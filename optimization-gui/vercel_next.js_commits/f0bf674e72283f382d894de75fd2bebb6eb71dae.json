{
    "author": "eps1lon",
    "message": "Remove `experimental.strictNextHead` (#81882)",
    "sha": "f0bf674e72283f382d894de75fd2bebb6eb71dae",
    "files": [
        {
            "sha": "aedea92cabc463acd2e6b06463347a49bae9ff1f",
            "filename": "packages/next/src/build/define-env.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -254,8 +254,6 @@ export function getDefineEnv({\n       config.experimental.scrollRestoration ?? false,\n     ...getImageConfig(config, dev),\n     'process.env.__NEXT_ROUTER_BASEPATH': config.basePath,\n-    'process.env.__NEXT_STRICT_NEXT_HEAD':\n-      config.experimental.strictNextHead ?? true,\n     'process.env.__NEXT_HAS_REWRITES': hasRewrites,\n     'process.env.__NEXT_CONFIG_OUTPUT': config.output,\n     'process.env.__NEXT_I18N_SUPPORT': !!config.i18n,"
        },
        {
            "sha": "244065459f355c7305bb0c042ccdce9e74aeb2e4",
            "filename": "packages/next/src/build/templates/edge-ssr.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -144,7 +144,6 @@ async function requestHandler(\n       ComponentMod: pageMod,\n       pageConfig: pageMod.pageConfig,\n       routeModule: pageMod.routeModule,\n-      strictNextHead: nextConfig.experimental.strictNextHead ?? true,\n       canonicalBase: nextConfig.amp.canonicalBase || '',\n       previewProps: prerenderManifest.preview,\n       ampOptimizerConfig: nextConfig.experimental.amp?.optimizer,"
        },
        {
            "sha": "c2fb7da868f14d49245f995e7cc11632ca495f3b",
            "filename": "packages/next/src/build/templates/pages.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -293,8 +293,6 @@ export async function handler(\n                   reactLoadableManifest,\n \n                   assetPrefix: nextConfig.assetPrefix,\n-                  strictNextHead:\n-                    nextConfig.experimental.strictNextHead ?? true,\n                   previewProps: prerenderManifest.preview,\n                   images: nextConfig.images as any,\n                   nextConfigOutput: nextConfig.output,"
        },
        {
            "sha": "a80acac83b30ddbfb44c042a6396c9cd3d11a988",
            "filename": "packages/next/src/client/head-manager.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 84,
            "changes": 116,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fclient%2Fhead-manager.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fclient%2Fhead-manager.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fhead-manager.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -50,104 +50,52 @@ export function isEqualNode(oldTag: Element, newTag: Element) {\n   return oldTag.isEqualNode(newTag)\n }\n \n-let updateElements: (type: string, components: JSX.Element[]) => void\n+function updateElements(type: string, components: JSX.Element[]) {\n+  const headEl = document.querySelector('head')\n+  if (!headEl) return\n \n-if (process.env.__NEXT_STRICT_NEXT_HEAD) {\n-  updateElements = (type, components) => {\n-    const headEl = document.querySelector('head')\n-    if (!headEl) return\n+  const oldTags = new Set(headEl.querySelectorAll(`${type}[data-next-head]`))\n \n-    const oldTags = new Set(headEl.querySelectorAll(`${type}[data-next-head]`))\n-\n-    if (type === 'meta') {\n-      const metaCharset = headEl.querySelector('meta[charset]')\n-      if (metaCharset !== null) {\n-        oldTags.add(metaCharset)\n-      }\n+  if (type === 'meta') {\n+    const metaCharset = headEl.querySelector('meta[charset]')\n+    if (metaCharset !== null) {\n+      oldTags.add(metaCharset)\n     }\n+  }\n \n-    const newTags: Element[] = []\n-    for (let i = 0; i < components.length; i++) {\n-      const component = components[i]\n-      const newTag = reactElementToDOM(component)\n-      newTag.setAttribute('data-next-head', '')\n-\n-      let isNew = true\n-      for (const oldTag of oldTags) {\n-        if (isEqualNode(oldTag, newTag)) {\n-          oldTags.delete(oldTag)\n-          isNew = false\n-          break\n-        }\n-      }\n+  const newTags: Element[] = []\n+  for (let i = 0; i < components.length; i++) {\n+    const component = components[i]\n+    const newTag = reactElementToDOM(component)\n+    newTag.setAttribute('data-next-head', '')\n \n-      if (isNew) {\n-        newTags.push(newTag)\n+    let isNew = true\n+    for (const oldTag of oldTags) {\n+      if (isEqualNode(oldTag, newTag)) {\n+        oldTags.delete(oldTag)\n+        isNew = false\n+        break\n       }\n     }\n \n-    for (const oldTag of oldTags) {\n-      oldTag.parentNode?.removeChild(oldTag)\n-    }\n-\n-    for (const newTag of newTags) {\n-      // meta[charset] must be first element so special case\n-      if (\n-        newTag.tagName.toLowerCase() === 'meta' &&\n-        newTag.getAttribute('charset') !== null\n-      ) {\n-        headEl.prepend(newTag)\n-      }\n-      headEl.appendChild(newTag)\n+    if (isNew) {\n+      newTags.push(newTag)\n     }\n   }\n-} else {\n-  updateElements = (type, components) => {\n-    const headEl = document.getElementsByTagName('head')[0]\n-    const headCountEl: HTMLMetaElement = headEl.querySelector(\n-      'meta[name=next-head-count]'\n-    ) as HTMLMetaElement\n-    if (process.env.NODE_ENV !== 'production') {\n-      if (!headCountEl) {\n-        console.error(\n-          'Warning: next-head-count is missing. https://nextjs.org/docs/messages/next-head-count-missing'\n-        )\n-        return\n-      }\n-    }\n \n-    const headCount = Number(headCountEl.content)\n-    const oldTags: Element[] = []\n+  for (const oldTag of oldTags) {\n+    oldTag.parentNode?.removeChild(oldTag)\n+  }\n \n-    for (\n-      let i = 0, j = headCountEl.previousElementSibling;\n-      i < headCount;\n-      i++, j = j?.previousElementSibling || null\n+  for (const newTag of newTags) {\n+    // meta[charset] must be first element so special case\n+    if (\n+      newTag.tagName.toLowerCase() === 'meta' &&\n+      newTag.getAttribute('charset') !== null\n     ) {\n-      if (j?.tagName?.toLowerCase() === type) {\n-        oldTags.push(j)\n-      }\n+      headEl.prepend(newTag)\n     }\n-    const newTags = (components.map(reactElementToDOM) as HTMLElement[]).filter(\n-      (newTag) => {\n-        for (let k = 0, len = oldTags.length; k < len; k++) {\n-          const oldTag = oldTags[k]\n-          if (isEqualNode(oldTag, newTag)) {\n-            oldTags.splice(k, 1)\n-            return false\n-          }\n-        }\n-        return true\n-      }\n-    )\n-\n-    oldTags.forEach((t) => t.parentNode?.removeChild(t))\n-    newTags.forEach((t) => headEl.insertBefore(t, headCountEl))\n-    headCountEl.content = (\n-      headCount -\n-      oldTags.length +\n-      newTags.length\n-    ).toString()\n+    headEl.appendChild(newTag)\n   }\n }\n "
        },
        {
            "sha": "f007d0ffc09e84a810d267ab7a3d6b501ca093a6",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -393,7 +393,6 @@ async function exportAppImpl(\n           serverActionsManifest,\n         }\n       : {}),\n-    strictNextHead: nextConfig.experimental.strictNextHead ?? true,\n     deploymentId: nextConfig.deploymentId,\n     htmlLimitedBots: nextConfig.htmlLimitedBots.source,\n     experimental: {"
        },
        {
            "sha": "4436b0d04942eae58f5d523765b553e8db877538",
            "filename": "packages/next/src/pages/_document.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 20,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -657,22 +657,12 @@ export class Head extends React.Component<HeadProps> {\n           child.props['rel'] === 'preload' &&\n           child.props['as'] === 'style'\n         ) {\n-          if (this.context.strictNextHead) {\n-            cssPreloads.push(\n-              React.cloneElement(child, { 'data-next-head': '' })\n-            )\n-          } else {\n-            cssPreloads.push(child)\n-          }\n+          cssPreloads.push(child)\n         } else {\n           if (child) {\n-            if (this.context.strictNextHead) {\n-              otherHeadElements.push(\n-                React.cloneElement(child, { 'data-next-head': '' })\n-              )\n-            } else {\n-              otherHeadElements.push(child)\n-            }\n+            otherHeadElements.push(\n+              React.cloneElement(child, { 'data-next-head': '' })\n+            )\n           }\n         }\n       })\n@@ -811,12 +801,6 @@ export class Head extends React.Component<HeadProps> {\n           </>\n         )}\n         {head}\n-        {this.context.strictNextHead ? null : (\n-          <meta\n-            name=\"next-head-count\"\n-            content={React.Children.count(head || []).toString()}\n-          />\n-        )}\n \n         {children}\n "
        },
        {
            "sha": "76d9be73062ebcfeb1ebb6cdfcff7605fdb75b7b",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -565,7 +565,6 @@ export default abstract class Server<\n       supportsDynamicResponse: true,\n       trailingSlash: this.nextConfig.trailingSlash,\n       deploymentId: this.nextConfig.deploymentId,\n-      strictNextHead: this.nextConfig.experimental.strictNextHead ?? true,\n       poweredByHeader: this.nextConfig.poweredByHeader,\n       canonicalBase: this.nextConfig.amp.canonicalBase || '',\n       generateEtags,"
        },
        {
            "sha": "149029d52ffd2eb295be81db02b6b5a36b71b4ff",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -414,7 +414,6 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n             algorithm: z.enum(['sha256', 'sha384', 'sha512']).optional(),\n           })\n           .optional(),\n-        strictNextHead: z.boolean().optional(),\n         swcPlugins: z\n           // The specific swc plugin's option is unknown, use z.any() here\n           .array(z.tuple([z.string(), z.record(z.string(), z.any())]))"
        },
        {
            "sha": "1f89cfd11e0d090b5e13a27fca2904894a22048d",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -335,8 +335,6 @@ export interface ExperimentalConfig {\n   dynamicOnHover?: boolean\n   appDocumentPreloading?: boolean\n   preloadEntriesOnStart?: boolean\n-  /** @default true */\n-  strictNextHead?: boolean\n   clientRouterFilter?: boolean\n   clientRouterFilterRedirects?: boolean\n   /**\n@@ -1472,7 +1470,6 @@ export const defaultConfig = Object.freeze({\n     devtoolSegmentExplorer: true,\n     browserDebugInfoInTerminal: false,\n     optimizeRouterScrolling: false,\n-    strictNextHead: true,\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,"
        },
        {
            "sha": "da1d7ca6e0c9dbe4bae4c61fe5a23c9f3a665592",
            "filename": "packages/next/src/server/render.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -287,7 +287,6 @@ export type RenderOptsPartial = {\n   images: ImageConfigComplete\n   largePageDataBytes?: number\n   isOnDemandRevalidate?: boolean\n-  strictNextHead: boolean\n   isPossibleServerAction?: boolean\n   isExperimentalCompile?: boolean\n   isPrefetch?: boolean\n@@ -1524,7 +1523,6 @@ export async function renderToHTMLImpl(\n       notFoundSrcPage: notFoundSrcPage && dev ? notFoundSrcPage : undefined,\n     },\n     nonce,\n-    strictNextHead: renderOpts.strictNextHead,\n     buildManifest: filteredBuildManifest,\n     docComponentsRendered,\n     dangerousAsPath: router.asPath,"
        },
        {
            "sha": "11bdc2fb83273ba85cb2252110576fc05719f9bc",
            "filename": "packages/next/src/shared/lib/html-context.shared-runtime.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhtml-context.shared-runtime.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhtml-context.shared-runtime.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhtml-context.shared-runtime.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -9,7 +9,6 @@ import { createContext, useContext, type JSX } from 'react'\n export type HtmlProps = {\n   __NEXT_DATA__: NEXT_DATA\n   nonce?: string\n-  strictNextHead: boolean\n   dangerousAsPath: string\n   docComponentsRendered: {\n     Html?: boolean"
        },
        {
            "sha": "540b0ba4da823c55e263fd8874fbb188f75ced4d",
            "filename": "test/development/pages-dir/client-navigation/fixture/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Ffixture%2Fnext.config.js?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -4,12 +4,6 @@ module.exports = {\n     // Make sure entries are not getting disposed.\n     maxInactiveAge: 1000 * 60 * 60,\n   },\n-  experimental:\n-    process.env.TEST_STRICT_NEXT_HEAD !== undefined\n-      ? {\n-          strictNextHead: process.env.TEST_STRICT_NEXT_HEAD === 'true',\n-        }\n-      : {},\n   // scroll position can be finicky with the\n   // indicators showing so hide by default\n   devIndicators: false,"
        },
        {
            "sha": "7ecf3aeaf182c57b497697d3c501e0b7577156b2",
            "filename": "test/development/pages-dir/client-navigation/head.test.ts",
            "status": "modified",
            "additions": 152,
            "deletions": 180,
            "changes": 332,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Fhead.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Fhead.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Fhead.test.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -4,202 +4,174 @@ import { waitFor } from 'next-test-utils'\n import path from 'path'\n import { nextTestSetup } from 'e2e-utils'\n \n-const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n-\n-describe.each([[false], [true]])(\n-  'updating <Head /> with strictNextHead=%s while client routing',\n-  (strictNextHead) => {\n-    const { next } = nextTestSetup({\n-      files: path.join(__dirname, 'fixture'),\n-      env: {\n-        TEST_STRICT_NEXT_HEAD: String(strictNextHead),\n-      },\n-    })\n+describe('updating <Head /> while client routing', () => {\n+  const { next } = nextTestSetup({\n+    files: path.join(__dirname, 'fixture'),\n+  })\n+\n+  it.each([true, false])(\n+    'should handle boolean async prop in next/head client-side: %s',\n+    async (bool) => {\n+      const browser = await next.browser('/head')\n+      const value = await browser.eval(\n+        `document.querySelector('script[src=\"/test-async-${JSON.stringify(\n+          bool\n+        )}.js\"]').async`\n+      )\n \n-    it.each([true, false])(\n-      'should handle boolean async prop in next/head client-side: %s',\n-      async (bool) => {\n-        const browser = await next.browser('/head')\n-        const value = await browser.eval(\n-          `document.querySelector('script[src=\"/test-async-${JSON.stringify(\n-            bool\n-          )}.js\"]').async`\n-        )\n-\n-        expect(value).toBe(bool)\n-      }\n-    )\n+      expect(value).toBe(bool)\n+    }\n+  )\n \n-    it('should only execute async and defer scripts once', async () => {\n-      const browser = await next.browser('/head')\n+  it('should only execute async and defer scripts once', async () => {\n+    const browser = await next.browser('/head')\n \n-      await browser.waitForElementByCss('h1')\n-      await waitFor(2000)\n-      expect(Number(await browser.eval('window.__test_async_executions'))).toBe(\n-        strictNextHead || isReact18\n-          ? 1\n-          : // <meta name=\"next-head-count\" /> is floated before <script />.\n-            // head-manager thinks it needs to add these again resulting in another execution.\n-            2\n-      )\n-      expect(Number(await browser.eval('window.__test_defer_executions'))).toBe(\n-        strictNextHead || isReact18\n-          ? 1\n-          : // <meta name=\"next-head-count\" /> is floated before <script defer />.\n-            // head-manager thinks it needs to add these again resulting in another execution.\n-            2\n-      )\n+    await browser.waitForElementByCss('h1')\n+    await waitFor(2000)\n+    expect(Number(await browser.eval('window.__test_async_executions'))).toBe(1)\n+    expect(Number(await browser.eval('window.__test_defer_executions'))).toBe(1)\n \n-      await browser.elementByCss('#reverseScriptOrder').click()\n-      await waitFor(2000)\n+    await browser.elementByCss('#reverseScriptOrder').click()\n+    await waitFor(2000)\n \n-      expect(Number(await browser.eval('window.__test_async_executions'))).toBe(\n-        strictNextHead || isReact18 ? 1 : 2\n-      )\n-      expect(Number(await browser.eval('window.__test_defer_executions'))).toBe(\n-        strictNextHead || isReact18 ? 1 : 2\n-      )\n+    expect(Number(await browser.eval('window.__test_async_executions'))).toBe(1)\n+    expect(Number(await browser.eval('window.__test_defer_executions'))).toBe(1)\n \n-      await browser.elementByCss('#toggleScript').click()\n-      await waitFor(2000)\n+    await browser.elementByCss('#toggleScript').click()\n+    await waitFor(2000)\n \n-      expect(Number(await browser.eval('window.__test_async_executions'))).toBe(\n-        strictNextHead || isReact18 ? 1 : 2\n-      )\n-      expect(Number(await browser.eval('window.__test_defer_executions'))).toBe(\n-        strictNextHead || isReact18 ? 1 : 2\n-      )\n-    })\n+    expect(Number(await browser.eval('window.__test_async_executions'))).toBe(1)\n+    expect(Number(await browser.eval('window.__test_defer_executions'))).toBe(1)\n+  })\n \n-    it('should warn when stylesheets or scripts are in head', async () => {\n-      const browser = await next.browser('/head')\n+  it('should warn when stylesheets or scripts are in head', async () => {\n+    const browser = await next.browser('/head')\n \n-      await browser.waitForElementByCss('h1')\n-      await waitFor(1000)\n-      const browserLogs = await browser.log()\n-      let foundStyles = false\n-      let foundScripts = false\n-      const logs = []\n-      browserLogs.forEach(({ message }) => {\n-        if (message.includes('Do not add stylesheets using next/head')) {\n-          foundStyles = true\n-          logs.push(message)\n-        }\n-        if (message.includes('Do not add <script> tags using next/head')) {\n-          foundScripts = true\n-          logs.push(message)\n-        }\n-      })\n-\n-      expect(foundStyles).toEqual(true)\n-      expect(foundScripts).toEqual(true)\n-\n-      // Warnings are unique\n-      expect(logs.length).toEqual(new Set(logs).size)\n+    await browser.waitForElementByCss('h1')\n+    await waitFor(1000)\n+    const browserLogs = await browser.log()\n+    let foundStyles = false\n+    let foundScripts = false\n+    const logs = []\n+    browserLogs.forEach(({ message }) => {\n+      if (message.includes('Do not add stylesheets using next/head')) {\n+        foundStyles = true\n+        logs.push(message)\n+      }\n+      if (message.includes('Do not add <script> tags using next/head')) {\n+        foundScripts = true\n+        logs.push(message)\n+      }\n     })\n \n-    it('should warn when scripts are in head', async () => {\n-      const browser = await next.browser('/head')\n-      await browser.waitForElementByCss('h1')\n-      await waitFor(1000)\n-      const browserLogs = await browser.log()\n-      let found = false\n-      browserLogs.forEach((log) => {\n-        if (log.message.includes('Use next/script instead')) {\n-          found = true\n-        }\n-      })\n-      expect(found).toEqual(true)\n+    expect(foundStyles).toEqual(true)\n+    expect(foundScripts).toEqual(true)\n+\n+    // Warnings are unique\n+    expect(logs.length).toEqual(new Set(logs).size)\n+  })\n+\n+  it('should warn when scripts are in head', async () => {\n+    const browser = await next.browser('/head')\n+    await browser.waitForElementByCss('h1')\n+    await waitFor(1000)\n+    const browserLogs = await browser.log()\n+    let found = false\n+    browserLogs.forEach((log) => {\n+      if (log.message.includes('Use next/script instead')) {\n+        found = true\n+      }\n     })\n-\n-    it('should not warn when application/ld+json scripts are in head', async () => {\n-      const browser = await next.browser('/head-with-json-ld-snippet')\n-      await browser.waitForElementByCss('h1')\n-      await waitFor(1000)\n-      const browserLogs = await browser.log()\n-      let found = false\n-      browserLogs.forEach((log) => {\n-        if (log.message.includes('Use next/script instead')) {\n-          found = true\n-        }\n-      })\n-      expect(found).toEqual(false)\n+    expect(found).toEqual(true)\n+  })\n+\n+  it('should not warn when application/ld+json scripts are in head', async () => {\n+    const browser = await next.browser('/head-with-json-ld-snippet')\n+    await browser.waitForElementByCss('h1')\n+    await waitFor(1000)\n+    const browserLogs = await browser.log()\n+    let found = false\n+    browserLogs.forEach((log) => {\n+      if (log.message.includes('Use next/script instead')) {\n+        found = true\n+      }\n     })\n+    expect(found).toEqual(false)\n+  })\n \n-    it('should update head during client routing', async () => {\n-      const browser = await next.browser('/nav/head-1')\n-      expect(\n-        await browser\n-          .elementByCss('meta[name=\"description\"]')\n-          .getAttribute('content')\n-      ).toBe('Head One')\n-\n+  it('should update head during client routing', async () => {\n+    const browser = await next.browser('/nav/head-1')\n+    expect(\n       await browser\n-        .elementByCss('#to-head-2')\n-        .click()\n-        .waitForElementByCss('#head-2', 3000)\n-      expect(\n-        await browser\n-          .elementByCss('meta[name=\"description\"]')\n-          .getAttribute('content')\n-      ).toBe('Head Two')\n-\n+        .elementByCss('meta[name=\"description\"]')\n+        .getAttribute('content')\n+    ).toBe('Head One')\n+\n+    await browser\n+      .elementByCss('#to-head-2')\n+      .click()\n+      .waitForElementByCss('#head-2', 3000)\n+    expect(\n       await browser\n-        .elementByCss('#to-head-1')\n-        .click()\n-        .waitForElementByCss('#head-1', 3000)\n-      expect(\n-        await browser\n-          .elementByCss('meta[name=\"description\"]')\n-          .getAttribute('content')\n-      ).toBe('Head One')\n-\n+        .elementByCss('meta[name=\"description\"]')\n+        .getAttribute('content')\n+    ).toBe('Head Two')\n+\n+    await browser\n+      .elementByCss('#to-head-1')\n+      .click()\n+      .waitForElementByCss('#head-1', 3000)\n+    expect(\n       await browser\n-        .elementByCss('#to-head-3')\n-        .click()\n-        .waitForElementByCss('#head-3', 3000)\n-      expect(\n-        await browser\n-          .elementByCss('meta[name=\"description\"]')\n-          .getAttribute('content')\n-      ).toBe('Head Three')\n-      expect(await browser.eval('document.title')).toBe('')\n-\n+        .elementByCss('meta[name=\"description\"]')\n+        .getAttribute('content')\n+    ).toBe('Head One')\n+\n+    await browser\n+      .elementByCss('#to-head-3')\n+      .click()\n+      .waitForElementByCss('#head-3', 3000)\n+    expect(\n       await browser\n-        .elementByCss('#to-head-1')\n-        .click()\n-        .waitForElementByCss('#head-1', 3000)\n-      expect(\n-        await browser\n-          .elementByCss('meta[name=\"description\"]')\n-          .getAttribute('content')\n-      ).toBe('Head One')\n-    })\n-\n-    it('should update title during client routing', async () => {\n-      const browser = await next.browser('/nav/head-1')\n-      expect(await browser.eval('document.title')).toBe('this is head-1')\n-\n-      await browser\n-        .elementByCss('#to-head-2')\n-        .click()\n-        .waitForElementByCss('#head-2', 3000)\n-      expect(await browser.eval('document.title')).toBe('this is head-2')\n-\n+        .elementByCss('meta[name=\"description\"]')\n+        .getAttribute('content')\n+    ).toBe('Head Three')\n+    expect(await browser.eval('document.title')).toBe('')\n+\n+    await browser\n+      .elementByCss('#to-head-1')\n+      .click()\n+      .waitForElementByCss('#head-1', 3000)\n+    expect(\n       await browser\n-        .elementByCss('#to-head-1')\n-        .click()\n-        .waitForElementByCss('#head-1', 3000)\n-      expect(await browser.eval('document.title')).toBe('this is head-1')\n-    })\n-\n-    it('should update head when unmounting component', async () => {\n-      const browser = await next.browser('/head-dynamic')\n-      expect(await browser.eval('document.title')).toBe('B')\n-      await browser.elementByCss('button').click()\n-      expect(await browser.eval('document.title')).toBe('A')\n-      await browser.elementByCss('button').click()\n-      expect(await browser.eval('document.title')).toBe('B')\n-    })\n-  }\n-)\n+        .elementByCss('meta[name=\"description\"]')\n+        .getAttribute('content')\n+    ).toBe('Head One')\n+  })\n+\n+  it('should update title during client routing', async () => {\n+    const browser = await next.browser('/nav/head-1')\n+    expect(await browser.eval('document.title')).toBe('this is head-1')\n+\n+    await browser\n+      .elementByCss('#to-head-2')\n+      .click()\n+      .waitForElementByCss('#head-2', 3000)\n+    expect(await browser.eval('document.title')).toBe('this is head-2')\n+\n+    await browser\n+      .elementByCss('#to-head-1')\n+      .click()\n+      .waitForElementByCss('#head-1', 3000)\n+    expect(await browser.eval('document.title')).toBe('this is head-1')\n+  })\n+\n+  it('should update head when unmounting component', async () => {\n+    const browser = await next.browser('/head-dynamic')\n+    expect(await browser.eval('document.title')).toBe('B')\n+    await browser.elementByCss('button').click()\n+    expect(await browser.eval('document.title')).toBe('A')\n+    await browser.elementByCss('button').click()\n+    expect(await browser.eval('document.title')).toBe('B')\n+  })\n+})"
        },
        {
            "sha": "83290ab81bcb1b300934360b82d8878d1ae8c857",
            "filename": "test/development/pages-dir/client-navigation/rendering-head.test.ts",
            "status": "modified",
            "additions": 221,
            "deletions": 332,
            "changes": 553,
            "blob_url": "https://github.com/vercel/next.js/blob/f0bf674e72283f382d894de75fd2bebb6eb71dae/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering-head.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0bf674e72283f382d894de75fd2bebb6eb71dae/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering-head.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering-head.test.ts?ref=f0bf674e72283f382d894de75fd2bebb6eb71dae",
            "patch": "@@ -8,336 +8,225 @@ import path from 'path'\n const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n \n describe('Client Navigation rendering <Head />', () => {\n-  describe.each([[false], [true], [undefined]])(\n-    'with strictNextHead=%s',\n-    (strictNextHead) => {\n-      const { next } = nextTestSetup({\n-        files: path.join(__dirname, 'fixture'),\n-        env:\n-          strictNextHead !== undefined\n-            ? {\n-                TEST_STRICT_NEXT_HEAD: String(strictNextHead),\n-              }\n-            : {},\n-      })\n-\n-      function render(\n-        pathname: Parameters<typeof renderViaHTTP>[1],\n-        query?: Parameters<typeof renderViaHTTP>[2]\n-      ) {\n-        return renderViaHTTP(next.appPort, pathname, query)\n-      }\n-\n-      it('should handle undefined prop in head server-side', async () => {\n-        const html = await render('/head')\n-        const $ = cheerio.load(html)\n-        const value = 'content' in $('meta[name=\"empty-content\"]').attr()\n-\n-        expect(value).toBe(false)\n-      })\n-\n-      // default-head contains an empty <Head />.\n-      test('header renders default charset', async () => {\n-        const html = await render('/default-head')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta charSet=\"utf-8\" data-next-head=\"\"/>'\n-            : '<meta charSet=\"utf-8\"/>'\n-        )\n-        expect(html).toContain('next-head, but only once.')\n-      })\n-\n-      test('header renders default viewport', async () => {\n-        const html = await render('/default-head')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta name=\"viewport\" content=\"width=device-width\" data-next-head=\"\"/>'\n-            : '<meta name=\"viewport\" content=\"width=device-width\"/>'\n-        )\n-      })\n-\n-      test('header helper renders header information', async () => {\n-        const html = await render('/head')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta charSet=\"iso-8859-5\" data-next-head=\"\"/>'\n-            : '<meta charSet=\"iso-8859-5\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta content=\"my meta\" data-next-head=\"\"/>'\n-            : '<meta content=\"my meta\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/>'\n-            : '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>'\n-        )\n-        expect(html).toContain('I can have meta tags')\n-      })\n-\n-      test('header helper dedupes tags', async () => {\n-        const html = await render('/head')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta charSet=\"iso-8859-5\" data-next-head=\"\"/>'\n-            : '<meta charSet=\"iso-8859-5\"/>'\n-        )\n-        expect(html).not.toContain(\n-          strictNextHead !== false\n-            ? '<meta charSet=\"utf-8\" data-next-head=\"\"/>'\n-            : '<meta charSet=\"utf-8\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/>'\n-            : '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/>'\n-        )\n-        // Should contain only one viewport\n-        expect(html.match(/<meta name=\"viewport\" /g).length).toBe(1)\n-        expect(html).not.toContain(\n-          '<meta name=\"viewport\" content=\"width=device-width\"'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta content=\"my meta\" data-next-head=\"\"/>'\n-            : '<meta content=\"my meta\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<link rel=\"stylesheet\" href=\"/dup-style.css\" data-next-head=\"\"/><link rel=\"stylesheet\" href=\"/dup-style.css\" data-next-head=\"\"/>'\n-            : '<link rel=\"stylesheet\" href=\"/dup-style.css\"/><link rel=\"stylesheet\" href=\"/dup-style.css\"/>'\n-        )\n-        const dedupeLink =\n-          strictNextHead !== false\n-            ? '<link rel=\"stylesheet\" href=\"dedupe-style.css\" data-next-head=\"\"/>'\n-            : '<link rel=\"stylesheet\" href=\"dedupe-style.css\"/>'\n-        expect(html).toContain(dedupeLink)\n-        expect(\n-          html.substring(html.indexOf(dedupeLink) + dedupeLink.length)\n-        ).not.toContain('<link rel=\"stylesheet\" href=\"dedupe-style.css\"')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<link rel=\"alternate\" hrefLang=\"en\" href=\"/last/en\" data-next-head=\"\"/>'\n-            : '<link rel=\"alternate\" hrefLang=\"en\" href=\"/last/en\"/>'\n-        )\n-        expect(html).not.toContain(\n-          '<link rel=\"alternate\" hrefLang=\"en\" href=\"/first/en\"'\n-        )\n-      })\n-\n-      test('header helper dedupes tags with the same key as the default', async () => {\n-        const html = await render('/head-duplicate-default-keys')\n-        // Expect exactly one `charSet`\n-        expect((html.match(/charSet=/g) || []).length).toBe(1)\n-        // Expect exactly one `viewport`\n-        expect((html.match(/name=\"viewport\"/g) || []).length).toBe(1)\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta charSet=\"iso-8859-1\" data-next-head=\"\"/>'\n-            : '<meta charSet=\"iso-8859-1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta name=\"viewport\" content=\"width=500\" data-next-head=\"\"/>'\n-            : '<meta name=\"viewport\" content=\"width=500\"/>'\n-        )\n-      })\n-\n-      test('header helper avoids dedupe of specific tags', async () => {\n-        const html = await render('/head')\n-        console.log(html)\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"article:tag\" content=\"tag1\" data-next-head=\"\"/>'\n-            : '<meta property=\"article:tag\" content=\"tag1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"article:tag\" content=\"tag2\" data-next-head=\"\"/>'\n-            : '<meta property=\"article:tag\" content=\"tag2\"/>'\n-        )\n-        expect(html).not.toContain('<meta property=\"dedupe:tag\" content=\"tag3\"')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"dedupe:tag\" content=\"tag4\" data-next-head=\"\"/>'\n-            : '<meta property=\"dedupe:tag\" content=\"tag4\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image\" content=\"ogImageTag1\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image\" content=\"ogImageTag1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image\" content=\"ogImageTag2\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image\" content=\"ogImageTag2\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:alt\" content=\"ogImageAltTag1\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:alt\" content=\"ogImageAltTag1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:alt\" content=\"ogImageAltTag2\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:alt\" content=\"ogImageAltTag2\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:width\" content=\"ogImageWidthTag1\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:width\" content=\"ogImageWidthTag1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:width\" content=\"ogImageWidthTag2\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:width\" content=\"ogImageWidthTag2\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:height\" content=\"ogImageHeightTag1\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:height\" content=\"ogImageHeightTag1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:height\" content=\"ogImageHeightTag2\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:height\" content=\"ogImageHeightTag2\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:type\" content=\"ogImageTypeTag1\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:type\" content=\"ogImageTypeTag1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:type\" content=\"ogImageTypeTag2\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:type\" content=\"ogImageTypeTag2\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag1\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag2\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag2\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:url\" content=\"ogImageUrlTag1\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:url\" content=\"ogImageUrlTag1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"og:image:url\" content=\"ogImageUrlTag2\" data-next-head=\"\"/>'\n-            : '<meta property=\"og:image:url\" content=\"ogImageUrlTag2\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"fb:pages\" content=\"fbpages1\" data-next-head=\"\"/>'\n-            : '<meta property=\"fb:pages\" content=\"fbpages1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta property=\"fb:pages\" content=\"fbpages2\" data-next-head=\"\"/>'\n-            : '<meta property=\"fb:pages\" content=\"fbpages2\"/>'\n-        )\n-      })\n-\n-      test('header helper avoids dedupe of meta tags with the same name if they use unique keys', async () => {\n-        const html = await render('/head')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta name=\"citation_author\" content=\"authorName1\" data-next-head=\"\"/>'\n-            : '<meta name=\"citation_author\" content=\"authorName1\"/>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta name=\"citation_author\" content=\"authorName2\" data-next-head=\"\"/>'\n-            : '<meta name=\"citation_author\" content=\"authorName2\"/>'\n-        )\n-      })\n-\n-      test('header helper renders Fragment children', async () => {\n-        const html = await render('/head')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<title data-next-head=\"\">Fragment title</title>'\n-            : '<title>Fragment title</title>'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<meta content=\"meta fragment\" data-next-head=\"\"/>'\n-            : '<meta content=\"meta fragment\"/>'\n-        )\n-      })\n-\n-      test('header helper renders boolean attributes correctly children', async () => {\n-        const html = await render('/head')\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<script src=\"/test-async-false.js\" data-next-head=\"\">'\n-            : '<script src=\"/test-async-false.js\">'\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<script src=\"/test-async-true.js\" async=\"\" data-next-head=\"\">'\n-            : ''\n-        )\n-        expect(html).toContain(\n-          strictNextHead !== false\n-            ? '<script src=\"/test-defer.js\" defer=\"\" data-next-head=\"\">'\n-            : ''\n-        )\n-      })\n-\n-      it('should place charset element at the top of <head>', async () => {\n-        const html = await render('/head-priority')\n-        const nextHeadElement =\n-          strictNextHead !== false\n-            ? '<meta charSet=\"iso-8859-5\" data-next-head=\"\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/><meta name=\"title\" content=\"head title\" data-next-head=\"\"/>'\n-            : '<meta charSet=\"iso-8859-5\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/><meta name=\"title\" content=\"head title\"/><meta name=\"next-head-count\" content=\"3\"/>'\n-        const documentHeadElement =\n-          '<meta name=\"keywords\" content=\"document head test\"/>'\n-\n-        expect(html).toContain(\n-          isReact18\n-            ? // charset is not actually at the top.\n-              // data-next-hide-fouc comes first\n-              `</style></noscript>${nextHeadElement}${documentHeadElement}`\n-            : `<head>${nextHeadElement}${documentHeadElement}`\n-        )\n-      })\n-\n-      test('custom meta properties are rendered only once', async () => {\n-        const browser = await next.browser('/head-with-custom-metadata')\n-\n-        // Check that title appears only once\n-        const titleElements = await browser.elementsByCss('title')\n-        expect(titleElements).toHaveLength(1)\n-        const titleText = await browser.elementByCss('title').text()\n-        expect(titleText).toBe('Title Page')\n-\n-        // Check that each meta property appears only once\n-        const ogTitleElements = await browser.elementsByCss(\n-          'meta[property=\"og:title\"]'\n-        )\n-        expect(ogTitleElements).toHaveLength(1)\n-        const ogTitleContent = await browser\n-          .elementByCss('meta[property=\"og:title\"]')\n-          .getAttribute('content')\n-        expect(ogTitleContent).toBe('Title Content')\n-\n-        const descriptionElements = await browser.elementsByCss(\n-          'meta[name=\"description\"]'\n-        )\n-        expect(descriptionElements).toHaveLength(1)\n-        const descriptionContent = await browser\n-          .elementByCss('meta[name=\"description\"]')\n-          .getAttribute('content')\n-        expect(descriptionContent).toBe('Description Content')\n-      })\n-    }\n-  )\n+  const { next } = nextTestSetup({\n+    files: path.join(__dirname, 'fixture'),\n+  })\n+\n+  function render(\n+    pathname: Parameters<typeof renderViaHTTP>[1],\n+    query?: Parameters<typeof renderViaHTTP>[2]\n+  ) {\n+    return renderViaHTTP(next.appPort, pathname, query)\n+  }\n+\n+  it('should handle undefined prop in head server-side', async () => {\n+    const html = await render('/head')\n+    const $ = cheerio.load(html)\n+    const value = 'content' in $('meta[name=\"empty-content\"]').attr()\n+\n+    expect(value).toBe(false)\n+  })\n+\n+  // default-head contains an empty <Head />.\n+  test('header renders default charset', async () => {\n+    const html = await render('/default-head')\n+    expect(html).toContain('<meta charSet=\"utf-8\" data-next-head=\"\"/>')\n+    expect(html).toContain('next-head, but only once.')\n+  })\n+\n+  test('header renders default viewport', async () => {\n+    const html = await render('/default-head')\n+    expect(html).toContain(\n+      '<meta name=\"viewport\" content=\"width=device-width\" data-next-head=\"\"/>'\n+    )\n+  })\n+\n+  test('header helper renders header information', async () => {\n+    const html = await render('/head')\n+    expect(html).toContain('<meta charSet=\"iso-8859-5\" data-next-head=\"\"/>')\n+    expect(html).toContain('<meta content=\"my meta\" data-next-head=\"\"/>')\n+    expect(html).toContain(\n+      '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain('I can have meta tags')\n+  })\n+\n+  test('header helper dedupes tags', async () => {\n+    const html = await render('/head')\n+    expect(html).toContain('<meta charSet=\"iso-8859-5\" data-next-head=\"\"/>')\n+    expect(html).not.toContain('<meta charSet=\"utf-8\" data-next-head=\"\"/>')\n+    expect(html).toContain(\n+      '<meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/>'\n+    )\n+    // Should contain only one viewport\n+    expect(html.match(/<meta name=\"viewport\" /g).length).toBe(1)\n+    expect(html).not.toContain(\n+      '<meta name=\"viewport\" content=\"width=device-width\"'\n+    )\n+    expect(html).toContain('<meta content=\"my meta\" data-next-head=\"\"/>')\n+    expect(html).toContain(\n+      '<link rel=\"stylesheet\" href=\"/dup-style.css\" data-next-head=\"\"/><link rel=\"stylesheet\" href=\"/dup-style.css\" data-next-head=\"\"/>'\n+    )\n+    const dedupeLink =\n+      '<link rel=\"stylesheet\" href=\"dedupe-style.css\" data-next-head=\"\"/>'\n+    expect(html).toContain(dedupeLink)\n+    expect(\n+      html.substring(html.indexOf(dedupeLink) + dedupeLink.length)\n+    ).not.toContain('<link rel=\"stylesheet\" href=\"dedupe-style.css\"')\n+    expect(html).toContain(\n+      '<link rel=\"alternate\" hrefLang=\"en\" href=\"/last/en\" data-next-head=\"\"/>'\n+    )\n+    expect(html).not.toContain(\n+      '<link rel=\"alternate\" hrefLang=\"en\" href=\"/first/en\"'\n+    )\n+  })\n+\n+  test('header helper dedupes tags with the same key as the default', async () => {\n+    const html = await render('/head-duplicate-default-keys')\n+    // Expect exactly one `charSet`\n+    expect((html.match(/charSet=/g) || []).length).toBe(1)\n+    // Expect exactly one `viewport`\n+    expect((html.match(/name=\"viewport\"/g) || []).length).toBe(1)\n+    expect(html).toContain('<meta charSet=\"iso-8859-1\" data-next-head=\"\"/>')\n+    expect(html).toContain(\n+      '<meta name=\"viewport\" content=\"width=500\" data-next-head=\"\"/>'\n+    )\n+  })\n+\n+  test('header helper avoids dedupe of specific tags', async () => {\n+    const html = await render('/head')\n+    console.log(html)\n+    expect(html).toContain(\n+      '<meta property=\"article:tag\" content=\"tag1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"article:tag\" content=\"tag2\" data-next-head=\"\"/>'\n+    )\n+    expect(html).not.toContain('<meta property=\"dedupe:tag\" content=\"tag3\"')\n+    expect(html).toContain(\n+      '<meta property=\"dedupe:tag\" content=\"tag4\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image\" content=\"ogImageTag1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image\" content=\"ogImageTag2\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:alt\" content=\"ogImageAltTag1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:alt\" content=\"ogImageAltTag2\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:width\" content=\"ogImageWidthTag1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:width\" content=\"ogImageWidthTag2\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:height\" content=\"ogImageHeightTag1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:height\" content=\"ogImageHeightTag2\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:type\" content=\"ogImageTypeTag1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:type\" content=\"ogImageTypeTag2\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:secure_url\" content=\"ogImageSecureUrlTag2\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:url\" content=\"ogImageUrlTag1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"og:image:url\" content=\"ogImageUrlTag2\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"fb:pages\" content=\"fbpages1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta property=\"fb:pages\" content=\"fbpages2\" data-next-head=\"\"/>'\n+    )\n+  })\n+\n+  test('header helper avoids dedupe of meta tags with the same name if they use unique keys', async () => {\n+    const html = await render('/head')\n+    expect(html).toContain(\n+      '<meta name=\"citation_author\" content=\"authorName1\" data-next-head=\"\"/>'\n+    )\n+    expect(html).toContain(\n+      '<meta name=\"citation_author\" content=\"authorName2\" data-next-head=\"\"/>'\n+    )\n+  })\n+\n+  test('header helper renders Fragment children', async () => {\n+    const html = await render('/head')\n+    expect(html).toContain('<title data-next-head=\"\">Fragment title</title>')\n+    expect(html).toContain('<meta content=\"meta fragment\" data-next-head=\"\"/>')\n+  })\n+\n+  test('header helper renders boolean attributes correctly children', async () => {\n+    const html = await render('/head')\n+    expect(html).toContain(\n+      '<script src=\"/test-async-false.js\" data-next-head=\"\">'\n+    )\n+    expect(html).toContain(\n+      '<script src=\"/test-async-true.js\" async=\"\" data-next-head=\"\">'\n+    )\n+    expect(html).toContain(\n+      '<script src=\"/test-defer.js\" defer=\"\" data-next-head=\"\">'\n+    )\n+  })\n+\n+  it('should place charset element at the top of <head>', async () => {\n+    const html = await render('/head-priority')\n+    const nextHeadElement =\n+      '<meta charSet=\"iso-8859-5\" data-next-head=\"\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" data-next-head=\"\"/><meta name=\"title\" content=\"head title\" data-next-head=\"\"/>'\n+    const documentHeadElement =\n+      '<meta name=\"keywords\" content=\"document head test\"/>'\n+\n+    expect(html).toContain(\n+      isReact18\n+        ? // charset is not actually at the top.\n+          // data-next-hide-fouc comes first\n+          `</style></noscript>${nextHeadElement}${documentHeadElement}`\n+        : `<head>${nextHeadElement}${documentHeadElement}`\n+    )\n+  })\n+\n+  test('custom meta properties are rendered only once', async () => {\n+    const browser = await next.browser('/head-with-custom-metadata')\n+\n+    // Check that title appears only once\n+    const titleElements = await browser.elementsByCss('title')\n+    expect(titleElements).toHaveLength(1)\n+    const titleText = await browser.elementByCss('title').text()\n+    expect(titleText).toBe('Title Page')\n+\n+    // Check that each meta property appears only once\n+    const ogTitleElements = await browser.elementsByCss(\n+      'meta[property=\"og:title\"]'\n+    )\n+    expect(ogTitleElements).toHaveLength(1)\n+    const ogTitleContent = await browser\n+      .elementByCss('meta[property=\"og:title\"]')\n+      .getAttribute('content')\n+    expect(ogTitleContent).toBe('Title Content')\n+\n+    const descriptionElements = await browser.elementsByCss(\n+      'meta[name=\"description\"]'\n+    )\n+    expect(descriptionElements).toHaveLength(1)\n+    const descriptionContent = await browser\n+      .elementByCss('meta[name=\"description\"]')\n+      .getAttribute('content')\n+    expect(descriptionContent).toBe('Description Content')\n+  })\n })"
        }
    ],
    "stats": {
        "total": 1045,
        "additions": 409,
        "deletions": 636
    }
}