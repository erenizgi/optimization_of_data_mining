{
    "author": "sokra",
    "message": "Turbopack: handle task cancelation (#76831)\n\n### What?\n\n* handle task cancelation\n* wait for stopping turbo-tasks before running exit handlers\n* sort all output manifests",
    "sha": "93c91cad31085125ef2cc1fb7b8d45152cecf897",
    "files": [
        {
            "sha": "9fe3e9c34e54b9a23e7b0f2527e6d31e48e2b4a5",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/93c91cad31085125ef2cc1fb7b8d45152cecf897/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/93c91cad31085125ef2cc1fb7b8d45152cecf897/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=93c91cad31085125ef2cc1fb7b8d45152cecf897",
            "patch": "@@ -543,8 +543,8 @@ async fn project_on_exit_internal(project: &ProjectInstance) {\n pub async fn project_shutdown(\n     #[napi(ts_arg_type = \"{ __napiType: \\\"Project\\\" }\")] project: External<ProjectInstance>,\n ) {\n-    project_on_exit_internal(&project).await;\n     project.turbo_tasks.stop_and_wait().await;\n+    project_on_exit_internal(&project).await;\n }\n \n #[napi(object)]"
        },
        {
            "sha": "5faea439b6a2886309faad534832d3bd80510abb",
            "filename": "packages/next/src/shared/lib/turbopack/manifest-loader.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 1,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/93c91cad31085125ef2cc1fb7b8d45152cecf897/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/93c91cad31085125ef2cc1fb7b8d45152cecf897/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts?ref=93c91cad31085125ef2cc1fb7b8d45152cecf897",
            "patch": "@@ -200,6 +200,16 @@ export class TurbopackManifestLoader {\n       mergeActionIds(manifest.node, m.node)\n       mergeActionIds(manifest.edge, m.edge)\n     }\n+    for (const key in manifest.node) {\n+      const entry = manifest.node[key]\n+      entry.workers = sortObjectByKey(entry.workers)\n+      entry.layer = sortObjectByKey(entry.layer)\n+    }\n+    for (const key in manifest.edge) {\n+      const entry = manifest.edge[key]\n+      entry.workers = sortObjectByKey(entry.workers)\n+      entry.layer = sortObjectByKey(entry.layer)\n+    }\n \n     return manifest\n   }\n@@ -247,6 +257,7 @@ export class TurbopackManifestLoader {\n     for (const m of manifests) {\n       Object.assign(manifest.pages, m.pages)\n     }\n+    manifest.pages = sortObjectByKey(manifest.pages)\n     return manifest\n   }\n \n@@ -398,6 +409,7 @@ export class TurbopackManifestLoader {\n       // polyfillFiles should always be the same, so we can overwrite instead of actually merging\n       if (m.polyfillFiles.length) manifest.polyfillFiles = m.polyfillFiles\n     }\n+    manifest.pages = sortObjectByKey(manifest.pages) as BuildManifest['pages']\n     return manifest\n   }\n \n@@ -550,6 +562,8 @@ export class TurbopackManifestLoader {\n       manifest.pagesUsingSizeAdjust =\n         manifest.pagesUsingSizeAdjust || m.pagesUsingSizeAdjust\n     }\n+    manifest.app = sortObjectByKey(manifest.app)\n+    manifest.pages = sortObjectByKey(manifest.pages)\n     return manifest\n   }\n \n@@ -620,6 +634,8 @@ export class TurbopackManifestLoader {\n         instrumentation = m.instrumentation\n       }\n     }\n+    manifest.functions = sortObjectByKey(manifest.functions)\n+    manifest.middleware = sortObjectByKey(manifest.middleware)\n     const updateFunctionDefinition = (\n       fun: EdgeFunctionDefinition\n     ): EdgeFunctionDefinition => {\n@@ -696,7 +712,7 @@ export class TurbopackManifestLoader {\n     for (const m of manifests) {\n       Object.assign(manifest, m)\n     }\n-    return manifest\n+    return sortObjectByKey(manifest)\n   }\n \n   private async writePagesManifest(): Promise<void> {\n@@ -733,3 +749,15 @@ export class TurbopackManifestLoader {\n     }\n   }\n }\n+\n+function sortObjectByKey(obj: Record<string, any>) {\n+  return Object.keys(obj)\n+    .sort()\n+    .reduce(\n+      (acc, key) => {\n+        acc[key] = obj[key]\n+        return acc\n+      },\n+      {} as Record<string, any>\n+    )\n+}"
        },
        {
            "sha": "ac651fded253a389e67f185a5a291768a1eb6c5a",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 41,
            "deletions": 4,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=93c91cad31085125ef2cc1fb7b8d45152cecf897",
            "patch": "@@ -447,6 +447,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             this: &TurboTasksBackendInner<B>,\n             task: &impl TaskGuard,\n             reader: Option<TaskId>,\n+            ctx: &impl ExecuteContext<'_>,\n         ) -> Option<std::result::Result<std::result::Result<RawVc, EventListener>, anyhow::Error>>\n         {\n             match get!(task, InProgress) {\n@@ -457,10 +458,18 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n                     marked_as_completed,\n                     done_event,\n                     ..\n-                })) if !*marked_as_completed => {\n-                    Some(Ok(Err(listen_to_done_event(this, reader, done_event))))\n+                })) => {\n+                    if !*marked_as_completed {\n+                        Some(Ok(Err(listen_to_done_event(this, reader, done_event))))\n+                    } else {\n+                        None\n+                    }\n                 }\n-                _ => None,\n+                Some(InProgressState::Canceled) => Some(Err(anyhow::anyhow!(\n+                    \"{} was canceled\",\n+                    ctx.get_task_description(task.id())\n+                ))),\n+                None => None,\n             }\n         }\n \n@@ -545,7 +554,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             }\n         }\n \n-        if let Some(value) = check_in_progress(self, &task, reader) {\n+        if let Some(value) = check_in_progress(self, &task, reader, &ctx) {\n             return value;\n         }\n \n@@ -755,6 +764,9 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n                 InProgressState::Scheduled { .. } => {\n                     // Already scheduled\n                 }\n+                InProgressState::Canceled => {\n+                    bail!(\"{} was canceled\", ctx.get_task_description(task_id));\n+                }\n             }\n         } else if task.add(CachedDataItem::new_scheduled(\n             self.get_task_desc_fn(task_id),\n@@ -1077,6 +1089,27 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             .map(|task_type| task_type.fn_type)\n     }\n \n+    fn task_execution_canceled(\n+        &self,\n+        task_id: TaskId,\n+        turbo_tasks: &dyn TurboTasksBackendApi<TurboTasksBackend<B>>,\n+    ) {\n+        let mut ctx = self.execute_context(turbo_tasks);\n+        let mut task = ctx.task(task_id, TaskDataCategory::Data);\n+        if let Some(in_progress) = remove!(task, InProgress) {\n+            match in_progress {\n+                InProgressState::Scheduled { done_event } => done_event.notify(usize::MAX),\n+                InProgressState::InProgress(box InProgressStateInner { done_event, .. }) => {\n+                    done_event.notify(usize::MAX)\n+                }\n+                InProgressState::Canceled => {}\n+            }\n+        }\n+        task.add_new(CachedDataItem::InProgress {\n+            value: InProgressState::Canceled,\n+        });\n+    }\n+\n     fn try_start_task_execution(\n         &self,\n         task_id: TaskId,\n@@ -2036,6 +2069,10 @@ impl<B: BackingStorage> Backend for TurboTasksBackend<B> {\n     type TaskState = ();\n     fn new_task_state(&self, _task: TaskId) -> Self::TaskState {}\n \n+    fn task_execution_canceled(&self, task: TaskId, turbo_tasks: &dyn TurboTasksBackendApi<Self>) {\n+        self.0.task_execution_canceled(task, turbo_tasks)\n+    }\n+\n     fn try_start_task_execution(\n         &self,\n         task_id: TaskId,"
        },
        {
            "sha": "d0c6e8c66da692e21e8bcabd84b50b002e81701f",
            "filename": "turbopack/crates/turbo-tasks-backend/src/data.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs?ref=93c91cad31085125ef2cc1fb7b8d45152cecf897",
            "patch": "@@ -320,6 +320,7 @@ pub struct InProgressStateInner {\n pub enum InProgressState {\n     Scheduled { done_event: Event },\n     InProgress(Box<InProgressStateInner>),\n+    Canceled,\n }\n \n transient_traits!(InProgressState);"
        },
        {
            "sha": "31e5b9c780dcd9cefaf51f0baf8d12d19d25402c",
            "filename": "turbopack/crates/turbo-tasks-memory/src/memory_backend.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Fmemory_backend.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Fmemory_backend.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Fmemory_backend.rs?ref=93c91cad31085125ef2cc1fb7b8d45152cecf897",
            "patch": "@@ -395,6 +395,14 @@ impl Backend for MemoryBackend {\n         }\n     }\n \n+    fn task_execution_canceled(\n+        &self,\n+        _task: TaskId,\n+        _turbo_tasks: &dyn TurboTasksBackendApi<Self>,\n+    ) {\n+        todo!()\n+    }\n+\n     fn try_start_task_execution<'a>(\n         &'a self,\n         task: TaskId,"
        },
        {
            "sha": "fec266da3b41e357bb71b21fc8f575e5bcd7796c",
            "filename": "turbopack/crates/turbo-tasks/src/backend.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs?ref=93c91cad31085125ef2cc1fb7b8d45152cecf897",
            "patch": "@@ -453,6 +453,8 @@ pub trait Backend: Sync + Send {\n         turbo_tasks: &dyn TurboTasksBackendApi<Self>,\n     ) -> Option<TaskExecutionSpec<'a>>;\n \n+    fn task_execution_canceled(&self, task: TaskId, turbo_tasks: &dyn TurboTasksBackendApi<Self>);\n+\n     fn task_execution_result(\n         &self,\n         task: TaskId,"
        },
        {
            "sha": "b6213ce5a09b41590efc46ce6b2cd2c7e3a0840d",
            "filename": "turbopack/crates/turbo-tasks/src/manager.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/93c91cad31085125ef2cc1fb7b8d45152cecf897/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs?ref=93c91cad31085125ef2cc1fb7b8d45152cecf897",
            "patch": "@@ -647,6 +647,7 @@ impl<B: Backend + 'static> TurboTasks<B> {\n                 )));\n                 let single_execution_future = async {\n                     if this.stopped.load(Ordering::Acquire) {\n+                        this.backend.task_execution_canceled(task_id, &*this);\n                         return false;\n                     }\n "
        }
    ],
    "stats": {
        "total": 89,
        "additions": 83,
        "deletions": 6
    }
}