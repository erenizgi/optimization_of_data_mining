{
    "author": "sebmarkbage",
    "message": "Make params and searchParams new Promises (#85158)\n\nThe problem is that without a new Promise, when all the awaits are in\nthird party, we'd keep searching down to the inner most which shows\n`internal params`. We could maybe make the real value of those include\nall params. But we can also just not dedupe to show the real value.",
    "sha": "d2bbca9866a1eeb435d22cfbe2afcb64ed1a7aaa",
    "files": [
        {
            "sha": "3601ca235fe7bb01351c1478c38d63689fb9880b",
            "filename": "packages/next/src/server/request/params.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d2bbca9866a1eeb435d22cfbe2afcb64ed1a7aaa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d2bbca9866a1eeb435d22cfbe2afcb64ed1a7aaa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts?ref=d2bbca9866a1eeb435d22cfbe2afcb64ed1a7aaa",
            "patch": "@@ -456,15 +456,17 @@ function makeDynamicallyTrackedParamsWithDevWarnings(\n   requestStore: RequestStore\n ): Promise<Params> {\n   if (requestStore.asyncApiPromises && hasFallbackParams) {\n-    // Deliberately don't wrap each instance of params in a `new Promise()`.\n-    // We want React Devtools to consider all the separate `params` promises\n-    // that we create for each segment to be triggered by one IO operation --\n-    // the resolving of the underlying `sharedParamsParent` promise.\n-    // It's created above any userspace code and has a `displayName`,\n-    // so it should show up in \"suspended by\".\n-    const promise = requestStore.asyncApiPromises.sharedParamsParent.then(\n-      () => underlyingParams\n-    )\n+    // We wrap each instance of params in a `new Promise()`, because deduping\n+    // them across requests doesn't work anyway and this let us show each\n+    // await a different set of values. This is important when all awaits\n+    // are in third party which would otherwise track all the way to the\n+    // internal params.\n+    const sharedParamsParent = requestStore.asyncApiPromises.sharedParamsParent\n+    const promise: Promise<Params> = new Promise((resolve, reject) => {\n+      sharedParamsParent.then(() => resolve(underlyingParams), reject)\n+    })\n+    // @ts-expect-error\n+    promise.displayName = 'params'\n     return instrumentParamsPromiseWithDevWarnings(\n       underlyingParams,\n       promise,"
        },
        {
            "sha": "bf12bfae5249c6bd3313e74a5aea6d62cc0f8da3",
            "filename": "packages/next/src/server/request/search-params.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/d2bbca9866a1eeb435d22cfbe2afcb64ed1a7aaa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d2bbca9866a1eeb435d22cfbe2afcb64ed1a7aaa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts?ref=d2bbca9866a1eeb435d22cfbe2afcb64ed1a7aaa",
            "patch": "@@ -423,15 +423,16 @@ function makeUntrackedSearchParamsWithDevWarningsImpl(\n \n   let promise: Promise<SearchParams>\n   if (requestStore.asyncApiPromises) {\n-    // Deliberately don't wrap each instance of params in a `new Promise()`.\n-    // We want React Devtools to consider all the separate `searchParams` promises\n-    // that we create for each segment to be triggered by one IO operation --\n-    // the resolving of the underlying `sharedParamsParent` promise.\n-    // It's created above any userspace code and has a `displayName`,\n-    // so it should show up in \"suspended by\".\n-    promise = requestStore.asyncApiPromises.sharedSearchParamsParent.then(\n-      () => proxiedUnderlying\n-    )\n+    // We wrap each instance of searchParams in a `new Promise()`.\n+    // This is important when all awaits are in third party which would otherwise\n+    // track all the way to the internal params.\n+    const sharedSearchParamsParent =\n+      requestStore.asyncApiPromises.sharedSearchParamsParent\n+    promise = new Promise((resolve, reject) => {\n+      sharedSearchParamsParent.then(() => resolve(proxiedUnderlying), reject)\n+    })\n+    // @ts-expect-error\n+    promise.displayName = 'searchParams'\n   } else {\n     promise = makeDevtoolsIOAwarePromise(\n       proxiedUnderlying,"
        }
    ],
    "stats": {
        "total": 39,
        "additions": 21,
        "deletions": 18
    }
}