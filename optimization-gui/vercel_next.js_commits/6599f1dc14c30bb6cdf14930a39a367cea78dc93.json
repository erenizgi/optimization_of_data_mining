{
    "author": "lubieowoce",
    "message": "provide declarations for server-only/client-only (#80361)\n\nWe implement the behavior of `import 'server-only'` and `import\n'client-only'` on the compiler level and thus don't require having them\ninstalled as dependencies. By default it works fine with typescript,\nbecause (surprisingly) TSC *doesn't check side-effecting imports*.\nBut this behavior can be overridden with\n[`noUncheckedSideEffectImports`](https://www.typescriptlang.org/tsconfig/#noUncheckedSideEffectImports)\nwhich'd cause `import 'server-only'` to start erroring. To prevent that,\nwe add declarations for them in next's global type declarations.",
    "sha": "6599f1dc14c30bb6cdf14930a39a367cea78dc93",
    "files": [
        {
            "sha": "572fb6d737ee5f6e9bd278b056492a7259d885ff",
            "filename": "packages/next/types/global.d.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/6599f1dc14c30bb6cdf14930a39a367cea78dc93/packages%2Fnext%2Ftypes%2Fglobal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6599f1dc14c30bb6cdf14930a39a367cea78dc93/packages%2Fnext%2Ftypes%2Fglobal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2Fglobal.d.ts?ref=6599f1dc14c30bb6cdf14930a39a367cea78dc93",
            "patch": "@@ -43,6 +43,30 @@ declare module '*.module.scss' {\n   export default classes\n }\n \n+// We implement the behavior of `import 'server-only'` and `import 'client-only'` on the compiler level\n+// and thus don't require having them installed as dependencies.\n+// By default it works fine with typescript, because (surprisingly) TSC *doesn't check side-effecting imports*.\n+// But this behavior can be overridden with `noUncheckedSideEffectImports`\n+// (https://www.typescriptlang.org/tsconfig/#noUncheckedSideEffectImports)\n+// which'd cause `import 'server-only'` to start erroring.\n+// To prevent that, we add declarations for them here.\n+\n+declare module 'server-only' {\n+  /**\n+   * `import 'server-only'` marks your module as only usable on the server\n+   * and prevents it from being used on the client.\n+   * Read more: https://nextjs.org/docs/app/getting-started/server-and-client-components#preventing-environment-poisoning\n+   */\n+}\n+\n+declare module 'client-only' {\n+  /**\n+   * `import 'client-only'` marks your module as only usable on the client\n+   * and prevents it from being used on the server.\n+   * Read more: https://nextjs.org/docs/app/getting-started/server-and-client-components#preventing-environment-poisoning\n+   */\n+}\n+\n interface Window {\n   MSInputMethodContext?: unknown\n   /** @internal */"
        },
        {
            "sha": "2f512798697add059e8fd4b9e73f21250c913725",
            "filename": "test/production/typescript-checked-side-effect-imports/.gitignore",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2F.gitignore",
            "raw_url": "https://github.com/vercel/next.js/raw/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2F.gitignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2F.gitignore?ref=6599f1dc14c30bb6cdf14930a39a367cea78dc93",
            "patch": "@@ -0,0 +1,2 @@\n+# tsconfig.json in tests is excluded by default, but we customize it for this test, so it needs to be included\n+!tsconfig.json\n\\ No newline at end of file"
        },
        {
            "sha": "31133d7475ddc8bd02fb0d3fbf168fe9ec932cb7",
            "filename": "test/production/typescript-checked-side-effect-imports/app/client/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Fclient%2Fpage.tsx?ref=6599f1dc14c30bb6cdf14930a39a367cea78dc93",
            "patch": "@@ -0,0 +1,6 @@\n+'use client'\n+import 'client-only'\n+\n+export default function Page() {\n+  return <>Hello</>\n+}"
        },
        {
            "sha": "0b605f1646c61f508d568290872e3541ea582544",
            "filename": "test/production/typescript-checked-side-effect-imports/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Flayout.tsx?ref=6599f1dc14c30bb6cdf14930a39a367cea78dc93",
            "patch": "@@ -0,0 +1,9 @@\n+import type { ReactNode } from 'react'\n+\n+export default function RootLayout({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "7d09b169ca6686a59b9f294c1d1469dc66fb32ca",
            "filename": "test/production/typescript-checked-side-effect-imports/app/server/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Fserver%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Fserver%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fapp%2Fserver%2Fpage.tsx?ref=6599f1dc14c30bb6cdf14930a39a367cea78dc93",
            "patch": "@@ -0,0 +1,5 @@\n+import 'server-only'\n+\n+export default function Page() {\n+  return <>Hello</>\n+}"
        },
        {
            "sha": "7370d4f5922fd0e2122832b371cdde98d5438c9b",
            "filename": "test/production/typescript-checked-side-effect-imports/index.test.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Findex.test.ts?ref=6599f1dc14c30bb6cdf14930a39a367cea78dc93",
            "patch": "@@ -0,0 +1,23 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('Imports of server/client-only with noUncheckedSideEffectImports', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true, // No need to run this in deployment mode.\n+    skipStart: true,\n+  })\n+  if (skipped) return\n+\n+  let buildResult: Awaited<ReturnType<(typeof next)['build']>>\n+  beforeAll(async () => {\n+    buildResult = await next.build()\n+  })\n+\n+  it('Should build without typescript errors', async () => {\n+    // If something's wrong with our declarations of these modules, TSC will error with:\n+    //   `Type error: Cannot find module 'server-only' or its corresponding type declarations.`\n+    expect(buildResult.cliOutput).not.toContain('server-only')\n+    expect(buildResult.cliOutput).not.toContain('client-only')\n+    expect(buildResult.exitCode).toBe(0)\n+  })\n+})"
        },
        {
            "sha": "3e9ad88b46aa0943c0f290853a6c8d6426a243ed",
            "filename": "test/production/typescript-checked-side-effect-imports/next.config.ts",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Fnext.config.ts?ref=6599f1dc14c30bb6cdf14930a39a367cea78dc93",
            "patch": "@@ -0,0 +1,3 @@\n+import type { NextConfig } from 'next'\n+const nextConfig: NextConfig = {}\n+export default nextConfig"
        },
        {
            "sha": "ec1b906c5e51cb899160a0e527e4d4f306c0a5ca",
            "filename": "test/production/typescript-checked-side-effect-imports/tsconfig.json",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/6599f1dc14c30bb6cdf14930a39a367cea78dc93/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Ftypescript-checked-side-effect-imports%2Ftsconfig.json?ref=6599f1dc14c30bb6cdf14930a39a367cea78dc93",
            "patch": "@@ -0,0 +1,28 @@\n+{\n+  \"compilerOptions\": {\n+    // the only change from the default tsconfig.\n+    // this forces `import 'server-only'` and `import 'client-only'` to be checked.\n+    \"noUncheckedSideEffectImports\": true,\n+\n+    \"target\": \"ES2017\",\n+    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n+    \"allowJs\": true,\n+    \"skipLibCheck\": true,\n+    \"strict\": false,\n+    \"noEmit\": true,\n+    \"incremental\": true,\n+    \"module\": \"esnext\",\n+    \"esModuleInterop\": true,\n+    \"moduleResolution\": \"node\",\n+    \"resolveJsonModule\": true,\n+    \"isolatedModules\": true,\n+    \"jsx\": \"preserve\",\n+    \"plugins\": [\n+      {\n+        \"name\": \"next\"\n+      }\n+    ]\n+  },\n+  \"include\": [\"next-env.d.ts\", \".next/types/**/*.ts\", \"**/*.ts\", \"**/*.tsx\"],\n+  \"exclude\": [\"node_modules\", \"**/*.test.ts\", \"**/*.test.tsx\"]\n+}"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 100,
        "deletions": 0
    }
}