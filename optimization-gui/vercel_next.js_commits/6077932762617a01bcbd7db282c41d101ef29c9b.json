{
    "author": "ztanner",
    "message": "[test]: de-flake client-cache.original.test.ts (#84831)\n\nThis has been frequently flaking on deployment tests\n([ex](https://github.com/vercel/next.js/actions/runs/18420977957/job/52496287125))\n\n- refactored from deprecated `check` to `retry`\n- added more explicit waitForElement signals before proceeding in the\ntest flow\n\nValidated the change by running it 6 times locally.\n\nTest run:\nhttps://github.com/vercel/next.js/actions/runs/18470261924/job/52637178224",
    "sha": "6077932762617a01bcbd7db282c41d101ef29c9b",
    "files": [
        {
            "sha": "c161bff800ba7ebe0dc1db99fec84748872cd0bb",
            "filename": "test/e2e/app-dir/app-client-cache/client-cache.original.test.ts",
            "status": "modified",
            "additions": 133,
            "deletions": 137,
            "changes": 270,
            "blob_url": "https://github.com/vercel/next.js/blob/6077932762617a01bcbd7db282c41d101ef29c9b/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.original.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6077932762617a01bcbd7db282c41d101ef29c9b/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.original.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-client-cache%2Fclient-cache.original.test.ts?ref=6077932762617a01bcbd7db282c41d101ef29c9b",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { check, retry } from 'next-test-utils'\n+import { retry } from 'next-test-utils'\n import { Playwright } from 'next-webdriver'\n import {\n   browserConfigWithFixedTime,\n@@ -25,13 +25,16 @@ describe('app dir client cache semantics (30s/5min)', () => {\n \n       // navigate to prefetch-auto page\n       await browser.elementByCss('[href=\"/1\"]').click()\n+      await browser.waitForElementByCss('#random-number')\n \n       let initialNumber = await browser.elementById('random-number').text()\n \n       // Navigate back to the index, and then back to the prefetch-auto page\n       await browser.elementByCss('[href=\"/\"]').click()\n+      await browser.waitForElementByCss('[href=\"/1\"]')\n       await browser.eval(fastForwardTo, 5 * 1000)\n       await browser.elementByCss('[href=\"/1\"]').click()\n+      await browser.waitForElementByCss('#random-number')\n \n       let newNumber = await browser.elementById('random-number').text()\n \n@@ -43,7 +46,9 @@ describe('app dir client cache semantics (30s/5min)', () => {\n \n       // Navigate back to the index, and then back to the prefetch-auto page\n       await browser.elementByCss('[href=\"/\"]').click()\n+      await browser.waitForElementByCss('[href=\"/1\"]')\n       await browser.elementByCss('[href=\"/1\"]').click()\n+      await browser.waitForElementByCss('#random-number')\n \n       newNumber = await browser.elementById('random-number').text()\n \n@@ -58,7 +63,9 @@ describe('app dir client cache semantics (30s/5min)', () => {\n \n       // Navigate back to the index, and then back to the prefetch-auto page\n       await browser.elementByCss('[href=\"/\"]').click()\n+      await browser.waitForElementByCss('[href=\"/1\"]')\n       await browser.elementByCss('[href=\"/1\"]').click()\n+      await browser.waitForElementByCss('#random-number')\n \n       newNumber = await browser.elementById('random-number').text()\n \n@@ -76,52 +83,49 @@ describe('app dir client cache semantics (30s/5min)', () => {\n       it('should prefetch the full page', async () => {\n         const { getRequests, clearRequests } =\n           await createRequestsListener(browser)\n-        await check(() => {\n-          return getRequests().some(\n-            ([url, didPartialPrefetch]) =>\n-              getPathname(url) === '/0' && !didPartialPrefetch\n-          )\n-            ? 'success'\n-            : 'fail'\n-        }, 'success')\n+        await retry(() => {\n+          expect(\n+            getRequests().some(\n+              ([url, didPartialPrefetch]) =>\n+                getPathname(url) === '/0' && !didPartialPrefetch\n+            )\n+          ).toBe(true)\n+        })\n \n         clearRequests()\n \n-        await browser\n-          .elementByCss('[href=\"/0?timeout=0\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n+        await browser.elementByCss('[href=\"/0?timeout=0\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n \n-        expect(\n-          getRequests().every(([url]) => getPathname(url) !== '/0')\n-        ).toEqual(true)\n+        await retry(() => {\n+          const requests = getRequests()\n+          expect(requests.every(([url]) => getPathname(url) !== '/0')).toBe(\n+            true\n+          )\n+        })\n       })\n       it('should re-use the cache for the full page, only for 5 mins', async () => {\n-        const randomNumber = await browser\n-          .elementByCss('[href=\"/0?timeout=0\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/0?timeout=0\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const randomNumber = await browser.elementById('random-number').text()\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/0?timeout=0\"]')\n \n-        const number = await browser\n-          .elementByCss('[href=\"/0?timeout=0\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/0?timeout=0\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const number = await browser.elementById('random-number').text()\n \n         expect(number).toBe(randomNumber)\n \n         await browser.eval(fastForwardTo, 5 * 60 * 1000)\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/0?timeout=0\"]')\n \n-        const newNumber = await browser\n-          .elementByCss('[href=\"/0?timeout=0\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/0?timeout=0\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const newNumber = await browser.elementById('random-number').text()\n \n         expect(newNumber).not.toBe(randomNumber)\n       })\n@@ -130,40 +134,37 @@ describe('app dir client cache semantics (30s/5min)', () => {\n         const { getRequests, clearRequests } =\n           await createRequestsListener(browser)\n \n-        await check(() => {\n-          return getRequests().some(\n-            ([url, didPartialPrefetch]) =>\n-              getPathname(url) === '/0' && !didPartialPrefetch\n-          )\n-            ? 'success'\n-            : 'fail'\n-        }, 'success')\n+        await retry(() => {\n+          expect(\n+            getRequests().some(\n+              ([url, didPartialPrefetch]) =>\n+                getPathname(url) === '/0' && !didPartialPrefetch\n+            )\n+          ).toBe(true)\n+        })\n \n-        const randomNumber = await browser\n-          .elementByCss('[href=\"/0?timeout=0\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/0?timeout=0\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const randomNumber = await browser.elementById('random-number').text()\n \n         await browser.eval(fastForwardTo, 5 * 60 * 1000)\n         clearRequests()\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/0?timeout=0\"]')\n \n-        await check(() => {\n-          return getRequests().some(\n-            ([url, didPartialPrefetch]) =>\n-              getPathname(url) === '/0' && !didPartialPrefetch\n-          )\n-            ? 'success'\n-            : 'fail'\n-        }, 'success')\n+        await retry(() => {\n+          expect(\n+            getRequests().some(\n+              ([url, didPartialPrefetch]) =>\n+                getPathname(url) === '/0' && !didPartialPrefetch\n+            )\n+          ).toBe(true)\n+        })\n \n-        const number = await browser\n-          .elementByCss('[href=\"/0?timeout=0\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/0?timeout=0\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const number = await browser.elementById('random-number').text()\n \n         expect(number).not.toBe(randomNumber)\n       })\n@@ -177,14 +178,15 @@ describe('app dir client cache semantics (30s/5min)', () => {\n       it('should not prefetch the page at all', async () => {\n         const { getRequests } = await createRequestsListener(browser)\n \n-        await browser\n-          .elementByCss('[href=\"/2\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n+        await browser.elementByCss('[href=\"/2\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n \n-        expect(\n-          getRequests().filter(([url]) => getPathname(url) === '/2')\n-        ).toHaveLength(1)\n+        await retry(() => {\n+          const requests = getRequests().filter(\n+            ([url]) => getPathname(url) === '/2'\n+          )\n+          expect(requests.length).toBe(1)\n+        })\n \n         expect(\n           getRequests().some(\n@@ -194,31 +196,27 @@ describe('app dir client cache semantics (30s/5min)', () => {\n         ).toBe(false)\n       })\n       it('should re-use the cache only for 30 seconds', async () => {\n-        const randomNumber = await browser\n-          .elementByCss('[href=\"/2\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/2\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const randomNumber = await browser.elementById('random-number').text()\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/2\"]')\n \n-        const number = await browser\n-          .elementByCss('[href=\"/2\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/2\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const number = await browser.elementById('random-number').text()\n \n         expect(number).toBe(randomNumber)\n \n         await browser.eval(fastForwardTo, 30 * 1000)\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/2\"]')\n \n-        const newNumber = await browser\n-          .elementByCss('[href=\"/2\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/2\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const newNumber = await browser.elementById('random-number').text()\n \n         expect(newNumber).not.toBe(randomNumber)\n       })\n@@ -234,81 +232,79 @@ describe('app dir client cache semantics (30s/5min)', () => {\n         const { getRequests, clearRequests } =\n           await createRequestsListener(browser)\n \n-        await check(() => {\n-          return getRequests().some(\n-            ([url, didPartialPrefetch]) =>\n-              getPathname(url) === '/1' && didPartialPrefetch\n-          )\n-            ? 'success'\n-            : 'fail'\n-        }, 'success')\n+        await retry(() => {\n+          expect(\n+            getRequests().some(\n+              ([url, didPartialPrefetch]) =>\n+                getPathname(url) === '/1' && didPartialPrefetch\n+            )\n+          ).toBe(true)\n+        })\n \n         clearRequests()\n \n-        await browser\n-          .elementByCss('[href=\"/1\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n+        await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n \n-        expect(\n-          getRequests().some(\n-            ([url, didPartialPrefetch]) =>\n-              getPathname(url) === '/1' && !didPartialPrefetch\n-          )\n-        ).toBe(true)\n+        await retry(() => {\n+          expect(\n+            getRequests().some(\n+              ([url, didPartialPrefetch]) =>\n+                getPathname(url) === '/1' && !didPartialPrefetch\n+            )\n+          ).toBe(true)\n+        })\n       })\n       it('should re-use the full cache for only 30 seconds', async () => {\n-        const randomNumber = await browser\n-          .elementByCss('[href=\"/1\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const randomNumber = await browser.elementById('random-number').text()\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/1\"]')\n \n-        const number = await browser\n-          .elementByCss('[href=\"/1\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const number = await browser.elementById('random-number').text()\n \n         expect(number).toBe(randomNumber)\n \n         await browser.eval(fastForwardTo, 5 * 1000)\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/1\"]')\n \n-        const newNumber = await browser\n-          .elementByCss('[href=\"/1\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const newNumber = await browser.elementById('random-number').text()\n \n         expect(newNumber).toBe(randomNumber)\n \n         await browser.eval(fastForwardTo, 30 * 1000)\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/1\"]')\n \n-        const newNumber2 = await browser\n-          .elementByCss('[href=\"/1\"]')\n-          .click()\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const newNumber2 = await browser.elementById('random-number').text()\n \n         expect(newNumber2).not.toBe(newNumber)\n       })\n \n       it('should renew the 30s cache once the data is revalidated', async () => {\n         // navigate to prefetch-auto page\n         await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n \n         let initialNumber = await browser.elementById('random-number').text()\n \n         // Navigate back to the index, and then back to the prefetch-auto page\n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/1\"]')\n         await browser.eval(fastForwardTo, 5 * 1000)\n         await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n \n         let newNumber = await browser.elementById('random-number').text()\n \n@@ -320,7 +316,9 @@ describe('app dir client cache semantics (30s/5min)', () => {\n \n         // Navigate back to the index, and then back to the prefetch-auto page\n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/1\"]')\n         await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n \n         newNumber = await browser.elementById('random-number').text()\n \n@@ -335,7 +333,9 @@ describe('app dir client cache semantics (30s/5min)', () => {\n \n         // Navigate back to the index, and then back to the prefetch-auto page\n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/1\"]')\n         await browser.elementByCss('[href=\"/1\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n \n         newNumber = await browser.elementById('random-number').text()\n \n@@ -344,31 +344,18 @@ describe('app dir client cache semantics (30s/5min)', () => {\n       })\n \n       it('should refetch below the fold after 30 seconds', async () => {\n-        const randomLoadingNumber = await browser\n-          .elementByCss('[href=\"/1?timeout=1000\"]')\n-          .click()\n-          .waitForElementByCss('#loading')\n-          .text()\n-\n-        const randomNumber = await browser\n-          .waitForElementByCss('#random-number')\n-          .text()\n+        await browser.elementByCss('[href=\"/1?timeout=1000\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const randomNumber = await browser.elementById('random-number').text()\n \n         await browser.elementByCss('[href=\"/\"]').click()\n+        await browser.waitForElementByCss('[href=\"/1?timeout=1000\"]')\n \n         await browser.eval(fastForwardTo, 30 * 1000)\n \n-        const newLoadingNumber = await browser\n-          .elementByCss('[href=\"/1?timeout=1000\"]')\n-          .click()\n-          .waitForElementByCss('#loading')\n-          .text()\n-\n-        const newNumber = await browser\n-          .waitForElementByCss('#random-number')\n-          .text()\n-\n-        expect(newLoadingNumber).toBe(randomLoadingNumber)\n+        await browser.elementByCss('[href=\"/1?timeout=1000\"]').click()\n+        await browser.waitForElementByCss('#random-number')\n+        const newNumber = await browser.elementById('random-number').text()\n \n         expect(newNumber).not.toBe(randomNumber)\n       })\n@@ -429,12 +416,18 @@ describe('app dir client cache semantics (30s/5min)', () => {\n     it('should seed the prefetch cache with the fetched page data', async () => {\n       const browser = await next.browser('/1', browserConfigWithFixedTime)\n \n+      await browser.waitForElementByCss('#random-number')\n       const initialNumber = await browser.elementById('random-number').text()\n \n       // Move forward a few seconds, navigate off the page and then back to it\n       await browser.eval(fastForwardTo, 5 * 1000)\n       await browser.elementByCss('[href=\"/\"]').click()\n+      await browser.waitForElementByCss('[href=\"/1\"]')\n+\n+      await browser.waitForIdleNetwork()\n+\n       await browser.elementByCss('[href=\"/1\"]').click()\n+      await browser.waitForElementByCss('#random-number')\n \n       const newNumber = await browser.elementById('random-number').text()\n \n@@ -448,12 +441,15 @@ describe('app dir client cache semantics (30s/5min)', () => {\n         browserConfigWithFixedTime\n       )\n \n+      await browser.waitForElementByCss('#random-number')\n       const initialNumber = await browser.elementById('random-number').text()\n \n       // Expire the cache\n       await browser.eval(fastForwardTo, 30 * 1000)\n       await browser.elementByCss('[href=\"/without-loading\"]').click()\n+      await browser.waitForElementByCss('[href=\"/without-loading/1\"]')\n       await browser.elementByCss('[href=\"/without-loading/1\"]').click()\n+      await browser.waitForElementByCss('#random-number')\n \n       const newNumber = await browser.elementById('random-number').text()\n "
        }
    ],
    "stats": {
        "total": 270,
        "additions": 133,
        "deletions": 137
    }
}