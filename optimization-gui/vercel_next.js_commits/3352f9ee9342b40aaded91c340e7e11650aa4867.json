{
    "author": "unstubbable",
    "message": "[test] Don't use `request.allHeaders()` in sync `page.on()` callbacks (#86751)",
    "sha": "3352f9ee9342b40aaded91c340e7e11650aa4867",
    "files": [
        {
            "sha": "577d70ca0973dbb2c514527ce3984a03b2a1f837",
            "filename": "test/e2e/app-dir/app-basepath/index.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 16,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/3352f9ee9342b40aaded91c340e7e11650aa4867/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3352f9ee9342b40aaded91c340e7e11650aa4867/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts?ref=3352f9ee9342b40aaded91c340e7e11650aa4867",
            "patch": "@@ -75,22 +75,8 @@ describe('app dir - basepath', () => {\n       let rscRequests = []\n       const browser = await next.browser(path, {\n         beforePageLoad(page) {\n-          page.on('request', async (request) => {\n-            let headers: { [key: string]: string }\n-            try {\n-              headers = await request.allHeaders()\n-            } catch (e) {\n-              if (\n-                e.message.includes(\n-                  'Target page, context or browser has been closed'\n-                )\n-              ) {\n-                // Ignore errors caused by closed browser during test teardown\n-                return\n-              }\n-              throw e\n-            }\n-\n+          page.on('request', (request) => {\n+            const headers = request.headers()\n             if (\n               headers['rsc'] === '1' &&\n               // Prefetches also include `rsc`\n@@ -103,6 +89,7 @@ describe('app dir - basepath', () => {\n       })\n \n       await browser.elementByCss('button').click()\n+      await browser.waitForIdleNetwork()\n       await retry(async () => {\n         expect(rscRequests).toEqual([\n           expect.stringContaining(`${next.url}${path}`),"
        },
        {
            "sha": "9a98620729db30a2e480aebd535a8f628a204923",
            "filename": "test/e2e/switchable-runtime/index.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 10,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/3352f9ee9342b40aaded91c340e7e11650aa4867/test%2Fe2e%2Fswitchable-runtime%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3352f9ee9342b40aaded91c340e7e11650aa4867/test%2Fe2e%2Fswitchable-runtime%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fswitchable-runtime%2Findex.test.ts?ref=3352f9ee9342b40aaded91c340e7e11650aa4867",
            "patch": "@@ -107,11 +107,10 @@ describe('Switchable runtime', () => {\n         const browser = await webdriver(context.appPort, '/node', {\n           beforePageLoad(page) {\n             page.on('request', (request) => {\n-              return request.allHeaders().then((headers) => {\n-                if (headers['rsc'] === '1') {\n-                  flightRequest = request.url()\n-                }\n-              })\n+              const headers = request.headers()\n+              if (headers['rsc'] === '1') {\n+                flightRequest = request.url()\n+              }\n             })\n           },\n         })\n@@ -639,11 +638,10 @@ describe('Switchable runtime', () => {\n         const browser = await webdriver(context.appPort, '/node', {\n           beforePageLoad(page) {\n             page.on('request', (request) => {\n-              request.allHeaders().then((headers) => {\n-                if (headers['rsc'] === '1') {\n-                  flightRequest = request.url()\n-                }\n-              })\n+              const headers = request.headers()\n+              if (headers['rsc'] === '1') {\n+                flightRequest = request.url()\n+              }\n             })\n           },\n         })"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 11,
        "deletions": 26
    }
}