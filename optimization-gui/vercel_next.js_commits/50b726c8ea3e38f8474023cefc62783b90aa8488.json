{
    "author": "eps1lon",
    "message": "Only retry if canary fails on required jobs (#83851)",
    "sha": "50b726c8ea3e38f8474023cefc62783b90aa8488",
    "files": [
        {
            "sha": "d971d68c5e43307ddb042179fe5db9f8db3f09c7",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/50b726c8ea3e38f8474023cefc62783b90aa8488/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/50b726c8ea3e38f8474023cefc62783b90aa8488/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=50b726c8ea3e38f8474023cefc62783b90aa8488",
            "patch": "@@ -708,6 +708,7 @@ jobs:\n   buildPassed:\n     needs: ['deploy-target', 'build', 'build-wasm', 'build-native']\n     if: ${{ always() && needs.deploy-target.outputs.value != '' }}\n+    # Coupled with retry logic in retry_test.yml\n     name: thank you, build\n     runs-on: ubuntu-latest\n     steps:"
        },
        {
            "sha": "a741e858daaaa990c83bce2ce64dc661006ac28a",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/50b726c8ea3e38f8474023cefc62783b90aa8488/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/50b726c8ea3e38f8474023cefc62783b90aa8488/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=50b726c8ea3e38f8474023cefc62783b90aa8488",
            "patch": "@@ -1052,6 +1052,7 @@ jobs:\n \n     if: always()\n     runs-on: ubuntu-latest\n+    # Coupled with retry logic in retry_test.yml\n     name: thank you, next\n     steps:\n       - run: exit 1"
        },
        {
            "sha": "d2c18911d575380b52e8f1b9717b97211727b25d",
            "filename": ".github/workflows/retry_test.yml",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/50b726c8ea3e38f8474023cefc62783b90aa8488/.github%2Fworkflows%2Fretry_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/50b726c8ea3e38f8474023cefc62783b90aa8488/.github%2Fworkflows%2Fretry_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fretry_test.yml?ref=50b726c8ea3e38f8474023cefc62783b90aa8488",
            "patch": "@@ -2,6 +2,8 @@ name: retry-tests\n \n on:\n   workflow_run:\n+    # Make sure that required_job_conclusion knows what the name of the required\n+    # job is in each workflow.\n     workflows: ['build-and-test', 'build-and-deploy']\n     branches: [canary]\n     types:\n@@ -25,7 +27,51 @@ jobs:\n       }}\n     runs-on: ubuntu-latest\n     steps:\n+      - name: Check conclusion of required job\n+        id: required_job_conclusion\n+        uses: actions/github-script@v7\n+        continue-on-error: true\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          script: |\n+            // See build-and-test.yml and build-and-deploy.yml for the required job names\n+            const requiredJobName = {\n+              'build-and-test': 'thank you, next',\n+              'build-and-deploy': 'thank you, build',\n+            }[context.workflow]\n+\n+            async function rerunIfRequiredNotSuccessful() {\n+              const result = await github.paginate.iterator(\n+                'GET /repos/{owner}/{repo}/actions/runs/{run_id}/attempts/{attempt_number}/jobs',\n+                {\n+                  attempt_number: context.payload.workflow_run.run_attempt,\n+                  owner: context.repo.owner,\n+                  repo: context.repo.repo,\n+                  run_id: context.payload.workflow_run.id,\n+                }\n+              )\n+\n+              for await (const { data: jobs } of result) {\n+                for (const job of jobs) {\n+                  if (job.name === requiredJobName) {\n+                    console.log(\n+                      \"Using conclusion '%s' from %s\",\n+                      job.conclusion,\n+                      job.html_url\n+                    )\n+                    return job.conclusion\n+                  }\n+                }\n+              }\n+\n+              console.log(\"Couldn't find job with name '%s'\", requiredJobName)\n+              return null\n+            }\n+\n+            return await rerunIfRequiredNotSuccessful()\n       - name: send retry request to GitHub API\n+        if: ${{ steps.required_job_conclusion.outputs.result != 'success' }}\n         env:\n           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n         run: |"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 48,
        "deletions": 0
    }
}