{
    "author": "Cy-Tek",
    "message": "cleanup(turbopack): Embed Global vs Specific channel type in the Rust type system (#79291)\n\n## Refactor CompilationEventQueue to use enum for event channel types\n\n### What?\nIntroduces a new `EventChannelType` enum to replace string-based event\nchannel identification in the `CompilationEventQueue`.\n\n### Why?\nThis change improves type safety by replacing string-based channel\nidentification with a proper enum. Using an enum instead of string\nliterals makes the code more robust and more self-evident in what it's\ntrying to accomplish.\n\n### How?\n- Created a new `EventChannelType` enum with two variants: `Global` and\n`Type(String)`\n- Updated the `subscribers` map to use `EventChannelType` as keys\ninstead of strings\n- Replaced string literals like `\"*\"` with the appropriate enum variant\n(`EventChannelType::Global`)\n- Modified the event subscription and publishing logic to work with the\nnew enum-based approach\n\n---------\n\nCo-authored-by: Tobias Koppers <tobias.koppers@googlemail.com>",
    "sha": "d55e2f84933bbbd84413c80afa0521ec15a7b801",
    "files": [
        {
            "sha": "56a025c126f4b2b815137197c9f702dd29b3f105",
            "filename": "turbopack/crates/turbo-tasks/src/message_queue.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 6,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/d55e2f84933bbbd84413c80afa0521ec15a7b801/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d55e2f84933bbbd84413c80afa0521ec15a7b801/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs?ref=d55e2f84933bbbd84413c80afa0521ec15a7b801",
            "patch": "@@ -15,15 +15,24 @@ const MAX_QUEUE_SIZE: usize = 256;\n type ArcMx<T> = Arc<Mutex<T>>;\n type CompilationEventChannel = mpsc::Sender<Arc<dyn CompilationEvent>>;\n \n+#[derive(Debug, Clone, Eq, PartialEq, Hash)]\n+enum EventChannelType {\n+    Global,\n+    Type(String),\n+}\n+\n pub struct CompilationEventQueue {\n     event_history: ArcMx<VecDeque<Arc<dyn CompilationEvent>>>,\n-    subscribers: Arc<DashMap<String, Vec<CompilationEventChannel>>>,\n+    subscribers: Arc<DashMap<EventChannelType, Vec<CompilationEventChannel>>>,\n }\n \n impl Default for CompilationEventQueue {\n     fn default() -> Self {\n         let subscribers = DashMap::new();\n-        subscribers.insert(\"*\".to_owned(), Vec::<CompilationEventChannel>::new());\n+        subscribers.insert(\n+            EventChannelType::Global,\n+            Vec::<CompilationEventChannel>::new(),\n+        );\n \n         Self {\n             event_history: Arc::new(Mutex::new(VecDeque::with_capacity(MAX_QUEUE_SIZE))),\n@@ -51,7 +60,9 @@ impl CompilationEventQueue {\n             history.push_back(message_clone.clone());\n \n             // Send to all active receivers of the same message type\n-            if let Some(mut type_subscribers) = subscribers.get_mut(message_clone.type_name()) {\n+            if let Some(mut type_subscribers) = subscribers.get_mut(&EventChannelType::Type(\n+                message_clone.type_name().to_owned(),\n+            )) {\n                 let mut removal_indices = Vec::new();\n                 for (ix, sender) in type_subscribers.iter().enumerate() {\n                     if sender.send(message_clone.clone()).await.is_err() {\n@@ -65,7 +76,7 @@ impl CompilationEventQueue {\n             }\n \n             // Send to all global message subscribers\n-            let mut all_channel = subscribers.get_mut(\"*\").unwrap();\n+            let mut all_channel = subscribers.get_mut(&EventChannelType::Global).unwrap();\n             let mut removal_indices = Vec::new();\n             for (ix, sender) in all_channel.iter_mut().enumerate() {\n                 if sender.send(message_clone.clone()).await.is_err() {\n@@ -95,7 +106,9 @@ impl CompilationEventQueue {\n             // Store the sender\n             if let Some(event_types) = event_types {\n                 for event_type in event_types.iter() {\n-                    let mut type_subscribers = subscribers.entry(event_type.clone()).or_default();\n+                    let mut type_subscribers = subscribers\n+                        .entry(EventChannelType::Type(event_type.clone()))\n+                        .or_default();\n                     type_subscribers.push(tx_clone.clone());\n                 }\n \n@@ -105,7 +118,8 @@ impl CompilationEventQueue {\n                     }\n                 }\n             } else {\n-                let mut global_subscribers = subscribers.entry(\"*\".to_string()).or_default();\n+                let mut global_subscribers =\n+                    subscribers.entry(EventChannelType::Global).or_default();\n                 global_subscribers.push(tx_clone.clone());\n \n                 for event in event_history.lock().await.iter() {"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 20,
        "deletions": 6
    }
}