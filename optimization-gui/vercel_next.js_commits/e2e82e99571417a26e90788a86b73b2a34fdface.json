{
    "author": "kdy1",
    "message": "perf(turbopack): Detect more immutable tasks (#80423)\n\n### What?\n\nSkip the dependency tracking for tasks that are analyzed to be immutable turbo tasks.\n\n### Why?\n\nWe can do so!\n\n---------\n\nCo-authored-by: Luke Sandberg <lukesandberg@users.noreply.github.com>",
    "sha": "e2e82e99571417a26e90788a86b73b2a34fdface",
    "files": [
        {
            "sha": "b2a02f08dbe2757a2de93083835b3560fa4ab295",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=e2e82e99571417a26e90788a86b73b2a34fdface",
            "patch": "@@ -1627,7 +1627,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             // new_children list now.\n             AggregationUpdateQueue::run(\n                 AggregationUpdateJob::DecreaseActiveCounts {\n-                    task_ids: new_children.into_iter().collect(),\n+                    task_ids: new_children.into_keys().collect(),\n                 },\n                 &mut ctx,\n             );\n@@ -1675,10 +1675,12 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n         let mut old_edges = Vec::new();\n \n         let has_children = !new_children.is_empty();\n+        let has_mutable_children =\n+            has_children && new_children.values().any(|is_immutable| !*is_immutable);\n \n-        // If the task is not stateful and has no children, it does not have a way to be invalidated\n-        // and we can mark it as immutable.\n-        if !stateful && !has_children {\n+        // If the task is not stateful and has no mutable children, it does not have a way to be\n+        // invalidated and we can mark it as immutable.\n+        if !stateful && !has_mutable_children {\n             task.mark_as_immutable();\n         }\n \n@@ -1691,7 +1693,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n         if has_children {\n             old_edges.extend(\n                 iter_many!(task, Child { task } => task)\n-                    .filter(|task| !new_children.remove(task))\n+                    .filter(|task| new_children.remove(task).is_none())\n                     .map(OutdatedEdge::Child),\n             );\n         } else {\n@@ -1722,7 +1724,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n                     }),\n             );\n         }\n-        if self.should_track_dependencies() {\n+        if !task.is_immutable() && self.should_track_dependencies() {\n             old_edges.extend(iter_many!(task, OutdatedCellDependency { target } => OutdatedEdge::CellDependency(target)));\n             old_edges.extend(iter_many!(task, OutdatedOutputDependency { target } => OutdatedEdge::OutputDependency(target)));\n             old_edges.extend(\n@@ -1788,7 +1790,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             // that. (We already filtered out the old children from that list)\n             AggregationUpdateQueue::run(\n                 AggregationUpdateJob::DecreaseActiveCounts {\n-                    task_ids: new_children.into_iter().collect(),\n+                    task_ids: new_children.into_keys().collect(),\n                 },\n                 &mut ctx,\n             );"
        },
        {
            "sha": "9cdad2b394cf30a2b951ee9901f36a0b4b8ff6b1",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/connect_child.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_child.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_child.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_child.rs?ref=e2e82e99571417a26e90788a86b73b2a34fdface",
            "patch": "@@ -52,9 +52,10 @@ impl ConnectChildOperation {\n         };\n \n         // Quick skip if the child was already connected before\n-        if !new_children.insert(child_task_id) {\n+        if new_children.insert(child_task_id, is_immutable).is_some() {\n             return;\n         }\n+\n         if parent_task.has_key(&CachedDataItemKey::Child {\n             task: child_task_id,\n         }) {"
        },
        {
            "sha": "995ef416c29ed6c504b74dba7a02f9f22946c43b",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/connect_children.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_children.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_children.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_children.rs?ref=e2e82e99571417a26e90788a86b73b2a34fdface",
            "patch": "@@ -1,4 +1,4 @@\n-use rustc_hash::FxHashSet;\n+use rustc_hash::FxHashMap;\n use smallvec::SmallVec;\n use turbo_tasks::TaskId;\n \n@@ -14,7 +14,7 @@ use crate::{\n pub fn connect_children(\n     parent_task_id: TaskId,\n     parent_task: &mut impl TaskGuard,\n-    new_children: FxHashSet<TaskId>,\n+    new_children: FxHashMap<TaskId, bool>,\n     queue: &mut AggregationUpdateQueue,\n     has_active_count: bool,\n     should_track_activeness: bool,\n@@ -25,14 +25,14 @@ pub fn connect_children(\n \n     let parent_aggregation = get_aggregation_number(parent_task);\n \n-    for &new_child in new_children.iter() {\n+    for &new_child in new_children.keys() {\n         parent_task.add_new(CachedDataItem::Child {\n             task: new_child,\n             value: (),\n         });\n     }\n \n-    let new_follower_ids: SmallVec<_> = new_children.iter().copied().collect();\n+    let new_follower_ids: SmallVec<_> = new_children.keys().copied().collect();\n \n     let aggregating_node = is_aggregating_node(parent_aggregation);\n     let upper_ids = (!aggregating_node).then(|| get_uppers(&*parent_task));"
        },
        {
            "sha": "5dbd066db22bddf16e1e8992eb6d4dda28a9a083",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/prepare_new_children.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fprepare_new_children.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fprepare_new_children.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fprepare_new_children.rs?ref=e2e82e99571417a26e90788a86b73b2a34fdface",
            "patch": "@@ -1,6 +1,6 @@\n use std::{cmp::max, num::NonZeroU32};\n \n-use rustc_hash::FxHashSet;\n+use rustc_hash::FxHashMap;\n use turbo_tasks::TaskId;\n \n use crate::backend::{\n@@ -15,7 +15,7 @@ const AGGREGATION_NUMBER_BUFFER_SPACE: u32 = 3;\n pub fn prepare_new_children(\n     parent_task_id: TaskId,\n     parent_task: &mut impl TaskGuard,\n-    new_children: &FxHashSet<TaskId>,\n+    new_children: &FxHashMap<TaskId, bool>,\n     queue: &mut AggregationUpdateQueue,\n ) {\n     if new_children.is_empty() {\n@@ -48,7 +48,7 @@ pub fn prepare_new_children(\n     if !is_aggregating_node(future_parent_aggregation) {\n         let child_base_aggregation_number =\n             future_parent_aggregation + AGGREGATION_NUMBER_BUFFER_SPACE;\n-        for &new_child in new_children.iter() {\n+        for &new_child in new_children.keys() {\n             queue.push(AggregationUpdateJob::UpdateAggregationNumber {\n                 task_id: new_child,\n                 base_aggregation_number: child_base_aggregation_number,"
        },
        {
            "sha": "edbb055357b9d97af599b0804d8098d0ab7a4d9b",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/update_output.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs?ref=e2e82e99571417a26e90788a86b73b2a34fdface",
            "patch": "@@ -61,7 +61,7 @@ impl UpdateOutputOperation {\n             return;\n         }\n         let children = if ctx.should_track_children() {\n-            new_children.iter().copied().collect()\n+            new_children.keys().copied().collect()\n         } else {\n             Default::default()\n         };"
        },
        {
            "sha": "a3034373e7c55c1c0a25de9fd30b90d17886a6dc",
            "filename": "turbopack/crates/turbo-tasks-backend/src/data.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2e82e99571417a26e90788a86b73b2a34fdface/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs?ref=e2e82e99571417a26e90788a86b73b2a34fdface",
            "patch": "@@ -1,6 +1,6 @@\n use std::cmp::Ordering;\n \n-use rustc_hash::FxHashSet;\n+use rustc_hash::FxHashMap;\n use serde::{Deserialize, Serialize};\n use turbo_tasks::{\n     CellId, KeyValuePair, SessionId, TaskId, TraitTypeId, TypedSharedReference, ValueTypeId,\n@@ -315,7 +315,9 @@ pub struct InProgressStateInner {\n     pub done_event: Event,\n     /// Children that should be connected to the task and have their active_count decremented\n     /// once the task completes.\n-    pub new_children: FxHashSet<TaskId>,\n+    ///\n+    /// The bool value is `is_immutable` of the child task.\n+    pub new_children: FxHashMap<TaskId, bool>,\n }\n \n #[derive(Debug)]"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 23,
        "deletions": 18
    }
}