{
    "author": "bgub",
    "message": "test: improve tests for typed route validation (#82660)\n\nRemove tests of the implementation details. Add more tests for route\nhandler types.\n\nRe: feedback from @eps1lon",
    "sha": "7ef0a2b2767b4159f8db8e1884bac98370528a25",
    "files": [
        {
            "sha": "0967ebe2d11f9b439381988dd2a3a8fbb7c1e6ca",
            "filename": "test/e2e/app-dir/typed-routes-validator/typed-routes-validator.test.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 16,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/7ef0a2b2767b4159f8db8e1884bac98370528a25/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ef0a2b2767b4159f8db8e1884bac98370528a25/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts?ref=7ef0a2b2767b4159f8db8e1884bac98370528a25",
            "patch": "@@ -12,21 +12,8 @@ describe('typed-routes-validator', () => {\n \n   it('should generate route validation correctly', async () => {\n     const dts = await next.readFile('.next/types/validator.ts')\n-    expect(dts).toMatch(\n-      /const handler = {} as typeof import\\(\".*\\/app\\/page.js\"\\)\\s+handler satisfies AppPageConfig<\"\\/\">/\n-    )\n-    expect(dts).toMatch(\n-      /const handler = {} as typeof import\\(\".*\\/app\\/send-email\\/route.js\"\\)\\s+handler satisfies RouteHandlerConfig<\"\\/send-email\">/\n-    )\n-    expect(dts).toMatch(\n-      /const handler = {} as typeof import\\(\".*\\/pages\\/about.js\"\\)\\s+handler satisfies PagesPageConfig/\n-    )\n-    expect(dts).toMatch(\n-      /const handler = {} as typeof import\\(\".*\\/pages\\/api\\/test-route.js\"\\)\\s+handler satisfies ApiRouteConfig/\n-    )\n-    expect(dts).toMatch(\n-      /const handler = {} as typeof import\\(\".*\\/app\\/layout.js\"\\)\\s+handler satisfies LayoutConfig<\"\\/\">/\n-    )\n+    // sanity check that dev generation is working\n+    expect(dts).toContain('handler satisfies AppPageConfig')\n   })\n \n   if (isNextStart) {\n@@ -81,6 +68,23 @@ describe('typed-routes-validator', () => {\n       return new Response('Created', { status: 201 })\n     }\n \n+    export const dynamic = 'force-dynamic'\n+            `\n+      )\n+\n+      await next.patchFile(\n+        'app/valid-2/route.ts',\n+        `\n+    import type { NextRequest } from 'next/server'\n+\n+    export async function GET() {\n+      return new Response('OK')\n+    }\n+\n+    export async function POST(request: NextRequest) {\n+      return new Response('Created', { status: 201 })\n+    }\n+\n     export const dynamic = 'force-dynamic'\n             `\n       )\n@@ -89,7 +93,7 @@ describe('typed-routes-validator', () => {\n       expect(exitCode).toBe(0)\n     })\n \n-    it('should fail type checking with invalid route handler exports', async () => {\n+    it('should fail type checking with invalid route handler return type', async () => {\n       await next.stop()\n       await next.patchFile(\n         'app/invalid/route.ts',\n@@ -111,6 +115,26 @@ describe('typed-routes-validator', () => {\n       )\n     })\n \n+    it('should fail type checking with invalid route handler params', async () => {\n+      await next.stop()\n+      await next.patchFile(\n+        'app/invalid-2/route.ts',\n+        `\n+    // not a valid type for request\n+    export async function POST(request: number) {\n+      return new Response('Created', { status: 201 })\n+    }\n+            `\n+      )\n+\n+      const { exitCode, cliOutput } = await next.build()\n+      // clean up before assertion just in case it fails\n+      await next.deleteFile('app/invalid-2/route.ts')\n+\n+      expect(exitCode).toBe(1)\n+      expect(cliOutput).toContain(`Types of property 'POST' are incompatible.`)\n+    })\n+\n     it('should pass type checking with valid layout exports', async () => {\n       await next.stop()\n       await next.patchFile("
        }
    ],
    "stats": {
        "total": 56,
        "additions": 40,
        "deletions": 16
    }
}