{
    "author": "sokra",
    "message": "Turbopack: add tracing for fetch calls (#77673)\n\n### What?\n\nTracing did only show CPU operations, but fetch calls e. g. for next/font where not instrumented.\n\nThis adds spans for them:\n\n![image.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/4WNXXAu8pNAHiAuC2uqW/4a37ff55-bd50-44b4-a6ee-18368f68593f.png)",
    "sha": "23c2aaebca137b8d53b199c7e84a89deca27105b",
    "files": [
        {
            "sha": "39bfabcdccd34803b95fe949ba1b06bae1121e58",
            "filename": "turbopack/crates/turbo-tasks-fetch/src/lib.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/23c2aaebca137b8d53b199c7e84a89deca27105b/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/23c2aaebca137b8d53b199c7e84a89deca27105b/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Flib.rs?ref=23c2aaebca137b8d53b199c7e84a89deca27105b",
            "patch": "@@ -4,7 +4,7 @@\n \n use anyhow::Result;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{mark_session_dependent, ResolvedVc, Vc};\n+use turbo_tasks::{duration_span, mark_session_dependent, ResolvedVc, Vc};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::issue::{Issue, IssueSeverity, IssueStage, OptionStyledString, StyledString};\n \n@@ -72,11 +72,20 @@ pub async fn fetch(\n         builder = builder.header(\"User-Agent\", user_agent.as_str());\n     }\n \n-    let response = builder.send().await.and_then(|r| r.error_for_status());\n+    let response = {\n+        let _span = duration_span!(\"fetch request\", url = url.as_str());\n+        builder.send().await\n+    }\n+    .and_then(|r| r.error_for_status());\n     match response {\n         Ok(response) => {\n             let status = response.status().as_u16();\n-            let body = response.bytes().await?.to_vec();\n+\n+            let body = {\n+                let _span = duration_span!(\"fetch response\", url = url.as_str());\n+                response.bytes().await?\n+            }\n+            .to_vec();\n \n             Ok(Vc::cell(Ok(HttpResponse {\n                 status,"
        },
        {
            "sha": "e6f4e65781255702509fff5a82e36f5967c0fd96",
            "filename": "turbopack/crates/turbopack-trace-utils/src/tracing_presets.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/23c2aaebca137b8d53b199c7e84a89deca27105b/turbopack%2Fcrates%2Fturbopack-trace-utils%2Fsrc%2Ftracing_presets.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/23c2aaebca137b8d53b199c7e84a89deca27105b/turbopack%2Fcrates%2Fturbopack-trace-utils%2Fsrc%2Ftracing_presets.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-utils%2Fsrc%2Ftracing_presets.rs?ref=23c2aaebca137b8d53b199c7e84a89deca27105b",
            "patch": "@@ -4,14 +4,15 @@ pub static TRACING_OVERVIEW_TARGETS: Lazy<Vec<&str>> = Lazy::new(|| {\n     vec![\n         \"turbo_tasks=info\",\n         \"turbo_tasks_fs=info\",\n+        \"turbo_tasks_fetch=info\",\n         \"turbopack=info\",\n         \"turbopack_binding=info\",\n+        \"turbopack_browser=info\",\n         \"turbopack_nodejs=info\",\n         \"turbopack_cli=info\",\n         \"turbopack_cli_utils=info\",\n         \"turbopack_core=info\",\n         \"turbopack_css=info\",\n-        \"turbopack_browser=info\",\n         \"turbopack_dev_server=info\",\n         \"turbopack_ecmascript=info\",\n         \"turbopack_ecmascript_hmr_protocol=info\","
        }
    ],
    "stats": {
        "total": 18,
        "additions": 14,
        "deletions": 4
    }
}