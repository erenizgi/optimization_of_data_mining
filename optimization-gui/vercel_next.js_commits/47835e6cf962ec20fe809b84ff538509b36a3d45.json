{
    "author": "sokra",
    "message": "add turbo tasks fuzzing (#79372)\n\n### What?\n\nAdd fuzz testing for turbo-tasks-backend",
    "sha": "47835e6cf962ec20fe809b84ff538509b36a3d45",
    "files": [
        {
            "sha": "7507c3bcf3ac3f32415c3914f694480d5bbe1beb",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 53,
            "deletions": 5,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -33,6 +33,18 @@ version = \"2.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"512761e0bb2578dd7380c6baaa0f4ce03e84f95e960231d1dec8bf4d7d6e2627\"\n \n+[[package]]\n+name = \"afl\"\n+version = \"0.15.18\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"eda81c043843d2eeb489c3f30774953326fa043b7a6470d4c2ad7c3cdfd9847b\"\n+dependencies = [\n+ \"home\",\n+ \"libc\",\n+ \"rustc_version\",\n+ \"xdg\",\n+]\n+\n [[package]]\n name = \"ahash\"\n version = \"0.7.8\"\n@@ -241,9 +253,12 @@ dependencies = [\n \n [[package]]\n name = \"arbitrary\"\n-version = \"1.3.2\"\n+version = \"1.4.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"7d5a26814d8dcb93b0e5a0ff3c6d80a8843bafb21b39e8e18a6f05471870e110\"\n+checksum = \"dde20b3d026af13f561bdd0f15edf01fc734f0dafcedbaf42bba506a9517f223\"\n+dependencies = [\n+ \"derive_arbitrary\",\n+]\n \n [[package]]\n name = \"arc-swap\"\n@@ -1852,6 +1867,17 @@ dependencies = [\n  \"serde\",\n ]\n \n+[[package]]\n+name = \"derive_arbitrary\"\n+version = \"1.4.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"30542c1ad912e0e3d22a1935c290e12e8a29d704a420177a31faad4a601a0800\"\n+dependencies = [\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn 2.0.100\",\n+]\n+\n [[package]]\n name = \"derive_builder\"\n version = \"0.12.0\"\n@@ -3561,13 +3587,12 @@ checksum = \"d750af042f7ef4f724306de029d18836c26c1765a54a6a3f094cbd23a7267ffa\"\n \n [[package]]\n name = \"libfuzzer-sys\"\n-version = \"0.4.7\"\n+version = \"0.4.9\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"a96cfd5557eb82f2b83fed4955246c988d331975a002961b07c81584d107e7f7\"\n+checksum = \"cf78f52d400cf2d84a3a973a78a592b4adc535739e0a5597a0da6f0c357adc75\"\n dependencies = [\n  \"arbitrary\",\n  \"cc\",\n- \"once_cell\",\n ]\n \n [[package]]\n@@ -9246,6 +9271,23 @@ dependencies = [\n  \"turbo-tasks-testing\",\n ]\n \n+[[package]]\n+name = \"turbo-tasks-backend-fuzz\"\n+version = \"0.0.0\"\n+dependencies = [\n+ \"afl\",\n+ \"anyhow\",\n+ \"arbitrary\",\n+ \"libfuzzer-sys\",\n+ \"once_cell\",\n+ \"serde\",\n+ \"tokio\",\n+ \"turbo-tasks\",\n+ \"turbo-tasks-backend\",\n+ \"turbo-tasks-build\",\n+ \"turbo-tasks-malloc\",\n+]\n+\n [[package]]\n name = \"turbo-tasks-build\"\n version = \"0.1.0\"\n@@ -11488,6 +11530,12 @@ dependencies = [\n  \"rustix 0.38.41\",\n ]\n \n+[[package]]\n+name = \"xdg\"\n+version = \"2.5.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"213b7324336b53d2414b2db8537e56544d981803139155afa84f76eeebb7a546\"\n+\n [[package]]\n name = \"xtask\"\n version = \"0.1.0\""
        },
        {
            "sha": "f92cb0f056c6be8607f54ac1f0026bf5f018db35",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -11,6 +11,7 @@ members = [\n   \"crates/next-core\",\n   \"crates/next-custom-transforms\",\n   \"turbopack/crates/*\",\n+  \"turbopack/crates/*/fuzz\",\n   \"turbopack/xtask\",\n ]\n \n@@ -20,7 +21,7 @@ exclude = [\"crates/next-error-code-swc-plugin\"]\n too_many_arguments = \"allow\"\n \n [workspace.lints.rust]\n-unexpected_cfgs = { level = \"warn\", check-cfg = ['cfg(rust_analyzer)'] }\n+unexpected_cfgs = { level = \"warn\", check-cfg = ['cfg(rust_analyzer)', 'cfg(fuzzing)'] }\n \n # This crate is particularly sensitive to compiler optimizations\n [profile.dev.package.turbo-persistence]"
        },
        {
            "sha": "638c3bb3b1d8e55981b21a7299d5b021e07e0268",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/.gitignore",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2F.gitignore",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2F.gitignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2F.gitignore?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -0,0 +1,3 @@\n+artifacts\n+corpus\n+afl-out"
        },
        {
            "sha": "b07675ea8e2eb70d6000fcb58ad3e28f871d6feb",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/Cargo.toml",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2FCargo.toml?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -0,0 +1,37 @@\n+[package]\n+name = \"turbo-tasks-backend-fuzz\"\n+version = \"0.0.0\"\n+publish = false\n+edition = \"2024\"\n+\n+[package.metadata]\n+cargo-fuzz = true\n+\n+[dependencies]\n+afl = \"0.15.18\"\n+anyhow = { workspace = true }\n+arbitrary = { version = \"1.4.1\", features = [\"derive\"] }\n+libfuzzer-sys = \"0.4.9\"\n+once_cell = { workspace = true }\n+serde = { workspace = true }\n+tokio = { workspace = true, features = [\"full\"] }\n+turbo-tasks = { workspace = true }\n+turbo-tasks-backend = { workspace = true }\n+turbo-tasks-malloc = { workspace = true }\n+\n+[build-dependencies]\n+turbo-tasks-build = { workspace = true }\n+\n+[[bin]]\n+name = \"fuzz_graph\"\n+path = \"fuzz_targets/graph.rs\"\n+test = false\n+doc = false\n+bench = false\n+\n+[[bin]]\n+name = \"afl_graph\"\n+path = \"afl_targets/graph.rs\"\n+test = false\n+doc = false\n+bench = false"
        },
        {
            "sha": "f76dd238ade08917e6712764a16a22005a50573d",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/afl-in/empty",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fafl-in%2Fempty",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fafl-in%2Fempty",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fafl-in%2Fempty?ref=47835e6cf962ec20fe809b84ff538509b36a3d45"
        },
        {
            "sha": "efe6f4a04ef7b3e4c046800da58ce7c4509406be",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/afl_targets/graph.rs",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fafl_targets%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fafl_targets%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fafl_targets%2Fgraph.rs?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -0,0 +1,26 @@\n+#![feature(arbitrary_self_types_pointers)]\n+\n+use afl::fuzz;\n+\n+use crate::graph::{TaskSpec, init, run};\n+\n+#[path = \"../src/graph.rs\"]\n+mod graph;\n+\n+// Run with:\n+// cargo afl build --bin afl_graph\n+// AFL_AUTORESUME=1 cargo afl fuzz -i turbopack/crates/turbo-tasks-backend/fuzz/afl-in -o\n+// turbopack/crates/turbo-tasks-backend/fuzz/afl-out -- target/debug/afl_graph\n+\n+fn main() {\n+    register();\n+    init();\n+    fuzz!(|data: Vec<TaskSpec>| {\n+        run(data);\n+    });\n+}\n+\n+pub fn register() {\n+    turbo_tasks::register();\n+    include!(concat!(env!(\"OUT_DIR\"), \"/register_afl_graph.rs\"));\n+}"
        },
        {
            "sha": "1673efed59cce6379c6a83d17829dfc0687e253f",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/build.rs",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fbuild.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fbuild.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fbuild.rs?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -0,0 +1,5 @@\n+use turbo_tasks_build::generate_register;\n+\n+fn main() {\n+    generate_register();\n+}"
        },
        {
            "sha": "4af3d7873b3be9f53a30355dd79d95b219affa4f",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/fuzz_targets/graph.rs",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Ffuzz_targets%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Ffuzz_targets%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Ffuzz_targets%2Fgraph.rs?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -0,0 +1,23 @@\n+#![no_main]\n+#![feature(arbitrary_self_types_pointers)]\n+\n+use libfuzzer_sys::fuzz_target;\n+\n+use crate::graph::{TaskSpec, init};\n+\n+#[path = \"../src/graph.rs\"]\n+mod graph;\n+\n+// Run with:\n+// cd turbopack/crates/turbo-tasks-backend\n+// cargo fuzz run fuzz_graph -- -timeout=3 -print_pcs=1 -print_funcs=999999 -print_final_stats=1\n+// add --jobs=6 -workers=6 for parallel fuzzing\n+\n+fuzz_target!(init: { register(); init(); }, |data: Vec<TaskSpec>| {\n+    graph::run(data);\n+});\n+\n+pub fn register() {\n+    turbo_tasks::register();\n+    include!(concat!(env!(\"OUT_DIR\"), \"/register_fuzz_graph.rs\"));\n+}"
        },
        {
            "sha": "46616c048caaa6dd47eb6ea3e2338dcb88ac32cc",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/src/graph.rs",
            "status": "added",
            "additions": 167,
            "deletions": 0,
            "changes": 167,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -0,0 +1,167 @@\n+use anyhow::Result;\n+use arbitrary::Arbitrary;\n+use once_cell::sync::Lazy;\n+use serde::{Deserialize, Serialize};\n+use turbo_tasks::{self, NonLocalValue, TurboTasks, Vc, trace::TraceRawVcs};\n+use turbo_tasks_malloc::TurboMalloc;\n+\n+#[derive(\n+    Arbitrary, Clone, Debug, PartialEq, Eq, NonLocalValue, Serialize, Deserialize, TraceRawVcs,\n+)]\n+pub struct TaskReferenceSpec {\n+    task: u16,\n+    chain: u8,\n+    read: bool,\n+    read_strongly_consistent: bool,\n+}\n+\n+#[derive(\n+    Arbitrary, Clone, Debug, PartialEq, Eq, NonLocalValue, Serialize, Deserialize, TraceRawVcs,\n+)]\n+pub struct TaskSpec {\n+    references: Vec<TaskReferenceSpec>,\n+    children: u8,\n+}\n+\n+static RUNTIME: Lazy<tokio::runtime::Runtime> = Lazy::new(|| {\n+    tokio::runtime::Builder::new_multi_thread()\n+        .enable_all()\n+        .on_thread_stop(|| {\n+            TurboMalloc::thread_stop();\n+        })\n+        .build()\n+        .unwrap()\n+});\n+\n+pub fn init() {\n+    let _ = &*RUNTIME;\n+}\n+\n+pub fn run(data: Vec<TaskSpec>) {\n+    let mut data = data;\n+    let len = data.len();\n+    if len == 0 {\n+        return;\n+    }\n+    for (i, task) in data.iter_mut().enumerate() {\n+        for reference in task.references.iter_mut() {\n+            let task = reference.task as usize;\n+            if task <= i {\n+                return;\n+            }\n+            if task >= len {\n+                return;\n+            }\n+        }\n+    }\n+    let mut referenced = vec![false; data.len()];\n+    for task in &data {\n+        for reference in &task.references {\n+            referenced[reference.task as usize] = true;\n+        }\n+    }\n+    if !referenced.iter().skip(1).all(|&x| x) {\n+        return;\n+    }\n+    actual_operation(data);\n+}\n+\n+fn actual_operation(data: Vec<TaskSpec>) {\n+    let tt = TurboTasks::new(turbo_tasks_backend::TurboTasksBackend::new(\n+        turbo_tasks_backend::BackendOptions {\n+            storage_mode: None,\n+            small_preallocation: true,\n+            ..Default::default()\n+        },\n+        turbo_tasks_backend::noop_backing_storage(),\n+    ));\n+    RUNTIME\n+        .block_on(async {\n+            tt.run_once(async move {\n+                let spec: Vc<TasksSpec> = Vc::cell(data);\n+                run_task(spec, 0).strongly_consistent().await?;\n+                Ok(())\n+            })\n+            .await\n+        })\n+        .unwrap();\n+}\n+\n+#[turbo_tasks::value(transparent)]\n+struct TasksSpec(Vec<TaskSpec>);\n+\n+#[turbo_tasks::function]\n+async fn run_task_chain(\n+    spec: Vc<TasksSpec>,\n+    from: u16,\n+    ref_index: usize,\n+    to: u16,\n+    chain: u8,\n+) -> Result<Vc<()>> {\n+    if chain > 0 {\n+        run_task_chain(spec, from, ref_index, to, chain - 1).await?;\n+    } else {\n+        run_task(spec, to).await?;\n+    }\n+    Ok(Vc::cell(()))\n+}\n+\n+#[turbo_tasks::function]\n+async fn run_task(spec: Vc<TasksSpec>, task_index: u16) -> Result<Vc<()>> {\n+    let spec_ref = spec.await?;\n+    let task = &spec_ref[task_index as usize];\n+    for i in 0..task.children {\n+        run_task_child(task_index, i).await?;\n+    }\n+    for (i, reference) in task.references.iter().enumerate() {\n+        let call = if reference.chain > 0 {\n+            run_task_chain(spec, task_index, i, reference.task, reference.chain)\n+        } else {\n+            run_task(spec, reference.task)\n+        };\n+        if reference.read {\n+            call.await?;\n+        }\n+        if reference.read_strongly_consistent {\n+            call.strongly_consistent().await?;\n+        }\n+    }\n+    Ok(Vc::cell(()))\n+}\n+\n+#[turbo_tasks::function]\n+async fn run_task_child(from: u16, i: u8) -> Result<Vc<()>> {\n+    let _ = from;\n+    let _ = i;\n+    Ok(Vc::cell(()))\n+}\n+\n+/// This removes all unused tasks and remaps references to have a continuous range.\n+#[allow(dead_code, reason = \"used to minimize the graph when crash found\")]\n+fn optimize(spec: Vec<TaskSpec>) -> Vec<TaskSpec> {\n+    let mut referenced = vec![false; spec.len()];\n+    for task in &spec {\n+        for reference in &task.references {\n+            referenced[reference.task as usize] = true;\n+        }\n+    }\n+    let mut new_index = vec![usize::MAX; spec.len()];\n+    let mut index = 0;\n+    for i in 0..spec.len() {\n+        if referenced[i] {\n+            new_index[i] = index;\n+            index += 1;\n+        }\n+    }\n+    let mut new_spec = vec![];\n+    for (i, task) in spec.iter().enumerate() {\n+        if referenced[i] {\n+            let mut new_task = task.clone();\n+            for reference in &mut new_task.references {\n+                reference.task = new_index[reference.task as usize] as u16;\n+            }\n+            new_spec.push(new_task);\n+        }\n+    }\n+    new_spec\n+}"
        },
        {
            "sha": "f95626ee299f2a3228360fd768d1d973043a1c43",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -138,6 +138,9 @@ pub struct BackendOptions {\n \n     /// Enables the backing storage.\n     pub storage_mode: Option<StorageMode>,\n+\n+    /// Avoid big preallocations for faster startup. Should only be used for testing purposes.\n+    pub small_preallocation: bool,\n }\n \n impl Default for BackendOptions {\n@@ -147,6 +150,7 @@ impl Default for BackendOptions {\n             children_tracking: true,\n             active_tracking: true,\n             storage_mode: Some(StorageMode::ReadWrite),\n+            small_preallocation: false,\n         }\n     }\n }\n@@ -224,6 +228,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n         if !options.dependency_tracking {\n             options.active_tracking = false;\n         }\n+        let small_preallocation = options.small_preallocation;\n         Self {\n             options,\n             start_time: Instant::now(),\n@@ -243,7 +248,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             persisted_task_cache_log: need_log.then(|| Sharded::new(shard_amount)),\n             task_cache: BiMap::new(),\n             transient_tasks: FxDashMap::default(),\n-            storage: Storage::new(),\n+            storage: Storage::new(small_preallocation),\n             in_progress_operations: AtomicUsize::new(0),\n             snapshot_request: Mutex::new(SnapshotRequest::new()),\n             operations_suspended: Condvar::new(),"
        },
        {
            "sha": "25b680a5d649027177f904bb9bae1c53dde66db7",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/storage.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -612,18 +612,27 @@ pub struct Storage {\n }\n \n impl Storage {\n-    pub fn new() -> Self {\n+    pub fn new(small_preallocation: bool) -> Self {\n+        let map_capacity: usize = if small_preallocation {\n+            1024\n+        } else {\n+            1024 * 1024\n+        };\n+        let modified_capacity: usize = if small_preallocation { 0 } else { 1024 };\n+        let shard_factor: usize = if small_preallocation { 4 } else { 64 };\n+\n         let shard_amount =\n-            (available_parallelism().map_or(4, |v| v.get()) * 64).next_power_of_two();\n+            (available_parallelism().map_or(4, |v| v.get()) * shard_factor).next_power_of_two();\n+\n         Self {\n             snapshot_mode: AtomicBool::new(false),\n             modified: FxDashMap::with_capacity_and_hasher_and_shard_amount(\n-                1024,\n+                modified_capacity,\n                 Default::default(),\n                 shard_amount,\n             ),\n             map: FxDashMap::with_capacity_and_hasher_and_shard_amount(\n-                1024 * 1024,\n+                map_capacity,\n                 Default::default(),\n                 shard_amount,\n             ),"
        },
        {
            "sha": "f7e8097a1b7aa323238bc220e11253355c6c4f6c",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/bug.rs",
            "status": "added",
            "additions": 195,
            "deletions": 0,
            "changes": 195,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fbug.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fbug.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fbug.rs?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -0,0 +1,195 @@\n+#![feature(arbitrary_self_types)]\n+#![feature(arbitrary_self_types_pointers)]\n+#![allow(clippy::needless_return)] // tokio macro-generated code doesn't respect this\n+\n+use anyhow::Result;\n+use serde::{Deserialize, Serialize};\n+use turbo_tasks::{NonLocalValue, Vc, trace::TraceRawVcs};\n+use turbo_tasks_testing::{Registration, register, run};\n+\n+static REGISTRATION: Registration = register!();\n+\n+#[derive(Debug, Clone, PartialEq, Eq, NonLocalValue, Serialize, Deserialize, TraceRawVcs)]\n+struct TaskReferenceSpec {\n+    task: u16,\n+    read: bool,\n+    read_strongly_consistent: bool,\n+}\n+\n+#[derive(Debug, Clone, PartialEq, Eq, NonLocalValue, Serialize, Deserialize, TraceRawVcs)]\n+struct TaskSpec {\n+    references: Vec<TaskReferenceSpec>,\n+}\n+\n+#[turbo_tasks::value(transparent)]\n+struct TasksSpec(Vec<TaskSpec>);\n+\n+#[tokio::test]\n+async fn graph_bug() {\n+    // see https://github.com/vercel/next.js/pull/79451\n+    run(&REGISTRATION, || async {\n+        let spec = vec![\n+            TaskSpec {\n+                references: vec![\n+                    TaskReferenceSpec {\n+                        task: 3,\n+                        read: false,\n+                        read_strongly_consistent: true,\n+                    },\n+                    TaskReferenceSpec {\n+                        task: 1,\n+                        read: true,\n+                        read_strongly_consistent: false,\n+                    },\n+                    TaskReferenceSpec {\n+                        task: 12,\n+                        read: false,\n+                        read_strongly_consistent: true,\n+                    },\n+                ],\n+            },\n+            TaskSpec {\n+                references: vec![TaskReferenceSpec {\n+                    task: 2,\n+                    read: true,\n+                    read_strongly_consistent: true,\n+                }],\n+            },\n+            TaskSpec {\n+                references: vec![TaskReferenceSpec {\n+                    task: 4,\n+                    read: false,\n+                    read_strongly_consistent: false,\n+                }],\n+            },\n+            TaskSpec {\n+                references: vec![TaskReferenceSpec {\n+                    task: 6,\n+                    read: false,\n+                    read_strongly_consistent: false,\n+                }],\n+            },\n+            TaskSpec {\n+                references: vec![\n+                    TaskReferenceSpec {\n+                        task: 5,\n+                        read: false,\n+                        read_strongly_consistent: false,\n+                    },\n+                    TaskReferenceSpec {\n+                        task: 13,\n+                        read: false,\n+                        read_strongly_consistent: false,\n+                    },\n+                ],\n+            },\n+            TaskSpec {\n+                references: vec![\n+                    TaskReferenceSpec {\n+                        task: 11,\n+                        read: false,\n+                        read_strongly_consistent: true,\n+                    },\n+                    TaskReferenceSpec {\n+                        task: 14,\n+                        read: false,\n+                        read_strongly_consistent: false,\n+                    },\n+                    TaskReferenceSpec {\n+                        task: 7,\n+                        read: false,\n+                        read_strongly_consistent: false,\n+                    },\n+                    TaskReferenceSpec {\n+                        task: 8,\n+                        read: false,\n+                        read_strongly_consistent: false,\n+                    },\n+                ],\n+            },\n+            TaskSpec {\n+                references: vec![TaskReferenceSpec {\n+                    task: 9,\n+                    read: false,\n+                    read_strongly_consistent: false,\n+                }],\n+            },\n+            TaskSpec { references: vec![] },\n+            TaskSpec {\n+                references: vec![\n+                    TaskReferenceSpec {\n+                        task: 12,\n+                        read: false,\n+                        read_strongly_consistent: false,\n+                    },\n+                    TaskReferenceSpec {\n+                        task: 11,\n+                        read: false,\n+                        read_strongly_consistent: false,\n+                    },\n+                ],\n+            },\n+            TaskSpec {\n+                references: vec![TaskReferenceSpec {\n+                    task: 10,\n+                    read: false,\n+                    read_strongly_consistent: false,\n+                }],\n+            },\n+            TaskSpec {\n+                references: vec![TaskReferenceSpec {\n+                    task: 12,\n+                    read: false,\n+                    read_strongly_consistent: false,\n+                }],\n+            },\n+            TaskSpec { references: vec![] },\n+            TaskSpec {\n+                references: vec![TaskReferenceSpec {\n+                    task: 14,\n+                    read: false,\n+                    read_strongly_consistent: false,\n+                }],\n+            },\n+            TaskSpec { references: vec![] },\n+            TaskSpec {\n+                references: vec![\n+                    TaskReferenceSpec {\n+                        task: 16,\n+                        read: false,\n+                        read_strongly_consistent: true,\n+                    },\n+                    TaskReferenceSpec {\n+                        task: 15,\n+                        read: false,\n+                        read_strongly_consistent: true,\n+                    },\n+                ],\n+            },\n+            TaskSpec { references: vec![] },\n+            TaskSpec { references: vec![] },\n+        ];\n+        let spec: Vc<TasksSpec> = Vc::cell(spec);\n+        run_task(spec, 0).await?;\n+\n+        anyhow::Ok(())\n+    })\n+    .await\n+    .unwrap()\n+}\n+\n+#[turbo_tasks::function]\n+async fn run_task(spec: Vc<TasksSpec>, task: u16) -> Result<Vc<()>> {\n+    let spec_ref = spec.await?;\n+    let task = &spec_ref[task as usize];\n+    for reference in &task.references {\n+        let call = run_task(spec, reference.task);\n+        if reference.read {\n+            call.await?;\n+        }\n+        if reference.read_strongly_consistent {\n+            call.strongly_consistent().await?;\n+        }\n+    }\n+    Ok(Vc::cell(()))\n+}"
        },
        {
            "sha": "7861387a02362678525b62b52ab260b13f914b38",
            "filename": "turbopack/crates/turbo-tasks-build/src/lib.rs",
            "status": "modified",
            "additions": 63,
            "deletions": 8,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-build%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/47835e6cf962ec20fe809b84ff538509b36a3d45/turbopack%2Fcrates%2Fturbo-tasks-build%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-build%2Fsrc%2Flib.rs?ref=47835e6cf962ec20fe809b84ff538509b36a3d45",
            "patch": "@@ -11,8 +11,8 @@ use glob::glob;\n use quote::ToTokens;\n use rustc_hash::{FxHashMap, FxHashSet};\n use syn::{\n-    Attribute, Ident, Item, ItemEnum, ItemFn, ItemImpl, ItemMacro, ItemMod, ItemStruct, ItemTrait,\n-    TraitItem, TraitItemFn, parse_quote,\n+    Attribute, Expr, Ident, Item, ItemEnum, ItemFn, ItemImpl, ItemMacro, ItemMod, ItemStruct,\n+    ItemTrait, Lit, Meta, TraitItem, TraitItemFn, parse_quote,\n };\n use turbo_tasks_macros_shared::{\n     GenericTypeInput, PrimitiveInput, get_impl_function_ident, get_native_function_ident,\n@@ -34,6 +34,8 @@ pub fn generate_register() {\n     let src_dir = crate_dir.join(\"src\");\n     let examples_dir = crate_dir.join(\"examples\");\n     let tests_dir = crate_dir.join(\"tests\");\n+    let fuzz_dir = crate_dir.join(\"fuzz_targets\");\n+    let afl_dir = crate_dir.join(\"afl_targets\");\n     let benches_dir = crate_dir.join(\"benches\");\n     let cargo_lock_path = workspace_dir.join(\"Cargo.lock\");\n \n@@ -80,6 +82,34 @@ pub fn generate_register() {\n         }\n     }\n \n+    if afl_dir.exists() {\n+        for item in read_dir(afl_dir).unwrap() {\n+            let item = item.unwrap();\n+            let file_type = &item.file_type().unwrap();\n+            if file_type.is_file() || file_type.is_symlink() {\n+                let name = item.file_name();\n+                let name = name.to_string_lossy();\n+                if name.ends_with(\".rs\") {\n+                    entries.push((format!(\"register_afl_{name}\"), item.path()));\n+                }\n+            }\n+        }\n+    }\n+\n+    if fuzz_dir.exists() {\n+        for item in read_dir(fuzz_dir).unwrap() {\n+            let item = item.unwrap();\n+            let file_type = &item.file_type().unwrap();\n+            if file_type.is_file() || file_type.is_symlink() {\n+                let name = item.file_name();\n+                let name = name.to_string_lossy();\n+                if name.ends_with(\".rs\") {\n+                    entries.push((format!(\"register_fuzz_{name}\"), item.path()));\n+                }\n+            }\n+        }\n+    }\n+\n     if benches_dir.exists() {\n         let bench_mod = benches_dir.join(\"mod.rs\");\n         if bench_mod.is_file() || bench_mod.is_symlink() {\n@@ -340,21 +370,46 @@ impl RegisterContext<'_> {\n             self.mod_path = parent_mod_path;\n         } else {\n             let parent_file_path = self.file_path.parent().unwrap();\n-            let direct = parent_file_path.join(format!(\"{child_mod_name}.rs\"));\n-            if direct.exists() {\n+            if let Some(path) = mod_item.attrs.iter().find_map(|attr| {\n+                let Meta::NameValue(pair) = &attr.meta else {\n+                    return None;\n+                };\n+                if !pair.path.is_ident(\"path\") {\n+                    return None;\n+                }\n+                let Expr::Lit(lit) = &pair.value else {\n+                    return None;\n+                };\n+                let Lit::Str(str) = &lit.lit else {\n+                    return None;\n+                };\n+                let path = str.value();\n+                let path = path.replace('/', &format!(\"{PATH_SEP}\"));\n+                let path = parent_file_path.join(path);\n+                Some(path)\n+            }) {\n                 self.queue.push(QueueEntry {\n-                    file_path: direct,\n+                    file_path: path,\n                     mod_path: child_mod_path,\n                     attributes: self.attributes.clone(),\n                 });\n             } else {\n-                let nested = parent_file_path.join(&child_mod_name).join(\"mod.rs\");\n-                if nested.exists() {\n+                let direct = parent_file_path.join(format!(\"{child_mod_name}.rs\"));\n+                if direct.exists() {\n                     self.queue.push(QueueEntry {\n-                        file_path: nested,\n+                        file_path: direct,\n                         mod_path: child_mod_path,\n                         attributes: self.attributes.clone(),\n                     });\n+                } else {\n+                    let nested = parent_file_path.join(&child_mod_name).join(\"mod.rs\");\n+                    if nested.exists() {\n+                        self.queue.push(QueueEntry {\n+                            file_path: nested,\n+                            mod_path: child_mod_path,\n+                            attributes: self.attributes.clone(),\n+                        });\n+                    }\n                 }\n             }\n         }"
        }
    ],
    "stats": {
        "total": 612,
        "additions": 593,
        "deletions": 19
    }
}