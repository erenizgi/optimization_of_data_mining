{
    "author": "devjiwonchoi",
    "message": "Add codemod for `middleware` to `proxy` (#84127)\n\nStacked to https://github.com/vercel/next.js/pull/84119\n\nThis PR adds a codemod for renaming `middleware` to `proxy`. Below are\nthe behaviors:\n\n- Rename `middleware.*`, `src/middleware.*` to `proxy.*`, `src/proxy.*`\n- Rename function/variable exports from `middleware` to `proxy`. Default\nexports are skipped.",
    "sha": "e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
    "files": [
        {
            "sha": "e6ad8278e08a03869096b0bce5f96f09cc544c6d",
            "filename": "packages/next-codemod/lib/utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Flib%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Flib%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Flib%2Futils.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -121,4 +121,9 @@ export const TRANSFORMER_INQUIRER_CHOICES = [\n     value: 'next-lint-to-eslint-cli',\n     version: '16.0.0',\n   },\n+  {\n+    title: 'Migrate from deprecated `middleware` convention to `proxy`',\n+    value: 'middleware-to-proxy',\n+    version: '16.0.0',\n+  },\n ]"
        },
        {
            "sha": "5950d01d83328372e5dfbcd0b791739c9d4c6288",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/async-function.input.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fasync-function.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fasync-function.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fasync-function.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,10 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+export async function middleware(request: NextRequest) {\n+  const response = await fetch('/api/auth')\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+export const config = {\n+  matcher: '/about/:path*',\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "d6914724a951cba122de201aef580802f6378223",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/async-function.output.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fasync-function.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fasync-function.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fasync-function.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,10 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+export async function proxy(request: NextRequest) {\n+  const response = await fetch('/api/auth')\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+export const config = {\n+  matcher: '/about/:path*',\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "edd830a2e423ee4a87aad9b0be0ddf9f9a6410e3",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/const-export.input.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fconst-export.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fconst-export.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fconst-export.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,11 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+const middleware = (request: NextRequest) => {\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+export { middleware }\n+\n+export const config = {\n+  matcher: '/about/:path*',\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "575d073ca46c6741c2320e03f44848be6a5bb912",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/const-export.output.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fconst-export.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fconst-export.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fconst-export.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,11 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+const proxy = (request: NextRequest) => {\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+export { proxy }\n+\n+export const config = {\n+  matcher: '/about/:path*',\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "508703414493b81c59a27ffd13f047d5fd0855e6",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/default-export.input.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fdefault-export.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fdefault-export.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fdefault-export.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,9 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+export default function middleware(request: NextRequest) {\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+export const config = {\n+  matcher: '/about/:path*',\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "4b985c79065605c935a7bcb3e1575987566ee0da",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/default-export.output.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fdefault-export.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fdefault-export.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fdefault-export.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,9 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+export default function proxy(request: NextRequest) {\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+export const config = {\n+  matcher: '/about/:path*',\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "00e0b8d25eea7d6b93de4151fe38aae3e7d9e0c8",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/export-as-alias.input.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-as-alias.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-as-alias.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-as-alias.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,9 @@\n+import { NextResponse } from 'next/server'\n+\n+const proxy = 'existing proxy variable'\n+\n+function middleware() {\n+  return NextResponse.next()\n+}\n+\n+export { middleware as randomName }\n\\ No newline at end of file"
        },
        {
            "sha": "19e3efe4785bb968da76e34f4b8a077fc3380112",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/export-as-alias.output.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-as-alias.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-as-alias.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-as-alias.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,9 @@\n+import { NextResponse } from 'next/server'\n+\n+const proxy = 'existing proxy variable'\n+\n+function _proxy1() {\n+  return NextResponse.next()\n+}\n+\n+export { _proxy1 as randomName }\n\\ No newline at end of file"
        },
        {
            "sha": "abf06c5cd33d64659d522a09dbf3bf5be15b2e4a",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/export-specifier.input.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-specifier.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-specifier.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-specifier.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,11 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+function middleware(request: NextRequest) {\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+const config = {\n+  matcher: '/about/:path*',\n+}\n+\n+export { middleware, config }\n\\ No newline at end of file"
        },
        {
            "sha": "6ad9b4adcb35a9f0c7d692f13908503737d91878",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/export-specifier.output.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-specifier.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-specifier.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fexport-specifier.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,11 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+function proxy(request: NextRequest) {\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+const config = {\n+  matcher: '/about/:path*',\n+}\n+\n+export { proxy, config }\n\\ No newline at end of file"
        },
        {
            "sha": "25680076a817f68cc76eddea1238e9640c08ddd8",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/import-conflict.input.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fimport-conflict.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fimport-conflict.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fimport-conflict.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,7 @@\n+import { NextResponse } from 'next/server'\n+// @ts-expect-error: test fixture\n+import { proxy } from 'some-library'\n+\n+export function middleware() {\n+  return NextResponse.next()\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "5f93684ee19a973f05501f7d0309940f66eca10b",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/import-conflict.output.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fimport-conflict.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fimport-conflict.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fimport-conflict.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,8 @@\n+import { NextResponse } from 'next/server'\n+// @ts-expect-error: test fixture\n+import { proxy } from 'some-library'\n+\n+export function _proxy1() {\n+  return NextResponse.next()\n+}\n+export { _proxy1 as proxy };\n\\ No newline at end of file"
        },
        {
            "sha": "8190bd425692ab7ff71fb54d05dbd0d5fd36be27",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/multiple-references.input.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fmultiple-references.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fmultiple-references.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fmultiple-references.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,10 @@\n+import { NextRequest } from 'next/server'\n+\n+const proxy = 'existing proxy variable'\n+\n+export function middleware(request: NextRequest) {\n+  return middleware(request) // self-reference\n+}\n+\n+const handler = middleware\n+export { handler }\n\\ No newline at end of file"
        },
        {
            "sha": "3b99967015b8df58ab7c8e502f99c509e7c55b9f",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/multiple-references.output.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fmultiple-references.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fmultiple-references.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fmultiple-references.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,11 @@\n+import { NextRequest } from 'next/server'\n+\n+const proxy = 'existing proxy variable'\n+\n+export function _proxy1(request: NextRequest) {\n+  return _proxy1(request); // self-reference\n+}\n+\n+const handler = _proxy1\n+export { handler }\n+export { _proxy1 as proxy };\n\\ No newline at end of file"
        },
        {
            "sha": "a0a725d8c71fe5a76ae35b5b6d49c9f0ce5d5ce8",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/named-export.input.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnamed-export.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnamed-export.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnamed-export.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,9 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+export function middleware(request: NextRequest) {\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+export const config = {\n+  matcher: '/about/:path*',\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "416cb9b6465de5974681b6431ff318227ddc9926",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/named-export.output.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnamed-export.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnamed-export.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnamed-export.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,9 @@\n+import { NextResponse, NextRequest } from 'next/server'\n+\n+export function proxy(request: NextRequest) {\n+  return NextResponse.redirect(new URL('/home', request.url))\n+}\n+\n+export const config = {\n+  matcher: '/about/:path*',\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "d5ce35c8c6bff3a77bc354ac31ea16b359814398",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/scope-conflict.input.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fscope-conflict.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fscope-conflict.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fscope-conflict.input.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,7 @@\n+import { NextResponse } from 'next/server'\n+\n+const proxy = 'existing proxy variable'\n+\n+export function middleware() {\n+  return NextResponse.next()\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "f026dd4bc1d4556e343c21a6f2eee04ea98c6e8c",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/scope-conflict.output.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fscope-conflict.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fscope-conflict.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fscope-conflict.output.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,8 @@\n+import { NextResponse } from 'next/server'\n+\n+const proxy = 'existing proxy variable'\n+\n+export function _proxy1() {\n+  return NextResponse.next()\n+}\n+export { _proxy1 as proxy };\n\\ No newline at end of file"
        },
        {
            "sha": "21f3e01a074228a27616bc658cc1a4056f66bb25",
            "filename": "packages/next-codemod/transforms/__tests__/middleware-to-proxy.test.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fmiddleware-to-proxy.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fmiddleware-to-proxy.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__tests__%2Fmiddleware-to-proxy.test.js?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,16 @@\n+/* global jest */\n+jest.autoMockOff()\n+const defineTest = require('jscodeshift/dist/testUtils').defineTest\n+const { readdirSync } = require('fs')\n+const { join } = require('path')\n+\n+const fixtureDir = 'middleware-to-proxy'\n+const fixtureDirPath = join(__dirname, '..', '__testfixtures__', fixtureDir)\n+const fixtures = readdirSync(fixtureDirPath)\n+  .filter(file => file.endsWith('.input.ts'))\n+  .map(file => file.replace('.input.ts', ''))\n+\n+for (const fixture of fixtures) {\n+  const prefix = `${fixtureDir}/${fixture}`\n+  defineTest(__dirname, fixtureDir, null, prefix, { parser: 'ts' })\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "bbe52e21671f10ccc96d138f13323dbe4905513d",
            "filename": "packages/next-codemod/transforms/middleware-to-proxy.ts",
            "status": "added",
            "additions": 270,
            "deletions": 0,
            "changes": 270,
            "blob_url": "https://github.com/vercel/next.js/blob/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2Fmiddleware-to-proxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e42c7cf70ea8fb25f828d766959e70344e3f0bd2/packages%2Fnext-codemod%2Ftransforms%2Fmiddleware-to-proxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2Fmiddleware-to-proxy.ts?ref=e42c7cf70ea8fb25f828d766959e70344e3f0bd2",
            "patch": "@@ -0,0 +1,270 @@\n+import type { API, ASTPath, Collection, FileInfo } from 'jscodeshift'\n+import path from 'path'\n+import fs from 'fs'\n+import { createParserFromPath } from '../lib/parser'\n+\n+export default function transformer(file: FileInfo) {\n+  if (\n+    !/(^|[/\\\\])middleware\\.|[/\\\\]src[/\\\\]middleware\\./.test(file.path) &&\n+    // fixtures have unique basenames in test\n+    process.env.NODE_ENV !== 'test'\n+  ) {\n+    return file.source\n+  }\n+\n+  const j = createParserFromPath(file.path)\n+  const root = j(file.source)\n+\n+  if (!root.length) {\n+    return file.source\n+  }\n+\n+  const proxyIdentifier = generateUniqueIdentifier(root, j, 'proxy')\n+  const needsAlias = proxyIdentifier !== 'proxy'\n+\n+  let hasChanges = false\n+  // Track if we exported something as 'proxy'\n+  let exportedAsProxy = false\n+\n+  // Handle named export declarations\n+  root.find(j.ExportNamedDeclaration).forEach((nodePath) => {\n+    const declaration = nodePath.node.declaration\n+\n+    // Handle: export function middleware() {} or export async function middleware() {}\n+    if (\n+      j.FunctionDeclaration.check(declaration) &&\n+      declaration.id?.name === 'middleware'\n+    ) {\n+      declaration.id.name = proxyIdentifier\n+      exportedAsProxy = true // Exported function declarations become proxy\n+      hasChanges = true\n+    }\n+\n+    // Handle: export { middleware }\n+    if (nodePath.node.specifiers) {\n+      nodePath.node.specifiers.forEach((specifier) => {\n+        if (\n+          j.ExportSpecifier.check(specifier) &&\n+          j.Identifier.check(specifier.local) &&\n+          specifier.local.name === 'middleware'\n+        ) {\n+          // Check if this is exporting middleware as 'middleware' (which should become 'proxy')\n+          if (\n+            j.Identifier.check(specifier.exported) &&\n+            specifier.exported.name === 'middleware'\n+          ) {\n+            if (needsAlias) {\n+              // Create export alias: export { _proxy1 as proxy }\n+              const newSpecifier = j.exportSpecifier.from({\n+                local: j.identifier(proxyIdentifier),\n+                exported: j.identifier('proxy'),\n+              })\n+              // Replace in the specifiers array\n+              const specifierIndex = nodePath.node.specifiers.indexOf(specifier)\n+              nodePath.node.specifiers[specifierIndex] = newSpecifier\n+            } else {\n+              // Simple rename: export { proxy }\n+              specifier.exported = j.identifier('proxy')\n+              specifier.local = j.identifier('proxy')\n+            }\n+            exportedAsProxy = true\n+            hasChanges = true\n+          } else {\n+            // This is exporting middleware as something else (e.g., export { middleware as randomName })\n+            // Just update the local reference to the new identifier\n+            specifier.local = j.identifier(proxyIdentifier)\n+            hasChanges = true\n+          }\n+        }\n+      })\n+    }\n+  })\n+\n+  // Handle default export declarations\n+  root.find(j.ExportDefaultDeclaration).forEach((nodePath) => {\n+    const declaration = nodePath.node.declaration\n+\n+    // Handle: export default function middleware() {} or export default async function middleware() {}\n+    if (\n+      j.FunctionDeclaration.check(declaration) &&\n+      declaration.id?.name === 'middleware'\n+    ) {\n+      declaration.id.name = proxyIdentifier\n+      hasChanges = true\n+    }\n+  })\n+\n+  // Handle function declarations that are later exported\n+  root\n+    .find(j.FunctionDeclaration, {\n+      id: { name: 'middleware' },\n+    })\n+    .forEach((nodePath) => {\n+      if (nodePath.node.id) {\n+        nodePath.node.id.name = proxyIdentifier\n+        hasChanges = true\n+      }\n+    })\n+\n+  // Handle variable declarations: const middleware = ...\n+  root\n+    .find(j.VariableDeclarator, {\n+      id: { name: 'middleware' },\n+    })\n+    .forEach((nodePath) => {\n+      if (j.Identifier.check(nodePath.node.id)) {\n+        nodePath.node.id.name = proxyIdentifier\n+        hasChanges = true\n+      }\n+    })\n+\n+  // Update all references to middleware in the scope\n+  if (hasChanges && needsAlias) {\n+    root\n+      .find(j.Identifier, { name: 'middleware' })\n+      .filter((astPath: ASTPath<any>) => {\n+        // Don't rename if it's part of an export specifier we already handled\n+        const parent = astPath.parent\n+        if (j.ExportSpecifier.check(parent.node)) {\n+          return false\n+        }\n+\n+        // Don't rename if it's a function/variable declaration we already handled\n+        if (\n+          (j.FunctionDeclaration.check(parent.node) &&\n+            parent.node.id === astPath.node) ||\n+          (j.VariableDeclarator.check(parent.node) &&\n+            parent.node.id === astPath.node)\n+        ) {\n+          return false\n+        }\n+\n+        return true\n+      })\n+      .forEach((astPath: ASTPath<any>) => {\n+        astPath.node.name = proxyIdentifier\n+      })\n+  }\n+\n+  if (!hasChanges) {\n+    return file.source\n+  }\n+\n+  // If we used a unique identifier AND we exported `as proxy`, add an export alias\n+  // This handles cases where the export was part of the declaration itself:\n+  //   export function middleware() {} -> export function _proxy1() {} (needs alias)\n+  // vs cases where export was separate:\n+  //   export { middleware } -> export { _proxy1 as proxy } (already handled)\n+  if (needsAlias && hasChanges && exportedAsProxy) {\n+    // Check if we already created a proxy export (from export specifiers like `export { middleware }`)\n+    const hasExportSpecifier =\n+      root.find(j.ExportNamedDeclaration).filter((astPath: ASTPath<any>) => {\n+        return (\n+          astPath.node.specifiers &&\n+          astPath.node.specifiers.some(\n+            (spec) =>\n+              j.ExportSpecifier.check(spec) &&\n+              j.Identifier.check(spec.exported) &&\n+              spec.exported.name === 'proxy'\n+          )\n+        )\n+      }).length > 0\n+\n+    // If no proxy export exists yet, create one to maintain the 'proxy' API\n+    // Example: export function _proxy1() {} + export { _proxy1 as proxy }\n+    if (!hasExportSpecifier) {\n+      const exportSpecifier = j.exportSpecifier.from({\n+        local: j.identifier(proxyIdentifier),\n+        exported: j.identifier('proxy'),\n+      })\n+\n+      const exportDeclaration = j.exportNamedDeclaration(null, [\n+        exportSpecifier,\n+      ])\n+\n+      // Add the export at the end of the file\n+      const program = root.find(j.Program)\n+      if (program.length > 0) {\n+        program.get('body').value.push(exportDeclaration)\n+      }\n+    }\n+  }\n+\n+  const source = root.toSource()\n+\n+  // We will not modify the original file in real world,\n+  // so return the source here for testing.\n+  if (process.env.NODE_ENV === 'test') {\n+    return source\n+  }\n+\n+  const { dir, ext } = path.parse(file.path)\n+  const newFilePath = path.join(dir, 'proxy' + ext)\n+\n+  try {\n+    fs.writeFileSync(newFilePath, source)\n+    fs.unlinkSync(file.path)\n+  } catch (cause) {\n+    console.error(\n+      `Failed to write \"${newFilePath}\" and delete \"${file.path}\".\\n${JSON.stringify({ cause })}`\n+    )\n+    return file.source\n+  }\n+}\n+\n+function generateUniqueIdentifier(\n+  root: Collection<any>,\n+  j: API['j'],\n+  baseName: string\n+): string {\n+  // First check if baseName itself is available\n+  if (!hasIdentifierInScope(root, j, baseName)) {\n+    return baseName\n+  }\n+\n+  // Generate _proxy1, _proxy2, etc.\n+  let counter = 1\n+  while (true) {\n+    const candidate = `_${baseName}${counter}`\n+    if (!hasIdentifierInScope(root, j, candidate)) {\n+      return candidate\n+    }\n+    counter++\n+  }\n+}\n+\n+function hasIdentifierInScope(\n+  root: Collection<any>,\n+  j: API['j'],\n+  name: string\n+): boolean {\n+  // Check for variable declarations\n+  const hasVariableDeclaration =\n+    root\n+      .find(j.VariableDeclarator)\n+      .filter(\n+        (astPath: ASTPath<any>) =>\n+          j.Identifier.check(astPath.value.id) && astPath.value.id.name === name\n+      ).length > 0\n+\n+  // Check for function declarations\n+  const hasFunctionDeclaration =\n+    root\n+      .find(j.FunctionDeclaration)\n+      .filter(\n+        (astPath: ASTPath<any>) =>\n+          astPath.value.id && astPath.value.id.name === name\n+      ).length > 0\n+\n+  // Check for import specifiers\n+  const hasImportSpecifier =\n+    root\n+      .find(j.ImportSpecifier)\n+      .filter(\n+        (astPath: ASTPath<any>) =>\n+          j.Identifier.check(astPath.value.local) &&\n+          astPath.value.local.name === name\n+      ).length > 0\n+\n+  return hasVariableDeclaration || hasFunctionDeclaration || hasImportSpecifier\n+}"
        }
    ],
    "stats": {
        "total": 460,
        "additions": 460,
        "deletions": 0
    }
}