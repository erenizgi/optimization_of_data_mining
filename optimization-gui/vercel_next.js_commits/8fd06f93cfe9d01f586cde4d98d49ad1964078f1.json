{
    "author": "timneutkens",
    "message": "Turbopack build: Implement error when using next start without --turbopack (#77678)\n\n### What?\n\nThis PR adds validation to ensure that the build tool used during `next\nbuild` matches the one used during `next start`. It prevents mismatches\nbetween Turbopack and Webpack builds.\n\n### Why?\nWhen a project is built with Turbopack but started without the\n`--turbopack` flag (or vice versa), it can lead to unexpected behavior\nand errors. This change ensures consistency between build and runtime\nenvironments.\n\n### How?\n- Added a constant `IS_TURBOPACK_BUILD_FILE` to track which build tool\nwas used\n- Added validation in the server startup to check if the `--turbopack`\nflag matches the build tool that was used\n- Added appropriate error messages (669 and 670) to provide clear\nguidance when mismatches occur",
    "sha": "8fd06f93cfe9d01f586cde4d98d49ad1964078f1",
    "files": [
        {
            "sha": "6d2fc1cf65661db1f2c7036975df6e9cb5301da5",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8fd06f93cfe9d01f586cde4d98d49ad1964078f1/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8fd06f93cfe9d01f586cde4d98d49ad1964078f1/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=8fd06f93cfe9d01f586cde4d98d49ad1964078f1",
            "patch": "@@ -666,5 +666,7 @@\n   \"665\": \"Failed to find Server Action \\\"%s\\\". This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n   \"666\": \"Turbopack builds are only available in canary builds of Next.js.\",\n   \"667\": \"receiveExpiredTags is deprecated, and not expected to be called.\",\n-  \"668\": \"Internal Next.js error: Router action dispatched before initialization.\"\n+  \"668\": \"Internal Next.js error: Router action dispatched before initialization.\",\n+  \"669\": \"Invariant: --turbopack is set but the build used Webpack\",\n+  \"670\": \"Invariant: --turbopack is not set but the build used Turbopack. Add --turbopack to \\\"next start\\\".\"\n }"
        },
        {
            "sha": "f3a195fbd2ed42504d633b34e72ae69f1455d1d0",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8fd06f93cfe9d01f586cde4d98d49ad1964078f1/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8fd06f93cfe9d01f586cde4d98d49ad1964078f1/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=8fd06f93cfe9d01f586cde4d98d49ad1964078f1",
            "patch": "@@ -81,6 +81,7 @@ import {\n   UNDERSCORE_NOT_FOUND_ROUTE,\n   DYNAMIC_CSS_MANIFEST,\n   TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST,\n+  IS_TURBOPACK_BUILD_FILE,\n } from '../shared/lib/constants'\n import {\n   getSortedRoutes,\n@@ -1452,7 +1453,7 @@ export default async function build(\n       let shutdownPromise = Promise.resolve()\n       if (!isGenerateMode) {\n         if (turboNextBuild) {\n-          await writeFileUtf8(path.join(distDir, 'IS_TURBOPACK_BUILD'), '')\n+          await writeFileUtf8(path.join(distDir, IS_TURBOPACK_BUILD_FILE), '')\n           const {\n             duration: compilerDuration,\n             shutdownPromise: p,\n@@ -2333,6 +2334,7 @@ export default async function build(\n                   ]\n                 : []),\n               BUILD_ID_FILE,\n+              turboNextBuild ? IS_TURBOPACK_BUILD_FILE : null,\n               path.join(SERVER_DIRECTORY, NEXT_FONT_MANIFEST + '.js'),\n               path.join(SERVER_DIRECTORY, NEXT_FONT_MANIFEST + '.json'),\n               ...instrumentationHookEntryFiles,"
        },
        {
            "sha": "6f726a376cb4fc054ed2d5bf483e67f429d01d02",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/8fd06f93cfe9d01f586cde4d98d49ad1964078f1/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8fd06f93cfe9d01f586cde4d98d49ad1964078f1/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=8fd06f93cfe9d01f586cde4d98d49ad1964078f1",
            "patch": "@@ -42,6 +42,7 @@ import {\n   PHASE_PRODUCTION_BUILD,\n   UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n   FUNCTIONS_CONFIG_MANIFEST,\n+  IS_TURBOPACK_BUILD_FILE,\n } from '../shared/lib/constants'\n import { findDir } from '../lib/find-pages-dir'\n import { NodeNextRequest, NodeNextResponse } from './base-http/node'\n@@ -188,9 +189,24 @@ export default class NextNodeServer extends BaseServer<\n     // Initialize super class\n     super(options)\n \n-    this.isDev = options.dev ?? false\n+    const isDev = options.dev ?? false\n+    this.isDev = isDev\n     this.sriEnabled = Boolean(options.conf.experimental?.sri?.algorithm)\n \n+    const isTurbopackBuild = this.isTurbopackBuild()\n+\n+    if (!isDev) {\n+      if (process.env.TURBOPACK && !isTurbopackBuild) {\n+        throw new Error(\n+          `Invariant: --turbopack is set but the build used Webpack`\n+        )\n+      } else if (!process.env.TURBOPACK && isTurbopackBuild) {\n+        throw new Error(\n+          `Invariant: --turbopack is not set but the build used Turbopack. Add --turbopack to \"next start\".`\n+        )\n+      }\n+    }\n+\n     /**\n      * This sets environment variable to be used at the time of SSR by head.tsx.\n      * Using this from process.env allows targeting SSR by calling\n@@ -510,6 +526,11 @@ export default class NextNodeServer extends BaseServer<\n     }\n   }\n \n+  private isTurbopackBuild(): boolean {\n+    const isTurbopackBuildFile = join(this.distDir, IS_TURBOPACK_BUILD_FILE)\n+    return fs.existsSync(isTurbopackBuildFile)\n+  }\n+\n   protected getEnabledDirectories(dev: boolean): NextEnabledDirectories {\n     const dir = dev ? this.dir : this.serverDistDir\n "
        },
        {
            "sha": "07a8ae2fa9db30f28df518bba61f7246f9163f23",
            "filename": "packages/next/src/shared/lib/constants.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8fd06f93cfe9d01f586cde4d98d49ad1964078f1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8fd06f93cfe9d01f586cde4d98d49ad1964078f1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts?ref=8fd06f93cfe9d01f586cde4d98d49ad1964078f1",
            "patch": "@@ -56,6 +56,7 @@ export const CONFIG_FILES = [\n   'next.config.ts',\n ]\n export const BUILD_ID_FILE = 'BUILD_ID'\n+export const IS_TURBOPACK_BUILD_FILE = 'IS_TURBOPACK_BUILD'\n export const BLOCKED_PAGES = ['/_document', '/_app', '/_error']\n export const CLIENT_PUBLIC_FILES_PATH = 'public'\n export const CLIENT_STATIC_FILES_PATH = 'static'"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 29,
        "deletions": 3
    }
}