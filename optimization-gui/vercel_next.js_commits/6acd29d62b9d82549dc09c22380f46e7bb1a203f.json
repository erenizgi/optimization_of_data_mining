{
    "author": "acdlite",
    "message": "Client instrumentation: onRouterTransitionStart (#77791)\n\nAdds a new API for observing the start of an App Router navigation:\n\n```ts\n// <PROJECT_ROOT>/instrumentation-client.ts\n\nexport function onRouterTransitionStart(\n  url: string,\n  navigationType: 'push' | 'replace' | 'traverse'\n) {\n  // ...\n}\n```\n\n`navigationType` is one of \"push\", \"replace\", or \"traverse\". This is\ninspired by the Navigation API:\n\nhttps://developer.mozilla.org/en-US/docs/Web/API/NavigateEvent/navigationType\n\n`onRouterTransitionStart` is intended for sending logs to a performance\nmonitoring tool. It is _not_ intended as a general purpose event for\nimplementing application behavior.\n\nIt fires at the start of every client-side navigation, including those\ninitiated by a popstate (back/forward) event.\n\nThere is no corresponding API for observing the end of a navigation. We\nintend to build support for this in the future, but it's a non-trivial\nproblem space due of the streaming nature of React transitions. Refer to\nthe React Transition Tracing proposal for more details:\nhttps://github.com/reactjs/rfcs/blob/transition-tracing/text/0235-transition-tracing.md\n\n`onRouterTransitionStart` is only called during App Router navigations.\nTo instrument Pages Router navigations, use `router.events`.\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that\nyou follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the\nPR.\n- Read the Docs Contribution Guide to ensure your contribution follows\nthe docs guidelines:\nhttps://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc\nhttps://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See\nhttps://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature\nrequest has been accepted for implementation before opening a PR. (A\ndiscussion must be opened, see\nhttps://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added\n(https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to\nunderstand the PR)\n- When linking to a Slack thread, you might want to share details of the\nconclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic\nbehind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "6acd29d62b9d82549dc09c22380f46e7bb1a203f",
    "files": [
        {
            "sha": "b65e811729aa1313306c06263ed1d9b3b75161da",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 51,
            "deletions": 37,
            "changes": 88,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -159,41 +159,11 @@ const initialServerResponse = createFromReadableStream<InitialRSCPayload>(\n   { callServer, findSourceMapURL }\n )\n \n-// React overrides `.then` and doesn't return a new promise chain,\n-// so we wrap the action queue in a promise to ensure that its value\n-// is defined when the promise resolves.\n-// https://github.com/facebook/react/blob/163365a07872337e04826c4f501565d43dbd2fd4/packages/react-client/src/ReactFlightClient.js#L189-L190\n-const pendingActionQueue: Promise<AppRouterActionQueue> = new Promise(\n-  (resolve, reject) => {\n-    initialServerResponse.then(\n-      (initialRSCPayload) => {\n-        // setAppBuildId should be called only once, during JS initialization\n-        // and before any components have hydrated.\n-        setAppBuildId(initialRSCPayload.b)\n-\n-        const initialTimestamp = Date.now()\n-\n-        resolve(\n-          createMutableActionQueue(\n-            createInitialRouterState({\n-              navigatedAt: initialTimestamp,\n-              initialFlightData: initialRSCPayload.f,\n-              initialCanonicalUrlParts: initialRSCPayload.c,\n-              initialParallelRoutes: new Map(),\n-              location: window.location,\n-              couldBeIntercepted: initialRSCPayload.i,\n-              postponed: initialRSCPayload.s,\n-              prerendered: initialRSCPayload.S,\n-            })\n-          )\n-        )\n-      },\n-      (err: Error) => reject(err)\n-    )\n-  }\n-)\n-\n-function ServerRoot(): React.ReactNode {\n+function ServerRoot({\n+  pendingActionQueue,\n+}: {\n+  pendingActionQueue: Promise<AppRouterActionQueue>\n+}): React.ReactNode {\n   const initialRSCPayload = use(initialServerResponse)\n   const actionQueue = use<AppRouterActionQueue>(pendingActionQueue)\n \n@@ -241,12 +211,56 @@ const reactRootOptions: ReactDOMClient.RootOptions = {\n   onUncaughtError,\n }\n \n-export function hydrate() {\n+export type ClientInstrumentationHooks = {\n+  onRouterTransitionStart?: (\n+    url: string,\n+    navigationType: 'push' | 'replace' | 'traverse'\n+  ) => void\n+}\n+\n+export function hydrate(\n+  instrumentationHooks: ClientInstrumentationHooks | null\n+) {\n+  // React overrides `.then` and doesn't return a new promise chain,\n+  // so we wrap the action queue in a promise to ensure that its value\n+  // is defined when the promise resolves.\n+  // https://github.com/facebook/react/blob/163365a07872337e04826c4f501565d43dbd2fd4/packages/react-client/src/ReactFlightClient.js#L189-L190\n+  const pendingActionQueue: Promise<AppRouterActionQueue> = new Promise(\n+    (resolve, reject) => {\n+      initialServerResponse.then(\n+        (initialRSCPayload) => {\n+          // setAppBuildId should be called only once, during JS initialization\n+          // and before any components have hydrated.\n+          setAppBuildId(initialRSCPayload.b)\n+\n+          const initialTimestamp = Date.now()\n+\n+          resolve(\n+            createMutableActionQueue(\n+              createInitialRouterState({\n+                navigatedAt: initialTimestamp,\n+                initialFlightData: initialRSCPayload.f,\n+                initialCanonicalUrlParts: initialRSCPayload.c,\n+                initialParallelRoutes: new Map(),\n+                location: window.location,\n+                couldBeIntercepted: initialRSCPayload.i,\n+                postponed: initialRSCPayload.s,\n+                prerendered: initialRSCPayload.S,\n+              }),\n+              instrumentationHooks\n+            )\n+          )\n+        },\n+        (err: Error) => reject(err)\n+      )\n+    }\n+  )\n+\n   const reactEl = (\n     <StrictModeIfEnabled>\n       <HeadManagerContext.Provider value={{ appDir: true }}>\n         <Root>\n-          <ServerRoot />\n+          <ServerRoot pendingActionQueue={pendingActionQueue} />\n         </Root>\n       </HeadManagerContext.Provider>\n     </StrictModeIfEnabled>"
        },
        {
            "sha": "9bd9a43c3e4bfcb66762dd5e804ca419cd0bb711",
            "filename": "packages/next/src/client/app-next-dev.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-dev.ts?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -1,12 +1,14 @@\n // TODO-APP: hydration warning\n \n import './app-webpack'\n-import '../lib/require-instrumentation-client'\n+\n import { appBootstrap } from './app-bootstrap'\n import { initializeDevBuildIndicatorForAppRouter } from './dev/dev-build-indicator/initialize-for-app-router'\n \n+const instrumentationHooks = require('../lib/require-instrumentation-client')\n+\n appBootstrap(() => {\n   const { hydrate } = require('./app-index')\n-  hydrate()\n+  hydrate(instrumentationHooks)\n   initializeDevBuildIndicatorForAppRouter()\n })"
        },
        {
            "sha": "cced9a14d0fc383682949012079193bf5ba4c1b2",
            "filename": "packages/next/src/client/app-next-turbopack.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -1,14 +1,15 @@\n // TODO-APP: hydration warning\n \n-import '../lib/require-instrumentation-client'\n import { appBootstrap } from './app-bootstrap'\n \n window.next.version += '-turbo'\n ;(self as any).__webpack_hash__ = ''\n \n+const instrumentationHooks = require('../lib/require-instrumentation-client')\n+\n appBootstrap(() => {\n   const { hydrate } = require('./app-index')\n-  hydrate()\n+  hydrate(instrumentationHooks)\n \n   if (process.env.NODE_ENV !== 'production') {\n     const { initializeDevBuildIndicatorForAppRouter } ="
        },
        {
            "sha": "574536ee144d29eb1ee19fd0f310007b6408909b",
            "filename": "packages/next/src/client/app-next.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next.ts?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -1,13 +1,14 @@\n // This import must go first because it needs to patch webpack chunk loading\n // before React patches chunk loading.\n import './app-webpack'\n-import '../lib/require-instrumentation-client'\n import { appBootstrap } from './app-bootstrap'\n \n+const instrumentationHooks = require('../lib/require-instrumentation-client')\n+\n appBootstrap(() => {\n   const { hydrate } = require('./app-index')\n   // Include app-router and layout-router in the main chunk\n   require('next/dist/client/components/app-router')\n   require('next/dist/client/components/layout-router')\n-  hydrate()\n+  hydrate(instrumentationHooks)\n })"
        },
        {
            "sha": "630f6f93d38b530a973ffb862f4910ac42fa2593",
            "filename": "packages/next/src/client/components/app-router-instance.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 1,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -25,13 +25,20 @@ import type {\n   PrefetchOptions,\n } from '../../shared/lib/app-router-context.shared-runtime'\n import { setLinkForCurrentNavigation, type LinkInstance } from './links'\n+import type { FlightRouterState } from '../../server/app-render/types'\n+import type { ClientInstrumentationHooks } from '../app-index'\n \n export type DispatchStatePromise = React.Dispatch<ReducerState>\n \n export type AppRouterActionQueue = {\n   state: AppRouterState\n   dispatch: (payload: ReducerActions, setState: DispatchStatePromise) => void\n   action: (state: AppRouterState, action: ReducerActions) => ReducerState\n+\n+  onRouterTransitionStart:\n+    | ((url: string, type: 'push' | 'replace' | 'traverse') => void)\n+    | null\n+\n   pending: ActionQueueNode | null\n   needsRefresh?: boolean\n   last: ActionQueueNode | null\n@@ -193,7 +200,8 @@ function dispatchAction(\n let globalActionQueue: AppRouterActionQueue | null = null\n \n export function createMutableActionQueue(\n-  initialState: AppRouterState\n+  initialState: AppRouterState,\n+  instrumentationHooks: ClientInstrumentationHooks | null\n ): AppRouterActionQueue {\n   const actionQueue: AppRouterActionQueue = {\n     state: initialState,\n@@ -205,6 +213,12 @@ export function createMutableActionQueue(\n     },\n     pending: null,\n     last: null,\n+    onRouterTransitionStart:\n+      instrumentationHooks !== null &&\n+      typeof instrumentationHooks.onRouterTransitionStart === 'function'\n+        ? // This profiling hook will be called at the start of every navigation.\n+          instrumentationHooks.onRouterTransitionStart\n+        : null,\n   }\n \n   if (typeof window !== 'undefined') {\n@@ -236,6 +250,13 @@ function getAppRouterActionQueue(): AppRouterActionQueue {\n   return globalActionQueue\n }\n \n+function getProfilingHookForOnNavigationStart() {\n+  if (globalActionQueue !== null) {\n+    return globalActionQueue.onRouterTransitionStart\n+  }\n+  return null\n+}\n+\n export function dispatchNavigateAction(\n   href: string,\n   navigateType: NavigateAction['navigateType'],\n@@ -251,6 +272,11 @@ export function dispatchNavigateAction(\n \n   setLinkForCurrentNavigation(linkInstanceRef)\n \n+  const onRouterTransitionStart = getProfilingHookForOnNavigationStart()\n+  if (onRouterTransitionStart !== null) {\n+    onRouterTransitionStart(href, navigateType)\n+  }\n+\n   dispatchAppRouterAction({\n     type: ACTION_NAVIGATE,\n     url,\n@@ -262,6 +288,21 @@ export function dispatchNavigateAction(\n   })\n }\n \n+export function dispatchTraverseAction(\n+  href: string,\n+  tree: FlightRouterState | undefined\n+) {\n+  const onRouterTransitionStart = getProfilingHookForOnNavigationStart()\n+  if (onRouterTransitionStart !== null) {\n+    onRouterTransitionStart(href, 'traverse')\n+  }\n+  dispatchAppRouterAction({\n+    type: ACTION_RESTORE,\n+    url: new URL(href),\n+    tree,\n+  })\n+}\n+\n /**\n  * The app router that is exposed through `useRouter`. These are public API\n  * methods. Internal Next.js code should call the lower level methods directly"
        },
        {
            "sha": "9483f84cd2e3e2415d47a2727f9481fd7844933a",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -40,6 +40,7 @@ import { getSelectedParams } from './router-reducer/compute-changed-path'\n import type { FlightRouterState } from '../../server/app-render/types'\n import { useNavFailureHandler } from './nav-failure-handler'\n import {\n+  dispatchTraverseAction,\n   publicAppRouterInstance,\n   type AppRouterActionQueue,\n } from './app-router-instance'\n@@ -418,11 +419,10 @@ function Router({\n       // TODO-APP: Ideally the back button should not use startTransition as it should apply the updates synchronously\n       // Without startTransition works if the cache is there for this path\n       startTransition(() => {\n-        dispatchAppRouterAction({\n-          type: ACTION_RESTORE,\n-          url: new URL(window.location.href),\n-          tree: event.state.__PRIVATE_NEXTJS_INTERNALS_TREE,\n-        })\n+        dispatchTraverseAction(\n+          window.location.href,\n+          event.state.__PRIVATE_NEXTJS_INTERNALS_TREE\n+        )\n       })\n     }\n "
        },
        {
            "sha": "7f533090313489945f457b0d1cd8a2311c1f66d6",
            "filename": "packages/next/src/lib/require-instrumentation-client.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Frequire-instrumentation-client.ts?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -7,7 +7,7 @@\n if (process.env.NODE_ENV === 'development') {\n   const measureName = 'Client Instrumentation Hook'\n   const startTime = performance.now()\n-  require('private-next-instrumentation-client')\n+  module.exports = require('private-next-instrumentation-client')\n   const endTime = performance.now()\n \n   const duration = endTime - startTime\n@@ -27,5 +27,5 @@ if (process.env.NODE_ENV === 'development') {\n     )\n   }\n } else {\n-  require('private-next-instrumentation-client')\n+  module.exports = require('private-next-instrumentation-client')\n }"
        },
        {
            "sha": "a082bd76811057370f0d1d262dec0bfa11508ae0",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -1092,7 +1092,7 @@ function App<T>({\n     prerendered: response.S,\n   })\n \n-  const actionQueue = createMutableActionQueue(initialState)\n+  const actionQueue = createMutableActionQueue(initialState, null)\n \n   const { HeadManagerContext } =\n     require('../../shared/lib/head-manager-context.shared-runtime') as typeof import('../../shared/lib/head-manager-context.shared-runtime')\n@@ -1159,7 +1159,7 @@ function ErrorApp<T>({\n     prerendered: response.S,\n   })\n \n-  const actionQueue = createMutableActionQueue(initialState)\n+  const actionQueue = createMutableActionQueue(initialState, null)\n \n   return (\n     <ServerInsertedMetadataProvider>"
        },
        {
            "sha": "568b8766b221ff6f634b18301f23c56466195e68",
            "filename": "test/e2e/instrumentation-client-hook/app-router/app/layout.tsx",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Flayout.tsx?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -1,9 +1,19 @@\n-import React from 'react'\n+import Link from 'next/link'\n \n export default function RootLayout({ children }) {\n   return (\n     <html>\n-      <body>{children}</body>\n+      <body>\n+        <ul>\n+          <li>\n+            <Link href=\"/\">Home</Link>\n+          </li>\n+          <li>\n+            <Link href=\"/some-page\">Some Page</Link>\n+          </li>\n+        </ul>\n+        {children}\n+      </body>\n     </html>\n   )\n }"
        },
        {
            "sha": "113324caa66e29ac7b09a2d3e89c2317fa27cf38",
            "filename": "test/e2e/instrumentation-client-hook/app-router/app/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fpage.tsx?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -1,5 +1,3 @@\n-import React from 'react'\n-\n export default function Page() {\n-  return <h1>App</h1>\n+  return <h1 id=\"home\">Home</h1>\n }"
        },
        {
            "sha": "8c6bb6df3ca6ec24cbe1fa53d4fe9c793df587ef",
            "filename": "test/e2e/instrumentation-client-hook/app-router/app/some-page/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fsome-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fsome-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Fapp%2Fsome-page%2Fpage.tsx?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <h1 id=\"some-page\">Some page</h1>\n+}"
        },
        {
            "sha": "0f1c8fb10ad0b9af3d05d4e6d7cd704bf9ffb19f",
            "filename": "test/e2e/instrumentation-client-hook/app-router/instrumentation-client.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Fapp-router%2Finstrumentation-client.ts?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -4,3 +4,8 @@ const start = performance.now()\n while (performance.now() - start < 20) {\n   // Intentionally block for 20ms to test instrumentation timing\n }\n+\n+export function onRouterTransitionStart(href: string, navigateType: string) {\n+  const pathname = new URL(href, window.location.href).pathname\n+  console.log(`[Router Transition Start] [${navigateType}] ${pathname}`)\n+}"
        },
        {
            "sha": "b47db90edecb0235b41052faf8e2643ef0a21a95",
            "filename": "test/e2e/instrumentation-client-hook/instrumentation-client-hook.test.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6acd29d62b9d82549dc09c22380f46e7bb1a203f/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Finstrumentation-client-hook%2Finstrumentation-client-hook.test.ts?ref=6acd29d62b9d82549dc09c22380f46e7bb1a203f",
            "patch": "@@ -49,6 +49,59 @@ describe('Instrumentation Client Hook', () => {\n     })\n   })\n \n+  describe('onRouterTransitionStart', () => {\n+    const { next } = nextTestSetup({\n+      files: path.join(__dirname, 'app-router'),\n+    })\n+\n+    function filterNavigationStartLogs(logs: Array<{ message: string }>) {\n+      const result = []\n+      for (const log of logs) {\n+        if (log.message.startsWith('[Router Transition Start]')) {\n+          result.push(log.message)\n+        }\n+      }\n+      return result\n+    }\n+\n+    it('onRouterTransitionStart fires at the start of a navigation', async () => {\n+      const browser = await next.browser('/')\n+\n+      const linkToSomePage = await browser.elementByCss('a[href=\"/some-page\"]')\n+      await linkToSomePage.click()\n+      await browser.elementById('some-page')\n+\n+      const linkToHome = await browser.elementByCss('a[href=\"/\"]')\n+      await linkToHome.click()\n+      await browser.elementById('home')\n+\n+      expect(filterNavigationStartLogs(await browser.log())).toEqual([\n+        '[Router Transition Start] [push] /some-page',\n+        '[Router Transition Start] [push] /',\n+      ])\n+    })\n+\n+    it('onRouterTransitionStart fires at the start of a back/forward navigation', async () => {\n+      const browser = await next.browser('/')\n+\n+      const linkToSomePage = await browser.elementByCss('a[href=\"/some-page\"]')\n+      await linkToSomePage.click()\n+      await browser.elementById('some-page')\n+\n+      await browser.back()\n+      await browser.elementById('home')\n+\n+      await browser.forward()\n+      await browser.elementById('some-page')\n+\n+      expect(filterNavigationStartLogs(await browser.log())).toEqual([\n+        '[Router Transition Start] [push] /some-page',\n+        '[Router Transition Start] [traverse] /',\n+        '[Router Transition Start] [traverse] /some-page',\n+      ])\n+    })\n+  })\n+\n   describe('HMR in development mode', () => {\n     const { next, isNextDev } = nextTestSetup({\n       files: path.join(__dirname, 'app-router'),"
        }
    ],
    "stats": {
        "total": 244,
        "additions": 186,
        "deletions": 58
    }
}