{
    "author": "eps1lon",
    "message": "[devtools] Ensure Chrome DevTools workspace can connect with proxy rewrites (#86289)",
    "sha": "a7b0b5fa9e388075f458a884a1e158689d10bf5f",
    "files": [
        {
            "sha": "8076af8b34bebca80c3a296207538731948c6fe0",
            "filename": "packages/next/src/server/lib/chrome-devtools-workspace.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a7b0b5fa9e388075f458a884a1e158689d10bf5f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fchrome-devtools-workspace.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7b0b5fa9e388075f458a884a1e158689d10bf5f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fchrome-devtools-workspace.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fchrome-devtools-workspace.ts?ref=a7b0b5fa9e388075f458a884a1e158689d10bf5f",
            "patch": "@@ -1,6 +1,5 @@\n import type { ServerResponse } from 'http'\n import type { NextConfigComplete } from '../config-shared'\n-import type { NextUrlWithParsedQuery } from '../request-meta'\n \n import { randomUUID } from 'crypto'\n import * as fs from 'fs'\n@@ -11,9 +10,9 @@ import { getStorageDirectory } from '../cache-dir'\n let workspaceUUID: string | null = null\n \n export function isChromeDevtoolsWorkspaceUrl(\n-  url: NextUrlWithParsedQuery\n+  pathname: string | undefined\n ): boolean {\n-  return url.pathname === '/.well-known/appspecific/com.chrome.devtools.json'\n+  return pathname === '/.well-known/appspecific/com.chrome.devtools.json'\n }\n \n export async function handleChromeDevtoolsWorkspaceRequest("
        },
        {
            "sha": "a08441c8dbbb61a2aa3dff89070f5d5b19b2a7f5",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a7b0b5fa9e388075f458a884a1e158689d10bf5f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7b0b5fa9e388075f458a884a1e158689d10bf5f/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=a7b0b5fa9e388075f458a884a1e158689d10bf5f",
            "patch": "@@ -575,7 +575,8 @@ export async function initialize(opts: {\n         )\n       }\n \n-      if (opts.dev && isChromeDevtoolsWorkspaceUrl(parsedUrl)) {\n+      // We want the original pathname without any basePath or proxy rewrites.\n+      if (opts.dev && isChromeDevtoolsWorkspaceUrl(req.url)) {\n         await handleChromeDevtoolsWorkspaceRequest(res, opts, config)\n         return\n       }"
        },
        {
            "sha": "6450aba60f1c90b64c3f5ae04b18f6668f97e01c",
            "filename": "test/e2e/chrome-devtools-workspace/chrome-devtools-workspace.test.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Fchrome-devtools-workspace.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Fchrome-devtools-workspace.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fchrome-devtools-workspace%2Fchrome-devtools-workspace.test.ts?ref=a7b0b5fa9e388075f458a884a1e158689d10bf5f",
            "patch": "@@ -30,3 +30,33 @@ describe('chrome-devtools-workspace default', () => {\n     }\n   })\n })\n+\n+describe('chrome-devtools-workspace proxy', () => {\n+  const { isNextDev, next } = nextTestSetup({\n+    files: path.join(__dirname, 'fixtures', 'proxy'),\n+  })\n+\n+  it('should be able to connect to Chrome DevTools in dev', async () => {\n+    const devtoolsResponse = await next.fetch(\n+      '/.well-known/appspecific/com.chrome.devtools.json'\n+    )\n+    if (isNextDev) {\n+      const json = await devtoolsResponse.json()\n+      expect(json).toEqual({\n+        workspace: {\n+          uuid: expect.any(String),\n+          root: next.testDir,\n+        },\n+      })\n+\n+      const pageReload = await next.fetch(\n+        '/.well-known/appspecific/com.chrome.devtools.json'\n+      )\n+      // The UUID should be stable across reloads.\n+      // Otherwise you'd have to reconnect every-time.\n+      expect(await pageReload.json()).toEqual(json)\n+    } else {\n+      expect({ status: devtoolsResponse.status }).toEqual({ status: 404 })\n+    }\n+  })\n+})"
        },
        {
            "sha": "129e646fef5011dcb833a01435126d21395ae58d",
            "filename": "test/e2e/chrome-devtools-workspace/fixtures/proxy/app/[lang]/page.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fapp%2F%5Blang%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fapp%2F%5Blang%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fapp%2F%5Blang%5D%2Fpage.js?ref=a7b0b5fa9e388075f458a884a1e158689d10bf5f",
            "patch": "@@ -0,0 +1,4 @@\n+export default async function Page({ params }) {\n+  const { lang } = await params\n+  return `Hello, ${lang} Dave!`\n+}"
        },
        {
            "sha": "d02e5191f0b550eb3db714bdccc6b167270dbbe9",
            "filename": "test/e2e/chrome-devtools-workspace/fixtures/proxy/app/layout.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fapp%2Flayout.js?ref=a7b0b5fa9e388075f458a884a1e158689d10bf5f",
            "patch": "@@ -0,0 +1,11 @@\n+import { Suspense } from 'react'\n+\n+export default function Root({ children }) {\n+  return (\n+    <html>\n+      <body>\n+        <Suspense fallback=\"loading\">{children}</Suspense>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/chrome-devtools-workspace/fixtures/proxy/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fnext.config.js?ref=a7b0b5fa9e388075f458a884a1e158689d10bf5f",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "68dc82ebbca249cfbc0243f553c340829aac6599",
            "filename": "test/e2e/chrome-devtools-workspace/fixtures/proxy/proxy.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fproxy.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a7b0b5fa9e388075f458a884a1e158689d10bf5f/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fproxy.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fchrome-devtools-workspace%2Ffixtures%2Fproxy%2Fproxy.js?ref=a7b0b5fa9e388075f458a884a1e158689d10bf5f",
            "patch": "@@ -0,0 +1,13 @@\n+import { NextResponse } from 'next/server'\n+\n+export function proxy(request, context) {\n+  const url = new URL(request.url)\n+  url.pathname = `/en-EN${url.pathname}`\n+\n+  return NextResponse.rewrite(url)\n+}\n+\n+export const config = {\n+  // Matcher ignoring `/_next/`, `/api/`, static assets, favicon, etc.\n+  matcher: ['/((?!api|_next/static|_next/image|favicon.ico).*)'],\n+}"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 68,
        "deletions": 4
    }
}