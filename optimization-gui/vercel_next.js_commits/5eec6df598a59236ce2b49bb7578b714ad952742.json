{
    "author": "huozhi",
    "message": "[metadata] disable streaming metadata for ppr deployment (#75978)\n\n### What\r\n\r\nThis PR forcedly disables the streaming metadata on vercel deployment\r\nwhen PPR is enabled on the target route. There're still some work need\r\nto be done on infra side, so we only let non-PPR mode and self-hosting\r\nPPR (mostly local testing) be controlled by `streamingMetadata` flag.\r\n\r\nOnce the blocker is gone, then we can re-enable it",
    "sha": "5eec6df598a59236ce2b49bb7578b714ad952742",
    "files": [
        {
            "sha": "d9f6e305b51d133e2e696f469caec7bf2cfdd22d",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -2771,7 +2771,11 @@ export default async function build(\n               },\n               // If it's PPR rendered non-static page, bypass the PPR cache when streaming metadata is enabled.\n               // This will skip the postpone data for those bots requests and instead produce a dynamic render.\n-              ...(isRoutePPREnabled && config.experimental.streamingMetadata\n+              ...(isRoutePPREnabled &&\n+              // Disable streaming metadata for PPR on deployment where we don't have the special env.\n+              // TODO: enable streaming metadata in PPR mode by default once it's ready.\n+              process.env.__NEXT_EXPERIMENTAL_PPR === 'true' &&\n+              config.experimental.streamingMetadata\n                 ? [\n                     {\n                       type: 'header',"
        },
        {
            "sha": "b1d1ca18c6df3de1b75a06fce0f84ce0c4f73bfe",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 21,
            "deletions": 6,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -434,6 +434,17 @@ function NonIndex({ ctx }: { ctx: AppRenderContext }) {\n   return null\n }\n \n+function getServeStreamingMetadata(ctx: AppRenderContext) {\n+  const isRoutePPREnabled = !!ctx.renderOpts.experimental.isRoutePPREnabled\n+  const serveStreamingMetadata = !!ctx.renderOpts.serveStreamingMetadata\n+  // If the route is in PPR and the special env is not set, disable the streaming metadata.\n+  // TODO: enable streaming metadata in PPR mode by default once it's ready.\n+  if (isRoutePPREnabled && process.env.__NEXT_EXPERIMENTAL_PPR !== 'true') {\n+    return false\n+  }\n+  return serveStreamingMetadata\n+}\n+\n /**\n  * This is used by server actions & client-side navigations to generate RSC data from a client-side request.\n  * This function is only called on \"dynamic\" requests (ie, there wasn't already a static response).\n@@ -473,6 +484,8 @@ async function generateDynamicRSCPayload(\n     url,\n   } = ctx\n \n+  const serveStreamingMetadata = getServeStreamingMetadata(ctx)\n+\n   if (!options?.skipFlight) {\n     const preloadCallbacks: PreloadCallbacks = []\n \n@@ -492,7 +505,7 @@ async function generateDynamicRSCPayload(\n         workStore,\n         MetadataBoundary,\n         ViewportBoundary,\n-        serveStreamingMetadata: !!ctx.renderOpts.serveStreamingMetadata,\n+        serveStreamingMetadata,\n       })\n \n     const { StreamingMetadata, StaticMetadata } =\n@@ -501,7 +514,7 @@ async function generateDynamicRSCPayload(\n           // Adding requestId as react key to make metadata remount for each render\n           <MetadataTree key={requestId} />\n         )\n-      }, !!ctx.renderOpts.serveStreamingMetadata)\n+      }, serveStreamingMetadata)\n \n     flightData = (\n       await walkTreeWithFlightRouterState({\n@@ -779,6 +792,7 @@ async function getRSCPayload(\n     getDynamicParamFromSegment,\n     query\n   )\n+  const serveStreamingMetadata = getServeStreamingMetadata(ctx)\n \n   const searchParams = createServerSearchParamsForMetadata(query, workStore)\n   const { ViewportTree, MetadataTree, getViewportReady, getMetadataReady } =\n@@ -797,7 +811,7 @@ async function getRSCPayload(\n       workStore,\n       MetadataBoundary,\n       ViewportBoundary,\n-      serveStreamingMetadata: !!ctx.renderOpts.serveStreamingMetadata,\n+      serveStreamingMetadata: serveStreamingMetadata,\n     })\n \n   const preloadCallbacks: PreloadCallbacks = []\n@@ -808,7 +822,7 @@ async function getRSCPayload(\n         // Not add requestId as react key to ensure segment prefetch could result consistently if nothing changed\n         <MetadataTree />\n       )\n-    }, !!ctx.renderOpts.serveStreamingMetadata)\n+    }, serveStreamingMetadata)\n \n   const seedData = await createComponentTree({\n     ctx,\n@@ -910,6 +924,7 @@ async function getErrorRSCPayload(\n     workStore,\n   } = ctx\n \n+  const serveStreamingMetadata = getServeStreamingMetadata(ctx)\n   const searchParams = createServerSearchParamsForMetadata(query, workStore)\n   const { MetadataTree, ViewportTree } = createMetadataComponents({\n     tree,\n@@ -924,7 +939,7 @@ async function getErrorRSCPayload(\n     workStore,\n     MetadataBoundary,\n     ViewportBoundary,\n-    serveStreamingMetadata: !!ctx.renderOpts.serveStreamingMetadata,\n+    serveStreamingMetadata: serveStreamingMetadata,\n   })\n \n   const { StreamingMetadata, StaticMetadata } =\n@@ -935,7 +950,7 @@ async function getErrorRSCPayload(\n           <MetadataTree key={requestId} />\n         </React.Fragment>\n       ),\n-      !!ctx.renderOpts.serveStreamingMetadata\n+      serveStreamingMetadata\n     )\n \n   const initialHead = ("
        },
        {
            "sha": "a05f03a529d1c40fda2d458c17e71950ea89ff55",
            "filename": "test/e2e/app-dir/ppr-metadata-streaming/ppr-metadata-streaming.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -2,6 +2,9 @@ import { nextTestSetup } from 'e2e-utils'\n import cheerio from 'cheerio'\n import { assertNoConsoleErrors } from 'next-test-utils'\n \n+// TODO: remove this env once streaming metadata is available for ppr\n+process.env.__NEXT_EXPERIMENTAL_PPR = 'true'\n+\n function countSubstring(str: string, substr: string): number {\n   return str.split(substr).length - 1\n }"
        },
        {
            "sha": "677545a7d38f7e4d2efa5076d363b20263e4e6c8",
            "filename": "test/production/app-dir/metadata-streaming-config/metadata-streaming-config-customized.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -1,5 +1,8 @@\n import { nextTestSetup } from 'e2e-utils'\n \n+// TODO: remove this env once streaming metadata is available for ppr\n+process.env.__NEXT_EXPERIMENTAL_PPR = 'true'\n+\n describe('app-dir - metadata-streaming-config-customized', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,"
        },
        {
            "sha": "34c868c61ce98894a3bd9a7a2a93c381708e2726",
            "filename": "test/production/app-dir/metadata-streaming-config/metadata-streaming-config.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -1,5 +1,8 @@\n import { nextTestSetup } from 'e2e-utils'\n \n+// TODO: remove this env once streaming metadata is available for ppr\n+process.env.__NEXT_EXPERIMENTAL_PPR = 'true'\n+\n describe('app-dir - metadata-streaming-config', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,"
        },
        {
            "sha": "a065865841cbca3851753198c0bc52d9c6063274",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/dynamic/layout.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Flayout.tsx?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -0,0 +1,5 @@\n+import { Suspense } from 'react'\n+\n+export default function Root({ children }) {\n+  return <Suspense fallback={<p>Loading...</p>}>{children}</Suspense>\n+}"
        },
        {
            "sha": "a74d30071009fe1132cf190fae86e17c34b97e02",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/dynamic/page.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Fpage.tsx?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -0,0 +1,12 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  return <p>hello world</p>\n+}\n+\n+// Dynamic metadata\n+export async function generateMetadata() {\n+  await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 1000))\n+  return { title: 'dynamic-title' }\n+}"
        },
        {
            "sha": "3902c914da24b84be05ef4c77a2cba99fbf278a9",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/layout.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Flayout.tsx?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -0,0 +1,16 @@\n+import { ReactNode } from 'react'\n+import Link from 'next/link'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <nav>\n+          <Link href=\"/ppr\">ppr</Link>\n+          <Link href=\"/dynamic\">dynamic</Link>\n+        </nav>\n+        {children}\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "a065865841cbca3851753198c0bc52d9c6063274",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/ppr/layout.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Flayout.tsx?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -0,0 +1,5 @@\n+import { Suspense } from 'react'\n+\n+export default function Root({ children }) {\n+  return <Suspense fallback={<p>Loading...</p>}>{children}</Suspense>\n+}"
        },
        {
            "sha": "d0385d61a5590b21811fd2eece0a65296fda9a2d",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/ppr/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Fpage.tsx?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -0,0 +1,13 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+  return <p>ppr</p>\n+}\n+\n+export async function generateMetadata() {\n+  await connection()\n+  return { title: 'ppr-title' }\n+}\n+\n+export const experimental_ppr = true"
        },
        {
            "sha": "13d4d0eb7b1e4d0c2f34861737632a4181eaf20b",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/next.config.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5eec6df598a59236ce2b49bb7578b714ad952742/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fnext.config.js?ref=5eec6df598a59236ce2b49bb7578b714ad952742",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    ppr: 'incremental',\n+    streamingMetadata: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 97,
        "deletions": 7
    }
}