{
    "author": "lukesandberg",
    "message": "[turbopack] Move static type ID variables into getters (#81150)\n\nSimplify some of the static macro variables by moving them into their only callsites.\n\nDelete dead `ident` factories\n\nJust a tiny cleanup motivated by reading through the `registry` codegen and realizing that many of the `ident`s aren't needed.",
    "sha": "b6a2a2edd469e59ba8707ab462878069234e4eb8",
    "files": [
        {
            "sha": "967c589eb2fa05bbed198524b1d81b86035491ff",
            "filename": "turbopack/crates/turbo-tasks-macros-shared/src/ident.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 43,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Fident.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Fident.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-shared%2Fsrc%2Fident.rs?ref=b6a2a2edd469e59ba8707ab462878069234e4eb8",
            "patch": "@@ -186,15 +186,6 @@ pub fn get_type_ident(ty: &Type) -> Option<Ident> {\n         }\n     }\n }\n-\n-pub fn get_read_ref_ident(ident: &Ident) -> Ident {\n-    Ident::new(&(ident.to_string() + \"ReadRef\"), ident.span())\n-}\n-\n-pub fn get_trait_ref_ident(ident: &Ident) -> Ident {\n-    Ident::new(&(ident.to_string() + \"TraitRef\"), ident.span())\n-}\n-\n pub fn get_trait_default_impl_function_ident(trait_ident: &Ident, ident: &Ident) -> Ident {\n     Ident::new(\n         &format!(\n@@ -206,47 +197,13 @@ pub fn get_trait_default_impl_function_ident(trait_ident: &Ident, ident: &Ident)\n     )\n }\n \n-pub fn get_trait_type_id_ident(ident: &Ident) -> Ident {\n-    Ident::new(\n-        &format!(\"{}_TRAIT_TYPE_ID\", ident.to_string().to_uppercase()),\n-        ident.span(),\n-    )\n-}\n-pub fn get_trait_type_vtable_registry(ident: &Ident) -> Ident {\n-    Ident::new(\n-        &format!(\n-            \"{}_TRAIT_TYPE_VTABLE_REGISTRY\",\n-            ident.to_string().to_uppercase()\n-        ),\n-        ident.span(),\n-    )\n-}\n-\n-pub fn get_trait_default_impl_function_id_ident(trait_ident: &Ident, ident: &Ident) -> Ident {\n-    Ident::new(\n-        &format!(\n-            \"{}_DEFAULT_IMPL_{}_FUNCTION_ID\",\n-            trait_ident.to_string().to_uppercase(),\n-            ident.to_string().to_uppercase()\n-        ),\n-        ident.span(),\n-    )\n-}\n-\n pub fn get_value_type_ident(ident: &Ident) -> Ident {\n     Ident::new(\n         &format!(\"{}_VALUE_TYPE\", ident.to_string().to_uppercase()),\n         ident.span(),\n     )\n }\n \n-pub fn get_value_type_id_ident(ident: &Ident) -> Ident {\n-    Ident::new(\n-        &format!(\"{}_VALUE_TYPE_ID\", ident.to_string().to_uppercase()),\n-        ident.span(),\n-    )\n-}\n-\n pub fn get_value_type_init_ident(ident: &Ident) -> Ident {\n     Ident::new(\n         &format!(\"{}_VALUE_TYPE_INIT\", ident.to_string().to_uppercase()),"
        },
        {
            "sha": "44b48d69209847edb17bf01194a4c6c71210932e",
            "filename": "turbopack/crates/turbo-tasks-macros/src/value_macro.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_macro.rs?ref=b6a2a2edd469e59ba8707ab462878069234e4eb8",
            "patch": "@@ -12,8 +12,7 @@ use syn::{\n     spanned::Spanned,\n };\n use turbo_tasks_macros_shared::{\n-    get_register_value_type_ident, get_value_type_id_ident, get_value_type_ident,\n-    get_value_type_init_ident,\n+    get_register_value_type_ident, get_value_type_ident, get_value_type_init_ident,\n };\n \n enum IntoMode {\n@@ -458,7 +457,6 @@ pub fn value_type_and_register(\n ) -> proc_macro2::TokenStream {\n     let value_type_init_ident = get_value_type_init_ident(ident);\n     let value_type_ident = get_value_type_ident(ident);\n-    let value_type_id_ident = get_value_type_id_ident(ident);\n     let register_value_type_ident = get_register_value_type_ident(ident);\n \n     let (impl_generics, where_clause) = if let Some(generics) = generics {\n@@ -485,11 +483,6 @@ pub fn value_type_and_register(\n                     )\n                 })\n             });\n-        #[doc(hidden)]\n-        static #value_type_id_ident: turbo_tasks::macro_helpers::Lazy<turbo_tasks::ValueTypeId> =\n-            turbo_tasks::macro_helpers::Lazy::new(|| {\n-                turbo_tasks::registry::get_value_type_id(*#value_type_ident)\n-            });\n \n \n         #[doc(hidden)]\n@@ -511,7 +504,12 @@ pub fn value_type_and_register(\n             type CellMode = #cell_mode;\n \n             fn get_value_type_id() -> turbo_tasks::ValueTypeId {\n-                *#value_type_id_ident\n+                static ident: turbo_tasks::macro_helpers::Lazy<turbo_tasks::ValueTypeId> =\n+                turbo_tasks::macro_helpers::Lazy::new(|| {\n+                    turbo_tasks::registry::get_value_type_id(*#value_type_ident)\n+                });\n+\n+                *ident\n             }\n         }\n     }"
        },
        {
            "sha": "886c8f81af9e1a1fcdd4479631575d81254c81a4",
            "filename": "turbopack/crates/turbo-tasks-macros/src/value_trait_macro.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 14,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs?ref=b6a2a2edd469e59ba8707ab462878069234e4eb8",
            "patch": "@@ -5,8 +5,7 @@ use syn::{\n     FnArg, ItemTrait, Pat, TraitItem, TraitItemFn, parse_macro_input, parse_quote, spanned::Spanned,\n };\n use turbo_tasks_macros_shared::{\n-    ValueTraitArguments, get_trait_default_impl_function_ident, get_trait_type_id_ident,\n-    get_trait_type_ident, get_trait_type_vtable_registry, is_self_used,\n+    ValueTraitArguments, get_trait_default_impl_function_ident, get_trait_type_ident, is_self_used,\n };\n \n use crate::{\n@@ -68,8 +67,6 @@ pub fn value_trait(args: TokenStream, input: TokenStream) -> TokenStream {\n     let supertraits = supertraits.iter().collect::<Vec<_>>();\n \n     let trait_type_ident = get_trait_type_ident(trait_ident);\n-    let trait_type_id_ident = get_trait_type_id_ident(trait_ident);\n-    let trait_type_vtable_registry = get_trait_type_vtable_registry(trait_ident);\n     let mut dynamic_trait_fns = Vec::new();\n     let mut trait_methods: Vec<TokenStream2> = Vec::new();\n     let mut native_functions = Vec::new();\n@@ -287,24 +284,24 @@ pub fn value_trait(args: TokenStream, input: TokenStream) -> TokenStream {\n                 #(#trait_methods)*\n                 trait_type\n             });\n-        #[doc(hidden)]\n-        static #trait_type_id_ident: turbo_tasks::macro_helpers::Lazy<turbo_tasks::TraitTypeId> =\n-            turbo_tasks::macro_helpers::Lazy::new(|| {\n-                turbo_tasks::registry::get_trait_type_id(&#trait_type_ident)\n-            });\n-        #[doc(hidden)]\n-        static #trait_type_vtable_registry: turbo_tasks::macro_helpers::Lazy<turbo_tasks::macro_helpers::VTableRegistry<dyn # trait_ident>> =\n-            turbo_tasks::macro_helpers::Lazy::new(turbo_tasks::macro_helpers::VTableRegistry::new);\n \n         impl turbo_tasks::VcValueTrait for Box<dyn #trait_ident> {\n             type ValueTrait = dyn #trait_ident;\n \n             fn get_trait_type_id() -> turbo_tasks::TraitTypeId {\n-                *#trait_type_id_ident\n+                static ident: turbo_tasks::macro_helpers::Lazy<turbo_tasks::TraitTypeId> =\n+                turbo_tasks::macro_helpers::Lazy::new(|| {\n+                    turbo_tasks::registry::get_trait_type_id(&#trait_type_ident)\n+                });\n+\n+                *ident\n             }\n \n             fn get_impl_vtables() -> &'static turbo_tasks::macro_helpers::VTableRegistry<Self::ValueTrait> {\n-                &*#trait_type_vtable_registry\n+                static registry: turbo_tasks::macro_helpers::Lazy<turbo_tasks::macro_helpers::VTableRegistry<dyn # trait_ident>> =\n+                turbo_tasks::macro_helpers::Lazy::new(turbo_tasks::macro_helpers::VTableRegistry::new);\n+\n+                &*registry\n             }\n         }\n "
        },
        {
            "sha": "b97c1feaba73e06ca8adb3fc0d103837d17ece9c",
            "filename": "turbopack/crates/turbo-tasks/src/completion.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcompletion.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcompletion.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fcompletion.rs?ref=b6a2a2edd469e59ba8707ab462878069234e4eb8",
            "patch": "@@ -37,7 +37,9 @@ impl Completion {\n         // This is the same code that Completion::cell uses except that it\n         // only updates the cell when it is empty (Completion::cell opted-out of\n         // that via `#[turbo_tasks::value(cell = \"new\")]`)\n-        let cell = turbo_tasks::macro_helpers::find_cell_by_type(*COMPLETION_VALUE_TYPE_ID);\n+        let cell = turbo_tasks::macro_helpers::find_cell_by_type(\n+            <Completion as crate::VcValueType>::get_value_type_id(),\n+        );\n         cell.conditional_update(|old| old.is_none().then_some(Completion));\n         let raw: RawVc = cell.into();\n         raw.into()"
        },
        {
            "sha": "db996d8c0f4f7f77633f8580bae7dc417cc4ec96",
            "filename": "turbopack/crates/turbopack-node/src/evaluate.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs?ref=b6a2a2edd469e59ba8707ab462878069234e4eb8",
            "patch": "@@ -15,8 +15,8 @@ use serde_json::Value as JsonValue;\n use turbo_rcstr::rcstr;\n use turbo_tasks::{\n     Completion, FxIndexMap, NonLocalValue, OperationVc, RawVc, ResolvedVc, TaskInput,\n-    TryJoinIterExt, Vc, apply_effects, duration_span, fxindexmap, mark_finished, prevent_gc,\n-    trace::TraceRawVcs, util::SharedError,\n+    TryJoinIterExt, Vc, VcValueType, apply_effects, duration_span, fxindexmap, mark_finished,\n+    prevent_gc, trace::TraceRawVcs, util::SharedError,\n };\n use turbo_tasks_bytes::{Bytes, Stream};\n use turbo_tasks_env::{EnvMap, ProcessEnv};\n@@ -371,7 +371,9 @@ pub fn custom_evaluate(evaluate_context: impl EvaluateContext) -> Vc<JavaScriptE\n \n     // We create a new cell in this task, which will be updated from the\n     // [compute_evaluate_stream] task.\n-    let cell = turbo_tasks::macro_helpers::find_cell_by_type(*JAVASCRIPTEVALUATION_VALUE_TYPE_ID);\n+    let cell = turbo_tasks::macro_helpers::find_cell_by_type(\n+        <JavaScriptEvaluation as VcValueType>::get_value_type_id(),\n+    );\n \n     // We initialize the cell with a stream that is open, but has no values.\n     // The first [compute_evaluate_stream] pipe call will pick up that stream."
        },
        {
            "sha": "02fd6c4c28b02a1b4e70c9f695536ab42d1e2e02",
            "filename": "turbopack/crates/turbopack-node/src/render/render_proxy.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_proxy.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_proxy.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_proxy.rs?ref=b6a2a2edd469e59ba8707ab462878069234e4eb8",
            "patch": "@@ -9,8 +9,8 @@ use parking_lot::Mutex;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{\n-    RawVc, ResolvedVc, TaskInput, ValueToString, Vc, duration_span, mark_finished, prevent_gc,\n-    trace::TraceRawVcs, util::SharedError,\n+    RawVc, ResolvedVc, TaskInput, ValueToString, Vc, VcValueType, duration_span, mark_finished,\n+    prevent_gc, trace::TraceRawVcs, util::SharedError,\n };\n use turbo_tasks_bytes::{Bytes, Stream};\n use turbo_tasks_env::ProcessEnv;\n@@ -177,7 +177,9 @@ fn render_stream(options: RenderStreamOptions) -> Vc<RenderStream> {\n \n     // We create a new cell in this task, which will be updated from the\n     // [render_stream_internal] task.\n-    let cell = turbo_tasks::macro_helpers::find_cell_by_type(*RENDERSTREAM_VALUE_TYPE_ID);\n+    let cell = turbo_tasks::macro_helpers::find_cell_by_type(\n+        <RenderStream as VcValueType>::get_value_type_id(),\n+    );\n \n     // We initialize the cell with a stream that is open, but has no values.\n     // The first [render_stream_internal] pipe call will pick up that stream."
        },
        {
            "sha": "6e312d7da2be192c27109a8c264385a8658f27b8",
            "filename": "turbopack/crates/turbopack-node/src/render/render_static.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_static.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b6a2a2edd469e59ba8707ab462878069234e4eb8/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_static.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Frender%2Frender_static.rs?ref=b6a2a2edd469e59ba8707ab462878069234e4eb8",
            "patch": "@@ -9,8 +9,8 @@ use parking_lot::Mutex;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::rcstr;\n use turbo_tasks::{\n-    RawVc, ResolvedVc, TaskInput, ValueToString, Vc, duration_span, mark_finished, prevent_gc,\n-    trace::TraceRawVcs, util::SharedError,\n+    RawVc, ResolvedVc, TaskInput, ValueToString, Vc, VcValueType, duration_span, mark_finished,\n+    prevent_gc, trace::TraceRawVcs, util::SharedError,\n };\n use turbo_tasks_bytes::{Bytes, Stream};\n use turbo_tasks_env::ProcessEnv;\n@@ -228,7 +228,9 @@ fn render_stream(options: RenderStreamOptions) -> Vc<RenderStream> {\n \n     // We create a new cell in this task, which will be updated from the\n     // [render_stream_internal] task.\n-    let cell = turbo_tasks::macro_helpers::find_cell_by_type(*RENDERSTREAM_VALUE_TYPE_ID);\n+    let cell = turbo_tasks::macro_helpers::find_cell_by_type(\n+        <RenderStream as VcValueType>::get_value_type_id(),\n+    );\n \n     // We initialize the cell with a stream that is open, but has no values.\n     // The first [render_stream_internal] pipe call will pick up that stream."
        }
    ],
    "stats": {
        "total": 112,
        "additions": 36,
        "deletions": 76
    }
}