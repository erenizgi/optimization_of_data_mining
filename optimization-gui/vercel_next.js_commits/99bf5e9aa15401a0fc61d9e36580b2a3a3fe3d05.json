{
    "author": "eps1lon",
    "message": "Add (failing) test for module based feature telemetry in App Router (#75952)\n\nNoticed this while adding bundle layers to Pages router. The telemetry Webpack plugin is picking up these features but then we're not recording them properly.",
    "sha": "99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05",
    "files": [
        {
            "sha": "9b27f0ee02ad7baa0c814adb3be1dd7384a5ac2d",
            "filename": "test/integration/telemetry/app/app-dir/page.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Fapp%2Fapp-dir%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Fapp%2Fapp-dir%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Fapp%2Fapp-dir%2Fpage.js?ref=99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05",
            "patch": "@@ -0,0 +1,16 @@\n+import Image from 'next/image'\n+import LegacyImage from 'next/legacy/image'\n+import profilePic from '../../public/small.jpg'\n+\n+function About() {\n+  return (\n+    <>\n+      <h1>My Homepage</h1>\n+      <LegacyImage src={profilePic} alt=\"Picture of the author\" />\n+      <Image src={profilePic} alt=\"Picture of the author\" />\n+      <p>Welcome to my homepage!</p>\n+    </>\n+  )\n+}\n+\n+export default About"
        },
        {
            "sha": "5560657841caf85961c08c11940fc656ddbba1de",
            "filename": "test/integration/telemetry/app/hello/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Fapp%2Fhello%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Fapp%2Fhello%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Fapp%2Fhello%2Fpage.js?ref=99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'hello world'\n+}"
        },
        {
            "sha": "803f17d863c8ad887c14588aab3487e473367b41",
            "filename": "test/integration/telemetry/app/layout.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Fapp%2Flayout.js?ref=99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05",
            "patch": "@@ -0,0 +1,7 @@\n+export default function RootLayout({ children }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "3dd24f8a72db59c501fd22c4012413507ad21c3f",
            "filename": "test/integration/telemetry/test/config.test.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js?ref=99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05",
            "patch": "@@ -84,7 +84,7 @@ describe('config telemetry', () => {\n           expect(event1).toMatch(/\"reactStrictMode\": false/)\n           expect(event1).toMatch(/\"turboFlag\": false/)\n           expect(event1).toMatch(/\"pagesDir\": true/)\n-          expect(event1).toMatch(/\"appDir\": false/)\n+          expect(event1).toMatch(/\"appDir\": true/)\n         } catch (err) {\n           require('console').error('failing stderr', stderr, err)\n           throw err\n@@ -287,6 +287,7 @@ describe('config telemetry', () => {\n             expect.arrayContaining([\n               {\n                 featureName: 'next/image',\n+                // FIXME: Should be +1 from App Router\n                 invocationCount: 2,\n               },\n               {\n@@ -532,12 +533,14 @@ describe('config telemetry', () => {\n           )\n           // eslint-disable-next-line jest/no-standalone-expect\n           expect(featureUsageEvents).toContainEqual({\n+            // FIXME: Should be +1 from App Router\n             featureName: 'next/legacy/image',\n             invocationCount: 2,\n           })\n           // eslint-disable-next-line jest/no-standalone-expect\n           expect(featureUsageEvents).toContainEqual({\n             featureName: 'next/image',\n+            // FIXME: Should be +1 from App Router\n             invocationCount: 2,\n           })\n         }\n@@ -724,6 +727,7 @@ describe('config telemetry', () => {\n             path.join(appDir, 'next.config.js')\n           )\n \n+          await fs.move(path.join(appDir, 'app'), path.join(appDir, '~app'))\n           await fs.move(path.join(appDir, '_app'), path.join(appDir, 'app'))\n \n           const { stderr } = await nextBuild(appDir, [], {\n@@ -737,6 +741,7 @@ describe('config telemetry', () => {\n           )\n \n           await fs.move(path.join(appDir, 'app'), path.join(appDir, '_app'))\n+          await fs.move(path.join(appDir, '~app'), path.join(appDir, 'app'))\n \n           const featureUsageEvents = findAllTelemetryEvents(\n             stderr,"
        },
        {
            "sha": "9949a53c43a7c3770d2cea6a2278503fdb129aad",
            "filename": "test/integration/telemetry/test/index.test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Ftest%2Findex.test.js?ref=99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05",
            "patch": "@@ -382,8 +382,8 @@ describe('Telemetry CLI', () => {\n         expect(event1).toMatch(/\"ssrPageCount\": 3/)\n         expect(event1).toMatch(/\"staticPageCount\": 5/)\n         expect(event1).toMatch(/\"totalPageCount\": 12/)\n-        expect(event1).toMatch(/\"totalAppPagesCount\": 0/)\n-        expect(event1).toMatch(/\"staticAppPagesCount\": 0/)\n+        expect(event1).toMatch(/\"totalAppPagesCount\": 3/)\n+        expect(event1).toMatch(/\"staticAppPagesCount\": 3/)\n         expect(event1).toMatch(/\"serverAppPagesCount\": 0/)\n         expect(event1).toMatch(/\"edgeRuntimeAppCount\": 0/)\n         expect(event1).toMatch(/\"edgeRuntimePagesCount\": 2/)"
        },
        {
            "sha": "106fc2f7fa8d5bdb204768396f56a7d5fb692a3d",
            "filename": "test/integration/telemetry/test/page-features.test.js",
            "status": "modified",
            "additions": 125,
            "deletions": 173,
            "changes": 298,
            "blob_url": "https://github.com/vercel/next.js/blob/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Ftest%2Fpage-features.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05/test%2Fintegration%2Ftelemetry%2Ftest%2Fpage-features.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Ftest%2Fpage-features.test.js?ref=99bf5e9aa15401a0fc61d9e36580b2a3a3fe3d05",
            "patch": "@@ -11,190 +11,145 @@ import {\n \n const appDir = path.join(__dirname, '..')\n \n-const setupAppDir = async () => {\n-  await fs.mkdir(path.join(__dirname, '../app'))\n-  await fs.writeFile(\n-    path.join(__dirname, '../app/layout.js'),\n-    `\n-      export default function RootLayout({ children }) {\n-        return <html>\n-          <head/>\n-          <body>{children}</body>\n-        </html>\n-      }\n-    `\n-  )\n-  await fs.ensureFile(path.join(__dirname, '../app/hello/page.js'))\n-  await fs.writeFile(\n-    path.join(__dirname, '../app/hello/page.js'),\n-    'export default function Page() { return \"hello world\" }'\n-  )\n-\n-  return async function teardownAppDir() {\n-    await fs.remove(path.join(__dirname, '../app'))\n-  }\n-}\n-\n describe('page features telemetry', () => {\n   if (process.env.TURBOPACK) {\n     it('detects --turbo correctly for `next dev`', async () => {\n       let port = await findPort()\n       let stderr = ''\n \n-      const teardown = await setupAppDir()\n+      const handleStderr = (msg) => {\n+        stderr += msg\n+      }\n+      let app = await launchApp(appDir, port, {\n+        onStderr: handleStderr,\n+        env: {\n+          NEXT_TELEMETRY_DEBUG: 1,\n+        },\n+        turbo: true,\n+      })\n+      await check(() => stderr, /NEXT_CLI_SESSION_STARTED/)\n+      await renderViaHTTP(port, '/hello')\n+\n+      if (app) {\n+        await killApp(app)\n+      }\n \n       try {\n-        const handleStderr = (msg) => {\n-          stderr += msg\n-        }\n-        let app = await launchApp(appDir, port, {\n-          onStderr: handleStderr,\n-          env: {\n-            NEXT_TELEMETRY_DEBUG: 1,\n-          },\n-          turbo: true,\n-        })\n-        await check(() => stderr, /NEXT_CLI_SESSION_STARTED/)\n-        await renderViaHTTP(port, '/hello')\n-\n-        if (app) {\n-          await killApp(app)\n-        }\n-\n-        try {\n-          expect(stderr).toContain('NEXT_CLI_SESSION_STARTED')\n-          const event1 = /NEXT_CLI_SESSION_STARTED[\\s\\S]+?{([\\s\\S]+?)}/\n-            .exec(stderr)\n-            .pop()\n+        expect(stderr).toContain('NEXT_CLI_SESSION_STARTED')\n+        const event1 = /NEXT_CLI_SESSION_STARTED[\\s\\S]+?{([\\s\\S]+?)}/\n+          .exec(stderr)\n+          .pop()\n \n-          expect(event1).toMatch(/\"pagesDir\": true/)\n-          expect(event1).toMatch(/\"turboFlag\": true/)\n-        } catch (err) {\n-          require('console').error('failing stderr', stderr, err)\n-          throw err\n-        }\n-      } finally {\n-        await teardown()\n+        expect(event1).toMatch(/\"pagesDir\": true/)\n+        expect(event1).toMatch(/\"turboFlag\": true/)\n+      } catch (err) {\n+        require('console').error('failing stderr', stderr, err)\n+        throw err\n       }\n     })\n \n     it('detects --turbo correctly for `next dev` stopped', async () => {\n       let port = await findPort()\n       let stderr = ''\n \n-      const teardown = await setupAppDir()\n-\n-      try {\n-        const handleStderr = (msg) => {\n-          stderr += msg\n-        }\n-        let app = await launchApp(appDir, port, {\n-          onStderr: handleStderr,\n-          env: {\n-            NEXT_TELEMETRY_DEBUG: 1,\n-          },\n-          turbo: true,\n-        })\n-\n-        await check(() => stderr, /NEXT_CLI_SESSION_STARTED/)\n-        await renderViaHTTP(port, '/hello')\n+      const handleStderr = (msg) => {\n+        stderr += msg\n+      }\n+      let app = await launchApp(appDir, port, {\n+        onStderr: handleStderr,\n+        env: {\n+          NEXT_TELEMETRY_DEBUG: 1,\n+        },\n+        turbo: true,\n+      })\n+\n+      await check(() => stderr, /NEXT_CLI_SESSION_STARTED/)\n+      await renderViaHTTP(port, '/hello')\n+\n+      if (app) {\n+        await killApp(app, 'SIGTERM')\n+      }\n+      await check(() => stderr, /NEXT_CLI_SESSION_STOPPED/)\n \n-        if (app) {\n-          await killApp(app, 'SIGTERM')\n-        }\n-        await check(() => stderr, /NEXT_CLI_SESSION_STOPPED/)\n+      expect(stderr).toContain('NEXT_CLI_SESSION_STOPPED')\n+      const event1 = /NEXT_CLI_SESSION_STOPPED[\\s\\S]+?{([\\s\\S]+?)}/\n+        .exec(stderr)\n+        .pop()\n \n-        expect(stderr).toContain('NEXT_CLI_SESSION_STOPPED')\n-        const event1 = /NEXT_CLI_SESSION_STOPPED[\\s\\S]+?{([\\s\\S]+?)}/\n-          .exec(stderr)\n-          .pop()\n+      expect(event1).toMatch(/\"pagesDir\": true/)\n+      expect(event1).toMatch(/\"turboFlag\": true/)\n \n-        expect(event1).toMatch(/\"pagesDir\": true/)\n-        expect(event1).toMatch(/\"turboFlag\": true/)\n-\n-        expect(\n-          await fs.pathExists(path.join(appDir, '.next/_events.json'))\n-        ).toBe(false)\n-      } finally {\n-        await teardown()\n-      }\n+      expect(await fs.pathExists(path.join(appDir, '.next/_events.json'))).toBe(\n+        false\n+      )\n     })\n   } else {\n     it('detects correctly for `next dev` stopped (no turbo)', async () => {\n       let port = await findPort()\n       let stderr = ''\n \n-      const teardown = await setupAppDir()\n-\n-      try {\n-        const handleStderr = (msg) => {\n-          stderr += msg\n-        }\n-        let app = await launchApp(appDir, port, {\n-          onStderr: handleStderr,\n-          env: {\n-            NEXT_TELEMETRY_DEBUG: 1,\n-          },\n-        })\n+      const handleStderr = (msg) => {\n+        stderr += msg\n+      }\n+      let app = await launchApp(appDir, port, {\n+        onStderr: handleStderr,\n+        env: {\n+          NEXT_TELEMETRY_DEBUG: 1,\n+        },\n+      })\n+\n+      await check(() => stderr, /NEXT_CLI_SESSION_STARTED/)\n+      await renderViaHTTP(port, '/hello')\n+\n+      if (app) {\n+        await killApp(app, 'SIGTERM')\n+      }\n \n-        await check(() => stderr, /NEXT_CLI_SESSION_STARTED/)\n-        await renderViaHTTP(port, '/hello')\n+      await check(() => stderr, /NEXT_CLI_SESSION_STOPPED/)\n \n-        if (app) {\n-          await killApp(app, 'SIGTERM')\n-        }\n+      expect(stderr).toContain('NEXT_CLI_SESSION_STOPPED')\n+      const event1 = /NEXT_CLI_SESSION_STOPPED[\\s\\S]+?{([\\s\\S]+?)}/\n+        .exec(stderr)\n+        .pop()\n \n-        await check(() => stderr, /NEXT_CLI_SESSION_STOPPED/)\n+      expect(event1).toMatch(/\"turboFlag\": false/)\n+      expect(event1).toMatch(/\"pagesDir\": true/)\n+      expect(event1).toMatch(/\"appDir\": true/)\n \n-        expect(stderr).toContain('NEXT_CLI_SESSION_STOPPED')\n-        const event1 = /NEXT_CLI_SESSION_STOPPED[\\s\\S]+?{([\\s\\S]+?)}/\n-          .exec(stderr)\n-          .pop()\n-\n-        expect(event1).toMatch(/\"turboFlag\": false/)\n-        expect(event1).toMatch(/\"pagesDir\": true/)\n-        expect(event1).toMatch(/\"appDir\": true/)\n-\n-        expect(\n-          await fs.pathExists(path.join(appDir, '.next/_events.json'))\n-        ).toBe(false)\n-      } finally {\n-        await teardown()\n-      }\n+      expect(await fs.pathExists(path.join(appDir, '.next/_events.json'))).toBe(\n+        false\n+      )\n     })\n     ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n       'production mode',\n       () => {\n         it('should detect app page counts', async () => {\n-          const teardown = await setupAppDir()\n-\n-          try {\n-            await fs.ensureFile(path.join(__dirname, '../app/ssr/page.js'))\n-            await fs.writeFile(\n-              path.join(__dirname, '../app/ssr/page.js'),\n-              `\n+          await fs.ensureFile(path.join(__dirname, '../app/ssr/page.js'))\n+          await fs.writeFile(\n+            path.join(__dirname, '../app/ssr/page.js'),\n+            `\n           export const revalidate = 0\n           export default function Page() {\n             return <p>ssr page</p>\n           }\n         `\n-            )\n-            await fs.ensureFile(path.join(__dirname, '../app/edge-ssr/page.js'))\n-            await fs.writeFile(\n-              path.join(__dirname, '../app/edge-ssr/page.js'),\n-              `\n+          )\n+          await fs.ensureFile(path.join(__dirname, '../app/edge-ssr/page.js'))\n+          await fs.writeFile(\n+            path.join(__dirname, '../app/edge-ssr/page.js'),\n+            `\n           export const runtime = 'edge'\n           export default function Page() {\n             return <p>edge-ssr page</p>\n           }\n         `\n-            )\n-            await fs.ensureFile(\n-              path.join(__dirname, '../app/app-ssg/[slug]/page.js')\n-            )\n-            await fs.writeFile(\n-              path.join(__dirname, '../app/app-ssg/[slug]/page.js'),\n-              `\n+          )\n+          await fs.ensureFile(\n+            path.join(__dirname, '../app/app-ssg/[slug]/page.js')\n+          )\n+          await fs.writeFile(\n+            path.join(__dirname, '../app/app-ssg/[slug]/page.js'),\n+            `\n           export function generateStaticParams() {\n             return [\n               { slug: 'post-1' },\n@@ -205,39 +160,36 @@ describe('page features telemetry', () => {\n             return <p>ssg page</p>\n           }\n         `\n-            )\n-            const { stderr } = await nextBuild(appDir, [], {\n-              stderr: true,\n-              env: { NEXT_TELEMETRY_DEBUG: 1 },\n-            })\n-\n-            try {\n-              expect(stderr).toContain('NEXT_BUILD_OPTIMIZED')\n-              const event1 = /NEXT_BUILD_OPTIMIZED[\\s\\S]+?{([\\s\\S]+?)}/\n-                .exec(stderr)\n-                .pop()\n-              expect(event1).toMatch(/\"staticPropsPageCount\": 2/)\n-              expect(event1).toMatch(/\"serverPropsPageCount\": 2/)\n-              expect(event1).toMatch(/\"ssrPageCount\": 3/)\n-              expect(event1).toMatch(/\"staticPageCount\": 5/)\n-              expect(event1).toMatch(/\"totalPageCount\": 12/)\n-              expect(event1).toMatch(/\"totalAppPagesCount\": 5/)\n-              expect(event1).toMatch(/\"serverAppPagesCount\": 2/)\n-              expect(event1).toMatch(/\"edgeRuntimeAppCount\": 1/)\n-              expect(event1).toMatch(/\"edgeRuntimePagesCount\": 2/)\n-\n-              expect(stderr).toContain('NEXT_BUILD_COMPLETED')\n-              const event2 = /NEXT_BUILD_COMPLETED[\\s\\S]+?{([\\s\\S]+?)}/\n-                .exec(stderr)\n-                .pop()\n-\n-              expect(event2).toMatch(/\"totalAppPagesCount\": 5/)\n-            } catch (err) {\n-              require('console').error('failing stderr', stderr, err)\n-              throw err\n-            }\n-          } finally {\n-            await teardown()\n+          )\n+          const { stderr } = await nextBuild(appDir, [], {\n+            stderr: true,\n+            env: { NEXT_TELEMETRY_DEBUG: 1 },\n+          })\n+\n+          try {\n+            expect(stderr).toContain('NEXT_BUILD_OPTIMIZED')\n+            const event1 = /NEXT_BUILD_OPTIMIZED[\\s\\S]+?{([\\s\\S]+?)}/\n+              .exec(stderr)\n+              .pop()\n+            expect(event1).toMatch(/\"staticPropsPageCount\": 2/)\n+            expect(event1).toMatch(/\"serverPropsPageCount\": 2/)\n+            expect(event1).toMatch(/\"ssrPageCount\": 3/)\n+            expect(event1).toMatch(/\"staticPageCount\": 5/)\n+            expect(event1).toMatch(/\"totalPageCount\": 12/)\n+            expect(event1).toMatch(/\"totalAppPagesCount\": 6/)\n+            expect(event1).toMatch(/\"serverAppPagesCount\": 2/)\n+            expect(event1).toMatch(/\"edgeRuntimeAppCount\": 1/)\n+            expect(event1).toMatch(/\"edgeRuntimePagesCount\": 2/)\n+\n+            expect(stderr).toContain('NEXT_BUILD_COMPLETED')\n+            const event2 = /NEXT_BUILD_COMPLETED[\\s\\S]+?{([\\s\\S]+?)}/\n+              .exec(stderr)\n+              .pop()\n+\n+            expect(event2).toMatch(/\"totalAppPagesCount\": 6/)\n+          } catch (err) {\n+            require('console').error('failing stderr', stderr, err)\n+            throw err\n           }\n         })\n "
        }
    ],
    "stats": {
        "total": 335,
        "additions": 159,
        "deletions": 176
    }
}