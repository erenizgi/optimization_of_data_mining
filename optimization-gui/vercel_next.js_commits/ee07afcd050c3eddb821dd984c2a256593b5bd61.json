{
    "author": "lukesandberg",
    "message": "[turbopack] Conditionally create pages router data endpoints. (#84194)\n\nPages router data endpoints are only needed or used in `dev` but we would unconditionally create them even in `build` scenarios`.\n\nThis clarifies the API and modifies `endpoint` collection to also collect these when they exist.  This will unblock enabling the `whole_app_module_graph`",
    "sha": "ee07afcd050c3eddb821dd984c2a256593b5bd61",
    "files": [
        {
            "sha": "77bbfddcc65b6a4a298d299479b7a865ff425b84",
            "filename": "crates/next-api/src/operation.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ee07afcd050c3eddb821dd984c2a256593b5bd61/crates%2Fnext-api%2Fsrc%2Foperation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee07afcd050c3eddb821dd984c2a256593b5bd61/crates%2Fnext-api%2Fsrc%2Foperation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Foperation.rs?ref=ee07afcd050c3eddb821dd984c2a256593b5bd61",
            "patch": "@@ -166,7 +166,7 @@ async fn pick_endpoint(\n         }\n         EndpointSelector::RoutePageData(name) => {\n             if let Some(Route::Page { data_endpoint, .. }) = endpoints.routes.get(&name) {\n-                Some(*data_endpoint)\n+                *data_endpoint\n             } else {\n                 None\n             }"
        },
        {
            "sha": "d61cb12689cb4658f08842177c9046269f0d585c",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 19,
            "deletions": 14,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/ee07afcd050c3eddb821dd984c2a256593b5bd61/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee07afcd050c3eddb821dd984c2a256593b5bd61/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=ee07afcd050c3eddb821dd984c2a256593b5bd61",
            "patch": "@@ -199,18 +199,23 @@ impl PagesProject {\n                         .to_resolved()\n                         .await?,\n                     ),\n-                    data_endpoint: ResolvedVc::upcast(\n-                        PageEndpoint::new(\n-                            PageEndpointType::Data,\n-                            self,\n-                            pathname,\n-                            original_name,\n-                            page,\n-                            pages_structure,\n-                        )\n-                        .to_resolved()\n-                        .await?,\n-                    ),\n+                    // The data endpoint is only needed in development mode to support HMR\n+                    data_endpoint: if self.project().next_mode().await?.is_development() {\n+                        Some(ResolvedVc::upcast(\n+                            PageEndpoint::new(\n+                                PageEndpointType::Data,\n+                                self,\n+                                pathname,\n+                                original_name,\n+                                page,\n+                                pages_structure,\n+                            )\n+                            .to_resolved()\n+                            .await?,\n+                        ))\n+                    } else {\n+                        None\n+                    },\n                 })\n             })\n         };\n@@ -653,7 +658,7 @@ impl PageEndpoint {\n             if self.ty == PageEndpointType::Data {\n                 rcstr!(\"?server-data\")\n             } else {\n-                RcStr::default()\n+                rcstr!(\"\")\n             },\n         )))\n     }\n@@ -719,8 +724,8 @@ impl PageEndpoint {\n         let this = self.await?;\n         let project = this.pages_project.project();\n \n-        let should_trace = project.next_mode().await?.is_production();\n         if *project.per_page_module_graph().await? {\n+            let should_trace = project.next_mode().await?.is_production();\n             let ssr_chunk_module = self.internal_ssr_chunk_module().await?;\n             // Implements layout segment optimization to compute a graph \"chain\" for document, app,\n             // page"
        },
        {
            "sha": "e1296cf4861537ddbfe3fe90ac6c7032b4f89b21",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ee07afcd050c3eddb821dd984c2a256593b5bd61/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee07afcd050c3eddb821dd984c2a256593b5bd61/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=ee07afcd050c3eddb821dd984c2a256593b5bd61",
            "patch": "@@ -863,7 +863,7 @@ impl Project {\n             match route {\n                 Route::Page {\n                     html_endpoint,\n-                    data_endpoint: _,\n+                    data_endpoint,\n                 } => {\n                     if !app_dir_only {\n                         endpoints.push(*html_endpoint);\n@@ -873,6 +873,10 @@ impl Project {\n                             endpoints.push(entrypoints.pages_document_endpoint);\n                             is_pages_entries_added = true;\n                         }\n+                        // This only exists in development mode for HMR\n+                        if let Some(data_endpoint) = data_endpoint {\n+                            endpoints.push(*data_endpoint);\n+                        }\n                     }\n                 }\n                 Route::PageApi { endpoint } => {"
        },
        {
            "sha": "8da029b73ba0e4f8af3982daae9b27e01be29134",
            "filename": "crates/next-api/src/route.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ee07afcd050c3eddb821dd984c2a256593b5bd61/crates%2Fnext-api%2Fsrc%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee07afcd050c3eddb821dd984c2a256593b5bd61/crates%2Fnext-api%2Fsrc%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Froute.rs?ref=ee07afcd050c3eddb821dd984c2a256593b5bd61",
            "patch": "@@ -34,7 +34,7 @@ pub struct AppPageRoute {\n pub enum Route {\n     Page {\n         html_endpoint: ResolvedVc<Box<dyn Endpoint>>,\n-        data_endpoint: ResolvedVc<Box<dyn Endpoint>>,\n+        data_endpoint: Option<ResolvedVc<Box<dyn Endpoint>>>,\n     },\n     PageApi {\n         endpoint: ResolvedVc<Box<dyn Endpoint>>,"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 26,
        "deletions": 17
    }
}