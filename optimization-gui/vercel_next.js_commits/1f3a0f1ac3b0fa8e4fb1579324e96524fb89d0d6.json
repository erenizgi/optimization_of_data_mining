{
    "author": "kdy1",
    "message": "refactor(next-swc): Do not amend minifier options from Rust code (#78719)\n\n### What?\n\nRemove Rust-side amending logic for minifier options and move all configuration to JS side\n\n### Why?\n\nx-ref: https://vercel.slack.com/archives/C04KC8A53T7/p1746034154828369?thread_ts=1746024368.021439&cid=C04KC8A53T7\n\n### How?",
    "sha": "1f3a0f1ac3b0fa8e4fb1579324e96524fb89d0d6",
    "files": [
        {
            "sha": "be9966cca5edf93bcbfd8993bdaeab9da8b21553",
            "filename": "crates/napi/src/minify.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 38,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/1f3a0f1ac3b0fa8e4fb1579324e96524fb89d0d6/crates%2Fnapi%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1f3a0f1ac3b0fa8e4fb1579324e96524fb89d0d6/crates%2Fnapi%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fminify.rs?ref=1f3a0f1ac3b0fa8e4fb1579324e96524fb89d0d6",
            "patch": "@@ -30,20 +30,16 @@ use napi::bindgen_prelude::*;\n use rustc_hash::FxHashMap;\n use serde::Deserialize;\n use swc_core::{\n-    base::{config::JsMinifyOptions, try_with_handler, BoolOrDataConfig, TransformOutput},\n+    base::{config::JsMinifyOptions, try_with_handler, TransformOutput},\n     common::{errors::ColorConfig, sync::Lrc, FileName, SourceFile, SourceMap, GLOBALS},\n-    ecma::minifier::option::{\n-        terser::{TerserCompressorOptions, TerserInlineOption},\n-        MangleOptions,\n-    },\n };\n \n use crate::{get_compiler, util::MapErr};\n \n pub struct MinifyTask {\n     c: swc_core::base::Compiler,\n     code: MinifyTarget,\n-    opts: swc_core::base::config::JsMinifyOptions,\n+    opts: JsMinifyOptions,\n }\n \n #[derive(Deserialize)]\n@@ -104,43 +100,14 @@ impl Task for MinifyTask {\n     }\n }\n \n-/// **NOTE** `inline: 3` breaks some codes.\n-///\n-/// <https://github.com/vercel/next.js/pull/57904>\n-fn patch_opts(opts: &mut JsMinifyOptions) {\n-    opts.compress = BoolOrDataConfig::from_obj(TerserCompressorOptions {\n-        inline: Some(TerserInlineOption::Num(2)),\n-        global_defs: [(\n-            \"process.env.__NEXT_PRIVATE_MINIMIZE_MACRO_FALSE\".into(),\n-            false.into(),\n-        )]\n-        .iter()\n-        .cloned()\n-        .collect(),\n-        ..Default::default()\n-    });\n-\n-    if !opts.mangle.is_false() {\n-        let mut mangle = std::mem::take(&mut opts.mangle);\n-        if mangle.is_true() {\n-            mangle = BoolOrDataConfig::from_obj(MangleOptions::default());\n-        }\n-        opts.mangle = mangle.map(|mut mangle_opts| {\n-            mangle_opts.reserved.push(\"AbortSignal\".into());\n-            mangle_opts\n-        });\n-    }\n-}\n-\n #[napi]\n pub fn minify(\n     input: Buffer,\n     opts: Buffer,\n     signal: Option<AbortSignal>,\n ) -> napi::Result<AsyncTask<MinifyTask>> {\n     let code = serde_json::from_slice(&input)?;\n-    let mut opts = serde_json::from_slice(&opts)?;\n-    patch_opts(&mut opts);\n+    let opts = serde_json::from_slice(&opts)?;\n \n     let c = get_compiler();\n \n@@ -152,8 +119,7 @@ pub fn minify(\n #[napi]\n pub fn minify_sync(input: Buffer, opts: Buffer) -> napi::Result<TransformOutput> {\n     let code: MinifyTarget = serde_json::from_slice(&input)?;\n-    let mut opts = serde_json::from_slice(&opts)?;\n-    patch_opts(&mut opts);\n+    let opts = serde_json::from_slice(&opts)?;\n \n     let c = get_compiler();\n "
        },
        {
            "sha": "a86483dd7fa0b359754098112b9630469aaa5577",
            "filename": "packages/next/src/build/webpack/plugins/minify-webpack-plugin/src/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/1f3a0f1ac3b0fa8e4fb1579324e96524fb89d0d6/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1f3a0f1ac3b0fa8e4fb1579324e96524fb89d0d6/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts?ref=1f3a0f1ac3b0fa8e4fb1579324e96524fb89d0d6",
            "patch": "@@ -52,6 +52,7 @@ export class MinifyPlugin {\n     const mangle = this.options.noMangling\n       ? false\n       : {\n+          reserved: ['AbortSignal'],\n           disableCharFreq: !!this.options.disableCharFreq,\n         }\n     const compilationSpan =\n@@ -139,9 +140,12 @@ export class MinifyPlugin {\n                     },\n                   }\n                 : {}),\n-              // Compress options are defined in crates/napi/src/minify.rs.\n-              compress: false,\n-              // Mangle options may be amended in crates/napi/src/minify.rs.\n+              compress: {\n+                inline: 2,\n+                global_defs: {\n+                  'process.env.__NEXT_PRIVATE_MINIMIZE_MACRO_FALSE': false,\n+                },\n+              },\n               mangle,\n               module: 'unknown',\n               output: {"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 11,
        "deletions": 41
    }
}