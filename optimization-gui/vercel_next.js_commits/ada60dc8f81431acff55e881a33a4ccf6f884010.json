{
    "author": "huozhi",
    "message": "[codemod] upgrade to nearest minor by default (#87004)",
    "sha": "ada60dc8f81431acff55e881a33a4ccf6f884010",
    "files": [
        {
            "sha": "517ee16db064bf8a0df287999be1ba9f64f24fec",
            "filename": "packages/next-codemod/bin/next-codemod.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/ada60dc8f81431acff55e881a33a4ccf6f884010/packages%2Fnext-codemod%2Fbin%2Fnext-codemod.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ada60dc8f81431acff55e881a33a4ccf6f884010/packages%2Fnext-codemod%2Fbin%2Fnext-codemod.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Fbin%2Fnext-codemod.ts?ref=ada60dc8f81431acff55e881a33a4ccf6f884010",
            "patch": "@@ -58,18 +58,9 @@ program\n   .description(\n     'Upgrade Next.js apps to desired versions with a single command.'\n   )\n-  // The CLI interface must be backwards compatible at all times so that older\n-  // versions of Next.js can still run the codemod successfully.\n   .argument(\n     '[revision]',\n-    'Specify the target Next.js version using an NPM dist tag (e.g. \"latest\", \"canary\", \"rc\", \"beta\") or an exact version number (e.g. \"15.0.0\").',\n-    packageJson.version.includes('-canary.')\n-      ? 'canary'\n-      : packageJson.version.includes('-rc.')\n-        ? 'rc'\n-        : packageJson.version.includes('-beta.')\n-          ? 'beta'\n-          : 'latest'\n+    'Specify the upgrade type (\"patch\", \"minor\", \"major\"), an NPM dist tag (e.g. \"latest\", \"canary\", \"rc\"), or an exact version (e.g. \"15.0.0\"). Defaults to \"minor\".'\n   )\n   .usage('[revision] [options]')\n   .option('--verbose', 'Verbose output', false)"
        },
        {
            "sha": "f443228f82cad702ac742fd41fa031fbf631bdd8",
            "filename": "packages/next-codemod/bin/upgrade.ts",
            "status": "modified",
            "additions": 66,
            "deletions": 5,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/ada60dc8f81431acff55e881a33a4ccf6f884010/packages%2Fnext-codemod%2Fbin%2Fupgrade.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ada60dc8f81431acff55e881a33a4ccf6f884010/packages%2Fnext-codemod%2Fbin%2Fupgrade.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Fbin%2Fupgrade.ts?ref=ada60dc8f81431acff55e881a33a4ccf6f884010",
            "patch": "@@ -5,6 +5,7 @@ import {\n   satisfies as satisfiesVersionRange,\n   compare as compareVersions,\n   major,\n+  minor,\n } from 'semver'\n import { execSync } from 'child_process'\n import path from 'path'\n@@ -81,6 +82,33 @@ function endMessage(targetNextVersion: string) {\n \n const cwd = process.cwd()\n \n+/**\n+ * Resolves semantic version keywords (patch, minor, major) to npm version queries.\n+ * - patch: latest patch within current minor (e.g., 15.0.x -> 15.0.y)\n+ * - minor: latest minor within current major (e.g., 15.0.x -> 15.1.x)\n+ * - major: latest stable version (equivalent to \"latest\")\n+ */\n+function resolveSemanticRevision(\n+  revision: string,\n+  installedVersion: string\n+): string {\n+  const installedMajor = major(installedVersion)\n+  const installedMinor = minor(installedVersion)\n+\n+  switch (revision) {\n+    case 'patch':\n+      // ~15.0.0 matches >=15.0.0 <15.1.0\n+      return `~${installedMajor}.${installedMinor}.0`\n+    case 'minor':\n+      // ^15.0.0 matches >=15.0.0 <16.0.0\n+      return `^${installedMajor}.0.0`\n+    case 'major':\n+      return 'latest'\n+    default:\n+      return revision\n+  }\n+}\n+\n export async function runUpgrade(\n   revision: string | undefined,\n   options: { verbose: boolean }\n@@ -89,18 +117,53 @@ export async function runUpgrade(\n   const appPackageJsonPath = path.resolve(cwd, 'package.json')\n   let appPackageJson = JSON.parse(fs.readFileSync(appPackageJsonPath, 'utf8'))\n \n+  const installedNextVersion = getInstalledNextVersion()\n+\n+  // Resolve semantic keywords to npm version queries\n+  const resolvedRevision = resolveSemanticRevision(\n+    revision ?? 'minor',\n+    installedNextVersion\n+  )\n+\n+  if (options.verbose) {\n+    console.log(`  Resolved upgrade target: ${resolvedRevision}`)\n+  }\n+\n   let targetNextPackageJson: {\n     version: string\n     peerDependencies: Record<string, string>\n   }\n \n   try {\n+    // First, find the highest matching version\n+    const versionsJSON = execSync(\n+      `npm --silent view \"next@${resolvedRevision}\" --json --field version`,\n+      { encoding: 'utf-8' }\n+    )\n+    const versionOrVersions = JSON.parse(versionsJSON)\n+    let targetVersion: string\n+    if (Array.isArray(versionOrVersions)) {\n+      versionOrVersions.sort(compareVersions)\n+      targetVersion = versionOrVersions[versionOrVersions.length - 1]\n+    } else {\n+      targetVersion = versionOrVersions\n+    }\n+\n+    if (options.verbose) {\n+      console.log(`  Target version: ${targetVersion}`)\n+    }\n+\n+    // Then fetch the full package info for that specific version\n     const targetNextPackage = execSync(\n-      `npm --silent view \"next@${revision}\" --json`,\n+      `npm --silent view \"next@${targetVersion}\" --json`,\n       { encoding: 'utf-8' }\n     )\n     targetNextPackageJson = JSON.parse(targetNextPackage)\n-  } catch {}\n+  } catch (e) {\n+    if (options.verbose) {\n+      console.error('  Error fetching package info:', e)\n+    }\n+  }\n \n   const validRevision =\n     targetNextPackageJson !== null &&\n@@ -109,12 +172,10 @@ export async function runUpgrade(\n     'peerDependencies' in targetNextPackageJson\n   if (!validRevision) {\n     throw new BadInput(\n-      `Invalid revision provided: \"${revision}\". Please provide a valid Next.js version or dist-tag (e.g. \"latest\", \"canary\", \"beta\", \"rc\", or \"15.0.0\").\\nCheck available versions at https://www.npmjs.com/package/next?activeTab=versions.`\n+      `Invalid revision provided: \"${revision ?? 'minor'}\" (resolved to \"${resolvedRevision}\"). Please provide a valid Next.js version, dist-tag (e.g. \"latest\", \"canary\", \"rc\"), or upgrade type (\"patch\", \"minor\", \"major\").\\nCheck available versions at https://www.npmjs.com/package/next?activeTab=versions.`\n     )\n   }\n \n-  const installedNextVersion = getInstalledNextVersion()\n-\n   const targetNextVersion = targetNextPackageJson.version\n \n   if (compareVersions(installedNextVersion, targetNextVersion) === 0) {"
        }
    ],
    "stats": {
        "total": 82,
        "additions": 67,
        "deletions": 15
    }
}