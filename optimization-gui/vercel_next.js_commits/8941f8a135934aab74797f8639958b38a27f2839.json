{
    "author": "huozhi",
    "message": "[metadata] re-insert icons to head for streamed metadata (#76915)\n\n### What\n\nRe-insert the metadata icons under body tag into head tag to ensure they\ncan be proper displayed.\n\n### Why\n\n* For chromium based browsers (Chrome, Edge, etc.) and Safari, icons\nneed to stay under `<head>` to be picked up by the browser. Firefox\ndoesn't have this requirement.\n* Firefox will always render svg > icon > png, so it doesn't matter to\nit.\n\n\nMade a test in https://icons-order-test.vercel.app/, you can play with\nthe test cases here. These links can see the comparsion of the approach\nin the this PR.\n\nDuring deployment it's very hard to verify Safari as it's pretty broken.\nBut deploymet works well.\nAfter we re-insert the icon from body into head, they can be properly\ndisplayed across all the browsers.\n\nNote: We insert the script during streaming rather than using a jsx\nelement right after metadata to avoid the hydration errors\n\nCloses #76810\nCloses NDX-951",
    "sha": "8941f8a135934aab74797f8639958b38a27f2839",
    "files": [
        {
            "sha": "0cda2d7c25ca59bedd33b3480a0fef49dbb3bcf2",
            "filename": "packages/next/src/client/components/metadata/server-inserted-metadata.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.tsx?ref=8941f8a135934aab74797f8639958b38a27f2839",
            "previous_filename": "packages/next/src/client/components/metadata/server-inserted-metadata.ts"
        },
        {
            "sha": "715455aae30003ee38a9ce98466afd832e49cafd",
            "filename": "packages/next/src/lib/metadata/generate/icons.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficons.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficons.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficons.tsx?ref=8941f8a135934aab74797f8639958b38a27f2839",
            "patch": "@@ -1,7 +1,6 @@\n import type { ResolvedMetadata } from '../types/metadata-interface'\n import type { Icon, IconDescriptor } from '../types/metadata-types'\n \n-import React from 'react'\n import { MetaFilter } from './meta'\n \n function IconDescriptorLink({ icon }: { icon: IconDescriptor }) {"
        },
        {
            "sha": "4f20ad0565fb31c66e4ba143db8e2da87e7e9b6c",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=8941f8a135934aab74797f8639958b38a27f2839",
            "patch": "@@ -317,7 +317,7 @@ function createNotFoundLoaderTree(loaderTree: LoaderTree): LoaderTree {\n }\n \n function createDivergedMetadataComponents(\n-  Metadata: React.ComponentType<{}>,\n+  Metadata: React.ComponentType,\n   serveStreamingMetadata: boolean\n ): {\n   StaticMetadata: React.ComponentType<{}>\n@@ -326,8 +326,9 @@ function createDivergedMetadataComponents(\n   function EmptyMetadata() {\n     return null\n   }\n-  const StreamingMetadata: React.ComponentType<{}> | null =\n-    serveStreamingMetadata ? Metadata : null\n+  const StreamingMetadata: React.ComponentType | null = serveStreamingMetadata\n+    ? Metadata\n+    : null\n \n   const StaticMetadata: React.ComponentType<{}> = serveStreamingMetadata\n     ? EmptyMetadata\n@@ -1711,7 +1712,7 @@ async function renderToStream(\n   const { ServerInsertedHTMLProvider, renderServerInsertedHTML } =\n     createServerInsertedHTML()\n   const { ServerInsertedMetadataProvider, getServerInsertedMetadata } =\n-    createServerInsertedMetadata()\n+    createServerInsertedMetadata(ctx.nonce)\n \n   const tracingMetadata = getTracedMetadata(\n     getTracer().getTracePropagationData(),\n@@ -2299,9 +2300,9 @@ async function spawnDynamicValidationInDev(\n     }\n   }\n \n-  const { ServerInsertedHTMLProvider } = createServerInsertedHTML()\n-  const { ServerInsertedMetadataProvider } = createServerInsertedMetadata()\n   const nonce = '1'\n+  const { ServerInsertedHTMLProvider } = createServerInsertedHTML()\n+  const { ServerInsertedMetadataProvider } = createServerInsertedMetadata(nonce)\n \n   if (initialServerStream) {\n     const [warmupStream, renderStream] = initialServerStream.tee()\n@@ -2584,7 +2585,7 @@ async function prerenderToStream(\n   const { ServerInsertedHTMLProvider, renderServerInsertedHTML } =\n     createServerInsertedHTML()\n   const { ServerInsertedMetadataProvider, getServerInsertedMetadata } =\n-    createServerInsertedMetadata()\n+    createServerInsertedMetadata(ctx.nonce)\n \n   const tracingMetadata = getTracedMetadata(\n     getTracer().getTracePropagationData(),"
        },
        {
            "sha": "209c237b5e04723fdfddffbf9f6b8e60afa4eab9",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=8941f8a135934aab74797f8639958b38a27f2839",
            "patch": "@@ -40,7 +40,7 @@ export function createComponentTree(props: {\n   missingSlots?: Set<string>\n   preloadCallbacks: PreloadCallbacks\n   authInterrupts: boolean\n-  StreamingMetadata: React.ComponentType<{}> | null\n+  StreamingMetadata: React.ComponentType | null\n   StreamingMetadataOutlet: React.ComponentType\n }): Promise<CacheNodeSeedData> {\n   return getTracer().trace(\n@@ -92,7 +92,7 @@ async function createComponentTreeInternal({\n   missingSlots?: Set<string>\n   preloadCallbacks: PreloadCallbacks\n   authInterrupts: boolean\n-  StreamingMetadata: React.ComponentType<{}> | null\n+  StreamingMetadata: React.ComponentType | null\n   StreamingMetadataOutlet: React.ComponentType | null\n }): Promise<CacheNodeSeedData> {\n   const {"
        },
        {
            "sha": "1c62dca163b13d25f04131cee858fe502debe2d0",
            "filename": "packages/next/src/server/app-render/metadata-insertion/create-server-inserted-metadata.tsx",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fcreate-server-inserted-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fcreate-server-inserted-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fcreate-server-inserted-metadata.tsx?ref=8941f8a135934aab74797f8639958b38a27f2839",
            "patch": "@@ -6,7 +6,15 @@ import {\n } from '../../../shared/lib/server-inserted-metadata.shared-runtime'\n import { renderToString } from '../render-to-string'\n \n-export function createServerInsertedMetadata() {\n+/**\n+ * For chromium based browsers (Chrome, Edge, etc.) and Safari,\n+ * icons need to stay under <head> to be picked up by the browser.\n+ *\n+ */\n+const REINSERT_ICON_SCRIPT = `\\\n+document.querySelectorAll('body link[rel=\"icon\"], body link[rel=\"apple-touch-icon\"]').forEach(el => document.head.appendChild(el))`\n+\n+export function createServerInsertedMetadata(nonce: string | undefined) {\n   let metadataResolver: MetadataResolver | null = null\n   let metadataToFlush: React.ReactNode = null\n   const setMetadataResolver = (resolver: MetadataResolver): void => {\n@@ -34,7 +42,12 @@ export function createServerInsertedMetadata() {\n       metadataToFlush = metadataResolver()\n       const html = await renderToString({\n         renderToReadableStream,\n-        element: <>{metadataToFlush}</>,\n+        element: (\n+          <>\n+            {metadataToFlush}\n+            <script nonce={nonce}>{REINSERT_ICON_SCRIPT}</script>\n+          </>\n+        ),\n       })\n \n       return html"
        },
        {
            "sha": "57adae0c5c5bb6f0fd634a521bae47a1c0bad589",
            "filename": "test/e2e/app-dir/metadata-icons/app/custom-icon/page.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fpage.tsx?ref=8941f8a135934aab74797f8639958b38a27f2839",
            "patch": "@@ -0,0 +1,25 @@\n+import { Metadata } from 'next'\n+import Link from 'next/link'\n+import { connection } from 'next/server'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <Link id=\"custom-icon-sub-link\" href=\"/custom-icon/sub\">\n+        Go to another page with custom icon\n+      </Link>\n+    </>\n+  )\n+}\n+\n+export async function generateMetadata(): Promise<Metadata> {\n+  await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 300))\n+\n+  return {\n+    icons: {\n+      // add version query to avoid caching on client side with multiple navs\n+      icon: `/heart.png?v=${Math.round(Math.random() * 1000)}`,\n+    },\n+  }\n+}"
        },
        {
            "sha": "cfbc9e53b754d1ab6c1a5e238e862c7b061a6fb5",
            "filename": "test/e2e/app-dir/metadata-icons/app/custom-icon/sub/page.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fsub%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fsub%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fsub%2Fpage.tsx?ref=8941f8a135934aab74797f8639958b38a27f2839",
            "patch": "@@ -0,0 +1,25 @@\n+import { type Metadata } from 'next'\n+import Link from 'next/link'\n+import { connection } from 'next/server'\n+\n+export async function generateMetadata(): Promise<Metadata> {\n+  await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 300))\n+\n+  return {\n+    icons: {\n+      // add version query to avoid caching on client side with multiple navs\n+      icon: `/star.png?v=${Math.round(Math.random() * 1000)}`,\n+    },\n+  }\n+}\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <Link id=\"custom-icon-link\" href=\"/custom-icon\">\n+        Back to previous page with custom icon\n+      </Link>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "b8049952a6c0d211bdef2ba68c68642e8eed9131",
            "filename": "test/e2e/app-dir/metadata-icons/metadata-icons.test.ts",
            "status": "modified",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts?ref=8941f8a135934aab74797f8639958b38a27f2839",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n \n describe('app-dir - metadata-icons', () => {\n   const { next } = nextTestSetup({\n@@ -28,4 +29,66 @@ describe('app-dir - metadata-icons', () => {\n       '/shortcut-icon-nested.png'\n     )\n   })\n+\n+  it('should re-insert the body icons into the head', async () => {\n+    const browser = await next.browser('/custom-icon')\n+\n+    await retry(async () => {\n+      const iconsInBody = await browser.elementsByCss('body link[rel=\"icon\"]')\n+      const iconsInHead = await browser.elementsByCss('head link[rel=\"icon\"]')\n+\n+      // moved to head\n+      expect(iconsInBody.length).toBe(0)\n+      // re-inserted favicon.ico + /heart.png\n+      expect(iconsInHead.length).toBe(2)\n+    })\n+  })\n+\n+  it('should re-insert the apple icons into the head after navigation', async () => {\n+    const browser = await next.browser('/custom-icon')\n+    await browser.elementByCss('#custom-icon-sub-link').click()\n+\n+    await retry(async () => {\n+      const url = await browser.url()\n+      expect(url).toMatch(/\\/custom-icon\\/sub$/)\n+    })\n+\n+    await retry(async () => {\n+      const iconsInHead = await browser.elementsByCss('head link[rel=\"icon\"]')\n+      let iconUrls = await Promise.all(\n+        iconsInHead.map(\n+          async (el) => (await el.getAttribute('href')).split('?')[0]\n+        )\n+      )\n+      // Pick last 2 icons\n+      // In non-headless mode, the icons are deduped;\n+      // In headless mode, the icons are not deduped\n+      expect(iconUrls.length === 4 ? iconUrls.slice(2) : iconUrls).toEqual([\n+        '/favicon.ico',\n+        '/star.png',\n+      ])\n+    })\n+\n+    // navigate back\n+    await browser.elementByCss('#custom-icon-link').click()\n+    await retry(async () => {\n+      const url = await browser.url()\n+      expect(url).toMatch(/\\/custom-icon$/)\n+    })\n+\n+    await retry(async () => {\n+      const icons = await browser.elementsByCss('head link[rel=\"icon\"]')\n+      const iconUrls = await Promise.all(\n+        icons.map(async (el) => (await el.getAttribute('href')).split('?')[0])\n+      )\n+\n+      // Pick last 2 icons\n+      // In non-headless mode, the icons are deduped;\n+      // In headless mode, the icons are not deduped\n+      expect(iconUrls.length === 4 ? iconUrls.slice(2) : iconUrls).toEqual([\n+        '/favicon.ico',\n+        '/heart.png',\n+      ])\n+    })\n+  })\n })"
        },
        {
            "sha": "b998556bdac2912d0ae5eaad84afccc677eb4313",
            "filename": "test/e2e/app-dir/metadata-icons/public/heart.png",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fpublic%2Fheart.png",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fpublic%2Fheart.png",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fpublic%2Fheart.png?ref=8941f8a135934aab74797f8639958b38a27f2839"
        },
        {
            "sha": "0c4dddc7a61d30cf10bf054517f25737c2ac7bd8",
            "filename": "test/e2e/app-dir/metadata-icons/public/star.png",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fpublic%2Fstar.png",
            "raw_url": "https://github.com/vercel/next.js/raw/8941f8a135934aab74797f8639958b38a27f2839/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fpublic%2Fstar.png",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fpublic%2Fstar.png?ref=8941f8a135934aab74797f8639958b38a27f2839"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 138,
        "deletions": 12
    }
}