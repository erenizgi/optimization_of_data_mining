{
    "author": "unstubbable",
    "message": "Avoid duplicate WebSocket connection for global error pages (#82788)\n\nWhen we're rendering a global error page (something with `<html\nid=\"__next_error__\">`), we are wrapping the root element in a component\nthat renders a top-level dev overlay to show the global error. The\nfunction that's wrapping this element was previously creating an\nunnecessary second WebSocket connection to handle the case where the\nerror is removed by editing a server component, and the page is\nsubsequently reloaded. However, this can be handled by the first\nWebSocket connection that's created in the root element just fine, we\njust need to ensure that the reload is also triggered when\n`document.documentElement.id` is `'__next_error__'`, which is the same\n[condition we use for rendering the\nwrapper](https://github.com/vercel/next.js/blob/a0b7a725a1b424473940fe3111842ae92d918a25/packages/next/src/client/app-index.tsx#L275).\n\nThis change is covered by existing tests, e.g.\n`test/development/app-dir/missing-required-html-tags/index.test.ts`.",
    "sha": "64b69ff0a6faafc6859db4ce84fe48bf37e50018",
    "files": [
        {
            "sha": "dc5978d271b428ae9022b7c1f19ed7f66ee5eb26",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/64b69ff0a6faafc6859db4ce84fe48bf37e50018/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b69ff0a6faafc6859db4ce84fe48bf37e50018/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=64b69ff0a6faafc6859db4ce84fe48bf37e50018",
            "patch": "@@ -276,11 +276,13 @@ export function hydrate(\n     let element = reactEl\n     // Server rendering failed, fall back to client-side rendering\n     if (process.env.NODE_ENV !== 'production') {\n-      const { createRootLevelDevOverlayElement } =\n+      const { RootLevelDevOverlayElement } =\n         require('../next-devtools/userspace/app/client-entry') as typeof import('../next-devtools/userspace/app/client-entry')\n \n       // Note this won't cause hydration mismatch because we are doing CSR w/o hydration\n-      element = createRootLevelDevOverlayElement(element)\n+      element = (\n+        <RootLevelDevOverlayElement>{element}</RootLevelDevOverlayElement>\n+      )\n     }\n \n     ReactDOMClient.createRoot(appElement, reactRootOptions).render(element)"
        },
        {
            "sha": "5156f935e48f3629fe308b1caa4e48a0574730ff",
            "filename": "packages/next/src/client/dev/hot-reloader/app/hot-reloader-app.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/64b69ff0a6faafc6859db4ce84fe48bf37e50018/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b69ff0a6faafc6859db4ce84fe48bf37e50018/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx?ref=64b69ff0a6faafc6859db4ce84fe48bf37e50018",
            "patch": "@@ -391,7 +391,10 @@ function processMessage(\n       // server with any subsequent requests.\n       document.cookie = `${NEXT_HMR_REFRESH_HASH_COOKIE}=${obj.hash};path=/`\n \n-      if (RuntimeErrorHandler.hadRuntimeError) {\n+      if (\n+        RuntimeErrorHandler.hadRuntimeError ||\n+        document.documentElement.id === '__next_error__'\n+      ) {\n         if (reloading) return\n         reloading = true\n         return window.location.reload()"
        },
        {
            "sha": "75d0356ebcfa04ac94fd9d617a24038c136d4175",
            "filename": "packages/next/src/next-devtools/userspace/app/client-entry.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 27,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/64b69ff0a6faafc6859db4ce84fe48bf37e50018/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fclient-entry.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b69ff0a6faafc6859db4ce84fe48bf37e50018/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fclient-entry.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Fclient-entry.tsx?ref=64b69ff0a6faafc6859db4ce84fe48bf37e50018",
            "patch": "@@ -1,36 +1,17 @@\n import React from 'react'\n-import { getSocketUrl } from '../../../client/dev/hot-reloader/get-socket-url'\n-import { HMR_ACTIONS_SENT_TO_BROWSER } from '../../../server/dev/hot-reloader-types'\n import DefaultGlobalError from '../../../client/components/builtin/global-error'\n import { AppDevOverlayErrorBoundary } from './app-dev-overlay-error-boundary'\n \n-// if an error is thrown while rendering an RSC stream, this will catch it in dev\n-// and show the error overlay\n-export function createRootLevelDevOverlayElement(reactEl: React.ReactElement) {\n-  const socketUrl = getSocketUrl(process.env.__NEXT_ASSET_PREFIX || '')\n-  const socket = new window.WebSocket(`${socketUrl}/_next/webpack-hmr`)\n-\n-  // add minimal \"hot reload\" support for RSC errors\n-  const handler = (event: MessageEvent) => {\n-    let obj\n-    try {\n-      obj = JSON.parse(event.data)\n-    } catch {}\n-\n-    if (!obj || !('action' in obj)) {\n-      return\n-    }\n-\n-    if (obj.action === HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES) {\n-      window.location.reload()\n-    }\n-  }\n-\n-  socket.addEventListener('message', handler)\n-\n+// If an error is thrown while rendering an RSC stream, this will catch it in\n+// dev and show the error overlay.\n+export function RootLevelDevOverlayElement({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n   return (\n     <AppDevOverlayErrorBoundary globalError={[DefaultGlobalError, null]}>\n-      {reactEl}\n+      {children}\n     </AppDevOverlayErrorBoundary>\n   )\n }"
        },
        {
            "sha": "0724a0c0295bc8e66d01924e5d8ce30f9abc487d",
            "filename": "packages/next/src/server/stream-utils/node-web-streams-helper.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/64b69ff0a6faafc6859db4ce84fe48bf37e50018/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b69ff0a6faafc6859db4ce84fe48bf37e50018/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts?ref=64b69ff0a6faafc6859db4ce84fe48bf37e50018",
            "patch": "@@ -636,7 +636,7 @@ export function createRootLayoutValidatorStream(): TransformStream<\n                 .map((c) => `<${c}>`)\n                 .join(\n                   missingTags.length > 1 ? ' and ' : ''\n-                )} tags in the root layout.\\nRead more at https://nextjs.org/docs/messages/missing-root-layout-tags\"\"\n+                )} tags in the root layout.\\nRead more at https://nextjs.org/docs/messages/missing-root-layout-tags\"\n               data-next-error-digest=\"${MISSING_ROOT_TAGS_ERROR}\"\n               data-next-error-stack=\"\"\n             ></template>"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 17,
        "deletions": 31
    }
}