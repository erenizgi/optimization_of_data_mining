{
    "author": "devjiwonchoi",
    "message": "Put native TS resolver for next config under `--experimental-next-config-strip-types` flag (#84675)\n\nUsing Node.js native TS resolution is great. However, enabling by\ndefault can be frustrating for the users as it has restrictions, such as\nrequiring a file extension for imports, and does not read tsconfig.json\n(no import alias).\n\nIt also emits a warning when using `next.config.ts` on a CommonJS\nproject, which is the majority of the apps:\n\n```\n(node:68710) [MODULE_TYPELESS_PACKAGE_JSON] Warning: Module type of file:///.../next.config.ts is not specified and it doesn't parse as CommonJS.\nReparsing as ES module because module syntax was detected. This incurs a performance overhead.\nTo eliminate this warning, add \"type\": \"module\" to /.../package.json.\n(Use `node --trace-warnings ...` to show where the warning was created)\n```\n\nTherefore, put this under an `--experimental-next-config-strip-types`\nflag for now.",
    "sha": "ec560204f97532bae5daa5ef9a907fe2062fc415",
    "files": [
        {
            "sha": "dce688d8145a24590c00cc5978ece5952fe51c43",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ec560204f97532bae5daa5ef9a907fe2062fc415/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/ec560204f97532bae5daa5ef9a907fe2062fc415/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=ec560204f97532bae5daa5ef9a907fe2062fc415",
            "patch": "@@ -562,6 +562,7 @@ jobs:\n     with:\n       nodeVersion: ${{ matrix.node }}\n       afterBuild: |\n+        export __NEXT_NODE_NATIVE_TS_LOADER_ENABLED=true\n         NEXT_TEST_MODE=dev NODE_OPTIONS=--experimental-transform-types node run-tests.js test/e2e/app-dir/next-config-ts-native-ts/**/*.test.ts test/e2e/app-dir/next-config-ts-native-mts/**/*.test.ts\n       stepName: 'test-next-config-ts-native-ts-dev-${{ matrix.node }}'\n \n@@ -582,6 +583,7 @@ jobs:\n     with:\n       nodeVersion: ${{ matrix.node }}\n       afterBuild: |\n+        export __NEXT_NODE_NATIVE_TS_LOADER_ENABLED=true\n         NEXT_TEST_MODE=start NODE_OPTIONS=--experimental-transform-types node run-tests.js test/e2e/app-dir/next-config-ts-native-ts/**/*.test.ts test/e2e/app-dir/next-config-ts-native-mts/**/*.test.ts\n       stepName: 'test-next-config-ts-native-ts-prod-${{ matrix.node }}'\n "
        },
        {
            "sha": "227372e33f53b21fcbae484dd976de815389c269",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 6,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=ec560204f97532bae5daa5ef9a907fe2062fc415",
            "patch": "@@ -150,13 +150,20 @@ program\n     '--experimental-upload-trace, <traceUrl>',\n     'Reports a subset of the debugging trace to a remote HTTP URL. Includes sensitive data.'\n   )\n-  .action((directory: string, options: NextBuildOptions) =>\n+  .option(\n+    '--experimental-next-config-strip-types',\n+    'Use Node.js native TypeScript resolution for next.config.(ts|mts)'\n+  )\n+  .action((directory: string, options: NextBuildOptions) => {\n+    if (options.experimentalNextConfigStripTypes) {\n+      process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'true'\n+    }\n     // ensure process exits after build completes so open handles/connections\n     // don't cause process to hang\n-    import('../cli/next-build.js').then((mod) =>\n+    return import('../cli/next-build.js').then((mod) =>\n       mod.nextBuild(options, directory).then(() => process.exit(0))\n     )\n-  )\n+  })\n   .usage('[directory] [options]')\n \n program\n@@ -208,8 +215,15 @@ program\n     '--experimental-upload-trace, <traceUrl>',\n     'Reports a subset of the debugging trace to a remote HTTP URL. Includes sensitive data.'\n   )\n+  .option(\n+    '--experimental-next-config-strip-types',\n+    'Use Node.js native TypeScript resolution for next.config.(ts|mts)'\n+  )\n   .action(\n     (directory: string, options: NextDevOptions, { _optionValueSources }) => {\n+      if (options.experimentalNextConfigStripTypes) {\n+        process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'true'\n+      }\n       const portSource = _optionValueSources.port\n       import('../cli/next-dev.js').then((mod) =>\n         mod.nextDev(options, portSource, directory)\n@@ -267,11 +281,18 @@ program\n       'Specify the maximum amount of milliseconds to wait before closing inactive connections.'\n     ).argParser(parseValidPositiveInteger)\n   )\n-  .action((directory: string, options: NextStartOptions) =>\n-    import('../cli/next-start.js').then((mod) =>\n+  .option(\n+    '--experimental-next-config-strip-types',\n+    'Use Node.js native TypeScript resolution for next.config.(ts|mts)'\n+  )\n+  .action((directory: string, options: NextStartOptions) => {\n+    if (options.experimentalNextConfigStripTypes) {\n+      process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'true'\n+    }\n+    return import('../cli/next-start.js').then((mod) =>\n       mod.nextStart(options, directory)\n     )\n-  )\n+  })\n   .usage('[directory] [options]')\n \n program"
        },
        {
            "sha": "0fefd8c8551e1d994578f274c2d7f827d30b70bc",
            "filename": "packages/next/src/build/next-config-ts/transpile-config.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts?ref=ec560204f97532bae5daa5ef9a907fe2062fc415",
            "patch": "@@ -116,7 +116,7 @@ export async function transpileConfig({\n }) {\n   try {\n     // envs are passed to the workers and preserve the flag\n-    if (process.env.__NEXT_NODE_NATIVE_TS_LOADER_FAILED !== '1') {\n+    if (process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED === 'true') {\n       try {\n         // Node.js v22.10.0+\n         // Value is 'strip' or 'transform' based on how the feature is enabled.\n@@ -139,7 +139,7 @@ export async function transpileConfig({\n         }\n \n         // Feature is not enabled, fallback to legacy resolution for current session.\n-        process.env.__NEXT_NODE_NATIVE_TS_LOADER_FAILED = '1'\n+        process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'false'\n       } catch (cause) {\n         warnOnce(\n           `Failed to import \"${configFileName}\" using Node.js native TypeScript resolution.` +\n@@ -148,7 +148,7 @@ export async function transpileConfig({\n           { cause }\n         )\n         // Once failed, fallback to legacy resolution for current session.\n-        process.env.__NEXT_NODE_NATIVE_TS_LOADER_FAILED = '1'\n+        process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'false'\n       }\n     }\n "
        },
        {
            "sha": "27c92c8e0fd1b998c1065114d1777d55900ccf85",
            "filename": "packages/next/src/cli/next-build.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts?ref=ec560204f97532bae5daa5ef9a907fe2062fc415",
            "patch": "@@ -25,6 +25,7 @@ export type NextBuildOptions = {\n   experimentalTurbo?: boolean\n   experimentalBuildMode: 'default' | 'compile' | 'generate' | 'generate-env'\n   experimentalUploadTrace?: string\n+  experimentalNextConfigStripTypes?: boolean\n }\n \n const nextBuild = (options: NextBuildOptions, directory?: string) => {"
        },
        {
            "sha": "31b415c7580e405a9b6ce1985a1083e8d3e0c0b7",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=ec560204f97532bae5daa5ef9a907fe2062fc415",
            "patch": "@@ -56,6 +56,7 @@ export type NextDevOptions = {\n   experimentalHttpsCert?: string\n   experimentalHttpsCa?: string\n   experimentalUploadTrace?: string\n+  experimentalNextConfigStripTypes?: boolean\n }\n \n type PortSource = 'cli' | 'default' | 'env'"
        },
        {
            "sha": "d4f6c9c374617ee73d9a95bc58f0bf1ef9b740f1",
            "filename": "packages/next/src/cli/next-start.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fcli%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec560204f97532bae5daa5ef9a907fe2062fc415/packages%2Fnext%2Fsrc%2Fcli%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-start.ts?ref=ec560204f97532bae5daa5ef9a907fe2062fc415",
            "patch": "@@ -13,6 +13,7 @@ export type NextStartOptions = {\n   port: number\n   hostname?: string\n   keepAliveTimeout?: number\n+  experimentalNextConfigStripTypes?: boolean\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 35,
        "deletions": 9
    }
}