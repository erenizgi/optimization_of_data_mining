{
    "author": "gaojude",
    "message": "Fix validateRSCRequestHeaders incorrect redirect (#82119)\n\nFound during dogfooding on Vercel that sometimes the RSC validation\nfails incorrectly. The root cause was that headers like\n`Next-Router-Prefetch` were absent from the header and transferred to\nrequest meta. Eventually we should improve how we retrieve these fields\nconsistently.",
    "sha": "5c25087d57a919f3eb363f21cf4235918fd76167",
    "files": [
        {
            "sha": "855e2795607eaa073f126ef70902b3e6a10188bc",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/5c25087d57a919f3eb363f21cf4235918fd76167/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c25087d57a919f3eb363f21cf4235918fd76167/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=5c25087d57a919f3eb363f21cf4235918fd76167",
            "patch": "@@ -2013,9 +2013,18 @@ export default abstract class Server<\n       isRSCRequest\n     ) {\n       const headers = req.headers\n+\n+      const isPrefetchRSCRequest =\n+        headers[NEXT_ROUTER_PREFETCH_HEADER.toLowerCase()] ||\n+        getRequestMeta(req, 'isPrefetchRSCRequest')\n+\n+      const segmentPrefetchRSCRequest =\n+        headers[NEXT_ROUTER_SEGMENT_PREFETCH_HEADER.toLowerCase()] ||\n+        getRequestMeta(req, 'segmentPrefetchRSCRequest')\n+\n       const expectedHash = computeCacheBustingSearchParam(\n-        headers[NEXT_ROUTER_PREFETCH_HEADER.toLowerCase()],\n-        headers[NEXT_ROUTER_SEGMENT_PREFETCH_HEADER.toLowerCase()],\n+        isPrefetchRSCRequest ? '1' : '0',\n+        segmentPrefetchRSCRequest,\n         headers[NEXT_ROUTER_STATE_TREE_HEADER.toLowerCase()],\n         headers[NEXT_URL.toLowerCase()]\n       )"
        },
        {
            "sha": "c08f7644e9b701e4a668f3487726d21ceb9bcdfa",
            "filename": "packages/next/src/shared/lib/router/utils/cache-busting-search-param.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5c25087d57a919f3eb363f21cf4235918fd76167/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c25087d57a919f3eb363f21cf4235918fd76167/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fcache-busting-search-param.ts?ref=5c25087d57a919f3eb363f21cf4235918fd76167",
            "patch": "@@ -1,13 +1,13 @@\n import { hexHash } from '../../hash'\n \n export function computeCacheBustingSearchParam(\n-  prefetchHeader: string | string[] | undefined,\n+  prefetchHeader: '1' | '0' | undefined,\n   segmentPrefetchHeader: string | string[] | undefined,\n   stateTreeHeader: string | string[] | undefined,\n   nextUrlHeader: string | string[] | undefined\n ): string {\n   if (\n-    prefetchHeader === undefined &&\n+    (prefetchHeader === undefined || prefetchHeader === '0') &&\n     segmentPrefetchHeader === undefined &&\n     stateTreeHeader === undefined &&\n     nextUrlHeader === undefined"
        },
        {
            "sha": "b2918daf693c5308565e8ad95146530952b7f82e",
            "filename": "test/e2e/app-dir/app-prefetch/prefetching.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c25087d57a919f3eb363f21cf4235918fd76167/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c25087d57a919f3eb363f21cf4235918fd76167/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.test.ts?ref=5c25087d57a919f3eb363f21cf4235918fd76167",
            "patch": "@@ -305,7 +305,7 @@ describe('app dir - prefetching', () => {\n \n     const url = new URL('/prefetch-auto/justputit', 'http://localhost')\n     const cacheBustingParam = computeCacheBustingSearchParam(\n-      headers['Next-Router-Prefetch'],\n+      headers['Next-Router-Prefetch'] ? '1' : '0',\n       undefined,\n       headers['Next-Router-State-Tree'],\n       headers['Next-Url']"
        },
        {
            "sha": "1dc725868e3279aa613242b53c961233de926721",
            "filename": "test/e2e/app-dir/ppr-full/ppr-full.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c25087d57a919f3eb363f21cf4235918fd76167/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c25087d57a919f3eb363f21cf4235918fd76167/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-full%2Fppr-full.test.ts?ref=5c25087d57a919f3eb363f21cf4235918fd76167",
            "patch": "@@ -52,7 +52,7 @@ const addCacheBustingSearchParam = (\n   headers: Record<string, string | string[] | undefined>\n ) => {\n   const cacheKey = computeCacheBustingSearchParam(\n-    headers['Next-Router-Prefetch'],\n+    headers['Next-Router-Prefetch'] ? '1' : '0',\n     headers['Next-Router-Segment-Prefetch'],\n     headers['Next-Router-State-Tree'],\n     headers['Next-URL']"
        },
        {
            "sha": "9e0028b7386148d88cd5dcf7dba5ad37693ac42d",
            "filename": "test/e2e/app-dir/rewrite-headers/rewrite-headers.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c25087d57a919f3eb363f21cf4235918fd76167/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c25087d57a919f3eb363f21cf4235918fd76167/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts?ref=5c25087d57a919f3eb363f21cf4235918fd76167",
            "patch": "@@ -418,7 +418,7 @@ describe('rewrite-headers', () => {\n         // Add cache busting param for RSC requests\n         if (headers.RSC === '1') {\n           const cacheBustingParam = computeCacheBustingSearchParam(\n-            headers['Next-Router-Prefetch'],\n+            headers['Next-Router-Prefetch'] ? '1' : '0',\n             undefined,\n             headers['Next-Router-State-Tree'],\n             undefined"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 16,
        "deletions": 7
    }
}