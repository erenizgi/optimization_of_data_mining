{
    "author": "eps1lon",
    "message": "[test] Use new Redbox matchers in pages/ ReactRefreshLogBox (#76391)",
    "sha": "58d328a0cf9f722a49e4c85386d0b806c086c21f",
    "files": [
        {
            "sha": "33fcebfb56a6cb631799e6673cdef3c3ed43fb25",
            "filename": "test/development/acceptance/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 643,
            "deletions": 254,
            "changes": 897,
            "blob_url": "https://github.com/vercel/next.js/blob/58d328a0cf9f722a49e4c85386d0b806c086c21f/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/58d328a0cf9f722a49e4c85386d0b806c086c21f/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts?ref=58d328a0cf9f722a49e4c85386d0b806c086c21f",
            "patch": "@@ -2,24 +2,23 @@\n import { createSandbox } from 'development-sandbox'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n import {\n-  describeVariants as describe,\n   getStackFramesContent,\n   toggleCollapseCallStackFrames,\n-  hasRedboxCallStack,\n } from 'next-test-utils'\n import path from 'path'\n import { outdent } from 'outdent'\n \n-describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n-  const isTurbopack = mode === 'turbo'\n-  const { next } = nextTestSetup({\n+const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n+\n+describe('ReactRefreshLogBox', () => {\n+  const { isTurbopack, next } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n     skipStart: true,\n   })\n \n   test('should strip whitespace correctly with newline', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'index.js',\n@@ -42,15 +41,48 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n     )\n     await session.evaluate(() => document.querySelector('a').click())\n \n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxSource()).toMatchSnapshot()\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: idk\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (8:27) @ onClick\n+       >  8 |                     throw new Error('idk')\n+            |                           ^\",\n+         \"stack\": [\n+           \"onClick index.js (8:27)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: idk\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (8:27) @ onClick\n+       >  8 |                     throw new Error('idk')\n+            |                           ^\",\n+         \"stack\": [\n+           \"onClick index.js (8:27)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    }\n   })\n \n   // https://github.com/pmmmwh/react-refresh-webpack-plugin/pull/3#issuecomment-554137807\n   test('module init error not shown', async () => {\n     // Start here:\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     // We start here.\n     await session.patch(\n@@ -86,14 +118,107 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n       `\n     )\n \n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxSource()).toMatchSnapshot()\n+    if (isReact18) {\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: no\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"index.js (3:7) @ [project]/index.js [ssr] (ecmascript)\n+         > 3 | throw new Error('no')\n+             |       ^\",\n+           \"stack\": [\n+             \"[project]/index.js [ssr] (ecmascript) index.js (3:7)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: no\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"index.js (3:7) @ eval\n+         > 3 | throw new Error('no')\n+             |       ^\",\n+           \"stack\": [\n+             \"eval index.js (3:7)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"eval ./pages/index.js\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+           ],\n+         }\n+        `)\n+      }\n+    } else {\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: no\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"index.js (3:7) @ [project]/index.js [ssr] (ecmascript)\n+         > 3 | throw new Error('no')\n+             |       ^\",\n+           \"stack\": [\n+             \"[project]/index.js [ssr] (ecmascript) index.js (3:7)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 1,\n+           \"description\": \"Error: no\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"index.js (3:7) @ eval\n+         > 3 | throw new Error('no')\n+             |       ^\",\n+           \"stack\": [\n+             \"eval index.js (3:7)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"eval ./pages/index.js\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+           ],\n+         }\n+        `)\n+      }\n+    }\n   })\n \n   // https://github.com/pmmmwh/react-refresh-webpack-plugin/pull/3#issuecomment-554152127\n   test('boundaries', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.write(\n       'FunctionDefault.js',\n@@ -146,19 +271,51 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n       `export default function FunctionDefault() { throw new Error('no'); }`\n     )\n \n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxSource()).toMatchSnapshot()\n-    expect(\n-      await session.evaluate(() => document.querySelector('h2').textContent)\n-    ).toBe('error')\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 2,\n+         \"description\": \"Error: no\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"FunctionDefault.js (1:51) @ FunctionDefault\n+       > 1 | export default function FunctionDefault() { throw new Error('no'); }\n+           |                                                   ^\",\n+         \"stack\": [\n+           \"FunctionDefault FunctionDefault.js (1:51)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: no\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"FunctionDefault.js (1:51) @ FunctionDefault\n+       > 1 | export default function FunctionDefault() { throw new Error('no'); }\n+           |                                                   ^\",\n+         \"stack\": [\n+           \"FunctionDefault FunctionDefault.js (1:51)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n+         ],\n+       }\n+      `)\n+    }\n   })\n \n   // TODO: investigate why this fails when running outside of the Next.js\n   // monorepo e.g. fails when using pnpm create next-app\n   // https://github.com/vercel/next.js/pull/23203\n   test.skip('internal package errors', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     // Make a react build-time error.\n     await session.patch(\n@@ -169,18 +326,16 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n         }`\n     )\n \n-    await session.assertHasRedbox()\n-    // We internally only check the script path, not including the line number\n-    // and error message because the error comes from an external library.\n-    // This test ensures that the errored script path is correctly resolved.\n-    expect(await session.getRedboxSource()).toContain(\n-      `../../../../packages/next/dist/pages/_document.js`\n-    )\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox()\n+    } else {\n+      await expect(browser).toDisplayRedbox()\n+    }\n   })\n \n   test('unterminated JSX', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'index.js',\n@@ -210,52 +365,58 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n       `\n     )\n \n-    await session.assertHasRedbox()\n-    const source = next.normalizeTestDirContent(await session.getRedboxSource())\n     if (process.env.TURBOPACK) {\n-      expect(source).toMatchInlineSnapshot(`\n-       \"./index.js (7:1)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js (7:1)\n        Parsing ecmascript source code failed\n-         5 |     div\n-         6 |   )\n        > 7 | }\n-           | ^\n-\n-       Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\"\n+           | ^\",\n+         \"stack\": [],\n+       }\n       `)\n     } else {\n-      expect(source).toMatchInlineSnapshot(`\n-        \"./index.js\n-        Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n-           ,-[7:1]\n-         4 |       <p>lol</p>\n-         5 |     div\n-         6 |   )\n-         7 | }\n-           : ^\n-           \\`----\n-          x Unexpected eof\n-           ,-[7:1]\n-         4 |       <p>lol</p>\n-         5 |     div\n-         6 |   )\n-         7 | }\n-           \\`----\n-\n-        Caused by:\n-            Syntax Error\n-\n-        Import trace for requested module:\n-        ./index.js\n-        ./pages/index.js\"\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+       Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+          ,-[7:1]\n+        4 |       <p>lol</p>\n+        5 |     div\n+        6 |   )\n+        7 | }\n+          : ^\n+          \\`----\n+         x Unexpected eof\n+          ,-[7:1]\n+        4 |       <p>lol</p>\n+        5 |     div\n+        6 |   )\n+        7 | }\n+          \\`----\n+       Caused by:\n+           Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./pages/index.js\",\n+         \"stack\": [],\n+       }\n       `)\n     }\n   })\n \n   // Module trace is only available with webpack 5\n   test('conversion to class component (1)', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.write(\n       'Child.js',\n@@ -298,8 +459,43 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n       `\n     )\n \n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxSource()).toMatchSnapshot()\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 2,\n+         \"description\": \"Error: \",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"Child.js (4:11) @ ClickCount.render\n+       > 4 |     throw new Error()\n+           |           ^\",\n+         \"stack\": [\n+           \"ClickCount.render Child.js (4:11)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: \",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"Child.js (4:11) @ ClickCount.render\n+       > 4 |     throw new Error()\n+           |           ^\",\n+         \"stack\": [\n+           \"ClickCount.render Child.js (4:11)\",\n+           \"Set.forEach <anonymous> (0:0)\",\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n+         ],\n+       }\n+      `)\n+    }\n \n     await session.patch(\n       'Child.js',\n@@ -321,7 +517,7 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n \n   test('css syntax errors', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.write('index.module.css', `.button {}`)\n     await session.patch(\n@@ -342,36 +538,74 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n \n     // Syntax error\n     await session.patch('index.module.css', `.button`)\n-    await session.assertHasRedbox()\n-    const source = await session.getRedboxSource()\n-    expect(source).toMatch(\n-      process.env.TURBOPACK\n-        ? './index.module.css (1:9)'\n-        : './index.module.css (1:1)'\n-    )\n-    if (!process.env.TURBOPACK) {\n-      expect(source).toMatch('Syntax error: ')\n-      expect(source).toMatch('Unknown word')\n-    }\n-    if (process.env.TURBOPACK) {\n-      expect(source).toMatch('> 1 | .button')\n-      expect(source).toMatch('    |        ')\n+\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing css source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.module.css (1:9)\n+       Parsing css source code failed\n+       > 1 | .button\n+           |         ^\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n-      expect(source).toMatch('> 1 | .button')\n-      expect(source).toMatch('    | ^')\n+      await expect({ browser, next }).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Syntax error: <FIXME-project-root>/index.module.css Unknown word\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.module.css (1:1)\n+       Syntax error: <FIXME-project-root>/index.module.css Unknown word\n+       > 1 | .button\n+           | ^\",\n+         \"stack\": [],\n+       }\n+      `)\n     }\n \n     // Checks for selectors that can't be prefixed.\n     // Selector \"button\" is not pure (pure selectors must contain at least one local class or id)\n     await session.patch('index.module.css', `button {}`)\n-    await session.assertHasRedbox()\n-    const source2 = await session.getRedboxSource()\n-    expect(source2).toMatchSnapshot()\n+\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing css source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.module.css\n+       Parsing css source code failed\n+       Selector is not pure (pure selectors must contain at least one local class or id), (lightningcss, Selector(button, specificity = 0x1))\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Syntax error: Selector \"button\" is not pure (pure selectors must contain at least one local class or id)\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.module.css (1:1)\n+       Syntax error: Selector \"button\" is not pure (pure selectors must contain at least one local class or id)\n+       > 1 | button {}\n+           | ^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n   })\n \n   test('logbox: anchors links in error messages', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'index.js',\n@@ -393,31 +627,42 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n \n     await session.assertNoRedbox()\n     await session.evaluate(() => document.querySelector('button').click())\n-    await session.assertHasRedbox()\n \n-    const header = await session.getRedboxDescription()\n-    expect(header).toMatchSnapshot()\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          document\n-            .querySelector('body > nextjs-portal')\n-            .shadowRoot.querySelectorAll('#nextjs__container_errors_desc a')\n-            .length\n-      )\n-    ).toBe(1)\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          (\n-            document\n-              .querySelector('body > nextjs-portal')\n-              .shadowRoot.querySelector(\n-                '#nextjs__container_errors_desc a:nth-of-type(1)'\n-              ) as any\n-          ).href\n-      )\n-    ).toMatchSnapshot()\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: end https://nextjs.org\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('end https://nextjs.org')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: end https://nextjs.org\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('end https://nextjs.org')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    }\n \n     await session.patch(\n       'index.js',\n@@ -439,31 +684,42 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n \n     await session.assertNoRedbox()\n     await session.evaluate(() => document.querySelector('button').click())\n-    await session.assertHasRedbox()\n \n-    const header2 = await session.getRedboxDescription()\n-    expect(header2).toMatchSnapshot()\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          document\n-            .querySelector('body > nextjs-portal')\n-            .shadowRoot.querySelectorAll('#nextjs__container_errors_desc a')\n-            .length\n-      )\n-    ).toBe(1)\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          (\n-            document\n-              .querySelector('body > nextjs-portal')\n-              .shadowRoot.querySelector(\n-                '#nextjs__container_errors_desc a:nth-of-type(1)'\n-              ) as any\n-          ).href\n-      )\n-    ).toMatchSnapshot()\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: https://nextjs.org start\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('https://nextjs.org start')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: https://nextjs.org start\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('https://nextjs.org start')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    }\n \n     await session.patch(\n       'index.js',\n@@ -485,31 +741,42 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n \n     await session.assertNoRedbox()\n     await session.evaluate(() => document.querySelector('button').click())\n-    await session.assertHasRedbox()\n \n-    const header3 = await session.getRedboxDescription()\n-    expect(header3).toMatchSnapshot()\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          document\n-            .querySelector('body > nextjs-portal')\n-            .shadowRoot.querySelectorAll('#nextjs__container_errors_desc a')\n-            .length\n-      )\n-    ).toBe(1)\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          (\n-            document\n-              .querySelector('body > nextjs-portal')\n-              .shadowRoot.querySelector(\n-                '#nextjs__container_errors_desc a:nth-of-type(1)'\n-              ) as any\n-          ).href\n-      )\n-    ).toMatchSnapshot()\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: middle https://nextjs.org end\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('middle https://nextjs.org end')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: middle https://nextjs.org end\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('middle https://nextjs.org end')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    }\n \n     await session.patch(\n       'index.js',\n@@ -531,46 +798,42 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n \n     await session.assertNoRedbox()\n     await session.evaluate(() => document.querySelector('button').click())\n-    await session.assertHasRedbox()\n \n-    const header4 = await session.getRedboxDescription()\n-    expect(header4).toMatchInlineSnapshot(\n-      `\"Error: multiple https://nextjs.org links http://example.com\"`\n-    )\n-    // Do not highlight the http://example.com link\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          document\n-            .querySelector('body > nextjs-portal')\n-            .shadowRoot.querySelectorAll('#nextjs__container_errors_desc a')\n-            .length\n-      )\n-    ).toBe(1)\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          (\n-            document\n-              .querySelector('body > nextjs-portal')\n-              .shadowRoot.querySelector(\n-                '#nextjs__container_errors_desc a:nth-of-type(1)'\n-              ) as any\n-          ).href\n-      )\n-    ).toMatchSnapshot()\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          (\n-            document\n-              .querySelector('body > nextjs-portal')\n-              .shadowRoot.querySelector(\n-                '#nextjs__container_errors_desc a:nth-of-type(2)'\n-              ) as any\n-          ).href\n-      )\n-    ).toBe(null)\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: multiple https://nextjs.org links http://example.com\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('multiple https://nextjs.org links http://example.com')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: multiple https://nextjs.org links http://example.com\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('multiple https://nextjs.org links http://example.com')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    }\n \n     await session.patch(\n       'index.js',\n@@ -592,51 +855,47 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n \n     await session.assertNoRedbox()\n     await session.evaluate(() => document.querySelector('button').click())\n-    await session.assertHasRedbox()\n \n-    const header5 = await session.getRedboxDescription()\n-    expect(header5).toMatchInlineSnapshot(\n-      `\"Error: multiple https://nextjs.org links (http://example.com)\"`\n-    )\n-    // Do not highlight the http://example.com link\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          document\n-            .querySelector('body > nextjs-portal')\n-            .shadowRoot.querySelectorAll('#nextjs__container_errors_desc a')\n-            .length\n-      )\n-    ).toBe(1)\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          (\n-            document\n-              .querySelector('body > nextjs-portal')\n-              .shadowRoot.querySelector(\n-                '#nextjs__container_errors_desc a:nth-of-type(1)'\n-              ) as any\n-          ).href\n-      )\n-    ).toMatchSnapshot()\n-    expect(\n-      await session.evaluate(\n-        () =>\n-          (\n-            document\n-              .querySelector('body > nextjs-portal')\n-              .shadowRoot.querySelector(\n-                '#nextjs__container_errors_desc a:nth-of-type(2)'\n-              ) as any\n-          ).href\n-      )\n-    ).toBe(null)\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: multiple https://nextjs.org links (http://example.com)\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('multiple https://nextjs.org links (http://example.com)')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: multiple https://nextjs.org links (http://example.com)\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"index.js (5:11) @ Index.useCallback[boom]\n+       > 5 |     throw new Error('multiple https://nextjs.org links (http://example.com)')\n+           |           ^\",\n+         \"stack\": [\n+           \"Index.useCallback[boom] index.js (5:11)\",\n+           \"UtilityScript.evaluate <anonymous> (236:17)\",\n+           \"UtilityScript.<anonymous> <anonymous> (1:44)\",\n+         ],\n+       }\n+      `)\n+    }\n   })\n \n   test('non-Error errors are handled properly', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'index.js',\n@@ -650,10 +909,29 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n       `\n     )\n \n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Error: {\"a\":1,\"b\":\"x\"}\"`\n-    )\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: {\"a\":1,\"b\":\"x\"}\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: {\"a\":1,\"b\":\"x\"}\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n \n     // fix previous error\n     await session.patch(\n@@ -680,10 +958,32 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n         }\n       `\n     )\n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxDescription()).toContain(\n-      `Error: class Hello {`\n-    )\n+\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: class Hello {\n+       }\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: class Hello {\n+       }\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n \n     // fix previous error\n     await session.patch(\n@@ -708,10 +1008,30 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n         }\n       `\n     )\n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Error: string error\"`\n-    )\n+\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: string error\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: string error\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n \n     // fix previous error\n     await session.patch(\n@@ -736,13 +1056,33 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n         }\n       `\n     )\n-    await session.assertHasRedbox()\n-    expect(await session.getRedboxDescription()).toContain(\n-      `Error: A null error was thrown`\n-    )\n+\n+    if (isReact18) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: A null error was thrown, see here for more info: https://nextjs.org/docs/messages/threw-undefined\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: A null error was thrown, see here for more info: https://nextjs.org/docs/messages/threw-undefined\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": null,\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n   })\n \n-  test('Call stack count is correct for pages error', async () => {\n+  it('Call stack count is correct for pages error', async () => {\n     await using sandbox = await createSandbox(\n       next,\n       new Map([\n@@ -759,14 +1099,63 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox %s', (mode) => {\n         ],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.assertHasRedbox()\n+    const { browser } = sandbox\n+\n+    if (isReact18) {\n+      // TODO(veil): Why different error count between Turbopack and Webpack?\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 3,\n+           \"description\": \"Error: Client error\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Unhandled Runtime Error\",\n+           \"source\": \"pages/index.js (3:11) @ Page\n+         > 3 |     throw new Error('Client error')\n+             |           ^\",\n+           \"stack\": [\n+             \"Page pages/index.js (3:11)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"count\": 2,\n+           \"description\": \"Error: Client error\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Unhandled Runtime Error\",\n+           \"source\": \"pages/index.js (3:11) @ Page\n+         > 3 |     throw new Error('Client error')\n+             |           ^\",\n+           \"stack\": [\n+             \"Page pages/index.js (3:11)\",\n+           ],\n+         }\n+        `)\n+      }\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error: Client error\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Unhandled Runtime Error\",\n+         \"source\": \"pages/index.js (3:11) @ Page\n+       > 3 |     throw new Error('Client error')\n+           |           ^\",\n+         \"stack\": [\n+           \"Page pages/index.js (3:11)\",\n+         ],\n+       }\n+      `)\n+    }\n \n     await toggleCollapseCallStackFrames(browser)\n \n     // Expect more than the default amount of frames\n     // The default stackTraceLimit results in max 9 [data-nextjs-call-stack-frame] elements\n-    await hasRedboxCallStack(browser)\n+\n     const callStackFrames = await browser.elementsByCss(\n       '[data-nextjs-call-stack-frame]'\n     )"
        },
        {
            "sha": "efb7f8a2d99a2f5ba6cbb63208545c23f37d18b1",
            "filename": "test/development/acceptance/__snapshots__/ReactRefreshLogBox.test.ts.snap",
            "status": "removed",
            "additions": 0,
            "deletions": 131,
            "changes": 131,
            "blob_url": "https://github.com/vercel/next.js/blob/0b49048a620fc0c0c75c076952cd079dace03c92/test%2Fdevelopment%2Facceptance%2F__snapshots__%2FReactRefreshLogBox.test.ts.snap",
            "raw_url": "https://github.com/vercel/next.js/raw/0b49048a620fc0c0c75c076952cd079dace03c92/test%2Fdevelopment%2Facceptance%2F__snapshots__%2FReactRefreshLogBox.test.ts.snap",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2F__snapshots__%2FReactRefreshLogBox.test.ts.snap?ref=0b49048a620fc0c0c75c076952cd079dace03c92",
            "patch": "@@ -1,131 +0,0 @@\n-// Jest Snapshot v1, https://goo.gl/fbAQLP\n-\n-exports[`ReactRefreshLogBox default boundaries 1`] = `\n-\"FunctionDefault.js (1:51) @ FunctionDefault\n-\n-> 1 | export default function FunctionDefault() { throw new Error('no'); }\n-    |                                                   ^\"\n-`;\n-\n-exports[`ReactRefreshLogBox default conversion to class component (1) 1`] = `\n-\"Child.js (4:11) @ ClickCount.render\n-\n-  2 | export default class ClickCount extends Component {\n-  3 |   render() {\n-> 4 |     throw new Error()\n-    |           ^\n-  5 |   }\n-  6 | }\"\n-`;\n-\n-exports[`ReactRefreshLogBox default css syntax errors 1`] = `\n-\"./index.module.css (1:1)\n-Syntax error: Selector \"button\" is not pure (pure selectors must contain at least one local class or id)\n-\n-> 1 | button {}\n-    | ^\"\n-`;\n-\n-exports[`ReactRefreshLogBox default logbox: anchors links in error messages 1`] = `\"Error: end https://nextjs.org\"`;\n-\n-exports[`ReactRefreshLogBox default logbox: anchors links in error messages 2`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox default logbox: anchors links in error messages 3`] = `\"Error: https://nextjs.org start\"`;\n-\n-exports[`ReactRefreshLogBox default logbox: anchors links in error messages 4`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox default logbox: anchors links in error messages 5`] = `\"Error: middle https://nextjs.org end\"`;\n-\n-exports[`ReactRefreshLogBox default logbox: anchors links in error messages 6`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox default logbox: anchors links in error messages 8`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox default logbox: anchors links in error messages 10`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox default module init error not shown 1`] = `\n-\"index.js (3:7) @ eval\n-\n-  1 | // top offset for snapshot\n-  2 | import * as React from 'react';\n-> 3 | throw new Error('no')\n-    |       ^\n-  4 | class ClassDefault extends React.Component {\n-  5 |   render() {\n-  6 |     return <h1>Default Export</h1>;\"\n-`;\n-\n-exports[`ReactRefreshLogBox default should strip whitespace correctly with newline 1`] = `\n-\"index.js (8:27) @ onClick\n-\n-   6 |\n-   7 |                   <a onClick={() => {\n->  8 |                     throw new Error('idk')\n-     |                           ^\n-   9 |                   }}>\n-  10 |                     click me\n-  11 |                   </a>\"\n-`;\n-\n-exports[`ReactRefreshLogBox turbo boundaries 1`] = `\n-\"FunctionDefault.js (1:51) @ FunctionDefault\n-\n-> 1 | export default function FunctionDefault() { throw new Error('no'); }\n-    |                                                   ^\"\n-`;\n-\n-exports[`ReactRefreshLogBox turbo conversion to class component (1) 1`] = `\n-\"Child.js (4:11) @ ClickCount.render\n-\n-  2 | export default class ClickCount extends Component {\n-  3 |   render() {\n-> 4 |     throw new Error()\n-    |           ^\n-  5 |   }\n-  6 | }\"\n-`;\n-\n-exports[`ReactRefreshLogBox turbo css syntax errors 1`] = `\n-\"./index.module.css\n-Parsing css source code failed\n-Selector is not pure (pure selectors must contain at least one local class or id), (lightningcss, Selector(button, specificity = 0x1))\"\n-`;\n-\n-exports[`ReactRefreshLogBox turbo logbox: anchors links in error messages 1`] = `\"Error: end https://nextjs.org\"`;\n-\n-exports[`ReactRefreshLogBox turbo logbox: anchors links in error messages 2`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox turbo logbox: anchors links in error messages 3`] = `\"Error: https://nextjs.org start\"`;\n-\n-exports[`ReactRefreshLogBox turbo logbox: anchors links in error messages 4`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox turbo logbox: anchors links in error messages 5`] = `\"Error: middle https://nextjs.org end\"`;\n-\n-exports[`ReactRefreshLogBox turbo logbox: anchors links in error messages 6`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox turbo logbox: anchors links in error messages 8`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox turbo logbox: anchors links in error messages 10`] = `\"https://nextjs.org/\"`;\n-\n-exports[`ReactRefreshLogBox turbo module init error not shown 1`] = `\n-\"index.js (3:7) @ [project]/index.js [ssr] (ecmascript)\n-\n-  1 | // top offset for snapshot\n-  2 | import * as React from 'react';\n-> 3 | throw new Error('no')\n-    |       ^\n-  4 | class ClassDefault extends React.Component {\n-  5 |   render() {\n-  6 |     return <h1>Default Export</h1>;\"\n-`;\n-\n-exports[`ReactRefreshLogBox turbo should strip whitespace correctly with newline 1`] = `\n-\"index.js (8:27) @ onClick\n-\n-   6 |\n-   7 |                   <a onClick={() => {\n->  8 |                     throw new Error('idk')\n-     |                           ^\n-   9 |                   }}>\n-  10 |                     click me\n-  11 |                   </a>\"\n-`;"
        },
        {
            "sha": "dc7a645c8c380631852e2dcb78c9e6fee04fdee9",
            "filename": "test/development/acceptance/hydration-error.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 24,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/58d328a0cf9f722a49e4c85386d0b806c086c21f/test%2Fdevelopment%2Facceptance%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/58d328a0cf9f722a49e4c85386d0b806c086c21f/test%2Fdevelopment%2Facceptance%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2Fhydration-error.test.ts?ref=58d328a0cf9f722a49e4c85386d0b806c086c21f",
            "patch": "@@ -86,7 +86,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Text content did not match. Server: \"server\" Client: \"client\"\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -111,7 +111,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -170,7 +170,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching <main> in <div>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -193,7 +193,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -238,7 +238,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching text node for \"second\" in <div>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -264,7 +264,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -301,7 +301,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Did not expect server HTML to contain a <main> in <div>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -325,7 +325,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -360,7 +360,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Did not expect server HTML to contain the text node \"only\" in <div>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -384,7 +384,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -431,7 +431,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching <table> in <div>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -455,7 +455,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -496,7 +496,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching <table> in <div>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -520,7 +520,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -568,7 +568,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching <main> in <div>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -593,7 +593,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -667,7 +667,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching <p> in <p>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -692,7 +692,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n        This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -739,7 +739,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching <div> in <p>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -764,7 +764,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n        This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -801,7 +801,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching <tr> in <div>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -826,7 +826,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n        This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -869,7 +869,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Expected server HTML to contain a matching <p> in <span>.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)\n@@ -898,7 +898,7 @@ describe('Error overlay for hydration errors in Pages router', () => {\n        This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Unhandled Runtime Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [],\n        }\n       `)"
        },
        {
            "sha": "47a0297ee06f204f9ea08bd37449aa5d5f5dd0ee",
            "filename": "test/development/app-dir/dynamic-io-dev-errors/dynamic-io-dev-errors.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/58d328a0cf9f722a49e4c85386d0b806c086c21f/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/58d328a0cf9f722a49e4c85386d0b806c086c21f/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts?ref=58d328a0cf9f722a49e4c85386d0b806c086c21f",
            "patch": "@@ -106,7 +106,7 @@ describe('Dynamic IO Dev Errors', () => {\n          \"description\": \"Error: Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": undefined,\n+         \"source\": null,\n          \"stack\": [\n            \"Page [Server] <anonymous> (2:1)\",\n            \"main <anonymous> (2:1)\","
        },
        {
            "sha": "1f80cc6fb5d8c33ec30f86bab7294810f0a7a34c",
            "filename": "test/lib/add-redbox-matchers.ts",
            "status": "modified",
            "additions": 56,
            "deletions": 9,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/58d328a0cf9f722a49e4c85386d0b806c086c21f/test%2Flib%2Fadd-redbox-matchers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/58d328a0cf9f722a49e4c85386d0b806c086c21f/test%2Flib%2Fadd-redbox-matchers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fadd-redbox-matchers.ts?ref=58d328a0cf9f722a49e4c85386d0b806c086c21f",
            "patch": "@@ -12,6 +12,7 @@ import {\n   openRedbox,\n } from './next-test-utils'\n import type { BrowserInterface } from './browsers/base'\n+import { NextInstance } from 'e2e-utils'\n \n declare global {\n   namespace jest {\n@@ -22,8 +23,13 @@ declare global {\n        * When a Redbox is hidden at first and requires manual display by clicking the toast,\n        * use {@link toDisplayCollapsedRedbox} instead.\n        *\n+       *\n+       * If the project root appears in the snapshot, pass in the `NextInstance`\n+       * as well to normalize the snapshot e.g. `await expect({ browser, next }).toDisplayRedbox()`.\n+       *\n        * Unintented content in the snapshot should be reported to the Next.js DX team.\n-       * <FIXME-internal-frame> in the snapshot would be unintended.\n+       * `<FIXME-internal-frame>` in the snapshot would be unintended.\n+       * `<FIXME-project-root>` in the snapshot would be unintended.\n        * Any node_modules in the snapshot would be unintended.\n        * Differences in the snapshot between Turbopack and Webpack would be unintended.\n        *\n@@ -36,8 +42,12 @@ declare global {\n        * When a Redbox is immediately displayed,\n        * use {@link toDisplayRedbox} instead.\n        *\n+       * If the project root appears in the snapshot, pass in the `NextInstance`\n+       * as well to normalize the snapshot e.g. `await expect({ browser, next }).toDisplayCollapsedRedbox()`.\n+       *\n        * Unintented content in the snapshot should be reported to the Next.js DX team.\n-       * <FIXME-internal-frame> in the snapshot would be unintended.\n+       * `<FIXME-internal-frame>` in the snapshot would be unintended.\n+       * `<FIXME-project-root>` in the snapshot would be unintended.\n        * Any node_modules in the snapshot would be unintended.\n        * Differences in the snapshot between Turbopack and Webpack would be unintended.\n        *\n@@ -59,7 +69,8 @@ interface RedboxSnapshot {\n }\n \n async function createRedboxSnapshot(\n-  browser: BrowserInterface\n+  browser: BrowserInterface,\n+  next: NextInstance | null\n ): Promise<RedboxSnapshot> {\n   const [\n     label,\n@@ -119,13 +130,25 @@ async function createRedboxSnapshot(\n         focusedSource += '\\n' + sourceFrameLine\n       }\n     }\n+\n+    focusedSource = focusedSource.trim()\n+\n+    if (next !== null) {\n+      focusedSource = focusedSource.replace(\n+        next.testDir,\n+        '<FIXME-project-root>'\n+      )\n+    }\n   }\n \n   const snapshot: RedboxSnapshot = {\n     environmentLabel,\n     label,\n-    description,\n-    source: focusedSource?.trim(),\n+    description:\n+      description !== null && next !== null\n+        ? description.replace(next.testDir, '<FIXME-project-root>')\n+        : description,\n+    source: focusedSource,\n     stack,\n     // TODO(newDevOverlay): Always return `count`. Normalizing currently to avoid assertion forks.\n     count: label === 'Build Error' && count === -1 ? 1 : count,\n@@ -143,9 +166,21 @@ async function createRedboxSnapshot(\n expect.extend({\n   async toDisplayRedbox(\n     this: MatcherContext,\n-    browser: BrowserInterface,\n+    browserOrContext:\n+      | BrowserInterface\n+      | { browser: BrowserInterface; next: NextInstance },\n     expectedRedboxSnapshot?: string\n   ) {\n+    let browser: BrowserInterface\n+    let next: NextInstance\n+    if ('browser' in browserOrContext && 'next' in browserOrContext) {\n+      browser = browserOrContext.browser\n+      next = browserOrContext.next\n+    } else {\n+      browser = browserOrContext\n+      next = null\n+    }\n+\n     // Otherwise jest uses the async stack trace which makes it impossible to know the actual callsite of `toMatchSpeechInlineSnapshot`.\n     // @ts-expect-error -- Not readonly\n     this.error = new Error()\n@@ -170,7 +205,7 @@ expect.extend({\n       }\n     }\n \n-    const redbox = await createRedboxSnapshot(browser)\n+    const redbox = await createRedboxSnapshot(browser, next)\n \n     // argument length is relevant.\n     // Jest will update absent snapshots but fail if you specify a snapshot even if undefined.\n@@ -182,9 +217,21 @@ expect.extend({\n   },\n   async toDisplayCollapsedRedbox(\n     this: MatcherContext,\n-    browser: BrowserInterface,\n+    browserOrContext:\n+      | BrowserInterface\n+      | { browser: BrowserInterface; next: NextInstance },\n     expectedRedboxSnapshot?: string\n   ) {\n+    let browser: BrowserInterface\n+    let next: NextInstance | null\n+    if ('browser' in browserOrContext && 'next' in browserOrContext) {\n+      browser = browserOrContext.browser\n+      next = browserOrContext.next\n+    } else {\n+      browser = browserOrContext\n+      next = null\n+    }\n+\n     // Otherwise jest uses the async stack trace which makes it impossible to know the actual callsite of `toMatchSpeechInlineSnapshot`.\n     // @ts-expect-error -- Not readonly\n     this.error = new Error()\n@@ -216,7 +263,7 @@ expect.extend({\n       }\n     }\n \n-    const redbox = await createRedboxSnapshot(browser)\n+    const redbox = await createRedboxSnapshot(browser, next)\n \n     // argument length is relevant.\n     // Jest will update absent snapshots but fail if you specify a snapshot even if undefined."
        }
    ],
    "stats": {
        "total": 1143,
        "additions": 724,
        "deletions": 419
    }
}