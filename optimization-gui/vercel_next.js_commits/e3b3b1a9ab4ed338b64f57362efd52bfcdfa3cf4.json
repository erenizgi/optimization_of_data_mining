{
    "author": "eps1lon",
    "message": "[test] Avoid needless start/stop from using `createSandbox` (#85507)\n\n`createSandbox` fully isolates the returned session from the existing\nNext instance by restarting the server.\n\nThis is wasteful if the existing instance is already started. Some tests\ncalled `nextTestSetup()` without `skipStart` which got fixed in this PR.\n\nSome tests can just use `patchFile` nowadays instead of `createSandbox`.",
    "sha": "e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4",
    "files": [
        {
            "sha": "64c97ce074f8b9c7ac548cea7523c04b6af67343",
            "filename": "test/development/acceptance-app/app-hmr-changes.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fdevelopment%2Facceptance-app%2Fapp-hmr-changes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fdevelopment%2Facceptance-app%2Fapp-hmr-changes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fapp-hmr-changes.test.ts?ref=e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4",
            "patch": "@@ -19,6 +19,7 @@ describe('Error overlay - RSC build errors', () => {\n       'image-size': '^1.0.2',\n       autoprefixer: '^10.4.13',\n     },\n+    skipStart: true,\n   })\n \n   // TODO: The error overlay is not closed when restoring the working code."
        },
        {
            "sha": "9b6f9672a563a6e897c11a5669ce976d362f7777",
            "filename": "test/development/app-dir/cache-components-dev-errors/cache-components-dev-errors.test.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 53,
            "changes": 92,
            "blob_url": "https://github.com/vercel/next.js/blob/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-errors%2Fcache-components-dev-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-errors%2Fcache-components-dev-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-errors%2Fcache-components-dev-errors.test.ts?ref=e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4",
            "patch": "@@ -6,7 +6,6 @@ import {\n   hasErrorToast,\n   retry,\n } from 'next-test-utils'\n-import { createSandbox } from 'development-sandbox'\n import { outdent } from 'outdent'\n \n describe('Cache Components Dev Errors', () => {\n@@ -128,65 +127,52 @@ describe('Cache Components Dev Errors', () => {\n   })\n \n   it('should clear segment errors after correcting them', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.tsx',\n-          outdent`\n-          export const revalidate = 10\n-          export default function Page() {\n-            return (\n-              <div>Hello World</div>\n-            );\n-          }\n-        `,\n-        ],\n-      ])\n-    )\n-    const { browser, session } = sandbox\n-    if (isTurbopack) {\n-      await expect(browser).toDisplayRedbox(`\n-       {\n-         \"description\": \"Ecmascript file had an error\",\n-         \"environmentLabel\": null,\n-         \"label\": \"Build Error\",\n-         \"source\": \"./app/page.tsx (1:14)\n-       Ecmascript file had an error\n-       > 1 | export const revalidate = 10\n-           |              ^^^^^^^^^^\",\n-         \"stack\": [],\n-       }\n-      `)\n-    } else {\n-      await expect(browser).toDisplayRedbox(`\n-       {\n-         \"description\": \"  x Route segment config \"revalidate\" is not compatible with \\`nextConfig.cacheComponents\\`. Please remove it.\",\n-         \"environmentLabel\": null,\n-         \"label\": \"Build Error\",\n-         \"source\": \"./app/page.tsx\n-       Error:   x Route segment config \"revalidate\" is not compatible with \\`nextConfig.cacheComponents\\`. Please remove it.\n-          ,-[1:1]\n-        1 | export const revalidate = 10\n-          :              ^^^^^^^^^^\n-        2 | export default function Page() {\n-        3 |   return (\n-        4 |     <div>Hello World</div>\n-          \\`----\",\n-         \"stack\": [],\n-       }\n-      `)\n-    }\n-\n-    await session.patch(\n+    let browser: any\n+    await next.patchFile(\n       'app/page.tsx',\n       outdent`\n+      export const revalidate = 10\n       export default function Page() {\n         return (\n           <div>Hello World</div>\n         );\n       }\n-    `\n+    `,\n+      async () => {\n+        browser = await next.browser('/')\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayRedbox(`\n+           {\n+             \"description\": \"Ecmascript file had an error\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Build Error\",\n+             \"source\": \"./app/page.tsx (1:14)\n+           Ecmascript file had an error\n+           > 1 | export const revalidate = 10\n+               |              ^^^^^^^^^^\",\n+             \"stack\": [],\n+           }\n+          `)\n+        } else {\n+          await expect(browser).toDisplayRedbox(`\n+           {\n+             \"description\": \"  x Route segment config \"revalidate\" is not compatible with \\`nextConfig.cacheComponents\\`. Please remove it.\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Build Error\",\n+             \"source\": \"./app/page.tsx\n+           Error:   x Route segment config \"revalidate\" is not compatible with \\`nextConfig.cacheComponents\\`. Please remove it.\n+              ,-[1:1]\n+            1 | export const revalidate = 10\n+              :              ^^^^^^^^^^\n+            2 | export default function Page() {\n+            3 |   return (\n+            4 |     <div>Hello World</div>\n+              \\`----\",\n+             \"stack\": [],\n+           }\n+          `)\n+        }\n+      }\n     )\n \n     await assertNoRedbox(browser)"
        },
        {
            "sha": "9dbc04f834f879463f5c90ef4e39c936e1cf6649",
            "filename": "test/e2e/app-dir/app-root-params-getters/fixtures/use-cache-runtime/app/[lang]/[locale]/unstable_cache/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Funstable_cache%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Funstable_cache%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-runtime%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Funstable_cache%2Fpage.tsx?ref=e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4",
            "patch": "@@ -29,6 +29,6 @@ async function Runtime() {\n   )\n }\n \n-const getCachedParams = unstable_cache(async () => {\n+const getCachedParams = unstable_cache(async function uncachedGetParams() {\n   return { lang: await lang(), locale: await locale() }\n })"
        },
        {
            "sha": "55674b4f6b95f114f761fd026ff0c5a88b4650fc",
            "filename": "test/e2e/app-dir/app-root-params-getters/use-cache.test.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 28,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fuse-cache.test.ts?ref=e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4",
            "patch": "@@ -1,6 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n import { join } from 'path'\n-import { createSandbox } from 'development-sandbox'\n+import { assertNoRedbox } from 'next-test-utils'\n \n describe('app-root-param-getters - cache - at runtime', () => {\n   const { next, isNextDev, skipped } = nextTestSetup({\n@@ -13,29 +13,38 @@ describe('app-root-param-getters - cache - at runtime', () => {\n \n   if (isNextDev) {\n     it('should error when using root params within a \"use cache\" - dev', async () => {\n-      await using sandbox = await createSandbox(\n-        next,\n-        undefined,\n-        '/en/us/use-cache'\n-      )\n-      const { session } = sandbox\n-      await session.assertHasRedbox()\n-      expect(await session.getRedboxDescription()).toInclude(\n-        'Route /[lang]/[locale]/use-cache used `import(\\'next/root-params\\').lang()` inside `\"use cache\"` or `unstable_cache`'\n-      )\n+      const browser = await next.browser('/en/us/use-cache')\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"Route /[lang]/[locale]/use-cache used \\`import('next/root-params').lang()\\` inside \\`\"use cache\"\\` or \\`unstable_cache\\`. Support for this API inside cache scopes is planned for a future version of Next.js.\",\n+         \"environmentLabel\": \"Cache\",\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/[lang]/[locale]/use-cache/page.tsx (33:28) @ getCachedParams\n+       > 33 |   return { lang: await lang(), locale: await locale() }\n+            |                            ^\",\n+         \"stack\": [\n+           \"getCachedParams app/[lang]/[locale]/use-cache/page.tsx (33:28)\",\n+         ],\n+       }\n+      `)\n     })\n \n     it('should error when using root params within `unstable_cache` - dev', async () => {\n-      await using sandbox = await createSandbox(\n-        next,\n-        undefined,\n-        '/en/us/unstable_cache'\n-      )\n-      const { session } = sandbox\n-      await session.assertHasRedbox()\n-      expect(await session.getRedboxDescription()).toInclude(\n-        'Route /[lang]/[locale]/unstable_cache used `import(\\'next/root-params\\').lang()` inside `\"use cache\"` or `unstable_cache`'\n-      )\n+      const browser = await next.browser('/en/us/unstable_cache')\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"Route /[lang]/[locale]/unstable_cache used \\`import('next/root-params').lang()\\` inside \\`\"use cache\"\\` or \\`unstable_cache\\`. Support for this API inside cache scopes is planned for a future version of Next.js.\",\n+         \"environmentLabel\": \"Server\",\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/[lang]/[locale]/unstable_cache/page.tsx (33:28) @ uncachedGetParams\n+       > 33 |   return { lang: await lang(), locale: await locale() }\n+            |                            ^\",\n+         \"stack\": [\n+           \"uncachedGetParams app/[lang]/[locale]/unstable_cache/page.tsx (33:28)\",\n+           \"Runtime app/[lang]/[locale]/unstable_cache/page.tsx (17:22)\",\n+         ],\n+       }\n+      `)\n     })\n   } else {\n     it('should error when using root params within a \"use cache\" - start', async () => {\n@@ -61,13 +70,9 @@ describe('app-root-param-getters - private cache', () => {\n \n   if (isNextDev) {\n     it('should allow using root params within a \"use cache: private\" - dev', async () => {\n-      await using sandbox = await createSandbox(\n-        next,\n-        undefined,\n-        '/en/us/use-cache-private'\n-      )\n-      const { session, browser } = sandbox\n-      await session.assertNoRedbox()\n+      const browser = await next.browser('/en/us/use-cache-private')\n+\n+      await assertNoRedbox(browser)\n       expect(await browser.elementById('param').text()).toBe('en us')\n     })\n   } else {"
        },
        {
            "sha": "f6445a76fb3029c8bbf3cc7ea4619ff5bb28245f",
            "filename": "test/e2e/app-dir/logging/fetch-logging.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 19,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fe2e%2Fapp-dir%2Flogging%2Ffetch-logging.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4/test%2Fe2e%2Fapp-dir%2Flogging%2Ffetch-logging.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Flogging%2Ffetch-logging.test.ts?ref=e3b3b1a9ab4ed338b64f57362efd52bfcdfa3cf4",
            "patch": "@@ -3,7 +3,6 @@ import fs from 'fs'\n import stripAnsi from 'strip-ansi'\n import { retry } from 'next-test-utils'\n import { nextTestSetup } from 'e2e-utils'\n-import { createSandbox } from 'development-sandbox'\n \n const cacheReasonRegex = /Cache (missed|skipped) reason: /\n \n@@ -52,30 +51,26 @@ describe('app-dir - fetch logging', () => {\n \n   isNextDev &&\n     it('should not log requests for HMR refreshes', async () => {\n-      await using sandbox = await createSandbox(\n-        next,\n-        undefined,\n-        '/fetch-no-store'\n-      )\n-\n-      const { browser, session } = sandbox\n+      const browser = await next.browser('/fetch-no-store')\n \n       let headline = await browser.waitForElementByCss('h1').text()\n       expect(headline).toBe('Hello World!')\n       const outputIndex = next.cliOutput.length\n \n-      await session.patch('app/fetch-no-store/page.js', (content) =>\n-        content.replace('Hello World!', 'Hello Test!')\n+      await next.patchFile(\n+        'app/fetch-no-store/page.js',\n+        (content) => content.replace('Hello World!', 'Hello Test!'),\n+        async () => {\n+          await retry(async () => {\n+            headline = await browser.waitForElementByCss('h1').text()\n+            expect(headline).toBe('Hello Test!')\n+            const logs = stripAnsi(next.cliOutput.slice(outputIndex))\n+            expect(logs).toInclude(' GET /fetch-no-store')\n+            expect(logs).not.toInclude(` │ GET `)\n+            // TODO: remove custom duration in case we increase the default.\n+          }, 5000)\n+        }\n       )\n-\n-      await retry(async () => {\n-        headline = await browser.waitForElementByCss('h1').text()\n-        expect(headline).toBe('Hello Test!')\n-        const logs = stripAnsi(next.cliOutput.slice(outputIndex))\n-        expect(logs).toInclude(' GET /fetch-no-store')\n-        expect(logs).not.toInclude(` │ GET `)\n-        // TODO: remove custom duration in case we increase the default.\n-      }, 5000)\n     })\n \n   // TODO: remove when there is a test for isNextDev === false"
        }
    ],
    "stats": {
        "total": 189,
        "additions": 88,
        "deletions": 101
    }
}