{
    "author": "huozhi",
    "message": "[devtool] display segment explorer as tree view (#80261)",
    "sha": "356cdf23939e81c92ee97ab19ebb391d80529951",
    "files": [
        {
            "sha": "03f03a63e15ad16ef2741fdcfc932a6c35c2b41a",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 42,
            "deletions": 21,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/356cdf23939e81c92ee97ab19ebb391d80529951/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/356cdf23939e81c92ee97ab19ebb391d80529951/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=356cdf23939e81c92ee97ab19ebb391d80529951",
            "patch": "@@ -62,17 +62,20 @@ function PageSegmentTree({ tree }: { tree: Trie<SegmentNode> | undefined }) {\n         tree={tree}\n         node={tree.getRoot()}\n         level={0}\n+        segment=\"\"\n       />\n     </div>\n   )\n }\n \n function PageSegmentTreeLayerPresentation({\n   tree,\n+  segment,\n   node,\n   level,\n }: {\n   tree: Trie<SegmentNode>\n+  segment: string\n   node: TrieNode<SegmentNode>\n   level: number\n }) {\n@@ -81,11 +84,9 @@ function PageSegmentTreeLayerPresentation({\n \n   const segments = pagePath.split('/') || []\n   const fileName = segments.pop() || ''\n-  const segmentPath = segments.join('/')\n+  const childrenKeys = Object.keys(node.children)\n \n-  let pagePathPrefix = segmentPath\n-\n-  const childrenKeys = Object.keys(node.children).sort((a, b) => {\n+  const sortedChildrenKeys = childrenKeys.sort((a, b) => {\n     // Prioritize if it's a file convention like layout or page,\n     // then the rest parallel routes.\n     const aHasExt = a.includes('.')\n@@ -98,13 +99,11 @@ function PageSegmentTreeLayerPresentation({\n \n   return (\n     <div\n-      className={cx(\n-        'segment-explorer-item',\n-        level > 1 && 'segment-explorer-item--nested'\n-      )}\n+      className=\"segment-explorer-item\"\n+      data-nextjs-devtool-segment-explorer-segment={segment}\n     >\n-      {!fileName || level === 0 ? null : (\n-        <div className=\"segment-explorer-item-row\">\n+      {fileName ? (\n+        <div className={cx('segment-explorer-item-row')}>\n           <div className=\"segment-explorer-line\">\n             <div className={`segment-explorer-line-text-${nodeName}`}>\n               <span\n@@ -115,20 +114,39 @@ function PageSegmentTreeLayerPresentation({\n               >\n                 {nodeName === 'layout' ? ICONS.layout : ICONS.page}\n               </span>\n-              {pagePathPrefix === '' ? '' : `${pagePathPrefix}/`}\n               <span className=\"segment-explorer-filename-path\">{fileName}</span>\n             </div>\n           </div>\n         </div>\n-      )}\n-\n-      <div className=\"tree-node-expanded-rendered-children\">\n-        {childrenKeys.map((segment) => {\n-          const child = node.children[segment]\n+      ) : segment ? (\n+        <div className={'segment-explorer-item-row'}>\n+          <div className=\"segment-explorer-line\">\n+            <div className={`segment-explorer-line-text-${nodeName}`}>\n+              <span\n+                className={cx(\n+                  'segment-explorer-line-icon',\n+                  `segment-explorer-line-icon-${nodeName}`\n+                )}\n+              ></span>\n+              <span className=\"segment-explorer-filename-path\">\n+                {`${segment}/`}\n+              </span>\n+            </div>\n+          </div>\n+        </div>\n+      ) : null}\n+\n+      <div\n+        className=\"segment-explorer-segment-children\"\n+        data-nextjs-devtool-segment-explorer-level={level}\n+      >\n+        {sortedChildrenKeys.map((childSegment) => {\n+          const child = node.children[childSegment]\n           return (\n             child && (\n               <PageSegmentTreeLayerPresentation\n-                key={segment}\n+                key={childSegment}\n+                segment={childSegment}\n                 tree={tree}\n                 node={child}\n                 level={level + 1}\n@@ -163,17 +181,20 @@ export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n     font-size: var(--size-14);\n   }\n \n-  .segment-explorer-item--nested {\n-    padding-left: 20px;\n-  }\n-\n   .segment-explorer-item-row {\n     display: flex;\n     align-items: center;\n     gap: 8px;\n     padding: 2px 0;\n   }\n \n+  [data-nextjs-devtool-segment-explorer-level].segment-explorer-segment-children {\n+    padding-left: 20px;\n+  }\n+  [data-nextjs-devtool-segment-explorer-level='0'].segment-explorer-segment-children {\n+    padding-left: 0px;\n+  }\n+\n   .segment-explorer-filename-path {\n     display: inline-block;\n   }"
        },
        {
            "sha": "7b264b447b61917ef15563e06c50ca493fd1466b",
            "filename": "test/development/app-dir/segment-explorer/app/(v2)/blog/(team)/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2Flayout.tsx?ref=356cdf23939e81c92ee97ab19ebb391d80529951",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Layout({ children }) {\n+  return (\n+    <div>\n+      <h3>Nested Layout</h3>\n+      <div className=\"nested-children\">{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "fb945dafc3b1e1ff98e0a840ace6fdcef4edc86d",
            "filename": "test/development/app-dir/segment-explorer/app/(v2)/blog/(team)/~/(overview)/grid/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2F%7E%2F(overview)%2Fgrid%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2F%7E%2F(overview)%2Fgrid%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2F%7E%2F(overview)%2Fgrid%2Fpage.tsx?ref=356cdf23939e81c92ee97ab19ebb391d80529951",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Page() {\n+  return (\n+    <div>\n+      Page <br />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "7b264b447b61917ef15563e06c50ca493fd1466b",
            "filename": "test/development/app-dir/segment-explorer/app/(v2)/blog/(team)/~/(overview)/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2F%7E%2F(overview)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2F%7E%2F(overview)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Fblog%2F(team)%2F%7E%2F(overview)%2Flayout.tsx?ref=356cdf23939e81c92ee97ab19ebb391d80529951",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Layout({ children }) {\n+  return (\n+    <div>\n+      <h3>Nested Layout</h3>\n+      <div className=\"nested-children\">{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "7b264b447b61917ef15563e06c50ca493fd1466b",
            "filename": "test/development/app-dir/segment-explorer/app/(v2)/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fapp%2F(v2)%2Flayout.tsx?ref=356cdf23939e81c92ee97ab19ebb391d80529951",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Layout({ children }) {\n+  return (\n+    <div>\n+      <h3>Nested Layout</h3>\n+      <div className=\"nested-children\">{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "b7815bb4c0f147c19263b4bcbecffa0934c26f26",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 21,
            "changes": 68,
            "blob_url": "https://github.com/vercel/next.js/blob/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/356cdf23939e81c92ee97ab19ebb391d80529951/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=356cdf23939e81c92ee97ab19ebb391d80529951",
            "patch": "@@ -1,34 +1,60 @@\n import { nextTestSetup } from 'e2e-utils'\n import { openDevToolsIndicatorPopover } from 'next-test-utils'\n+import { Playwright } from 'next-webdriver'\n+\n+async function getSegmentExplorerContent(browser: Playwright) {\n+  // open the devtool button\n+  await openDevToolsIndicatorPopover(browser)\n+\n+  // open the segment explorer\n+  await browser.elementByCss('[data-segment-explorer]').click()\n+\n+  //  wait for the segment explorer to be visible\n+  await browser.waitForElementByCss('[data-nextjs-devtool-segment-explorer]')\n+\n+  const content = await browser.elementByCss(\n+    '[data-nextjs-devtool-segment-explorer]'\n+  )\n+  return content.text()\n+}\n \n describe('segment-explorer', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,\n   })\n \n-  it('should render the segment explorer', async () => {\n+  it('should render the segment explorer for parallel routes', async () => {\n     const browser = await next.browser('/parallel-routes')\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"app/\n+     layout.tsx\n+     parallel-routes/\n+     layout.tsx\n+     page.tsx\n+     @bar/\n+     layout.tsx\n+     page.tsx\n+     @foo/\n+     layout.tsx\n+     page.tsx\"\n+    `)\n+  })\n \n-    // open the devtool button\n-    await openDevToolsIndicatorPopover(browser)\n-\n-    // open the segment explorer\n-    await browser.elementByCss('[data-segment-explorer]').click()\n-\n-    //  wait for the segment explorer to be visible\n-    await browser.waitForElementByCss('[data-nextjs-devtool-segment-explorer]')\n-\n-    const content = await browser.elementByCss(\n-      '[data-nextjs-devtool-segment-explorer]'\n-    )\n-    expect(await content.text()).toMatchInlineSnapshot(`\n-     \"app/layout.tsx\n-     app/parallel-routes/layout.tsx\n-     app/parallel-routes/page.tsx\n-     app/parallel-routes/@bar/layout.tsx\n-     app/parallel-routes/@bar/page.tsx\n-     app/parallel-routes/@foo/layout.tsx\n-     app/parallel-routes/@foo/page.tsx\"\n+  it('should render the segment explorer for nested routes', async () => {\n+    const browser = await next.browser('/blog/~/grid')\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n+     \"app/\n+     layout.tsx\n+     (v2)/\n+     layout.tsx\n+     blog/\n+     (team)/\n+     layout.tsx\n+     ~/\n+     (overview)/\n+     layout.tsx\n+     grid/\n+     page.tsx\"\n     `)\n   })\n })"
        }
    ],
    "stats": {
        "total": 162,
        "additions": 120,
        "deletions": 42
    }
}