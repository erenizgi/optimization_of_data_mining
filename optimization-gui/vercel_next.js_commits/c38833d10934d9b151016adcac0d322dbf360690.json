{
    "author": "sokra",
    "message": "Revert \"Turbopack: skip invalidating a task on cell/output change when the dependency is outdated\" (#84526)\n\nReverts vercel/next.js#84376",
    "sha": "c38833d10934d9b151016adcac0d322dbf360690",
    "files": [
        {
            "sha": "d4b5078586e291f9dc7d6f04a380aa3c1b52b84b",
            "filename": "test/e2e/app-dir/no-double-tailwind-execution/app/globals.css",
            "status": "removed",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Fglobals.css",
            "raw_url": "https://github.com/vercel/next.js/raw/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Fglobals.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Fglobals.css?ref=d4eb8915334320a39a376b409fb2e359a630d57c",
            "patch": "@@ -1 +0,0 @@\n-@import 'tailwindcss';"
        },
        {
            "sha": "5c549e129fd0eb9b5634ae7712a480653ab93547",
            "filename": "test/e2e/app-dir/no-double-tailwind-execution/app/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Flayout.tsx?ref=d4eb8915334320a39a376b409fb2e359a630d57c",
            "patch": "@@ -1,10 +0,0 @@\n-import './globals.css'\n-\n-import { ReactNode } from 'react'\n-export default function Root({ children }: { children: ReactNode }) {\n-  return (\n-    <html>\n-      <body>{children}</body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/no-double-tailwind-execution/app/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fapp%2Fpage.tsx?ref=d4eb8915334320a39a376b409fb2e359a630d57c",
            "patch": "@@ -1,3 +0,0 @@\n-export default function Page() {\n-  return <p>hello world</p>\n-}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/no-double-tailwind-execution/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fnext.config.js?ref=d4eb8915334320a39a376b409fb2e359a630d57c",
            "patch": "@@ -1,6 +0,0 @@\n-/**\n- * @type {import('next').NextConfig}\n- */\n-const nextConfig = {}\n-\n-module.exports = nextConfig"
        },
        {
            "sha": "9b38894d44ce47a42384b82b2f05528e7d6371c0",
            "filename": "test/e2e/app-dir/no-double-tailwind-execution/no-double-tailwind-execution.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 55,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fno-double-tailwind-execution.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fno-double-tailwind-execution.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fno-double-tailwind-execution.test.ts?ref=d4eb8915334320a39a376b409fb2e359a630d57c",
            "patch": "@@ -1,55 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import { retry } from 'next-test-utils'\n-\n-describe('no-double-tailwind-execution', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n-    files: __dirname,\n-    skipDeployment: true,\n-    dependencies: {\n-      '@tailwindcss/postcss': '^4',\n-      tailwindcss: '^4',\n-    },\n-    env: {\n-      DEBUG: 'tailwindcss',\n-      ...process.env,\n-    },\n-  })\n-\n-  if (skipped) {\n-    return\n-  }\n-\n-  it('should run tailwind only once initially and per change', async () => {\n-    const browser = await next.browser('/')\n-    expect(await browser.elementByCss('p').text()).toBe('hello world')\n-\n-    if (isNextDev) {\n-      const filePath = 'app/page.tsx'\n-      const origContent = await next.readFile(filePath)\n-      let getOutput = next.getCliOutputFromHere()\n-      await next.patchFile(\n-        filePath,\n-        origContent.replace('hello world', 'hello hmr'),\n-        async () => {\n-          await retry(async () => {\n-            expect(await browser.elementByCss('p').text()).toBe('hello hmr')\n-            let tailwindProcessingCount = [\n-              ...getOutput().matchAll(\n-                /\\[@tailwindcss\\/postcss\\] app\\/globals.css/g\n-              ),\n-            ].length\n-            expect(tailwindProcessingCount).toBe(1)\n-          })\n-        }\n-      )\n-    }\n-    let tailwindProcessingCount = [\n-      ...next.cliOutput.matchAll(/\\[@tailwindcss\\/postcss\\] app\\/globals.css/g),\n-    ].length\n-    if (isNextDev) {\n-      expect(tailwindProcessingCount).toBe(3) // dev: initial + hmr + hmr (revert)\n-    } else {\n-      expect(tailwindProcessingCount).toBe(1) // build\n-    }\n-  })\n-})"
        },
        {
            "sha": "0967ef424bce6791893e9a57bb952f80fd536e93",
            "filename": "test/e2e/app-dir/no-double-tailwind-execution/package.json",
            "status": "removed",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fpackage.json?ref=d4eb8915334320a39a376b409fb2e359a630d57c",
            "patch": "@@ -1 +0,0 @@\n-{}"
        },
        {
            "sha": "86e8e3c4574222beff76cfb19dafad56c828c64c",
            "filename": "test/e2e/app-dir/no-double-tailwind-execution/postcss.config.mjs",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fpostcss.config.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/d4eb8915334320a39a376b409fb2e359a630d57c/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fpostcss.config.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-double-tailwind-execution%2Fpostcss.config.mjs?ref=d4eb8915334320a39a376b409fb2e359a630d57c",
            "patch": "@@ -1,5 +0,0 @@\n-const config = {\n-  plugins: ['@tailwindcss/postcss'],\n-}\n-\n-export default config"
        },
        {
            "sha": "ee37e2a2475508ae02c370c8597448fcd3dd6468",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c38833d10934d9b151016adcac0d322dbf360690/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c38833d10934d9b151016adcac0d322dbf360690/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs?ref=c38833d10934d9b151016adcac0d322dbf360690",
            "patch": "@@ -601,7 +601,6 @@ pub enum AnyOperation {\n     ConnectChild(connect_child::ConnectChildOperation),\n     Invalidate(invalidate::InvalidateOperation),\n     UpdateOutput(update_output::UpdateOutputOperation),\n-    UpdateCell(update_cell::UpdateCellOperation),\n     CleanupOldEdges(cleanup_old_edges::CleanupOldEdgesOperation),\n     AggregationUpdate(aggregation_update::AggregationUpdateQueue),\n     Nested(Vec<AnyOperation>),\n@@ -613,7 +612,6 @@ impl AnyOperation {\n             AnyOperation::ConnectChild(op) => op.execute(ctx),\n             AnyOperation::Invalidate(op) => op.execute(ctx),\n             AnyOperation::UpdateOutput(op) => op.execute(ctx),\n-            AnyOperation::UpdateCell(op) => op.execute(ctx),\n             AnyOperation::CleanupOldEdges(op) => op.execute(ctx),\n             AnyOperation::AggregationUpdate(op) => op.execute(ctx),\n             AnyOperation::Nested(ops) => {\n@@ -628,7 +626,6 @@ impl AnyOperation {\n impl_operation!(ConnectChild connect_child::ConnectChildOperation);\n impl_operation!(Invalidate invalidate::InvalidateOperation);\n impl_operation!(UpdateOutput update_output::UpdateOutputOperation);\n-impl_operation!(UpdateCell update_cell::UpdateCellOperation);\n impl_operation!(CleanupOldEdges cleanup_old_edges::CleanupOldEdgesOperation);\n impl_operation!(AggregationUpdate aggregation_update::AggregationUpdateQueue);\n \n@@ -642,5 +639,6 @@ pub use self::{\n     cleanup_old_edges::OutdatedEdge,\n     connect_children::connect_children,\n     prepare_new_children::prepare_new_children,\n+    update_cell::UpdateCellOperation,\n     update_collectible::UpdateCollectibleOperation,\n };"
        },
        {
            "sha": "fadf13d9fbf374189e91fb40b7e6da64a69381b2",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/update_cell.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 92,
            "changes": 103,
            "blob_url": "https://github.com/vercel/next.js/blob/c38833d10934d9b151016adcac0d322dbf360690/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_cell.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c38833d10934d9b151016adcac0d322dbf360690/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_cell.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_cell.rs?ref=c38833d10934d9b151016adcac0d322dbf360690",
            "patch": "@@ -1,37 +1,17 @@\n-use std::mem::take;\n-\n-use serde::{Deserialize, Serialize};\n-use smallvec::SmallVec;\n use turbo_tasks::{CellId, TaskId, backend::CellContent};\n \n #[cfg(feature = \"trace_task_dirty\")]\n use crate::backend::operation::invalidate::TaskDirtyCause;\n use crate::{\n     backend::{\n         TaskDataCategory,\n-        operation::{\n-            AggregationUpdateQueue, ExecuteContext, Operation, TaskGuard,\n-            invalidate::make_task_dirty_internal,\n-        },\n+        operation::{ExecuteContext, InvalidateOperation, TaskGuard},\n         storage::{get_many, remove},\n     },\n-    data::{CachedDataItem, CachedDataItemKey, CellRef},\n+    data::{CachedDataItem, CachedDataItemKey},\n };\n \n-#[derive(Serialize, Deserialize, Clone, Default)]\n-#[allow(clippy::large_enum_variant)]\n-pub enum UpdateCellOperation {\n-    InvalidateWhenCellDependency {\n-        cell_ref: CellRef,\n-        dependent_tasks: SmallVec<[TaskId; 4]>,\n-        queue: AggregationUpdateQueue,\n-    },\n-    AggregationUpdate {\n-        queue: AggregationUpdateQueue,\n-    },\n-    #[default]\n-    Done,\n-}\n+pub struct UpdateCellOperation;\n \n impl UpdateCellOperation {\n     pub fn run(task_id: TaskId, cell: CellId, content: CellContent, mut ctx: impl ExecuteContext) {\n@@ -59,7 +39,7 @@ impl UpdateCellOperation {\n                 // This is a hack for the streaming hack. Stateful tasks are never recomputed, so this forces invalidation for them in case of this hack.\n                 task.has_key(&CachedDataItemKey::Stateful {}))\n         {\n-            let dependent_tasks = get_many!(\n+            let dependent = get_many!(\n                 task,\n                 CellDependent { cell: dependent_cell, task }\n                 if dependent_cell == cell\n@@ -69,78 +49,17 @@ impl UpdateCellOperation {\n             drop(task);\n             drop(old_content);\n \n-            UpdateCellOperation::InvalidateWhenCellDependency {\n-                cell_ref: CellRef {\n-                    task: task_id,\n-                    cell,\n+            InvalidateOperation::run(\n+                dependent,\n+                #[cfg(feature = \"trace_task_dirty\")]\n+                TaskDirtyCause::CellChange {\n+                    value_type: cell.type_id,\n                 },\n-                dependent_tasks,\n-                queue: AggregationUpdateQueue::new(),\n-            }\n-            .execute(&mut ctx);\n+                ctx,\n+            );\n         } else {\n             drop(task);\n             drop(old_content);\n         }\n     }\n }\n-\n-impl Operation for UpdateCellOperation {\n-    fn execute(mut self, ctx: &mut impl ExecuteContext) {\n-        loop {\n-            ctx.operation_suspend_point(&self);\n-            match self {\n-                UpdateCellOperation::InvalidateWhenCellDependency {\n-                    cell_ref,\n-                    ref mut dependent_tasks,\n-                    ref mut queue,\n-                } => {\n-                    if let Some(dependent_task_id) = dependent_tasks.pop() {\n-                        if ctx.is_once_task(dependent_task_id) {\n-                            // once tasks are never invalidated\n-                            continue;\n-                        }\n-                        let dependent = ctx.task(dependent_task_id, TaskDataCategory::All);\n-                        if dependent.has_key(&CachedDataItemKey::OutdatedCellDependency {\n-                            target: cell_ref,\n-                        }) {\n-                            // cell dependency is outdated, so it hasn't read the cell yet\n-                            // and doesn't need to be invalidated\n-                            continue;\n-                        }\n-                        if !dependent\n-                            .has_key(&CachedDataItemKey::CellDependency { target: cell_ref })\n-                        {\n-                            // cell dependency has been removed, so the task doesn't depend on the\n-                            // cell anymore and doesn't need to be\n-                            // invalidated\n-                            continue;\n-                        }\n-                        make_task_dirty_internal(\n-                            dependent,\n-                            dependent_task_id,\n-                            true,\n-                            #[cfg(feature = \"trace_task_dirty\")]\n-                            TaskDirtyCause::CellChange {\n-                                value_type: cell_ref.cell.type_id,\n-                            },\n-                            queue,\n-                            ctx,\n-                        );\n-                    }\n-                    if dependent_tasks.is_empty() {\n-                        self = UpdateCellOperation::AggregationUpdate { queue: take(queue) };\n-                    }\n-                }\n-                UpdateCellOperation::AggregationUpdate { ref mut queue } => {\n-                    if queue.process(ctx) {\n-                        self = UpdateCellOperation::Done\n-                    }\n-                }\n-                UpdateCellOperation::Done => {\n-                    return;\n-                }\n-            }\n-        }\n-    }\n-}"
        },
        {
            "sha": "96adf4aea88ee6b30cc847c25437956b30fb883a",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/update_output.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 23,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/c38833d10934d9b151016adcac0d322dbf360690/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c38833d10934d9b151016adcac0d322dbf360690/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fupdate_output.rs?ref=c38833d10934d9b151016adcac0d322dbf360690",
            "patch": "@@ -12,7 +12,7 @@ use crate::{\n         TaskDataCategory,\n         operation::{\n             AggregationUpdateQueue, ExecuteContext, Operation, TaskGuard,\n-            invalidate::make_task_dirty_internal,\n+            invalidate::{make_task_dirty, make_task_dirty_internal},\n         },\n         storage::{get, get_many},\n     },\n@@ -25,6 +25,7 @@ use crate::{\n #[derive(Serialize, Deserialize, Clone, Default)]\n pub enum UpdateOutputOperation {\n     MakeDependentTasksDirty {\n+        #[cfg(feature = \"trace_task_dirty\")]\n         task_id: TaskId,\n         dependent_tasks: SmallVec<[TaskId; 4]>,\n         children: SmallVec<[TaskId; 4]>,\n@@ -131,6 +132,7 @@ impl UpdateOutputOperation {\n         }\n \n         UpdateOutputOperation::MakeDependentTasksDirty {\n+            #[cfg(feature = \"trace_task_dirty\")]\n             task_id,\n             dependent_tasks,\n             children,\n@@ -146,35 +148,15 @@ impl Operation for UpdateOutputOperation {\n             ctx.operation_suspend_point(&self);\n             match self {\n                 UpdateOutputOperation::MakeDependentTasksDirty {\n+                    #[cfg(feature = \"trace_task_dirty\")]\n                     task_id,\n                     ref mut dependent_tasks,\n                     ref mut children,\n                     ref mut queue,\n                 } => {\n                     if let Some(dependent_task_id) = dependent_tasks.pop() {\n-                        if ctx.is_once_task(dependent_task_id) {\n-                            // once tasks are never invalidated\n-                            continue;\n-                        }\n-                        let dependent = ctx.task(dependent_task_id, TaskDataCategory::All);\n-                        if dependent.has_key(&CachedDataItemKey::OutdatedOutputDependency {\n-                            target: task_id,\n-                        }) {\n-                            // output dependency is outdated, so it hasn't read the output yet\n-                            // and doesn't need to be invalidated\n-                            continue;\n-                        }\n-                        if !dependent\n-                            .has_key(&CachedDataItemKey::OutputDependency { target: task_id })\n-                        {\n-                            // output dependency has been removed, so the task doesn't depend on the\n-                            // output anymore and doesn't need to be invalidated\n-                            continue;\n-                        }\n-                        make_task_dirty_internal(\n-                            dependent,\n+                        make_task_dirty(\n                             dependent_task_id,\n-                            true,\n                             #[cfg(feature = \"trace_task_dirty\")]\n                             TaskDirtyCause::OutputChange { task_id },\n                             queue,"
        }
    ],
    "stats": {
        "total": 216,
        "additions": 17,
        "deletions": 199
    }
}