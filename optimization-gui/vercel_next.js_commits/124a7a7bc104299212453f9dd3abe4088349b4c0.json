{
    "author": "eps1lon",
    "message": "[dev-overlay] Only warn once per invalid sourcemap (#77444)",
    "sha": "124a7a7bc104299212453f9dd3abe4088349b4c0",
    "files": [
        {
            "sha": "088cef0e2212d5d2bf7da8472a36e509101a4083",
            "filename": ".prettierignore",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/124a7a7bc104299212453f9dd3abe4088349b4c0/.prettierignore",
            "raw_url": "https://github.com/vercel/next.js/raw/124a7a7bc104299212453f9dd3abe4088349b4c0/.prettierignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.prettierignore?ref=124a7a7bc104299212453f9dd3abe4088349b4c0",
            "patch": "@@ -48,6 +48,7 @@ bench/nested-deps/components/**/*\n **/.tina/__generated__/**\n test/lib/amp-validator-wasm.js\n test/production/pages-dir/production/fixture/amp-validator-wasm.js\n+test/e2e/app-dir/server-source-maps/fixtures/default/app/bad-sourcemap/page.js\n test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/ignored.js\n test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/sourcemapped.js\n test/e2e/app-dir/server-source-maps/fixtures/default/external-pkg/sourcemapped.js"
        },
        {
            "sha": "930cd6856006966ded2a8e6c330ee046453fba6a",
            "filename": "packages/next/src/server/patch-error-inspect.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/124a7a7bc104299212453f9dd3abe4088349b4c0/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/124a7a7bc104299212453f9dd3abe4088349b4c0/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts?ref=124a7a7bc104299212453f9dd3abe4088349b4c0",
            "patch": "@@ -57,7 +57,7 @@ interface IgnoreableStackFrame extends StackFrame {\n \n type SourceMapCache = Map<\n   string,\n-  { map: SyncSourceMapConsumer; payload: ModernSourceMapPayload }\n+  null | { map: SyncSourceMapConsumer; payload: ModernSourceMapPayload }\n >\n \n function frameToString(frame: StackFrame): string {\n@@ -208,6 +208,9 @@ function getSourcemappedFrameIfPossible(\n       console.error(\n         `${sourceURL}: Invalid source map. Only conformant source maps can be used to find the original code. Cause: ${cause}`\n       )\n+      // If loading fails once, it'll fail every time.\n+      // So set the cache to avoid duplicate errors.\n+      sourceMapCache.set(frame.file, null)\n       // Don't even fall back to the bundler because it might be not as strict\n       // with regards to parsing and then we fail later once we consume the\n       // source map payload.\n@@ -235,12 +238,20 @@ function getSourcemappedFrameIfPossible(\n       console.error(\n         `${sourceURL}: Invalid source map. Only conformant source maps can be used to find the original code. Cause: ${cause}`\n       )\n+      // If creating the consumer fails once, it'll fail every time.\n+      // So set the cache to avoid duplicate errors.\n+      sourceMapCache.set(frame.file, null)\n       return createUnsourcemappedFrame(frame)\n     }\n     sourceMapCache.set(frame.file, {\n       map: sourceMapConsumer,\n       payload: sourceMapPayload,\n     })\n+  } else if (sourceMapCacheEntry === null) {\n+    // We failed earlier getting the payload or consumer.\n+    // Just return an unsourcemapped frame.\n+    // Errors will already be logged.\n+    return createUnsourcemappedFrame(frame)\n   } else {\n     sourceMapConsumer = sourceMapCacheEntry.map\n     sourceMapPayload = sourceMapCacheEntry.payload"
        },
        {
            "sha": "db57b0fa0d018b7197b1bd0eeb53a07fa7dd556c",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/app/bad-sourcemap/page.js",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/124a7a7bc104299212453f9dd3abe4088349b4c0/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fbad-sourcemap%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/124a7a7bc104299212453f9dd3abe4088349b4c0/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fbad-sourcemap%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fbad-sourcemap%2Fpage.js?ref=124a7a7bc104299212453f9dd3abe4088349b4c0",
            "patch": "@@ -1,10 +1,13 @@\n // Compile with pnpm tsc test/e2e/app-dir/server-source-maps/fixtures/default/bad-sourcemap/page.js --allowJs --sourceMap --target esnext --outDir test/e2e/app-dir/server-source-maps/fixtures/default/app/bad-sourcemap\n // Then change the `sources` entry in the sourcemap to `[\"custom://[badhost]/app/bad-sourcemap/page.js\"]`\n // tsc compile errors can be ignored\n-import { connection } from 'next/server'\n+import { connection } from 'next/server';\n+function logError() {\n+    console.error(new Error('Boom!'));\n+}\n export default async function Page() {\n-  await connection()\n-  console.error(new Error('Boom!'))\n-  return <p>Hello, Dave!</p>\n+    await connection();\n+    logError();\n+    return <p>Hello, Dave!</p>;\n }\n-//# sourceMappingURL=page.js.map\n+//# sourceMappingURL=page.js.map\n\\ No newline at end of file"
        },
        {
            "sha": "01681f5b5d2526b3935a57b0b9b38d5986b94cf3",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/app/bad-sourcemap/page.js.map",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/124a7a7bc104299212453f9dd3abe4088349b4c0/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fbad-sourcemap%2Fpage.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/124a7a7bc104299212453f9dd3abe4088349b4c0/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fbad-sourcemap%2Fpage.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fbad-sourcemap%2Fpage.js.map?ref=124a7a7bc104299212453f9dd3abe4088349b4c0",
            "patch": "@@ -6,5 +6,5 @@\n     \"custom://[badhost]/app/bad-sourcemap/page.js\"\n   ],\n   \"names\": [],\n-  \"mappings\": \"AAAA,yNAAyN;AACzN,yGAAyG;AACzG,oCAAoC;AAEpC,OAAO,EAAE,UAAU,EAAE,MAAM,aAAa,CAAA;AAExC,MAAM,CAAC,OAAO,CAAC,KAAK,UAAU,IAAI;IAChC,MAAM,UAAU,EAAE,CAAA;IAClB,OAAO,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,CAAA;IACjC,OAAO,CAAC,CAAC,CAAC,YAAY,EAAE,CAAC,CAAC,CAAA;AAC5B,CAAC\"\n+  \"mappings\": \"AAAA,yNAAyN;AACzN,yGAAyG;AACzG,oCAAoC;AAEpC,OAAO,EAAE,UAAU,EAAE,MAAM,aAAa,CAAA;AAExC,SAAS,QAAQ;IACf,OAAO,CAAC,KAAK,CAAC,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,CAAA;AACnC,CAAC;AAED,MAAM,CAAC,OAAO,CAAC,KAAK,UAAU,IAAI;IAChC,MAAM,UAAU,EAAE,CAAA;IAClB,QAAQ,EAAE,CAAA;IACV,OAAO,CAAC,CAAC,CAAC,YAAY,EAAE,CAAC,CAAC,CAAA;AAC5B,CAAC\"\n }"
        },
        {
            "sha": "f18e3b6d3c0130f12bb9124d40d20978cce80877",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/bad-sourcemap/page.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/124a7a7bc104299212453f9dd3abe4088349b4c0/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fbad-sourcemap%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/124a7a7bc104299212453f9dd3abe4088349b4c0/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fbad-sourcemap%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fbad-sourcemap%2Fpage.js?ref=124a7a7bc104299212453f9dd3abe4088349b4c0",
            "patch": "@@ -4,8 +4,12 @@\n \n import { connection } from 'next/server'\n \n+function logError() {\n+  console.error(new Error('Boom!'))\n+}\n+\n export default async function Page() {\n   await connection()\n-  console.error(new Error('Boom!'))\n+  logError()\n   return <p>Hello, Dave!</p>\n }"
        },
        {
            "sha": "593a3d99aaa6ac56f3469b5806e73c52dc82027f",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/124a7a7bc104299212453f9dd3abe4088349b4c0/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/124a7a7bc104299212453f9dd3abe4088349b4c0/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=124a7a7bc104299212453f9dd3abe4088349b4c0",
            "patch": "@@ -270,7 +270,8 @@ describe('app-dir - server source maps', () => {\n           // Node.js is fine with invalid URLs in index maps apparently.\n           '' +\n             '\\nError: Boom!' +\n-            '\\n    at Page (custom://[badhost]/app/bad-sourcemap/page.js:9:15)' +\n+            '\\n    at logError (custom://[badhost]/app/bad-sourcemap/page.js:8:16)' +\n+            '\\n    at Page (custom://[badhost]/app/bad-sourcemap/page.js:13:2)' +\n             // TODO: Remove blank line\n             '\\n'\n         )\n@@ -282,8 +283,15 @@ describe('app-dir - server source maps', () => {\n           '' +\n             `\\nwebpack-internal:///(rsc)/./app/bad-sourcemap/page.js: Invalid source map. Only conformant source maps can be used to find the original code. Cause: TypeError [ERR_INVALID_ARG_TYPE]: The \"payload\" argument must be of type object. Received null` +\n             '\\nError: Boom!' +\n-            '\\n    at Page (webpack-internal:///(rsc)/./app/bad-sourcemap/page.js:15:19)'\n+            '\\n    at logError (webpack-internal:///(rsc)/./app/bad-sourcemap/page.js:14:19)' +\n+            '\\n    at Page (webpack-internal:///(rsc)/./app/bad-sourcemap/page.js:18:5)'\n         )\n+        // Expect the invalid sourcemap warning only once.\n+        expect(\n+          normalizeCliOutput(next.cliOutput.slice(outputIndex)).split(\n+            'Invalid source map.'\n+          ).length - 1\n+        ).toEqual(1)\n       }\n     } else {\n       // TODO: test `next start` with `--enable-source-maps`"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 37,
        "deletions": 10
    }
}