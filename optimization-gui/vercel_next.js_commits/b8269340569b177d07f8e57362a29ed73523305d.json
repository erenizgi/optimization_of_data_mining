{
    "author": "sokra",
    "message": "Turbopack: write a LOG file for the database (#78650)\n\n### What?\n\nWrite a LOG file for the database to allow introspection and debugging",
    "sha": "b8269340569b177d07f8e57362a29ed73523305d",
    "files": [
        {
            "sha": "0c0fe6f3cb86f9f771df7612deb5254c418870b2",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 66,
            "deletions": 3,
            "changes": 69,
            "blob_url": "https://github.com/vercel/next.js/blob/b8269340569b177d07f8e57362a29ed73523305d/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/b8269340569b177d07f8e57362a29ed73523305d/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=b8269340569b177d07f8e57362a29ed73523305d",
            "patch": "@@ -1190,17 +1190,17 @@ dependencies = [\n \n [[package]]\n name = \"chrono\"\n-version = \"0.4.38\"\n+version = \"0.4.40\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"a21f936df1771bf62b77f047b726c4625ff2e8aa607c01ec06e5a05bd8463401\"\n+checksum = \"1a7964611d71df112cb1730f2ee67324fcf4d0fc6606acbbe9bfe06df124637c\"\n dependencies = [\n  \"android-tzdata\",\n  \"iana-time-zone\",\n  \"js-sys\",\n  \"num-traits\",\n  \"serde\",\n  \"wasm-bindgen\",\n- \"windows-targets 0.52.6\",\n+ \"windows-link\",\n ]\n \n [[package]]\n@@ -3562,6 +3562,47 @@ version = \"1.0.9\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"af150ab688ff2122fcef229be89cb50dd66af9e01a4ff320cc137eecc9bacc38\"\n \n+[[package]]\n+name = \"jiff\"\n+version = \"0.2.10\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"5a064218214dc6a10fbae5ec5fa888d80c45d611aba169222fc272072bf7aef6\"\n+dependencies = [\n+ \"jiff-static\",\n+ \"jiff-tzdb-platform\",\n+ \"log\",\n+ \"portable-atomic\",\n+ \"portable-atomic-util\",\n+ \"serde\",\n+ \"windows-sys 0.59.0\",\n+]\n+\n+[[package]]\n+name = \"jiff-static\"\n+version = \"0.2.10\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"199b7932d97e325aff3a7030e141eafe7f2c6268e1d1b24859b753a627f45254\"\n+dependencies = [\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn 2.0.100\",\n+]\n+\n+[[package]]\n+name = \"jiff-tzdb\"\n+version = \"0.1.4\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"c1283705eb0a21404d2bfd6eef2a7593d240bc42a0bdb39db0ad6fa2ec026524\"\n+\n+[[package]]\n+name = \"jiff-tzdb-platform\"\n+version = \"0.1.3\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"875a5a69ac2bab1a891711cf5eccbec1ce0341ea805560dcd90b7a2e925132e8\"\n+dependencies = [\n+ \"jiff-tzdb\",\n+]\n+\n [[package]]\n name = \"jni\"\n version = \"0.21.1\"\n@@ -5376,6 +5417,21 @@ dependencies = [\n  \"windows-sys 0.52.0\",\n ]\n \n+[[package]]\n+name = \"portable-atomic\"\n+version = \"1.11.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"350e9b48cbc6b0e028b0473b114454c6316e57336ee184ceab6e53f72c178b3e\"\n+\n+[[package]]\n+name = \"portable-atomic-util\"\n+version = \"0.2.4\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"d8a2f0d8d040d7848a709caf78912debcc3f33ee4b3cac47d73d1e1069e83507\"\n+dependencies = [\n+ \"portable-atomic\",\n+]\n+\n [[package]]\n name = \"portpicker\"\n version = \"0.1.1\"\n@@ -9261,6 +9317,7 @@ version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n  \"byteorder\",\n+ \"jiff\",\n  \"lzzzz\",\n  \"memmap2 0.9.5\",\n  \"parking_lot\",\n@@ -11488,6 +11545,12 @@ dependencies = [\n  \"syn 2.0.100\",\n ]\n \n+[[package]]\n+name = \"windows-link\"\n+version = \"0.1.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"76840935b766e1b0a05c0066835fb9ec80071d4c09a16f6bd5f7e655e3c14c38\"\n+\n [[package]]\n name = \"windows-result\"\n version = \"0.2.0\""
        },
        {
            "sha": "abd656d3fcb87b9254b2b68aecab47b105d8d19e",
            "filename": "turbopack/crates/turbo-persistence/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b8269340569b177d07f8e57362a29ed73523305d/turbopack%2Fcrates%2Fturbo-persistence%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/b8269340569b177d07f8e57362a29ed73523305d/turbopack%2Fcrates%2Fturbo-persistence%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2FCargo.toml?ref=b8269340569b177d07f8e57362a29ed73523305d",
            "patch": "@@ -14,6 +14,7 @@ print_stats = [\"stats\"]\n anyhow = { workspace = true }\n pot = \"3.0.0\"\n byteorder = \"1.5.0\"\n+jiff = \"0.2.10\"\n lzzzz = \"1.1.0\"\n memmap2 = \"0.9.5\"\n parking_lot = { workspace = true }"
        },
        {
            "sha": "22ffc6e538614fed8b78309b69ca8b4bdb26147b",
            "filename": "turbopack/crates/turbo-persistence/src/db.rs",
            "status": "modified",
            "additions": 79,
            "deletions": 3,
            "changes": 82,
            "blob_url": "https://github.com/vercel/next.js/blob/b8269340569b177d07f8e57362a29ed73523305d/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b8269340569b177d07f8e57362a29ed73523305d/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs?ref=b8269340569b177d07f8e57362a29ed73523305d",
            "patch": "@@ -2,7 +2,7 @@ use std::{\n     any::{Any, TypeId},\n     collections::HashSet,\n     fs::{self, File, OpenOptions, ReadDir},\n-    io::Write,\n+    io::{BufWriter, Write},\n     mem::{swap, transmute, MaybeUninit},\n     path::{Path, PathBuf},\n     sync::{\n@@ -13,6 +13,7 @@ use std::{\n \n use anyhow::{bail, Context, Result};\n use byteorder::{ReadBytesExt, WriteBytesExt, BE};\n+use jiff::Timestamp;\n use lzzzz::lz4::decompress;\n use memmap2::Mmap;\n use parking_lot::{Mutex, RwLock};\n@@ -287,6 +288,9 @@ impl TurboPersistence {\n                     Some(\"CURRENT\") => {\n                         // Already read\n                     }\n+                    Some(\"LOG\") => {\n+                        // Ignored, write-only\n+                    }\n                     _ => {\n                         if !path\n                             .file_name()\n@@ -393,6 +397,15 @@ impl TurboPersistence {\n         Ok(WriteBatch::new(self.path.clone(), current))\n     }\n \n+    fn open_log(&self) -> Result<BufWriter<File>> {\n+        let log_path = self.path.join(\"LOG\");\n+        let log_file = OpenOptions::new()\n+            .create(true)\n+            .append(true)\n+            .open(log_path)?;\n+        Ok(BufWriter::new(log_file))\n+    }\n+\n     /// Commits a WriteBatch to the database. This will finish writing the data to disk and make it\n     /// visible to readers.\n     pub fn commit_write_batch<K: StoreKey + Send + Sync + 'static, const FAMILIES: usize>(\n@@ -418,10 +431,12 @@ impl TurboPersistence {\n     fn commit(\n         &self,\n         mut new_sst_files: Vec<(u32, File)>,\n-        new_blob_files: Vec<File>,\n+        new_blob_files: Vec<(u32, File)>,\n         mut indicies_to_delete: Vec<usize>,\n         mut seq: u32,\n     ) -> Result<(), anyhow::Error> {\n+        let time = Timestamp::now();\n+\n         new_sst_files.sort_unstable_by_key(|(seq, _)| *seq);\n \n         let mut new_sst_files = new_sst_files\n@@ -432,10 +447,20 @@ impl TurboPersistence {\n             })\n             .collect::<Result<Vec<_>>>()?;\n \n-        for file in new_blob_files {\n+        for (_, file) in new_blob_files.iter() {\n             file.sync_all()?;\n         }\n \n+        let new_sst_info = new_sst_files\n+            .iter()\n+            .map(|sst| {\n+                let seq = sst.sequence_number();\n+                let range = sst.range()?;\n+                let size = sst.size();\n+                Ok((seq, range.family, range.min_hash, range.max_hash, size))\n+            })\n+            .collect::<Result<Vec<_>>>()?;\n+\n         if !indicies_to_delete.is_empty() {\n             seq += 1;\n         }\n@@ -479,6 +504,30 @@ impl TurboPersistence {\n             fs::remove_file(self.path.join(format!(\"{seq:08}.sst\")))?;\n         }\n \n+        {\n+            let mut log = self.open_log()?;\n+            writeln!(log, \"Time {}\", time)?;\n+            let span = time.until(Timestamp::now())?;\n+            writeln!(log, \"Commit {seq:08} {:#}\", span)?;\n+            for (index, family, min, max, size) in new_sst_info.iter() {\n+                writeln!(\n+                    log,\n+                    \"{:08} SST family:{} {:016x}-{:016x} {} MiB\",\n+                    index,\n+                    family,\n+                    min,\n+                    max,\n+                    size / 1024 / 1024\n+                )?;\n+            }\n+            for (seq, _) in new_blob_files.iter() {\n+                writeln!(log, \"{:08} BLOB\", seq)?;\n+            }\n+            for index in indicies_to_delete.iter() {\n+                writeln!(log, \"{:08} DELETED\", index)?;\n+            }\n+        }\n+\n         Ok(())\n     }\n \n@@ -583,6 +632,7 @@ impl TurboPersistence {\n         let value_block_cache = &self.value_block_cache;\n         let path = &self.path;\n \n+        let log_mutex = Mutex::new(());\n         let result = sst_by_family\n             .into_par_iter()\n             .with_min_len(1)\n@@ -604,6 +654,32 @@ impl TurboPersistence {\n                     },\n                 );\n \n+                if !merge_jobs.is_empty() {\n+                    let guard = log_mutex.lock();\n+                    let mut log = self.open_log()?;\n+                    writeln!(\n+                        log,\n+                        \"Compaction for family {family} (coverage: {coverage}):\"\n+                    )?;\n+                    for job in merge_jobs.iter() {\n+                        writeln!(log, \"  merge\")?;\n+                        for i in job.iter() {\n+                            let index = ssts_with_ranges[*i].index;\n+                            let (min, max) = ssts_with_ranges[*i].range();\n+                            writeln!(log, \"    {index:08} {min:016x}-{max:016x}\")?;\n+                        }\n+                    }\n+                    if !move_jobs.is_empty() {\n+                        writeln!(log, \"  move\")?;\n+                        for i in move_jobs.iter() {\n+                            let index = ssts_with_ranges[*i].index;\n+                            let (min, max) = ssts_with_ranges[*i].range();\n+                            writeln!(log, \"    {index:08} {min:016x}-{max:016x}\")?;\n+                        }\n+                    }\n+                    drop(guard);\n+                }\n+\n                 // Later we will remove the merged and moved files\n                 let indicies_to_delete = merge_jobs\n                     .iter()"
        },
        {
            "sha": "902fb917798d85bb202b9f4ec287ed13ca176b04",
            "filename": "turbopack/crates/turbo-persistence/src/static_sorted_file.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/b8269340569b177d07f8e57362a29ed73523305d/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b8269340569b177d07f8e57362a29ed73523305d/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file.rs?ref=b8269340569b177d07f8e57362a29ed73523305d",
            "patch": "@@ -138,6 +138,11 @@ impl StaticSortedFile {\n         self.sequence_number\n     }\n \n+    /// The size of this file in bytes.\n+    pub fn size(&self) -> usize {\n+        self.mmap.len()\n+    }\n+\n     /// Opens an SST file at the given path. This memory maps the file, but does not read it yet.\n     /// It's lazy read on demand.\n     pub fn open(sequence_number: u32, path: PathBuf) -> Result<Self> {"
        },
        {
            "sha": "09fa9553ef34dc968f69b21cb77baf7a890fc309",
            "filename": "turbopack/crates/turbo-persistence/src/write_batch.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/b8269340569b177d07f8e57362a29ed73523305d/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b8269340569b177d07f8e57362a29ed73523305d/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs?ref=b8269340569b177d07f8e57362a29ed73523305d",
            "patch": "@@ -31,16 +31,20 @@ struct ThreadLocalState<K: StoreKey + Send, const FAMILIES: usize> {\n     /// The collectors for each family.\n     collectors: [Option<Collector<K>>; FAMILIES],\n     /// The list of new SST files that have been created.\n+    /// Tuple of (sequence number, file).\n     new_sst_files: Vec<(u32, File)>,\n     /// The list of new blob files that have been created.\n-    new_blob_files: Vec<File>,\n+    /// Tuple of (sequence number, file).\n+    new_blob_files: Vec<(u32, File)>,\n }\n \n /// The result of a `WriteBatch::finish` operation.\n pub(crate) struct FinishResult {\n     pub(crate) sequence_number: u32,\n+    /// Tuple of (sequence number, file).\n     pub(crate) new_sst_files: Vec<(u32, File)>,\n-    pub(crate) new_blob_files: Vec<File>,\n+    /// Tuple of (sequence number, file).\n+    pub(crate) new_blob_files: Vec<(u32, File)>,\n }\n \n /// A write batch.\n@@ -121,7 +125,7 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n         } else {\n             let (blob, file) = self.create_blob(&value)?;\n             collector.put_blob(key, blob);\n-            state.new_blob_files.push(file);\n+            state.new_blob_files.push((blob, file));\n         }\n         Ok(())\n     }\n@@ -240,6 +244,7 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n     }\n \n     /// Creates a new blob file with the given value.\n+    /// Returns a tuple of (sequence number, file).\n     fn create_blob(&self, value: &[u8]) -> Result<(u32, File)> {\n         let seq = self.current_sequence_number.fetch_add(1, Ordering::SeqCst) + 1;\n         let mut buffer = Vec::new();\n@@ -256,6 +261,7 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n     }\n \n     /// Creates a new SST file with the given collector data.\n+    /// Returns a tuple of (sequence number, file).\n     fn create_sst_file(\n         &self,\n         family: u32,"
        }
    ],
    "stats": {
        "total": 169,
        "additions": 160,
        "deletions": 9
    }
}