{
    "author": "bgw",
    "message": "[devtools] Port cache invalidation logic from turbopack to webpack (#80184)\n\nWe want to support the \"reset bundler cache\" button in webpack/rspack. The webpack cache is a lot more stable, but it'd be good to have as a relative baseline once we have telemetry.\n\nWe don't use a persistent cache in rspack (it's an experimental feature). The reset button is incorrectly shown there, but I think that's fine for now. Clicking it just restarts the server.\n\n## Testing\n\n```\npnpm turbo build build-native\n```\n\nWebpack:\n\n```\npnpm next dev examples/basic-css\n```\n\nRspack:\n\n```\npnpm next dev examples/with-rspack\n```\n\nUsed the reset/restart buttons in the preferences UI:\n\n<img src=\"https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/HAZVitxRNnZz8QMiPn4a/0a007d96-d3f0-4617-a8ea-d98bdaee60dd.png\" width=500/>\n\nWatched the contents of `.next/cache/webpack` to verify the reset of the cache.",
    "sha": "d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
    "files": [
        {
            "sha": "5ee4727941ac5f244eb574fed6b8b8e98e6b54af",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -707,5 +707,6 @@\n   \"706\": \"Invariant: static responses cannot be streamed %s\",\n   \"707\": \"Invariant app-page handler received invalid cache entry %s\",\n   \"708\": \"Failed to persist Chrome DevTools workspace UUID. The Chrome DevTools Workspace needs to be reconnected after the next page reload.\",\n-  \"709\": \"`rspack.getModuleNamedExports` is not supported by the wasm bindings.\"\n+  \"709\": \"`rspack.getModuleNamedExports` is not supported by the wasm bindings.\",\n+  \"710\": \"Unable to remove an invalidated webpack cache. If this issue persists you can work around it by deleting %s\"\n }"
        },
        {
            "sha": "a04923c807abdbc32f34d3d97c7d2f6bae7aff61",
            "filename": "packages/next/src/build/define-env.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -289,8 +289,21 @@ export function getDefineEnv({\n       : {}),\n     'process.env.__NEXT_DEVTOOL_SEGMENT_EXPLORER':\n       config.experimental.devtoolSegmentExplorer ?? false,\n-    'process.env.__NEXT_TURBOPACK_PERSISTENT_CACHE':\n-      config.experimental.turbopackPersistentCaching ?? false,\n+\n+    // The devtools need to know whether or not to show an option to clear the\n+    // bundler cache. This option may be removed later once Turbopack's\n+    // persistent cache feature is more stable.\n+    //\n+    // This environment value is currently best-effort:\n+    // - It's possible to disable the webpack filesystem cache, but it's\n+    //   unlikely for a user to do that.\n+    // - Rspack's persistent cache is unstable and requires a different\n+    //   configuration than webpack to enable (which we don't do).\n+    //\n+    // In the worst case we'll show an option to clear the cache, but it'll be a\n+    // no-op that just restarts the development server.\n+    'process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE':\n+      !isTurbopack || (config.experimental.turbopackPersistentCaching ?? false),\n   }\n \n   const userDefines = config.compiler?.define ?? {}"
        },
        {
            "sha": "42662ffdd0647b2a57579bc3b1dcb6867ba434d0",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -289,6 +289,21 @@ export function hasExternalOtelApiPackage(): boolean {\n \n const UNSAFE_CACHE_REGEX = /[\\\\/]pages[\\\\/][^\\\\/]+(?:$|\\?|#)/\n \n+export function getCacheDirectories(\n+  configs: webpack.Configuration[]\n+): Set<string> {\n+  return new Set(\n+    configs\n+      .map((cfg) => {\n+        if (typeof cfg.cache === 'object' && cfg.cache.type === 'filesystem') {\n+          return cfg.cache.cacheDirectory\n+        }\n+        return null\n+      })\n+      .filter((dir) => dir != null)\n+  )\n+}\n+\n export default async function getBaseWebpackConfig(\n   dir: string,\n   {"
        },
        {
            "sha": "cc57abd911bcae6e75ff4e5f9935b012182a1b6e",
            "filename": "packages/next/src/build/webpack/cache-invalidation.ts",
            "status": "added",
            "additions": 96,
            "deletions": 0,
            "changes": 96,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fcache-invalidation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fcache-invalidation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fcache-invalidation.ts?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -0,0 +1,96 @@\n+import fs from 'node:fs/promises'\n+import path from 'node:path'\n+\n+const INVALIDATION_MARKER = '__nextjs_invalidated_cache'\n+\n+/**\n+ * Atomically write an invalidation marker.\n+ *\n+ * Because attempting to delete currently open cache files could cause issues,\n+ * actual deletion of files is deferred until the next start-up (in\n+ * `checkPersistentCacheInvalidationAndCleanup`).\n+ *\n+ * In the case that no database is currently open (e.g. via a separate CLI\n+ * subcommand), you should call `cleanupPersistentCache` *after* this to eagerly\n+ * remove the cache files.\n+ */\n+export async function invalidatePersistentCache(cacheDirectory: string) {\n+  let file\n+  try {\n+    // We're just opening it so that `open()` creates the file.\n+    file = await fs.open(path.join(cacheDirectory, INVALIDATION_MARKER), 'w')\n+    // We don't currently write anything to the file, but we could choose to\n+    // later, e.g. a reason for the invalidation.\n+  } catch (err: any) {\n+    // it's valid for the cache to not exist at all\n+    if (err.code !== 'ENOENT') {\n+      throw err\n+    }\n+  } finally {\n+    file?.close()\n+  }\n+}\n+\n+/**\n+ * Called during startup. See if the cache is in a partially-completed\n+ * invalidation state. Finds and delete any invalidated cache files.\n+ */\n+export async function checkPersistentCacheInvalidationAndCleanup(\n+  cacheDirectory: string\n+) {\n+  const invalidated = await fs\n+    .access(path.join(cacheDirectory, INVALIDATION_MARKER))\n+    .then(\n+      () => true,\n+      () => false\n+    )\n+  if (invalidated) {\n+    await cleanupPersistentCache(cacheDirectory)\n+  }\n+}\n+\n+/**\n+ * Helper for `checkPersistentCacheInvalidationAndCleanup`. You can call this to\n+ * explicitly clean up a database after running `invalidatePersistentCache` when\n+ * webpack is not running.\n+ *\n+ * You should not run this if the cache has not yet been invalidated, as this\n+ * operation is not atomic and could result in a partially-deleted and corrupted\n+ * database.\n+ */\n+async function cleanupPersistentCache(cacheDirectory: string) {\n+  try {\n+    await cleanupPersistentCacheInner(cacheDirectory)\n+  } catch (e) {\n+    // generate a user-friendly error message\n+    throw new Error(\n+      `Unable to remove an invalidated webpack cache. If this issue persists ` +\n+        `you can work around it by deleting ${cacheDirectory}`,\n+      { cause: e }\n+    )\n+  }\n+}\n+\n+async function cleanupPersistentCacheInner(cacheDirectory: string) {\n+  const files = await fs.readdir(cacheDirectory)\n+\n+  // delete everything except the invalidation marker\n+  await Promise.all(\n+    files.map((name) =>\n+      name !== INVALIDATION_MARKER\n+        ? fs.rm(path.join(cacheDirectory, name), {\n+            force: true, // ignore errors if path does not exist\n+            recursive: true,\n+            maxRetries: 2, // windows prevents deletion of open files\n+          })\n+        : null\n+    )\n+  )\n+\n+  // delete the invalidation marker last, once we're sure everything is cleaned\n+  // up\n+  await fs.rm(path.join(cacheDirectory, INVALIDATION_MARKER), {\n+    force: true,\n+    maxRetries: 2,\n+  })\n+}"
        },
        {
            "sha": "efbc908ed179fd5883ba97b64b94c93489b2f81a",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/dev-tools-info/user-preferences.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -66,10 +66,10 @@ export function UserPreferences({\n     setScale(value)\n   }\n \n-  function handleRestartDevServer() {\n+  function handleRestartDevServer(invalidatePersistentCache: boolean) {\n     let endpoint = '/__nextjs_restart_dev'\n \n-    if (process.env.__NEXT_TURBOPACK_PERSISTENT_CACHE) {\n+    if (invalidatePersistentCache) {\n       endpoint = '/__nextjs_restart_dev?invalidatePersistentCache'\n     }\n \n@@ -198,14 +198,16 @@ export function UserPreferences({\n               name=\"restart-dev-server\"\n               data-restart-dev-server\n               className=\"action-button\"\n-              onClick={handleRestartDevServer}\n+              onClick={() =>\n+                handleRestartDevServer(/*invalidatePersistentCache*/ false)\n+              }\n             >\n               <span>Restart</span>\n             </button>\n           </div>\n         </div>\n       </div>\n-      {process.env.__NEXT_TURBOPACK_PERSISTENT_CACHE ? (\n+      {process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE ? (\n         <div className=\"preferences-container\">\n           <div className=\"preference-section\">\n             <div className=\"preference-header\">\n@@ -222,7 +224,9 @@ export function UserPreferences({\n                 name=\"reset-bundler-cache\"\n                 data-reset-bundler-cache\n                 className=\"action-button\"\n-                onClick={handleRestartDevServer}\n+                onClick={() =>\n+                  handleRestartDevServer(/*invalidatePersistentCache*/ true)\n+                }\n               >\n                 <span>Reset Cache</span>\n               </button>"
        },
        {
            "sha": "0e6a643ba883e09fbd36587d5c4624e75552c6cb",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/restart-server-button.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -34,7 +34,7 @@ export function RestartServerButton({ error }: { error: Error }) {\n   function handleClick() {\n     let endpoint = '/__nextjs_restart_dev'\n \n-    if (process.env.__NEXT_TURBOPACK_PERSISTENT_CACHE) {\n+    if (process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE) {\n       endpoint = '/__nextjs_restart_dev?invalidatePersistentCache'\n     }\n \n@@ -52,7 +52,7 @@ export function RestartServerButton({ error }: { error: Error }) {\n       className=\"restart-dev-server-button\"\n       onClick={handleClick}\n       title={\n-        process.env.__NEXT_TURBOPACK_PERSISTENT_CACHE\n+        process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE\n           ? 'Clears the bundler cache and restarts the dev server. Helpful if you are seeing stale errors or changes are not appearing.'\n           : 'Restarts the development server without needing to leave the browser.'\n       }"
        },
        {
            "sha": "76cd34acca57f961363958c497995eed1f58ca1d",
            "filename": "packages/next/src/next-devtools/server/restart-dev-server-middleware.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 4,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Frestart-dev-server-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Frestart-dev-server-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Frestart-dev-server-middleware.ts?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -3,17 +3,20 @@ import type { Telemetry } from '../../telemetry/storage'\n import { RESTART_EXIT_CODE } from '../../server/lib/utils'\n import { middlewareResponse } from './middleware-response'\n import type { Project } from '../../build/swc/types'\n+import { invalidatePersistentCache as invalidateWebpackPersistentCache } from '../../build/webpack/cache-invalidation'\n \n const EVENT_DEV_OVERLAY_RESTART_SERVER = 'DEV_OVERLAY_RESTART_SERVER'\n \n interface RestartDevServerMiddlewareConfig {\n   telemetry: Telemetry\n   turbopackProject?: Project\n+  webpackCacheDirectories?: Set<string>\n }\n \n export function getRestartDevServerMiddleware({\n   telemetry,\n   turbopackProject,\n+  webpackCacheDirectories,\n }: RestartDevServerMiddlewareConfig) {\n   /**\n    * Some random value between 1 and Number.MAX_SAFE_INTEGER (inclusive). The same value is returned\n@@ -34,16 +37,25 @@ export function getRestartDevServerMiddleware({\n       return middlewareResponse.methodNotAllowed(res)\n     }\n \n-    const invalidatePersistentCache = searchParams.has(\n+    const shouldInvalidatePersistentCache = searchParams.has(\n       'invalidatePersistentCache'\n     )\n-    if (invalidatePersistentCache) {\n-      await turbopackProject?.invalidatePersistentCache()\n+    if (shouldInvalidatePersistentCache) {\n+      if (webpackCacheDirectories != null) {\n+        await Promise.all(\n+          Array.from(webpackCacheDirectories).map(\n+            invalidateWebpackPersistentCache\n+          )\n+        )\n+      }\n+      if (turbopackProject != null) {\n+        await turbopackProject.invalidatePersistentCache()\n+      }\n     }\n \n     telemetry.record({\n       eventName: EVENT_DEV_OVERLAY_RESTART_SERVER,\n-      payload: { invalidatePersistentCache },\n+      payload: { invalidatePersistentCache: shouldInvalidatePersistentCache },\n     })\n \n     // TODO: Use flushDetached"
        },
        {
            "sha": "87f91f1701d3dff02e207aa53111a2a4c9beae27",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -27,6 +27,7 @@ import {\n import { watchCompilers } from '../../build/output'\n import * as Log from '../../build/output/log'\n import getBaseWebpackConfig, {\n+  getCacheDirectories,\n   loadProjectInfo,\n } from '../../build/webpack-config'\n import { APP_DIR_ALIAS, WEBPACK_LAYERS } from '../../lib/constants'\n@@ -88,6 +89,7 @@ import { getDevOverlayFontMiddleware } from '../../next-devtools/server/font/get\n import { getDisableDevIndicatorMiddleware } from '../../next-devtools/server/dev-indicator-middleware'\n import getWebpackBundler from '../../shared/lib/get-webpack-bundler'\n import { getRestartDevServerMiddleware } from '../../next-devtools/server/restart-dev-server-middleware'\n+import { checkPersistentCacheInvalidationAndCleanup } from '../../build/webpack/cache-invalidation'\n \n const MILLISECONDS_IN_NANOSECOND = BigInt(1_000_000)\n \n@@ -1155,6 +1157,11 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     // @ts-ignore webpack 5\n     this.activeWebpackConfigs.parallelism = 1\n \n+    await Promise.all(\n+      Array.from(getCacheDirectories(this.activeWebpackConfigs)).map(\n+        checkPersistentCacheInvalidationAndCleanup\n+      )\n+    )\n     this.multiCompiler = getWebpackBundler()(\n       this.activeWebpackConfigs\n     ) as unknown as webpack.MultiCompiler\n@@ -1574,6 +1581,10 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       getDisableDevIndicatorMiddleware(),\n       getRestartDevServerMiddleware({\n         telemetry: this.telemetry,\n+        webpackCacheDirectories:\n+          this.activeWebpackConfigs != null\n+            ? getCacheDirectories(this.activeWebpackConfigs)\n+            : undefined,\n       }),\n     ]\n   }"
        },
        {
            "sha": "fc18af945299431902f3b9764e728a11e0d13680",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/db_invalidation.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d60157fc0b8f0c6b2caf189c0b24dae96e0e5683/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs?ref=d60157fc0b8f0c6b2caf189c0b24dae96e0e5683",
            "patch": "@@ -1,6 +1,6 @@\n use std::{\n     fs::{self, read_dir},\n-    io,\n+    io::{self, ErrorKind},\n     path::Path,\n };\n \n@@ -19,8 +19,12 @@ const INVALIDATION_MARKER: &str = \"__turbo_tasks_invalidated_db\";\n /// This should be run with the base (non-versioned) path, as that likely aligns closest with user\n /// expectations (e.g. if they're clearing the cache for disk space reasons).\n pub fn invalidate_db(base_path: &Path) -> anyhow::Result<()> {\n-    fs::write(base_path.join(INVALIDATION_MARKER), [0u8; 0])?;\n-    Ok(())\n+    match fs::write(base_path.join(INVALIDATION_MARKER), [0u8; 0]) {\n+        Ok(_) => Ok(()),\n+        // just ignore if the cache directory doesn't exist at all\n+        Err(err) if err.kind() == ErrorKind::NotFound => Ok(()),\n+        Err(err) => Err(err).context(\"Failed to invalidate database\"),\n+    }\n }\n \n /// Called during startup. See if the db is in a partially-completed invalidation state. Find and"
        }
    ],
    "stats": {
        "total": 190,
        "additions": 173,
        "deletions": 17
    }
}