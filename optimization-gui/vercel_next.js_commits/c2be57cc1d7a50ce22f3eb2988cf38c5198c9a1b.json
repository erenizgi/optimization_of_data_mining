{
    "author": "mischnic",
    "message": "Turbopack: pass current Node.js version from JS side instead of invoking node (#80949)",
    "sha": "c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
    "files": [
        {
            "sha": "ea704148b2a5453ec443d4cfe5e08852a7db5d7d",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -156,6 +156,9 @@ pub struct NapiProjectOptions {\n     /// local names for variables, functions etc., which can be useful for\n     /// debugging/profiling purposes.\n     pub no_mangling: bool,\n+\n+    /// The version of Node.js that is available/currently running.\n+    pub current_node_js_version: RcStr,\n }\n \n /// [NapiProjectOptions] with all fields optional.\n@@ -261,6 +264,7 @@ impl From<NapiProjectOptions> for ProjectOptions {\n             preview_props: val.preview_props.into(),\n             browserslist_query: val.browserslist_query,\n             no_mangling: val.no_mangling,\n+            current_node_js_version: val.current_node_js_version,\n         }\n     }\n }"
        },
        {
            "sha": "eb6b4cb6ce9436b4a77d9fe413e9f5d5b708ada0",
            "filename": "crates/next-api/benches/hmr.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-api%2Fbenches%2Fhmr.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-api%2Fbenches%2Fhmr.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fbenches%2Fhmr.rs?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -1,5 +1,4 @@\n use std::{\n-    env,\n     fs::{create_dir_all, write},\n     mem::forget,\n     path::{Path, PathBuf},\n@@ -182,10 +181,7 @@ impl HmrBenchmark {\n                 project_path: RcStr::from(project_path.clone()),\n                 next_config: load_next_config(),\n                 js_config: RcStr::from(\"{}\"),\n-                env: vec![(\n-                    RcStr::from(\"PATH\"),\n-                    RcStr::from(env::var(\"PATH\").unwrap_or_default()),\n-                )],\n+                env: vec![],\n                 define_env: DefineEnv {\n                     client: vec![],\n                     edge: vec![],\n@@ -205,6 +201,7 @@ impl HmrBenchmark {\n                 },\n                 browserslist_query: RcStr::from(\"last 2 versions\"),\n                 no_mangling: false,\n+                current_node_js_version: RcStr::from(\"18.0.0\"),\n             };\n \n             container.initialize(options).await?;"
        },
        {
            "sha": "5b4f26f3dbfe8d3d8834761dcb764dc997adf2f4",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -51,6 +51,7 @@ use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::AssetContext,\n     diagnostics::DiagnosticExt,\n+    environment::NodeJsVersion,\n     file_source::FileSource,\n     ident::Layer,\n     issue::{\n@@ -186,6 +187,9 @@ pub struct ProjectOptions {\n     /// local names for variables, functions etc., which can be useful for\n     /// debugging/profiling purposes.\n     pub no_mangling: bool,\n+\n+    /// The version of Node.js that is available/currently running.\n+    pub current_node_js_version: RcStr,\n }\n \n #[derive(\n@@ -442,6 +446,7 @@ impl ProjectContainer {\n         let preview_props;\n         let browserslist_query;\n         let no_mangling;\n+        let current_node_js_version;\n         {\n             let options = self.options_state.get();\n             let options = options\n@@ -464,7 +469,8 @@ impl ProjectContainer {\n             build_id = options.build_id.clone();\n             preview_props = options.preview_props.clone();\n             browserslist_query = options.browserslist_query.clone();\n-            no_mangling = options.no_mangling\n+            no_mangling = options.no_mangling;\n+            current_node_js_version = options.current_node_js_version.clone();\n         }\n \n         let dist_dir = next_config\n@@ -493,6 +499,7 @@ impl ProjectContainer {\n             encryption_key,\n             preview_props,\n             no_mangling,\n+            current_node_js_version,\n         }\n         .cell())\n     }\n@@ -570,6 +577,8 @@ pub struct Project {\n     /// local names for variables, functions etc., which can be useful for\n     /// debugging/profiling purposes.\n     no_mangling: bool,\n+\n+    current_node_js_version: RcStr,\n }\n \n #[turbo_tasks::value]\n@@ -737,6 +746,11 @@ impl Project {\n         *self.env\n     }\n \n+    #[turbo_tasks::function]\n+    pub(super) fn current_node_js_version(&self) -> Vc<NodeJsVersion> {\n+        NodeJsVersion::Static(ResolvedVc::cell(self.current_node_js_version.clone())).cell()\n+    }\n+\n     #[turbo_tasks::function]\n     pub(super) fn next_config(&self) -> Vc<NextConfig> {\n         *self.next_config\n@@ -974,10 +988,10 @@ impl Project {\n     pub(super) async fn server_compile_time_info(self: Vc<Self>) -> Result<Vc<CompileTimeInfo>> {\n         let this = self.await?;\n         Ok(get_server_compile_time_info(\n-            self.env(),\n-            this.define_env.nodejs(),\n             // `/ROOT` corresponds to `[project]/`, so we need exactly the `path` part.\n             format!(\"/ROOT/{}\", self.project_path().await?.path).into(),\n+            this.define_env.nodejs(),\n+            self.current_node_js_version(),\n         ))\n     }\n \n@@ -987,7 +1001,7 @@ impl Project {\n         Ok(get_edge_compile_time_info(\n             self.project_path(),\n             this.define_env.edge(),\n-            self.env(),\n+            self.current_node_js_version(),\n         ))\n     }\n "
        },
        {
            "sha": "caf36a0655f8bf4809cae8a34e34400be2951dc0",
            "filename": "crates/next-build-test/src/main.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-build-test%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-build-test%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-build-test%2Fsrc%2Fmain.rs?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -166,6 +166,7 @@ fn main() {\n                                      Safari versions, last 1 Edge versions\"\n                     .into(),\n                 no_mangling: false,\n+                current_node_js_version: \"18.0.0\".into(),\n             };\n \n             let json = serde_json::to_string_pretty(&options).unwrap();"
        },
        {
            "sha": "ad2861f773fc5e87622bd3428e9dd02ca5227d7b",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::Result;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{FxIndexMap, OptionVcExt, ResolvedVc, Vc};\n-use turbo_tasks_env::{EnvMap, ProcessEnv};\n+use turbo_tasks_env::EnvMap;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{css::chunk::CssChunkType, resolve_options_context::ResolveOptionsContext};\n use turbopack_browser::BrowserChunkingContext;\n@@ -83,16 +83,11 @@ async fn next_edge_free_vars(\n pub async fn get_edge_compile_time_info(\n     project_path: Vc<FileSystemPath>,\n     define_env: Vc<EnvMap>,\n-    process_env: Vc<Box<dyn ProcessEnv>>,\n+    node_version: ResolvedVc<NodeJsVersion>,\n ) -> Result<Vc<CompileTimeInfo>> {\n     CompileTimeInfo::builder(\n         Environment::new(ExecutionEnvironment::EdgeWorker(\n-            EdgeWorkerEnvironment {\n-                node_version: NodeJsVersion::resolved_cell(NodeJsVersion::Current(\n-                    process_env.to_resolved().await?,\n-                )),\n-            }\n-            .resolved_cell(),\n+            EdgeWorkerEnvironment { node_version }.resolved_cell(),\n         ))\n         .to_resolved()\n         .await?,"
        },
        {
            "sha": "1e298bb9f658d4790fa65d0d0441a07f847af097",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -3,7 +3,7 @@ use std::iter::once;\n use anyhow::{Result, bail};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{FxIndexMap, OptionVcExt, ResolvedVc, TaskInput, Vc};\n-use turbo_tasks_env::{EnvMap, ProcessEnv};\n+use turbo_tasks_env::EnvMap;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::{\n     css::chunk::CssChunkType,\n@@ -381,17 +381,15 @@ async fn next_server_free_vars(define_env: Vc<EnvMap>) -> Result<Vc<FreeVarRefer\n \n #[turbo_tasks::function]\n pub async fn get_server_compile_time_info(\n-    process_env: Vc<Box<dyn ProcessEnv>>,\n-    define_env: Vc<EnvMap>,\n     cwd: RcStr,\n+    define_env: Vc<EnvMap>,\n+    node_version: ResolvedVc<NodeJsVersion>,\n ) -> Result<Vc<CompileTimeInfo>> {\n     CompileTimeInfo::builder(\n         Environment::new(ExecutionEnvironment::NodeJsLambda(\n             NodeJsEnvironment {\n                 compile_target: CompileTarget::current().to_resolved().await?,\n-                node_version: NodeJsVersion::resolved_cell(NodeJsVersion::Current(\n-                    process_env.to_resolved().await?,\n-                )),\n+                node_version,\n                 cwd: ResolvedVc::cell(Some(cwd)),\n             }\n             .resolved_cell(),"
        },
        {
            "sha": "e944b8dcc85ceee121c029d370b1e6b7273392be",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -136,6 +136,8 @@ export interface NapiProjectOptions {\n    * debugging/profiling purposes.\n    */\n   noMangling: boolean\n+  /** The version of Node.js that is available/currently running. */\n+  currentNodeJsVersion: RcStr\n }\n /** [NapiProjectOptions] with all fields optional. */\n export interface NapiPartialProjectOptions {"
        },
        {
            "sha": "ce72f44629ce090664229c3e9ba7107e3a176d45",
            "filename": "packages/next/src/build/swc/types.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -423,6 +423,11 @@ export interface ProjectOptions {\n    * debugging/profiling purposes.\n    */\n   noMangling: boolean\n+\n+  /**\n+   * The version of Node.js that is available/currently running.\n+   */\n+  currentNodeJsVersion: string\n }\n \n export interface DefineEnv {"
        },
        {
            "sha": "a67d6bd2787d5e8cc362b4c7aa822de26eef9e42",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -43,6 +43,7 @@ export async function turbopackBuild(): Promise<{\n   const rewrites = NextBuildContext.rewrites!\n   const appDirOnly = NextBuildContext.appDirOnly!\n   const noMangling = NextBuildContext.noMangling!\n+  const currentNodeJsVersion = process.versions.node\n \n   const startTime = process.hrtime()\n   const bindings = await loadBindings(config?.experimental?.useWasmBinary)\n@@ -80,6 +81,7 @@ export async function turbopackBuild(): Promise<{\n       previewProps,\n       browserslistQuery: supportedBrowsers.join(', '),\n       noMangling,\n+      currentNodeJsVersion,\n     },\n     {\n       persistentCaching,"
        },
        {
            "sha": "f42df48b190347fae44685b6218590bbc8bf7a6a",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -210,6 +210,8 @@ export async function createHotReloaderTurbopack(\n     'last 1 Chrome versions, last 1 Firefox versions, last 1 Safari versions, last 1 Edge versions',\n   ]\n \n+  const currentNodeJsVersion = process.versions.node\n+\n   const project = await bindings.turbo.createProject(\n     {\n       projectPath: projectPath,\n@@ -243,6 +245,7 @@ export async function createHotReloaderTurbopack(\n       previewProps: opts.fsChecker.prerenderManifest.preview,\n       browserslistQuery: supportedBrowsers.join(', '),\n       noMangling: false,\n+      currentNodeJsVersion,\n     },\n     {\n       persistentCaching: isPersistentCachingEnabled(opts.nextConfig),"
        },
        {
            "sha": "bc51d3eed7c8677a8db42dc93955b4f379601bd1",
            "filename": "test/development/basic/next-rs-api.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -197,9 +197,7 @@ describe('next.rs api', () => {\n       '.next'\n     )\n     project = await bindings.turbo.createProject({\n-      env: {\n-        PATH: process.env.PATH,\n-      },\n+      env: {},\n       jsConfig: {\n         compilerOptions: {},\n       },\n@@ -233,6 +231,7 @@ describe('next.rs api', () => {\n       },\n       browserslistQuery: 'last 2 versions',\n       noMangling: false,\n+      currentNodeJsVersion: '18.0.0',\n     })\n     projectUpdateSubscription = filterMapAsyncIterator(\n       project.updateInfoSubscribe(1000),"
        },
        {
            "sha": "7b9c8d525d4d99b7fb392a504d072864ad2eda2c",
            "filename": "turbopack/crates/turbopack-core/src/environment.rs",
            "status": "modified",
            "additions": 35,
            "deletions": 11,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs?ref=c2be57cc1d7a50ce22f3eb2988cf38c5198c9a1b",
            "patch": "@@ -3,7 +3,7 @@ use std::{\n     str::FromStr,\n };\n \n-use anyhow::{Context, Result, anyhow};\n+use anyhow::{Context, Result, anyhow, bail};\n use browserslist::Distrib;\n use swc_core::ecma::preset_env::{Version, Versions};\n use turbo_rcstr::{RcStr, rcstr};\n@@ -12,7 +12,7 @@ use turbo_tasks_env::ProcessEnv;\n \n use crate::target::CompileTarget;\n \n-static DEFAULT_NODEJS_VERSION: &str = \"16.0.0\";\n+static DEFAULT_NODEJS_VERSION: &str = \"18.0.0\";\n \n #[turbo_tasks::value]\n #[derive(Clone, Copy, Default, Hash, TaskInput, Debug)]\n@@ -283,7 +283,8 @@ impl NodeJsEnvironment {\n \n         Ok(Vc::cell(Versions {\n             node: Some(\n-                Version::from_str(&str).map_err(|_| anyhow!(\"Node.js version parse error\"))?,\n+                Version::from_str(&str)\n+                    .map_err(|_| anyhow!(\"Failed to parse Node.js version: '{}'\", str))?,\n             ),\n             ..Default::default()\n         }))\n@@ -303,7 +304,9 @@ impl NodeJsEnvironment {\n \n #[turbo_tasks::value(shared)]\n pub enum NodeJsVersion {\n+    /// Use the version of Node.js that is available from the environment (via `node --version`)\n     Current(ResolvedVc<Box<dyn ProcessEnv>>),\n+    /// Use the specified version of Node.js.\n     Static(ResolvedVc<RcStr>),\n }\n \n@@ -323,6 +326,9 @@ pub struct BrowserEnvironment {\n \n #[turbo_tasks::value(shared)]\n pub struct EdgeWorkerEnvironment {\n+    // This isn't actually the Edge's worker environment, but we have to use some kind of version\n+    // for transpiling ECMAScript features. No tool supports Edge Workers as a separate\n+    // environment.\n     pub node_version: ResolvedVc<NodeJsVersion>,\n }\n \n@@ -360,12 +366,30 @@ pub async fn get_current_nodejs_version(env: Vc<Box<dyn ProcessEnv>>) -> Result<\n     cmd.stdin(Stdio::piped());\n     cmd.stdout(Stdio::piped());\n \n-    Ok(Vc::cell(\n-        String::from_utf8(cmd.output()?.stdout)?\n-            .strip_prefix('v')\n-            .context(\"Version must begin with v\")?\n-            .strip_suffix('\\n')\n-            .context(\"Version must end with \\\\n\")?\n-            .into(),\n-    ))\n+    let output = cmd.output()?;\n+\n+    if !output.status.success() {\n+        bail!(\n+            \"'node --version' command failed{}{}\",\n+            output\n+                .status\n+                .code()\n+                .map(|c| format!(\" with exit code {c}\"))\n+                .unwrap_or_default(),\n+            String::from_utf8(output.stderr)\n+                .map(|stderr| format!(\": {stderr}\"))\n+                .unwrap_or_default()\n+        );\n+    }\n+\n+    let version = String::from_utf8(output.stdout)\n+        .context(\"failed to parse 'node --version' output as utf8\")?;\n+    if let Some(version_number) = version.strip_prefix(\"v\") {\n+        Ok(Vc::cell(version_number.trim().into()))\n+    } else {\n+        bail!(\n+            \"Expected 'node --version' to return a version starting with 'v', but received: '{}'\",\n+            version\n+        )\n+    }\n }"
        }
    ],
    "stats": {
        "total": 118,
        "additions": 81,
        "deletions": 37
    }
}