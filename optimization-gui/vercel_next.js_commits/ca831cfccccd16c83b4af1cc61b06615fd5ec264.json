{
    "author": "ztanner",
    "message": "test: fix actions deployment tests (#87279)\n\nFixes a few failing deployment tests that weren't validated when landed\nlast week.\n\n- next.cliOutput is not available when deployed because it's part of\nruntime logs\n- status code changes on Vercel because POSTing to a static 404 page is\ntreated differently.",
    "sha": "ca831cfccccd16c83b4af1cc61b06615fd5ec264",
    "files": [
        {
            "sha": "6a005fd5b34f26f740d4956c00a8bd451f595fa1",
            "filename": "test/e2e/app-dir/actions-unrecognized/actions-unrecognized.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/ca831cfccccd16c83b4af1cc61b06615fd5ec264/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ca831cfccccd16c83b4af1cc61b06615fd5ec264/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts?ref=ca831cfccccd16c83b4af1cc61b06615fd5ec264",
            "patch": "@@ -82,7 +82,7 @@ describe('unrecognized server actions', () => {\n     )\n   }\n \n-  it('should 404 when POSTing a urlencoded action to a nonexistent page', async () => {\n+  it('should error when POSTing a urlencoded action to a nonexistent page', async () => {\n     const res = await next.fetch('/non-existent-route', {\n       method: 'POST',\n       headers: {\n@@ -92,7 +92,8 @@ describe('unrecognized server actions', () => {\n       body: 'foo=bar',\n     })\n \n-    expect(res.status).toBe(404)\n+    // On Vercel, this would hit the 404 route which is a static page, and returns a 405 instead.\n+    expect(res.status).toBe(isNextDeploy ? 405 : 404)\n   })\n \n   describe.each(['nodejs', 'edge'])("
        },
        {
            "sha": "f384c9dc5c4c3294983cf0d11474089091fa7bab",
            "filename": "test/e2e/app-dir/no-server-actions/no-server-actions.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 10,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/ca831cfccccd16c83b4af1cc61b06615fd5ec264/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fno-server-actions.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ca831cfccccd16c83b4af1cc61b06615fd5ec264/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fno-server-actions.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fno-server-actions%2Fno-server-actions.test.ts?ref=ca831cfccccd16c83b4af1cc61b06615fd5ec264",
            "patch": "@@ -1,11 +1,11 @@\n import { nextTestSetup } from 'e2e-utils'\n \n describe('app-dir - no server actions', () => {\n-  const { next } = nextTestSetup({\n+  const { next, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n   })\n \n-  it('should 404 when triggering a fetch action on an app with no server actions', async () => {\n+  it('should error when triggering a fetch action on an app with no server actions', async () => {\n     const res = await next.fetch('/', {\n       method: 'POST',\n       headers: {\n@@ -15,28 +15,36 @@ describe('app-dir - no server actions', () => {\n \n     expect(res.status).toBe(404)\n     expect(res.headers.get('x-nextjs-action-not-found')).toBe('1')\n-    expect(next.cliOutput).toContain(\n-      'Failed to find Server Action \"abc123\". This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action'\n-    )\n+\n+    // Runtime logs and custom headers are not forwarded to the client when deployed.\n+    if (!isNextDeploy) {\n+      expect(next.cliOutput).toContain(\n+        'Failed to find Server Action \"abc123\". This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action'\n+      )\n+    }\n   })\n \n-  it('should 404 when triggering an MPA action on an app with no server actions', async () => {\n+  it('should error when triggering an MPA action on an app with no server actions', async () => {\n     const formData = new FormData()\n     formData.append('test', 'value')\n \n     const res = await next.fetch('/', {\n       method: 'POST',\n       headers: {\n-        'Content-Type': 'multipart/form-data',\n+        'Content-Type': 'multipart/form-data; boundary=test',\n       },\n       // @ts-expect-error: node-fetch types don't seem to like FormData\n       body: formData,\n     })\n \n     expect(res.status).toBe(404)\n     expect(res.headers.get('x-nextjs-action-not-found')).toBe('1')\n-    expect(next.cliOutput).toContain(\n-      'Failed to find Server Action. This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action'\n-    )\n+\n+    // Runtime logs are not available when deployed.\n+    if (!isNextDeploy) {\n+      expect(next.cliOutput).toContain(\n+        'Failed to find Server Action. This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action'\n+      )\n+    }\n   })\n })"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 21,
        "deletions": 12
    }
}