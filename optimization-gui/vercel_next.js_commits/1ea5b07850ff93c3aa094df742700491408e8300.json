{
    "author": "timneutkens",
    "message": "Remove loadConfig from main development process, pass value from child process (#88230)\n\n## Eliminate duplicate `loadConfig` calls during development server\nstartup\n\n### What?\n\nRemove duplicate `loadConfig` calls from the parent process\n(`next-dev.ts`) by passing `distDir` via IPC from the child process\nwhere config is already loaded.\n\n### Why?\n\nPreviously, when booting the development server:\n\n1. The **child process** (`start-server.ts` → `router-server.ts`) would\ncall `loadConfig` to get the full configuration for the actual server\n2. The **parent process** (`next-dev.ts`) would also call `loadConfig`\nseparately just to access `config.distDir` for telemetry and trace\nuploads\n\nSince these are separate processes, the in-memory config cache couldn't\nbe shared, resulting in redundant config loading work.\n\n### How?\n\nExtended the existing IPC messaging to include `distDir` when the child\nprocess sends `nextServerReady`:\n\n```\nParent (next-dev.ts)         Child (start-server.ts → router-server.ts)\n        |                                    |\n        |-------- fork() ------------------>|\n        |<------- nextWorkerReady ----------|\n        |-------- nextWorkerOptions ------->|\n        |                                   | loadConfig() ← only called here now\n        |<-- nextServerReady + distDir -----|\n        |                                    |\n   Store distDir for                         \n   telemetry/trace uploads                   \n```\n\n**Changes:**\n\n- **`render-server.ts`**: Added `distDir` to `ServerInitResult` type\n- **`router-server.ts`**: Return `config.distDir` in `initialize()`\nresult and pass to render server opts\n- **`start-server.ts`**: Return `distDir` from `startServer()` and\ninclude it in IPC message\n- **`next-dev.ts`**: Receive `distDir` from IPC, remove both\n`loadConfig` calls, use `distDir` directly for telemetry/trace",
    "sha": "1ea5b07850ff93c3aa094df742700491408e8300",
    "files": [
        {
            "sha": "a0f23e6d12b73b67f94b729dcfa2a5ebf7ff00db",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 37,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/1ea5b07850ff93c3aa094df742700491408e8300/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1ea5b07850ff93c3aa094df742700491408e8300/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=1ea5b07850ff93c3aa094df742700491408e8300",
            "patch": "@@ -16,12 +16,9 @@ import {\n } from '../server/lib/utils'\n import * as Log from '../build/output/log'\n import { getProjectDir } from '../lib/get-project-dir'\n-import { PHASE_DEVELOPMENT_SERVER } from '../shared/lib/constants'\n import path from 'path'\n-import type { NextConfigComplete } from '../server/config-shared'\n import { traceGlobals } from '../trace/shared'\n import { Telemetry } from '../telemetry/storage'\n-import loadConfig from '../server/config'\n import { findPagesDir } from '../lib/find-pages-dir'\n import { fileExists, FileType } from '../lib/file-exists'\n import { getNpxCommand } from '../lib/helpers/get-npx-command'\n@@ -40,11 +37,7 @@ import { once } from 'node:events'\n import { clearTimeout } from 'timers'\n import { flushAllTraces, trace } from '../trace'\n import { traceId } from '../trace/shared'\n-import {\n-  Bundler,\n-  finalizeBundlerFromConfig,\n-  parseBundlerArgs,\n-} from '../lib/bundler'\n+import { Bundler, parseBundlerArgs } from '../lib/bundler'\n \n export type NextDevOptions = {\n   disableSourceMaps: boolean\n@@ -68,9 +61,9 @@ type PortSource = 'cli' | 'default' | 'env'\n \n let dir: string\n let child: undefined | ChildProcess\n-// The config in next-dev is only used to access config.distDir for telemetry and trace.\n-let config: NextConfigComplete\n-let bundler: Bundler\n+// distDir is received from the child process via IPC, used for telemetry and trace.\n+let distDir: string | undefined\n+let isTurbopack: boolean\n let traceUploadUrl: string\n let sessionStopHandled = false\n const sessionStarted = Date.now()\n@@ -124,24 +117,18 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n       pagesDir = !!pagesResult.pagesDir\n     }\n \n-    config =\n-      config ||\n-      (await loadConfig(PHASE_DEVELOPMENT_SERVER, dir, { silent: true }))\n-\n     let telemetry =\n       (traceGlobals.get('telemetry') as InstanceType<\n         typeof import('../telemetry/storage').Telemetry\n       >) ||\n       new Telemetry({\n-        distDir: path.join(dir, config.distDir),\n+        distDir: path.join(dir, distDir || '.next'),\n       })\n-    // Reading the config can modify environment variables that influence the bundler selection.\n-    bundler = finalizeBundlerFromConfig(bundler)\n \n     telemetry.record(\n       eventCliSessionStopped({\n         cliCommand: 'dev',\n-        turboFlag: bundler === Bundler.Turbopack,\n+        turboFlag: isTurbopack,\n         durationMilliseconds: Date.now() - sessionStarted,\n         pagesDir,\n         appDir,\n@@ -154,13 +141,13 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n     // noise to the output\n   }\n \n-  if (traceUploadUrl) {\n+  if (traceUploadUrl && distDir) {\n     uploadTrace({\n       traceUploadUrl,\n       mode: 'dev',\n       projectDir: dir,\n-      distDir: config.distDir,\n-      isTurboSession: bundler === Bundler.Turbopack,\n+      distDir,\n+      isTurboSession: isTurbopack,\n     })\n   }\n \n@@ -185,7 +172,9 @@ const nextDev = async (\n   portSource: PortSource,\n   directory?: string\n ) => {\n-  bundler = parseBundlerArgs(options)\n+  // Note: parseBundlerArgs can only decide on Turbopack or webpack.\n+  // Rspack can be configured via next.config.js but next.config.js is not loaded in the main process, only in the child process.\n+  isTurbopack = parseBundlerArgs(options) === Bundler.Turbopack\n \n   dir = getProjectDir(process.env.NEXT_PRIVATE_DEV_DIR || directory)\n \n@@ -315,9 +304,7 @@ const nextDev = async (\n         stdio: 'inherit',\n         env: {\n           ...defaultEnv,\n-          ...(bundler === Bundler.Turbopack\n-            ? { TURBOPACK: process.env.TURBOPACK }\n-            : undefined),\n+          ...(isTurbopack ? { TURBOPACK: process.env.TURBOPACK } : undefined),\n           NEXT_PRIVATE_WORKER: '1',\n           NEXT_PRIVATE_TRACE_ID: traceId,\n           NODE_EXTRA_CA_CERTS: startServerOptions.selfSignedCertificate\n@@ -350,6 +337,10 @@ const nextDev = async (\n               // it can be re-used on automatic dev server restarts.\n               port = parseInt(msg.port, 10)\n             }\n+            if (msg.distDir) {\n+              // Store the distDir from the child process for telemetry and trace uploads.\n+              distDir = msg.distDir\n+            }\n \n             resolved = true\n             resolve()\n@@ -365,21 +356,13 @@ const nextDev = async (\n           // Starting the dev server will overwrite the `.next/trace` file, so we\n           // must upload the existing contents before restarting the server to\n           // preserve the metrics.\n-          if (traceUploadUrl) {\n-            // Postpone loading next config when we need to get\n-            //  config.distDir for upload trace.\n-            config =\n-              config ||\n-              (await loadConfig(PHASE_DEVELOPMENT_SERVER, dir, {\n-                silent: true,\n-              }))\n-            bundler = finalizeBundlerFromConfig(bundler)\n+          if (traceUploadUrl && distDir) {\n             uploadTrace({\n               traceUploadUrl,\n               mode: 'dev',\n               projectDir: dir,\n-              distDir: config.distDir,\n-              isTurboSession: bundler === Bundler.Turbopack,\n+              distDir,\n+              isTurboSession: isTurbopack,\n               sync: true,\n             })\n           }"
        },
        {
            "sha": "37d5599dc012b1c12ce2240762c0d952badfab9f",
            "filename": "packages/next/src/server/lib/render-server.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1ea5b07850ff93c3aa094df742700491408e8300/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1ea5b07850ff93c3aa094df742700491408e8300/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts?ref=1ea5b07850ff93c3aa094df742700491408e8300",
            "patch": "@@ -15,6 +15,8 @@ export type ServerInitResult = {\n   server: NextServer\n   // Make an effort to close upgraded HTTP requests (e.g. Turbopack HMR websockets)\n   closeUpgraded: () => void\n+  // The distDir from config, used by the parent process for telemetry/trace\n+  distDir: string\n }\n \n let initializations: Record<string, Promise<ServerInitResult> | undefined> = {}\n@@ -91,6 +93,7 @@ async function initializeImpl(opts: {\n   startServerSpan: Span | undefined\n   quiet?: boolean\n   onDevServerCleanup: ((listener: () => Promise<void>) => void) | undefined\n+  distDir: string\n }): Promise<ServerInitResult> {\n   const type = process.env.__NEXT_PRIVATE_RENDER_WORKER\n   if (type) {\n@@ -166,6 +169,7 @@ async function initializeImpl(opts: {\n     closeUpgraded() {\n       opts.bundlerService?.close()\n     },\n+    distDir: opts.distDir,\n   }\n }\n "
        },
        {
            "sha": "45278189b79da511592352e905cb67c3544c2ae1",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1ea5b07850ff93c3aa094df742700491408e8300/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1ea5b07850ff93c3aa094df742700491408e8300/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=1ea5b07850ff93c3aa094df742700491408e8300",
            "patch": "@@ -727,6 +727,7 @@ export async function initialize(opts: {\n     startServerSpan: opts.startServerSpan,\n     quiet: opts.quiet,\n     onDevServerCleanup: opts.onDevServerCleanup,\n+    distDir: config.distDir,\n   }\n   renderServerOpts.serverFields.routerServerHandler = requestHandlerImpl\n \n@@ -898,5 +899,6 @@ export async function initialize(opts: {\n     closeUpgraded() {\n       development?.bundler?.hotReloader?.close()\n     },\n+    distDir: config.distDir,\n   }\n }"
        },
        {
            "sha": "4458368a632e28720b7f799c2a1d038a80217c8a",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/1ea5b07850ff93c3aa094df742700491408e8300/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1ea5b07850ff93c3aa094df742700491408e8300/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=1ea5b07850ff93c3aa094df742700491408e8300",
            "patch": "@@ -166,9 +166,13 @@ export async function getRequestHandlers({\n   })\n }\n \n+export type StartServerResult = {\n+  distDir: string\n+}\n+\n export async function startServer(\n   serverOptions: StartServerOptions\n-): Promise<void> {\n+): Promise<StartServerResult> {\n   const {\n     dir,\n     isDev,\n@@ -301,7 +305,7 @@ export async function startServer(\n \n   let cleanupListeners = isDev ? new AsyncCallbackSet() : undefined\n \n-  await new Promise<void>((resolve) => {\n+  const distDir = await new Promise<string>((resolve) => {\n     server.on('listening', async () => {\n       const addr = server.address()\n       const actualHostname = formatHostname(\n@@ -482,14 +486,14 @@ export async function startServer(\n             configPhase: PHASE_DEVELOPMENT_SERVER,\n           })\n         }\n+\n+        resolve(initResult.distDir)\n       } catch (err) {\n         // fatal error if we can't setup\n         handlersError()\n         console.error(err)\n         process.exit(1)\n       }\n-\n-      resolve()\n     })\n     server.listen(port, hostname)\n   })\n@@ -521,6 +525,8 @@ export async function startServer(\n       process.exit(RESTART_EXIT_CODE)\n     })\n   }\n+\n+  return { distDir }\n }\n \n if (process.env.NEXT_PRIVATE_WORKER && process.send) {\n@@ -538,7 +544,7 @@ if (process.env.NEXT_PRIVATE_WORKER && process.send) {\n         'memory.totalMem': String(os.totalmem()),\n         'memory.heapSizeLimit': String(v8.getHeapStatistics().heap_size_limit),\n       })\n-      await startServerSpan.traceAsyncFn(() =>\n+      const result = await startServerSpan.traceAsyncFn(() =>\n         startServer(msg.nextWorkerOptions)\n       )\n       const memoryUsage = process.memoryUsage()\n@@ -551,7 +557,11 @@ if (process.env.NEXT_PRIVATE_WORKER && process.send) {\n         'memory.heapUsed',\n         String(memoryUsage.heapUsed)\n       )\n-      process.send({ nextServerReady: true, port: process.env.PORT })\n+      process.send({\n+        nextServerReady: true,\n+        port: process.env.PORT,\n+        distDir: result.distDir,\n+      })\n     }\n   })\n   process.send({ nextWorkerReady: true })"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 42,
        "deletions": 43
    }
}