{
    "author": "timneutkens",
    "message": "Turbopack: Don't convert script to module when using preset-env (#80724)\n\nBoth swc's `preset_env` and the\n`crates/next-core/src/next_shared/transforms/next_track_dynamic_imports.rs`\nwere using the `Program::{Module, Script}` type to determine whether to\ninsert CJS requires or ESM imports.\n\nRemove the normaliziation of modules to scripts to allow these\ntransforms to insert the right type of import.",
    "sha": "036b95767621d12227a7635de1f289db189db15d",
    "files": [
        {
            "sha": "00b73e159cf4a80d18b9868f8e4d5db3abbe386a",
            "filename": "turbopack/crates/turbopack-ecmascript/src/transform/mod.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 26,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/036b95767621d12227a7635de1f289db189db15d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/036b95767621d12227a7635de1f289db189db15d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs?ref=036b95767621d12227a7635de1f289db189db15d",
            "patch": "@@ -6,9 +6,9 @@ use rustc_hash::FxHashMap;\n use swc_core::{\n     atoms::{Atom, atom},\n     base::SwcComments,\n-    common::{Mark, SourceMap, comments::Comments, util::take::Take},\n+    common::{Mark, SourceMap, comments::Comments},\n     ecma::{\n-        ast::{Module, ModuleItem, Program, Script},\n+        ast::{ModuleItem, Program},\n         preset_env::{self, Targets},\n         transforms::{base::assumptions::Assumptions, optimization::inline_globals, react::react},\n     },\n@@ -215,32 +215,14 @@ impl EcmascriptInputTransform {\n                     },\n                 );\n \n-                let module_program = std::mem::replace(program, Program::Module(Module::dummy()));\n-\n-                let module_program = if let Program::Script(Script {\n-                    span,\n-                    mut body,\n-                    shebang,\n-                }) = module_program\n-                {\n-                    Program::Module(Module {\n-                        span,\n-                        body: body.drain(..).map(ModuleItem::Stmt).collect(),\n-                        shebang,\n-                    })\n-                } else {\n-                    module_program\n-                };\n-\n                 // Explicit type annotation to ensure that we don't duplicate transforms in the\n                 // final binary\n-                *program =\n-                    module_program.apply(preset_env::transform_from_env::<&'_ dyn Comments>(\n-                        top_level_mark,\n-                        Some(&comments),\n-                        config,\n-                        Assumptions::default(),\n-                    ));\n+                program.mutate(preset_env::transform_from_env::<&'_ dyn Comments>(\n+                    top_level_mark,\n+                    Some(&comments),\n+                    config,\n+                    Assumptions::default(),\n+                ));\n             }\n             EcmascriptInputTransform::TypeScript {\n                 // TODO(WEB-1213)"
        },
        {
            "sha": "0fdb400b34b1c3126a2025b66461a130c33b09cd",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/swc_transforms/preset_env/output/turbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/036b95767621d12227a7635de1f289db189db15d/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fswc_transforms%2Fpreset_env%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js",
            "raw_url": "https://github.com/vercel/next.js/raw/036b95767621d12227a7635de1f289db189db15d/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fswc_transforms%2Fpreset_env%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fswc_transforms%2Fpreset_env%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js?ref=036b95767621d12227a7635de1f289db189db15d",
            "patch": "@@ -1,16 +1,16 @@\n (globalThis.TURBOPACK = globalThis.TURBOPACK || []).push([\"output/turbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js\", {\n \n-\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/swc_transforms/preset_env/input/index.js [test] (ecmascript)\": ((__turbopack_context__) => {\n-\"use strict\";\n+\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/swc_transforms/preset_env/input/index.js [test] (ecmascript)\": (function(__turbopack_context__) {\n \n-var __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$node_modules$2f40$swc$2f$helpers$2f$_$2f$_class_call_check$2e$js__$5b$test$5d$__$28$ecmascript$29$__ = __turbopack_context__.i(\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/node_modules/@swc/helpers/_/_class_call_check.js [test] (ecmascript)\");\n-;\n+var { m: module, e: exports } = __turbopack_context__;\n+{\n+var _class_call_check = __turbopack_context__.r(\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/node_modules/@swc/helpers/_/_class_call_check.js [test] (ecmascript)\");\n var Foo = function Foo() {\n     \"use strict\";\n-    (0, __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$node_modules$2f40$swc$2f$helpers$2f$_$2f$_class_call_check$2e$js__$5b$test$5d$__$28$ecmascript$29$__[\"_\"])(this, Foo);\n+    _class_call_check._(this, Foo);\n };\n console.log(Foo, [].includes('foo'));\n-}),\n+}}),\n \"[project]/turbopack/crates/turbopack-tests/tests/snapshot/node_modules/@swc/helpers/_/_class_call_check.js [test] (ecmascript)\": (function(__turbopack_context__) {\n \n var { m: module, e: exports } = __turbopack_context__;"
        },
        {
            "sha": "c4c3db365fa65180e6edbdaf976377da84d245e6",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/swc_transforms/preset_env/output/turbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js.map",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/036b95767621d12227a7635de1f289db189db15d/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fswc_transforms%2Fpreset_env%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/036b95767621d12227a7635de1f289db189db15d/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fswc_transforms%2Fpreset_env%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fswc_transforms%2Fpreset_env%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_bff03a32._.js.map?ref=036b95767621d12227a7635de1f289db189db15d",
            "patch": "@@ -2,6 +2,6 @@\n   \"version\": 3,\n   \"sources\": [],\n   \"sections\": [\n-    {\"offset\": {\"line\": 5, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/swc_transforms/preset_env/input/index.js\"],\"sourcesContent\":[\"class Foo {}\\n\\nconsole.log(Foo, [].includes('foo'))\\n\"],\"names\":[],\"mappings\":\";;AAAA,IAAA,AAAM,MAAN,SAAM;;2OAAA;;AAEN,QAAQ,GAAG,CAAC,KAAK,EAAE,CAAC,QAAQ,CAAC\"}},\n+    {\"offset\": {\"line\": 6, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/swc_transforms/preset_env/input/index.js\"],\"sourcesContent\":[\"class Foo {}\\n\\nconsole.log(Foo, [].includes('foo'))\\n\"],\"names\":[],\"mappings\":\";AAAA,IAAA,AAAM,MAAN,SAAM;;8BAAA;;AAEN,QAAQ,GAAG,CAAC,KAAK,EAAE,CAAC,QAAQ,CAAC\"}},\n     {\"offset\": {\"line\": 17, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/node_modules/@swc/helpers/_/_class_call_check.js\"],\"sourcesContent\":[\"\\\"purposefully empty stub\\\";\\n\\\"@swc/helpers/_/_class_call_check.js\\\";\\n\"],\"names\":[],\"mappings\":\"AAAA;AACA\",\"ignoreList\":[0]}}]\n }\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 15,
        "deletions": 33
    }
}