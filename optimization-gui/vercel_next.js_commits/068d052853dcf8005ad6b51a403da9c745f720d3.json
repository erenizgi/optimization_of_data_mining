{
    "author": "wyattjoh",
    "message": "[refactor] Simplified cache handler loading API (#76130)\n\nThis simplifies the API for accessing different cache handlers from\nwithin Next.js. Rather than propagating global access everywhere, this\nprovides some simple functions for storing the handlers.\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that\nyou follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the\nPR.\n- Read the Docs Contribution Guide to ensure your contribution follows\nthe docs guidelines:\nhttps://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc\nhttps://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See\nhttps://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature\nrequest has been accepted for implementation before opening a PR. (A\ndiscussion must be opened, see\nhttps://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added\n(https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to\nunderstand the PR)\n- When linking to a Slack thread, you might want to share details of the\nconclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic\nbehind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "068d052853dcf8005ad6b51a403da9c745f720d3",
    "files": [
        {
            "sha": "7b1501b8e05b257d446d6d474f82ec3455152304",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -646,5 +646,6 @@\n   \"645\": \"@rspack/plugin-react-refresh is not available. Please make sure the appropriate Next.js plugin is installed.\",\n   \"646\": \"No span found for compilation\",\n   \"647\": \"@rspack/core is not available. Please make sure `@next/plugin-rspack` is correctly installed.\",\n-  \"648\": \"@rspack/plugin-react-refresh is not available. Please make sure `@next/plugin-rspack` is correctly installed.\"\n+  \"648\": \"@rspack/plugin-react-refresh is not available. Please make sure `@next/plugin-rspack` is correctly installed.\",\n+  \"649\": \"Cache handlers not initialized\"\n }"
        },
        {
            "sha": "e9fbab50ba28260e86fe994b1d3ceddeaa6e8150",
            "filename": "packages/next/src/build/load-entrypoint.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 24,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Fload-entrypoint.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Fload-entrypoint.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fload-entrypoint.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -36,37 +36,14 @@ export async function loadEntrypoint(\n     | 'pages-api',\n   replacements: Record<`VAR_${string}`, string>,\n   injections?: Record<string, string>,\n-  imports?: Record<string, string | null>,\n-  importMaps?: Record<string, Record<string, string>>\n+  imports?: Record<string, string | null>\n ): Promise<string> {\n   const filepath = path.resolve(\n     path.join(TEMPLATES_ESM_FOLDER, `${entrypoint}.js`)\n   )\n \n   let file = await fs.readFile(filepath, 'utf8')\n \n-  const importMapItems: Record<string, Record<string, string>> = {}\n-\n-  for (const key of Object.keys(importMaps || {})) {\n-    importMapItems[key] = {}\n-\n-    for (const [innerKey, importPath] of Object.entries(\n-      importMaps?.[key] || {}\n-    )) {\n-      file = `import ${key}_${innerKey} from ${JSON.stringify(importPath)}\\n${file}`\n-      importMapItems[key][innerKey] = `${key}_${innerKey}`\n-    }\n-  }\n-\n-  file = file.replace(\n-    new RegExp(`cacheHandlers = {}`),\n-    `cacheHandlers = {\\n${Object.entries(importMapItems['cacheHandlers'] || {})\n-      .map(([key, value]) => {\n-        return `${key}: ${value}`\n-      })\n-      .join(',')}\\n}`\n-  )\n-\n   // Update the relative imports to be absolute. This will update any relative\n   // imports to be relative to the root of the `next` package.\n   let count = 0"
        },
        {
            "sha": "3401fdf7348feab68efe481809107a41fc34b01a",
            "filename": "packages/next/src/build/templates/edge-app-route.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -10,12 +10,6 @@ import * as module from 'VAR_USERLAND'\n declare const nextConfig: NextConfigComplete\n // INJECT:nextConfig\n \n-const cacheHandlers = {}\n-\n-if (!(globalThis as any).__nextCacheHandlers) {\n-  ;(globalThis as any).__nextCacheHandlers = cacheHandlers\n-}\n-\n const maybeJSONParse = (str?: string) => (str ? JSON.parse(str) : undefined)\n \n const rscManifest = self.__RSC_MANIFEST?.['VAR_PAGE']"
        },
        {
            "sha": "994e53fce0add38a9be0ab40c4a7eac81efa19f0",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 15,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -13,25 +13,13 @@ import type { NextConfigComplete } from '../../server/config-shared'\n import { PAGE_TYPES } from '../../lib/page-types'\n import { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\n import { createServerModuleMap } from '../../server/app-render/action-utils'\n-import {\n-  cacheHandlerGlobal,\n-  cacheHandlersSymbol,\n-} from '../../server/use-cache/constants'\n+import { initializeCacheHandlers } from '../../server/use-cache/handlers'\n \n declare const incrementalCacheHandler: any\n // OPTIONAL_IMPORT:incrementalCacheHandler\n \n-const cacheHandlers = {}\n-\n-if (!cacheHandlerGlobal.__nextCacheHandlers) {\n-  cacheHandlerGlobal.__nextCacheHandlers = cacheHandlers\n-\n-  if (!cacheHandlerGlobal.__nextCacheHandlers.default) {\n-    cacheHandlerGlobal.__nextCacheHandlers.default =\n-      cacheHandlerGlobal[cacheHandlersSymbol]?.DefaultCache ||\n-      cacheHandlerGlobal.__nextCacheHandlers.__nextDefault\n-  }\n-}\n+// Initialize the cache handlers interface.\n+initializeCacheHandlers()\n \n const Document: DocumentType = null!\n const appMod = null"
        },
        {
            "sha": "bdce04e4bc460781ebfa2235f4c685c4bd70d41f",
            "filename": "packages/next/src/build/templates/edge-ssr.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 15,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -2,6 +2,7 @@ import '../../server/web/globals'\n import { adapter } from '../../server/web/adapter'\n import { getRender } from '../webpack/loaders/next-edge-ssr-loader/render'\n import { IncrementalCache } from '../../server/lib/incremental-cache'\n+import { initializeCacheHandlers } from '../../server/use-cache/handlers'\n \n import Document from 'VAR_MODULE_DOCUMENT'\n import * as appMod from 'VAR_MODULE_APP'\n@@ -23,10 +24,6 @@ import type { RequestData } from '../../server/web/types'\n import type { BuildManifest } from '../../server/get-page-files'\n import type { NextConfigComplete } from '../../server/config-shared'\n import type { PAGE_TYPES } from '../../lib/page-types'\n-import {\n-  cacheHandlerGlobal,\n-  cacheHandlersSymbol,\n-} from '../../server/use-cache/constants'\n \n // injected by the loader afterwards.\n declare const pagesType: PAGE_TYPES\n@@ -44,17 +41,8 @@ declare const user500RouteModuleOptions: any\n // INJECT:errorRouteModuleOptions\n // INJECT:user500RouteModuleOptions\n \n-const cacheHandlers = {}\n-\n-if (!cacheHandlerGlobal.__nextCacheHandlers) {\n-  cacheHandlerGlobal.__nextCacheHandlers = cacheHandlers\n-\n-  if (!cacheHandlerGlobal.__nextCacheHandlers.default) {\n-    cacheHandlerGlobal.__nextCacheHandlers.default =\n-      cacheHandlerGlobal[cacheHandlersSymbol]?.DefaultCache ||\n-      cacheHandlerGlobal.__nextCacheHandlers.__nextDefault\n-  }\n-}\n+// Initialize the cache handlers interface.\n+initializeCacheHandlers()\n \n const pageMod = {\n   ...userlandPage,"
        },
        {
            "sha": "59b68af893fc4f919d45e5417537f583fd8359c2",
            "filename": "packages/next/src/build/webpack/loaders/next-edge-app-route-loader/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-app-route-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-app-route-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-app-route-loader%2Findex.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -36,7 +36,7 @@ const EdgeAppRouteLoader: webpack.LoaderDefinitionFunction<EdgeAppRouteLoaderQue\n     const cacheHandlers = JSON.parse(cacheHandlersStringified || '{}')\n \n     if (!cacheHandlers.default) {\n-      cacheHandlers.__nextDefault = require.resolve(\n+      cacheHandlers.default = require.resolve(\n         '../../../../server/lib/cache-handlers/default'\n       )\n     }\n@@ -77,10 +77,6 @@ const EdgeAppRouteLoader: webpack.LoaderDefinitionFunction<EdgeAppRouteLoaderQue\n       },\n       {\n         nextConfig: stringifiedConfig,\n-      },\n-      {},\n-      {\n-        cacheHandlers,\n       }\n     )\n   }"
        },
        {
            "sha": "d34869f12fd35e95c96c6f27d8eb5b8ccffd0876",
            "filename": "packages/next/src/build/webpack/loaders/next-edge-ssr-loader/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -85,7 +85,7 @@ const edgeSSRLoader: webpack.LoaderDefinitionFunction<EdgeSSRLoaderQuery> =\n     const cacheHandlers = JSON.parse(cacheHandlersStringified || '{}')\n \n     if (!cacheHandlers.default) {\n-      cacheHandlers.__nextDefault = require.resolve(\n+      cacheHandlers.default = require.resolve(\n         '../../../../server/lib/cache-handlers/default'\n       )\n     }\n@@ -166,9 +166,6 @@ const edgeSSRLoader: webpack.LoaderDefinitionFunction<EdgeSSRLoaderQuery> =\n         },\n         {\n           incrementalCacheHandler: cacheHandler ?? null,\n-        },\n-        {\n-          cacheHandlers: cacheHandlers ?? {},\n         }\n       )\n     } else {\n@@ -197,9 +194,6 @@ const edgeSSRLoader: webpack.LoaderDefinitionFunction<EdgeSSRLoaderQuery> =\n         {\n           userland500Page: userland500Path,\n           incrementalCacheHandler: cacheHandler ?? null,\n-        },\n-        {\n-          cacheHandlers: cacheHandlers || {},\n         }\n       )\n     }"
        },
        {
            "sha": "a49d409f615883d7c1e3d73e8eb882879c5c0f51",
            "filename": "packages/next/src/export/helpers/create-incremental-cache.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 13,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fexport%2Fhelpers%2Fcreate-incremental-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fexport%2Fhelpers%2Fcreate-incremental-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fhelpers%2Fcreate-incremental-cache.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -4,8 +4,10 @@ import { hasNextSupport } from '../../server/ci-info'\n import { nodeFs } from '../../server/lib/node-fs-methods'\n import { interopDefault } from '../../lib/interop-default'\n import { formatDynamicImportPath } from '../../lib/format-dynamic-import-path'\n-import { cacheHandlerGlobal } from '../../server/use-cache/constants'\n-import DefaultCacheHandler from '../../server/lib/cache-handlers/default'\n+import {\n+  initializeCacheHandlers,\n+  setCacheHandler,\n+} from '../../server/use-cache/handlers'\n \n export async function createIncrementalCache({\n   cacheHandler,\n@@ -36,21 +38,18 @@ export async function createIncrementalCache({\n     )\n   }\n \n-  if (!cacheHandlerGlobal.__nextCacheHandlers && cacheHandlers) {\n-    cacheHandlerGlobal.__nextCacheHandlers = {}\n+  if (cacheHandlers && initializeCacheHandlers()) {\n+    for (const [kind, handler] of Object.entries(cacheHandlers)) {\n+      if (!handler) continue\n \n-    for (const key of Object.keys(cacheHandlers)) {\n-      if (cacheHandlers[key]) {\n-        ;(globalThis as any).__nextCacheHandlers[key] = interopDefault(\n-          await import(formatDynamicImportPath(dir, cacheHandlers[key])).then(\n+      setCacheHandler(\n+        kind,\n+        interopDefault(\n+          await import(formatDynamicImportPath(dir, handler)).then(\n             (mod) => mod.default || mod\n           )\n         )\n-      }\n-    }\n-\n-    if (!cacheHandlers.default) {\n-      cacheHandlerGlobal.__nextCacheHandlers.default = DefaultCacheHandler\n+      )\n     }\n   }\n "
        },
        {
            "sha": "6805e27d4100856155c63b52243689ff90961297",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 17,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -180,6 +180,7 @@ import {\n   shouldServeStreamingMetadata,\n   isHtmlBotRequest,\n } from './lib/streaming-metadata'\n+import { getCacheHandlers } from './use-cache/handlers'\n \n export type FindComponentsResult = {\n   components: LoadComponentsReturnType\n@@ -1433,24 +1434,20 @@ export default abstract class Server<\n         ;(globalThis as any).__incrementalCache = incrementalCache\n       }\n \n-      const _globalThis: typeof globalThis & {\n-        __nextCacheHandlers?: Record<\n-          string,\n-          import('./lib/cache-handlers/types').CacheHandler\n-        >\n-      } = globalThis\n-\n-      if (_globalThis.__nextCacheHandlers) {\n-        const expiredTags: string[] =\n-          (req.headers[NEXT_CACHE_REVALIDATED_TAGS_HEADER] as string)?.split(\n-            ','\n-          ) || []\n-\n-        for (const handler of Object.values(_globalThis.__nextCacheHandlers)) {\n-          if (typeof handler?.receiveExpiredTags === 'function') {\n-            await handler.receiveExpiredTags(...expiredTags)\n-          }\n+      // If the header is present, receive the expired tags from all the\n+      // cache handlers.\n+      const handlers = getCacheHandlers()\n+      if (handlers) {\n+        const header = req.headers[NEXT_CACHE_REVALIDATED_TAGS_HEADER] ?? ''\n+        const expiredTags = typeof header === 'string' ? header.split(',') : []\n+\n+        const promises: Promise<void>[] = []\n+        for (const handler of handlers) {\n+          promises.push(handler.receiveExpiredTags(...expiredTags))\n         }\n+\n+        // Only await if there are any promises to wait for.\n+        if (promises.length > 0) await Promise.all(promises)\n       }\n \n       // set server components HMR cache to request meta so it can be passed"
        },
        {
            "sha": "2ddac8a66e1f57145ca2bc1a4d735c4a2f22a663",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 15,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -26,6 +26,7 @@ import {\n   getPrerenderResumeDataCache,\n   getRenderResumeDataCache,\n } from '../../app-render/work-unit-async-storage.external'\n+import { getCacheHandlers } from '../../use-cache/handlers'\n \n export interface CacheHandlerContext {\n   fs?: CacheFs\n@@ -245,22 +246,21 @@ export class IncrementalCache implements IncrementalCacheType {\n   }\n \n   async revalidateTag(tags: string | string[]): Promise<void> {\n-    const _globalThis: typeof globalThis & {\n-      __nextCacheHandlers?: Record<\n-        string,\n-        import('../cache-handlers/types').CacheHandler\n-      >\n-    } = globalThis\n+    const promises: Promise<void>[] = []\n+\n+    if (this.cacheHandler?.revalidateTag) {\n+      promises.push(this.cacheHandler.revalidateTag(tags))\n+    }\n+\n+    const handlers = getCacheHandlers()\n+    if (handlers) {\n+      tags = Array.isArray(tags) ? tags : [tags]\n+      for (const handler of handlers) {\n+        promises.push(handler.expireTags(...tags))\n+      }\n+    }\n \n-    return Promise.all([\n-      // call expireTags on all configured cache handlers\n-      Object.values(_globalThis.__nextCacheHandlers || {}).map(\n-        (cacheHandler) =>\n-          typeof cacheHandler.expireTags === 'function' &&\n-          cacheHandler.expireTags(...(Array.isArray(tags) ? tags : [tags]))\n-      ),\n-      this.cacheHandler?.revalidateTag?.(tags),\n-    ]).then(() => {})\n+    await Promise.all(promises)\n   }\n \n   // x-ref: https://github.com/facebook/react/blob/2655c9354d8e1c54ba888444220f63e836925caa/packages/react/src/ReactFetch.js#L23"
        },
        {
            "sha": "721536dff4f11f51f7c529abcb8f263ff06b2ac1",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 27,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -109,8 +109,7 @@ import { RouteKind } from './route-kind'\n import { InvariantError } from '../shared/lib/invariant-error'\n import { AwaiterOnce } from './after/awaiter'\n import { AsyncCallbackSet } from './lib/async-callback-set'\n-import DefaultCacheHandler from './lib/cache-handlers/default'\n-import { cacheHandlerGlobal, cacheHandlersSymbol } from './use-cache/constants'\n+import { initializeCacheHandlers, setCacheHandler } from './use-cache/handlers'\n import type { UnwrapPromise } from '../lib/coalesced-function'\n \n export * from './base-server'\n@@ -379,35 +378,25 @@ export default class NextNodeServer extends BaseServer<\n     )\n   }\n \n-  protected async loadCustomCacheHandlers() {\n+  private async loadCustomCacheHandlers() {\n     const { cacheHandlers } = this.nextConfig.experimental\n+    if (!cacheHandlers) return\n \n-    if (!cacheHandlerGlobal.__nextCacheHandlers && cacheHandlers) {\n-      cacheHandlerGlobal.__nextCacheHandlers = {}\n+    // If we've already initialized the cache handlers interface, don't do it\n+    // again.\n+    if (!initializeCacheHandlers()) return\n \n-      for (const key of Object.keys(cacheHandlers)) {\n-        if (cacheHandlers[key]) {\n-          ;(globalThis as any).__nextCacheHandlers[key] = interopDefault(\n-            await dynamicImportEsmDefault(\n-              formatDynamicImportPath(this.distDir, cacheHandlers[key])\n-            )\n-          )\n-        }\n-      }\n+    for (const [kind, handler] of Object.entries(cacheHandlers)) {\n+      if (!handler) continue\n \n-      if (!cacheHandlers.default) {\n-        cacheHandlerGlobal.__nextCacheHandlers.default =\n-          cacheHandlerGlobal[cacheHandlersSymbol]?.DefaultCache ||\n-          DefaultCacheHandler\n-      }\n-\n-      if (\n-        !cacheHandlers.remote &&\n-        cacheHandlerGlobal[cacheHandlersSymbol]?.RemoteCache\n-      ) {\n-        cacheHandlerGlobal.__nextCacheHandlers.remote =\n-          cacheHandlerGlobal[cacheHandlersSymbol].RemoteCache\n-      }\n+      setCacheHandler(\n+        kind,\n+        interopDefault(\n+          await dynamicImportEsmDefault(\n+            formatDynamicImportPath(this.distDir, handler)\n+          )\n+        )\n+      )\n     }\n   }\n "
        },
        {
            "sha": "7117a38d2573be811b4f0b196cf8abf48e5d7669",
            "filename": "packages/next/src/server/use-cache/constants.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fconstants.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -1,13 +1,2 @@\n-import type { CacheHandler } from '../lib/cache-handlers/types'\n-\n // If the expire time is less than .\n export const DYNAMIC_EXPIRE = 300\n-\n-export const cacheHandlersSymbol = Symbol.for('@next/cache-handlers')\n-export const cacheHandlerGlobal: typeof globalThis & {\n-  [cacheHandlersSymbol]?: {\n-    RemoteCache?: CacheHandler\n-    DefaultCache?: CacheHandler\n-  }\n-  __nextCacheHandlers?: Record<string, CacheHandler>\n-} = globalThis"
        },
        {
            "sha": "77a5ef83a2617df96ee6ea2e13548a10c78dbda2",
            "filename": "packages/next/src/server/use-cache/handlers.ts",
            "status": "added",
            "additions": 121,
            "deletions": 0,
            "changes": 121,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fhandlers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fhandlers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fhandlers.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -0,0 +1,121 @@\n+import DefaultCacheHandler from '../lib/cache-handlers/default'\n+import type { CacheHandler } from '../lib/cache-handlers/types'\n+\n+const debug = process.env.NEXT_PRIVATE_DEBUG_USE_CACHE\n+  ? (message: string, ...args: any[]) => {\n+      console.log(`use-cache[${process.pid}]: ${message}`, ...args)\n+    }\n+  : () => {}\n+\n+const handlersSymbol = Symbol.for('@next/cache-handlers')\n+const handlersMapSymbol = Symbol.for('@next/cache-handlers-map')\n+const handlersSetSymbol = Symbol.for('@next/cache-handlers-set')\n+\n+/**\n+ * The reference to the cache handlers. We store the cache handlers on the\n+ * global object so that we can access the same instance across different\n+ * boundaries (such as different copies of the same module).\n+ */\n+const reference: typeof globalThis & {\n+  [handlersSymbol]?: {\n+    RemoteCache?: CacheHandler\n+    DefaultCache?: CacheHandler\n+  }\n+  [handlersMapSymbol]?: Map<string, CacheHandler>\n+  [handlersSetSymbol]?: Set<CacheHandler>\n+} = globalThis\n+\n+/**\n+ * Initialize the cache handlers.\n+ * @returns `true` if the cache handlers were initialized, `false` if they were already initialized.\n+ */\n+export function initializeCacheHandlers(): boolean {\n+  // If the cache handlers have already been initialized, don't do it again.\n+  if (reference[handlersMapSymbol]) {\n+    debug('cache handlers already initialized')\n+    return false\n+  }\n+\n+  debug('initializing cache handlers')\n+  reference[handlersMapSymbol] = new Map<string, CacheHandler>()\n+\n+  // Initialize the cache from the symbol contents first.\n+  if (reference[handlersSymbol]) {\n+    let fallback: CacheHandler\n+    if (reference[handlersSymbol].DefaultCache) {\n+      debug('setting \"default\" cache handler from symbol')\n+      fallback = reference[handlersSymbol].DefaultCache\n+    } else {\n+      debug('setting \"default\" cache handler from default')\n+      fallback = DefaultCacheHandler\n+    }\n+\n+    reference[handlersMapSymbol].set('default', fallback)\n+\n+    if (reference[handlersSymbol].RemoteCache) {\n+      debug('setting \"remote\" cache handler from symbol')\n+      reference[handlersMapSymbol].set(\n+        'remote',\n+        reference[handlersSymbol].RemoteCache\n+      )\n+    } else {\n+      debug('setting \"remote\" cache handler from default')\n+      reference[handlersMapSymbol].set('remote', fallback)\n+    }\n+  } else {\n+    debug('setting \"default\" cache handler from default')\n+    reference[handlersMapSymbol].set('default', DefaultCacheHandler)\n+    debug('setting \"remote\" cache handler from default')\n+    reference[handlersMapSymbol].set('remote', DefaultCacheHandler)\n+  }\n+\n+  // Create a set of the cache handlers.\n+  reference[handlersSetSymbol] = new Set(reference[handlersMapSymbol].values())\n+\n+  return true\n+}\n+\n+/**\n+ * Get a cache handler by kind.\n+ * @param kind - The kind of cache handler to get.\n+ * @returns The cache handler, or `undefined` if it is not initialized or does not exist.\n+ */\n+export function getCacheHandler(kind: string): CacheHandler | undefined {\n+  // This should never be called before initializeCacheHandlers.\n+  if (!reference[handlersMapSymbol]) {\n+    throw new Error('Cache handlers not initialized')\n+  }\n+\n+  return reference[handlersMapSymbol].get(kind)\n+}\n+\n+/**\n+ * Get an iterator over the cache handlers.\n+ * @returns An iterator over the cache handlers, or `undefined` if they are not initialized.\n+ */\n+export function getCacheHandlers(): SetIterator<CacheHandler> | undefined {\n+  if (!reference[handlersSetSymbol]) {\n+    return undefined\n+  }\n+\n+  return reference[handlersSetSymbol].values()\n+}\n+\n+/**\n+ * Set a cache handler by kind.\n+ * @param kind - The kind of cache handler to set.\n+ * @param cacheHandler - The cache handler to set.\n+ */\n+export function setCacheHandler(\n+  kind: string,\n+  cacheHandler: CacheHandler\n+): void {\n+  // This should never be called before initializeCacheHandlers.\n+  if (!reference[handlersMapSymbol] || !reference[handlersSetSymbol]) {\n+    throw new Error('Cache handlers not initialized')\n+  }\n+\n+  debug('setting cache handler for \"%s\"', kind)\n+  reference[handlersMapSymbol].set(kind, cacheHandler)\n+  reference[handlersSetSymbol].add(cacheHandler)\n+}"
        },
        {
            "sha": "2c9345cc9f647b41d11449c0dbebc3ae2e4a8595",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 11,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -35,12 +35,13 @@ import {\n   getClientReferenceManifestForRsc,\n   getServerModuleMap,\n } from '../app-render/encryption-utils'\n-import type { CacheHandler, CacheEntry } from '../lib/cache-handlers/types'\n+import type { CacheEntry } from '../lib/cache-handlers/types'\n import type { CacheSignal } from '../app-render/cache-signal'\n import { decryptActionBoundArgs } from '../app-render/encryption'\n import { InvariantError } from '../../shared/lib/invariant-error'\n import { getDigestForWellKnownError } from '../app-render/create-error-handler'\n-import { cacheHandlerGlobal, DYNAMIC_EXPIRE } from './constants'\n+import { DYNAMIC_EXPIRE } from './constants'\n+import { getCacheHandler } from './handlers'\n import { UseCacheTimeoutError } from './use-cache-errors'\n import { createHangingInputAbortSignal } from '../app-render/dynamic-rendering'\n import {\n@@ -65,8 +66,6 @@ export interface UseCachePageComponentProps {\n \n const isEdgeRuntime = process.env.NEXT_RUNTIME === 'edge'\n \n-const cacheHandlerMap: Map<string, CacheHandler> = new Map()\n-\n function generateCacheEntry(\n   workStore: WorkStore,\n   outerWorkUnitStore: WorkUnitStore | undefined,\n@@ -507,13 +506,7 @@ export function cache(\n   boundArgsLength: number,\n   fn: (...args: unknown[]) => Promise<unknown>\n ) {\n-  for (const [key, value] of Object.entries(\n-    cacheHandlerGlobal.__nextCacheHandlers || {}\n-  )) {\n-    cacheHandlerMap.set(key, value as CacheHandler)\n-  }\n-  const cacheHandler = cacheHandlerMap.get(kind)\n-\n+  const cacheHandler = getCacheHandler(kind)\n   if (cacheHandler === undefined) {\n     throw new Error('Unknown cache handler: ' + kind)\n   }"
        },
        {
            "sha": "4f762047e50c28d4376f0f6252492f6bdc232535",
            "filename": "test/production/app-dir/dynamic-io-cache-handlers/app/actions.ts",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fapp%2Factions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fapp%2Factions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fapp%2Factions.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -0,0 +1,6 @@\n+'use server'\n+import { revalidatePath } from 'next/cache'\n+\n+export async function revalidate() {\n+  revalidatePath('/')\n+}"
        },
        {
            "sha": "d94b82524303342e4beb5ecf7beff7fdba4c31c6",
            "filename": "test/production/app-dir/dynamic-io-cache-handlers/app/page.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fapp%2Fpage.tsx?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -1,4 +1,5 @@\n import React, { Suspense } from 'react'\n+import { revalidate } from './actions'\n \n async function Random({ cached }: { cached?: boolean }) {\n   const data = await fetch(\n@@ -31,6 +32,11 @@ export default function Page() {\n       <Suspense fallback={<p>Loading...</p>}>\n         <CachedRandom />\n       </Suspense>\n+      <form action={revalidate}>\n+        <button id=\"revalidate-tag\" type=\"submit\">\n+          Revalidate tag\n+        </button>\n+      </form>\n     </>\n   )\n }"
        },
        {
            "sha": "a38b4d65f3e378ca54835ec784dfcdf161ba9497",
            "filename": "test/production/app-dir/dynamic-io-cache-handlers/dynamic-io-cache-handlers.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/068d052853dcf8005ad6b51a403da9c745f720d3/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fdynamic-io-cache-handlers.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/068d052853dcf8005ad6b51a403da9c745f720d3/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fdynamic-io-cache-handlers.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fdynamic-io-cache-handlers%2Fdynamic-io-cache-handlers.test.ts?ref=068d052853dcf8005ad6b51a403da9c745f720d3",
            "patch": "@@ -71,11 +71,9 @@ describe('dynamic-io-cache-handlers', () => {\n         shouldRejectOnError: true,\n         onStdout(data) {\n           output += data\n-          require('console').log(data)\n         },\n         onStderr(data) {\n           output += data\n-          require('console').log(data)\n         },\n       }\n     )\n@@ -90,7 +88,6 @@ describe('dynamic-io-cache-handlers', () => {\n     expect(res.status).toBe(200)\n \n     await retry(() => {\n-      expect(output).toContain('symbol receiveExpiredTags')\n       expect(output).toContain('symbol get')\n       expect(output).toContain('symbol set')\n     })\n@@ -101,9 +98,26 @@ describe('dynamic-io-cache-handlers', () => {\n     expect(res.status).toBe(200)\n \n     await retry(() => {\n-      expect(output).toContain('symbol receiveExpiredTags')\n       expect(output).toContain('symbol expireTags')\n       expect(output).toContain('tag1')\n     })\n   })\n+\n+  it('should call receiveExpiredTags on global default cache handler', async () => {\n+    const res = await fetchViaHTTP(\n+      appPort,\n+      '/',\n+      {},\n+      {\n+        headers: {\n+          'x-next-revalidated-tags': 'tag1',\n+        },\n+      }\n+    )\n+    expect(res.status).toBe(200)\n+\n+    await retry(async () => {\n+      expect(output).toContain(\"symbol receiveExpiredTags [ 'tag1' ]\")\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 394,
        "additions": 223,
        "deletions": 171
    }
}