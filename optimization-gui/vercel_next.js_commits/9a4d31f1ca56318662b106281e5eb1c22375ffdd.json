{
    "author": "gnoff",
    "message": "Only enable unhandledRejection filtering when opted in (#83726)\n\nWe need to debug some unexpected process crashes in front. This change\nmakes the unhandled rejection filter only enabled when configred with\nthe __NEXT_USE_UNHANDLED_REJECTION_FILTER environment variable.",
    "sha": "9a4d31f1ca56318662b106281e5eb1c22375ffdd",
    "files": [
        {
            "sha": "5c8216610f9b71d8bde8e48061e9684fef633e26",
            "filename": "packages/next/src/server/node-environment-extensions/unhandled-rejection.tsx",
            "status": "modified",
            "additions": 94,
            "deletions": 1,
            "changes": 95,
            "blob_url": "https://github.com/vercel/next.js/blob/9a4d31f1ca56318662b106281e5eb1c22375ffdd/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9a4d31f1ca56318662b106281e5eb1c22375ffdd/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Funhandled-rejection.tsx?ref=9a4d31f1ca56318662b106281e5eb1c22375ffdd",
            "patch": "@@ -21,6 +21,48 @@\n \n import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n \n+const MODE:\n+  | 'enabled'\n+  | 'debug'\n+  | 'true'\n+  | 'false'\n+  | '1'\n+  | '0'\n+  | ''\n+  | string\n+  | undefined = process.env.__NEXT_USE_UNHANDLED_REJECTION_FILTER\n+\n+let ENABLE_UHR_FILTER = false\n+let DEBUG_UHR_FILTER = false\n+\n+switch (MODE) {\n+  case 'debug':\n+    DEBUG_UHR_FILTER = true\n+  // fallthrough\n+  case 'enabled':\n+  case 'true':\n+  case '1':\n+    ENABLE_UHR_FILTER = true\n+    break\n+  case 'false':\n+  case 'disabled':\n+  case '0':\n+  case '':\n+  case undefined:\n+    break\n+  default:\n+    if (typeof MODE === 'string') {\n+      console.error(\n+        `__NEXT_USE_UNHANDLED_REJECTION_FILTER has an unrecognized value: ${JSON.stringify(MODE)}. Use \"enabled\", \"disabled\", or \"debug\" or omit the environment variable altogether`\n+      )\n+    }\n+}\n+\n+const debug = DEBUG_UHR_FILTER\n+  ? (...args: any[]) =>\n+      console.log('[UNHANDLED REJECTION DEBUG]', ...args, new Error().stack)\n+  : undefined\n+\n type ListenerMetadata = {\n   listener: NodeJS.UnhandledRejectionListener\n   once: boolean\n@@ -55,9 +97,15 @@ let didWarnRemoveAll = false\n  */\n function installUnhandledRejectionFilter(): void {\n   if (filterInstalled) {\n+    debug?.('unexpected second install')\n     return\n   }\n \n+  debug?.(\n+    'installUnhandledRejectionFilter',\n+    process.listeners('unhandledRejection').map((l) => l.toString())\n+  )\n+\n   // Capture existing handlers\n   underlyingListeners = Array.from(process.listeners('unhandledRejection'))\n   // We assume all existing handlers are not \"once\"\n@@ -94,6 +142,7 @@ function installUnhandledRejectionFilter(): void {\n     listener: (...args: any[]) => void\n   ) {\n     if (event === 'unhandledRejection') {\n+      debug?.('process.on/addListener', listener.toString())\n       // Add new handlers to our internal queue instead of the process\n       underlyingListeners.push(listener as NodeJS.UnhandledRejectionListener)\n       listenerMetadata.push({ listener, once: false })\n@@ -115,6 +164,7 @@ function installUnhandledRejectionFilter(): void {\n     listener: (...args: any[]) => void\n   ) {\n     if (event === 'unhandledRejection') {\n+      debug?.('process.once', listener.toString())\n       underlyingListeners.push(listener)\n       listenerMetadata.push({ listener, once: true })\n       return process\n@@ -128,6 +178,7 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessPrependListener,\n     function (event: string | symbol, listener: (...args: any[]) => void) {\n       if (event === 'unhandledRejection') {\n+        debug?.('process.prependListener', listener.toString())\n         if (didWarnPrepend === false) {\n           didWarnPrepend = true\n           console.warn(\n@@ -156,6 +207,7 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessPrependOnceListener,\n     function (event: string | symbol, listener: (...args: any[]) => void) {\n       if (event === 'unhandledRejection') {\n+        debug?.('process.prependOnceListener', listener.toString())\n         if (didWarnPrepend === false) {\n           didWarnPrepend = true\n           console.warn(\n@@ -183,6 +235,7 @@ function installUnhandledRejectionFilter(): void {\n     listener: (...args: any[]) => void\n   ) {\n     if (event === 'unhandledRejection') {\n+      debug?.('process.removeListener', listener.toString())\n       // Check if they're trying to remove our filtering handler\n       if (listener === filteringUnhandledRejectionHandler) {\n         uninstallUnhandledRejectionFilter()\n@@ -191,8 +244,11 @@ function installUnhandledRejectionFilter(): void {\n \n       const index = underlyingListeners.lastIndexOf(listener)\n       if (index > -1) {\n+        debug?.('process.removeListener match found', index)\n         underlyingListeners.splice(index, 1)\n         listenerMetadata.splice(index, 1)\n+      } else {\n+        debug?.('process.removeListener match not found', index)\n       }\n       return process\n     }\n@@ -211,6 +267,10 @@ function installUnhandledRejectionFilter(): void {\n     originalProcessRemoveAllListeners,\n     function (event?: string | symbol) {\n       if (event === 'unhandledRejection') {\n+        debug?.(\n+          'process.removeAllListeners',\n+          underlyingListeners.map((l) => l.toString())\n+        )\n         if (didWarnRemoveAll === false) {\n           didWarnRemoveAll = true\n           console.warn(\n@@ -245,6 +305,12 @@ function installUnhandledRejectionFilter(): void {\n     event: string | symbol\n   ) {\n     if (event === 'unhandledRejection') {\n+      debug?.(\n+        'process.listeners',\n+        [filteringUnhandledRejectionHandler, ...underlyingListeners].map((l) =>\n+          l.toString()\n+        )\n+      )\n       return [filteringUnhandledRejectionHandler, ...underlyingListeners]\n     }\n     return originalProcessListeners.call(process, event as any)\n@@ -263,6 +329,18 @@ function installUnhandledRejectionFilter(): void {\n   originalProcessOn.call(process, 'rejectionHandled', noopRejectionHandled)\n \n   filterInstalled = true\n+\n+  debug?.(\n+    'after install actual listeners',\n+    originalProcessListeners\n+      .call(process, 'unhandledRejection' as any)\n+      .map((l) => l.toString())\n+  )\n+\n+  debug?.(\n+    'after install listeners',\n+    process.listeners('unhandledRejection').map((l) => l.toString())\n+  )\n }\n \n /**\n@@ -272,9 +350,17 @@ function installUnhandledRejectionFilter(): void {\n  */\n function uninstallUnhandledRejectionFilter(): void {\n   if (!filterInstalled) {\n+    debug?.('unexpected second uninstall')\n     return\n   }\n \n+  debug?.(\n+    'uninstallUnhandledRejectionFilter',\n+    [filteringUnhandledRejectionHandler, ...underlyingListeners].map((l) =>\n+      l.toString()\n+    )\n+  )\n+\n   // Restore original process methods\n   process.on = originalProcessOn\n   process.addListener = originalProcessAddListener\n@@ -312,6 +398,11 @@ function uninstallUnhandledRejectionFilter(): void {\n   filterInstalled = false\n   underlyingListeners.length = 0\n   listenerMetadata.length = 0\n+\n+  debug?.(\n+    'after uninstall',\n+    process.listeners('unhandledRejection').map((l) => l.toString())\n+  )\n }\n \n /**\n@@ -385,4 +476,6 @@ function filteringUnhandledRejectionHandler(\n function noopRejectionHandled() {}\n \n // Install the filter when this module is imported\n-installUnhandledRejectionFilter()\n+if (ENABLE_UHR_FILTER) {\n+  installUnhandledRejectionFilter()\n+}"
        },
        {
            "sha": "07be6cdf02a4b4b4c9afed95226686e68db61743",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9a4d31f1ca56318662b106281e5eb1c22375ffdd/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9a4d31f1ca56318662b106281e5eb1c22375ffdd/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=9a4d31f1ca56318662b106281e5eb1c22375ffdd",
            "patch": "@@ -10,6 +10,9 @@ describe('Cache Components Errors', () => {\n     files: __dirname + '/fixtures/default',\n     skipStart: !isNextDev,\n     skipDeployment: true,\n+    env: {\n+      __NEXT_USE_UNHANDLED_REJECTION_FILTER: 'enabled',\n+    },\n   })\n   const isRspack = !!process.env.NEXT_RSPACK\n "
        }
    ],
    "stats": {
        "total": 98,
        "additions": 97,
        "deletions": 1
    }
}