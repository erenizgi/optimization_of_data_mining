{
    "author": "timneutkens",
    "message": "Turbopack: Only load capsize-font-metrics once (#83654)\n\n## What?\n\nCurrently each `next/font` import would cause the capsize-font-metrics\njson to be loaded which is 4.2Mb so not super fast to load on machines\nwith a slower filesystem. On one trace provided it showed 100-160ms\nspent on loading for each `next/font` import (each individual font\nimported).\n\nOn my machine it was more like 10ms per font imported. Worth fixing\neither way.\n\n---------\n\nCo-authored-by: Luke Sandberg <lukesandberg@users.noreply.github.com>",
    "sha": "a64c5915a948f69e05212ef22ce675dab9e61c4c",
    "files": [
        {
            "sha": "caf29190c7008edf62dc78401eeb110a7c413f37",
            "filename": "crates/next-core/src/next_font/google/font_fallback.rs",
            "status": "modified",
            "additions": 28,
            "deletions": 19,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/a64c5915a948f69e05212ef22ce675dab9e61c4c/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Ffont_fallback.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a64c5915a948f69e05212ef22ce675dab9e61c4c/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Ffont_fallback.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Ffont_fallback.rs?ref=a64c5915a948f69e05212ef22ce675dab9e61c4c",
            "patch": "@@ -1,10 +1,9 @@\n use anyhow::{Context, Result};\n use once_cell::sync::Lazy;\n use regex::Regex;\n-use rustc_hash::FxHashMap;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{NonLocalValue, Vc, trace::TraceRawVcs};\n+use turbo_tasks::{FxIndexMap, NonLocalValue, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::issue::{IssueExt, IssueSeverity, StyledString};\n \n@@ -22,43 +21,52 @@ use crate::{\n };\n \n /// An entry in the Google fonts metrics map\n-#[derive(Deserialize, Debug)]\n+#[derive(Deserialize, Serialize, Debug, PartialEq, Eq, TraceRawVcs, NonLocalValue)]\n #[serde(rename_all = \"camelCase\")]\n pub(super) struct FontMetricsMapEntry {\n     category: RcStr,\n     ascent: i32,\n     descent: i32,\n     line_gap: u32,\n     units_per_em: u32,\n-    x_width_avg: f64,\n+    x_width_avg: u64,\n }\n \n-#[derive(Deserialize, Debug)]\n-pub(super) struct FontMetricsMap(pub FxHashMap<RcStr, FontMetricsMapEntry>);\n+#[derive(Debug)]\n+#[turbo_tasks::value]\n+pub(super) struct FontMetricsMap(pub FxIndexMap<RcStr, FontMetricsMapEntry>);\n \n #[derive(Debug, PartialEq, Serialize, Deserialize, TraceRawVcs, NonLocalValue)]\n struct Fallback {\n     pub font_family: RcStr,\n     pub adjustment: Option<FontAdjustment>,\n }\n \n+// This JSON file is large, so we cache it in turbotasks\n+#[turbo_tasks::function]\n+async fn load_font_metrics(project_root: FileSystemPath) -> Result<Vc<FontMetricsMap>> {\n+    let data: FontMetricsMap = load_next_js_templateon(\n+        project_root,\n+        rcstr!(\"dist/server/capsize-font-metrics.json\"),\n+    )\n+    .await?;\n+\n+    Ok(data.cell())\n+}\n+\n #[turbo_tasks::function]\n pub(super) async fn get_font_fallback(\n-    lookup_path: FileSystemPath,\n+    project_root: FileSystemPath,\n     options_vc: Vc<NextFontGoogleOptions>,\n ) -> Result<Vc<FontFallback>> {\n     let options = options_vc.await?;\n     Ok(match &options.fallback {\n         Some(fallback) => FontFallback::Manual(fallback.clone()).cell(),\n         None => {\n-            let metrics_json = load_next_js_templateon(\n-                lookup_path.clone(),\n-                rcstr!(\"dist/server/capsize-font-metrics.json\"),\n-            )\n-            .await?;\n+            let metrics_json = load_font_metrics(project_root.clone()).await?;\n             let fallback = lookup_fallback(\n                 &options.font_family,\n-                metrics_json,\n+                &metrics_json,\n                 options.adjust_font_fallback,\n             );\n \n@@ -74,7 +82,7 @@ pub(super) async fn get_font_fallback(\n                 .cell(),\n                 Err(_) => {\n                     NextFontIssue {\n-                        path: lookup_path.clone(),\n+                        path: project_root.clone(),\n                         title: StyledString::Text(\n                             format!(\n                                 \"Failed to find font override values for font `{}`\",\n@@ -124,7 +132,7 @@ fn format_fallback_font_name(font_family: &str) -> RcStr {\n \n fn lookup_fallback(\n     font_family: &str,\n-    font_metrics_map: FontMetricsMap,\n+    font_metrics_map: &FontMetricsMap,\n     adjust: bool,\n ) -> Result<Fallback> {\n     let font_family = format_fallback_font_name(font_family);\n@@ -142,9 +150,10 @@ fn lookup_fallback(\n     let metrics = if adjust {\n         // Derived from\n         // https://github.com/vercel/next.js/blob/7bfd5829999b1d203e447d30de7e29108c31934a/packages/next/src/server/font-utils.ts#L131\n-        let main_font_avg_width = metrics.x_width_avg / metrics.units_per_em as f64;\n+        let main_font_avg_width = metrics.x_width_avg as f64 / metrics.units_per_em as f64;\n         let fallback_metrics = font_metrics_map.0.get(&fallback.capsize_key).unwrap();\n-        let fallback_font_avg_width = fallback_metrics.x_width_avg / fallback.units_per_em as f64;\n+        let fallback_font_avg_width =\n+            fallback_metrics.x_width_avg as f64 / fallback.units_per_em as f64;\n         let size_adjust = main_font_avg_width / fallback_font_avg_width;\n \n         let ascent = metrics.ascent as f64 / (metrics.units_per_em as f64 * size_adjust);\n@@ -208,7 +217,7 @@ mod tests {\n         )?;\n \n         assert_eq!(\n-            lookup_fallback(\"Inter\", font_metrics, true)?,\n+            lookup_fallback(\"Inter\", &font_metrics, true)?,\n             Fallback {\n                 font_family: rcstr!(\"Arial\"),\n                 adjustment: Some(FontAdjustment {\n@@ -254,7 +263,7 @@ mod tests {\n         )?;\n \n         assert_eq!(\n-            lookup_fallback(\"Roboto Slab\", font_metrics, true)?,\n+            lookup_fallback(\"Roboto Slab\", &font_metrics, true)?,\n             Fallback {\n                 font_family: rcstr!(\"Times New Roman\"),\n                 adjustment: Some(FontAdjustment {"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 28,
        "deletions": 19
    }
}