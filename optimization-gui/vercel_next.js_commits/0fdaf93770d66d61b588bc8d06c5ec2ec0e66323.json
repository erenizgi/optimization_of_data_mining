{
    "author": "sokra",
    "message": "Turbopack: improve compaction (#82375)\n\n### What?\n\n* fix initial duplication set\n* improve compaction config (1MB limit was too aggressive and was led to compaction on every call)",
    "sha": "0fdaf93770d66d61b588bc8d06c5ec2ec0e66323",
    "files": [
        {
            "sha": "9357ac08afdd1307fd575e97c2bbdb0185287596",
            "filename": "turbopack/crates/turbo-persistence/src/compaction/selector.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/0fdaf93770d66d61b588bc8d06c5ec2ec0e66323/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0fdaf93770d66d61b588bc8d06c5ec2ec0e66323/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs?ref=0fdaf93770d66d61b588bc8d06c5ec2ec0e66323",
            "patch": "@@ -136,8 +136,8 @@ impl Default for CompactConfig {\n             optimal_merge_count: 8,\n             max_merge_count: 32,\n             max_merge_bytes: 500 * MB,\n-            min_merge_duplication_bytes: MB,\n-            optimal_merge_duplication_bytes: 10 * MB,\n+            min_merge_duplication_bytes: 50 * MB,\n+            optimal_merge_duplication_bytes: 100 * MB,\n             max_merge_segment_count: 8,\n         }\n     }\n@@ -236,13 +236,20 @@ pub fn get_merge_segments<T: Compactable>(\n             // We have reached the maximum number of merge jobs, so we stop here.\n             break;\n         }\n-        let mut current_range = start_compactable.range();\n+        let start_compactable_range = start_compactable.range();\n+        let start_compactable_size = start_compactable.size();\n+        let mut current_range = start_compactable_range.clone();\n \n         // We might need to restart the search if we need to extend the range.\n         'search: loop {\n             let mut current_set = smallvec![start_index];\n-            let mut current_size = start_compactable.size();\n+            let mut current_size = start_compactable_size;\n             let mut duplication = IntervalMap::<Option<DuplicationInfo>>::new();\n+            duplication.update(start_compactable_range.clone(), |dup_info| {\n+                dup_info\n+                    .get_or_insert_default()\n+                    .add(start_compactable_size, &start_compactable_range);\n+            });\n             let mut current_skip = 0;\n \n             // We will capture compactables in the current_range until we find a optimal merge\n@@ -612,8 +619,8 @@ mod tests {\n                 min_merge_count: 2,\n                 optimal_merge_count: 4,\n                 max_merge_bytes: 5000,\n-                min_merge_duplication_bytes: 200,\n-                optimal_merge_duplication_bytes: 500,\n+                min_merge_duplication_bytes: 500,\n+                optimal_merge_duplication_bytes: 1000,\n                 max_merge_segment_count: 4,\n             };\n             let (jobs, _) = get_merge_segments(&containers, &config);\n@@ -656,7 +663,7 @@ mod tests {\n         println!(\"Number of compactions: {number_of_compactions}\");\n \n         let metrics = compute_metrics(&containers, 0..=KEY_RANGE);\n-        assert!(number_of_compactions < 40);\n+        assert!(number_of_compactions < 30);\n         assert!(containers.len() < 30);\n         assert!(metrics.duplication < 0.5);\n     }"
        },
        {
            "sha": "2a89db52b86d748a464898a07b5685893d765b54",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/turbo/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0fdaf93770d66d61b588bc8d06c5ec2ec0e66323/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0fdaf93770d66d61b588bc8d06c5ec2ec0e66323/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo%2Fmod.rs?ref=0fdaf93770d66d61b588bc8d06c5ec2ec0e66323",
            "patch": "@@ -21,7 +21,7 @@ const COMPACT_CONFIG: CompactConfig = CompactConfig {\n     optimal_merge_count: 8,\n     max_merge_count: 64,\n     max_merge_bytes: 512 * MB,\n-    min_merge_duplication_bytes: MB,\n+    min_merge_duplication_bytes: 50 * MB,\n     optimal_merge_duplication_bytes: 100 * MB,\n     max_merge_segment_count: 16,\n };"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 15,
        "deletions": 8
    }
}