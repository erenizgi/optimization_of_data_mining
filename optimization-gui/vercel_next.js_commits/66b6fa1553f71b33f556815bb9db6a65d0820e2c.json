{
    "author": "kdy1",
    "message": "feat: Disable char frequency analysis for mangler (#77887)\n\n### What?\n\nDisable character frequency analysis for server-side builds.\n\n### Why?\n\n\nhttps://vercel.slack.com/archives/C05KYT5S9FF/p1742935766157509?thread_ts=1742255598.708199&cid=C05KYT5S9FF\n\n### How?\n\nCloses NAR-118\n\n---------\n\nCo-authored-by: Tobias Koppers <tobias.koppers@googlemail.com>",
    "sha": "66b6fa1553f71b33f556815bb9db6a65d0820e2c",
    "files": [
        {
            "sha": "36d9caef0b627bab5d18490dc48e20a1b122a9b1",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -19,8 +19,8 @@ use turbopack_browser::{\n };\n use turbopack_core::{\n     chunk::{\n-        module_id_strategies::ModuleIdStrategy, ChunkingConfig, ChunkingContext, MinifyType,\n-        SourceMapsType,\n+        module_id_strategies::ModuleIdStrategy, ChunkingConfig, ChunkingContext, MangleType,\n+        MinifyType, SourceMapsType,\n     },\n     compile_time_info::{\n         CompileTimeDefineValue, CompileTimeDefines, CompileTimeInfo, DefineableNameSegment,\n@@ -397,7 +397,7 @@ pub async fn get_client_module_options_context(\n         css: CssOptionsContext {\n             minify_type: if *next_config.turbo_minify(mode).await? {\n                 MinifyType::Minify {\n-                    mangle: !*no_mangling.await?,\n+                    mangle: (!*no_mangling.await?).then_some(MangleType::OptimalSize),\n                 }\n             } else {\n                 MinifyType::NoMinify\n@@ -454,7 +454,7 @@ pub async fn get_client_chunking_context(\n     .chunk_suffix_path(chunk_suffix_path)\n     .minify_type(if *minify.await? {\n         MinifyType::Minify {\n-            mangle: !*no_mangling.await?,\n+            mangle: (!*no_mangling.await?).then_some(MangleType::OptimalSize),\n         }\n     } else {\n         MinifyType::NoMinify"
        },
        {
            "sha": "71c4b97f2f46aec67fe4f0a87f01c2043a7c4a5d",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -7,8 +7,8 @@ use turbopack::{css::chunk::CssChunkType, resolve_options_context::ResolveOption\n use turbopack_browser::BrowserChunkingContext;\n use turbopack_core::{\n     chunk::{\n-        module_id_strategies::ModuleIdStrategy, ChunkingConfig, ChunkingContext, MinifyType,\n-        SourceMapsType,\n+        module_id_strategies::ModuleIdStrategy, ChunkingConfig, ChunkingContext, MangleType,\n+        MinifyType, SourceMapsType,\n     },\n     compile_time_info::{\n         CompileTimeDefineValue, CompileTimeDefines, CompileTimeInfo, DefineableNameSegment,\n@@ -241,7 +241,8 @@ pub async fn get_edge_chunking_context_with_client_assets(\n     .asset_base_path(asset_prefix)\n     .minify_type(if *turbo_minify.await? {\n         MinifyType::Minify {\n-            mangle: !*no_mangling.await?,\n+            // React needs deterministic function names to work correctly.\n+            mangle: (!*no_mangling.await?).then_some(MangleType::Deterministic),\n         }\n     } else {\n         MinifyType::NoMinify\n@@ -304,7 +305,7 @@ pub async fn get_edge_chunking_context(\n     .asset_base_path(ResolvedVc::cell(Some(\"blob:server/edge/\".into())))\n     .minify_type(if *turbo_minify.await? {\n         MinifyType::Minify {\n-            mangle: !*no_mangling.await?,\n+            mangle: (!*no_mangling.await?).then_some(MangleType::OptimalSize),\n         }\n     } else {\n         MinifyType::NoMinify"
        },
        {
            "sha": "313fdaca39a98da4923b32c194bbeb1ae9e2a3b1",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -15,7 +15,10 @@ use turbopack::{\n     transition::Transition,\n };\n use turbopack_core::{\n-    chunk::{module_id_strategies::ModuleIdStrategy, ChunkingConfig, MinifyType, SourceMapsType},\n+    chunk::{\n+        module_id_strategies::ModuleIdStrategy, ChunkingConfig, MangleType, MinifyType,\n+        SourceMapsType,\n+    },\n     compile_time_info::{\n         CompileTimeDefineValue, CompileTimeDefines, CompileTimeInfo, DefineableNameSegment,\n         FreeVarReferences,\n@@ -1015,7 +1018,8 @@ pub async fn get_server_chunking_context_with_client_assets(\n     .asset_prefix(asset_prefix)\n     .minify_type(if *turbo_minify.await? {\n         MinifyType::Minify {\n-            mangle: !*no_mangling.await?,\n+            // React needs deterministic function names to work correctly.\n+            mangle: (!*no_mangling.await?).then_some(MangleType::Deterministic),\n         }\n     } else {\n         MinifyType::NoMinify\n@@ -1080,7 +1084,7 @@ pub async fn get_server_chunking_context(\n     )\n     .minify_type(if *turbo_minify.await? {\n         MinifyType::Minify {\n-            mangle: !*no_mangling.await?,\n+            mangle: (!*no_mangling.await?).then_some(MangleType::OptimalSize),\n         }\n     } else {\n         MinifyType::NoMinify"
        },
        {
            "sha": "2195ff0bbe189ea270d7b5f8b0ec6c78861989ca",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -1187,7 +1187,10 @@ export default async function getBaseWebpackConfig(\n                     'process.env.__NEXT_PRIVATE_MINIMIZE_MACRO_FALSE': false,\n                   },\n                 },\n-                mangle: !noMangling && { reserved: ['AbortSignal'] },\n+                mangle: !noMangling && {\n+                  reserved: ['AbortSignal'],\n+                  disableCharFreq: !isClient,\n+                },\n               },\n             }),\n             new (getRspackCore().LightningCssMinimizerRspackPlugin)({"
        },
        {
            "sha": "9408cee663c6fbe9574ab7ac82be44cdfc971c96",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -27,7 +27,7 @@ use turbopack_core::{\n     asset::Asset,\n     chunk::{\n         availability_info::AvailabilityInfo, ChunkingConfig, ChunkingContext, EvaluatableAsset,\n-        EvaluatableAssets, MinifyType, SourceMapsType,\n+        EvaluatableAssets, MangleType, MinifyType, SourceMapsType,\n     },\n     environment::{BrowserEnvironment, Environment, ExecutionEnvironment, NodeJsEnvironment},\n     ident::AssetIdent,\n@@ -93,7 +93,9 @@ impl TurbopackBuildBuilder {\n             show_all: false,\n             log_detail: false,\n             source_maps_type: SourceMapsType::Full,\n-            minify_type: MinifyType::Minify { mangle: true },\n+            minify_type: MinifyType::Minify {\n+                mangle: Some(MangleType::OptimalSize),\n+            },\n             target: Target::Node,\n         }\n     }\n@@ -522,7 +524,9 @@ pub async fn build(args: &BuildArguments) -> Result<()> {\n         .minify_type(if args.no_minify {\n             MinifyType::NoMinify\n         } else {\n-            MinifyType::Minify { mangle: true }\n+            MinifyType::Minify {\n+                mangle: Some(MangleType::OptimalSize),\n+            }\n         })\n         .target(args.common.target.unwrap_or(Target::Node))\n         .show_all(args.common.show_all);"
        },
        {
            "sha": "52f8c40a22fe8464eade78b49655a52f73c25642",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking_context.rs",
            "status": "modified",
            "additions": 26,
            "deletions": 2,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -17,6 +17,26 @@ use crate::{\n     output::{OutputAsset, OutputAssets},\n };\n \n+#[derive(\n+    Debug,\n+    TaskInput,\n+    Clone,\n+    Copy,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    Serialize,\n+    Deserialize,\n+    TraceRawVcs,\n+    DeterministicHash,\n+    NonLocalValue,\n+)]\n+#[serde(rename_all = \"kebab-case\")]\n+pub enum MangleType {\n+    OptimalSize,\n+    Deterministic,\n+}\n+\n #[derive(\n     Debug,\n     TaskInput,\n@@ -32,13 +52,17 @@ use crate::{\n     NonLocalValue,\n )]\n pub enum MinifyType {\n-    Minify { mangle: bool },\n+    // TODO instead of adding a new property here,\n+    // refactor that to Minify(MinifyOptions) to allow defaults on MinifyOptions\n+    Minify { mangle: Option<MangleType> },\n     NoMinify,\n }\n \n impl Default for MinifyType {\n     fn default() -> Self {\n-        Self::Minify { mangle: true }\n+        Self::Minify {\n+            mangle: Some(MangleType::OptimalSize),\n+        }\n     }\n }\n "
        },
        {
            "sha": "c456c98b547a20492967546e6812d8b8114eec8e",
            "filename": "turbopack/crates/turbopack-core/src/chunk/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -29,7 +29,7 @@ pub use self::{\n     },\n     chunking_context::{\n         ChunkGroupResult, ChunkGroupType, ChunkingConfig, ChunkingConfigs, ChunkingContext,\n-        ChunkingContextExt, EntryChunkGroupResult, MinifyType, SourceMapsType,\n+        ChunkingContextExt, EntryChunkGroupResult, MangleType, MinifyType, SourceMapsType,\n     },\n     data::{ChunkData, ChunkDataOption, ChunksData},\n     evaluate::{EvaluatableAsset, EvaluatableAssetExt, EvaluatableAssets},"
        },
        {
            "sha": "9a26f8a2b0f0826616042d190f3de09de7b7f9a0",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 11,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -23,12 +23,15 @@ use swc_core::{\n     },\n };\n use tracing::{instrument, Level};\n-use turbopack_core::code_builder::{Code, CodeBuilder};\n+use turbopack_core::{\n+    chunk::MangleType,\n+    code_builder::{Code, CodeBuilder},\n+};\n \n use crate::parse::generate_js_source_map;\n \n #[instrument(level = Level::INFO, skip_all)]\n-pub fn minify(code: &Code, source_maps: bool, mangle: bool) -> Result<Code> {\n+pub fn minify(code: &Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n     let source_maps = source_maps\n         .then(|| code.generate_source_map_ref())\n         .transpose()?;\n@@ -84,14 +87,20 @@ pub fn minify(code: &Code, source_maps: bool, mangle: bool) -> Result<Code> {\n                             passes: 2,\n                             ..Default::default()\n                         }),\n-                        mangle: if mangle {\n-                            Some(MangleOptions {\n-                                reserved: vec![\"AbortSignal\".into()],\n-                                ..Default::default()\n-                            })\n-                        } else {\n-                            None\n-                        },\n+                        mangle: mangle.map(|mangle| {\n+                            let reserved = vec![\"AbortSignal\".into()];\n+                            match mangle {\n+                                MangleType::OptimalSize => MangleOptions {\n+                                    reserved,\n+                                    ..Default::default()\n+                                },\n+                                MangleType::Deterministic => MangleOptions {\n+                                    reserved,\n+                                    disable_char_freq: true,\n+                                    ..Default::default()\n+                                },\n+                            }\n+                        }),\n                         ..Default::default()\n                     },\n                     &ExtraOptions {\n@@ -101,7 +110,7 @@ pub fn minify(code: &Code, source_maps: bool, mangle: bool) -> Result<Code> {\n                     },\n                 );\n \n-                if !mangle {\n+                if mangle.is_none() {\n                     program.mutate(hygiene_with_config(hygiene::Config {\n                         top_level_mark,\n                         ..Default::default()"
        },
        {
            "sha": "78197ec333e88242d0b7f9b72b3e3ab071d6d0ac",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/basic/ecmascript_minify/options.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fecmascript_minify%2Foptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fecmascript_minify%2Foptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fecmascript_minify%2Foptions.json?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -2,7 +2,7 @@\n   \"runtime\": \"NodeJs\",\n   \"minifyType\": {\n     \"Minify\": {\n-      \"mangle\": true\n+      \"mangle\": \"optimal-size\"\n     }\n   }\n }"
        },
        {
            "sha": "012b46107ba832c04972925cdad2500b643211c6",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/minification/paren-remover/options.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fminification%2Fparen-remover%2Foptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6fa1553f71b33f556815bb9db6a65d0820e2c/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fminification%2Fparen-remover%2Foptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fminification%2Fparen-remover%2Foptions.json?ref=66b6fa1553f71b33f556815bb9db6a65d0820e2c",
            "patch": "@@ -1,7 +1,7 @@\n {\n   \"minifyType\": {\n     \"Minify\": {\n-      \"mangle\": true\n+      \"mangle\": \"optimal-size\"\n     }\n   }\n }"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 76,
        "deletions": 31
    }
}