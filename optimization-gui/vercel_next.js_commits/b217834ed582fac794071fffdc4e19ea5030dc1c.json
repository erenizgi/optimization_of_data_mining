{
    "author": "timneutkens",
    "message": "Destructure loadComponents where possible (#82986)\n\n## What?\n\nMore preparation work for removing manifest loading from loadComponents. No changes to how things function, only making it clearer what is used from loadComponents in each place it is used.",
    "sha": "b217834ed582fac794071fffdc4e19ea5030dc1c",
    "files": [
        {
            "sha": "2ac0f5a8095150d4a974af945f58ed739384b1a1",
            "filename": "packages/next/src/build/segment-config/app/app-segments.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 14,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segments.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segments.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fapp-segments.ts?ref=b217834ed582fac794071fffdc4e19ea5030dc1c",
            "patch": "@@ -1,13 +1,6 @@\n-import type { LoadComponentsReturnType } from '../../../server/load-components'\n import type { Params } from '../../../server/request/params'\n-import type {\n-  AppPageRouteModule,\n-  AppPageModule,\n-} from '../../../server/route-modules/app-page/module.compiled'\n-import type {\n-  AppRouteRouteModule,\n-  AppRouteModule,\n-} from '../../../server/route-modules/app-route/module.compiled'\n+import type { AppPageRouteModule } from '../../../server/route-modules/app-page/module.compiled'\n+import type { AppRouteRouteModule } from '../../../server/route-modules/app-route/module.compiled'\n import {\n   type AppSegmentConfig,\n   parseAppSegmentConfig,\n@@ -25,6 +18,7 @@ import {\n   type LoaderTree,\n } from '../../../server/lib/app-dir-module'\n import { PAGE_SEGMENT_KEY } from '../../../shared/lib/segment'\n+import type { RouteModule } from '../../../server/route-modules/route-module'\n \n type GenerateStaticParams = (options: { params?: Params }) => Promise<Params[]>\n \n@@ -187,11 +181,9 @@ function collectAppRouteSegments(\n  * @param components the loaded components\n  * @returns the segments for the route module\n  */\n-export function collectSegments({\n-  routeModule,\n-}: LoadComponentsReturnType<AppPageModule | AppRouteModule>):\n-  | Promise<AppSegment[]>\n-  | AppSegment[] {\n+export function collectSegments(\n+  routeModule: RouteModule\n+): Promise<AppSegment[]> | AppSegment[] {\n   if (isAppRouteRouteModule(routeModule)) {\n     return collectAppRouteSegments(routeModule)\n   }"
        },
        {
            "sha": "7966cc02f633111b95a4446c80b68950dd1c1863",
            "filename": "packages/next/src/build/segment-config/app/collect-root-param-keys.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fcollect-root-param-keys.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fcollect-root-param-keys.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fsegment-config%2Fapp%2Fcollect-root-param-keys.ts?ref=b217834ed582fac794071fffdc4e19ea5030dc1c",
            "patch": "@@ -1,12 +1,10 @@\n import { getSegmentParam } from '../../../server/app-render/get-segment-param'\n-import type { LoadComponentsReturnType } from '../../../server/load-components'\n-import type { AppPageModule } from '../../../server/route-modules/app-page/module'\n import type AppPageRouteModule from '../../../server/route-modules/app-page/module'\n-import type { AppRouteModule } from '../../../server/route-modules/app-route/module'\n import {\n   isAppPageRouteModule,\n   isAppRouteRouteModule,\n } from '../../../server/route-modules/checks'\n+import type { RouteModule } from '../../../server/route-modules/route-module'\n import { InvariantError } from '../../../shared/lib/invariant-error'\n \n function collectAppPageRootParamKeys(\n@@ -46,11 +44,9 @@ function collectAppPageRootParamKeys(\n  * @param components the loaded components\n  * @returns the segments for the route module\n  */\n-export function collectRootParamKeys({\n-  routeModule,\n-}: LoadComponentsReturnType<\n-  AppPageModule | AppRouteModule\n->): readonly string[] {\n+export function collectRootParamKeys(\n+  routeModule: RouteModule\n+): readonly string[] {\n   if (isAppRouteRouteModule(routeModule)) {\n     return []\n   }"
        },
        {
            "sha": "83f10ee3b509b974bd67cddc8c20d6f4cc8acc67",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=b217834ed582fac794071fffdc4e19ea5030dc1c",
            "patch": "@@ -16,7 +16,6 @@ import type {\n } from './webpack/plugins/middleware-plugin'\n import type { WebpackLayerName } from '../lib/constants'\n import type { AppPageModule } from '../server/route-modules/app-page/module'\n-import type { RouteModule } from '../server/route-modules/route-module'\n import type { NextComponentType } from '../shared/lib/utils'\n \n import '../server/require-hook'\n@@ -1163,9 +1162,10 @@ export async function isPageStatic({\n           sriEnabled,\n         })\n       }\n-      const Comp = componentsResult.Component as NextComponentType | undefined\n \n-      const routeModule: RouteModule = componentsResult.routeModule\n+      const { Component, routeModule } = componentsResult\n+\n+      const Comp = Component as NextComponentType | undefined\n \n       let isRoutePPREnabled: boolean = false\n \n@@ -1176,7 +1176,7 @@ export async function isPageStatic({\n \n         let segments\n         try {\n-          segments = await collectSegments(componentsResult)\n+          segments = await collectSegments(routeModule)\n         } catch (err) {\n           throw new Error(`Failed to collect configuration for ${page}`, {\n             cause: err,\n@@ -1194,7 +1194,7 @@ export async function isPageStatic({\n           )\n         }\n \n-        rootParamKeys = collectRootParamKeys(componentsResult)\n+        rootParamKeys = collectRootParamKeys(routeModule)\n \n         // A page supports partial prerendering if it is an app page and either\n         // the whole app has PPR enabled or this page has PPR enabled when we're\n@@ -1422,14 +1422,14 @@ export async function hasCustomGetInitialProps({\n     require('../shared/lib/runtime-config.external') as typeof import('../shared/lib/runtime-config.external')\n   ).setConfig(runtimeEnvConfig)\n \n-  const components = await loadComponents({\n+  const { ComponentMod } = await loadComponents({\n     distDir,\n     page: page,\n     isAppPath: false,\n     isDev: false,\n     sriEnabled,\n   })\n-  let mod = components.ComponentMod\n+  let mod = ComponentMod\n \n   if (checkingApp) {\n     mod = (await mod._app) || mod.default || mod\n@@ -1454,16 +1454,16 @@ export async function getDefinedNamedExports({\n   ;(\n     require('../shared/lib/runtime-config.external') as typeof import('../shared/lib/runtime-config.external')\n   ).setConfig(runtimeEnvConfig)\n-  const components = await loadComponents({\n+  const { ComponentMod } = await loadComponents({\n     distDir,\n     page: page,\n     isAppPath: false,\n     isDev: false,\n     sriEnabled,\n   })\n \n-  return Object.keys(components.ComponentMod).filter((key) => {\n-    return typeof components.ComponentMod[key] !== 'undefined'\n+  return Object.keys(ComponentMod).filter((key) => {\n+    return typeof ComponentMod[key] !== 'undefined'\n   })\n }\n "
        },
        {
            "sha": "67a177c36edd45fcbce68bf5bc2b4e4ae5873d5a",
            "filename": "packages/next/src/server/dev/static-paths-worker.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fstatic-paths-worker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fstatic-paths-worker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fstatic-paths-worker.ts?ref=b217834ed582fac794071fffdc4e19ea5030dc1c",
            "patch": "@@ -107,13 +107,14 @@ export async function loadStaticPaths({\n   })\n \n   if (isAppPath) {\n-    const segments = await collectSegments(components)\n+    const routeModule = components.routeModule\n+    const segments = await collectSegments(routeModule)\n \n     const isRoutePPREnabled =\n-      isAppPageRouteModule(components.routeModule) &&\n+      isAppPageRouteModule(routeModule) &&\n       checkIsRoutePPREnabled(config.pprConfig, reduceAppConfig(segments))\n \n-    const rootParamKeys = collectRootParamKeys(components)\n+    const rootParamKeys = collectRootParamKeys(routeModule)\n \n     return buildAppStaticPaths({\n       dir,"
        },
        {
            "sha": "77f3daf4326c69b763f7f78dd03cb7c749f78025",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 27,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b217834ed582fac794071fffdc4e19ea5030dc1c/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=b217834ed582fac794071fffdc4e19ea5030dc1c",
            "patch": "@@ -361,37 +361,42 @@ export default class NextNodeServer extends BaseServer<\n     await this.loadCustomCacheHandlers()\n \n     for (const page of Object.keys(pagesManifest || {})) {\n-      await loadComponents({\n-        distDir: this.distDir,\n-        page,\n-        isAppPath: false,\n-        isDev: this.isDev,\n-        sriEnabled: this.sriEnabled,\n-      }).catch(() => {})\n+      try {\n+        await loadComponents({\n+          distDir: this.distDir,\n+          page,\n+          isAppPath: false,\n+          isDev: this.isDev,\n+          sriEnabled: this.sriEnabled,\n+        })\n+      } catch (_err) {\n+        // Intentionally ignored because this is a preload step.\n+      }\n     }\n \n     for (const page of Object.keys(appPathsManifest || {})) {\n-      await loadComponents({\n-        distDir: this.distDir,\n-        page,\n-        isAppPath: true,\n-        isDev: this.isDev,\n-        sriEnabled: this.sriEnabled,\n-      })\n-        .then(async ({ ComponentMod }) => {\n-          // we need to ensure fetch is patched before we require the page,\n-          // otherwise if the fetch is patched by user code, we will be patching it\n-          // too late and there won't be any caching behaviors\n-          ComponentMod.patchFetch()\n-\n-          const webpackRequire = ComponentMod.__next_app__.require\n-          if (webpackRequire?.m) {\n-            for (const id of Object.keys(webpackRequire.m)) {\n-              await webpackRequire(id)\n-            }\n-          }\n+      try {\n+        const { ComponentMod } = await loadComponents({\n+          distDir: this.distDir,\n+          page,\n+          isAppPath: true,\n+          isDev: this.isDev,\n+          sriEnabled: this.sriEnabled,\n         })\n-        .catch(() => {})\n+        // we need to ensure fetch is patched before we require the page,\n+        // otherwise if the fetch is patched by user code, we will be patching it\n+        // too late and there won't be any caching behaviors\n+        ComponentMod.patchFetch()\n+\n+        const webpackRequire = ComponentMod.__next_app__.require\n+        if (webpackRequire?.m) {\n+          for (const id of Object.keys(webpackRequire.m)) {\n+            await webpackRequire(id)\n+          }\n+        }\n+      } catch (_err) {\n+        // Intentionally ignored because this is a preload step.\n+      }\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 118,
        "additions": 56,
        "deletions": 62
    }
}