{
    "author": "kdy1",
    "message": "Revert \"perf(turbopack): Use rayon threadpool for `minify()`\" (#79296)\n\nReverts vercel/next.js#79261 because it regressed RSS",
    "sha": "f4fc1a642751869aa497002f9d05764e3c9beeac",
    "files": [
        {
            "sha": "0042dedb572ba7cc53a6550ae2890c93d539c770",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f4fc1a642751869aa497002f9d05764e3c9beeac/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/f4fc1a642751869aa497002f9d05764e3c9beeac/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=f4fc1a642751869aa497002f9d05764e3c9beeac",
            "patch": "@@ -10162,7 +10162,6 @@ dependencies = [\n  \"par-core\",\n  \"parking_lot\",\n  \"petgraph 0.6.3\",\n- \"rayon\",\n  \"regex\",\n  \"rustc-hash 2.1.1\",\n  \"serde\","
        },
        {
            "sha": "d970d1eaf17df52387f009b8aaba0d2aa4340ed5",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/content.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs?ref=f4fc1a642751869aa497002f9d05764e3c9beeac",
            "patch": "@@ -128,7 +128,7 @@ impl EcmascriptBrowserChunkContent {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(code, source_maps, mangle).await?;\n+            code = minify(&code, source_maps, mangle)?;\n         }\n \n         Ok(code.cell())"
        },
        {
            "sha": "62bd90851cfb13136944535aa1dd93ac6a14d98d",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/evaluate/chunk.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs?ref=f4fc1a642751869aa497002f9d05764e3c9beeac",
            "patch": "@@ -194,7 +194,7 @@ impl EcmascriptBrowserEvaluateChunk {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(code, source_maps, mangle).await?;\n+            code = minify(&code, source_maps, mangle)?;\n         }\n \n         Ok(code.cell())"
        },
        {
            "sha": "26e36bb210e35b9d6a1432a578ef737455866064",
            "filename": "turbopack/crates/turbopack-ecmascript/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml?ref=f4fc1a642751869aa497002f9d05764e3c9beeac",
            "patch": "@@ -44,7 +44,6 @@ turbopack-resolve = { workspace = true }\n turbopack-swc-utils = { workspace = true }\n url = { workspace = true }\n urlencoding = { workspace = true }\n-rayon = { workspace = true }\n \n swc_core = { workspace = true, features = [\n   \"ecma_ast\","
        },
        {
            "sha": "a7e85af651ba1ba580f71a727560e6dae8137963",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 14,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=f4fc1a642751869aa497002f9d05764e3c9beeac",
            "patch": "@@ -31,18 +31,7 @@ use turbopack_core::{\n use crate::parse::generate_js_source_map;\n \n #[instrument(level = Level::INFO, skip_all)]\n-pub async fn minify(code: Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n-    let (tx, rx) = tokio::sync::oneshot::channel();\n-\n-    rayon::spawn(move || {\n-        let result = minify_inner(code, source_maps, mangle);\n-        tx.send(result).unwrap();\n-    });\n-\n-    rx.await.unwrap()\n-}\n-\n-fn minify_inner(code: Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n+pub fn minify(code: &Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n     let source_maps = source_maps\n         .then(|| code.generate_source_map_ref())\n         .transpose()?;\n@@ -150,8 +139,8 @@ fn minify_inner(code: Code, source_maps: bool, mangle: Option<MangleType>) -> Re\n                 src_map_buf,\n                 Some(original_map),\n                 // We do not inline source contents.\n-                // We provide a synthesized value to `cm.new_source_file` above, so it cannot\n-                // be the value user expect anyway.\n+                // We provide a synthesized value to `cm.new_source_file` above, so it cannot be\n+                // the value user expect anyway.\n                 false,\n             )?),\n         );"
        },
        {
            "sha": "1c3809247095956c404be00609c0ec2ca1f9a8f7",
            "filename": "turbopack/crates/turbopack-nodejs/src/ecmascript/node/content.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f4fc1a642751869aa497002f9d05764e3c9beeac/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs?ref=f4fc1a642751869aa497002f9d05764e3c9beeac",
            "patch": "@@ -78,7 +78,7 @@ impl EcmascriptBuildNodeChunkContent {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(code, source_maps, mangle).await?;\n+            code = minify(&code, source_maps, mangle)?;\n         }\n \n         Ok(code.cell())"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 6,
        "deletions": 19
    }
}