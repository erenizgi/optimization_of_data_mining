{
    "author": "bgw",
    "message": "Turbopack: Use `format!` instead of `anyhow!` inside of `anyhow::Context::with_context` calls (#88293)\n\n`anyhow!` works here because we just need something that implements `Display`, but `format!` is better.",
    "sha": "ee9e68872eaffd2c974103503e928d60c83e7075",
    "files": [
        {
            "sha": "c72d15b7d6c86f143ae343d107f6308f112f19e7",
            "filename": "turbopack/crates/turbo-tasks-backend/src/kv_backing_storage.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 10,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs?ref=ee9e68872eaffd2c974103503e928d60c83e7075",
            "patch": "@@ -5,7 +5,7 @@ use std::{\n     sync::{Arc, LazyLock, Mutex, PoisonError, Weak},\n };\n \n-use anyhow::{Context, Result, anyhow};\n+use anyhow::{Context, Result};\n use turbo_bincode::{\n     TurboBincodeBuffer, turbo_bincode_decode, turbo_bincode_encode, turbo_bincode_encode_into,\n };\n@@ -328,7 +328,7 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorageSealed\n                                         WriteBuffer::Borrowed(&task_id.to_le_bytes()),\n                                     )\n                                     .with_context(|| {\n-                                        anyhow!(\n+                                        format!(\n                                             \"Unable to write task cache {task_type:?} => {task_id}\"\n                                         )\n                                     })?;\n@@ -339,7 +339,7 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorageSealed\n                                         WriteBuffer::Borrowed(&task_type_bytes),\n                                     )\n                                     .with_context(|| {\n-                                        anyhow!(\n+                                        format!(\n                                             \"Unable to write task cache {task_id} => {task_type:?}\"\n                                         )\n                                     })?;\n@@ -373,14 +373,14 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorageSealed\n                             batch\n                                 .put(KeySpace::TaskMeta, WriteBuffer::Borrowed(key), meta)\n                                 .with_context(|| {\n-                                    anyhow!(\"Unable to write meta items for {task_id}\")\n+                                    format!(\"Unable to write meta items for {task_id}\")\n                                 })?;\n                         }\n                         if let Some(data) = data {\n                             batch\n                                 .put(KeySpace::TaskData, WriteBuffer::Borrowed(key), data)\n                                 .with_context(|| {\n-                                    anyhow!(\"Unable to write data items for {task_id}\")\n+                                    format!(\"Unable to write data items for {task_id}\")\n                                 })?;\n                         }\n                     }\n@@ -415,7 +415,7 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorageSealed\n                                 WriteBuffer::Borrowed(&task_id.to_le_bytes()),\n                             )\n                             .with_context(|| {\n-                                anyhow!(\"Unable to write task cache {task_type:?} => {task_id}\")\n+                                format!(\"Unable to write task cache {task_type:?} => {task_id}\")\n                             })?;\n                         batch\n                             .put(\n@@ -424,7 +424,7 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorageSealed\n                                 WriteBuffer::Borrowed(&task_type_bytes),\n                             )\n                             .with_context(|| {\n-                                anyhow!(\"Unable to write task cache {task_id} => {task_type:?}\")\n+                                format!(\"Unable to write task cache {task_id} => {task_type:?}\")\n                             })?;\n                         next_task_id = next_task_id.max(task_id + 1);\n                     }\n@@ -440,9 +440,7 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorageSealed\n \n         {\n             let _span = tracing::trace_span!(\"commit\").entered();\n-            batch\n-                .commit()\n-                .with_context(|| anyhow!(\"Unable to commit operations\"))?;\n+            batch.commit().context(\"Unable to commit operations\")?;\n         }\n         Ok(())\n     }"
        },
        {
            "sha": "308012054c5add0c17921aaebdf99de6d791d81b",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=ee9e68872eaffd2c974103503e928d60c83e7075",
            "patch": "@@ -1049,7 +1049,7 @@ impl FileSystem for DiskFileSystem {\n                             Err(err)\n                         }\n                     })\n-                    .with_context(|| anyhow!(\"removing {} failed\", full_path.display()))?;\n+                    .with_context(|| format!(\"removing {} failed\", full_path.display()))?;\n                 }\n             }\n \n@@ -1202,7 +1202,7 @@ impl FileSystem for DiskFileSystem {\n                             .concurrency_limited(&inner.write_semaphore)\n                             .await\n                             .with_context(|| {\n-                                anyhow!(\"removing existing symlink {} failed\", full_path.display())\n+                                format!(\"removing existing symlink {} failed\", full_path.display())\n                             })?;\n                     }\n \n@@ -1257,7 +1257,7 @@ impl FileSystem for DiskFileSystem {\n                         ))\n                         .concurrency_limited(&inner.write_semaphore)\n                         .await\n-                        .with_context(|| anyhow!(\"removing {} failed\", full_path.display()))?;\n+                        .with_context(|| format!(\"removing {} failed\", full_path.display()))?;\n                 }\n             }\n "
        },
        {
            "sha": "57ab3043c2e856f25e324fa63ede8fa817ae4643",
            "filename": "turbopack/crates/turbopack-bench/src/util/env.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fcrates%2Fturbopack-bench%2Fsrc%2Futil%2Fenv.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fcrates%2Fturbopack-bench%2Fsrc%2Futil%2Fenv.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-bench%2Fsrc%2Futil%2Fenv.rs?ref=ee9e68872eaffd2c974103503e928d60c83e7075",
            "patch": "@@ -1,6 +1,6 @@\n use std::{error::Error, str::FromStr};\n \n-use anyhow::{Context, Result, anyhow};\n+use anyhow::{Context, Result};\n \n /// Reads an environment variable.\n pub fn read_env<T>(name: &str, default: T) -> Result<T>\n@@ -13,7 +13,7 @@ where\n         None | Some(\"\") => Ok(default),\n         Some(config) => config\n             .parse()\n-            .with_context(|| anyhow!(\"Invalid value for {}\", name)),\n+            .with_context(|| format!(\"Invalid value for {}\", name)),\n     }\n }\n \n@@ -40,7 +40,7 @@ where\n             .split(',')\n             .map(|s| {\n                 s.parse()\n-                    .with_context(|| anyhow!(\"Invalid value for {}\", name))\n+                    .with_context(|| format!(\"Invalid value for {}\", name))\n             })\n             .collect(),\n     }"
        },
        {
            "sha": "69e2258dc0f5f3a4f46d449e563978489b355f11",
            "filename": "turbopack/crates/turbopack-tracing/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs?ref=ee9e68872eaffd2c974103503e928d60c83e7075",
            "patch": "@@ -16,7 +16,7 @@ use std::{\n     time::{Duration, Instant},\n };\n \n-use anyhow::{Context, Result, anyhow};\n+use anyhow::{Context, Result};\n use difference::Changeset;\n use helpers::print_changeset;\n use regex::Regex;\n@@ -645,8 +645,8 @@ async fn exec_node(directory: &str, path: &str) -> Result<CommandOutput> {\n \n     let output = timeout(Duration::from_secs(100), cmd.output())\n         .await\n-        .with_context(|| anyhow!(\"node execution of {path} is hanging\"))?\n-        .with_context(|| anyhow!(\"failed to spawn node process of {path}\"))?;\n+        .with_context(|| format!(\"node execution of {path} is hanging\"))?\n+        .with_context(|| format!(\"failed to spawn node process of {path}\"))?;\n \n     let output = CommandOutput {\n         stdout: String::from_utf8_lossy(&output.stdout).to_string(),"
        },
        {
            "sha": "456efa14221b899b12fecd79730971cb2c91959d",
            "filename": "turbopack/xtask/src/summarize_bench/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fxtask%2Fsrc%2Fsummarize_bench%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee9e68872eaffd2c974103503e928d60c83e7075/turbopack%2Fxtask%2Fsrc%2Fsummarize_bench%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fxtask%2Fsrc%2Fsummarize_bench%2Fmod.rs?ref=ee9e68872eaffd2c974103503e928d60c83e7075",
            "patch": "@@ -8,7 +8,7 @@ use std::{\n     time::{Duration, UNIX_EPOCH},\n };\n \n-use anyhow::{Context, anyhow};\n+use anyhow::Context;\n use chrono::{DateTime, Utc};\n use indexmap::IndexSet;\n use rustc_hash::{FxHashMap, FxHasher};\n@@ -84,7 +84,7 @@ pub fn process_all(path: PathBuf) {\n                     let file = File::open(&data_file.path).unwrap();\n                     let reader = std::io::BufReader::new(file);\n                     let data: BaseBenchmarks = serde_json::from_reader(reader)\n-                        .with_context(|| anyhow!(\"unable to read {}\", data_file.path.display()))\n+                        .with_context(|| format!(\"unable to read {}\", data_file.path.display()))\n                         .unwrap();\n                     data\n                 })"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 19,
        "deletions": 21
    }
}