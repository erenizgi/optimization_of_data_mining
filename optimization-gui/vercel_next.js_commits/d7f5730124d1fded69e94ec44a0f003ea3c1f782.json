{
    "author": "raunofreiberg",
    "message": "[Dev Tools] Improve keyboard interactions for menu & overlays (#76754)\n\nThis PR implements robust keyboard navigation for the Dev Tools dropdown\nmenu, and its nested overlays that appear.\n\nFull list of changes:\n- Use enum state `open` for making sure only one overlay can be open at\na time\n- Implement proper focus trapping through `useFocusTrap` to make sure\nfocus can never leave the trap\n- Fixed bugs related to focusing items in the menu\n- Focused index in the menu is retained when closing a nested overlay\n- Move all overlay-related logic to `DevToolsInfo`\n\n_Note: We should follow up with an assessment of ARIA attributes on all\nthese surfaces_\n\n\nhttps://github.com/user-attachments/assets/66a36359-1265-40dd-82cc-1032dfdcff28\n\nCloses NDX-927",
    "sha": "d7f5730124d1fded69e94ec44a0f003ea3c1f782",
    "files": [
        {
            "sha": "4577fcd84a39bf4b374a7b438302afd290586948",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-indicator.tsx",
            "status": "modified",
            "additions": 122,
            "deletions": 249,
            "changes": 371,
            "blob_url": "https://github.com/vercel/next.js/blob/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx?ref=d7f5730124d1fded69e94ec44a0f003ea3c1f782",
            "patch": "@@ -1,4 +1,4 @@\n-import type { Dispatch, SetStateAction } from 'react'\n+import type { CSSProperties, Dispatch, SetStateAction } from 'react'\n import { STORAGE_KEY_POSITION, type OverlayState } from '../../../../shared'\n \n import { useState, useEffect, useRef, createContext, useContext } from 'react'\n@@ -11,6 +11,12 @@ import { TurbopackInfo } from './dev-tools-info/turbopack-info'\n import { RouteInfo } from './dev-tools-info/route-info'\n import GearIcon from '../../../icons/gear-icon'\n import { UserPreferences } from './dev-tools-info/user-preferences'\n+import {\n+  MENU_CURVE,\n+  MENU_DURATION_MS,\n+  useClickOutside,\n+  useFocusTrap,\n+} from './utils'\n \n // TODO: add E2E tests to cover different scenarios\n \n@@ -59,9 +65,6 @@ export function DevToolsIndicator({\n \n //////////////////////////////////////////////////////////////////////////////////////\n \n-const ANIMATE_OUT_DURATION_MS = 200\n-const ANIMATE_OUT_TIMING_FUNCTION = 'cubic-bezier(0.175, 0.885, 0.32, 1.1)'\n-\n interface C {\n   closeMenu: () => void\n   selectedIndex: number\n@@ -83,6 +86,15 @@ function getInitialPosition() {\n   return INDICATOR_POSITION\n }\n \n+const OVERLAYS = {\n+  Root: 'root',\n+  Turbo: 'turbo',\n+  Route: 'route',\n+  Preferences: 'preferences',\n+} as const\n+\n+export type Overlays = (typeof OVERLAYS)[keyof typeof OVERLAYS]\n+\n function DevToolsPopover({\n   routerType,\n   disabled,\n@@ -107,91 +119,67 @@ function DevToolsPopover({\n }) {\n   const menuRef = useRef<HTMLDivElement>(null)\n   const triggerRef = useRef<HTMLButtonElement | null>(null)\n-  const turbopackRef = useRef<HTMLElement>(null)\n-  const triggerTurbopackRef = useRef<HTMLButtonElement | null>(null)\n-  const routeInfoRef = useRef<HTMLElement>(null)\n-  const triggerRouteInfoRef = useRef<HTMLButtonElement | null>(null)\n-  const preferencesRef = useRef<HTMLElement>(null)\n-  const triggerPreferencesRef = useRef<HTMLButtonElement | null>(null)\n-  const [isMenuOpen, setIsMenuOpen] = useState(false)\n-  const [isTurbopackInfoOpen, setIsTurbopackInfoOpen] = useState(false)\n-  const [isRouteInfoOpen, setIsRouteInfoOpen] = useState(false)\n-  const [isPreferencesOpen, setIsPreferencesOpen] = useState(false)\n-  const [selectedIndex, setSelectedIndex] = useState(-1)\n+\n+  const [open, setOpen] = useState<Overlays | null>(null)\n   const [position, setPosition] = useState(getInitialPosition())\n+  const [selectedIndex, setSelectedIndex] = useState(-1)\n+\n+  const isMenuOpen = open === OVERLAYS.Root\n+  const isTurbopackInfoOpen = open === OVERLAYS.Turbo\n+  const isRouteInfoOpen = open === OVERLAYS.Route\n+  const isPreferencesOpen = open === OVERLAYS.Preferences\n \n-  // This hook lets us do an exit animation before unmounting the component\n   const { mounted: menuMounted, rendered: menuRendered } = useDelayedRender(\n     isMenuOpen,\n     {\n       // Intentionally no fade in, makes the UI feel more immediate\n       enterDelay: 0,\n       // Graceful fade out to confirm that the UI did not break\n-      exitDelay: ANIMATE_OUT_DURATION_MS,\n+      exitDelay: MENU_DURATION_MS,\n     }\n   )\n-  const { mounted: turbopackInfoMounted, rendered: turbopackInfoRendered } =\n-    useDelayedRender(isTurbopackInfoOpen, {\n-      enterDelay: 0,\n-      exitDelay: ANIMATE_OUT_DURATION_MS,\n-    })\n-  const { mounted: routeInfoMounted, rendered: routeInfoRendered } =\n-    useDelayedRender(isRouteInfoOpen, {\n-      enterDelay: 0,\n-      exitDelay: ANIMATE_OUT_DURATION_MS,\n-    })\n-  const { mounted: preferencesMounted, rendered: preferencesRendered } =\n-    useDelayedRender(isPreferencesOpen, {\n-      enterDelay: 0,\n-      exitDelay: ANIMATE_OUT_DURATION_MS,\n-    })\n \n   // Features to make the menu accessible\n   useFocusTrap(menuRef, triggerRef, isMenuOpen)\n   useClickOutside(menuRef, triggerRef, isMenuOpen, closeMenu)\n-  useFocusTrap(turbopackRef, triggerTurbopackRef, isTurbopackInfoOpen)\n-  useClickOutside(\n-    turbopackRef,\n-    triggerTurbopackRef,\n-    isTurbopackInfoOpen,\n-    closeTurbopackInfo\n-  )\n-  useFocusTrap(routeInfoRef, triggerRouteInfoRef, isRouteInfoOpen)\n-  useClickOutside(\n-    routeInfoRef,\n-    triggerRouteInfoRef,\n-    isRouteInfoOpen,\n-    closeRouteInfo\n-  )\n-  useFocusTrap(preferencesRef, triggerPreferencesRef, isPreferencesOpen)\n-  useClickOutside(\n-    preferencesRef,\n-    triggerPreferencesRef,\n-    isPreferencesOpen,\n-    closePreferences\n-  )\n+\n+  useEffect(() => {\n+    if (open === null) {\n+      // Avoid flashing selected state\n+      const id = setTimeout(() => {\n+        setSelectedIndex(-1)\n+      }, MENU_DURATION_MS)\n+      return () => clearTimeout(id)\n+    }\n+  }, [open])\n+\n   function select(index: number | 'first' | 'last') {\n     if (index === 'first') {\n-      const all = menuRef.current?.querySelectorAll('[role=\"menuitem\"]')\n-      if (all) {\n-        const firstIndex = all[0].getAttribute('data-index')\n-        select(Number(firstIndex))\n-      }\n+      setTimeout(() => {\n+        const all = menuRef.current?.querySelectorAll('[role=\"menuitem\"]')\n+        if (all) {\n+          const firstIndex = all[0].getAttribute('data-index')\n+          select(Number(firstIndex))\n+        }\n+      })\n       return\n     }\n \n     if (index === 'last') {\n-      const all = menuRef.current?.querySelectorAll('[role=\"menuitem\"]')\n-      if (all) {\n-        const lastIndex = all.length - 1\n-        select(lastIndex)\n-      }\n+      setTimeout(() => {\n+        const all = menuRef.current?.querySelectorAll('[role=\"menuitem\"]')\n+        if (all) {\n+          const lastIndex = all.length - 1\n+          select(lastIndex)\n+        }\n+      })\n       return\n     }\n \n     const el = menuRef.current?.querySelector(\n       `[data-index=\"${index}\"]`\n     ) as HTMLElement\n+\n     if (el) {\n       setSelectedIndex(index)\n       el?.focus()\n@@ -221,33 +209,8 @@ function DevToolsPopover({\n     }\n   }\n \n-  function onTriggerKeydown(e: React.KeyboardEvent<HTMLButtonElement>) {\n-    if (isMenuOpen) {\n-      return\n-    }\n-\n-    // Open with first item focused\n-    if (e.key === 'ArrowDown' || e.key === 'Enter' || e.key === ' ') {\n-      e.preventDefault()\n-      setIsMenuOpen(true)\n-      // Run on next tick because querying DOM after state change\n-      setTimeout(() => {\n-        select('first')\n-      })\n-    }\n-\n-    // Open with last item focused\n-    if (e.key === 'ArrowUp') {\n-      e.preventDefault()\n-      setIsMenuOpen(true)\n-      // Run on next tick because querying DOM after state change\n-      setTimeout(() => {\n-        select('last')\n-      })\n-    }\n-  }\n-\n   function openErrorOverlay() {\n+    setOpen(null)\n     if (issueCount > 0) {\n       setIsErrorOverlayOpen(true)\n     }\n@@ -257,50 +220,61 @@ function DevToolsPopover({\n     setIsErrorOverlayOpen((prev) => !prev)\n   }\n \n-  function onTriggerClick() {\n-    setIsMenuOpen((prev) => !prev)\n-  }\n-\n-  function closeMenu() {\n-    setIsMenuOpen(false)\n-    // Avoid flashing selected state\n-    setTimeout(() => {\n-      setSelectedIndex(-1)\n-    }, ANIMATE_OUT_DURATION_MS)\n-  }\n-\n-  function closeTurbopackInfo() {\n-    setIsTurbopackInfoOpen(false)\n+  function openRootMenu() {\n+    setOpen((prevOpen) => {\n+      if (prevOpen === null) select('first')\n+      return OVERLAYS.Root\n+    })\n   }\n \n-  function closeRouteInfo() {\n-    setIsRouteInfoOpen(false)\n+  function onTriggerClick() {\n+    if (open === OVERLAYS.Root) {\n+      setOpen(null)\n+    } else {\n+      openRootMenu()\n+      setTimeout(() => {\n+        select('first')\n+      })\n+    }\n   }\n \n-  function closePreferences() {\n-    setIsPreferencesOpen(false)\n+  function closeMenu() {\n+    // Only close when we were on `Root`,\n+    // otherwise it will close other overlays\n+    setOpen((prevOpen) => {\n+      if (prevOpen === OVERLAYS.Root) {\n+        return null\n+      }\n+      return prevOpen\n+    })\n   }\n \n   function handleHideDevtools() {\n-    closePreferences()\n+    setOpen(null)\n     hide()\n   }\n \n   const [vertical, horizontal] = position.split('-', 2)\n+  const popover = { [vertical]: 'calc(100% + 8px)', [horizontal]: 0 }\n \n   return (\n     <Toast\n       data-nextjs-toast\n-      style={{\n-        boxShadow: 'none',\n-        zIndex: 2147483647,\n-        // Reset the toast component's default positions.\n-        bottom: 'initial',\n-        left: 'initial',\n-        [vertical]: '10px',\n-        [horizontal]: '20px',\n-      }}\n+      style={\n+        {\n+          '--animate-out-duration-ms': `${MENU_DURATION_MS}ms`,\n+          '--animate-out-timing-function': MENU_CURVE,\n+          boxShadow: 'none',\n+          zIndex: 2147483647,\n+          // Reset the toast component's default positions.\n+          bottom: 'initial',\n+          left: 'initial',\n+          [vertical]: '10px',\n+          [horizontal]: '20px',\n+        } as CSSProperties\n+      }\n     >\n+      {/* Trigger */}\n       <NextLogo\n         ref={triggerRef}\n         aria-haspopup=\"menu\"\n@@ -311,58 +285,42 @@ function DevToolsPopover({\n         disabled={disabled}\n         issueCount={issueCount}\n         onTriggerClick={onTriggerClick}\n-        onKeyDown={onTriggerKeydown}\n         toggleErrorOverlay={toggleErrorOverlay}\n         isDevBuilding={useIsDevBuilding()}\n         isDevRendering={useIsDevRendering()}\n         isBuildError={isBuildError}\n       />\n \n-      {routeInfoMounted && (\n-        <RouteInfo\n-          ref={routeInfoRef}\n-          routerType={routerType}\n-          routeType={isStaticRoute ? 'Static' : 'Dynamic'}\n-          isOpen={isRouteInfoOpen}\n-          setIsOpen={setIsRouteInfoOpen}\n-          setPreviousOpen={setIsMenuOpen}\n-          style={{\n-            [vertical]: 'calc(100% + 8px)',\n-            [horizontal]: 0,\n-          }}\n-          data-rendered={routeInfoRendered}\n-        />\n-      )}\n+      {/* Route Info */}\n+      <RouteInfo\n+        isOpen={isRouteInfoOpen}\n+        close={openRootMenu}\n+        triggerRef={triggerRef}\n+        style={popover}\n+        routerType={routerType}\n+        routeType={isStaticRoute ? 'Static' : 'Dynamic'}\n+      />\n \n-      {turbopackInfoMounted && (\n-        <TurbopackInfo\n-          ref={turbopackRef}\n-          isOpen={isTurbopackInfoOpen}\n-          setIsOpen={setIsTurbopackInfoOpen}\n-          setPreviousOpen={setIsMenuOpen}\n-          style={{\n-            [vertical]: 'calc(100% + 8px)',\n-            [horizontal]: 0,\n-          }}\n-          data-rendered={turbopackInfoRendered}\n-        />\n-      )}\n+      {/* Turbopack Info */}\n+      <TurbopackInfo\n+        isOpen={isTurbopackInfoOpen}\n+        close={openRootMenu}\n+        triggerRef={triggerRef}\n+        style={popover}\n+      />\n \n-      {preferencesMounted && (\n-        <UserPreferences\n-          ref={preferencesRef}\n-          isOpen={isPreferencesOpen}\n-          hide={handleHideDevtools}\n-          setPosition={setPosition}\n-          position={position}\n-          style={{\n-            [vertical]: 'calc(100% + 8px)',\n-            [horizontal]: 0,\n-          }}\n-          data-rendered={preferencesRendered}\n-        />\n-      )}\n+      {/* Preferences */}\n+      <UserPreferences\n+        isOpen={isPreferencesOpen}\n+        close={openRootMenu}\n+        triggerRef={triggerRef}\n+        style={popover}\n+        hide={handleHideDevtools}\n+        setPosition={setPosition}\n+        position={position}\n+      />\n \n+      {/* Dropdown Menu */}\n       {menuMounted && (\n         <div\n           ref={menuRef}\n@@ -375,14 +333,7 @@ function DevToolsPopover({\n           className=\"dev-tools-indicator-menu\"\n           onKeyDown={onMenuKeydown}\n           data-rendered={menuRendered}\n-          style={\n-            {\n-              '--animate-out-duration-ms': `${ANIMATE_OUT_DURATION_MS}ms`,\n-              '--animate-out-timing-function': ANIMATE_OUT_TIMING_FUNCTION,\n-              [vertical]: 'calc(100% + 8px)',\n-              [horizontal]: 0,\n-            } as React.CSSProperties\n-          }\n+          style={popover}\n         >\n           <Context.Provider\n             value={{\n@@ -406,7 +357,7 @@ function DevToolsPopover({\n                 label=\"Route\"\n                 index={1}\n                 value={isStaticRoute ? 'Static' : 'Dynamic'}\n-                onClick={() => setIsRouteInfoOpen(true)}\n+                onClick={() => setOpen(OVERLAYS.Route)}\n                 data-nextjs-route-type={isStaticRoute ? 'static' : 'dynamic'}\n               />\n               {isTurbopack ? (\n@@ -421,7 +372,7 @@ function DevToolsPopover({\n                   title=\"Learn about Turbopack and how to enable it in your application.\"\n                   label=\"Try Turbopack\"\n                   value={<ChevronRight />}\n-                  onClick={() => setIsTurbopackInfoOpen(true)}\n+                  onClick={() => setOpen(OVERLAYS.Turbo)}\n                 />\n               )}\n             </div>\n@@ -431,7 +382,7 @@ function DevToolsPopover({\n                 data-preferences\n                 label=\"Preferences\"\n                 value={<GearIcon />}\n-                onClick={() => setIsPreferencesOpen(true)}\n+                onClick={() => setOpen(OVERLAYS.Preferences)}\n                 index={isTurbopack ? 2 : 3}\n               />\n             </div>\n@@ -534,84 +485,6 @@ function IssueCount({ children }: { children: number }) {\n \n //////////////////////////////////////////////////////////////////////////////////////\n \n-function useFocusTrap(\n-  menuRef: React.RefObject<HTMLElement | null>,\n-  triggerRef: React.RefObject<HTMLButtonElement | null>,\n-  isMenuOpen: boolean\n-) {\n-  useEffect(() => {\n-    if (isMenuOpen) {\n-      menuRef.current?.focus()\n-    } else {\n-      const root = triggerRef.current?.getRootNode()\n-      const activeElement =\n-        root instanceof ShadowRoot ? (root?.activeElement as HTMLElement) : null\n-\n-      // Only restore focus if the focus was previously on the menu.\n-      // This avoids us accidentally focusing on mount when the\n-      // user could want to interact with their own app instead.\n-      if (menuRef.current?.contains(activeElement)) {\n-        triggerRef.current?.focus()\n-      }\n-    }\n-    // eslint-disable-next-line react-hooks/exhaustive-deps\n-  }, [isMenuOpen])\n-}\n-\n-//////////////////////////////////////////////////////////////////////////////////////\n-\n-function useClickOutside(\n-  menuRef: React.RefObject<HTMLElement | null>,\n-  triggerRef: React.RefObject<HTMLButtonElement | null>,\n-  isMenuOpen: boolean,\n-  closeMenu: () => void\n-) {\n-  useEffect(() => {\n-    if (!isMenuOpen) {\n-      return\n-    }\n-\n-    // Close menu when clicking outside of it or its button\n-    const handleClickOutside = (event: MouseEvent) => {\n-      if (\n-        !(menuRef.current?.getBoundingClientRect()\n-          ? event.clientX >= menuRef.current.getBoundingClientRect()!.left &&\n-            event.clientX <= menuRef.current.getBoundingClientRect()!.right &&\n-            event.clientY >= menuRef.current.getBoundingClientRect()!.top &&\n-            event.clientY <= menuRef.current.getBoundingClientRect()!.bottom\n-          : false) &&\n-        !(triggerRef.current?.getBoundingClientRect()\n-          ? event.clientX >= triggerRef.current.getBoundingClientRect()!.left &&\n-            event.clientX <=\n-              triggerRef.current.getBoundingClientRect()!.right &&\n-            event.clientY >= triggerRef.current.getBoundingClientRect()!.top &&\n-            event.clientY <= triggerRef.current.getBoundingClientRect()!.bottom\n-          : false)\n-      ) {\n-        closeMenu()\n-      }\n-    }\n-\n-    // Close popover when pressing escape\n-    const handleKeyDown = (event: KeyboardEvent) => {\n-      if (event.key === 'Escape') {\n-        closeMenu()\n-      }\n-    }\n-\n-    document.addEventListener('mousedown', handleClickOutside)\n-    document.addEventListener('keydown', handleKeyDown)\n-\n-    return () => {\n-      document.removeEventListener('mousedown', handleClickOutside)\n-      document.removeEventListener('keydown', handleKeyDown)\n-    }\n-    // eslint-disable-next-line react-hooks/exhaustive-deps\n-  }, [isMenuOpen])\n-}\n-\n-//////////////////////////////////////////////////////////////////////////////////////\n-\n export const DEV_TOOLS_INDICATOR_STYLES = `\n   .dev-tools-indicator-menu {\n     -webkit-font-smoothing: antialiased;"
        },
        {
            "sha": "f9c7b53c74268d6d0f14d9fde83c8862d3a088d0",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-info/dev-tools-info.tsx",
            "status": "modified",
            "additions": 62,
            "deletions": 27,
            "changes": 89,
            "blob_url": "https://github.com/vercel/next.js/blob/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fdev-tools-info.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fdev-tools-info.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fdev-tools-info.tsx?ref=d7f5730124d1fded69e94ec44a0f003ea3c1f782",
            "patch": "@@ -1,37 +1,69 @@\n+import { useRef } from 'react'\n+import { MENU_DURATION_MS, useClickOutside, useFocusTrap } from '../utils'\n+import { useDelayedRender } from '../../../../hooks/use-delayed-render'\n+\n+export interface DevToolsInfoPropsCore {\n+  isOpen: boolean\n+  triggerRef: React.RefObject<HTMLButtonElement | null>\n+  close: () => void\n+}\n+\n+export interface DevToolsInfoProps extends DevToolsInfoPropsCore {\n+  title: string\n+  children: React.ReactNode\n+  learnMoreLink?: string\n+}\n+\n export function DevToolsInfo({\n   title,\n   children,\n   learnMoreLink,\n-  setIsOpen,\n-  setPreviousOpen,\n+  isOpen,\n+  triggerRef,\n+  close,\n   ...props\n-}: {\n-  title: string\n-  children: React.ReactNode\n-  learnMoreLink?: string\n-  setIsOpen?: (isOpen: boolean) => void\n-  setPreviousOpen?: (isOpen: boolean) => void\n-}) {\n-  const hasActionButtons = Boolean(\n-    learnMoreLink && setIsOpen && setPreviousOpen\n-  )\n+}: DevToolsInfoProps) {\n+  const ref = useRef<HTMLDivElement | null>(null)\n+  const closeButtonRef = useRef<HTMLButtonElement | null>(null)\n+\n+  const { mounted, rendered } = useDelayedRender(isOpen, {\n+    // Intentionally no fade in, makes the UI feel more immediate\n+    enterDelay: 0,\n+    // Graceful fade out to confirm that the UI did not break\n+    exitDelay: MENU_DURATION_MS,\n+  })\n+\n+  useFocusTrap(ref, triggerRef, isOpen, () => {\n+    // Bring focus to close button, so the user can easily close the overlay\n+    closeButtonRef.current?.focus()\n+  })\n+  useClickOutside(ref, triggerRef, isOpen, close)\n+\n+  if (!mounted) {\n+    return null\n+  }\n \n   return (\n-    <div data-info-popover {...props}>\n+    <div\n+      tabIndex={-1}\n+      role=\"dialog\"\n+      ref={ref}\n+      data-info-popover\n+      {...props}\n+      data-rendered={rendered}\n+    >\n       <div className=\"dev-tools-info-container\">\n         <h1 className=\"dev-tools-info-title\">{title}</h1>\n         {children}\n-        {hasActionButtons && (\n-          <div className=\"dev-tools-info-button-container\">\n-            <button\n-              className=\"dev-tools-info-close-button\"\n-              onClick={() => {\n-                setIsOpen?.(false)\n-                setPreviousOpen?.(true)\n-              }}\n-            >\n-              Close\n-            </button>\n+        <div className=\"dev-tools-info-button-container\">\n+          <button\n+            ref={closeButtonRef}\n+            className=\"dev-tools-info-close-button\"\n+            onClick={close}\n+          >\n+            Close\n+          </button>\n+          {learnMoreLink && (\n             <a\n               className=\"dev-tools-info-learn-more-button\"\n               href={learnMoreLink}\n@@ -40,8 +72,8 @@ export function DevToolsInfo({\n             >\n               Learn More\n             </a>\n-          </div>\n-        )}\n+          )}\n+        </div>\n       </div>\n     </div>\n   )\n@@ -72,6 +104,10 @@ export const DEV_TOOLS_INFO_STYLES = `\n       opacity: 1;\n       scale: 1;\n     }\n+\n+    button:focus-visible {\n+      outline: var(--focus-ring);\n+    }\n   }\n \n   .dev-tools-info-container {\n@@ -134,7 +170,6 @@ export const DEV_TOOLS_INFO_STYLES = `\n     transition: background var(--duration-short) ease;\n     color: var(--color-background-100);\n     border-radius: var(--rounded-md-2);\n-    border: 1px solid var(--color-gray-1000);\n     background: var(--color-gray-1000);\n   }\n "
        },
        {
            "sha": "4c18da6e5c755f3c549a24077a38dc76b0dbc171",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-info/route-info.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Froute-info.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Froute-info.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Froute-info.tsx?ref=d7f5730124d1fded69e94ec44a0f003ea3c1f782",
            "patch": "@@ -1,3 +1,5 @@\n+import type { HTMLProps } from 'react'\n+import type { DevToolsInfoPropsCore } from './dev-tools-info'\n import { DevToolsInfo } from './dev-tools-info'\n \n function StaticRouteContent({ routerType }: { routerType: 'pages' | 'app' }) {\n@@ -106,36 +108,28 @@ const learnMoreLink = {\n     dynamic:\n       'https://nextjs.org/docs/app/building-your-application/rendering/server-components#dynamic-rendering',\n   },\n-}\n+} as const\n \n export function RouteInfo({\n   routeType,\n   routerType,\n-  isOpen,\n-  setIsOpen,\n-  setPreviousOpen,\n   ...props\n }: {\n   routeType: 'Static' | 'Dynamic'\n   routerType: 'pages' | 'app'\n-  isOpen: boolean\n-  setIsOpen: (isOpen: boolean) => void\n-  setPreviousOpen: (isOpen: boolean) => void\n-  style?: React.CSSProperties\n-  ref?: React.RefObject<HTMLElement | null>\n-}) {\n+} & DevToolsInfoPropsCore &\n+  HTMLProps<HTMLDivElement>) {\n   const isStaticRoute = routeType === 'Static'\n \n   const learnMore = isStaticRoute\n     ? learnMoreLink[routerType].static\n     : learnMoreLink[routerType].dynamic\n+\n   return (\n     <DevToolsInfo\n-      {...props}\n       title={`${routeType} Route`}\n       learnMoreLink={learnMore}\n-      setIsOpen={setIsOpen}\n-      setPreviousOpen={setPreviousOpen}\n+      {...props}\n     >\n       {isStaticRoute ? (\n         <StaticRouteContent routerType={routerType} />"
        },
        {
            "sha": "9fef23500ea489ce5d94a4b0cbf701a73e4aa843",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-info/turbopack-info.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 15,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fturbopack-info.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fturbopack-info.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fturbopack-info.tsx?ref=d7f5730124d1fded69e94ec44a0f003ea3c1f782",
            "patch": "@@ -1,24 +1,14 @@\n-import { DevToolsInfo } from './dev-tools-info'\n+import { DevToolsInfo, type DevToolsInfoPropsCore } from './dev-tools-info'\n import { CopyButton } from '../../../copy-button'\n+import type { HTMLProps } from 'react'\n \n-export function TurbopackInfo({\n-  isOpen,\n-  setIsOpen,\n-  setPreviousOpen,\n-  ...props\n-}: {\n-  isOpen: boolean\n-  setIsOpen: (isOpen: boolean) => void\n-  setPreviousOpen: (isOpen: boolean) => void\n-  style?: React.CSSProperties\n-  ref?: React.RefObject<HTMLElement | null>\n-}) {\n+export function TurbopackInfo(\n+  props: DevToolsInfoPropsCore & HTMLProps<HTMLDivElement>\n+) {\n   return (\n     <DevToolsInfo\n       title=\"Turbopack\"\n       learnMoreLink=\"https://nextjs.org/docs/app/api-reference/turbopack\"\n-      setIsOpen={setIsOpen}\n-      setPreviousOpen={setPreviousOpen}\n       {...props}\n     >\n       <article className=\"dev-tools-info-article\">"
        },
        {
            "sha": "bb064107dd67a1975380bfc119e9230832a27538",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-info/user-preferences.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx?ref=d7f5730124d1fded69e94ec44a0f003ea3c1f782",
            "patch": "@@ -1,12 +1,13 @@\n-import { useState } from 'react'\n-import { DevToolsInfo } from './dev-tools-info'\n+import { useState, type HTMLProps } from 'react'\n import { css } from '../../../../../utils/css'\n-import type { DevToolsIndicatorPosition } from '../dev-tools-indicator'\n import EyeIcon from '../../../../icons/eye-icon'\n import { STORAGE_KEY_POSITION, STORAGE_KEY_THEME } from '../../../../../shared'\n import LightIcon from '../../../../icons/light-icon'\n import DarkIcon from '../../../../icons/dark-icon'\n import SystemIcon from '../../../../icons/system-icon'\n+import type { DevToolsInfoPropsCore } from './dev-tools-info'\n+import { DevToolsInfo } from './dev-tools-info'\n+import type { DevToolsIndicatorPosition } from '../dev-tools-indicator'\n \n function getInitialPreference() {\n   if (typeof localStorage === 'undefined') {\n@@ -18,19 +19,16 @@ function getInitialPreference() {\n }\n \n export function UserPreferences({\n-  isOpen,\n   setPosition,\n   position,\n   hide,\n   ...props\n }: {\n-  isOpen: boolean\n   setPosition: (position: DevToolsIndicatorPosition) => void\n   position: DevToolsIndicatorPosition\n   hide: () => void\n-  style?: React.CSSProperties\n-  ref?: React.RefObject<HTMLElement | null>\n-}) {\n+} & DevToolsInfoPropsCore &\n+  HTMLProps<HTMLDivElement>) {\n   // derive initial theme from system preference\n   const [theme, setTheme] = useState(getInitialPreference())\n \n@@ -253,7 +251,7 @@ export const DEV_TOOLS_INFO_USER_PREFERENCES_STYLES = css`\n     }\n \n     &:focus-within {\n-      outline: 5px auto -webkit-focus-ring-color;\n+      outline: var(--focus-ring);\n     }\n   }\n "
        },
        {
            "sha": "47d1ec00264e58b11d47d191642f0da401859b57",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/utils.ts",
            "status": "added",
            "additions": 134,
            "deletions": 0,
            "changes": 134,
            "blob_url": "https://github.com/vercel/next.js/blob/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7f5730124d1fded69e94ec44a0f003ea3c1f782/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts?ref=d7f5730124d1fded69e94ec44a0f003ea3c1f782",
            "patch": "@@ -0,0 +1,134 @@\n+import { useEffect } from 'react'\n+\n+export function useFocusTrap(\n+  rootRef: React.RefObject<HTMLElement | null>,\n+  triggerRef: React.RefObject<HTMLButtonElement | null>,\n+  active: boolean,\n+  onOpenFocus?: () => void\n+) {\n+  useEffect(() => {\n+    let rootNode: HTMLElement | null = null\n+\n+    function onTab(e: KeyboardEvent) {\n+      if (e.key !== 'Tab' || rootNode === null) {\n+        return\n+      }\n+\n+      const [firstFocusableNode, lastFocusableNode] =\n+        getFocusableNodes(rootNode)\n+      const activeElement = getActiveElement(rootNode)\n+\n+      if (e.shiftKey) {\n+        if (activeElement === firstFocusableNode) {\n+          lastFocusableNode?.focus()\n+          e.preventDefault()\n+        }\n+      } else {\n+        if (activeElement === lastFocusableNode) {\n+          firstFocusableNode?.focus()\n+          e.preventDefault()\n+        }\n+      }\n+    }\n+\n+    const id = setTimeout(() => {\n+      // Grab this on next tick to ensure the content is mounted\n+      rootNode = rootRef.current\n+      if (active) {\n+        if (onOpenFocus) {\n+          onOpenFocus()\n+        } else {\n+          rootNode?.focus()\n+        }\n+        rootNode?.addEventListener('keydown', onTab)\n+      } else {\n+        const activeElement = getActiveElement(rootNode)\n+        // Only restore focus if the focus was previously on the content.\n+        // This avoids us accidentally focusing on mount when the\n+        // user could want to interact with their own app instead.\n+        if (rootNode?.contains(activeElement)) {\n+          triggerRef.current?.focus()\n+        }\n+      }\n+    })\n+\n+    return () => {\n+      clearTimeout(id)\n+      rootNode?.removeEventListener('keydown', onTab)\n+    }\n+    // eslint-disable-next-line react-hooks/exhaustive-deps\n+  }, [active])\n+}\n+\n+function getActiveElement(node: HTMLElement | null) {\n+  const root = node?.getRootNode()\n+  return root instanceof ShadowRoot\n+    ? (root?.activeElement as HTMLElement)\n+    : null\n+}\n+\n+function getFocusableNodes(node: HTMLElement): [HTMLElement, HTMLElement] | [] {\n+  const focusableElements = node.querySelectorAll(\n+    'button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])'\n+  )\n+  if (!focusableElements) return []\n+  return [\n+    focusableElements![0] as HTMLElement,\n+    focusableElements![focusableElements!.length - 1] as HTMLElement,\n+  ]\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////////////\n+\n+export function useClickOutside(\n+  rootRef: React.RefObject<HTMLElement | null>,\n+  triggerRef: React.RefObject<HTMLButtonElement | null>,\n+  active: boolean,\n+  close: () => void\n+) {\n+  useEffect(() => {\n+    if (!active) {\n+      return\n+    }\n+\n+    function handleClickOutside(event: MouseEvent) {\n+      if (\n+        !(rootRef.current?.getBoundingClientRect()\n+          ? event.clientX >= rootRef.current.getBoundingClientRect()!.left &&\n+            event.clientX <= rootRef.current.getBoundingClientRect()!.right &&\n+            event.clientY >= rootRef.current.getBoundingClientRect()!.top &&\n+            event.clientY <= rootRef.current.getBoundingClientRect()!.bottom\n+          : false) &&\n+        !(triggerRef.current?.getBoundingClientRect()\n+          ? event.clientX >= triggerRef.current.getBoundingClientRect()!.left &&\n+            event.clientX <=\n+              triggerRef.current.getBoundingClientRect()!.right &&\n+            event.clientY >= triggerRef.current.getBoundingClientRect()!.top &&\n+            event.clientY <= triggerRef.current.getBoundingClientRect()!.bottom\n+          : false)\n+      ) {\n+        close()\n+      }\n+    }\n+\n+    function handleKeyDown(event: KeyboardEvent) {\n+      if (event.key === 'Escape') {\n+        close()\n+      }\n+    }\n+\n+    document.addEventListener('mousedown', handleClickOutside)\n+    document.addEventListener('keydown', handleKeyDown)\n+\n+    return () => {\n+      document.removeEventListener('mousedown', handleClickOutside)\n+      document.removeEventListener('keydown', handleKeyDown)\n+    }\n+    // eslint-disable-next-line react-hooks/exhaustive-deps\n+  }, [active])\n+}\n+\n+//////////////////////////////////////////////////////////////////////////////////////\n+\n+export const MENU_DURATION_MS = 200\n+export const MENU_CURVE = 'cubic-bezier(0.175, 0.885, 0.32, 1.1)'"
        }
    ],
    "stats": {
        "total": 650,
        "additions": 337,
        "deletions": 313
    }
}