{
    "author": "icyJoseph",
    "message": "fix: find root dir on fs root (#82590)\n\nAttempt at fixing from our side:\nhttps://github.com/vercel/next.js/issues/82577\n\nRather, the issue is that when the project is at the root of the file\nsystem - `findRootDir` loops indefinitely, and we keep pushing to the\nlockFiles found.\n\nI also noticed the warning claims we use the last lockfile found, but we\nreturn `dirname(lockfile)` - that is the first lock file found.\n\nRegardless, when using this project setup:\n\n```console\n.\n├── apps\n│   └── frontend\n│       ├── README.md\n│       ├── next.config.ts\n│       ├── package.json\n│       ├── pnpm-lock.yaml\n│       ├── src\n│       │   └── app\n│       │       ├── globals.css\n│       │       ├── layout.tsx\n│       │       └── page.tsx\n│       └── tsconfig.json\n├── package.json\n├── pnpm-lock.yaml\n└── pnpm-workspace.yaml\n```\n\nRunning `pnpm --filter frontend dev` still ends up in panic: `Error\n[TurbopackInternalError]: Next.js package not found` - Maybe that's\nstill expected :)\n\nAs for https://github.com/vercel/next.js/issues/82577 - a way for them\nto get unblocked is to use a `WORKDIR`. More details on that issue\nthread.\n\n---------\n\nCo-authored-by: Luke Sandberg <lukesandberg@users.noreply.github.com>",
    "sha": "925f8a9446ca67551324825033febea3accd6419",
    "files": [
        {
            "sha": "54bc7f54c7fc7befb150b9fe5bf0a96ae59f2766",
            "filename": "packages/next/src/lib/find-root.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 9,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/925f8a9446ca67551324825033febea3accd6419/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/925f8a9446ca67551324825033febea3accd6419/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts?ref=925f8a9446ca67551324825033febea3accd6419",
            "patch": "@@ -23,21 +23,25 @@ export function findRootDir(cwd: string) {\n \n   const lockFiles = [lockFile]\n   while (true) {\n-    const nextDir = dirname(dirname(lockFiles[lockFiles.length - 1]))\n-    const newLockFile = findRootLockFile(nextDir)\n+    const lastLockFile = lockFiles[lockFiles.length - 1]\n+    const currentDir = dirname(lastLockFile)\n+    const parentDir = dirname(currentDir)\n \n-    if (newLockFile) {\n-      lockFiles.push(newLockFile)\n-    } else {\n-      break\n-    }\n+    // dirname('/')==='/' so if we happen to reach the FS root (as might happen in a container we need to quit to avoid looping forever\n+    if (parentDir === currentDir) break\n+\n+    const newLockFile = findRootLockFile(parentDir)\n+\n+    if (!newLockFile) break\n+\n+    lockFiles.push(newLockFile)\n   }\n \n   // Only warn if not in a build worker to avoid duplicate warnings\n   if (typeof process.send !== 'function' && lockFiles.length > 1) {\n     const additionalLockFiles = lockFiles\n       .slice(0, -1)\n-      .map((str) => '\\n   * ' + str)\n+      .map((str) => `\\n   * ${str}`)\n       .join('')\n \n     if (process.env.TURBOPACK) {\n@@ -61,5 +65,5 @@ export function findRootDir(cwd: string) {\n     }\n   }\n \n-  return dirname(lockFile)\n+  return dirname(lockFiles[lockFiles.length - 1])\n }"
        }
    ],
    "stats": {
        "total": 22,
        "additions": 13,
        "deletions": 9
    }
}