{
    "author": "gnoff",
    "message": "Resolve Viewport separately from Metadata (#77427)\n\nViewport blocks the root while Metadata no longer does. However Metadata\nrequires the reading of dynamic params for things like icon loading and\nother features that require the path whereas viewport does not. Reading\nthe path in fallback prerenders is considered dynamic when DIO is\nenabled which means that any dynamic route with a file based metadata\nsuch as an icon will trigger dynamic at the root.\n\nTo Address this we simply resolve viewport separately from metadata.",
    "sha": "c7a338df5ada1c410d9bfb16abf0ed85d2694fc0",
    "files": [
        {
            "sha": "9b8c593abec534c48b67af634d344fedb798781d",
            "filename": "packages/next/src/lib/metadata/metadata.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx?ref=c7a338df5ada1c410d9bfb16abf0ed85d2694fc0",
            "patch": "@@ -355,17 +355,16 @@ async function renderViewport(\n   workStore: WorkStore,\n   errorConvention?: MetadataErrorType\n ) {\n-  const notFoundResolvedViewport = await resolveViewport(\n+  const resolvedViewport = await resolveViewport(\n     tree,\n     searchParams,\n     errorConvention,\n     getDynamicParamFromSegment,\n     workStore\n   )\n \n-  const elements: Array<React.ReactNode> = createViewportElements(\n-    notFoundResolvedViewport\n-  )\n+  const elements: Array<React.ReactNode> =\n+    createViewportElements(resolvedViewport)\n   return (\n     <>\n       {elements.map((el, index) => {"
        },
        {
            "sha": "096f5ca9caf7d0b70b7cbd1202f23426ac99f5c7",
            "filename": "packages/next/src/lib/metadata/resolve-metadata.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.test.ts?ref=c7a338df5ada1c410d9bfb16abf0ed85d2694fc0",
            "patch": "@@ -12,7 +12,6 @@ function accumulateMetadata(metadataItems: MetadataItems) {\n   const fullMetadataItems: FullMetadataItems = metadataItems.map((item) => [\n     item[0],\n     item[1],\n-    null,\n   ])\n   return originAccumulateMetadata(fullMetadataItems, {\n     pathname: '/test',\n@@ -23,9 +22,7 @@ function accumulateMetadata(metadataItems: MetadataItems) {\n \n function accumulateViewport(viewportExports: Viewport[]) {\n   // skip the first two arguments (metadata and static metadata)\n-  return originAccumulateViewport(\n-    viewportExports.map((item) => [null, null, item])\n-  )\n+  return originAccumulateViewport(viewportExports.map((item) => item))\n }\n \n function mapUrlsToStrings(obj: any) {"
        },
        {
            "sha": "35fdbcaa4a83af4176acf82d6b1e6f637321e277",
            "filename": "packages/next/src/lib/metadata/resolve-metadata.ts",
            "status": "modified",
            "additions": 170,
            "deletions": 20,
            "changes": 190,
            "blob_url": "https://github.com/vercel/next.js/blob/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts?ref=c7a338df5ada1c410d9bfb16abf0ed85d2694fc0",
            "patch": "@@ -68,11 +68,11 @@ type ViewportResolver = (\n \n export type MetadataErrorType = 'not-found' | 'forbidden' | 'unauthorized'\n \n-export type MetadataItems = [\n-  Metadata | MetadataResolver | null,\n-  StaticMetadata,\n-  Viewport | ViewportResolver | null,\n-][]\n+export type MetadataItems = Array<\n+  [Metadata | MetadataResolver | null, StaticMetadata]\n+>\n+\n+export type ViewportItems = Array<Viewport | ViewportResolver | null>\n \n type TitleTemplates = {\n   title: string | null\n@@ -457,22 +457,65 @@ async function collectMetadata({\n   const staticFilesMetadata = await resolveStaticMetadata(tree[2], props)\n   const metadataExport = mod ? getDefinedMetadata(mod, props, { route }) : null\n \n-  const viewportExport = mod ? getDefinedViewport(mod, props, { route }) : null\n-\n-  metadataItems.push([metadataExport, staticFilesMetadata, viewportExport])\n+  metadataItems.push([metadataExport, staticFilesMetadata])\n \n   if (hasErrorConventionComponent && errorConvention) {\n     const errorMod = await getComponentTypeModule(tree, errorConvention)\n-    const errorViewportExport = errorMod\n-      ? getDefinedViewport(errorMod, props, { route })\n-      : null\n     const errorMetadataExport = errorMod\n       ? getDefinedMetadata(errorMod, props, { route })\n       : null\n \n     errorMetadataItem[0] = errorMetadataExport\n     errorMetadataItem[1] = staticFilesMetadata\n-    errorMetadataItem[2] = errorViewportExport\n+  }\n+}\n+\n+// [layout.metadata, static files metadata] -> ... -> [page.metadata, static files metadata]\n+async function collectViewport({\n+  tree,\n+  viewportItems,\n+  errorViewportItemRef,\n+  props,\n+  route,\n+  errorConvention,\n+}: {\n+  tree: LoaderTree\n+  viewportItems: ViewportItems\n+  errorViewportItemRef: ErrorViewportItemRef\n+  props: any\n+  route: string\n+  errorConvention?: MetadataErrorType\n+}) {\n+  let mod\n+  let modType\n+  const hasErrorConventionComponent = Boolean(\n+    errorConvention && tree[2][errorConvention]\n+  )\n+  if (errorConvention) {\n+    mod = await getComponentTypeModule(tree, 'layout')\n+    modType = errorConvention\n+  } else {\n+    const { mod: layoutOrPageMod, modType: layoutOrPageModType } =\n+      await getLayoutOrPageModule(tree)\n+    mod = layoutOrPageMod\n+    modType = layoutOrPageModType\n+  }\n+\n+  if (modType) {\n+    route += `/${modType}`\n+  }\n+\n+  const viewportExport = mod ? getDefinedViewport(mod, props, { route }) : null\n+\n+  viewportItems.push(viewportExport)\n+\n+  if (hasErrorConventionComponent && errorConvention) {\n+    const errorMod = await getComponentTypeModule(tree, errorConvention)\n+    const errorViewportExport = errorMod\n+      ? getDefinedViewport(errorMod, props, { route })\n+      : null\n+\n+    errorViewportItemRef.current = errorViewportExport\n   }\n }\n \n@@ -485,7 +528,7 @@ const resolveMetadataItems = cache(async function (\n ) {\n   const parentParams = {}\n   const metadataItems: MetadataItems = []\n-  const errorMetadataItem: MetadataItems[number] = [null, null, null]\n+  const errorMetadataItem: MetadataItems[number] = [null, null]\n   const treePrefix = undefined\n   return resolveMetadataItemsImpl(\n     metadataItems,\n@@ -580,6 +623,113 @@ async function resolveMetadataItemsImpl(\n   return metadataItems\n }\n \n+type ErrorViewportItemRef = { current: ViewportItems[number] }\n+const resolveViewportItems = cache(async function (\n+  tree: LoaderTree,\n+  searchParams: Promise<ParsedUrlQuery>,\n+  errorConvention: MetadataErrorType | undefined,\n+  getDynamicParamFromSegment: GetDynamicParamFromSegment,\n+  workStore: WorkStore\n+) {\n+  const parentParams = {}\n+  const viewportItems: ViewportItems = []\n+  const errorViewportItemRef: ErrorViewportItemRef = {\n+    current: null,\n+  }\n+  const treePrefix = undefined\n+  return resolveViewportItemsImpl(\n+    viewportItems,\n+    tree,\n+    treePrefix,\n+    parentParams,\n+    searchParams,\n+    errorConvention,\n+    errorViewportItemRef,\n+    getDynamicParamFromSegment,\n+    workStore\n+  )\n+})\n+\n+async function resolveViewportItemsImpl(\n+  viewportItems: ViewportItems,\n+  tree: LoaderTree,\n+  /** Provided tree can be nested subtree, this argument says what is the path of such subtree */\n+  treePrefix: undefined | string[],\n+  parentParams: Params,\n+  searchParams: Promise<ParsedUrlQuery>,\n+  errorConvention: MetadataErrorType | undefined,\n+  errorViewportItemRef: ErrorViewportItemRef,\n+  getDynamicParamFromSegment: GetDynamicParamFromSegment,\n+  workStore: WorkStore\n+): Promise<ViewportItems> {\n+  const [segment, parallelRoutes, { page }] = tree\n+  const currentTreePrefix =\n+    treePrefix && treePrefix.length ? [...treePrefix, segment] : [segment]\n+  const isPage = typeof page !== 'undefined'\n+\n+  // Handle dynamic segment params.\n+  const segmentParam = getDynamicParamFromSegment(segment)\n+  /**\n+   * Create object holding the parent params and current params\n+   */\n+  let currentParams = parentParams\n+  if (segmentParam && segmentParam.value !== null) {\n+    currentParams = {\n+      ...parentParams,\n+      [segmentParam.param]: segmentParam.value,\n+    }\n+  }\n+\n+  const params = createServerParamsForMetadata(currentParams, workStore)\n+\n+  let layerProps: LayoutProps | PageProps\n+  if (isPage) {\n+    layerProps = {\n+      params,\n+      searchParams,\n+    }\n+  } else {\n+    layerProps = {\n+      params,\n+    }\n+  }\n+\n+  await collectViewport({\n+    tree,\n+    viewportItems,\n+    errorViewportItemRef,\n+    errorConvention,\n+    props: layerProps,\n+    route: currentTreePrefix\n+      // __PAGE__ shouldn't be shown in a route\n+      .filter((s) => s !== PAGE_SEGMENT_KEY)\n+      .join('/'),\n+  })\n+\n+  for (const key in parallelRoutes) {\n+    const childTree = parallelRoutes[key]\n+    await resolveViewportItemsImpl(\n+      viewportItems,\n+      childTree,\n+      currentTreePrefix,\n+      currentParams,\n+      searchParams,\n+      errorConvention,\n+      errorViewportItemRef,\n+      getDynamicParamFromSegment,\n+      workStore\n+    )\n+  }\n+\n+  if (Object.keys(parallelRoutes).length === 0 && errorConvention) {\n+    // If there are no parallel routes, place error metadata as the last item.\n+    // e.g. layout -> layout -> not-found\n+    viewportItems.push(errorViewportItemRef.current)\n+  }\n+\n+  return viewportItems\n+}\n+\n type WithTitle = { title?: AbsoluteTemplateString | null }\n type WithDescription = { description?: string | null }\n \n@@ -692,15 +842,15 @@ function prerenderMetadata(metadataItems: MetadataItems) {\n   return resolversAndResults\n }\n \n-function prerenderViewport(metadataItems: MetadataItems) {\n+function prerenderViewport(viewportItems: ViewportItems) {\n   // If the index is a function then it is a resolver and the next slot\n   // is the corresponding result. If the index is not a function it is the result\n   // itself.\n   const resolversAndResults: Array<\n     ((value: ResolvedViewport) => void) | Result<Viewport>\n   > = []\n-  for (let i = 0; i < metadataItems.length; i++) {\n-    const viewportExport = metadataItems[i][2]\n+  for (let i = 0; i < viewportItems.length; i++) {\n+    const viewportExport = viewportItems[i]\n     getResult(resolversAndResults, viewportExport)\n   }\n   return resolversAndResults\n@@ -865,11 +1015,11 @@ export async function accumulateMetadata(\n }\n \n export async function accumulateViewport(\n-  metadataItems: MetadataItems\n+  viewportItems: ViewportItems\n ): Promise<ResolvedViewport> {\n   const resolvedViewport: ResolvedViewport = createDefaultViewport()\n \n-  const resolversAndResults = prerenderViewport(metadataItems)\n+  const resolversAndResults = prerenderViewport(viewportItems)\n   let i = 0\n \n   while (i < resolversAndResults.length) {\n@@ -929,14 +1079,14 @@ export async function resolveViewport(\n   getDynamicParamFromSegment: GetDynamicParamFromSegment,\n   workStore: WorkStore\n ): Promise<ResolvedViewport> {\n-  const metadataItems = await resolveMetadataItems(\n+  const viewportItems = await resolveViewportItems(\n     tree,\n     searchParams,\n     errorConvention,\n     getDynamicParamFromSegment,\n     workStore\n   )\n-  return accumulateViewport(metadataItems)\n+  return accumulateViewport(viewportItems)\n }\n \n function isPromiseLike<T>("
        },
        {
            "sha": "670bc018d775a392b73e7408f554c096587a8f3d",
            "filename": "test/e2e/app-dir/metadata/app/dynamic/[slug]/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fdynamic%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fdynamic%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fdynamic%2F%5Bslug%5D%2Fpage.tsx?ref=c7a338df5ada1c410d9bfb16abf0ed85d2694fc0",
            "patch": "@@ -1,5 +1,5 @@\n async function format({ params, searchParams }) {\n-  const { slug } = params\n+  const { slug } = await params\n   const { q } = await searchParams\n   return `params - ${slug}${q ? ` query - ${q}` : ''}`\n }"
        },
        {
            "sha": "d5014c13110ef39bccb2a790694f26da40341c8e",
            "filename": "test/e2e/app-dir/metadata/metadata.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c7a338df5ada1c410d9bfb16abf0ed85d2694fc0/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts?ref=c7a338df5ada1c410d9bfb16abf0ed85d2694fc0",
            "patch": "@@ -549,8 +549,8 @@ describe('app dir - metadata', () => {\n     it('should render icon and apple touch icon meta if their images are specified', async () => {\n       const $ = await next.render$('/icons/static/nested')\n \n-      const $icon = $('head > link[rel=\"icon\"][type!=\"image/x-icon\"]')\n-      const $appleIcon = $('head > link[rel=\"apple-touch-icon\"]')\n+      const $icon = $('link[rel=\"icon\"][type!=\"image/x-icon\"]')\n+      const $appleIcon = $('link[rel=\"apple-touch-icon\"]')\n \n       expect($icon.attr('href')).toMatch(/\\/icons\\/static\\/nested\\/icon1/)\n       expect($icon.attr('sizes')).toBe('32x32')\n@@ -565,19 +565,17 @@ describe('app dir - metadata', () => {\n     it('should not render if image file is not specified', async () => {\n       const $ = await next.render$('/icons/static')\n \n-      const $icon = $('head > link[rel=\"icon\"][type!=\"image/x-icon\"]')\n+      const $icon = $('link[rel=\"icon\"][type!=\"image/x-icon\"]')\n \n       expect($icon.attr('href')).toMatch(/\\/icons\\/static\\/icon/)\n       expect($icon.attr('sizes')).toBe('114x114')\n \n       // No apple icon if it's not provided\n-      const $appleIcon = $('head > link[rel=\"apple-touch-icon\"]')\n+      const $appleIcon = $('link[rel=\"apple-touch-icon\"]')\n       expect($appleIcon.length).toBe(0)\n \n       const $dynamic = await next.render$('/icons/static/dynamic-routes/123')\n-      const $dynamicIcon = $dynamic(\n-        'head > link[rel=\"icon\"][type!=\"image/x-icon\"]'\n-      )\n+      const $dynamicIcon = $dynamic('link[rel=\"icon\"][type!=\"image/x-icon\"]')\n       const dynamicIconHref = $dynamicIcon.attr('href')\n       expect(dynamicIconHref).toMatch(\n         /\\/icons\\/static\\/dynamic-routes\\/123\\/icon/\n@@ -845,7 +843,7 @@ describe('app dir - metadata', () => {\n \n           await check(async () => {\n             const $ = await next.render$('/icons/static')\n-            const $icon = $('head > link[rel=\"icon\"][type!=\"image/x-icon\"]')\n+            const $icon = $('link[rel=\"icon\"][type!=\"image/x-icon\"]')\n             return $icon.attr('href')\n           }, /\\/icons\\/static\\/icon2/)\n "
        }
    ],
    "stats": {
        "total": 218,
        "additions": 181,
        "deletions": 37
    }
}