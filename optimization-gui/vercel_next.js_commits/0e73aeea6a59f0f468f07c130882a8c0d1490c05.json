{
    "author": "gaojude",
    "message": "Perf: Use canonicalUrl from prefetch for dynamic RSC requests (#80817)\n\nIf a prefetch request hits a 307, the browser follows the redirect, and\nyou’ll know the final URL after that. Then, during actual navigation,\ndynamic data should be fetched from the redirected URL rather than the\noriginal one specified in the link.",
    "sha": "0e73aeea6a59f0f468f07c130882a8c0d1490c05",
    "files": [
        {
            "sha": "15f1ee344883adad5016f413714ed9b518ea5a39",
            "filename": "packages/next/src/client/components/router-reducer/reducers/navigate-reducer.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/0e73aeea6a59f0f468f07c130882a8c0d1490c05/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0e73aeea6a59f0f468f07c130882a8c0d1490c05/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts?ref=0e73aeea6a59f0f468f07c130882a8c0d1490c05",
            "patch": "@@ -237,11 +237,18 @@ export function navigateReducer(\n       }\n \n       if (prefetchValues.aliased) {\n+        // When alias is enabled, search param may not be included in the canonicalUrl.\n+        // But we want to set url to canonicalUrl so that we use redirected path for fetching dynamic data.\n+        const urlWithCanonicalPathname = new URL(url.href)\n+        if (canonicalUrlOverride) {\n+          urlWithCanonicalPathname.pathname = canonicalUrlOverride.pathname\n+        }\n+\n         const result = handleAliasedPrefetchEntry(\n           navigatedAt,\n           state,\n           flightData,\n-          url,\n+          urlWithCanonicalPathname,\n           mutable\n         )\n \n@@ -376,10 +383,13 @@ export function navigateReducer(\n                 // root multiple times per navigation, like if the server sends us\n                 // a different response than we expected. For now, we revert back\n                 // to the lazy fetching mechanism in that case.)\n-                const dynamicRequest = fetchServerResponse(url, {\n-                  flightRouterState: dynamicRequestTree,\n-                  nextUrl: state.nextUrl,\n-                })\n+                const dynamicRequest = fetchServerResponse(\n+                  new URL(updatedCanonicalUrl, url.origin),\n+                  {\n+                    flightRouterState: dynamicRequestTree,\n+                    nextUrl: state.nextUrl,\n+                  }\n+                )\n \n                 listenForDynamicRequest(task, dynamicRequest)\n                 // We store the dynamic request on the `lazyData` property of the CacheNode"
        },
        {
            "sha": "2cccabec4fd92363904bb5ffa5d23638470a5982",
            "filename": "packages/next/src/client/components/segment-cache-impl/navigation.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/0e73aeea6a59f0f468f07c130882a8c0d1490c05/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0e73aeea6a59f0f468f07c130882a8c0d1490c05/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts?ref=0e73aeea6a59f0f468f07c130882a8c0d1490c05",
            "patch": "@@ -190,10 +190,13 @@ function navigateUsingPrefetchedRouteTree(\n   if (task !== null) {\n     const dynamicRequestTree = task.dynamicRequestTree\n     if (dynamicRequestTree !== null) {\n-      const promiseForDynamicServerResponse = fetchServerResponse(url, {\n-        flightRouterState: dynamicRequestTree,\n-        nextUrl,\n-      })\n+      const promiseForDynamicServerResponse = fetchServerResponse(\n+        new URL(canonicalUrl, url.origin),\n+        {\n+          flightRouterState: dynamicRequestTree,\n+          nextUrl,\n+        }\n+      )\n       listenForDynamicRequest(task, promiseForDynamicServerResponse)\n     } else {\n       // The prefetched tree does not contain dynamic holes — it's"
        },
        {
            "sha": "0c33707b1dca99b9890ea27b6f49c3fda41dbc53",
            "filename": "test/e2e/app-dir/rsc-redirect/app/about/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fabout%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fabout%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fabout%2Fpage.tsx?ref=0e73aeea6a59f0f468f07c130882a8c0d1490c05",
            "patch": "@@ -0,0 +1,7 @@\n+import React from 'react'\n+\n+export default function Page() {\n+  return <div id=\"about-page\">About Page</div>\n+}\n+\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "39c1a7b2268e72bb642662a7e61384a3b3beb59d",
            "filename": "test/e2e/app-dir/rsc-redirect/app/old-about/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fold-about%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fold-about%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fold-about%2Fpage.tsx?ref=0e73aeea6a59f0f468f07c130882a8c0d1490c05",
            "patch": "@@ -0,0 +1,8 @@\n+export default function OldAbout() {\n+  return (\n+    <div>\n+      Old About - you should not see this page because middleware should\n+      redirect you to /about\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "da2394b78fe0f50ac0df49cc30471953668dad62",
            "filename": "test/e2e/app-dir/rsc-redirect/app/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fapp%2Fpage.tsx?ref=0e73aeea6a59f0f468f07c130882a8c0d1490c05",
            "patch": "@@ -5,7 +5,7 @@ export default function Page() {\n   return (\n     <div>\n       <h1>Home</h1>\n-      <Link href=\"/origin\">Go to Origin</Link>\n+      <Link href=\"/old-about\">Go to (Old) About Page</Link>\n     </div>\n   )\n }"
        },
        {
            "sha": "60b2b0a242840b9f0f4756d7893ed50f17e3e8ad",
            "filename": "test/e2e/app-dir/rsc-redirect/middleware.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Fmiddleware.ts?ref=0e73aeea6a59f0f468f07c130882a8c0d1490c05",
            "patch": "@@ -0,0 +1,13 @@\n+import { NextResponse } from 'next/server'\n+import type { NextRequest } from 'next/server'\n+\n+export function middleware(request: NextRequest) {\n+  console.log('middleware called')\n+  if (request.nextUrl.pathname === '/old-about') {\n+    const url = request.nextUrl.clone()\n+    url.pathname = '/about'\n+    console.log('redirecting to', url.pathname)\n+    return NextResponse.redirect(url)\n+  }\n+  return NextResponse.next()\n+}"
        },
        {
            "sha": "b820dddff6f87d7d8532ada438b62e18fcbca31c",
            "filename": "test/e2e/app-dir/rsc-redirect/rsc-redirect.test.ts",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-redirect%2Frsc-redirect.test.ts?ref=0e73aeea6a59f0f468f07c130882a8c0d1490c05",
            "patch": "@@ -1,6 +1,10 @@\n import { nextTestSetup } from 'e2e-utils'\n import { fetchViaHTTP } from 'next-test-utils'\n import { NEXT_RSC_UNION_QUERY } from 'next/dist/client/components/app-router-headers'\n+import fs from 'fs'\n+import path from 'path'\n+\n+const configPath = path.join(__dirname, 'next.config.js')\n \n describe('rsc-redirect', () => {\n   const { next } = nextTestSetup({\n@@ -29,3 +33,50 @@ describe('rsc-redirect', () => {\n     expect(response.status).toBe(200)\n   })\n })\n+\n+if (process.env.NODE_ENV === 'production') {\n+  describe.each([\n+    { ppr: true, segmentCache: true },\n+    { ppr: true, segmentCache: false },\n+    { ppr: false, segmentCache: true },\n+    { ppr: false, segmentCache: false },\n+  ] as const)(\n+    'rsc-redirect /old-about -> /about (ppr: $ppr, segmentCache: $segmentCache)',\n+    ({ ppr, segmentCache }) => {\n+      beforeAll(() => {\n+        // Write next.config.js with the current flags\n+        fs.writeFileSync(\n+          configPath,\n+          `module.exports = { experimental: { ppr: ${ppr}, clientSegmentCache: ${segmentCache} } }\\n`\n+        )\n+      })\n+\n+      afterAll(() => {\n+        // Clean up config file\n+        if (fs.existsSync(configPath)) fs.unlinkSync(configPath)\n+      })\n+\n+      const { next } = nextTestSetup({\n+        files: __dirname,\n+      })\n+\n+      it('uses prefetched, redirected URL in the navigation, as opposed to the href in the link', async () => {\n+        const networkStatuses: number[] = []\n+        const browser = await next.browser('/', {\n+          beforePageLoad: (page) => {\n+            page.on('response', (response) => {\n+              networkStatuses.push(response.status())\n+            })\n+          },\n+        })\n+        await browser.waitForIdleNetwork()\n+        // Clear network statuses before clicking to only capture responses from the click\n+        networkStatuses.length = 0\n+        await browser.elementByCss('a[href=\"/old-about\"]').click()\n+        await browser.waitForElementByCss('#about-page')\n+        expect(networkStatuses).toContain(200)\n+        expect(networkStatuses).not.toContain(307)\n+      })\n+    }\n+  )\n+}"
        },
        {
            "sha": "ac25c7dac410751145378ec2389fa4401f3e3f2e",
            "filename": "test/e2e/app-dir/searchparams-reuse-loading/searchparams-reuse-loading.test.ts",
            "status": "modified",
            "additions": 58,
            "deletions": 42,
            "changes": 100,
            "blob_url": "https://github.com/vercel/next.js/blob/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fsearchparams-reuse-loading.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0e73aeea6a59f0f468f07c130882a8c0d1490c05/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fsearchparams-reuse-loading.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsearchparams-reuse-loading%2Fsearchparams-reuse-loading.test.ts?ref=0e73aeea6a59f0f468f07c130882a8c0d1490c05",
            "patch": "@@ -181,62 +181,76 @@ describe('searchparams-reuse-loading', () => {\n         let interceptRequests = false\n         const browser = await next.browser(path, {\n           beforePageLoad(page) {\n-            page.route('**/search-params*', async (route) => {\n-              if (!interceptRequests) {\n-                return route.continue()\n-              }\n-\n-              const request = route.request()\n-              const headers = await request.allHeaders()\n-              const url = new URL(request.url())\n-              const promiseKey =\n-                url.pathname + '?id=' + url.searchParams.get('id')\n-\n-              if (headers['rsc'] === '1' && !headers['next-router-prefetch']) {\n-                // Create a promise that will be resolved by the later test code\n-                let resolvePromise: () => void\n-                const promise = new Promise<void>((res) => {\n-                  resolvePromise = res\n-                })\n-\n-                if (rscRequestPromise.has(promiseKey)) {\n-                  throw new Error('Duplicate request')\n+            page.route(\n+              (url) => {\n+                return url.pathname.includes('search-params')\n+              },\n+              async (route) => {\n+                if (!interceptRequests) {\n+                  return route.continue()\n                 }\n \n-                rscRequestPromise.set(promiseKey, {\n-                  resolve: async () => {\n-                    await route.continue()\n-                    // wait a moment to ensure the response is received\n-                    await new Promise((res) => setTimeout(res, 500))\n-                    resolvePromise()\n-                  },\n-                })\n-\n-                // Await the promise to effectively stall the request\n-                await promise\n-              } else {\n-                await route.continue()\n+                const request = route.request()\n+                const headers = await request.allHeaders()\n+                const url = new URL(request.url())\n+                const promiseKey =\n+                  url.pathname + '?id=' + url.searchParams.get('id')\n+\n+                if (\n+                  headers['rsc'] === '1' &&\n+                  !headers['next-router-prefetch']\n+                ) {\n+                  // Create a promise that will be resolved by the later test code\n+                  let resolvePromise: () => void\n+                  const promise = new Promise<void>((res) => {\n+                    resolvePromise = res\n+                  })\n+\n+                  if (rscRequestPromise.has(promiseKey)) {\n+                    throw new Error('Duplicate request')\n+                  }\n+\n+                  rscRequestPromise.set(promiseKey, {\n+                    resolve: async () => {\n+                      await route.continue()\n+                      // wait a moment to ensure the response is received\n+                      await new Promise((res) => setTimeout(res, 500))\n+                      resolvePromise()\n+                    },\n+                  })\n+\n+                  // Await the promise to effectively stall the request\n+                  await promise\n+                } else {\n+                  await route.continue()\n+                }\n               }\n-            })\n+            )\n           },\n         })\n \n         const basePath = path === '/' ? '' : path\n+        const searchParamsPagePath = `${basePath}/search-params`\n+        const canonicalSearchParamsPagePath =\n+          path === '/with-middleware'\n+            ? `${searchParamsPagePath}/someValue`\n+            : searchParamsPagePath\n \n         await browser.waitForIdleNetwork()\n         interceptRequests = true\n         // The first link we click is \"auto\" prefetched.\n         await browser\n-          .elementByCss(`[href=\"${basePath}/search-params?id=1\"]`)\n+          .elementByCss(`[href=\"${searchParamsPagePath}?id=1\"]`)\n           .click()\n \n         // We expect to click it and immediately see a loading state\n         expect(await browser.elementById('loading').text()).toBe('Loading...')\n         // We only resolve the dynamic request after we've confirmed loading exists,\n         // to avoid a race where the dynamic request handles the loading state instead.\n         let dynamicRequest = rscRequestPromise.get(\n-          `${basePath}/search-params?id=1`\n+          `${canonicalSearchParamsPagePath}?id=1`\n         )\n+\n         expect(dynamicRequest).toBeDefined()\n \n         // resolve the promise\n@@ -252,10 +266,12 @@ describe('searchparams-reuse-loading', () => {\n         // Do the exact same thing again, for another prefetch auto link, to ensure\n         // loading works as expected and we get different search params\n         await browser\n-          .elementByCss(`[href=\"${basePath}/search-params?id=2\"]`)\n+          .elementByCss(`[href=\"${searchParamsPagePath}?id=2\"]`)\n           .click()\n         expect(await browser.elementById('loading').text()).toBe('Loading...')\n-        dynamicRequest = rscRequestPromise.get(`${basePath}/search-params?id=2`)\n+        dynamicRequest = rscRequestPromise.get(\n+          `${canonicalSearchParamsPagePath}?id=2`\n+        )\n         expect(dynamicRequest).toBeDefined()\n \n         // resolve the promise\n@@ -269,11 +285,11 @@ describe('searchparams-reuse-loading', () => {\n         await browser.elementByCss(`[href='${path}']`).click()\n \n         await browser\n-          .elementByCss(`[href=\"${basePath}/search-params?id=3\"]`)\n+          .elementByCss(`[href=\"${searchParamsPagePath}?id=3\"]`)\n           .click()\n-        expect(rscRequestPromise.has(`${basePath}/search-params?id=3`)).toBe(\n-          false\n-        )\n+        expect(\n+          rscRequestPromise.has(`${canonicalSearchParamsPagePath}?id=3`)\n+        ).toBe(false)\n         // no need to resolve any dynamic requests, as this is a full prefetch\n         const params3 = await browser.waitForElementByCss('#params').text()\n         expect(params3).toBe('{\"id\":\"3\"}')"
        }
    ],
    "stats": {
        "total": 212,
        "additions": 160,
        "deletions": 52
    }
}