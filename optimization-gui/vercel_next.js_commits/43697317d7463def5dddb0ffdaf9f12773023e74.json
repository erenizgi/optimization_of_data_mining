{
    "author": "bgw",
    "message": "feat(CI): Revalidate vercel data cache on areweturboyet after uploading data to KV store (#76693)\n\nWithout this, you'll have to wait up to 600 seconds after merging a manifest update and waiting for the upload CI job to run, which leads to some confusion. This should make it near-instant.\n\nCalls the endpoint defined here: https://github.com/vercel/areweturboyet/pull/20\n\nThis needs the `TURBOYET_TOKEN` secret to be configured on the repository. (Thanks @timneutkens)\n\nTested by running it here: https://github.com/vercel/next.js/actions/runs/13635362971/job/38112680086\n\n![Screenshot 2025-03-03 at 9.27.10â€¯AM.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/HAZVitxRNnZz8QMiPn4a/c69fd2b9-2729-4149-8082-5c4f27709585.png)",
    "sha": "43697317d7463def5dddb0ffdaf9f12773023e74",
    "files": [
        {
            "sha": "df475597ce3462410a7097bffb284c8536cbb25b",
            "filename": ".github/actions/upload-turboyet-data/dist/index.js",
            "status": "modified",
            "additions": 33,
            "deletions": 1,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/43697317d7463def5dddb0ffdaf9f12773023e74/.github%2Factions%2Fupload-turboyet-data%2Fdist%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/43697317d7463def5dddb0ffdaf9f12773023e74/.github%2Factions%2Fupload-turboyet-data%2Fdist%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Factions%2Fupload-turboyet-data%2Fdist%2Findex.js?ref=43697317d7463def5dddb0ffdaf9f12773023e74",
            "patch": "@@ -5242,7 +5242,10 @@ async function collectResults(manifestFile) {\n   }\n }\n \n-async function collectAndUpload(kv, { jsonPrefix, kvPrefix }) {\n+async function collectAndUpload(\n+  kv,\n+  { jsonPrefix, kvPrefix, deploymentDomain }\n+) {\n   const developmentResult = await collectResults(\n     `test/${jsonPrefix}dev-tests-manifest.json`\n   )\n@@ -5283,6 +5286,34 @@ async function collectAndUpload(kv, { jsonPrefix, kvPrefix }) {\n \n   await kv.set(`${kvPrefix}examples-data`, developmentExamplesResult.data)\n   console.log('SUCCESSFULLY SAVED EXAMPLES')\n+\n+  if (deploymentDomain != null) {\n+    // Upstash does not provide strong consistency, so just wait a couple\n+    // seconds before invalidating the cache in case of replication lag.\n+    //\n+    // https://upstash.com/docs/redis/features/consistency\n+    await new Promise((resolve) => setTimeout(resolve, 2000))\n+    try {\n+      const response = await fetch(\n+        `https://${deploymentDomain}/api/revalidate`,\n+        {\n+          method: 'POST',\n+          headers: {\n+            'X-Auth-Token': process.env.TURBOYET_TOKEN,\n+            'Content-Type': 'application/json',\n+          },\n+        }\n+      )\n+      const responseJson = await response.json()\n+      if (!responseJson.revalidated) {\n+        throw new Error(responseJson.error)\n+      }\n+      console.log('SUCCESSFULLY REVALIDATED VERCEL DATA CACHE')\n+    } catch (error) {\n+      // non-fatal: the cache will eventually expire anyways\n+      console.error('FAILED TO REVALIDATE VERCEL DATA CACHE', error)\n+    }\n+  }\n }\n \n async function main() {\n@@ -5295,6 +5326,7 @@ async function main() {\n     await collectAndUpload(kv, {\n       jsonPrefix: 'turbopack-',\n       kvPrefix: '',\n+      deploymentDomain: 'areweturboyet.com',\n     })\n     console.log('### UPLOADING RSPACK DATA')\n     await collectAndUpload(kv, {"
        },
        {
            "sha": "174cbe3e02c589498aec8c6b548f89796411bbb4",
            "filename": ".github/actions/upload-turboyet-data/dist/index.js.map",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/43697317d7463def5dddb0ffdaf9f12773023e74/.github%2Factions%2Fupload-turboyet-data%2Fdist%2Findex.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/43697317d7463def5dddb0ffdaf9f12773023e74/.github%2Factions%2Fupload-turboyet-data%2Fdist%2Findex.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Factions%2Fupload-turboyet-data%2Fdist%2Findex.js.map?ref=43697317d7463def5dddb0ffdaf9f12773023e74"
        },
        {
            "sha": "f518be5a81833b4cc5f6d8db72a28a3e42b2d467",
            "filename": ".github/actions/upload-turboyet-data/src/main.js",
            "status": "modified",
            "additions": 33,
            "deletions": 1,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/43697317d7463def5dddb0ffdaf9f12773023e74/.github%2Factions%2Fupload-turboyet-data%2Fsrc%2Fmain.js",
            "raw_url": "https://github.com/vercel/next.js/raw/43697317d7463def5dddb0ffdaf9f12773023e74/.github%2Factions%2Fupload-turboyet-data%2Fsrc%2Fmain.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Factions%2Fupload-turboyet-data%2Fsrc%2Fmain.js?ref=43697317d7463def5dddb0ffdaf9f12773023e74",
            "patch": "@@ -134,7 +134,10 @@ async function collectResults(manifestFile) {\n   }\n }\n \n-async function collectAndUpload(kv, { jsonPrefix, kvPrefix }) {\n+async function collectAndUpload(\n+  kv,\n+  { jsonPrefix, kvPrefix, deploymentDomain }\n+) {\n   const developmentResult = await collectResults(\n     `test/${jsonPrefix}dev-tests-manifest.json`\n   )\n@@ -175,6 +178,34 @@ async function collectAndUpload(kv, { jsonPrefix, kvPrefix }) {\n \n   await kv.set(`${kvPrefix}examples-data`, developmentExamplesResult.data)\n   console.log('SUCCESSFULLY SAVED EXAMPLES')\n+\n+  if (deploymentDomain != null) {\n+    // Upstash does not provide strong consistency, so just wait a couple\n+    // seconds before invalidating the cache in case of replication lag.\n+    //\n+    // https://upstash.com/docs/redis/features/consistency\n+    await new Promise((resolve) => setTimeout(resolve, 2000))\n+    try {\n+      const response = await fetch(\n+        `https://${deploymentDomain}/api/revalidate`,\n+        {\n+          method: 'POST',\n+          headers: {\n+            'X-Auth-Token': process.env.TURBOYET_TOKEN,\n+            'Content-Type': 'application/json',\n+          },\n+        }\n+      )\n+      const responseJson = await response.json()\n+      if (!responseJson.revalidated) {\n+        throw new Error(responseJson.error)\n+      }\n+      console.log('SUCCESSFULLY REVALIDATED VERCEL DATA CACHE')\n+    } catch (error) {\n+      // non-fatal: the cache will eventually expire anyways\n+      console.error('FAILED TO REVALIDATE VERCEL DATA CACHE', error)\n+    }\n+  }\n }\n \n async function main() {\n@@ -187,6 +218,7 @@ async function main() {\n     await collectAndUpload(kv, {\n       jsonPrefix: 'turbopack-',\n       kvPrefix: '',\n+      deploymentDomain: 'areweturboyet.com',\n     })\n     console.log('### UPLOADING RSPACK DATA')\n     await collectAndUpload(kv, {"
        },
        {
            "sha": "b8bee13eb70086a2ee484362bfb776bae0601d38",
            "filename": ".github/workflows/upload-tests-manifest.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/43697317d7463def5dddb0ffdaf9f12773023e74/.github%2Fworkflows%2Fupload-tests-manifest.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/43697317d7463def5dddb0ffdaf9f12773023e74/.github%2Fworkflows%2Fupload-tests-manifest.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fupload-tests-manifest.yml?ref=43697317d7463def5dddb0ffdaf9f12773023e74",
            "patch": "@@ -6,12 +6,7 @@ name: Upload bundler test manifests to areweturboyet.com\n on:\n   schedule:\n     - cron: '0 8 * * *'\n-  workflow_dispatch:\n-    inputs:\n-      version:\n-        description: Next.js version, sha, branch to test\n-        type: string\n-        default: 'canary'\n+  workflow_dispatch: {}\n   push:\n     branches:\n       - canary\n@@ -45,4 +40,5 @@ jobs:\n         env:\n           TURBOYET_KV_REST_API_URL: ${{ secrets.TURBOYET_KV_REST_API_URL }}\n           TURBOYET_KV_REST_API_TOKEN: ${{ secrets.TURBOYET_KV_REST_API_TOKEN }}\n+          TURBOYET_TOKEN: ${{ secrets.TURBOYET_TOKEN }}\n         uses: ./.github/actions/upload-turboyet-data"
        }
    ],
    "stats": {
        "total": 78,
        "additions": 69,
        "deletions": 9
    }
}