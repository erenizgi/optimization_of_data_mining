{
    "author": "huozhi",
    "message": "fix metadata basePath for manifest (#76681)\n\n### What\r\n\r\nStatic metadata manifest file should be prefixed with `basePath` when it's specified, as all the requests are sent to the routes under `/<basePath>/*`, it should also show the correct url in the html\r\n\r\nFixes #56687\r\nCloses NEXT-2707",
    "sha": "9483a371f1ac3a87464b59c68aa990e9813f28f0",
    "files": [
        {
            "sha": "40d553f8f202e450abc0b3ca82eac1c4f18bdcc1",
            "filename": "crates/next-core/src/app_page_loader_tree.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9483a371f1ac3a87464b59c68aa990e9813f28f0/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9483a371f1ac3a87464b59c68aa990e9813f28f0/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs?ref=9483a371f1ac3a87464b59c68aa990e9813f28f0",
            "patch": "@@ -133,11 +133,18 @@ impl AppPageLoaderTreeBuilder {\n             return Ok(());\n         };\n \n-        let manifest_route = &format!(\"/{}\", get_metadata_route_name(manifest).await?);\n+        let metadata_manifest_route = get_metadata_route_name(manifest).await?;\n+        // prefix with base_path if it exists\n+        let manifest_route = if let Some(base_path) = &self.base_path {\n+            format!(\"{}/{}\", base_path, metadata_manifest_route)\n+        } else {\n+            metadata_manifest_route.to_string()\n+        };\n+\n         writeln!(\n             self.loader_tree_code,\n             \"    manifest: {},\",\n-            StringifyJs(manifest_route)\n+            StringifyJs(&manifest_route)\n         )?;\n \n         Ok(())"
        },
        {
            "sha": "f871fe2f22b7549065020d3024a127551a9169c4",
            "filename": "packages/next/src/build/webpack/loaders/metadata/discover.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9483a371f1ac3a87464b59c68aa990e9813f28f0/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fmetadata%2Fdiscover.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9483a371f1ac3a87464b59c68aa990e9813f28f0/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fmetadata%2Fdiscover.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fmetadata%2Fdiscover.ts?ref=9483a371f1ac3a87464b59c68aa990e9813f28f0",
            "patch": "@@ -86,7 +86,9 @@ export async function createStaticMetadataFromRoute(\n         const extension = staticManifestExtension.includes(ext.slice(1))\n           ? ext.slice(1)\n           : 'webmanifest'\n-        staticImagesMetadata.manifest = JSON.stringify(`/${name}.${extension}`)\n+        staticImagesMetadata.manifest = JSON.stringify(\n+          `${basePath}/${name}.${extension}`\n+        )\n       }\n       return\n     }"
        },
        {
            "sha": "14984b6a28fff3b6e858469676c34c3e624e6bad",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-url.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9483a371f1ac3a87464b59c68aa990e9813f28f0/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9483a371f1ac3a87464b59c68aa990e9813f28f0/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts?ref=9483a371f1ac3a87464b59c68aa990e9813f28f0",
            "patch": "@@ -73,8 +73,8 @@ function resolveUrl(\n   }\n \n   // Handle relative or absolute paths\n-  const basePath = metadataBase.pathname || ''\n-  const joinedPath = path.posix.join(basePath, url)\n+  const pathname = metadataBase.pathname || ''\n+  const joinedPath = path.posix.join(pathname, url)\n \n   return new URL(joinedPath, metadataBase)\n }"
        },
        {
            "sha": "3f1c3a59914d3b91d04a3964f274d25269294acd",
            "filename": "test/e2e/app-dir/app-basepath/app/manifest.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9483a371f1ac3a87464b59c68aa990e9813f28f0/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmanifest.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9483a371f1ac3a87464b59c68aa990e9813f28f0/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmanifest.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmanifest.ts?ref=9483a371f1ac3a87464b59c68aa990e9813f28f0",
            "patch": "@@ -0,0 +1,7 @@\n+import { MetadataRoute } from 'next'\n+\n+export default function manifest(): MetadataRoute.Manifest {\n+  return {\n+    name: 'NextJS Manifest',\n+  }\n+}"
        },
        {
            "sha": "7cbc1d26733614b83dcc25b9cfcd5e06dffb147c",
            "filename": "test/e2e/app-dir/app-basepath/app/metadata/opengraph-image.png",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/9483a371f1ac3a87464b59c68aa990e9813f28f0/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmetadata%2Fopengraph-image.png",
            "raw_url": "https://github.com/vercel/next.js/raw/9483a371f1ac3a87464b59c68aa990e9813f28f0/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmetadata%2Fopengraph-image.png",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmetadata%2Fopengraph-image.png?ref=9483a371f1ac3a87464b59c68aa990e9813f28f0",
            "previous_filename": "test/e2e/app-dir/app-basepath/app/another/opengraph-image.png"
        },
        {
            "sha": "9ac06150f5e11ec64740b505c7d745ce2589fc4b",
            "filename": "test/e2e/app-dir/app-basepath/app/metadata/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9483a371f1ac3a87464b59c68aa990e9813f28f0/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmetadata%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9483a371f1ac3a87464b59c68aa990e9813f28f0/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmetadata%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Fapp%2Fmetadata%2Fpage.js?ref=9483a371f1ac3a87464b59c68aa990e9813f28f0",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div id=\"page-metadata\">Page Metadata</div>\n+}"
        },
        {
            "sha": "8e327b313301882808d2e1ac9214f91ca608bcbc",
            "filename": "test/e2e/app-dir/app-basepath/index.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9483a371f1ac3a87464b59c68aa990e9813f28f0/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9483a371f1ac3a87464b59c68aa990e9813f28f0/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-basepath%2Findex.test.ts?ref=9483a371f1ac3a87464b59c68aa990e9813f28f0",
            "patch": "@@ -32,11 +32,16 @@ describe('app dir - basepath', () => {\n     ).toBe(`Page 2`)\n   })\n \n-  it('should prefix metadata og image with basePath', async () => {\n-    const $ = await next.render$('/base/another')\n+  it('should prefix segment metadata og image with basePath and pathname', async () => {\n+    const $ = await next.render$('/base/metadata')\n     const ogImageHref = $('meta[property=\"og:image\"]').attr('content')\n+    expect(ogImageHref).toContain('/base/metadata/opengraph-image.png')\n+  })\n \n-    expect(ogImageHref).toContain('/base/another/opengraph-image.png')\n+  it('should prefix manifest with basePath', async () => {\n+    const $ = await next.render$('/base/metadata')\n+    const manifestHref = $('link[rel=\"manifest\"]').attr('href')\n+    expect(manifestHref).toContain('/base/manifest.webmanifest')\n   })\n \n   it('should prefix redirect() with basePath', async () => {"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 32,
        "deletions": 8
    }
}