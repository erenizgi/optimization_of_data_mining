{
    "author": "jantimon",
    "message": "add support for cssmodules-pure-no-check to allow global CSS features like View Transitions (#77321)\n\n## What?\n\nThis PR adds support for `cssmodules-pure-no-check` in CSS Modules by\nupgrading `postcss-modules-local-by-default` from 4.0.4 to 4.2.0\n(`cssmodules-pure-no-check` was also recently [merged into LightningCSS\n1.29.3](https://github.com/parcel-bundler/lightningcss/pull/898))\n\n## Why?\nGlobal CSS selectors like View Transitions API require global scope to\nwork properly. Currently, there's no clean way to use these selectors\nwith CSS Modules in Next.js, which causes issues when:\n1. Using the View Transitions API\n2. Migrating from css-in-js libraries like styled-components to React\nServer Components with CSS Modules\n\n## How?\n- Upgrades `postcss-modules-local-by-default` to 4.2.0\n- Adds support for the `/* cssmodules-pure-no-check */` comment pattern\nin CSS files which disables CSS Modules localization for that file\n- This mirrors established escape hatches in other tools (`@ts-nocheck`,\n`/* eslint-disable */`)\n- Added tests (similar to one @samcx wrote previously) to ensure\nfunctionality works correctly\n\nThe approach was previously approved by @samcx in issue #77232, who\nmentioned that LightningCSS was already bumped, but we needed to bump\nthe PostCSS side\n\nFixes #77232\n\n---------\n\nCo-authored-by: Sam Ko <sam@vercel.com>",
    "sha": "ebc1150c8274e9f53099b0af3cf1810276e3b18d",
    "files": [
        {
            "sha": "56c7c30e968f295ac57cc1aa58b7695ab1ab81f1",
            "filename": "packages/next/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/packages%2Fnext%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/packages%2Fnext%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fpackage.json?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -293,7 +293,7 @@\n     \"picomatch\": \"4.0.1\",\n     \"postcss-flexbugs-fixes\": \"5.0.2\",\n     \"postcss-modules-extract-imports\": \"3.0.0\",\n-    \"postcss-modules-local-by-default\": \"4.0.4\",\n+    \"postcss-modules-local-by-default\": \"4.2.0\",\n     \"postcss-modules-scope\": \"3.0.0\",\n     \"postcss-modules-values\": \"4.0.0\",\n     \"postcss-preset-env\": \"7.4.3\","
        },
        {
            "sha": "fbc7934d16180dffcbcd85eb20a0fa9ac72ec697",
            "filename": "packages/next/src/compiled/postcss-modules-local-by-default/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/packages%2Fnext%2Fsrc%2Fcompiled%2Fpostcss-modules-local-by-default%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/packages%2Fnext%2Fsrc%2Fcompiled%2Fpostcss-modules-local-by-default%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fpostcss-modules-local-by-default%2Findex.js?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d"
        },
        {
            "sha": "006c0fce080307282b59d7853d320f6aac37db48",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 5,
            "deletions": 11,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -1405,8 +1405,8 @@ importers:\n         specifier: 3.0.0\n         version: 3.0.0(postcss@8.4.31)\n       postcss-modules-local-by-default:\n-        specifier: 4.0.4\n-        version: 4.0.4(postcss@8.4.31)\n+        specifier: 4.2.0\n+        version: 4.2.0(postcss@8.4.31)\n       postcss-modules-scope:\n         specifier: 3.0.0\n         version: 3.0.0(postcss@8.4.31)\n@@ -13674,12 +13674,6 @@ packages:\n     peerDependencies:\n       postcss: ^8.1.0\n \n-  postcss-modules-local-by-default@4.0.4:\n-    resolution: {integrity: sha512-L4QzMnOdVwRm1Qb8m4x8jsZzKAaPAgrUF1r/hjDR2Xj7R+8Zsf97jAlSQzWtKx5YNiNGN8QxmPFIc/sh+RQl+Q==}\n-    engines: {node: ^10 || ^12 || >= 14}\n-    peerDependencies:\n-      postcss: ^8.1.0\n-\n   postcss-modules-local-by-default@4.2.0:\n     resolution: {integrity: sha512-5kcJm/zk+GJDSfw+V/42fJ5fhjL5YbFDl8nVdXkJPLLW+Vf9mTD5Xe0wqIaDnLuL2U6cDNpTr+UQ+v2HWIBhzw==}\n     engines: {node: ^10 || ^12 || >= 14}\n@@ -32394,11 +32388,11 @@ snapshots:\n     dependencies:\n       postcss: 8.4.49\n \n-  postcss-modules-local-by-default@4.0.4(postcss@8.4.31):\n+  postcss-modules-local-by-default@4.2.0(postcss@8.4.31):\n     dependencies:\n       icss-utils: 5.1.0(postcss@8.4.31)\n       postcss: 8.4.31\n-      postcss-selector-parser: 6.0.11\n+      postcss-selector-parser: 7.0.0\n       postcss-value-parser: 4.2.0\n \n   postcss-modules-local-by-default@4.2.0(postcss@8.4.49):\n@@ -32435,7 +32429,7 @@ snapshots:\n       lodash.camelcase: 4.3.0\n       postcss: 8.4.31\n       postcss-modules-extract-imports: 3.0.0(postcss@8.4.31)\n-      postcss-modules-local-by-default: 4.0.4(postcss@8.4.31)\n+      postcss-modules-local-by-default: 4.2.0(postcss@8.4.31)\n       postcss-modules-scope: 3.0.0(postcss@8.4.31)\n       postcss-modules-values: 4.0.0(postcss@8.4.31)\n       string-hash: 1.1.3"
        },
        {
            "sha": "8c60c0aa605d4ef95f15779ad43df9970b1bb32f",
            "filename": "test/e2e/app-dir/css-modules-pure-no-check/app/home.module.css",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Fhome.module.css",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Fhome.module.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Fhome.module.css?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -0,0 +1,19 @@\n+/* cssmodules-pure-no-check */\n+\n+/* View Transitions API - requires global scope to work properly */\n+:global(::view-transition-old(root)) {\n+  animation-duration: 0.3s;\n+}\n+\n+/* a local class */\n+.home {\n+  background-color: #f0f0f0;\n+  color: #333;\n+  font-size: 16px;\n+  padding: 20px;\n+}\n+\n+/* a global class */\n+:global(.global) {\n+  font-weight: 700;\n+}"
        },
        {
            "sha": "56ffc2df94a7d1b5c51f70b7685a83b7a3750d1e",
            "filename": "test/e2e/app-dir/css-modules-pure-no-check/app/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Flayout.tsx?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -0,0 +1,13 @@\n+import type { ReactNode } from 'react'\n+\n+export default function RootLayout({\n+  children,\n+}: Readonly<{\n+  children: ReactNode\n+}>) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "206073969635cb8c2f953f6ef343d0901108d93d",
            "filename": "test/e2e/app-dir/css-modules-pure-no-check/app/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fapp%2Fpage.tsx?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -0,0 +1,9 @@\n+import styles from './home.module.css'\n+\n+export default function Home() {\n+  return (\n+    <div id=\"my-div\" className={`${styles.home} global`}>\n+      <div>This text should be bold</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "2a4784903222c72be3419ba94f8e037ca2e53d0f",
            "filename": "test/e2e/app-dir/css-modules-pure-no-check/css-modules-pure-no-check.test.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fcss-modules-pure-no-check.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fcss-modules-pure-no-check.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fcss-modules-pure-no-check.test.ts?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -0,0 +1,37 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import cheerio from 'cheerio'\n+\n+describe('css-modules-pure-no-check', () => {\n+  const { isNextStart, next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should apply styles correctly', async () => {\n+    const browser = await next.browser('/')\n+\n+    const elementWithGlobalStyles = await browser\n+      .elementByCss('#my-div')\n+      .getComputedCss('font-weight')\n+\n+    expect(elementWithGlobalStyles).toBe('700')\n+  })\n+\n+  if (isNextStart) {\n+    it('should have emitted a CSS file', async () => {\n+      const html = await next.render('/')\n+      const $html = cheerio.load(html)\n+\n+      const cssLink = $html('link[rel=\"stylesheet\"]')\n+      expect(cssLink.length).toBe(1)\n+      const cssHref = cssLink[0].attribs['href']\n+\n+      const res = await next.fetch(cssHref)\n+      const cssCode = await res.text()\n+\n+      expect(cssCode).toInclude(`.global{font-weight:700}`)\n+      expect(cssCode).toInclude(\n+        `::view-transition-old(root){animation-duration:.3s}`\n+      )\n+    })\n+  }\n+})"
        },
        {
            "sha": "73290639bc0ae1d251322dd57c81c24e6934dfb7",
            "filename": "test/e2e/app-dir/css-modules-pure-no-check/next.config.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-pure-no-check%2Fnext.config.ts?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -0,0 +1,7 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  /* config options here */\n+}\n+\n+export default nextConfig"
        },
        {
            "sha": "8c60c0aa605d4ef95f15779ad43df9970b1bb32f",
            "filename": "test/integration/css-fixtures/cssmodules-pure-no-check/pages/index.module.css",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Fpages%2Findex.module.css",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Fpages%2Findex.module.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Fpages%2Findex.module.css?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -0,0 +1,19 @@\n+/* cssmodules-pure-no-check */\n+\n+/* View Transitions API - requires global scope to work properly */\n+:global(::view-transition-old(root)) {\n+  animation-duration: 0.3s;\n+}\n+\n+/* a local class */\n+.home {\n+  background-color: #f0f0f0;\n+  color: #333;\n+  font-size: 16px;\n+  padding: 20px;\n+}\n+\n+/* a global class */\n+:global(.global) {\n+  font-weight: 700;\n+}"
        },
        {
            "sha": "963894805bf9cd42dae997633bae2a91a0fbd342",
            "filename": "test/integration/css-fixtures/cssmodules-pure-no-check/pages/index.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Fpages%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Fpages%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Fpages%2Findex.tsx?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -0,0 +1,9 @@\n+import styles from './index.module.css'\n+\n+export default function Home() {\n+  return (\n+    <div id=\"my-div\" className={`${styles.home} global`}>\n+      <div>This text should be bold</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "1d4f624eff7d9cc1f6acd2028a03cb50916f5827",
            "filename": "test/integration/css-fixtures/cssmodules-pure-no-check/tsconfig.json",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-fixtures%2Fcssmodules-pure-no-check%2Ftsconfig.json?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -0,0 +1,24 @@\n+{\n+  \"compilerOptions\": {\n+    \"target\": \"ES2017\",\n+    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n+    \"allowJs\": true,\n+    \"skipLibCheck\": true,\n+    \"strict\": false,\n+    \"noEmit\": true,\n+    \"incremental\": true,\n+    \"module\": \"esnext\",\n+    \"esModuleInterop\": true,\n+    \"moduleResolution\": \"node\",\n+    \"resolveJsonModule\": true,\n+    \"isolatedModules\": true,\n+    \"jsx\": \"preserve\",\n+    \"plugins\": [\n+      {\n+        \"name\": \"next\"\n+      }\n+    ]\n+  },\n+  \"include\": [\"next-env.d.ts\", \".next/types/**/*.ts\", \"**/*.ts\", \"**/*.tsx\"],\n+  \"exclude\": [\"node_modules\"]\n+}"
        },
        {
            "sha": "fa0d83d1413560ebcdfe978ab3d5c2ef217bbfdc",
            "filename": "test/integration/css-modules/test/index.test.js",
            "status": "modified",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ebc1150c8274e9f53099b0af3cf1810276e3b18d/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-modules%2Ftest%2Findex.test.js?ref=ebc1150c8274e9f53099b0af3cf1810276e3b18d",
            "patch": "@@ -724,3 +724,59 @@ describe('Catch-all Route CSS Module Usage', () => {\n     }\n   )\n })\n+\n+describe('cssmodules-pure-no-check usage', () => {\n+  const appDir = join(fixturesDir, 'cssmodules-pure-no-check')\n+\n+  let stdout\n+  let code\n+  let app\n+  let appPort\n+\n+  beforeAll(async () => {\n+    await remove(join(appDir, '.next'))\n+    ;({ code, stdout } = await nextBuild(appDir, [], {\n+      stdout: true,\n+    }))\n+    appPort = await findPort()\n+    app = await nextStart(appDir, appPort)\n+  })\n+\n+  afterAll(() => killApp(app))\n+\n+  it('should have compiled successfully', () => {\n+    console.log(stdout)\n+    expect(code).toBe(0)\n+    expect(stdout).toMatch(/Compiled successfully/)\n+  })\n+\n+  it('should apply styles correctly', async () => {\n+    const browser = await webdriver(appPort, '/')\n+\n+    const elementWithGlobalStyles = await browser\n+      .elementByCss('#my-div')\n+      .getComputedCss('font-weight')\n+\n+    expect(elementWithGlobalStyles).toBe('700')\n+  })\n+\n+  it(`should've emitted a CSS file`, async () => {\n+    const content = await renderViaHTTP(appPort, '/')\n+    const $ = cheerio.load(content)\n+\n+    const cssSheet = $('link[rel=\"stylesheet\"]')\n+    expect(cssSheet.length).toBe(1)\n+    const stylesheet = cssSheet[0].attribs['href']\n+\n+    const cssContent = await fetchViaHTTP(appPort, stylesheet).then((res) =>\n+      res.text()\n+    )\n+\n+    const cssCode = cssContent.replace(/\\/\\*.*?\\*\\//g, '').trim()\n+\n+    expect(cssCode).toInclude(`.global{font-weight:700}`)\n+    expect(cssCode).toInclude(\n+      `::view-transition-old(root){animation-duration:.3s}`\n+    )\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 213,
        "additions": 200,
        "deletions": 13
    }
}