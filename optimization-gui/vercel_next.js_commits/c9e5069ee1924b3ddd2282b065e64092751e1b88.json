{
    "author": "ijjk",
    "message": "Fix i18n fallback: false collision (#82136)\n\nThis fixes a case with i18n in pages router with deeply nested mixed\n`fallback: false` and `fallback: 'blocking'` routes where the internal\n`NoFallbackError` would be bubbled outside of the server handler causing\nthe invariant to leak instead of rendering the 404 page like expected.\n\nVerified against our E2E deploy tests here\nhttps://github.com/vercel/vercel/actions/runs/16586881087/job/46913897238\nand\nhttps://github.com/vercel/next.js/actions/runs/16586877291/job/46913935296\n\nCloses: NEXT-4655",
    "sha": "c9e5069ee1924b3ddd2282b065e64092751e1b88",
    "files": [
        {
            "sha": "6a5f316a48e4bd0c54a138ace806349549669449",
            "filename": "packages/next/src/server/lib/i18n-provider.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fi18n-provider.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fi18n-provider.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fi18n-provider.ts?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -118,8 +118,8 @@ export class I18NProvider {\n       // query and strip it from the pathname.\n       if (analysis.detectedLocale) {\n         if (analysis.detectedLocale !== detectedLocale) {\n-          throw new Error(\n-            `Invariant: The detected locale does not match the locale in the query. Expected to find '${detectedLocale}' in '${pathname}' but found '${analysis.detectedLocale}'}`\n+          console.warn(\n+            `The detected locale does not match the locale in the query. Expected to find '${detectedLocale}' in '${pathname}' but found '${analysis.detectedLocale}'}`\n           )\n         }\n "
        },
        {
            "sha": "708fdbcc75f2d643a6ec00210115645882660c34",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -1095,9 +1095,9 @@ export default class NextNodeServer extends BaseServer<\n       throw new Error('Invariant: pathname is undefined')\n     }\n \n-    // This is a catch-all route, there should be no fallbacks so mark it as\n-    // such.\n-    addRequestMeta(req, 'bubbleNoFallback', true)\n+    // When in minimal mode we do not bubble the fallback as the\n+    // router-server is not present to handle the error\n+    addRequestMeta(req, 'bubbleNoFallback', this.minimalMode ? undefined : true)\n \n     // This is needed to expose render404 and nextConfig\n     // for environments without router-server"
        },
        {
            "sha": "5c89029aec20f194f8c3e894e759575260da0324",
            "filename": "test/e2e/i18n-fallback-collision/i18n-fallback-collision.test.ts",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fi18n-fallback-collision.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fi18n-fallback-collision.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fi18n-fallback-collision.test.ts?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,45 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('i18n-disallow-multiple-locales', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it.each([\n+    ['/non-existent'],\n+    ['/es/non-existent'],\n+    ['/first/non-existent'],\n+    ['/es/first/non-existent'],\n+    ['/first/second/non-existent'],\n+    ['/es/first/second/non-existent'],\n+  ])(\n+    'should 404 properly for fallback: false non-prerendered %s',\n+    async (pathname) => {\n+      const res = await next.fetch(pathname)\n+      expect(res.status).toBe(404)\n+    }\n+  )\n+\n+  it.each([\n+    { urlPath: '/first', page: '/[first]' },\n+    { urlPath: '/first/second', page: '/[first]/[second]' },\n+    { urlPath: '/first/second/third', page: '/[first]/[second]/[third]' },\n+    {\n+      urlPath: '/first/second/third/fourth',\n+      page: '/[first]/[second]/[third]/[fourth]',\n+    },\n+  ])(\n+    'should render properly for fallback: false prerendered $urlPath',\n+    async ({ urlPath, page }) => {\n+      const res = await next.fetch(urlPath)\n+      expect(res.status).toBe(200)\n+      expect(await res.text()).toContain(page)\n+    }\n+  )\n+\n+  it('should render properly for fallback: blocking', async () => {\n+    const res = await next.fetch('/first/second/third/another')\n+    expect(res.status).toBe(200)\n+    expect(await res.text()).toContain('/[first]/[second]/[third]/[fourth]')\n+  })\n+})"
        },
        {
            "sha": "d322e5a79fe571a5ddc2076bbd439a768c375dbd",
            "filename": "test/e2e/i18n-fallback-collision/next.config.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fnext.config.ts?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,13 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  /* config options here */\n+  reactStrictMode: true,\n+\n+  i18n: {\n+    defaultLocale: 'en',\n+    locales: ['en', 'es'],\n+  },\n+}\n+\n+export default nextConfig"
        },
        {
            "sha": "6d4904e9b46617fcc3c19602b162b01ca167446f",
            "filename": "test/e2e/i18n-fallback-collision/pages/[first]/[second]/[third]/[fourth]/index.js",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2F%5Bfourth%5D%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2F%5Bfourth%5D%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2F%5Bfourth%5D%2Findex.js?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,32 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>page: /[first]/[second]/[third]/[fourth]</p>\n+    </>\n+  )\n+}\n+\n+export function getStaticProps({ params }) {\n+  return {\n+    props: {\n+      params,\n+      now: Date.now(),\n+    },\n+  }\n+}\n+\n+export function getStaticPaths() {\n+  return {\n+    paths: [\n+      {\n+        params: {\n+          first: 'first',\n+          second: 'second',\n+          third: 'third',\n+          fourth: 'fourth',\n+        },\n+      },\n+    ],\n+    fallback: 'blocking',\n+  }\n+}"
        },
        {
            "sha": "f32ce55db64b7b832247e51fa404ca8c9552d78c",
            "filename": "test/e2e/i18n-fallback-collision/pages/[first]/[second]/[third]/index.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Findex.js?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,27 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>page: /[first]/[second]/[third]</p>\n+    </>\n+  )\n+}\n+\n+export function getStaticProps({ params }) {\n+  return {\n+    props: {\n+      params,\n+      now: Date.now(),\n+    },\n+  }\n+}\n+\n+export function getStaticPaths() {\n+  return {\n+    paths: [\n+      {\n+        params: { first: 'first', second: 'second', third: 'third' },\n+      },\n+    ],\n+    fallback: false,\n+  }\n+}"
        },
        {
            "sha": "c8e4e5befa964d1781e9c5198e32a29b23515712",
            "filename": "test/e2e/i18n-fallback-collision/pages/[first]/[second]/index.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2F%5Bsecond%5D%2Findex.js?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,27 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>page: /[first]/[second]</p>\n+    </>\n+  )\n+}\n+\n+export function getStaticProps({ params }) {\n+  return {\n+    props: {\n+      params,\n+      now: Date.now(),\n+    },\n+  }\n+}\n+\n+export function getStaticPaths() {\n+  return {\n+    paths: [\n+      {\n+        params: { first: 'first', second: 'second' },\n+      },\n+    ],\n+    fallback: false,\n+  }\n+}"
        },
        {
            "sha": "3e5fd7e387b8c6e74907f149b962155cc795d04d",
            "filename": "test/e2e/i18n-fallback-collision/pages/[first]/index.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F%5Bfirst%5D%2Findex.js?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,27 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>page: /[first]</p>\n+    </>\n+  )\n+}\n+\n+export function getStaticProps({ params }) {\n+  return {\n+    props: {\n+      params,\n+      now: Date.now(),\n+    },\n+  }\n+}\n+\n+export function getStaticPaths() {\n+  return {\n+    paths: [\n+      {\n+        params: { first: 'first' },\n+      },\n+    ],\n+    fallback: false,\n+  }\n+}"
        },
        {
            "sha": "93928c3da70e2367557c82fc6aacfced7dd3266c",
            "filename": "test/e2e/i18n-fallback-collision/pages/_app.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F_app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F_app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F_app.tsx?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,5 @@\n+import type { AppProps } from 'next/app'\n+\n+export default function App({ Component, pageProps }: AppProps) {\n+  return <Component {...pageProps} />\n+}"
        },
        {
            "sha": "89f88e1068236c0d2458ad59705c59d207c393c8",
            "filename": "test/e2e/i18n-fallback-collision/pages/_document.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F_document.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F_document.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2F_document.tsx?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,13 @@\n+import { Html, Head, Main, NextScript } from 'next/document'\n+\n+export default function Document() {\n+  return (\n+    <Html lang=\"en\">\n+      <Head />\n+      <body className=\"antialiased\">\n+        <Main />\n+        <NextScript />\n+      </body>\n+    </Html>\n+  )\n+}"
        },
        {
            "sha": "a7954953fb477ade5bcab043a02e2207975b44a8",
            "filename": "test/e2e/i18n-fallback-collision/pages/index.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e5069ee1924b3ddd2282b065e64092751e1b88/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-fallback-collision%2Fpages%2Findex.tsx?ref=c9e5069ee1924b3ddd2282b065e64092751e1b88",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Home() {\n+  return (\n+    <>\n+      <p>index page</p>\n+    </>\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 206,
        "additions": 201,
        "deletions": 5
    }
}