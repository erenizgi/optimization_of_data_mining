{
    "author": "mischnic",
    "message": "Turbopack: fix module rules for `.module.scss` (#82570)\n\nIt ran `postcss(webpack(postcss(filesource)))`, which doesn't work.\n\nAnd changing the order does make sense, since we do want Webpack (SCSS) to run first, and only then PostCSS?\n\n#82554 didn't catch every case",
    "sha": "756221bb2d4c0498fe1d36f1c68bf79944b4d4c0",
    "files": [
        {
            "sha": "c96be6547a5de747ecc09f03b24e5fb7403b465c",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/app/other.module.scss",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fother.module.scss",
            "raw_url": "https://github.com/vercel/next.js/raw/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fother.module.scss",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fother.module.scss?ref=756221bb2d4c0498fe1d36f1c68bf79944b4d4c0",
            "patch": "@@ -0,0 +1,4 @@\n+.other {\n+  // some SCSS\n+  color: red;\n+}"
        },
        {
            "sha": "ad16d96359986efe47eae6dab5abdc8ae566b784",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/app/page.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.tsx?ref=756221bb2d4c0498fe1d36f1c68bf79944b4d4c0",
            "patch": "@@ -1,5 +1,11 @@\n import styles from './page.module.css'\n+import other from './other.module.scss'\n \n export default function Page() {\n-  return <p className={styles.main}>hello world</p>\n+  return (\n+    <div>\n+      <p className={styles.main}>hello world</p>\n+      <span className={other.other}>hello world</span>\n+    </div>\n+  )\n }"
        },
        {
            "sha": "d7aed41737cd4a40f6b8375830dfc018af0677c2",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/css-modules-rsc-postcss.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fcss-modules-rsc-postcss.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fcss-modules-rsc-postcss.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fcss-modules-rsc-postcss.test.ts?ref=756221bb2d4c0498fe1d36f1c68bf79944b4d4c0",
            "patch": "@@ -5,6 +5,7 @@ describe('css-modules-rsc-postcss', () => {\n     files: __dirname,\n     dependencies: {\n       'postcss-nested': '4.2.1',\n+      sass: 'latest',\n     },\n   })\n \n@@ -13,5 +14,8 @@ describe('css-modules-rsc-postcss', () => {\n     expect(await browser.elementByCss('p').getComputedCss('color')).toBe(\n       'rgb(0, 128, 0)'\n     )\n+    expect(await browser.elementByCss('span').getComputedCss('color')).toBe(\n+      'rgb(0, 128, 0)'\n+    )\n   })\n })"
        },
        {
            "sha": "8fadad10ee2e96823423e6f6ed60f1490383e96b",
            "filename": "test/e2e/app-dir/css-order/app/base-scss.module.scss",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fbase-scss.module.scss",
            "raw_url": "https://github.com/vercel/next.js/raw/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fbase-scss.module.scss",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fbase-scss.module.scss?ref=756221bb2d4c0498fe1d36f1c68bf79944b4d4c0",
            "patch": "@@ -1,3 +1,4 @@\n+// this is scss\n $base1: rgb(255, 1, 0);\n \n .base {"
        },
        {
            "sha": "4b30081ca217c40374d21d009d125f02bbdb40eb",
            "filename": "test/e2e/app-dir/css-order/app/base2-scss.module.scss",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fbase2-scss.module.scss",
            "raw_url": "https://github.com/vercel/next.js/raw/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fbase2-scss.module.scss",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-order%2Fapp%2Fbase2-scss.module.scss?ref=756221bb2d4c0498fe1d36f1c68bf79944b4d4c0",
            "patch": "@@ -1,3 +1,4 @@\n+// this is scss\n .base {\n   color: rgb(255, 3, 0);\n }"
        },
        {
            "sha": "dc5ac7b2dac476bff3df75f141ced1a186fcbcf0",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 80,
            "deletions": 79,
            "changes": 159,
            "blob_url": "https://github.com/vercel/next.js/blob/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/756221bb2d4c0498fe1d36f1c68bf79944b4d4c0/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=756221bb2d4c0498fe1d36f1c68bf79944b4d4c0",
            "patch": "@@ -470,6 +470,86 @@ impl ModuleOptions {\n             ),\n         ];\n \n+        if let Some(webpack_loaders_options) = enable_webpack_loaders {\n+            let webpack_loaders_options = webpack_loaders_options.await?;\n+            let execution_context =\n+                execution_context.context(\"execution_context is required for webpack_loaders\")?;\n+            let import_map = if let Some(loader_runner_package) =\n+                webpack_loaders_options.loader_runner_package\n+            {\n+                package_import_map_from_import_mapping(\n+                    rcstr!(\"loader-runner\"),\n+                    *loader_runner_package,\n+                )\n+            } else {\n+                package_import_map_from_context(\n+                    rcstr!(\"loader-runner\"),\n+                    path.clone()\n+                        .context(\"need_path in ModuleOptions::new is incorrect\")?,\n+                )\n+            };\n+            for (key, rule) in webpack_loaders_options.rules.await?.iter() {\n+                rules.push(ModuleRule::new(\n+                    RuleCondition::All(vec![\n+                        if key.starts_with(\"#\") {\n+                            // This is a custom marker requiring a corresponding condition entry\n+                            let conditions = (*webpack_loaders_options.conditions.await?)\n+                                .context(\n+                                    \"Expected a condition entry for the webpack loader rule \\\n+                                     matching {key}. Create a `conditions` mapping in your \\\n+                                     next.config.js\",\n+                                )?\n+                                .await?;\n+\n+                            let condition = conditions.get(key).context(\n+                                \"Expected a condition entry for the webpack loader rule matching \\\n+                                 {key}.\",\n+                            )?;\n+\n+                            match &condition.path {\n+                                ConditionPath::Glob(glob) => RuleCondition::ResourcePathGlob {\n+                                    base: execution_context.project_path().owned().await?,\n+                                    glob: Glob::new(glob.clone()).await?,\n+                                },\n+                                ConditionPath::Regex(regex) => {\n+                                    RuleCondition::ResourcePathEsRegex(regex.await?)\n+                                }\n+                            }\n+                        } else if key.contains('/') {\n+                            RuleCondition::ResourcePathGlob {\n+                                base: execution_context.project_path().owned().await?,\n+                                glob: Glob::new(key.clone()).await?,\n+                            }\n+                        } else {\n+                            RuleCondition::ResourceBasePathGlob(Glob::new(key.clone()).await?)\n+                        },\n+                        RuleCondition::not(RuleCondition::ResourceIsVirtualSource),\n+                        module_css_external_transform_conditions.clone(),\n+                    ]),\n+                    vec![ModuleRuleEffect::SourceTransforms(ResolvedVc::cell(vec![\n+                        ResolvedVc::upcast(\n+                            WebpackLoaders::new(\n+                                node_evaluate_asset_context(\n+                                    *execution_context,\n+                                    Some(import_map),\n+                                    None,\n+                                    Layer::new(rcstr!(\"webpack_loaders\")),\n+                                    false,\n+                                ),\n+                                *execution_context,\n+                                *rule.loaders,\n+                                rule.rename_as.clone(),\n+                                resolve_options_context,\n+                                matches!(ecmascript_source_maps, SourceMapsType::Full),\n+                            )\n+                            .to_resolved()\n+                            .await?,\n+                        ),\n+                    ]))],\n+                ));\n+            }\n+        }\n+\n         if enable_raw_css {\n             rules.extend([\n                 ModuleRule::new(\n@@ -644,85 +724,6 @@ impl ModuleOptions {\n             ));\n         }\n \n-        if let Some(webpack_loaders_options) = enable_webpack_loaders {\n-            let webpack_loaders_options = webpack_loaders_options.await?;\n-            let execution_context =\n-                execution_context.context(\"execution_context is required for webpack_loaders\")?;\n-            let import_map = if let Some(loader_runner_package) =\n-                webpack_loaders_options.loader_runner_package\n-            {\n-                package_import_map_from_import_mapping(\n-                    rcstr!(\"loader-runner\"),\n-                    *loader_runner_package,\n-                )\n-            } else {\n-                package_import_map_from_context(\n-                    rcstr!(\"loader-runner\"),\n-                    path.context(\"need_path in ModuleOptions::new is incorrect\")?,\n-                )\n-            };\n-            for (key, rule) in webpack_loaders_options.rules.await?.iter() {\n-                rules.push(ModuleRule::new(\n-                    RuleCondition::All(vec![\n-                        if key.starts_with(\"#\") {\n-                            // This is a custom marker requiring a corresponding condition entry\n-                            let conditions = (*webpack_loaders_options.conditions.await?)\n-                                .context(\n-                                    \"Expected a condition entry for the webpack loader rule \\\n-                                     matching {key}. Create a `conditions` mapping in your \\\n-                                     next.config.js\",\n-                                )?\n-                                .await?;\n-\n-                            let condition = conditions.get(key).context(\n-                                \"Expected a condition entry for the webpack loader rule matching \\\n-                                 {key}.\",\n-                            )?;\n-\n-                            match &condition.path {\n-                                ConditionPath::Glob(glob) => RuleCondition::ResourcePathGlob {\n-                                    base: execution_context.project_path().owned().await?,\n-                                    glob: Glob::new(glob.clone()).await?,\n-                                },\n-                                ConditionPath::Regex(regex) => {\n-                                    RuleCondition::ResourcePathEsRegex(regex.await?)\n-                                }\n-                            }\n-                        } else if key.contains('/') {\n-                            RuleCondition::ResourcePathGlob {\n-                                base: execution_context.project_path().owned().await?,\n-                                glob: Glob::new(key.clone()).await?,\n-                            }\n-                        } else {\n-                            RuleCondition::ResourceBasePathGlob(Glob::new(key.clone()).await?)\n-                        },\n-                        RuleCondition::not(RuleCondition::ResourceIsVirtualSource),\n-                        module_css_external_transform_conditions.clone(),\n-                    ]),\n-                    vec![ModuleRuleEffect::SourceTransforms(ResolvedVc::cell(vec![\n-                        ResolvedVc::upcast(\n-                            WebpackLoaders::new(\n-                                node_evaluate_asset_context(\n-                                    *execution_context,\n-                                    Some(import_map),\n-                                    None,\n-                                    Layer::new(rcstr!(\"webpack_loaders\")),\n-                                    false,\n-                                ),\n-                                *execution_context,\n-                                *rule.loaders,\n-                                rule.rename_as.clone(),\n-                                resolve_options_context,\n-                                matches!(ecmascript_source_maps, SourceMapsType::Full),\n-                            )\n-                            .to_resolved()\n-                            .await?,\n-                        ),\n-                    ]))],\n-                ));\n-            }\n-        }\n-\n         rules.extend(module_rules.iter().cloned());\n \n         Ok(ModuleOptions::cell(ModuleOptions { rules }))"
        }
    ],
    "stats": {
        "total": 177,
        "additions": 97,
        "deletions": 80
    }
}