{
    "author": "unstubbable",
    "message": "Fix cache kind validation (#76064)\n\nDefault cache handlers should be allowed and not trigger a build error.",
    "sha": "0cac089867b4465690385c2d48f5f3df5c5e000a",
    "files": [
        {
            "sha": "7b95ae9c25facc86e1ff0e602a0a0d5d4371fe7a",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/0cac089867b4465690385c2d48f5f3df5c5e000a/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0cac089867b4465690385c2d48f5f3df5c5e000a/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=0cac089867b4465690385c2d48f5f3df5c5e000a",
            "patch": "@@ -43,8 +43,21 @@ struct CustomRoutes {\n pub struct ModularizeImports(FxIndexMap<String, ModularizeImportPackageConfig>);\n \n #[turbo_tasks::value(transparent)]\n+#[derive(Clone, Debug)]\n pub struct CacheKinds(FxHashSet<RcStr>);\n \n+impl CacheKinds {\n+    pub fn extend<I: IntoIterator<Item = RcStr>>(&mut self, iter: I) {\n+        self.0.extend(iter);\n+    }\n+}\n+\n+impl Default for CacheKinds {\n+    fn default() -> Self {\n+        CacheKinds([\"default\", \"remote\"].iter().map(|&s| s.into()).collect())\n+    }\n+}\n+\n #[turbo_tasks::value(serialization = \"custom\", eq = \"manual\")]\n #[derive(Clone, Debug, Default, PartialEq, Serialize, Deserialize, OperationValue)]\n #[serde(rename_all = \"camelCase\")]\n@@ -1422,13 +1435,13 @@ impl NextConfig {\n \n     #[turbo_tasks::function]\n     pub fn cache_kinds(&self) -> Vc<CacheKinds> {\n-        Vc::cell(\n-            self.experimental\n-                .cache_handlers\n-                .as_ref()\n-                .map(|handlers| handlers.keys().cloned().collect())\n-                .unwrap_or_default(),\n-        )\n+        let mut cache_kinds = CacheKinds::default();\n+\n+        if let Some(handlers) = self.experimental.cache_handlers.as_ref() {\n+            cache_kinds.extend(handlers.keys().cloned());\n+        }\n+\n+        cache_kinds.cell()\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "a0144362c1425a2a7b85aacdd03056901048a80e",
            "filename": "packages/next/src/build/swc/options.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/0cac089867b4465690385c2d48f5f3df5c5e000a/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0cac089867b4465690385c2d48f5f3df5c5e000a/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts?ref=0cac089867b4465690385c2d48f5f3df5c5e000a",
            "patch": "@@ -221,7 +221,9 @@ function getBaseSWCOptions({\n             isReactServerLayer,\n             useCacheEnabled,\n             hashSalt: serverReferenceHashSalt,\n-            cacheKinds: cacheHandlers ? Object.keys(cacheHandlers) : [],\n+            cacheKinds: ['default', 'remote'].concat(\n+              cacheHandlers ? Object.keys(cacheHandlers) : []\n+            ),\n           }\n         : undefined,\n     // For app router we prefer to bundle ESM,"
        },
        {
            "sha": "3aa74329359fa2a1ec9c3851422114dd46c91c92",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/0cac089867b4465690385c2d48f5f3df5c5e000a/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0cac089867b4465690385c2d48f5f3df5c5e000a/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=0cac089867b4465690385c2d48f5f3df5c5e000a",
            "patch": "@@ -400,6 +400,14 @@ export default class NextNodeServer extends BaseServer<\n           cacheHandlerGlobal[cacheHandlersSymbol]?.DefaultCache ||\n           DefaultCacheHandler\n       }\n+\n+      if (\n+        !cacheHandlers.remote &&\n+        cacheHandlerGlobal[cacheHandlersSymbol]?.RemoteCache\n+      ) {\n+        cacheHandlerGlobal.__nextCacheHandlers.remote =\n+          cacheHandlerGlobal[cacheHandlersSymbol].RemoteCache\n+      }\n     }\n   }\n "
        },
        {
            "sha": "9297cb48e1fbd4b94378bd1dc927cf27e0c0bc0a",
            "filename": "test/e2e/app-dir/use-cache-unknown-cache-kind/app/remote/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fapp%2Fremote%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fapp%2Fremote%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fapp%2Fremote%2Fpage.tsx?ref=0cac089867b4465690385c2d48f5f3df5c5e000a",
            "patch": "@@ -0,0 +1,5 @@\n+'use cache: remote'\n+\n+export default async function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "af56a26e95638b0ca81376c09cdc214e5aa18b3c",
            "filename": "test/e2e/app-dir/use-cache-unknown-cache-kind/instrumentation.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Finstrumentation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Finstrumentation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Finstrumentation.ts?ref=0cac089867b4465690385c2d48f5f3df5c5e000a",
            "patch": "@@ -0,0 +1,7 @@\n+import DefaultCacheHandler from 'next/dist/server/lib/cache-handlers/default'\n+\n+export function register() {\n+  globalThis[Symbol.for('@next/cache-handlers')] = {\n+    RemoteCache: DefaultCacheHandler,\n+  }\n+}"
        },
        {
            "sha": "163414e688363e024b7422e16266adc694981f1f",
            "filename": "test/e2e/app-dir/use-cache-unknown-cache-kind/next.config.js",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fnext.config.js?ref=0cac089867b4465690385c2d48f5f3df5c5e000a",
            "patch": "@@ -4,6 +4,8 @@\n const nextConfig = {\n   experimental: {\n     dynamicIO: true,\n+    cacheHandlers: {}, // overwrite the default config\n+    prerenderEarlyExit: false,\n   },\n }\n "
        },
        {
            "sha": "b5c45eeca25d450cc0b93bb935eb39bd67b8ebfe",
            "filename": "test/e2e/app-dir/use-cache-unknown-cache-kind/use-cache-unknown-cache-kind.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fuse-cache-unknown-cache-kind.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fuse-cache-unknown-cache-kind.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-unknown-cache-kind%2Fuse-cache-unknown-cache-kind.test.ts?ref=0cac089867b4465690385c2d48f5f3df5c5e000a",
            "patch": "@@ -33,9 +33,12 @@ describe('use-cache-unknown-cache-kind', () => {\n     process.env.__NEXT_EXPERIMENTAL_NEW_DEV_OVERLAY === 'true'\n \n   if (isNextStart) {\n+    beforeAll(async () => {\n+      await next.build()\n+    })\n+\n     it('should fail the build with an error', async () => {\n-      const { cliOutput } = await next.build()\n-      const buildOutput = getBuildOutput(cliOutput)\n+      const buildOutput = getBuildOutput(next.cliOutput)\n \n       if (isTurbopack) {\n         expect(buildOutput).toMatchInlineSnapshot(`\n@@ -79,7 +82,16 @@ describe('use-cache-unknown-cache-kind', () => {\n         `)\n       }\n     })\n+\n+    it('should not fail the build for default cache kinds', async () => {\n+      expect(next.cliOutput).not.toInclude('Unknown cache kind \"remote\"')\n+    })\n   } else {\n+    it('should not show an error for default cache kinds', async () => {\n+      const browser = await next.browser('/remote')\n+      await assertNoRedbox(browser)\n+    })\n+\n     it('should show a build error', async () => {\n       const browser = await next.browser('/')\n "
        },
        {
            "sha": "d18e59375e894b471eaed0948b06c77abe0358c6",
            "filename": "test/lib/next-modes/next-dev.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0cac089867b4465690385c2d48f5f3df5c5e000a/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-dev.ts?ref=0cac089867b4465690385c2d48f5f3df5c5e000a",
            "patch": "@@ -161,13 +161,13 @@ export class NextDevInstance extends NextInstance {\n   ) {\n     await this.handleDevWatchDelayBeforeChange(filename)\n     try {\n-      const cliOutputLengthBefore = this.cliOutput.length\n+      let cliOutputLength = this.cliOutput.length\n       const isServerRunning = this.childProcess && !this.isStopping\n \n       const detectServerRestart = async () => {\n         await retry(async () => {\n           const isServerReady = this.serverReadyPattern.test(\n-            this.cliOutput.slice(cliOutputLengthBefore)\n+            this.cliOutput.slice(cliOutputLength)\n           )\n           if (isServerRunning && !isServerReady) {\n             throw new Error('Server has not finished restarting.')\n@@ -202,6 +202,7 @@ export class NextDevInstance extends NextInstance {\n           runWithTempContent\n             ? async (...args) => {\n                 await waitServerToBeReadyAfterPatchFile()\n+                cliOutputLength = this.cliOutput.length\n \n                 return runWithTempContent(...args)\n               }"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 62,
        "deletions": 12
    }
}