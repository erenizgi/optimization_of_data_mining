{
    "author": "ijjk",
    "message": "Move static-env imports (#77035)\n\nIn https://github.com/vercel/next.js/pull/76990 we noticed that imports\nin `base-server`/`next-server` are being processed by turbopack which\nneeds to be investigated further although for now this moves the imports\nto only import the necessary files in `next-server` to avoid bundling\ntime regression.",
    "sha": "d0dfc63c20bb64174524949620ebb547225e6b18",
    "files": [
        {
            "sha": "c6ada2bb4dcc0eda9b7020376af661e077b1109c",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=d0dfc63c20bb64174524949620ebb547225e6b18",
            "patch": "@@ -207,7 +207,8 @@ import {\n \n import { turbopackBuild } from './turbopack-build'\n import { isPersistentCachingEnabled } from '../shared/lib/turbopack/utils'\n-import { inlineStaticEnv, populateStaticEnv } from '../lib/inline-static-env'\n+import { inlineStaticEnv } from '../lib/inline-static-env'\n+import { populateStaticEnv } from '../lib/static-env'\n \n type Fallback = null | boolean | string\n "
        },
        {
            "sha": "8c98ad8c54842e720bcf83c6c5505883f752fdbe",
            "filename": "packages/next/src/build/webpack/plugins/define-env-plugin.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 44,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts?ref=d0dfc63c20bb64174524949620ebb547225e6b18",
            "patch": "@@ -6,17 +6,10 @@ import type { MiddlewareMatcher } from '../../analysis/get-page-static-info'\n import { webpack } from 'next/dist/compiled/webpack/webpack'\n import { needsExperimentalReact } from '../../../lib/needs-experimental-react'\n import { checkIsAppPPREnabled } from '../../../server/lib/experimental/ppr'\n-\n-function errorIfEnvConflicted(config: NextConfigComplete, key: string) {\n-  const isPrivateKey = /^(?:NODE_.+)|^(?:__.+)$/i.test(key)\n-  const hasNextRuntimeKey = key === 'NEXT_RUNTIME'\n-\n-  if (isPrivateKey || hasNextRuntimeKey) {\n-    throw new Error(\n-      `The key \"${key}\" under \"env\" in ${config.configFileName} is not allowed. https://nextjs.org/docs/messages/env-key-not-allowed`\n-    )\n-  }\n-}\n+import {\n+  getNextConfigEnv,\n+  getNextPublicEnvironmentVariables,\n+} from '../../../lib/static-env'\n \n type BloomFilter = ReturnType<\n   import('../../../shared/lib/bloom-filter').BloomFilter['export']\n@@ -56,39 +49,6 @@ interface SerializedDefineEnv {\n   [key: string]: string\n }\n \n-/**\n- * Collects all environment variables that are using the `NEXT_PUBLIC_` prefix.\n- */\n-export function getNextPublicEnvironmentVariables(): DefineEnv {\n-  const defineEnv: DefineEnv = {}\n-  for (const key in process.env) {\n-    if (key.startsWith('NEXT_PUBLIC_')) {\n-      const value = process.env[key]\n-      if (value != null) {\n-        defineEnv[`process.env.${key}`] = value\n-      }\n-    }\n-  }\n-  return defineEnv\n-}\n-\n-/**\n- * Collects the `env` config value from the Next.js config.\n- */\n-export function getNextConfigEnv(config: NextConfigComplete): DefineEnv {\n-  // Refactored code below to use for-of\n-  const defineEnv: DefineEnv = {}\n-  const env = config.env\n-  for (const key in env) {\n-    const value = env[key]\n-    if (value != null) {\n-      errorIfEnvConflicted(config, key)\n-      defineEnv[`process.env.${key}`] = value\n-    }\n-  }\n-  return defineEnv\n-}\n-\n /**\n  * Serializes the DefineEnv config so that it can be inserted into the code by Webpack/Turbopack, JSON stringifies each value.\n  */"
        },
        {
            "sha": "fe02dd7c41ac48dc3e626be5fd5539aa05112990",
            "filename": "packages/next/src/lib/inline-static-env.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 26,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Flib%2Finline-static-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Flib%2Finline-static-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Finline-static-env.ts?ref=d0dfc63c20bb64174524949620ebb547225e6b18",
            "patch": "@@ -3,38 +3,13 @@ import path from 'path'\n import crypto from 'crypto'\n import { promisify } from 'util'\n import globOriginal from 'next/dist/compiled/glob'\n-import {\n-  getNextConfigEnv,\n-  getNextPublicEnvironmentVariables,\n-} from '../build/webpack/plugins/define-env-plugin'\n import { Sema } from 'next/dist/compiled/async-sema'\n import type { NextConfigComplete } from '../server/config-shared'\n import { BUILD_MANIFEST } from '../shared/lib/constants'\n+import { getNextConfigEnv, getStaticEnv } from './static-env'\n \n const glob = promisify(globOriginal)\n \n-const getStaticEnv = (config: NextConfigComplete) => {\n-  const staticEnv: Record<string, string | undefined> = {\n-    ...getNextPublicEnvironmentVariables(),\n-    ...getNextConfigEnv(config),\n-    'process.env.NEXT_DEPLOYMENT_ID': config.deploymentId || '',\n-  }\n-  return staticEnv\n-}\n-\n-export function populateStaticEnv(config: NextConfigComplete) {\n-  // since inlining comes after static generation we need\n-  // to ensure this value is assigned to process env so it\n-  // can still be accessed\n-  const staticEnv = getStaticEnv(config)\n-  for (const key in staticEnv) {\n-    const innerKey = key.split('.').pop() || ''\n-    if (!process.env[innerKey]) {\n-      process.env[innerKey] = staticEnv[key] || ''\n-    }\n-  }\n-}\n-\n export async function inlineStaticEnv({\n   distDir,\n   config,"
        },
        {
            "sha": "250167bdb1478d8a9cd7e98e8e603ba6cea1ec34",
            "filename": "packages/next/src/lib/static-env.ts",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Flib%2Fstatic-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Flib%2Fstatic-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fstatic-env.ts?ref=d0dfc63c20bb64174524949620ebb547225e6b18",
            "patch": "@@ -0,0 +1,67 @@\n+import type { NextConfigComplete } from '../server/config-shared'\n+\n+function errorIfEnvConflicted(config: NextConfigComplete, key: string) {\n+  const isPrivateKey = /^(?:NODE_.+)|^(?:__.+)$/i.test(key)\n+  const hasNextRuntimeKey = key === 'NEXT_RUNTIME'\n+\n+  if (isPrivateKey || hasNextRuntimeKey) {\n+    throw new Error(\n+      `The key \"${key}\" under \"env\" in ${config.configFileName} is not allowed. https://nextjs.org/docs/messages/env-key-not-allowed`\n+    )\n+  }\n+}\n+\n+/**\n+ * Collects all environment variables that are using the `NEXT_PUBLIC_` prefix.\n+ */\n+export function getNextPublicEnvironmentVariables() {\n+  const defineEnv: Record<string, string | undefined> = {}\n+  for (const key in process.env) {\n+    if (key.startsWith('NEXT_PUBLIC_')) {\n+      const value = process.env[key]\n+      if (value != null) {\n+        defineEnv[`process.env.${key}`] = value\n+      }\n+    }\n+  }\n+  return defineEnv\n+}\n+\n+/**\n+ * Collects the `env` config value from the Next.js config.\n+ */\n+export function getNextConfigEnv(config: NextConfigComplete) {\n+  // Refactored code below to use for-of\n+  const defineEnv: Record<string, string | undefined> = {}\n+  const env = config.env\n+  for (const key in env) {\n+    const value = env[key]\n+    if (value != null) {\n+      errorIfEnvConflicted(config, key)\n+      defineEnv[`process.env.${key}`] = value\n+    }\n+  }\n+  return defineEnv\n+}\n+\n+export function getStaticEnv(config: NextConfigComplete) {\n+  const staticEnv: Record<string, string | undefined> = {\n+    ...getNextPublicEnvironmentVariables(),\n+    ...getNextConfigEnv(config),\n+    'process.env.NEXT_DEPLOYMENT_ID': config.deploymentId || '',\n+  }\n+  return staticEnv\n+}\n+\n+export function populateStaticEnv(config: NextConfigComplete) {\n+  // since inlining comes after static generation we need\n+  // to ensure this value is assigned to process env so it\n+  // can still be accessed\n+  const staticEnv = getStaticEnv(config)\n+  for (const key in staticEnv) {\n+    const innerKey = key.split('.').pop() || ''\n+    if (!process.env[innerKey]) {\n+      process.env[innerKey] = staticEnv[key] || ''\n+    }\n+  }\n+}"
        },
        {
            "sha": "1cbe3f3ee99bcbf2fce7caa5ff8c6fd65219581d",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=d0dfc63c20bb64174524949620ebb547225e6b18",
            "patch": "@@ -614,17 +614,6 @@ export default abstract class Server<\n       reactMaxHeadersLength: this.nextConfig.reactMaxHeadersLength,\n     }\n \n-    if (process.env.NEXT_RUNTIME !== 'edge') {\n-      const { populateStaticEnv } =\n-        require('../lib/inline-static-env') as typeof import('../lib/inline-static-env')\n-\n-      // when using compile mode static env isn't inlined so we\n-      // need to populate in normal runtime env\n-      if (this.renderOpts.isExperimentalCompile) {\n-        populateStaticEnv(this.nextConfig)\n-      }\n-    }\n-\n     // Initialize next/config with the environment configuration\n     setConfig({\n       serverRuntimeConfig,"
        },
        {
            "sha": "9115b66ac8231fca1a4ca678a7f1586ba7013ab8",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d0dfc63c20bb64174524949620ebb547225e6b18/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=d0dfc63c20bb64174524949620ebb547225e6b18",
            "patch": "@@ -111,6 +111,7 @@ import { AwaiterOnce } from './after/awaiter'\n import { AsyncCallbackSet } from './lib/async-callback-set'\n import { initializeCacheHandlers, setCacheHandler } from './use-cache/handlers'\n import type { UnwrapPromise } from '../lib/coalesced-function'\n+import { populateStaticEnv } from '../lib/static-env'\n \n export * from './base-server'\n \n@@ -279,6 +280,12 @@ export default class NextNodeServer extends BaseServer<\n         console.error('Failed to prepare server', err)\n       })\n     }\n+\n+    // when using compile mode static env isn't inlined so we\n+    // need to populate in normal runtime env\n+    if (this.renderOpts.isExperimentalCompile) {\n+      populateStaticEnv(this.nextConfig)\n+    }\n   }\n \n   public async unstable_preloadEntries(): Promise<void> {"
        }
    ],
    "stats": {
        "total": 163,
        "additions": 81,
        "deletions": 82
    }
}