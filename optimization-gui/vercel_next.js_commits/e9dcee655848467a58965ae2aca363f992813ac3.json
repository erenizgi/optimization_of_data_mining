{
    "author": "wbinnssmith",
    "message": "Next.js plugin for alternate bundler (#76186)\n\nThis adds a new package allowing users to opt-into using Rspack in place of webpack in Next.js. While there is some logic to handle rspack in core, the actual third-party dependencies are not included there, only conditionally loaded. This package:\r\n    \r\n- Includes the actual npm dependencies on `@rspack/core` and `@rspack/plugin-react-refresh`\r\n- Sets the `NEXT_RSPACK` environment variable, which Next.js itself uses to load the dependencies\r\n- It exists as a kind of no-op `withRspack` decorator. @timneutkens is this the best approach to this?",
    "sha": "e9dcee655848467a58965ae2aca363f992813ac3",
    "files": [
        {
            "sha": "e91161f68b74d7d150c2d1e22e14282bdbfe08b4",
            "filename": "package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e9dcee655848467a58965ae2aca363f992813ac3/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e9dcee655848467a58965ae2aca363f992813ac3/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=e9dcee655848467a58965ae2aca363f992813ac3",
            "patch": "@@ -16,7 +16,7 @@\n     \"test-types\": \"tsc\",\n     \"test-unit\": \"jest test/unit/ packages/next/ packages/font\",\n     \"test-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\",\n-    \"test-dev-rspack\": \"cross-env NEXT_TEST_MODE=dev NEXT_RSPACK=1 BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN=1 BUILTIN_APP_LOADER=1 BUILTIN_SWC_LOADER=1 pnpm testheadless\",\n+    \"test-dev-rspack\": \"cross-env NEXT_TEST_MODE=dev NEXT_TEST_USE_RSPACK=1 BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN=1 BUILTIN_APP_LOADER=1 BUILTIN_SWC_LOADER=1 pnpm testheadless\",\n     \"test-dev-turbo\": \"cross-env NEXT_TEST_MODE=dev TURBOPACK=1 TURBOPACK_DEV=1 pnpm testheadless\",\n     \"test-start\": \"cross-env NEXT_TEST_MODE=start pnpm testheadless\",\n     \"test-start-rspack\": \"cross-env NEXT_TEST_MODE=start NEXT_RSPACK=1 BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN=1 BUILTIN_APP_LOADER=1 BUILTIN_SWC_LOADER=1 pnpm testheadless\","
        },
        {
            "sha": "4762c00b7b7da5d49c9acb84826e5f411e086172",
            "filename": "packages/next-plugin-rspack/README.md",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext-plugin-rspack%2FREADME.md",
            "raw_url": "https://github.com/vercel/next.js/raw/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext-plugin-rspack%2FREADME.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-plugin-rspack%2FREADME.md?ref=e9dcee655848467a58965ae2aca363f992813ac3",
            "patch": "@@ -0,0 +1,44 @@\n+# @next/plugin-rspack\n+\n+This plugin allows you to use [Rspack](https://rspack.dev) in place of webpack with Next.js.\n+\n+## Installation\n+\n+```\n+npm install @next/plugin-rspack\n+```\n+\n+or\n+\n+```\n+yarn add @next/plugin-rspack\n+```\n+\n+## Usage\n+\n+Create or update a `next.config.js`/`next.config.ts` and wrap your existing configuration:\n+\n+```js\n+const withRspack = require('@next/plugin-rspack')\n+\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  /* config options here */\n+}\n+\n+module.exports = withRspack(nextConfig)\n+```\n+\n+## Usage with next-compose-plugins\n+\n+Alternatively, you can use `next-compose-plugins` to quickly integrate `@next/plugin-rspack` with other Next.js plugins:\n+\n+```js\n+const withPlugins = require('next-compose-plugins')\n+const withRspack = require('@next/plugin-rspack')\n+\n+module.exports = withPlugins([\n+  [withRspack],\n+  // your other plugins here\n+])\n+```"
        },
        {
            "sha": "006e0c7d4f8a2f184ef576d787c716e7ddd94515",
            "filename": "packages/next-plugin-rspack/index.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext-plugin-rspack%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext-plugin-rspack%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-plugin-rspack%2Findex.js?ref=e9dcee655848467a58965ae2aca363f992813ac3",
            "patch": "@@ -0,0 +1,7 @@\n+module.exports = function withRspack(config) {\n+  process.env.NEXT_RSPACK = 'true'\n+  process.env.BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN = 'true'\n+  process.env.BUILTIN_APP_LOADER = 'true'\n+  process.env.BUILTIN_SWC_LOADER = 'true'\n+  return config\n+}"
        },
        {
            "sha": "804e1618063c6ecaa4e52967ca74308c398f2fb4",
            "filename": "packages/next-plugin-rspack/package.json",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext-plugin-rspack%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext-plugin-rspack%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-plugin-rspack%2Fpackage.json?ref=e9dcee655848467a58965ae2aca363f992813ac3",
            "patch": "@@ -0,0 +1,12 @@\n+{\n+  \"name\": \"@next/plugin-rspack\",\n+  \"version\": \"15.2.0-canary.65\",\n+  \"repository\": {\n+    \"url\": \"vercel/next.js\",\n+    \"directory\": \"packages/next-plugin-rspack\"\n+  },\n+  \"dependencies\": {\n+    \"@rspack/core\": \"npm:@rspack-canary/core@1.2.0-canary-37cc738d-20250207113050\",\n+    \"@rspack/plugin-react-refresh\": \"1.0.1\"\n+  }\n+}"
        },
        {
            "sha": "0ddb334d4793ffbcad333ea6589977f6f0a55de5",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=e9dcee655848467a58965ae2aca363f992813ac3",
            "patch": "@@ -644,5 +644,7 @@\n   \"643\": \"Invalid \\\"devIndicator.position\\\" provided, expected one of %s, received %s\",\n   \"644\": \"@rspack/core is not available. Please make sure the appropriate Next.js plugin is installed.\",\n   \"645\": \"@rspack/plugin-react-refresh is not available. Please make sure the appropriate Next.js plugin is installed.\",\n-  \"646\": \"No span found for compilation\"\n+  \"646\": \"No span found for compilation\",\n+  \"647\": \"@rspack/core is not available. Please make sure `@next/plugin-rspack` is correctly installed.\",\n+  \"648\": \"@rspack/plugin-react-refresh is not available. Please make sure `@next/plugin-rspack` is correctly installed.\"\n }"
        },
        {
            "sha": "9ba62d1ad4277ce890e16dee2673c37a4666cd5d",
            "filename": "packages/next/src/shared/lib/get-rspack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e9dcee655848467a58965ae2aca363f992813ac3/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-rspack.ts?ref=e9dcee655848467a58965ae2aca363f992813ac3",
            "patch": "@@ -5,7 +5,7 @@ export function getRspackCore() {\n   } catch (e) {\n     if (e instanceof Error && 'code' in e && e.code === 'MODULE_NOT_FOUND') {\n       throw new Error(\n-        '@rspack/core is not available. Please make sure the appropriate Next.js plugin is installed.'\n+        '@rspack/core is not available. Please make sure `@next/plugin-rspack` is correctly installed.'\n       )\n     }\n \n@@ -20,7 +20,7 @@ export function getRspackReactRefresh() {\n   } catch (e) {\n     if (e instanceof Error && 'code' in e && e.code === 'MODULE_NOT_FOUND') {\n       throw new Error(\n-        '@rspack/plugin-react-refresh is not available. Please make sure the appropriate Next.js plugin is installed.'\n+        '@rspack/plugin-react-refresh is not available. Please make sure `@next/plugin-rspack` is correctly installed.'\n       )\n     }\n "
        },
        {
            "sha": "750e3cebe99a22bdd952e219c7a4aa2cf8d2a45d",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/e9dcee655848467a58965ae2aca363f992813ac3/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/e9dcee655848467a58965ae2aca363f992813ac3/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=e9dcee655848467a58965ae2aca363f992813ac3",
            "patch": "@@ -1631,6 +1631,15 @@ importers:\n         specifier: ^0.7.0\n         version: 0.7.3\n \n+  packages/next-plugin-rspack:\n+    dependencies:\n+      '@rspack/core':\n+        specifier: npm:@rspack-canary/core@1.2.0-canary-37cc738d-20250207113050\n+        version: '@rspack-canary/core@1.2.0-canary-37cc738d-20250207113050(@swc/helpers@0.5.15)'\n+      '@rspack/plugin-react-refresh':\n+        specifier: 1.0.1\n+        version: 1.0.1(react-refresh@0.12.0)\n+\n   packages/next-plugin-storybook: {}\n \n   packages/next-polyfill-module:"
        },
        {
            "sha": "fd83206d4aecb9a3cd7fe5c8a0b1916a54f478cb",
            "filename": "test/lib/create-next-install.js",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/e9dcee655848467a58965ae2aca363f992813ac3/test%2Flib%2Fcreate-next-install.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e9dcee655848467a58965ae2aca363f992813ac3/test%2Flib%2Fcreate-next-install.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fcreate-next-install.js?ref=e9dcee655848467a58965ae2aca363f992813ac3",
            "patch": "@@ -8,6 +8,7 @@ const { linkPackages } =\n   require('../../.github/actions/next-stats-action/src/prepare/repo-setup')()\n \n const PREFER_OFFLINE = process.env.NEXT_TEST_PREFER_OFFLINE === '1'\n+const useRspack = process.env.NEXT_TEST_USE_RSPACK === '1'\n \n async function installDependencies(cwd, tmpDir) {\n   const args = [\n@@ -122,6 +123,7 @@ async function createNextInstall({\n             })\n           )\n       }\n+\n       const combinedDependencies = {\n         next: pkgPaths.get('next'),\n         ...Object.keys(dependencies).reduce((prev, pkg) => {\n@@ -131,6 +133,12 @@ async function createNextInstall({\n         }, {}),\n       }\n \n+      if (useRspack) {\n+        combinedDependencies['@next/plugin-rspack'] = pkgPaths = pkgPaths.get(\n+          '@next/plugin-rspack'\n+        )\n+      }\n+\n       const scripts = {\n         debug: `NEXT_PRIVATE_SKIP_CANARY_CHECK=1 NEXT_TELEMETRY_DISABLED=1 NEXT_TEST_NATIVE_DIR=${process.env.NEXT_TEST_NATIVE_DIR} node --inspect --trace-deprecation --enable-source-maps node_modules/next/dist/bin/next`,\n         ...packageJson.scripts,\n@@ -183,6 +191,15 @@ async function createNextInstall({\n           .traceAsyncFn(() => installDependencies(installDir, tmpDir))\n       }\n \n+      if (useRspack) {\n+        // This is what the @next/plugin-rspack plugin does.\n+        // TODO: Load the plugin properly during test\n+        process.env.NEXT_RSPACK = 'true'\n+        process.env.BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN = 'true'\n+        process.env.BUILTIN_APP_LOADER = 'true'\n+        process.env.BUILTIN_SWC_LOADER = 'true'\n+      }\n+\n       return {\n         installDir,\n         pkgPaths,"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 95,
        "deletions": 4
    }
}