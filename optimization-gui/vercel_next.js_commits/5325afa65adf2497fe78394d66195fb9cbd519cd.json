{
    "author": "huozhi",
    "message": "[metadata] refactor to remove async metadata (#78495)",
    "sha": "5325afa65adf2497fe78394d66195fb9cbd519cd",
    "files": [
        {
            "sha": "c1dde1dc2426545528a50e896fd928d92b3f7b57",
            "filename": "packages/next/src/client/components/metadata/async-metadata.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fasync-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fasync-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fasync-metadata.tsx?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -3,15 +3,6 @@\n import { Suspense, use } from 'react'\n import type { StreamingMetadataResolvedState } from './types'\n \n-export const AsyncMetadata =\n-  typeof window === 'undefined'\n-    ? (\n-        require('./server-inserted-metadata') as typeof import('./server-inserted-metadata')\n-      ).ServerInsertMetadata\n-    : (\n-        require('./browser-resolved-metadata') as typeof import('./browser-resolved-metadata')\n-      ).BrowserResolvedMetadata\n-\n function MetadataOutlet({\n   promise,\n }: {"
        },
        {
            "sha": "4a3e181225aaf8202be5126b39e835ec73ae5163",
            "filename": "packages/next/src/client/components/metadata/browser-resolved-metadata.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/286eefe64e334b8a965f2bd91a95552087574ace/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fbrowser-resolved-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/286eefe64e334b8a965f2bd91a95552087574ace/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fbrowser-resolved-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fbrowser-resolved-metadata.tsx?ref=286eefe64e334b8a965f2bd91a95552087574ace",
            "patch": "@@ -1,14 +0,0 @@\n-import { use } from 'react'\n-import type { StreamingMetadataResolvedState } from './types'\n-\n-export function BrowserResolvedMetadata({\n-  promise,\n-}: {\n-  promise: Promise<StreamingMetadataResolvedState>\n-}) {\n-  const { metadata, error } = use(promise)\n-  // If there's metadata error on client, discard the browser metadata\n-  // and let metadata outlet deal with the error. This will avoid the duplication metadata.\n-  if (error) return null\n-  return metadata\n-}"
        },
        {
            "sha": "0cda2d7c25ca59bedd33b3480a0fef49dbb3bcf2",
            "filename": "packages/next/src/client/components/metadata/server-inserted-metadata.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 29,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/286eefe64e334b8a965f2bd91a95552087574ace/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/286eefe64e334b8a965f2bd91a95552087574ace/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.tsx?ref=286eefe64e334b8a965f2bd91a95552087574ace",
            "patch": "@@ -1,29 +0,0 @@\n-import { use, useContext } from 'react'\n-import {\n-  type MetadataResolver,\n-  ServerInsertedMetadataContext,\n-} from '../../../shared/lib/server-inserted-metadata.shared-runtime'\n-import type { StreamingMetadataResolvedState } from './types'\n-\n-// Receives a metadata resolver setter from the context, and will pass the metadata resolving promise to\n-// the context where we gonna use it to resolve the metadata, and render as string to append in <body>.\n-const useServerInsertedMetadata = (metadataResolver: MetadataResolver) => {\n-  const setMetadataResolver = useContext(ServerInsertedMetadataContext)\n-\n-  if (setMetadataResolver) {\n-    setMetadataResolver(metadataResolver)\n-  }\n-}\n-\n-export function ServerInsertMetadata({\n-  promise,\n-}: {\n-  promise: Promise<StreamingMetadataResolvedState>\n-}) {\n-  // Apply use() to the metadata promise to suspend the rendering in SSR.\n-  const { metadata } = use(promise)\n-  // Insert metadata into the HTML stream through the `useServerInsertedMetadata`\n-  useServerInsertedMetadata(() => metadata)\n-\n-  return null\n-}"
        },
        {
            "sha": "b0c70100fbc1346ea7eadf3859107850b85509a3",
            "filename": "packages/next/src/lib/metadata/generate/icon-mark.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficon-mark.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficon-mark.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficon-mark.tsx?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -0,0 +1,14 @@\n+'use client'\n+\n+// This is a client component that only renders during SSR,\n+// but will be replaced during streaming with an icon insertion script tag.\n+// We don't want it to be presented anywhere so it's only visible during streaming,\n+// right after the icon meta tags so that browser can pick it up as soon as it's rendered.\n+// Note: we don't just emit the script here because we only need the script if it's not in the head,\n+// and we need it to be hoistable alongside the other metadata but sync scripts are not hoistable.\n+export const IconMark = () => {\n+  if (typeof window !== 'undefined') {\n+    return null\n+  }\n+  return <meta name=\"«nxt-icon»\" />\n+}"
        },
        {
            "sha": "24d2efce4dc0b7529f5cdb9c676bc8312cedd9e9",
            "filename": "packages/next/src/lib/metadata/generate/icons.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficons.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficons.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Ficons.tsx?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -1,5 +1,6 @@\n import type { ResolvedMetadata } from '../types/metadata-interface'\n import type { Icon, IconDescriptor } from '../types/metadata-types'\n+import { IconMark } from './icon-mark'\n \n import { MetaFilter } from './meta'\n \n@@ -27,6 +28,14 @@ export function IconsMetadata({ icons }: { icons: ResolvedMetadata['icons'] }) {\n   const appleList = icons.apple\n   const otherList = icons.other\n \n+  const hasIcon = Boolean(\n+    shortcutList?.length ||\n+      iconList?.length ||\n+      appleList?.length ||\n+      otherList?.length\n+  )\n+  if (!hasIcon) return null\n+\n   return MetaFilter([\n     shortcutList\n       ? shortcutList.map((icon) => IconLink({ rel: 'shortcut icon', icon }))\n@@ -36,5 +45,6 @@ export function IconsMetadata({ icons }: { icons: ResolvedMetadata['icons'] }) {\n       ? appleList.map((icon) => IconLink({ rel: 'apple-touch-icon', icon }))\n       : null,\n     otherList ? otherList.map((icon) => IconDescriptorLink({ icon })) : null,\n+    hasIcon ? <IconMark /> : null,\n   ])\n }"
        },
        {
            "sha": "e724cfda58ae923154389c8eb8a6eb34f3012383",
            "filename": "packages/next/src/lib/metadata/metadata.tsx",
            "status": "modified",
            "additions": 16,
            "deletions": 15,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -38,10 +38,7 @@ import {\n   METADATA_BOUNDARY_NAME,\n   VIEWPORT_BOUNDARY_NAME,\n } from './metadata-constants'\n-import {\n-  AsyncMetadata,\n-  AsyncMetadataOutlet,\n-} from '../../client/components/metadata/async-metadata'\n+import { AsyncMetadataOutlet } from '../../client/components/metadata/async-metadata'\n import { isPostpone } from '../../server/lib/router-utils/is-postpone'\n import { createServerSearchParamsForMetadata } from '../../server/request/search-params'\n import { createServerPathnameForMetadata } from '../../server/request/pathname'\n@@ -211,18 +208,22 @@ export function createMetadataComponents({\n       }\n     }\n   }\n-  async function Metadata() {\n-    const promise = resolveFinalMetadata()\n-    if (serveStreamingMetadata) {\n-      return (\n-        <div hidden>\n-          <Suspense fallback={null}>\n-            <AsyncMetadata promise={promise} />\n-          </Suspense>\n-        </div>\n-      )\n+\n+  function Metadata() {\n+    if (!serveStreamingMetadata) {\n+      return <MetadataResolver />\n     }\n-    const metadataState = await promise\n+    return (\n+      <div hidden>\n+        <Suspense fallback={null}>\n+          <MetadataResolver />\n+        </Suspense>\n+      </div>\n+    )\n+  }\n+\n+  async function MetadataResolver() {\n+    const metadataState = await resolveFinalMetadata()\n     return metadataState.metadata\n   }\n "
        },
        {
            "sha": "acaa896bf9bc624f889465b71cbd9250b28b1cc2",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 19,
            "deletions": 42,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -985,7 +985,7 @@ async function getErrorRSCPayload(\n   const seedData: CacheNodeSeedData = [\n     initialTree[0],\n     <html id=\"__next_error__\">\n-      <head>{metadata}</head>\n+      <head></head>\n       <body>\n         {process.env.NODE_ENV !== 'production' && err ? (\n           <template\n@@ -1043,15 +1043,13 @@ function App<T>({\n   preinitScripts,\n   clientReferenceManifest,\n   ServerInsertedHTMLProvider,\n-  ServerInsertedMetadataProvider,\n   gracefullyDegrade,\n   nonce,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n   preinitScripts: () => void\n   clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedHTMLProvider: React.ComponentType<{ children: JSX.Element }>\n-  ServerInsertedMetadataProvider: React.ComponentType<{ children: JSX.Element }>\n   gracefullyDegrade: boolean\n   nonce?: string\n }): JSX.Element {\n@@ -1091,16 +1089,14 @@ function App<T>({\n         nonce,\n       }}\n     >\n-      <ServerInsertedMetadataProvider>\n-        <ServerInsertedHTMLProvider>\n-          <AppRouter\n-            actionQueue={actionQueue}\n-            globalErrorComponentAndStyles={response.G}\n-            assetPrefix={response.p}\n-            gracefullyDegrade={gracefullyDegrade}\n-          />\n-        </ServerInsertedHTMLProvider>\n-      </ServerInsertedMetadataProvider>\n+      <ServerInsertedHTMLProvider>\n+        <AppRouter\n+          actionQueue={actionQueue}\n+          globalErrorComponentAndStyles={response.G}\n+          assetPrefix={response.p}\n+          gracefullyDegrade={gracefullyDegrade}\n+        />\n+      </ServerInsertedHTMLProvider>\n     </HeadManagerContext.Provider>\n   )\n }\n@@ -1112,15 +1108,13 @@ function ErrorApp<T>({\n   reactServerStream,\n   preinitScripts,\n   clientReferenceManifest,\n-  ServerInsertedMetadataProvider,\n   ServerInsertedHTMLProvider,\n   gracefullyDegrade,\n   nonce,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n   preinitScripts: () => void\n   clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n-  ServerInsertedMetadataProvider: React.ComponentType<{ children: JSX.Element }>\n   ServerInsertedHTMLProvider: React.ComponentType<{ children: JSX.Element }>\n   gracefullyDegrade: boolean\n   nonce?: string\n@@ -1152,16 +1146,14 @@ function ErrorApp<T>({\n   const actionQueue = createMutableActionQueue(initialState, null)\n \n   return (\n-    <ServerInsertedMetadataProvider>\n-      <ServerInsertedHTMLProvider>\n-        <AppRouter\n-          actionQueue={actionQueue}\n-          globalErrorComponentAndStyles={response.G}\n-          assetPrefix={response.p}\n-          gracefullyDegrade={gracefullyDegrade}\n-        />\n-      </ServerInsertedHTMLProvider>\n-    </ServerInsertedMetadataProvider>\n+    <ServerInsertedHTMLProvider>\n+      <AppRouter\n+        actionQueue={actionQueue}\n+        globalErrorComponentAndStyles={response.G}\n+        assetPrefix={response.p}\n+        gracefullyDegrade={gracefullyDegrade}\n+      />\n+    </ServerInsertedHTMLProvider>\n   )\n }\n \n@@ -1781,8 +1773,7 @@ async function renderToStream(\n \n   const { ServerInsertedHTMLProvider, renderServerInsertedHTML } =\n     createServerInsertedHTML()\n-  const { ServerInsertedMetadataProvider, getServerInsertedMetadata } =\n-    createServerInsertedMetadata(nonce)\n+  const getServerInsertedMetadata = createServerInsertedMetadata(nonce)\n \n   const tracingMetadata = getTracedMetadata(\n     getTracer().getTracePropagationData(),\n@@ -1979,7 +1970,6 @@ async function renderToStream(\n             preinitScripts={preinitScripts}\n             clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-            ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n             nonce={nonce}\n             gracefullyDegrade={!!botType}\n           />,\n@@ -2018,7 +2008,6 @@ async function renderToStream(\n         preinitScripts={preinitScripts}\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-        ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n         gracefullyDegrade={!!botType}\n         nonce={nonce}\n       />,\n@@ -2171,7 +2160,6 @@ async function renderToStream(\n           element: (\n             <ErrorApp\n               reactServerStream={errorServerStream}\n-              ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               preinitScripts={errorPreinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n@@ -2276,7 +2264,6 @@ async function spawnDynamicValidationInDev(\n   // that are provided during the actual prerenderToStream.\n   const preinitScripts = () => {}\n   const { ServerInsertedHTMLProvider } = createServerInsertedHTML()\n-  const { ServerInsertedMetadataProvider } = createServerInsertedMetadata(nonce)\n \n   const rootParams = getRootParams(\n     ComponentMod.tree,\n@@ -2443,7 +2430,6 @@ async function spawnDynamicValidationInDev(\n         preinitScripts={preinitScripts}\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-        ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n         gracefullyDegrade={!!botType}\n         nonce={nonce}\n       />,\n@@ -2596,7 +2582,6 @@ async function spawnDynamicValidationInDev(\n               preinitScripts={preinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-              ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n               gracefullyDegrade={!!botType}\n               nonce={nonce}\n             />,\n@@ -2746,8 +2731,7 @@ async function prerenderToStream(\n \n   const { ServerInsertedHTMLProvider, renderServerInsertedHTML } =\n     createServerInsertedHTML()\n-  const { ServerInsertedMetadataProvider, getServerInsertedMetadata } =\n-    createServerInsertedMetadata(nonce)\n+  const getServerInsertedMetadata = createServerInsertedMetadata(nonce)\n \n   const tracingMetadata = getTracedMetadata(\n     getTracer().getTracePropagationData(),\n@@ -3039,7 +3023,6 @@ async function prerenderToStream(\n             preinitScripts={preinitScripts}\n             clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-            ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n             gracefullyDegrade={!!botType}\n             nonce={nonce}\n           />,\n@@ -3200,7 +3183,6 @@ async function prerenderToStream(\n                 preinitScripts={preinitScripts}\n                 clientReferenceManifest={clientReferenceManifest}\n                 ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-                ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n                 gracefullyDegrade={!!botType}\n                 nonce={nonce}\n               />,\n@@ -3333,7 +3315,6 @@ async function prerenderToStream(\n               preinitScripts={() => {}}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-              ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n               gracefullyDegrade={!!botType}\n               nonce={nonce}\n             />,\n@@ -3432,7 +3413,6 @@ async function prerenderToStream(\n           preinitScripts={preinitScripts}\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-          ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n           gracefullyDegrade={!!botType}\n           nonce={nonce}\n         />,\n@@ -3565,7 +3545,6 @@ async function prerenderToStream(\n               preinitScripts={() => {}}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-              ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n               gracefullyDegrade={!!botType}\n               nonce={nonce}\n             />,\n@@ -3645,7 +3624,6 @@ async function prerenderToStream(\n           preinitScripts={preinitScripts}\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-          ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n           gracefullyDegrade={!!botType}\n           nonce={nonce}\n         />,\n@@ -3807,7 +3785,6 @@ async function prerenderToStream(\n         element: (\n           <ErrorApp\n             reactServerStream={errorServerStream}\n-            ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             preinitScripts={errorPreinitScripts}\n             clientReferenceManifest={clientReferenceManifest}"
        },
        {
            "sha": "fa90de61636e3d902bedd93d6491c61274133ce3",
            "filename": "packages/next/src/server/app-render/metadata-insertion/create-server-inserted-metadata.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 43,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fcreate-server-inserted-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fcreate-server-inserted-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fcreate-server-inserted-metadata.tsx?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -1,11 +1,3 @@\n-import React from 'react'\n-import { renderToReadableStream } from 'react-dom/server.edge'\n-import {\n-  ServerInsertedMetadataContext,\n-  type MetadataResolver,\n-} from '../../../shared/lib/server-inserted-metadata.shared-runtime'\n-import { renderToString } from '../render-to-string'\n-\n /**\n  * For chromium based browsers (Chrome, Edge, etc.) and Safari,\n  * icons need to stay under <head> to be picked up by the browser.\n@@ -15,42 +7,14 @@ const REINSERT_ICON_SCRIPT = `\\\n document.querySelectorAll('body link[rel=\"icon\"], body link[rel=\"apple-touch-icon\"]').forEach(el => document.head.appendChild(el))`\n \n export function createServerInsertedMetadata(nonce: string | undefined) {\n-  let metadataResolver: MetadataResolver | null = null\n-  let metadataToFlush: React.ReactNode = null\n-  const setMetadataResolver = (resolver: MetadataResolver): void => {\n-    metadataResolver = resolver\n-  }\n-\n-  return {\n-    ServerInsertedMetadataProvider: ({\n-      children,\n-    }: {\n-      children: React.ReactNode\n-    }) => {\n-      return (\n-        <ServerInsertedMetadataContext.Provider value={setMetadataResolver}>\n-          {children}\n-        </ServerInsertedMetadataContext.Provider>\n-      )\n-    },\n-\n-    async getServerInsertedMetadata(): Promise<string> {\n-      if (!metadataResolver || metadataToFlush) {\n-        return ''\n-      }\n+  let inserted = false\n \n-      metadataToFlush = metadataResolver()\n-      const html = await renderToString({\n-        renderToReadableStream,\n-        element: (\n-          <>\n-            {metadataToFlush}\n-            <script nonce={nonce}>{REINSERT_ICON_SCRIPT}</script>\n-          </>\n-        ),\n-      })\n+  return async function getServerInsertedMetadata(): Promise<string> {\n+    if (inserted) {\n+      return ''\n+    }\n \n-      return html\n-    },\n+    inserted = true\n+    return `<script nonce=\"${nonce}\">${REINSERT_ICON_SCRIPT}</script>`\n   }\n }"
        },
        {
            "sha": "475a921dcd8db12c2908624dae2bd947a0549f39",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -155,7 +155,7 @@ import {\n   getBuiltinRequestContext,\n   type WaitUntil,\n } from './after/builtin-request-context'\n-import { ENCODED_TAGS } from './stream-utils/encodedTags'\n+import { ENCODED_TAGS } from './stream-utils/encoded-tags'\n import { NextRequestHint } from './web/adapter'\n import { getRevalidateReason } from './instrumentation/utils'\n import { RouteKind } from './route-kind'"
        },
        {
            "sha": "00a3e07163c6c411517c89418f71d175a7e67d3b",
            "filename": "packages/next/src/server/route-modules/app-page/vendored/contexts/entrypoints.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fvendored%2Fcontexts%2Fentrypoints.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fvendored%2Fcontexts%2Fentrypoints.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fvendored%2Fcontexts%2Fentrypoints.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -1,6 +1,5 @@\n export * as HeadManagerContext from '../../../../../shared/lib/head-manager-context.shared-runtime'\n export * as ServerInsertedHtml from '../../../../../shared/lib/server-inserted-html.shared-runtime'\n-export * as ServerInsertedMetadata from '../../../../../shared/lib/server-inserted-metadata.shared-runtime'\n export * as AppRouterContext from '../../../../../shared/lib/app-router-context.shared-runtime'\n export * as HooksClientContext from '../../../../../shared/lib/hooks-client-context.shared-runtime'\n export * as RouterContext from '../../../../../shared/lib/router-context.shared-runtime'"
        },
        {
            "sha": "1cb99d1fc205f3da93e45e1399763bd31271a7b8",
            "filename": "packages/next/src/server/stream-utils/encoded-tags.ts",
            "status": "renamed",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fencoded-tags.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fencoded-tags.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fencoded-tags.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -18,4 +18,13 @@ export const ENCODED_TAGS = {\n       60, 47, 98, 111, 100, 121, 62, 60, 47, 104, 116, 109, 108, 62,\n     ]),\n   },\n+  META: {\n+    // Only the match the prefix cause the suffix can be different wether it's xml compatible or not \">\" or \"/>\"\n+    // <meta name=\"«nxt-icon»\"\n+    // This is a special mark that will be replaced by the icon insertion script tag.\n+    ICON_MARK: new Uint8Array([\n+      60, 109, 101, 116, 97, 32, 110, 97, 109, 101, 61, 34, 194, 171, 110, 120,\n+      116, 45, 105, 99, 111, 110, 194, 187, 34,\n+    ]),\n+  },\n } as const",
            "previous_filename": "packages/next/src/server/stream-utils/encodedTags.ts"
        },
        {
            "sha": "748d56e30cbf87f318a3ec85f32e9edfdf10c298",
            "filename": "packages/next/src/server/stream-utils/node-web-streams-helper.ts",
            "status": "modified",
            "additions": 92,
            "deletions": 15,
            "changes": 107,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -2,7 +2,7 @@ import { getTracer } from '../lib/trace/tracer'\n import { AppRenderSpan } from '../lib/trace/constants'\n import { DetachedPromise } from '../../lib/detached-promise'\n import { scheduleImmediate, atLeastOneTask } from '../../lib/scheduler'\n-import { ENCODED_TAGS } from './encodedTags'\n+import { ENCODED_TAGS } from './encoded-tags'\n import {\n   indexOfUint8Array,\n   isEquivalentUint8Arrays,\n@@ -193,6 +193,89 @@ export function renderToInitialFizzStream({\n   )\n }\n \n+function createMetadataTransformStream(\n+  insert: () => Promise<string> | string\n+): TransformStream<Uint8Array, Uint8Array> {\n+  let chunkIndex = -1\n+  let isMarkRemoved = false\n+\n+  return new TransformStream({\n+    async transform(chunk, controller) {\n+      let iconMarkIndex = -1\n+      let closedHeadIndex = -1\n+      chunkIndex++\n+\n+      if (isMarkRemoved) {\n+        controller.enqueue(chunk)\n+        return\n+      }\n+      let iconMarkLength = 0\n+      // Only search for the closed head tag once\n+      if (iconMarkIndex === -1) {\n+        iconMarkIndex = indexOfUint8Array(chunk, ENCODED_TAGS.META.ICON_MARK)\n+        if (iconMarkIndex === -1) {\n+          controller.enqueue(chunk)\n+          return\n+        } else {\n+          // When we found the `<meta name=\"«nxt-icon»\"` tag prefix, we will remove it from the chunk.\n+          // Its close tag could either be `/>` or `>`, checking the next char to ensure we cover both cases.\n+          iconMarkLength = ENCODED_TAGS.META.ICON_MARK.length\n+          // Check if next char is /, this is for xml mode.\n+          if (chunk[iconMarkIndex + iconMarkLength] === 47) {\n+            iconMarkLength += 2\n+          } else {\n+            // The last char is `>`\n+            iconMarkLength++\n+          }\n+        }\n+      }\n+\n+      // Check if icon mark is inside <head> tag in the first chunk.\n+      if (chunkIndex === 0) {\n+        closedHeadIndex = indexOfUint8Array(chunk, ENCODED_TAGS.CLOSED.HEAD)\n+        // The mark icon is located in the 1st chunk before the head tag.\n+        // We do not need to insert the script tag in this case because it's in the head.\n+        // Just remove the icon mark from the chunk.\n+        if (iconMarkIndex < closedHeadIndex && iconMarkIndex !== -1) {\n+          const replaced = new Uint8Array(chunk.length - iconMarkLength)\n+\n+          // Remove the icon mark from the chunk.\n+          replaced.set(chunk.subarray(0, iconMarkIndex))\n+          replaced.set(\n+            chunk.subarray(iconMarkIndex + iconMarkLength),\n+            iconMarkIndex\n+          )\n+          chunk = replaced\n+          isMarkRemoved = true\n+        }\n+      } else {\n+        // When it's appeared in the following chunks, we'll need to\n+        // remove the mark and then insert the script tag at that position.\n+        const insertion = await insert()\n+        const encodedInsertion = encoder.encode(insertion)\n+        const insertionLength = encodedInsertion.length\n+        // Replace the icon mark with the hoist script or empty string.\n+        const replaced = new Uint8Array(\n+          chunk.length - iconMarkLength + insertionLength\n+        )\n+        // Set the first part of the chunk, before the icon mark.\n+        replaced.set(chunk.subarray(0, iconMarkIndex))\n+        // Set the insertion after the icon mark.\n+        replaced.set(encodedInsertion, iconMarkIndex)\n+\n+        // Set the rest of the chunk after the icon mark.\n+        replaced.set(\n+          chunk.subarray(iconMarkIndex + iconMarkLength),\n+          iconMarkIndex + insertionLength\n+        )\n+        chunk = replaced\n+        isMarkRemoved = true\n+      }\n+      controller.enqueue(chunk)\n+    },\n+  })\n+}\n+\n function createHeadInsertionTransformStream(\n   insert: () => Promise<string>\n ): TransformStream<Uint8Array, Uint8Array> {\n@@ -564,8 +647,8 @@ export async function continueFizzStream(\n     // Buffer everything to avoid flushing too frequently\n     createBufferedTransformStream(),\n \n-    // Insert generated metadata\n-    createHeadInsertionTransformStream(getServerInsertedMetadata),\n+    // Transform metadata\n+    createMetadataTransformStream(getServerInsertedMetadata),\n \n     // Insert suffix content\n     suffixUnclosed != null && suffixUnclosed.length > 0\n@@ -607,10 +690,8 @@ export async function continueDynamicPrerender(\n       .pipeThrough(createStripDocumentClosingTagsTransform())\n       // Insert generated tags to head\n       .pipeThrough(createHeadInsertionTransformStream(getServerInsertedHTML))\n-      // Insert generated metadata\n-      .pipeThrough(\n-        createHeadInsertionTransformStream(getServerInsertedMetadata)\n-      )\n+      // Transform metadata\n+      .pipeThrough(createMetadataTransformStream(getServerInsertedMetadata))\n   )\n }\n \n@@ -634,10 +715,8 @@ export async function continueStaticPrerender(\n       .pipeThrough(createBufferedTransformStream())\n       // Insert generated tags to head\n       .pipeThrough(createHeadInsertionTransformStream(getServerInsertedHTML))\n-      // Insert generated metadata to head\n-      .pipeThrough(\n-        createHeadInsertionTransformStream(getServerInsertedMetadata)\n-      )\n+      // Transform metadata\n+      .pipeThrough(createMetadataTransformStream(getServerInsertedMetadata))\n       // Insert the inlined data (Flight data, form state, etc.) stream into the HTML\n       .pipeThrough(createMergedTransformStream(inlinedDataStream))\n       // Close tags should always be deferred to the end\n@@ -665,10 +744,8 @@ export async function continueDynamicHTMLResume(\n       .pipeThrough(createBufferedTransformStream())\n       // Insert generated tags to head\n       .pipeThrough(createHeadInsertionTransformStream(getServerInsertedHTML))\n-      // Insert generated metadata to body\n-      .pipeThrough(\n-        createHeadInsertionTransformStream(getServerInsertedMetadata)\n-      )\n+      // Transform metadata\n+      .pipeThrough(createMetadataTransformStream(getServerInsertedMetadata))\n       // Insert the inlined data (Flight data, form state, etc.) stream into the HTML\n       .pipeThrough(createMergedTransformStream(inlinedDataStream))\n       // Close tags should always be deferred to the end"
        },
        {
            "sha": "3ad44c908f22fa7f86d8e413510b1165e3c766a3",
            "filename": "packages/next/src/shared/lib/server-inserted-metadata.shared-runtime.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/286eefe64e334b8a965f2bd91a95552087574ace/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fserver-inserted-metadata.shared-runtime.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/286eefe64e334b8a965f2bd91a95552087574ace/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fserver-inserted-metadata.shared-runtime.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fserver-inserted-metadata.shared-runtime.ts?ref=286eefe64e334b8a965f2bd91a95552087574ace",
            "patch": "@@ -1,10 +0,0 @@\n-'use client'\n-\n-import type React from 'react'\n-import { createContext } from 'react'\n-\n-export type MetadataResolver = () => React.ReactNode\n-type MetadataResolverSetter = (m: MetadataResolver) => void\n-\n-export const ServerInsertedMetadataContext =\n-  createContext<MetadataResolverSetter | null>(null)"
        },
        {
            "sha": "db3e99a661651aa64fd03fcacd098b4e61537f4c",
            "filename": "test/e2e/app-dir/app-css/index.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fapp-css%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fapp-css%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-css%2Findex.test.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -491,6 +491,12 @@ describe('app dir - css', () => {\n \n             const matches = initialHtml\n               .match(/\\/_next\\/static\\/css\\/.+?\\.css/g)\n+              // The same css chunk could be split into 2 RSC script\n+              // normalize \"/_next/static/css/app/\\\"])</script><script>self.__next_f.push([1,\\\"not-found.css\"\n+              // to \"/_next/static/css/app/not-found.css\"\n+              .map((href) =>\n+                href.replace('\"])</script><script>self.__next_f.push([1,\"', '')\n+              )\n               .sort()\n \n             // Heavy on testing React implementation details."
        },
        {
            "sha": "8f6459c0ddacabf0fbc0cb2c663e42f22dbb1aad",
            "filename": "test/e2e/app-dir/metadata-icons/metadata-icons.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -44,6 +44,27 @@ describe('app-dir - metadata-icons', () => {\n     })\n   })\n \n+  it('should not contain icon insertion script when metadata is rendered in head', async () => {\n+    const iconInsertionScript = `document.querySelectorAll('body link[rel=\"icon\"], body link[rel=\"apple-touch-icon\"]').forEach(el => document.head.appendChild(el))`\n+\n+    const suspendedHtml = await next.render('/custom-icon')\n+    expect(suspendedHtml).toContain(iconInsertionScript)\n+  })\n+\n+  it('should not contain icon replacement mark in html or after hydration', async () => {\n+    const html = await next.render('/custom-icon')\n+    expect(html).not.toContain('<meta name=\"«nxt-icon»\" content=\"\"/>')\n+    expect(html).not.toContain('«nxt-icon»')\n+\n+    const browser = await next.browser('/custom-icon')\n+    const metaTags = await browser.elementsByCss('meta')\n+    // none of them has [name=\"«nxt-icon»\"]\n+    const names = await Promise.all(\n+      metaTags.map((el) => el.getAttribute('name'))\n+    )\n+    expect(names).not.toContain('«nxt-icon»')\n+  })\n+\n   it('should re-insert the apple icons into the head after navigation', async () => {\n     const browser = await next.browser('/custom-icon')\n     await browser.elementByCss('#custom-icon-sub-link').click()"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/metadata-icons/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fnext.config.js?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "7e74651ef555be256b557d4bfe2c18bb16e6658d",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/metadata-streaming-parallel-routes.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -15,7 +15,9 @@ describe('app-dir - metadata-streaming', () => {\n \n     const $ = await next.render$('/parallel-routes')\n     expect($('title').length).toBe(1)\n-    expect($('head title').text()).toBe('parallel title')\n+    // We can't ensure if it's inserted into  head or body since it's a race condition,\n+    // where sometimes the metadata can be suspended.\n+    expect($('title').text()).toBe('parallel title')\n \n     // validate behavior remains the same on client navigations\n     await browser.elementByCss('[href=\"/parallel-routes/test-page\"]').click()"
        },
        {
            "sha": "00922d5c52f08d3b1775f4ed2e14e375f509c421",
            "filename": "test/e2e/app-dir/metadata-streaming/metadata-streaming.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming.test.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -157,8 +157,10 @@ describe('app-dir - metadata-streaming', () => {\n   describe('static', () => {\n     it('should render static metadata in the head', async () => {\n       const $ = await next.render$('/static/full')\n+      // We can't ensure if it's inserted into  head or body since it's a race condition,\n+      // where sometimes the metadata can be suspended.\n       expect($('title').length).toBe(1)\n-      expect($('head title').text()).toBe('static page')\n+      expect($('title').text()).toBe('static page')\n     })\n \n     it('should determine dynamic metadata in build and render in the body', async () => {"
        },
        {
            "sha": "ffa57ebc3718ddba2e403e2b6dffc8f7f20ce06e",
            "filename": "test/e2e/app-dir/metadata-suspense/index.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-suspense%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-suspense%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-suspense%2Findex.test.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -10,13 +10,18 @@ describe('app dir - metadata dynamic routes suspense', () => {\n     return\n   }\n \n-  it('should render metadata in head even root layout is wrapped with Suspense', async () => {\n-    const $ = await next.render$('/')\n+  it('should render metadata in head when root layout is wrapped with Suspense for bot requests', async () => {\n+    const $ = await next.render$('/', undefined, {\n+      headers: {\n+        'User-Agent': 'Discordbot/2.0;',\n+      },\n+    })\n     expect($('head title').text()).toBe('My title')\n     expect($('head meta[name=\"application-name\"]').attr('content')).toBe(\n       'suspense-app'\n     )\n \n-    expect($('body meta').length).toBe(0)\n+    // unique title\n+    expect($('title').length).toBe(1)\n   })\n })"
        },
        {
            "sha": "05e56cf6199b30d25ffa05fd40250333fce6fcf1",
            "filename": "test/e2e/app-dir/metadata-suspense/tsconfig.json",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-suspense%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fmetadata-suspense%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-suspense%2Ftsconfig.json?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -1,25 +1,24 @@\n {\n   \"compilerOptions\": {\n+    \"target\": \"ES2017\",\n     \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n     \"allowJs\": true,\n     \"skipLibCheck\": true,\n     \"strict\": false,\n-    \"forceConsistentCasingInFileNames\": true,\n     \"noEmit\": true,\n     \"incremental\": true,\n-    \"esModuleInterop\": true,\n     \"module\": \"esnext\",\n-    \"moduleResolution\": \"bundler\",\n+    \"esModuleInterop\": true,\n+    \"moduleResolution\": \"node\",\n     \"resolveJsonModule\": true,\n     \"isolatedModules\": true,\n     \"jsx\": \"preserve\",\n     \"plugins\": [\n       {\n         \"name\": \"next\"\n       }\n-    ],\n-    \"target\": \"ES2017\"\n+    ]\n   },\n   \"include\": [\"next-env.d.ts\", \".next/types/**/*.ts\", \"**/*.ts\", \"**/*.tsx\"],\n-  \"exclude\": [\"node_modules\"]\n+  \"exclude\": [\"node_modules\", \"**/*.test.ts\", \"**/*.test.tsx\"]\n }"
        },
        {
            "sha": "1de544393891b2a70cc0ab2d4054be8e01981db9",
            "filename": "test/e2e/app-dir/not-found/conflict-route/app/not-found/page.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fnot-found%2Fconflict-route%2Fapp%2Fnot-found%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fnot-found%2Fconflict-route%2Fapp%2Fnot-found%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found%2Fconflict-route%2Fapp%2Fnot-found%2Fpage.js?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -1,3 +1,3 @@\n export default function Page() {\n-  return <h1>I'm still a valid page</h1>\n+  return <h1>I am still a valid page</h1>\n }"
        },
        {
            "sha": "5dae63b970d56ca6c0c78c0d42b365792cb35b58",
            "filename": "test/e2e/app-dir/not-found/conflict-route/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fnot-found%2Fconflict-route%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fapp-dir%2Fnot-found%2Fconflict-route%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnot-found%2Fconflict-route%2Findex.test.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -22,7 +22,7 @@ describe('app dir - not-found - conflict route', () => {\n \n     it('should allow to have a valid /not-found route', async () => {\n       const html = await next.render('/not-found')\n-      expect(html).toContain(\"I'm still a valid page\")\n+      expect(html).toContain('I am still a valid page')\n     })\n   }\n "
        },
        {
            "sha": "ef65c33811cc991ffb4ac54a23651fbe42c7d7dc",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5325afa65adf2497fe78394d66195fb9cbd519cd/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=5325afa65adf2497fe78394d66195fb9cbd519cd",
            "patch": "@@ -169,7 +169,7 @@ describe('opentelemetry', () => {\n                       },\n                       {\n                         attributes: {\n-                          'next.clientComponentLoadCount': 8,\n+                          'next.clientComponentLoadCount': 7,\n                           'next.span_type':\n                             'NextNodeServer.clientComponentLoading',\n                         },"
        }
    ],
    "stats": {
        "total": 416,
        "additions": 223,
        "deletions": 193
    }
}