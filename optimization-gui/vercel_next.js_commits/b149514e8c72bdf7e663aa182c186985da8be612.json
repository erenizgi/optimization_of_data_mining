{
    "author": "acdlite",
    "message": "Add experimental flag for RSC request validation (#80157)\n\nWe're going to expand this to cover all RSC requests, not just segment\nprefetches. To decouple this from clientSegmentCache, I've added a new\nflag to control it. (Although for now, the behavior is still gated\nbehind both flags, until we've made the check more robust.)",
    "sha": "b149514e8c72bdf7e663aa182c186985da8be612",
    "files": [
        {
            "sha": "3fc674f17ca151d0342266ab69f85d38a863af11",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/b149514e8c72bdf7e663aa182c186985da8be612/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b149514e8c72bdf7e663aa182c186985da8be612/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=b149514e8c72bdf7e663aa182c186985da8be612",
            "patch": "@@ -2084,6 +2084,8 @@ export default abstract class Server<\n     // TODO: Consider not using custom request headers at all, and instead fully\n     // encode everything into the search param.\n     if (\n+      !this.minimalMode &&\n+      this.nextConfig.experimental.validateRSCRequestHeaders &&\n       this.isAppSegmentPrefetchEnabled &&\n       getRequestMeta(req, 'segmentPrefetchRSCRequest')\n     ) {\n@@ -3746,11 +3748,17 @@ export default abstract class Server<\n     let page = pathname\n     const bubbleNoFallback =\n       getRequestMeta(ctx.req, 'bubbleNoFallback') ?? false\n-    addRequestMeta(\n-      ctx.req,\n-      'cacheBustingSearchParam',\n-      query[NEXT_RSC_UNION_QUERY]\n-    )\n+\n+    if (\n+      !this.minimalMode &&\n+      this.nextConfig.experimental.validateRSCRequestHeaders\n+    ) {\n+      addRequestMeta(\n+        ctx.req,\n+        'cacheBustingSearchParam',\n+        query[NEXT_RSC_UNION_QUERY]\n+      )\n+    }\n     delete query[NEXT_RSC_UNION_QUERY]\n \n     const options: MatchOptions = {"
        },
        {
            "sha": "b493fcefeaaa6083aaa30c78dfbc1fc06a427714",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b149514e8c72bdf7e663aa182c186985da8be612/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b149514e8c72bdf7e663aa182c186985da8be612/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=b149514e8c72bdf7e663aa182c186985da8be612",
            "patch": "@@ -406,6 +406,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         proxyTimeout: z.number().gte(0).optional(),\n         routerBFCache: z.boolean().optional(),\n         removeUncaughtErrorAndRejectionListeners: z.boolean().optional(),\n+        validateRSCRequestHeaders: z.boolean().optional(),\n         scrollRestoration: z.boolean().optional(),\n         sri: z\n           .object({"
        },
        {
            "sha": "500c153e06d66922751c3bd25ff5d7a9affaedc4",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b149514e8c72bdf7e663aa182c186985da8be612/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b149514e8c72bdf7e663aa182c186985da8be612/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=b149514e8c72bdf7e663aa182c186985da8be612",
            "patch": "@@ -539,6 +539,12 @@ export interface ExperimentalConfig {\n    */\n   removeUncaughtErrorAndRejectionListeners?: boolean\n \n+  /**\n+   * During an RSC request, validates that the request headers match the\n+   * cache-busting search parameter sent by the client.\n+   */\n+  validateRSCRequestHeaders?: boolean\n+\n   serverActions?: {\n     /**\n      * Allows adjusting body parser size limit for server actions.\n@@ -1368,6 +1374,7 @@ export const defaultConfig = {\n     viewTransition: false,\n     routerBFCache: false,\n     removeUncaughtErrorAndRejectionListeners: false,\n+    validateRSCRequestHeaders: false,\n     staleTimes: {\n       dynamic: 0,\n       static: 300,"
        },
        {
            "sha": "a1492c48744fdeda34377b0061807b9235bda6ac",
            "filename": "test/e2e/app-dir/segment-cache/cdn-cache-busting/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b149514e8c72bdf7e663aa182c186985da8be612/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b149514e8c72bdf7e663aa182c186985da8be612/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fcdn-cache-busting%2Fnext.config.js?ref=b149514e8c72bdf7e663aa182c186985da8be612",
            "patch": "@@ -4,6 +4,7 @@\n const nextConfig = {\n   experimental: {\n     clientSegmentCache: true,\n+    validateRSCRequestHeaders: true,\n   },\n }\n "
        }
    ],
    "stats": {
        "total": 27,
        "additions": 22,
        "deletions": 5
    }
}