{
    "author": "mischnic",
    "message": "Turbopack: really fix export collection (#80240)\n\n- For `export default class Foo`, we don't insert a `var __TURBOPACK__default__export__ = Foo` variable because it should be a live binding. So put the correct name/syntax context into `ImportMap.exports`\r\n- The `__TURBOPACK__default__export__` generated by module fragment tree shaking should use the same syntax context as the one generated by `module_item.rs` (which is `SyntaxContext(0)`).",
    "sha": "9e9d13fb4d43fa0cb7bc4f51180678fc5099950c",
    "files": [
        {
            "sha": "92a7f537a338e7924cc9a21b0417f9b0420f71bd",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/imports.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 5,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs?ref=9e9d13fb4d43fa0cb7bc4f51180678fc5099950c",
            "patch": "@@ -643,13 +643,30 @@ impl Visit for Analyzer<'_> {\n \n         self.data.exports.insert(\n             rcstr!(\"default\"),\n-            (\n-                // `EsmModuleItem::code_generation` inserts this variable.\n-                magic_identifier::mangle(\"default export\").into(),\n-                SyntaxContext::empty(),\n-            ),\n+            // Mirror what `EsmModuleItem::code_generation` does, these are live bindings if the\n+            // class/function has an identifier.\n+            match &n.decl {\n+                DefaultDecl::Class(ClassExpr { ident, .. })\n+                | DefaultDecl::Fn(FnExpr { ident, .. }) => ident.as_ref().map_or_else(\n+                    || {\n+                        (\n+                            magic_identifier::mangle(\"default export\").into(),\n+                            SyntaxContext::empty(),\n+                        )\n+                    },\n+                    |ident| (ident.to_id()),\n+                ),\n+                DefaultDecl::TsInterfaceDecl(_) => {\n+                    // not matching, might happen due to eventual consistency\n+                    (\n+                        magic_identifier::mangle(\"default export\").into(),\n+                        SyntaxContext::empty(),\n+                    )\n+                }\n+            },\n         );\n     }\n+\n     fn visit_export_default_expr(&mut self, n: &ExportDefaultExpr) {\n         self.data.has_exports = true;\n "
        },
        {
            "sha": "4bc247a5221e47684878305b36638e21b8e2199c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/graph.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fgraph.rs?ref=9e9d13fb4d43fa0cb7bc4f51180678fc5099950c",
            "patch": "@@ -20,7 +20,7 @@ use swc_core::{\n             PropName, PropOrSpread, Stmt, Str, VarDecl, VarDeclKind, VarDeclarator, op,\n         },\n         atoms::Atom,\n-        utils::{ExprCtx, ExprExt, find_pat_ids, private_ident, quote_ident},\n+        utils::{ExprCtx, ExprExt, find_pat_ids, quote_ident},\n     },\n };\n use turbo_rcstr::RcStr;\n@@ -1007,8 +1007,14 @@ impl DepGraph {\n                             DefaultDecl::TsInterfaceDecl(_) => unreachable!(),\n                         };\n \n+                        // Mirror what `EsmModuleItem::code_generation` does, these are live\n+                        // bindings if the class/function has an identifier.\n                         let default_var = id.unwrap_or_else(|| {\n-                            private_ident!(magic_identifier::mangle(\"default export\"))\n+                            Ident::new(\n+                                magic_identifier::mangle(\"default export\").into(),\n+                                DUMMY_SP,\n+                                Default::default(),\n+                            )\n                         });\n \n                         {\n@@ -1073,8 +1079,13 @@ impl DepGraph {\n                         exports.push((default_var.to_id(), \"default\".into()));\n                     }\n                     ModuleDecl::ExportDefaultExpr(export) => {\n-                        let default_var =\n-                            private_ident!(magic_identifier::mangle(\"default export\"));\n+                        // Mirror what `EsmModuleItem::code_generation` does, these are live\n+                        // bindings if the class/function has an identifier.\n+                        let default_var = Ident::new(\n+                            magic_identifier::mangle(\"default export\").into(),\n+                            DUMMY_SP,\n+                            Default::default(),\n+                        );\n \n                         {\n                             // For"
        },
        {
            "sha": "02baab64b5d75d2f35658b9898486cffced84368",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/tree-shaker/analyzer/amphtml-document/output.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Famphtml-document%2Foutput.md",
            "raw_url": "https://github.com/vercel/next.js/raw/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Famphtml-document%2Foutput.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Famphtml-document%2Foutput.md?ref=9e9d13fb4d43fa0cb7bc4f51180678fc5099950c",
            "patch": "@@ -277,7 +277,7 @@ graph TD\n     N7[\"Items: [ItemId(1, ImportBinding(2))]\"];\n     N8[\"Items: [ItemId(1, ImportBinding(3))]\"];\n     N9[\"Items: [ItemId(1, ImportBinding(4))]\"];\n-    N10[\"Items: [ItemId(2, Normal), ItemId(3, Normal), ItemId(Export((&quot;__TURBOPACK__default__export__&quot;, #5), &quot;default&quot;))]\"];\n+    N10[\"Items: [ItemId(2, Normal), ItemId(3, Normal), ItemId(Export((&quot;__TURBOPACK__default__export__&quot;, #0), &quot;default&quot;))]\"];\n     N4 --> N0;\n     N9 --> N4;\n     N1 --> N0;"
        },
        {
            "sha": "4df805bed6f93fd0bc0596e4b8ae1d74fb4581ca",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/tree-shaker/analyzer/mui-sys/output.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Fmui-sys%2Foutput.md",
            "raw_url": "https://github.com/vercel/next.js/raw/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Fmui-sys%2Foutput.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Fmui-sys%2Foutput.md?ref=9e9d13fb4d43fa0cb7bc4f51180678fc5099950c",
            "patch": "@@ -917,7 +917,7 @@ graph TD\n     N26[\"Items: [ItemId(20, VarDeclarator(0))]\"];\n     N27[\"Items: [ItemId(21, VarDeclarator(0))]\"];\n     N28[\"Items: [ItemId(22, VarDeclarator(0)), ItemId(Export((&quot;gridArea&quot;, #2), &quot;gridArea&quot;))]\"];\n-    N29[\"Items: [ItemId(23, VarDeclarator(0)), ItemId(24, Normal), ItemId(Export((&quot;__TURBOPACK__default__export__&quot;, #12), &quot;default&quot;))]\"];\n+    N29[\"Items: [ItemId(23, VarDeclarator(0)), ItemId(24, Normal), ItemId(Export((&quot;__TURBOPACK__default__export__&quot;, #0), &quot;default&quot;))]\"];\n     N30[\"Items: [ItemId(Export((&quot;gridAutoColumns&quot;, #2), &quot;gridAutoColumns&quot;))]\"];\n     N31[\"Items: [ItemId(Export((&quot;gridAutoFlow&quot;, #2), &quot;gridAutoFlow&quot;))]\"];\n     N32[\"Items: [ItemId(Export((&quot;gridAutoRows&quot;, #2), &quot;gridAutoRows&quot;))]\"];"
        },
        {
            "sha": "612659143e07ef221e38ac33d9a5fde2b52275e9",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/tree-shaker/analyzer/node-fetch/output.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Fnode-fetch%2Foutput.md",
            "raw_url": "https://github.com/vercel/next.js/raw/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Fnode-fetch%2Foutput.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Fnode-fetch%2Foutput.md?ref=9e9d13fb4d43fa0cb7bc4f51180678fc5099950c",
            "patch": "@@ -121,7 +121,7 @@ graph TD\n graph TD\n     N0[\"Items: [ItemId(0, ImportOfModule)]\"];\n     N1[\"Items: [ItemId(0, ImportBinding(0))]\"];\n-    N2[\"Items: [ItemId(1, VarDeclarator(0)), ItemId(2, Normal), ItemId(3, Normal), ItemId(Export((&quot;__TURBOPACK__default__export__&quot;, #4), &quot;default&quot;))]\"];\n+    N2[\"Items: [ItemId(1, VarDeclarator(0)), ItemId(2, Normal), ItemId(3, Normal), ItemId(Export((&quot;__TURBOPACK__default__export__&quot;, #0), &quot;default&quot;))]\"];\n     N1 --> N0;\n ```\n # Entrypoints"
        },
        {
            "sha": "63537dd38eadfd92f5119d7e8f541ee65feedbb2",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/tree-shaker/analyzer/template-pages/output.md",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Ftemplate-pages%2Foutput.md",
            "raw_url": "https://github.com/vercel/next.js/raw/9e9d13fb4d43fa0cb7bc4f51180678fc5099950c/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Ftemplate-pages%2Foutput.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Ftree-shaker%2Fanalyzer%2Ftemplate-pages%2Foutput.md?ref=9e9d13fb4d43fa0cb7bc4f51180678fc5099950c",
            "patch": "@@ -687,7 +687,7 @@ graph TD\n     N21[\"Items: [ItemId(15, VarDeclarator(0))]\"];\n     N22[\"Items: [ItemId(16, VarDeclarator(0))]\"];\n     N23[\"Items: [ItemId(17, VarDeclarator(0)), ItemId(Export((&quot;routeModule&quot;, #2), &quot;routeModule&quot;))]\"];\n-    N24[\"Items: [ItemId(Export((&quot;__TURBOPACK__default__export__&quot;, #3), &quot;default&quot;))]\"];\n+    N24[\"Items: [ItemId(Export((&quot;__TURBOPACK__default__export__&quot;, #0), &quot;default&quot;))]\"];\n     N25[\"Items: [ItemId(Export((&quot;config&quot;, #2), &quot;config&quot;))]\"];\n     N26[\"Items: [ItemId(Export((&quot;getServerSideProps&quot;, #2), &quot;getServerSideProps&quot;))]\"];\n     N27[\"Items: [ItemId(Export((&quot;getStaticPaths&quot;, #2), &quot;getStaticPaths&quot;))]\"];"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 41,
        "deletions": 13
    }
}