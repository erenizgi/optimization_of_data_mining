{
    "author": "eps1lon",
    "message": "[node-webstreams] Exhaustive React aliases in App Router (#81040)\n\nThe previous logic relied heavily on default-fallthroughs which makes it hard to follow what alias we end up using in which bundle.\r\n\r\nThe new logic has more duplication which is intended so that you think about each entrypoint. With the new factoring, some bad combinations are more obvious (e.g. `react-dom/server` in product code not using the vendored version or `react-server-dom-webpack/server` not throwing in a Client environment). Compare changing aliases to .node in https://github.com/vercel/next.js/pull/81048/ (based on this refactor) vs changing it without the refactor: https://github.com/vercel/next.js/pull/80941\r\n\r\nFixing the bad combinations is not part of this work. We probably need to finish `react-markup` first before we get more strict with `react-dom/server` usage in Server code.",
    "sha": "343c83807fd53a2052fce6f7ddccf8461edee8b8",
    "files": [
        {
            "sha": "e8e0ea1bcc47583fcd3a060a9f09ce1956394a91",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -147,7 +147,7 @@ pub async fn get_edge_resolve_options_context(\n             .map(RcStr::from),\n     );\n \n-    if ty.supports_react_server() {\n+    if ty.should_use_react_server_condition() {\n         custom_conditions.push(rcstr!(\"react-server\"));\n     };\n "
        },
        {
            "sha": "b33ae4d1b501e3e62ac26efdc107b719193a344a",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 182,
            "deletions": 79,
            "changes": 261,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -723,7 +723,9 @@ async fn get_react_client_package(next_config: Vc<NextConfig>) -> Result<&'stati\n     Ok(react_client_package)\n }\n \n-async fn rsc_aliases(\n+// Use createVendoredReactAliases in file:///./../../../packages/next/src/build/create-compiler-aliases.ts\n+// as the source of truth.\n+async fn apply_vendored_react_aliases_server(\n     import_map: &mut ImportMap,\n     project_path: FileSystemPath,\n     ty: ServerContextType,\n@@ -739,93 +741,194 @@ async fn rsc_aliases(\n     } else {\n         \"\"\n     };\n-    let react_client_package = get_react_client_package(next_config).await?;\n+    let react_condition = if ty.should_use_react_server_condition() {\n+        \"server\"\n+    } else {\n+        \"client\"\n+    };\n \n-    let mut alias = FxIndexMap::default();\n-    if matches!(\n-        ty,\n-        ServerContextType::AppSSR { .. }\n-            | ServerContextType::AppRSC { .. }\n-            | ServerContextType::AppRoute { .. }\n-    ) {\n-        alias.extend(fxindexmap! {\n-            \"react\" => format!(\"next/dist/compiled/react{react_channel}\"),\n-            \"react-dom\" => format!(\"next/dist/compiled/react-dom{react_channel}\"),\n-            \"react/jsx-runtime\" => format!(\"next/dist/compiled/react{react_channel}/jsx-runtime\"),\n-            \"react/jsx-dev-runtime\" => format!(\"next/dist/compiled/react{react_channel}/jsx-dev-runtime\"),\n-            \"react/compiler-runtime\" => format!(\"next/dist/compiled/react{react_channel}/compiler-runtime\"),\n-            \"react-dom/client\" => format!(\"next/dist/compiled/react-dom{react_channel}/{react_client_package}\"),\n-            \"react-dom/static\" => format!(\"next/dist/compiled/react-dom{react_channel}/static\"),\n-            \"react-dom/static.edge\" => format!(\"next/dist/compiled/react-dom{react_channel}/static.edge\"),\n-            \"react-dom/static.browser\" => format!(\"next/dist/compiled/react-dom{react_channel}/static.browser\"),\n-            \"react-dom/server\" => format!(\"next/dist/compiled/react-dom{react_channel}/server\"),\n-            \"react-dom/server.edge\" => format!(\"next/dist/compiled/react-dom{react_channel}/server.edge\"),\n-            \"react-dom/server.browser\" => format!(\"next/dist/compiled/react-dom{react_channel}/server.browser\"),\n+    // ✅ Correct alias\n+    // ❌ Incorrect alias i.e. importing this entrypoint should throw an error.\n+    // ❔ Alias that may produce correct code in certain conditions.Keep until react-markup is\n+    // available.\n+\n+    let mut react_alias = FxIndexMap::default();\n+    if runtime == NextRuntime::NodeJs && react_condition == \"client\" {\n+        react_alias.extend(fxindexmap! {\n+            // file:///./../../../packages/next/src/compiled/react/package.json\n+            \"react\" =>                                  /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react\"),\n+            \"react/compiler-runtime\" =>                 /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-compiler-runtime\"),\n+            \"react/jsx-dev-runtime\" =>                  /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-jsx-dev-runtime\"),\n+            \"react/jsx-runtime\" =>                      /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-jsx-runtime\"),\n+            // file:///./../../../packages/next/src/compiled/react-dom/package.json\n+            \"react-dom\" =>                              /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-dom\"),\n+            \"react-dom/client\" =>                       /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/client\"),\n+            \"react-dom/server\" =>                       /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.node\"),\n+            \"react-dom/server.browser\" =>               /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.browser\"),\n+            // TODO: Use build without legacy APIs\n+            \"react-dom/server.edge\" =>                  /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.edge\"),\n+            \"react-dom/static\" =>                       /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.node\"),\n+            \"react-dom/static.browser\" =>               /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.browser\"),\n+            \"react-dom/static.edge\" =>                  /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.edge\"),\n+            // file:///./../../../packages/next/src/compiled/react-server-dom-webpack/package.json\n+            \"react-server-dom-webpack/client\" =>        /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-webpack/client.edge\" =>   /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-server-dom-turbopack-client-edge\"),\n+            \"react-server-dom-webpack/server.edge\" =>   /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.edge\"),\n+            \"react-server-dom-webpack/server.node\" =>   /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.node\"),\n+            \"react-server-dom-webpack/static.edge\" =>   /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/static.edge\"),\n+            \"react-server-dom-turbopack/client\" =>      /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-turbopack/client.edge\" => /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-server-dom-turbopack-client-edge\"),\n+            \"react-server-dom-turbopack/server.edge\" => /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.edge\"),\n+            \"react-server-dom-turbopack/server.node\" => /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.node\"),\n+            \"react-server-dom-turbopack/static.edge\" => /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/static.edge\"),\n+        })\n+    } else if runtime == NextRuntime::NodeJs && react_condition == \"server\" {\n+        react_alias.extend(fxindexmap! {\n+            // file:///./../../../packages/next/src/compiled/react/package.json\n+            \"react\" =>                                  /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react\"),\n+            \"react/compiler-runtime\" =>                 /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-compiler-runtime\"),\n+            \"react/jsx-dev-runtime\" =>                  /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime\"),\n+            \"react/jsx-runtime\" =>                      /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-runtime\"),\n+            // file:///./../../../packages/next/src/compiled/react-dom/package.json\n+            \"react-dom\" =>                              /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-dom\"),\n+            \"react-dom/client\" =>                       /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/client\"),\n+            \"react-dom/server\" =>                       /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.node\"),\n+            \"react-dom/server.browser\" =>               /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.browser\"),\n+            // TODO: Use build without legacy APIs\n+            \"react-dom/server.edge\" =>                  /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.edge\"),\n+            \"react-dom/static\" =>                       /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.node\"),\n+            \"react-dom/static.browser\" =>               /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.browser\"),\n+            \"react-dom/static.edge\" =>                  /* ❔ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.edge\"),\n+            // file:///./../../../packages/next/src/compiled/react-server-dom-webpack/package.json\n+            \"react-server-dom-webpack/client\" =>        /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-webpack/client.edge\" =>   /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-webpack/server.edge\" =>   /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge\"),\n+            \"react-server-dom-webpack/server.node\" =>   /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-node\"),\n+            \"react-server-dom-webpack/static.edge\" =>   /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-static-edge\"),\n+            \"react-server-dom-turbopack/client\" =>      /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-turbopack/client.edge\" => /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-turbopack/server.edge\" => /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge\"),\n+            \"react-server-dom-turbopack/server.node\" => /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-node\"),\n+            \"react-server-dom-turbopack/static.edge\" => /* ✅ */ format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-static-edge\"),\n+\n+            // Needed to make `react-dom/server` work.\n+            // TODO: really?\n+                \"next/dist/compiled/react\" => format!(\"next/dist/compiled/react/index.js\"),\n+        })\n+    } else if runtime == NextRuntime::Edge && react_condition == \"client\" {\n+        react_alias.extend(fxindexmap! {\n+            // file:///./../../../packages/next/src/compiled/react/package.json\n+            \"react\" =>                                  /* ✅ */ format!(\"next/dist/compiled/react{react_channel}\"),\n+            \"react/compiler-runtime\" =>                 /* ✅ */ format!(\"next/dist/compiled/react{react_channel}/compiler-runtime\"),\n+            \"react/jsx-dev-runtime\" =>                  /* ✅ */ format!(\"next/dist/compiled/react{react_channel}/jsx-dev-runtime\"),\n+            \"react/jsx-runtime\" =>                      /* ✅ */ format!(\"next/dist/compiled/react{react_channel}/jsx-runtime\"),\n+            // file:///./../../../packages/next/src/compiled/react-dom/package.json\n+            \"react-dom\" =>                              /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}\"),\n+            \"react-dom/client\" =>                       /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}/client\"),\n+            \"react-dom/server\" =>                       /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.edge\"),\n+            \"react-dom/server.browser\" =>               /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.browser\"),\n+            // TODO: Use build without legacy APIs\n+            \"react-dom/server.edge\" =>                  /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.edge\"),\n+            \"react-dom/static\" =>                       /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.edge\"),\n+            \"react-dom/static.browser\" =>               /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.browser\"),\n+            \"react-dom/static.edge\" =>                  /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.edge\"),\n+            // file:///./../../../packages/next/src/compiled/react-server-dom-webpack/package.json\n+            \"react-server-dom-webpack/client\" =>        /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-webpack/client.edge\" =>   /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-webpack/server.edge\" =>   /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.edge\"),\n+            \"react-server-dom-webpack/server.node\" =>   /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.node\"),\n+            \"react-server-dom-webpack/static.edge\" =>   /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/static.edge\"),\n+            \"react-server-dom-turbopack/client\" =>      /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-turbopack/client.edge\" => /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-turbopack/server.edge\" => /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.edge\"),\n+            \"react-server-dom-turbopack/server.node\" => /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.node\"),\n+            \"react-server-dom-turbopack/static.edge\" => /* ❌ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/static.edge\"),\n+        })\n+    } else if runtime == NextRuntime::Edge && react_condition == \"server\" {\n+        react_alias.extend(fxindexmap! {\n+            // file:///./../../../packages/next/src/compiled/react/package.json\n+            \"react\" =>                                  /* ✅ */ format!(\"next/dist/compiled/react{react_channel}/react.react-server\"),\n+            \"react/compiler-runtime\" =>                 /* ❌ */ format!(\"next/dist/compiled/react{react_channel}/compiler-runtime\"),\n+            \"react/jsx-dev-runtime\" =>                  /* ✅ */ format!(\"next/dist/compiled/react{react_channel}/jsx-dev-runtime.react-server\"),\n+            \"react/jsx-runtime\" =>                      /* ✅ */ format!(\"next/dist/compiled/react{react_channel}/jsx-runtime.react-server\"),\n+            // file:///./../../../packages/next/src/compiled/react-dom/package.json\n+            \"react-dom\" =>                              /* ✅ */ format!(\"next/dist/compiled/react-dom{react_channel}/react-dom.react-server\"),\n+            \"react-dom/client\" =>                       /* ❌ */ format!(\"next/dist/compiled/react-dom{react_channel}/client\"),\n+            \"react-dom/server\" =>                       /* ❌ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.edge\"),\n+            \"react-dom/server.browser\" =>               /* ❌ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.browser\"),\n+            // TODO: Use build without legacy APIs\n+            \"react-dom/server.edge\" =>                  /* ❌ */ format!(\"next/dist/compiled/react-dom{react_channel}/server.edge\"),\n+            \"react-dom/static\" =>                       /* ❌ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.edge\"),\n+            \"react-dom/static.browser\" =>               /* ❌ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.browser\"),\n+            \"react-dom/static.edge\" =>                  /* ❌ */ format!(\"next/dist/compiled/react-dom{react_channel}/static.edge\"),\n+            // file:///./../../../packages/next/src/compiled/react-server-dom-webpack/package.json\n+            \"react-server-dom-webpack/client\" =>        /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-webpack/client.edge\" =>   /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-webpack/server.edge\" =>   /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.edge\"),\n+            \"react-server-dom-webpack/server.node\" =>   /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.node\"),\n+            \"react-server-dom-webpack/static.edge\" =>   /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/static.edge\"),\n+            \"react-server-dom-turbopack/client\" =>      /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-turbopack/client.edge\" => /* ❔ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n+            \"react-server-dom-turbopack/server.edge\" => /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.edge\"),\n+            \"react-server-dom-turbopack/server.node\" => /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.node\"),\n+            \"react-server-dom-turbopack/static.edge\" => /* ✅ */ format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/static.edge\"),\n+        });\n+\n+        react_alias.extend(fxindexmap! {\n+            // This should just be `next/dist/compiled/react${react_channel}` but how to Rust.\n+            \"next/dist/compiled/react\"                               => react_alias[\"react\"].clone(),\n+            \"next/dist/compiled/react-experimental\"                  => react_alias[\"react\"].clone(),\n+            \"next/dist/compiled/react/compiler-runtime\"              => react_alias[\"react/compiler-runtime\"].clone(),\n+            \"next/dist/compiled/react-experimental/compiler-runtime\" => react_alias[\"react/compiler-runtime\"].clone(),\n+            \"next/dist/compiled/react/jsx-dev-runtime\"               => react_alias[\"react/jsx-dev-runtime\"].clone(),\n+            \"next/dist/compiled/react-experimental/jsx-dev-runtime\"  => react_alias[\"react/jsx-dev-runtime\"].clone(),\n+            \"next/dist/compiled/react/jsx-runtime\"                   => react_alias[\"react/jsx-runtime\"].clone(),\n+            \"next/dist/compiled/react-experimental/jsx-runtime\"      => react_alias[\"react/jsx-runtime\"].clone(),\n+            \"next/dist/compiled/react-dom\"                           => react_alias[\"react-dom\"].clone(),\n+            \"next/dist/compiled/react-dom-experimental\"              => react_alias[\"react-dom\"].clone(),\n         });\n     }\n-    alias.extend(fxindexmap! {\n-        \"react-server-dom-webpack/client\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client\"),\n-        \"react-server-dom-webpack/client.edge\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n-        \"react-server-dom-webpack/server.edge\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.edge\"),\n-        \"react-server-dom-webpack/server.node\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.node\"),\n-        \"react-server-dom-webpack/static.edge\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/static.edge\"),\n-        \"react-server-dom-turbopack/client\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client\"),\n-        \"react-server-dom-turbopack/client.edge\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/client.edge\"),\n-        \"react-server-dom-turbopack/server.edge\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.edge\"),\n-        \"react-server-dom-turbopack/server.node\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/server.node\"),\n-        \"react-server-dom-turbopack/static.edge\" => format!(\"next/dist/compiled/react-server-dom-turbopack{react_channel}/static.edge\"),\n+\n+    let react_client_package = get_react_client_package(next_config).await?;\n+    react_alias.extend(fxindexmap! {\n+        \"react-dom/client\" => format!(\"next/dist/compiled/react-dom{react_channel}/{react_client_package}\"),\n     });\n \n-    if runtime == NextRuntime::NodeJs {\n-        if matches!(ty, ServerContextType::AppSSR { .. }) {\n-            alias.extend(fxindexmap! {\n-                    \"react/jsx-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-jsx-runtime\"),\n-                    \"react/jsx-dev-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-jsx-dev-runtime\"),\n-                    \"react/compiler-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-compiler-runtime\"),\n-                    \"react\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react\"),\n-                    \"react-dom\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-dom\"),\n-                    \"react-server-dom-webpack/client.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-server-dom-turbopack-client-edge\"),\n-                    \"react-server-dom-turbopack/client.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/ssr/react-server-dom-turbopack-client-edge\"),\n-                });\n-        } else if ty.supports_react_server() {\n-            alias.extend(fxindexmap! {\n-                \"react/jsx-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-runtime\"),\n-                \"react/jsx-dev-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime\"),\n-                \"react/compiler-runtime\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-compiler-runtime\"),\n-                \"react\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react\"),\n-                \"react-dom\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-dom\"),\n-                \"react-server-dom-webpack/server.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge\"),\n-                \"react-server-dom-webpack/server.node\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-node\"),\n-                \"react-server-dom-webpack/static.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-static-edge\"),\n-                \"react-server-dom-turbopack/server.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-edge\"),\n-                \"react-server-dom-turbopack/server.node\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-server-node\"),\n-                \"react-server-dom-turbopack/static.edge\" => format!(\"next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-turbopack-static-edge\"),\n-                \"next/navigation\" => format!(\"next/dist/api/navigation.react-server\"),\n-\n-                // Needed to make `react-dom/server` work.\n-                \"next/dist/compiled/react\" => format!(\"next/dist/compiled/react/index.js\"),\n-            });\n-        }\n+    let mut alias = react_alias;\n+    if react_condition == \"server\" {\n+        // This is used in the server runtime to import React Server Components.\n+        alias.extend(fxindexmap! {\n+            \"next/navigation\" => format!(\"next/dist/api/navigation.react-server\"),\n+        });\n     }\n \n-    if runtime == NextRuntime::Edge && ty.supports_react_server() {\n+    insert_exact_alias_map(import_map, project_path, alias);\n+\n+    Ok(())\n+}\n+\n+async fn rsc_aliases(\n+    import_map: &mut ImportMap,\n+    project_path: FileSystemPath,\n+    ty: ServerContextType,\n+    runtime: NextRuntime,\n+    next_config: Vc<NextConfig>,\n+) -> Result<()> {\n+    apply_vendored_react_aliases_server(\n+        import_map,\n+        project_path.clone(),\n+        ty.clone(),\n+        runtime,\n+        next_config,\n+    )\n+    .await?;\n+\n+    let mut alias = FxIndexMap::default();\n+    if ty.should_use_react_server_condition() {\n+        // This is used in the server runtime to import React Server Components.\n         alias.extend(fxindexmap! {\n-            \"react\" => format!(\"next/dist/compiled/react{react_channel}/react.react-server\"),\n-            \"next/dist/compiled/react\" => format!(\"next/dist/compiled/react{react_channel}/react.react-server\"),\n-            \"next/dist/compiled/react-experimental\" =>  format!(\"next/dist/compiled/react-experimental/react.react-server\"),\n-            \"react/jsx-runtime\" => format!(\"next/dist/compiled/react{react_channel}/jsx-runtime.react-server\"),\n-            \"react/compiler-runtime\" => format!(\"next/dist/compiled/react{react_channel}/compiler-runtime\"),\n-            \"next/dist/compiled/react/jsx-runtime\" => format!(\"next/dist/compiled/react{react_channel}/jsx-runtime.react-server\"),\n-            \"next/dist/compiled/react-experimental/jsx-runtime\" => format!(\"next/dist/compiled/react-experimental/jsx-runtime.react-server\"),\n-            \"next/dist/compiled/react/compiler-runtime\" => format!(\"next/dist/compiled/react{react_channel}/compiler-runtime\"),\n-            \"react/jsx-dev-runtime\" => format!(\"next/dist/compiled/react{react_channel}/jsx-dev-runtime.react-server\"),\n-            \"next/dist/compiled/react/jsx-dev-runtime\" => format!(\"next/dist/compiled/react{react_channel}/jsx-dev-runtime.react-server\"),\n-            \"next/dist/compiled/react-experimental/jsx-dev-runtime\" => format!(\"next/dist/compiled/react-experimental/jsx-dev-runtime.react-server\"),\n-            \"react-dom\" => format!(\"next/dist/compiled/react-dom{react_channel}/react-dom.react-server\"),\n-            \"next/dist/compiled/react-dom\" => format!(\"next/dist/compiled/react-dom{react_channel}/react-dom.react-server\"),\n-            \"next/dist/compiled/react-dom-experimental\" => format!(\"next/dist/compiled/react-dom-experimental/react-dom.react-server\"),\n             \"next/navigation\" => format!(\"next/dist/api/navigation.react-server\"),\n-        })\n+        });\n     }\n \n     insert_exact_alias_map(import_map, project_path.clone(), alias);"
        },
        {
            "sha": "873b8e43c7cdb71a22c647b9f10757f16f52a1a0",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -109,7 +109,7 @@ pub enum ServerContextType {\n }\n \n impl ServerContextType {\n-    pub fn supports_react_server(&self) -> bool {\n+    pub fn should_use_react_server_condition(&self) -> bool {\n         matches!(\n             self,\n             ServerContextType::AppRSC { .. }\n@@ -208,7 +208,7 @@ pub async fn get_server_resolve_options_context(\n             .map(RcStr::from),\n     );\n \n-    if ty.supports_react_server() {\n+    if ty.should_use_react_server_condition() {\n         custom_conditions.push(rcstr!(\"react-server\"));\n     };\n "
        },
        {
            "sha": "6f21155e1a37fb4a1de405af56fbcf46bac5fb74",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -714,5 +714,6 @@\n   \"713\": \"Unexpected error during process lookup\",\n   \"714\": \"cannot run loadNative when `NEXT_TEST_WASM` is set\",\n   \"715\": \"Server Action \\\"%s\\\" was not found on the server. \\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n-  \"716\": \"NEXT_DEVTOOLS_SIMULATED_ERROR\"\n+  \"716\": \"NEXT_DEVTOOLS_SIMULATED_ERROR\",\n+  \"717\": \"Unsupported environment condition \\\"%s\\\" and react condition \\\"%s\\\". This is a bug in Next.js.\"\n }"
        },
        {
            "sha": "1877bbdc1333227c2061d035041fcb2c989c9caa",
            "filename": "packages/next/src/build/create-compiler-aliases.ts",
            "status": "modified",
            "additions": 238,
            "deletions": 75,
            "changes": 313,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcreate-compiler-aliases.ts?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -17,8 +17,7 @@ import type { NextConfigComplete } from '../server/config-shared'\n import { defaultOverrides } from '../server/require-hook'\n import { hasExternalOtelApiPackage } from './webpack-config'\n import { NEXT_PROJECT_ROOT } from './next-dir-paths'\n-import { WEBPACK_LAYERS } from '../lib/constants'\n-import { isWebpackServerOnlyLayer } from './utils'\n+import { shouldUseReactServerCondition } from './utils'\n \n interface CompilerAliases {\n   [alias: string]: string | string[]\n@@ -259,97 +258,261 @@ export function createAppRouterApiAliases(isServerOnlyLayer: boolean) {\n   return aliasMap\n }\n \n-export function createRSCAliases(\n-  bundledReactChannel: string,\n+// file:///./../compiled/react/package.json\n+type ReactEntrypoint = 'jsx-runtime' | 'jsx-dev-runtime' | 'compiler-runtime'\n+// file:///./../compiled/react-dom/package.json\n+type ReactDOMEntrypoint =\n+  | 'client'\n+  | 'server'\n+  | 'server.edge'\n+  | 'server.browser'\n+  // TODO: server.node\n+  | 'static'\n+  | 'static.browser'\n+  | 'static.edge'\n+// TODO: static.node\n+\n+// file:///./../compiled/react-server-dom-webpack/package.json\n+type ReactServerDOMWebpackEntrypoint =\n+  | 'client'\n+  // TODO: client.browser\n+  | 'client.edge'\n+  // TODO: client.node\n+  // TODO: server\n+  // TODO: server.browser\n+  | 'server.edge'\n+  | 'server.node'\n+  // TODO: static\n+  // TODO: static.browser\n+  | 'static.edge'\n+// TODO: static.node\n+\n+type ReactPackagesEntryPoint =\n+  | 'react'\n+  | `react/${ReactEntrypoint}`\n+  | 'react-dom'\n+  | `react-dom/${ReactDOMEntrypoint}`\n+  | `react-server-dom-webpack/${ReactServerDOMWebpackEntrypoint}`\n+\n+type BundledReactChannel = '' | '-experimental'\n+\n+type ReactAliases = {\n+  [K in `${ReactPackagesEntryPoint}$`]: string\n+} & {\n+  // Edge Runtime does not use next-server runtime.\n+  // This means we rely on rewritten import sources in compiled React.\n+  // We need to alias those rewritten import sources.\n+  [K in\n+    | `next/dist/compiled/react${BundledReactChannel}$`\n+    | `next/dist/compiled/react${BundledReactChannel}/${ReactEntrypoint}$`\n+    | `next/dist/compiled/react-dom${BundledReactChannel}$`]?: string\n+}\n+\n+export function createVendoredReactAliases(\n+  bundledReactChannel: BundledReactChannel,\n   {\n     layer,\n+    isBrowser,\n     isEdgeServer,\n     reactProductionProfiling,\n   }: {\n     layer: WebpackLayerName\n+    isBrowser: boolean\n     isEdgeServer: boolean\n     reactProductionProfiling: boolean\n   }\n ): CompilerAliases {\n-  const isServerOnlyLayer = isWebpackServerOnlyLayer(layer)\n-  // For middleware, instrumentation layers, treat them as rsc layer.\n-  // Since we only built the runtime package for rsc, convert everything to rsc\n-  // to ensure the runtime modules path existed.\n-  if (isServerOnlyLayer) {\n-    layer = WEBPACK_LAYERS.reactServerComponents\n-  }\n-\n-  let alias: Record<string, string> = {\n-    react$: `next/dist/compiled/react${bundledReactChannel}`,\n-    'react-dom$': `next/dist/compiled/react-dom${bundledReactChannel}`,\n-    'react/jsx-runtime$': `next/dist/compiled/react${bundledReactChannel}/jsx-runtime`,\n-    'react/jsx-dev-runtime$': `next/dist/compiled/react${bundledReactChannel}/jsx-dev-runtime`,\n-    'react/compiler-runtime$': `next/dist/compiled/react${bundledReactChannel}/compiler-runtime`,\n-    'react-dom/client$': `next/dist/compiled/react-dom${bundledReactChannel}/client`,\n-    'react-dom/server$': `next/dist/compiled/react-dom${bundledReactChannel}/server`,\n-    'react-dom/server.browser$': `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n-    'react-dom/static$': `next/dist/compiled/react-dom${bundledReactChannel}/static`,\n-    'react-dom/static.edge$': `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n-    'react-dom/static.browser$': `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n-    // optimizations to ignore the legacy build of react-dom/server in `server.edge` build\n-    'react-dom/server.edge$': `next/dist/build/webpack/alias/react-dom-server-edge${bundledReactChannel}.js`,\n-    // react-server-dom-webpack alias\n-    'react-server-dom-webpack/client$': `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client`,\n-    'react-server-dom-webpack/client.edge$': `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.edge`,\n-    'react-server-dom-webpack/server.edge$': `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.edge`,\n-    'react-server-dom-webpack/server.node$': `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.node`,\n-    'react-server-dom-webpack/static.edge$': `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/static.edge`,\n-  }\n-\n-  if (!isEdgeServer) {\n-    if (layer === WEBPACK_LAYERS.serverSideRendering) {\n-      alias = Object.assign(alias, {\n-        'react/jsx-runtime$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-jsx-runtime`,\n-        'react/jsx-dev-runtime$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-jsx-dev-runtime`,\n-        'react/compiler-runtime$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-compiler-runtime`,\n-        react$: `next/dist/server/route-modules/app-page/vendored/${layer}/react`,\n-        'react-dom$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-dom`,\n-        'react-server-dom-webpack/client.edge$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-server-dom-webpack-client-edge`,\n-      })\n-    } else if (layer === WEBPACK_LAYERS.reactServerComponents) {\n-      alias = Object.assign(alias, {\n-        'react/jsx-runtime$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-jsx-runtime`,\n-        'react/jsx-dev-runtime$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-jsx-dev-runtime`,\n-        'react/compiler-runtime$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-compiler-runtime`,\n-        react$: `next/dist/server/route-modules/app-page/vendored/${layer}/react`,\n-        'react-dom$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-dom`,\n-        'react-server-dom-webpack/server.edge$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-server-dom-webpack-server-edge`,\n-        'react-server-dom-webpack/server.node$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-server-dom-webpack-server-node`,\n-        'react-server-dom-webpack/static.edge$': `next/dist/server/route-modules/app-page/vendored/${layer}/react-server-dom-webpack-static-edge`,\n-      })\n+  const environmentCondition = isBrowser\n+    ? 'browser'\n+    : isEdgeServer\n+      ? 'edge'\n+      : 'nodejs'\n+  const reactCondition = shouldUseReactServerCondition(layer)\n+    ? 'server'\n+    : 'client'\n+\n+  // ✅ Correct alias\n+  // ❌ Incorrect alias i.e. importing this entrypoint should throw an error.\n+  // ❔ Alias that may produce correct code in certain conditions.Keep until react-markup is available.\n+\n+  let reactAlias: ReactAliases\n+  if (environmentCondition === 'browser' && reactCondition === 'client') {\n+    // prettier-ignore\n+    reactAlias = {\n+      // file:///./../compiled/react/package.json\n+      react$:                                  /* ✅ */ `next/dist/compiled/react${bundledReactChannel}`,\n+      'react/compiler-runtime$':               /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/compiler-runtime`,\n+      'react/jsx-dev-runtime$':                /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/jsx-dev-runtime`,\n+      'react/jsx-runtime$':                    /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/jsx-runtime`,\n+      // file:///./../compiled/react-dom/package.json\n+      'react-dom$':                            /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}`,\n+      'react-dom/client$':                     /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/client`,\n+      'react-dom/server$':                     /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n+      'react-dom/server.browser$':             /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n+      // optimizations to ignore the legacy build of react-dom/server in `server.edge` build\n+      'react-dom/server.edge$':                /* ❌ */ `next/dist/build/webpack/alias/react-dom-server-edge${bundledReactChannel}.js`,\n+      'react-dom/static$':                     /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n+      'react-dom/static.browser$':             /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n+      'react-dom/static.edge$':                /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n+      // file:///./../compiled/react-server-dom-webpack/package.json\n+      'react-server-dom-webpack/client$':      /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.browser`,\n+      'react-server-dom-webpack/client.edge$': /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.edge`,\n+      'react-server-dom-webpack/server.edge$': /* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.edge`,\n+      'react-server-dom-webpack/server.node$': /* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.node`,\n+      'react-server-dom-webpack/static.edge$': /* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/static.edge`,\n     }\n-  }\n-\n-  if (isEdgeServer) {\n-    if (layer === WEBPACK_LAYERS.reactServerComponents) {\n-      alias = Object.assign(alias, {\n-        react$: `next/dist/compiled/react${bundledReactChannel}/react.react-server`,\n-        'next/dist/compiled/react$': `next/dist/compiled/react${bundledReactChannel}/react.react-server`,\n-        'next/dist/compiled/react-experimental$': `next/dist/compiled/react-experimental/react.react-server`,\n-        'react/jsx-runtime$': `next/dist/compiled/react${bundledReactChannel}/jsx-runtime.react-server`,\n-        'react/compiler-runtime$': `next/dist/compiled/react${bundledReactChannel}/compiler-runtime`,\n-        'next/dist/compiled/react/jsx-runtime$': `next/dist/compiled/react${bundledReactChannel}/jsx-runtime.react-server`,\n-        'next/dist/compiled/react-experimental/jsx-runtime$': `next/dist/compiled/react-experimental/jsx-runtime.react-server`,\n-        'react/jsx-dev-runtime$': `next/dist/compiled/react${bundledReactChannel}/jsx-dev-runtime.react-server`,\n-        'next/dist/compiled/react/jsx-dev-runtime$': `next/dist/compiled/react${bundledReactChannel}/jsx-dev-runtime.react-server`,\n-        'next/dist/compiled/react-experimental/jsx-dev-runtime$': `next/dist/compiled/react-experimental/jsx-dev-runtime.react-server`,\n-        'react-dom$': `next/dist/compiled/react-dom${bundledReactChannel}/react-dom.react-server`,\n-        'next/dist/compiled/react-dom$': `next/dist/compiled/react-dom${bundledReactChannel}/react-dom.react-server`,\n-        'next/dist/compiled/react-dom-experimental$': `next/dist/compiled/react-dom-experimental/react-dom.react-server`,\n-      })\n+  } else if (\n+    environmentCondition === 'browser' &&\n+    reactCondition === 'server'\n+  ) {\n+    // prettier-ignore\n+    reactAlias = {\n+      // file:///./../compiled/react/package.json\n+      react$:                                  /* ❌ */ `next/dist/compiled/react${bundledReactChannel}`,\n+      'react/compiler-runtime$':               /* ❌ */ `next/dist/compiled/react${bundledReactChannel}/compiler-runtime`,\n+      'react/jsx-dev-runtime$':                /* ❌ */ `next/dist/compiled/react${bundledReactChannel}/jsx-dev-runtime`,\n+      'react/jsx-runtime$':                    /* ❌ */ `next/dist/compiled/react${bundledReactChannel}/jsx-runtime`,\n+      // file:///./../compiled/react-dom/package.json\n+      'react-dom$':                            /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}`,\n+      'react-dom/client$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/client`,\n+      'react-dom/server$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n+      'react-dom/server.browser$':             /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n+      // optimizations to ignore the legacy build of react-dom/server in `server.edge` build\n+      'react-dom/server.edge$':                /* ❌ */ `next/dist/build/webpack/alias/react-dom-server-edge${bundledReactChannel}.js`,\n+      'react-dom/static$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n+      'react-dom/static.browser$':             /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n+      'react-dom/static.edge$':                /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n+      // file:///./../compiled/react-server-dom-webpack/package.json\n+      'react-server-dom-webpack/client$':      /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.browser`,\n+      'react-server-dom-webpack/client.edge$': /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.edge`,\n+      'react-server-dom-webpack/server.edge$': /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.edge`,\n+      'react-server-dom-webpack/server.node$': /* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.node`,\n+      'react-server-dom-webpack/static.edge$': /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/static.edge`,\n+    }\n+  } else if (environmentCondition === 'nodejs' && reactCondition === 'client') {\n+    // prettier-ignore\n+    reactAlias = {\n+      // file:///./../compiled/react/package.json\n+      react$:                                 /* ✅ */ `next/dist/server/route-modules/app-page/vendored/ssr/react`,\n+      'react/compiler-runtime$':              /* ✅ */ `next/dist/server/route-modules/app-page/vendored/ssr/react-compiler-runtime`,\n+      'react/jsx-dev-runtime$':               /* ✅ */ `next/dist/server/route-modules/app-page/vendored/ssr/react-jsx-dev-runtime`,\n+      'react/jsx-runtime$':                   /* ✅ */ `next/dist/server/route-modules/app-page/vendored/ssr/react-jsx-runtime`,\n+      // file:///./../compiled/react-dom/package.json\n+      'react-dom$':                           /* ✅ */ `next/dist/server/route-modules/app-page/vendored/ssr/react-dom`,\n+      'react-dom/client$':                    /* ❔ */ `next/dist/compiled/react-dom${bundledReactChannel}/client`,\n+      'react-dom/server$':                    /* ❔ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.node`,\n+      'react-dom/server.browser$':            /* ❔ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n+      // optimizations to ignore the legacy build of react-dom/server in `server.edge` build\n+      'react-dom/server.edge$':               /* ✅ */ `next/dist/build/webpack/alias/react-dom-server-edge${bundledReactChannel}.js`,\n+      'react-dom/static$':                    /* ❔ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.node`,\n+      'react-dom/static.browser$':            /* ❔ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n+      'react-dom/static.edge$':               /* ❔ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n+      // file:///./../compiled/react-server-dom-webpack/package.json\n+      'react-server-dom-webpack/client$':     /* ❔ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.node`,\n+      'react-server-dom-webpack/client.edge$':/* ✅ */ `next/dist/server/route-modules/app-page/vendored/ssr/react-server-dom-webpack-client-edge`,\n+      'react-server-dom-webpack/server.edge$':/* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.edge`,\n+      'react-server-dom-webpack/server.node$':/* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.node`,\n+      'react-server-dom-webpack/static.edge$':/* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/static.edge`,\n+    }\n+  } else if (environmentCondition === 'nodejs' && reactCondition === 'server') {\n+    // prettier-ignore\n+    reactAlias = {\n+      // file:///./../compiled/react/package.json\n+      react$:                                  /* ✅ */ `next/dist/server/route-modules/app-page/vendored/rsc/react`,\n+      'react/compiler-runtime$':               /* ✅ */ `next/dist/server/route-modules/app-page/vendored/rsc/react-compiler-runtime`,\n+      'react/jsx-dev-runtime$':                /* ✅ */ `next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-dev-runtime`,\n+      'react/jsx-runtime$':                    /* ✅ */ `next/dist/server/route-modules/app-page/vendored/rsc/react-jsx-runtime`,\n+      // file:///./../compiled/react-dom/package.json\n+      'react-dom$':                            /* ✅ */ `next/dist/server/route-modules/app-page/vendored/rsc/react-dom`,\n+      'react-dom/client$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/client`,\n+      'react-dom/server$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.node`,\n+      'react-dom/server.browser$':             /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n+      // optimizations to ignore the legacy build of react-dom/server in `server.edge` build\n+      'react-dom/server.edge$':                /* ❌ */ `next/dist/build/webpack/alias/react-dom-server-edge${bundledReactChannel}.js`,\n+      'react-dom/static$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.node`,\n+      'react-dom/static.browser$':             /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n+      'react-dom/static.edge$':                /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n+      // file:///./../compiled/react-server-dom-webpack/package.json\n+      'react-server-dom-webpack/client$':      /* ❔ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.node`,\n+      'react-server-dom-webpack/client.edge$': /* ❔ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.edge`,\n+      'react-server-dom-webpack/server.edge$': /* ✅ */ `next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-webpack-server-edge`,\n+      'react-server-dom-webpack/server.node$': /* ✅ */ `next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-webpack-server-node`,\n+      'react-server-dom-webpack/static.edge$': /* ✅ */ `next/dist/server/route-modules/app-page/vendored/rsc/react-server-dom-webpack-static-edge`,\n+    }\n+  } else if (environmentCondition === 'edge' && reactCondition === 'client') {\n+    // prettier-ignore\n+    reactAlias = {\n+      // file:///./../compiled/react/package.json\n+      react$:                                  /* ✅ */ `next/dist/compiled/react${bundledReactChannel}`,\n+      'react/compiler-runtime$':               /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/compiler-runtime`,\n+      'react/jsx-dev-runtime$':                /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/jsx-dev-runtime`,\n+      'react/jsx-runtime$':                    /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/jsx-runtime`,\n+      // file:///./../compiled/react-dom/package.json\n+      'react-dom$':                            /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}`,\n+      'react-dom/client$':                     /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/client`,\n+      'react-dom/server$':                     /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.edge`,\n+      'react-dom/server.browser$':             /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n+      // optimizations to ignore the legacy build of react-dom/server in `server.edge` build\n+      'react-dom/server.edge$':                /* ✅ */ `next/dist/build/webpack/alias/react-dom-server-edge${bundledReactChannel}.js`,\n+      'react-dom/static$':                     /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n+      'react-dom/static.browser$':             /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n+      'react-dom/static.edge$':                /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n+      // file:///./../compiled/react-server-dom-webpack/package.json\n+      'react-server-dom-webpack/client$':      /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.edge`,\n+      'react-server-dom-webpack/client.edge$': /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.edge`,\n+      'react-server-dom-webpack/server.edge$': /* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.edge`,\n+      'react-server-dom-webpack/server.node$': /* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.node`,\n+      'react-server-dom-webpack/static.edge$': /* ❌ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/static.edge`,\n     }\n+  } else if (environmentCondition === 'edge' && reactCondition === 'server') {\n+    // prettier-ignore\n+    reactAlias = {\n+      // file:///./../compiled/react/package.json\n+      react$:                                  /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/react.react-server`,\n+      'react/compiler-runtime$':               /* ❌ */ `next/dist/compiled/react${bundledReactChannel}/compiler-runtime`,\n+      'react/jsx-dev-runtime$':                /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/jsx-dev-runtime.react-server`,\n+      'react/jsx-runtime$':                    /* ✅ */ `next/dist/compiled/react${bundledReactChannel}/jsx-runtime.react-server`,\n+      // file:///./../compiled/react-dom/package.json\n+      'react-dom$':                            /* ✅ */ `next/dist/compiled/react-dom${bundledReactChannel}/react-dom.react-server`,\n+      'react-dom/client$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/client`,\n+      'react-dom/server$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.edge`,\n+      'react-dom/server.browser$':             /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/server.browser`,\n+      // optimizations to ignore the legacy build of react-dom/server in `server.edge` build\n+      'react-dom/server.edge$':                /* ❌ */ `next/dist/build/webpack/alias/react-dom-server-edge${bundledReactChannel}.js`,\n+      'react-dom/static$':                     /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n+      'react-dom/static.browser$':             /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.browser`,\n+      'react-dom/static.edge$':                /* ❌ */ `next/dist/compiled/react-dom${bundledReactChannel}/static.edge`,\n+      // file:///./../compiled/react-server-dom-webpack/package.json\n+      'react-server-dom-webpack/client$':      /* ❔ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.edge`,\n+      'react-server-dom-webpack/client.edge$': /* ❔ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/client.edge`,\n+      'react-server-dom-webpack/server.edge$': /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.edge`,\n+      'react-server-dom-webpack/server.node$': /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/server.node`,\n+      'react-server-dom-webpack/static.edge$': /* ✅ */ `next/dist/compiled/react-server-dom-webpack${bundledReactChannel}/static.edge`,\n+    }\n+\n+    // prettier-ignore\n+    reactAlias[`next/dist/compiled/react${bundledReactChannel}$`                 ] = reactAlias[`react$`]\n+    // prettier-ignore\n+    reactAlias[`next/dist/compiled/react${bundledReactChannel}/compiler-runtime$`] = reactAlias[`react/compiler-runtime$`]\n+    // prettier-ignore\n+    reactAlias[`next/dist/compiled/react${bundledReactChannel}/jsx-dev-runtime$` ] = reactAlias[`react/jsx-dev-runtime$`]\n+    // prettier-ignore\n+    reactAlias[`next/dist/compiled/react${bundledReactChannel}/jsx-runtime$`     ] = reactAlias[`react/jsx-runtime$`]\n+    // prettier-ignore\n+    reactAlias[`next/dist/compiled/react-dom${bundledReactChannel}$`             ] = reactAlias[`react-dom$`]\n+  } else {\n+    throw new Error(\n+      `Unsupported environment condition \"${environmentCondition}\" and react condition \"${reactCondition}\". This is a bug in Next.js.`\n+    )\n   }\n \n   if (reactProductionProfiling) {\n-    alias['react-dom/client$'] =\n+    reactAlias['react-dom/client$'] =\n       `next/dist/compiled/react-dom${bundledReactChannel}/profiling`\n   }\n \n+  const alias: CompilerAliases = reactAlias\n+\n   alias[\n     '@vercel/turbopack-ecmascript-runtime/browser/dev/hmr-client/hmr-client.ts'\n   ] = `next/dist/client/dev/noop-turbopack-hmr`"
        },
        {
            "sha": "6b1417d6696d7b76ec8b1521401989728355bb5a",
            "filename": "packages/next/src/build/handle-externals.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -10,7 +10,7 @@ import {\n   NODE_ESM_RESOLVE_OPTIONS,\n   NODE_RESOLVE_OPTIONS,\n } from './webpack-config'\n-import { isWebpackBundledLayer, isWebpackServerOnlyLayer } from './utils'\n+import { isWebpackBundledLayer, shouldUseReactServerCondition } from './utils'\n import { normalizePathSep } from '../shared/lib/page-path/normalize-path-sep'\n const reactPackagesRegex = /^(react|react-dom|react-server-dom-webpack)($|\\/)/\n \n@@ -216,7 +216,7 @@ export function makeExternalHandler({\n     // TODO-APP: bundle route.js with different layer that externals common node_module deps.\n     // Make sure @vercel/og is loaded as ESM for Node.js runtime\n     if (\n-      isWebpackServerOnlyLayer(layer) &&\n+      shouldUseReactServerCondition(layer) &&\n       request === 'next/dist/compiled/@vercel/og/index.node.js'\n     ) {\n       return `module ${request}`"
        },
        {
            "sha": "6775acbf8b6edacfe913c466c946f13292d80edd",
            "filename": "packages/next/src/build/swc/options.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -7,7 +7,7 @@ import type {\n   StyledComponentsConfig,\n } from '../../server/config-shared'\n import type { ResolvedBaseUrl } from '../load-jsconfig'\n-import { isWebpackServerOnlyLayer, isWebpackAppPagesLayer } from '../utils'\n+import { shouldUseReactServerCondition, isWebpackAppPagesLayer } from '../utils'\n import { escapeStringRegexp } from '../../shared/lib/escape-regexp'\n \n const nextDirname = path.dirname(require.resolve('next/package.json'))\n@@ -96,7 +96,7 @@ function getBaseSWCOptions({\n   useCacheEnabled?: boolean\n   trackDynamicImports?: boolean\n }) {\n-  const isReactServerLayer = isWebpackServerOnlyLayer(bundleLayer)\n+  const isReactServerLayer = shouldUseReactServerCondition(bundleLayer)\n   const isAppRouterPagesLayer = isWebpackAppPagesLayer(bundleLayer)\n   const parserConfig = getParserOptions({ filename, jsConfig })\n   const paths = jsConfig?.compilerOptions?.paths"
        },
        {
            "sha": "7e9da48145a017a2ba9daf0550b0ce8fac46b60a",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -1846,7 +1846,7 @@ export function getSupportedBrowsers(\n   return MODERN_BROWSERSLIST_TARGET\n }\n \n-export function isWebpackServerOnlyLayer(\n+export function shouldUseReactServerCondition(\n   layer: WebpackLayerName | null | undefined\n ): boolean {\n   return Boolean("
        },
        {
            "sha": "4d1d667f74d2e855c752ebeb47434d2aaf26ef05",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 13,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/343c83807fd53a2052fce6f7ddccf8461edee8b8/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=343c83807fd53a2052fce6f7ddccf8461edee8b8",
            "patch": "@@ -12,7 +12,7 @@ import type { WebpackLayerName } from '../lib/constants'\n import {\n   isWebpackBundledLayer,\n   isWebpackClientOnlyLayer,\n-  isWebpackServerOnlyLayer,\n+  shouldUseReactServerCondition,\n   isWebpackDefaultLayer,\n   RSPACK_DEFAULT_LAYERS_REGEX,\n } from './utils'\n@@ -80,7 +80,7 @@ import { OptionalPeerDependencyResolverPlugin } from './webpack/plugins/optional\n import {\n   createWebpackAliases,\n   createServerOnlyClientOnlyAliases,\n-  createRSCAliases,\n+  createVendoredReactAliases,\n   createNextApiEsmAliases,\n   createAppRouterApiAliases,\n } from './create-compiler-aliases'\n@@ -1484,7 +1484,7 @@ export default async function getBaseWebpackConfig(\n                 },\n               },\n               {\n-                issuerLayer: isWebpackServerOnlyLayer,\n+                issuerLayer: shouldUseReactServerCondition,\n                 resolve: {\n                   alias: createAppRouterApiAliases(true),\n                 },\n@@ -1500,7 +1500,7 @@ export default async function getBaseWebpackConfig(\n         ...(hasAppDir && !isClient\n           ? [\n               {\n-                issuerLayer: isWebpackServerOnlyLayer,\n+                issuerLayer: shouldUseReactServerCondition,\n                 test: {\n                   // Resolve it if it is a source code file, and it has NOT been\n                   // opted out of bundling.\n@@ -1528,10 +1528,11 @@ export default async function getBaseWebpackConfig(\n                   // If missing the alias override here, the default alias will be used which aliases\n                   // react to the direct file path, not the package name. In that case the condition\n                   // will be ignored completely.\n-                  alias: createRSCAliases(bundledReactChannel, {\n+                  alias: createVendoredReactAliases(bundledReactChannel, {\n                     // No server components profiling\n                     reactProductionProfiling,\n                     layer: WEBPACK_LAYERS.reactServerComponents,\n+                    isBrowser: isClient,\n                     isEdgeServer,\n                   }),\n                 },\n@@ -1571,7 +1572,7 @@ export default async function getBaseWebpackConfig(\n                 // Alias react for switching between default set and share subset.\n                 oneOf: [\n                   {\n-                    issuerLayer: isWebpackServerOnlyLayer,\n+                    issuerLayer: shouldUseReactServerCondition,\n                     test: {\n                       // Resolve it if it is a source code file, and it has NOT been\n                       // opted out of bundling.\n@@ -1585,9 +1586,10 @@ export default async function getBaseWebpackConfig(\n                     resolve: {\n                       // It needs `conditionNames` here to require the proper asset,\n                       // when react is acting as dependency of compiled/react-dom.\n-                      alias: createRSCAliases(bundledReactChannel, {\n+                      alias: createVendoredReactAliases(bundledReactChannel, {\n                         reactProductionProfiling,\n                         layer: WEBPACK_LAYERS.reactServerComponents,\n+                        isBrowser: isClient,\n                         isEdgeServer,\n                       }),\n                     },\n@@ -1596,9 +1598,10 @@ export default async function getBaseWebpackConfig(\n                     test: aliasCodeConditionTest,\n                     issuerLayer: WEBPACK_LAYERS.serverSideRendering,\n                     resolve: {\n-                      alias: createRSCAliases(bundledReactChannel, {\n+                      alias: createVendoredReactAliases(bundledReactChannel, {\n                         reactProductionProfiling,\n                         layer: WEBPACK_LAYERS.serverSideRendering,\n+                        isBrowser: isClient,\n                         isEdgeServer,\n                       }),\n                     },\n@@ -1609,9 +1612,10 @@ export default async function getBaseWebpackConfig(\n                 test: aliasCodeConditionTest,\n                 issuerLayer: WEBPACK_LAYERS.appPagesBrowser,\n                 resolve: {\n-                  alias: createRSCAliases(bundledReactChannel, {\n+                  alias: createVendoredReactAliases(bundledReactChannel, {\n                     reactProductionProfiling,\n                     layer: WEBPACK_LAYERS.appPagesBrowser,\n+                    isBrowser: isClient,\n                     isEdgeServer,\n                   }),\n                 },\n@@ -1663,9 +1667,10 @@ export default async function getBaseWebpackConfig(\n               resolve: {\n                 mainFields: getMainField(compilerType, true),\n                 conditionNames: reactServerCondition,\n-                alias: createRSCAliases(bundledReactChannel, {\n+                alias: createVendoredReactAliases(bundledReactChannel, {\n                   reactProductionProfiling,\n                   layer: WEBPACK_LAYERS.middleware,\n+                  isBrowser: isClient,\n                   isEdgeServer,\n                 }),\n               },\n@@ -1677,9 +1682,10 @@ export default async function getBaseWebpackConfig(\n               resolve: {\n                 mainFields: getMainField(compilerType, true),\n                 conditionNames: reactServerCondition,\n-                alias: createRSCAliases(bundledReactChannel, {\n+                alias: createVendoredReactAliases(bundledReactChannel, {\n                   reactProductionProfiling,\n                   layer: WEBPACK_LAYERS.instrument,\n+                  isBrowser: isClient,\n                   isEdgeServer,\n                 }),\n               },\n@@ -1688,7 +1694,7 @@ export default async function getBaseWebpackConfig(\n               ? [\n                   {\n                     test: codeCondition.test,\n-                    issuerLayer: isWebpackServerOnlyLayer,\n+                    issuerLayer: shouldUseReactServerCondition,\n                     exclude: asyncStoragesRegex,\n                     use: appServerLayerLoaders,\n                   },\n@@ -2530,9 +2536,10 @@ export default async function getBaseWebpackConfig(\n       ].map((layer) => ({\n         issuerLayer: layer,\n         resolve: {\n-          alias: createRSCAliases(bundledReactChannel, {\n+          alias: createVendoredReactAliases(bundledReactChannel, {\n             reactProductionProfiling,\n             layer,\n+            isBrowser: isClient,\n             isEdgeServer,\n           }),\n         },"
        }
    ],
    "stats": {
        "total": 626,
        "additions": 450,
        "deletions": 176
    }
}