{
    "author": "timneutkens",
    "message": "Fix build-indicator test flaking (#83585)\n\n## What?\n\nFixes the flaky build-indicator test to use `retry` instead of\n`waitFor`. `waitFor` assumes something happens within x amount of time\nbut if that's slightly slower than that it fails the test even though\nthe test is not broken.",
    "sha": "3b8ce1a479778dc161fec7c8e9401861deaaf447",
    "files": [
        {
            "sha": "efc305a161b7d17da418fd3827eb7f58f551e6bd",
            "filename": "test/integration/build-indicator/test/index.test.js",
            "status": "modified",
            "additions": 18,
            "deletions": 12,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8ce1a479778dc161fec7c8e9401861deaaf447/test%2Fintegration%2Fbuild-indicator%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8ce1a479778dc161fec7c8e9401861deaaf447/test%2Fintegration%2Fbuild-indicator%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbuild-indicator%2Ftest%2Findex.test.js?ref=3b8ce1a479778dc161fec7c8e9401861deaaf447",
            "patch": "@@ -3,7 +3,7 @@\n import fs from 'fs-extra'\n import { join } from 'path'\n import webdriver from 'next-webdriver'\n-import { findPort, launchApp, killApp, waitFor, check } from 'next-test-utils'\n+import { findPort, launchApp, killApp, retry } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n const appDir = join(__dirname, '..')\n@@ -47,12 +47,14 @@ describe('Build Activity Indicator', () => {\n     })\n     await fs.remove(configPath)\n \n-    await check(\n-      () => stripAnsi(stderr),\n-      new RegExp(\n-        `Invalid \"devIndicator.position\" provided, expected one of top-left, top-right, bottom-left, bottom-right, received ttop-leff`\n+    await retry(async () => {\n+      const content = stripAnsi(stderr)\n+      expect(content).toMatch(\n+        new RegExp(\n+          `Invalid \"devIndicator.position\" provided, expected one of top-left, top-right, bottom-left, bottom-right, received ttop-leff`\n+        )\n       )\n-    )\n+    })\n \n     if (app) {\n       await killApp(app)\n@@ -76,9 +78,11 @@ describe('Build Activity Indicator', () => {\n           )\n           await installCheckVisible(browser)\n           await browser.elementByCss('#to-a').click()\n-          await waitFor(500)\n-          const wasVisible = await browser.eval('window.showedBuilder')\n-          expect(wasVisible).toBe(true)\n+          await retry(async () => {\n+            const wasVisible = await browser.eval('window.showedBuilder')\n+            expect(wasVisible).toBe(true)\n+          })\n+\n           await browser.close()\n         })\n       }\n@@ -98,10 +102,12 @@ describe('Build Activity Indicator', () => {\n       const newContent = origContent.replace('b', 'c')\n \n       await fs.writeFile(pagePath, newContent, 'utf8')\n-      await waitFor(500)\n-      const wasVisible = await browser.eval('window.showedBuilder')\n \n-      expect(wasVisible).toBe(true)\n+      await retry(async () => {\n+        const wasVisible = await browser.eval('window.showedBuilder')\n+\n+        expect(wasVisible).toBe(true)\n+      })\n       await fs.writeFile(pagePath, origContent, 'utf8')\n       await browser.close()\n     })"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 18,
        "deletions": 12
    }
}