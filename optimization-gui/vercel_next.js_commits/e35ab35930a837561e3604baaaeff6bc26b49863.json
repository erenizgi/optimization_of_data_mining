{
    "author": "mischnic",
    "message": "Turbopack: prevent panic in swc issue emitter (#76595)",
    "sha": "e35ab35930a837561e3604baaaeff6bc26b49863",
    "files": [
        {
            "sha": "3ef11fc21b7c6b5cd3cc7ecfcca23443abf0fe2e",
            "filename": "turbopack/crates/turbopack-core/src/issue/analyze.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fanalyze.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fanalyze.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fanalyze.rs?ref=e35ab35930a837561e3604baaaeff6bc26b49863",
            "patch": "@@ -23,15 +23,15 @@ pub struct AnalyzeIssue {\n impl AnalyzeIssue {\n     #[turbo_tasks::function]\n     pub fn new(\n-        severity: ResolvedVc<IssueSeverity>,\n+        severity: IssueSeverity,\n         source_ident: ResolvedVc<AssetIdent>,\n         title: ResolvedVc<RcStr>,\n         message: ResolvedVc<StyledString>,\n         code: Option<RcStr>,\n         source: Option<IssueSource>,\n     ) -> Vc<Self> {\n         Self {\n-            severity,\n+            severity: severity.resolved_cell(),\n             source_ident,\n             title,\n             message,"
        },
        {
            "sha": "0559f6cb116e4a34b3b276ad12618e36be572361",
            "filename": "turbopack/crates/turbopack-core/src/issue/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmod.rs?ref=e35ab35930a837561e3604baaaeff6bc26b49863",
            "patch": "@@ -30,7 +30,7 @@ use crate::{\n };\n \n #[turbo_tasks::value(shared)]\n-#[derive(PartialOrd, Ord, Copy, Clone, Hash, Debug, DeterministicHash)]\n+#[derive(PartialOrd, Ord, Copy, Clone, Hash, Debug, DeterministicHash, TaskInput)]\n #[serde(rename_all = \"camelCase\")]\n pub enum IssueSeverity {\n     Bug,"
        },
        {
            "sha": "946d56986fb2ea6154e5619cbc4826010f515905",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=e35ab35930a837561e3604baaaeff6bc26b49863",
            "patch": "@@ -413,7 +413,7 @@ pub async fn expand_star_exports(\n \n async fn emit_star_exports_issue(source_ident: Vc<AssetIdent>, message: RcStr) -> Result<()> {\n     AnalyzeIssue::new(\n-        IssueSeverity::Warning.cell(),\n+        IssueSeverity::Warning,\n         source_ident,\n         Vc::cell(\"unexpected export *\".into()),\n         StyledString::Text(message).cell(),"
        },
        {
            "sha": "ad92855a6fc26bb3b53ba6bd777299a18ba8c3f2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=e35ab35930a837561e3604baaaeff6bc26b49863",
            "patch": "@@ -939,7 +939,7 @@ pub(crate) async fn analyse_ecmascript_module_internal(\n             analysis.set_async_module(async_module);\n         } else if let Some(span) = top_level_await_span {\n             AnalyzeIssue::new(\n-                IssueSeverity::Error.cell(),\n+                IssueSeverity::Error,\n                 source.ident(),\n                 Vc::cell(\"unexpected top level await\".into()),\n                 StyledString::Text(\"top level await is only supported in ESM modules.\".into())"
        },
        {
            "sha": "e8a8d14df1baa00b5910f79960a3b02f5d5e2d37",
            "filename": "turbopack/crates/turbopack-swc-utils/src/emitter.rs",
            "status": "modified",
            "additions": 41,
            "deletions": 13,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-swc-utils%2Fsrc%2Femitter.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e35ab35930a837561e3604baaaeff6bc26b49863/turbopack%2Fcrates%2Fturbopack-swc-utils%2Fsrc%2Femitter.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-swc-utils%2Fsrc%2Femitter.rs?ref=e35ab35930a837561e3604baaaeff6bc26b49863",
            "patch": "@@ -27,19 +27,46 @@ impl IssueCollector {\n         };\n \n         for issue in issues {\n-            issue.to_resolved().await?.emit();\n+            AnalyzeIssue::new(\n+                issue.severity,\n+                issue.source.ident(),\n+                Vc::cell(issue.title),\n+                issue.message.cell(),\n+                issue.code,\n+                issue.issue_source,\n+            )\n+            .to_resolved()\n+            .await?\n+            .emit();\n         }\n         Ok(())\n     }\n \n     pub fn last_emitted_issue(&self) -> Option<Vc<AnalyzeIssue>> {\n         let inner = self.inner.lock();\n-        inner.emitted_issues.last().copied()\n+        inner.emitted_issues.last().map(|issue| {\n+            AnalyzeIssue::new(\n+                issue.severity,\n+                issue.source.ident(),\n+                Vc::cell(issue.title.clone()),\n+                issue.message.clone().cell(),\n+                issue.code.clone(),\n+                issue.issue_source.clone(),\n+            )\n+        })\n     }\n }\n \n struct IssueCollectorInner {\n-    emitted_issues: Vec<Vc<AnalyzeIssue>>,\n+    emitted_issues: Vec<PlainAnalyzeIssue>,\n+}\n+struct PlainAnalyzeIssue {\n+    severity: IssueSeverity,\n+    source: ResolvedVc<Box<dyn Source>>,\n+    title: RcStr,\n+    message: StyledString,\n+    code: Option<RcStr>,\n+    issue_source: Option<IssueSource>,\n }\n \n pub struct IssueEmitter {\n@@ -88,7 +115,7 @@ impl Emitter for IssueEmitter {\n             .as_ref()\n             .is_some_and(|d| matches!(d, DiagnosticId::Lint(_)));\n \n-        let severity = (if is_lint {\n+        let severity = if is_lint {\n             IssueSeverity::Suggestion\n         } else {\n             match level {\n@@ -101,8 +128,7 @@ impl Emitter for IssueEmitter {\n                 Level::Cancelled => IssueSeverity::Error,\n                 Level::FailureNote => IssueSeverity::Note,\n             }\n-        })\n-        .resolved_cell();\n+        };\n \n         let title;\n         if let Some(t) = self.title.as_ref() {\n@@ -118,14 +144,16 @@ impl Emitter for IssueEmitter {\n         });\n         // TODO add other primary and secondary spans with labels as sub_issues\n \n-        let issue = AnalyzeIssue::new(\n-            *severity,\n-            self.source.ident(),\n-            Vc::cell(title),\n-            StyledString::Text(message.into()).cell(),\n+        // This can be invoked by swc on different threads, so we cannot call any turbo-tasks or\n+        // create cells here.\n+        let issue = PlainAnalyzeIssue {\n+            severity,\n+            source: self.source,\n+            title,\n+            message: StyledString::Text(message.into()),\n             code,\n-            source,\n-        );\n+            issue_source: source,\n+        };\n \n         let mut inner = self.inner.lock();\n         inner.emitted_issues.push(issue);"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 46,
        "deletions": 18
    }
}