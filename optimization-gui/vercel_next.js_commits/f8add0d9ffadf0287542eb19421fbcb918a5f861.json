{
    "author": "huozhi",
    "message": "[segment explorer] fix soft navigation case (#80443)",
    "sha": "f8add0d9ffadf0287542eb19421fbcb918a5f861",
    "files": [
        {
            "sha": "ada99aa0bd7bccc73b1bb5710c29dcb6e5b2de69",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f8add0d9ffadf0287542eb19421fbcb918a5f861/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f8add0d9ffadf0287542eb19421fbcb918a5f861/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=f8add0d9ffadf0287542eb19421fbcb918a5f861",
            "patch": "@@ -80,6 +80,8 @@ function PageSegmentTreeLayerPresentation({\n                   {folderName && (\n                     <span className=\"segment-explorer-filename--path\">\n                       {folderName}\n+                      {/* hidden slashes for testing snapshots */}\n+                      <small>{'/'}</small>\n                     </span>\n                   )}\n                   <span className=\"segment-explorer-filename--name\">\n@@ -151,6 +153,9 @@ export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n   .segment-explorer-filename--path {\n     margin-right: 8px;\n   }\n+  .segment-explorer-filename--path small {\n+    width: 0;\n+  }\n   .segment-explorer-filename--name {\n     color: var(--color-gray-800);\n   }"
        },
        {
            "sha": "0d19bff0f55d20c26f2251f7c2e2c728af317768",
            "filename": "packages/next/src/next-devtools/dev-overlay/segment-explorer.test.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f8add0d9ffadf0287542eb19421fbcb918a5f861/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f8add0d9ffadf0287542eb19421fbcb918a5f861/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.test.tsx?ref=f8add0d9ffadf0287542eb19421fbcb918a5f861",
            "patch": "@@ -75,7 +75,7 @@ describe('Segment Explorer', () => {\n     })\n   })\n \n-  test.failing('remove node in the middle', () => {\n+  test('remove node in the middle', () => {\n     insertSegmentNode({ pagePath: '/a/b/@sidebar/page.js', type: 'page' })\n     insertSegmentNode({ pagePath: '/a/b/page.js', type: 'page' })\n     insertSegmentNode({ pagePath: '/a/b/layout.js', type: 'layout' })"
        },
        {
            "sha": "a78866eee646de7bb03529cb820cd58cbbba33af",
            "filename": "packages/next/src/next-devtools/dev-overlay/segment-explorer.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 7,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/f8add0d9ffadf0287542eb19421fbcb918a5f861/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f8add0d9ffadf0287542eb19421fbcb918a5f861/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer.ts?ref=f8add0d9ffadf0287542eb19421fbcb918a5f861",
            "patch": "@@ -55,9 +55,11 @@ const createSegmentTreeStore = (): {\n const { subscribe, getSnapshot, getServerSnapshot } = createSegmentTreeStore()\n \n function createTrie<Value = string>({\n-  getKey = (k) => k as unknown as string,\n+  getCharacters = (item: Value) => [item] as string[],\n+  compare = (a: Value | undefined, b: Value | undefined) => a === b,\n }: {\n-  getKey: (k: Value) => string\n+  getCharacters?: (item: Value) => string[]\n+  compare?: (a: Value | undefined, b: Value | undefined) => boolean\n }): Trie<Value> {\n   const root: TrieNode<Value> = {\n     value: undefined,\n@@ -72,8 +74,7 @@ function createTrie<Value = string>({\n \n   function insert(value: Value) {\n     let currentNode = root\n-    const key = getKey(value)\n-    const segments = key.split('/')\n+    const segments = getCharacters(value)\n \n     for (const segment of segments) {\n       if (!currentNode.children[segment]) {\n@@ -91,8 +92,31 @@ function createTrie<Value = string>({\n     markUpdated()\n   }\n \n-  function remove(_: Value) {\n-    // TODO Implement remove functionality\n+  function remove(value: Value) {\n+    let currentNode = root\n+    const segments = getCharacters(value)\n+    const stack: TrieNode<Value>[] = []\n+    let found = true\n+    for (const segment of segments) {\n+      if (!currentNode.children[segment]) {\n+        found = false\n+        break\n+      }\n+      stack.push(currentNode)\n+      currentNode = currentNode.children[segment]!\n+    }\n+    // If the value is not found, skip removal\n+    if (!found || !compare(currentNode.value, value)) {\n+      return\n+    }\n+    currentNode.value = undefined\n+    for (let i = stack.length - 1; i >= 0; i--) {\n+      const parentNode = stack[i]\n+      const segment = segments[i]\n+      if (Object.keys(parentNode.children[segment]!.children).length === 0) {\n+        delete parentNode.children[segment]\n+      }\n+    }\n \n     markUpdated()\n   }\n@@ -113,7 +137,11 @@ export type SegmentTrie = Trie<SegmentNode>\n export type SegmentTrieNode = TrieNode<SegmentNode>\n \n const trie: SegmentTrie = createTrie({\n-  getKey: (item) => item.pagePath,\n+  compare: (a, b) => {\n+    if (!a || !b) return false\n+    return a.pagePath === b.pagePath && a.type === b.type\n+  },\n+  getCharacters: (item) => item.pagePath.split('/'),\n })\n export const insertSegmentNode = trie.insert\n export const removeSegmentNode = trie.remove"
        },
        {
            "sha": "83e5180ada9a5136863409838547febb1000151c",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 18,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/f8add0d9ffadf0287542eb19421fbcb918a5f861/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f8add0d9ffadf0287542eb19421fbcb918a5f861/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=f8add0d9ffadf0287542eb19421fbcb918a5f861",
            "patch": "@@ -26,44 +26,42 @@ describe('segment-explorer', () => {\n   it('should render the segment explorer for parallel routes', async () => {\n     const browser = await next.browser('/parallel-routes')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"applayout.tsx\n-     parallel-routeslayout.tsx\n-     parallel-routespage.tsx\n-     @barlayout.tsx\n-     @barpage.tsx\n-     @foolayout.tsx\n-     @foopage.tsx\"\n+     \"app/layout.tsx\n+     parallel-routes/layout.tsx\n+     parallel-routes/page.tsx\n+     @bar/layout.tsx\n+     @bar/page.tsx\n+     @foo/layout.tsx\n+     @foo/page.tsx\"\n     `)\n   })\n \n   it('should render the segment explorer for nested routes', async () => {\n     const browser = await next.browser('/blog/~/grid')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"applayout.tsx\n-     (v2)layout.tsx\n-     (team)layout.tsx\n-     (overview)layout.tsx\n-     gridpage.tsx\"\n+     \"app/layout.tsx\n+     (v2)/layout.tsx\n+     (team)/layout.tsx\n+     (overview)/layout.tsx\n+     grid/page.tsx\"\n     `)\n   })\n \n   it('should cleanup on soft navigation', async () => {\n     const browser = await next.browser('/soft-navigation/a')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"applayout.tsx\n-     apage.tsx\"\n+     \"app/layout.tsx\n+     a/page.tsx\"\n     `)\n \n     await browser.elementByCss('[href=\"/soft-navigation/b\"]').click()\n     await retry(async () => {\n       expect(await browser.elementByCss('body').text()).toContain('Page B')\n     })\n \n-    // FIXME: Should no longer contain /soft-navigation/a/page.js\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"applayout.tsx\n-     apage.tsx\n-     bpage.tsx\"\n+     \"app/layout.tsx\n+     b/page.tsx\"\n     `)\n   })\n })"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 57,
        "deletions": 26
    }
}