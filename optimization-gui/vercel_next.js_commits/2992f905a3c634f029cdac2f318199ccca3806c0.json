{
    "author": "acdlite",
    "message": "Repeat fix in #78387 for routes without params (#78568)\n\nDepends on:\n- https://github.com/vercel/vercel/pull/13275\n\n---\n\nFollow up to #78387. When incremental PPR mode is enabled, we need to\ncreate a special \"inverse\" route to handle tree requests for every route\nin the manifest that doesn't have PPR enabled. #78387 fixed this for\n\"dynamic\" routes — which in the context of the relevant module I believe\nmeans routes with params, and has nothing to do with dynamic data in the\nPPR sense — but it didn't handle for \"static\" routes — which here means\nroutes without any params.\n\nThe fix is to apply the same logic in #78387 for all routes, both\n\"static\" and \"dynamic\", in the routes manifest.",
    "sha": "2992f905a3c634f029cdac2f318199ccca3806c0",
    "files": [
        {
            "sha": "65aeb2779d530b856723f02cce2843fdda2b5c67",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/2992f905a3c634f029cdac2f318199ccca3806c0/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2992f905a3c634f029cdac2f318199ccca3806c0/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=2992f905a3c634f029cdac2f318199ccca3806c0",
            "patch": "@@ -3539,13 +3539,14 @@ export default async function build(\n           await writeManifest(pagesManifestPath, pagesManifest)\n \n           if (config.experimental.clientSegmentCache) {\n-            for (const dynamicRoute of routesManifest.dynamicRoutes) {\n+            for (const route of [\n+              ...routesManifest.staticRoutes,\n+              ...routesManifest.dynamicRoutes,\n+            ]) {\n               // We only want to handle pages that are using the app router. We\n               // need this path in order to determine if it's an app route or an\n               // app page.\n-              const originalAppPath = pageInfos.get(\n-                dynamicRoute.page\n-              )?.originalAppPath\n+              const originalAppPath = pageInfos.get(route.page)?.originalAppPath\n               if (!originalAppPath) {\n                 continue\n               }\n@@ -3558,7 +3559,7 @@ export default async function build(\n               // We don't need to add the prefetch segment data routes if it was\n               // added due to a page that was already generated. This would have\n               // happened if the page was static or partially static.\n-              if (dynamicRoute.prefetchSegmentDataRoutes) {\n+              if (route.prefetchSegmentDataRoutes) {\n                 continue\n               }\n \n@@ -3567,9 +3568,9 @@ export default async function build(\n               // with other dynamic routes for the prefetch segment\n               // routes. This is only an issue for pages that do not have\n               // partial prerendering enabled.\n-              dynamicRoute.prefetchSegmentDataRoutes = [\n+              route.prefetchSegmentDataRoutes = [\n                 buildInversePrefetchSegmentDataRoute(\n-                  dynamicRoute.page,\n+                  route.page,\n                   // We use the special segment path of `/_tree` because it's\n                   // the first one sent by the client router so it's the only\n                   // one we need to rewrite to the regular prefetch RSC route."
        },
        {
            "sha": "b2b537ebca2f788076d8f6e90c77c7b14fb7f98c",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/prefetch-tests/[id]/page.jsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2F%5Bid%5D%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2F%5Bid%5D%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2F%5Bid%5D%2Fpage.jsx?ref=2992f905a3c634f029cdac2f318199ccca3806c0",
            "patch": "@@ -0,0 +1,9 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+\n+  return <div>/prefetch-tests/[id]</div>\n+}\n+\n+export const experimental_ppr = true"
        },
        {
            "sha": "9eb3f10e14e93aa674c90e8bf397ca31829a4f0a",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/prefetch-tests/dynamic/page.jsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Fdynamic%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Fdynamic%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Fdynamic%2Fpage.jsx?ref=2992f905a3c634f029cdac2f318199ccca3806c0",
            "patch": "@@ -0,0 +1,7 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+\n+  return <div>/prefetch-tests/dynamic</div>\n+}"
        },
        {
            "sha": "484952a22bcbe94c317fbc1aacc0fd5b60ea42b6",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/prefetch-tests/layout.jsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Flayout.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Flayout.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Flayout.jsx?ref=2992f905a3c634f029cdac2f318199ccca3806c0",
            "patch": "@@ -0,0 +1,7 @@\n+export default function RootLayout({ children, params }) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "baa9f6289f21c5658a89931f4a7a19247d8388bf",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/app/prefetch-tests/page.jsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Fpage.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Fpage.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fapp%2Fprefetch-tests%2Fpage.jsx?ref=2992f905a3c634f029cdac2f318199ccca3806c0",
            "patch": "@@ -0,0 +1,9 @@\n+import Link from 'next/link'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <Link href=\"/prefetch-tests/dynamic\">Dynamic</Link>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "b1f11bb31332f847b3b9cf62149f18a871efd03c",
            "filename": "test/e2e/app-dir/segment-cache/conflicting-routes/conflicting-routes.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2992f905a3c634f029cdac2f318199ccca3806c0/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fconflicting-routes%2Fconflicting-routes.test.ts?ref=2992f905a3c634f029cdac2f318199ccca3806c0",
            "patch": "@@ -30,4 +30,28 @@ describe('conflicting routes', () => {\n       )\n     }\n   })\n+\n+  it('matches the right route when the original route has no dynamic params, is dynamic, and PPR is disabled', async () => {\n+    if (isNextDeploy) {\n+      // TODO: Temporarily disabled until corresponding fix in Vercel builder\n+      // (https://github.com/vercel/vercel/pull/13275) is released.\n+      return\n+    }\n+\n+    const res = await next.fetch('/prefetch-tests/dynamic', {\n+      headers: {\n+        RSC: '1',\n+        'Next-Router-Prefetch': '1',\n+        'Next-Router-Segment-Prefetch': '/_tree',\n+      },\n+    })\n+\n+    expect(res.status).toBe(200)\n+\n+    if (isNextDeploy) {\n+      expect(res.headers.get('x-matched-path')).toBe(\n+        '/prefetch-tests/dynamic.prefetch.rsc'\n+      )\n+    }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 71,
        "additions": 64,
        "deletions": 7
    }
}