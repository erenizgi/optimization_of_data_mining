{
    "author": "mischnic",
    "message": "Fix flakey multiple-lockfiles tests (#83103)\n\nWriting to `join(next.testDir, '../package-lock.json')` breaks test isolation.",
    "sha": "589065d7884456180b991d4bd57da0e5bdb7fbff",
    "files": [
        {
            "sha": "7db06de94543faf538d7da7222a212a6bbacac62",
            "filename": "test/development/project-directory-with-styled-jsx-suffix/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Fdevelopment%2Fproject-directory-with-styled-jsx-suffix%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Fdevelopment%2Fproject-directory-with-styled-jsx-suffix%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fproject-directory-with-styled-jsx-suffix%2Findex.test.ts?ref=589065d7884456180b991d4bd57da0e5bdb7fbff",
            "patch": "@@ -14,7 +14,7 @@ describe('project directory with styled-jsx suffix', () => {\n           } \n         `,\n       },\n-      dirSuffix: '-styled-jsx',\n+      subDir: 'test-styled-jsx',\n     })\n   })\n   afterAll(() => next.destroy())"
        },
        {
            "sha": "933ab5a69eed8a201051c85a6e6f7db244f1232b",
            "filename": "test/e2e/app-dir/multiple-lockfiles/multiple-lockfiles-with-output-file-tracing-root.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-output-file-tracing-root.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-output-file-tracing-root.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-output-file-tracing-root.test.ts?ref=589065d7884456180b991d4bd57da0e5bdb7fbff",
            "patch": "@@ -1,5 +1,4 @@\n import { join } from 'path'\n-import { unlink } from 'fs/promises'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n \n describe('multiple-lockfiles - has-output-file-tracing-root', () => {\n@@ -16,18 +15,15 @@ describe('multiple-lockfiles - has-output-file-tracing-root', () => {\n         lockfileVersion: 3,\n       }),\n     },\n+    // So that ../package-lock.json doesn't leave the isolated testDir\n+    subDir: 'test',\n     skipDeployment: true,\n   })\n \n   if (skipped) {\n     return\n   }\n \n-  afterAll(async () => {\n-    // Cleanup to ensure it doesn't affect other tests.\n-    await unlink(join(next.testDir, '../package-lock.json'))\n-  })\n-\n   it('should not have multiple lockfiles warnings', async () => {\n     expect(next.cliOutput).not.toMatch(\n       /We detected multiple lockfiles and selected the directory of .+ as the root directory\\./"
        },
        {
            "sha": "8ba93d06e3aa99d67d6686fee4fbe5f69b5d3494",
            "filename": "test/e2e/app-dir/multiple-lockfiles/multiple-lockfiles-with-turbo-root.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-turbo-root.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-turbo-root.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles-with-turbo-root.test.ts?ref=589065d7884456180b991d4bd57da0e5bdb7fbff",
            "patch": "@@ -1,5 +1,4 @@\n import { join } from 'path'\n-import { unlink } from 'fs/promises'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n \n describe('multiple-lockfiles - has-turbo-root', () => {\n@@ -16,18 +15,15 @@ describe('multiple-lockfiles - has-turbo-root', () => {\n         lockfileVersion: 3,\n       }),\n     },\n+    // So that ../package-lock.json doesn't leave the isolated testDir\n+    subDir: 'test',\n     skipDeployment: true,\n   })\n \n   if (skipped) {\n     return\n   }\n \n-  afterAll(async () => {\n-    // Cleanup to ensure it doesn't affect other tests.\n-    await unlink(join(next.testDir, '../package-lock.json'))\n-  })\n-\n   it('should not have multiple lockfiles warnings', async () => {\n     expect(next.cliOutput).not.toMatch(\n       /We detected multiple lockfiles and selected the directory of .+ as the root directory\\./"
        },
        {
            "sha": "3d8b032d451e84f175b7cd305c95e51838c0b95e",
            "filename": "test/e2e/app-dir/multiple-lockfiles/multiple-lockfiles.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts?ref=589065d7884456180b991d4bd57da0e5bdb7fbff",
            "patch": "@@ -1,5 +1,4 @@\n import { join } from 'path'\n-import { unlink } from 'fs/promises'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n \n describe('multiple-lockfiles', () => {\n@@ -14,18 +13,15 @@ describe('multiple-lockfiles', () => {\n         lockfileVersion: 3,\n       }),\n     },\n+    // So that ../package-lock.json doesn't leave the isolated testDir\n+    subDir: 'test',\n     skipDeployment: true,\n   })\n \n   if (skipped) {\n     return\n   }\n \n-  afterAll(async () => {\n-    // Cleanup to ensure it doesn't affect other tests.\n-    await unlink(join(next.testDir, '../package-lock.json'))\n-  })\n-\n   it('should have multiple lockfiles warnings', async () => {\n     expect(next.cliOutput).toMatch(\n       /We detected multiple lockfiles and selected the directory of .+ as the root directory\\./"
        },
        {
            "sha": "aece83ee6e6a3801a9d83117974e09c27f0249cf",
            "filename": "test/lib/create-next-install.js",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Flib%2Fcreate-next-install.js",
            "raw_url": "https://github.com/vercel/next.js/raw/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Flib%2Fcreate-next-install.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fcreate-next-install.js?ref=589065d7884456180b991d4bd57da0e5bdb7fbff",
            "patch": "@@ -39,7 +39,7 @@ async function installDependencies(cwd, tmpDir) {\n  * @param {object | null} [param0.resolutions]\n  * @param { ((ctx: { dependencies: { [key: string]: string } }) => string) | string | null} [param0.installCommand]\n  * @param {object} [param0.packageJson]\n- * @param {string} [param0.dirSuffix]\n+ * @param {string} [param0.subDir]\n  * @param {boolean} [param0.keepRepoDir]\n  * @param {(span: import('@next/telemetry').Span, installDir: string) => Promise<void>} param0.beforeInstall\n  * @returns {Promise<{installDir: string, pkgPaths: Map<string, string>, tmpRepoDir: string | undefined}>}\n@@ -50,7 +50,7 @@ async function createNextInstall({\n   resolutions = null,\n   installCommand = null,\n   packageJson = {},\n-  dirSuffix = '',\n+  subDir = '',\n   keepRepoDir = false,\n   beforeInstall,\n }) {\n@@ -62,7 +62,8 @@ async function createNextInstall({\n       const origRepoDir = path.join(__dirname, '../../')\n       const installDir = path.join(\n         tmpDir,\n-        `next-install-${randomBytes(32).toString('hex')}${dirSuffix}`\n+        `next-install-${randomBytes(32).toString('hex')}`,\n+        subDir\n       )\n       let tmpRepoDir\n       require('console').log('Creating next instance in:')\n@@ -77,7 +78,8 @@ async function createNextInstall({\n       } else {\n         tmpRepoDir = path.join(\n           tmpDir,\n-          `next-repo-${randomBytes(32).toString('hex')}${dirSuffix}`\n+          `next-repo-${randomBytes(32).toString('hex')}`,\n+          subDir\n         )\n         require('console').log('Creating temp repo dir', tmpRepoDir)\n "
        },
        {
            "sha": "ff6dc506b3966a0174fe356718e838a0a742203b",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/589065d7884456180b991d4bd57da0e5bdb7fbff/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=589065d7884456180b991d4bd57da0e5bdb7fbff",
            "patch": "@@ -40,7 +40,7 @@ export interface NextInstanceOpts {\n   startCommand?: string\n   startArgs?: string[]\n   env?: Record<string, string>\n-  dirSuffix?: string\n+  subDir?: string\n   turbo?: boolean\n   forcedPort?: string\n   serverReadyPattern?: RegExp\n@@ -85,7 +85,7 @@ export class NextInstance {\n   protected basePath?: string\n   public env: Record<string, string>\n   public forcedPort?: string\n-  public dirSuffix: string = ''\n+  public subDir: string = ''\n   public startServerTimeout: number = 10_000 // 10 seconds\n   public serverReadyPattern: RegExp = / âœ“ Ready in /\n   patchFileDelay: number = 0\n@@ -201,9 +201,8 @@ export class NextInstance {\n           : process.env.NEXT_TEST_DIR || (await fs.realpath(os.tmpdir()))\n         this.testDir = path.join(\n           tmpDir,\n-          `next-test-${Date.now()}-${(Math.random() * 1000) | 0}${\n-            this.dirSuffix\n-          }`\n+          `next-test-${Date.now()}-${(Math.random() * 1000) | 0}`,\n+          this.subDir\n         )\n \n         const reactVersion =\n@@ -273,7 +272,7 @@ export class NextInstance {\n               resolutions: this.resolutions ?? null,\n               installCommand: this.installCommand,\n               packageJson: this.packageJson,\n-              dirSuffix: this.dirSuffix,\n+              subDir: this.subDir,\n               keepRepoDir: true,\n               beforeInstall: async (span, installDir) => {\n                 this.testDir = installDir"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 18,
        "deletions": 29
    }
}