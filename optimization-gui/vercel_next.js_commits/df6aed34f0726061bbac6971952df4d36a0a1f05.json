{
    "author": "Cy-Tek",
    "message": "fix(Turbopack): Add better error messaging for when we can't determine Next.js root (#83918)\n\n## Improve error message when Next.js package can't be found\n\n### What?\nEnhances the `get_next_package` function to provide a more informative\nerror message when the Next.js package cannot be found from the context\ndirectory.\n\n### Why?\nWhen users encounter issues with Next.js package resolution, the\nprevious generic error message \"Next.js package not found\" didn't\nprovide enough context or guidance on how to fix the problem. The\nimproved error message explains potential causes and solutions.\n\n### How?\n- Updated the function to use Vc<FileSystemPath> for context_directory\n- Improved error handling with a detailed message that:\n  - Explains the issue clearly\n  - Shows the context directory path where resolution failed\n  - Suggests setting `turbopack.root` in the Next.js config\n  - Mentions potential issues with symlinks\n  - Provides a link to documentation for more information\n\n### How to Test\n\nTo test this, \n1. Modify `<projectRoot>/bench/basic-app/next.config.js` to \n    ```js\n    module.exports = {\n      experimental: {\n        serverMinification: true,\n      },\n      turbopack: {\n        root: __dirname,\n      }\n    }\n    ```\n2. Run `pnpm build && pnpm swc-build-native` to ensure that you have the\nupdated code\n3. Run `pnpm next dev --turbo bench/basic-app` and ensure the error\nshows up exactly once\n4. Run `pnpm next build --turbo bench/basic-app` and ensure the same\nerror shows up exactly once\n\n---------\n\nCo-authored-by: Niklas Mischkulnig <4586894+mischnic@users.noreply.github.com>\nCo-authored-by: Luke Sandberg <lukeisandberg@gmail.com>",
    "sha": "df6aed34f0726061bbac6971952df4d36a0a1f05",
    "files": [
        {
            "sha": "295f979db212bc6d071a9069e25803fcca983873",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 28,
            "deletions": 17,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -69,7 +69,7 @@ use crate::{\n         },\n         utils::{\n             DetachedVc, NapiDiagnostic, NapiIssue, RootTask, TurbopackResult, get_diagnostics,\n-            get_issues, subscribe,\n+            get_issues, strongly_consistent_catch_collectables, subscribe,\n         },\n     },\n     util::DhatProfilerGuard,\n@@ -847,7 +847,7 @@ impl NapiEntrypoints {\n \n #[turbo_tasks::value(serialization = \"none\")]\n struct EntrypointsWithIssues {\n-    entrypoints: ReadRef<EntrypointsOperation>,\n+    entrypoints: Option<ReadRef<EntrypointsOperation>>,\n     issues: Arc<Vec<ReadRef<PlainIssue>>>,\n     diagnostics: Arc<Vec<ReadRef<PlainDiagnostic>>>,\n     effects: Arc<Effects>,\n@@ -859,10 +859,8 @@ async fn get_entrypoints_with_issues_operation(\n ) -> Result<Vc<EntrypointsWithIssues>> {\n     let entrypoints_operation =\n         EntrypointsOperation::new(project_container_entrypoints_operation(container));\n-    let entrypoints = entrypoints_operation.read_strongly_consistent().await?;\n-    let issues = get_issues(entrypoints_operation).await?;\n-    let diagnostics = get_diagnostics(entrypoints_operation).await?;\n-    let effects = Arc::new(get_effects(entrypoints_operation).await?);\n+    let (entrypoints, issues, diagnostics, effects) =\n+        strongly_consistent_catch_collectables(entrypoints_operation).await?;\n     Ok(EntrypointsWithIssues {\n         entrypoints,\n         issues,\n@@ -883,7 +881,7 @@ fn project_container_entrypoints_operation(\n \n #[turbo_tasks::value(serialization = \"none\")]\n struct AllWrittenEntrypointsWithIssues {\n-    entrypoints: Option<ReadRef<Entrypoints>>,\n+    entrypoints: Option<ReadRef<EntrypointsOperation>>,\n     issues: Arc<Vec<ReadRef<PlainIssue>>>,\n     diagnostics: Arc<Vec<ReadRef<PlainDiagnostic>>>,\n     effects: Arc<Effects>,\n@@ -894,7 +892,7 @@ struct AllWrittenEntrypointsWithIssues {\n pub async fn project_write_all_entrypoints_to_disk(\n     #[napi(ts_arg_type = \"{ __napiType: \\\"Project\\\" }\")] project: External<ProjectInstance>,\n     app_dir_only: bool,\n-) -> napi::Result<TurbopackResult<NapiEntrypoints>> {\n+) -> napi::Result<TurbopackResult<Option<NapiEntrypoints>>> {\n     let ctx = &project.turbopack_ctx;\n     let container = project.container;\n     let tt = ctx.turbo_tasks();\n@@ -905,7 +903,7 @@ pub async fn project_write_all_entrypoints_to_disk(\n                 get_all_written_entrypoints_with_issues_operation(container, app_dir_only);\n \n             // Read and compile the files\n-            let EntrypointsWithIssues {\n+            let AllWrittenEntrypointsWithIssues {\n                 entrypoints,\n                 issues,\n                 diagnostics,\n@@ -923,7 +921,14 @@ pub async fn project_write_all_entrypoints_to_disk(\n         .await?;\n \n     Ok(TurbopackResult {\n-        result: NapiEntrypoints::from_entrypoints_op(&entrypoints, &project.turbopack_ctx)?,\n+        result: if let Some(entrypoints) = entrypoints {\n+            Some(NapiEntrypoints::from_entrypoints_op(\n+                &entrypoints,\n+                &project.turbopack_ctx,\n+            )?)\n+        } else {\n+            None\n+        },\n         issues: issues.iter().map(|i| NapiIssue::from(&**i)).collect(),\n         diagnostics: diags.iter().map(|d| NapiDiagnostic::from(d)).collect(),\n     })\n@@ -933,16 +938,14 @@ pub async fn project_write_all_entrypoints_to_disk(\n async fn get_all_written_entrypoints_with_issues_operation(\n     container: ResolvedVc<ProjectContainer>,\n     app_dir_only: bool,\n-) -> Result<Vc<EntrypointsWithIssues>> {\n+) -> Result<Vc<AllWrittenEntrypointsWithIssues>> {\n     let entrypoints_operation = EntrypointsOperation::new(all_entrypoints_write_to_disk_operation(\n         container,\n         app_dir_only,\n     ));\n-    let entrypoints = entrypoints_operation.read_strongly_consistent().await?;\n-    let issues = get_issues(entrypoints_operation).await?;\n-    let diagnostics = get_diagnostics(entrypoints_operation).await?;\n-    let effects = Arc::new(get_effects(entrypoints_operation).await?);\n-    Ok(EntrypointsWithIssues {\n+    let (entrypoints, issues, diagnostics, effects) =\n+        strongly_consistent_catch_collectables(entrypoints_operation).await?;\n+    Ok(AllWrittenEntrypointsWithIssues {\n         entrypoints,\n         issues,\n         diagnostics,\n@@ -1016,16 +1019,24 @@ pub fn project_entrypoints_subscribe(\n                 } = &*entrypoints_with_issues_op\n                     .read_strongly_consistent()\n                     .await?;\n+\n                 effects.apply().await?;\n                 Ok((entrypoints.clone(), issues.clone(), diagnostics.clone()))\n             }\n             .instrument(tracing::info_span!(\"entrypoints subscription\"))\n         },\n         move |ctx| {\n             let (entrypoints, issues, diags) = ctx.value;\n+            let result = match entrypoints {\n+                Some(entrypoints) => Some(NapiEntrypoints::from_entrypoints_op(\n+                    &entrypoints,\n+                    &turbopack_ctx,\n+                )?),\n+                None => None,\n+            };\n \n             Ok(vec![TurbopackResult {\n-                result: NapiEntrypoints::from_entrypoints_op(&entrypoints, &turbopack_ctx)?,\n+                result,\n                 issues: issues\n                     .iter()\n                     .map(|issue| NapiIssue::from(&**issue))"
        },
        {
            "sha": "7217b7e890f72ec353f62c598d16e057812ed14c",
            "filename": "crates/next-api/src/module_graph.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -490,7 +490,7 @@ impl Issue for CssGlobalImportIssue {\n     }\n \n     fn severity(&self) -> IssueSeverity {\n-        IssueSeverity::Error\n+        IssueSeverity::Fatal\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "c78a83b464818230c7a551231e3dcb6f0460f217",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 68,
            "deletions": 2,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -5,8 +5,9 @@ use either::Either;\n use rustc_hash::FxHashMap;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{FxIndexMap, ResolvedVc, Vc, fxindexmap};\n-use turbo_tasks_fs::{FileSystem, FileSystemPath};\n+use turbo_tasks_fs::{FileSystem, FileSystemPath, to_sys_path};\n use turbopack_core::{\n+    issue::{Issue, IssueExt, IssueSeverity, IssueStage, StyledString},\n     reference_type::{CommonJsReferenceSubType, ReferenceType},\n     resolve::{\n         AliasPattern, ExternalTraced, ExternalType, ResolveAliasMap, SubpathValue,\n@@ -1240,20 +1241,85 @@ pub async fn get_next_package(context_directory: FileSystemPath) -> Result<FileS\n         .context(\"Next.js package not found\")\n }\n \n+#[turbo_tasks::value(shared)]\n+struct MissingNextFolderIssue {\n+    path: FileSystemPath,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl Issue for MissingNextFolderIssue {\n+    #[turbo_tasks::function]\n+    fn file_path(&self) -> Vc<FileSystemPath> {\n+        self.path.clone().cell()\n+    }\n+\n+    fn severity(&self) -> IssueSeverity {\n+        IssueSeverity::Fatal\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn stage(&self) -> Vc<IssueStage> {\n+        IssueStage::Resolve.into()\n+    }\n+\n+    #[turbo_tasks::function]\n+    async fn title(&self) -> Result<Vc<StyledString>> {\n+        let system_path = match to_sys_path(self.path.clone()).await? {\n+            Some(path) => path.to_str().unwrap_or(\"{unknown}\").to_string(),\n+            _ => \"{unknown}\".to_string(),\n+        };\n+\n+        Ok(StyledString::Stack(vec![\n+            StyledString::Line(vec![\n+                StyledString::Text(\n+                    \"Error: Next.js inferred your workspace root, but it may not be correct.\".into(),\n+                ),\n+            ]),\n+            StyledString::Line(vec![\n+                StyledString::Text(\"We couldn't find the Next.js package (\".into()),\n+                StyledString::Strong(\"next/package.json\".into()),\n+                StyledString::Text(\") from the project directory: \".into()),\n+                StyledString::Strong(system_path.into()),\n+            ]),\n+            StyledString::Line(vec![\n+                StyledString::Text(\" To fix this, set \".into()),\n+                StyledString::Code(\"turbopack.root\".into()),\n+                StyledString::Text(\n+                    \" in your Next.js config, or ensure the Next.js package is resolvable from this directory.\".into(),\n+                ),\n+            ]),\n+            StyledString::Line(vec![\n+                StyledString::Text(\"Note: For security and performance reasons, files outside of the project directory will not be compiled.\".into()),\n+            ]),\n+            StyledString::Line(vec![\n+                StyledString::Text(\"See \".into()),\n+                StyledString::Strong(\"https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack#root-directory\".into()),\n+                StyledString::Text(\" for more information.\".into())\n+            ]),\n+        ])\n+            .cell())\n+    }\n+}\n+\n #[turbo_tasks::function]\n pub async fn try_get_next_package(\n     context_directory: FileSystemPath,\n ) -> Result<Vc<OptionFileSystemPath>> {\n     let root = context_directory.root().owned().await?;\n     let result = resolve(\n-        context_directory,\n+        context_directory.clone(),\n         ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined),\n         Request::parse(Pattern::Constant(rcstr!(\"next/package.json\"))),\n         node_cjs_resolve_options(root),\n     );\n     if let Some(source) = &*result.first_source().await? {\n         Ok(Vc::cell(Some(source.ident().path().await?.parent())))\n     } else {\n+        MissingNextFolderIssue {\n+            path: context_directory,\n+        }\n+        .resolved_cell()\n+        .emit();\n         Ok(Vc::cell(None))\n     }\n }"
        },
        {
            "sha": "97042dcb375b874c8ac7e94aa1617edfeb87e6d1",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -850,5 +850,6 @@\n   \"849\": \"Route %s with \\\\`dynamic = \\\"error\\\"\\\\` couldn't be rendered statically because it used \\\\`cookies()\\\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering\",\n   \"850\": \"metadataBase is not a valid URL: %s\",\n   \"851\": \"Pass either `webpack` or `turbopack`, not both.\",\n-  \"852\": \"Only custom servers can pass `webpack`, `turbo`, or `turbopack`.\"\n+  \"852\": \"Only custom servers can pass `webpack`, `turbo`, or `turbopack`.\",\n+  \"853\": \"Turbopack build failed\"\n }"
        },
        {
            "sha": "37aae2c1808e7a011422eefb3d2fdbd224ccd625",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 8,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -658,24 +658,42 @@ function bindingToApi(\n \n     async writeAllEntrypointsToDisk(\n       appDirOnly: boolean\n-    ): Promise<TurbopackResult<RawEntrypoints>> {\n+    ): Promise<TurbopackResult<Partial<RawEntrypoints>>> {\n       const napiEndpoints = (await binding.projectWriteAllEntrypointsToDisk(\n         this._nativeProject,\n         appDirOnly\n-      )) as TurbopackResult<NapiEntrypoints>\n+      )) as TurbopackResult<Partial<NapiEntrypoints>>\n \n-      return napiEntrypointsToRawEntrypoints(napiEndpoints)\n+      if ('routes' in napiEndpoints) {\n+        return napiEntrypointsToRawEntrypoints(\n+          napiEndpoints as TurbopackResult<NapiEntrypoints>\n+        )\n+      } else {\n+        return {\n+          issues: napiEndpoints.issues,\n+          diagnostics: napiEndpoints.diagnostics,\n+        }\n+      }\n     }\n \n     entrypointsSubscribe() {\n-      const subscription = subscribe<TurbopackResult<NapiEntrypoints>>(\n+      const subscription = subscribe<TurbopackResult<NapiEntrypoints | {}>>(\n         false,\n         async (callback) =>\n           binding.projectEntrypointsSubscribe(this._nativeProject, callback)\n       )\n       return (async function* () {\n         for await (const entrypoints of subscription) {\n-          yield napiEntrypointsToRawEntrypoints(entrypoints)\n+          if ('routes' in (entrypoints as TurbopackResult<NapiEntrypoints>)) {\n+            yield napiEntrypointsToRawEntrypoints(\n+              entrypoints as TurbopackResult<NapiEntrypoints>\n+            )\n+          } else {\n+            yield {\n+              issues: entrypoints.issues,\n+              diagnostics: entrypoints.diagnostics,\n+            } as TurbopackResult<{}>\n+          }\n         }\n       })()\n     }\n@@ -766,7 +784,7 @@ function bindingToApi(\n       )) as TurbopackResult<WrittenEndpoint>\n     }\n \n-    async clientChanged(): Promise<AsyncIterableIterator<TurbopackResult<{}>>> {\n+    async clientChanged(): Promise<AsyncIterableIterator<TurbopackResult>> {\n       const clientSubscription = subscribe<TurbopackResult>(\n         false,\n         async (callback) =>\n@@ -778,7 +796,7 @@ function bindingToApi(\n \n     async serverChanged(\n       includeIssues: boolean\n-    ): Promise<AsyncIterableIterator<TurbopackResult<{}>>> {\n+    ): Promise<AsyncIterableIterator<TurbopackResult>> {\n       const serverSubscription = subscribe<TurbopackResult>(\n         false,\n         async (callback) =>\n@@ -1023,12 +1041,13 @@ function bindingToApi(\n             type: 'conflict',\n           }\n           break\n-        default:\n+        default: {\n           const _exhaustiveCheck: never = routeType\n           invariant(\n             nativeRoute,\n             () => `Unknown route type: ${_exhaustiveCheck}`\n           )\n+        }\n       }\n       routes.set(pathname, route)\n     }"
        },
        {
            "sha": "32aa57ebbc3a79e6c11bd8ab7192b6a36f9699d6",
            "filename": "packages/next/src/build/swc/types.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -225,9 +225,11 @@ export interface Project {\n \n   writeAllEntrypointsToDisk(\n     appDirOnly: boolean\n-  ): Promise<TurbopackResult<RawEntrypoints>>\n+  ): Promise<TurbopackResult<Partial<RawEntrypoints>>>\n \n-  entrypointsSubscribe(): AsyncIterableIterator<TurbopackResult<RawEntrypoints>>\n+  entrypointsSubscribe(): AsyncIterableIterator<\n+    TurbopackResult<RawEntrypoints | {}>\n+  >\n \n   hmrEvents(identifier: string): AsyncIterableIterator<TurbopackResult<Update>>\n "
        },
        {
            "sha": "1254a495c9133495f787b3752b2e8e417a6752ea",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 43,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -1,15 +1,11 @@\n import path from 'path'\n import { validateTurboNextConfig } from '../../lib/turbopack-warning'\n-import {\n-  formatIssue,\n-  isPersistentCachingEnabledForBuild,\n-  isRelevantWarning,\n-} from '../../shared/lib/turbopack/utils'\n+import { isPersistentCachingEnabledForBuild } from '../../shared/lib/turbopack/utils'\n import { NextBuildContext } from '../build-context'\n import { createDefineEnv, loadBindings } from '../swc'\n import {\n-  rawEntrypointsToEntrypoints,\n   handleRouteType,\n+  rawEntrypointsToEntrypoints,\n } from '../handle-entrypoints'\n import { TurbopackManifestLoader } from '../../shared/lib/turbopack/manifest-loader'\n import { promises as fs } from 'fs'\n@@ -20,8 +16,9 @@ import { Telemetry } from '../../telemetry/storage'\n import { setGlobal } from '../../trace'\n import { isCI } from '../../server/ci-info'\n import { backgroundLogCompilationEvents } from '../../shared/lib/turbopack/compilation-events'\n-import { getSupportedBrowsers } from '../utils'\n+import { getSupportedBrowsers, printBuildErrors } from '../utils'\n import { normalizePath } from '../../lib/normalize-path'\n+import type { RawEntrypoints, TurbopackResult } from '../swc/types'\n \n export async function turbopackBuild(): Promise<{\n   duration: number\n@@ -107,17 +104,22 @@ export async function turbopackBuild(): Promise<{\n     )\n \n     let appDirOnly = NextBuildContext.appDirOnly!\n-    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n     const entrypoints = await project.writeAllEntrypointsToDisk(appDirOnly)\n+    printBuildErrors(entrypoints, dev)\n+\n+    let routes = entrypoints.routes\n+    if (!routes) {\n+      // This should never ever happen, there should be an error issue, or the bindings call should\n+      // have thrown.\n+      throw new Error(`Turbopack build failed`)\n+    }\n \n-    const hasPagesEntries = Array.from(entrypoints.routes.values()).some(\n-      (route) => {\n-        if (route.type === 'page' || route.type === 'page-api') {\n-          return true\n-        }\n-        return false\n+    const hasPagesEntries = Array.from(routes.values()).some((route) => {\n+      if (route.type === 'page' || route.type === 'page-api') {\n+        return true\n       }\n-    )\n+      return false\n+    })\n     // If there's no pages entries, then we are in app-dir-only mode\n     if (!hasPagesEntries) {\n       appDirOnly = true\n@@ -129,35 +131,11 @@ export async function turbopackBuild(): Promise<{\n       encryptionKey,\n     })\n \n-    const topLevelErrors = []\n-    const topLevelWarnings = []\n-    for (const issue of entrypoints.issues) {\n-      if (issue.severity === 'error' || issue.severity === 'fatal') {\n-        topLevelErrors.push(formatIssue(issue))\n-      } else if (isRelevantWarning(issue)) {\n-        topLevelWarnings.push(formatIssue(issue))\n-      }\n-    }\n-\n-    if (topLevelWarnings.length > 0) {\n-      console.warn(\n-        `Turbopack build encountered ${\n-          topLevelWarnings.length\n-        } warnings:\\n${topLevelWarnings.join('\\n')}`\n-      )\n-    }\n-\n-    if (topLevelErrors.length > 0) {\n-      throw new Error(\n-        `Turbopack build failed with ${\n-          topLevelErrors.length\n-        } errors:\\n${topLevelErrors.join('\\n')}`\n-      )\n-    }\n-\n-    const currentEntrypoints = await rawEntrypointsToEntrypoints(entrypoints)\n+    const currentEntrypoints = await rawEntrypointsToEntrypoints(\n+      entrypoints as TurbopackResult<RawEntrypoints>\n+    )\n \n-    const promises: Promise<any>[] = []\n+    const promises: Promise<void>[] = []\n \n     if (!appDirOnly) {\n       for (const [page, route] of currentEntrypoints.page) {"
        },
        {
            "sha": "c47c6fb20e2c6cb5f6ef9e1c4107ad46338b3419",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 80,
            "deletions": 13,
            "changes": 93,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -1,19 +1,28 @@\n import type { NextConfigComplete } from '../server/config-shared'\n import type { ExperimentalPPRConfig } from '../server/lib/experimental/ppr'\n+import { checkIsRoutePPREnabled } from '../server/lib/experimental/ppr'\n import type { AssetBinding } from './webpack/loaders/get-module-build-info'\n import type { ServerRuntime } from '../types'\n import type { BuildManifest } from '../server/get-page-files'\n import type {\n+  CustomRoutes,\n+  Header,\n   Redirect,\n   Rewrite,\n-  Header,\n-  CustomRoutes,\n } from '../lib/load-custom-routes'\n import type {\n   EdgeFunctionDefinition,\n   MiddlewareManifest,\n } from './webpack/plugins/middleware-plugin'\n import type { WebpackLayerName } from '../lib/constants'\n+import {\n+  INSTRUMENTATION_HOOK_FILENAME,\n+  MIDDLEWARE_FILENAME,\n+  SERVER_PROPS_GET_INIT_PROPS_CONFLICT,\n+  SERVER_PROPS_SSG_CONFLICT,\n+  SSG_GET_INITIAL_PROPS_CONFLICT,\n+  WEBPACK_LAYERS,\n+} from '../lib/constants'\n import type {\n   AppPageModule,\n   AppPageRouteModule,\n@@ -24,21 +33,13 @@ import '../server/require-hook'\n import '../server/node-polyfill-crypto'\n import '../server/node-environment'\n \n-import { green, yellow, red, cyan, bold, underline } from '../lib/picocolors'\n+import { bold, cyan, green, red, underline, yellow } from '../lib/picocolors'\n import textTable from 'next/dist/compiled/text-table'\n import path from 'path'\n import { promises as fs } from 'fs'\n import { isValidElementType } from 'next/dist/compiled/react-is'\n import stripAnsi from 'next/dist/compiled/strip-ansi'\n import browserslist from 'next/dist/compiled/browserslist'\n-import {\n-  SSG_GET_INITIAL_PROPS_CONFLICT,\n-  SERVER_PROPS_GET_INIT_PROPS_CONFLICT,\n-  SERVER_PROPS_SSG_CONFLICT,\n-  MIDDLEWARE_FILENAME,\n-  INSTRUMENTATION_HOOK_FILENAME,\n-  WEBPACK_LAYERS,\n-} from '../lib/constants'\n import {\n   MODERN_BROWSERSLIST_TARGET,\n   UNDERSCORE_GLOBAL_ERROR_ROUTE,\n@@ -49,16 +50,15 @@ import { isDynamicRoute } from '../shared/lib/router/utils/is-dynamic'\n import { findPageFile } from '../server/lib/find-page-file'\n import { isEdgeRuntime } from '../lib/is-edge-runtime'\n import * as Log from './output/log'\n-import { loadComponents } from '../server/load-components'\n import type { LoadComponentsReturnType } from '../server/load-components'\n+import { loadComponents } from '../server/load-components'\n import { trace } from '../trace'\n import { setHttpClientAndAgentOptions } from '../server/setup-http-agent-env'\n import { Sema } from 'next/dist/compiled/async-sema'\n import { normalizePagePath } from '../shared/lib/page-path/normalize-page-path'\n import { getRuntimeContext } from '../server/web/sandbox'\n import { RouteKind } from '../server/route-kind'\n import type { PageExtensions } from './page-extensions-type'\n-import { checkIsRoutePPREnabled } from '../server/lib/experimental/ppr'\n import type { FallbackMode } from '../lib/fallback'\n import type { OutgoingHttpHeaders } from 'http'\n import type { AppSegmentConfig } from './segment-config/app/app-segment-config'\n@@ -72,6 +72,8 @@ import type { PrerenderedRoute } from './static-paths/types'\n import type { CacheControl } from '../server/lib/cache-control'\n import { formatExpire, formatRevalidate } from './output/format'\n import type { AppRouteRouteModule } from '../server/route-modules/app-route/module'\n+import { formatIssue, isRelevantWarning } from '../shared/lib/turbopack/utils'\n+import type { TurbopackResult } from './swc/types'\n \n export type ROUTER_TYPE = 'pages' | 'app'\n \n@@ -171,6 +173,71 @@ export function collectRoutesUsingEdgeRuntime(\n   return routesUsingEdgeRuntime\n }\n \n+/**\n+ * Processes and categorizes build issues, then logs them as warnings, errors, or fatal errors.\n+ * Stops execution if fatal issues are encountered.\n+ *\n+ * @param entrypoints - The result object containing build issues to process.\n+ * @param isDev - A flag indicating if the build is running in development mode.\n+ * @return This function does not return a value but logs or throws errors based on the issues.\n+ * @throws {Error} If a fatal issue is encountered, this function throws an error. In development mode, we only throw on\n+ *                 'fatal' and 'bug' issues. In production mode, we also throw on 'error' issues.\n+ */\n+export function printBuildErrors(\n+  entrypoints: TurbopackResult,\n+  isDev: boolean\n+): void {\n+  // Issues that we want to stop the server from executing\n+  const topLevelFatalIssues = []\n+  // Issues that are true errors, but we believe we can keep running and allow the user to address the issue\n+  const topLevelErrors = []\n+  // Issues that are warnings but should not affect the running of the build\n+  const topLevelWarnings = []\n+\n+  for (const issue of entrypoints.issues) {\n+    // We only want to completely shut down the server\n+    if (issue.severity === 'fatal' || issue.severity === 'bug') {\n+      topLevelFatalIssues.push(formatIssue(issue))\n+    } else if (isRelevantWarning(issue)) {\n+      topLevelWarnings.push(formatIssue(issue))\n+    } else if (issue.severity === 'error') {\n+      if (isDev) {\n+        // We want to treat errors as recoverable in development\n+        // so that we can show the errors in the site and allow users\n+        // to respond to the errors when necessary. In production builds\n+        // though we want to error out and stop the build process.\n+        topLevelErrors.push(formatIssue(issue))\n+      } else {\n+        topLevelFatalIssues.push(formatIssue(issue))\n+      }\n+    }\n+  }\n+  // TODO: print in order by source location so issues from the same file are displayed together and then add a summary at the end about the number of warnings/errors\n+  if (topLevelWarnings.length > 0) {\n+    console.warn(\n+      `Turbopack build encountered ${\n+        topLevelWarnings.length\n+      } warnings:\\n${topLevelWarnings.join('\\n')}`\n+    )\n+  }\n+\n+  if (topLevelErrors.length > 0) {\n+    console.error(\n+      `Turbopack build encountered ${\n+        topLevelErrors.length\n+      } errors:\\n${topLevelErrors.join('\\n')}`\n+    )\n+  }\n+\n+  if (topLevelFatalIssues.length > 0) {\n+    throw new Error(\n+      `Turbopack build failed with ${\n+        topLevelFatalIssues.length\n+      } errors:\\n${topLevelFatalIssues.join('\\n')}`\n+    )\n+  }\n+}\n+\n export async function printTreeView(\n   lists: {\n     pages: ReadonlyArray<string>"
        },
        {
            "sha": "b250003515598cb51d6a5c65eb27cd4bf34c2689",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 8,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -96,7 +96,7 @@ import { devIndicatorServerState } from './dev-indicator-server-state'\n import { getDisableDevIndicatorMiddleware } from '../../next-devtools/server/dev-indicator-middleware'\n import { getRestartDevServerMiddleware } from '../../next-devtools/server/restart-dev-server-middleware'\n import { backgroundLogCompilationEvents } from '../../shared/lib/turbopack/compilation-events'\n-import { getSupportedBrowsers } from '../../build/utils'\n+import { getSupportedBrowsers, printBuildErrors } from '../../build/utils'\n import {\n   receiveBrowserLogsTurbopack,\n   handleClientFileLogs,\n@@ -627,25 +627,34 @@ export async function createHotReloaderTurbopack(\n         )\n       }\n \n+      // Always process issues/diagnostics, even if there are no entrypoints yet\n+      processTopLevelIssues(currentTopLevelIssues, entrypoints)\n+\n+      // Certain crtical issues prevent any entrypoints from being constructed so return early\n+      if (!('routes' in entrypoints)) {\n+        printBuildErrors(entrypoints, true)\n+\n+        currentEntriesHandlingResolve!()\n+        currentEntriesHandlingResolve = undefined\n+        continue\n+      }\n+\n+      const routes = entrypoints.routes\n       const existingRoutes = [\n         ...currentEntrypoints.app.keys(),\n         ...currentEntrypoints.page.keys(),\n       ]\n-      const newRoutes = [...entrypoints.routes.keys()]\n+      const newRoutes = [...routes.keys()]\n \n       const addedRoutes = newRoutes.filter(\n         (route) =>\n           !currentEntrypoints.app.has(route) &&\n           !currentEntrypoints.page.has(route)\n       )\n-      const removedRoutes = existingRoutes.filter(\n-        (route) => !entrypoints.routes.has(route)\n-      )\n-\n-      processTopLevelIssues(currentTopLevelIssues, entrypoints)\n+      const removedRoutes = existingRoutes.filter((route) => !routes.has(route))\n \n       await handleEntrypoints({\n-        entrypoints,\n+        entrypoints: entrypoints as any,\n \n         currentEntrypoints,\n "
        },
        {
            "sha": "3bdbbf1079796c4f8c0e8441f8785dd01114ba00",
            "filename": "test/development/basic/next-rs-api.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/df6aed34f0726061bbac6971952df4d36a0a1f05/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df6aed34f0726061bbac6971952df4d36a0a1f05/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts?ref=df6aed34f0726061bbac6971952df4d36a0a1f05",
            "patch": "@@ -398,6 +398,10 @@ describe('next.rs api', () => {\n     const entrypointsSubscription = project.entrypointsSubscribe()\n     const entrypoints = await entrypointsSubscription.next()\n     expect(entrypoints.done).toBe(false)\n+    if (!('routes' in entrypoints.value)) {\n+      throw new Error('Entrypoints not available due to compilation errors')\n+    }\n+\n     expect(Array.from(entrypoints.value.routes.keys()).sort()).toEqual([\n       '/',\n       '/_not-found',\n@@ -487,9 +491,13 @@ describe('next.rs api', () => {\n     // eslint-disable-next-line no-loop-func\n     it(`should allow to write ${name} to disk`, async () => {\n       const entrypointsSubscribtion = project.entrypointsSubscribe()\n-      const entrypoints: TurbopackResult<RawEntrypoints> = (\n+      const entrypoints: TurbopackResult<RawEntrypoints | {}> = (\n         await entrypointsSubscribtion.next()\n       ).value\n+      if (!('routes' in entrypoints)) {\n+        throw new Error('Entrypoints not available due to compilation errors')\n+      }\n+\n       const route = entrypoints.routes.get(path)\n       entrypointsSubscribtion.return()\n \n@@ -546,7 +554,6 @@ describe('next.rs api', () => {\n         }\n         default: {\n           throw new Error('unknown route type')\n-          break\n         }\n       }\n     })\n@@ -623,9 +630,13 @@ describe('next.rs api', () => {\n         console.log('start')\n         await new Promise((r) => setTimeout(r, 1000))\n         const entrypointsSubscribtion = project.entrypointsSubscribe()\n-        const entrypoints: TurbopackResult<RawEntrypoints> = (\n+        const entrypoints: TurbopackResult<RawEntrypoints | {}> = (\n           await entrypointsSubscribtion.next()\n         ).value\n+        if (!('routes' in entrypoints)) {\n+          throw new Error('Entrypoints not available due to compilation errors')\n+        }\n+\n         const route = entrypoints.routes.get(path)\n         entrypointsSubscribtion.return()\n \n@@ -766,9 +777,13 @@ describe('next.rs api', () => {\n     console.log('start')\n     await new Promise((r) => setTimeout(r, 1000))\n     const entrypointsSubscribtion = project.entrypointsSubscribe()\n-    const entrypoints: TurbopackResult<RawEntrypoints> = (\n+    const entrypoints: TurbopackResult<RawEntrypoints | {}> = (\n       await entrypointsSubscribtion.next()\n     ).value\n+    if (!('routes' in entrypoints)) {\n+      throw new Error('Entrypoints not available due to compilation errors')\n+    }\n+\n     const route = entrypoints.routes.get('/')\n     entrypointsSubscribtion.return()\n "
        }
    ],
    "stats": {
        "total": 366,
        "additions": 267,
        "deletions": 99
    }
}