{
    "author": "mischnic",
    "message": "Turbopack: flush Node.js worker IPC on error (#84077)\n\nIf the Nodejs process exited too quickly after `sendError`, Turbopack never received the error message and then  previously crashed with panics such as \n```\n- Execution of PostCssTransformedAsset::process failed\n- creating new process\n- reading packet length\n- unexpected end of file\n```\n\nNow, flush the socket before calling `process.exit()`",
    "sha": "9cf9183e0090e0dd322f4604a21f00f00111db4c",
    "files": [
        {
            "sha": "d01d80cd708f39a3faa9bddadb2cf8f69d24682d",
            "filename": "turbopack/crates/turbopack-node/js/src/ipc/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9cf9183e0090e0dd322f4604a21f00f00111db4c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9cf9183e0090e0dd322f4604a21f00f00111db4c/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Fipc%2Findex.ts?ref=9cf9183e0090e0dd322f4604a21f00f00111db4c",
            "patch": "@@ -169,18 +169,20 @@ function createIpc<TIncoming, TOutgoing>(\n     sendReady,\n \n     async sendError(error: Error): Promise<never> {\n+      let failed = false\n       try {\n         await send({\n           type: 'error',\n           ...structuredError(error),\n         })\n       } catch (err) {\n+        // There's nothing we can do about errors that happen after this point, we can't tell anyone\n+        // about them.\n         console.error('failed to send error back to rust:', err)\n-        // ignore and exit anyway\n-        process.exit(1)\n+        failed = true\n       }\n-\n-      process.exit(0)\n+      await new Promise<void>((res) => socket.end(() => res()))\n+      process.exit(failed ? 1 : 0)\n     },\n   }\n }"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 6,
        "deletions": 4
    }
}