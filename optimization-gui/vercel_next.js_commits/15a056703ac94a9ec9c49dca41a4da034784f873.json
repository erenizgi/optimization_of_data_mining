{
    "author": "bgw",
    "message": "Turbopack: Remove undocumented legacy syntax for built-in conditions (e.g. foreign, browser) (#83068)\n\n- https://github.com/vercel/next.js/pull/82857 provides a better way to do this that we intend to document.\n- This syntax was never documented (outside of the types and tests). You wouldn't be able to figure out the built-in conditions without digging through the Turbopack source code.",
    "sha": "15a056703ac94a9ec9c49dca41a4da034784f873",
    "files": [
        {
            "sha": "ed9221b9b2bdcf1e34a87e8958cc2182533d6c71",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 44,
            "deletions": 100,
            "changes": 144,
            "blob_url": "https://github.com/vercel/next.js/blob/15a056703ac94a9ec9c49dca41a4da034784f873/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/15a056703ac94a9ec9c49dca41a4da034784f873/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=15a056703ac94a9ec9c49dca41a4da034784f873",
            "patch": "@@ -1,5 +1,3 @@\n-use std::{collections::BTreeSet, str::FromStr};\n-\n use anyhow::{Context, Result, bail};\n use either::Either;\n use rustc_hash::FxHashSet;\n@@ -667,21 +665,11 @@ impl TryFrom<ConfigConditionItem> for ConditionItem {\n     }\n }\n \n-#[derive(\n-    Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n-)]\n-#[serde(rename_all = \"camelCase\", untagged)]\n-pub enum RuleConfigItem {\n-    Options(RuleConfigItemOptions),\n-    LegacyConditional(FxIndexMap<RcStr, RuleConfigItem>),\n-    LegacyBoolean(bool),\n-}\n-\n #[derive(\n     Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n )]\n #[serde(rename_all = \"camelCase\")]\n-pub struct RuleConfigItemOptions {\n+pub struct RuleConfigItem {\n     pub loaders: Vec<LoaderItem>,\n     #[serde(default, alias = \"as\")]\n     pub rename_as: Option<RcStr>,\n@@ -1401,11 +1389,7 @@ impl NextConfig {\n     }\n \n     #[turbo_tasks::function]\n-    pub async fn webpack_rules(\n-        &self,\n-        active_conditions: BTreeSet<WebpackLoaderBuiltinCondition>,\n-        project_path: FileSystemPath,\n-    ) -> Result<Vc<WebpackRules>> {\n+    pub async fn webpack_rules(&self, project_path: FileSystemPath) -> Result<Vc<WebpackRules>> {\n         let Some(turbo_rules) = self.turbopack.as_ref().and_then(|t| t.rules.as_ref()) else {\n             return Ok(Vc::cell(Vec::new()));\n         };\n@@ -1429,43 +1413,6 @@ impl NextConfig {\n                         .collect(),\n                 )\n             }\n-            enum FindRuleResult<'a> {\n-                Found(&'a RuleConfigItemOptions),\n-                NotFound,\n-                Break,\n-            }\n-            // This logic is needed for the `LegacyConditional`/`LegacyBoolean` configuration\n-            // syntax. This is technically public syntax, but was never documented and it is\n-            // unlikely that anyone is depending on it (outside of some Next.js internals).\n-            fn find_rule<'a>(\n-                rule: &'a RuleConfigItem,\n-                active_conditions: &BTreeSet<WebpackLoaderBuiltinCondition>,\n-            ) -> FindRuleResult<'a> {\n-                match rule {\n-                    RuleConfigItem::Options(rule) => FindRuleResult::Found(rule),\n-                    RuleConfigItem::LegacyConditional(map) => {\n-                        for (condition, rule) in map.iter() {\n-                            let condition = WebpackLoaderBuiltinCondition::from_str(condition);\n-                            if let Ok(condition) = condition\n-                                && (condition == WebpackLoaderBuiltinCondition::Default\n-                                    || active_conditions.contains(&condition))\n-                            {\n-                                match find_rule(rule, active_conditions) {\n-                                    FindRuleResult::Found(rule) => {\n-                                        return FindRuleResult::Found(rule);\n-                                    }\n-                                    FindRuleResult::Break => {\n-                                        return FindRuleResult::Break;\n-                                    }\n-                                    FindRuleResult::NotFound => {}\n-                                }\n-                            }\n-                        }\n-                        FindRuleResult::NotFound\n-                    }\n-                    RuleConfigItem::LegacyBoolean(_) => FindRuleResult::Break,\n-                }\n-            }\n             let config_file_path = || project_path.join(&self.config_file_name);\n             for item in &rule_collection.0 {\n                 match item {\n@@ -1479,55 +1426,52 @@ impl NextConfig {\n                             },\n                         ));\n                     }\n-                    RuleConfigCollectionItem::Full(rule_config_item) => {\n-                        if let FindRuleResult::Found(RuleConfigItemOptions {\n-                            loaders,\n-                            rename_as,\n-                            condition,\n-                        }) = find_rule(rule_config_item, &active_conditions)\n+                    RuleConfigCollectionItem::Full(RuleConfigItem {\n+                        loaders,\n+                        rename_as,\n+                        condition,\n+                    }) => {\n+                        // If the extension contains a wildcard, and the rename_as does not,\n+                        // emit an issue to prevent users from encountering duplicate module\n+                        // names.\n+                        if glob.contains(\"*\")\n+                            && let Some(rename_as) = rename_as.as_ref()\n+                            && !rename_as.contains(\"*\")\n                         {\n-                            // If the extension contains a wildcard, and the rename_as does not,\n-                            // emit an issue to prevent users from encountering duplicate module\n-                            // names.\n-                            if glob.contains(\"*\")\n-                                && let Some(rename_as) = rename_as.as_ref()\n-                                && !rename_as.contains(\"*\")\n-                            {\n-                                InvalidLoaderRuleRenameAsIssue {\n-                                    glob: glob.clone(),\n+                            InvalidLoaderRuleRenameAsIssue {\n+                                glob: glob.clone(),\n+                                config_file_path: config_file_path()?,\n+                                rename_as: rename_as.clone(),\n+                            }\n+                            .resolved_cell()\n+                            .emit();\n+                        }\n+\n+                        // convert from Next.js-specific condition type to internal Turbopack\n+                        // condition type\n+                        let condition = if let Some(condition) = condition {\n+                            if let Ok(cond) = ConditionItem::try_from(condition.clone()) {\n+                                Some(cond)\n+                            } else {\n+                                InvalidLoaderRuleConditionIssue {\n+                                    condition: condition.clone(),\n                                     config_file_path: config_file_path()?,\n-                                    rename_as: rename_as.clone(),\n                                 }\n                                 .resolved_cell()\n                                 .emit();\n-                            }\n-\n-                            // convert from Next.js-specific condition type to internal Turbopack\n-                            // condition type\n-                            let condition = if let Some(condition) = condition {\n-                                if let Ok(cond) = ConditionItem::try_from(condition.clone()) {\n-                                    Some(cond)\n-                                } else {\n-                                    InvalidLoaderRuleConditionIssue {\n-                                        condition: condition.clone(),\n-                                        config_file_path: config_file_path()?,\n-                                    }\n-                                    .resolved_cell()\n-                                    .emit();\n-                                    None\n-                                }\n-                            } else {\n                                 None\n-                            };\n-                            rules.push((\n-                                glob.clone(),\n-                                LoaderRuleItem {\n-                                    loaders: transform_loaders(&mut loaders.iter()),\n-                                    rename_as: rename_as.clone(),\n-                                    condition,\n-                                },\n-                            ));\n-                        }\n+                            }\n+                        } else {\n+                            None\n+                        };\n+                        rules.push((\n+                            glob.clone(),\n+                            LoaderRuleItem {\n+                                loaders: transform_loaders(&mut loaders.iter()),\n+                                rename_as: rename_as.clone(),\n+                                condition,\n+                            },\n+                        ));\n                     }\n                 }\n             }\n@@ -2001,11 +1945,11 @@ mod tests {\n             }\n         });\n \n-        let rule_config: RuleConfigItemOptions = serde_json::from_value(json_value).unwrap();\n+        let rule_config: RuleConfigItem = serde_json::from_value(json_value).unwrap();\n \n         assert_eq!(\n             rule_config,\n-            RuleConfigItemOptions {\n+            RuleConfigItem {\n                 loaders: vec![],\n                 rename_as: Some(rcstr!(\"*.js\")),\n                 condition: Some(ConfigConditionItem::All("
        },
        {
            "sha": "17f2ae259f8a185d2059d64c729648f9c18e1a66",
            "filename": "crates/next-core/src/next_shared/webpack_rules/babel.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/15a056703ac94a9ec9c49dca41a4da034784f873/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fbabel.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/15a056703ac94a9ec9c49dca41a4da034784f873/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fbabel.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fbabel.rs?ref=15a056703ac94a9ec9c49dca41a4da034784f873",
            "patch": "@@ -5,14 +5,16 @@ use regex::Regex;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, Vc};\n use turbo_tasks_fs::{self, FileSystemEntryType, FileSystemPath};\n-use turbopack::module_options::LoaderRuleItem;\n+use turbopack::module_options::{ConditionItem, LoaderRuleItem};\n use turbopack_core::{\n     issue::{Issue, IssueExt, IssueSeverity, IssueStage, OptionStyledString, StyledString},\n     reference_type::{CommonJsReferenceSubType, ReferenceType},\n     resolve::{node::node_cjs_resolve_options, parse::Request, pattern::Pattern, resolve},\n };\n use turbopack_node::transforms::webpack::WebpackLoaderItem;\n \n+use crate::next_shared::webpack_rules::WebpackLoaderBuiltinCondition;\n+\n // https://babeljs.io/docs/config-files\n // TODO: Also support a `babel` key in a package.json file\n const BABEL_CONFIG_FILES: &[&str] = &[\n@@ -89,7 +91,9 @@ pub async fn get_babel_loader_rules(\n                 options: Default::default(),\n             }]),\n             rename_as: Some(rcstr!(\"*\")),\n-            condition: None,\n+            condition: Some(ConditionItem::Not(Box::new(ConditionItem::Builtin(\n+                RcStr::from(WebpackLoaderBuiltinCondition::Foreign.as_str()),\n+            )))),\n         },\n     )])\n }"
        },
        {
            "sha": "594f56f49db839926ebb52063307aa6a70f93466",
            "filename": "crates/next-core/src/next_shared/webpack_rules/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/15a056703ac94a9ec9c49dca41a4da034784f873/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/15a056703ac94a9ec9c49dca41a4da034784f873/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs?ref=15a056703ac94a9ec9c49dca41a4da034784f873",
            "patch": "@@ -149,7 +149,7 @@ pub async fn webpack_loader_options(\n     builtin_conditions: BTreeSet<WebpackLoaderBuiltinCondition>,\n ) -> Result<Vc<OptionWebpackLoadersOptions>> {\n     let mut rules = next_config\n-        .webpack_rules(builtin_conditions.clone(), project_path.clone())\n+        .webpack_rules(project_path.clone())\n         .owned()\n         .await?;\n "
        },
        {
            "sha": "6860dd35bf1762c3d578422d1c3eab343b7dea9f",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 41,
            "changes": 72,
            "blob_url": "https://github.com/vercel/next.js/blob/15a056703ac94a9ec9c49dca41a4da034784f873/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/15a056703ac94a9ec9c49dca41a4da034784f873/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=15a056703ac94a9ec9c49dca41a4da034784f873",
            "patch": "@@ -16,7 +16,6 @@ import type {\n   TurbopackRuleCondition,\n   TurbopackRuleConfigCollection,\n   TurbopackRuleConfigItem,\n-  TurbopackRuleConfigItemOptions,\n } from '../../server/config-shared'\n import { isDeepStrictEqual } from 'util'\n import { type DefineEnvOptions, getDefineEnv } from '../define-env'\n@@ -836,29 +835,32 @@ function bindingToApi(\n \n         for (const key of ruleKeys) {\n           nextConfig.turbopack.conditions[`#reactCompiler/${key}`] = {\n-            path: key,\n-            content:\n-              options.compilationMode === 'annotation'\n-                ? /['\"]use memo['\"]/\n-                : !options.compilationMode ||\n-                    options.compilationMode === 'infer'\n-                  ? // Matches declaration or useXXX or </ (closing jsx) or /> (self closing jsx)\n-                    /['\"]use memo['\"]|\\Wuse[A-Z]|<\\/|\\/>/\n-                  : undefined,\n+            all: [\n+              'browser',\n+              { not: 'foreign' },\n+              {\n+                path: key,\n+                content:\n+                  options.compilationMode === 'annotation'\n+                    ? /['\"]use memo['\"]/\n+                    : !options.compilationMode ||\n+                        options.compilationMode === 'infer'\n+                      ? // Matches declaration or useXXX or </ (closing jsx) or /> (self closing jsx)\n+                        /['\"]use memo['\"]|\\Wuse[A-Z]|<\\/|\\/>/\n+                      : undefined,\n+              },\n+            ],\n           }\n           nextConfig.turbopack.rules[`#reactCompiler/${key}`] = {\n-            browser: {\n-              foreign: false,\n-              loaders: [\n-                getReactCompilerLoader(\n-                  reactCompilerOptions,\n-                  projectPath,\n-                  nextConfig.dev,\n-                  /* isServer */ false,\n-                  /* reactCompilerExclude */ undefined\n-                ),\n-              ],\n-            },\n+            loaders: [\n+              getReactCompilerLoader(\n+                reactCompilerOptions,\n+                projectPath,\n+                nextConfig.dev,\n+                /* isServer */ false,\n+                /* reactCompilerExclude */ undefined\n+              ),\n+            ],\n           }\n         }\n       }\n@@ -1039,26 +1041,14 @@ function bindingToApi(\n       glob: string\n     ): any {\n       if (!rule) return rule\n+      for (const item of rule.loaders) {\n+        checkLoaderItem(item, glob)\n+      }\n       let serializedRule: any = rule\n-      if ('loaders' in rule) {\n-        const narrowedRule = rule as TurbopackRuleConfigItemOptions\n-        for (const item of narrowedRule.loaders) {\n-          checkLoaderItem(item, glob)\n-        }\n-        if (narrowedRule.condition != null) {\n-          serializedRule = {\n-            ...rule,\n-            condition: serializeRuleCondition(narrowedRule.condition),\n-          }\n-        }\n-      } else {\n-        serializedRule = {}\n-        for (const [key, value] of Object.entries(rule)) {\n-          if (typeof value === 'object' && value) {\n-            serializedRule[key] = serializeConfigItem(value, glob)\n-          } else {\n-            serializedRule[key] = value\n-          }\n+      if (rule.condition != null) {\n+        serializedRule = {\n+          ...rule,\n+          condition: serializeRuleCondition(rule.condition),\n         }\n       }\n       return serializedRule"
        },
        {
            "sha": "77aea9e12087b1bfcd4ed547b71ad0d1a2dc5822",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 12,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/15a056703ac94a9ec9c49dca41a4da034784f873/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/15a056703ac94a9ec9c49dca41a4da034784f873/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=15a056703ac94a9ec9c49dca41a4da034784f873",
            "patch": "@@ -11,7 +11,6 @@ import type {\n   DeprecatedExperimentalTurboOptions,\n   TurbopackOptions,\n   TurbopackRuleConfigItem,\n-  TurbopackRuleConfigItemOptions,\n   TurbopackRuleConfigCollection,\n   TurbopackRuleCondition,\n   TurbopackLoaderBuiltinCondition,\n@@ -135,26 +134,17 @@ const zTurbopackCondition: zod.ZodType<TurbopackRuleCondition> = z.union([\n   }),\n ])\n \n-const zTurbopackRuleConfigItemOptions: zod.ZodType<TurbopackRuleConfigItemOptions> =\n+const zTurbopackRuleConfigItem: zod.ZodType<TurbopackRuleConfigItem> =\n   z.strictObject({\n     loaders: z.array(zTurbopackLoaderItem),\n     as: z.string().optional(),\n     condition: zTurbopackCondition.optional(),\n   })\n \n-const zTurbopackRuleConfigItem: zod.ZodType<TurbopackRuleConfigItem> = z.union([\n-  z.literal(false),\n-  z.record(\n-    zTurbopackLoaderBuiltinCondition,\n-    z.lazy(() => zTurbopackRuleConfigItem)\n-  ),\n-  zTurbopackRuleConfigItemOptions,\n-])\n-\n const zTurbopackRuleConfigCollection: zod.ZodType<TurbopackRuleConfigCollection> =\n   z.union([\n     zTurbopackRuleConfigItem,\n-    z.array(z.union([zTurbopackLoaderItem, zTurbopackRuleConfigItemOptions])),\n+    z.array(z.union([zTurbopackLoaderItem, zTurbopackRuleConfigItem])),\n   ])\n \n const zTurbopackConfig: zod.ZodType<TurbopackOptions> = z.strictObject({"
        },
        {
            "sha": "f25359d9cccae39c3619833a7ee679fb60947f8d",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/15a056703ac94a9ec9c49dca41a4da034784f873/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/15a056703ac94a9ec9c49dca41a4da034784f873/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=15a056703ac94a9ec9c49dca41a4da034784f873",
            "patch": "@@ -278,17 +278,12 @@ export type TurbopackRuleCondition =\n       content?: RegExp\n     }\n \n-export type TurbopackRuleConfigItemOptions = {\n+export type TurbopackRuleConfigItem = {\n   loaders: TurbopackLoaderItem[]\n   as?: string\n   condition?: TurbopackRuleCondition\n }\n \n-export type TurbopackRuleConfigItem =\n-  | TurbopackRuleConfigItemOptions\n-  | { [condition in TurbopackLoaderBuiltinCondition]?: TurbopackRuleConfigItem }\n-  | false\n-\n /**\n  * This can be an object representing a single configuration, or a list of\n  * loaders and/or rule configuration objects.\n@@ -300,7 +295,7 @@ export type TurbopackRuleConfigItem =\n  */\n export type TurbopackRuleConfigCollection =\n   | TurbopackRuleConfigItem\n-  | (TurbopackLoaderItem | TurbopackRuleConfigItemOptions)[]\n+  | (TurbopackLoaderItem | TurbopackRuleConfigItem)[]\n \n export interface TurbopackOptions {\n   /**"
        },
        {
            "sha": "ab341e9310147a7bd939242eb653b706a0cdec7a",
            "filename": "test/e2e/app-dir/webpack-loader-conditions/next.config.js",
            "status": "modified",
            "additions": 21,
            "deletions": 21,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/15a056703ac94a9ec9c49dca41a4da034784f873/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/15a056703ac94a9ec9c49dca41a4da034784f873/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fnext.config.js?ref=15a056703ac94a9ec9c49dca41a4da034784f873",
            "patch": "@@ -4,35 +4,35 @@\n const nextConfig = {\n   turbopack: {\n     rules: {\n-      '*.test-file.js': {\n-        browser: {\n-          foreign: {\n-            loaders: [\n-              {\n-                loader: require.resolve('./test-file-loader.js'),\n-                options: { browser: true, foreign: true },\n-              },\n-            ],\n-          },\n-          default: {\n-            loaders: [\n-              {\n-                loader: require.resolve('./test-file-loader.js'),\n-                options: { browser: true },\n-              },\n-            ],\n-          },\n+      '*.test-file.js': [\n+        {\n+          condition: { all: ['browser', 'foreign'] },\n+          loaders: [\n+            {\n+              loader: require.resolve('./test-file-loader.js'),\n+              options: { browser: true, foreign: true },\n+            },\n+          ],\n+        },\n+        {\n+          condition: { all: ['browser', { not: 'foreign' }] },\n+          loaders: [\n+            {\n+              loader: require.resolve('./test-file-loader.js'),\n+              options: { browser: true },\n+            },\n+          ],\n         },\n-        foreign: false,\n-        default: {\n+        {\n+          condition: { not: { any: ['browser', 'foreign'] } },\n           loaders: [\n             {\n               loader: require.resolve('./test-file-loader.js'),\n               options: { default: true },\n             },\n           ],\n         },\n-      },\n+      ],\n     },\n   },\n }"
        }
    ],
    "stats": {
        "total": 291,
        "additions": 107,
        "deletions": 184
    }
}