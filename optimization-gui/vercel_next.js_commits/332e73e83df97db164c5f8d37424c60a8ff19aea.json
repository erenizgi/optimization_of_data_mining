{
    "author": "bgub",
    "message": "feat: add typesafety with config.typedRoutes to redirect() and permanentRedirect() (#82860)\n\nSee\nhttps://github.com/vercel/next.js/discussions/66217#discussioncomment-14161194",
    "sha": "332e73e83df97db164c5f8d37424c60a8ff19aea",
    "files": [
        {
            "sha": "a04cddac5891e6e224f0cda50bef9721e79f8838",
            "filename": "packages/next/src/server/lib/router-utils/typegen.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/332e73e83df97db164c5f8d37424c60a8ff19aea/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/332e73e83df97db164c5f8d37424c60a8ff19aea/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts?ref=332e73e83df97db164c5f8d37424c60a8ff19aea",
            "patch": "@@ -331,6 +331,8 @@ declare module 'next/navigation' {\n   export * from 'next/dist/client/components/navigation.js'\n \n   import type { NavigateOptions, AppRouterInstance as OriginalAppRouterInstance } from 'next/dist/shared/lib/app-router-context.shared-runtime.js'\n+  import type { RedirectType } from 'next/dist/client/components/redirect-error.js'\n+  \n   interface AppRouterInstance extends OriginalAppRouterInstance {\n     /**\n      * Navigate to the provided href.\n@@ -349,6 +351,41 @@ declare module 'next/navigation' {\n   }\n \n   export function useRouter(): AppRouterInstance;\n+  \n+  /**\n+   * This function allows you to redirect the user to another URL. It can be used in\n+   * [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components),\n+   * [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers), and\n+   * [Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations).\n+   *\n+   * - In a Server Component, this will insert a meta tag to redirect the user to the target page.\n+   * - In a Route Handler or Server Action, it will serve a 307/303 to the caller.\n+   * - In a Server Action, type defaults to 'push' and 'replace' elsewhere.\n+   *\n+   * Read more: [Next.js Docs: redirect](https://nextjs.org/docs/app/api-reference/functions/redirect)\n+   */\n+  export function redirect<RouteType>(\n+    /** The URL to redirect to */\n+    url: __next_route_internal_types__.RouteImpl<RouteType>,\n+    type?: RedirectType\n+  ): never;\n+  \n+  /**\n+   * This function allows you to redirect the user to another URL. It can be used in\n+   * [Server Components](https://nextjs.org/docs/app/building-your-application/rendering/server-components),\n+   * [Route Handlers](https://nextjs.org/docs/app/building-your-application/routing/route-handlers), and\n+   * [Server Actions](https://nextjs.org/docs/app/building-your-application/data-fetching/server-actions-and-mutations).\n+   *\n+   * - In a Server Component, this will insert a meta tag to redirect the user to the target page.\n+   * - In a Route Handler or Server Action, it will serve a 308/303 to the caller.\n+   *\n+   * Read more: [Next.js Docs: redirect](https://nextjs.org/docs/app/api-reference/functions/redirect)\n+   */\n+  export function permanentRedirect<RouteType>(\n+    /** The URL to redirect to */\n+    url: __next_route_internal_types__.RouteImpl<RouteType>,\n+    type?: RedirectType\n+  ): never;\n }\n \n declare module 'next/form' {"
        },
        {
            "sha": "03fd4722a3905d490ec637de83d8f94c35544938",
            "filename": "test/e2e/app-dir/typed-routes/typed-links.test.ts",
            "status": "modified",
            "additions": 92,
            "deletions": 0,
            "changes": 92,
            "blob_url": "https://github.com/vercel/next.js/blob/332e73e83df97db164c5f8d37424c60a8ff19aea/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-links.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/332e73e83df97db164c5f8d37424c60a8ff19aea/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-links.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-links.test.ts?ref=332e73e83df97db164c5f8d37424c60a8ff19aea",
            "patch": "@@ -90,10 +90,102 @@ export default function InvalidLinks() {\n       )\n \n       const { exitCode, cliOutput } = await next.build()\n+      // clean up for future tests\n+      await next.deleteFile('app/invalid-links.tsx')\n+\n       expect(exitCode).toBe(1)\n       expect(cliOutput).toContain(\n         `Type error: \"/invalid-route\" is not an existing route. If it is intentional, please type it explicitly with \\`as Route\\`.`\n       )\n     })\n+\n+    it('should pass type checking with valid redirect routes', async () => {\n+      await next.stop()\n+      await next.patchFile(\n+        'app/valid-redirects.tsx',\n+        `\n+import { redirect, permanentRedirect } from 'next/navigation'\n+\n+export default function ValidRedirects() {\n+  function handleRedirect() {\n+    redirect('/dashboard')\n+    permanentRedirect('/project/123')\n+  }\n+\n+  return (\n+    <button onClick={handleRedirect}>\n+      Test Redirects\n+    </button>\n+  )\n+}\n+`\n+      )\n+\n+      const { exitCode } = await next.build()\n+      expect(exitCode).toBe(0)\n+    })\n+\n+    it('should work with redirect Route type casting', async () => {\n+      await next.stop()\n+      await next.patchFile(\n+        'app/redirect-casting.tsx',\n+        `\n+import type { Route } from 'next'\n+import { redirect, permanentRedirect } from 'next/navigation'\n+\n+export default function RedirectCasting() {\n+  function handleRedirect() {\n+    const dynamicPath = '/dynamic-path'\n+    redirect(dynamicPath as Route)\n+    permanentRedirect(dynamicPath as Route)\n+  }\n+\n+  return (\n+    <button onClick={handleRedirect}>\n+      Casted Redirects\n+    </button>\n+  )\n+}\n+`\n+      )\n+\n+      const { exitCode } = await next.build()\n+      expect(exitCode).toBe(0)\n+    })\n+\n+    it('should fail type checking with invalid redirect routes', async () => {\n+      await next.stop()\n+      await next.patchFile(\n+        'app/invalid-redirects.tsx',\n+        `\n+import { redirect, permanentRedirect } from 'next/navigation'\n+\n+export default function InvalidRedirects() {\n+  function handleRedirect() {\n+    redirect('/invalid-route')\n+    permanentRedirect('/another-invalid-route')\n+  }\n+\n+  return (\n+    <button onClick={handleRedirect}>\n+      Invalid Redirects\n+    </button>\n+  )\n+}\n+`\n+      )\n+\n+      const { exitCode, cliOutput } = await next.build()\n+      // clean up for future tests\n+      await next.deleteFile('app/invalid-redirects.tsx')\n+\n+      expect(exitCode).toBe(1)\n+      expect(cliOutput).toContain(\n+        `Type error: Argument of type '\"/invalid-route\"' is not assignable to parameter of type 'RouteImpl<\"/invalid-route\">'.`\n+      )\n+      expect(cliOutput).toContain(\n+        `Type error: Argument of type '\"/another-invalid-route\"' is not assignable to parameter of type 'RouteImpl<\"/another-invalid-route\">'.`\n+      )\n+    })\n   }\n })"
        },
        {
            "sha": "2e73585cfa298ca0c84ec72064ea59da1491aac5",
            "filename": "test/e2e/app-dir/typed-routes/typed-routes.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/332e73e83df97db164c5f8d37424c60a8ff19aea/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/332e73e83df97db164c5f8d37424c60a8ff19aea/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts?ref=332e73e83df97db164c5f8d37424c60a8ff19aea",
            "patch": "@@ -79,6 +79,8 @@ type InvalidRoute = RouteContext<'/api/users/invalid'>`\n       )\n \n       const { cliOutput } = await next.build()\n+      // clean up for future tests\n+      await next.deleteFile('app/type-testing.ts')\n \n       expect(cliOutput).toContain(\n         `Type '\"/dasboard\"' does not satisfy the constraint 'AppRoutes'.`"
        },
        {
            "sha": "a2bb8525a08857c7a69586b7e01ddb5850b9aecd",
            "filename": "test/integration/app-types/app-types.test.js",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/332e73e83df97db164c5f8d37424c60a8ff19aea/test%2Fintegration%2Fapp-types%2Fapp-types.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/332e73e83df97db164c5f8d37424c60a8ff19aea/test%2Fintegration%2Fapp-types%2Fapp-types.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-types%2Fapp-types.test.js?ref=332e73e83df97db164c5f8d37424c60a8ff19aea",
            "patch": "@@ -70,6 +70,21 @@ describe('app type checking - production mode', () => {\n     )\n   })\n \n+  it('should generate route types correctly and report redirect errors', async () => {\n+    // Make sure all errors were reported and other redirect functions passed type checking\n+    const errorLines = [\n+      ...errors.matchAll(\n+        /\\.\\/src\\/app\\/type-checks\\/redirect\\/page\\.tsx:(\\d+):/g\n+      ),\n+    ].map(([, line]) => +line)\n+\n+    const ST = 7\n+    const ED = 11\n+    expect(errorLines).toEqual(\n+      Array.from({ length: ED - ST + 1 }, (_, i) => i + ST)\n+    )\n+  })\n+\n   // Type validation is not supported in Turbopack yet.\n   if (!process.env.IS_TURBOPACK_TEST && !process.env.TURBOPACK_DEV) {\n     it('should type check invalid entry exports', () => {"
        },
        {
            "sha": "9b41f224e0ff4dbae7cd131b30e483c462d0e0d0",
            "filename": "test/integration/app-types/src/app/type-checks/redirect/page.tsx",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/332e73e83df97db164c5f8d37424c60a8ff19aea/test%2Fintegration%2Fapp-types%2Fsrc%2Fapp%2Ftype-checks%2Fredirect%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/332e73e83df97db164c5f8d37424c60a8ff19aea/test%2Fintegration%2Fapp-types%2Fsrc%2Fapp%2Ftype-checks%2Fredirect%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-types%2Fsrc%2Fapp%2Ftype-checks%2Fredirect%2Fpage.tsx?ref=332e73e83df97db164c5f8d37424c60a8ff19aea",
            "patch": "@@ -0,0 +1,27 @@\n+import { redirect, permanentRedirect } from 'next/navigation'\n+import type { Route } from 'next'\n+\n+export default function Page() {\n+  function testRedirect() {\n+    // Invalid routes - these should cause type errors:\n+    redirect('/wrong-link')\n+    redirect('/blog/a?1/b')\n+    redirect(`/blog/${'a/b/c'}`)\n+    permanentRedirect('/nonexistent-route')\n+    permanentRedirect('/wrong/route')\n+\n+    // Correctly typed - these should pass:\n+    redirect('/dashboard/another')\n+    redirect('/about')\n+    redirect('/redirect')\n+    redirect(`/blog/${'a/b'}`)\n+    redirect('https://vercel.com')\n+    redirect('/invalid' as Route)\n+    permanentRedirect('/dashboard/user')\n+    permanentRedirect('/blog/a/b')\n+    permanentRedirect(`/dashboard/${'123'}`)\n+    permanentRedirect('/external' as Route)\n+  }\n+\n+  return <div onClick={testRedirect} />\n+}"
        }
    ],
    "stats": {
        "total": 173,
        "additions": 173,
        "deletions": 0
    }
}