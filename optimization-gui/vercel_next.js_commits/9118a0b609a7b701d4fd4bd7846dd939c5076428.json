{
    "author": "unstubbable",
    "message": "Keep server code out of browser chunks (#76660)\n\nReduces the main chunk's size for a hello world app ~from 60.2 kB to\n51.6 kB~ from 53.5 kB to 45.6 kB (after #76622 got merged).\n\nIn the past we were a bit sloppy with using modules from `src/server`\nalso in universally used modules (server & browser). This led to code\nending up in browser chunks that's only meant for the server, e.g. async\nlocal storage modules.\n\nWe did have already quite a few conditional requires with `typeof\nwindow` checks for those modules, but not everywhere. This is fixed in\nthis PR. And shared modules are also moved out of `src/server` into\neither `src/shared/lib` or `src/client`.\n\nA simple smoke test is added to ensure we don't regress here, at least\nfor a simple hello world app. A better verification might be some kind\nof linter rule though.\n\nIn addition, we don't remove the `typeof window` SWC optimization for\nNext.js modules anymore (which is still done for other `node_modules`,\nsee #62051), to ensure that guarded code becomes dead code and is\neliminated.\n\nIdeally, SWC would take care of the DCE solely by using `typeof window`\nchecks, without needing to manually split modules and dynamically\nrequiring them, which is very tedious and we'd like to avoid. But this\nis currently not the case.\n\nAnother option worth exploring is using the ESM modules from\n`next/dist/esm` in hopes of yielding better DCE results.",
    "sha": "9118a0b609a7b701d4fd4bd7846dd939c5076428",
    "files": [
        {
            "sha": "ff8c43d8b0067596e11015e907b7304b96f84ee0",
            "filename": "packages/next/src/build/normalize-catchall-routes.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fbuild%2Fnormalize-catchall-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fbuild%2Fnormalize-catchall-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fnormalize-catchall-routes.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,4 +1,4 @@\n-import { isInterceptionRouteAppPath } from '../server/lib/interception-routes'\n+import { isInterceptionRouteAppPath } from '../shared/lib/router/utils/interception-routes'\n import { AppPathnameNormalizer } from '../server/normalizers/built/app/app-pathname-normalizer'\n \n /**"
        },
        {
            "sha": "437b15ce26dfd1da206a32c15b20204cf4314477",
            "filename": "packages/next/src/build/swc/options.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -513,7 +513,10 @@ export function getLoaderSWCOptions({\n     options.cjsRequireOptimizer = undefined\n     // Disable optimizer for node_modules in app browser layer, to avoid unnecessary replacement.\n     // e.g. typeof window could result differently in js worker or browser.\n-    if (options.jsc.transform.optimizer.globals?.typeofs) {\n+    if (\n+      options.jsc.transform.optimizer.globals?.typeofs &&\n+      !filename.includes(nextDirname)\n+    ) {\n       delete options.jsc.transform.optimizer.globals.typeofs.window\n     }\n   }"
        },
        {
            "sha": "43c04c9fc9269740d1b7639f74df86b1cd04bb57",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -69,7 +69,7 @@ import { normalizeAppPath } from '../shared/lib/router/utils/app-paths'\n import { denormalizeAppPagePath } from '../shared/lib/page-path/denormalize-app-path'\n import { RouteKind } from '../server/route-kind'\n import type { PageExtensions } from './page-extensions-type'\n-import { isInterceptionRouteAppPath } from '../server/lib/interception-routes'\n+import { isInterceptionRouteAppPath } from '../shared/lib/router/utils/interception-routes'\n import { checkIsRoutePPREnabled } from '../server/lib/experimental/ppr'\n import type { FallbackMode } from '../lib/fallback'\n import type { OutgoingHttpHeaders } from 'http'"
        },
        {
            "sha": "caedf3146a599118e017024742b14848813481a4",
            "filename": "packages/next/src/client/components/client-page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fclient-page.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fclient-page.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fclient-page.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -51,10 +51,10 @@ export function ClientPageRoot({\n     return <Component params={clientParams} searchParams={clientSearchParams} />\n   } else {\n     const { createRenderSearchParamsFromClient } =\n-      require('../../server/request/search-params.browser') as typeof import('../../server/request/search-params.browser')\n+      require('../request/search-params.browser') as typeof import('../request/search-params.browser')\n     const clientSearchParams = createRenderSearchParamsFromClient(searchParams)\n     const { createRenderParamsFromClient } =\n-      require('../../server/request/params.browser') as typeof import('../../server/request/params.browser')\n+      require('../request/params.browser') as typeof import('../request/params.browser')\n     const clientParams = createRenderParamsFromClient(params)\n \n     return <Component params={clientParams} searchParams={clientSearchParams} />"
        },
        {
            "sha": "f27ee7e65d52802231fc2b0c2406f9ff9c9eb025",
            "filename": "packages/next/src/client/components/client-segment.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fclient-segment.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fclient-segment.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fclient-segment.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -45,7 +45,7 @@ export function ClientSegmentRoot({\n     return <Component {...slots} params={clientParams} />\n   } else {\n     const { createRenderParamsFromClient } =\n-      require('../../server/request/params.browser') as typeof import('../../server/request/params.browser')\n+      require('../request/params.browser') as typeof import('../request/params.browser')\n     const clientParams = createRenderParamsFromClient(params)\n     return <Component {...slots} params={clientParams} />\n   }"
        },
        {
            "sha": "65f50eb0f241fda0e0c63e82be5137f8e4f3f61b",
            "filename": "packages/next/src/client/components/error-boundary.tsx",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -4,7 +4,13 @@ import React, { type JSX } from 'react'\n import { useUntrackedPathname } from './navigation-untracked'\n import { isNextRouterError } from './is-next-router-error'\n import { handleHardNavError } from './nav-failure-handler'\n-import { workAsyncStorage } from '../../server/app-render/work-async-storage.external'\n+\n+const workAsyncStorage =\n+  typeof window === 'undefined'\n+    ? (\n+        require('../../server/app-render/work-async-storage.external') as typeof import('../../server/app-render/work-async-storage.external')\n+      ).workAsyncStorage\n+    : undefined\n \n const styles = {\n   error: {\n@@ -54,10 +60,12 @@ interface ErrorBoundaryHandlerState {\n // function crashes so we can maintain our previous cache\n // instead of caching the error page\n function HandleISRError({ error }: { error: any }) {\n-  const store = workAsyncStorage.getStore()\n-  if (store?.isRevalidate || store?.isStaticGeneration) {\n-    console.error(error)\n-    throw error\n+  if (workAsyncStorage) {\n+    const store = workAsyncStorage.getStore()\n+    if (store?.isRevalidate || store?.isStaticGeneration) {\n+      console.error(error)\n+      throw error\n+    }\n   }\n \n   return null"
        },
        {
            "sha": "e79c8ec7671798551dcea119e645376eb173e80c",
            "filename": "packages/next/src/client/components/match-segments.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmatch-segments.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmatch-segments.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmatch-segments.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,4 +1,3 @@\n-import { getSegmentParam } from '../../server/app-render/get-segment-param'\n import type { Segment } from '../../server/app-render/types'\n \n export const matchSegment = (\n@@ -19,17 +18,3 @@ export const matchSegment = (\n   }\n   return existingSegment[0] === segment[0] && existingSegment[1] === segment[1]\n }\n-\n-/*\n- * This function is used to determine if an existing segment can be overridden by the incoming segment.\n- */\n-export const canSegmentBeOverridden = (\n-  existingSegment: Segment,\n-  segment: Segment\n-): boolean => {\n-  if (Array.isArray(existingSegment) || !Array.isArray(segment)) {\n-    return false\n-  }\n-\n-  return getSegmentParam(existingSegment)?.param === segment[0]\n-}"
        },
        {
            "sha": "1ede4822a273ba3725e3e9355cfa6a901382c49f",
            "filename": "packages/next/src/client/components/metadata/async-metadata.tsx",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fasync-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fasync-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fasync-metadata.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,42 @@\n+'use client'\n+\n+import { Suspense, use } from 'react'\n+import type { StreamingMetadataResolvedState } from './types'\n+\n+export const AsyncMetadata =\n+  typeof window === 'undefined'\n+    ? (\n+        require('./server-inserted-metadata') as typeof import('./server-inserted-metadata')\n+      ).ServerInsertMetadata\n+    : (\n+        require('./browser-resolved-metadata') as typeof import('./browser-resolved-metadata')\n+      ).BrowserResolvedMetadata\n+\n+function MetadataOutlet({\n+  promise,\n+}: {\n+  promise: Promise<StreamingMetadataResolvedState>\n+}) {\n+  const { error, digest } = use(promise)\n+  if (error) {\n+    if (digest) {\n+      // The error will lose its original digest after passing from server layer to client layerï¼›\n+      // We recover the digest property here to override the React created one if original digest exists.\n+      ;(error as any).digest = digest\n+    }\n+    throw error\n+  }\n+  return null\n+}\n+\n+export function AsyncMetadataOutlet({\n+  promise,\n+}: {\n+  promise: Promise<StreamingMetadataResolvedState>\n+}) {\n+  return (\n+    <Suspense fallback={null}>\n+      <MetadataOutlet promise={promise} />\n+    </Suspense>\n+  )\n+}"
        },
        {
            "sha": "4a3e181225aaf8202be5126b39e835ec73ae5163",
            "filename": "packages/next/src/client/components/metadata/browser-resolved-metadata.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fbrowser-resolved-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fbrowser-resolved-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fbrowser-resolved-metadata.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,14 @@\n+import { use } from 'react'\n+import type { StreamingMetadataResolvedState } from './types'\n+\n+export function BrowserResolvedMetadata({\n+  promise,\n+}: {\n+  promise: Promise<StreamingMetadataResolvedState>\n+}) {\n+  const { metadata, error } = use(promise)\n+  // If there's metadata error on client, discard the browser metadata\n+  // and let metadata outlet deal with the error. This will avoid the duplication metadata.\n+  if (error) return null\n+  return metadata\n+}"
        },
        {
            "sha": "ef72e157a3ef1be77aabcc641fd835143d19ac44",
            "filename": "packages/next/src/client/components/metadata/metadata-boundary.tsx",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fmetadata-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fmetadata-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fmetadata-boundary.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -4,7 +4,7 @@ import {\n   METADATA_BOUNDARY_NAME,\n   VIEWPORT_BOUNDARY_NAME,\n   OUTLET_BOUNDARY_NAME,\n-} from './metadata-constants'\n+} from '../../../lib/metadata/metadata-constants'\n \n // We use a namespace object to allow us to recover the name of the function\n // at runtime even when production bundling/minification is used.",
            "previous_filename": "packages/next/src/lib/metadata/metadata-boundary.tsx"
        },
        {
            "sha": "0cda2d7c25ca59bedd33b3480a0fef49dbb3bcf2",
            "filename": "packages/next/src/client/components/metadata/server-inserted-metadata.ts",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Fserver-inserted-metadata.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,29 @@\n+import { use, useContext } from 'react'\n+import {\n+  type MetadataResolver,\n+  ServerInsertedMetadataContext,\n+} from '../../../shared/lib/server-inserted-metadata.shared-runtime'\n+import type { StreamingMetadataResolvedState } from './types'\n+\n+// Receives a metadata resolver setter from the context, and will pass the metadata resolving promise to\n+// the context where we gonna use it to resolve the metadata, and render as string to append in <body>.\n+const useServerInsertedMetadata = (metadataResolver: MetadataResolver) => {\n+  const setMetadataResolver = useContext(ServerInsertedMetadataContext)\n+\n+  if (setMetadataResolver) {\n+    setMetadataResolver(metadataResolver)\n+  }\n+}\n+\n+export function ServerInsertMetadata({\n+  promise,\n+}: {\n+  promise: Promise<StreamingMetadataResolvedState>\n+}) {\n+  // Apply use() to the metadata promise to suspend the rendering in SSR.\n+  const { metadata } = use(promise)\n+  // Insert metadata into the HTML stream through the `useServerInsertedMetadata`\n+  useServerInsertedMetadata(() => metadata)\n+\n+  return null\n+}"
        },
        {
            "sha": "0a45b6a13960e7e19de4e371fbb41c1ddb516507",
            "filename": "packages/next/src/client/components/metadata/types.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fmetadata%2Ftypes.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,5 @@\n+export type StreamingMetadataResolvedState = {\n+  metadata: React.ReactNode\n+  error: unknown | null\n+  digest: string | undefined\n+}"
        },
        {
            "sha": "fb01d7b7caa679615904aa95bf75d57fe82f9158",
            "filename": "packages/next/src/client/components/navigation.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -15,7 +15,13 @@ import {\n import { getSegmentValue } from './router-reducer/reducers/get-segment-value'\n import { PAGE_SEGMENT_KEY, DEFAULT_SEGMENT_KEY } from '../../shared/lib/segment'\n import { ReadonlyURLSearchParams } from './navigation.react-server'\n-import { useDynamicRouteParams } from '../../server/app-render/dynamic-rendering'\n+\n+const useDynamicRouteParams =\n+  typeof window === 'undefined'\n+    ? (\n+        require('../../server/app-render/dynamic-rendering') as typeof import('../../server/app-render/dynamic-rendering')\n+      ).useDynamicRouteParams\n+    : undefined\n \n /**\n  * A [Client Component](https://nextjs.org/docs/app/building-your-application/rendering/client-components) hook\n@@ -84,7 +90,7 @@ export function useSearchParams(): ReadonlyURLSearchParams {\n  */\n // Client components API\n export function usePathname(): string {\n-  useDynamicRouteParams('usePathname()')\n+  useDynamicRouteParams?.('usePathname()')\n \n   // In the case where this is `null`, the compat types added in `next-env.d.ts`\n   // will add a new overload that changes the return type to include `null`.\n@@ -144,7 +150,7 @@ export function useRouter(): AppRouterInstance {\n  */\n // Client components API\n export function useParams<T extends Params = Params>(): T {\n-  useDynamicRouteParams('useParams()')\n+  useDynamicRouteParams?.('useParams()')\n \n   return useContext(PathParamsContext) as T\n }\n@@ -215,7 +221,7 @@ function getSelectedLayoutSegmentPath(\n export function useSelectedLayoutSegments(\n   parallelRouteKey: string = 'children'\n ): string[] {\n-  useDynamicRouteParams('useSelectedLayoutSegments()')\n+  useDynamicRouteParams?.('useSelectedLayoutSegments()')\n \n   const context = useContext(LayoutRouterContext)\n   // @ts-expect-error This only happens in `pages`. Type is overwritten in navigation.d.ts\n@@ -246,7 +252,7 @@ export function useSelectedLayoutSegments(\n export function useSelectedLayoutSegment(\n   parallelRouteKey: string = 'children'\n ): string | null {\n-  useDynamicRouteParams('useSelectedLayoutSegment()')\n+  useDynamicRouteParams?.('useSelectedLayoutSegment()')\n \n   const selectedLayoutSegments = useSelectedLayoutSegments(parallelRouteKey)\n "
        },
        {
            "sha": "d5db39935f7342a9f784bd6aada4d1a1c9eb49ff",
            "filename": "packages/next/src/client/components/redirect.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 9,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fredirect.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fredirect.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fredirect.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,4 +1,3 @@\n-import { actionAsyncStorage } from '../../server/app-render/action-async-storage.external'\n import { RedirectStatusCode } from './redirect-status-code'\n import {\n   RedirectType,\n@@ -7,6 +6,13 @@ import {\n   REDIRECT_ERROR_CODE,\n } from './redirect-error'\n \n+const actionAsyncStorage =\n+  typeof window === 'undefined'\n+    ? (\n+        require('../../server/app-render/action-async-storage.external') as typeof import('../../server/app-render/action-async-storage.external')\n+      ).actionAsyncStorage\n+    : undefined\n+\n export function getRedirectError(\n   url: string,\n   type: RedirectType,\n@@ -34,14 +40,11 @@ export function redirect(\n   url: string,\n   type?: RedirectType\n ): never {\n-  const actionStore = actionAsyncStorage.getStore()\n-  const redirectType =\n-    type || (actionStore?.isAction ? RedirectType.push : RedirectType.replace)\n-  throw getRedirectError(\n-    url,\n-    redirectType,\n-    RedirectStatusCode.TemporaryRedirect\n-  )\n+  type ??= actionAsyncStorage?.getStore()?.isAction\n+    ? RedirectType.push\n+    : RedirectType.replace\n+\n+  throw getRedirectError(url, type, RedirectStatusCode.TemporaryRedirect)\n }\n \n /**"
        },
        {
            "sha": "8d8d10abc22e54049cca20bc543ad543fe98330a",
            "filename": "packages/next/src/client/components/router-reducer/compute-changed-path.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcompute-changed-path.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcompute-changed-path.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcompute-changed-path.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -2,7 +2,7 @@ import type {\n   FlightRouterState,\n   Segment,\n } from '../../../server/app-render/types'\n-import { INTERCEPTION_ROUTE_MARKERS } from '../../../server/lib/interception-routes'\n+import { INTERCEPTION_ROUTE_MARKERS } from '../../../shared/lib/router/utils/interception-routes'\n import type { Params } from '../../../server/request/params'\n import {\n   isGroupSegment,"
        },
        {
            "sha": "81ecdc96b8d4d5b1f9d8f6452027a02f1658e3ee",
            "filename": "packages/next/src/client/components/router-reducer/reducers/has-interception-route-in-current-tree.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhas-interception-route-in-current-tree.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhas-interception-route-in-current-tree.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhas-interception-route-in-current-tree.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,5 +1,5 @@\n import type { FlightRouterState } from '../../../../server/app-render/types'\n-import { isInterceptionRouteAppPath } from '../../../../server/lib/interception-routes'\n+import { isInterceptionRouteAppPath } from '../../../../shared/lib/router/utils/interception-routes'\n \n export function hasInterceptionRouteInCurrentTree([\n   segment,"
        },
        {
            "sha": "44752e6952dacbae197f27b5daccf73fd35ef31a",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -46,7 +46,7 @@ import {\n   encodeChildSegmentKey,\n   encodeSegment,\n   ROOT_SEGMENT_KEY,\n-} from '../../../server/app-render/segment-value-encoding'\n+} from '../../../shared/lib/segment-cache/segment-value-encoding'\n import type {\n   FlightRouterState,\n   NavigationFlightResponse,"
        },
        {
            "sha": "76aff5f16f4c31e8ff13df611c317575e7e16e1c",
            "filename": "packages/next/src/client/components/unstable-rethrow.browser.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.browser.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.browser.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.browser.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,12 @@\n+import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n+import { isNextRouterError } from './is-next-router-error'\n+\n+export function unstable_rethrow(error: unknown): void {\n+  if (isNextRouterError(error) || isBailoutToCSRError(error)) {\n+    throw error\n+  }\n+\n+  if (error instanceof Error && 'cause' in error) {\n+    unstable_rethrow(error.cause)\n+  }\n+}"
        },
        {
            "sha": "9c4d6ebaa37a430b0822a98185d10a6344bee627",
            "filename": "packages/next/src/client/components/unstable-rethrow.server.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.server.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,23 @@\n+import { isHangingPromiseRejectionError } from '../../server/dynamic-rendering-utils'\n+import { isPostpone } from '../../server/lib/router-utils/is-postpone'\n+import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n+import { isNextRouterError } from './is-next-router-error'\n+import { isDynamicPostpone } from '../../server/app-render/dynamic-rendering'\n+import { isDynamicServerError } from './hooks-server-context'\n+\n+export function unstable_rethrow(error: unknown): void {\n+  if (\n+    isNextRouterError(error) ||\n+    isBailoutToCSRError(error) ||\n+    isDynamicServerError(error) ||\n+    isDynamicPostpone(error) ||\n+    isPostpone(error) ||\n+    isHangingPromiseRejectionError(error)\n+  ) {\n+    throw error\n+  }\n+\n+  if (error instanceof Error && 'cause' in error) {\n+    unstable_rethrow(error.cause)\n+  }\n+}"
        },
        {
            "sha": "de82d998bbdcb6aac35d08ccb96b15ca32cc2545",
            "filename": "packages/next/src/client/components/unstable-rethrow.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 21,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Funstable-rethrow.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,28 +1,15 @@\n-import { isDynamicUsageError } from '../../export/helpers/is-dynamic-usage-error'\n-import { isHangingPromiseRejectionError } from '../../server/dynamic-rendering-utils'\n-import { isPostpone } from '../../server/lib/router-utils/is-postpone'\n-import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n-import { isNextRouterError } from './is-next-router-error'\n-\n /**\n  * This function should be used to rethrow internal Next.js errors so that they can be handled by the framework.\n  * When wrapping an API that uses errors to interrupt control flow, you should use this function before you do any error handling.\n  * This function will rethrow the error if it is a Next.js error so it can be handled, otherwise it will do nothing.\n  *\n  * Read more: [Next.js Docs: `unstable_rethrow`](https://nextjs.org/docs/app/api-reference/functions/unstable_rethrow)\n  */\n-export function unstable_rethrow(error: unknown): void {\n-  if (\n-    isNextRouterError(error) ||\n-    isBailoutToCSRError(error) ||\n-    isDynamicUsageError(error) ||\n-    isPostpone(error) ||\n-    isHangingPromiseRejectionError(error)\n-  ) {\n-    throw error\n-  }\n-\n-  if (error instanceof Error && 'cause' in error) {\n-    unstable_rethrow(error.cause)\n-  }\n-}\n+export const unstable_rethrow =\n+  typeof window === 'undefined'\n+    ? (\n+        require('./unstable-rethrow.server') as typeof import('./unstable-rethrow.server')\n+      ).unstable_rethrow\n+    : (\n+        require('./unstable-rethrow.browser') as typeof import('./unstable-rethrow.browser')\n+      ).unstable_rethrow"
        },
        {
            "sha": "0facf35621c37b21cc3e9903bf58a33f652858e8",
            "filename": "packages/next/src/client/request/params.browser.dev.ts",
            "status": "renamed",
            "additions": 7,
            "deletions": 33,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.dev.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,42 +1,16 @@\n-import type { Params } from './params'\n+import type { Params } from '../../server/request/params'\n \n-import { ReflectAdapter } from '../web/spec-extension/adapters/reflect'\n+import { ReflectAdapter } from '../../server/web/spec-extension/adapters/reflect'\n import { InvariantError } from '../../shared/lib/invariant-error'\n-import { describeStringPropertyAccess, wellKnownProperties } from './utils'\n-\n-export function createRenderParamsFromClient(underlyingParams: Params) {\n-  if (process.env.NODE_ENV === 'development') {\n-    return makeDynamicallyTrackedExoticParamsWithDevWarnings(underlyingParams)\n-  } else {\n-    return makeUntrackedExoticParams(underlyingParams)\n-  }\n-}\n+import {\n+  describeStringPropertyAccess,\n+  wellKnownProperties,\n+} from '../../shared/lib/utils/reflect-utils'\n \n interface CacheLifetime {}\n const CachedParams = new WeakMap<CacheLifetime, Promise<Params>>()\n \n-function makeUntrackedExoticParams(underlyingParams: Params): Promise<Params> {\n-  const cachedParams = CachedParams.get(underlyingParams)\n-  if (cachedParams) {\n-    return cachedParams\n-  }\n-\n-  const promise = Promise.resolve(underlyingParams)\n-  CachedParams.set(underlyingParams, promise)\n-\n-  Object.keys(underlyingParams).forEach((prop) => {\n-    if (wellKnownProperties.has(prop)) {\n-      // These properties cannot be shadowed because they need to be the\n-      // true underlying value for Promises to work correctly at runtime\n-    } else {\n-      ;(promise as any)[prop] = underlyingParams[prop]\n-    }\n-  })\n-\n-  return promise\n-}\n-\n-function makeDynamicallyTrackedExoticParamsWithDevWarnings(\n+export function makeDynamicallyTrackedExoticParamsWithDevWarnings(\n   underlyingParams: Params\n ): Promise<Params> {\n   const cachedParams = CachedParams.get(underlyingParams)",
            "previous_filename": "packages/next/src/server/request/params.browser.ts"
        },
        {
            "sha": "2b34bedf81aece8a3f6af05c8aed8cba62d0b7bb",
            "filename": "packages/next/src/client/request/params.browser.prod.ts",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.prod.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.prod.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.prod.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,28 @@\n+import type { Params } from '../../server/request/params'\n+import { wellKnownProperties } from '../../shared/lib/utils/reflect-utils'\n+\n+interface CacheLifetime {}\n+const CachedParams = new WeakMap<CacheLifetime, Promise<Params>>()\n+\n+export function makeUntrackedExoticParams(\n+  underlyingParams: Params\n+): Promise<Params> {\n+  const cachedParams = CachedParams.get(underlyingParams)\n+  if (cachedParams) {\n+    return cachedParams\n+  }\n+\n+  const promise = Promise.resolve(underlyingParams)\n+  CachedParams.set(underlyingParams, promise)\n+\n+  Object.keys(underlyingParams).forEach((prop) => {\n+    if (wellKnownProperties.has(prop)) {\n+      // These properties cannot be shadowed because they need to be the\n+      // true underlying value for Promises to work correctly at runtime\n+    } else {\n+      ;(promise as any)[prop] = underlyingParams[prop]\n+    }\n+  })\n+\n+  return promise\n+}"
        },
        {
            "sha": "571b9000c76ed36358c5c95b5463dae7e825cfed",
            "filename": "packages/next/src/client/request/params.browser.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fparams.browser.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,7 @@\n+export const createRenderParamsFromClient =\n+  process.env.NODE_ENV === 'development'\n+    ? (require('./params.browser.dev') as typeof import('./params.browser.dev'))\n+        .makeDynamicallyTrackedExoticParamsWithDevWarnings\n+    : (\n+        require('./params.browser.prod') as typeof import('./params.browser.prod')\n+      ).makeUntrackedExoticParams"
        },
        {
            "sha": "e71520e835fbe307d82168b937005b938c1f5f68",
            "filename": "packages/next/src/client/request/search-params.browser.dev.ts",
            "status": "renamed",
            "additions": 4,
            "deletions": 42,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.dev.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,28 +1,16 @@\n-import type { SearchParams } from './search-params'\n+import type { SearchParams } from '../../server/request/search-params'\n \n-import { ReflectAdapter } from '../web/spec-extension/adapters/reflect'\n+import { ReflectAdapter } from '../../server/web/spec-extension/adapters/reflect'\n import {\n   describeStringPropertyAccess,\n   describeHasCheckingStringProperty,\n   wellKnownProperties,\n-} from './utils'\n-\n-export function createRenderSearchParamsFromClient(\n-  underlyingSearchParams: SearchParams\n-): Promise<SearchParams> {\n-  if (process.env.NODE_ENV === 'development') {\n-    return makeUntrackedExoticSearchParamsWithDevWarnings(\n-      underlyingSearchParams\n-    )\n-  } else {\n-    return makeUntrackedExoticSearchParams(underlyingSearchParams)\n-  }\n-}\n+} from '../../shared/lib/utils/reflect-utils'\n \n interface CacheLifetime {}\n const CachedSearchParams = new WeakMap<CacheLifetime, Promise<SearchParams>>()\n \n-function makeUntrackedExoticSearchParamsWithDevWarnings(\n+export function makeUntrackedExoticSearchParamsWithDevWarnings(\n   underlyingSearchParams: SearchParams\n ): Promise<SearchParams> {\n   const cachedSearchParams = CachedSearchParams.get(underlyingSearchParams)\n@@ -96,32 +84,6 @@ function makeUntrackedExoticSearchParamsWithDevWarnings(\n   return proxiedPromise\n }\n \n-function makeUntrackedExoticSearchParams(\n-  underlyingSearchParams: SearchParams\n-): Promise<SearchParams> {\n-  const cachedSearchParams = CachedSearchParams.get(underlyingSearchParams)\n-  if (cachedSearchParams) {\n-    return cachedSearchParams\n-  }\n-\n-  // We don't use makeResolvedReactPromise here because searchParams\n-  // supports copying with spread and we don't want to unnecessarily\n-  // instrument the promise with spreadable properties of ReactPromise.\n-  const promise = Promise.resolve(underlyingSearchParams)\n-  CachedSearchParams.set(underlyingSearchParams, promise)\n-\n-  Object.keys(underlyingSearchParams).forEach((prop) => {\n-    if (wellKnownProperties.has(prop)) {\n-      // These properties cannot be shadowed because they need to be the\n-      // true underlying value for Promises to work correctly at runtime\n-    } else {\n-      ;(promise as any)[prop] = underlyingSearchParams[prop]\n-    }\n-  })\n-\n-  return promise\n-}\n-\n function warnForSyncAccess(expression: string) {\n   console.error(\n     `A searchParam property was accessed directly with ${expression}. ` +",
            "previous_filename": "packages/next/src/server/request/search-params.browser.ts"
        },
        {
            "sha": "3232eb9181980b750606e1fda67e7b6534df6e3c",
            "filename": "packages/next/src/client/request/search-params.browser.prod.ts",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.prod.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.prod.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.prod.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,32 @@\n+import type { SearchParams } from '../../server/request/search-params'\n+\n+import { wellKnownProperties } from '../../shared/lib/utils/reflect-utils'\n+\n+interface CacheLifetime {}\n+const CachedSearchParams = new WeakMap<CacheLifetime, Promise<SearchParams>>()\n+\n+export function makeUntrackedExoticSearchParams(\n+  underlyingSearchParams: SearchParams\n+): Promise<SearchParams> {\n+  const cachedSearchParams = CachedSearchParams.get(underlyingSearchParams)\n+  if (cachedSearchParams) {\n+    return cachedSearchParams\n+  }\n+\n+  // We don't use makeResolvedReactPromise here because searchParams\n+  // supports copying with spread and we don't want to unnecessarily\n+  // instrument the promise with spreadable properties of ReactPromise.\n+  const promise = Promise.resolve(underlyingSearchParams)\n+  CachedSearchParams.set(underlyingSearchParams, promise)\n+\n+  Object.keys(underlyingSearchParams).forEach((prop) => {\n+    if (wellKnownProperties.has(prop)) {\n+      // These properties cannot be shadowed because they need to be the\n+      // true underlying value for Promises to work correctly at runtime\n+    } else {\n+      ;(promise as any)[prop] = underlyingSearchParams[prop]\n+    }\n+  })\n+\n+  return promise\n+}"
        },
        {
            "sha": "53147aef95ac3d8de1124c1c739ff90ce4bc269c",
            "filename": "packages/next/src/client/request/search-params.browser.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Frequest%2Fsearch-params.browser.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,8 @@\n+export const createRenderSearchParamsFromClient =\n+  process.env.NODE_ENV === 'development'\n+    ? (\n+        require('./search-params.browser.dev') as typeof import('./search-params.browser.dev')\n+      ).makeUntrackedExoticSearchParamsWithDevWarnings\n+    : (\n+        require('./search-params.browser.prod') as typeof import('./search-params.browser.prod')\n+      ).makeUntrackedExoticSearchParams"
        },
        {
            "sha": "b644625942e393ced8d0e7f53884a4633b884c3c",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -62,7 +62,7 @@ import type { DeepReadonly } from '../shared/lib/deep-readonly'\n import { isInterceptionRouteRewrite } from '../lib/generate-interception-routes-rewrites'\n import type { ActionManifest } from '../build/webpack/plugins/flight-client-entry-plugin'\n import { extractInfoFromServerReferenceId } from '../shared/lib/server-reference-info'\n-import { convertSegmentPathToStaticExportFilename } from '../server/app-render/segment-value-encoding'\n+import { convertSegmentPathToStaticExportFilename } from '../shared/lib/segment-cache/segment-value-encoding'\n \n export class ExportError extends Error {\n   code = 'NEXT_EXPORT_ERROR'"
        },
        {
            "sha": "837e528b565bc799dac57caee95507c7adbf8f53",
            "filename": "packages/next/src/lib/create-client-router-filter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Flib%2Fcreate-client-router-filter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Flib%2Fcreate-client-router-filter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fcreate-client-router-filter.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -7,7 +7,7 @@ import { tryToParsePath } from './try-to-parse-path'\n import {\n   extractInterceptionRouteInformation,\n   isInterceptionRouteAppPath,\n-} from '../server/lib/interception-routes'\n+} from '../shared/lib/router/utils/interception-routes'\n \n export function createClientRouterFilter(\n   paths: string[],"
        },
        {
            "sha": "a178919e4d9eaf01d83666eba06b484ebb218637",
            "filename": "packages/next/src/lib/generate-interception-routes-rewrites.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Flib%2Fgenerate-interception-routes-rewrites.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Flib%2Fgenerate-interception-routes-rewrites.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fgenerate-interception-routes-rewrites.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -3,7 +3,7 @@ import { NEXT_URL } from '../client/components/app-router-headers'\n import {\n   extractInterceptionRouteInformation,\n   isInterceptionRouteAppPath,\n-} from '../server/lib/interception-routes'\n+} from '../shared/lib/router/utils/interception-routes'\n import type { Rewrite } from './load-custom-routes'\n \n // a function that converts normalised paths (e.g. /foo/[bar]/[baz]) to the format expected by pathToRegexp (e.g. /foo/:bar/:baz)"
        },
        {
            "sha": "2fa206d74678d676b8ead641457d4bfdf585442c",
            "filename": "packages/next/src/lib/metadata/async-metadata.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 80,
            "changes": 80,
            "blob_url": "https://github.com/vercel/next.js/blob/f1256388bb3d00ba328a5a90689f8763832a2bab/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fasync-metadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f1256388bb3d00ba328a5a90689f8763832a2bab/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fasync-metadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fasync-metadata.tsx?ref=f1256388bb3d00ba328a5a90689f8763832a2bab",
            "patch": "@@ -1,80 +0,0 @@\n-'use client'\n-\n-import { Suspense, use } from 'react'\n-import { useServerInsertedMetadata } from '../../server/app-render/metadata-insertion/use-server-inserted-metadata'\n-\n-export type StreamingMetadataResolvedState = {\n-  metadata: React.ReactNode\n-  error: unknown | null\n-  digest: string | undefined\n-}\n-\n-function ServerInsertMetadata({\n-  promise,\n-}: {\n-  promise: Promise<StreamingMetadataResolvedState>\n-}) {\n-  // Apply use() to the metadata promise to suspend the rendering in SSR.\n-  const { metadata } = use(promise)\n-  // Insert metadata into the HTML stream through the `useServerInsertedMetadata`\n-  useServerInsertedMetadata(() => metadata)\n-\n-  return null\n-}\n-\n-function BrowserResolvedMetadata({\n-  promise,\n-}: {\n-  promise: Promise<StreamingMetadataResolvedState>\n-}) {\n-  const { metadata, error } = use(promise)\n-  // If there's metadata error on client, discard the browser metadata\n-  // and let metadata outlet deal with the error. This will avoid the duplication metadata.\n-  if (error) return null\n-  return metadata\n-}\n-\n-export function AsyncMetadata({\n-  promise,\n-}: {\n-  promise: Promise<StreamingMetadataResolvedState>\n-}) {\n-  return (\n-    <>\n-      {typeof window === 'undefined' ? (\n-        <ServerInsertMetadata promise={promise} />\n-      ) : (\n-        <BrowserResolvedMetadata promise={promise} />\n-      )}\n-    </>\n-  )\n-}\n-\n-function MetadataOutlet({\n-  promise,\n-}: {\n-  promise: Promise<StreamingMetadataResolvedState>\n-}) {\n-  const { error, digest } = use(promise)\n-  if (error) {\n-    if (digest) {\n-      // The error will lose its original digest after passing from server layer to client layerï¼›\n-      // We recover the digest property here to override the React created one if original digest exists.\n-      ;(error as any).digest = digest\n-    }\n-    throw error\n-  }\n-  return null\n-}\n-\n-export function AsyncMetadataOutlet({\n-  promise,\n-}: {\n-  promise: Promise<StreamingMetadataResolvedState>\n-}) {\n-  return (\n-    <Suspense fallback={null}>\n-      <MetadataOutlet promise={promise} />\n-    </Suspense>\n-  )\n-}"
        },
        {
            "sha": "5bff4e8363df99bf68341bed0dbabc721d69916f",
            "filename": "packages/next/src/lib/metadata/metadata.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -3,7 +3,7 @@ import type { ParsedUrlQuery } from 'querystring'\n import type { GetDynamicParamFromSegment } from '../../server/app-render/app-render'\n import type { LoaderTree } from '../../server/lib/app-dir-module'\n import type { CreateServerParamsForMetadata } from '../../server/request/params'\n-import type { StreamingMetadataResolvedState } from './async-metadata'\n+import type { StreamingMetadataResolvedState } from '../../client/components/metadata/types'\n import {\n   AppleWebAppMeta,\n   FormatDetectionMeta,\n@@ -37,7 +37,10 @@ import {\n   METADATA_BOUNDARY_NAME,\n   VIEWPORT_BOUNDARY_NAME,\n } from './metadata-constants'\n-import { AsyncMetadata, AsyncMetadataOutlet } from './async-metadata'\n+import {\n+  AsyncMetadata,\n+  AsyncMetadataOutlet,\n+} from '../../client/components/metadata/async-metadata'\n import { isPostpone } from '../../server/lib/router-utils/is-postpone'\n \n // Use a promise to share the status of the metadata resolving,"
        },
        {
            "sha": "dd18c1c5397d2678cdb4aef2236bdb9f22e380a0",
            "filename": "packages/next/src/pages/_error.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fpages%2F_error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fpages%2F_error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fpages%2F_error.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,7 +1,6 @@\n import React from 'react'\n import Head from '../shared/lib/head'\n import type { NextPageContext } from '../shared/lib/utils'\n-import { getRequestMeta } from '../server/request-meta'\n \n const statusCodes: { [code: number]: string } = {\n   400: 'Bad Request',\n@@ -30,6 +29,9 @@ function _getInitialProps({\n   if (typeof window !== 'undefined') {\n     hostname = window.location.hostname\n   } else if (req) {\n+    const { getRequestMeta } =\n+      require('../server/request-meta') as typeof import('../server/request-meta')\n+\n     const initUrl = getRequestMeta(req, 'initURL')\n     if (initUrl) {\n       const url = new URL(initUrl)"
        },
        {
            "sha": "1ec7b2a07f258b25a5a26032cafbf35bfb57dd18",
            "filename": "packages/next/src/server/app-render/collect-segment-data.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -26,7 +26,7 @@ import {\n   encodeSegment,\n   ROOT_SEGMENT_KEY,\n   type EncodedSegment,\n-} from './segment-value-encoding'\n+} from '../../shared/lib/segment-cache/segment-value-encoding'\n import { getDigestForWellKnownError } from './create-error-handler'\n import type { FallbackRouteParams } from '../request/fallback-params'\n "
        },
        {
            "sha": "e0755550e3fef50c531bb0c7131176feb8d849d4",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 28,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -564,35 +564,33 @@ export function annotateDynamicAccess(\n }\n \n export function useDynamicRouteParams(expression: string) {\n-  if (typeof window === 'undefined') {\n-    const workStore = workAsyncStorage.getStore()\n+  const workStore = workAsyncStorage.getStore()\n \n-    if (\n-      workStore &&\n-      workStore.isStaticGeneration &&\n-      workStore.fallbackRouteParams &&\n-      workStore.fallbackRouteParams.size > 0\n-    ) {\n-      // There are fallback route params, we should track these as dynamic\n-      // accesses.\n-      const workUnitStore = workUnitAsyncStorage.getStore()\n-      if (workUnitStore) {\n-        // We're prerendering with dynamicIO or PPR or both\n-        if (workUnitStore.type === 'prerender') {\n-          // We are in a prerender with dynamicIO semantics\n-          // We are going to hang here and never resolve. This will cause the currently\n-          // rendering component to effectively be a dynamic hole\n-          React.use(makeHangingPromise(workUnitStore.renderSignal, expression))\n-        } else if (workUnitStore.type === 'prerender-ppr') {\n-          // We're prerendering with PPR\n-          postponeWithTracking(\n-            workStore.route,\n-            expression,\n-            workUnitStore.dynamicTracking\n-          )\n-        } else if (workUnitStore.type === 'prerender-legacy') {\n-          throwToInterruptStaticGeneration(expression, workStore, workUnitStore)\n-        }\n+  if (\n+    workStore &&\n+    workStore.isStaticGeneration &&\n+    workStore.fallbackRouteParams &&\n+    workStore.fallbackRouteParams.size > 0\n+  ) {\n+    // There are fallback route params, we should track these as dynamic\n+    // accesses.\n+    const workUnitStore = workUnitAsyncStorage.getStore()\n+    if (workUnitStore) {\n+      // We're prerendering with dynamicIO or PPR or both\n+      if (workUnitStore.type === 'prerender') {\n+        // We are in a prerender with dynamicIO semantics\n+        // We are going to hang here and never resolve. This will cause the currently\n+        // rendering component to effectively be a dynamic hole\n+        React.use(makeHangingPromise(workUnitStore.renderSignal, expression))\n+      } else if (workUnitStore.type === 'prerender-ppr') {\n+        // We're prerendering with PPR\n+        postponeWithTracking(\n+          workStore.route,\n+          expression,\n+          workUnitStore.dynamicTracking\n+        )\n+      } else if (workUnitStore.type === 'prerender-legacy') {\n+        throwToInterruptStaticGeneration(expression, workStore, workUnitStore)\n       }\n     }\n   }"
        },
        {
            "sha": "f0c2ae4e1a4966cfebb850381511e539eaf51c7f",
            "filename": "packages/next/src/server/app-render/entry-base.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -37,7 +37,7 @@ import {\n   MetadataBoundary,\n   ViewportBoundary,\n   OutletBoundary,\n-} from '../../lib/metadata/metadata-boundary'\n+} from '../../client/components/metadata/metadata-boundary'\n \n import { preloadStyle, preloadFont, preconnect } from './rsc/preloads'\n import { Postpone } from './rsc/postpone'"
        },
        {
            "sha": "f3c8ecc81d7b854f95061b88dc56b30b5769dd33",
            "filename": "packages/next/src/server/app-render/get-segment-param.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-segment-param.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-segment-param.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-segment-param.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,4 +1,4 @@\n-import { INTERCEPTION_ROUTE_MARKERS } from '../lib/interception-routes'\n+import { INTERCEPTION_ROUTE_MARKERS } from '../../shared/lib/router/utils/interception-routes'\n import type { DynamicParamTypes } from './types'\n \n /**"
        },
        {
            "sha": "de48498901b28cb745964993d730630f1ba65bc4",
            "filename": "packages/next/src/server/app-render/metadata-insertion/use-server-inserted-metadata.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 19,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/f1256388bb3d00ba328a5a90689f8763832a2bab/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fuse-server-inserted-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1256388bb3d00ba328a5a90689f8763832a2bab/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fuse-server-inserted-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmetadata-insertion%2Fuse-server-inserted-metadata.ts?ref=f1256388bb3d00ba328a5a90689f8763832a2bab",
            "patch": "@@ -1,19 +0,0 @@\n-'use client'\n-\n-import { useContext } from 'react'\n-import {\n-  type MetadataResolver,\n-  ServerInsertedMetadataContext,\n-} from '../../../shared/lib/server-inserted-metadata.shared-runtime'\n-\n-// Receives a metadata resolver setter from the context, and will pass the metadata resolving promise to\n-// the context where we gonna use it to resolve the metadata, and render as string to append in <body>.\n-export const useServerInsertedMetadata = (\n-  metadataResolver: MetadataResolver\n-) => {\n-  const setMetadataResolver = useContext(ServerInsertedMetadataContext)\n-\n-  if (setMetadataResolver) {\n-    setMetadataResolver(metadataResolver)\n-  }\n-}"
        },
        {
            "sha": "5dffcc577c69baf2f35d479d754e8ff262366bcf",
            "filename": "packages/next/src/server/app-render/walk-tree-with-flight-router-state.tsx",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -5,10 +5,7 @@ import type {\n   PreloadCallbacks,\n   Segment,\n } from './types'\n-import {\n-  canSegmentBeOverridden,\n-  matchSegment,\n-} from '../../client/components/match-segments'\n+import { matchSegment } from '../../client/components/match-segments'\n import type { LoaderTree } from '../lib/app-dir-module'\n import { getLinkAndScriptTags } from './get-css-inlined-link-tags'\n import { getPreloadableFonts } from './get-preloadable-fonts'\n@@ -21,6 +18,7 @@ import {\n } from '../../shared/lib/segment'\n import { createComponentTree } from './create-component-tree'\n import type { HeadData } from '../../shared/lib/app-router-context.shared-runtime'\n+import { getSegmentParam } from './get-segment-param'\n \n /**\n  * Use router state to decide at what common layout to render the page.\n@@ -286,3 +284,18 @@ export async function walkTreeWithFlightRouterState({\n \n   return paths\n }\n+\n+/*\n+ * This function is used to determine if an existing segment can be overridden\n+ * by the incoming segment.\n+ */\n+const canSegmentBeOverridden = (\n+  existingSegment: Segment,\n+  segment: Segment\n+): boolean => {\n+  if (Array.isArray(existingSegment) || !Array.isArray(segment)) {\n+    return false\n+  }\n+\n+  return getSegmentParam(existingSegment)?.param === segment[0]\n+}"
        },
        {
            "sha": "fd067d5e79b27b0fa557e27a90e266cb5cfa1a0c",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -153,7 +153,7 @@ import {\n import { PrefetchRSCPathnameNormalizer } from './normalizers/request/prefetch-rsc'\n import { NextDataPathnameNormalizer } from './normalizers/request/next-data'\n import { getIsServerAction } from './lib/server-action-request-meta'\n-import { isInterceptionRouteAppPath } from './lib/interception-routes'\n+import { isInterceptionRouteAppPath } from '../shared/lib/router/utils/interception-routes'\n import { toRoute } from './lib/to-route'\n import type { DeepReadonly } from '../shared/lib/deep-readonly'\n import { isNodeNextRequest, isNodeNextResponse } from './base-http/helpers'"
        },
        {
            "sha": "f0ee12bd034aabd1040e81a122e359b75ff02fee",
            "filename": "packages/next/src/server/request/params.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -17,7 +17,10 @@ import {\n   type PrerenderStoreModern,\n } from '../app-render/work-unit-async-storage.external'\n import { InvariantError } from '../../shared/lib/invariant-error'\n-import { describeStringPropertyAccess, wellKnownProperties } from './utils'\n+import {\n+  describeStringPropertyAccess,\n+  wellKnownProperties,\n+} from '../../shared/lib/utils/reflect-utils'\n import { makeHangingPromise } from '../dynamic-rendering-utils'\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n import { scheduleImmediate } from '../../lib/scheduler'"
        },
        {
            "sha": "3b6643159b67d4d4d4ff235bdb24004b2919288a",
            "filename": "packages/next/src/server/request/root-params.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -16,7 +16,10 @@ import {\n import { makeHangingPromise } from '../dynamic-rendering-utils'\n import type { FallbackRouteParams } from './fallback-params'\n import type { Params } from './params'\n-import { describeStringPropertyAccess, wellKnownProperties } from './utils'\n+import {\n+  describeStringPropertyAccess,\n+  wellKnownProperties,\n+} from '../../shared/lib/utils/reflect-utils'\n \n interface CacheLifetime {}\n const CachedParams = new WeakMap<CacheLifetime, Promise<Params>>()"
        },
        {
            "sha": "55379276eefb447787caf8a39f3021842915f0ed",
            "filename": "packages/next/src/server/request/search-params.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -23,8 +23,10 @@ import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-b\n import {\n   describeStringPropertyAccess,\n   describeHasCheckingStringProperty,\n-  throwWithStaticGenerationBailoutErrorWithDynamicError,\n   wellKnownProperties,\n+} from '../../shared/lib/utils/reflect-utils'\n+import {\n+  throwWithStaticGenerationBailoutErrorWithDynamicError,\n   throwForSearchParamsAccessInUseCache,\n } from './utils'\n import { scheduleImmediate } from '../../lib/scheduler'"
        },
        {
            "sha": "e7855d394ce45f386bc1e2a9af63a3625dc2ca23",
            "filename": "packages/next/src/server/request/utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 50,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,28 +1,6 @@\n import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n import { afterTaskAsyncStorage } from '../app-render/after-task-async-storage.external'\n \n-// This regex will have fast negatives meaning valid identifiers may not pass\n-// this test. However this is only used during static generation to provide hints\n-// about why a page bailed out of some or all prerendering and we can use bracket notation\n-// for example while `à² _à² ` is a valid identifier it's ok to print `searchParams['à² _à² ']`\n-// even if this would have been fine too `searchParams.à² _à² `\n-const isDefinitelyAValidIdentifier = /^[A-Za-z_$][A-Za-z0-9_$]*$/\n-\n-export function describeStringPropertyAccess(target: string, prop: string) {\n-  if (isDefinitelyAValidIdentifier.test(prop)) {\n-    return `\\`${target}.${prop}\\``\n-  }\n-  return `\\`${target}[${JSON.stringify(prop)}]\\``\n-}\n-\n-export function describeHasCheckingStringProperty(\n-  target: string,\n-  prop: string\n-) {\n-  const stringifiedProp = JSON.stringify(prop)\n-  return `\\`Reflect.has(${target}, ${stringifiedProp})\\`, \\`${stringifiedProp} in ${target}\\`, or similar`\n-}\n-\n export function throwWithStaticGenerationBailoutError(\n   route: string,\n   expression: string\n@@ -51,31 +29,3 @@ export function isRequestAPICallableInsideAfter() {\n   const afterTaskStore = afterTaskAsyncStorage.getStore()\n   return afterTaskStore?.rootTaskSpawnPhase === 'action'\n }\n-\n-export const wellKnownProperties = new Set([\n-  'hasOwnProperty',\n-  'isPrototypeOf',\n-  'propertyIsEnumerable',\n-  'toString',\n-  'valueOf',\n-  'toLocaleString',\n-\n-  // Promise prototype\n-  // fallthrough\n-  'then',\n-  'catch',\n-  'finally',\n-\n-  // React Promise extension\n-  // fallthrough\n-  'status',\n-\n-  // React introspection\n-  'displayName',\n-\n-  // Common tested properties\n-  // fallthrough\n-  'toJSON',\n-  '$$typeof',\n-  '__esModule',\n-])"
        },
        {
            "sha": "3f61778122081d53343664fdc3bafa4e9b0a8691",
            "filename": "packages/next/src/shared/lib/router/utils/interception-routes.test.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Finterception-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Finterception-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Finterception-routes.test.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "previous_filename": "packages/next/src/server/lib/interception-routes.test.ts"
        },
        {
            "sha": "a899657e0f66e4f8b78bd4979bd3284e76b0aec6",
            "filename": "packages/next/src/shared/lib/router/utils/interception-routes.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Finterception-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Finterception-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Finterception-routes.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,4 +1,4 @@\n-import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n+import { normalizeAppPath } from './app-paths'\n \n // order matters here, the first match will be used\n export const INTERCEPTION_ROUTE_MARKERS = [",
            "previous_filename": "packages/next/src/server/lib/interception-routes.ts"
        },
        {
            "sha": "5f2e0907617120833438c4830746dc7ad5ce3c46",
            "filename": "packages/next/src/shared/lib/router/utils/is-dynamic.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fis-dynamic.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fis-dynamic.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fis-dynamic.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,7 +1,7 @@\n import {\n   extractInterceptionRouteInformation,\n   isInterceptionRouteAppPath,\n-} from '../../../../server/lib/interception-routes'\n+} from './interception-routes'\n \n // Identify /.*[param].*/ in route string\n const TEST_ROUTE = /\\/[^/]*\\[[^/]+\\][^/]*(?=\\/|$)/"
        },
        {
            "sha": "fcccfe69e33d05bf291f118774805dc10d71d5ed",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -10,7 +10,7 @@ import { parseUrl } from './parse-url'\n import {\n   INTERCEPTION_ROUTE_MARKERS,\n   isInterceptionRouteAppPath,\n-} from '../../../../server/lib/interception-routes'\n+} from './interception-routes'\n import { NEXT_RSC_UNION_QUERY } from '../../../../client/components/app-router-headers'\n import { getCookieParser } from '../../../../server/api-utils/get-cookie-parser'\n import type { Params } from '../../../../server/request/params'"
        },
        {
            "sha": "9d255f3fbcd04e8a1043eaf86db15468e94c9ad4",
            "filename": "packages/next/src/shared/lib/router/utils/route-regex.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-regex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-regex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Froute-regex.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -2,7 +2,7 @@ import {\n   NEXT_INTERCEPTION_MARKER_PREFIX,\n   NEXT_QUERY_PARAM_PREFIX,\n } from '../../../../lib/constants'\n-import { INTERCEPTION_ROUTE_MARKERS } from '../../../../server/lib/interception-routes'\n+import { INTERCEPTION_ROUTE_MARKERS } from './interception-routes'\n import { escapeStringRegexp } from '../../escape-regexp'\n import { removeTrailingSlash } from './remove-trailing-slash'\n "
        },
        {
            "sha": "11c217a70bc46dcdbf7f4ecae430e72c2128d6f8",
            "filename": "packages/next/src/shared/lib/segment-cache/segment-value-encoding.ts",
            "status": "renamed",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment-cache%2Fsegment-value-encoding.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment-cache%2Fsegment-value-encoding.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fsegment-cache%2Fsegment-value-encoding.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -1,5 +1,5 @@\n-import { PAGE_SEGMENT_KEY } from '../../shared/lib/segment'\n-import type { Segment as FlightRouterStateSegment } from './types'\n+import { PAGE_SEGMENT_KEY } from '../segment'\n+import type { Segment as FlightRouterStateSegment } from '../../../server/app-render/types'\n \n // TypeScript trick to simulate opaque types, like in Flow.\n type Opaque<K, T> = T & { __brand: K }",
            "previous_filename": "packages/next/src/server/app-render/segment-value-encoding.ts"
        },
        {
            "sha": "36e4f5c8b11f34ae10e756518973e7e0b0b4c738",
            "filename": "packages/next/src/shared/lib/utils/reflect-utils.ts",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Futils%2Freflect-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Futils%2Freflect-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Futils%2Freflect-utils.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,49 @@\n+// This regex will have fast negatives meaning valid identifiers may not pass\n+// this test. However this is only used during static generation to provide hints\n+// about why a page bailed out of some or all prerendering and we can use bracket notation\n+// for example while `à² _à² ` is a valid identifier it's ok to print `searchParams['à² _à² ']`\n+// even if this would have been fine too `searchParams.à² _à² `\n+const isDefinitelyAValidIdentifier = /^[A-Za-z_$][A-Za-z0-9_$]*$/\n+\n+export function describeStringPropertyAccess(target: string, prop: string) {\n+  if (isDefinitelyAValidIdentifier.test(prop)) {\n+    return `\\`${target}.${prop}\\``\n+  }\n+  return `\\`${target}[${JSON.stringify(prop)}]\\``\n+}\n+\n+export function describeHasCheckingStringProperty(\n+  target: string,\n+  prop: string\n+) {\n+  const stringifiedProp = JSON.stringify(prop)\n+  return `\\`Reflect.has(${target}, ${stringifiedProp})\\`, \\`${stringifiedProp} in ${target}\\`, or similar`\n+}\n+\n+export const wellKnownProperties = new Set([\n+  'hasOwnProperty',\n+  'isPrototypeOf',\n+  'propertyIsEnumerable',\n+  'toString',\n+  'valueOf',\n+  'toLocaleString',\n+\n+  // Promise prototype\n+  // fallthrough\n+  'then',\n+  'catch',\n+  'finally',\n+\n+  // React Promise extension\n+  // fallthrough\n+  'status',\n+\n+  // React introspection\n+  'displayName',\n+\n+  // Common tested properties\n+  // fallthrough\n+  'toJSON',\n+  '$$typeof',\n+  '__esModule',\n+])"
        },
        {
            "sha": "9fb8b1059fe419e6bb7698175ac65e30c8377213",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -535,6 +535,22 @@ export class NextInstance {\n     return fs.readFile(path.join(this.testDir, filename), 'utf8')\n   }\n \n+  public async readFiles(\n+    dirname: string,\n+    predicate: (filename: string) => boolean\n+  ) {\n+    const absoluteDirname = path.join(this.testDir, dirname)\n+    const filenames = await fs.readdir(absoluteDirname, 'utf-8')\n+\n+    return Promise.all(\n+      filenames\n+        .filter(predicate)\n+        .map((filename) =>\n+          fs.readFile(path.join(absoluteDirname, filename), 'utf8')\n+        )\n+    )\n+  }\n+\n   public readFileSync(filename: string) {\n     return readFileSync(path.join(this.testDir, filename), 'utf8')\n   }"
        },
        {
            "sha": "4965832f2c9b0605eaa189b7c7fb11124d24e48a",
            "filename": "test/production/app-dir/browser-chunks/app/favicon.ico",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Ffavicon.ico",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Ffavicon.ico",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Ffavicon.ico?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428"
        },
        {
            "sha": "e7077399c03ce1479a655dc647c0545b64531628",
            "filename": "test/production/app-dir/browser-chunks/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Flayout.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/production/app-dir/browser-chunks/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fapp%2Fpage.tsx?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "cfc6c74d00bd62baf076b97ce856b45733d12243",
            "filename": "test/production/app-dir/browser-chunks/browser-chunks.test.ts",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,39 @@\n+/* eslint-disable jest/no-standalone-expect */\n+import { nextTestSetup } from 'e2e-utils'\n+import { SourceMapPayload } from 'module'\n+\n+describe('browser-chunks', () => {\n+  const { next, isTurbopack } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  ;(isTurbopack ? it.skip : it)(\n+    'must not bundle any server modules into browser chunks',\n+    async () => {\n+      const sourcemaps = await next.readFiles(\n+        '.next/static/chunks',\n+        (filename) => filename.endsWith('.js.map')\n+      )\n+\n+      const sources = sourcemaps.flatMap(\n+        (sourcemap) => (JSON.parse(sourcemap) as SourceMapPayload).sources\n+      )\n+\n+      const serverSources = sources.filter(\n+        (source) =>\n+          /webpack:\\/\\/_N_E\\/(\\.\\.\\/)*src\\/server\\//.test(source) ||\n+          source.includes('next/dist/esm/server') ||\n+          source.includes('next/dist/server')\n+      )\n+\n+      if (serverSources.length > 0) {\n+        console.error(\n+          `Found the following server modules:\\n  ${serverSources.join('\\n  ')}\\nIf any of these modules are allowed to be included in browser chunks, move them to src/shared or src/client.`\n+        )\n+\n+        throw new Error('Did not expect any server modules in browser chunks.')\n+      }\n+    }\n+  )\n+})"
        },
        {
            "sha": "11e1418b06aa45803bc47150b2cddd9c7f0945f2",
            "filename": "test/production/app-dir/browser-chunks/next.config.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9118a0b609a7b701d4fd4bd7846dd939c5076428/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fnext.config.js?ref=9118a0b609a7b701d4fd4bd7846dd939c5076428",
            "patch": "@@ -0,0 +1,8 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  productionBrowserSourceMaps: true,\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 805,
        "additions": 465,
        "deletions": 340
    }
}