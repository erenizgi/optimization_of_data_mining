{
    "author": "lukesandberg",
    "message": "Make turbopack the default bundler for custom servers (#84281)\n\nMake Turbopack the default bundler for custom servers ðŸš€ \n\nIn the same line as #84216 we want to ship turbopack by default, but now for programmatic usecases.\n\n### What?\n\nHave the custom server entrypoint perform the same 'turbopack by default' logic as the main next entrypoints.  This was a little tricky since next itself uses the custom server entrypoints.  So i have adjusted this function to only perform the logic if it is a custom server since otherwise the next process already has the correct environment variables set\n\nAlso deprecate the `turbo` property while we are there.",
    "sha": "1c5a74063dce8225a7eaf92989b4a387e0ba82a9",
    "files": [
        {
            "sha": "cd3f62c8209f271556ad8303c1d8555e9a87a8ec",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1c5a74063dce8225a7eaf92989b4a387e0ba82a9/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/1c5a74063dce8225a7eaf92989b4a387e0ba82a9/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=1c5a74063dce8225a7eaf92989b4a387e0ba82a9",
            "patch": "@@ -848,5 +848,7 @@\n   \"847\": \"Route %s with \\\\`dynamic = \\\"error\\\"\\\\` couldn't be rendered statically because it used \\\\`connection()\\\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering\",\n   \"848\": \"%sused %s. \\\\`searchParams\\\\` is a Promise and must be unwrapped with \\\\`await\\\\` or \\\\`React.use()\\\\` before accessing its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n   \"849\": \"Route %s with \\\\`dynamic = \\\"error\\\"\\\\` couldn't be rendered statically because it used \\\\`cookies()\\\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering\",\n-  \"850\": \"metadataBase is not a valid URL: %s\"\n+  \"850\": \"metadataBase is not a valid URL: %s\",\n+  \"851\": \"Pass either `webpack` or `turbopack`, not both.\",\n+  \"852\": \"Only custom servers can pass `webpack`, `turbo`, or `turbopack`.\"\n }"
        },
        {
            "sha": "9f479bc0996f318b97ba3db117523b3432fbab34",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 10,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/1c5a74063dce8225a7eaf92989b4a387e0ba82a9/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1c5a74063dce8225a7eaf92989b4a387e0ba82a9/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=1c5a74063dce8225a7eaf92989b4a387e0ba82a9",
            "patch": "@@ -52,6 +52,15 @@ export type NextServerOptions = Omit<\n > &\n   Partial<Pick<ServerOptions | DevServerOptions, 'conf'>>\n \n+export type NextBundlerOptions = {\n+  /** @deprecated Use `turbopack` instead */\n+  turbo?: boolean\n+  /** Selects Turbopack as the bundler */\n+  turbopack?: boolean\n+  /** Selects Webpack as the bundler */\n+  webpack?: boolean\n+}\n+\n export type RequestHandler = (\n   req: IncomingMessage,\n   res: ServerResponse,\n@@ -531,18 +540,30 @@ class NextCustomServer implements NextWrapperServer {\n \n // This file is used for when users run `require('next')`\n function createServer(\n-  options: NextServerOptions & {\n-    turbo?: boolean\n-    turbopack?: boolean\n-  }\n+  options: NextServerOptions & NextBundlerOptions\n ): NextWrapperServer {\n-  if (\n-    options &&\n-    (options.turbo || options.turbopack || process.env.IS_TURBOPACK_TEST)\n-  ) {\n-    // Configure TURBOPACK if it isn't already set\n-    process.env.TURBOPACK ??= '1'\n+  // next sets customServer to false when calling this function, in that case we don't want to modify the environment variables\n+  const isCustomServer = options?.customServer ?? true\n+  if (isCustomServer) {\n+    const selectTurbopack =\n+      options &&\n+      (options.turbo || options.turbopack || process.env.IS_TURBOPACK_TEST)\n+    const selectWebpack =\n+      options && (options.webpack || process.env.IS_WEBPACK_TEST)\n+    if (selectTurbopack && selectWebpack) {\n+      throw new Error('Pass either `webpack` or `turbopack`, not both.')\n+    }\n+    if (selectTurbopack || !selectWebpack) {\n+      process.env.TURBOPACK ??= selectTurbopack ? '1' : 'auto'\n+    }\n+  } else {\n+    if (options && (options.webpack || options.turbo || options.turbopack)) {\n+      throw new Error(\n+        'Only custom servers can pass `webpack`, `turbo`, or `turbopack`.'\n+      )\n+    }\n   }\n+\n   // The package is used as a TypeScript plugin.\n   if (\n     options &&"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 34,
        "deletions": 11
    }
}