{
    "author": "mischnic",
    "message": "Turbopack: fix ESM project in standalone mode (#78774)",
    "sha": "b492477e4e447030ee3d7cb88a3b27ae6a0eaf05",
    "files": [
        {
            "sha": "381888bad81b44456e9edffc8ac4d4eaed456cf6",
            "filename": "packages/next/src/build/collect-build-traces.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b492477e4e447030ee3d7cb88a3b27ae6a0eaf05/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b492477e4e447030ee3d7cb88a3b27ae6a0eaf05/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts?ref=b492477e4e447030ee3d7cb88a3b27ae6a0eaf05",
            "patch": "@@ -82,6 +82,7 @@ export async function collectBuildTraces({\n   hasSsrAmpPages,\n   buildTraceContext,\n   outputFileTracingRoot,\n+  isTurbopack,\n }: {\n   dir: string\n   distDir: string\n@@ -93,6 +94,7 @@ export async function collectBuildTraces({\n   nextBuildSpan?: Span\n   config: NextConfigComplete\n   buildTraceContext?: BuildTraceContext\n+  isTurbopack: boolean\n }) {\n   const startTime = Date.now()\n   debug('starting build traces')\n@@ -278,6 +280,11 @@ export async function collectBuildTraces({\n         )\n       }\n \n+      if (isTurbopack) {\n+        addToTracedFiles(distDir, './package.json', serverTracedFiles)\n+        addToTracedFiles(distDir, './package.json', minimalServerTracedFiles)\n+      }\n+\n       {\n         const chunksToTrace: string[] = [\n           ...(buildTraceContext?.chunksTrace?.action.input || []),"
        },
        {
            "sha": "ba9eaa5d14cdf035611ab28a47e7fe7e5fbb863c",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b492477e4e447030ee3d7cb88a3b27ae6a0eaf05/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b492477e4e447030ee3d7cb88a3b27ae6a0eaf05/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=b492477e4e447030ee3d7cb88a3b27ae6a0eaf05",
            "patch": "@@ -1516,6 +1516,7 @@ export default async function build(\n                     hasSsrAmpPages: false,\n                     buildTraceContext,\n                     outputFileTracingRoot,\n+                    isTurbopack: false,\n                   })\n                   .catch((err) => {\n                     console.error(err)\n@@ -2441,6 +2442,7 @@ export default async function build(\n           hasSsrAmpPages,\n           buildTraceContext,\n           outputFileTracingRoot,\n+          isTurbopack: true,\n         }).catch((err) => {\n           console.error(err)\n           process.exit(1)"
        },
        {
            "sha": "ee46e10683129fd113b1396f549a239709f399be",
            "filename": "test/e2e/app-dir/app-esm-js/standalone.test.ts",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/vercel/next.js/blob/b492477e4e447030ee3d7cb88a3b27ae6a0eaf05/test%2Fe2e%2Fapp-dir%2Fapp-esm-js%2Fstandalone.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b492477e4e447030ee3d7cb88a3b27ae6a0eaf05/test%2Fe2e%2Fapp-dir%2Fapp-esm-js%2Fstandalone.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-esm-js%2Fstandalone.test.ts?ref=b492477e4e447030ee3d7cb88a3b27ae6a0eaf05",
            "patch": "@@ -0,0 +1,72 @@\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+import fs from 'fs-extra'\n+import os from 'os'\n+import path from 'path'\n+import {\n+  findPort,\n+  initNextServerScript,\n+  killApp,\n+  fetchViaHTTP,\n+} from 'next-test-utils'\n+\n+if (!(globalThis as any).isNextStart) {\n+  it('should skip for non-next start', () => {})\n+} else {\n+  describe('output: standalone with ESM app dir', () => {\n+    const { next, skipped } = nextTestSetup({\n+      files: {\n+        app: new FileRef(path.join(__dirname, 'app')),\n+        pages: new FileRef(path.join(__dirname, 'pages')),\n+        public: new FileRef(path.join(__dirname, 'public')),\n+        'next.config.js': 'export default {\"output\": \"standalone\"}',\n+      },\n+      packageJson: {\n+        type: 'module',\n+      },\n+      skipStart: true,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    beforeAll(async () => {\n+      await next.start()\n+    })\n+\n+    it('should work correctly with output standalone', async () => {\n+      const tmpFolder = path.join(os.tmpdir(), 'next-standalone-' + Date.now())\n+      await fs.mkdirp(tmpFolder)\n+      await fs.writeFile(\n+        path.join(tmpFolder, 'package.json'),\n+        '{\"type\": \"module\"}'\n+      )\n+      const distFolder = path.join(tmpFolder, 'test')\n+      await fs.move(path.join(next.testDir, '.next/standalone'), distFolder)\n+      let server: any\n+      try {\n+        const testServer = path.join(distFolder, 'server.js')\n+        const appPort = await findPort()\n+        server = await initNextServerScript(\n+          testServer,\n+          /- Local:/,\n+          {\n+            ...process.env,\n+            PORT: appPort.toString(),\n+          },\n+          undefined,\n+          {\n+            cwd: distFolder,\n+          }\n+        )\n+        for (const testPath of ['/app', '/pages', '/opengraph-image']) {\n+          const res = await fetchViaHTTP(appPort, testPath)\n+          expect(res.status).toBe(200)\n+        }\n+      } finally {\n+        if (server) await killApp(server)\n+        await fs.remove(tmpFolder)\n+      }\n+    })\n+  })\n+}"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 81,
        "deletions": 0
    }
}