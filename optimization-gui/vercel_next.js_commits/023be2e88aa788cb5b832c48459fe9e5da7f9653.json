{
    "author": "huozhi",
    "message": "metadata: use fixed segment in dynamic routes with static metadata files (#88113)",
    "sha": "023be2e88aa788cb5b832c48459fe9e5da7f9653",
    "files": [
        {
            "sha": "0a58e9f0da3251e399801783052bd21fa9197fc8",
            "filename": "crates/next-core/src/app_page_loader_tree.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/023be2e88aa788cb5b832c48459fe9e5da7f9653/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/023be2e88aa788cb5b832c48459fe9e5da7f9653/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs?ref=023be2e88aa788cb5b832c48459fe9e5da7f9653",
            "patch": "@@ -251,7 +251,7 @@ impl AppPageLoaderTreeBuilder {\n         let metadata_route = &*get_metadata_route_name(item.clone().into()).await?;\n         writeln!(\n             self.loader_tree_code,\n-            \"{s}  url: fillMetadataSegment({}, await props.params, {}) + \\\n+            \"{s}  url: fillMetadataSegment({}, await props.params, {}, true) + \\\n              `?${{{identifier}.src.split(\\\"/\\\").splice(-1)[0]}}`,\",\n             StringifyJs(&pathname_prefix),\n             StringifyJs(metadata_route),"
        },
        {
            "sha": "33de4cbf817d125fc57e79431ad8d4c00fb193d9",
            "filename": "crates/next-core/src/next_app/metadata/image.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/023be2e88aa788cb5b832c48459fe9e5da7f9653/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/023be2e88aa788cb5b832c48459fe9e5da7f9653/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs?ref=023be2e88aa788cb5b832c48459fe9e5da7f9653",
            "patch": "@@ -74,7 +74,7 @@ async fn dynamic_image_metadata_with_generator_source(\n \n             export default async function (props) {{\n                 const {{ __metadata_id__: _, ...params }} = await props.params\n-                const imageUrl = fillMetadataSegment({pathname_prefix}, params, {page_segment})\n+                const imageUrl = fillMetadataSegment({pathname_prefix}, params, {page_segment}, false)\n \n                 const {{ generateImageMetadata }} = imageModule\n \n@@ -148,7 +148,7 @@ async fn dynamic_image_metadata_without_generator_source(\n \n             export default async function (props) {{\n                 const {{ __metadata_id__: _, ...params }} = await props.params\n-                const imageUrl = fillMetadataSegment({pathname_prefix}, params, {page_segment})\n+                const imageUrl = fillMetadataSegment({pathname_prefix}, params, {page_segment}, false)\n \n                 function getImageMetadata(imageMetadata, idParam) {{\n                     const data = {{"
        },
        {
            "sha": "a94c500cf0f0855a8301ae4199bec2ff9c2690ff",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 2,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/023be2e88aa788cb5b832c48459fe9e5da7f9653/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/023be2e88aa788cb5b832c48459fe9e5da7f9653/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=023be2e88aa788cb5b832c48459fe9e5da7f9653",
            "patch": "@@ -85,6 +85,41 @@ import type { TurbopackResult } from './swc/types'\n import type { FunctionsConfigManifest, ManifestRoute } from './index'\n import { getNamedRouteRegex } from '../shared/lib/router/utils/route-regex'\n import { parseAppRoute } from '../shared/lib/router/routes/app'\n+import { fillMetadataSegment } from '../lib/metadata/get-metadata-route'\n+import { STATIC_METADATA_IMAGES } from '../lib/metadata/is-metadata-route'\n+\n+// Build a set of static metadata image filenames for quick lookup\n+const staticMetadataImageFilenames = new Set<string>(\n+  Object.values(STATIC_METADATA_IMAGES).map((meta) => meta.filename)\n+)\n+\n+/**\n+ * Get the display path for build output. For static metadata files under\n+ * dynamic routes, this normalizes the path to use \"-\" placeholder.\n+ * e.g., /dynamic/[id]/icon.png -> /dynamic/-/icon.png\n+ */\n+function getTreeViewDisplayPath(pagePath: string): string {\n+  // Check if the path contains dynamic segments\n+  if (!isDynamicRoute(pagePath)) {\n+    return pagePath\n+  }\n+\n+  // Check if the filename is a static metadata image\n+  const lastSlash = pagePath.lastIndexOf('/')\n+  const filename = pagePath.slice(lastSlash + 1)\n+  const dotIndex = filename.lastIndexOf('.')\n+  const baseName = dotIndex > 0 ? filename.slice(0, dotIndex) : filename\n+\n+  // Check against known static metadata image filenames (e.g., icon, apple-icon, opengraph-image)\n+  if (!staticMetadataImageFilenames.has(baseName)) {\n+    return pagePath\n+  }\n+\n+  // Transform using fillMetadataSegment with isStatic=true\n+  const segment = pagePath.slice(0, lastSlash)\n+  const lastSegment = filename\n+  return fillMetadataSegment(segment, {}, lastSegment, true)\n+}\n \n export type ROUTER_TYPE = 'pages' | 'app'\n \n@@ -416,10 +451,12 @@ export async function printTreeView(\n         symbol = 'ƒ'\n       }\n \n+      const displayPath = getTreeViewDisplayPath(item)\n+\n       if (hasGSPAndRevalidateZero.has(item)) {\n         usedSymbols.add('ƒ')\n         messages.push([\n-          `${border} ƒ ${item}${\n+          `${border} ƒ ${displayPath}${\n             totalDuration > MIN_DURATION\n               ? ` (${getPrettyDuration(totalDuration)})`\n               : ''\n@@ -436,7 +473,7 @@ export async function printTreeView(\n       usedSymbols.add(symbol)\n \n       messages.push([\n-        `${border} ${symbol} ${item}${\n+        `${border} ${symbol} ${displayPath}${\n           totalDuration > MIN_DURATION\n             ? ` (${getPrettyDuration(totalDuration)})`\n             : ''"
        },
        {
            "sha": "e90c4a57acf405c476fb62f18ad37bb677d74698",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-image-loader.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/023be2e88aa788cb5b832c48459fe9e5da7f9653/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/023be2e88aa788cb5b832c48459fe9e5da7f9653/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts?ref=023be2e88aa788cb5b832c48459fe9e5da7f9653",
            "patch": "@@ -91,7 +91,7 @@ async function nextMetadataImageLoader(\n     function getImageMetadata(imageMetadata, idParam, resolvedParams) {\n       const imageUrl = fillMetadataSegment(${JSON.stringify(\n         pathnamePrefix\n-      )}, resolvedParams, ${JSON.stringify(pageSegment)})\n+      )}, resolvedParams, ${JSON.stringify(pageSegment)}, false)\n       const data = {\n         alt: imageMetadata.alt,\n         type: imageMetadata.contentType || 'image/png',\n@@ -175,7 +175,7 @@ async function nextMetadataImageLoader(\n     const imageData = ${JSON.stringify(imageData)}\n     const imageUrl = fillMetadataSegment(${JSON.stringify(\n       pathnamePrefix\n-    )}, await props.params, ${JSON.stringify(pageSegment)})\n+    )}, await props.params, ${JSON.stringify(pageSegment)}, true)\n \n     return [{\n       ...imageData,"
        },
        {
            "sha": "15019bba8af772d3c89c76eff2394b664adb5ae6",
            "filename": "packages/next/src/lib/metadata/get-metadata-route.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 3,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/023be2e88aa788cb5b832c48459fe9e5da7f9653/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fget-metadata-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/023be2e88aa788cb5b832c48459fe9e5da7f9653/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fget-metadata-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fget-metadata-route.ts?ref=023be2e88aa788cb5b832c48459fe9e5da7f9653",
            "patch": "@@ -52,19 +52,39 @@ function getMetadataRouteSuffix(page: string) {\n  * Fill the dynamic segment in the metadata route\n  *\n  * Example:\n- * fillMetadataSegment('/a/[slug]', { params: { slug: 'b' } }, 'open-graph') -> '/a/b/open-graph'\n+ * fillMetadataSegment('/a/[slug]', { params: { slug: 'b' } }, 'open-graph', false) -> '/a/b/open-graph'\n+ *\n+ * When isStatic is true, all dynamic segments are filled with \"-\" placeholder\n+ * since static metadata files have consistent responses regardless of params.\n+ * Example:\n+ * fillMetadataSegment('/a/[slug]', {}, 'icon.png', true) -> '/a/-/icon.png'\n  *\n  */\n export function fillMetadataSegment(\n   segment: string,\n   params: any,\n-  lastSegment: string\n+  lastSegment: string,\n+  isStatic: boolean\n ) {\n   const pathname = normalizeAppPath(segment)\n   const routeRegex = getNamedRouteRegex(pathname, {\n     prefixRouteKeys: false,\n   })\n-  const route = interpolateDynamicPath(pathname, params, routeRegex)\n+\n+  // For static metadata files, fill all dynamic segments with \"-\" placeholder\n+  const routeParams = isStatic\n+    ? Object.keys(routeRegex.groups).reduce(\n+        (acc, key) => {\n+          const { repeat } = routeRegex.groups[key]\n+          // Use array for catch-all segments, string for regular segments\n+          acc[key] = repeat ? ['-'] : '-'\n+          return acc\n+        },\n+        {} as Record<string, string | string[]>\n+      )\n+    : params\n+\n+  const route = interpolateDynamicPath(pathname, routeParams, routeRegex)\n   const { name, ext } = path.parse(lastSegment)\n   const pagePath = path.posix.join(segment, name)\n   const suffix = getMetadataRouteSuffix(pagePath)"
        },
        {
            "sha": "e4b2ff33054681fd3dd5eb5215cd962d3b7387b2",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/023be2e88aa788cb5b832c48459fe9e5da7f9653/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/023be2e88aa788cb5b832c48459fe9e5da7f9653/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=023be2e88aa788cb5b832c48459fe9e5da7f9653",
            "patch": "@@ -65,7 +65,10 @@ import {\n   isMetadataRouteFile,\n   isStaticMetadataFile,\n } from '../../../lib/metadata/is-metadata-route'\n-import { normalizeMetadataPageToRoute } from '../../../lib/metadata/get-metadata-route'\n+import {\n+  fillMetadataSegment,\n+  normalizeMetadataPageToRoute,\n+} from '../../../lib/metadata/get-metadata-route'\n import { JsConfigPathsPlugin } from '../../../build/webpack/plugins/jsconfig-paths-plugin'\n import { store as consoleStore } from '../../../build/output/store'\n import {\n@@ -680,7 +683,16 @@ async function startWatcher(\n           if (useFileSystemPublicRoutes) {\n             // Static metadata files will be served from filesystem.\n             if (appDir && isStaticMetadataFile(fileName.replace(appDir, ''))) {\n-              staticMetadataFiles.set(pageName, fileName)\n+              // Use \"-\" placeholder for dynamic segments since static files have consistent content\n+              const segment = path.posix.dirname(pageName)\n+              const lastSegment = path.posix.basename(pageName)\n+              const normalizedPath = fillMetadataSegment(\n+                segment,\n+                {},\n+                lastSegment,\n+                true\n+              )\n+              staticMetadataFiles.set(normalizedPath, fileName)\n             } else {\n               appFiles.add(pageName)\n             }"
        },
        {
            "sha": "ea1382c12ba9430e9f007fce145fe84746069013",
            "filename": "test/e2e/app-dir/metadata-static-file/metadata-static-file-dynamic-route.test.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 10,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/023be2e88aa788cb5b832c48459fe9e5da7f9653/test%2Fe2e%2Fapp-dir%2Fmetadata-static-file%2Fmetadata-static-file-dynamic-route.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/023be2e88aa788cb5b832c48459fe9e5da7f9653/test%2Fe2e%2Fapp-dir%2Fmetadata-static-file%2Fmetadata-static-file-dynamic-route.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-static-file%2Fmetadata-static-file-dynamic-route.test.ts?ref=023be2e88aa788cb5b832c48459fe9e5da7f9653",
            "patch": "@@ -1,4 +1,4 @@\n-import { nextTestSetup } from 'e2e-utils'\n+import { nextTestSetup, isNextStart } from 'e2e-utils'\n import { getCommonMetadataHeadTags } from './utils'\n \n describe('metadata-files-static-output-dynamic-route', () => {\n@@ -25,19 +25,21 @@ describe('metadata-files-static-output-dynamic-route', () => {\n     return\n   }\n \n-  it('should have correct link tags for dynamic page', async () => {\n+  it('should have correct link tags for dynamic page with static placeholder', async () => {\n     const browser = await next.browser('/dynamic/123')\n \n+    // Static metadata files under dynamic routes use \"-\" as placeholder\n+    // since the file content is the same regardless of params\n     expect(await getCommonMetadataHeadTags(browser)).toMatchInlineSnapshot(`\n      {\n        \"links\": [\n          {\n-           \"href\": \"/dynamic/123/apple-icon.png\",\n+           \"href\": \"/dynamic/-/apple-icon.png\",\n            \"rel\": \"apple-touch-icon\",\n            \"type\": \"image/png\",\n          },\n          {\n-           \"href\": \"/dynamic/123/icon.png\",\n+           \"href\": \"/dynamic/-/icon.png\",\n            \"rel\": \"icon\",\n            \"type\": \"image/png\",\n          },\n@@ -87,19 +89,20 @@ describe('metadata-files-static-output-dynamic-route', () => {\n     `)\n   })\n \n-  it('should serve static files when requested to its route for dynamic page', async () => {\n+  it('should serve static files when requested with placeholder for dynamic page', async () => {\n+    // Static metadata files use \"-\" as placeholder for dynamic segments\n     const [\n       appleIconRes,\n       iconRes,\n       opengraphImageRes,\n       twitterImageRes,\n       sitemapRes,\n     ] = await Promise.all([\n-      next.fetch('/dynamic/123/apple-icon.png'),\n-      next.fetch('/dynamic/123/icon.png'),\n-      next.fetch('/dynamic/123/opengraph-image.png'),\n-      next.fetch('/dynamic/123/twitter-image.png'),\n-      next.fetch('/dynamic/123/sitemap.xml'),\n+      next.fetch('/dynamic/-/apple-icon.png'),\n+      next.fetch('/dynamic/-/icon.png'),\n+      next.fetch('/dynamic/-/opengraph-image.png'),\n+      next.fetch('/dynamic/-/twitter-image.png'),\n+      next.fetch('/dynamic/-/sitemap.xml'),\n     ])\n \n     // Compare response content with actual files\n@@ -144,4 +147,18 @@ describe('metadata-files-static-output-dynamic-route', () => {\n       sitemap: actualSitemap,\n     })\n   })\n+\n+  if (isNextStart) {\n+    it('should display static metadata files with \"-\" placeholder in build output', () => {\n+      // Build output should show normalized paths with \"-\" for dynamic segments\n+      expect(next.cliOutput).toContain('/dynamic/-/apple-icon.png')\n+      expect(next.cliOutput).toContain('/dynamic/-/icon.png')\n+      expect(next.cliOutput).toContain('/dynamic/-/opengraph-image.png')\n+      expect(next.cliOutput).toContain('/dynamic/-/twitter-image.png')\n+\n+      // Should NOT show the dynamic segment pattern in output for static files\n+      expect(next.cliOutput).not.toMatch(/\\/dynamic\\/\\[id\\]\\/icon\\.png/)\n+      expect(next.cliOutput).not.toMatch(/\\/dynamic\\/\\[id\\]\\/apple-icon\\.png/)\n+    })\n+  }\n })"
        },
        {
            "sha": "bbc18cef73657b4c299572ea82b844151839643c",
            "filename": "test/e2e/app-dir/metadata/metadata.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/023be2e88aa788cb5b832c48459fe9e5da7f9653/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/023be2e88aa788cb5b832c48459fe9e5da7f9653/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts?ref=023be2e88aa788cb5b832c48459fe9e5da7f9653",
            "patch": "@@ -597,8 +597,10 @@ describe('app dir - metadata', () => {\n       const $dynamic = await next.render$('/icons/static/dynamic-routes/123')\n       const $dynamicIcon = $dynamic('link[rel=\"icon\"][type!=\"image/x-icon\"]')\n       const dynamicIconHref = $dynamicIcon.attr('href')\n+      // Static icon files under dynamic routes use \"-\" as placeholder\n+      // since the file content is the same regardless of params\n       expect(dynamicIconHref).toMatch(\n-        /\\/icons\\/static\\/dynamic-routes\\/123\\/icon/\n+        /\\/icons\\/static\\/dynamic-routes\\/-\\/icon/\n       )\n       const dynamicIconRes = await next.fetch(dynamicIconHref)\n       expect(dynamicIconRes.status).toBe(200)"
        }
    ],
    "stats": {
        "total": 134,
        "additions": 111,
        "deletions": 23
    }
}