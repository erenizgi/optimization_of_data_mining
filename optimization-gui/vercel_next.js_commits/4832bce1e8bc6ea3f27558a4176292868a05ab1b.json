{
    "author": "mischnic",
    "message": "Turbopack: more tracing (#75351)\n\n**View the diff without whitespace changes**\r\n\r\nAdd a few more spans similar to the ones that Next has (I don't know where these gaps come from), there are no gaps in the verbose trace below:\r\n`TURBOPACK_TRACING=turbopack`:\r\n\r\n![Bildschirmfoto 2025-01-27 um 10 23 01](https://github.com/user-attachments/assets/c06c10b5-ec4c-499d-883f-44e227ef5aa1)\r\n\r\n`TURBOPACK_TRACING=turbo-tasks`:\r\n![Bildschirmfoto 2025-01-27 um 10 23 16](https://github.com/user-attachments/assets/64a23237-db35-47b4-9d3a-0a717e4b0cd5)",
    "sha": "4832bce1e8bc6ea3f27558a4176292868a05ab1b",
    "files": [
        {
            "sha": "7d436e62a0de1ebf14036e4784aa17582dcab64f",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 33,
            "deletions": 22,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/4832bce1e8bc6ea3f27558a4176292868a05ab1b/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4832bce1e8bc6ea3f27558a4176292868a05ab1b/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=4832bce1e8bc6ea3f27558a4176292868a05ab1b",
            "patch": "@@ -7,6 +7,7 @@ use std::{\n \n use anyhow::{bail, Context, Result};\n use rustc_hash::FxHashSet;\n+use tracing::Instrument;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{\n     apply_effects, ReadConsistency, ResolvedVc, TransientInstance, TryJoinIterExt, TurboTasks,\n@@ -149,7 +150,9 @@ impl TurbopackBuildBuilder {\n             // Await the result to propagate any errors.\n             build_result_op.read_strongly_consistent().await?;\n \n-            apply_effects(build_result_op).await?;\n+            apply_effects(build_result_op)\n+                .instrument(tracing::info_span!(\"apply effects\"))\n+                .await?;\n \n             let issue_reporter: Vc<Box<dyn IssueReporter>> =\n                 Vc::upcast(ConsoleUi::new(TransientInstance::new(LogOptions {\n@@ -270,26 +273,30 @@ async fn build_internal(\n \n     let origin = PlainResolveOrigin::new(asset_context, project_fs.root().join(\"_\".into()));\n     let project_dir = &project_dir;\n-    let entries = entry_requests\n-        .into_iter()\n-        .map(|request_vc| async move {\n-            let ty = Value::new(ReferenceType::Entry(EntryReferenceSubType::Undefined));\n-            let request = request_vc.await?;\n-            origin\n-                .resolve_asset(request_vc, origin.resolve_options(ty.clone()), ty)\n-                .await?\n-                .first_module()\n-                .await?\n-                .with_context(|| {\n-                    format!(\n-                        \"Unable to resolve entry {} from directory {}.\",\n-                        request.request().unwrap(),\n-                        project_dir\n-                    )\n-                })\n-        })\n-        .try_join()\n-        .await?;\n+    let entries = async move {\n+        entry_requests\n+            .into_iter()\n+            .map(|request_vc| async move {\n+                let ty = Value::new(ReferenceType::Entry(EntryReferenceSubType::Undefined));\n+                let request = request_vc.await?;\n+                origin\n+                    .resolve_asset(request_vc, origin.resolve_options(ty.clone()), ty)\n+                    .await?\n+                    .first_module()\n+                    .await?\n+                    .with_context(|| {\n+                        format!(\n+                            \"Unable to resolve entry {} from directory {}.\",\n+                            request.request().unwrap(),\n+                            project_dir\n+                        )\n+                    })\n+            })\n+            .try_join()\n+            .await\n+    }\n+    .instrument(tracing::info_span!(\"resolve entries\"))\n+    .await?;\n \n     let module_graph =\n         ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(entries.clone())]));\n@@ -445,7 +452,11 @@ async fn build_internal(\n \n     let mut chunks: FxHashSet<ResolvedVc<Box<dyn OutputAsset>>> = FxHashSet::default();\n     for chunk_group in entry_chunk_groups {\n-        chunks.extend(&*all_assets_from_entries(*chunk_group).await?);\n+        chunks.extend(\n+            &*async move { all_assets_from_entries(*chunk_group).await }\n+                .instrument(tracing::info_span!(\"list chunks\"))\n+                .await?,\n+        );\n     }\n \n     chunks"
        },
        {
            "sha": "54f410869bd7e9fc3ebcef4012d2264e7e9e460c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4832bce1e8bc6ea3f27558a4176292868a05ab1b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4832bce1e8bc6ea3f27558a4176292868a05ab1b/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=4832bce1e8bc6ea3f27558a4176292868a05ab1b",
            "patch": "@@ -19,11 +19,13 @@ use swc_core::{\n         transforms::base::fixer::paren_remover,\n     },\n };\n+use tracing::{instrument, Level};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::code_builder::{Code, CodeBuilder};\n \n use crate::parse::generate_js_source_map;\n \n+#[instrument(level = Level::INFO, skip_all)]\n pub fn minify(path: &FileSystemPath, code: &Code, source_maps: bool, mangle: bool) -> Result<Code> {\n     let source_maps = source_maps\n         .then(|| code.generate_source_map_ref())"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 35,
        "deletions": 22
    }
}