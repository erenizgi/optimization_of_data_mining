{
    "author": "eps1lon",
    "message": "Handle `Origin: null` headers (#85402)",
    "sha": "a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4",
    "files": [
        {
            "sha": "9925adf75c852b24965032ff99fe93e46ae802f4",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4",
            "patch": "@@ -551,9 +551,10 @@ export async function handleAction({\n   // When running actions the default is no-store, you can still `cache: 'force-cache'`\n   workStore.fetchCache = 'default-no-store'\n \n+  const originHeader = req.headers['origin']\n   const originDomain =\n-    typeof req.headers['origin'] === 'string'\n-      ? new URL(req.headers['origin']).host\n+    typeof originHeader === 'string' && originHeader !== 'null'\n+      ? new URL(originHeader).host\n       : undefined\n   const host = parseHostHeader(req.headers)\n "
        },
        {
            "sha": "92d41bd82e071ebdd5b8798042cb019848884926",
            "filename": "packages/next/src/server/lib/router-utils/block-cross-site.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts?ref=a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4",
            "patch": "@@ -85,7 +85,7 @@ export const blockCrossSite = (\n   // ensure websocket requests from allowed origin\n   const rawOrigin = req.headers['origin']\n \n-  if (rawOrigin) {\n+  if (rawOrigin && rawOrigin !== 'null') {\n     const parsedOrigin = parseUrl(rawOrigin)\n \n     if (parsedOrigin) {"
        },
        {
            "sha": "8cf75c75860fcc5d975f6dc6efad55c6f9fcdd93",
            "filename": "test/e2e/app-dir/actions-allowed-origins/app-action-allowed-origins.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4/test%2Fe2e%2Fapp-dir%2Factions-allowed-origins%2Fapp-action-allowed-origins.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4/test%2Fe2e%2Fapp-dir%2Factions-allowed-origins%2Fapp-action-allowed-origins.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions-allowed-origins%2Fapp-action-allowed-origins.test.ts?ref=a99aaa9c423c627e483cb7b5d117f2ffdcf44fe4",
            "patch": "@@ -26,4 +26,17 @@ describe('app-dir action allowed origins', () => {\n       return await browser.elementByCss('#res').text()\n     }, 'hi')\n   })\n+\n+  it('should not crash for requests from privacy sensitive contexts', async function () {\n+    const res = await next.fetch('/', {\n+      method: 'POST',\n+      headers: {\n+        Origin: 'null',\n+        'Content-type': 'application/x-www-form-urlencoded',\n+        'Sec-Fetch-Site': 'same-origin',\n+      },\n+    })\n+\n+    expect({ status: res.status }).toEqual({ status: 200 })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 17,
        "deletions": 3
    }
}