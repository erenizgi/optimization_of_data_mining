{
    "author": "devjiwonchoi",
    "message": "[release] use changesets/action for canary release (#79038)\n\nThis PR uses `changesets/action` to handle the canary release. Since the\naction creates a Version Packages PR by default, I added a GH Action\nthat checks if the PR is released from the correct release workflow. It\ntriple-verifies via the user login (`vercel-release-bot`), PR title\n(`Version Packages (canary)`), and a label (`created-by: CI`) to ensure\nthe opened PR is not trying to spoof.\n\nAfter the validation, the PR bypasses required checks, is merged into\nthe canary branch, and proceeds with the rest of the release process.\n\n### Testing Plan\n\nTry running `ci:version` and `ci:publish` locally, and handle the\nrelease type via env `RELEASE_TYPE`.\n\nConfirmed the CI force merge on\nhttps://github.com/devjiwonchoi/lab-releases/pull/13\n\n---------\n\nCo-authored-by: Sebastian \"Sebbie\" Silbermann <sebastian.silbermann@vercel.com>",
    "sha": "85c6b3a03dbd4c31bc4730153d1b37dbb53e401c",
    "files": [
        {
            "sha": "9c737e8413ae07e678f25b29e6e8c51edb5da04b",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=85c6b3a03dbd4c31bc4730153d1b37dbb53e401c",
            "patch": "@@ -20,7 +20,8 @@ env:\n   # See https://doc.rust-lang.org/rustc/platform-support/apple-darwin.html#os-version for more details\n   MACOSX_DEPLOYMENT_TARGET: 11.0\n   # This will become \"true\" if the latest commit is\n-  # \"Version Packages\", set from check-is-release.js\n+  # \"Version Packages\" or \"Version Pacakges (canary)\"\n+  # set from scripts/check-is-release.js\n   __NEW_RELEASE: 'false'\n \n jobs:\n@@ -49,7 +50,7 @@ jobs:\n         run: |\n           # TODO: Remove the new release check once the new release workflow is fully replaced.\n           RELEASE_CHECK=$(node ./scripts/check-is-release.js 2> /dev/null || :)\n-          if [[ $RELEASE_CHECK =~ ^Version\\ Packages$ ]];\n+          if [[ $RELEASE_CHECK =~ ^Version\\ Packages(\\ \\(canary\\))?$ ]];\n           then\n             echo \"__NEW_RELEASE=true\" >> $GITHUB_ENV\n           elif [[ $RELEASE_CHECK = v* ]];\n@@ -610,6 +611,14 @@ jobs:\n         env:\n           GITHUB_TOKEN: ${{ secrets.RELEASE_BOT_GITHUB_TOKEN }}\n           NPM_TOKEN: ${{ secrets.NPM_TOKEN_ELEVATED }}\n+          RELEASE_TYPE: ${{ github.event.inputs.releaseType }}\n+\n+      # Add label to verify the PR is created from this workflow.\n+      - name: Add label to PR\n+        if: steps.changesets.outputs.pullRequestNumber\n+        run: 'gh pr edit ${{ steps.changesets.outputs.pullRequestNumber }} --add-label \"created-by: CI\"'\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n \n       - name: Upload npm log artifact\n         uses: actions/upload-artifact@v4"
        },
        {
            "sha": "1f22b160fcc57e8219cca5b38f1a512d290a4210",
            "filename": ".github/workflows/force_merge_canary_release_pr.yml",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/.github%2Fworkflows%2Fforce_merge_canary_release_pr.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/.github%2Fworkflows%2Fforce_merge_canary_release_pr.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fforce_merge_canary_release_pr.yml?ref=85c6b3a03dbd4c31bc4730153d1b37dbb53e401c",
            "patch": "@@ -0,0 +1,23 @@\n+name: Force Merge Canary Release PR\n+\n+on: pull_request\n+\n+permissions:\n+  # To bypass and merge PR\n+  pull-requests: write\n+\n+jobs:\n+  force-merge-canary-release-pr:\n+    runs-on: ubuntu-latest\n+    # Validate the login, PR title, and the label to ensure the PR is\n+    # from the release PR and prevent spoofing.\n+    if: |\n+      github.event.pull_request.user.login == 'vercel-release-bot' &&\n+      github.event.pull_request.title == 'Version Packages (canary)' &&\n+      contains(github.event.pull_request.labels.*.name, 'created-by: CI')\n+    steps:\n+      - name: Bypass required status checks and merge PR\n+        run: gh pr merge --admin --squash \"$PR_URL\"\n+        env:\n+          PR_URL: ${{github.event.pull_request.html_url}}\n+          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}"
        },
        {
            "sha": "311f1e8c4505098b7bbdd37675af0c383d942e13",
            "filename": ".github/workflows/trigger_release_new.yml",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/.github%2Fworkflows%2Ftrigger_release_new.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/.github%2Fworkflows%2Ftrigger_release_new.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Ftrigger_release_new.yml?ref=85c6b3a03dbd4c31bc4730153d1b37dbb53e401c",
            "patch": "@@ -1,15 +1,22 @@\n name: Trigger Release (New)\n \n on:\n+  # Run every day at 23:15 UTC\n+  # TODO: Disabled cron for now, but uncomment\n+  # once replaced the old release workflow.\n+  # schedule:\n+  #   - cron: '15 23 * * *'\n+  # Run manually\n   workflow_dispatch:\n     inputs:\n       releaseType:\n         description: Release Type\n         required: true\n         type: choice\n+        # Cron job will run canary release\n+        default: canary\n         options:\n-          # TODO: Follow up enable the case.\n-          # - canary\n+          - canary\n           - stable\n           # TODO: Follow up enable the case.\n           # - release-candidate\n@@ -26,6 +33,10 @@ env:\n   TURBO_VERSION: 2.3.3\n   NODE_LTS_VERSION: 20\n \n+permissions:\n+  # To create PR\n+  pull-requests: write\n+\n jobs:\n   start:\n     if: github.repository_owner == 'vercel'"
        },
        {
            "sha": "7f5f1e9e62c8e1a8492bf33a3e31cdc86d18975c",
            "filename": "package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=85c6b3a03dbd4c31bc4730153d1b37dbb53e401c",
            "patch": "@@ -13,8 +13,8 @@\n     \"lerna\": \"lerna\",\n     \"dev\": \"turbo run dev --parallel\",\n     \"pack-next\": \"tsx scripts/pack-next.ts\",\n-    \"ci:version\": \"changeset version && pnpm install --no-frozen-lockfile\",\n-    \"ci:publish\": \"changeset publish\",\n+    \"ci:version\": \"tsx ./scripts/release/version-packages.ts\",\n+    \"ci:publish\": \"tsx ./scripts/release/publish-npm.ts\",\n     \"test-types\": \"tsc\",\n     \"test-unit\": \"jest test/unit/ packages/next/ packages/font\",\n     \"test-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\","
        },
        {
            "sha": "26edd2b49e4ccdeadc675a9b4d676c816f65772a",
            "filename": "scripts/check-is-release.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/scripts%2Fcheck-is-release.js",
            "raw_url": "https://github.com/vercel/next.js/raw/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/scripts%2Fcheck-is-release.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fcheck-is-release.js?ref=85c6b3a03dbd4c31bc4730153d1b37dbb53e401c",
            "patch": "@@ -13,7 +13,7 @@ const checkIsRelease = async () => {\n \n   const versionString = commitMsg.split(' ').pop().trim()\n   const publishMsgRegex = /^v\\d{1,}\\.\\d{1,}\\.\\d{1,}(-\\w{1,}\\.\\d{1,})?$/\n-  const newPublishMsgRegex = /^Version Packages$/\n+  const newPublishMsgRegex = /^Version Packages( \\(canary\\))?$/\n \n   if (publishMsgRegex.test(versionString)) {\n     console.log(versionString)"
        },
        {
            "sha": "cc768429d5c314a98df3a9edb1285071d5ef7f86",
            "filename": "scripts/release/publish-npm.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/scripts%2Frelease%2Fpublish-npm.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/scripts%2Frelease%2Fpublish-npm.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Frelease%2Fpublish-npm.ts?ref=85c6b3a03dbd4c31bc4730153d1b37dbb53e401c",
            "patch": "@@ -0,0 +1,17 @@\n+import execa from 'execa'\n+\n+async function publishNpm() {\n+  const releaseType = process.env.RELEASE_TYPE\n+  const tag =\n+    releaseType === 'canary'\n+      ? 'canary'\n+      : releaseType === 'release-candidate'\n+        ? 'rc'\n+        : 'latest'\n+\n+  await execa('pnpm', ['changeset', 'publish', '--tag', tag], {\n+    stdio: 'inherit',\n+  })\n+}\n+\n+publishNpm()"
        },
        {
            "sha": "336ad2e08e5b009e530d73d45919d62c7fd2dffa",
            "filename": "scripts/release/version-packages.ts",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/scripts%2Frelease%2Fversion-packages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/85c6b3a03dbd4c31bc4730153d1b37dbb53e401c/scripts%2Frelease%2Fversion-packages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Frelease%2Fversion-packages.ts?ref=85c6b3a03dbd4c31bc4730153d1b37dbb53e401c",
            "patch": "@@ -0,0 +1,38 @@\n+import execa from 'execa'\n+import { existsSync } from 'node:fs'\n+import { join } from 'node:path'\n+\n+async function versionPackages() {\n+  const preConfigPath = join(process.cwd(), '.changeset', 'pre.json')\n+\n+  // Exit previous pre mode to prepare for the next release.\n+  if (existsSync(preConfigPath)) {\n+    if (require(preConfigPath).mode !== 'exit') {\n+      // Since current repository is in pre mode, need\n+      // to exit before versioning the packages.\n+      await execa('pnpm', ['changeset', 'pre', 'exit'], {\n+        stdio: 'inherit',\n+      })\n+    }\n+  }\n+\n+  const releaseType = process.env.RELEASE_TYPE\n+\n+  if (releaseType === 'canary') {\n+    // Enter pre mode as \"canary\" tag.\n+    await execa('pnpm', ['changeset', 'pre', 'enter', 'canary'], {\n+      stdio: 'inherit',\n+    })\n+    // TODO: Create empty changeset for `next` to bump canary version\n+    // even if there is no changeset.\n+  }\n+\n+  await execa('pnpm', ['changeset', 'version'], {\n+    stdio: 'inherit',\n+  })\n+  await execa('pnpm', ['install', '--no-frozen-lockfile'], {\n+    stdio: 'inherit',\n+  })\n+}\n+\n+versionPackages()"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 105,
        "deletions": 7
    }
}