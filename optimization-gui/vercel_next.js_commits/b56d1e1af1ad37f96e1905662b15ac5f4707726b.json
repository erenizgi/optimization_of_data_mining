{
    "author": "bgub",
    "message": "fix: typesafe linking to route handlers and pages API routes (#82858)\n\nFixes #82833",
    "sha": "b56d1e1af1ad37f96e1905662b15ac5f4707726b",
    "files": [
        {
            "sha": "1909b720f0148e196133140afd5c8639bb40a556",
            "filename": "packages/next/src/server/lib/router-utils/typegen.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/b56d1e1af1ad37f96e1905662b15ac5f4707726b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b56d1e1af1ad37f96e1905662b15ac5f4707726b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts?ref=b56d1e1af1ad37f96e1905662b15ac5f4707726b",
            "patch": "@@ -201,18 +201,24 @@ export function generateLinkTypesFile(\n   routesManifest: RouteTypesManifest\n ): string {\n   // Generate serialized static and dynamic routes for the internal namespace\n-  const allRoutes = {\n-    ...routesManifest.appRoutes,\n-    ...routesManifest.pageRoutes,\n-    ...routesManifest.redirectRoutes,\n-    ...routesManifest.rewriteRoutes,\n-  }\n+  // Build a unified set of routes across app/pages/redirect/rewrite as well as\n+  // app route handlers and Pages Router API routes.\n+  const allRoutesSet = new Set<string>([\n+    ...Object.keys(routesManifest.appRoutes),\n+    ...Object.keys(routesManifest.pageRoutes),\n+    ...Object.keys(routesManifest.redirectRoutes),\n+    ...Object.keys(routesManifest.rewriteRoutes),\n+    // Allow linking to App Route Handlers (e.g. `/logout/route.ts`)\n+    ...Object.keys(routesManifest.appRouteHandlerRoutes),\n+    // Allow linking to Pages Router API routes (e.g. `/api/*`)\n+    ...Array.from(routesManifest.pageApiRoutes),\n+  ])\n \n   const staticRouteTypes: string[] = []\n   const dynamicRouteTypes: string[] = []\n \n   // Process each route using the same logic as the plugin\n-  for (const route of Object.keys(allRoutes)) {\n+  for (const route of allRoutesSet) {\n     const { isDynamic, routeType } = formatRouteToRouteType(route)\n     if (isDynamic) {\n       dynamicRouteTypes.push(routeType)"
        },
        {
            "sha": "200c71ae6ad8a0c54936f322f24b1b5fcf34c76e",
            "filename": "test/e2e/app-dir/typed-routes/app/api-test/route.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/b56d1e1af1ad37f96e1905662b15ac5f4707726b/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fapp%2Fapi-test%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b56d1e1af1ad37f96e1905662b15ac5f4707726b/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fapp%2Fapi-test%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Fapp%2Fapi-test%2Froute.ts?ref=b56d1e1af1ad37f96e1905662b15ac5f4707726b",
            "patch": "@@ -0,0 +1,5 @@\n+import { NextResponse } from 'next/server'\n+\n+export function GET() {\n+  return NextResponse.json({ message: 'Hello, world!' })\n+}"
        },
        {
            "sha": "5b6b7030ceefbda073570e207e8a0939045b7202",
            "filename": "test/e2e/app-dir/typed-routes/typed-links.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/b56d1e1af1ad37f96e1905662b15ac5f4707726b/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-links.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b56d1e1af1ad37f96e1905662b15ac5f4707726b/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-links.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-links.test.ts?ref=b56d1e1af1ad37f96e1905662b15ac5f4707726b",
            "patch": "@@ -15,6 +15,12 @@ describe('typed-links', () => {\n     expect(dts).toContain(`declare module 'next/link'`)\n   })\n \n+  it('should include handler route from app/api-test/route.ts in generated link route definitions', async () => {\n+    const dts = await next.readFile('.next/types/link.d.ts')\n+    // Ensure the app route handler at app/api-test/route.ts (\"/api-test\") is present\n+    expect(dts).toContain('`/api-test`')\n+  })\n+\n   if (isNextStart) {\n     it('should pass type checking with valid routes', async () => {\n       await next.stop()"
        },
        {
            "sha": "5dc57646bcbca72d373bf92b7d6d3920df4e3b13",
            "filename": "test/e2e/app-dir/typed-routes/typed-routes.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b56d1e1af1ad37f96e1905662b15ac5f4707726b/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b56d1e1af1ad37f96e1905662b15ac5f4707726b/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts?ref=b56d1e1af1ad37f96e1905662b15ac5f4707726b",
            "patch": "@@ -2,7 +2,7 @@ import { nextTestSetup } from 'e2e-utils'\n \n const expectedDts = `\n type AppRoutes = \"/\" | \"/_shop/[[...category]]\" | \"/dashboard\" | \"/dashboard/settings\" | \"/docs/[...slug]\" | \"/gallery/photo/[id]\" | \"/project/[slug]\"\n-type AppRouteHandlerRoutes = \"/api/docs/[...slug]\" | \"/api/shop/[[...category]]\" | \"/api/users/[id]\"\n+type AppRouteHandlerRoutes = \"/api-test\" | \"/api/docs/[...slug]\" | \"/api/shop/[[...category]]\" | \"/api/users/[id]\"\n type PageRoutes = \"/about\" | \"/users/[id]\"\n type LayoutRoutes = \"/\" | \"/dashboard\"\n type RedirectRoutes = \"/blog/[category]/[[...slug]]\" | \"/project/[slug]\""
        }
    ],
    "stats": {
        "total": 33,
        "additions": 25,
        "deletions": 8
    }
}