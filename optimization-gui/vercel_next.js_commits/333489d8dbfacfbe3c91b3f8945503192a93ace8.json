{
    "author": "sokra",
    "message": "Turbopack: fix postcss in RSC CSS (#82554)\n\n### What?\r\n\r\nmake sure to apply PostCSS on .module.css that is requested from RSC.\r\n\r\nFixes a regression from #82448\r\n\r\nCloses #82545",
    "sha": "333489d8dbfacfbe3c91b3f8945503192a93ace8",
    "files": [
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Flayout.tsx?ref=333489d8dbfacfbe3c91b3f8945503192a93ace8",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "173c4a4b7fa31a1a472a07f13d8f17f5d3c16100",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/app/page.module.css",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.module.css",
            "raw_url": "https://github.com/vercel/next.js/raw/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.module.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.module.css?ref=333489d8dbfacfbe3c91b3f8945503192a93ace8",
            "patch": "@@ -0,0 +1,5 @@\n+:not(html) {\n+  .main {\n+    color: red;\n+  }\n+}"
        },
        {
            "sha": "bcd5a0e83f36f2a8884009b5b44fea02946c550a",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/app/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fapp%2Fpage.tsx?ref=333489d8dbfacfbe3c91b3f8945503192a93ace8",
            "patch": "@@ -0,0 +1,5 @@\n+import styles from './page.module.css'\n+\n+export default function Page() {\n+  return <p className={styles.main}>hello world</p>\n+}"
        },
        {
            "sha": "e0990d422c76369e9f29ff099d86e0b22c4f80f4",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/css-modules-rsc-postcss.test.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fcss-modules-rsc-postcss.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fcss-modules-rsc-postcss.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fcss-modules-rsc-postcss.test.ts?ref=333489d8dbfacfbe3c91b3f8945503192a93ace8",
            "patch": "@@ -0,0 +1,17 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('css-modules-rsc-postcss', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    dependencies: {\n+      'postcss-nested': '4.2.1',\n+    },\n+  })\n+\n+  it('should compile successfully and apply the correct styles', async () => {\n+    const browser = await next.browser('/')\n+    expect(await browser.elementByCss('p').getComputedCss('color')).toBe(\n+      'rgb(0, 128, 0)'\n+    )\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fnext.config.js?ref=333489d8dbfacfbe3c91b3f8945503192a93ace8",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "9f27c9e8a99f72b5e828584834894cd72fc117b6",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/plugin.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fplugin.js",
            "raw_url": "https://github.com/vercel/next.js/raw/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fplugin.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fplugin.js?ref=333489d8dbfacfbe3c91b3f8945503192a93ace8",
            "patch": "@@ -0,0 +1,12 @@\n+const plugin = () => {\n+  return {\n+    postcssPlugin: 'color-change',\n+    Declaration: {\n+      color(prop) {\n+        prop.value = 'green'\n+      },\n+    },\n+  }\n+}\n+plugin.postcss = true\n+module.exports = plugin"
        },
        {
            "sha": "24ef2eb93905114ef2903983e6d246552302514e",
            "filename": "test/e2e/app-dir/css-modules-rsc-postcss/postcss.config.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fpostcss.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/333489d8dbfacfbe3c91b3f8945503192a93ace8/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fpostcss.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-modules-rsc-postcss%2Fpostcss.config.js?ref=333489d8dbfacfbe3c91b3f8945503192a93ace8",
            "patch": "@@ -0,0 +1,3 @@\n+module.exports = {\n+  plugins: ['postcss-nested', require.resolve('./plugin')],\n+}"
        },
        {
            "sha": "0a59484394a9219b06c5b30147b3703f1bed46a2",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 27,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/333489d8dbfacfbe3c91b3f8945503192a93ace8/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/333489d8dbfacfbe3c91b3f8945503192a93ace8/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=333489d8dbfacfbe3c91b3f8945503192a93ace8",
            "patch": "@@ -162,15 +162,17 @@ impl ModuleOptions {\n         // only then be processed with Webpack/PostCSS).\n         //\n         // Note that this is not an exhaustive condition for PostCSS/Webpack, but excludes certain\n-        // cases, so it should be added conjunctively together with the `module_css_condition` rule.\n+        // cases, so it should be added conjunctively together with CSS Module rule.\n         //\n         // If module css, then only when (Inner or Analyze or Compose)\n         // <=> (not (module css)) or (Inner or Analyzer or Compose)\n-        let module_css_external_transform_conditions = vec![\n+        //\n+        // So only if this is not a CSS module, or one of the special reference type constraints.\n+        let module_css_external_transform_conditions = RuleCondition::Any(vec![\n+            RuleCondition::not(module_css_condition.clone()),\n             RuleCondition::ReferenceType(ReferenceType::Css(CssReferenceSubType::Inner)),\n             RuleCondition::ReferenceType(ReferenceType::Css(CssReferenceSubType::Analyze)),\n-            RuleCondition::ReferenceType(ReferenceType::Css(CssReferenceSubType::Compose)),\n-        ];\n+        ]);\n \n         let mut ts_preprocess = vec![];\n         let mut ecma_preprocess = vec![];\n@@ -505,22 +507,14 @@ impl ModuleOptions {\n                 };\n \n                 rules.push(ModuleRule::new(\n-                    RuleCondition::Any(vec![\n-                        RuleCondition::All(vec![\n-                            RuleCondition::Any(vec![\n-                                RuleCondition::ResourcePathEndsWith(\".css\".to_string()),\n-                                RuleCondition::ContentTypeStartsWith(\"text/css\".to_string()),\n-                            ]),\n-                            RuleCondition::not(module_css_condition.clone()),\n+                    RuleCondition::All(vec![\n+                        RuleCondition::Any(vec![\n+                            // Both CSS and CSS Modules\n+                            RuleCondition::ResourcePathEndsWith(\".css\".to_string()),\n+                            RuleCondition::ContentTypeStartsWith(\"text/css\".to_string()),\n+                            module_css_condition.clone(),\n                         ]),\n-                        RuleCondition::All(\n-                            [\n-                                vec![module_css_condition.clone()],\n-                                // see comment on module_css_external_transform_conditions\n-                                module_css_external_transform_conditions.clone(),\n-                            ]\n-                            .concat(),\n-                        ),\n+                        module_css_external_transform_conditions.clone(),\n                     ]),\n                     vec![ModuleRuleEffect::SourceTransforms(ResolvedVc::cell(vec![\n                         ResolvedVc::upcast(\n@@ -703,14 +697,7 @@ impl ModuleOptions {\n                             RuleCondition::ResourceBasePathGlob(Glob::new(key.clone()).await?)\n                         },\n                         RuleCondition::not(RuleCondition::ResourceIsVirtualSource),\n-                        // see comment on module_css_external_transform_conditions\n-                        RuleCondition::Any(\n-                            [\n-                                vec![RuleCondition::not(module_css_condition.clone())],\n-                                module_css_external_transform_conditions.clone(),\n-                            ]\n-                            .concat(),\n-                        ),\n+                        module_css_external_transform_conditions.clone(),\n                     ]),\n                     vec![ModuleRuleEffect::SourceTransforms(ResolvedVc::cell(vec![\n                         ResolvedVc::upcast("
        }
    ],
    "stats": {
        "total": 97,
        "additions": 70,
        "deletions": 27
    }
}