{
    "author": "eps1lon",
    "message": "[sourcemaps] Fix sourcemapping in Redbox on Windows (#82078)",
    "sha": "49371dc364eecca41e52dfc5f6bf1b6cda3ed83d",
    "files": [
        {
            "sha": "d8b0e99de13d7b3c8782f23b68f10a06ab6e945b",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 14,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/49371dc364eecca41e52dfc5f6bf1b6cda3ed83d/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/49371dc364eecca41e52dfc5f6bf1b6cda3ed83d/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=49371dc364eecca41e52dfc5f6bf1b6cda3ed83d",
            "patch": "@@ -41,7 +41,7 @@ use turbo_tasks_backend::{BackingStorage, db_invalidation::invalidation_reasons}\n use turbo_tasks_fs::{\n     DiskFileSystem, FileContent, FileSystem, FileSystemPath, util::uri_from_file,\n };\n-use turbo_unix_path::get_relative_path_to;\n+use turbo_unix_path::{get_relative_path_to, sys_to_unix};\n use turbopack_core::{\n     PROJECT_FILESYSTEM_NAME, SOURCE_URL_PROTOCOL,\n     diagnostics::PlainDiagnostic,\n@@ -1409,12 +1409,17 @@ pub struct OptionStackFrame(Option<StackFrame>);\n #[turbo_tasks::function]\n pub async fn get_source_map_rope(\n     container: Vc<ProjectContainer>,\n-    file_path: RcStr,\n+    source_url: RcStr,\n ) -> Result<Vc<OptionStringifiedSourceMap>> {\n-    let (file, module) = match Url::parse(&file_path) {\n+    let (file_path_sys, module) = match Url::parse(&source_url) {\n         Ok(url) => match url.scheme() {\n             \"file\" => {\n-                let path = urlencoding::decode(url.path())?.to_string();\n+                let path = match url.to_file_path() {\n+                    Ok(path) => path.to_string_lossy().into(),\n+                    Err(_) => {\n+                        bail!(\"Failed to convert file URL to file path: {url}\");\n+                    }\n+                };\n                 let module = url.query_pairs().find(|(k, _)| k == \"id\");\n                 (\n                     path,\n@@ -1426,23 +1431,29 @@ pub async fn get_source_map_rope(\n             }\n             _ => bail!(\"Unknown url scheme '{}'\", url.scheme()),\n         },\n-        Err(_) => (file_path.to_string(), None),\n+        Err(_) => (source_url.to_string(), None),\n     };\n \n-    let Some(chunk_base) =\n-        file.strip_prefix(container.project().dist_dir_absolute().await?.as_str())\n-    else {\n-        // File doesn't exist within the dist dir\n-        return Ok(OptionStringifiedSourceMap::none());\n-    };\n+    let chunk_base_unix =\n+        match file_path_sys.strip_prefix(container.project().dist_dir_absolute().await?.as_str()) {\n+            Some(relative_path) => sys_to_unix(relative_path),\n+            None => {\n+                // File doesn't exist within the dist dir\n+                return Ok(OptionStringifiedSourceMap::none());\n+            }\n+        };\n \n-    let server_path = container.project().node_root().await?.join(chunk_base)?;\n+    let server_path = container\n+        .project()\n+        .node_root()\n+        .await?\n+        .join(&chunk_base_unix)?;\n \n     let client_path = container\n         .project()\n         .client_relative_path()\n         .await?\n-        .join(chunk_base)?;\n+        .join(&chunk_base_unix)?;\n \n     let mut map = container.get_source_map(server_path, module.clone());\n \n@@ -1453,7 +1464,7 @@ pub async fn get_source_map_rope(\n         // chunks.\n         map = container.get_source_map(client_path, module);\n         if map.await?.is_none() {\n-            bail!(\"chunk/module '{}' is missing a sourcemap\", file_path);\n+            bail!(\"chunk/module '{}' is missing a sourcemap\", source_url);\n         }\n     }\n "
        }
    ],
    "stats": {
        "total": 39,
        "additions": 25,
        "deletions": 14
    }
}