{
    "author": "ztanner",
    "message": "Add refresh API to next/cache (#84666)\n\nThis provides a way to refresh the client cache from within a server\naction. This is useful when you need to refresh the client UI / read\nyour writes without needing to rely on `updateTag`.\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "5dcfec401a299498a1866f1973391381ba1cbf85",
    "files": [
        {
            "sha": "e1d0d668ad4fc244c322e3eb657d51fd2b6a19d4",
            "filename": "docs/01-app/03-api-reference/04-functions/refresh.mdx",
            "status": "added",
            "additions": 71,
            "deletions": 0,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/docs%2F01-app%2F03-api-reference%2F04-functions%2Frefresh.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/docs%2F01-app%2F03-api-reference%2F04-functions%2Frefresh.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F04-functions%2Frefresh.mdx?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,71 @@\n+---\n+title: refresh\n+description: API Reference for the refresh function.\n+---\n+\n+`refresh` allows you to refresh the client router from within a [Server Action](/docs/app/getting-started/updating-data).\n+\n+## Usage\n+\n+`refresh` can **only** be called from within Server Actions. It cannot be used in Route Handlers, Client Components, or any other context.\n+\n+## Parameters\n+\n+```tsx\n+refresh(): void;\n+```\n+\n+## Returns\n+\n+`refresh` does not return a value.\n+\n+## Examples\n+\n+```ts filename=\"app/actions.ts\" switcher\n+'use server'\n+\n+import { refresh } from 'next/cache'\n+import { redirect } from 'next/navigation'\n+\n+export async function createPost(formData: FormData) {\n+  const title = formData.get('title')\n+  const content = formData.get('content')\n+\n+  // Create the post in your database\n+  const post = await db.post.create({\n+    data: { title, content },\n+  })\n+\n+  refresh()\n+}\n+```\n+\n+```js filename=\"app/actions.js\" switcher\n+'use server'\n+\n+import { refresh } from 'next/cache'\n+import { redirect } from 'next/navigation'\n+\n+export async function createPost(formData) {\n+  const title = formData.get('title')\n+  const content = formData.get('content')\n+\n+  // Create the post in your database\n+  const post = await db.post.create({\n+    data: { title, content },\n+  })\n+\n+  refresh()\n+}\n+```\n+\n+### Error when used outside Server Actions\n+\n+```ts filename=\"app/api/posts/route.ts\" switcher\n+import { refresh } from 'next/cache'\n+\n+export async function POST() {\n+  // This will throw an error\n+  refresh()\n+}\n+```"
        },
        {
            "sha": "ca839bec10ada21bd27cd3ca912a876077792ac2",
            "filename": "packages/next/cache.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Fcache.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Fcache.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fcache.d.ts?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -5,6 +5,7 @@ export {\n   revalidateTag,\n   unstable_expirePath,\n   unstable_expireTag,\n+  refresh,\n } from 'next/dist/server/web/spec-extension/revalidate'\n \n export { unstable_noStore } from 'next/dist/server/web/spec-extension/unstable-no-store'"
        },
        {
            "sha": "8e7a1e60277eda206b25aa82ab56ae376a5c15dd",
            "filename": "packages/next/cache.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Fcache.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Fcache.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fcache.js?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -12,6 +12,8 @@ const cacheExports = {\n   unstable_expirePath: require('next/dist/server/web/spec-extension/revalidate')\n     .unstable_expirePath,\n \n+  refresh: require('next/dist/server/web/spec-extension/revalidate').refresh,\n+\n   unstable_noStore:\n     require('next/dist/server/web/spec-extension/unstable-no-store')\n       .unstable_noStore,\n@@ -33,3 +35,4 @@ exports.unstable_expirePath = cacheExports.unstable_expirePath\n exports.unstable_noStore = cacheExports.unstable_noStore\n exports.unstable_cacheLife = cacheExports.unstable_cacheLife\n exports.unstable_cacheTag = cacheExports.unstable_cacheTag\n+exports.refresh = cacheExports.refresh"
        },
        {
            "sha": "b92f4f03075a7a8fb1b598efc49ee399b65a2da1",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -867,5 +867,6 @@\n   \"866\": \"Both \\\"%s\\\" and \\\"%s\\\" files are detected. Please use \\\"%s\\\" instead.\",\n   \"867\": \"The %s \\\"%s\\\" must export a %s or a \\\\`default\\\\` function\",\n   \"868\": \"No reference found for param: %s in reference: %s\",\n-  \"869\": \"No reference found for segment: %s with reference: %s\"\n+  \"869\": \"No reference found for segment: %s with reference: %s\",\n+  \"870\": \"refresh can only be called from within a Server Action. See more info here: https://nextjs.org/docs/app/api-reference/functions/refresh\"\n }"
        },
        {
            "sha": "394e7b8ebe17889ef4fd6b6bc36b48147ee8ff91",
            "filename": "packages/next/src/build/webpack/plugins/next-types-plugin/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -534,6 +534,7 @@ declare module 'next/cache' {\n     revalidatePath,\n     unstable_expireTag,\n     unstable_expirePath,\n+    refresh,\n   } from 'next/dist/server/web/spec-extension/revalidate'\n   export { unstable_noStore } from 'next/dist/server/web/spec-extension/unstable-no-store'\n "
        },
        {
            "sha": "91845dc54a2eaf30f34cbab7f9c03a22d44d953b",
            "filename": "packages/next/src/server/web/spec-extension/revalidate.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -55,6 +55,32 @@ export function unstable_expirePath(\n   return revalidate(tags, `unstable_expirePath ${originalPath}`)\n }\n \n+/**\n+ * This function allows you to refresh client cache from server actions.\n+ * It's useful as dynamic data can be cached on the client which won't\n+ * be refreshed by expireTag\n+ */\n+export function refresh() {\n+  const workStore = workAsyncStorage.getStore()\n+  const workUnitStore = workUnitAsyncStorage.getStore()\n+\n+  if (\n+    !workStore ||\n+    workStore.page.endsWith('/route') ||\n+    workUnitStore?.phase !== 'action'\n+  ) {\n+    throw new Error(\n+      'refresh can only be called from within a Server Action. ' +\n+        'See more info here: https://nextjs.org/docs/app/api-reference/functions/refresh'\n+    )\n+  }\n+\n+  if (workStore) {\n+    // TODO: break this to it's own field\n+    workStore.pathWasRevalidated = true\n+  }\n+}\n+\n /**\n  * This function allows you to purge [cached data](https://nextjs.org/docs/app/building-your-application/caching) on-demand for a specific cache tag.\n  *"
        },
        {
            "sha": "08eaa94fdc8896acfd343a0dbb61c713eec93a55",
            "filename": "test/e2e/app-dir/refresh/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Flayout.tsx?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "fbe5d39c49bb5afe59281247b92008a3158afc3f",
            "filename": "test/e2e/app-dir/refresh/app/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Floading.tsx?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Loading() {\n+  return <div id=\"loading\">loading...</div>\n+}"
        },
        {
            "sha": "152104aa23e6b78c159b2e62d9c40d14cb47c969",
            "filename": "test/e2e/app-dir/refresh/app/refresh-invalid-cache/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-cache%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-cache%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-cache%2Fpage.tsx?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,13 @@\n+import { connection } from 'next/server'\n+import { unstable_cache, refresh } from 'next/cache'\n+\n+const cachedFunction = unstable_cache(async () => {\n+  refresh()\n+  return 'data'\n+}, ['test-key'])\n+\n+export default async function Page() {\n+  await connection()\n+  const data = await cachedFunction()\n+  return <div>{data}</div>\n+}"
        },
        {
            "sha": "05524526243e47ed7c2f0fa1e29d7f8b68f1002b",
            "filename": "test/e2e/app-dir/refresh/app/refresh-invalid-render/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-render%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-render%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-render%2Fpage.tsx?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,9 @@\n+import { connection } from 'next/server'\n+import { refresh } from 'next/cache'\n+\n+export default async function Page() {\n+  await connection()\n+  refresh()\n+\n+  return <div>This should error</div>\n+}"
        },
        {
            "sha": "3eb58abf66d42cab7db42f096a14bc027494d2d4",
            "filename": "test/e2e/app-dir/refresh/app/refresh-invalid-route/route.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-route%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-route%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh-invalid-route%2Froute.ts?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,8 @@\n+import { refresh } from 'next/cache'\n+import { connection } from 'next/server'\n+\n+export async function GET() {\n+  await connection()\n+  refresh()\n+  return new Response('ok')\n+}"
        },
        {
            "sha": "30a58d52cda7ec709d78e2a6d2d9a5f460dc6117",
            "filename": "test/e2e/app-dir/refresh/app/refresh/actions.ts",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Factions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Factions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Factions.ts?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,6 @@\n+'use server'\n+import { refresh } from 'next/cache'\n+\n+export async function triggerRefresh() {\n+  refresh()\n+}"
        },
        {
            "sha": "a7547c0fcbd9da3aff1d1e30c12116a083187ca6",
            "filename": "test/e2e/app-dir/refresh/app/refresh/page.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Fapp%2Frefresh%2Fpage.tsx?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,16 @@\n+import { triggerRefresh } from './actions'\n+\n+export default function Page() {\n+  const timestamp = performance.now()\n+\n+  return (\n+    <>\n+      <div id=\"server-timestamp\">{timestamp}</div>\n+      <form action={triggerRefresh}>\n+        <button id=\"refresh-button\" type=\"submit\">\n+          Refresh\n+        </button>\n+      </form>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "0a588c52b994cb71e1a78ed92533cb4798c1a830",
            "filename": "test/e2e/app-dir/refresh/refresh.test.ts",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Frefresh.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5dcfec401a299498a1866f1973391381ba1cbf85/test%2Fe2e%2Fapp-dir%2Frefresh%2Frefresh.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frefresh%2Frefresh.test.ts?ref=5dcfec401a299498a1866f1973391381ba1cbf85",
            "patch": "@@ -0,0 +1,83 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { retry, assertHasRedbox, getRedboxDescription } from 'next-test-utils'\n+\n+describe('app-dir refresh', () => {\n+  const { next, skipped, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+    // We do not have access to runtime logs when deployed\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) return\n+\n+  it('should refresh client cache when refresh() is called in a server action', async () => {\n+    const browser = await next.browser('/refresh')\n+\n+    const initialServerTimestamp = await browser\n+      .elementById('server-timestamp')\n+      .text()\n+\n+    expect(initialServerTimestamp).toBeTruthy()\n+\n+    await new Promise((resolve) => setTimeout(resolve, 100))\n+\n+    await browser.elementById('refresh-button').click()\n+\n+    await retry(async () => {\n+      const newServerTimestamp = await browser\n+        .elementById('server-timestamp')\n+        .text()\n+      expect(newServerTimestamp).not.toBe(initialServerTimestamp)\n+      expect(Number(newServerTimestamp)).toBeGreaterThan(\n+        Number(initialServerTimestamp)\n+      )\n+    })\n+  })\n+\n+  it('should throw an error when refresh() is called during page render', async () => {\n+    const browser = await next.browser('/refresh-invalid-render')\n+\n+    if (isNextDev) {\n+      await assertHasRedbox(browser)\n+      const description = await getRedboxDescription(browser)\n+      expect(description).toContain(\n+        'refresh can only be called from within a Server Action'\n+      )\n+    } else {\n+      await retry(async () => {\n+        expect(next.cliOutput).toContain(\n+          'refresh can only be called from within a Server Action'\n+        )\n+      })\n+    }\n+  })\n+\n+  it('should throw an error when refresh() is called in a route handler', async () => {\n+    const res = await next.fetch('/refresh-invalid-route')\n+    expect(res.status).toBe(500)\n+\n+    await retry(async () => {\n+      expect(next.cliOutput).toContain(\n+        'refresh can only be called from within a Server Action'\n+      )\n+    })\n+  })\n+\n+  it('should throw an error when refresh() is called in unstable_cache', async () => {\n+    const browser = await next.browser('/refresh-invalid-cache')\n+\n+    if (isNextDev) {\n+      await assertHasRedbox(browser)\n+      const description = await getRedboxDescription(browser)\n+      expect(description).toContain(\n+        'refresh can only be called from within a Server Action'\n+      )\n+    } else {\n+      await retry(async () => {\n+        expect(next.cliOutput).toContain(\n+          'refresh can only be called from within a Server Action'\n+        )\n+      })\n+    }\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 254,
        "additions": 253,
        "deletions": 1
    }
}