{
    "author": "lukesandberg",
    "message": "[turbopack] Delete `FunctionId` (#80809)\n\n## Delete the `FunctionId` type\n\nThis is only used to map to/from global names,  we can just do that directly and remove some indirection.\n\nThis is a tiny cleanup following https://github.com/vercel/next.js/pull/80695 which made functionids irrelevant to most  of the runtime.",
    "sha": "0d84c976cd26f4a1a62f4a17a5208d9a98c286d4",
    "files": [
        {
            "sha": "b7020739b9b12f597939d84eb07b2da0f2727de5",
            "filename": "turbopack/crates/turbo-tasks/src/backend.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs?ref=0d84c976cd26f4a1a62f4a17a5208d9a98c286d4",
            "patch": "@@ -213,9 +213,7 @@ mod ser {\n                 unreachable!();\n             };\n             let mut state = serializer.serialize_seq(Some(2))?;\n-            // It would be a little tricky but we _could_ store the function id on the native_fn so\n-            // that instead of a hashmap lookup this would be a memory access on the NativeFn\n-            state.serialize_element(&registry::get_function_id(native_fn))?;\n+            state.serialize_element(&registry::get_function_global_name(native_fn))?;\n             let arg = *arg;\n             let arg = native_fn.arg_meta.as_serialize(arg);\n             state.serialize_element(arg)?;\n@@ -237,10 +235,10 @@ mod ser {\n                 where\n                     A: serde::de::SeqAccess<'de>,\n                 {\n-                    let fn_id = seq\n+                    let fn_name = seq\n                         .next_element()?\n                         .ok_or_else(|| serde::de::Error::invalid_length(0, &self))?;\n-                    let native_fn = registry::get_function(fn_id);\n+                    let native_fn = registry::get_function_by_global_name(fn_name);\n                     let seed = native_fn.arg_meta.deserialization_seed();\n                     let arg = seq\n                         .next_element_seed(seed)?"
        },
        {
            "sha": "a1fa5379d8dab05f71ee1352020655e19fb60edd",
            "filename": "turbopack/crates/turbo-tasks/src/id.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fid.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fid.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fid.rs?ref=0d84c976cd26f4a1a62f4a17a5208d9a98c286d4",
            "patch": "@@ -113,7 +113,6 @@ macro_rules! define_id {\n }\n \n define_id!(TaskId: u32, derive(Serialize, Deserialize), serde(transparent));\n-define_id!(FunctionId: u32);\n define_id!(ValueTypeId: u32);\n define_id!(TraitTypeId: u32);\n define_id!(BackendJobId: u32);\n@@ -202,12 +201,6 @@ macro_rules! make_serializable {\n     };\n }\n \n-make_serializable!(\n-    FunctionId,\n-    registry::get_function_global_name,\n-    registry::get_function_id_by_global_name,\n-    FunctionIdVisitor\n-);\n make_serializable!(\n     ValueTypeId,\n     registry::get_value_type_global_name,"
        },
        {
            "sha": "260124df7ecaa11667ea31899ff11a681d24351b",
            "filename": "turbopack/crates/turbo-tasks/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs?ref=0d84c976cd26f4a1a62f4a17a5208d9a98c286d4",
            "patch": "@@ -94,8 +94,7 @@ pub use completion::{Completion, Completions};\n pub use display::ValueToString;\n pub use effect::{ApplyEffectsContext, Effects, apply_effects, effect, get_effects};\n pub use id::{\n-    ExecutionId, FunctionId, LocalTaskId, SessionId, TRANSIENT_TASK_BIT, TaskId, TraitTypeId,\n-    ValueTypeId,\n+    ExecutionId, LocalTaskId, SessionId, TRANSIENT_TASK_BIT, TaskId, TraitTypeId, ValueTypeId,\n };\n pub use invalidation::{\n     DynamicEqHash, InvalidationReason, InvalidationReasonKind, InvalidationReasonSet, Invalidator,"
        },
        {
            "sha": "45eee7aaab6ebc119e731bfe09d324417f484e03",
            "filename": "turbopack/crates/turbo-tasks/src/registry.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 30,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fregistry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fregistry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fregistry.rs?ref=0d84c976cd26f4a1a62f4a17a5208d9a98c286d4",
            "patch": "@@ -1,25 +1,21 @@\n-use std::{fmt::Debug, hash::Hash, num::NonZeroU64, ops::Deref};\n+use std::{fmt::Debug, hash::Hash, num::NonZeroU64, ops::Deref, sync::RwLock};\n \n use dashmap::mapref::entry::Entry;\n use once_cell::sync::Lazy;\n+use rustc_hash::FxHashMap;\n \n use crate::{\n     FxDashMap, TraitType, ValueType,\n-    id::{FunctionId, TraitTypeId, ValueTypeId},\n+    id::{TraitTypeId, ValueTypeId},\n     id_factory::IdFactory,\n     native_function::NativeFunction,\n     no_move_vec::NoMoveVec,\n };\n \n-static FUNCTION_ID_FACTORY: IdFactory<FunctionId> = IdFactory::new_const(\n-    FunctionId::MIN.to_non_zero_u64(),\n-    FunctionId::MAX.to_non_zero_u64(),\n-);\n-static FUNCTIONS_BY_NAME: Lazy<FxDashMap<&'static str, FunctionId>> = Lazy::new(FxDashMap::default);\n-static FUNCTIONS_BY_VALUE: Lazy<FxDashMap<&'static NativeFunction, FunctionId>> =\n-    Lazy::new(FxDashMap::default);\n-static FUNCTIONS: Lazy<NoMoveVec<(&'static NativeFunction, &'static str)>> =\n-    Lazy::new(NoMoveVec::new);\n+static NAME_TO_FUNCTION: Lazy<RwLock<FxHashMap<&'static str, &'static NativeFunction>>> =\n+    Lazy::new(RwLock::default);\n+static FUNCTION_TO_NAME: Lazy<RwLock<FxHashMap<&'static NativeFunction, &'static str>>> =\n+    Lazy::new(RwLock::default);\n \n static VALUE_TYPE_ID_FACTORY: IdFactory<ValueTypeId> = IdFactory::new_const(\n     ValueTypeId::MIN.to_non_zero_u64(),\n@@ -80,31 +76,23 @@ where\n     }\n }\n \n+/// Registers a function so it is available for persistence\n pub fn register_function(global_name: &'static str, func: &'static NativeFunction) {\n-    register_thing(\n-        global_name,\n-        func,\n-        &FUNCTION_ID_FACTORY,\n-        &FUNCTIONS,\n-        &FUNCTIONS_BY_NAME,\n-        &FUNCTIONS_BY_VALUE,\n+    let prev = FUNCTION_TO_NAME.write().unwrap().insert(func, global_name);\n+    debug_assert!(prev.is_none(), \"function {global_name} registered twice?\");\n+    let prev = NAME_TO_FUNCTION.write().unwrap().insert(global_name, func);\n+    debug_assert!(\n+        prev.is_none(),\n+        \"registration mappings for {global_name} are inconsistent!\"\n     );\n }\n \n-pub fn get_function_id(func: &'static NativeFunction) -> FunctionId {\n-    get_thing_id(func, &FUNCTIONS_BY_VALUE)\n-}\n-\n-pub fn get_function_id_by_global_name(global_name: &str) -> Option<FunctionId> {\n-    FUNCTIONS_BY_NAME.get(global_name).map(|x| *x)\n-}\n-\n-pub fn get_function(id: FunctionId) -> &'static NativeFunction {\n-    FUNCTIONS.get(*id as usize).unwrap().0\n+pub fn get_function_by_global_name(global_name: &str) -> &'static NativeFunction {\n+    NAME_TO_FUNCTION.read().unwrap().get(global_name).unwrap()\n }\n \n-pub fn get_function_global_name(id: FunctionId) -> &'static str {\n-    FUNCTIONS.get(*id as usize).unwrap().1\n+pub fn get_function_global_name(func: &'static NativeFunction) -> &'static str {\n+    FUNCTION_TO_NAME.read().unwrap().get(&func).unwrap()\n }\n \n pub fn register_value_type("
        },
        {
            "sha": "fb44f2d52caf23c241fc5aa57f64b7507ce4508a",
            "filename": "turbopack/crates/turbo-tasks/src/task_statistics.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask_statistics.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0d84c976cd26f4a1a62f4a17a5208d9a98c286d4/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask_statistics.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask_statistics.rs?ref=0d84c976cd26f4a1a62f4a17a5208d9a98c286d4",
            "patch": "@@ -73,7 +73,7 @@ impl Serialize for TaskStatistics {\n     {\n         let mut map = serializer.serialize_map(Some(self.inner.len()))?;\n         for entry in &self.inner {\n-            let key = registry::get_function_global_name(registry::get_function_id(entry.key()));\n+            let key = registry::get_function_global_name(entry.key());\n             map.serialize_entry(key, entry.value())?;\n         }\n         map.end()"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 23,
        "deletions": 45
    }
}