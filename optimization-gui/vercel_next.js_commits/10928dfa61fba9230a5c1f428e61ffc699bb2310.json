{
    "author": "huozhi",
    "message": "[global-not-found] fix shared css imports not being picked (#80151)",
    "sha": "10928dfa61fba9230a5c1f428e61ffc699bb2310",
    "files": [
        {
            "sha": "41cd0773febd307fd180a24c794e4a74072b5f6f",
            "filename": "packages/next/src/build/webpack/plugins/flight-client-entry-plugin.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 9,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -108,6 +108,9 @@ const pluginState = getProxiedPluginState({\n   injectedClientEntries: {} as Record<string, string>,\n })\n \n+const POSSIBLE_SHARED_CONVENTIONS = ['template', 'layout']\n+const STANDALONE_BUNDLE_CONVENTION = 'global-not-found'\n+\n function deduplicateCSSImportsForEntry(mergedCSSimports: CssImports) {\n   // If multiple entry module connections are having the same CSS import,\n   // we only need to have one module to keep track of that CSS import.\n@@ -138,8 +141,8 @@ function deduplicateCSSImportsForEntry(mergedCSSimports: CssImports) {\n     const aName = path.parse(aPath).name\n     const bName = path.parse(bPath).name\n \n-    const indexA = ['template', 'layout'].indexOf(aName)\n-    const indexB = ['template', 'layout'].indexOf(bName)\n+    const indexA = POSSIBLE_SHARED_CONVENTIONS.indexOf(aName)\n+    const indexB = POSSIBLE_SHARED_CONVENTIONS.indexOf(bName)\n \n     if (indexA === -1) return 1\n     if (indexB === -1) return -1\n@@ -148,20 +151,29 @@ function deduplicateCSSImportsForEntry(mergedCSSimports: CssImports) {\n \n   const dedupedCSSImports: CssImports = {}\n   const trackedCSSImports = new Set<string>()\n-  for (const [entryName, cssImports] of sortedCSSImports) {\n+\n+  for (const [entryFilePath, cssImports] of sortedCSSImports) {\n+    const entryConventionName = path.parse(entryFilePath).name\n+\n     for (const cssImport of cssImports) {\n-      if (trackedCSSImports.has(cssImport)) continue\n+      // If the CSS import is already tracked, we can skip it.\n+      // Or if it's any standalone entry such as `global-not-found`, it won't share any resources with other entry, skip it.\n+      if (\n+        trackedCSSImports.has(cssImport) &&\n+        STANDALONE_BUNDLE_CONVENTION !== entryConventionName\n+      ) {\n+        continue\n+      }\n \n       // Only track CSS imports that are in files that can inherit CSS.\n-      const filename = path.parse(entryName).name\n-      if (['template', 'layout'].includes(filename)) {\n+      if (POSSIBLE_SHARED_CONVENTIONS.includes(entryConventionName)) {\n         trackedCSSImports.add(cssImport)\n       }\n \n-      if (!dedupedCSSImports[entryName]) {\n-        dedupedCSSImports[entryName] = []\n+      if (!dedupedCSSImports[entryFilePath]) {\n+        dedupedCSSImports[entryFilePath] = []\n       }\n-      dedupedCSSImports[entryName].push(cssImport)\n+      dedupedCSSImports[entryFilePath].push(cssImport)\n     }\n   }\n "
        },
        {
            "sha": "6f7be9458297a35649d5f59c5ba793fad181f36e",
            "filename": "test/e2e/app-dir/global-not-found/css/app/call-not-found/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fcall-not-found%2Fpage.tsx?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+import { notFound } from 'next/navigation'\n+\n+export default function Page() {\n+  notFound()\n+}"
        },
        {
            "sha": "f5733496f458508970b12f5e8e0fc298e3886036",
            "filename": "test/e2e/app-dir/global-not-found/css/app/client.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fclient.tsx?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export function Client() {\n+  return <div id=\"client\">client</div>\n+}"
        },
        {
            "sha": "1ce3b93d298fd5d274798084673e4b2550794147",
            "filename": "test/e2e/app-dir/global-not-found/css/app/global-not-found.css",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal-not-found.css",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal-not-found.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal-not-found.css?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,3 @@\n+.blue-text {\n+  color: rgb(0, 0, 255);\n+}"
        },
        {
            "sha": "ea6b0822865cfe6e648b4c076c5947cd5d828441",
            "filename": "test/e2e/app-dir/global-not-found/css/app/global-not-found.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal-not-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal-not-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal-not-found.tsx?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,17 @@\n+import { Client } from './client'\n+import './global.css'\n+import './global-not-found.css'\n+\n+export default function GlobalNotFound() {\n+  return (\n+    // html tag is different from actual page's layout\n+    <html data-global-not-found=\"true\">\n+      <body>\n+        <h1 id=\"global-error-title\">global-not-found</h1>\n+        <Client />\n+        <p className=\"orange-text\">orange text (from global.css)</p>\n+        <p className=\"blue-text\">blue text (from global-not-found.css)</p>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "a4728aa8c121c50c2c3468c3e8ec7988c0449071",
            "filename": "test/e2e/app-dir/global-not-found/css/app/global.css",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal.css",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fglobal.css?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,3 @@\n+.orange-text {\n+  color: rgb(255, 165, 0);\n+}"
        },
        {
            "sha": "da7692dbf45c764083d0f50ddcce0ba39bb340e3",
            "filename": "test/e2e/app-dir/global-not-found/css/app/layout.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Flayout.tsx?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,16 @@\n+import './global.css'\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+      <footer>\n+        <p className=\"orange-text\">layout footer orange text</p>\n+      </footer>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/global-not-found/css/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fapp%2Fpage.tsx?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "0cbc5b980dad98038c57de7e069ddd0e9910bfde",
            "filename": "test/e2e/app-dir/global-not-found/css/global-not-found-css.test.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fglobal-not-found-css.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fglobal-not-found-css.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fglobal-not-found-css.test.ts?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,23 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('global-not-found - css', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should include css for global-not-found properly', async () => {\n+    const browser = await next.browser('/does-not-exist')\n+\n+    // This css import is shared with `/` route's layout\n+    const textColorOrange = await browser\n+      .elementByCss('.orange-text')\n+      .getComputedCss('color')\n+    expect(textColorOrange).toBe('rgb(255, 165, 0)')\n+\n+    // This css import is only used in the global-not-found convention\n+    const textColorRed = await browser\n+      .elementByCss('.blue-text')\n+      .getComputedCss('color')\n+    expect(textColorRed).toBe('rgb(0, 0, 255)')\n+  })\n+})"
        },
        {
            "sha": "a198cf5a769a106aef77008e1dd3fc2e332aa98e",
            "filename": "test/e2e/app-dir/global-not-found/css/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/10928dfa61fba9230a5c1f428e61ffc699bb2310/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fcss%2Fnext.config.js?ref=10928dfa61fba9230a5c1f428e61ffc699bb2310",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    globalNotFound: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 108,
        "deletions": 9
    }
}