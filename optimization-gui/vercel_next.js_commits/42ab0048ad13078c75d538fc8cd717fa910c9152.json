{
    "author": "kdy1",
    "message": "perf(turbopack): Use `triomphe::Arc` for `Rope` (#76141)\n\n### What?\n\nI tried using `triomphe::Arc` for `Rope`, although there was no big performance difference on my device (mac, M3 Max)\n\n### Why?\n\nIt's a clear win, even if it's very small.",
    "sha": "42ab0048ad13078c75d538fc8cd717fa910c9152",
    "files": [
        {
            "sha": "f8666ea489fa584b2647d5a8289f52e43fb8eeab",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/42ab0048ad13078c75d538fc8cd717fa910c9152/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/42ab0048ad13078c75d538fc8cd717fa910c9152/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=42ab0048ad13078c75d538fc8cd717fa910c9152",
            "patch": "@@ -9339,13 +9339,15 @@ dependencies = [\n  \"tempfile\",\n  \"tokio\",\n  \"tracing\",\n+ \"triomphe 0.1.12\",\n  \"turbo-rcstr\",\n  \"turbo-tasks\",\n  \"turbo-tasks-build\",\n  \"turbo-tasks-hash\",\n  \"turbo-tasks-memory\",\n  \"turbo-tasks-testing\",\n  \"unicode-segmentation\",\n+ \"unsize\",\n  \"urlencoding\",\n ]\n "
        },
        {
            "sha": "2b337ce8b8997530dd29994741cac65eabdaa98c",
            "filename": "turbopack/crates/turbo-tasks-fs/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/42ab0048ad13078c75d538fc8cd717fa910c9152/turbopack%2Fcrates%2Fturbo-tasks-fs%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/42ab0048ad13078c75d538fc8cd717fa910c9152/turbopack%2Fcrates%2Fturbo-tasks-fs%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2FCargo.toml?ref=42ab0048ad13078c75d538fc8cd717fa910c9152",
            "patch": "@@ -47,6 +47,8 @@ serde_json = { workspace = true }\n serde_path_to_error = { workspace = true }\n tokio = { workspace = true }\n tracing = { workspace = true }\n+unsize = \"1.1.0\"\n+triomphe = { workspace = true, features = [\"unsize\"] }\n turbo-rcstr = { workspace = true }\n turbo-tasks = { workspace = true }\n turbo-tasks-hash = { workspace = true }"
        },
        {
            "sha": "baa98d3a605ff1f2dc9ab8ac4c1a4f6721f5e534",
            "filename": "turbopack/crates/turbo-tasks-fs/src/rope.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/42ab0048ad13078c75d538fc8cd717fa910c9152/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/42ab0048ad13078c75d538fc8cd717fa910c9152/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs?ref=42ab0048ad13078c75d538fc8cd717fa910c9152",
            "patch": "@@ -6,7 +6,6 @@ use std::{\n     mem,\n     ops::{AddAssign, Deref},\n     pin::Pin,\n-    sync::Arc,\n     task::{Context as TaskContext, Poll},\n };\n \n@@ -16,7 +15,9 @@ use futures::Stream;\n use serde::{Deserialize, Deserializer, Serialize, Serializer};\n use serde_bytes::ByteBuf;\n use tokio::io::{AsyncRead, ReadBuf};\n+use triomphe::Arc;\n use turbo_tasks_hash::{DeterministicHash, DeterministicHasher};\n+use unsize::{CoerceUnsize, Coercion};\n use RopeElem::{Local, Shared};\n \n static EMPTY_BUF: &[u8] = &[];\n@@ -141,7 +142,7 @@ impl<T: Into<Bytes>> From<T> for Rope {\n         } else {\n             Rope {\n                 length: bytes.len(),\n-                data: InnerRope(Arc::from([Local(bytes)])),\n+                data: InnerRope(Arc::from([Local(bytes)]).unsize(Coercion::to_slice())),\n             }\n         }\n     }\n@@ -539,7 +540,7 @@ impl InnerRope {\n \n impl Default for InnerRope {\n     fn default() -> Self {\n-        InnerRope(Arc::from([]))\n+        InnerRope(Arc::new([]).unsize(Coercion::to_slice()))\n     }\n }\n "
        }
    ],
    "stats": {
        "total": 11,
        "additions": 8,
        "deletions": 3
    }
}