{
    "author": "devjiwonchoi",
    "message": "[next-config-ts] Set Node.js native TS loader fallback flag to process.env (#83832)\n\nSince local variables aren't passed to the workers, the fallback flag\nwasn't passed correctly. Since `process.env` is passed, use that to set\nthe flag.\n\n#### Before\n\n```\n    running pnpm next build\n\n ⚠ Failed to import \"next.config.ts\" using Node.js native TypeScript resolution. Falling back to legacy resolution. {\n  cause: TypeError: Module \"file:///private/var/folders/cm/328vyfy92k194zkm0jpl5sqw0000gn/T/next-install-0b4875510d429ddf1727b03e3cbba84cb61013dfee0914f9812b7608c029a47f/foo.json\" needs an import attribute of \"type: json\"\n      at ignore-listed frames {\n    code: 'ERR_IMPORT_ATTRIBUTE_MISSING'\n  }\n}\n\n   Creating an optimized production build ...\n ⚠ Failed to import \"next.config.ts\" using Node.js native TypeScript resolution. Falling back to legacy resolution. {\n  cause: TypeError: Module \"file:///private/var/folders/cm/328vyfy92k194zkm0jpl5sqw0000gn/T/next-install-0b4875510d429ddf1727b03e3cbba84cb61013dfee0914f9812b7608c029a47f/foo.json\" needs an import attribute of \"type: json\"\n      at ignore-listed frames {\n    code: 'ERR_IMPORT_ATTRIBUTE_MISSING'\n  }\n}\n ⚠ Failed to import \"next.config.ts\" using Node.js native TypeScript resolution. Falling back to legacy resolution. {\n  cause: TypeError: Module \"file:///private/var/folders/cm/328vyfy92k194zkm0jpl5sqw0000gn/T/next-install-0b4875510d429ddf1727b03e3cbba84cb61013dfee0914f9812b7608c029a47f/foo.json\" needs an import attribute of \"type: json\"\n      at ignore-listed frames {\n    code: 'ERR_IMPORT_ATTRIBUTE_MISSING'\n  }\n}\n ⚠ Failed to import \"next.config.ts\" using Node.js native TypeScript resolution. Falling back to legacy resolution. {\n  cause: TypeError: Module \"file:///private/var/folders/cm/328vyfy92k194zkm0jpl5sqw0000gn/T/next-install-0b4875510d429ddf1727b03e3cbba84cb61013dfee0914f9812b7608c029a47f/foo.json\" needs an import attribute of \"type: json\"\n      at ignore-listed frames {\n    code: 'ERR_IMPORT_ATTRIBUTE_MISSING'\n  }\n}\n\n ✓ Starting...\n ⚠ Failed to import \"next.config.ts\" using Node.js native TypeScript resolution. Falling back to legacy resolution. {\n  cause: TypeError: Module \"file:///private/var/folders/cm/328vyfy92k194zkm0jpl5sqw0000gn/T/next-install-0b4875510d429ddf1727b03e3cbba84cb61013dfee0914f9812b7608c029a47f/foo.json\" needs an import attribute of \"type: json\"\n      at ignore-listed frames {\n    code: 'ERR_IMPORT_ATTRIBUTE_MISSING'\n  }\n}\n ✓ Ready in 316ms\n```\n\n#### After\n\n```\n    running pnpm next build\n\n ⚠ Failed to import \"next.config.ts\" using Node.js native TypeScript resolution. Falling back to legacy resolution. {\n  cause: TypeError: Module \"file:///private/var/folders/cm/328vyfy92k194zkm0jpl5sqw0000gn/T/next-install-baa26127b75b4c408a5e1a471c7b7908c7cd11e4843c7a9d850a2c0d8ca2eadb/foo.json\" needs an import attribute of \"type: json\"\n      at ignore-listed frames {\n    code: 'ERR_IMPORT_ATTRIBUTE_MISSING'\n  }\n}\n ✓ Starting...\n ⚠ Failed to import \"next.config.ts\" using Node.js native TypeScript resolution. Falling back to legacy resolution. {\n  cause: TypeError: Module \"file:///private/var/folders/cm/328vyfy92k194zkm0jpl5sqw0000gn/T/next-install-baa26127b75b4c408a5e1a471c7b7908c7cd11e4843c7a9d850a2c0d8ca2eadb/foo.json\" needs an import attribute of \"type: json\"\n      at ignore-listed frames {\n    code: 'ERR_IMPORT_ATTRIBUTE_MISSING'\n  }\n}\n ✓ Ready in 309ms\n```",
    "sha": "18425676ddc7696994c05afa5da9dc9cd20b1d07",
    "files": [
        {
            "sha": "4a2e9047659398c07b3f43b86a81b241227857b8",
            "filename": "packages/next/src/build/next-config-ts/transpile-config.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/18425676ddc7696994c05afa5da9dc9cd20b1d07/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/18425676ddc7696994c05afa5da9dc9cd20b1d07/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts?ref=18425676ddc7696994c05afa5da9dc9cd20b1d07",
            "patch": "@@ -105,8 +105,6 @@ async function getTsConfig(cwd: string): Promise<CompilerOptions> {\n   return parsedCommandLine.options\n }\n \n-let useNodeNativeTSLoader = true\n-\n export async function transpileConfig({\n   nextConfigPath,\n   configFileName,\n@@ -117,7 +115,8 @@ export async function transpileConfig({\n   cwd: string\n }) {\n   try {\n-    if (useNodeNativeTSLoader) {\n+    // envs are passed to the workers and preserve the flag\n+    if (process.env.__NEXT_NODE_NATIVE_TS_LOADER_FAILED !== '1') {\n       try {\n         // Node.js v22.10.0+\n         // Value is 'strip' or 'transform' based on how the feature is enabled.\n@@ -140,15 +139,15 @@ export async function transpileConfig({\n         }\n \n         // Feature is not enabled, fallback to legacy resolution for current session.\n-        useNodeNativeTSLoader = false\n+        process.env.__NEXT_NODE_NATIVE_TS_LOADER_FAILED = '1'\n       } catch (cause) {\n         warnOnce(\n           `Failed to import \"${configFileName}\" using Node.js native TypeScript resolution.` +\n             ' Falling back to legacy resolution.',\n           { cause }\n         )\n         // Once failed, fallback to legacy resolution for current session.\n-        useNodeNativeTSLoader = false\n+        process.env.__NEXT_NODE_NATIVE_TS_LOADER_FAILED = '1'\n       }\n     }\n "
        }
    ],
    "stats": {
        "total": 9,
        "additions": 4,
        "deletions": 5
    }
}