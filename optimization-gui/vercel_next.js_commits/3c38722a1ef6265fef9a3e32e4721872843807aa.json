{
    "author": "huozhi",
    "message": "[metadata] replace for initial body icon case (#81688)",
    "sha": "3c38722a1ef6265fef9a3e32e4721872843807aa",
    "files": [
        {
            "sha": "9375408cb7164da1023e225af85ae977ac5154b8",
            "filename": "packages/next/src/server/stream-utils/node-web-streams-helper.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 13,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/3c38722a1ef6265fef9a3e32e4721872843807aa/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c38722a1ef6265fef9a3e32e4721872843807aa/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fstream-utils%2Fnode-web-streams-helper.ts?ref=3c38722a1ef6265fef9a3e32e4721872843807aa",
            "patch": "@@ -263,21 +263,39 @@ function createMetadataTransformStream(\n       // Check if icon mark is inside <head> tag in the first chunk.\n       if (chunkIndex === 0) {\n         closedHeadIndex = indexOfUint8Array(chunk, ENCODED_TAGS.CLOSED.HEAD)\n-        // The mark icon is located in the 1st chunk before the head tag.\n-        // We do not need to insert the script tag in this case because it's in the head.\n-        // Just remove the icon mark from the chunk.\n-        if (iconMarkIndex < closedHeadIndex && iconMarkIndex !== -1) {\n-          const replaced = new Uint8Array(chunk.length - iconMarkLength)\n-\n-          // Remove the icon mark from the chunk.\n-          replaced.set(chunk.subarray(0, iconMarkIndex))\n-          replaced.set(\n-            chunk.subarray(iconMarkIndex + iconMarkLength),\n-            iconMarkIndex\n-          )\n-          chunk = replaced\n+        if (iconMarkIndex !== -1) {\n+          // The mark icon is located in the 1st chunk before the head tag.\n+          // We do not need to insert the script tag in this case because it's in the head.\n+          // Just remove the icon mark from the chunk.\n+          if (iconMarkIndex < closedHeadIndex) {\n+            const replaced = new Uint8Array(chunk.length - iconMarkLength)\n+\n+            // Remove the icon mark from the chunk.\n+            replaced.set(chunk.subarray(0, iconMarkIndex))\n+            replaced.set(\n+              chunk.subarray(iconMarkIndex + iconMarkLength),\n+              iconMarkIndex\n+            )\n+            chunk = replaced\n+          } else {\n+            // The icon mark is after the head tag, replace and insert the script tag at that position.\n+            const insertion = await insert()\n+            const encodedInsertion = encoder.encode(insertion)\n+            const insertionLength = encodedInsertion.length\n+            const replaced = new Uint8Array(\n+              chunk.length - iconMarkLength + insertionLength\n+            )\n+            replaced.set(chunk.subarray(0, iconMarkIndex))\n+            replaced.set(encodedInsertion, iconMarkIndex)\n+            replaced.set(\n+              chunk.subarray(iconMarkIndex + iconMarkLength),\n+              iconMarkIndex + insertionLength\n+            )\n+            chunk = replaced\n+          }\n           isMarkRemoved = true\n         }\n+        // If there's no icon mark located, it will be handled later when if present in the following chunks.\n       } else {\n         // When it's appeared in the following chunks, we'll need to\n         // remove the mark and then insert the script tag at that position."
        },
        {
            "sha": "932d9062e8149b23ccef2770c12e65940bc104f9",
            "filename": "test/e2e/app-dir/metadata-icons/app/custom-icon/delay-icons/page.tsx",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/3c38722a1ef6265fef9a3e32e4721872843807aa/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fdelay-icons%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c38722a1ef6265fef9a3e32e4721872843807aa/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fdelay-icons%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fapp%2Fcustom-icon%2Fdelay-icons%2Fpage.tsx?ref=3c38722a1ef6265fef9a3e32e4721872843807aa",
            "patch": "@@ -0,0 +1,28 @@\n+import Link from 'next/link'\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  return (\n+    <div>\n+      <h1>Delay Icons</h1>\n+      <Link id=\"custom-icon-sub-link\" href=\"/custom-icon/sub\">\n+        Go to another page with custom icon\n+      </Link>\n+      <br />\n+      <Link id=\"custom-icon-sub-link\" href=\"/custom-icon\">\n+        Go to root page with custom icon\n+      </Link>\n+    </div>\n+  )\n+}\n+\n+export async function generateMetadata() {\n+  await connection()\n+  return {\n+    // This long text description will lead to the metadata being inserted after the head tag.\n+    description: 'long text description'.repeat(1000),\n+    icons: {\n+      icon: `/heart.png`,\n+    },\n+  }\n+}"
        },
        {
            "sha": "1adba07b53228060a8c81f07a2a90df4d79d511f",
            "filename": "test/e2e/app-dir/metadata-icons/metadata-icons.test.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 3,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/3c38722a1ef6265fef9a3e32e4721872843807aa/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c38722a1ef6265fef9a3e32e4721872843807aa/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-icons%2Fmetadata-icons.test.ts?ref=3c38722a1ef6265fef9a3e32e4721872843807aa",
            "patch": "@@ -1,6 +1,8 @@\n import { nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n \n+const iconInsertionScript = `document.querySelectorAll('body link[rel=\"icon\"], body link[rel=\"apple-touch-icon\"]').forEach(el => document.head.appendChild(el))`\n+\n describe('app-dir - metadata-icons', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,\n@@ -45,15 +47,13 @@ describe('app-dir - metadata-icons', () => {\n   })\n \n   it('should not contain icon insertion script when metadata is rendered in head', async () => {\n-    const iconInsertionScript = `document.querySelectorAll('body link[rel=\"icon\"], body link[rel=\"apple-touch-icon\"]').forEach(el => document.head.appendChild(el))`\n-\n     const suspendedHtml = await next.render('/custom-icon')\n     expect(suspendedHtml).toContain(iconInsertionScript)\n   })\n \n   it('should not contain icon replacement mark in html or after hydration', async () => {\n     const html = await next.render('/custom-icon')\n-    expect(html).not.toContain('<meta name=\"«nxt-icon»\" content=\"\"/>')\n+    expect(html).not.toContain('<meta name=\"«nxt-icon»\">')\n     expect(html).not.toContain('«nxt-icon»')\n \n     const browser = await next.browser('/custom-icon')\n@@ -112,4 +112,32 @@ describe('app-dir - metadata-icons', () => {\n       ])\n     })\n   })\n+\n+  it('should re-insert the icons into head when icons are inserted in body during initial chunk', async () => {\n+    const $ = await next.render$('/custom-icon/delay-icons')\n+    expect($('meta[name=\"«nxt-icon»\"]').length).toBe(0)\n+\n+    // body will contain the icons and the script to insert them into head\n+    const body = $('body')\n+    const icons = body.find('link[rel=\"icon\"]')\n+    expect(icons.length).toBe(2)\n+    expect(Array.from(icons.map((_, el) => $(el).attr('href')))).toContain(\n+      '/heart.png'\n+    )\n+\n+    const bodyHtml = body.html()\n+    expect(bodyHtml).toContain(iconInsertionScript)\n+\n+    // icons should be inserted into head after hydration\n+    const browser = await next.browser('/custom-icon/delay-icons')\n+    await retry(async () => {\n+      const iconsInHead = await browser.elementsByCss('head link[rel=\"icon\"]')\n+      const iconUrls = await Promise.all(\n+        iconsInHead.map(\n+          async (el) => (await el.getAttribute('href')).split('?')[0]\n+        )\n+      )\n+      expect(iconUrls).toEqual(['/favicon.ico', '/heart.png'])\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 90,
        "deletions": 16
    }
}