{
    "author": "mischnic",
    "message": "Turbopack: error when importing Typescript in node_modules (#83990)\n\nWebpack treats TS files in node_modules as Javascript files (i.e. you get a JS parse error)\n\nTurbopack previously did a similar thing (though it parsed as Typescript, but then never ran the TS AST transform).\nThis never worked properly, it failed due to some unreachable assertion in the swc transforms.\n\nNow it fails with a proper error ~~, though too many of them~~:\n\n```\n./node_modules/.pnpm/pkg@file+pkg/node_modules/pkg/index.ts\nMissing module type\nThe module type effect must be applied before adding Ecmascript transforms\n\n\n./node_modules/.pnpm/pkg@file+pkg/node_modules/pkg/index.ts\nUnknown module type\nThis module doesn't have an associated type. Use a known file extension, or register a loader for it.\n\nRead more: https://nextjs.org/docs/app/api-reference/next-config-js/turbo#webpack-loaders\n    at ignore-listed frames\n```\n\nAdditionally: don't run styled-jsx/styled-components/relay/... in node_modules in the server. This aligns it what we already had configured for the client context",
    "sha": "6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
    "files": [
        {
            "sha": "ea4cf9db95c7c71c92111059ed4da9341e63c59b",
            "filename": "crates/next-core/src/next_client/transforms.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -32,7 +32,10 @@ pub async fn get_next_client_transforms_rules(\n \n     let modularize_imports_config = &next_config.modularize_imports().await?;\n     let enable_mdx_rs = next_config.mdx_rs().await?.is_some();\n-    rules.push(get_next_lint_transform_rule(enable_mdx_rs));\n+\n+    if !foreign_code {\n+        rules.push(get_next_lint_transform_rule(enable_mdx_rs));\n+    }\n \n     if !modularize_imports_config.is_empty() {\n         rules.push(get_next_modularize_imports_rule("
        },
        {
            "sha": "b4bc06b0992d6b5ad8b9bd1c2d4f366fbf1acee6",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 51,
            "deletions": 75,
            "changes": 126,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -559,14 +559,16 @@ pub async fn get_server_module_options_context(\n     .flatten()\n     .collect();\n \n-    // Custom ecma transform rules selectively being applied depends on the server\n-    // context type.\n-    let styled_components_transform_rule =\n-        get_styled_components_transform_rule(next_config).await?;\n-    // It's important the client's browserlist config is used for styled-jsx, otherwise we transpile\n-    // the CSS to be compatible with Node.js 20.\n-    let styled_jsx_transform_rule =\n-        get_styled_jsx_transform_rule(next_config, client_environment.runtime_versions()).await?;\n+    // Only relevant for pages, not routes/etc.\n+    let page_transform_rules: Vec<ModuleRule> = vec![\n+        get_styled_components_transform_rule(next_config).await?,\n+        // It's important the client's browserlist config is used for styled-jsx, otherwise we\n+        // transpile the CSS to be compatible with Node.js 20.\n+        get_styled_jsx_transform_rule(next_config, client_environment.runtime_versions()).await?,\n+    ]\n+    .into_iter()\n+    .flatten()\n+    .collect();\n \n     let source_maps = if *next_config.server_source_maps().await? {\n         SourceMapsType::Full\n@@ -608,23 +610,16 @@ pub async fn get_server_module_options_context(\n \n     let module_options_context = match ty {\n         ServerContextType::Pages { .. } | ServerContextType::PagesApi { .. } => {\n-            let mut custom_source_transform_rules: Vec<ModuleRule> =\n-                vec![styled_components_transform_rule, styled_jsx_transform_rule]\n-                    .into_iter()\n-                    .flatten()\n-                    .collect();\n-\n+            next_server_rules.extend(page_transform_rules);\n             if let ServerContextType::Pages { .. } = ty {\n-                custom_source_transform_rules.push(\n+                next_server_rules.push(\n                     get_next_react_server_components_transform_rule(next_config, false, None)\n                         .await?,\n                 );\n             }\n \n-            next_server_rules.extend(custom_source_transform_rules.iter().cloned());\n             next_server_rules.extend(source_transform_rules);\n \n-            foreign_next_server_rules.extend(custom_source_transform_rules);\n             foreign_next_server_rules.extend(internal_custom_rules);\n \n             let url_rewrite_behavior = Some(\n@@ -690,21 +685,13 @@ pub async fn get_server_module_options_context(\n             }\n         }\n         ServerContextType::AppSSR { app_dir, .. } => {\n-            let mut custom_source_transform_rules: Vec<ModuleRule> =\n-                vec![styled_components_transform_rule, styled_jsx_transform_rule]\n-                    .into_iter()\n-                    .flatten()\n-                    .collect();\n-\n-            foreign_next_server_rules.extend(custom_source_transform_rules.iter().cloned());\n             foreign_next_server_rules.extend(internal_custom_rules);\n \n-            custom_source_transform_rules.push(\n+            next_server_rules.extend(page_transform_rules.clone());\n+            next_server_rules.push(\n                 get_next_react_server_components_transform_rule(next_config, false, Some(app_dir))\n                     .await?,\n             );\n-\n-            next_server_rules.extend(custom_source_transform_rules.clone());\n             next_server_rules.extend(source_transform_rules);\n \n             let foreign_code_module_options_context = ModuleOptionsContext {\n@@ -755,33 +742,29 @@ pub async fn get_server_module_options_context(\n             ecmascript_client_reference_transition_name,\n             ..\n         } => {\n-            let mut custom_source_transform_rules: Vec<ModuleRule> =\n-                vec![styled_components_transform_rule, styled_jsx_transform_rule]\n-                    .into_iter()\n-                    .flatten()\n-                    .collect();\n-\n-            if let Some(ecmascript_client_reference_transition_name) =\n-                ecmascript_client_reference_transition_name\n-            {\n-                custom_source_transform_rules.push(get_ecma_transform_rule(\n-                    Box::new(ClientDirectiveTransformer::new(\n-                        ecmascript_client_reference_transition_name,\n-                    )),\n-                    enable_mdx_rs.is_some(),\n-                    EcmascriptTransformStage::Preprocess,\n-                ));\n-            }\n+            next_server_rules.extend(page_transform_rules);\n+\n+            let client_directive_transformer = ecmascript_client_reference_transition_name.map(\n+                |ecmascript_client_reference_transition_name| {\n+                    get_ecma_transform_rule(\n+                        Box::new(ClientDirectiveTransformer::new(\n+                            ecmascript_client_reference_transition_name,\n+                        )),\n+                        enable_mdx_rs.is_some(),\n+                        EcmascriptTransformStage::Preprocess,\n+                    )\n+                },\n+            );\n \n-            foreign_next_server_rules.extend(custom_source_transform_rules.iter().cloned());\n+            foreign_next_server_rules.extend(client_directive_transformer.clone());\n             foreign_next_server_rules.extend(internal_custom_rules);\n \n-            custom_source_transform_rules.push(\n+            next_server_rules.extend(client_directive_transformer.clone());\n+            next_server_rules.push(\n                 get_next_react_server_components_transform_rule(next_config, true, Some(app_dir))\n                     .await?,\n             );\n \n-            next_server_rules.extend(custom_source_transform_rules.clone());\n             next_server_rules.extend(source_transform_rules);\n \n             let foreign_code_module_options_context = ModuleOptionsContext {\n@@ -909,35 +892,28 @@ pub async fn get_server_module_options_context(\n             app_dir,\n             ecmascript_client_reference_transition_name,\n         } => {\n-            let mut custom_source_transform_rules: Vec<ModuleRule> =\n-                vec![styled_components_transform_rule, styled_jsx_transform_rule]\n-                    .into_iter()\n-                    .flatten()\n-                    .collect();\n-\n-            if let Some(ecmascript_client_reference_transition_name) =\n-                ecmascript_client_reference_transition_name\n-            {\n-                custom_source_transform_rules.push(get_ecma_transform_rule(\n-                    Box::new(ClientDirectiveTransformer::new(\n-                        ecmascript_client_reference_transition_name,\n-                    )),\n-                    enable_mdx_rs.is_some(),\n-                    EcmascriptTransformStage::Preprocess,\n-                ));\n-            } else {\n-                custom_source_transform_rules.push(get_ecma_transform_rule(\n-                    Box::new(ClientDisallowedDirectiveTransformer::new(\n-                        \"next/dist/client/use-client-disallowed.js\".to_string(),\n-                    )),\n-                    enable_mdx_rs.is_some(),\n-                    EcmascriptTransformStage::Preprocess,\n-                ));\n-            }\n-\n-            custom_source_transform_rules.push(\n+            let custom_source_transform_rules: Vec<ModuleRule> = vec![\n+                if let Some(ecmascript_client_reference_transition_name) =\n+                    ecmascript_client_reference_transition_name\n+                {\n+                    get_ecma_transform_rule(\n+                        Box::new(ClientDirectiveTransformer::new(\n+                            ecmascript_client_reference_transition_name,\n+                        )),\n+                        enable_mdx_rs.is_some(),\n+                        EcmascriptTransformStage::Preprocess,\n+                    )\n+                } else {\n+                    get_ecma_transform_rule(\n+                        Box::new(ClientDisallowedDirectiveTransformer::new(\n+                            \"next/dist/client/use-client-disallowed.js\".to_string(),\n+                        )),\n+                        enable_mdx_rs.is_some(),\n+                        EcmascriptTransformStage::Preprocess,\n+                    )\n+                },\n                 get_next_react_server_components_transform_rule(next_config, true, app_dir).await?,\n-            );\n+            ];\n \n             internal_custom_rules.extend(custom_source_transform_rules.iter().cloned());\n "
        },
        {
            "sha": "11cae645ab53b21859377ab92bfff6349c9916ee",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -39,7 +39,9 @@ pub async fn get_next_server_transforms_rules(\n     let modularize_imports_config = &next_config.modularize_imports().await?;\n     let mdx_rs = next_config.mdx_rs().await?.is_some();\n \n-    rules.push(get_next_lint_transform_rule(mdx_rs));\n+    if !foreign_code {\n+        rules.push(get_next_lint_transform_rule(mdx_rs));\n+    }\n \n     if !modularize_imports_config.is_empty() {\n         rules.push(get_next_modularize_imports_rule("
        },
        {
            "sha": "c6cd8470693c81d241d1965bfa714453a903707c",
            "filename": "test/e2e/app-dir/app-routes-client-component/node_modules/my-module/MyModuleClientComponent.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Fapp-dir%2Fapp-routes-client-component%2Fnode_modules%2Fmy-module%2FMyModuleClientComponent.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Fapp-dir%2Fapp-routes-client-component%2Fnode_modules%2Fmy-module%2FMyModuleClientComponent.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-routes-client-component%2Fnode_modules%2Fmy-module%2FMyModuleClientComponent.js?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "previous_filename": "test/e2e/app-dir/app-routes-client-component/node_modules/my-module/MyModuleClientComponent.tsx"
        },
        {
            "sha": "bf15eff980a84e31a072de5ab9858140b85106a3",
            "filename": "test/e2e/transpile-packages-typescript-foreign/app/layout.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fapp%2Flayout.js?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -0,0 +1,10 @@\n+import * as React from 'react'\n+\n+export default function Root({ children }) {\n+  return (\n+    <html>\n+      <head></head>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "7ec6a2f42b27bfe38ebbcdc15180258e639bf1fb",
            "filename": "test/e2e/transpile-packages-typescript-foreign/app/page.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fapp%2Fpage.js?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -0,0 +1,5 @@\n+import { Foo } from 'pkg/index.ts'\n+\n+export default function Page() {\n+  return <main>Hello {Foo}</main>\n+}"
        },
        {
            "sha": "3f43493645b4986b06694d5f46f08da4f03f31c1",
            "filename": "test/e2e/transpile-packages-typescript-foreign/index.test.ts",
            "status": "added",
            "additions": 62,
            "deletions": 0,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Findex.test.ts?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -0,0 +1,62 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('transpile-packages-typescript-foreign', () => {\n+  describe('without transpilePackages', () => {\n+    const { next, skipped } = nextTestSetup({\n+      files: __dirname,\n+      skipDeployment: true,\n+      skipStart: true,\n+      dependencies: {\n+        pkg: `file:./pkg`,\n+      },\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    it('should fail', async () => {\n+      try {\n+        await next.start()\n+        await next.render('/')\n+      } catch (e) {}\n+\n+      if (process.env.IS_TURBOPACK_TEST) {\n+        expect(next.cliOutput).toContain(`pkg/index.ts\n+Unknown module type\n+This module doesn't have an associated type`)\n+        expect(\n+          next.cliOutput.match(/Unknown module type/g).length\n+        ).toBeLessThanOrEqual(1)\n+        expect(\n+          next.cliOutput.match(/Missing module type/g).length\n+        ).toBeLessThanOrEqual(1)\n+      } else {\n+        expect(next.cliOutput).toContain(`pkg/index.ts\n+Module parse failed: Unexpected token`)\n+      }\n+    })\n+  })\n+\n+  describe('with transpilePackages', () => {\n+    const { next, skipped } = nextTestSetup({\n+      files: __dirname,\n+      skipDeployment: true,\n+      dependencies: {\n+        pkg: `file:./pkg`,\n+      },\n+      nextConfig: {\n+        transpilePackages: ['pkg'],\n+      },\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    it('should work', async () => {\n+      const $ = await next.render$('/')\n+      expect($('main').text()).toEqual('Hello 123')\n+    })\n+  })\n+})"
        },
        {
            "sha": "ee0dd2b04a643178d8dfd040c86ae94daac52db2",
            "filename": "test/e2e/transpile-packages-typescript-foreign/pkg/cents.ts",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Fcents.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Fcents.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Fcents.ts?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -0,0 +1 @@\n+export type Cents = number"
        },
        {
            "sha": "1bc6fa9c31073539f0e0be2e48f5464232b2d6d2",
            "filename": "test/e2e/transpile-packages-typescript-foreign/pkg/index.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Findex.ts?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -0,0 +1,5 @@\n+import type { Cents } from './cents'\n+\n+export type Type = Cents\n+\n+export const Foo = 123"
        },
        {
            "sha": "cd6c0be32b264cdfe0bbc59cea53a30e3ef8a138",
            "filename": "test/e2e/transpile-packages-typescript-foreign/pkg/package.json",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftranspile-packages-typescript-foreign%2Fpkg%2Fpackage.json?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -0,0 +1,4 @@\n+{\n+  \"name\": \"pkg\",\n+  \"version\": \"1.0.0\"\n+}"
        },
        {
            "sha": "190cbb13245b7993529432777d24adca67bf8389",
            "filename": "turbopack/crates/turbopack-core/src/chunk/module_id_strategies.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 27,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmodule_id_strategies.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmodule_id_strategies.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmodule_id_strategies.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -4,10 +4,7 @@ use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n use turbo_tasks_hash::hash_xxh3_hash64;\n \n use super::ModuleId;\n-use crate::{\n-    ident::AssetIdent,\n-    issue::{IssueExt, StyledString, module::ModuleIssue},\n-};\n+use crate::ident::AssetIdent;\n \n #[turbo_tasks::value_trait]\n pub trait ModuleIdStrategy {\n@@ -54,32 +51,17 @@ impl ModuleIdStrategy for GlobalModuleIdStrategy {\n         }\n \n         let ident_string = ident.to_string().await?;\n-        if !ident_string.ends_with(\"[app-client] (ecmascript, next/dynamic entry)\") {\n+        if ident_string.ends_with(\"[app-client] (ecmascript, next/dynamic entry)\") {\n             // TODO: This shouldn't happen, but is a temporary workaround to ignore next/dynamic\n             // imports of a server component from another server component.\n-            // TODO(PACK-4879): should this be a debug_assert! a panic!? a bail!?\n-\n-            ModuleIssue {\n-                ident,\n-                title: StyledString::Text(\n-                    format!(\"ModuleId not found for ident: {ident_string:?}\").into(),\n-                )\n-                .resolved_cell(),\n-                description: StyledString::Text(\n-                    format!(\"ModuleId not found for ident: {ident_string:?}\").into(),\n-                )\n-                .resolved_cell(),\n-                source: None,\n-            }\n-            .resolved_cell()\n-            .emit();\n+            return Ok(ModuleId::String(\n+                hash_xxh3_hash64(ident.to_string().await?)\n+                    .to_string()\n+                    .into(),\n+            )\n+            .cell());\n         }\n \n-        Ok(ModuleId::String(\n-            hash_xxh3_hash64(ident.to_string().await?)\n-                .to_string()\n-                .into(),\n-        )\n-        .cell())\n+        bail!(\"ModuleId not found for ident: {ident_string:?}\");\n     }\n }"
        },
        {
            "sha": "6ac8ef7523973415428cc33fc7d94eb3fb1cb840",
            "filename": "turbopack/crates/turbopack-core/src/issue/module.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fissue%2Fmodule.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -1,5 +1,5 @@\n use anyhow::Result;\n-use turbo_rcstr::rcstr;\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, Vc};\n use turbo_tasks_fs::FileSystemPath;\n \n@@ -10,14 +10,32 @@ use crate::{\n     source::Source,\n };\n \n-#[turbo_tasks::value(shared)]\n+#[turbo_tasks::value]\n pub struct ModuleIssue {\n     pub ident: ResolvedVc<AssetIdent>,\n     pub title: ResolvedVc<StyledString>,\n     pub description: ResolvedVc<StyledString>,\n     // TODO(PACK-4879): make this mandatory and drop `ident`\n     pub source: Option<IssueSource>,\n }\n+#[turbo_tasks::value_impl]\n+impl ModuleIssue {\n+    #[turbo_tasks::function]\n+    pub fn new(\n+        ident: ResolvedVc<AssetIdent>,\n+        title: RcStr,\n+        description: RcStr,\n+        source: Option<IssueSource>,\n+    ) -> Vc<Self> {\n+        ModuleIssue {\n+            ident,\n+            title: StyledString::Text(title).resolved_cell(),\n+            description: StyledString::Text(description).resolved_cell(),\n+            source,\n+        }\n+        .cell()\n+    }\n+}\n \n #[turbo_tasks::value_impl]\n impl Issue for ModuleIssue {"
        },
        {
            "sha": "035f254d676addc90e2b13e9a2052d0e20883704",
            "filename": "turbopack/crates/turbopack-nft/src/nft.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -6,7 +6,10 @@ use turbo_tasks::{ResolvedVc, TransientInstance, TryJoinIterExt, ValueToString,\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack::{\n     ModuleAssetContext,\n-    module_options::{CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext},\n+    module_options::{\n+        CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext,\n+        TypescriptTransformOptions,\n+    },\n };\n use turbopack_cli_utils::issue::{ConsoleUi, LogOptions};\n use turbopack_core::{\n@@ -80,6 +83,9 @@ async fn node_file_trace_operation(\n         CompileTimeInfo::new(environment),\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n+                enable_typescript_transform: Some(\n+                    TypescriptTransformOptions::default().resolved_cell(),\n+                ),\n                 ..Default::default()\n             },\n             css: CssOptionsContext {"
        },
        {
            "sha": "ef67c32338d5415c9c4300fb3bf8e2896652f2e9",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -23,7 +23,7 @@ use turbopack::{\n     ecmascript::{EcmascriptInputTransform, TreeShakingMode, chunk::EcmascriptChunkType},\n     module_options::{\n         EcmascriptOptionsContext, JsxTransformOptions, ModuleOptionsContext, ModuleRule,\n-        ModuleRuleEffect, RuleCondition,\n+        ModuleRuleEffect, RuleCondition, TypescriptTransformOptions,\n     },\n };\n use turbopack_browser::BrowserChunkingContext;\n@@ -340,6 +340,9 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n         compile_time_info,\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n+                enable_typescript_transform: Some(\n+                    TypescriptTransformOptions::default().resolved_cell(),\n+                ),\n                 enable_jsx: Some(JsxTransformOptions::resolved_cell(JsxTransformOptions {\n                     development: true,\n                     ..Default::default()"
        },
        {
            "sha": "9fcd8b05b9570a631283b8046913eaff0007384a",
            "filename": "turbopack/crates/turbopack-tracing/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -34,7 +34,10 @@ use turbo_tasks_backend::TurboTasksBackend;\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack::{\n     ModuleAssetContext, emit_with_completion_operation,\n-    module_options::{CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext},\n+    module_options::{\n+        CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext,\n+        TypescriptTransformOptions,\n+    },\n };\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n@@ -357,6 +360,9 @@ async fn node_file_trace_operation(\n         CompileTimeInfo::new(environment),\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n+                enable_typescript_transform: Some(\n+                    TypescriptTransformOptions::default().resolved_cell(),\n+                ),\n                 enable_types: true,\n                 ..Default::default()\n             },"
        },
        {
            "sha": "aa03a3bd2e335a8e830242684789453af1bc22a7",
            "filename": "turbopack/crates/turbopack-tracing/tests/unit.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -15,7 +15,10 @@ use turbo_tasks_backend::TurboTasksBackend;\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack::{\n     ModuleAssetContext,\n-    module_options::{CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext},\n+    module_options::{\n+        CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext,\n+        TypescriptTransformOptions,\n+    },\n };\n use turbopack_core::{\n     chunk::ChunkingType,\n@@ -195,6 +198,9 @@ async fn node_file_trace_operation(package_root: RcStr, input: RcStr) -> Result<\n         CompileTimeInfo::new(environment),\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n+                enable_typescript_transform: Some(\n+                    TypescriptTransformOptions::default().resolved_cell(),\n+                ),\n                 ..Default::default()\n             },\n             css: CssOptionsContext {"
        },
        {
            "sha": "e17b7799a11ccb11bb4c8cac3c5c934075ca5892",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 22,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -37,7 +37,7 @@ use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n     context::{AssetContext, ProcessResult},\n     ident::Layer,\n-    issue::{IssueExt, IssueSource, StyledString, module::ModuleIssue},\n+    issue::{IssueExt, IssueSource, module::ModuleIssue},\n     module::Module,\n     node_addon_module::NodeAddonModule,\n     output::OutputAsset,\n@@ -70,7 +70,9 @@ use turbopack_static::{css::StaticUrlCssModule, ecma::StaticUrlJsModule};\n use turbopack_wasm::{module_asset::WebAssemblyModuleAsset, source::WebAssemblySource};\n \n use self::transition::{Transition, TransitionOptions};\n-use crate::module_options::{CssOptionsContext, CustomModuleType, EcmascriptOptionsContext};\n+use crate::module_options::{\n+    CssOptionsContext, CustomModuleType, EcmascriptOptionsContext, TypescriptTransformOptions,\n+};\n \n async fn apply_module_type(\n     source: ResolvedVc<Box<dyn Source>>,\n@@ -620,34 +622,32 @@ async fn process_default_internal(\n                                 options,\n                             }),\n                             Some(module_type) => {\n-                                ModuleIssue {\n-                                    ident,\n-                                    title: StyledString::Text(rcstr!(\"Invalid module type\"))\n-                                        .resolved_cell(),\n-                                    description: StyledString::Text(rcstr!(\n+                                ModuleIssue::new(\n+                                    *ident,\n+                                    rcstr!(\"Invalid module type\"),\n+                                    rcstr!(\n                                         \"The module type must be Ecmascript or Typescript to add \\\n                                          Ecmascript transforms\"\n-                                    ))\n-                                    .resolved_cell(),\n-                                    source: Some(IssueSource::from_source_only(current_source)),\n-                                }\n-                                .resolved_cell()\n+                                    ),\n+                                    Some(IssueSource::from_source_only(current_source)),\n+                                )\n+                                .to_resolved()\n+                                .await?\n                                 .emit();\n                                 Some(module_type)\n                             }\n                             None => {\n-                                ModuleIssue {\n-                                    ident,\n-                                    title: StyledString::Text(rcstr!(\"Missing module type\"))\n-                                        .resolved_cell(),\n-                                    description: StyledString::Text(rcstr!(\n+                                ModuleIssue::new(\n+                                    *ident,\n+                                    rcstr!(\"Missing module type\"),\n+                                    rcstr!(\n                                         \"The module type effect must be applied before adding \\\n                                          Ecmascript transforms\"\n-                                    ))\n-                                    .resolved_cell(),\n-                                    source: Some(IssueSource::from_source_only(current_source)),\n-                                }\n-                                .resolved_cell()\n+                                    ),\n+                                    Some(IssueSource::from_source_only(current_source)),\n+                                )\n+                                .to_resolved()\n+                                .await?\n                                 .emit();\n                                 None\n                             }\n@@ -703,6 +703,9 @@ pub async fn externals_tracing_module_context(\n         // are actually representative of what Turbopack does.\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n+                enable_typescript_transform: Some(\n+                    TypescriptTransformOptions::default().resolved_cell(),\n+                ),\n                 // enable_types should not be enabled here. It gets set automatically when a TS file\n                 // is encountered.\n                 source_maps: SourceMapsType::None,"
        },
        {
            "sha": "33ead8a94471ed67f679c922d868278e6fc6ee8f",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 100,
            "deletions": 100,
            "changes": 200,
            "blob_url": "https://github.com/vercel/next.js/blob/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=6779a5c07e70b34ccb9cfb1c94fa3f8a7a5711f4",
            "patch": "@@ -255,7 +255,6 @@ impl ModuleOptions {\n             RuleCondition::ReferenceType(ReferenceType::Css(CssReferenceSubType::Analyze)),\n         ]);\n \n-        let mut ts_preprocess = vec![];\n         let mut ecma_preprocess = vec![];\n         let mut postprocess = vec![];\n \n@@ -291,15 +290,6 @@ impl ModuleOptions {\n             postprocess.push(EcmascriptInputTransform::PresetEnv(environment));\n         }\n \n-        let ts_transform = if let Some(options) = enable_typescript_transform {\n-            let options = options.await?;\n-            Some(EcmascriptInputTransform::TypeScript {\n-                use_define_for_class_fields: options.use_define_for_class_fields,\n-            })\n-        } else {\n-            None\n-        };\n-\n         let decorators_transform = if let Some(options) = &enable_decorators {\n             let options = options.await?;\n             options\n@@ -315,13 +305,6 @@ impl ModuleOptions {\n             None\n         };\n \n-        if let Some(ts_transform) = &ts_transform {\n-            if let Some(decorators_transform) = &decorators_transform {\n-                ts_preprocess.splice(0..0, [decorators_transform.clone(), ts_transform.clone()]);\n-            } else {\n-                ts_preprocess.splice(0..0, [ts_transform.clone()]);\n-            }\n-        }\n         if let Some(decorators_transform) = &decorators_transform {\n             // Apply decorators transform for the ModuleType::Ecmascript as well after\n             // constructing ts_app_transforms. Ecmascript can have decorators for\n@@ -334,7 +317,6 @@ impl ModuleOptions {\n             ecma_preprocess.splice(0..0, [decorators_transform.clone()]);\n         }\n \n-        let ts_preprocess = ResolvedVc::cell(ts_preprocess);\n         let ecma_preprocess = ResolvedVc::cell(ecma_preprocess);\n         let main = ResolvedVc::<EcmascriptInputTransforms>::cell(vec![]);\n         let postprocess = ResolvedVc::cell(postprocess);\n@@ -388,88 +370,6 @@ impl ModuleOptions {\n                     .resolved_cell(),\n                 })],\n             ),\n-            ModuleRule::new_all(\n-                RuleCondition::ResourcePathEndsWith(\".ts\".to_string()),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    preprocess: ts_preprocess,\n-                    main,\n-                    postprocess,\n-                    tsx: false,\n-                    analyze_types: enable_types,\n-                    options: ecmascript_options_vc,\n-                })],\n-            ),\n-            ModuleRule::new_all(\n-                RuleCondition::ResourcePathEndsWith(\".tsx\".to_string()),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    preprocess: ts_preprocess,\n-                    main,\n-                    postprocess,\n-                    tsx: true,\n-                    analyze_types: enable_types,\n-                    options: ecmascript_options_vc,\n-                })],\n-            ),\n-            ModuleRule::new_all(\n-                RuleCondition::ResourcePathEndsWith(\".mts\".to_string()),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    preprocess: ts_preprocess,\n-                    main,\n-                    postprocess,\n-                    tsx: false,\n-                    analyze_types: enable_types,\n-                    options: EcmascriptOptions {\n-                        specified_module_type: SpecifiedModuleType::EcmaScript,\n-                        ..ecmascript_options\n-                    }\n-                    .resolved_cell(),\n-                })],\n-            ),\n-            ModuleRule::new_all(\n-                RuleCondition::ResourcePathEndsWith(\".mtsx\".to_string()),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    preprocess: ts_preprocess,\n-                    main,\n-                    postprocess,\n-                    tsx: true,\n-                    analyze_types: enable_types,\n-                    options: EcmascriptOptions {\n-                        specified_module_type: SpecifiedModuleType::EcmaScript,\n-                        ..ecmascript_options\n-                    }\n-                    .resolved_cell(),\n-                })],\n-            ),\n-            ModuleRule::new_all(\n-                RuleCondition::ResourcePathEndsWith(\".cts\".to_string()),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    preprocess: ts_preprocess,\n-                    main,\n-                    postprocess,\n-                    tsx: false,\n-                    analyze_types: enable_types,\n-                    options: EcmascriptOptions {\n-                        specified_module_type: SpecifiedModuleType::CommonJs,\n-                        ..ecmascript_options\n-                    }\n-                    .resolved_cell(),\n-                })],\n-            ),\n-            ModuleRule::new_all(\n-                RuleCondition::ResourcePathEndsWith(\".ctsx\".to_string()),\n-                vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n-                    preprocess: ts_preprocess,\n-                    main,\n-                    postprocess,\n-                    tsx: true,\n-                    analyze_types: enable_types,\n-                    options: EcmascriptOptions {\n-                        specified_module_type: SpecifiedModuleType::CommonJs,\n-                        ..ecmascript_options\n-                    }\n-                    .resolved_cell(),\n-                })],\n-            ),\n             ModuleRule::new(\n                 RuleCondition::ResourcePathEndsWith(\".d.ts\".to_string()),\n                 vec![ModuleRuleEffect::ModuleType(\n@@ -544,6 +444,106 @@ impl ModuleOptions {\n             ),\n         ];\n \n+        if let Some(options) = enable_typescript_transform {\n+            let ts_preprocess = ResolvedVc::cell(\n+                decorators_transform\n+                    .clone()\n+                    .into_iter()\n+                    .chain(std::iter::once(EcmascriptInputTransform::TypeScript {\n+                        use_define_for_class_fields: options.await?.use_define_for_class_fields,\n+                    }))\n+                    .collect(),\n+            );\n+\n+            rules.splice(\n+                0..0,\n+                [\n+                    ModuleRule::new_all(\n+                        RuleCondition::ResourcePathEndsWith(\".ts\".to_string()),\n+                        vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n+                            preprocess: ts_preprocess,\n+                            main,\n+                            postprocess,\n+                            tsx: false,\n+                            analyze_types: enable_types,\n+                            options: ecmascript_options_vc,\n+                        })],\n+                    ),\n+                    ModuleRule::new_all(\n+                        RuleCondition::ResourcePathEndsWith(\".tsx\".to_string()),\n+                        vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n+                            preprocess: ts_preprocess,\n+                            main,\n+                            postprocess,\n+                            tsx: true,\n+                            analyze_types: enable_types,\n+                            options: ecmascript_options_vc,\n+                        })],\n+                    ),\n+                    ModuleRule::new_all(\n+                        RuleCondition::ResourcePathEndsWith(\".mts\".to_string()),\n+                        vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n+                            preprocess: ts_preprocess,\n+                            main,\n+                            postprocess,\n+                            tsx: false,\n+                            analyze_types: enable_types,\n+                            options: EcmascriptOptions {\n+                                specified_module_type: SpecifiedModuleType::EcmaScript,\n+                                ..ecmascript_options\n+                            }\n+                            .resolved_cell(),\n+                        })],\n+                    ),\n+                    ModuleRule::new_all(\n+                        RuleCondition::ResourcePathEndsWith(\".mtsx\".to_string()),\n+                        vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n+                            preprocess: ts_preprocess,\n+                            main,\n+                            postprocess,\n+                            tsx: true,\n+                            analyze_types: enable_types,\n+                            options: EcmascriptOptions {\n+                                specified_module_type: SpecifiedModuleType::EcmaScript,\n+                                ..ecmascript_options\n+                            }\n+                            .resolved_cell(),\n+                        })],\n+                    ),\n+                    ModuleRule::new_all(\n+                        RuleCondition::ResourcePathEndsWith(\".cts\".to_string()),\n+                        vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n+                            preprocess: ts_preprocess,\n+                            main,\n+                            postprocess,\n+                            tsx: false,\n+                            analyze_types: enable_types,\n+                            options: EcmascriptOptions {\n+                                specified_module_type: SpecifiedModuleType::CommonJs,\n+                                ..ecmascript_options\n+                            }\n+                            .resolved_cell(),\n+                        })],\n+                    ),\n+                    ModuleRule::new_all(\n+                        RuleCondition::ResourcePathEndsWith(\".ctsx\".to_string()),\n+                        vec![ModuleRuleEffect::ModuleType(ModuleType::Typescript {\n+                            preprocess: ts_preprocess,\n+                            main,\n+                            postprocess,\n+                            tsx: true,\n+                            analyze_types: enable_types,\n+                            options: EcmascriptOptions {\n+                                specified_module_type: SpecifiedModuleType::CommonJs,\n+                                ..ecmascript_options\n+                            }\n+                            .resolved_cell(),\n+                        })],\n+                    ),\n+                ],\n+            );\n+        }\n+\n         if let Some(webpack_loaders_options) = enable_webpack_loaders {\n             let webpack_loaders_options = webpack_loaders_options.await?;\n             let execution_context ="
        }
    ],
    "stats": {
        "total": 556,
        "additions": 324,
        "deletions": 232
    }
}