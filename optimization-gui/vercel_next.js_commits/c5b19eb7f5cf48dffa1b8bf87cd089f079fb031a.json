{
    "author": "feedthejim",
    "message": "test: reduce flakiness in opentelemetry test for prod mode (#88102)\n\n## Summary\n\nReduces flakiness in the OpenTelemetry e2e test\n(`test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts`) for\nproduction mode.\n\n### Root Cause\nIn production mode, Next.js generates additional spans from:\n- RSC prefetch requests (with `?_rsc` query param)\n- Edge runtime boundary spans\n\nThese extra root spans cause `toMatchObject` assertions to fail because\nthey receive more spans than expected.\n\n### Changes\n\n1. **Filter spans by expected `http.target`** in `expectTrace()`:\n   - Extract expected `http.target` values from the match object\n   - Filter root spans to only include those with matching targets\n- This excludes RSC prefetch and edge boundary spans that aren't part of\nthe test assertion\n\n2. **Fix TestExporter callback bug** in `instrumentation-test.ts`:\n   - The success callback was called unconditionally (even after errors)\n   - Added early `return` after error callback\n   - Moved success callback inside the success path\n\n## Test Plan\n- [x] All 34 tests pass in production mode (`NEXT_TEST_MODE=start`)\n- [ ] CI passes",
    "sha": "c5b19eb7f5cf48dffa1b8bf87cd089f079fb031a",
    "files": [
        {
            "sha": "ed6c721e2572ad10c6035bac3f900348c2f18830",
            "filename": "test/e2e/opentelemetry/instrumentation/instrumentation-test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c5b19eb7f5cf48dffa1b8bf87cd089f079fb031a/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Finstrumentation-test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5b19eb7f5cf48dffa1b8bf87cd089f079fb031a/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Finstrumentation-test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Finstrumentation-test.ts?ref=c5b19eb7f5cf48dffa1b8bf87cd089f079fb031a",
            "patch": "@@ -71,13 +71,13 @@ class TestExporter implements SpanExporter {\n           code: ExportResultCode.FAILED,\n           error: new Error(`http status ${response.status}`),\n         })\n+        return\n       }\n+      resultCallback({ code: ExportResultCode.SUCCESS })\n     } catch (e) {\n-      console.warn('WARN: TestExporterP: error:', e)\n+      console.warn('WARN: TestExporter: error:', e)\n       resultCallback({ code: ExportResultCode.FAILED, error: e })\n     }\n-\n-    resultCallback({ code: ExportResultCode.SUCCESS })\n   }\n   shutdown(): Promise<void> {\n     return Promise.resolve()"
        },
        {
            "sha": "014a5175b69fe8ce25999e6a25df4d1705171e49",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/c5b19eb7f5cf48dffa1b8bf87cd089f079fb031a/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5b19eb7f5cf48dffa1b8bf87cd089f079fb031a/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=c5b19eb7f5cf48dffa1b8bf87cd089f079fb031a",
            "patch": "@@ -1426,6 +1426,14 @@ async function expectTrace(\n   match: SpanMatch[],\n   edgeOnly?: boolean\n ) {\n+  // Extract expected http.target values from the match to filter out extra spans\n+  // that may be generated in production mode (e.g., RSC prefetch requests)\n+  const expectedTargets = new Set(\n+    match\n+      .map((m) => m.attributes?.['http.target'] as string | undefined)\n+      .filter(Boolean)\n+  )\n+\n   await check(async () => {\n     const traces = collector.getSpans()\n \n@@ -1481,15 +1489,27 @@ async function expectTrace(\n       })\n     }\n \n-    tree.sort((a, b) => {\n+    // Filter root spans to only those matching expected http.target values\n+    // This prevents flakiness from extra spans in prod mode (RSC prefetch, etc.)\n+    const filteredTree =\n+      expectedTargets.size > 0\n+        ? tree.filter((span) => {\n+            const target = span.attributes?.['http.target'] as\n+              | string\n+              | undefined\n+            return target && expectedTargets.has(target)\n+          })\n+        : tree\n+\n+    filteredTree.sort((a, b) => {\n       const runtimeDiff = (a.runtime ?? '').localeCompare(b.runtime ?? '')\n       if (runtimeDiff !== 0) {\n         return runtimeDiff\n       }\n       return a.name.localeCompare(b.name)\n     })\n \n-    expect(tree).toMatchObject(match)\n+    expect(filteredTree).toMatchObject(match)\n     return 'success'\n   }, 'success')\n }"
        }
    ],
    "stats": {
        "total": 30,
        "additions": 25,
        "deletions": 5
    }
}