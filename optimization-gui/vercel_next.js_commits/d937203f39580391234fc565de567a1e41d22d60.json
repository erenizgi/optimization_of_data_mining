{
    "author": "ijjk",
    "message": "Implement initial handler interface for pages routes (#79260)\n\nContinuation of https://github.com/vercel/next.js/pull/78166 this\nimplements the `handler` interface for pages routes, This does not move\nthe response handling inside of the handler yet as that will be in a\nfollow-up PR to keep the changes isolated. This still returns the\n`RenderResult` for the `base-server` to continue to handle.\n\nValidated against `vercel/vercel` deploy tests here\nhttps://github.com/vercel/vercel/pull/13349",
    "sha": "d937203f39580391234fc565de567a1e41d22d60",
    "files": [
        {
            "sha": "c993aee9d7f82d7dc6ea0d799a6d62333a21dcd3",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -678,11 +678,17 @@\n   \"677\": \"`trackDynamicImport` should always receive a promise. Something went wrong in the dynamic imports transform.\",\n   \"678\": \"CacheSignal got more endRead() calls than beginRead() calls\",\n   \"679\": \"A CacheSignal cannot subscribe to itself\",\n-  \"680\": \"CacheSignal cannot be used in the edge runtime, because `dynamicIO` does not support it.\",\n-  \"681\": \"Dynamic imports should not be instrumented in the edge runtime, because `dynamicIO` doesn't support it\",\n-  \"682\": \"\\\\`experimental.ppr\\\\` can not be \\\\`%s\\\\` when \\\\`experimental.dynamicIO\\\\` is \\\\`true\\\\`. PPR is implicitly enabled when Dynamic IO is enabled.\",\n-  \"683\": \"The \\\\`compiler.define\\\\` option is configured to replace the \\\\`%s\\\\` variable. This variable is either part of a Next.js built-in or is already configured.\",\n-  \"684\": \"The \\\\`compiler.defineServer\\\\` option is configured to replace the \\\\`%s\\\\` variable. This variable is either part of a Next.js built-in or is already configured.\",\n-  \"685\": \"Accessed fallback \\\\`params\\\\` during prerendering.\",\n-  \"686\": \"Expected clientReferenceManifest to be defined.\"\n+  \"680\": \"Invariant: missing result from invoking %s\",\n+  \"681\": \"Invariant: missing result from invoking %s handler\",\n+  \"682\": \"Invariant: missing result\",\n+  \"683\": \"Invariant: missing result from \",\n+  \"684\": \"Invariant: missing result from ino\",\n+  \"685\": \"CacheSignal cannot be used in the edge runtime, because `dynamicIO` does not support it.\",\n+  \"686\": \"\\\\`experimental.ppr\\\\` can not be \\\\`%s\\\\` when \\\\`experimental.dynamicIO\\\\` is \\\\`true\\\\`. PPR is implicitly enabled when Dynamic IO is enabled.\",\n+  \"687\": \"Dynamic imports should not be instrumented in the edge runtime, because `dynamicIO` doesn't support it\",\n+  \"688\": \"The \\\\`compiler.define\\\\` option is configured to replace the \\\\`%s\\\\` variable. This variable is either part of a Next.js built-in or is already configured.\",\n+  \"689\": \"The \\\\`compiler.defineServer\\\\` option is configured to replace the \\\\`%s\\\\` variable. This variable is either part of a Next.js built-in or is already configured.\",\n+  \"690\": \"Invariant: loadManifests called for edge runtime\",\n+  \"691\": \"Accessed fallback \\\\`params\\\\` during prerendering.\",\n+  \"692\": \"Expected clientReferenceManifest to be defined.\"\n }"
        },
        {
            "sha": "bafd191ee9f145d20e91d97672e5abf2e5288b63",
            "filename": "packages/next/src/build/define-env.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -1,5 +1,6 @@\n import type { I18NDomains, NextConfigComplete } from '../server/config-shared'\n import type { MiddlewareMatcher } from './analysis/get-page-static-info'\n+import path from 'node:path'\n import { needsExperimentalReact } from '../lib/needs-experimental-react'\n import { checkIsAppPPREnabled } from '../server/lib/experimental/ppr'\n import {\n@@ -20,6 +21,7 @@ export interface DefineEnvOptions {\n   config: NextConfigComplete\n   dev: boolean\n   distDir: string\n+  projectPath: string\n   fetchCacheKeyPrefix: string | undefined\n   hasRewrites: boolean\n   isClient: boolean\n@@ -89,6 +91,7 @@ export function getDefineEnv({\n   config,\n   dev,\n   distDir,\n+  projectPath,\n   fetchCacheKeyPrefix,\n   hasRewrites,\n   isClient,\n@@ -275,6 +278,10 @@ export function getDefineEnv({\n     ...(isNodeServer\n       ? {\n           'process.env.__NEXT_RELATIVE_DIST_DIR': config.distDir,\n+          'process.env.__NEXT_RELATIVE_PROJECT_DIR': path.relative(\n+            process.cwd(),\n+            projectPath\n+          ),\n         }\n       : {}),\n     'process.env.__NEXT_DEVTOOL_SEGMENT_EXPLORER':"
        },
        {
            "sha": "0b6d5bff3a59da0e2f2eddb84cc6feea0540f1b0",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -551,7 +551,7 @@ async function writeFunctionsConfigManifest(\n   )\n }\n \n-interface RequiredServerFilesManifest {\n+export interface RequiredServerFilesManifest {\n   version: number\n   config: NextConfigComplete\n   appDir: string\n@@ -2262,8 +2262,6 @@ export default async function build(\n                 ...config.experimental,\n                 cacheHandlers: normalizedCacheHandlers,\n                 trustHostHeader: ciEnvironment.hasNextSupport,\n-\n-                // @ts-expect-error internal field TODO: fix this, should use a separate mechanism to pass the info.\n                 isExperimentalCompile: isCompileMode,\n               },\n             },\n@@ -2322,6 +2320,7 @@ export default async function build(\n               BUILD_ID_FILE,\n               path.join(SERVER_DIRECTORY, NEXT_FONT_MANIFEST + '.js'),\n               path.join(SERVER_DIRECTORY, NEXT_FONT_MANIFEST + '.json'),\n+              SERVER_FILES_MANIFEST,\n               ...instrumentationHookEntryFiles,\n             ]\n               .filter(nonNullable)"
        },
        {
            "sha": "2ee89263b6de2fc1ad568e50ed237681e1d447b8",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -386,6 +386,7 @@ export function createDefineEnv({\n   config,\n   dev,\n   distDir,\n+  projectPath,\n   fetchCacheKeyPrefix,\n   hasRewrites,\n   middlewareMatchers,\n@@ -407,6 +408,7 @@ export function createDefineEnv({\n         config,\n         dev,\n         distDir,\n+        projectPath,\n         fetchCacheKeyPrefix,\n         hasRewrites,\n         isClient: variant === 'client',"
        },
        {
            "sha": "86fc6e66d5e2ac26c3ff3729bed050fbf7899283",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -49,4 +49,5 @@ export const routeModule = new AppPageRouteModule({\n     loaderTree: tree,\n   },\n   distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n+  projectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n })"
        },
        {
            "sha": "b6c467bbe388f70494509ebc566a7c25944fc523",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -25,6 +25,7 @@ const routeModule = new AppRouteRouteModule({\n     bundlePath: 'VAR_DEFINITION_BUNDLE_PATH',\n   },\n   distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n+  projectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n   resolvedPagePath: 'VAR_RESOLVED_PAGE_PATH',\n   nextConfigOutput,\n   userland,"
        },
        {
            "sha": "400ba434ae358bddd69376ce2e243ca7de7c5ea5",
            "filename": "packages/next/src/build/templates/pages-api.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 4,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -12,6 +12,7 @@ import { hoist } from './helpers'\n import * as userland from 'VAR_USERLAND'\n import { getTracer, SpanKind } from '../../server/lib/trace/tracer'\n import { BaseServerSpan } from '../../server/lib/trace/constants'\n+import type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\n \n // Re-export the handler (should be the default export).\n export default hoist(userland, 'default')\n@@ -31,6 +32,7 @@ const routeModule = new PagesAPIRouteModule({\n   },\n   userland,\n   distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n+  projectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n })\n \n export async function handler(\n@@ -44,11 +46,12 @@ export async function handler(\n \n   // turbopack doesn't normalize `/index` in the page name\n   // so we need to to process dynamic routes properly\n+  // TODO: fix turbopack providing differing value from webpack\n   if (process.env.TURBOPACK) {\n-    srcPage = srcPage.replace(/\\/index$/, '')\n+    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n   }\n \n-  const prepareResult = await routeModule.prepare(req, srcPage)\n+  const prepareResult = await routeModule.prepare(req, res, { srcPage })\n \n   if (!prepareResult) {\n     res.statusCode = 400\n@@ -64,11 +67,16 @@ export async function handler(\n     const tracer = getTracer()\n \n     const activeSpan = tracer.getActiveScopeSpan()\n+    const onRequestError =\n+      routeModule.instrumentationOnRequestError.bind(routeModule)\n \n     const invokeRouteModule = async (span?: Span) =>\n       routeModule\n         .render(req, res, {\n-          query,\n+          query: {\n+            ...query,\n+            ...params,\n+          },\n           params,\n           allowedRevalidateHeaderKeys: process.env\n             .__NEXT_ALLOWED_REVALIDATE_HEADERS as any as string[],\n@@ -81,8 +89,10 @@ export async function handler(\n           propagateError: false,\n           dev: routeModule.isDev,\n           page: 'VAR_DEFINITION_PAGE',\n+          projectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n \n-          onError: routeModule.instrumentationOnRequestError.bind(routeModule),\n+          onError: (...args: Parameters<InstrumentationOnRequestError>) =>\n+            onRequestError(req, ...args),\n         })\n         .finally(() => {\n           if (!span) return"
        },
        {
            "sha": "9b8221ed6714f92babe683d0c609aeccdb3a8713",
            "filename": "packages/next/src/build/templates/pages.ts",
            "status": "modified",
            "additions": 319,
            "deletions": 0,
            "changes": 319,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -1,5 +1,19 @@\n+import type { IncomingMessage, ServerResponse } from 'node:http'\n+import type RenderResult from '../../server/render-result'\n+import type { ParsedUrlQuery } from 'node:querystring'\n import { PagesRouteModule } from '../../server/route-modules/pages/module.compiled'\n import { RouteKind } from '../../server/route-kind'\n+import { BaseServerSpan } from '../../server/lib/trace/constants'\n+import { getTracer, SpanKind, type Span } from '../../server/lib/trace/tracer'\n+import { formatUrl } from '../../shared/lib/router/utils/format-url'\n+import {\n+  RouterServerContextSymbol,\n+  routerServerGlobal,\n+} from '../../server/lib/router-utils/router-server-context'\n+import { getRequestMeta } from '../../server/request-meta'\n+import { interopDefault } from '../../server/app-render/interop-default'\n+import { getRevalidateReason } from '../../server/instrumentation/utils'\n+import { normalizeDataPath } from '../../shared/lib/page-path/normalize-data-path'\n import { hoist } from './helpers'\n \n // Import the app and document modules.\n@@ -52,10 +66,315 @@ export const routeModule = new PagesRouteModule({\n     filename: '',\n   },\n   distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n+  projectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n   components: {\n     // default export might not exist when optimized for data only\n     App: app.default,\n     Document: document.default,\n   },\n   userland,\n })\n+\n+export async function handler(\n+  req: IncomingMessage,\n+  res: ServerResponse,\n+  ctx: {\n+    waitUntil: (prom: Promise<void>) => void\n+  }\n+): Promise<RenderResult | null> {\n+  let srcPage = 'VAR_DEFINITION_PAGE'\n+\n+  // turbopack doesn't normalize `/index` in the page name\n+  // so we need to to process dynamic routes properly\n+  // TODO: fix turbopack providing differing value from webpack\n+  if (process.env.TURBOPACK) {\n+    srcPage = srcPage.replace(/\\/index$/, '') || '/'\n+  } else if (srcPage === '/index') {\n+    // we always normalize /index specifically\n+    srcPage = '/'\n+  }\n+  const multiZoneDraftMode = process.env\n+    .__NEXT_MULTI_ZONE_DRAFT_MODE as any as boolean\n+\n+  const prepareResult = await routeModule.prepare(req, res, {\n+    srcPage,\n+    multiZoneDraftMode,\n+  })\n+\n+  if (!prepareResult) {\n+    res.statusCode = 400\n+    res.end('Bad Request')\n+    ctx.waitUntil?.(Promise.resolve())\n+    return null\n+  }\n+\n+  const {\n+    buildId,\n+    query,\n+    params,\n+    parsedUrl,\n+    originalQuery,\n+    originalPathname,\n+    buildManifest,\n+    nextFontManifest,\n+    isNextDataRequest,\n+    serverFilesManifest,\n+    reactLoadableManifest,\n+    prerenderManifest,\n+    isDraftMode,\n+    isOnDemandRevalidate,\n+    locale,\n+    locales,\n+    defaultLocale,\n+  } = prepareResult\n+\n+  const routerServerContext =\n+    routerServerGlobal[RouterServerContextSymbol]?.[\n+      process.env.__NEXT_RELATIVE_PROJECT_DIR || ''\n+    ]\n+\n+  const onError = routeModule.instrumentationOnRequestError.bind(routeModule)\n+  const nextConfig =\n+    routerServerContext?.nextConfig || serverFilesManifest.config\n+\n+  const isExperimentalCompile =\n+    serverFilesManifest?.config?.experimental?.isExperimentalCompile\n+\n+  const isIsrFallback = Boolean(getRequestMeta(req, 'isIsrFallback'))\n+  const hasServerProps = Boolean(getServerSideProps)\n+  const hasStaticProps = Boolean(getStaticProps)\n+  const hasGetInitialProps = Boolean(\n+    (userland.default || userland).getInitialProps\n+  )\n+\n+  try {\n+    const method = req.method || 'GET'\n+    const tracer = getTracer()\n+\n+    const activeSpan = tracer.getActiveScopeSpan()\n+    const resolvedUrl = formatUrl({\n+      pathname: parsedUrl.pathname,\n+      // make sure to only add query values from original URL\n+      query: hasStaticProps ? {} : originalQuery,\n+    })\n+\n+    const publicRuntimeConfig: Record<string, string> =\n+      routerServerContext?.publicRuntimeConfig || nextConfig.publicRuntimeConfig\n+\n+    let ErrorDebug: any\n+\n+    if (process.env.NODE_ENV === 'development') {\n+      ErrorDebug = (props: any) => {\n+        const ReactDevOverlayImpl =\n+          require('next/dist/client/components/react-dev-overlay/pages/pages-dev-overlay').PagesDevOverlay\n+        return ReactDevOverlayImpl(props)\n+      }\n+    }\n+\n+    const invokeRouteModule = async (span?: Span) =>\n+      routeModule\n+        .render(req, res, {\n+          query:\n+            hasStaticProps && !isExperimentalCompile\n+              ? ({\n+                  ...params,\n+                  ...(query.amp && config.amp\n+                    ? {\n+                        amp: query.amp as string,\n+                      }\n+                    : {}),\n+                } as ParsedUrlQuery)\n+              : {\n+                  ...query,\n+                  ...params,\n+                },\n+          params,\n+          page: srcPage,\n+          renderContext: {\n+            isDraftMode,\n+            isFallback: isIsrFallback,\n+            developmentNotFoundSourcePage: getRequestMeta(\n+              req,\n+              'developmentNotFoundSourcePage'\n+            ),\n+          },\n+          sharedContext: {\n+            buildId,\n+            customServer:\n+              Boolean(routerServerContext?.isCustomServer) || undefined,\n+            deploymentId: process.env.NEXT_DEPLOYMENT_ID,\n+          },\n+          renderOpts: {\n+            params,\n+            routeModule,\n+            page: srcPage,\n+            pageConfig: config || {},\n+            Component: interopDefault(userland),\n+            ComponentMod: userland,\n+            getStaticProps,\n+            getStaticPaths,\n+            getServerSideProps,\n+            supportsDynamicResponse: !hasStaticProps,\n+            buildManifest,\n+            nextFontManifest,\n+            reactLoadableManifest,\n+\n+            assetPrefix: nextConfig.assetPrefix,\n+            strictNextHead: Boolean(nextConfig.experimental.strictNextHead),\n+            previewProps: prerenderManifest.preview,\n+            images: nextConfig.images as any,\n+            nextConfigOutput: nextConfig.output,\n+            optimizeCss: Boolean(nextConfig.experimental.optimizeCss),\n+            nextScriptWorkers: Boolean(\n+              nextConfig.experimental.nextScriptWorkers\n+            ),\n+            domainLocales: nextConfig.i18n?.domains,\n+            crossOrigin: nextConfig.crossOrigin,\n+\n+            multiZoneDraftMode,\n+            basePath: nextConfig.basePath,\n+            canonicalBase: nextConfig.amp.canonicalBase || '',\n+            ampOptimizerConfig: nextConfig.experimental.amp?.optimizer,\n+            disableOptimizedLoading:\n+              nextConfig.experimental.disableOptimizedLoading,\n+            largePageDataBytes: nextConfig.experimental.largePageDataBytes,\n+            // Only the `publicRuntimeConfig` key is exposed to the client side\n+            // It'll be rendered as part of __NEXT_DATA__ on the client side\n+            runtimeConfig:\n+              Object.keys(publicRuntimeConfig).length > 0\n+                ? publicRuntimeConfig\n+                : undefined,\n+\n+            isExperimentalCompile,\n+\n+            experimental: {\n+              clientTraceMetadata:\n+                nextConfig.experimental.clientTraceMetadata || ([] as any),\n+            },\n+\n+            locale,\n+            locales,\n+            defaultLocale,\n+\n+            isNextDataRequest:\n+              isNextDataRequest && (hasServerProps || hasStaticProps),\n+\n+            resolvedUrl,\n+            // For getServerSideProps and getInitialProps we need to ensure we use the original URL\n+            // and not the resolved URL to prevent a hydration mismatch on\n+            // asPath\n+            resolvedAsPath:\n+              hasServerProps || hasGetInitialProps\n+                ? formatUrl({\n+                    // we use the original URL pathname less the _next/data prefix if\n+                    // present\n+                    pathname: isNextDataRequest\n+                      ? normalizeDataPath(originalPathname)\n+                      : originalPathname,\n+                    query: originalQuery,\n+                  })\n+                : resolvedUrl,\n+\n+            isOnDemandRevalidate,\n+\n+            ErrorDebug,\n+            err: getRequestMeta(req, 'invokeError'),\n+            dev: routeModule.isDev,\n+\n+            // needed for experimental.optimizeCss feature\n+            distDir: `${routeModule.projectDir}/${routeModule.distDir}`,\n+\n+            ampSkipValidation: nextConfig.experimental.amp?.skipValidation,\n+            ampValidator: getRequestMeta(req, 'ampValidator'),\n+          },\n+        })\n+        .finally(() => {\n+          if (!span) return\n+\n+          span.setAttributes({\n+            'http.status_code': res.statusCode,\n+            'next.rsc': false,\n+          })\n+\n+          const rootSpanAttributes = tracer.getRootSpanAttributes()\n+          // We were unable to get attributes, probably OTEL is not enabled\n+          if (!rootSpanAttributes) {\n+            return\n+          }\n+\n+          if (\n+            rootSpanAttributes.get('next.span_type') !==\n+            BaseServerSpan.handleRequest\n+          ) {\n+            console.warn(\n+              `Unexpected root span type '${rootSpanAttributes.get(\n+                'next.span_type'\n+              )}'. Please report this Next.js issue https://github.com/vercel/next.js`\n+            )\n+            return\n+          }\n+\n+          const route = rootSpanAttributes.get('next.route')\n+          if (route) {\n+            const name = `${method} ${route}`\n+\n+            span.setAttributes({\n+              'next.route': route,\n+              'http.route': route,\n+              'next.span_name': name,\n+            })\n+            span.updateName(name)\n+          } else {\n+            span.updateName(`${method} ${req.url}`)\n+          }\n+        })\n+\n+    // TODO: activeSpan code path is for when wrapped by\n+    // next-server can be removed when this is no longer used\n+    if (activeSpan) {\n+      return await invokeRouteModule(activeSpan)\n+    } else {\n+      return await tracer.withPropagatedContext(req.headers, () =>\n+        tracer.trace(\n+          BaseServerSpan.handleRequest,\n+          {\n+            spanName: `${method} ${req.url}`,\n+            kind: SpanKind.SERVER,\n+            attributes: {\n+              'http.method': method,\n+              'http.target': req.url,\n+            },\n+          },\n+          invokeRouteModule\n+        )\n+      )\n+    }\n+  } catch (err) {\n+    await onError(\n+      req,\n+      err,\n+      {\n+        path: req.url || '/',\n+        headers: req.headers,\n+        method: req.method || 'GET',\n+      },\n+      {\n+        routerKind: 'Pages Router',\n+        routePath: srcPage,\n+        routeType: 'render',\n+        revalidateReason: getRevalidateReason({\n+          isRevalidate: hasStaticProps,\n+          isOnDemandRevalidate,\n+        }),\n+      }\n+    )\n+\n+    // rethrow so that we can handle serving error page\n+    throw err\n+  } finally {\n+    // We don't allow any waitUntil work in pages API routes currently\n+    // so if callback is present return with resolved promise since no\n+    // pending work\n+    ctx.waitUntil?.(Promise.resolve())\n+  }\n+}"
        },
        {
            "sha": "712014c0bc0a57d52ec5c4ea0339eeb38853ad90",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -70,6 +70,7 @@ export async function turbopackBuild(): Promise<{\n         config,\n         dev,\n         distDir,\n+        projectPath: dir,\n         fetchCacheKeyPrefix: config.experimental.fetchCacheKeyPrefix,\n         hasRewrites,\n         // Implemented separately in Turbopack, doesn't have to be passed here."
        },
        {
            "sha": "8e9854f306502da87e0283b0187e94556f718c97",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -1950,6 +1950,7 @@ export default async function getBaseWebpackConfig(\n           config,\n           dev,\n           distDir,\n+          projectPath: dir,\n           fetchCacheKeyPrefix,\n           hasRewrites,\n           isClient,"
        },
        {
            "sha": "707fd1e87e7e14a09067ac23bea900206fb99aa8",
            "filename": "packages/next/src/build/webpack/loaders/next-edge-ssr-loader/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -55,8 +55,9 @@ function getRouteModuleOptions(page: string) {\n       bundlePath: '',\n       filename: '',\n     },\n-    // edge runtime doesn't read from distDir\n+    // edge runtime doesn't read from distDir or projectDir\n     distDir: '',\n+    projectDir: '',\n   }\n \n   return options"
        },
        {
            "sha": "6f5d331c0a128c4a375ffb9060085c0eff3c16fa",
            "filename": "packages/next/src/server/api-utils/node/api-resolver.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapi-utils%2Fnode%2Fapi-resolver.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -41,6 +41,7 @@ type ApiContext = __ApiPreviewProps & {\n   hostname?: string\n   multiZoneDraftMode?: boolean\n   dev: boolean\n+  projectDir: string\n }\n \n function getMaxContentLength(responseLimit?: ResponseLimit) {\n@@ -286,7 +287,8 @@ async function revalidate(\n   }\n \n   const internalRevalidate =\n-    routerServerGlobal[RouterServerContextSymbol]?.revalidate\n+    routerServerGlobal[RouterServerContextSymbol]?.[context.projectDir]\n+      ?.revalidate\n \n   try {\n     // We use the revalidate in router-server if available."
        },
        {
            "sha": "374878818b4d858a868b6b24bd5e44ba78d89ef5",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 88,
            "deletions": 44,
            "changes": 132,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -596,7 +596,6 @@ export default abstract class Server<\n           ? publicRuntimeConfig\n           : undefined,\n \n-      // @ts-expect-error internal field not publicly exposed\n       isExperimentalCompile: this.nextConfig.experimental.isExperimentalCompile,\n       // `htmlLimitedBots` is passed to server as serialized config in string format\n       htmlLimitedBots: this.nextConfig.htmlLimitedBots,\n@@ -2733,55 +2732,101 @@ export default abstract class Server<\n           }\n \n           if (isPagesRouteModule(routeModule)) {\n-            // Due to the way we pass data by mutating `renderOpts`, we can't extend\n-            // the object here but only updating its `clientReferenceManifest` and\n-            // `nextFontManifest` properties.\n-            // https://github.com/vercel/next.js/blob/df7cbd904c3bd85f399d1ce90680c0ecf92d2752/packages/next/server/render.tsx#L947-L952\n-            renderOpts.nextFontManifest = this.nextFontManifest\n-            renderOpts.clientReferenceManifest =\n-              components.clientReferenceManifest\n-\n             const request = isNodeNextRequest(req) ? req.originalRequest : req\n+\n             const response = isNodeNextResponse(res)\n               ? res.originalResponse\n               : res\n \n-            // Call the built-in render method on the module.\n-            try {\n-              result = await routeModule.render(\n-                request as any,\n-                response as any,\n-                {\n-                  page: pathname,\n-                  params: opts.params,\n-                  query,\n-                  renderOpts,\n-                  sharedContext: {\n-                    buildId: this.buildId,\n-                    deploymentId: this.nextConfig.deploymentId,\n-                    customServer: this.serverOptions.customServer || undefined,\n-                  },\n-                  renderContext: {\n-                    isFallback: pagesFallback,\n-                    isDraftMode: renderOpts.isDraftMode,\n-                    developmentNotFoundSourcePage: getRequestMeta(\n-                      req,\n-                      'developmentNotFoundSourcePage'\n-                    ),\n-                  },\n-                }\n+            if (\n+              components.ComponentMod.handler &&\n+              process.env.NEXT_RUNTIME !== 'edge'\n+            ) {\n+              const parsedInitUrl = parseUrl(\n+                getRequestMeta(req, 'initURL') || req.url\n               )\n-            } catch (err) {\n-              await this.instrumentationOnRequestError(err, req, {\n-                routerKind: 'Pages Router',\n-                routePath: pathname,\n-                routeType: 'render',\n-                revalidateReason: getRevalidateReason({\n-                  isRevalidate: isSSG,\n-                  isOnDemandRevalidate: renderOpts.isOnDemandRevalidate,\n-                }),\n+              request.url =\n+                req.url = `${parsedInitUrl.pathname}${parsedInitUrl.search || ''}`\n+\n+              // propagate the request context for dev\n+              setRequestMeta(request, getRequestMeta(req))\n+              addRequestMeta(request, 'projectDir', this.dir)\n+              addRequestMeta(request, 'isIsrFallback', pagesFallback)\n+              addRequestMeta(request, 'query', query)\n+              addRequestMeta(request, 'params', opts.params)\n+              addRequestMeta(\n+                request,\n+                'ampValidator',\n+                this.renderOpts.ampValidator\n+              )\n+\n+              if (renderOpts.err) {\n+                addRequestMeta(request, 'invokeError', renderOpts.err)\n+              }\n+              const handler: (\n+                req: ServerRequest | IncomingMessage,\n+                res: ServerResponse | HTTPServerResponse,\n+                ctx: {\n+                  waitUntil: ReturnType<Server['getWaitUntil']>\n+                }\n+              ) => Promise<RenderResult> = components.ComponentMod.handler\n+\n+              result = await handler(request, response, {\n+                waitUntil: this.getWaitUntil(),\n               })\n-              throw err\n+\n+              if (!result) {\n+                throw new Error(\n+                  `Invariant: missing result from invoking ${pathname} handler`\n+                )\n+              }\n+            } else {\n+              // Due to the way we pass data by mutating `renderOpts`, we can't extend\n+              // the object here but only updating its `clientReferenceManifest` and\n+              // `nextFontManifest` properties.\n+              // https://github.com/vercel/next.js/blob/df7cbd904c3bd85f399d1ce90680c0ecf92d2752/packages/next/server/render.tsx#L947-L952\n+              renderOpts.nextFontManifest = this.nextFontManifest\n+              renderOpts.clientReferenceManifest =\n+                components.clientReferenceManifest\n+\n+              // Call the built-in render method on the module.\n+              try {\n+                result = await routeModule.render(\n+                  request as any,\n+                  response as any,\n+                  {\n+                    page: pathname,\n+                    params: opts.params,\n+                    query,\n+                    renderOpts,\n+                    sharedContext: {\n+                      buildId: this.buildId,\n+                      deploymentId: this.nextConfig.deploymentId,\n+                      customServer:\n+                        this.serverOptions.customServer || undefined,\n+                    },\n+                    renderContext: {\n+                      isFallback: pagesFallback,\n+                      isDraftMode: renderOpts.isDraftMode,\n+                      developmentNotFoundSourcePage: getRequestMeta(\n+                        req,\n+                        'developmentNotFoundSourcePage'\n+                      ),\n+                    },\n+                  }\n+                )\n+              } catch (err) {\n+                await this.instrumentationOnRequestError(err, req, {\n+                  routerKind: 'Pages Router',\n+                  routePath: pathname,\n+                  routeType: 'render',\n+                  revalidateReason: getRevalidateReason({\n+                    isRevalidate: isSSG,\n+                    isOnDemandRevalidate: renderOpts.isOnDemandRevalidate,\n+                  }),\n+                })\n+                throw err\n+              }\n             }\n           } else {\n             const module = components.routeModule as AppPageRouteModule\n@@ -3018,7 +3063,6 @@ export default abstract class Server<\n       // When experimental compile is used, no pages have been prerendered,\n       // so they should all be blocking.\n \n-      // @ts-expect-error internal field\n       if (this.nextConfig.experimental.isExperimentalCompile) {\n         fallbackMode = FallbackMode.BLOCKING_STATIC_RENDER\n       }"
        },
        {
            "sha": "466748a33e82b24c4f862720638760b82debbe47",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -574,6 +574,10 @@ export interface ExperimentalConfig {\n    * @internal Used by the Next.js internals only.\n    */\n   trustHostHeader?: boolean\n+  /**\n+   * @internal Used by the Next.js internals only.\n+   */\n+  isExperimentalCompile?: boolean\n \n   useWasmBinary?: boolean\n "
        },
        {
            "sha": "529f65b9c1f4b8f5c36e52a440fe67b0bfa86560",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -227,6 +227,7 @@ export async function createHotReloaderTurbopack(\n         config: nextConfig,\n         dev,\n         distDir,\n+        projectPath,\n         fetchCacheKeyPrefix: opts.nextConfig.experimental.fetchCacheKeyPrefix,\n         hasRewrites,\n         // TODO: Implement"
        },
        {
            "sha": "6a5d7957dffdb38ef5c0cd987dfc1cc82fa1666c",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 9,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -24,10 +24,7 @@ import fs from 'fs'\n import { Worker } from 'next/dist/compiled/jest-worker'\n import { join as pathJoin } from 'path'\n import { ampValidation } from '../../build/output'\n-import {\n-  INSTRUMENTATION_HOOK_FILENAME,\n-  PUBLIC_DIR_MIDDLEWARE_CONFLICT,\n-} from '../../lib/constants'\n+import { PUBLIC_DIR_MIDDLEWARE_CONFLICT } from '../../lib/constants'\n import { findPagesDir } from '../../lib/find-pages-dir'\n import {\n   PHASE_DEVELOPMENT_SERVER,\n@@ -70,6 +67,10 @@ import type { ServerComponentsHmrCache } from '../response-cache'\n import { logRequests } from './log-requests'\n import { FallbackMode } from '../../lib/fallback'\n import type { PagesDevOverlayType } from '../../client/components/react-dev-overlay/pages/pages-dev-overlay'\n+import {\n+  ensureInstrumentationRegistered,\n+  getInstrumentationModule,\n+} from '../lib/router-utils/instrumentation-globals.external'\n \n // Load ReactDevOverlay only when needed\n let ReactDevOverlayImpl: PagesDevOverlayType\n@@ -689,8 +690,9 @@ export default class DevServer extends Server {\n         .catch(() => false))\n     ) {\n       try {\n-        instrumentationModule = await require(\n-          pathJoin(this.distDir, 'server', INSTRUMENTATION_HOOK_FILENAME)\n+        instrumentationModule = await getInstrumentationModule(\n+          this.dir,\n+          this.nextConfig.distDir\n         )\n       } catch (err: any) {\n         err.message = `An error occurred while loading instrumentation hook: ${err.message}`\n@@ -701,9 +703,7 @@ export default class DevServer extends Server {\n   }\n \n   protected async runInstrumentationHookIfAvailable() {\n-    await this.startServerSpan\n-      .traceChild('run-instrumentation-hook')\n-      .traceAsyncFn(() => this.instrumentation?.register?.())\n+    await ensureInstrumentationRegistered(this.dir, this.nextConfig.distDir)\n   }\n \n   protected async ensureEdgeFunction({"
        },
        {
            "sha": "435024801be70538bbc2b53eacedbc9eaa4d9473",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -667,8 +667,13 @@ export async function initialize(opts: {\n \n   // this must come after initialize of render server since it's\n   // using initialized methods\n-  routerServerGlobal[RouterServerContextSymbol] = {\n-    dir: opts.dir,\n+  if (!routerServerGlobal[RouterServerContextSymbol]) {\n+    routerServerGlobal[RouterServerContextSymbol] = {}\n+  }\n+  const relativeProjectDir = path.relative(process.cwd(), opts.dir)\n+\n+  routerServerGlobal[RouterServerContextSymbol][relativeProjectDir] = {\n+    nextConfig: config,\n     hostname: handlers.server.hostname,\n     revalidate: handlers.server.revalidate.bind(handlers.server),\n   }"
        },
        {
            "sha": "ad32f11f9bdf5970be9ef13a1980a3f7b70fed14",
            "filename": "packages/next/src/server/lib/router-utils/instrumentation-globals.external.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Finstrumentation-globals.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Finstrumentation-globals.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Finstrumentation-globals.external.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -13,7 +13,7 @@ export async function getInstrumentationModule(\n   projectDir: string,\n   distDir: string\n ): Promise<InstrumentationModule | undefined> {\n-  if (cachedInstrumentationModule && process.env.NODE_ENV === 'production') {\n+  if (cachedInstrumentationModule) {\n     return cachedInstrumentationModule\n   }\n \n@@ -42,9 +42,12 @@ export async function getInstrumentationModule(\n }\n \n let instrumentationModulePromise: Promise<any> | null = null\n+\n async function registerInstrumentation(projectDir: string, distDir: string) {\n   // Ensure registerInstrumentation is not called in production build\n-  if (process.env.NEXT_PHASE === 'phase-production-build') return\n+  if (process.env.NEXT_PHASE === 'phase-production-build') {\n+    return\n+  }\n   if (!instrumentationModulePromise) {\n     instrumentationModulePromise = getInstrumentationModule(projectDir, distDir)\n   }"
        },
        {
            "sha": "f12b924fabaf4b3a3230d359dfeb4ee990c1c0e3",
            "filename": "packages/next/src/server/lib/router-utils/router-server-context.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 9,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -1,3 +1,5 @@\n+import type { NextConfigComplete } from '../../config-shared'\n+\n export type RevalidateFn = (config: {\n   urlPath: string\n   revalidateHeaders: { [key: string]: string | string[] }\n@@ -6,15 +8,25 @@ export type RevalidateFn = (config: {\n \n // The RouterServerContext contains instance specific\n // information that isn't available/relevant when\n-// deployed in serverless environments\n-export interface RouterServerContext {\n-  dir?: string\n-  // hostname the server is started with\n-  hostname?: string\n-  // revalidate function to bypass going through network\n-  // to invoke revalidate request (uses mocked req/res)\n-  revalidate?: RevalidateFn\n-}\n+// deployed in serverless environments, the key is\n+// the relative project dir this allows separate contexts\n+// when running multiple next instances in same process\n+export type RouterServerContext = Record<\n+  string,\n+  {\n+    // hostname the server is started with\n+    hostname?: string\n+    // revalidate function to bypass going through network\n+    // to invoke revalidate request (uses mocked req/res)\n+    revalidate?: RevalidateFn\n+    // current loaded public runtime config\n+    publicRuntimeConfig?: NextConfigComplete['publicRuntimeConfig']\n+    // exposing nextConfig for dev mode specifically\n+    nextConfig?: NextConfigComplete\n+    // whether running in custom server mode\n+    isCustomServer?: boolean\n+  }\n+>\n \n export const RouterServerContextSymbol = Symbol.for(\n   '@next/router-server-methods'"
        },
        {
            "sha": "13619ed1fe166ed41d2d0db776571b74f99d36e4",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -666,6 +666,7 @@ async function startWatcher(opts: SetupOpts) {\n               hasRewrites,\n               // TODO: Implement\n               middlewareMatchers: undefined,\n+              projectPath: opts.dir,\n             }),\n           })\n         }\n@@ -740,6 +741,7 @@ async function startWatcher(opts: SetupOpts) {\n                   isEdgeServer,\n                   isNodeServer,\n                   middlewareMatchers: undefined,\n+                  projectPath: opts.dir,\n                 })\n \n                 Object.keys(plugin.definitions).forEach((key) => {"
        },
        {
            "sha": "9e607259d8e62043ba4da6fbfc9ac59fbe4f8d0c",
            "filename": "packages/next/src/server/load-manifest.external.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 20,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fload-manifest.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fload-manifest.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fload-manifest.external.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -25,30 +25,35 @@ export function loadManifest<T extends object>(\n export function loadManifest<T extends object>(\n   path: string,\n   shouldCache?: boolean,\n-  cache?: Map<string, unknown>\n+  cache?: Map<string, unknown>,\n+  skipParse?: boolean\n ): DeepReadonly<T>\n export function loadManifest<T extends object>(\n   path: string,\n   shouldCache?: true,\n-  cache?: Map<string, unknown>\n+  cache?: Map<string, unknown>,\n+  skipParse?: boolean\n ): DeepReadonly<T>\n export function loadManifest<T extends object>(\n   path: string,\n   shouldCache: boolean = true,\n-  cache = sharedCache\n+  cache = sharedCache,\n+  skipParse = false\n ): T {\n   const cached = shouldCache && cache.get(path)\n   if (cached) {\n     return cached as T\n   }\n \n-  let manifest = JSON.parse(\n-    readFileSync(/* turbopackIgnore: true */ path, 'utf8')\n-  )\n+  let manifest: any = readFileSync(/* turbopackIgnore: true */ path, 'utf8')\n \n-  // Freeze the manifest so it cannot be modified if we're caching it.\n-  if (shouldCache) {\n-    manifest = deepFreeze(manifest)\n+  if (!skipParse) {\n+    manifest = JSON.parse(manifest)\n+\n+    // Freeze the manifest so it cannot be modified if we're caching it.\n+    if (shouldCache) {\n+      manifest = deepFreeze(manifest)\n+    }\n   }\n \n   if (shouldCache) {\n@@ -102,18 +107,37 @@ export function evalManifest<T extends object>(\n   return contextObject as T\n }\n \n-export function loadManifestFromRelativePath<T extends object>(\n-  projectDir: string,\n-  distDir: string,\n-  manifest: string,\n-  shouldCache = true,\n+export function loadManifestFromRelativePath<T extends object>({\n+  projectDir,\n+  distDir,\n+  manifest,\n+  shouldCache,\n+  cache,\n+  skipParse,\n+  handleMissing,\n+}: {\n+  projectDir: string\n+  distDir: string\n+  manifest: string\n+  shouldCache?: boolean\n   cache?: Map<string, unknown>\n-): DeepReadonly<T> {\n-  return loadManifest<T>(\n-    join(/* turbopackIgnore: true */ projectDir, distDir, manifest),\n-    shouldCache,\n-    cache\n-  )\n+  skipParse?: boolean\n+  handleMissing?: boolean\n+}): DeepReadonly<T> {\n+  try {\n+    return loadManifest<T>(\n+      join(/* turbopackIgnore: true */ projectDir, distDir, manifest),\n+      shouldCache,\n+      cache,\n+      skipParse\n+    )\n+  } catch (err) {\n+    if (handleMissing) {\n+      // TODO: should this be undefined\n+      return {} as DeepReadonly<T>\n+    }\n+    throw err\n+  }\n }\n \n export function clearManifestCache(path: string, cache = sharedCache): boolean {"
        },
        {
            "sha": "287e1e51529ac1f2359218072afff548bd324cbd",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 17,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -25,7 +25,7 @@ import type { CacheControl } from './lib/cache-control'\n import type { WaitUntil } from './after/builtin-request-context'\n \n import fs from 'fs'\n-import { join, resolve } from 'path'\n+import { join } from 'path'\n import { getRouteMatcher } from '../shared/lib/router/utils/route-matcher'\n import { addRequestMeta, getRequestMeta } from './request-meta'\n import {\n@@ -85,7 +85,6 @@ import { setHttpClientAndAgentOptions } from './setup-http-agent-env'\n import { isPagesAPIRouteMatch } from './route-matches/pages-api-route-match'\n import type { PagesAPIRouteMatch } from './route-matches/pages-api-route-match'\n import type { MatchOptions } from './route-matcher-managers/route-matcher-manager'\n-import { INSTRUMENTATION_HOOK_FILENAME } from '../lib/constants'\n import { BubbledError, getTracer } from './lib/trace/tracer'\n import { NextNodeServerSpan } from './lib/trace/constants'\n import { nodeFs } from './lib/node-fs-methods'\n@@ -111,6 +110,10 @@ import type { UnwrapPromise } from '../lib/coalesced-function'\n import { populateStaticEnv } from '../lib/static-env'\n import { isPostpone } from './lib/router-utils/is-postpone'\n import { NodeModuleLoader } from './lib/module-loader/node-module-loader'\n+import {\n+  ensureInstrumentationRegistered,\n+  getInstrumentationModule,\n+} from './lib/router-utils/instrumentation-globals.external'\n \n export * from './base-server'\n \n@@ -122,11 +125,6 @@ const dynamicImportEsmDefault = process.env.NEXT_MINIMAL\n       import(/* webpackIgnore: true */ id).then((mod) => mod.default || mod)\n   : (id: string) => import(id).then((mod) => mod.default || mod)\n \n-// For module that will be compiled to CJS, e.g. instrument\n-const dynamicRequire = process.env.NEXT_MINIMAL\n-  ? __non_webpack_require__\n-  : require\n-\n export type NodeRequestHandler = BaseRequestHandler<\n   IncomingMessage | NodeNextRequest,\n   ServerResponse | NodeNextResponse\n@@ -429,13 +427,9 @@ export default class NextNodeServer extends BaseServer<\n   protected async loadInstrumentationModule() {\n     if (!this.serverOptions.dev) {\n       try {\n-        this.instrumentation = await dynamicRequire(\n-          resolve(\n-            this.serverOptions.dir || '.',\n-            this.serverOptions.conf.distDir!,\n-            'server',\n-            INSTRUMENTATION_HOOK_FILENAME\n-          )\n+        this.instrumentation = await getInstrumentationModule(\n+          this.dir,\n+          this.nextConfig.distDir\n         )\n       } catch (err: any) {\n         if (err.code !== 'MODULE_NOT_FOUND') {\n@@ -455,9 +449,7 @@ export default class NextNodeServer extends BaseServer<\n   }\n \n   protected async runInstrumentationHookIfAvailable() {\n-    if (this.registeredInstrumentation) return\n-    this.registeredInstrumentation = true\n-    await this.instrumentation?.register?.()\n+    await ensureInstrumentationRegistered(this.dir, this.nextConfig.distDir)\n   }\n \n   protected loadEnvConfig({\n@@ -672,6 +664,7 @@ export default class NextNodeServer extends BaseServer<\n         }\n       ) => Promise<void>\n     }\n+    addRequestMeta(req.originalRequest, 'projectDir', this.dir)\n     await module.handler(req.originalRequest, res.originalResponse, {\n       waitUntil: this.getWaitUntil(),\n     })"
        },
        {
            "sha": "f7d6b13b11b7b419930c0ab139da65d7f2159e77",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -27,6 +27,10 @@ import { formatUrl } from '../shared/lib/router/utils/format-url'\n import type { ServerFields } from './lib/router-utils/setup-dev-bundler'\n import type { ServerInitResult } from './lib/render-server'\n import { AsyncCallbackSet } from './lib/async-callback-set'\n+import {\n+  RouterServerContextSymbol,\n+  routerServerGlobal,\n+} from './lib/router-utils/router-server-context'\n \n let ServerImpl: typeof NextNodeServer\n \n@@ -246,7 +250,6 @@ export class NextServer implements NextWrapperServer {\n           path.join(dir, config.distDir, SERVER_FILES_MANIFEST)\n         ).config\n \n-        // @ts-expect-error internal field\n         config.experimental.isExperimentalCompile =\n           serializedConfig.experimental.isExperimentalCompile\n       } catch (_) {\n@@ -423,6 +426,22 @@ class NextCustomServer implements NextWrapperServer {\n \n   setAssetPrefix(assetPrefix: string): void {\n     this.server.setAssetPrefix(assetPrefix)\n+\n+    // update the router-server nextConfig instance as\n+    // this is the source of truth for \"handler\" in serverful\n+    const relativeProjectDir = path.relative(\n+      process.cwd(),\n+      this.options.dir || ''\n+    )\n+\n+    if (\n+      routerServerGlobal[RouterServerContextSymbol]?.[relativeProjectDir]\n+        ?.nextConfig\n+    ) {\n+      routerServerGlobal[RouterServerContextSymbol][\n+        relativeProjectDir\n+      ].nextConfig.assetPrefix = assetPrefix\n+    }\n   }\n \n   getUpgradeHandler(): UpgradeHandler {"
        },
        {
            "sha": "50d6f3852c03e5199197f47dacebdb5210e9d1ab",
            "filename": "packages/next/src/server/request-meta.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -183,6 +183,31 @@ export interface RequestMeta {\n    * The default locale that was inferred or explicitly set for the request.\n    */\n   defaultLocale?: string\n+\n+  /**\n+   * The project dir the server is running in\n+   */\n+  projectDir?: string\n+\n+  /**\n+   * Whether we are generating the fallback version of the page in dev mode\n+   */\n+  isIsrFallback?: boolean\n+\n+  /**\n+   * The query after resolving routes\n+   */\n+  query?: ParsedUrlQuery\n+\n+  /**\n+   * The params after resolving routes\n+   */\n+  params?: ParsedUrlQuery\n+\n+  /**\n+   * The AMP validator to use in development\n+   */\n+  ampValidator?: (html: string, pathname: string) => Promise<void>\n }\n \n /**"
        },
        {
            "sha": "4a0935ed4c2423ca252218de3877501d9724de3a",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -216,10 +216,11 @@ export class AppRouteRouteModule extends RouteModule<\n     userland,\n     definition,\n     distDir,\n+    projectDir,\n     resolvedPagePath,\n     nextConfigOutput,\n   }: AppRouteRouteModuleOptions) {\n-    super({ userland, definition, distDir })\n+    super({ userland, definition, distDir, projectDir })\n \n     this.resolvedPagePath = resolvedPagePath\n     this.nextConfigOutput = nextConfigOutput"
        },
        {
            "sha": "0257510be7be892fc09b75c040ff88a4c0091eff",
            "filename": "packages/next/src/server/route-modules/pages-api/module.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages-api%2Fmodule.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -92,6 +92,11 @@ type PagesAPIRouteHandlerContext = RouteModuleHandleContext & {\n    * whether multi-zone flag is enabled for draft mode\n    */\n   multiZoneDraftMode?: boolean\n+\n+  /**\n+   * The relative project directory\n+   */\n+  projectDir: string\n }\n \n export type PagesAPIRouteModuleOptions = RouteModuleOptions<\n@@ -144,6 +149,7 @@ export class PagesAPIRouteModule extends RouteModule<\n         hostname: context.hostname,\n         multiZoneDraftMode: context.multiZoneDraftMode,\n         dev: context.dev,\n+        projectDir: context.projectDir,\n       },\n       context.propagateError,\n       context.dev,"
        },
        {
            "sha": "006f10bf12743152e2db11b9487c78f7821ae385",
            "filename": "packages/next/src/server/route-modules/pages/builtin/_error.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fbuiltin%2F_error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fbuiltin%2F_error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fbuiltin%2F_error.tsx?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -16,6 +16,7 @@ export const routeModule = new PagesRouteModule({\n     bundlePath: '',\n   },\n   distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n+  projectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n   components: {\n     App,\n     Document,"
        },
        {
            "sha": "ece9dcb2c3873caaca2bb63895716306ae6975a7",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 273,
            "deletions": 75,
            "changes": 348,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -1,27 +1,43 @@\n-import type { IncomingMessage } from 'node:http'\n+import type { IncomingMessage, ServerResponse } from 'node:http'\n import type { InstrumentationOnRequestError } from '../instrumentation/types'\n import type { ParsedUrlQuery } from 'node:querystring'\n import type { UrlWithParsedQuery } from 'node:url'\n-import type { PrerenderManifest } from '../../build'\n+import type {\n+  PrerenderManifest,\n+  RequiredServerFilesManifest,\n+} from '../../build'\n import type { DevRoutesManifest } from '../lib/router-utils/setup-dev-bundler'\n import type { RouteDefinition } from '../route-definitions/route-definition'\n import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n \n-import { PRERENDER_MANIFEST, ROUTES_MANIFEST } from '../../shared/lib/constants'\n+import {\n+  BUILD_ID_FILE,\n+  BUILD_MANIFEST,\n+  NEXT_FONT_MANIFEST,\n+  PRERENDER_MANIFEST,\n+  REACT_LOADABLE_MANIFEST,\n+  ROUTES_MANIFEST,\n+  SERVER_FILES_MANIFEST,\n+} from '../../shared/lib/constants'\n import { parseReqUrl } from '../../lib/url'\n import {\n   normalizeLocalePath,\n   type PathLocale,\n } from '../../shared/lib/i18n/normalize-locale-path'\n import { isDynamicRoute } from '../../shared/lib/router/utils'\n import { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\n-import {\n-  RouterServerContextSymbol,\n-  routerServerGlobal,\n-} from '../lib/router-utils/router-server-context'\n import { getServerUtils } from '../server-utils'\n import { detectDomainLocale } from '../../shared/lib/i18n/detect-domain-locale'\n import { getHostname } from '../../shared/lib/get-hostname'\n+import { checkIsOnDemandRevalidate } from '../api-utils'\n+import type { PreviewData } from '../../types'\n+import type { BuildManifest } from '../get-page-files'\n+import type { ReactLoadableManifest } from '../load-components'\n+import type { NextFontManifest } from '../../build/webpack/plugins/next-font-manifest-plugin'\n+import { normalizeDataPath } from '../../shared/lib/page-path/normalize-data-path'\n+import { pathHasPrefix } from '../../shared/lib/router/utils/path-has-prefix'\n+import { addRequestMeta, getRequestMeta } from '../request-meta'\n+import { normalizePagePath } from '../../shared/lib/page-path/normalize-page-path'\n \n /**\n  * RouteModuleOptions is the options that are passed to the route module, other\n@@ -35,6 +51,7 @@ export interface RouteModuleOptions<\n   readonly definition: Readonly<D>\n   readonly userland: Readonly<U>\n   readonly distDir: string\n+  readonly projectDir: string\n }\n \n /**\n@@ -77,108 +94,206 @@ export abstract class RouteModule<\n   public distDir: string\n   public projectDir: string\n \n-  constructor({ userland, definition, distDir }: RouteModuleOptions<D, U>) {\n+  constructor({\n+    userland,\n+    definition,\n+    distDir,\n+    projectDir,\n+  }: RouteModuleOptions<D, U>) {\n     this.userland = userland\n     this.definition = definition\n     this.isDev = process.env.NODE_ENV === 'development'\n     this.distDir = distDir\n-\n-    if (process.env.NEXT_RUNTIME === 'edge') {\n-      this.projectDir = ''\n-    } else {\n-      this.projectDir =\n-        routerServerGlobal[RouterServerContextSymbol]?.dir || process.cwd()\n-    }\n+    this.projectDir = projectDir\n   }\n \n   public async instrumentationOnRequestError(\n+    req: IncomingMessage,\n     ...args: Parameters<InstrumentationOnRequestError>\n   ) {\n     // this is only handled here for node, for edge it\n     // is handled in the adapter/loader instead\n     if (process.env.NEXT_RUNTIME !== 'edge') {\n+      const { join } = require('node:path')\n+      const projectDir =\n+        getRequestMeta(req, 'projectDir') ||\n+        join(process.cwd(), this.projectDir)\n+\n       const { instrumentationOnRequestError } = await import(\n         '../lib/router-utils/instrumentation-globals.external'\n       )\n \n-      return instrumentationOnRequestError(\n-        this.projectDir,\n-        this.distDir,\n-        ...args\n+      return instrumentationOnRequestError(projectDir, this.distDir, ...args)\n+    }\n+  }\n+\n+  private async loadManifests(projectDir: string, srcPage: string) {\n+    if (process.env.NEXT_RUNTIME !== 'edge') {\n+      const { loadManifestFromRelativePath } = await import(\n+        '../load-manifest.external'\n       )\n+      const normalizedPagePath = normalizePagePath(srcPage)\n+\n+      const [\n+        routesManifest,\n+        prerenderManifest,\n+        buildManifest,\n+        reactLoadableManifest,\n+        nextFontManifest,\n+        serverFilesManifest,\n+        buildId,\n+      ] = await Promise.all([\n+        loadManifestFromRelativePath<DevRoutesManifest>({\n+          projectDir,\n+          distDir: this.distDir,\n+          manifest: ROUTES_MANIFEST,\n+        }),\n+        loadManifestFromRelativePath<PrerenderManifest>({\n+          projectDir,\n+          distDir: this.distDir,\n+          manifest: PRERENDER_MANIFEST,\n+        }),\n+        loadManifestFromRelativePath<BuildManifest>({\n+          projectDir,\n+          distDir: this.distDir,\n+          manifest: BUILD_MANIFEST,\n+        }),\n+        loadManifestFromRelativePath<ReactLoadableManifest>({\n+          projectDir,\n+          distDir: this.distDir,\n+          manifest: process.env.TURBOPACK\n+            ? `server/pages${normalizedPagePath}/${REACT_LOADABLE_MANIFEST}`\n+            : REACT_LOADABLE_MANIFEST,\n+          handleMissing: true,\n+        }),\n+        loadManifestFromRelativePath<NextFontManifest>({\n+          projectDir,\n+          distDir: this.distDir,\n+          manifest: `server/${NEXT_FONT_MANIFEST}.json`,\n+        }),\n+        this.isDev\n+          ? ({} as any)\n+          : loadManifestFromRelativePath<RequiredServerFilesManifest>({\n+              projectDir,\n+              distDir: this.distDir,\n+              manifest: SERVER_FILES_MANIFEST,\n+            }),\n+        this.isDev\n+          ? 'development'\n+          : loadManifestFromRelativePath<any>({\n+              projectDir,\n+              distDir: this.distDir,\n+              manifest: BUILD_ID_FILE,\n+              skipParse: true,\n+            }),\n+      ])\n+\n+      return {\n+        buildId,\n+        buildManifest,\n+        routesManifest,\n+        nextFontManifest,\n+        prerenderManifest,\n+        serverFilesManifest,\n+        reactLoadableManifest,\n+      }\n     }\n+    throw new Error('Invariant: loadManifests called for edge runtime')\n   }\n \n   public async prepare(\n     req: IncomingMessage,\n-    srcPage: string\n+    res: ServerResponse,\n+    {\n+      srcPage,\n+      multiZoneDraftMode,\n+    }: {\n+      srcPage: string\n+      multiZoneDraftMode?: boolean\n+    }\n   ): Promise<\n     | {\n+        buildId: string\n+        locale?: string\n+        locales?: readonly string[]\n+        defaultLocale?: string\n         query: ParsedUrlQuery\n-        params: ParsedUrlQuery\n+        originalQuery: ParsedUrlQuery\n+        originalPathname: string\n+        params?: ParsedUrlQuery\n         parsedUrl: UrlWithParsedQuery\n+        previewData: PreviewData\n+        isDraftMode: boolean\n+        isNextDataRequest: boolean\n+        buildManifest: DeepReadonly<BuildManifest>\n+        nextFontManifest: DeepReadonly<NextFontManifest>\n+        serverFilesManifest: DeepReadonly<RequiredServerFilesManifest>\n+        reactLoadableManifest: DeepReadonly<ReactLoadableManifest>\n         routesManifest: DeepReadonly<DevRoutesManifest>\n         prerenderManifest: DeepReadonly<PrerenderManifest>\n+        isOnDemandRevalidate: boolean\n+        revalidateOnlyGenerated: boolean\n       }\n     | undefined\n   > {\n     // \"prepare\" is only needed for node runtime currently\n     // if we want to share the normalizing logic here\n-    // we ill need to allow passing in the i18n and similar info\n+    // we will need to allow passing in the i18n and similar info\n     if (process.env.NEXT_RUNTIME !== 'edge') {\n-      const { loadManifestFromRelativePath } = await import(\n-        '../load-manifest.external'\n-      )\n+      const { join } = require('node:path')\n+      const projectDir =\n+        getRequestMeta(req, 'projectDir') ||\n+        join(process.cwd(), this.projectDir)\n+\n       const { ensureInstrumentationRegistered } = await import(\n         '../lib/router-utils/instrumentation-globals.external'\n       )\n+      // ensure instrumentation is registered and pass\n+      // onRequestError below\n+      ensureInstrumentationRegistered(projectDir, this.distDir)\n \n-      const [routesManifest, prerenderManifest] = await Promise.all([\n-        loadManifestFromRelativePath<DevRoutesManifest>(\n-          this.projectDir,\n-          this.distDir,\n-          ROUTES_MANIFEST\n-        ),\n-        loadManifestFromRelativePath<PrerenderManifest>(\n-          this.projectDir,\n-          this.distDir,\n-          PRERENDER_MANIFEST\n-        ),\n-        // ensure instrumentation is registered and pass\n-        // onRequestError below\n-        ensureInstrumentationRegistered(this.projectDir, this.distDir),\n-      ])\n-      // We need to parse dynamic route params\n-      // and do URL normalization here.\n-      // TODO: move this into server-utils for re-use\n+      const manifests = await this.loadManifests(projectDir, srcPage)\n+      const { routesManifest, prerenderManifest } = manifests\n       const { basePath, i18n, rewrites } = routesManifest\n \n       if (basePath) {\n         req.url = removePathPrefix(req.url || '/', basePath)\n       }\n \n-      let localeResult: PathLocale | undefined\n-\n-      if (i18n) {\n-        const urlParts = (req.url || '/').split('?')\n-        localeResult = normalizeLocalePath(urlParts[0] || '/', i18n.locales)\n-\n-        if (localeResult.detectedLocale) {\n-          req.url = `${localeResult.pathname}${\n-            urlParts[1] ? `?${urlParts[1]}` : ''\n-          }`\n-        }\n-      }\n-\n       const parsedUrl = parseReqUrl(req.url || '/')\n-\n       // if we couldn't parse the URL we can't continue\n       if (!parsedUrl) {\n         return\n       }\n+      let isNextDataRequest = false\n \n+      if (pathHasPrefix(parsedUrl.pathname || '/', '/_next/data')) {\n+        isNextDataRequest = true\n+        parsedUrl.pathname = normalizeDataPath(parsedUrl.pathname || '/')\n+      }\n+      let originalPathname = parsedUrl.pathname || '/'\n+      const originalQuery = { ...parsedUrl.query }\n       const pageIsDynamic = isDynamicRoute(srcPage)\n \n+      let localeResult: PathLocale | undefined\n+      let detectedLocale: string | undefined\n+\n+      if (i18n) {\n+        localeResult = normalizeLocalePath(\n+          parsedUrl.pathname || '/',\n+          i18n.locales\n+        )\n+\n+        if (localeResult.detectedLocale) {\n+          req.url = `${localeResult.pathname}${parsedUrl.search}`\n+          originalPathname = localeResult.pathname\n+\n+          if (!detectedLocale) {\n+            detectedLocale = localeResult.detectedLocale\n+          }\n+        }\n+      }\n+\n       const serverUtils = getServerUtils({\n         page: srcPage,\n         i18n,\n@@ -192,52 +307,135 @@ export abstract class RouteModule<\n       const domainLocale = detectDomainLocale(\n         i18n?.domains,\n         getHostname(parsedUrl, req.headers),\n-        localeResult?.detectedLocale\n+        detectedLocale\n       )\n+      addRequestMeta(req, 'isLocaleDomain', Boolean(domainLocale))\n \n       const defaultLocale = domainLocale?.defaultLocale || i18n?.defaultLocale\n \n       // Ensure parsedUrl.pathname includes locale before processing\n       // rewrites or they won't match correctly.\n-      if (defaultLocale && !localeResult?.detectedLocale) {\n+      if (defaultLocale && !detectedLocale) {\n         parsedUrl.pathname = `/${defaultLocale}${parsedUrl.pathname}`\n       }\n+      const locale =\n+        getRequestMeta(req, 'locale') || detectedLocale || defaultLocale\n \n       const rewriteParamKeys = Object.keys(\n         serverUtils.handleRewrites(req, parsedUrl)\n       )\n-      serverUtils.normalizeCdnUrl(req, [\n-        ...rewriteParamKeys,\n-        ...Object.keys(serverUtils.defaultRouteRegex?.groups || {}),\n-      ])\n \n-      const params: Record<string, undefined | string | string[]> =\n-        serverUtils.dynamicRouteMatcher\n-          ? serverUtils.dynamicRouteMatcher(\n-              localeResult?.pathname || parsedUrl.pathname || ''\n-            ) || {}\n-          : {}\n+      // after processing rewrites we want to remove locale\n+      // from parsedUrl pathname\n+      if (i18n) {\n+        parsedUrl.pathname = normalizeLocalePath(\n+          parsedUrl.pathname || '/',\n+          i18n.locales\n+        ).pathname\n+      }\n+\n+      let params: Record<string, undefined | string | string[]> | undefined =\n+        getRequestMeta(req, 'params')\n+\n+      // attempt parsing from pathname\n+      if (!params && serverUtils.dynamicRouteMatcher) {\n+        const paramsResult = serverUtils.dynamicRouteMatcher(\n+          normalizeDataPath(localeResult?.pathname || parsedUrl.pathname || '/')\n+        )\n+        if (paramsResult) {\n+          params = paramsResult\n+        }\n+      }\n+\n+      // Local \"next start\" expects the routing parsed query values\n+      // to not be present in the URL although when deployed proxies\n+      // will add query values from resolving the routes to pass to function.\n \n-      const query = {\n+      // TODO: do we want to change expectations for \"next start\"\n+      // to include these query values in the URL which affects asPath\n+      // but would match deployed behavior, e.g. a rewrite from middleware\n+      // that adds a query param would be in asPath as query but locally\n+      // it won't be in the asPath but still available in the query object\n+      const query = getRequestMeta(req, 'query') || {\n         ...parsedUrl.query,\n-        ...params,\n       }\n-      serverUtils.normalizeQueryParams(query)\n+\n+      const routeParamKeys = new Set<string>()\n+      const combinedParamKeys = [...rewriteParamKeys, ...routeParamKeys]\n+\n+      serverUtils.normalizeCdnUrl(req, combinedParamKeys)\n+      serverUtils.normalizeQueryParams(query, routeParamKeys)\n+      serverUtils.filterInternalQuery(originalQuery, combinedParamKeys)\n \n       if (pageIsDynamic) {\n         const result = serverUtils.normalizeDynamicRouteParams(query, true)\n \n+        req.url = serverUtils.interpolateDynamicPath(\n+          req.url || '/',\n+          params || query\n+        )\n+        parsedUrl.pathname = serverUtils.interpolateDynamicPath(\n+          parsedUrl.pathname || '/',\n+          params || query\n+        )\n+        originalPathname = serverUtils.interpolateDynamicPath(\n+          originalPathname,\n+          params || query\n+        )\n+\n+        // try pulling from query if valid\n         if (result.hasValidParams) {\n-          Object.assign(query, result.params)\n+          params = Object.assign({}, result.params, params)\n+\n+          // If we pulled from query remove it so it's\n+          // only in params\n+          for (const key in params) {\n+            delete query[key]\n+          }\n         }\n       }\n \n+      // Remove any normalized params from the query if they\n+      // weren't present as non-prefixed query key e.g.\n+      // ?search=1&nxtPsearch=hello we don't delete search\n+      for (const key of routeParamKeys) {\n+        if (!(key in originalQuery)) {\n+          delete query[key]\n+        }\n+      }\n+\n+      const { isOnDemandRevalidate, revalidateOnlyGenerated } =\n+        checkIsOnDemandRevalidate(req, prerenderManifest.preview)\n+\n+      let isDraftMode = false\n+      let previewData: PreviewData\n+\n+      const { tryGetPreviewData } =\n+        require('../api-utils/node/try-get-preview-data') as typeof import('../api-utils/node/try-get-preview-data')\n+\n+      previewData = tryGetPreviewData(\n+        req,\n+        res,\n+        prerenderManifest.preview,\n+        Boolean(multiZoneDraftMode)\n+      )\n+      isDraftMode = previewData !== false\n+\n       return {\n         query,\n+        originalQuery,\n+        originalPathname,\n         params,\n         parsedUrl,\n-        routesManifest,\n-        prerenderManifest,\n+        locale,\n+        isNextDataRequest,\n+        locales: i18n?.locales,\n+        defaultLocale,\n+        isDraftMode,\n+        previewData,\n+        isOnDemandRevalidate,\n+        revalidateOnlyGenerated,\n+        ...manifests,\n       }\n     }\n   }"
        },
        {
            "sha": "4e5f524f7ef37022497acb00818b2d7b5bdf91ad",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 15,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -32,23 +32,16 @@ import { isInterceptionRouteRewrite } from '../lib/generate-interception-routes-\n import { NEXT_ROUTER_STATE_TREE_HEADER } from '../client/components/app-router-headers'\n import { getSelectedParams } from '../client/components/router-reducer/compute-changed-path'\n \n-export function normalizeCdnUrl(\n-  req: BaseNextRequest | IncomingMessage,\n+function filterInternalQuery(\n+  query: Record<string, undefined | string | string[]>,\n   paramKeys: string[],\n   defaultRouteRegex: ReturnType<typeof getNamedRouteRegex> | undefined\n ) {\n-  // make sure to normalize req.url from CDNs to strip dynamic and rewrite\n-  // params from the query which are added during routing\n-  const _parsedUrl = parseReqUrl(req.url!)\n-\n-  // we can't normalize if we can't parse\n-  if (!_parsedUrl) {\n-    return req.url\n-  }\n-\n-  delete (_parsedUrl as any).search\n+  // this is used to pass query information in rewrites\n+  // but should not be exposed in final query\n+  delete query['nextInternalLocale']\n \n-  for (const key of Object.keys(_parsedUrl.query)) {\n+  for (const key in query) {\n     const isNextQueryPrefix =\n       key !== NEXT_QUERY_PARAM_PREFIX && key.startsWith(NEXT_QUERY_PARAM_PREFIX)\n \n@@ -62,9 +55,26 @@ export function normalizeCdnUrl(\n       paramKeys.includes(key) ||\n       (defaultRouteRegex && Object.keys(defaultRouteRegex.groups).includes(key))\n     ) {\n-      delete _parsedUrl.query[key]\n+      delete query[key]\n     }\n   }\n+}\n+\n+export function normalizeCdnUrl(\n+  req: BaseNextRequest | IncomingMessage,\n+  paramKeys: string[],\n+  defaultRouteRegex: ReturnType<typeof getNamedRouteRegex> | undefined\n+) {\n+  // make sure to normalize req.url from CDNs to strip dynamic and rewrite\n+  // params from the query which are added during routing\n+  const _parsedUrl = parseReqUrl(req.url!)\n+\n+  // we can't normalize if we can't parse\n+  if (!_parsedUrl) {\n+    return req.url\n+  }\n+  delete (_parsedUrl as any).search\n+  filterInternalQuery(_parsedUrl.query, paramKeys, defaultRouteRegex)\n \n   req.url = formatUrl(_parsedUrl)\n }\n@@ -415,7 +425,8 @@ export function getServerUtils({\n   }\n \n   function normalizeQueryParams(\n-    query: Record<string, string | string[] | undefined>\n+    query: Record<string, string | string[] | undefined>,\n+    routeParamKeys: Set<string>\n   ) {\n     // this is used to pass query information in rewrites\n     // but should not be exposed in final query\n@@ -428,6 +439,7 @@ export function getServerUtils({\n       // Remove the prefixed key from the query params because we want\n       // to consume it for the dynamic route matcher.\n       delete query[key]\n+      routeParamKeys.add(normalizedKey)\n \n       if (typeof value === 'undefined') continue\n \n@@ -466,14 +478,19 @@ export function getServerUtils({\n         ignoreMissingOptional\n       )\n     },\n+\n     normalizeCdnUrl: (\n       req: BaseNextRequest | IncomingMessage,\n       paramKeys: string[]\n     ) => normalizeCdnUrl(req, paramKeys, defaultRouteRegex),\n+\n     interpolateDynamicPath: (\n       pathname: string,\n       params: Record<string, undefined | string | string[]>\n     ) => interpolateDynamicPath(pathname, params, defaultRouteRegex),\n+\n+    filterInternalQuery: (query: ParsedUrlQuery, paramKeys: string[]) =>\n+      filterInternalQuery(query, paramKeys, defaultRouteRegex),\n   }\n }\n "
        },
        {
            "sha": "9b7cf7c9b4f4f30fe3cda994714cd72ef618496f",
            "filename": "packages/next/src/shared/lib/page-path/normalize-data-path.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fpage-path%2Fnormalize-data-path.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fpage-path%2Fnormalize-data-path.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fpage-path%2Fnormalize-data-path.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -0,0 +1,13 @@\n+/**\n+ * strip _next/data/<build-id>/ prefix and .json suffix\n+ */\n+export function normalizeDataPath(pathname: string) {\n+  pathname = pathname\n+    .replace(/\\/_next\\/data\\/[^/]{1,}/, '')\n+    .replace(/\\.json$/, '')\n+\n+  if (pathname === '/index') {\n+    return '/'\n+  }\n+  return pathname\n+}"
        },
        {
            "sha": "879cf7e9190cb0eb02e11f0d0a17a4542affa5e2",
            "filename": "test/development/acceptance/ReactRefreshLogBox-app-doc.test.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 36,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-app-doc.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-app-doc.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-app-doc.test.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -124,27 +124,26 @@ describe('ReactRefreshLogBox _app _document', () => {\n          \"label\": \"Build Error\",\n          \"source\": \"./pages/_app.js\n           Module build failed:\n-            \n-                 x Expression expected\n-                  ,-[<FIXME-project-root>/pages/_app.js:2:1]\n-                1 | function MyApp({ Component, pageProps }) {\n-                2 |   return <<Component {...pageProps} />;\n-                  :           ^\n-                3 | }\n-                4 | export default MyApp\n-                  \\`----\n-              \n-                 x Expression expected\n-                  ,-[<FIXME-project-root>/pages/_app.js:2:1]\n-                1 | function MyApp({ Component, pageProps }) {\n-                2 |   return <<Component {...pageProps} />;\n-                  :            ^^^^^^^^^\n-                3 | }\n-                4 | export default MyApp\n-                  \\`----\n-              \n-         \n-          Syntax Error\",\n+             Error:   x Expression expected\n+                   ,-[2:1]\n+                 1 | function MyApp({ Component, pageProps }) {\n+                 2 |   return <<Component {...pageProps} />;\n+                   :           ^\n+                 3 | }\n+                 4 | export default MyApp\n+                   \\`----\n+                  x Expression expected\n+                   ,-[2:1]\n+                 1 | function MyApp({ Component, pageProps }) {\n+                 2 |   return <<Component {...pageProps} />;\n+                   :            ^^^^^^^^^\n+                 3 | }\n+                 4 | export default MyApp\n+                   \\`----\n+               \n+               \n+                Caused by:\n+                    Syntax Error\",\n          \"stack\": [],\n        }\n       `)\n@@ -244,21 +243,21 @@ describe('ReactRefreshLogBox _app _document', () => {\n          \"environmentLabel\": null,\n          \"label\": \"Build Error\",\n          \"source\": \"./pages/_document.js\n-         Error:  Module build failed:\n-            \n-                 x Unexpected token \\`{\\`. Expected identifier, string literal, numeric literal or [ for the computed key\n-                  ,-[<FIXME-project-root>/pages/_document.js:3:1]\n-                1 | import Document, { Html, Head, Main, NextScript } from 'next/document'\n-                2 |\n-                3 | class MyDocument extends Document {{\n-                  :                                    ^\n-                4 |   static async getInitialProps(ctx) {\n-                5 |     const initialProps = await Document.getInitialProps(ctx)\n-                6 |     return { ...initialProps }\n-                  \\`----\n-              \n-         \n-          Syntax Error\",\n+          Module build failed:\n+             Error:   x Unexpected token \\`{\\`. Expected identifier, string literal, numeric literal or [ for the computed key\n+                   ,-[3:1]\n+                 1 | import Document, { Html, Head, Main, NextScript } from 'next/document'\n+                 2 |\n+                 3 | class MyDocument extends Document {{\n+                   :                                    ^\n+                 4 |   static async getInitialProps(ctx) {\n+                 5 |     const initialProps = await Document.getInitialProps(ctx)\n+                 6 |     return { ...initialProps }\n+                   \\`----\n+               \n+               \n+                Caused by:\n+                    Syntax Error\",\n          \"stack\": [],\n        }\n       `)"
        },
        {
            "sha": "1bf507b3148978e9a4f83f9cf55c868ce555beb3",
            "filename": "test/development/basic/next-rs-api.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -212,6 +212,7 @@ describe('next.rs api', () => {\n       },\n       dev: true,\n       defineEnv: createDefineEnv({\n+        projectPath: next.testDir,\n         isTurbopack: true,\n         clientRouterFilters: undefined,\n         config: nextConfig,"
        },
        {
            "sha": "116a452488ad3863f311b16d5ba58470869c6c92",
            "filename": "test/e2e/app-dir/use-cache-without-experimental-flag/use-cache-without-experimental-flag.test.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/test%2Fe2e%2Fapp-dir%2Fuse-cache-without-experimental-flag%2Fuse-cache-without-experimental-flag.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/test%2Fe2e%2Fapp-dir%2Fuse-cache-without-experimental-flag%2Fuse-cache-without-experimental-flag.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-without-experimental-flag%2Fuse-cache-without-experimental-flag.test.ts?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -13,6 +13,8 @@ const nextConfigWithUseCache: NextConfig = {\n   experimental: { useCache: true },\n }\n \n+const isRspack = process.env.NEXT_RSPACK !== undefined\n+\n describe('use-cache-without-experimental-flag', () => {\n   const { next, isNextStart, isTurbopack, skipped } = nextTestSetup({\n     files: __dirname,\n@@ -87,6 +89,10 @@ describe('use-cache-without-experimental-flag', () => {\n         expect(errorDescription).toMatchInlineSnapshot(\n           `\"Ecmascript file had an error\"`\n         )\n+      } else if (isRspack) {\n+        expect(errorDescription).toMatchInlineSnapshot(\n+          `\"   Module build failed:\"`\n+        )\n       } else {\n         expect(errorDescription).toMatchInlineSnapshot(\n           `\"  x To use \"use cache\", please enable the experimental feature flag \"useCache\" in your Next.js config.\"`\n@@ -107,6 +113,23 @@ describe('use-cache-without-experimental-flag', () => {\n \n            Read more: https://nextjs.org/docs/canary/app/api-reference/directives/use-cache#usage\"\n           `)\n+      } else if (isRspack) {\n+        expect(errorSource).toMatchInlineSnapshot(`\n+         \"./app/page.tsx\n+            Module build failed:\n+               Error:   x To use \"use cache\", please enable the experimental feature flag \"useCache\" in your Next.js config.\n+                    |\n+                    | Read more: https://nextjs.org/docs/canary/app/api-reference/directives/use-cache#usage\n+                 \n+                     ,-[1:1]\n+                   1 | 'use cache'\n+                     : ^^^^^^^^^^^\n+                   2 |\n+                   3 | export default async function Page() {\n+                   4 |   return <p>hello world</p>\n+                     \\`----\n+                 \"\n+        `)\n       } else {\n         expect(errorSource).toMatchInlineSnapshot(`\n          \"./app/page.tsx"
        },
        {
            "sha": "8950a8f23f691cc718ed4e8bc6122179c32af1a3",
            "filename": "test/integration/i18n-support/test/shared.js",
            "status": "modified",
            "additions": 4,
            "deletions": 13,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/test%2Fintegration%2Fi18n-support%2Ftest%2Fshared.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/test%2Fintegration%2Fi18n-support%2Ftest%2Fshared.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fi18n-support%2Ftest%2Fshared.js?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -436,7 +436,6 @@ export function runTests(ctx) {\n \n   // The page is accessible on subpath as well as on the domain url without subpath.\n   // Once this is not the case the test will need to be changed to access it via domain.\n-  // Beware of the different expectations on dev and prod version since the pre-rendering on dev does not work with domain locales\n   it('should prerender with the correct href for locale domain', async () => {\n     let browser = await webdriver(ctx.appPort, `${ctx.basePath || ''}/go`)\n \n@@ -449,11 +448,7 @@ export function runTests(ctx) {\n       ['#to-gssp-slug', '/gssp/first'],\n     ]) {\n       const href = await browser.elementByCss(element).getAttribute('href')\n-      if (ctx.isDev) {\n-        expect(href).toBe(`${ctx.basePath || ''}/go${pathname}`)\n-      } else {\n-        expect(href).toBe(`https://example.com${ctx.basePath || ''}${pathname}`)\n-      }\n+      expect(href).toBe(`https://example.com${ctx.basePath || ''}${pathname}`)\n     }\n     expect(\n       await browser.elementByCss('#to-external').getAttribute('href')\n@@ -470,13 +465,9 @@ export function runTests(ctx) {\n       ['#to-gssp-slug', '/gssp/first'],\n     ]) {\n       const href = await browser.elementByCss(element).getAttribute('href')\n-      if (ctx.isDev) {\n-        expect(href).toBe(`${ctx.basePath || ''}/go-BE${pathname}`)\n-      } else {\n-        expect(href).toBe(\n-          `https://example.com${ctx.basePath || ''}/go-BE${pathname}`\n-        )\n-      }\n+      expect(href).toBe(\n+        `https://example.com${ctx.basePath || ''}/go-BE${pathname}`\n+      )\n     }\n     expect(\n       await browser.elementByCss('#to-external').getAttribute('href')"
        },
        {
            "sha": "e366b97e6be544b30116306070a66e08f7144ff4",
            "filename": "test/integration/server-side-dev-errors/test/index.test.js",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -47,6 +47,15 @@ describe('server-side dev errors', () => {\n   })\n   afterAll(() => killApp(app))\n \n+  // TODO: update to ensure this frame is ignored properly by default\n+  function stripInternalHandler(output) {\n+    return output\n+      .replace(/.*at async handler .*next-route-loader.*/, '')\n+      .split(/\\n/)\n+      .filter((item) => !!item.trim())\n+      .join('\\n')\n+  }\n+\n   it('should show server-side error for gsp page correctly', async () => {\n     const content = await fs.readFile(gspPage, 'utf8')\n \n@@ -64,7 +73,9 @@ describe('server-side dev errors', () => {\n         )\n       })\n \n-      const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n+      const stderrOutput = stripInternalHandler(\n+        stripAnsi(stderr.slice(stderrIdx)).trim()\n+      )\n \n       expect(stderrOutput).toStartWith(\n         ' ReferenceError: missingVar is not defined' +\n@@ -113,7 +124,9 @@ describe('server-side dev errors', () => {\n         )\n       })\n \n-      const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n+      const stderrOutput = stripInternalHandler(\n+        stripAnsi(stderr.slice(stderrIdx)).trim()\n+      )\n       expect(stderrOutput).toStartWith(\n         ' ReferenceError: missingVar is not defined' +\n           '\\n    at getServerSideProps (../../test/integration/server-side-dev-errors/pages/gssp.js:6:2)' +\n@@ -161,7 +174,9 @@ describe('server-side dev errors', () => {\n         )\n       })\n \n-      const stderrOutput = stripAnsi(stderr.slice(stderrIdx)).trim()\n+      const stderrOutput = stripInternalHandler(\n+        stripAnsi(stderr.slice(stderrIdx)).trim()\n+      )\n       expect(stderrOutput).toStartWith(\n         ' ReferenceError: missingVar is not defined' +\n           '\\n    at getServerSideProps (../../test/integration/server-side-dev-errors/pages/blog/[slug].js:6:2)' +"
        },
        {
            "sha": "98e0f1e112f5a9eb9d0d256013649467fa0390f9",
            "filename": "test/rspack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/d937203f39580391234fc565de567a1e41d22d60/test%2Frspack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d937203f39580391234fc565de567a1e41d22d60/test%2Frspack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-dev-tests-manifest.json?ref=d937203f39580391234fc565de567a1e41d22d60",
            "patch": "@@ -2099,11 +2099,10 @@\n     \"runtimeError\": false\n   },\n   \"test/development/acceptance/ReactRefreshLogBox-app-doc.test.ts\": {\n-    \"passed\": [\n-      \"ReactRefreshLogBox _app _document empty _app shows logbox\",\n-      \"ReactRefreshLogBox _app _document empty _document shows logbox\"\n-    ],\n+    \"passed\": [],\n     \"failed\": [\n+      \"ReactRefreshLogBox _app _document empty _app shows logbox\",\n+      \"ReactRefreshLogBox _app _document empty _document shows logbox\",\n       \"ReactRefreshLogBox _app _document _app syntax error shows logbox\",\n       \"ReactRefreshLogBox _app _document _document syntax error shows logbox\"\n     ],\n@@ -3763,10 +3762,7 @@\n       \"Client Navigation rendering Rendering via HTTP allows to import .json files\",\n       \"Client Navigation rendering Rendering via HTTP asPath\",\n       \"Client Navigation rendering Rendering via HTTP default Content-Type\",\n-      \"Client Navigation rendering Rendering via HTTP default export is not a React Component\",\n       \"Client Navigation rendering Rendering via HTTP getInitialProps circular structure\",\n-      \"Client Navigation rendering Rendering via HTTP getInitialProps resolves to null\",\n-      \"Client Navigation rendering Rendering via HTTP getInitialProps should be class method\",\n       \"Client Navigation rendering Rendering via HTTP renders a link component\",\n       \"Client Navigation rendering Rendering via HTTP renders a stateless component\",\n       \"Client Navigation rendering Rendering via HTTP renders properties populated asynchronously\",\n@@ -3789,6 +3785,9 @@\n       \"Client Navigation rendering Rendering via HTTP with the HOC based router should navigate as expected\"\n     ],\n     \"failed\": [\n+      \"Client Navigation rendering Rendering via HTTP default export is not a React Component\",\n+      \"Client Navigation rendering Rendering via HTTP getInitialProps should be class method\",\n+      \"Client Navigation rendering Rendering via HTTP getInitialProps resolves to null\",\n       \"Client Navigation rendering Rendering via HTTP error-in-the-global-scope\",\n       \"Client Navigation rendering Rendering via HTTP error-inside-page\"\n     ],"
        }
    ],
    "stats": {
        "total": 1286,
        "additions": 1016,
        "deletions": 270
    }
}