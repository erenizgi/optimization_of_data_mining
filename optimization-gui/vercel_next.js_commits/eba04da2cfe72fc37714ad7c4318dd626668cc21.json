{
    "author": "mischnic",
    "message": "Cleanup `shouldRunTurboDevTest` usage (#82603)\n\nCo-authored-by: vercel[bot] <35613825+vercel[bot]@users.noreply.github.com>",
    "sha": "eba04da2cfe72fc37714ad7c4318dd626668cc21",
    "files": [
        {
            "sha": "03fbcb460ebba6b5e012f544c596fda26d4ec9f7",
            "filename": "test/development/basic/tailwind-jit.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fdevelopment%2Fbasic%2Ftailwind-jit.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fdevelopment%2Fbasic%2Ftailwind-jit.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Ftailwind-jit.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,11 +1,11 @@\n import { join } from 'path'\n import webdriver, { Playwright } from 'next-webdriver'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n-import { check, shouldRunTurboDevTest } from 'next-test-utils'\n+import { check } from 'next-test-utils'\n \n // [TODO]: It is unclear why turbopack takes longer to run this test\n // remove once it's fixed\n-if (shouldRunTurboDevTest()) {\n+if (process.env.IS_TURBOPACK_TEST) {\n   jest.setTimeout(1000 * 60 * 5)\n }\n "
        },
        {
            "sha": "213e2156d05b51c5608f59bade1d3cb5c2266c1c",
            "filename": "test/development/experimental-https-server/https-server-opengraph-image.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server-opengraph-image.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server-opengraph-image.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server-opengraph-image.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,12 +1,9 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { shouldRunTurboDevTest } from 'next-test-utils'\n \n describe('experimental-https-server OpenGraph image', () => {\n   const { next, skipped } = nextTestSetup({\n     files: __dirname,\n-    startCommand: `pnpm next ${\n-      shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'\n-    } --experimental-https`,\n+    startCommand: 'pnpm next dev --experimental-https',\n     skipStart: !process.env.NEXT_TEST_CI,\n   })\n   if (skipped) return"
        },
        {
            "sha": "b91d45658683211c7a625cde947289fb5e2d3645",
            "filename": "test/development/experimental-https-server/https-server.generated-key.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.generated-key.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.generated-key.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.generated-key.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,13 +1,11 @@\n import { nextTestSetup } from 'e2e-utils'\n import https from 'https'\n-import { renderViaHTTP, shouldRunTurboDevTest } from 'next-test-utils'\n+import { renderViaHTTP } from 'next-test-utils'\n \n describe('experimental-https-server (generated certificate)', () => {\n   const { next, skipped } = nextTestSetup({\n     files: __dirname,\n-    startCommand: `pnpm next ${\n-      shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'\n-    } --experimental-https`,\n+    startCommand: 'pnpm next dev --experimental-https',\n     skipStart: !process.env.NEXT_TEST_CI,\n   })\n   if (skipped) return"
        },
        {
            "sha": "b740b3a3e6639cecda17dfaf1d4e1ae79514865b",
            "filename": "test/development/experimental-https-server/https-server.provided-key.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.provided-key.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.provided-key.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server.provided-key.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,13 +1,11 @@\n import { nextTestSetup } from 'e2e-utils'\n import https from 'https'\n-import { renderViaHTTP, shouldRunTurboDevTest } from 'next-test-utils'\n+import { renderViaHTTP } from 'next-test-utils'\n \n describe('experimental-https-server (provided certificate)', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,\n-    startCommand: `pnpm next ${\n-      shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'\n-    } --experimental-https --experimental-https-key ./certificates/localhost-key.pem --experimental-https-cert ./certificates/localhost.pem`,\n+    startCommand: `pnpm next dev --experimental-https --experimental-https-key ./certificates/localhost-key.pem --experimental-https-cert ./certificates/localhost.pem`,\n   })\n   const agent = new https.Agent({\n     rejectUnauthorized: false,"
        },
        {
            "sha": "b8c2b5972f1669611a0f4c9b5a1d7b3b1c2a3f96",
            "filename": "test/e2e/app-dir/app-external/app-external.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fe2e%2Fapp-dir%2Fapp-external%2Fapp-external.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fe2e%2Fapp-dir%2Fapp-external%2Fapp-external.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-external%2Fapp-external.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,10 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import {\n-  assertNoRedbox,\n-  check,\n-  retry,\n-  shouldRunTurboDevTest,\n-} from 'next-test-utils'\n+import { assertNoRedbox, check, retry } from 'next-test-utils'\n \n async function resolveStreamResponse(response: any, onData?: any) {\n   let result = ''\n@@ -30,7 +25,7 @@ describe('app dir - external dependency', () => {\n     packageJson: {\n       scripts: {\n         build: 'next build',\n-        dev: `next ${shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'}`,\n+        dev: 'next dev',\n         start: 'next start',\n       },\n     },"
        },
        {
            "sha": "d7fafeefbddb26e9bce4f3d25256069b1e751775",
            "filename": "test/e2e/edge-compiler-module-exports-preference/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fe2e%2Fedge-compiler-module-exports-preference%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fe2e%2Fedge-compiler-module-exports-preference%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fedge-compiler-module-exports-preference%2Findex.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,6 +1,6 @@\n import { createNext } from 'e2e-utils'\n import { NextInstance } from 'e2e-utils'\n-import { fetchViaHTTP, shouldRunTurboDevTest } from 'next-test-utils'\n+import { fetchViaHTTP } from 'next-test-utils'\n \n describe('Edge compiler module exports preference', () => {\n   let next: NextInstance\n@@ -44,7 +44,7 @@ describe('Edge compiler module exports preference', () => {\n       packageJson: {\n         scripts: {\n           build: 'next build',\n-          dev: `next ${shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'}`,\n+          dev: 'next dev',\n           start: 'next start',\n         },\n       },"
        },
        {
            "sha": "98455dcb8119d15f5249db6d35021adff902098d",
            "filename": "test/e2e/edge-runtime-uses-edge-light-import-specifier-for-packages/edge-runtime-uses-edge-light-import-specifier-for-packages.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fe2e%2Fedge-runtime-uses-edge-light-import-specifier-for-packages%2Fedge-runtime-uses-edge-light-import-specifier-for-packages.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fe2e%2Fedge-runtime-uses-edge-light-import-specifier-for-packages%2Fedge-runtime-uses-edge-light-import-specifier-for-packages.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fedge-runtime-uses-edge-light-import-specifier-for-packages%2Fedge-runtime-uses-edge-light-import-specifier-for-packages.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,13 +1,12 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { shouldRunTurboDevTest } from '../../lib/next-test-utils'\n \n describe('edge-runtime uses edge-light import specifier for packages', () => {\n   const { next, skipped } = nextTestSetup({\n     files: __dirname,\n     packageJson: {\n       scripts: {\n         build: 'next build',\n-        dev: `next ${shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'}`,\n+        dev: 'next dev',\n         start: 'next start',\n       },\n     },"
        },
        {
            "sha": "66ac792daece72fe6e6d3096ff4a0f161050286b",
            "filename": "test/e2e/middleware-general/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -4,12 +4,7 @@ import fs from 'fs-extra'\n import { join } from 'path'\n import webdriver from 'next-webdriver'\n import { isNextStart, NextInstance } from 'e2e-utils'\n-import {\n-  check,\n-  fetchViaHTTP,\n-  shouldRunTurboDevTest,\n-  waitFor,\n-} from 'next-test-utils'\n+import { check, fetchViaHTTP, waitFor } from 'next-test-utils'\n import { createNext, FileRef } from 'e2e-utils'\n \n const urlsError = 'Please use only absolute URLs'\n@@ -89,9 +84,7 @@ describe('Middleware Runtime', () => {\n           scripts: {\n             setup: `cp -r ./shared-package ./node_modules`,\n             build: 'pnpm run setup && next build',\n-            dev: `pnpm run setup && next ${\n-              shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'\n-            }`,\n+            dev: 'pnpm run setup && next dev',\n             start: 'next start',\n           },\n         },"
        },
        {
            "sha": "182d2b7cc11d6c44c8cf462b494b2ad8fe7c6e47",
            "filename": "test/lib/e2e-utils/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Flib%2Fe2e-utils%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Flib%2Fe2e-utils%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fe2e-utils%2Findex.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -6,17 +6,15 @@ import { NextInstance, NextInstanceOpts } from '../next-modes/base'\n import { NextDevInstance } from '../next-modes/next-dev'\n import { NextStartInstance } from '../next-modes/next-start'\n import { NextDeployInstance } from '../next-modes/next-deploy'\n-import { shouldRunTurboDevTest } from '../next-test-utils'\n+import { shouldUseTurbopack } from '../next-test-utils'\n \n export type { NextInstance }\n \n // increase timeout to account for pnpm install time\n // if either test runs for the --turbo or have a custom timeout, set reduced timeout instead.\n // this is due to current --turbo test have a lot of tests fails with timeouts, ends up the whole\n // test job exceeds the 6 hours limit.\n-let testTimeout = shouldRunTurboDevTest()\n-  ? (240 * 1000) / 2\n-  : (process.platform === 'win32' ? 240 : 120) * 1000\n+let testTimeout = (process.platform === 'win32' ? 240 : 120) * 1000\n \n if (process.env.NEXT_E2E_TEST_TIMEOUT) {\n   try {\n@@ -166,7 +164,7 @@ export async function createNext(\n     return await trace('createNext').traceAsyncFn(async (rootSpan) => {\n       const useTurbo = !!process.env.NEXT_TEST_WASM\n         ? false\n-        : opts?.turbo ?? shouldRunTurboDevTest()\n+        : opts?.turbo ?? shouldUseTurbopack()\n \n       if (testMode === 'dev') {\n         // next dev\n@@ -291,8 +289,7 @@ export function nextTestSetup(\n     },\n     get isTurbopack(): boolean {\n       return Boolean(\n-        !process.env.NEXT_TEST_WASM &&\n-          (options.turbo ?? shouldRunTurboDevTest())\n+        !process.env.NEXT_TEST_WASM && (options.turbo ?? shouldUseTurbopack())\n       )\n     },\n "
        },
        {
            "sha": "8ca5ee58faebc5ea803b3d7bdd2270b897210789",
            "filename": "test/lib/next-modes/next-dev.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-dev.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,7 +1,6 @@\n import spawn from 'cross-spawn'\n import { Span } from 'next/dist/trace'\n import { NextInstance } from './base'\n-import { getTurbopackFlag } from '../turbo'\n import { retry, waitFor } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n@@ -33,7 +32,7 @@ export class NextDevInstance extends NextInstance {\n     let startArgs = [\n       'pnpm',\n       'next',\n-      useTurbo ? getTurbopackFlag() : undefined,\n+      useTurbo ? '--turbopack' : undefined,\n     ].filter(Boolean) as string[]\n \n     if (this.startCommand) {"
        },
        {
            "sha": "8ad35e77d21eed93cf742baff7cdbfbed556a205",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -28,13 +28,13 @@ import type { RequestInit, Response } from 'node-fetch'\n import type { NextServer } from 'next/dist/server/next'\n import { Playwright } from 'next-webdriver'\n \n-import { getTurbopackFlag, shouldRunTurboDevTest } from './turbo'\n+import { shouldUseTurbopack } from './turbo'\n import stripAnsi from 'strip-ansi'\n // TODO: Create dedicated Jest environment that sets up these matchers\n // Edge Runtime unit tests fail with \"EvalError: Code generation from strings disallowed for this context\" if these matchers are imported in those tests.\n import './add-redbox-matchers'\n \n-export { shouldRunTurboDevTest }\n+export { shouldUseTurbopack }\n \n export const nextServer = server\n export const pkg = _pkg\n@@ -451,11 +451,11 @@ export function launchApp(\n   opts?: NextDevOptions\n ) {\n   const options = opts ?? {}\n-  const useTurbo = shouldRunTurboDevTest()\n+  const useTurbo = shouldUseTurbopack()\n \n   return runNextCommandDev(\n     [\n-      useTurbo ? getTurbopackFlag() : undefined,\n+      useTurbo ? '--turbopack' : undefined,\n       dir,\n       '-p',\n       port as string,\n@@ -1435,7 +1435,7 @@ export function getSnapshotTestDescribe(variant: TestVariants) {\n     )\n   }\n \n-  const shouldRunTurboDev = shouldRunTurboDevTest()\n+  const shouldRunTurboDev = shouldUseTurbopack()\n   const shouldSkip =\n     (runningEnv === 'turbo' && !shouldRunTurboDev) ||\n     (runningEnv === 'default' && shouldRunTurboDev)"
        },
        {
            "sha": "8959cac88672c01d8091d52da6016516e5d24040",
            "filename": "test/lib/turbo.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 22,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Flib%2Fturbo.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Flib%2Fturbo.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fturbo.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -1,34 +1,17 @@\n let loggedTurbopack = false\n \n-/**\n- * Utility function to determine if a given test case needs to run with --turbo.\n- *\n- * This is primarily for the gradual test enablement with latest turbopack upstream changes.\n- *\n- * Note: it could be possible to dynamically create test cases itself (createDevTest(): it.each([...])), but\n- * it makes hard to conform with existing lint rules. Instead, starting off from manual fixture setup and\n- * update test cases accordingly as turbopack changes enable more test cases.\n- */\n-export function shouldRunTurboDevTest(): boolean {\n+export function shouldUseTurbopack(): boolean {\n   if (!!process.env.NEXT_TEST_WASM) {\n     return false\n   }\n \n-  const shouldRunTurboDev = !!process.env.IS_TURBOPACK_TEST\n-  if (shouldRunTurboDev && !loggedTurbopack) {\n+  const enabled = !!process.env.IS_TURBOPACK_TEST\n+  if (enabled && !loggedTurbopack) {\n     require('console').log(\n-      `Running tests with turbopack because environment variable TURBOPACK is set`\n+      `Running tests with turbopack because environment variable IS_TURBOPACK_TEST is set`\n     )\n     loggedTurbopack = true\n   }\n \n-  return shouldRunTurboDev\n-}\n-\n-export function getTurbopackFlag(): string {\n-  if (!!process.env.IS_TURBOPACK_TEST) {\n-    return '--turbo'\n-  } else {\n-    throw Error(`Cannot get the flag for running turbopack`)\n-  }\n+  return enabled\n }"
        },
        {
            "sha": "6f1bff5de5c9daa31bff0c7f4952c1b9b328942f",
            "filename": "test/production/pnpm-support/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fproduction%2Fpnpm-support%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eba04da2cfe72fc37714ad7c4318dd626668cc21/test%2Fproduction%2Fpnpm-support%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fpnpm-support%2Findex.test.ts?ref=eba04da2cfe72fc37714ad7c4318dd626668cc21",
            "patch": "@@ -9,7 +9,6 @@ import {\n   initNextServerScript,\n   killApp,\n   renderViaHTTP,\n-  shouldRunTurboDevTest,\n } from 'next-test-utils'\n \n describe('pnpm support', () => {\n@@ -73,7 +72,7 @@ describe('pnpm support', () => {\n       },\n       packageJson: {\n         scripts: {\n-          dev: `next ${shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'}`,\n+          dev: 'next dev',\n           build: 'next build',\n           start: 'next start',\n         },"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 30,
        "deletions": 72
    }
}