{
    "author": "styfle",
    "message": "fix(next/image): fix image-optimizer.ts headers (#82114)\n\nThe headers were forwarded to the serverless function for \"internal\"\nimages but not \"external\" images.\n\nThis changes the behavior to be the same for both such that neither\nreceive headers.",
    "sha": "6b12c60c61ee80cb0443ccd20de82ca9b4422ddd",
    "files": [
        {
            "sha": "0b69e5b3fdd8b106c7f980ae926e2a39b8e1a79c",
            "filename": "packages/next/src/server/image-optimizer.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/6b12c60c61ee80cb0443ccd20de82ca9b4422ddd/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6b12c60c61ee80cb0443ccd20de82ca9b4422ddd/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts?ref=6b12c60c61ee80cb0443ccd20de82ca9b4422ddd",
            "patch": "@@ -634,7 +634,6 @@ export async function fetchInternalImage(\n     const mocked = createRequestResponseMocks({\n       url: href,\n       method: _req.method || 'GET',\n-      headers: _req.headers,\n       socket: _req.socket,\n     })\n "
        },
        {
            "sha": "f67ce6872504cf22675e5f12b2a8978d7287908b",
            "filename": "test/integration/image-optimizer/app/pages/api/conditional-cookie.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/6b12c60c61ee80cb0443ccd20de82ca9b4422ddd/test%2Fintegration%2Fimage-optimizer%2Fapp%2Fpages%2Fapi%2Fconditional-cookie.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6b12c60c61ee80cb0443ccd20de82ca9b4422ddd/test%2Fintegration%2Fimage-optimizer%2Fapp%2Fpages%2Fapi%2Fconditional-cookie.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Fapp%2Fpages%2Fapi%2Fconditional-cookie.js?ref=6b12c60c61ee80cb0443ccd20de82ca9b4422ddd",
            "patch": "@@ -0,0 +1,11 @@\n+const pixel =\n+  'iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPj/HwADBwIAMCbHYQAAAABJRU5ErkJggg=='\n+\n+export default function handler(req, res) {\n+  if (req.headers['cookie']) {\n+    res.setHeader('content-type', 'image/png')\n+    res.end(Buffer.from(pixel, 'base64'))\n+  } else {\n+    res.status(401).end('cookie was not found')\n+  }\n+}"
        },
        {
            "sha": "559222a5398ef63c680fdc98aad3181be402262a",
            "filename": "test/integration/image-optimizer/test/util.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/6b12c60c61ee80cb0443ccd20de82ca9b4422ddd/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6b12c60c61ee80cb0443ccd20de82ca9b4422ddd/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts?ref=6b12c60c61ee80cb0443ccd20de82ca9b4422ddd",
            "patch": "@@ -308,6 +308,13 @@ export function runTests(ctx: RunTestsCtx) {\n     expect(ctx.nextOutput).toContain(animatedWarnText)\n   })\n \n+  it('should not forward cookie header', async () => {\n+    const query = { w: ctx.w, q: 30, url: '/api/conditional-cookie' }\n+    const opts = { headers: { accept: 'image/webp', cookie: '1' } }\n+    const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n+    expect(res.status).toBe(400)\n+  })\n+\n   if (ctx.nextConfigImages?.dangerouslyAllowSVG) {\n     it('should maintain vector svg', async () => {\n       const query = { w: ctx.w, q: 90, url: '/test.svg' }"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 18,
        "deletions": 1
    }
}