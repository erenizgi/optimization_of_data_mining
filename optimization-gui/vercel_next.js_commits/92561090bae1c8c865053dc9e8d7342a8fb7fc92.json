{
    "author": "ztanner",
    "message": "devtools: couple restart dev server UI with persistent cache flag (#80751)\n\nThe goal of this UI is to surface a nudge when we think that the server\nmight be in a bad state due to persistent caching problems. It probably\ndoesn't make sense to show up in any other case. While we work to figure\nout the best way to nudge it in dev, this couples the behavior behind\nthe persistent caching flag.\n\n---------\n\nCo-authored-by: Sebastian \"Sebbie\" Silbermann <sebastian.silbermann@vercel.com>",
    "sha": "92561090bae1c8c865053dc9e8d7342a8fb7fc92",
    "files": [
        {
            "sha": "1fe7660635b7e7eaa1243fe23af28c5ec0bcba58",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/error-overlay-toolbar.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/92561090bae1c8c865053dc9e8d7342a8fb7fc92/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/92561090bae1c8c865053dc9e8d7342a8fb7fc92/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Ferror-overlay-toolbar.tsx?ref=92561090bae1c8c865053dc9e8d7342a8fb7fc92",
            "patch": "@@ -15,7 +15,9 @@ export function ErrorOverlayToolbar({\n }: ErrorOverlayToolbarProps) {\n   return (\n     <span className=\"error-overlay-toolbar\">\n-      <RestartServerButton error={error} />\n+      {process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE && (\n+        <RestartServerButton error={error} />\n+      )}\n       <CopyStackTraceButton error={error} />\n       <DocsLinkButton errorMessage={error.message} />\n       <NodejsInspectorButton"
        },
        {
            "sha": "1a4b1059d535fe19ddf67a57405d413f9a2f44ee",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/error-overlay-toolbar/restart-server-button.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 19,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/92561090bae1c8c865053dc9e8d7342a8fb7fc92/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/92561090bae1c8c865053dc9e8d7342a8fb7fc92/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Ferror-overlay-toolbar%2Frestart-server-button.tsx?ref=92561090bae1c8c865053dc9e8d7342a8fb7fc92",
            "patch": "@@ -2,12 +2,11 @@ import { useState, useEffect } from 'react'\n import { RefreshClockWise } from '../../../icons/refresh-clock-wise'\n \n /**\n- * When the user reloads on a specific error and that error persists, we show\n- * the restart server button as an option. This is because some errors are\n- * recoverable by restarting the server and rebuilding the app.\n- *\n- * When Turbopack persistent cache is enabled, it will also clear the bundler\n- * cache. This improves DX by replacing the need to run `rm -rf .next` manually.\n+ * When the Turbopack persistent cache is enabled, and the user reloads on a\n+ * specific error and that error persists, we show the restart server button as\n+ * an option. This is because some errors are recoverable by clearing the\n+ * bundler cache, but we want to provide a shortcut to do this and collect\n+ * telemetry on how often this is used.\n  */\n export function RestartServerButton({ error }: { error: Error }) {\n   const [showButton, setShowButton] = useState(false)\n@@ -32,14 +31,8 @@ export function RestartServerButton({ error }: { error: Error }) {\n   }\n \n   function handleClick() {\n-    let endpoint = '/__nextjs_restart_dev'\n-\n-    if (process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE) {\n-      endpoint = '/__nextjs_restart_dev?invalidatePersistentCache'\n-    }\n-\n     // TODO: Use Client Action for transition indicator when DevTools is isolated.\n-    fetch(endpoint, {\n+    fetch('/__nextjs_restart_dev?invalidatePersistentCache', {\n       method: 'POST',\n     }).then(() => {\n       // TODO: poll server status and reload when the server is back up.\n@@ -51,14 +44,10 @@ export function RestartServerButton({ error }: { error: Error }) {\n     <button\n       className=\"restart-dev-server-button\"\n       onClick={handleClick}\n-      title={\n-        process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE\n-          ? 'Clears the bundler cache and restarts the dev server. Helpful if you are seeing stale errors or changes are not appearing.'\n-          : 'Restarts the development server without needing to leave the browser.'\n-      }\n+      title=\"Clears the bundler cache and restarts the dev server. Helpful if you are seeing stale errors or changes are not appearing.\"\n     >\n       <RefreshClockWise width={14} height={14} />\n-      Restart Dev Server\n+      Clear Bundler Cache &amp; Restart\n     </button>\n   )\n }"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 11,
        "deletions": 20
    }
}