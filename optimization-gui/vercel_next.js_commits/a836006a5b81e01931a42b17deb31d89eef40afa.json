{
    "author": "huozhi",
    "message": "[dev-overlay] refactor to group the middleware response utils (#76199)",
    "sha": "a836006a5b81e01931a42b17deb31d89eef40afa",
    "files": [
        {
            "sha": "dec83d9743db608b0fc8451d564d9adacd2a2d37",
            "filename": "packages/next/src/client/components/react-dev-overlay/_experimental/font/get-dev-overlay-font-middleware.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Ffont%2Fget-dev-overlay-font-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Ffont%2Fget-dev-overlay-font-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2F_experimental%2Ffont%2Fget-dev-overlay-font-middleware.ts?ref=a836006a5b81e01931a42b17deb31d89eef40afa",
            "patch": "@@ -1,9 +1,9 @@\n-import { internalServerError } from '../../server/shared'\n-import { notFound } from '../../../not-found'\n import type { ServerResponse, IncomingMessage } from 'http'\n import path from 'path'\n import * as fs from 'fs/promises'\n import { constants } from 'fs'\n+import * as Log from '../../../../../build/output/log'\n+import { middlewareResponse } from '../../server/middleware-response'\n \n const FONT_PREFIX = '/__nextjs_font/'\n \n@@ -34,14 +34,14 @@ export function getDevOverlayFontMiddleware() {\n \n       const fontFile = pathname.replace(FONT_PREFIX, '')\n       if (!VALID_FONTS.includes(fontFile)) {\n-        return notFound()\n+        return middlewareResponse.notFound(res)\n       }\n \n       const fontPath = path.resolve(__dirname, fontFile)\n       const fileExists = await checkFileExists(fontPath)\n \n       if (!fileExists) {\n-        return notFound()\n+        return middlewareResponse.notFound(res)\n       }\n \n       const fontData = await fs.readFile(fontPath)\n@@ -50,11 +50,11 @@ export function getDevOverlayFontMiddleware() {\n       })\n       res.end(fontData)\n     } catch (err) {\n-      console.error(\n+      Log.error(\n         'Failed to serve font:',\n         err instanceof Error ? err.message : err\n       )\n-      return internalServerError(res)\n+      return middlewareResponse.internalServerError(res)\n     }\n   }\n }"
        },
        {
            "sha": "89db34a4b64a54159103c1c0f24499bb890bb83d",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/get-next-error-feedback-middleware.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fget-next-error-feedback-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fget-next-error-feedback-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fget-next-error-feedback-middleware.ts?ref=a836006a5b81e01931a42b17deb31d89eef40afa",
            "patch": "@@ -1,6 +1,5 @@\n import { eventErrorFeedback } from '../../../../telemetry/events/error-feedback'\n-import { badRequest, internalServerError, noContent } from './shared'\n-\n+import { middlewareResponse } from './middleware-response'\n import type { ServerResponse, IncomingMessage } from 'http'\n import type { Telemetry } from '../../../../telemetry/storage'\n \n@@ -22,7 +21,7 @@ export function getNextErrorFeedbackMiddleware(telemetry: Telemetry) {\n       const wasHelpful = searchParams.get('wasHelpful')\n \n       if (!errorCode || !wasHelpful) {\n-        return badRequest(res)\n+        return middlewareResponse.badRequest(res)\n       }\n \n       await telemetry.record(\n@@ -32,9 +31,9 @@ export function getNextErrorFeedbackMiddleware(telemetry: Telemetry) {\n         })\n       )\n \n-      return noContent(res)\n+      return middlewareResponse.noContent(res)\n     } catch (error) {\n-      return internalServerError(res)\n+      return middlewareResponse.internalServerError(res)\n     }\n   }\n }"
        },
        {
            "sha": "1126fc701120a8f2feb4c9b9c7718100f58e798f",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/middleware-response.ts",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-response.ts?ref=a836006a5b81e01931a42b17deb31d89eef40afa",
            "patch": "@@ -0,0 +1,34 @@\n+import type { ServerResponse } from 'http'\n+import { inspect } from 'util'\n+\n+export const middlewareResponse = {\n+  noContent(res: ServerResponse) {\n+    res.statusCode = 204\n+    res.end('No Content')\n+  },\n+  notFound(res: ServerResponse) {\n+    res.statusCode = 404\n+    res.end('Not Found')\n+  },\n+  badRequest(res: ServerResponse) {\n+    res.statusCode = 400\n+    res.end('Bad Request')\n+  },\n+  internalServerError(res: ServerResponse, error?: unknown) {\n+    res.statusCode = 500\n+    res.setHeader('Content-Type', 'text/plain')\n+    res.end(\n+      error !== undefined\n+        ? inspect(error, { colors: false })\n+        : 'Internal Server Error'\n+    )\n+  },\n+  json(res: ServerResponse, data: any) {\n+    res\n+      .setHeader('Content-Type', 'application/json')\n+      .end(Buffer.from(JSON.stringify(data)))\n+  },\n+  jsonString(res: ServerResponse, data: string) {\n+    res.setHeader('Content-Type', 'application/json').end(Buffer.from(data))\n+  },\n+}"
        },
        {
            "sha": "c8cfc6e4dce9c45978e4012145242bf2d7bd5529",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/middleware-turbopack.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 19,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-turbopack.ts?ref=a836006a5b81e01931a42b17deb31d89eef40afa",
            "patch": "@@ -1,17 +1,11 @@\n import type { IncomingMessage, ServerResponse } from 'http'\n import {\n-  badRequest,\n   getOriginalCodeFrame,\n-  internalServerError,\n-  json,\n-  jsonString,\n-  noContent,\n-  notFound,\n   type OriginalStackFrameResponse,\n   type OriginalStackFramesRequest,\n   type OriginalStackFramesResponse,\n } from './shared'\n-\n+import { middlewareResponse } from './middleware-response'\n import fs, { constants as FS } from 'fs/promises'\n import path from 'path'\n import url from 'url'\n@@ -376,7 +370,7 @@ export function getOverlayMiddleware(project: Project) {\n \n     if (pathname === '/__nextjs_original-stack-frames') {\n       if (req.method !== 'POST') {\n-        return badRequest(res)\n+        return middlewareResponse.badRequest(res)\n       }\n \n       const body = await new Promise<string>((resolve, reject) => {\n@@ -410,26 +404,26 @@ export function getOverlayMiddleware(project: Project) {\n         })\n       )\n \n-      return json(res, result)\n+      return middlewareResponse.json(res, result)\n     } else if (pathname === '/__nextjs_launch-editor') {\n       const frame = createStackFrame(searchParams)\n \n-      if (!frame) return badRequest(res)\n+      if (!frame) return middlewareResponse.badRequest(res)\n \n       const fileExists = await fs.access(frame.file, FS.F_OK).then(\n         () => true,\n         () => false\n       )\n-      if (!fileExists) return notFound(res)\n+      if (!fileExists) return middlewareResponse.notFound(res)\n \n       try {\n         launchEditor(frame.file, frame.line ?? 1, frame.column ?? 1)\n       } catch (err) {\n         console.log('Failed to launch editor:', err)\n-        return internalServerError(res)\n+        return middlewareResponse.internalServerError(res)\n       }\n \n-      return noContent(res)\n+      return middlewareResponse.noContent(res)\n     }\n \n     return next()\n@@ -451,7 +445,7 @@ export function getSourceMapMiddleware(project: Project) {\n     let filename = searchParams.get('filename')\n \n     if (!filename) {\n-      return badRequest(res)\n+      return middlewareResponse.badRequest(res)\n     }\n \n     // TODO(veil): Always try the native version first.\n@@ -463,10 +457,10 @@ export function getSourceMapMiddleware(project: Project) {\n       const sourceMap = findSourceMap(filename)\n \n       if (sourceMap) {\n-        return json(res, sourceMap.payload)\n+        return middlewareResponse.json(res, sourceMap.payload)\n       }\n \n-      return noContent(res)\n+      return middlewareResponse.noContent(res)\n     }\n \n     try {\n@@ -480,20 +474,20 @@ export function getSourceMapMiddleware(project: Project) {\n       const sourceMapString = await project.getSourceMap(filename)\n \n       if (sourceMapString) {\n-        return jsonString(res, sourceMapString)\n+        return middlewareResponse.jsonString(res, sourceMapString)\n       }\n \n       if (filename.startsWith('file:')) {\n         const sourceMap = await getSourceMapFromFile(filename)\n \n         if (sourceMap) {\n-          return json(res, sourceMap)\n+          return middlewareResponse.json(res, sourceMap)\n         }\n       }\n     } catch (error) {\n       console.error('Failed to get source map:', error)\n     }\n \n-    noContent(res)\n+    middlewareResponse.noContent(res)\n   }\n }"
        },
        {
            "sha": "772caf06f49eb6e2660fb0565e938954a6e96258",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/middleware-webpack.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 16,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts?ref=a836006a5b81e01931a42b17deb31d89eef40afa",
            "patch": "@@ -10,16 +10,12 @@ import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import { getSourceMapFromFile } from '../internal/helpers/get-source-map-from-file'\n import { launchEditor } from '../internal/helpers/launchEditor'\n import {\n-  badRequest,\n   getOriginalCodeFrame,\n-  internalServerError,\n-  json,\n-  noContent,\n-  notFound,\n   type OriginalStackFrameResponse,\n   type OriginalStackFramesRequest,\n   type OriginalStackFramesResponse,\n } from './shared'\n+import { middlewareResponse } from './middleware-response'\n export { getServerError } from '../internal/helpers/node-stack-frames'\n export { parseStack } from '../internal/helpers/parse-stack'\n export { getSourceMapFromFile }\n@@ -522,7 +518,7 @@ export function getOverlayMiddleware(options: {\n \n     if (pathname === '/__nextjs_original-stack-frames') {\n       if (req.method !== 'POST') {\n-        return badRequest(res)\n+        return middlewareResponse.badRequest(res)\n       }\n \n       const body = await new Promise<string>((resolve, reject) => {\n@@ -539,7 +535,7 @@ export function getOverlayMiddleware(options: {\n           body\n         ) as OriginalStackFramesRequest\n \n-        return json(\n+        return middlewareResponse.json(\n           res,\n           await getOriginalStackFrames({\n             isServer,\n@@ -557,7 +553,7 @@ export function getOverlayMiddleware(options: {\n           })\n         )\n       } catch (err) {\n-        return badRequest(res)\n+        return middlewareResponse.badRequest(res)\n       }\n     } else if (pathname === '/__nextjs_launch-editor') {\n       const frame = {\n@@ -568,7 +564,7 @@ export function getOverlayMiddleware(options: {\n         arguments: searchParams.getAll('arguments').filter(Boolean),\n       } satisfies StackFrame\n \n-      if (!frame.file) return badRequest(res)\n+      if (!frame.file) return middlewareResponse.badRequest(res)\n \n       // frame files may start with their webpack layer, like (middleware)/middleware.js\n       const filePath = path.resolve(\n@@ -579,16 +575,16 @@ export function getOverlayMiddleware(options: {\n         () => true,\n         () => false\n       )\n-      if (!fileExists) return notFound(res)\n+      if (!fileExists) return middlewareResponse.notFound(res)\n \n       try {\n         launchEditor(filePath, frame.lineNumber, frame.column ?? 1)\n       } catch (err) {\n         console.log('Failed to launch editor:', err)\n-        return internalServerError(res)\n+        return middlewareResponse.internalServerError(res)\n       }\n \n-      return noContent(res)\n+      return middlewareResponse.noContent(res)\n     }\n \n     return next()\n@@ -616,7 +612,7 @@ export function getSourceMapMiddleware(options: {\n     const filename = searchParams.get('filename')\n \n     if (!filename) {\n-      return badRequest(res)\n+      return middlewareResponse.badRequest(res)\n     }\n \n     let source: Source | undefined\n@@ -640,13 +636,13 @@ export function getSourceMapMiddleware(options: {\n         },\n       })\n     } catch (error) {\n-      return internalServerError(res, error)\n+      return middlewareResponse.internalServerError(res, error)\n     }\n \n     if (!source) {\n-      return noContent(res)\n+      return middlewareResponse.noContent(res)\n     }\n \n-    return json(res, source.sourceMap)\n+    return middlewareResponse.json(res, source.sourceMap)\n   }\n }"
        },
        {
            "sha": "298d6ca5db31cf36b81869502d24906f7809420d",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/shared.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 37,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a836006a5b81e01931a42b17deb31d89eef40afa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fshared.ts?ref=a836006a5b81e01931a42b17deb31d89eef40afa",
            "patch": "@@ -1,6 +1,4 @@\n import type { StackFrame } from 'stacktrace-parser'\n-import type { ServerResponse } from 'http'\n-import { inspect } from 'util'\n import { codeFrameColumns } from 'next/dist/compiled/babel/code-frame'\n import isInternal, {\n   nextInternalsRe,\n@@ -82,38 +80,3 @@ export function getOriginalCodeFrame(\n     { forceColor: colors }\n   )\n }\n-\n-export function noContent(res: ServerResponse) {\n-  res.statusCode = 204\n-  res.end('No Content')\n-}\n-\n-export function badRequest(res: ServerResponse) {\n-  res.statusCode = 400\n-  res.end('Bad Request')\n-}\n-\n-export function notFound(res: ServerResponse) {\n-  res.statusCode = 404\n-  res.end('Not Found')\n-}\n-\n-export function internalServerError(res: ServerResponse, error?: unknown) {\n-  res.statusCode = 500\n-  res.setHeader('Content-Type', 'text/plain')\n-  res.end(\n-    error !== undefined\n-      ? inspect(error, { colors: false })\n-      : 'Internal Server Error'\n-  )\n-}\n-\n-export function json(res: ServerResponse, data: any) {\n-  res\n-    .setHeader('Content-Type', 'application/json')\n-    .end(Buffer.from(JSON.stringify(data)))\n-}\n-\n-export function jsonString(res: ServerResponse, data: string) {\n-  res.setHeader('Content-Type', 'application/json').end(Buffer.from(data))\n-}"
        }
    ],
    "stats": {
        "total": 152,
        "additions": 69,
        "deletions": 83
    }
}