{
    "author": "ztanner",
    "message": "revert: add ?dpl to fonts in `/_next/static/media` (#83062)\n\nThis change is causing double font loading due to CSS loading without a\n`dpl` while they are preloaded with a `dpl` param. Reverting until a\nproper fix can be implemented.\n\nReverts:\n- #82384\n- #82488",
    "sha": "c9d4a97433c5417fcbbf78dc265f12ff6292d365",
    "files": [
        {
            "sha": "f636443c718982dd056693e97978d44bc3434620",
            "filename": "packages/font/src/google/loader.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -124,7 +124,6 @@ describe('next/font/google loader', () => {\n         mockFetchResource.mockResolvedValue(Buffer.from('OK'))\n         const { css } = await nextFontGoogleFontLoader({\n           functionName,\n-          deploymentId: undefined,\n           data: [\n             {\n               adjustFontFallback: false,"
        },
        {
            "sha": "85168f40839103fd955fbe190a5e5f43594fa2b0",
            "filename": "packages/font/src/local/loader.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 33,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Ffont%2Fsrc%2Flocal%2Floader.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Ffont%2Fsrc%2Flocal%2Floader.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Flocal%2Floader.test.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -5,7 +5,6 @@ describe('next/font/local loader', () => {\n     test('Default CSS', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n-        deploymentId: undefined,\n         data: [{ src: './my-font.woff2' }],\n         emitFontFile: () => '/_next/static/media/my-font.woff2',\n         resolve: jest.fn(),\n@@ -29,37 +28,9 @@ describe('next/font/local loader', () => {\n       `)\n     })\n \n-    test('with dpl query string', async () => {\n-      const { css } = await nextFontLocalFontLoader({\n-        functionName: '',\n-        deploymentId: 'dpl_123',\n-        data: [{ src: './my-font.woff2' }],\n-        emitFontFile: () => '/_next/static/media/my-font.woff2',\n-        resolve: jest.fn(),\n-        isDev: false,\n-        isServer: true,\n-        variableName: 'myFont',\n-        loaderContext: {\n-          fs: {\n-            readFile: (_: string, cb: any) => cb(null, 'fontdata'),\n-          },\n-        } as any,\n-      })\n-\n-      expect(css).toMatchInlineSnapshot(`\n-        \"@font-face {\n-        font-family: myFont;\n-        src: url(/_next/static/media/my-font.woff2?dpl=dpl_123) format('woff2');\n-        font-display: swap;\n-        }\n-        \"\n-      `)\n-    })\n-\n     test('Weight and style', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n-        deploymentId: undefined,\n         data: [{ src: './my-font.woff2', weight: '100 900', style: 'italic' }],\n         emitFontFile: () => '/_next/static/media/my-font.woff2',\n         resolve: jest.fn(),\n@@ -88,7 +59,6 @@ describe('next/font/local loader', () => {\n     test('Other properties', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n-        deploymentId: undefined,\n         data: [\n           {\n             src: './my-font.woff2',\n@@ -125,7 +95,6 @@ describe('next/font/local loader', () => {\n     test('Multiple weights default style', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n-        deploymentId: undefined,\n         data: [\n           {\n             style: 'italic',\n@@ -202,7 +171,6 @@ describe('next/font/local loader', () => {\n     test('Multiple styles default weight', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n-        deploymentId: undefined,\n         data: [\n           {\n             weight: '400',\n@@ -265,7 +233,6 @@ describe('next/font/local loader', () => {\n     test('Custom font-family in declarations', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n-        deploymentId: undefined,\n         data: [\n           {\n             src: './my-font.woff2',"
        },
        {
            "sha": "e39ce48d64a296f562adc0fef3a3be7c24ad74ee",
            "filename": "packages/font/src/local/loader.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Ffont%2Fsrc%2Flocal%2Floader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Ffont%2Fsrc%2Flocal%2Floader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Flocal%2Floader.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -19,7 +19,6 @@ const nextFontLocalFontLoader: FontLoader = async ({\n   data,\n   emitFontFile,\n   resolve,\n-  deploymentId,\n   loaderContext,\n }) => {\n   const {\n@@ -46,10 +45,6 @@ const nextFontLocalFontLoader: FontLoader = async ({\n         preload,\n         typeof adjustFontFallback === 'undefined' || !!adjustFontFallback\n       )\n-      // Should match behavior in get-asset-query-string.ts\n-      const qs = deploymentId\n-        ? `${fontUrl.includes('?') ? '&' : '?'}dpl=${deploymentId}`\n-        : ''\n \n       // Try to load font metadata from the font file using fontkit.\n       // The data is used to calculate the fallback font override values.\n@@ -71,7 +66,7 @@ const nextFontLocalFontLoader: FontLoader = async ({\n           ? declarations.map(({ prop, value }) => [prop, value])\n           : []),\n         ...(hasCustomFontFamily ? [] : [['font-family', variableName]]),\n-        ['src', `url(${fontUrl + qs}) format('${format}')`],\n+        ['src', `url(${fontUrl}) format('${format}')`],\n         ['font-display', display],\n         ...((weight ?? defaultWeight)\n           ? [['font-weight', weight ?? defaultWeight]]"
        },
        {
            "sha": "fe10e31d59b927714096c2358fadc56cb62b2a62",
            "filename": "packages/next/font/index.d.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Ffont%2Findex.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Ffont%2Findex.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ffont%2Findex.d.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -19,7 +19,6 @@ export type FontLoader = (options: {\n   resolve: (src: string) => string\n   isDev: boolean\n   isServer: boolean\n-  deploymentId: string | undefined\n   loaderContext: any\n }) => Promise<{\n   css: string"
        },
        {
            "sha": "c001842a5272f544bf89c54df4de62d2087bb188",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -2451,7 +2451,6 @@ export default async function getBaseWebpackConfig(\n     isEdgeRuntime: isEdgeServer,\n     targetWeb: isClient || isEdgeServer,\n     assetPrefix: config.assetPrefix || '',\n-    deploymentId: config.deploymentId,\n     sassOptions: config.sassOptions,\n     productionBrowserSourceMaps: config.productionBrowserSourceMaps,\n     future: config.future,"
        },
        {
            "sha": "10ec131f9e0afb546b870d4333d13fbe2b21ba40",
            "filename": "packages/next/src/build/webpack/config/blocks/css/loaders/next-font.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fnext-font.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fnext-font.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fnext-font.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -62,7 +62,6 @@ export function getNextFontLoader(\n       isDev: ctx.isDevelopment,\n       isServer: ctx.isServer,\n       assetPrefix: ctx.assetPrefix,\n-      deploymentId: ctx.deploymentId,\n       fontLoaderPath,\n       postcss,\n     },"
        },
        {
            "sha": "4daa1b35696a25c1972a52ac0d3aff1ae8d11cb4",
            "filename": "packages/next/src/build/webpack/config/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Findex.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -19,7 +19,6 @@ export async function buildConfiguration(\n     isEdgeRuntime,\n     targetWeb,\n     assetPrefix,\n-    deploymentId,\n     sassOptions,\n     productionBrowserSourceMaps,\n     future,\n@@ -37,7 +36,6 @@ export async function buildConfiguration(\n     isEdgeRuntime: boolean\n     targetWeb: boolean\n     assetPrefix: string\n-    deploymentId: string | undefined\n     sassOptions: any\n     productionBrowserSourceMaps: boolean\n     transpilePackages: NextConfigComplete['transpilePackages']\n@@ -63,7 +61,6 @@ export async function buildConfiguration(\n         ? assetPrefix.slice(0, -1)\n         : assetPrefix\n       : '',\n-    deploymentId,\n     sassOptions,\n     productionBrowserSourceMaps,\n     transpilePackages,"
        },
        {
            "sha": "004e0acac5b6da5623cd2bcfd3546bbca1737286",
            "filename": "packages/next/src/build/webpack/config/utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Futils.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -19,7 +19,6 @@ export type ConfigurationContext = {\n   targetWeb: boolean\n \n   assetPrefix: string\n-  deploymentId: string | undefined\n \n   sassOptions: any\n   productionBrowserSourceMaps: boolean"
        },
        {
            "sha": "b50745f79d539f31383351d1d807290adedb07b2",
            "filename": "packages/next/src/build/webpack/loaders/next-font-loader/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -45,7 +45,6 @@ export default async function nextFontLoader(this: any) {\n       assetPrefix,\n       fontLoaderPath,\n       postcss: getPostcss,\n-      deploymentId,\n     } = this.getOptions()\n \n     if (assetPrefix && !/^\\/|https?:\\/\\//.test(assetPrefix)) {\n@@ -67,7 +66,7 @@ export default async function nextFontLoader(this: any) {\n      * NextFontManifestPlugin uses this to see if fallback fonts are being used.\n      * This is used to collect stats on fallback fonts usage by the Google Aurora team.\n      */\n-    const emitFontFile: Parameters<FontLoader>[0]['emitFontFile'] = (\n+    const emitFontFile = (\n       content: Buffer,\n       ext: string,\n       preload: boolean,\n@@ -110,7 +109,6 @@ export default async function nextFontLoader(this: any) {\n               ),\n             isDev,\n             isServer,\n-            deploymentId,\n             loaderContext: this,\n           })\n         )"
        },
        {
            "sha": "4436b0d04942eae58f5d523765b553e8db877538",
            "filename": "packages/next/src/pages/_document.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -363,8 +363,7 @@ function getAmpPath(ampPath: string, asPath: string): string {\n function getNextFontLinkTags(\n   nextFontManifest: DeepReadonly<NextFontManifest> | undefined,\n   dangerousAsPath: string,\n-  assetPrefix: string = '',\n-  assetQueryString: string = ''\n+  assetPrefix: string = ''\n ) {\n   if (!nextFontManifest) {\n     return {\n@@ -404,7 +403,7 @@ function getNextFontLinkTags(\n             <link\n               key={fontFile}\n               rel=\"preload\"\n-              href={`${assetPrefix}/_next/${encodeURIPath(fontFile)}${assetQueryString}`}\n+              href={`${assetPrefix}/_next/${encodeURIPath(fontFile)}`}\n               as=\"font\"\n               type={`font/${ext}`}\n               crossOrigin=\"anonymous\"\n@@ -756,8 +755,7 @@ export class Head extends React.Component<HeadProps> {\n     const nextFontLinkTags = getNextFontLinkTags(\n       nextFontManifest,\n       dangerousAsPath,\n-      assetPrefix,\n-      this.context.assetQueryString\n+      assetPrefix\n     )\n \n     const tracingMetadata = getTracedMetadata("
        },
        {
            "sha": "7d2b7485afd174a8440176437b16dce184c6a994",
            "filename": "packages/next/src/server/app-render/get-layer-assets.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -46,7 +46,7 @@ export function getLayerAssets({\n         const fontFilename = preloadedFontFiles[i]\n         const ext = /\\.(woff|woff2|eot|ttf|otf)$/.exec(fontFilename)![1]\n         const type = `font/${ext}`\n-        const href = `${ctx.assetPrefix}/_next/${encodeURIPath(fontFilename)}${getAssetQueryString(ctx, false)}`\n+        const href = `${ctx.assetPrefix}/_next/${encodeURIPath(fontFilename)}`\n \n         preloadCallbacks.push(() => {\n           ctx.componentMod.preloadFont("
        },
        {
            "sha": "83955f69fff45de94b73622b81e4b2e4cb9a22b3",
            "filename": "test/production/deployment-id-handling/deployment-id-cookie-handling.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -45,7 +45,11 @@ describe('deployment-id-handling disabled', () => {\n \n       for (const link of links) {\n         if (link.attribs.href) {\n-          expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+          if (link.attribs.as === 'font') {\n+            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+          } else {\n+            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+          }\n         }\n       }\n "
        },
        {
            "sha": "43213e45b10133bbf3bf779638640039d21f9815",
            "filename": "test/production/deployment-id-handling/deployment-id-handling.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c9d4a97433c5417fcbbf78dc265f12ff6292d365/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-handling.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9d4a97433c5417fcbbf78dc265f12ff6292d365/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-handling.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-handling.test.ts?ref=c9d4a97433c5417fcbbf78dc265f12ff6292d365",
            "patch": "@@ -39,7 +39,11 @@ describe.each(['NEXT_DEPLOYMENT_ID', 'CUSTOM_DEPLOYMENT_ID'])(\n \n         for (const link of links) {\n           if (link.attribs.href && link.attribs.rel !== 'expect') {\n-            expect(link.attribs.href).toContain('dpl=' + deploymentId)\n+            if (link.attribs.as === 'font') {\n+              expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+            } else {\n+              expect(link.attribs.href).toContain('dpl=' + deploymentId)\n+            }\n           }\n         }\n \n@@ -169,7 +173,11 @@ describe('deployment-id-handling disabled', () => {\n \n       for (const link of links) {\n         if (link.attribs.href) {\n-          expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+          if (link.attribs.as === 'font') {\n+            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+          } else {\n+            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n+          }\n         }\n       }\n "
        }
    ],
    "stats": {
        "total": 80,
        "additions": 21,
        "deletions": 59
    }
}