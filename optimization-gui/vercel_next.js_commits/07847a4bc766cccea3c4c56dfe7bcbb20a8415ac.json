{
    "author": "mischnic",
    "message": "Turbopack: skip next-server.js.nft.json for Vercel (#83299)\n\nOn Vercel, we only need `next-minimal-server.js.nft.json`\r\n\r\nAlso, `ci_has_next_support` was implemented correctly, it previously read from `nextConfig.env`, instead of the real (full) environment variables from the system.",
    "sha": "07847a4bc766cccea3c4c56dfe7bcbb20a8415ac",
    "files": [
        {
            "sha": "4ad57f1b4f7d3df61cda8696d3922bdef29682c3",
            "filename": "crates/next-api/src/next_server_nft.rs",
            "status": "modified",
            "additions": 23,
            "deletions": 13,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs?ref=07847a4bc766cccea3c4c56dfe7bcbb20a8415ac",
            "patch": "@@ -38,18 +38,28 @@ enum ServerNftType {\n \n #[turbo_tasks::function]\n pub async fn next_server_nft_assets(project: Vc<Project>) -> Result<Vc<OutputAssets>> {\n-    Ok(Vc::cell(vec![\n-        ResolvedVc::upcast(\n-            ServerNftJsonAsset::new(project, ServerNftType::Full)\n-                .to_resolved()\n-                .await?,\n-        ),\n-        ResolvedVc::upcast(\n-            ServerNftJsonAsset::new(project, ServerNftType::Minimal)\n-                .to_resolved()\n-                .await?,\n-        ),\n-    ]))\n+    let has_next_support = *project.ci_has_next_support().await?;\n+    let is_standalone = *project.next_config().is_standalone().await?;\n+\n+    let minimal = ResolvedVc::upcast(\n+        ServerNftJsonAsset::new(project, ServerNftType::Minimal)\n+            .to_resolved()\n+            .await?,\n+    );\n+\n+    if has_next_support && !is_standalone {\n+        // When deploying to Vercel, we only need next-minimal-server.js.nft.json\n+        Ok(Vc::cell(vec![minimal]))\n+    } else {\n+        Ok(Vc::cell(vec![\n+            minimal,\n+            ResolvedVc::upcast(\n+                ServerNftJsonAsset::new(project, ServerNftType::Full)\n+                    .to_resolved()\n+                    .await?,\n+            ),\n+        ]))\n+    }\n }\n \n #[turbo_tasks::value]\n@@ -248,7 +258,7 @@ impl ServerNftJsonAsset {\n     #[turbo_tasks::function]\n     async fn ignores(&self) -> Result<Vc<Glob>> {\n         let is_standalone = *self.project.next_config().is_standalone().await?;\n-        let has_next_support = *self.project.next_config().ci_has_next_support().await?;\n+        let has_next_support = *self.project.ci_has_next_support().await?;\n         let project_path = self.project.project_path().owned().await?;\n \n         let output_file_tracing_excludes = self"
        },
        {
            "sha": "edfdc5e35263ed8912619b06c1d5b87b85531075",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=07847a4bc766cccea3c4c56dfe7bcbb20a8415ac",
            "patch": "@@ -764,6 +764,13 @@ impl Project {\n         *self.env\n     }\n \n+    #[turbo_tasks::function]\n+    pub async fn ci_has_next_support(&self) -> Result<Vc<bool>> {\n+        Ok(Vc::cell(\n+            self.env.read(rcstr!(\"NOW_BUILDER\")).await?.is_some(),\n+        ))\n+    }\n+\n     #[turbo_tasks::function]\n     pub(super) fn current_node_js_version(&self) -> Vc<NodeJsVersion> {\n         NodeJsVersion::Static(ResolvedVc::cell(self.current_node_js_version.clone())).cell()"
        },
        {
            "sha": "604a70e95beb9e4bb3530ba44e9de354f043f631",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=07847a4bc766cccea3c4c56dfe7bcbb20a8415ac",
            "patch": "@@ -1328,11 +1328,6 @@ impl NextConfig {\n         Vc::cell(self.output == Some(OutputType::Standalone))\n     }\n \n-    #[turbo_tasks::function]\n-    pub fn ci_has_next_support(&self) -> Vc<bool> {\n-        Vc::cell(self.env.contains_key(\"NOW_BUILDER\"))\n-    }\n-\n     #[turbo_tasks::function]\n     pub fn cache_handler(&self, project_path: FileSystemPath) -> Result<Vc<OptionFileSystemPath>> {\n         if let Some(handler) = &self.cache_handler {"
        },
        {
            "sha": "c5eddcd0aaa2ef3a0d5f5b120f3909830bc21695",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files-app.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-app.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-app.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-app.test.ts?ref=07847a4bc766cccea3c4c56dfe7bcbb20a8415ac",
            "patch": "@@ -99,6 +99,7 @@ describe('required server files app router', () => {\n     await setupNext({ nextEnv: true, minimalMode: true })\n   })\n   afterAll(async () => {\n+    delete process.env.NOW_BUILDER\n     delete process.env.NEXT_PRIVATE_TEST_HEADERS\n     await next.destroy()\n     if (server) await killApp(server)"
        },
        {
            "sha": "498a6db845eca2d771758fa5b3b806650462335a",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files-ppr.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-ppr.test.ts?ref=07847a4bc766cccea3c4c56dfe7bcbb20a8415ac",
            "patch": "@@ -112,6 +112,7 @@ describe('required server files app router', () => {\n   })\n \n   afterAll(async () => {\n+    delete process.env.NOW_BUILDER\n     delete process.env.NEXT_PRIVATE_TEST_HEADERS\n     await next.destroy()\n     if (server) await killApp(server)"
        },
        {
            "sha": "2a7e2cde8a1fb620742442cb87d57b6db6732bc8",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts?ref=07847a4bc766cccea3c4c56dfe7bcbb20a8415ac",
            "patch": "@@ -161,6 +161,7 @@ describe('required server files', () => {\n   })\n \n   afterAll(async () => {\n+    delete process.env.NOW_BUILDER\n     delete process.env.NEXT_PRIVATE_TEST_HEADERS\n     await next.destroy()\n   })"
        },
        {
            "sha": "04111664910aaee23201745da9ee5f44df07e972",
            "filename": "test/production/standalone-mode/response-cache/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/test%2Fproduction%2Fstandalone-mode%2Fresponse-cache%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07847a4bc766cccea3c4c56dfe7bcbb20a8415ac/test%2Fproduction%2Fstandalone-mode%2Fresponse-cache%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fresponse-cache%2Findex.test.ts?ref=07847a4bc766cccea3c4c56dfe7bcbb20a8415ac",
            "patch": "@@ -85,6 +85,7 @@ describe('minimal-mode-response-cache', () => {\n     appPort = `http://127.0.0.1:${port}`\n   })\n   afterAll(async () => {\n+    delete process.env.NOW_BUILDER\n     delete process.env.NEXT_PRIVATE_TEST_HEADERS\n     await next.destroy()\n     if (server) await killApp(server)"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 34,
        "deletions": 18
    }
}