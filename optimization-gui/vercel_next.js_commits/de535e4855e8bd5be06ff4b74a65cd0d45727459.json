{
    "author": "ijjk",
    "message": "Ensure middleware layer is applied for node (#76293)\n\nThis ensures we apply the middleware layer when in the node runtime so\nthat `server-only` imports are properly handled. Also ensures our test\nsuite includes this condition for `edge` and `node` runtimes.\n\nFixes: https://github.com/vercel/next.js/issues/75904",
    "sha": "de535e4855e8bd5be06ff4b74a65cd0d45727459",
    "files": [
        {
            "sha": "28d6067fdb5e799eb347238a5458328317c2e1fb",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/de535e4855e8bd5be06ff4b74a65cd0d45727459/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de535e4855e8bd5be06ff4b74a65cd0d45727459/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=de535e4855e8bd5be06ff4b74a65cd0d45727459",
            "patch": "@@ -407,7 +407,10 @@ export function getEdgeServerEntry(opts: {\n       ).toString('base64'),\n     }\n \n-    return `next-middleware-loader?${stringify(loaderParams)}!`\n+    return {\n+      import: `next-middleware-loader?${stringify(loaderParams)}!`,\n+      layer: WEBPACK_LAYERS.middleware,\n+    }\n   }\n \n   if (isAPIRoute(opts.page)) {"
        },
        {
            "sha": "f318ad8eb125a4119a114985d1eff2b812e6ce3c",
            "filename": "test/e2e/middleware-general/app/lib/some-data.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/de535e4855e8bd5be06ff4b74a65cd0d45727459/test%2Fe2e%2Fmiddleware-general%2Fapp%2Flib%2Fsome-data.js",
            "raw_url": "https://github.com/vercel/next.js/raw/de535e4855e8bd5be06ff4b74a65cd0d45727459/test%2Fe2e%2Fmiddleware-general%2Fapp%2Flib%2Fsome-data.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Fapp%2Flib%2Fsome-data.js?ref=de535e4855e8bd5be06ff4b74a65cd0d45727459",
            "patch": "@@ -0,0 +1,5 @@\n+import 'server-only'\n+\n+export async function getSomeData() {\n+  return 'some data'\n+}"
        },
        {
            "sha": "a98f9794c03e71fc96476162438dd5402e282837",
            "filename": "test/e2e/middleware-general/app/middleware-node.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/de535e4855e8bd5be06ff4b74a65cd0d45727459/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js",
            "raw_url": "https://github.com/vercel/next.js/raw/de535e4855e8bd5be06ff4b74a65cd0d45727459/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware-node.js?ref=de535e4855e8bd5be06ff4b74a65cd0d45727459",
            "patch": "@@ -1,5 +1,6 @@\n /* global globalThis */\n import { NextRequest, NextResponse } from 'next/server'\n+import { getSomeData } from './lib/some-data'\n import magicValue from 'shared-package'\n \n export const config = {\n@@ -29,6 +30,8 @@ const params = (url) => {\n }\n \n export async function middleware(request) {\n+  getSomeData()\n+\n   const url = request.nextUrl\n \n   if (process.env.NEXT_RUNTIME === 'nodejs') {"
        },
        {
            "sha": "146288f85059a75e8efb8c6b5b02b8ac02d9222f",
            "filename": "test/e2e/middleware-general/app/middleware.js",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/de535e4855e8bd5be06ff4b74a65cd0d45727459/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/de535e4855e8bd5be06ff4b74a65cd0d45727459/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Fapp%2Fmiddleware.js?ref=de535e4855e8bd5be06ff4b74a65cd0d45727459",
            "patch": "@@ -1,5 +1,6 @@\n /* global globalThis */\n import { NextRequest, NextResponse, URLPattern } from 'next/server'\n+import { getSomeData } from './lib/some-data'\n import magicValue from 'shared-package'\n \n export const config = {\n@@ -38,6 +39,8 @@ const params = (url) => {\n }\n \n export async function middleware(request) {\n+  getSomeData()\n+\n   const url = request.nextUrl\n \n   if (request.headers.get('x-prerender-revalidate')) {"
        },
        {
            "sha": "00977bbbedc229f350d1545800c57d16beac84bc",
            "filename": "test/e2e/middleware-general/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/de535e4855e8bd5be06ff4b74a65cd0d45727459/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de535e4855e8bd5be06ff4b74a65cd0d45727459/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-general%2Ftest%2Findex.test.ts?ref=de535e4855e8bd5be06ff4b74a65cd0d45727459",
            "patch": "@@ -37,6 +37,7 @@ describe('Middleware Runtime', () => {\n               isNodeMiddleware ? 'middleware-node.js' : 'middleware.js'\n             )\n           ),\n+          lib: new FileRef(join(__dirname, '../app/lib')),\n           pages: new FileRef(join(__dirname, '../app/pages')),\n           'shared-package': new FileRef(\n             join(__dirname, '../app/node_modules/shared-package')"
        }
    ],
    "stats": {
        "total": 17,
        "additions": 16,
        "deletions": 1
    }
}