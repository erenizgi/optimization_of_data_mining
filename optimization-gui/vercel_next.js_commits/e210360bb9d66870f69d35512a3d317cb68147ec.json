{
    "author": "ijjk",
    "message": "Add create release branch workflow (#81687)\n\nThis creates a new workflow to create a release branch and apply the\nnecessary configs to allow releasing from that branch as this is quite\ncommon for backports.",
    "sha": "e210360bb9d66870f69d35512a3d317cb68147ec",
    "files": [
        {
            "sha": "0b0e354319839c08d480af05f6b4319d148a40d3",
            "filename": ".github/workflows/create_release_branch.yml",
            "status": "added",
            "additions": 77,
            "deletions": 0,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/e210360bb9d66870f69d35512a3d317cb68147ec/.github%2Fworkflows%2Fcreate_release_branch.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/e210360bb9d66870f69d35512a3d317cb68147ec/.github%2Fworkflows%2Fcreate_release_branch.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fcreate_release_branch.yml?ref=e210360bb9d66870f69d35512a3d317cb68147ec",
            "patch": "@@ -0,0 +1,77 @@\n+on:\n+  workflow_dispatch:\n+    inputs:\n+      branchName:\n+        description: name of branch to create (next-15-4)\n+        required: true\n+        type: string\n+\n+      tagName:\n+        description: Tag to start the branch from (v15.4.1)\n+        type: string\n+        required: true\n+\n+    secrets:\n+      RELEASE_BOT_GITHUB_TOKEN:\n+        required: true\n+\n+name: Create Release Branch\n+\n+env:\n+  NAPI_CLI_VERSION: 2.18.4\n+  TURBO_VERSION: 2.3.3\n+  NODE_LTS_VERSION: 20\n+\n+jobs:\n+  start:\n+    if: github.repository_owner == 'vercel'\n+    runs-on: ubuntu-latest\n+    env:\n+      NEXT_TELEMETRY_DISABLED: 1\n+      # we build a dev binary for use in CI so skip downloading\n+      # canary next-swc binaries in the monorepo\n+      NEXT_SKIP_NATIVE_POSTINSTALL: 1\n+\n+    steps:\n+      - name: Setup node\n+        uses: actions/setup-node@v4\n+        with:\n+          node-version: 18\n+          check-latest: true\n+\n+      - name: Clone Next.js repository\n+        run: git clone https://github.com/vercel/next.js.git --depth=25 --single-branch --branch ${GITHUB_REF_NAME:-canary} .\n+\n+      - name: Check token\n+        run: gh auth status\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.RELEASE_BOT_GITHUB_TOKEN }}\n+\n+      # https://github.com/actions/virtual-environments/issues/1187\n+      - name: tune linux network\n+        run: sudo ethtool -K eth0 tx off rx off\n+\n+      - name: Setup corepack\n+        run: |\n+          npm i -g corepack@0.31\n+          corepack enable\n+          pnpm --version\n+\n+      - id: get-store-path\n+        run: echo STORE_PATH=$(pnpm store path) >> $GITHUB_OUTPUT\n+\n+      - uses: actions/cache@v4\n+        timeout-minutes: 5\n+        id: cache-pnpm-store\n+        with:\n+          path: ${{ steps.get-store-path.outputs.STORE_PATH }}\n+          key: pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}\n+          restore-keys: |\n+            pnpm-store-\n+            pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}\n+\n+      - run: pnpm install\n+\n+      - run: node ./scripts/create-release-branch.js --branch-name ${{ github.event.inputs.branchName }} --tag-name ${{ github.event.inputs.tagName }}\n+        env:\n+          RELEASE_BOT_GITHUB_TOKEN: ${{ secrets.RELEASE_BOT_GITHUB_TOKEN }}"
        },
        {
            "sha": "911ff4c7652e820a8438eca2d82efa2aaffefcd0",
            "filename": "scripts/create-release-branch.js",
            "status": "added",
            "additions": 129,
            "deletions": 0,
            "changes": 129,
            "blob_url": "https://github.com/vercel/next.js/blob/e210360bb9d66870f69d35512a3d317cb68147ec/scripts%2Fcreate-release-branch.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e210360bb9d66870f69d35512a3d317cb68147ec/scripts%2Fcreate-release-branch.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fcreate-release-branch.js?ref=e210360bb9d66870f69d35512a3d317cb68147ec",
            "patch": "@@ -0,0 +1,129 @@\n+// @ts-check\n+const fs = require('fs')\n+const path = require('path')\n+const execa = require('execa')\n+const resolveFrom = require('resolve-from')\n+\n+async function main() {\n+  const args = process.argv\n+  const branchName = args[args.indexOf('--branch-name') + 1]\n+  const tagName = args[args.indexOf('--tag-name') + 1]\n+\n+  if (!branchName) {\n+    throw new Error('branchName value is missing!')\n+  }\n+\n+  if (!tagName || !tagName.startsWith('v')) {\n+    throw new Error('tagName value is invalid \"' + tagName + '\"')\n+  }\n+\n+  const githubToken = process.env.RELEASE_BOT_GITHUB_TOKEN\n+\n+  if (!githubToken) {\n+    console.log(`Missing RELEASE_BOT_GITHUB_TOKEN`)\n+    return\n+  }\n+\n+  const configStorePath = resolveFrom(\n+    path.join(process.cwd(), 'node_modules/release'),\n+    'configstore'\n+  )\n+  const ConfigStore = require(configStorePath)\n+\n+  const config = new ConfigStore('release')\n+  config.set('token', githubToken)\n+\n+  await execa(\n+    `git remote set-url origin https://nextjs-bot:${githubToken}@github.com/vercel/next.js.git`,\n+    { stdio: 'inherit', shell: true }\n+  )\n+  await execa(`git config user.name \"nextjs-bot\"`, {\n+    stdio: 'inherit',\n+    shell: true,\n+  })\n+  await execa(`git config user.email \"it+nextjs-bot@vercel.com\"`, {\n+    stdio: 'inherit',\n+    shell: true,\n+  })\n+  await execa(`git checkout -b \"${branchName}\"`, {\n+    stdio: 'inherit',\n+    shell: true,\n+  })\n+  await execa(`git reset --hard ${tagName}`, {\n+    stdio: 'inherit',\n+    shell: true,\n+  })\n+  const lernaPath = path.join(__dirname, '..', 'lerna.json')\n+  const existingLerna = JSON.parse(\n+    await fs.promises.readFile(lernaPath, 'utf8')\n+  )\n+  existingLerna.command.publish.allowBranch.push(branchName)\n+\n+  await fs.promises.writeFile(lernaPath, JSON.stringify(existingLerna, null, 2))\n+\n+  const buildAndDeployPath = path.join(\n+    __dirname,\n+    '..',\n+    '.github',\n+    'workflows',\n+    'build_and_deploy.yml'\n+  )\n+  const buildAndDeploy = await fs.promises.readFile(buildAndDeployPath, 'utf8')\n+  await fs.promises.writeFile(\n+    buildAndDeployPath,\n+    buildAndDeploy.replace(/refs\\/heads\\/canary/g, `refs/heads/${branchName}`)\n+  )\n+\n+  const buildAndTestPath = path.join(\n+    __dirname,\n+    '..',\n+    '.github',\n+    'workflows',\n+    'build_and_test.yml'\n+  )\n+  const buildAndTest = await fs.promises.readFile(buildAndTestPath, 'utf8')\n+  await fs.promises.writeFile(\n+    buildAndTestPath,\n+    buildAndTest.replace(`['canary']`, `['${branchName}']`)\n+  )\n+\n+  await execa(`git add .`, {\n+    stdio: 'inherit',\n+    shell: true,\n+  })\n+  await execa(`git commit -m \"setup release branch\"`, {\n+    stdio: 'inherit',\n+    shell: true,\n+  })\n+  await execa(`git push origin \"${branchName}\"`, {\n+    stdio: 'inherit',\n+    shell: true,\n+  })\n+\n+  console.log(`Waiting 5s before updating branch rules`)\n+  await new Promise((resolve) => setTimeout(resolve, 5_000))\n+\n+  const updateEnvironmentRes = await fetch(\n+    'https://api.github.com/repos/vercel/next.js/environments/release-stable/deployment-branch-policies',\n+    {\n+      method: 'POST',\n+      headers: {\n+        Accept: 'application/vnd.github+json',\n+        Authorization: `Bearer ${githubToken}`,\n+        'X-GitHub-Api-Version': '2022-11-28',\n+      },\n+      body: JSON.stringify({ name: branchName }),\n+    }\n+  )\n+\n+  if (!updateEnvironmentRes.ok) {\n+    console.error(\n+      { status: updateEnvironmentRes.status },\n+      await updateEnvironmentRes.text()\n+    )\n+    throw new Error(`Failed to update environment branch rules`)\n+  }\n+  console.log(`Successfully updated deployment environment branch rules`)\n+}\n+\n+main()"
        }
    ],
    "stats": {
        "total": 206,
        "additions": 206,
        "deletions": 0
    }
}