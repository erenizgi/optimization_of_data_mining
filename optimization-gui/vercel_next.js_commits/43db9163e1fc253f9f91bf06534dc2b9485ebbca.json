{
    "author": "sokra",
    "message": "Turbopack: fix race condition in test case (#82728)\n\n### What?\n\nFixes a race condition in the test case.\n\nSince we are using a single value for multiple Vcs (via ReadRef::cell) the counter can have multiple invalidators.",
    "sha": "43db9163e1fc253f9f91bf06534dc2b9485ebbca",
    "files": [
        {
            "sha": "e0d905477e973411ab61b8d57eaa0d0e42dfe907",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/read_ref_cell.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/43db9163e1fc253f9f91bf06534dc2b9485ebbca/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fread_ref_cell.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/43db9163e1fc253f9f91bf06534dc2b9485ebbca/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fread_ref_cell.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Fread_ref_cell.rs?ref=43db9163e1fc253f9f91bf06534dc2b9485ebbca",
            "patch": "@@ -2,7 +2,7 @@\n #![feature(arbitrary_self_types_pointers)]\n #![allow(clippy::needless_return)] // clippy bug causes false positive\n \n-use std::sync::Mutex;\n+use std::{collections::HashSet, mem::take, sync::Mutex};\n \n use anyhow::Result;\n use turbo_tasks::{Invalidator, ReadRef, Vc, get_invalidator};\n@@ -14,7 +14,7 @@ static REGISTRATION: Registration = register!();\n async fn read_ref() {\n     run(&REGISTRATION, || async {\n         let counter = Counter::cell(Counter {\n-            value: Mutex::new((0, None)),\n+            value: Mutex::new((0, Default::default())),\n         });\n \n         let counter_value = counter.get_value();\n@@ -55,14 +55,14 @@ struct CounterValue(usize);\n #[turbo_tasks::value(serialization = \"none\", cell = \"new\", eq = \"manual\")]\n struct Counter {\n     #[turbo_tasks(debug_ignore, trace_ignore)]\n-    value: Mutex<(usize, Option<Invalidator>)>,\n+    value: Mutex<(usize, HashSet<Invalidator>)>,\n }\n \n impl Counter {\n     fn incr(&self) {\n         let mut lock = self.value.lock().unwrap();\n         lock.0 += 1;\n-        if let Some(i) = lock.1.take() {\n+        for i in take(&mut lock.1) {\n             i.invalidate();\n         }\n     }\n@@ -73,7 +73,7 @@ impl Counter {\n     #[turbo_tasks::function]\n     fn get_value(&self) -> Result<Vc<CounterValue>> {\n         let mut lock = self.value.lock().unwrap();\n-        lock.1 = Some(get_invalidator());\n+        lock.1.insert(get_invalidator());\n         Ok(Vc::cell(lock.0))\n     }\n }"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 5,
        "deletions": 5
    }
}