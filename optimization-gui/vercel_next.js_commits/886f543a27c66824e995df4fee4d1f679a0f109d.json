{
    "author": "wyattjoh",
    "message": "fix(ppr): fix prerender info matching for rewritten paths (#83359)\n\n## What?\n\nFixed prerender info matching for rewritten paths in App Router by using\n`resolvedPathname` instead of `parsedUrl.pathname` in the app-page\ntemplate.\n\n## Why?\n\nPreviously, the app-page template used `parsedUrl.pathname` to match\nagainst `prerenderManifest` routes. However, when middleware rewrites\npaths, `parsedUrl.pathname` contains the original (unrewritten) path,\nwhile `resolvedPathname` contains the actual path that should be used\nfor prerender lookup.\n\nThis mismatch caused incorrect prerender behavior for routes that were\nrewritten by middleware, as the handler would look up prerender info\nusing the wrong path.\n\nThis handling is special cased for when not handling an interception\nroute when cache components is not enabled. This work is being tracked\nin NAR-335.\n\n## How?\n\n- **Modified `packages/next/src/build/templates/app-page.ts`**: \n  - Removed unused `parsedUrl` parameter from handler function\n- Updated prerender info matching to use `resolvedPathname` instead of\n`parsedUrl.pathname`\n- Added explanatory comment about why `resolvedPathname` is the correct\nchoice\n\n- **Added comprehensive test suite** in\n`test/e2e/app-dir/sub-shell-generation-middleware/`:\n  - Tests various middleware rewrite scenarios\n  - Validates sub-shell generation behavior with nested dynamic routes\n  - Tests both static and dynamic prerender scenarios\n- Includes middleware that rewrites paths to different route structures\n\n- **Enhanced deploy testing** in `test/lib/next-modes/next-deploy.ts`:\n  - Added `stderr: 'inherit'` to provide earlier deployment feedback\n  - Improves debugging experience for deployment-related tests\n\nThe fix ensures that prerender info lookup works correctly for all\npaths, whether they're rewritten by middleware or not, providing\nconsistent behavior across different routing scenarios.\n\nFixes #83354",
    "sha": "886f543a27c66824e995df4fee4d1f679a0f109d",
    "files": [
        {
            "sha": "d636182649adf1ad74e693dd682a2e35342f01af",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -89,6 +89,7 @@ import * as entryBase from '../../server/app-render/entry-base' with { 'turbopac\n import { RedirectStatusCode } from '../../client/components/redirect-status-code'\n import { InvariantError } from '../../shared/lib/invariant-error'\n import { scheduleOnNextTick } from '../../lib/scheduler'\n+import { isInterceptionRouteAppPath } from '../../shared/lib/router/utils/interception-routes'\n \n export * from '../../server/app-render/entry-base' with { 'turbopack-transition': 'next-server-utility' }\n \n@@ -150,7 +151,6 @@ export async function handler(\n     buildId,\n     query,\n     params,\n-    parsedUrl,\n     pageIsDynamic,\n     buildManifest,\n     nextFontManifest,\n@@ -167,12 +167,24 @@ export async function handler(\n     interceptionRoutePatterns,\n   } = prepareResult\n \n-  const pathname = parsedUrl.pathname || '/'\n   const normalizedSrcPage = normalizeAppPath(srcPage)\n \n   let { isOnDemandRevalidate } = prepareResult\n \n-  const prerenderInfo = routeModule.match(pathname, prerenderManifest)\n+  // We use the resolvedPathname instead of the parsedUrl.pathname because it\n+  // is not rewritten as resolvedPathname is. This will ensure that the correct\n+  // prerender info is used instead of using the original pathname as the\n+  // source. If however PPR is enabled and cacheComponents is disabled, we\n+  // treat the pathname as dynamic. Currently, there's a bug in the PPR\n+  // implementation that incorrectly leaves %%drp placeholders in the output of\n+  // parallel routes. This is addressed with cacheComponents.\n+  const prerenderInfo =\n+    nextConfig.experimental.ppr &&\n+    !nextConfig.experimental.cacheComponents &&\n+    isInterceptionRouteAppPath(resolvedPathname)\n+      ? null\n+      : routeModule.match(resolvedPathname, prerenderManifest)\n+\n   const isPrerendered = !!prerenderManifest.routes[resolvedPathname]\n \n   const userAgent = req.headers['user-agent'] || ''"
        },
        {
            "sha": "dc40de07226a76b370bb6a3072462f7ec09ae14e",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/[third]/layout.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Flayout.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,20 @@\n+import { Suspense } from 'react'\n+import SharedComponent from '../../../shared'\n+\n+export default async function ThirdLayout({\n+  children,\n+  params,\n+}: {\n+  children: React.ReactNode\n+  params: Promise<Record<string, string>>\n+}) {\n+  const current = await params\n+\n+  return (\n+    <>\n+      <pre>{JSON.stringify(current)}</pre>\n+      <SharedComponent layout={`/[first]/[second]/[third]`} />\n+      <Suspense>{children}</Suspense>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "7109986a87585f7ff4c10e54a82dd60b258bbd39",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/[third]/page.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2F%5Bthird%5D%2Fpage.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,16 @@\n+export default async function NotRewritePage({\n+  params,\n+}: {\n+  params: Promise<{ first: string; second: string; third: string }>\n+}) {\n+  const { first, second, third } = await params\n+  return (\n+    <div data-slug={`${first}/${second}/${third}`}>\n+      Page /{first}/{second}/{third}\n+    </div>\n+  )\n+}\n+\n+export async function generateStaticParams() {\n+  return [{ first: 'first', second: 'second', third: 'third' }]\n+}"
        },
        {
            "sha": "17d0144b87bd74979d7bfd08200e98705cac95b1",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/[second]/layout.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%5Bsecond%5D%2Flayout.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,20 @@\n+import { Suspense } from 'react'\n+import SharedComponent from '../../shared'\n+\n+export default async function SecondLayout({\n+  children,\n+  params,\n+}: {\n+  children: React.ReactNode\n+  params: Promise<Record<string, string>>\n+}) {\n+  const current = await params\n+\n+  return (\n+    <>\n+      <pre>{JSON.stringify(current)}</pre>\n+      <SharedComponent layout={`/[first]/[second]`} />\n+      <Suspense>{children}</Suspense>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "08b2c52dfc8923295660b43eeaf21e5cdcd97fd1",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/layout.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2Flayout.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,20 @@\n+import { Suspense } from 'react'\n+import SharedComponent from '../shared'\n+\n+export default async function FirstLayout({\n+  children,\n+  params,\n+}: {\n+  children: React.ReactNode\n+  params: Promise<Record<string, string>>\n+}) {\n+  const current = await params\n+\n+  return (\n+    <>\n+      <pre>{JSON.stringify(current)}</pre>\n+      <SharedComponent layout={`/[first]`} />\n+      <Suspense>{children}</Suspense>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "6a86e06b20ddd1f50899b87b73ac825a1837175e",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Flayout.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,13 @@\n+import { type ReactNode, Suspense } from 'react'\n+import SharedComponent from './shared'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <SharedComponent layout=\"/\" />\n+        <Suspense fallback={<div>Loading...</div>}>{children}</Suspense>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fpage.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "3d71bdb00f2267326ae16c81c9ca5a84d99a62b3",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/[slug]/layout.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2F%5Bslug%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2F%5Bslug%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2F%5Bslug%5D%2Flayout.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,20 @@\n+import { Suspense } from 'react'\n+import SharedComponent from '../../shared'\n+\n+export default async function RewriteSlugLayout({\n+  children,\n+  params,\n+}: {\n+  params: Promise<Record<string, string>>\n+  children: React.ReactNode\n+}) {\n+  const current = await params\n+\n+  return (\n+    <>\n+      <pre>{JSON.stringify(current)}</pre>\n+      <SharedComponent layout={`/rewrite/[slug]`} />\n+      <Suspense>{children}</Suspense>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "e2ec0be795854d4f32dc4acb95aeb7c60b226e5c",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/[slug]/page.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2F%5Bslug%5D%2Fpage.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,12 @@\n+export default async function RewritePage({\n+  params,\n+}: {\n+  params: Promise<{ slug: string }>\n+}) {\n+  const { slug } = await params\n+  return <div data-rewrite-slug={slug}>Page /rewrite/{slug}</div>\n+}\n+\n+export async function generateStaticParams() {\n+  return []\n+}"
        },
        {
            "sha": "f1e80574e3fa827627ff622a2694eabd63f8e04f",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/rewrite/layout.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Frewrite%2Flayout.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,20 @@\n+import { Suspense } from 'react'\n+import SharedComponent from '../shared'\n+\n+export default async function RewriteLayout({\n+  children,\n+  params,\n+}: {\n+  params: Promise<Record<string, string>>\n+  children: React.ReactNode\n+}) {\n+  const current = await params\n+\n+  return (\n+    <div>\n+      <pre>{JSON.stringify(current)}</pre>\n+      <SharedComponent layout={`/rewrite`} />\n+      <Suspense>{children}</Suspense>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "831ddb0a16d79acc7531722e4ee72461866373a5",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/shared.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fshared.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fshared.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fshared.tsx?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,19 @@\n+const { PHASE_PRODUCTION_BUILD } = require('next/constants')\n+\n+function getSentinelValue() {\n+  return process.env.NEXT_PHASE === PHASE_PRODUCTION_BUILD\n+    ? 'buildtime'\n+    : 'runtime'\n+}\n+\n+type Props = {\n+  layout: string\n+}\n+\n+export default function SharedComponent({ layout }: Props) {\n+  return (\n+    <div data-layout={layout} data-sentinel={getSentinelValue()}>\n+      SharedComponent {layout} â†’ {getSentinelValue()}\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "0889cab36a8124494615019ada33a52eccaf65da",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/middleware.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fmiddleware.ts?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,17 @@\n+import { type NextRequest, NextResponse } from 'next/server'\n+\n+export const middleware = (request: NextRequest) => {\n+  if (request.nextUrl.pathname.includes('/not-broken')) {\n+    const destination = new URL(\n+      '/rewrite' + request.nextUrl.pathname + request.nextUrl.search,\n+      request.url\n+    )\n+\n+    return NextResponse.rewrite(destination)\n+  }\n+  return NextResponse.next()\n+}\n+\n+export const config = {\n+  matcher: ['/not-broken'],\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fnext.config.js?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "386c0d6c488221e218f73607d18f9ccaf1b68a53",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/sub-shell-generation-middleware.test.ts",
            "status": "added",
            "additions": 167,
            "deletions": 0,
            "changes": 167,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fsub-shell-generation-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fsub-shell-generation-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fsub-shell-generation-middleware.test.ts?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -0,0 +1,167 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import * as cheerio from 'cheerio'\n+import { retry } from 'next-test-utils'\n+\n+describe('middleware-static-rewrite', () => {\n+  const { next, isNextDeploy, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  if (isNextDev) {\n+    it.skip('skipping dev test', () => {})\n+    return\n+  }\n+\n+  if (\n+    process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true' ||\n+    process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n+  ) {\n+    // Here we're validating that the correct fallback shell was used for\n+    // rendering.\n+    it('should use the correct fallback route', async () => {\n+      // First try to load a page that'll use the base fallback route with the\n+      // `/[first]/[second]/[third]` fallback.\n+      let $ = await next.render$('/first/second/third')\n+\n+      expect($('[data-slug]').data('slug')).toBe('first/second/third')\n+\n+      // Get the sentinel value that was generated at build time or runtime.\n+      expect($('[data-layout=\"/\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/[first]\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/[first]/[second]\"]').data('sentinel')).toBe(\n+        'buildtime'\n+      )\n+      expect(\n+        $('[data-layout=\"/[first]/[second]/[third]\"]').data('sentinel')\n+      ).toBe('buildtime')\n+\n+      // Then we try to load a page that'll use the `/first/second/[third]`\n+      // fallback.\n+      $ = await next.render$('/first/second/not-third')\n+\n+      expect($('[data-slug]').data('slug')).toBe('first/second/not-third')\n+\n+      expect($('[data-layout=\"/\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/[first]\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/[first]/[second]\"]').data('sentinel')).toBe(\n+        'buildtime'\n+      )\n+      expect(\n+        $('[data-layout=\"/[first]/[second]/[third]\"]').data('sentinel')\n+      ).toBe('runtime')\n+\n+      // Then we try to load a page that'll use the `/first/[second]/[third]`\n+      $ = await next.render$('/first/not-second/not-third')\n+\n+      expect($('[data-slug]').data('slug')).toBe('first/not-second/not-third')\n+\n+      expect($('[data-layout=\"/\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/[first]\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/[first]/[second]\"]').data('sentinel')).toBe(\n+        'runtime'\n+      )\n+      expect(\n+        $('[data-layout=\"/[first]/[second]/[third]\"]').data('sentinel')\n+      ).toBe('runtime')\n+\n+      // Then we try to load a page that'll use the `/[first]/[second]/[third]`\n+      $ = await next.render$('/not-first/not-second/not-third')\n+\n+      expect($('[data-slug]').data('slug')).toBe(\n+        'not-first/not-second/not-third'\n+      )\n+\n+      expect($('[data-layout=\"/\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/[first]\"]').data('sentinel')).toBe('runtime')\n+      expect($('[data-layout=\"/[first]/[second]\"]').data('sentinel')).toBe(\n+        'runtime'\n+      )\n+      expect(\n+        $('[data-layout=\"/[first]/[second]/[third]\"]').data('sentinel')\n+      ).toBe('runtime')\n+    })\n+\n+    it('should handle middleware rewrites as well', async () => {\n+      let res = await next.fetch('/not-broken')\n+\n+      expect(res.status).toBe(200)\n+\n+      if (isNextDeploy) {\n+        expect(res.headers.get('x-vercel-cache')).toMatch(/MISS|HIT|PRERENDER/)\n+      } else {\n+        expect(res.headers.get('x-nextjs-cache')).toBe(null)\n+      }\n+\n+      let html = await res.text()\n+      let $ = cheerio.load(html)\n+\n+      expect($('[data-layout=\"/\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/rewrite\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/rewrite/[slug]\"]').data('sentinel')).toBe(\n+        'runtime'\n+      )\n+\n+      await retry(async () => {\n+        res = await next.fetch('/not-broken')\n+\n+        expect(res.status).toBe(200)\n+        if (isNextDeploy) {\n+          expect(res.headers.get('x-vercel-cache')).toBe('HIT')\n+        } else {\n+          expect(res.headers.get('x-nextjs-cache')).toBe(null)\n+        }\n+      })\n+\n+      html = await res.text()\n+      $ = cheerio.load(html)\n+\n+      expect($('[data-rewrite-slug]').data('rewrite-slug')).toBe('not-broken')\n+\n+      expect($('[data-layout=\"/\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/rewrite\"]').data('sentinel')).toBe('buildtime')\n+      expect($('[data-layout=\"/rewrite/[slug]\"]').data('sentinel')).toBe(\n+        'runtime'\n+      )\n+    })\n+  } else {\n+    // Here we're validating that there is a static page generated for the\n+    // rewritten path.\n+    it('should eventually result in a cache hit', async () => {\n+      let res = await next.fetch('/not-broken')\n+\n+      expect(res.status).toBe(200)\n+      expect(\n+        res.headers.get(isNextDeploy ? 'x-vercel-cache' : 'x-nextjs-cache')\n+      ).toMatch(/MISS|HIT|PRERENDER/)\n+\n+      let html = await res.text()\n+      let $ = cheerio.load(html)\n+\n+      expect($('[data-layout=\"/\"]').data('sentinel')).toBe('runtime')\n+      expect($('[data-layout=\"/rewrite\"]').data('sentinel')).toBe('runtime')\n+      expect($('[data-layout=\"/rewrite/[slug]\"]').data('sentinel')).toBe(\n+        'runtime'\n+      )\n+\n+      await retry(async () => {\n+        res = await next.fetch('/not-broken')\n+\n+        expect(res.status).toBe(200)\n+        expect(\n+          res.headers.get(isNextDeploy ? 'x-vercel-cache' : 'x-nextjs-cache')\n+        ).toBe('HIT')\n+      })\n+\n+      html = await res.text()\n+      $ = cheerio.load(html)\n+\n+      expect($('[data-rewrite-slug]').data('rewrite-slug')).toBe('not-broken')\n+\n+      expect($('[data-layout=\"/\"]').data('sentinel')).toBe('runtime')\n+      expect($('[data-layout=\"/rewrite\"]').data('sentinel')).toBe('runtime')\n+      expect($('[data-layout=\"/rewrite/[slug]\"]').data('sentinel')).toBe(\n+        'runtime'\n+      )\n+    })\n+  }\n+})"
        },
        {
            "sha": "e69b9ede98272a283191b315d505b055a170762b",
            "filename": "test/lib/next-modes/next-deploy.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/886f543a27c66824e995df4fee4d1f679a0f109d/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-deploy.ts?ref=886f543a27c66824e995df4fee4d1f679a0f109d",
            "patch": "@@ -120,6 +120,10 @@ export class NextDeployInstance extends NextInstance {\n         cwd: this.testDir,\n         env: vercelEnv,\n         reject: false,\n+        // This will print deployment information earlier to the console so we\n+        // don't have to wait until the deployment is complete to get the\n+        // inspect URL.\n+        stderr: 'inherit',\n       }\n     )\n "
        }
    ],
    "stats": {
        "total": 375,
        "additions": 372,
        "deletions": 3
    }
}