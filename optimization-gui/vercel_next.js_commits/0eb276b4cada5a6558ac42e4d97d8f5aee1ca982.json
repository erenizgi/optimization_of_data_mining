{
    "author": "timneutkens",
    "message": "Turbopack Build: Fix edge _document test (#79628)\n\n## What?\n\nCurrently there's a specific case when you set `runtime:\n'experimental-edge'` for `_document.js` or `_app.js` where we\nincorrectly write a bundle that is wrapped with the route handling code\nto disk. This in turn causes `_document.js` to break during\nprerendering. Seems no users ran into this one yet since it was\nexperimental. This change ensures that we always write the module code\nfor _app / _document instead. This has no negative effect on edge\nruntime modules because those include the direct imports for _app /\n_document already in the single route module.",
    "sha": "0eb276b4cada5a6558ac42e4d97d8f5aee1ca982",
    "files": [
        {
            "sha": "469318da31d9dd5d69aa7ac8cae4f82119f2c9b3",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 28,
            "deletions": 25,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/0eb276b4cada5a6558ac42e4d97d8f5aee1ca982/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0eb276b4cada5a6558ac42e4d97d8f5aee1ca982/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=0eb276b4cada5a6558ac42e4d97d8f5aee1ca982",
            "patch": "@@ -907,36 +907,39 @@ impl PageEndpoint {\n             .module();\n \n         let config = parse_config_from_source(ssr_module, NextRuntime::default()).await?;\n-        Ok(if config.runtime == NextRuntime::Edge {\n-            let modules = create_page_ssr_entry_module(\n-                *this.pathname,\n-                reference_type,\n-                project_root,\n-                Vc::upcast(edge_module_context),\n-                self.source(),\n-                *this.original_name,\n-                *this.pages_structure,\n-                config.runtime,\n-                this.pages_project.project().next_config(),\n-            )\n-            .await?;\n-\n-            InternalSsrChunkModule {\n-                ssr_module: modules.ssr_module,\n-                app_module: modules.app_module,\n-                document_module: modules.document_module,\n-                runtime: config.runtime,\n-            }\n-        } else {\n-            let pathname = &**this.pathname.await?;\n+        let pathname = &**this.pathname.await?;\n \n+        Ok(\n             // `/_app` and `/_document` never get rendered directly so they don't need to be\n-            // wrapped in the route module.\n+            // wrapped in the route module, and don't need to be handled as edge runtime as the\n+            // rendering for edge is part of the page bundle.\n             if pathname == \"/_app\" || pathname == \"/_document\" {\n                 InternalSsrChunkModule {\n                     ssr_module: ssr_module.to_resolved().await?,\n                     app_module: None,\n                     document_module: None,\n+                    // /_app and /_document are always rendered for Node.js for this case. For edge\n+                    // they're included in the page bundle.\n+                    runtime: NextRuntime::NodeJs,\n+                }\n+            } else if config.runtime == NextRuntime::Edge {\n+                let modules = create_page_ssr_entry_module(\n+                    *this.pathname,\n+                    reference_type,\n+                    project_root,\n+                    Vc::upcast(edge_module_context),\n+                    self.source(),\n+                    *this.original_name,\n+                    *this.pages_structure,\n+                    config.runtime,\n+                    this.pages_project.project().next_config(),\n+                )\n+                .await?;\n+\n+                InternalSsrChunkModule {\n+                    ssr_module: modules.ssr_module,\n+                    app_module: modules.app_module,\n+                    document_module: modules.document_module,\n                     runtime: config.runtime,\n                 }\n             } else {\n@@ -959,8 +962,8 @@ impl PageEndpoint {\n                     runtime: config.runtime,\n                 }\n             }\n-        }\n-        .cell())\n+            .cell(),\n+        )\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "e3c19eeaffa5e961570f496638f8b810899788f9",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/0eb276b4cada5a6558ac42e4d97d8f5aee1ca982/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/0eb276b4cada5a6558ac42e4d97d8f5aee1ca982/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=0eb276b4cada5a6558ac42e4d97d8f5aee1ca982",
            "patch": "@@ -6544,10 +6544,10 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/edge-pages-support/edge-document.test.ts\": {\n-    \"passed\": [],\n-    \"failed\": [\n+    \"passed\": [\n       \"edge render - custom _document with edge runtime should render page properly\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 30,
        "deletions": 27
    }
}