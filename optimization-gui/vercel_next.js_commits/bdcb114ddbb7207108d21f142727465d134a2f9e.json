{
    "author": "mischnic",
    "message": "Turbopack: fix export-all-as with name collision (#81510)\n\n`EcmascriptModulePartReference` is a pretty counterintuitive reference. The `part` declares which module should be synthesised on the other side. That doesn't have anything to do with which exports are actually being imported by reference.\r\n\r\nThis only triggered a bug when these exports here had the same name by coincidence\r\n```js\r\n// reexport.js\r\nexport * as Sub from './sub.js' // <--\r\n// sub.js\r\nexport const Sub = 123 // <-- \r\n```",
    "sha": "bdcb114ddbb7207108d21f142727465d134a2f9e",
    "files": [
        {
            "sha": "75570846ddfa88ecc0042f1c33b453e1f5fe3b40",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/reference.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 13,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs?ref=bdcb114ddbb7207108d21f142727465d134a2f9e",
            "patch": "@@ -173,25 +173,17 @@ impl EcmascriptModulePartReference {\n             ));\n         }\n \n-        if merged_index.is_some() && matches!(*this.export_usage.await?, ExportUsage::Evaluation) {\n+        let export_usage = this.export_usage.await?;\n+        if merged_index.is_some() && matches!(*export_usage, ExportUsage::Evaluation) {\n             // No need to import, the module was already executed and is available in the same scope\n             // hoisting group (unless it's a namespace import)\n         } else {\n             let ident = referenced_asset\n                 .get_ident(\n                     chunking_context,\n-                    match &this.part {\n-                        ModulePart::Export(export)\n-                        | ModulePart::RenamedExport {\n-                            original_export: export,\n-                            ..\n-                        }\n-                        | ModulePart::RenamedNamespace { export } => Some(export.clone()),\n-                        ModulePart::Internal(_)\n-                        | ModulePart::Locals\n-                        | ModulePart::Exports\n-                        | ModulePart::Facade\n-                        | ModulePart::Evaluation => None,\n+                    match &*export_usage {\n+                        ExportUsage::Named(export) => Some(export.clone()),\n+                        ExportUsage::All | ExportUsage::Evaluation => None,\n                     },\n                     scope_hoisting_context,\n                 )"
        },
        {
            "sha": "92ee7a10b361dfa6b37c199240f88a9338e1f03a",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/reexport-all-as/input/index.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Findex.js?ref=bdcb114ddbb7207108d21f142727465d134a2f9e",
            "patch": "@@ -0,0 +1,5 @@\n+import { Sub } from 'package'\n+\n+it('should have the correct value', () => {\n+  expect(Sub).toMatchObject({ Sub: 123 })\n+})"
        },
        {
            "sha": "b6f8cf34a832c8512ed8eb871c77c7700a2cdf91",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/reexport-all-as/input/node_modules/package/index.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Findex.js?ref=bdcb114ddbb7207108d21f142727465d134a2f9e",
            "patch": "@@ -0,0 +1 @@\n+export * as Sub from './sub.js'"
        },
        {
            "sha": "a43829151e1423f0641beb1f114773f1c67fda72",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/reexport-all-as/input/node_modules/package/package.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Fpackage.json?ref=bdcb114ddbb7207108d21f142727465d134a2f9e",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"sideEffects\": false\n+}"
        },
        {
            "sha": "bbf587cf74dd9cb56aa754fe6c2293231b30a1a9",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/reexport-all-as/input/node_modules/package/sub.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Fsub.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Fsub.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Finput%2Fnode_modules%2Fpackage%2Fsub.js?ref=bdcb114ddbb7207108d21f142727465d134a2f9e",
            "patch": "@@ -0,0 +1 @@\n+export const Sub = 123"
        },
        {
            "sha": "af13697f09f935e9c18c212c95296a9187fde3eb",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/scope-hoisting/reexport-all-as/options.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Foptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/bdcb114ddbb7207108d21f142727465d134a2f9e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Foptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fscope-hoisting%2Freexport-all-as%2Foptions.json?ref=bdcb114ddbb7207108d21f142727465d134a2f9e",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"treeShakingMode\": \"reexports-only\"\n+}"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 18,
        "deletions": 13
    }
}