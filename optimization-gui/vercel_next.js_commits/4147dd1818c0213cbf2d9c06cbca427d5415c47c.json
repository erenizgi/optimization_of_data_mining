{
    "author": "unstubbable",
    "message": "Do not call `expireTags`/`getExpiration` unnecessarily (#77570)\n\n- At the end of a request, or after a server action, when no tags were revalidated, we should not call the `expireTags` method of the configured cache handlers.\r\n- After a server action, when no implicit tags were revalidated, we should not call the `getExpiration` method of the configured cache handlers.",
    "sha": "4147dd1818c0213cbf2d9c06cbca427d5415c47c",
    "files": [
        {
            "sha": "be62bf764533ed7dfdcb413de4982964c5f298e2",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/4147dd1818c0213cbf2d9c06cbca427d5415c47c/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4147dd1818c0213cbf2d9c06cbca427d5415c47c/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=4147dd1818c0213cbf2d9c06cbca427d5415c47c",
            "patch": "@@ -260,6 +260,12 @@ export class IncrementalCache implements IncrementalCacheType {\n   }\n \n   async revalidateTag(tags: string | string[]): Promise<void> {\n+    tags = Array.isArray(tags) ? tags : [tags]\n+\n+    if (tags.length === 0) {\n+      return\n+    }\n+\n     const promises: Promise<void>[] = []\n \n     if (this.cacheHandler?.revalidateTag) {\n@@ -268,7 +274,6 @@ export class IncrementalCache implements IncrementalCacheType {\n \n     const handlers = getCacheHandlers()\n     if (handlers) {\n-      tags = Array.isArray(tags) ? tags : [tags]\n       for (const handler of handlers) {\n         promises.push(handler.expireTags(...tags))\n       }\n@@ -279,7 +284,11 @@ export class IncrementalCache implements IncrementalCacheType {\n     const workUnitStore = workUnitAsyncStorage.getStore()\n \n     if (workUnitStore?.implicitTags) {\n-      await updateImplicitTagsExpiration(workUnitStore.implicitTags)\n+      const tagsSet = new Set(tags)\n+\n+      if (workUnitStore.implicitTags.tags.some((tag) => tagsSet.has(tag))) {\n+        await updateImplicitTagsExpiration(workUnitStore.implicitTags)\n+      }\n     }\n   }\n "
        },
        {
            "sha": "e4adb4782953e2ac3df87f8caac1c9de638457ca",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/app/layout.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Flayout.tsx?ref=4147dd1818c0213cbf2d9c06cbca427d5415c47c",
            "patch": "@@ -1,8 +1,12 @@\n+import { Suspense } from 'react'\n+\n export default function RootLayout({ children }) {\n   return (\n     <html>\n       <head />\n-      <body>{children}</body>\n+      <body>\n+        <Suspense>{children}</Suspense>\n+      </body>\n     </html>\n   )\n }"
        },
        {
            "sha": "67c60b1382de125771a92530fb0da5efc6a86b48",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/app/legacy/page.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Flegacy%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Flegacy%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Flegacy%2Fpage.tsx?ref=4147dd1818c0213cbf2d9c06cbca427d5415c47c",
            "patch": "@@ -5,6 +5,8 @@ import {\n   revalidateTag,\n } from 'next/cache'\n import { redirect } from 'next/navigation'\n+import { connection } from 'next/server'\n+import React from 'react'\n \n async function getData() {\n   'use cache: legacy'\n@@ -21,7 +23,9 @@ async function AsyncComp() {\n   return <p id=\"data\">{data}</p>\n }\n \n-export default function Legacy() {\n+export default async function Legacy() {\n+  await connection()\n+\n   return (\n     <main>\n       <Suspense fallback={<p>Loading...</p>}>"
        },
        {
            "sha": "ce1c9b713c6d49f8f785afa59a0e8d76f24e2568",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/app/page.tsx",
            "status": "modified",
            "additions": 38,
            "deletions": 10,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fapp%2Fpage.tsx?ref=4147dd1818c0213cbf2d9c06cbca427d5415c47c",
            "patch": "@@ -2,9 +2,12 @@ import { Suspense } from 'react'\n import {\n   unstable_cacheLife as cacheLife,\n   unstable_cacheTag as cacheTag,\n+  revalidatePath,\n   revalidateTag,\n } from 'next/cache'\n import { redirect } from 'next/navigation'\n+import { connection } from 'next/server'\n+import React from 'react'\n \n async function getData() {\n   'use cache'\n@@ -21,21 +24,46 @@ async function AsyncComp() {\n   return <p id=\"data\">{data}</p>\n }\n \n-export default function Home() {\n+export default async function Home() {\n+  await connection()\n+\n   return (\n     <main>\n       <Suspense fallback={<p>Loading...</p>}>\n         <AsyncComp />\n       </Suspense>\n-      <form\n-        action={async () => {\n-          'use server'\n-\n-          revalidateTag('modern')\n-          redirect('/')\n-        }}\n-      >\n-        <button id=\"revalidate\">Revalidate Tag</button>\n+      <form>\n+        <button\n+          id=\"revalidate-tag\"\n+          formAction={async () => {\n+            'use server'\n+\n+            revalidateTag('modern')\n+          }}\n+        >\n+          Revalidate Tag\n+        </button>{' '}\n+        <button\n+          id=\"revalidate-path\"\n+          formAction={async () => {\n+            'use server'\n+\n+            revalidatePath('/')\n+          }}\n+        >\n+          Revalidate Path\n+        </button>{' '}\n+        <button\n+          id=\"revalidate-redirect\"\n+          formAction={async () => {\n+            'use server'\n+\n+            revalidateTag('modern')\n+            redirect('/')\n+          }}\n+        >\n+          Revalidate Tag & Redirect\n+        </button>\n       </form>\n     </main>\n   )"
        },
        {
            "sha": "9aa97cb4d7dda389709891e3b5af4fa289205780",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/handler.js",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fhandler.js?ref=4147dd1818c0213cbf2d9c06cbca427d5415c47c",
            "patch": "@@ -8,27 +8,27 @@ const defaultCacheHandler =\n  */\n const cacheHandler = {\n   async get(cacheKey) {\n-    console.log('CustomCacheHandler::get', cacheKey)\n+    console.log('ModernCustomCacheHandler::get', cacheKey)\n     return defaultCacheHandler.get(cacheKey)\n   },\n \n   async set(cacheKey, pendingEntry) {\n-    console.log('CustomCacheHandler::set', cacheKey)\n+    console.log('ModernCustomCacheHandler::set', cacheKey)\n     return defaultCacheHandler.set(cacheKey, pendingEntry)\n   },\n \n   async refreshTags() {\n-    console.log('CustomCacheHandler::refreshTags')\n+    console.log('ModernCustomCacheHandler::refreshTags')\n     return defaultCacheHandler.refreshTags()\n   },\n \n   async getExpiration(...tags) {\n-    console.log('CustomCacheHandler::getExpiration', JSON.stringify(tags))\n+    console.log('ModernCustomCacheHandler::getExpiration', JSON.stringify(tags))\n     return defaultCacheHandler.getExpiration(...tags)\n   },\n \n   async expireTags(...tags) {\n-    console.log('CustomCacheHandler::expireTags', JSON.stringify(tags))\n+    console.log('ModernCustomCacheHandler::expireTags', JSON.stringify(tags))\n     return defaultCacheHandler.expireTags(...tags)\n   },\n }"
        },
        {
            "sha": "e9e0632452e9fd90759d6e18039fd0c31a7cd589",
            "filename": "test/e2e/app-dir/use-cache-custom-handler/use-cache-custom-handler.test.ts",
            "status": "modified",
            "additions": 76,
            "deletions": 25,
            "changes": 101,
            "blob_url": "https://github.com/vercel/next.js/blob/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4147dd1818c0213cbf2d9c06cbca427d5415c47c/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-custom-handler%2Fuse-cache-custom-handler.test.ts?ref=4147dd1818c0213cbf2d9c06cbca427d5415c47c",
            "patch": "@@ -1,4 +1,4 @@\n-import { isNextStart, nextTestSetup } from 'e2e-utils'\n+import { nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n \n const isoDateRegExp = /^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z$/\n@@ -12,32 +12,31 @@ describe('use-cache-custom-handler', () => {\n \n   if (skipped) return\n \n-  it('should use a modern custom cache handler if provided', async () => {\n-    const outputIndex = next.cliOutput.length\n-    const browser = await next.browser(`/`)\n+  let outputIndex: number\n \n-    if (isNextStart) {\n-      // Refresh once to let it revalidate the prerendered page.\n-      await browser.refresh()\n-    }\n+  beforeEach(() => {\n+    outputIndex = next.cliOutput.length\n+  })\n \n+  it('should use a modern custom cache handler if provided', async () => {\n+    const browser = await next.browser(`/`)\n     const initialData = await browser.elementById('data').text()\n     expect(initialData).toMatch(isoDateRegExp)\n \n     expect(next.cliOutput.slice(outputIndex)).toContain(\n-      'CustomCacheHandler::refreshTags'\n+      'ModernCustomCacheHandler::refreshTags'\n     )\n \n     expect(next.cliOutput.slice(outputIndex)).toContain(\n-      `CustomCacheHandler::getExpiration [\"_N_T_/layout\",\"_N_T_/page\",\"_N_T_/\"]`\n+      `ModernCustomCacheHandler::getExpiration [\"_N_T_/layout\",\"_N_T_/page\",\"_N_T_/\"]`\n     )\n \n     expect(next.cliOutput.slice(outputIndex)).toMatch(\n-      /CustomCacheHandler::get \\[\"(development|[A-Za-z0-9_-]{21})\",\"\\$undefined\",\"([0-9a-f]{2})+\",\\[\\]\\]/\n+      /ModernCustomCacheHandler::get \\[\"(development|[A-Za-z0-9_-]{21})\",\"\\$undefined\",\"([0-9a-f]{2})+\",\\[\\]\\]/\n     )\n \n     expect(next.cliOutput.slice(outputIndex)).toMatch(\n-      /CustomCacheHandler::set \\[\"(development|[A-Za-z0-9_-]{21})\",\"\\$undefined\",\"([0-9a-f]{2})+\",\\[\\]\\]/\n+      /ModernCustomCacheHandler::set \\[\"(development|[A-Za-z0-9_-]{21})\",\"\\$undefined\",\"([0-9a-f]{2})+\",\\[\\]\\]/\n     )\n \n     // The data should be cached initially.\n@@ -59,14 +58,7 @@ describe('use-cache-custom-handler', () => {\n   })\n \n   it('should use a legacy custom cache handler if provided', async () => {\n-    const outputIndex = next.cliOutput.length\n     const browser = await next.browser(`/legacy`)\n-\n-    if (isNextStart) {\n-      // Refresh once to let it revalidate the prerendered page.\n-      await browser.refresh()\n-    }\n-\n     const initialData = await browser.elementById('data').text()\n     expect(initialData).toMatch(isoDateRegExp)\n \n@@ -100,17 +92,16 @@ describe('use-cache-custom-handler', () => {\n     }, 5000)\n   })\n \n-  it('should revalidate using a modern custom cache handler', async () => {\n-    const outputIndex = next.cliOutput.length\n+  it('should revalidate after redirect using a modern custom cache handler', async () => {\n     const browser = await next.browser(`/`)\n     const initialData = await browser.elementById('data').text()\n     expect(initialData).toMatch(isoDateRegExp)\n \n-    await browser.elementById('revalidate').click()\n+    await browser.elementById('revalidate-redirect').click()\n \n     await retry(async () => {\n       expect(next.cliOutput.slice(outputIndex)).toContain(\n-        'CustomCacheHandler::expireTags [\"modern\"]'\n+        'ModernCustomCacheHandler::expireTags [\"modern\"]'\n       )\n \n       const data = await browser.elementById('data').text()\n@@ -119,8 +110,7 @@ describe('use-cache-custom-handler', () => {\n     }, 5000)\n   })\n \n-  it('should revalidate using a legacy custom cache handler', async () => {\n-    const outputIndex = next.cliOutput.length\n+  it('should revalidate after redirect using a legacy custom cache handler', async () => {\n     const browser = await next.browser(`/legacy`)\n     const initialData = await browser.elementById('data').text()\n     expect(initialData).toMatch(isoDateRegExp)\n@@ -145,4 +135,65 @@ describe('use-cache-custom-handler', () => {\n       expect(data).not.toEqual(initialData)\n     }, 5000)\n   })\n+\n+  it('should not call expireTags for a normal invocation', async () => {\n+    await next.fetch(`/`)\n+\n+    await retry(async () => {\n+      const cliOutput = next.cliOutput.slice(outputIndex)\n+      expect(cliOutput).toInclude('ModernCustomCacheHandler::refreshTags')\n+      expect(cliOutput).toInclude('ModernCustomCacheHandler::getExpiration')\n+      expect(cliOutput).not.toInclude('ModernCustomCacheHandler::expireTags')\n+    })\n+  })\n+\n+  it('should not call getExpiration again after an action if only explicit tags were revalidated', async () => {\n+    const browser = await next.browser(`/`)\n+\n+    await retry(async () => {\n+      const cliOutput = next.cliOutput.slice(outputIndex)\n+      expect(cliOutput).toInclude('ModernCustomCacheHandler::getExpiration')\n+    })\n+\n+    outputIndex = next.cliOutput.length\n+\n+    await browser.elementById('revalidate-tag').click()\n+\n+    await retry(async () => {\n+      const cliOutput = next.cliOutput.slice(outputIndex)\n+      expect(cliOutput).toIncludeRepeated(\n+        'ModernCustomCacheHandler::getExpiration',\n+        1\n+      )\n+      expect(cliOutput).toIncludeRepeated(\n+        `ModernCustomCacheHandler::expireTags`,\n+        1\n+      )\n+    })\n+  })\n+\n+  it('should call getExpiration again after an action if implicit tags were revalidated', async () => {\n+    const browser = await next.browser(`/`)\n+\n+    await retry(async () => {\n+      const cliOutput = next.cliOutput.slice(outputIndex)\n+      expect(cliOutput).toInclude('ModernCustomCacheHandler::getExpiration')\n+    })\n+\n+    outputIndex = next.cliOutput.length\n+\n+    await browser.elementById('revalidate-path').click()\n+\n+    await retry(async () => {\n+      const cliOutput = next.cliOutput.slice(outputIndex)\n+      expect(cliOutput).toIncludeRepeated(\n+        'ModernCustomCacheHandler::expireTags',\n+        1\n+      )\n+      expect(cliOutput).toIncludeRepeated(\n+        'ModernCustomCacheHandler::getExpiration',\n+        2\n+      )\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 184,
        "additions": 140,
        "deletions": 44
    }
}