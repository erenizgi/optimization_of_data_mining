{
    "author": "mischnic",
    "message": "Turbopack: add a CLI to NFT (#82815)",
    "sha": "e02f66763b1bb192d7eaed5d92f70c1624084116",
    "files": [
        {
            "sha": "8f9b19e5a45870d87cb7c78487cf4b0e5e656b19",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/e02f66763b1bb192d7eaed5d92f70c1624084116/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/e02f66763b1bb192d7eaed5d92f70c1624084116/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=e02f66763b1bb192d7eaed5d92f70c1624084116",
            "patch": "@@ -9895,6 +9895,33 @@ dependencies = [\n  \"turbopack-ecmascript\",\n ]\n \n+[[package]]\n+name = \"turbopack-nft\"\n+version = \"0.1.0\"\n+dependencies = [\n+ \"anyhow\",\n+ \"clap\",\n+ \"console-subscriber\",\n+ \"rustc-hash 2.1.1\",\n+ \"serde\",\n+ \"swc_core\",\n+ \"tokio\",\n+ \"tracing\",\n+ \"tracing-subscriber\",\n+ \"turbo-rcstr\",\n+ \"turbo-tasks\",\n+ \"turbo-tasks-backend\",\n+ \"turbo-tasks-build\",\n+ \"turbo-tasks-env\",\n+ \"turbo-tasks-fs\",\n+ \"turbo-tasks-malloc\",\n+ \"turbopack\",\n+ \"turbopack-cli-utils\",\n+ \"turbopack-core\",\n+ \"turbopack-resolve\",\n+ \"turbopack-trace-utils\",\n+]\n+\n [[package]]\n name = \"turbopack-node\"\n version = \"0.1.0\""
        },
        {
            "sha": "77304075aa5f67a8a259aeb734dabcb69697284a",
            "filename": "turbopack/crates/turbopack-cli/src/main.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs?ref=e02f66763b1bb192d7eaed5d92f70c1624084116",
            "patch": "@@ -56,7 +56,7 @@ async fn main_inner(args: Arguments) -> Result<()> {\n     if let Some(mut trace) = trace.filter(|v| !v.is_empty()) {\n         // Trace presets\n         match trace.as_str() {\n-            \"overview\" => {\n+            \"overview\" | \"1\" => {\n                 trace = TRACING_OVERVIEW_TARGETS.join(\",\");\n             }\n             \"turbopack\" => {"
        },
        {
            "sha": "aecb5388a79883b37e658e38f8aa4e46df8eb22e",
            "filename": "turbopack/crates/turbopack-nft/Cargo.toml",
            "status": "added",
            "additions": 45,
            "deletions": 0,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2FCargo.toml?ref=e02f66763b1bb192d7eaed5d92f70c1624084116",
            "patch": "@@ -0,0 +1,45 @@\n+[package]\n+name = \"turbopack-nft\"\n+version = \"0.1.0\"\n+description = \"TBD\"\n+license = \"MIT\"\n+edition = \"2024\"\n+autobenches = false\n+\n+[[bin]]\n+name = \"turbopack-nft\"\n+path = \"src/main.rs\"\n+bench = false\n+\n+[lib]\n+bench = false\n+\n+[lints]\n+workspace = true\n+\n+[dependencies]\n+anyhow = { workspace = true, features = [\"backtrace\"] }\n+clap = { workspace = true, features = [\"derive\", \"env\"] }\n+console-subscriber = { workspace = true, optional = true }\n+rustc-hash = { workspace = true }\n+serde = { workspace = true }\n+swc_core = { workspace = true }\n+tokio = { workspace = true, features = [\"full\"] }\n+tracing = { workspace = true }\n+tracing-subscriber = { workspace = true, features = [\"json\"] }\n+turbo-rcstr = { workspace = true }\n+turbo-tasks = { workspace = true }\n+turbo-tasks-backend = { workspace = true }\n+turbo-tasks-env = { workspace = true }\n+turbo-tasks-fs = { workspace = true }\n+turbo-tasks-malloc = { workspace = true, default-features = false, features = [\n+    \"custom_allocator\"\n+] }\n+turbopack = { workspace = true }\n+turbopack-cli-utils = { workspace = true }\n+turbopack-core = { workspace = true }\n+turbopack-resolve = { workspace = true }\n+turbopack-trace-utils = { workspace = true }\n+\n+[build-dependencies]\n+turbo-tasks-build = { workspace = true }"
        },
        {
            "sha": "1673efed59cce6379c6a83d17829dfc0687e253f",
            "filename": "turbopack/crates/turbopack-nft/build.rs",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fbuild.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fbuild.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fbuild.rs?ref=e02f66763b1bb192d7eaed5d92f70c1624084116",
            "patch": "@@ -0,0 +1,5 @@\n+use turbo_tasks_build::generate_register;\n+\n+fn main() {\n+    generate_register();\n+}"
        },
        {
            "sha": "500383fa3d5587277ba538c54740707f6a43fc55",
            "filename": "turbopack/crates/turbopack-nft/src/README.md",
            "status": "added",
            "additions": 72,
            "deletions": 0,
            "changes": 72,
            "blob_url": "https://github.com/vercel/next.js/blob/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2FREADME.md",
            "raw_url": "https://github.com/vercel/next.js/raw/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2FREADME.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2FREADME.md?ref=e02f66763b1bb192d7eaed5d92f70c1624084116",
            "patch": "@@ -0,0 +1,72 @@\n+# turbopack-nft\n+\n+A CLI to test the NFT implementation, similar to `@vercel/nft`'s `nft print index.js` CLI.\n+\n+## Usage\n+\n+```\n+Usage: turbopack-nft [OPTIONS] <ENTRY>\n+\n+Arguments:\n+  <ENTRY>\n+\n+Options:\n+      --graph\n+      --show-issues\n+  -h, --help         Print help\n+  -V, --version      Print version\n+```\n+\n+Use no arguments to print a list of all files referenced (but not necessarily bundled!) by the entry.\n+\n+```\n+$ cargo run -p turbopack-nft bench/heavy-npm-deps/app/page.js\n+FILELIST:\n+bench/heavy-npm-deps/app/page.js\n+bench/heavy-npm-deps/components/lodash.js\n+bench/heavy-npm-deps/node_modules/lodash-es\n+bench/heavy-npm-deps/package.json\n+node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/_DataView.js\n+node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/_Hash.js\n+node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/_LazyWrapper.js\n+node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/_ListCache.js\n+node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/_LodashWrapper.js\n+node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/_Map.js\n+```\n+\n+Use `--graph` to print a crude visualization of the module graph to determine why certain files were included:\n+```\n+$ cargo run -p turbopack-nft bench/heavy-npm-deps/app/page.js --graph\n+FILELIST:\n+[workspace]/bench/heavy-npm-deps/app/page.js\n+  [workspace]/bench/heavy-npm-deps/components/lodash.js\n+    [workspace]/node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/package.json\n+    [workspace]/bench/heavy-npm-deps/node_modules/lodash-es\n+    [workspace]/node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/lodash.js\n+      [workspace]/node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/add.js\n+        [workspace]/node_modules/.pnpm/lodash-es@4.17.21/node_modules/lodash-es/_createMathOperation.js\n+```\n+\n+\n+By default, no warnings and errors are printed (aligning with the Next.js Turbopack behavior which silences any tracing warnings in node_modules as they are non-actionable anyway), but can be enabled with `--show-issues`:\n+```\n+$ cargo run -p turbopack-nft ... --show-issues\n+[workspace]/packages/next/dist/build/jest/jest.js\n+  [workspace]/packages/next/dist/build/jest/jest.js:101:15  Module not found: Can't resolve <dynamic>\n+\n+      97 |         });\n+      98 |     }\n+      99 |     var mainPath = attempts === 1 ? './' : Array(attempts).join('../');\n+      100 |     try {\n+          +                v------------------------------------------------------v\n+      101 +         return require((0, _path.join)(dir, mainPath + 'package.json'));\n+          +                ^------------------------------------------------------^\n+      102 |     } catch (e) {\n+      103 |         return loadClosestPackageJson(dir, attempts + 1);\n+      104 |     }\n+      105 | }\n+\n+\n+FILELIST:\n+...\n+```"
        },
        {
            "sha": "647feb75e114607bbc2e23627e50c85067d79cb7",
            "filename": "turbopack/crates/turbopack-nft/src/lib.rs",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Flib.rs?ref=e02f66763b1bb192d7eaed5d92f70c1624084116",
            "patch": "@@ -0,0 +1,12 @@\n+#![feature(future_join)]\n+#![feature(min_specialization)]\n+#![feature(arbitrary_self_types)]\n+#![feature(arbitrary_self_types_pointers)]\n+\n+pub mod nft;\n+\n+pub fn register() {\n+    turbopack::register();\n+    turbopack_resolve::register();\n+    include!(concat!(env!(\"OUT_DIR\"), \"/register.rs\"));\n+}"
        },
        {
            "sha": "d0f90a91f95658644c0facde3ad0bcba7d4eda61",
            "filename": "turbopack/crates/turbopack-nft/src/main.rs",
            "status": "added",
            "additions": 111,
            "deletions": 0,
            "changes": 111,
            "blob_url": "https://github.com/vercel/next.js/blob/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs?ref=e02f66763b1bb192d7eaed5d92f70c1624084116",
            "patch": "@@ -0,0 +1,111 @@\n+#![feature(future_join)]\n+#![feature(min_specialization)]\n+\n+use std::env::current_dir;\n+\n+use anyhow::Result;\n+use clap::Parser;\n+use tracing_subscriber::{Registry, layer::SubscriberExt, util::SubscriberInitExt};\n+use turbo_tasks::{ReadConsistency, TurboTasks};\n+use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n+use turbo_tasks_malloc::TurboMalloc;\n+use turbopack_nft::{nft::node_file_trace, register};\n+use turbopack_trace_utils::{\n+    exit::ExitHandler,\n+    filter_layer::FilterLayer,\n+    raw_trace::RawTraceLayer,\n+    trace_writer::TraceWriter,\n+    tracing_presets::{\n+        TRACING_OVERVIEW_TARGETS, TRACING_TURBO_TASKS_TARGETS, TRACING_TURBOPACK_TARGETS,\n+    },\n+};\n+\n+#[derive(Debug, Parser)]\n+#[clap(author, version, about, long_about = None)]\n+pub struct Arguments {\n+    #[clap(value_parser)]\n+    pub entry: String,\n+\n+    #[clap(long)]\n+    pub graph: bool,\n+\n+    #[clap(long)]\n+    pub show_issues: bool,\n+}\n+\n+#[global_allocator]\n+static ALLOC: TurboMalloc = TurboMalloc;\n+\n+fn main() {\n+    let mut rt = tokio::runtime::Builder::new_multi_thread();\n+    rt.enable_all().disable_lifo_slot();\n+\n+    let args = Arguments::parse();\n+    rt.build().unwrap().block_on(main_inner(args)).unwrap();\n+}\n+\n+async fn main_inner(args: Arguments) -> Result<()> {\n+    let exit_handler = ExitHandler::listen();\n+\n+    let trace = std::env::var(\"TURBOPACK_TRACING\").ok();\n+    if let Some(mut trace) = trace.filter(|v| !v.is_empty()) {\n+        // Trace presets\n+        match trace.as_str() {\n+            \"overview\" | \"1\" => {\n+                trace = TRACING_OVERVIEW_TARGETS.join(\",\");\n+            }\n+            \"turbopack\" => {\n+                trace = TRACING_TURBOPACK_TARGETS.join(\",\");\n+            }\n+            \"turbo-tasks\" => {\n+                trace = TRACING_TURBO_TASKS_TARGETS.join(\",\");\n+            }\n+            _ => {}\n+        }\n+\n+        let subscriber = Registry::default();\n+\n+        let subscriber = subscriber.with(FilterLayer::try_new(&trace).unwrap());\n+\n+        let trace_file = current_dir()?.join(\"turbopack.log\");\n+        let trace_writer = std::fs::File::create(trace_file).unwrap();\n+        let (trace_writer, guard) = TraceWriter::new(trace_writer);\n+        let subscriber = subscriber.with(RawTraceLayer::new(trace_writer));\n+\n+        exit_handler\n+            .on_exit(async move { tokio::task::spawn_blocking(|| drop(guard)).await.unwrap() });\n+\n+        subscriber.init();\n+    }\n+\n+    register();\n+\n+    let tt = TurboTasks::new(TurboTasksBackend::new(\n+        BackendOptions {\n+            dependency_tracking: false,\n+            storage_mode: None,\n+            ..Default::default()\n+        },\n+        noop_backing_storage(),\n+    ));\n+\n+    let task = tt.spawn_once_task::<(), _>(async move {\n+        node_file_trace(\n+            current_dir()?.to_str().unwrap().into(),\n+            args.entry.into(),\n+            args.graph,\n+            args.show_issues,\n+        )\n+        .await?;\n+        Ok(Default::default())\n+    });\n+\n+    tt.wait_task_completion(task, ReadConsistency::Strong)\n+        .await?;\n+\n+    // Intentionally leak this `Arc`. Otherwise we'll waste time during process exit performing a\n+    // ton of drop calls.\n+    std::mem::forget(tt);\n+\n+    Ok(())\n+}"
        },
        {
            "sha": "4bb1c332470135ef255a6d46edca0cf67df81f03",
            "filename": "turbopack/crates/turbopack-nft/src/nft.rs",
            "status": "added",
            "additions": 153,
            "deletions": 0,
            "changes": 153,
            "blob_url": "https://github.com/vercel/next.js/blob/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e02f66763b1bb192d7eaed5d92f70c1624084116/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fnft.rs?ref=e02f66763b1bb192d7eaed5d92f70c1624084116",
            "patch": "@@ -0,0 +1,153 @@\n+use std::{collections::HashSet, env::current_dir, path::PathBuf};\n+\n+use anyhow::Result;\n+use turbo_rcstr::{RcStr, rcstr};\n+use turbo_tasks::{ResolvedVc, TransientInstance, TryJoinIterExt, ValueToString, Vc};\n+use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n+use turbopack::{\n+    ModuleAssetContext,\n+    module_options::{CssOptionsContext, EcmascriptOptionsContext, ModuleOptionsContext},\n+};\n+use turbopack_cli_utils::issue::{ConsoleUi, LogOptions};\n+use turbopack_core::{\n+    compile_time_info::CompileTimeInfo,\n+    context::AssetContext,\n+    environment::{Environment, ExecutionEnvironment, NodeJsEnvironment},\n+    file_source::FileSource,\n+    ident::Layer,\n+    issue::{IssueReporter, IssueSeverity, handle_issues},\n+    output::OutputAsset,\n+    reference::all_assets_from_entries,\n+    reference_type::ReferenceType,\n+    traced_asset::TracedAsset,\n+};\n+use turbopack_resolve::resolve_options_context::ResolveOptionsContext;\n+\n+pub async fn node_file_trace(\n+    project_root: RcStr,\n+    input: RcStr,\n+    graph: bool,\n+    show_issues: bool,\n+) -> Result<()> {\n+    let op = node_file_trace_operation(project_root.clone(), input.clone(), graph);\n+    let result = op.resolve_strongly_consistent().await?;\n+\n+    if show_issues {\n+        let issue_reporter: Vc<Box<dyn IssueReporter>> =\n+            Vc::upcast(ConsoleUi::new(TransientInstance::new(LogOptions {\n+                project_dir: PathBuf::from(project_root),\n+                current_dir: current_dir().unwrap(),\n+                show_all: true,\n+                log_detail: false,\n+                log_level: IssueSeverity::Hint,\n+            })));\n+\n+        handle_issues(op, issue_reporter, IssueSeverity::Error, None, None).await?;\n+    }\n+\n+    println!(\"FILELIST:\");\n+    for a in result.await? {\n+        println!(\"{a}\");\n+    }\n+\n+    Ok(())\n+}\n+\n+#[turbo_tasks::function(operation)]\n+async fn node_file_trace_operation(\n+    project_root: RcStr,\n+    input: RcStr,\n+    graph: bool,\n+) -> Result<Vc<Vec<RcStr>>> {\n+    let workspace_fs: Vc<Box<dyn FileSystem>> = Vc::upcast(DiskFileSystem::new(\n+        rcstr!(\"workspace\"),\n+        project_root.clone(),\n+    ));\n+    let input_dir = workspace_fs.root().owned().await?;\n+    let input = input_dir.join(&format!(\"{input}\"))?;\n+\n+    let source = FileSource::new(input);\n+    let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n+        NodeJsEnvironment::default().resolved_cell(),\n+    ));\n+    let module_asset_context = ModuleAssetContext::new(\n+        Default::default(),\n+        // This config should be kept in sync with\n+        // turbopack/crates/turbopack/tests/node-file-trace.rs and\n+        // turbopack/crates/turbopack/src/lib.rs\n+        CompileTimeInfo::new(environment),\n+        ModuleOptionsContext {\n+            ecmascript: EcmascriptOptionsContext {\n+                ..Default::default()\n+            },\n+            css: CssOptionsContext {\n+                enable_raw_css: true,\n+                ..Default::default()\n+            },\n+            // Environment is not passed in order to avoid downleveling JS / CSS for\n+            // node-file-trace.\n+            environment: None,\n+            ..Default::default()\n+        }\n+        .cell(),\n+        ResolveOptionsContext {\n+            enable_node_native_modules: true,\n+            enable_node_modules: Some(input_dir.clone()),\n+            custom_conditions: vec![rcstr!(\"node\")],\n+            loose_errors: true,\n+            ..Default::default()\n+        }\n+        .cell(),\n+        Layer::new(rcstr!(\"test\")),\n+    );\n+    let module = module_asset_context\n+        .process(Vc::upcast(source), ReferenceType::Undefined)\n+        .module();\n+\n+    let asset = TracedAsset::new(module).to_resolved().await?;\n+\n+    Ok(Vc::cell(if graph {\n+        to_graph(ResolvedVc::upcast(asset)).await?\n+    } else {\n+        to_list(ResolvedVc::upcast(asset)).await?\n+    }))\n+}\n+\n+async fn to_list(asset: ResolvedVc<Box<dyn OutputAsset>>) -> Result<Vec<RcStr>> {\n+    let mut assets = all_assets_from_entries(Vc::cell(vec![asset]))\n+        .await?\n+        .iter()\n+        .map(async |a| Ok(a.path().await?.path.clone()))\n+        .try_join()\n+        .await?;\n+    assets.sort();\n+    assets.dedup();\n+\n+    Ok(assets)\n+}\n+\n+async fn to_graph(asset: ResolvedVc<Box<dyn OutputAsset>>) -> Result<Vec<RcStr>> {\n+    let mut visited = HashSet::new();\n+    let mut queue = Vec::new();\n+    queue.push((0, asset));\n+\n+    let mut result = vec![];\n+    while let Some((depth, asset)) = queue.pop() {\n+        let references = asset.references().await?;\n+        let mut indent = String::new();\n+        for _ in 0..depth {\n+            indent.push_str(\"  \");\n+        }\n+        if visited.insert(asset) {\n+            for &asset in references.iter().rev() {\n+                queue.push((depth + 1, asset));\n+            }\n+            result.push(format!(\"{}{}\", indent, asset.path().to_string().await?).into());\n+        } else if references.is_empty() {\n+            result.push(format!(\"{}{} *\", indent, asset.path().to_string().await?).into());\n+        } else {\n+            result.push(format!(\"{}{} *...\", indent, asset.path().to_string().await?).into());\n+        }\n+    }\n+    Ok(result)\n+}"
        }
    ],
    "stats": {
        "total": 427,
        "additions": 426,
        "deletions": 1
    }
}