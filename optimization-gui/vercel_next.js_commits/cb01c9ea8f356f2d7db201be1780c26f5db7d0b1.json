{
    "author": "eps1lon",
    "message": "[test] Separate act and assertions (#85508)\n\nMoves the assertions out of `act` and removes redundant waiting for\nelements. Similar to https://github.com/vercel/next.js/pull/85417",
    "sha": "cb01c9ea8f356f2d7db201be1780c26f5db7d0b1",
    "files": [
        {
            "sha": "6e62c94d8de60340b1f75b5ecb7f1b18c02bf283",
            "filename": "test/e2e/app-dir/app-prefetch/prefetching.stale-times.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 34,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/cb01c9ea8f356f2d7db201be1780c26f5db7d0b1/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cb01c9ea8f356f2d7db201be1780c26f5db7d0b1/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts?ref=cb01c9ea8f356f2d7db201be1780c26f5db7d0b1",
            "patch": "@@ -37,16 +37,14 @@ describe('app dir - prefetching (custom staleTime)', () => {\n       async () => {\n         const reveal = await browser.elementByCss('#accordion-to-static-page')\n         await reveal.click()\n-        await browser.waitForElementByCss('#to-static-page')\n-        return await browser.elementByCss('#to-static-page')\n+        return browser.elementByCss('#to-static-page')\n       },\n       { includes: 'Static Page [prefetch-sentinel]' }\n     )\n \n     // Navigate to static page - should use prefetched data with no additional requests\n     await act(async () => {\n       await link.click()\n-      await browser.waitForElementByCss('#static-page')\n       const staticPageText = await browser.elementByCss('#static-page').text()\n       expect(staticPageText).toBe('Static Page [prefetch-sentinel]')\n     }, 'no-requests')\n@@ -66,12 +64,12 @@ describe('app dir - prefetching (custom staleTime)', () => {\n     await browser.waitForElementByCss('#to-static-page')\n \n     // Navigate to static page again using the accordion - should still use cached data with no additional requests\n-    await act(async () => {\n+    const staticPageText = await act(async () => {\n       await browser.elementByCss('#to-static-page').click()\n-      await browser.waitForElementByCss('#static-page')\n-      const staticPageText = await browser.elementByCss('#static-page').text()\n-      expect(staticPageText).toBe('Static Page [prefetch-sentinel]')\n+      return browser.elementByCss('#static-page').text()\n     }, 'no-requests')\n+\n+    expect(staticPageText).toBe('Static Page [prefetch-sentinel]')\n   })\n \n   it('should fetch again when a static page was prefetched when navigating to it after the stale time has passed', async () => {\n@@ -91,8 +89,7 @@ describe('app dir - prefetching (custom staleTime)', () => {\n       async () => {\n         const reveal = await browser.elementByCss('#accordion-to-static-page')\n         await reveal.click()\n-        await browser.waitForElementByCss('#to-static-page')\n-        return await browser.elementByCss('#to-static-page')\n+        return browser.elementByCss('#to-static-page')\n       },\n       { includes: 'Static Page [prefetch-sentinel]' }\n     )\n@@ -118,8 +115,7 @@ describe('app dir - prefetching (custom staleTime)', () => {\n       async () => {\n         const reveal = await browser.elementByCss('#accordion-to-static-page')\n         await reveal.click()\n-        await browser.waitForElementByCss('#to-static-page')\n-        return await browser.elementByCss('#to-static-page')\n+        return browser.elementByCss('#to-static-page')\n       },\n       { includes: 'Static Page [prefetch-sentinel]' }\n     )\n@@ -153,9 +149,10 @@ describe('app dir - prefetching (custom staleTime)', () => {\n     await act(async () => {\n       await browser.elementByCss(\"[href='/prefetch-auto-route-groups']\").click()\n       // Confirm that the dashboard page is still rendering the stale fetch count, as it should be cached\n-      expect(await browser.elementById('count').text()).toBe('1')\n     }, 'no-requests')\n \n+    expect(await browser.elementById('count').text()).toBe('1')\n+\n     // Navigate to a new sub-page - this will trigger another data fetch\n     await act(async () => {\n       await browser\n@@ -166,12 +163,14 @@ describe('app dir - prefetching (custom staleTime)', () => {\n     // Finally, go back to the route group page - should use cached data with no additional fetch\n     await act(async () => {\n       await browser.elementByCss(\"[href='/prefetch-auto-route-groups']\").click()\n-      // Confirm that the dashboard page is still rendering the stale fetch count, as it should be cached\n-      expect(await browser.elementById('count').text()).toBe('1')\n     }, 'no-requests')\n \n+    // Confirm that the dashboard page is still rendering the stale fetch count, as it should be cached\n+    expect(await browser.elementById('count').text()).toBe('1')\n+\n     // Reload the page to get the accurate total number of fetches\n     await browser.refresh()\n+\n     // The initial fetch, 2 sub-page fetches, and a final fetch when reloading the page\n     expect(await browser.elementById('count').text()).toBe('4')\n   })\n@@ -196,8 +195,7 @@ describe('app dir - prefetching (custom staleTime)', () => {\n       async () => {\n         const reveal = await browser.elementByCss('#accordion-to-home')\n         await reveal.click()\n-        await browser.waitForElementByCss('#to-home')\n-        return await browser.elementByCss('#to-home')\n+        return browser.elementByCss('#to-home')\n       },\n       { includes: 'Home Page [prefetch-sentinel]' }\n     )\n@@ -216,21 +214,17 @@ describe('app dir - prefetching (custom staleTime)', () => {\n           '#accordion-to-static-page-no-prefetch'\n         )\n         await reveal.click()\n-        await browser.waitForElementByCss('#to-static-page-no-prefetch')\n-        return await browser.elementByCss('#to-static-page-no-prefetch')\n+        return browser.elementByCss('#to-static-page-no-prefetch')\n       },\n       { includes: 'Static Page No Prefetch [prefetch-sentinel]' }\n     )\n \n     // Navigate back to static-page-no-prefetch - should use the fresh prefetch data\n-    await act(async () => {\n+    const staticPageText = await act(async () => {\n       await link.click()\n-      await browser.waitForElementByCss('#static-page-no-prefetch')\n-      const staticPageText = await browser\n-        .elementByCss('#static-page-no-prefetch')\n-        .text()\n-      expect(staticPageText).toBe('Static Page No Prefetch [prefetch-sentinel]')\n+      return browser.elementByCss('#static-page-no-prefetch').text()\n     }, 'no-requests')\n+    expect(staticPageText).toBe('Static Page No Prefetch [prefetch-sentinel]')\n   })\n \n   it('should renew the stale time after refetching expired RSC data', async () => {\n@@ -250,8 +244,7 @@ describe('app dir - prefetching (custom staleTime)', () => {\n       async () => {\n         const reveal = await browser.elementByCss('#accordion-to-static-page')\n         await reveal.click()\n-        await browser.waitForElementByCss('#to-static-page')\n-        return await browser.elementByCss('#to-static-page')\n+        return browser.elementByCss('#to-static-page')\n       },\n       { includes: 'Static Page [prefetch-sentinel]' }\n     )\n@@ -280,8 +273,7 @@ describe('app dir - prefetching (custom staleTime)', () => {\n       async () => {\n         const reveal = await browser.elementByCss('#accordion-to-static-page')\n         await reveal.click()\n-        await browser.waitForElementByCss('#to-static-page')\n-        return await browser.elementByCss('#to-static-page')\n+        return browser.elementByCss('#to-static-page')\n       },\n       { includes: 'Static Page [prefetch-sentinel]' }\n     )\n@@ -307,17 +299,15 @@ describe('app dir - prefetching (custom staleTime)', () => {\n     link = await act(async () => {\n       const reveal = await browser.elementByCss('#accordion-to-static-page')\n       await reveal.click()\n-      await browser.waitForElementByCss('#to-static-page')\n-      return await browser.elementByCss('#to-static-page')\n+      return browser.elementByCss('#to-static-page')\n     }, 'no-requests')\n \n     // Navigate to static page again (should NOT refetch - stale time should be renewed)\n     // If this assertion passes, it means the stale time was properly renewed after the refetch\n-    await act(async () => {\n+    const staticPageText = await act(async () => {\n       await link.click()\n-      await browser.waitForElementByCss('#static-page')\n-      const staticPageText = await browser.elementByCss('#static-page').text()\n-      expect(staticPageText).toBe('Static Page [prefetch-sentinel]')\n+      return browser.elementByCss('#static-page').text()\n     }, 'no-requests')\n+    expect(staticPageText).toBe('Static Page [prefetch-sentinel]')\n   })\n })"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 24,
        "deletions": 34
    }
}