{
    "author": "ijjk",
    "message": "Ensure custom NextServer config is honored (#81681)\n\nThis ensures if using NextServer or a custom-server directly we honor\nthe custom config passed in correctly.",
    "sha": "a0d15704e1c7f5571c1435bf9536592b33690cbd",
    "files": [
        {
            "sha": "a6f8939b12e26e113acbea9235b15240129f8b1b",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/a0d15704e1c7f5571c1435bf9536592b33690cbd/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a0d15704e1c7f5571c1435bf9536592b33690cbd/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=a0d15704e1c7f5571c1435bf9536592b33690cbd",
            "patch": "@@ -1106,12 +1106,17 @@ export default class NextNodeServer extends BaseServer<\n       routerServerGlobal[RouterServerContextSymbol] = {}\n     }\n     const relativeProjectDir = relative(process.cwd(), this.dir)\n+    const existingServerContext =\n+      routerServerGlobal[RouterServerContextSymbol][relativeProjectDir]\n \n-    if (!routerServerGlobal[RouterServerContextSymbol][relativeProjectDir]) {\n+    if (!existingServerContext) {\n       routerServerGlobal[RouterServerContextSymbol][relativeProjectDir] = {\n         render404: this.render404.bind(this),\n       }\n     }\n+    routerServerGlobal[RouterServerContextSymbol][\n+      relativeProjectDir\n+    ].nextConfig = this.nextConfig\n \n     try {\n       // next.js core assumes page path without trailing slash"
        },
        {
            "sha": "b31097aa35a330484a0292076423f5b72ab55073",
            "filename": "test/production/custom-server/custom-server.test.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/a0d15704e1c7f5571c1435bf9536592b33690cbd/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a0d15704e1c7f5571c1435bf9536592b33690cbd/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts?ref=a0d15704e1c7f5571c1435bf9536592b33690cbd",
            "patch": "@@ -50,6 +50,52 @@ describe('custom server', () => {\n   })\n })\n \n+describe('custom server provided config', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    startCommand: 'node server.js',\n+    serverReadyPattern: /^- Local:/,\n+    dependencies: {\n+      'get-port': '5.1.1',\n+    },\n+    env: {\n+      PROVIDED_CONFIG: 'true',\n+    },\n+  })\n+\n+  it.each(['a', 'b', 'c'])('can navigate to /%s', async (page) => {\n+    const $ = await next.render$(`/docs/${page}`)\n+    expect($('p').text()).toBe(`Page ${page}`)\n+  })\n+\n+  describe('with app dir', () => {\n+    it('should render app with react canary', async () => {\n+      const $ = await next.render$(`/docs/1`)\n+      expect($('body').text()).toMatch(/app: .+-canary/)\n+    })\n+\n+    it('should render pages with installed react', async () => {\n+      const $ = await next.render$(`/docs/2`)\n+      if (isReact18) {\n+        expect($('body').text()).toMatch(/pages: 18\\.\\d+\\.\\d+\\{/)\n+      } else {\n+        expect($('body').text()).toMatch(/pages: 19\\.\\d+\\.\\d+/)\n+      }\n+    })\n+\n+    describe('when using \"use cache\" with a custom cache handler', () => {\n+      it(\"should not unset the custom server's ALS context\", async () => {\n+        const cliOutputLength = next.cliOutput.length\n+        const $ = await next.render$('/docs/use-cache')\n+        expect($('p').text()).toBe('inner cache')\n+        const cliOutput = next.cliOutput.slice(cliOutputLength)\n+        expect(cliOutput).toMatch(createCacheSetLogRegExp('outer'))\n+        expect(cliOutput).toMatch(createCacheSetLogRegExp('inner'))\n+      })\n+    })\n+  })\n+})\n+\n describe('custom server with quiet setting', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,"
        },
        {
            "sha": "187d65915be1406b492ec9cbce346383707b7454",
            "filename": "test/production/custom-server/server.js",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/a0d15704e1c7f5571c1435bf9536592b33690cbd/test%2Fproduction%2Fcustom-server%2Fserver.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a0d15704e1c7f5571c1435bf9536592b33690cbd/test%2Fproduction%2Fcustom-server%2Fserver.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fserver.js?ref=a0d15704e1c7f5571c1435bf9536592b33690cbd",
            "patch": "@@ -10,8 +10,15 @@ let requestId = 0\n async function main() {\n   const port = await getPort()\n   const hostname = 'localhost'\n+  let conf = undefined\n+\n+  if (process.env.PROVIDED_CONFIG) {\n+    conf = require('./.next/required-server-files.json').config\n+    conf.basePath = '/docs'\n+  }\n+\n   // when using middleware `hostname` and `port` must be provided below\n-  const app = next({ hostname, port, quiet })\n+  const app = next({ hostname, port, quiet, conf })\n   const handle = app.getRequestHandler()\n \n   app.prepare().then(() => {\n@@ -21,7 +28,11 @@ async function main() {\n           // Be sure to pass `true` as the second argument to `url.parse`.\n           // This tells it to parse the query portion of the URL.\n           const parsedUrl = parse(req.url, true)\n-          const { pathname, query } = parsedUrl\n+          let { pathname, query } = parsedUrl\n+\n+          if (conf?.basePath) {\n+            pathname = pathname.replace(conf.basePath, '') || '/'\n+          }\n \n           if (pathname === '/a') {\n             await app.render(req, res, '/a', query)\n@@ -30,6 +41,7 @@ async function main() {\n           } else if (pathname === '/error') {\n             await app.render(req, res, '/page-error')\n           } else {\n+            parsedUrl.pathname = pathname\n             await handle(req, res, parsedUrl)\n           }\n         } catch (err) {"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 66,
        "deletions": 3
    }
}