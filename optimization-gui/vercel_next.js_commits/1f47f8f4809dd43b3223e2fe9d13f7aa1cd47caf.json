{
    "author": "kdy1",
    "message": "perf(next-swc): Remove needless JSON conversion (#80671)\n\n### What?\n\nRemove unnecessary JSON operations.\n\n### Why?\n\n - https://github.com/swc-project/swc/pull/10628\n - https://github.com/swc-project/swc/issues/10610",
    "sha": "1f47f8f4809dd43b3223e2fe9d13f7aa1cd47caf",
    "files": [
        {
            "sha": "4d8aa6f95201f8b6c7dda1dac72689d208b6f2ad",
            "filename": "crates/napi/src/minify.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 37,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/1f47f8f4809dd43b3223e2fe9d13f7aa1cd47caf/crates%2Fnapi%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1f47f8f4809dd43b3223e2fe9d13f7aa1cd47caf/crates%2Fnapi%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fminify.rs?ref=1f47f8f4809dd43b3223e2fe9d13f7aa1cd47caf",
            "patch": "@@ -26,57 +26,30 @@ IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER\n DEALINGS IN THE SOFTWARE.\n */\n \n+use anyhow::Context;\n use napi::bindgen_prelude::*;\n-use rustc_hash::FxHashMap;\n-use serde::Deserialize;\n use swc_core::{\n     base::{TransformOutput, config::JsMinifyOptions, try_with_handler},\n-    common::{FileName, GLOBALS, SourceFile, SourceMap, errors::ColorConfig, sync::Lrc},\n+    common::{FileName, GLOBALS, errors::ColorConfig},\n };\n \n use crate::{get_compiler, util::MapErr};\n \n pub struct MinifyTask {\n     c: swc_core::base::Compiler,\n-    code: MinifyTarget,\n+    code: Option<String>,\n     opts: JsMinifyOptions,\n }\n \n-#[derive(Deserialize)]\n-#[serde(untagged)]\n-enum MinifyTarget {\n-    /// Code to minify.\n-    Single(String),\n-    /// `{ filename: code }`\n-    Map(FxHashMap<String, String>),\n-}\n-\n-impl MinifyTarget {\n-    fn to_file(&self, cm: Lrc<SourceMap>) -> Lrc<SourceFile> {\n-        match self {\n-            MinifyTarget::Single(code) => cm.new_source_file(FileName::Anon.into(), code.clone()),\n-            MinifyTarget::Map(codes) => {\n-                assert_eq!(\n-                    codes.len(),\n-                    1,\n-                    \"swc.minify does not support concatenating multiple files yet\"\n-                );\n-\n-                let (filename, code) = codes.iter().next().unwrap();\n-\n-                cm.new_source_file(FileName::Real(filename.clone().into()).into(), code.clone())\n-            }\n-        }\n-    }\n-}\n-\n #[napi]\n impl Task for MinifyTask {\n     type Output = TransformOutput;\n \n     type JsValue = TransformOutput;\n \n     fn compute(&mut self) -> napi::Result<Self::Output> {\n+        let code = self.code.take().unwrap_or_default();\n+\n         try_with_handler(\n             self.c.cm.clone(),\n             swc_core::base::HandlerOpts {\n@@ -85,7 +58,7 @@ impl Task for MinifyTask {\n             },\n             |handler| {\n                 GLOBALS.set(&Default::default(), || {\n-                    let fm = self.code.to_file(self.c.cm.clone());\n+                    let fm = self.c.cm.new_source_file(FileName::Anon.into(), code);\n \n                     self.c.minify(fm, handler, &self.opts, Default::default())\n                 })\n@@ -106,24 +79,32 @@ pub fn minify(\n     opts: Buffer,\n     signal: Option<AbortSignal>,\n ) -> napi::Result<AsyncTask<MinifyTask>> {\n-    let code = serde_json::from_slice(&input)?;\n+    let code = String::from_utf8(input.into())\n+        .context(\"failed to convert input to string\")\n+        .convert_err()?;\n     let opts = serde_json::from_slice(&opts)?;\n \n     let c = get_compiler();\n \n-    let task = MinifyTask { c, code, opts };\n+    let task = MinifyTask {\n+        c,\n+        code: Some(code),\n+        opts,\n+    };\n \n     Ok(AsyncTask::with_optional_signal(task, signal))\n }\n \n #[napi]\n pub fn minify_sync(input: Buffer, opts: Buffer) -> napi::Result<TransformOutput> {\n-    let code: MinifyTarget = serde_json::from_slice(&input)?;\n+    let code = String::from_utf8(input.into())\n+        .context(\"failed to convert input to string\")\n+        .convert_err()?;\n     let opts = serde_json::from_slice(&opts)?;\n \n     let c = get_compiler();\n \n-    let fm = code.to_file(c.cm.clone());\n+    let fm = c.cm.new_source_file(FileName::Anon.into(), code);\n \n     try_with_handler(\n         c.cm.clone(),"
        },
        {
            "sha": "a978c5215e4232c8e2e98c7a813849e3fff0db65",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1f47f8f4809dd43b3223e2fe9d13f7aa1cd47caf/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1f47f8f4809dd43b3223e2fe9d13f7aa1cd47caf/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=1f47f8f4809dd43b3223e2fe9d13f7aa1cd47caf",
            "patch": "@@ -1364,11 +1364,11 @@ function loadNative(importPath?: string) {\n       },\n \n       minify(src: string, options: any) {\n-        return bindings.minify(toBuffer(src), toBuffer(options ?? {}))\n+        return bindings.minify(Buffer.from(src), toBuffer(options ?? {}))\n       },\n \n       minifySync(src: string, options: any) {\n-        return bindings.minifySync(toBuffer(src), toBuffer(options ?? {}))\n+        return bindings.minifySync(Buffer.from(src), toBuffer(options ?? {}))\n       },\n \n       parse(src: string, options: any) {"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 20,
        "deletions": 39
    }
}