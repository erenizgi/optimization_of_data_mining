{
    "author": "sokra",
    "message": "[Turbopack] merged chunks need to have min overlap of 2 merge remainers into chunk (#76320)\n\n### What?\n\nonly merge small chunks when they occur in multiple overlapping chunk groups.\nAll unmergable small chunks will go into a leftover chunk which combines all non-shared chunks.",
    "sha": "9a3d5a5ebd470bee3a580e24cbb125e7fc90a87d",
    "files": [
        {
            "sha": "cbea9bc1ef4036f0822a7f9b73c620d05b9a6bc9",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking/production.rs",
            "status": "modified",
            "additions": 31,
            "deletions": 6,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/9a3d5a5ebd470bee3a580e24cbb125e7fc90a87d/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fproduction.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9a3d5a5ebd470bee3a580e24cbb125e7fc90a87d/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fproduction.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking%2Fproduction.rs?ref=9a3d5a5ebd470bee3a580e24cbb125e7fc90a87d",
            "patch": "@@ -104,7 +104,7 @@ pub async fn make_production_chunks(\n                             smallest.size\n                         };\n                         let too_many_chunks = max_chunk_count_per_group != 0\n-                            && heap.len() + chunks_to_merge_size / merge_threshold\n+                            && heap.len() + chunks_to_merge_size / merge_threshold + 1\n                                 > max_chunk_count_per_group;\n                         let too_small_chunk = min_chunk_size != 0 && smallest.size < min_chunk_size;\n                         if too_many_chunks || too_small_chunk {\n@@ -152,6 +152,10 @@ pub async fn make_production_chunks(\n                         // Check all combination with the new candidate\n                         for (i, other) in selection.iter().enumerate() {\n                             let value = overlap(&candidate.chunk_groups, &other.chunk_groups);\n+                            // It need to have at least two chunk groups in common\n+                            if value <= 1 {\n+                                continue;\n+                            }\n                             if let Some((best_i1, best_i2, best_value)) = best_combination.as_mut()\n                             {\n                                 if value > *best_value {\n@@ -194,15 +198,36 @@ pub async fn make_production_chunks(\n                         } else {\n                             chunks_to_merge.push(candidate);\n                         }\n+                    } else {\n+                        // No merges possible\n+                        for unused in selection {\n+                            chunks_to_merge.push(unused);\n+                        }\n+                        break;\n                     }\n                 }\n \n-                // Left-over chunks go back to the heap\n-                for chunk in chunks_to_merge {\n+                // Left-over chunks are merged together forming the remainer chunk, which includes\n+                // all modules that are not sharable\n+                if let Some(MergeCandidate {\n+                    mut size,\n+                    mut chunk_items,\n+                    chunk_groups: _,\n+                }) = chunks_to_merge.pop()\n+                {\n+                    for chunk in chunks_to_merge {\n+                        let MergeCandidate {\n+                            size: other_size,\n+                            chunk_items: other_chunk_items,\n+                            chunk_groups: _,\n+                        } = chunk;\n+                        size += other_size;\n+                        chunk_items.extend(other_chunk_items);\n+                    }\n                     heap.push(ChunkCandidate {\n-                        size: chunk.size,\n-                        chunk_items: chunk.chunk_items,\n-                        chunk_groups: chunk.chunk_groups,\n+                        size,\n+                        chunk_items,\n+                        chunk_groups: None,\n                     });\n                 }\n             }"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 31,
        "deletions": 6
    }
}