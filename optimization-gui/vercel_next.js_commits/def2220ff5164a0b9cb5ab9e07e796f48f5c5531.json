{
    "author": "devjiwonchoi",
    "message": "Add codemod for Middleware API to Proxy API (#84824)\n\nStacked on https://github.com/vercel/next.js/pull/84764\n\n### Test Plan\n\nTested on local fixtures as well.",
    "sha": "def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
    "files": [
        {
            "sha": "ee1f901ad505014ab701e725699f781e5229f68f",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-basic.input.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-basic.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-basic.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-basic.input.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,12 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  experimental: {\n+    middlewarePrefetch: 'strict',\n+    middlewareClientMaxBodySize: '10mb',\n+    externalMiddlewareRewritesResolve: true,\n+  },\n+  skipMiddlewareUrlNormalize: true,\n+}\n+\n+export default nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "b70810315583d81b1fd45086361bf397ac231a6b",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-basic.output.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-basic.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-basic.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-basic.output.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,12 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  experimental: {\n+    proxyPrefetch: 'strict',\n+    proxyClientMaxBodySize: '10mb',\n+    externalProxyRewritesResolve: true,\n+  },\n+  skipProxyUrlNormalize: true,\n+}\n+\n+export default nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "e14cc4f6a9632abcb622455d2886fa34dbffca53",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-commonjs.input.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-commonjs.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-commonjs.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-commonjs.input.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,11 @@\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  experimental: {\n+    middlewarePrefetch: 'flexible',\n+    middlewareClientMaxBodySize: '8mb',\n+    externalMiddlewareRewritesResolve: false,\n+  },\n+  skipMiddlewareUrlNormalize: false,\n+}\n+\n+module.exports = nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "c8d7e236c94a8df613ac600a8676e34cc4f6b036",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-commonjs.output.ts",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-commonjs.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-commonjs.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-commonjs.output.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,11 @@\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  experimental: {\n+    proxyPrefetch: 'flexible',\n+    proxyClientMaxBodySize: '8mb',\n+    externalProxyRewritesResolve: false,\n+  },\n+  skipProxyUrlNormalize: false,\n+}\n+\n+module.exports = nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "c079a92972caa0558b52b57fc847b291d2e11049",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-function-arrow.input.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-arrow.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-arrow.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-arrow.input.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,12 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig = (): NextConfig => ({\n+  experimental: {\n+    middlewarePrefetch: 'strict',\n+    middlewareClientMaxBodySize: '5mb',\n+    externalMiddlewareRewritesResolve: true,\n+  },\n+  skipMiddlewareUrlNormalize: true,\n+})\n+\n+export default nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "0d4282c0b732a87995474d5392f85c9bfb006056",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-function-arrow.output.ts",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-arrow.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-arrow.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-arrow.output.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,12 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig = (): NextConfig => ({\n+  experimental: {\n+    proxyPrefetch: 'strict',\n+    proxyClientMaxBodySize: '5mb',\n+    externalProxyRewritesResolve: true,\n+  },\n+  skipProxyUrlNormalize: true,\n+})\n+\n+export default nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "f9e152e5a56451160029961b5fbe5af709f242e0",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-function-async.input.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-async.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-async.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-async.input.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,14 @@\n+import type { NextConfig } from 'next'\n+\n+async function nextConfig(): Promise<NextConfig> {\n+  return {\n+    experimental: {\n+      middlewarePrefetch: 'flexible',\n+      middlewareClientMaxBodySize: 5 * 1024 * 1024,\n+      externalMiddlewareRewritesResolve: false,\n+    },\n+    skipMiddlewareUrlNormalize: false,\n+  }\n+}\n+\n+export default nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "05b08d2b1578dc79afd14526ef131449d4dac746",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-function-async.output.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-async.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-async.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function-async.output.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,14 @@\n+import type { NextConfig } from 'next'\n+\n+async function nextConfig(): Promise<NextConfig> {\n+  return {\n+    experimental: {\n+      proxyPrefetch: 'flexible',\n+      proxyClientMaxBodySize: 5 * 1024 * 1024,\n+      externalProxyRewritesResolve: false,\n+    },\n+    skipProxyUrlNormalize: false,\n+  };\n+}\n+\n+export default nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "37ec9d8438515f48fc434137db9096ef8a00094a",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-function.input.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function.input.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,14 @@\n+import type { NextConfig } from 'next'\n+\n+function nextConfig(): NextConfig {\n+  return {\n+    experimental: {\n+      middlewarePrefetch: 'flexible',\n+      middlewareClientMaxBodySize: 5 * 1024 * 1024,\n+      externalMiddlewareRewritesResolve: false,\n+    },\n+    skipMiddlewareUrlNormalize: false,\n+  }\n+}\n+\n+export default nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "e7cdf1c47e1d8897fd4eb3c6132430a65ae73578",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-function.output.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-function.output.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,14 @@\n+import type { NextConfig } from 'next'\n+\n+function nextConfig(): NextConfig {\n+  return {\n+    experimental: {\n+      proxyPrefetch: 'flexible',\n+      proxyClientMaxBodySize: 5 * 1024 * 1024,\n+      externalProxyRewritesResolve: false,\n+    },\n+    skipProxyUrlNormalize: false,\n+  };\n+}\n+\n+export default nextConfig\n\\ No newline at end of file"
        },
        {
            "sha": "1fb49c50f522de1752e3608fd79b680f2e15e867",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-wrapped.input.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-wrapped.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-wrapped.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-wrapped.input.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,15 @@\n+import type { NextConfig } from 'next'\n+import fooWrapper from 'foo-wrapper'\n+import barWrapper from 'bar-wrapper'\n+import bazWrapper from 'baz-wrapper'\n+\n+const nextConfig: NextConfig = {\n+  experimental: {\n+    middlewarePrefetch: 'flexible',\n+    middlewareClientMaxBodySize: '8mb',\n+    externalMiddlewareRewritesResolve: false,\n+  },\n+  skipMiddlewareUrlNormalize: false,\n+}\n+\n+export default fooWrapper(barWrapper(bazWrapper(nextConfig)))\n\\ No newline at end of file"
        },
        {
            "sha": "0e90a820d8ee40d9b64da6cb670e84b88f6d8d6f",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/next-config-wrapped.output.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-wrapped.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-wrapped.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Fnext-config-wrapped.output.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,15 @@\n+import type { NextConfig } from 'next'\n+import fooWrapper from 'foo-wrapper'\n+import barWrapper from 'bar-wrapper'\n+import bazWrapper from 'baz-wrapper'\n+\n+const nextConfig: NextConfig = {\n+  experimental: {\n+    proxyPrefetch: 'flexible',\n+    proxyClientMaxBodySize: '8mb',\n+    externalProxyRewritesResolve: false,\n+  },\n+  skipProxyUrlNormalize: false,\n+}\n+\n+export default fooWrapper(barWrapper(bazWrapper(nextConfig)))\n\\ No newline at end of file"
        },
        {
            "sha": "f657cd22c6b7acf92837f527318ca263aba55217",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/type-imports.input.ts",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Ftype-imports.input.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Ftype-imports.input.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Ftype-imports.input.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,18 @@\n+import { NextRequest, NextResponse, NextMiddleware, MiddlewareConfig } from 'next/server'\n+import type { NextMiddleware as MiddlewareType } from 'next/server'\n+\n+export function middleware(request: NextRequest): NextMiddleware {\n+  return NextResponse.next()\n+}\n+\n+export const config: MiddlewareConfig = {\n+  matcher: '/api/:path*'\n+}\n+\n+// Type usage in function parameter\n+function createMiddleware(): NextMiddleware {\n+  return (request: NextRequest) => NextResponse.next()\n+}\n+\n+// Type alias using the imported type\n+type MyMiddleware = MiddlewareType\n\\ No newline at end of file"
        },
        {
            "sha": "6ffe78074a57c595a5fa480834c30bb982c4e04c",
            "filename": "packages/next-codemod/transforms/__testfixtures__/middleware-to-proxy/type-imports.output.ts",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Ftype-imports.output.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Ftype-imports.output.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2F__testfixtures__%2Fmiddleware-to-proxy%2Ftype-imports.output.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -0,0 +1,18 @@\n+import { NextRequest, NextResponse, NextProxy, ProxyConfig } from 'next/server'\n+import type { NextProxy as MiddlewareType } from 'next/server'\n+\n+export function proxy(request: NextRequest): NextProxy {\n+  return NextResponse.next()\n+}\n+\n+export const config: ProxyConfig = {\n+  matcher: '/api/:path*'\n+}\n+\n+// Type usage in function parameter\n+function createMiddleware(): NextProxy {\n+  return (request: NextRequest) => NextResponse.next()\n+}\n+\n+// Type alias using the imported type\n+type MyMiddleware = MiddlewareType\n\\ No newline at end of file"
        },
        {
            "sha": "36e698e2087912a2fba68f14b0f8a9716a858a30",
            "filename": "packages/next-codemod/transforms/middleware-to-proxy.ts",
            "status": "modified",
            "additions": 544,
            "deletions": 17,
            "changes": 561,
            "blob_url": "https://github.com/vercel/next.js/blob/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2Fmiddleware-to-proxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/def2220ff5164a0b9cb5ab9e07e796f48f5c5531/packages%2Fnext-codemod%2Ftransforms%2Fmiddleware-to-proxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-codemod%2Ftransforms%2Fmiddleware-to-proxy.ts?ref=def2220ff5164a0b9cb5ab9e07e796f48f5c5531",
            "patch": "@@ -1,24 +1,354 @@\n-import type { API, ASTPath, Collection, FileInfo } from 'jscodeshift'\n-import path from 'path'\n+import type {\n+  API,\n+  ASTPath,\n+  Collection,\n+  FileInfo,\n+  ObjectExpression,\n+  ObjectProperty,\n+  Property,\n+  SpreadElement,\n+  SpreadProperty,\n+  ObjectMethod,\n+} from 'jscodeshift'\n+\n import fs from 'fs'\n+import { join, parse } from 'path'\n+import { isNextConfigFile } from './lib/utils'\n import { createParserFromPath } from '../lib/parser'\n \n-export default function transformer(file: FileInfo) {\n-  if (\n-    !/(^|[/\\\\])middleware\\.|[/\\\\]src[/\\\\]middleware\\./.test(file.path) &&\n-    // fixtures have unique basenames in test\n-    process.env.NODE_ENV !== 'test'\n-  ) {\n-    return file.source\n-  }\n+// Middleware config properties that need to be renamed to proxy equivalents\n+const CONFIG_PROPERTY_MAP = {\n+  middlewarePrefetch: 'proxyPrefetch',\n+  middlewareClientMaxBodySize: 'proxyClientMaxBodySize',\n+  externalMiddlewareRewritesResolve: 'externalProxyRewritesResolve',\n+  skipMiddlewareUrlNormalize: 'skipProxyUrlNormalize',\n+}\n+\n+// Type imports from 'next/server' that need to be transformed\n+const MIDDLEWARE_TYPE_IMPORT_MAP = {\n+  NextMiddleware: 'NextProxy',\n+  MiddlewareConfig: 'ProxyConfig',\n+}\n \n+export default function transformer(file: FileInfo) {\n   const j = createParserFromPath(file.path)\n   const root = j(file.source)\n \n   if (!root.length) {\n     return file.source\n   }\n \n+  const isNextConfig =\n+    isNextConfigFile(file) ||\n+    (process.env.NODE_ENV === 'test' && /next-config-/.test(file.path))\n+  const isMiddlewareFile =\n+    /(^|[/\\\\])middleware\\.|[/\\\\]src[/\\\\]middleware\\./.test(file.path) ||\n+    (process.env.NODE_ENV === 'test' && !isNextConfig)\n+  const hasMiddlewareTypeImports = checkForNextServerTypeImports(root, j)\n+\n+  // In test mode, process all files. Otherwise, only process relevant files\n+  if (process.env.NODE_ENV !== 'test') {\n+    if (!isMiddlewareFile && !isNextConfig && !hasMiddlewareTypeImports) {\n+      return file.source\n+    }\n+  }\n+\n+  let hasChanges = false\n+\n+  if (hasMiddlewareTypeImports) {\n+    const typeImportChanges = transformMiddlewareTypeImports(root, j)\n+    hasChanges = hasChanges || typeImportChanges\n+  }\n+\n+  if (isMiddlewareFile) {\n+    const middlewareChanges = transformMiddlewareFunction(root, j)\n+    hasChanges = hasChanges || middlewareChanges.hasChanges\n+  }\n+\n+  if (isNextConfig) {\n+    const { hasConfigChanges } = transformNextConfig(root, j)\n+    hasChanges = hasChanges || hasConfigChanges\n+  }\n+\n+  if (!hasChanges) {\n+    return file.source\n+  }\n+\n+  const source = root.toSource()\n+\n+  // Need to write proxy file and unlink the original middleware file.\n+  if (isMiddlewareFile) {\n+    return handleMiddlewareFileRename(file, source)\n+  }\n+\n+  return source\n+}\n+\n+function checkForNextServerTypeImports(\n+  root: Collection<any>,\n+  j: API['j']\n+): boolean {\n+  return (\n+    root\n+      .find(j.ImportDeclaration, {\n+        source: { value: 'next/server' },\n+      })\n+      .find(j.ImportSpecifier)\n+      .filter(\n+        (path: ASTPath<any>) =>\n+          MIDDLEWARE_TYPE_IMPORT_MAP[path.node.imported.name]\n+      ).length > 0\n+  )\n+}\n+\n+function transformMiddlewareTypeImports(\n+  root: Collection<any>,\n+  j: API['j']\n+): boolean {\n+  let hasChanges = false\n+\n+  // Transform type imports from 'next/server'\n+  root\n+    .find(j.ImportDeclaration, {\n+      source: { value: 'next/server' },\n+    })\n+    .forEach((importPath: ASTPath<any>) => {\n+      const specifiers = importPath.node.specifiers\n+      if (!specifiers) return\n+\n+      specifiers.forEach((specifier: any) => {\n+        if (\n+          j.ImportSpecifier.check(specifier) &&\n+          specifier.imported &&\n+          MIDDLEWARE_TYPE_IMPORT_MAP[specifier.imported.name]\n+        ) {\n+          const oldImportName = specifier.imported.name\n+          const newImportName = MIDDLEWARE_TYPE_IMPORT_MAP[oldImportName]\n+\n+          // Update the local name if it matches the original imported name\n+          if (specifier.local && specifier.local.name === oldImportName) {\n+            specifier.local.name = newImportName\n+          }\n+\n+          // Transform the import name\n+          specifier.imported.name = newImportName\n+\n+          hasChanges = true\n+        }\n+      })\n+    })\n+\n+  // Also transform any type annotations using the old types\n+  Object.keys(MIDDLEWARE_TYPE_IMPORT_MAP).forEach((oldType) => {\n+    root\n+      .find(j.TSTypeReference)\n+      .filter((path: ASTPath<any>) => {\n+        return (\n+          path.node.typeName &&\n+          path.node.typeName.type === 'Identifier' &&\n+          path.node.typeName.name === oldType\n+        )\n+      })\n+      .forEach((path: ASTPath<any>) => {\n+        path.node.typeName.name = MIDDLEWARE_TYPE_IMPORT_MAP[oldType]\n+        hasChanges = true\n+      })\n+  })\n+\n+  return hasChanges\n+}\n+\n+function transformNextConfig(\n+  root: Collection<any>,\n+  j: API['j']\n+): { hasConfigChanges: boolean } {\n+  let hasConfigChanges = false\n+\n+  // Collect config-related object expressions instead of processing all\n+  const configObjects = findNextConfigObjects(root, j)\n+  configObjects.forEach((objPath: ASTPath<any>) => {\n+    const result = processConfigObject(objPath.value)\n+    hasConfigChanges = hasConfigChanges || result.hasChanges\n+  })\n+\n+  // Process function configurations that are likely to be Next.js config\n+  const configFunctions = findNextConfigFunctions(root, j)\n+  configFunctions.forEach((path: ASTPath<any>) => {\n+    const result = processFunctionConfig(path, j)\n+    hasConfigChanges = hasConfigChanges || result.hasChanges\n+  })\n+\n+  // Process arrow function configurations that are likely to be Next.js config\n+  const configArrowFunctions = findNextConfigArrowFunctions(root, j)\n+  configArrowFunctions.forEach((path: ASTPath<any>) => {\n+    const result = processArrowFunctionConfig(path, j)\n+    hasConfigChanges = hasConfigChanges || result.hasChanges\n+  })\n+\n+  // Process direct property assignments: config.experimental.middlewarePrefetch = value\n+  Object.keys(CONFIG_PROPERTY_MAP).forEach((oldProp) => {\n+    const newProp = CONFIG_PROPERTY_MAP[oldProp]\n+\n+    // Handle experimental.* properties\n+    if (\n+      oldProp.startsWith('middleware') &&\n+      oldProp !== 'skipMiddlewareUrlNormalize'\n+    ) {\n+      root\n+        .find(j.AssignmentExpression, {\n+          left: {\n+            type: 'MemberExpression',\n+            object: {\n+              type: 'MemberExpression',\n+              property: { name: 'experimental' },\n+            },\n+            property: { name: oldProp },\n+          },\n+        })\n+        .forEach((path: ASTPath<any>) => {\n+          path.node.left.property.name = newProp\n+          hasConfigChanges = true\n+        })\n+    } else {\n+      // Handle top-level properties like skipMiddlewareUrlNormalize\n+      root\n+        .find(j.AssignmentExpression, {\n+          left: {\n+            type: 'MemberExpression',\n+            property: { name: oldProp },\n+          },\n+        })\n+        .forEach((path: ASTPath<any>) => {\n+          path.node.left.property.name = newProp\n+          hasConfigChanges = true\n+        })\n+    }\n+  })\n+\n+  return { hasConfigChanges }\n+}\n+\n+function processConfigObject(configObj: ObjectExpression): {\n+  hasChanges: boolean\n+} {\n+  let hasChanges = false\n+\n+  // Check for experimental property\n+  const experimentalProp = configObj.properties.find(\n+    (prop) =>\n+      isStaticProperty(prop) &&\n+      prop.key &&\n+      prop.key.type === 'Identifier' &&\n+      prop.key.name === 'experimental'\n+  )\n+\n+  if (experimentalProp && isStaticProperty(experimentalProp)) {\n+    const experimentalObj = experimentalProp.value\n+    if (experimentalObj.type === 'ObjectExpression') {\n+      // Transform properties in experimental object\n+      experimentalObj.properties.forEach((prop) => {\n+        if (\n+          isStaticProperty(prop) &&\n+          prop.key &&\n+          prop.key.type === 'Identifier' &&\n+          CONFIG_PROPERTY_MAP[prop.key.name] &&\n+          prop.key.name !== 'skipMiddlewareUrlNormalize' // This is top-level\n+        ) {\n+          prop.key.name = CONFIG_PROPERTY_MAP[prop.key.name]\n+          hasChanges = true\n+        }\n+      })\n+    }\n+  }\n+\n+  // Transform top-level properties\n+  configObj.properties.forEach((prop) => {\n+    if (\n+      isStaticProperty(prop) &&\n+      prop.key &&\n+      prop.key.type === 'Identifier' &&\n+      prop.key.name === 'skipMiddlewareUrlNormalize'\n+    ) {\n+      prop.key.name = CONFIG_PROPERTY_MAP[prop.key.name]\n+      hasChanges = true\n+    }\n+  })\n+\n+  // Also transform any top-level middleware properties (for spread scenarios)\n+  configObj.properties.forEach((prop) => {\n+    if (\n+      isStaticProperty(prop) &&\n+      prop.key &&\n+      prop.key.type === 'Identifier' &&\n+      CONFIG_PROPERTY_MAP[prop.key.name] &&\n+      prop.key.name !== 'skipMiddlewareUrlNormalize' // Already handled above\n+    ) {\n+      prop.key.name = CONFIG_PROPERTY_MAP[prop.key.name]\n+      hasChanges = true\n+    }\n+  })\n+\n+  return { hasChanges }\n+}\n+\n+function processFunctionConfig(\n+  path: ASTPath<any>,\n+  j: API['j']\n+): { hasChanges: boolean } {\n+  let hasChanges = false\n+\n+  // Look for return statements with object expressions\n+  j(path)\n+    .find(j.ReturnStatement)\n+    .forEach((returnPath: ASTPath<any>) => {\n+      if (\n+        returnPath.node.argument &&\n+        returnPath.node.argument.type === 'ObjectExpression'\n+      ) {\n+        const result = processConfigObject(returnPath.node.argument)\n+        hasChanges = hasChanges || result.hasChanges\n+      }\n+    })\n+\n+  return { hasChanges }\n+}\n+\n+function processArrowFunctionConfig(\n+  path: ASTPath<any>,\n+  j: API['j']\n+): { hasChanges: boolean } {\n+  let hasChanges = false\n+\n+  const body = path.node.body\n+\n+  // Handle: () => ({ ... })\n+  if (body && body.type === 'ObjectExpression') {\n+    const result = processConfigObject(body)\n+    hasChanges = hasChanges || result.hasChanges\n+  }\n+\n+  // Handle: () => { return { ... } }\n+  if (body && body.type === 'BlockStatement') {\n+    j(path)\n+      .find(j.ReturnStatement)\n+      .forEach((returnPath: ASTPath<any>) => {\n+        if (\n+          returnPath.node.argument &&\n+          returnPath.node.argument.type === 'ObjectExpression'\n+        ) {\n+          const result = processConfigObject(returnPath.node.argument)\n+          hasChanges = hasChanges || result.hasChanges\n+        }\n+      })\n+  }\n+\n+  return { hasChanges }\n+}\n+\n+function transformMiddlewareFunction(\n+  root: Collection<any>,\n+  j: API['j']\n+): { hasChanges: boolean } {\n   const proxyIdentifier = generateUniqueIdentifier(root, j, 'proxy')\n   const needsAlias = proxyIdentifier !== 'proxy'\n \n@@ -146,10 +476,6 @@ export default function transformer(file: FileInfo) {\n       })\n   }\n \n-  if (!hasChanges) {\n-    return file.source\n-  }\n-\n   // If we used a unique identifier AND we exported `as proxy`, add an export alias\n   // This handles cases where the export was part of the declaration itself:\n   //   export function middleware() {} -> export function _proxy1() {} (needs alias)\n@@ -190,20 +516,24 @@ export default function transformer(file: FileInfo) {\n     }\n   }\n \n-  const source = root.toSource()\n+  return { hasChanges }\n+}\n \n+function handleMiddlewareFileRename(file: FileInfo, source: string): string {\n   // We will not modify the original file in real world,\n   // so return the source here for testing.\n   if (process.env.NODE_ENV === 'test') {\n     return source\n   }\n \n-  const { dir, ext } = path.parse(file.path)\n-  const newFilePath = path.join(dir, 'proxy' + ext)\n+  const { dir, ext } = parse(file.path)\n+  const newFilePath = join(dir, 'proxy' + ext)\n \n   try {\n     fs.writeFileSync(newFilePath, source)\n     fs.unlinkSync(file.path)\n+    // Return empty string to indicate successful file replacement.\n+    return ''\n   } catch (cause) {\n     console.error(\n       `Failed to write \"${newFilePath}\" and delete \"${file.path}\".\\n${JSON.stringify({ cause })}`\n@@ -212,6 +542,17 @@ export default function transformer(file: FileInfo) {\n   }\n }\n \n+function isStaticProperty(\n+  prop:\n+    | Property\n+    | ObjectProperty\n+    | SpreadElement\n+    | SpreadProperty\n+    | ObjectMethod\n+): prop is Property | ObjectProperty {\n+  return prop.type === 'Property' || prop.type === 'ObjectProperty'\n+}\n+\n function generateUniqueIdentifier(\n   root: Collection<any>,\n   j: API['j'],\n@@ -268,3 +609,189 @@ function hasIdentifierInScope(\n \n   return hasVariableDeclaration || hasFunctionDeclaration || hasImportSpecifier\n }\n+\n+function findNextConfigObjects(\n+  root: Collection<any>,\n+  j: API['j']\n+): ASTPath<any>[] {\n+  const configObjects: ASTPath<any>[] = []\n+\n+  // Find identifiers that are exported as default or assigned to module.exports\n+  const exportedNames = new Set<string>()\n+\n+  // Handle: export default nextConfig or export default wrappedFunction(nextConfig)\n+  root.find(j.ExportDefaultDeclaration).forEach((path: ASTPath<any>) => {\n+    if (j.Identifier.check(path.node.declaration)) {\n+      exportedNames.add(path.node.declaration.name)\n+    } else if (j.ObjectExpression.check(path.node.declaration)) {\n+      // Direct object export: export default { ... }\n+      configObjects.push(path.get('declaration'))\n+    } else if (j.CallExpression.check(path.node.declaration)) {\n+      // Handle wrapped exports: export default wrapper(config)\n+      extractObjectsFromCallExpression(\n+        path.node.declaration,\n+        configObjects,\n+        exportedNames,\n+        j\n+      )\n+    }\n+  })\n+\n+  // Handle: module.exports = nextConfig or module.exports = wrappedFunction(nextConfig)\n+  root\n+    .find(j.AssignmentExpression, {\n+      left: {\n+        type: 'MemberExpression',\n+        object: { name: 'module' },\n+        property: { name: 'exports' },\n+      },\n+    })\n+    .forEach((path: ASTPath<any>) => {\n+      if (j.Identifier.check(path.node.right)) {\n+        exportedNames.add(path.node.right.name)\n+      } else if (j.ObjectExpression.check(path.node.right)) {\n+        // Direct object assignment: module.exports = { ... }\n+        configObjects.push(path.get('right'))\n+      } else if (j.CallExpression.check(path.node.right)) {\n+        // Handle wrapped assignments: module.exports = wrapper(config)\n+        extractObjectsFromCallExpression(\n+          path.node.right,\n+          configObjects,\n+          exportedNames,\n+          j\n+        )\n+      }\n+    })\n+\n+  // Find variable declarations for exported names\n+  exportedNames.forEach((name) => {\n+    root\n+      .find(j.VariableDeclarator, { id: { name } })\n+      .forEach((path: ASTPath<any>) => {\n+        if (j.ObjectExpression.check(path.node.init)) {\n+          configObjects.push(path.get('init'))\n+        }\n+      })\n+  })\n+\n+  return configObjects\n+}\n+\n+function findNextConfigFunctions(\n+  root: Collection<any>,\n+  j: API['j']\n+): ASTPath<any>[] {\n+  const configFunctions: ASTPath<any>[] = []\n+  const exportedNames = new Set<string>()\n+\n+  // Handle: export default function or export default functionName\n+  root.find(j.ExportDefaultDeclaration).forEach((path: ASTPath<any>) => {\n+    if (j.FunctionDeclaration.check(path.node.declaration)) {\n+      // export default function configFunction() { ... }\n+      configFunctions.push(path.get('declaration'))\n+    } else if (j.Identifier.check(path.node.declaration)) {\n+      exportedNames.add(path.node.declaration.name)\n+    }\n+  })\n+\n+  // Handle: module.exports = function\n+  root\n+    .find(j.AssignmentExpression, {\n+      left: {\n+        type: 'MemberExpression',\n+        object: { name: 'module' },\n+        property: { name: 'exports' },\n+      },\n+    })\n+    .forEach((path: ASTPath<any>) => {\n+      if (j.FunctionExpression.check(path.node.right)) {\n+        // module.exports = function() { ... }\n+        configFunctions.push(path.get('right'))\n+      } else if (j.Identifier.check(path.node.right)) {\n+        exportedNames.add(path.node.right.name)\n+      }\n+    })\n+\n+  // Find function declarations for exported names\n+  exportedNames.forEach((name) => {\n+    root\n+      .find(j.FunctionDeclaration, { id: { name } })\n+      .forEach((path: ASTPath<any>) => {\n+        configFunctions.push(path)\n+      })\n+  })\n+\n+  return configFunctions\n+}\n+\n+function findNextConfigArrowFunctions(\n+  root: Collection<any>,\n+  j: API['j']\n+): ASTPath<any>[] {\n+  const configArrowFunctions: ASTPath<any>[] = []\n+  const exportedNames = new Set<string>()\n+\n+  // Handle: export default arrowFunction\n+  root.find(j.ExportDefaultDeclaration).forEach((path: ASTPath<any>) => {\n+    if (j.ArrowFunctionExpression.check(path.node.declaration)) {\n+      // export default () => { ... }\n+      configArrowFunctions.push(path.get('declaration'))\n+    } else if (j.Identifier.check(path.node.declaration)) {\n+      exportedNames.add(path.node.declaration.name)\n+    }\n+  })\n+\n+  // Handle: module.exports = arrowFunction\n+  root\n+    .find(j.AssignmentExpression, {\n+      left: {\n+        type: 'MemberExpression',\n+        object: { name: 'module' },\n+        property: { name: 'exports' },\n+      },\n+    })\n+    .forEach((path: ASTPath<any>) => {\n+      if (j.ArrowFunctionExpression.check(path.node.right)) {\n+        // module.exports = () => { ... }\n+        configArrowFunctions.push(path.get('right'))\n+      } else if (j.Identifier.check(path.node.right)) {\n+        exportedNames.add(path.node.right.name)\n+      }\n+    })\n+\n+  // Find variable declarations with arrow functions for exported names\n+  exportedNames.forEach((name) => {\n+    root\n+      .find(j.VariableDeclarator, { id: { name } })\n+      .forEach((path: ASTPath<any>) => {\n+        if (j.ArrowFunctionExpression.check(path.node.init)) {\n+          configArrowFunctions.push(path.get('init'))\n+        }\n+      })\n+  })\n+\n+  return configArrowFunctions\n+}\n+\n+function extractObjectsFromCallExpression(\n+  callExpr: any,\n+  configObjects: ASTPath<any>[],\n+  exportedNames: Set<string>,\n+  j: API['j']\n+): void {\n+  // Recursively extract arguments from call expressions\n+  // E.g., wrapper(anotherWrapper(config)) or wrapper(config)\n+  if (callExpr.arguments) {\n+    callExpr.arguments.forEach((arg: any) => {\n+      if (j.Identifier.check(arg)) {\n+        exportedNames.add(arg.name)\n+      } else if (j.ObjectExpression.check(arg)) {\n+        // This would be unusual but handle direct object arguments\n+        // We don't have the path here, so we'll skip this case\n+        // It would be handled by the direct export case anyway\n+      } else if (j.CallExpression.check(arg)) {\n+        extractObjectsFromCallExpression(arg, configObjects, exportedNames, j)\n+      }\n+    })\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 753,
        "additions": 736,
        "deletions": 17
    }
}