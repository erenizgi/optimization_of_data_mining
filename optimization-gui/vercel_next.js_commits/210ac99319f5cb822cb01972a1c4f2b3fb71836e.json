{
    "author": "timneutkens",
    "message": "Turbopack: Skip loading webpack plugin (#84125)\n\n## What?\n\nDon't load the webpack build-manifest-plugin because it imports some\nwebpack pieces.",
    "sha": "210ac99319f5cb822cb01972a1c4f2b3fb71836e",
    "files": [
        {
            "sha": "af69068d302653c15514d853abe2365a58848b4d",
            "filename": "packages/next/src/build/webpack/plugins/build-manifest-plugin-utils.ts",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/210ac99319f5cb822cb01972a1c4f2b3fb71836e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/210ac99319f5cb822cb01972a1c4f2b3fb71836e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin-utils.ts?ref=210ac99319f5cb822cb01972a1c4f2b3fb71836e",
            "patch": "@@ -0,0 +1,81 @@\n+import type { CustomRoutes, Rewrite } from '../../../lib/load-custom-routes'\n+import type { BuildManifest } from '../../../server/get-page-files'\n+\n+export type ClientBuildManifest = {\n+  [key: string]: string[]\n+}\n+\n+// Add the runtime ssg manifest file as a lazy-loaded file dependency.\n+// We also stub this file out for development mode (when it is not\n+// generated).\n+export const srcEmptySsgManifest = `self.__SSG_MANIFEST=new Set;self.__SSG_MANIFEST_CB&&self.__SSG_MANIFEST_CB()`\n+\n+function normalizeRewrite(item: {\n+  source: string\n+  destination: string\n+  has?: any\n+}): CustomRoutes['rewrites']['beforeFiles'][0] {\n+  return {\n+    has: item.has,\n+    source: item.source,\n+    destination: item.destination,\n+  }\n+}\n+\n+export const processRoute = (r: Rewrite) => {\n+  const rewrite = { ...r }\n+\n+  // omit external rewrite destinations since these aren't\n+  // handled client-side\n+  if (!rewrite?.destination?.startsWith('/')) {\n+    delete (rewrite as any).destination\n+  }\n+  return rewrite\n+}\n+\n+export function normalizeRewritesForBuildManifest(\n+  rewrites: CustomRoutes['rewrites']\n+): CustomRoutes['rewrites'] {\n+  return {\n+    afterFiles: rewrites.afterFiles\n+      ?.map(processRoute)\n+      ?.map((item) => normalizeRewrite(item)),\n+    beforeFiles: rewrites.beforeFiles\n+      ?.map(processRoute)\n+      ?.map((item) => normalizeRewrite(item)),\n+    fallback: rewrites.fallback\n+      ?.map(processRoute)\n+      ?.map((item) => normalizeRewrite(item)),\n+  }\n+}\n+\n+export function createEdgeRuntimeManifest(\n+  originAssetMap: Partial<BuildManifest>\n+): string {\n+  const manifestFilenames = ['_buildManifest.js', '_ssgManifest.js']\n+\n+  const assetMap: Partial<BuildManifest> = {\n+    ...originAssetMap,\n+    lowPriorityFiles: [],\n+  }\n+\n+  // we use globalThis here because middleware can be node\n+  // which doesn't have \"self\"\n+  const manifestDefCode = `globalThis.__BUILD_MANIFEST = ${JSON.stringify(\n+    assetMap,\n+    null,\n+    2\n+  )};\\n`\n+  // edge lowPriorityFiles item: '\"/static/\" + process.env.__NEXT_BUILD_ID + \"/low-priority.js\"'.\n+  // Since lowPriorityFiles is not fixed and relying on `process.env.__NEXT_BUILD_ID`, we'll produce code creating it dynamically.\n+  const lowPriorityFilesCode =\n+    `globalThis.__BUILD_MANIFEST.lowPriorityFiles = [\\n` +\n+    manifestFilenames\n+      .map((filename) => {\n+        return `\"/static/\" + process.env.__NEXT_BUILD_ID + \"/${filename}\",\\n`\n+      })\n+      .join(',') +\n+    `\\n];`\n+\n+  return manifestDefCode + lowPriorityFilesCode\n+}"
        },
        {
            "sha": "b07975568af08d35927019735249fe061598edcf",
            "filename": "packages/next/src/build/webpack/plugins/build-manifest-plugin.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 80,
            "changes": 88,
            "blob_url": "https://github.com/vercel/next.js/blob/210ac99319f5cb822cb01972a1c4f2b3fb71836e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/210ac99319f5cb822cb01972a1c4f2b3fb71836e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts?ref=210ac99319f5cb822cb01972a1c4f2b3fb71836e",
            "patch": "@@ -1,5 +1,5 @@\n import type { BloomFilter } from '../../../shared/lib/bloom-filter'\n-import type { Rewrite, CustomRoutes } from '../../../lib/load-custom-routes'\n+import type { CustomRoutes } from '../../../lib/load-custom-routes'\n import devalue from 'next/dist/compiled/devalue'\n import { webpack, sources } from 'next/dist/compiled/webpack/webpack'\n import {\n@@ -19,82 +19,21 @@ import { ampFirstEntryNamesMap } from './next-drop-client-page-plugin'\n import { getSortedRoutes } from '../../../shared/lib/router/utils'\n import { Span } from '../../../trace'\n import { getCompilationSpan } from '../utils'\n+import {\n+  createEdgeRuntimeManifest,\n+  normalizeRewritesForBuildManifest,\n+  processRoute,\n+  srcEmptySsgManifest,\n+  type ClientBuildManifest,\n+} from './build-manifest-plugin-utils'\n \n type DeepMutable<T> = { -readonly [P in keyof T]: DeepMutable<T[P]> }\n \n-export type ClientBuildManifest = {\n-  [key: string]: string[]\n-}\n-\n-// Add the runtime ssg manifest file as a lazy-loaded file dependency.\n-// We also stub this file out for development mode (when it is not\n-// generated).\n-export const srcEmptySsgManifest = `self.__SSG_MANIFEST=new Set;self.__SSG_MANIFEST_CB&&self.__SSG_MANIFEST_CB()`\n-\n // nodejs: '/static/<build id>/low-priority.js'\n function buildNodejsLowPriorityPath(filename: string, buildId: string) {\n   return `${CLIENT_STATIC_FILES_PATH}/${buildId}/${filename}`\n }\n \n-export function createEdgeRuntimeManifest(\n-  originAssetMap: Partial<BuildManifest>\n-): string {\n-  const manifestFilenames = ['_buildManifest.js', '_ssgManifest.js']\n-\n-  const assetMap: Partial<BuildManifest> = {\n-    ...originAssetMap,\n-    lowPriorityFiles: [],\n-  }\n-\n-  // we use globalThis here because middleware can be node\n-  // which doesn't have \"self\"\n-  const manifestDefCode = `globalThis.__BUILD_MANIFEST = ${JSON.stringify(\n-    assetMap,\n-    null,\n-    2\n-  )};\\n`\n-  // edge lowPriorityFiles item: '\"/static/\" + process.env.__NEXT_BUILD_ID + \"/low-priority.js\"'.\n-  // Since lowPriorityFiles is not fixed and relying on `process.env.__NEXT_BUILD_ID`, we'll produce code creating it dynamically.\n-  const lowPriorityFilesCode =\n-    `globalThis.__BUILD_MANIFEST.lowPriorityFiles = [\\n` +\n-    manifestFilenames\n-      .map((filename) => {\n-        return `\"/static/\" + process.env.__NEXT_BUILD_ID + \"/${filename}\",\\n`\n-      })\n-      .join(',') +\n-    `\\n];`\n-\n-  return manifestDefCode + lowPriorityFilesCode\n-}\n-\n-function normalizeRewrite(item: {\n-  source: string\n-  destination: string\n-  has?: any\n-}): CustomRoutes['rewrites']['beforeFiles'][0] {\n-  return {\n-    has: item.has,\n-    source: item.source,\n-    destination: item.destination,\n-  }\n-}\n-\n-export function normalizeRewritesForBuildManifest(\n-  rewrites: CustomRoutes['rewrites']\n-): CustomRoutes['rewrites'] {\n-  return {\n-    afterFiles: rewrites.afterFiles\n-      ?.map(processRoute)\n-      ?.map((item) => normalizeRewrite(item)),\n-    beforeFiles: rewrites.beforeFiles\n-      ?.map(processRoute)\n-      ?.map((item) => normalizeRewrite(item)),\n-    fallback: rewrites.fallback\n-      ?.map(processRoute)\n-      ?.map((item) => normalizeRewrite(item)),\n-  }\n-}\n-\n // This function takes the asset map generated in BuildManifestPlugin and creates a\n // reduced version to send to the client.\n export function generateClientManifest(\n@@ -161,17 +100,6 @@ export function getEntrypointFiles(entrypoint: any): string[] {\n   )\n }\n \n-export const processRoute = (r: Rewrite) => {\n-  const rewrite = { ...r }\n-\n-  // omit external rewrite destinations since these aren't\n-  // handled client-side\n-  if (!rewrite?.destination?.startsWith('/')) {\n-    delete (rewrite as any).destination\n-  }\n-  return rewrite\n-}\n-\n // This plugin creates a build-manifest.json for all assets that are being output\n // It has a mapping of \"entry\" filename to real filename. Because the real filename can be hashed in production\n export default class BuildManifestPlugin {"
        },
        {
            "sha": "f75b4442324cdaf5ad5552c461a756239cddcbb6",
            "filename": "packages/next/src/shared/lib/turbopack/manifest-loader.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/210ac99319f5cb822cb01972a1c4f2b3fb71836e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/210ac99319f5cb822cb01972a1c4f2b3fb71836e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts?ref=210ac99319f5cb822cb01972a1c4f2b3fb71836e",
            "patch": "@@ -33,13 +33,6 @@ import type { SetupOpts } from '../../../server/lib/router-utils/setup-dev-bundl\n import { deleteCache } from '../../../server/dev/require-cache'\n import { writeFileAtomic } from '../../../lib/fs/write-atomic'\n import { isInterceptionRouteRewrite } from '../../../lib/generate-interception-routes-rewrites'\n-import {\n-  type ClientBuildManifest,\n-  normalizeRewritesForBuildManifest,\n-  srcEmptySsgManifest,\n-  processRoute,\n-  createEdgeRuntimeManifest,\n-} from '../../../build/webpack/plugins/build-manifest-plugin'\n import getAssetPathFromRoute from '../router/utils/get-asset-path-from-route'\n import { getEntryKey, type EntryKey } from './entry-key'\n import type { CustomRoutes } from '../../../lib/load-custom-routes'\n@@ -53,6 +46,13 @@ import {\n import { tryToParsePath } from '../../../lib/try-to-parse-path'\n import { safePathToRegexp } from '../router/utils/route-match-utils'\n import type { Entrypoints } from '../../../build/swc/types'\n+import {\n+  normalizeRewritesForBuildManifest,\n+  type ClientBuildManifest,\n+  srcEmptySsgManifest,\n+  processRoute,\n+  createEdgeRuntimeManifest,\n+} from '../../../build/webpack/plugins/build-manifest-plugin-utils'\n \n interface InstrumentationDefinition {\n   files: string[]"
        }
    ],
    "stats": {
        "total": 183,
        "additions": 96,
        "deletions": 87
    }
}