{
    "author": "huozhi",
    "message": "[segment explorer] normalize path when running inside monorepo (#82146)\n\nWhen you running `pnpm next <project path>` from the monorepo root with turbopack and the `<project path>` is not same as your root directory, this lead the unrelated paths outside of the next.js project are also included into the segment explorer file paths. Because in turbopack the current directory is changed to `[project]` after bundling so that we didn't get the correct relative path when running segment explorer.\r\n\r\nThe absolute path is formatted as `<project-root>/<cwd>`,  and the `<project root>` will be included into the path if the working directory is not same as the next.js directory. The PR fixes the issue by extracting the `<project-root>` from the absolute path, and also stripped from the segment explorer paths.\r\n\r\nCloses NEXT-4651",
    "sha": "5321ba84c30aac57c55e39ed13b2f6356db20cd7",
    "files": [
        {
            "sha": "3a3bc50c7f535f72547f00e33c2c9ac62d7ca84d",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5321ba84c30aac57c55e39ed13b2f6356db20cd7/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5321ba84c30aac57c55e39ed13b2f6356db20cd7/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=5321ba84c30aac57c55e39ed13b2f6356db20cd7",
            "patch": "@@ -4145,9 +4145,9 @@ const getGlobalErrorStyles = async (\n   }\n   if (ctx.renderOpts.dev) {\n     const dir =\n-      process.env.NEXT_RUNTIME === 'edge'\n-        ? process.env.__NEXT_EDGE_PROJECT_DIR!\n-        : ctx.renderOpts.dir || ''\n+      (process.env.NEXT_RUNTIME === 'edge'\n+        ? process.env.__NEXT_EDGE_PROJECT_DIR\n+        : ctx.renderOpts.dir) || ''\n \n     const globalErrorModulePath = normalizeConventionFilePath(\n       dir,"
        },
        {
            "sha": "ee173548df235582157e0bd3572ea48a69a40212",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5321ba84c30aac57c55e39ed13b2f6356db20cd7/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5321ba84c30aac57c55e39ed13b2f6356db20cd7/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=5321ba84c30aac57c55e39ed13b2f6356db20cd7",
            "patch": "@@ -417,9 +417,9 @@ async function createComponentTreeInternal(\n     process.env.NODE_ENV === 'development' &&\n     ctx.renderOpts.devtoolSegmentExplorer\n   const dir =\n-    process.env.NEXT_RUNTIME === 'edge'\n-      ? process.env.__NEXT_EDGE_PROJECT_DIR!\n-      : ctx.renderOpts.dir || ''\n+    (process.env.NEXT_RUNTIME === 'edge'\n+      ? process.env.__NEXT_EDGE_PROJECT_DIR\n+      : ctx.renderOpts.dir) || ''\n \n   // Use the same condition to render metadataOutlet as metadata\n   const metadataOutlet = StreamingMetadataOutlet ? (\n@@ -1139,9 +1139,9 @@ async function createBoundaryConventionElement({\n     process.env.NODE_ENV === 'development' &&\n     ctx.renderOpts.devtoolSegmentExplorer\n   const dir =\n-    process.env.NEXT_RUNTIME === 'edge'\n-      ? process.env.__NEXT_EDGE_PROJECT_DIR!\n-      : ctx.renderOpts.dir || ''\n+    (process.env.NEXT_RUNTIME === 'edge'\n+      ? process.env.__NEXT_EDGE_PROJECT_DIR\n+      : ctx.renderOpts.dir) || ''\n   const { SegmentViewNode } = ctx.componentMod\n   const element = Component ? (\n     <>"
        },
        {
            "sha": "852f2204e8a9da1df306d3f5906533344f3fe862",
            "filename": "packages/next/src/server/app-render/segment-explorer-path.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5321ba84c30aac57c55e39ed13b2f6356db20cd7/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fsegment-explorer-path.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5321ba84c30aac57c55e39ed13b2f6356db20cd7/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fsegment-explorer-path.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fsegment-explorer-path.ts?ref=5321ba84c30aac57c55e39ed13b2f6356db20cd7",
            "patch": "@@ -9,11 +9,17 @@ export function normalizeConventionFilePath(\n   projectDir: string,\n   conventionPath: string | undefined\n ) {\n+  // Turbopack project path is formed as: \"<project root>/<cwd>\".\n+  // When project root is not the working directory, we can extract the relative project root path.\n+  // This is mostly used for running Next.js inside a monorepo.\n   const cwd = process.env.NEXT_RUNTIME === 'edge' ? '' : process.cwd()\n+  const relativeProjectRoot = projectDir.replace(cwd, '')\n \n   let relativePath = (conventionPath || '')\n     // remove turbopack [project] prefix\n-    .replace(/^\\[project\\][\\\\/]/, '')\n+    .replace(/^\\[project\\]/, '')\n+    // remove turbopack relative project path, everything after [project] and before the working directory.\n+    .replace(relativeProjectRoot, '')\n     // remove the project root from the path\n     .replace(projectDir, '')\n     // remove cwd prefix"
        }
    ],
    "stats": {
        "total": 26,
        "additions": 16,
        "deletions": 10
    }
}