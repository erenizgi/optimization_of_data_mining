{
    "author": "huozhi",
    "message": "[build] remove devtool from client chunks in prod (#81376)",
    "sha": "6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
    "files": [
        {
            "sha": "41fa914ddbce9102c3e6a3dcb7564027bb27a1d1",
            "filename": "packages/next/src/client/app-globals.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Fapp-globals.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Fapp-globals.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-globals.ts?ref=6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
            "patch": "@@ -0,0 +1,7 @@\n+// imports polyfill from `@next/polyfill-module` after build.\n+import '../build/polyfills/polyfill-module'\n+\n+// Only setup devtools in development\n+if (process.env.NODE_ENV !== 'production') {\n+  require('../next-devtools/userspace/app/app-dev-overlay-setup') as typeof import('../next-devtools/userspace/app/app-dev-overlay-setup')\n+}"
        },
        {
            "sha": "01503aef0c2598f786a8f8063847087155a5f4d2",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
            "patch": "@@ -1,8 +1,4 @@\n-// imports polyfill from `@next/polyfill-module` after build.\n-import '../build/polyfills/polyfill-module'\n-\n-import '../next-devtools/userspace/app/app-dev-overlay-setup'\n-\n+import './app-globals'\n import ReactDOMClient from 'react-dom/client'\n import React, { use } from 'react'\n // TODO: Explicitly import from client.browser"
        },
        {
            "sha": "08c98d8b5df0a371d84e9a25d81f6b3f3c8f9a95",
            "filename": "packages/next/src/client/app-next-turbopack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-next-turbopack.ts?ref=6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
            "patch": "@@ -1,8 +1,4 @@\n import { appBootstrap } from './app-bootstrap'\n-import {\n-  getComponentStack,\n-  getOwnerStack,\n-} from '../next-devtools/userspace/app/errors/stitched-error'\n import { isRecoverableError } from './react-client-callbacks/on-recoverable-error'\n \n window.next.version += '-turbo'\n@@ -17,6 +13,8 @@ appBootstrap(() => {\n     hydrate(instrumentationHooks)\n   } finally {\n     if (process.env.NODE_ENV !== 'production') {\n+      const { getComponentStack, getOwnerStack } =\n+        require('../next-devtools/userspace/app/errors/stitched-error') as typeof import('../next-devtools/userspace/app/errors/stitched-error')\n       const { renderAppDevOverlay } =\n         require('next/dist/compiled/next-devtools') as typeof import('next/dist/compiled/next-devtools')\n       renderAppDevOverlay(getComponentStack, getOwnerStack, isRecoverableError)"
        },
        {
            "sha": "e0de144515827deebf0e01ed7c5519dd5c749631",
            "filename": "packages/next/src/client/react-client-callbacks/error-boundary-callbacks.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 26,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Ferror-boundary-callbacks.ts?ref=6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
            "patch": "@@ -1,19 +1,21 @@\n // This file is only used in app router due to the specific error state handling.\n \n import type { ErrorInfo } from 'react'\n-import {\n-  setOwnerStackIfAvailable,\n-  setComponentStack,\n-  coerceError,\n-} from '../../next-devtools/userspace/app/errors/stitched-error'\n-import { handleClientError } from '../../next-devtools/userspace/app/errors/use-error-handler'\n import { isNextRouterError } from '../components/is-next-router-error'\n import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n import { reportGlobalError } from './report-global-error'\n-import { originConsoleError } from '../../next-devtools/userspace/app/errors/intercept-console-error'\n import { ErrorBoundaryHandler } from '../components/error-boundary'\n import DefaultErrorBoundary from '../components/builtin/global-error'\n \n+const devToolErrorMod: typeof import('../../next-devtools/userspace/app/errors') =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../../next-devtools/userspace/app/errors') as typeof import('../../next-devtools/userspace/app/errors'))\n+    : {\n+        decorateDevError: (error: unknown) => error as Error,\n+        handleClientError: () => {},\n+        originConsoleError: console.error.bind(console),\n+      }\n+\n export function onCaughtError(\n   thrownValue: unknown,\n   errorInfo: ErrorInfo & { errorBoundary?: React.Component }\n@@ -82,21 +84,14 @@ export function onCaughtError(\n       : `The above error occurred in one of your components.`\n \n     const errorLocation = `${componentErrorMessage} ${errorBoundaryMessage}`\n-\n-    const error = coerceError(thrownValue)\n-    setOwnerStackIfAvailable(error)\n-    // TODO: change to passing down errorInfo later\n-    // In development mode, pass along the component stack to the error\n-    if (errorInfo.componentStack) {\n-      setComponentStack(error, errorInfo.componentStack)\n-    }\n+    const error = devToolErrorMod.decorateDevError(thrownValue, errorInfo)\n \n     // Log and report the error with location but without modifying the error stack\n-    originConsoleError('%o\\n\\n%s', thrownValue, errorLocation)\n+    devToolErrorMod.originConsoleError('%o\\n\\n%s', thrownValue, errorLocation)\n \n-    handleClientError(error)\n+    devToolErrorMod.handleClientError(error)\n   } else {\n-    originConsoleError(thrownValue)\n+    devToolErrorMod.originConsoleError(thrownValue)\n   }\n }\n \n@@ -108,14 +103,7 @@ export function onUncaughtError(\n   if (isBailoutToCSRError(thrownValue) || isNextRouterError(thrownValue)) return\n \n   if (process.env.NODE_ENV !== 'production') {\n-    const error = coerceError(thrownValue)\n-    setOwnerStackIfAvailable(error)\n-\n-    // TODO: change to passing down errorInfo later\n-    // In development mode, pass along the component stack to the error\n-    if (errorInfo.componentStack) {\n-      setComponentStack(error, errorInfo.componentStack)\n-    }\n+    const error = devToolErrorMod.decorateDevError(thrownValue, errorInfo)\n \n     // TODO: Add an adendum to the overlay telling people about custom error boundaries.\n     reportGlobalError(error)"
        },
        {
            "sha": "a1c047f716773be0e95ec5ab56e627f61a8c1dfc",
            "filename": "packages/next/src/client/react-client-callbacks/on-recoverable-error.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 13,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Freact-client-callbacks%2Fon-recoverable-error.ts?ref=6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
            "patch": "@@ -2,11 +2,6 @@\n \n import type { HydrationOptions } from 'react-dom/client'\n import { isBailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n-import {\n-  setOwnerStackIfAvailable,\n-  setComponentStack,\n-  coerceError,\n-} from '../../next-devtools/userspace/app/errors/stitched-error'\n import isError from '../../lib/is-error'\n import { reportGlobalError } from './report-global-error'\n \n@@ -21,17 +16,17 @@ export const onRecoverableError: HydrationOptions['onRecoverableError'] = (\n   errorInfo\n ) => {\n   // x-ref: https://github.com/facebook/react/pull/28736\n-  const cause = isError(error) && 'cause' in error ? error.cause : error\n+  let cause = isError(error) && 'cause' in error ? error.cause : error\n   // Skip certain custom errors which are not expected to be reported on client\n   if (isBailoutToCSRError(cause)) return\n \n-  const causeError = coerceError(cause)\n-  recoverableErrors.add(causeError)\n-  setOwnerStackIfAvailable(causeError)\n-\n-  if (process.env.NODE_ENV === 'development' && errorInfo.componentStack) {\n-    setComponentStack(causeError, errorInfo.componentStack)\n+  if (process.env.NODE_ENV !== 'production') {\n+    const { decorateDevError } =\n+      require('../../next-devtools/userspace/app/errors/stitched-error') as typeof import('../../next-devtools/userspace/app/errors/stitched-error')\n+    const causeError = decorateDevError(cause, errorInfo)\n+    recoverableErrors.add(causeError)\n+    cause = causeError\n   }\n \n-  reportGlobalError(causeError)\n+  reportGlobalError(cause)\n }"
        },
        {
            "sha": "0e851e2322d7ef0d421351ef87005292acd06023",
            "filename": "packages/next/src/next-devtools/userspace/app/errors/index.ts",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Findex.ts?ref=6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
            "patch": "@@ -0,0 +1,3 @@\n+export { originConsoleError } from './intercept-console-error'\n+export { handleClientError } from './use-error-handler'\n+export { decorateDevError } from './stitched-error'"
        },
        {
            "sha": "aa75090bbd61e5f1f1d19b3fa992c25a57477617",
            "filename": "packages/next/src/next-devtools/userspace/app/errors/stitched-error.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Fstitched-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Fstitched-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fuserspace%2Fapp%2Ferrors%2Fstitched-error.ts?ref=6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
            "patch": "@@ -28,3 +28,17 @@ export function setOwnerStackIfAvailable(error: Error): void {\n     setOwnerStack(error, React.captureOwnerStack())\n   }\n }\n+\n+export function decorateDevError(\n+  thrownValue: unknown,\n+  errorInfo: React.ErrorInfo\n+) {\n+  const error = coerceError(thrownValue)\n+  setOwnerStackIfAvailable(error)\n+  // TODO: change to passing down errorInfo later\n+  // In development mode, pass along the component stack to the error\n+  if (errorInfo.componentStack) {\n+    setComponentStack(error, errorInfo.componentStack)\n+  }\n+  return error\n+}"
        },
        {
            "sha": "7423a7b2728c61aece0fe5993bf4562daf026593",
            "filename": "test/production/app-dir/browser-chunks/browser-chunks.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6ae87df4ba6d0e0ea016200fb17434344ce4ca42/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts?ref=6ae87df4ba6d0e0ea016200fb17434344ce4ca42",
            "patch": "@@ -34,7 +34,7 @@ describe('browser-chunks', () => {\n \n   it('must not bundle any dev overlay into browser chunks', () => {\n     const devOverlaySources = sources.filter((source) => {\n-      return source.includes('next-devtools/dev-overlay')\n+      return source.includes('next-devtools')\n     })\n \n     if (devOverlaySources.length > 0) {"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 50,
        "deletions": 49
    }
}