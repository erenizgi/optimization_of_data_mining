{
    "author": "sokra",
    "message": "Turbopack: sort keys in individual to make order deterministic (#82891)\n\n### What?\n\nTo avoid invalidation due to changed ordering, sort the items.",
    "sha": "0ed99f10c97e9cca47aad6d31023c9604a11c320",
    "files": [
        {
            "sha": "0737a64b681def8cb314f2b8fd93be8fee8364f5",
            "filename": "turbopack/crates/turbopack-core/src/compile_time_info.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/0ed99f10c97e9cca47aad6d31023c9604a11c320/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ed99f10c97e9cca47aad6d31023c9604a11c320/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcompile_time_info.rs?ref=0ed99f10c97e9cca47aad6d31023c9604a11c320",
            "patch": "@@ -154,7 +154,7 @@ impl From<serde_json::Value> for CompileTimeDefineValue {\n }\n \n #[turbo_tasks::value]\n-#[derive(Debug, Clone, Hash)]\n+#[derive(Debug, Clone, Hash, PartialOrd, Ord)]\n pub enum DefinableNameSegment {\n     Name(RcStr),\n     TypeOf,\n@@ -206,12 +206,16 @@ impl CompileTimeDefines {\n \n     #[turbo_tasks::function]\n     pub fn individual(&self) -> Vc<CompileTimeDefinesIndividual> {\n-        Vc::cell(\n+        let mut map: FxIndexMap<Vec<DefinableNameSegment>, ResolvedVc<CompileTimeDefineValue>> =\n             self.0\n                 .iter()\n                 .map(|(key, value)| (key.clone(), value.clone().resolved_cell()))\n-                .collect(),\n-        )\n+                .collect();\n+\n+        // Sort keys to make order as deterministic as possible\n+        map.sort_keys();\n+\n+        Vc::cell(map)\n     }\n }\n \n@@ -303,6 +307,10 @@ impl FreeVarReferences {\n                 .insert(key.to_vec(), value.clone().resolved_cell());\n         }\n \n+        // Sort keys to make order as deterministic as possible\n+        result.sort_keys();\n+        result.iter_mut().for_each(|(_, inner)| inner.sort_keys());\n+\n         Vc::cell(result)\n     }\n }"
        }
    ],
    "stats": {
        "total": 16,
        "additions": 12,
        "deletions": 4
    }
}