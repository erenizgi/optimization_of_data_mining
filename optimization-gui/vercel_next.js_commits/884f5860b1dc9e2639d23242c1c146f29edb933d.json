{
    "author": "Karibash",
    "message": "bugfix: Fix a bug that caused conflicting assets when adding a child compiler (#78011)\n\nfixes #76930\n\n## Summary\n\nFixes an issue where using a Webpack plugin that creates child compilers\nin a Next.js project could result in asset emission conflicts.\n\n## Description\n\nStarting from\n[vercel/next.js#75927](https://github.com/vercel/next.js/pull/75927),\nNext.js uses compilation.emitAsset to emit assets. However, emitAsset\nthrows an error when attempting to emit an asset with the same name and\nidentical content more than once.\nThis behavior is defined in Webpack's implementation:\n\nhttps://github.com/webpack/webpack/blob/70e3d9d5dbd3548431b8878dead4647beff5c14f/lib/Compilation.js#L4615-L4628\n\nWhen a plugin hooks into the compilation phase, it also runs for child\ncompilers. This can lead to duplicated asset emission when using plugins\nthat spawn child compilers, such as\n[vanilla-extract](https://github.com/vanilla-extract-css/vanilla-extract/blob/c66be53d600802b2922da1d6034e2a5ff3fbbcae/packages/webpack-plugin/src/compiler.ts#L85-L89).\n\nTo prevent this, we now use the thisCompilation hook instead of\ncompilation, which ensures that the plugin only applies to the main\ncompilation and not to any child compilers.\n\n---------\n\nCo-authored-by: Tobias Koppers <tobias.koppers@googlemail.com>\nCo-authored-by: Will Binns-Smith <wbinnssmith@gmail.com>",
    "sha": "884f5860b1dc9e2639d23242c1c146f29edb933d",
    "files": [
        {
            "sha": "cebb850c57e7887436be5e197d4f3cfafb8eb2ba",
            "filename": "packages/next/src/build/webpack/plugins/flight-manifest-plugin.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts?ref=884f5860b1dc9e2639d23242c1c146f29edb933d",
            "patch": "@@ -223,7 +223,7 @@ export class ClientReferenceManifestPlugin {\n   }\n \n   apply(compiler: webpack.Compiler) {\n-    compiler.hooks.compilation.tap(PLUGIN_NAME, (compilation) => {\n+    compiler.hooks.thisCompilation.tap(PLUGIN_NAME, (compilation) => {\n       compilation.hooks.processAssets.tap(\n         {\n           name: PLUGIN_NAME,"
        },
        {
            "sha": "1d28e5e47a55ca27b48aff706e9739748e50792c",
            "filename": "packages/next/src/build/webpack/plugins/middleware-plugin.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts?ref=884f5860b1dc9e2639d23242c1c146f29edb933d",
            "patch": "@@ -781,7 +781,7 @@ export default class MiddlewarePlugin {\n   }\n \n   public apply(compiler: webpack.Compiler) {\n-    compiler.hooks.compilation.tap(NAME, (compilation, params) => {\n+    compiler.hooks.thisCompilation.tap(NAME, (compilation, params) => {\n       const { hooks } = params.normalModuleFactory\n       /**\n        * This is the static code analysis phase."
        },
        {
            "sha": "5548c008d971f7d06fb7be1696c448cf91ec7429",
            "filename": "packages/next/src/build/webpack/plugins/next-trace-entrypoints-plugin.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts?ref=884f5860b1dc9e2639d23242c1c146f29edb933d",
            "patch": "@@ -575,7 +575,7 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n   }\n \n   apply(compiler: webpack.Compiler) {\n-    compiler.hooks.compilation.tap(PLUGIN_NAME, (compilation) => {\n+    compiler.hooks.thisCompilation.tap(PLUGIN_NAME, (compilation) => {\n       const compilationSpan =\n         getCompilationSpan(compilation) || getCompilationSpan(compiler)!\n       const traceEntrypointsPluginSpan = compilationSpan.traceChild("
        },
        {
            "sha": "997d639032b1f5c79220883e95a245ea3071f585",
            "filename": "packages/next/src/build/webpack/plugins/next-types-plugin/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts?ref=884f5860b1dc9e2639d23242c1c146f29edb933d",
            "patch": "@@ -1003,7 +1003,7 @@ export class NextTypesPlugin {\n       }\n     }\n \n-    compiler.hooks.compilation.tap(PLUGIN_NAME, (compilation) => {\n+    compiler.hooks.thisCompilation.tap(PLUGIN_NAME, (compilation) => {\n       compilation.hooks.processAssets.tapAsync(\n         {\n           name: PLUGIN_NAME,"
        },
        {
            "sha": "2b5e31f565513c488aa1f61f8d766328bfac6885",
            "filename": "packages/next/src/build/webpack/plugins/profiling-plugin.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fprofiling-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/884f5860b1dc9e2639d23242c1c146f29edb933d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fprofiling-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fprofiling-plugin.ts?ref=884f5860b1dc9e2639d23242c1c146f29edb933d",
            "patch": "@@ -91,7 +91,7 @@ export class ProfilingPlugin {\n   traceTopLevelHooks(compiler: any) {\n     this.traceHookPair(\n       'webpack-compilation',\n-      compiler.hooks.compilation,\n+      compiler.hooks.thisCompilation,\n       compiler.hooks.afterCompile,\n       {\n         parentSpan: () =>\n@@ -146,7 +146,7 @@ export class ProfilingPlugin {\n       },\n     })\n \n-    compiler.hooks.compilation.tap(\n+    compiler.hooks.thisCompilation.tap(\n       { name: pluginName, stage: -Infinity },\n       (compilation: any) => {\n         compilation.hooks.buildModule.tap(pluginName, (module: any) => {"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 6,
        "deletions": 6
    }
}