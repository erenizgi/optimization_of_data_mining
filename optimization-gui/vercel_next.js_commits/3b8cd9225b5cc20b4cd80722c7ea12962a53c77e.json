{
    "author": "unstubbable",
    "message": "Fix error logging for `'use cache'` runtime errors in production (#86500)\n\nIn production, when throwing an error in `'use cache'` at runtime, we\nare currently logging the obfuscated error that React is producing when\ncrossing the cache-server boundary. This is not ideal for investigating\nproduction issues so we're also logging the original error in the `'use\ncache'` wrapper as a work-around. But this error does not have a digest,\nwhich makes it non-obvious that it's the same error as the obfuscated\none.\n\nWith this PR we are fixing this by storing the original error (with a\ndigest) in the `reactServerErrorsByDigest` map (moved to the work\nstore), and retrieving it in the server environment when we log the\nerror. Thus the obfuscated error is not logged, and the original error\nwith a digest is logged instead.\n\nIn development, we keep the existing behavior of logging the transported\nerror, which also includes the dev-only `environmentName` property\n`'Cache'`.\n\nAs part of this fix, we're consolidating the\n`createFlightReactServerErrorHandler` and\n`createHTMLReactServerErrorHandler` functions, which had a big overlap\nand confusing names, into a single `createReactServerErrorHandler`\nfunction.\n\ncloses NAR-536",
    "sha": "3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
    "files": [
        {
            "sha": "9c18124ece7f7964416efa302648089adea3b259",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -606,11 +606,17 @@ export async function handler(\n           },\n           onAfterTaskError: () => {},\n \n-          onInstrumentationRequestError: (error, _request, errorContext) =>\n+          onInstrumentationRequestError: (\n+            error,\n+            _request,\n+            errorContext,\n+            silenceLog\n+          ) =>\n             routeModule.onRequestError(\n               req,\n               error,\n               errorContext,\n+              silenceLog,\n               routerServerContext\n             ),\n           err: getRequestMeta(req, 'invokeError'),\n@@ -1414,6 +1420,7 @@ export async function handler(\n     }\n   } catch (err) {\n     if (!(err instanceof NoFallbackError)) {\n+      const silenceLog = false\n       await routeModule.onRequestError(\n         req,\n         err,\n@@ -1426,6 +1433,7 @@ export async function handler(\n             isOnDemandRevalidate,\n           }),\n         },\n+        silenceLog,\n         routerServerContext\n       )\n     }"
        },
        {
            "sha": "eee8857c3607fab4cf3448b5865a5a685f4bf443",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 10,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -215,11 +215,17 @@ export async function handler(\n         res.on('close', cb)\n       },\n       onAfterTaskError: undefined,\n-      onInstrumentationRequestError: (error, _request, errorContext) =>\n+      onInstrumentationRequestError: (\n+        error,\n+        _request,\n+        errorContext,\n+        silenceLog\n+      ) =>\n         routeModule.onRequestError(\n           req,\n           error,\n           errorContext,\n+          silenceLog,\n           routerServerContext\n         ),\n     },\n@@ -369,6 +375,7 @@ export async function handler(\n           // if this is a background revalidate we need to report\n           // the request error here as it won't be bubbled\n           if (previousCacheEntry?.isStale) {\n+            const silenceLog = false\n             await routeModule.onRequestError(\n               req,\n               err,\n@@ -381,6 +388,7 @@ export async function handler(\n                   isOnDemandRevalidate,\n                 }),\n               },\n+              silenceLog,\n               routerServerContext\n             )\n           }\n@@ -488,15 +496,22 @@ export async function handler(\n     }\n   } catch (err) {\n     if (!(err instanceof NoFallbackError)) {\n-      await routeModule.onRequestError(req, err, {\n-        routerKind: 'App Router',\n-        routePath: normalizedSrcPage,\n-        routeType: 'route',\n-        revalidateReason: getRevalidateReason({\n-          isStaticGeneration,\n-          isOnDemandRevalidate,\n-        }),\n-      })\n+      const silenceLog = false\n+      await routeModule.onRequestError(\n+        req,\n+        err,\n+        {\n+          routerKind: 'App Router',\n+          routePath: normalizedSrcPage,\n+          routeType: 'route',\n+          revalidateReason: getRevalidateReason({\n+            isStaticGeneration,\n+            isOnDemandRevalidate,\n+          }),\n+        },\n+        silenceLog,\n+        routerServerContext\n+      )\n     }\n \n     // rethrow so that we can handle serving error page"
        },
        {
            "sha": "58fc2ad9cb602c2423d7b5fd4ea2ed0a866548e7",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 7,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -180,11 +180,17 @@ async function requestHandler(\n       },\n       onAfterTaskError: () => {},\n \n-      onInstrumentationRequestError: (error, _request, errorContext) =>\n+      onInstrumentationRequestError: (\n+        error,\n+        _request,\n+        errorContext,\n+        silenceLog\n+      ) =>\n         pageRouteModule.onRequestError(\n           baseReq,\n           error,\n           errorContext,\n+          silenceLog,\n           routerServerContext\n         ),\n       dev: pageRouteModule.isDev,\n@@ -319,12 +325,18 @@ async function requestHandler(\n \n       return renderResultToResponse(result)\n     } catch (err) {\n-      await pageRouteModule.onRequestError(baseReq, err, {\n-        routerKind: 'App Router',\n-        routePath: normalizedSrcPage,\n-        routeType: 'render',\n-        revalidateReason: undefined,\n-      })\n+      const silenceLog = false\n+      await pageRouteModule.onRequestError(\n+        baseReq,\n+        err,\n+        {\n+          routerKind: 'App Router',\n+          routePath: normalizedSrcPage,\n+          routeType: 'render',\n+          revalidateReason: undefined,\n+        },\n+        silenceLog\n+      )\n       // rethrow so that we can handle serving error page\n       throw err\n     }"
        },
        {
            "sha": "628788c14decb7058498c2c7bf05c85c89cebaf2",
            "filename": "packages/next/src/build/templates/edge-ssr.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 6,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -301,12 +301,18 @@ async function requestHandler(\n         throw err\n       }\n \n-      await errRouteModule.onRequestError(baseReq, err, {\n-        routerKind: 'Pages Router',\n-        routePath: srcPage,\n-        routeType: 'render',\n-        revalidateReason: undefined,\n-      })\n+      const silenceLog = false\n+      await errRouteModule.onRequestError(\n+        baseReq,\n+        err,\n+        {\n+          routerKind: 'Pages Router',\n+          routePath: srcPage,\n+          routeType: 'render',\n+          revalidateReason: undefined,\n+        },\n+        silenceLog\n+      )\n \n       const errResult = await errRouteModule.render(\n         // @ts-expect-error we don't type this for edge"
        },
        {
            "sha": "413209edc73e6a3d33ee31382c0dbb61bd8fbff3",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 60,
            "deletions": 38,
            "changes": 98,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -78,8 +78,7 @@ import { AppRenderSpan, NextNodeServerSpan } from '../lib/trace/constants'\n import { getTracer } from '../lib/trace/tracer'\n import { FlightRenderResult } from './flight-render-result'\n import {\n-  createFlightReactServerErrorHandler,\n-  createHTMLReactServerErrorHandler,\n+  createReactServerErrorHandler,\n   createHTMLErrorHandler,\n   type DigestedError,\n   isUserLandError,\n@@ -611,17 +610,22 @@ async function generateDynamicFlightRenderResult(\n     dev = false,\n     onInstrumentationRequestError,\n     setReactDebugChannel,\n+    nextExport = false,\n   } = renderOpts\n \n-  function onFlightDataRenderError(err: DigestedError) {\n+  function onFlightDataRenderError(err: DigestedError, silenceLog: boolean) {\n     return onInstrumentationRequestError?.(\n       err,\n       req,\n-      createErrorContext(ctx, 'react-server-components-payload')\n+      createErrorContext(ctx, 'react-server-components-payload'),\n+      silenceLog\n     )\n   }\n-  const onError = createFlightReactServerErrorHandler(\n+\n+  const onError = createReactServerErrorHandler(\n     dev,\n+    nextExport,\n+    workStore.reactServerErrorsByDigest,\n     onFlightDataRenderError\n   )\n \n@@ -766,18 +770,23 @@ async function generateDynamicFlightRenderResultWithStagesInDev(\n     setReactDebugChannel,\n     setCacheStatus,\n     clientReferenceManifest,\n+    nextExport = false,\n   } = renderOpts\n   assertClientReferenceManifest(clientReferenceManifest)\n \n-  function onFlightDataRenderError(err: DigestedError) {\n+  function onFlightDataRenderError(err: DigestedError, silenceLog: boolean) {\n     return onInstrumentationRequestError?.(\n       err,\n       req,\n-      createErrorContext(ctx, 'react-server-components-payload')\n+      createErrorContext(ctx, 'react-server-components-payload'),\n+      silenceLog\n     )\n   }\n-  const onError = createFlightReactServerErrorHandler(\n+\n+  const onError = createReactServerErrorHandler(\n     dev,\n+    nextExport,\n+    workStore.reactServerErrorsByDigest,\n     onFlightDataRenderError\n   )\n \n@@ -909,19 +918,23 @@ async function generateRuntimePrefetchResult(\n   ctx: AppRenderContext,\n   requestStore: RequestStore\n ): Promise<RenderResult> {\n-  const { workStore } = ctx\n-  const renderOpts = ctx.renderOpts\n+  const { workStore, renderOpts } = ctx\n+  const { nextExport = false, onInstrumentationRequestError } = renderOpts\n \n-  function onFlightDataRenderError(err: DigestedError) {\n-    return renderOpts.onInstrumentationRequestError?.(\n+  function onFlightDataRenderError(err: DigestedError, silenceLog: boolean) {\n+    return onInstrumentationRequestError?.(\n       err,\n       req,\n       // TODO(runtime-ppr): should we use a different value?\n-      createErrorContext(ctx, 'react-server-components-payload')\n+      createErrorContext(ctx, 'react-server-components-payload'),\n+      silenceLog\n     )\n   }\n-  const onError = createFlightReactServerErrorHandler(\n+\n+  const onError = createReactServerErrorHandler(\n     false,\n+    nextExport,\n+    workStore.reactServerErrorsByDigest,\n     onFlightDataRenderError\n   )\n \n@@ -2601,28 +2614,31 @@ async function renderToStream(\n       ? `self.__next_r=${JSON.stringify(requestId)}`\n       : undefined\n \n-  const reactServerErrorsByDigest: Map<string, DigestedError> = new Map()\n-  const silenceLogger = false\n-  function onHTMLRenderRSCError(err: DigestedError) {\n+  const { reactServerErrorsByDigest } = workStore\n+  function onHTMLRenderRSCError(err: DigestedError, silenceLog: boolean) {\n     return onInstrumentationRequestError?.(\n       err,\n       req,\n-      createErrorContext(ctx, 'react-server-components')\n+      createErrorContext(ctx, 'react-server-components'),\n+      silenceLog\n     )\n   }\n-  const serverComponentsErrorHandler = createHTMLReactServerErrorHandler(\n+  const serverComponentsErrorHandler = createReactServerErrorHandler(\n     dev,\n     nextExport,\n     reactServerErrorsByDigest,\n-    silenceLogger,\n     onHTMLRenderRSCError\n   )\n \n   function onHTMLRenderSSRError(err: DigestedError) {\n+    // We don't need to silence logs here. onHTMLRenderSSRError won't be called\n+    // at all if the error was logged before in the RSC error handler.\n+    const silenceLog = false\n     return onInstrumentationRequestError?.(\n       err,\n       req,\n-      createErrorContext(ctx, 'server-rendering')\n+      createErrorContext(ctx, 'server-rendering'),\n+      silenceLog\n     )\n   }\n \n@@ -2632,7 +2648,6 @@ async function renderToStream(\n     nextExport,\n     reactServerErrorsByDigest,\n     allCapturedErrors,\n-    silenceLogger,\n     onHTMLRenderSSRError\n   )\n \n@@ -4145,38 +4160,45 @@ async function prerenderToStream(\n     page\n   )\n \n-  const reactServerErrorsByDigest: Map<string, DigestedError> = new Map()\n+  const { reactServerErrorsByDigest } = workStore\n   // We don't report errors during prerendering through our instrumentation hooks\n-  const silenceLogger = !!experimental.isRoutePPREnabled\n-  function onHTMLRenderRSCError(err: DigestedError) {\n-    return onInstrumentationRequestError?.(\n-      err,\n-      req,\n-      createErrorContext(ctx, 'react-server-components')\n-    )\n+  const reportErrors = !experimental.isRoutePPREnabled\n+  function onHTMLRenderRSCError(err: DigestedError, silenceLog: boolean) {\n+    if (reportErrors) {\n+      return onInstrumentationRequestError?.(\n+        err,\n+        req,\n+        createErrorContext(ctx, 'react-server-components'),\n+        silenceLog\n+      )\n+    }\n   }\n-  const serverComponentsErrorHandler = createHTMLReactServerErrorHandler(\n+  const serverComponentsErrorHandler = createReactServerErrorHandler(\n     dev,\n     nextExport,\n     reactServerErrorsByDigest,\n-    silenceLogger,\n     onHTMLRenderRSCError\n   )\n \n   function onHTMLRenderSSRError(err: DigestedError) {\n-    return onInstrumentationRequestError?.(\n-      err,\n-      req,\n-      createErrorContext(ctx, 'server-rendering')\n-    )\n+    if (reportErrors) {\n+      // We don't need to silence logs here. onHTMLRenderSSRError won't be\n+      // called at all if the error was logged before in the RSC error handler.\n+      const silenceLog = false\n+      return onInstrumentationRequestError?.(\n+        err,\n+        req,\n+        createErrorContext(ctx, 'server-rendering'),\n+        silenceLog\n+      )\n+    }\n   }\n   const allCapturedErrors: Array<unknown> = []\n   const htmlRendererErrorHandler = createHTMLErrorHandler(\n     dev,\n     nextExport,\n     reactServerErrorsByDigest,\n     allCapturedErrors,\n-    silenceLogger,\n     onHTMLRenderSSRError\n   )\n "
        },
        {
            "sha": "f535783c18abf1c84afc23093091c814a485bfa9",
            "filename": "packages/next/src/server/app-render/create-error-handler.tsx",
            "status": "modified",
            "additions": 40,
            "deletions": 78,
            "changes": 118,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-error-handler.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-error-handler.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-error-handler.tsx?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -22,7 +22,7 @@ type SSRErrorHandler = (\n   errorInfo?: ErrorInfo\n ) => string | undefined\n \n-export type DigestedError = Error & { digest: string }\n+export type DigestedError = Error & { digest: string; environmentName?: string }\n \n /**\n  * Returns a digest for well-known Next.js errors, otherwise `undefined`. If a\n@@ -48,68 +48,11 @@ export function getDigestForWellKnownError(error: unknown): string | undefined {\n   return undefined\n }\n \n-export function createFlightReactServerErrorHandler(\n-  shouldFormatError: boolean,\n-  onReactServerRenderError: (err: DigestedError) => void\n-): RSCErrorHandler {\n-  return (thrownValue: unknown) => {\n-    if (typeof thrownValue === 'string') {\n-      // TODO-APP: look at using webcrypto instead. Requires a promise to be awaited.\n-      return stringHash(thrownValue).toString()\n-    }\n-\n-    // If the response was closed, we don't need to log the error.\n-    if (isAbortError(thrownValue)) return\n-\n-    const digest = getDigestForWellKnownError(thrownValue)\n-\n-    if (digest) {\n-      return digest\n-    }\n-\n-    if (isReactLargeShellError(thrownValue)) {\n-      // TODO: Aggregate\n-      console.error(thrownValue)\n-      return undefined\n-    }\n-\n-    const err = getProperError(thrownValue) as DigestedError\n-\n-    // If the error already has a digest, respect the original digest,\n-    // so it won't get re-generated into another new error.\n-    if (!err.digest) {\n-      // TODO-APP: look at using webcrypto instead. Requires a promise to be awaited.\n-      err.digest = stringHash(err.message + err.stack || '').toString()\n-    }\n-\n-    // Format server errors in development to add more helpful error messages\n-    if (shouldFormatError) {\n-      formatServerError(err)\n-    }\n-\n-    // Record exception in an active span, if available.\n-    const span = getTracer().getActiveScopeSpan()\n-    if (span) {\n-      span.recordException(err)\n-      span.setAttribute('error.type', err.name)\n-      span.setStatus({\n-        code: SpanStatusCode.ERROR,\n-        message: err.message,\n-      })\n-    }\n-\n-    onReactServerRenderError(err)\n-\n-    return createDigestWithErrorCode(thrownValue, err.digest)\n-  }\n-}\n-\n-export function createHTMLReactServerErrorHandler(\n+export function createReactServerErrorHandler(\n   shouldFormatError: boolean,\n   isNextExport: boolean,\n   reactServerErrors: Map<string, DigestedError>,\n-  silenceLogger: boolean,\n-  onReactServerRenderError: undefined | ((err: DigestedError) => void)\n+  onReactServerRenderError: (err: DigestedError, silenceLog: boolean) => void\n ): RSCErrorHandler {\n   return (thrownValue: unknown) => {\n     if (typeof thrownValue === 'string') {\n@@ -132,13 +75,34 @@ export function createHTMLReactServerErrorHandler(\n       return undefined\n     }\n \n-    const err = getProperError(thrownValue) as DigestedError\n+    let err = getProperError(thrownValue) as DigestedError\n+    let silenceLog = false\n \n     // If the error already has a digest, respect the original digest,\n     // so it won't get re-generated into another new error.\n-    if (!err.digest) {\n-      // TODO-APP: look at using webcrypto instead. Requires a promise to be awaited.\n-      err.digest = stringHash(err.message + (err.stack || '')).toString()\n+    if (err.digest) {\n+      if (\n+        process.env.NODE_ENV === 'production' &&\n+        reactServerErrors.has(err.digest)\n+      ) {\n+        // This error is likely an obfuscated error from another react-server\n+        // environment (e.g. 'use cache'). We recover the original error here\n+        // for reporting purposes.\n+        err = reactServerErrors.get(err.digest)!\n+        // We don't log it again though, as it was already logged in the\n+        // original environment.\n+        silenceLog = true\n+      } else {\n+        // Either we're in development (where we want to keep the transported\n+        // error with environmentName), or the error is not in reactServerErrors\n+        // but has a digest from other means. Keep the error as-is.\n+      }\n+    } else {\n+      err.digest = createDigestWithErrorCode(\n+        err,\n+        // TODO-APP: look at using webcrypto instead. Requires a promise to be awaited.\n+        stringHash(err.message + (err.stack || '')).toString()\n+      )\n     }\n \n     // @TODO by putting this here and not at the top it is possible that\n@@ -172,12 +136,10 @@ export function createHTMLReactServerErrorHandler(\n         })\n       }\n \n-      if (!silenceLogger) {\n-        onReactServerRenderError?.(err)\n-      }\n+      onReactServerRenderError(err, silenceLog)\n     }\n \n-    return createDigestWithErrorCode(thrownValue, err.digest)\n+    return err.digest\n   }\n }\n \n@@ -186,7 +148,6 @@ export function createHTMLErrorHandler(\n   isNextExport: boolean,\n   reactServerErrors: Map<string, DigestedError>,\n   allCapturedErrors: Array<unknown>,\n-  silenceLogger: boolean,\n   onHTMLRenderSSRError: (err: DigestedError, errorInfo?: ErrorInfo) => void\n ): SSRErrorHandler {\n   return (thrownValue: unknown, errorInfo?: ErrorInfo) => {\n@@ -210,6 +171,7 @@ export function createHTMLErrorHandler(\n     }\n \n     const err = getProperError(thrownValue) as DigestedError\n+\n     // If the error already has a digest, respect the original digest,\n     // so it won't get re-generated into another new error.\n     if (err.digest) {\n@@ -223,9 +185,12 @@ export function createHTMLErrorHandler(\n         // from other means so we don't need to produce a new one\n       }\n     } else {\n-      err.digest = stringHash(\n-        err.message + (errorInfo?.componentStack || err.stack || '')\n-      ).toString()\n+      err.digest = createDigestWithErrorCode(\n+        err,\n+        stringHash(\n+          err.message + (errorInfo?.componentStack || err.stack || '')\n+        ).toString()\n+      )\n     }\n \n     // Format server errors in development to add more helpful error messages\n@@ -253,16 +218,13 @@ export function createHTMLErrorHandler(\n         })\n       }\n \n-      if (\n-        !silenceLogger &&\n-        // HTML errors contain RSC errors as well, filter them out before reporting\n-        isSSRError\n-      ) {\n+      // HTML errors contain RSC errors as well, filter them out before reporting\n+      if (isSSRError) {\n         onHTMLRenderSSRError(err, errorInfo)\n       }\n     }\n \n-    return createDigestWithErrorCode(thrownValue, err.digest)\n+    return err.digest\n   }\n }\n "
        },
        {
            "sha": "1359d460c0cf2e9afd270b5a538740d69c37bed4",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -81,7 +81,8 @@ export type ServerOnInstrumentationRequestError = (\n   // The request could be middleware, node server or web server request,\n   // we normalized them into an aligned format to `onRequestError` API later.\n   request: NextRequestHint | BaseNextRequest | IncomingMessage,\n-  errorContext: Parameters<InstrumentationOnRequestError>[2]\n+  errorContext: Parameters<InstrumentationOnRequestError>[2],\n+  silenceLog: boolean\n ) => void | Promise<void>\n \n export interface RenderOptsPartial {"
        },
        {
            "sha": "76d0953d82b6ef3f37146a78bfc17649480c82aa",
            "filename": "packages/next/src/server/app-render/work-async-storage.external.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -9,6 +9,7 @@ import type { CacheLife } from '../use-cache/cache-life'\n // Share the instance module in the next-shared layer\n import { workAsyncStorageInstance } from './work-async-storage-instance' with { 'turbopack-transition': 'next-shared' }\n import type { LazyResult } from '../lib/lazy-result'\n+import type { DigestedError } from './create-error-handler'\n \n export interface WorkStore {\n   readonly isStaticGeneration: boolean\n@@ -114,6 +115,8 @@ export interface WorkStore {\n     fn: (...args: TArgs) => R,\n     ...args: TArgs\n   ) => R\n+\n+  reactServerErrorsByDigest: Map<string, DigestedError>\n }\n \n export type WorkAsyncStorage = AsyncLocalStorage<WorkStore>"
        },
        {
            "sha": "11b27fbea29b2d446862684a25e7a52cdf4a0925",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -145,6 +145,7 @@ export function createWorkStore({\n     refreshTagsByCacheKind: createRefreshTagsByCacheKind(),\n     runInCleanSnapshot: createSnapshot(),\n     shouldTrackFetchMetrics,\n+    reactServerErrorsByDigest: new Map(),\n   }\n \n   // TODO: remove this when we resolve accessing the store outside the execution context"
        },
        {
            "sha": "0e8aabc1be3f6c468fb0a5b89900a8d8e4aa907f",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -823,7 +823,7 @@ export default abstract class Server<\n     }\n   }\n \n-  public logError(err: Error): void {\n+  public logError(err: unknown): void {\n     if (this.quiet) return\n     Log.error(err)\n   }"
        },
        {
            "sha": "60c026e41a62bfb0de860e0afc0d349485e3847f",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -999,7 +999,9 @@ export default class DevServer extends Server {\n   ) {\n     await super.instrumentationOnRequestError(...args)\n \n-    const err = args[0]\n-    this.logErrorWithOriginalStack(err, 'app-dir')\n+    const [err, , , silenceLog] = args\n+    if (!silenceLog) {\n+      this.logErrorWithOriginalStack(err, 'app-dir')\n+    }\n   }\n }"
        },
        {
            "sha": "4403a5c35eaf309439a25cd6dcb4c5ff6a4f34f7",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 8,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -1160,13 +1160,19 @@ export default class NextNodeServer extends BaseServer<\n           })\n           if (handled) return true\n         } catch (apiError) {\n-          await this.instrumentationOnRequestError(apiError, req, {\n-            routePath: match.definition.page,\n-            routerKind: 'Pages Router',\n-            routeType: 'route',\n-            // Edge runtime does not support ISR\n-            revalidateReason: undefined,\n-          })\n+          const silenceLog = false\n+          await this.instrumentationOnRequestError(\n+            apiError,\n+            req,\n+            {\n+              routePath: match.definition.page,\n+              routerKind: 'Pages Router',\n+              routeType: 'route',\n+              // Edge runtime does not support ISR\n+              revalidateReason: undefined,\n+            },\n+            silenceLog\n+          )\n           throw apiError\n         }\n       }\n@@ -2123,7 +2129,10 @@ export default class NextNodeServer extends BaseServer<\n \n     // For Node.js runtime production logs, in dev it will be overridden by next-dev-server\n     if (!this.renderOpts.dev) {\n-      this.logError(args[0] as Error)\n+      const [err, , , silenceLog] = args\n+      if (!silenceLog) {\n+        this.logError(err)\n+      }\n     }\n   }\n "
        },
        {
            "sha": "22e527c7c7db730b8fb9df5651629fe6fabaad4d",
            "filename": "packages/next/src/server/route-modules/pages/pages-handler.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -420,6 +420,7 @@ export const getHandler = ({\n               // if this is a background revalidate we need to report\n               // the request error here as it won't be bubbled\n               if (previousCacheEntry?.isStale) {\n+                const silenceLog = false\n                 await routeModule.onRequestError(\n                   req,\n                   err,\n@@ -432,6 +433,7 @@ export const getHandler = ({\n                       isOnDemandRevalidate,\n                     }),\n                   },\n+                  silenceLog,\n                   routerServerContext\n                 )\n               }\n@@ -742,6 +744,7 @@ export const getHandler = ({\n       }\n     } catch (err) {\n       if (!(err instanceof NoFallbackError)) {\n+        const silenceLog = false\n         await routeModule.onRequestError(\n           req,\n           err,\n@@ -754,6 +757,7 @@ export const getHandler = ({\n               isOnDemandRevalidate,\n             }),\n           },\n+          silenceLog,\n           routerServerContext\n         )\n       }"
        },
        {
            "sha": "257133298258831ce2168fcc70554d1281530aa5",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -478,12 +478,15 @@ export abstract class RouteModule<\n     req: IncomingMessage | BaseNextRequest,\n     err: unknown,\n     errorContext: RequestErrorContext,\n+    silenceLog: boolean,\n     routerServerContext?: RouterServerContext[string]\n   ) {\n-    if (routerServerContext?.logErrorWithOriginalStack) {\n-      routerServerContext.logErrorWithOriginalStack(err, 'app-dir')\n-    } else {\n-      console.error(err)\n+    if (!silenceLog) {\n+      if (routerServerContext?.logErrorWithOriginalStack) {\n+        routerServerContext.logErrorWithOriginalStack(err, 'app-dir')\n+      } else {\n+        console.error(err)\n+      }\n     }\n     await this.instrumentationOnRequestError(\n       req,"
        },
        {
            "sha": "0142b8d3097eb6af640277c4c18c3ec9b6eacfa3",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 22,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -52,7 +52,7 @@ import type { CacheEntry } from '../lib/cache-handlers/types'\n import type { CacheSignal } from '../app-render/cache-signal'\n import { decryptActionBoundArgs } from '../app-render/encryption'\n import { InvariantError } from '../../shared/lib/invariant-error'\n-import { getDigestForWellKnownError } from '../app-render/create-error-handler'\n+import { createReactServerErrorHandler } from '../app-render/create-error-handler'\n import { DYNAMIC_EXPIRE, RUNTIME_PREFETCH_DYNAMIC_STALE } from './constants'\n import { getCacheHandler } from './handlers'\n import { UseCacheTimeoutError } from './use-cache-errors'\n@@ -68,9 +68,9 @@ import {\n import type { Params } from '../request/params'\n import { createLazyResult, isResolvedLazyResult } from '../lib/lazy-result'\n import { dynamicAccessAsyncStorage } from '../app-render/dynamic-access-async-storage.external'\n-import { isReactLargeShellError } from '../app-render/react-large-shell-error'\n import type { CacheLife } from './cache-life'\n import { RenderStage } from '../app-render/staged-rendering'\n+import * as Log from '../../build/output/log'\n \n interface PrivateCacheContext {\n   readonly kind: 'private'\n@@ -596,28 +596,23 @@ async function generateCacheEntryImpl(\n   // digests are handled correctly. Error formatting and reporting is not\n   // necessary here; the errors are encoded in the stream, and will be reported\n   // in the \"Server\" environment.\n-  const handleError = (error: unknown): string | undefined => {\n-    const digest = getDigestForWellKnownError(error)\n-\n-    if (digest) {\n-      return digest\n-    }\n-\n-    if (isReactLargeShellError(error)) {\n-      // TODO: Aggregate\n-      console.error(error)\n-      return undefined\n-    }\n+  const handleError = createReactServerErrorHandler(\n+    workStore.dev,\n+    workStore.isBuildTimePrerendering ?? false,\n+    workStore.reactServerErrorsByDigest,\n+    (error) => {\n+      // In production, we log the original error here. It gets a digest that\n+      // can be used to associate the error with the obfuscated error that might\n+      // be logged if the error is caught. In development, we prefer logging the\n+      // transported error in the server environment. It's not obfuscated and\n+      // also includes the (dev-only) environment name.\n+      if (process.env.NODE_ENV === 'production') {\n+        Log.error(error)\n+      }\n \n-    if (process.env.NODE_ENV !== 'development') {\n-      // TODO: For now we're also reporting the error here, because in\n-      // production, the \"Server\" environment will only get the obfuscated\n-      // error (created by the Flight Client in the cache wrapper).\n-      console.error(error)\n+      errors.push(error)\n     }\n-\n-    errors.push(error)\n-  }\n+  )\n \n   let stream: ReadableStream<Uint8Array>\n "
        },
        {
            "sha": "104fdb36899b1ada80b4e4c724d61a9950e50bcd",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 102,
            "deletions": 21,
            "changes": 123,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -2797,7 +2797,7 @@ describe('Cache Components Errors', () => {\n             `)\n           })\n         } else {\n-          it('should show an error at runtime', async () => {\n+          it('should log an error at runtime', async () => {\n             try {\n               await prerender('/use-cache-runtime-error')\n             } catch (error) {\n@@ -2817,24 +2817,89 @@ describe('Cache Components Errors', () => {\n               { isMinified: !isDebugPrerender }\n             )\n \n-            // TODO: The obfuscated error should be hidden, and the original\n-            // error should have a digest.\n             if (isDebugPrerender) {\n               expect(output).toMatchInlineSnapshot(`\n-               \"Error: Kaputt!\n+               \"⨯ Error: Kaputt!\n                    at throwAnError (<next-dist-dir>)\n                    at ThrowingComponent (<next-dist-dir>)\n-                   at Object.then (<next-dist-dir>)\n-               ⨯ [Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.] {\n+                   at Object.then (<next-dist-dir>) {\n                  digest: '<error-digest>'\n                }\"\n               `)\n             } else {\n               expect(output).toMatchInlineSnapshot(`\n-               \"Error: Kaputt!\n+               \"⨯ Error: Kaputt!\n                    at a (<next-dist-dir>)\n-                   at b (<next-dist-dir>)\n-               ⨯ [Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.] {\n+                   at b (<next-dist-dir>) {\n+                 digest: '<error-digest>'\n+               }\"\n+              `)\n+            }\n+          })\n+        }\n+      })\n+\n+      describe('catching an error at runtime', () => {\n+        if (isNextDev) {\n+          it('should show a collapsed redbox error', async () => {\n+            cliOutputLength = next.cliOutput.length\n+            const browser = await next.browser('/use-cache-catch-error')\n+\n+            await expect(browser).toDisplayCollapsedRedbox(`\n+             {\n+               \"description\": \"Kaputt!\",\n+               \"environmentLabel\": \"Cache\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/use-cache-catch-error/page.tsx (19:9) @ throwAnError\n+             > 19 |   throw new Error('Kaputt!')\n+                  |         ^\",\n+               \"stack\": [\n+                 \"throwAnError app/use-cache-catch-error/page.tsx (19:9)\",\n+                 \"Page app/use-cache-catch-error/page.tsx (11:7)\",\n+               ],\n+             }\n+            `)\n+          })\n+        } else {\n+          it('should log an error at runtime', async () => {\n+            try {\n+              await prerender('/use-cache-catch-error')\n+            } catch (error) {\n+              throw new Error('expected build not to fail', { cause: error })\n+            }\n+\n+            await next.start({ skipBuild: true })\n+            cliOutputLength = next.cliOutput.length\n+            await next.fetch('/use-cache-catch-error')\n+\n+            await retry(async () => {\n+              expect(next.cliOutput.slice(cliOutputLength)).toContain('Error')\n+            })\n+\n+            const output = getDeterministicOutput(\n+              next.cliOutput.slice(cliOutputLength),\n+              { isMinified: !isDebugPrerender }\n+            )\n+\n+            if (isDebugPrerender) {\n+              expect(output).toMatchInlineSnapshot(`\n+               \"⨯ Error: Kaputt!\n+                   at throwAnError (<next-dist-dir>)\n+                   at Object.then (<next-dist-dir>) {\n+                 digest: '<error-digest>'\n+               }\n+               [Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.] {\n+                 digest: '<error-digest>'\n+               }\"\n+              `)\n+            } else {\n+              expect(output).toMatchInlineSnapshot(`\n+               \"⨯ Error: Kaputt!\n+                   at a (<next-dist-dir>)\n+                   at b (<next-dist-dir>) {\n+                 digest: '<error-digest>'\n+               }\n+               [Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.] {\n                  digest: '<error-digest>'\n                }\"\n               `)\n@@ -3011,7 +3076,7 @@ describe('Cache Components Errors', () => {\n             if (isDebugPrerender) {\n               if (isTurbopack) {\n                 expect(output).toMatchInlineSnapshot(`\n-                 \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                 \"⨯ Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at Private (app/use-cache-private-in-use-cache/page.tsx:15:1)\n                      at stringify (<anonymous>)\n                    13 | }\n@@ -3020,7 +3085,9 @@ describe('Cache Components Errors', () => {\n                       | ^\n                    16 |   'use cache: private'\n                    17 |\n-                   18 |   return <p>Private</p>\n+                   18 |   return <p>Private</p> {\n+                   digest: '<error-digest>'\n+                 }\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at Private (app/use-cache-private-in-use-cache/page.tsx:15:1)\n                      at stringify (<anonymous>)\n@@ -3030,7 +3097,9 @@ describe('Cache Components Errors', () => {\n                       | ^\n                    16 |   'use cache: private'\n                    17 |\n-                   18 |   return <p>Private</p>\n+                   18 |   return <p>Private</p> {\n+                   digest: '<error-digest>'\n+                 }\n                  To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-use-cache\" in your browser to investigate the error.\n                  Error occurred prerendering page \"/use-cache-private-in-use-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n@@ -3039,7 +3108,7 @@ describe('Cache Components Errors', () => {\n                 `)\n               } else\n                 expect(output).toMatchInlineSnapshot(`\n-                 \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                 \"⨯ Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at Private (webpack:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n                      at stringify (<anonymous>)\n                    13 | }\n@@ -3048,7 +3117,9 @@ describe('Cache Components Errors', () => {\n                       | ^\n                    16 |   'use cache: private'\n                    17 |\n-                   18 |   return <p>Private</p>\n+                   18 |   return <p>Private</p> {\n+                   digest: '<error-digest>'\n+                 }\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at Private (webpack:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n                      at stringify (<anonymous>)\n@@ -3058,7 +3129,9 @@ describe('Cache Components Errors', () => {\n                       | ^\n                    16 |   'use cache: private'\n                    17 |\n-                   18 |   return <p>Private</p>\n+                   18 |   return <p>Private</p> {\n+                   digest: '<error-digest>'\n+                 }\n                  To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-use-cache\" in your browser to investigate the error.\n                  Error occurred prerendering page \"/use-cache-private-in-use-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n@@ -3068,7 +3141,7 @@ describe('Cache Components Errors', () => {\n             } else {\n               if (isTurbopack) {\n                 expect(output).toMatchInlineSnapshot(`\n-                 \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                 \"⨯ Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at <unknown> (app/use-cache-private-in-use-cache/page.tsx:15:1)\n                      at a (<anonymous>)\n                    13 | }\n@@ -3077,7 +3150,9 @@ describe('Cache Components Errors', () => {\n                       | ^\n                    16 |   'use cache: private'\n                    17 |\n-                   18 |   return <p>Private</p>\n+                   18 |   return <p>Private</p> {\n+                   digest: '<error-digest>'\n+                 }\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at <unknown> (app/use-cache-private-in-use-cache/page.tsx:15:1)\n                      at b (<anonymous>)\n@@ -3087,7 +3162,9 @@ describe('Cache Components Errors', () => {\n                       | ^\n                    16 |   'use cache: private'\n                    17 |\n-                   18 |   return <p>Private</p>\n+                   18 |   return <p>Private</p> {\n+                   digest: '<error-digest>'\n+                 }\n                  To get a more detailed stack trace and pinpoint the issue, try one of the following:\n                    - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-use-cache\" in your browser to investigate the error.\n                    - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n@@ -3096,12 +3173,16 @@ describe('Cache Components Errors', () => {\n                 `)\n               } else {\n                 expect(output).toMatchInlineSnapshot(`\n-                 \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                 \"⨯ Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at a (<next-dist-dir>)\n-                     at b (<anonymous>)\n+                     at b (<anonymous>) {\n+                   digest: '<error-digest>'\n+                 }\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at c (<next-dist-dir>)\n-                     at d (<anonymous>)\n+                     at d (<anonymous>) {\n+                   digest: '<error-digest>'\n+                 }\n                  To get a more detailed stack trace and pinpoint the issue, try one of the following:\n                    - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-use-cache\" in your browser to investigate the error.\n                    - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces."
        },
        {
            "sha": "1346c451cc6f89f781582251f9d9e5c5c2785feb",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-catch-error/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-catch-error%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-catch-error%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-catch-error%2Flayout.tsx?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -0,0 +1,13 @@\n+import { Suspense } from 'react'\n+\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>\n+          <Suspense>{children}</Suspense>\n+        </main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "b02c485ab70a62aa3e8ce5baaf48d8f4406ddc37",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-catch-error/page.tsx",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-catch-error%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-catch-error%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-catch-error%2Fpage.tsx?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -0,0 +1,30 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+\n+  return (\n+    <>\n+      <p>\n+        This page catches an error that's thrown in `'use cache'` at runtime.\n+      </p>\n+      <CatchingComponent />\n+    </>\n+  )\n+}\n+\n+async function throwAnError() {\n+  'use cache: remote'\n+\n+  throw new Error('Kaputt!')\n+}\n+\n+async function CatchingComponent() {\n+  try {\n+    await throwAnError()\n+  } catch (error) {\n+    console.error(error)\n+  }\n+\n+  return null\n+}"
        },
        {
            "sha": "97cadb89fe140ae29411cf9402c9ab2d577d46da",
            "filename": "test/e2e/app-dir/cache-components-errors/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -116,7 +116,7 @@ export function getDeterministicOutput(\n           replaceMinifiedName\n         )\n         .replace(/at \\d+ \\(/, replaceNumericModuleId)\n-        .replace(/digest: '\\d+'/, \"digest: '<error-digest>'\")\n+        .replace(/digest: '\\d+(@E\\d+)?'/, \"digest: '<error-digest>'\")\n \n       lines.push(convertModuleFunctionSequenceExpression(line))\n     }"
        },
        {
            "sha": "908e0cf9e3e5a8c8d3a6881bcde9302b182494ff",
            "filename": "test/e2e/app-dir/errors/index.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Ferrors%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3b8cd9225b5cc20b4cd80722c7ea12962a53c77e/test%2Fe2e%2Fapp-dir%2Ferrors%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ferrors%2Findex.test.ts?ref=3b8cd9225b5cc20b4cd80722c7ea12962a53c77e",
            "patch": "@@ -110,8 +110,8 @@ describe('app-dir - errors', () => {\n       expect(stripAnsi(next.cliOutput)).toEqual(\n         expect.stringMatching(\n           isNextDev\n-            ? /Error: An undefined error was thrown.*digest: '\\d+'/s\n-            : /Error: undefined.*digest: '\\d+'/s\n+            ? /Error: An undefined error was thrown.*digest: '\\d+@E\\d+'/s\n+            : /Error: undefined.*digest: '\\d+@E\\d+'/s\n         )\n       )\n     })\n@@ -133,8 +133,8 @@ describe('app-dir - errors', () => {\n       expect(stripAnsi(next.cliOutput)).toEqual(\n         expect.stringMatching(\n           isNextDev\n-            ? /Error: A null error was thrown.*digest: '\\d+'/s\n-            : /Error: null.*digest: '\\d+'/s\n+            ? /Error: A null error was thrown.*digest: '\\d+@E\\d+'/s\n+            : /Error: null.*digest: '\\d+@E\\d+'/s\n         )\n       )\n     })"
        }
    ],
    "stats": {
        "total": 575,
        "additions": 371,
        "deletions": 204
    }
}