{
    "author": "sokra",
    "message": "[Turbopack] pass inner modules to chunking to match chunking types (#76227)\n\n### What?\n\nrun chunking for the inner modules of the wrapper modules",
    "sha": "9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b",
    "files": [
        {
            "sha": "4d84c65de4a6cb0e7aeb3b8b93276e5e9d43394c",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b",
            "patch": "@@ -53,8 +53,8 @@ use turbopack::{\n use turbopack_core::{\n     asset::AssetContent,\n     chunk::{\n-        availability_info::AvailabilityInfo, ChunkableModule, ChunkableModules, ChunkingContext,\n-        ChunkingContextExt, EvaluatableAsset, EvaluatableAssets,\n+        availability_info::AvailabilityInfo, ChunkableModules, ChunkingContext, ChunkingContextExt,\n+        EvaluatableAsset, EvaluatableAssets,\n     },\n     file_source::FileSource,\n     ident::AssetIdent,\n@@ -833,7 +833,7 @@ impl AppProject {\n                     let graph = SingleModuleGraph::new_with_entries_visited(\n                         server_utils\n                             .iter()\n-                            .map(|m| **m)\n+                            .map(|m| Vc::upcast(**m))\n                             .chain(extra_entries)\n                             .collect(),\n                         VisitedModules::empty(),\n@@ -1663,10 +1663,7 @@ impl AppEndpoint {\n                         let server_utils = client_references\n                             .server_utils\n                             .iter()\n-                            .map(|m| async move {\n-                                Ok(*ResolvedVc::try_downcast::<Box<dyn ChunkableModule>>(*m)\n-                                    .context(\"Expected server utils to be chunkable\")?)\n-                            })\n+                            .map(async |m| Ok(Vc::upcast(*m.await?.module)))\n                             .try_join()\n                             .await?;\n                         let chunk_group = chunking_context\n@@ -1708,7 +1705,7 @@ impl AppEndpoint {\n                             let chunk_group = chunking_context\n                                 .chunk_group(\n                                     server_component.ident(),\n-                                    *ResolvedVc::upcast(server_component),\n+                                    Vc::upcast(*server_component.await?.module),\n                                     module_graph,\n                                     Value::new(current_availability_info),\n                                 )"
        },
        {
            "sha": "ff731fd32cc98877a102ecf93419485ba478ce75",
            "filename": "crates/next-core/src/next_client_reference/visit_client_reference.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs?ref=9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b",
            "patch": "@@ -81,7 +81,7 @@ pub struct ClientReferenceGraphResult {\n     pub client_references_by_server_component:\n         FxIndexMap<Option<ResolvedVc<NextServerComponentModule>>, Vec<ResolvedVc<Box<dyn Module>>>>,\n     pub server_component_entries: Vec<ResolvedVc<NextServerComponentModule>>,\n-    pub server_utils: Vec<ResolvedVc<Box<dyn Module>>>,\n+    pub server_utils: Vec<ResolvedVc<NextServerUtilityModule>>,\n     pub visited_nodes: ResolvedVc<VisitedClientReferenceGraphNodes>,\n }\n \n@@ -147,7 +147,7 @@ impl ClientReferenceGraphResult {\n #[derive(Clone, Debug)]\n pub struct ServerEntries {\n     pub server_component_entries: Vec<ResolvedVc<NextServerComponentModule>>,\n-    pub server_utils: Vec<ResolvedVc<Box<dyn Module>>>,\n+    pub server_utils: Vec<ResolvedVc<NextServerUtilityModule>>,\n }\n \n #[turbo_tasks::function]\n@@ -268,7 +268,7 @@ impl VisitClientReferenceNodeState {\n enum VisitClientReferenceNodeType {\n     ClientReference(ClientReference, ReadRef<RcStr>),\n     ServerComponentEntry(ResolvedVc<NextServerComponentModule>, ReadRef<RcStr>),\n-    ServerUtilEntry(ResolvedVc<Box<dyn Module>>, ReadRef<RcStr>),\n+    ServerUtilEntry(ResolvedVc<NextServerUtilityModule>, ReadRef<RcStr>),\n     Internal(ResolvedVc<Box<dyn Module>>, ReadRef<RcStr>),\n }\n \n@@ -306,7 +306,9 @@ impl Visit<VisitClientReferenceNode> for VisitClientReference {\n                 // nodes' edges.\n                 VisitClientReferenceNodeType::ClientReference(..) => return Ok(vec![]),\n                 VisitClientReferenceNodeType::Internal(module, _) => module,\n-                VisitClientReferenceNodeType::ServerUtilEntry(module, _) => module,\n+                VisitClientReferenceNodeType::ServerUtilEntry(module, _) => {\n+                    ResolvedVc::upcast(module)\n+                }\n                 VisitClientReferenceNodeType::ServerComponentEntry(module, _) => {\n                     ResolvedVc::upcast(module)\n                 }\n@@ -370,11 +372,13 @@ impl Visit<VisitClientReferenceNode> for VisitClientReference {\n                         });\n                     }\n \n-                    if ResolvedVc::try_downcast_type::<NextServerUtilityModule>(*module).is_some() {\n+                    if let Some(server_util_module) =\n+                        ResolvedVc::try_downcast_type::<NextServerUtilityModule>(*module)\n+                    {\n                         return Ok(VisitClientReferenceNode {\n                             state: VisitClientReferenceNodeState::InServerUtil,\n                             ty: VisitClientReferenceNodeType::ServerUtilEntry(\n-                                *module,\n+                                server_util_module,\n                                 module.ident().to_string().await?,\n                             ),\n                         });"
        },
        {
            "sha": "a87e02959998eb2c48fa531d734c29e3a8943bf8",
            "filename": "crates/next-core/src/next_server_component/server_component_module.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_module.rs?ref=9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b",
            "patch": "@@ -32,7 +32,7 @@ fn modifier() -> Vc<RcStr> {\n \n #[turbo_tasks::value(shared)]\n pub struct NextServerComponentModule {\n-    module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+    pub module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n }\n \n #[turbo_tasks::value_impl]"
        },
        {
            "sha": "b833391f4de4da4c8b02376de3f4588535c73e05",
            "filename": "crates/next-core/src/next_server_utility/server_utility_module.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_module.rs?ref=9a41b9eb5d7087a3d59f87daf7c0e0bd0434db1b",
            "patch": "@@ -32,7 +32,7 @@ fn modifier() -> Vc<RcStr> {\n \n #[turbo_tasks::value(shared)]\n pub struct NextServerUtilityModule {\n-    module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+    pub module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n }\n \n #[turbo_tasks::value_impl]"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 17,
        "deletions": 16
    }
}