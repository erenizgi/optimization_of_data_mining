{
    "author": "ztanner",
    "message": "[ci]: split clientSegmentCache test runners off from experimental (#84440)\n\nWe are preparing to enable `clientSegmentCache` by default on canary. To\nprepare, this splits it into a separate CI runner and adds a failing\ntest manifest so we can incrementally migrate / fix failing tests before\nstable release.",
    "sha": "c9c628561131bac0ec3820292fb679b768683ebd",
    "files": [
        {
            "sha": "cd7adf5960d2c94cd8655d8658752dfbcf327b13",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/c9c628561131bac0ec3820292fb679b768683ebd/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/c9c628561131bac0ec3820292fb679b768683ebd/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=c9c628561131bac0ec3820292fb679b768683ebd",
            "patch": "@@ -992,6 +992,73 @@ jobs:\n       stepName: 'test-experimental-prod-${{ matrix.group }}'\n     secrets: inherit\n \n+  test-client-segment-cache-integration:\n+    name: test clientSegmentCache integration\n+    needs: ['optimize-ci', 'changes', 'build-native', 'build-next']\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' }}\n+\n+    uses: ./.github/workflows/build_reusable.yml\n+    with:\n+      nodeVersion: 20.9.0\n+      afterBuild: |\n+        export __NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE=true\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"test/client-segment-cache-tests-manifest.json\"\n+        export IS_WEBPACK_TEST=1\n+\n+        node run-tests.js \\\n+          --timings \\\n+          --type integration\n+      stepName: 'test-client-segment-cache-integration'\n+    secrets: inherit\n+\n+  test-client-segment-cache-dev:\n+    name: test clientSegmentCache dev\n+    needs: ['optimize-ci', 'changes', 'build-native', 'build-next']\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' }}\n+\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        group: [1/6, 2/6, 3/6, 4/6, 5/6, 6/6]\n+    uses: ./.github/workflows/build_reusable.yml\n+    with:\n+      afterBuild: |\n+        export __NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE=true\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"test/client-segment-cache-tests-manifest.json\"\n+        export NEXT_TEST_MODE=dev\n+        export IS_WEBPACK_TEST=1\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          --type development\n+      stepName: 'test-client-segment-cache-dev-${{ matrix.group }}'\n+    secrets: inherit\n+\n+  test-client-segment-cache-prod:\n+    name: test clientSegmentCache prod\n+    needs: ['optimize-ci', 'changes', 'build-native', 'build-next']\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' && needs.changes.outputs.docs-only == 'false' }}\n+\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        group: [1/7, 2/7, 3/7, 4/7, 5/7, 6/7, 7/7]\n+    uses: ./.github/workflows/build_reusable.yml\n+    with:\n+      afterBuild: |\n+        export __NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE=true\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"test/client-segment-cache-tests-manifest.json\"\n+        export NEXT_TEST_MODE=start\n+        export IS_WEBPACK_TEST=1\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          --type production\n+      stepName: 'test-client-segment-cache-prod-${{ matrix.group }}'\n+    secrets: inherit\n+\n   tests-pass:\n     needs:\n       [\n@@ -1010,6 +1077,9 @@ jobs:\n         'test-experimental-dev',\n         'test-experimental-prod',\n         'test-experimental-integration',\n+        'test-client-segment-cache-dev',\n+        'test-client-segment-cache-prod',\n+        'test-client-segment-cache-integration',\n         'test-cargo-unit',\n         'rust-check',\n         'rustdoc-check',"
        },
        {
            "sha": "38c293fba762a0e2aee64bfdc176584a321f1bb8",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/c9c628561131bac0ec3820292fb679b768683ebd/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9c628561131bac0ec3820292fb679b768683ebd/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=c9c628561131bac0ec3820292fb679b768683ebd",
            "patch": "@@ -1709,6 +1709,25 @@ function enforceExperimentalFeatures(\n     }\n   }\n \n+  // TODO: Remove this once we've made Client Segment Cache the default.\n+  if (\n+    process.env.__NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE === 'true' &&\n+    // We do respect an explicit value in the user config.\n+    (config.experimental.clientSegmentCache === undefined ||\n+      (isDefaultConfig && !config.experimental.clientSegmentCache))\n+  ) {\n+    config.experimental.clientSegmentCache = true\n+\n+    if (configuredExperimentalFeatures) {\n+      addConfiguredExperimentalFeature(\n+        configuredExperimentalFeatures,\n+        'clientSegmentCache',\n+        true,\n+        'enabled by `__NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE`'\n+      )\n+    }\n+  }\n+\n   // TODO: Remove this once we've made Client Param Parsing the default.\n   if (\n     process.env.__NEXT_EXPERIMENTAL_PPR === 'true' &&"
        },
        {
            "sha": "17da86dd84ff1287db2dfa54b1496eaaaf3dac44",
            "filename": "test/client-segment-cache-tests-manifest.json",
            "status": "added",
            "additions": 133,
            "deletions": 0,
            "changes": 133,
            "blob_url": "https://github.com/vercel/next.js/blob/c9c628561131bac0ec3820292fb679b768683ebd/test%2Fclient-segment-cache-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/c9c628561131bac0ec3820292fb679b768683ebd/test%2Fclient-segment-cache-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fclient-segment-cache-tests-manifest.json?ref=c9c628561131bac0ec3820292fb679b768683ebd",
            "patch": "@@ -0,0 +1,133 @@\n+{\n+  \"version\": 2,\n+  \"suites\": {\n+    \"test/e2e/app-dir/actions/app-action-node-middleware.test.ts\": {\n+      \"failed\": [\n+        \"app-dir action handling fetch actions should handle redirects to routes that provide an invalid RSC response\",\n+        \"app-dir action handling should reset the form state when the action redirects to itself\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/actions/app-action.test.ts\": {\n+      \"failed\": [\n+        \"app-dir action handling fetch actions should handle redirects to routes that provide an invalid RSC response\",\n+        \"app-dir action handling should reset the form state when the action redirects to itself\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/app-client-cache/client-cache.experimental.test.ts\": {\n+      \"failed\": [\n+        \"app dir client cache semantics (experimental staleTimes) static: 180 prefetch={true} should use the custom static override time (3 minutes)\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/app-prefetch/prefetching.stale-times.test.ts\": {\n+      \"failed\": [\n+        \"app dir - prefetching (custom staleTime) should fetch again when a static page was prefetched when navigating to it after the stale time has passed\",\n+        \"app dir - prefetching (custom staleTime) should fetch again when the initially visited static page is visited after the stale time has passed\",\n+        \"app dir - prefetching (custom staleTime) should not fetch again when a static page was prefetched when navigating to it twice\",\n+        \"app dir - prefetching (custom staleTime) should renew the stale time after refetching expired RSC data\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/app-prefetch/prefetching.test.ts\": {\n+      \"failed\": [\n+        \"app dir - prefetching fetch priority should have an auto priority for all other fetch operations\",\n+        \"app dir - prefetching fetch priority should prefetch with high priority when navigating to a page without a prefetch entry\",\n+        \"app dir - prefetching prefetch cache seeding should not re-fetch the initial dynamic page if the same page is prefetched with prefetch={true}\",\n+        \"app dir - prefetching prefetch cache seeding should not re-fetch the initial static page if the same page is prefetched with prefetch={true}\",\n+        \"app dir - prefetching should calculate `_rsc` query based on `Next-Url`\",\n+        \"app dir - prefetching should immediately render the loading state for a dynamic segment when fetched from higher up in the tree\",\n+        \"app dir - prefetching should not fetch again when a static page was prefetched\",\n+        \"app dir - prefetching should not unintentionally modify the requested prefetch by escaping the uri encoded query params\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/app-static/app-static-custom-handler.test.ts\": {\n+      \"failed\": [\n+        \"app-dir static/dynamic handling should output HTML/RSC files for static paths\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/app-static/app-static.test.ts\": {\n+      \"failed\": [\n+        \"app-dir static/dynamic handling should output HTML/RSC files for static paths\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/navigation/navigation.test.ts\": {\n+      \"failed\": [\n+        \"app dir - navigation middleware redirect should change browser location when router.refresh() gets a redirect response\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/parallel-routes-and-interception/parallel-routes-and-interception.test.ts\": {\n+      \"failed\": [\n+        \"parallel-routes-and-interception route intercepting should support intercepting local dynamic sibling routes\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/parallel-routes-revalidation/parallel-routes-revalidation.test.ts\": {\n+      \"failed\": [\n+        \"parallel-routes-revalidation router.refresh (dynamic) - searchParams: false should correctly refresh data for previously intercepted modal and active page slot\",\n+        \"parallel-routes-revalidation router.refresh (dynamic) - searchParams: true should correctly refresh data for previously intercepted modal and active page slot\",\n+        \"parallel-routes-revalidation router.refresh (dynamic) - searchParams: true should correctly refresh data for the intercepted route and previously active page slot\",\n+        \"parallel-routes-revalidation router.refresh (regular) - searchParams: false should correctly refresh data for previously intercepted modal and active page slot\",\n+        \"parallel-routes-revalidation router.refresh (regular) - searchParams: true should correctly refresh data for previously intercepted modal and active page slot\",\n+        \"parallel-routes-revalidation router.refresh (regular) - searchParams: true should correctly refresh data for the intercepted route and previously active page slot\",\n+        \"parallel-routes-revalidation server action revalidation handles refreshing when multiple parallel slots are active\",\n+        \"parallel-routes-revalidation server action revalidation should not trigger a refresh for the page that is being redirected to\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/ppr-navigations/loading-tsx-no-partial-rendering/loading-tsx-no-partial-rendering.test.ts\": {\n+      \"failed\": [\n+        \"loading-tsx-no-partial-rendering when PPR is enabled, loading.tsx boundaries do not cause a partial prefetch\"\n+      ]\n+    },\n+    \"test/e2e/app-dir/searchparams-reuse-loading/searchparams-reuse-loading.test.ts\": {\n+      \"failed\": [\n+        \"searchparams-reuse-loading should re-use loading from \\\"full\\\" prefetch for param-full URL when navigating to param-full route\",\n+        \"searchparams-reuse-loading should re-use loading from \\\"full\\\" prefetch for param-full URL when navigating to param-less route\",\n+        \"searchparams-reuse-loading should re-use loading from \\\"full\\\" prefetch for param-less URL when navigating to param-full route\"\n+      ]\n+    },\n+    \"test/e2e/next-form/default/next-form-prefetch.test.ts\": {\n+      \"failed\": [\n+        \"app dir - form prefetching should prefetch a loading state for the form's target\"\n+      ]\n+    },\n+    \"test/integration/app-dir-export/test/config.test.ts\": {\n+      \"failed\": [\n+        \"app dir - with output export (next dev / next build) production mode should correctly emit exported assets to config.distDir\"\n+      ]\n+    },\n+    \"test/integration/app-dir-export/test/dynamicapiroute-prod.test.ts\": {\n+      \"failed\": [\n+        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicApiRoute 'error'\",\n+        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicApiRoute 'force-static'\"\n+      ]\n+    },\n+    \"test/integration/app-dir-export/test/dynamicpage-prod.test.ts\": {\n+      \"failed\": [\n+        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicPage 'error'\",\n+        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicPage 'force-static'\",\n+        \"app dir - with output export - dynamic api route prod production mode should work in prod with dynamicPage undefined\"\n+      ]\n+    },\n+    \"test/integration/app-dir-export/test/trailing-slash-start.test.ts\": {\n+      \"failed\": [\n+        \"app dir - with output export - trailing slash prod production mode should work in prod with trailingSlash 'false'\",\n+        \"app dir - with output export - trailing slash prod production mode should work in prod with trailingSlash 'true'\"\n+      ]\n+    },\n+    \"test/production/app-dir/build-output-prerender/build-output-prerender.test.ts\": {\n+      \"failed\": [\n+        \"build-output-prerender with a next config file with --debug-prerender prints a warning and the customized experimental flags\",\n+        \"build-output-prerender with a next config file without --debug-prerender prints only the user-selected experimental flags (and the ones enabled via env variable)\",\n+        \"build-output-prerender without a next config file with --debug-prerender prints a warning and the customized experimental flags\",\n+        \"build-output-prerender without a next config file without --debug-prerender prints no experimental flags (unless enabled via env variable)\"\n+      ]\n+    }\n+  },\n+  \"rules\": {\n+    \"include\": [\n+      \"test/e2e/**/*.test.{t,j}s{,x}\",\n+      \"test/integration/app-*/**/*.test.{t,j}s{,x}\",\n+      \"test/production/app-*/**/*.test.{t,j}s{,x}\",\n+      \"test/development/app-*/**/*.test.{t,j}s{,x}\",\n+      \"test/development/acceptance-app/**/*.test.{t,j}s{,x}\"\n+    ],\n+    \"exclude\": []\n+  }\n+}"
        },
        {
            "sha": "b86af8b0e3ac53ea5d1e9a749ba20be6554f8e1a",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c9c628561131bac0ec3820292fb679b768683ebd/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9c628561131bac0ec3820292fb679b768683ebd/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=c9c628561131bac0ec3820292fb679b768683ebd",
            "patch": "@@ -409,6 +409,9 @@ export class NextInstance {\n           if (process.env.NEXT_PRIVATE_EXPERIMENTAL_CACHE_COMPONENTS) {\n             process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS = process.env.NEXT_PRIVATE_EXPERIMENTAL_CACHE_COMPONENTS\n           }\n+          if (process.env.NEXT_PRIVATE_EXPERIMENTAL_CLIENT_SEGMENT_CACHE) {\n+            process.env.__NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE = process.env.NEXT_PRIVATE_EXPERIMENTAL_CLIENT_SEGMENT_CACHE\n+          }\n         `\n           )\n "
        },
        {
            "sha": "c6df79fb56396259701d83eb0be48a0badb1f150",
            "filename": "test/lib/next-modes/next-deploy.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c9c628561131bac0ec3820292fb679b768683ebd/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9c628561131bac0ec3820292fb679b768683ebd/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-deploy.ts?ref=c9c628561131bac0ec3820292fb679b768683ebd",
            "patch": "@@ -111,6 +111,12 @@ export class NextDeployInstance extends NextInstance {\n       )\n     }\n \n+    if (process.env.__NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE) {\n+      additionalEnv.push(\n+        `NEXT_PRIVATE_EXPERIMENTAL_CLIENT_SEGMENT_CACHE=${process.env.__NEXT_EXPERIMENTAL_CLIENT_SEGMENT_CACHE}`\n+      )\n+    }\n+\n     if (process.env.IS_TURBOPACK_TEST) {\n       additionalEnv.push(`IS_TURBOPACK_TEST=1`)\n     }"
        }
    ],
    "stats": {
        "total": 231,
        "additions": 231,
        "deletions": 0
    }
}