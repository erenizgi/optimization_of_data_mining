{
    "author": "sokra",
    "message": "Turbopack: improve named spans in tracing (#81458)\n\n### What?\n\nShow span name before attribute `name` in tracing when using custom named spans.\n\nInclude category and original span name when grouping spans.\n\nUse more custom named spans.",
    "sha": "1937a19fb9f342b0f5a4b982b88dff8971a27e38",
    "files": [
        {
            "sha": "a9238567bf88627679932e324265500768220459",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -309,7 +309,7 @@ impl DiskFileSystemInner {\n     }\n \n     fn invalidate(&self) {\n-        let _span = tracing::info_span!(\"invalidate filesystem\", path = &*self.root).entered();\n+        let _span = tracing::info_span!(\"invalidate filesystem\", name = &*self.root).entered();\n         let span = tracing::Span::current();\n         let handle = tokio::runtime::Handle::current();\n         let invalidator_map = take(&mut *self.invalidator_map.lock().unwrap());\n@@ -332,7 +332,7 @@ impl DiskFileSystemInner {\n         &self,\n         reason: impl Fn(String) -> R + Sync,\n     ) {\n-        let _span = tracing::info_span!(\"invalidate filesystem\", path = &*self.root).entered();\n+        let _span = tracing::info_span!(\"invalidate filesystem\", name = &*self.root).entered();\n         let span = tracing::Span::current();\n         let handle = tokio::runtime::Handle::current();\n         let invalidator_map = take(&mut *self.invalidator_map.lock().unwrap());\n@@ -388,7 +388,7 @@ impl DiskFileSystemInner {\n         // create the directory for the filesystem on disk, if it doesn't exist\n         retry_blocking(root_path.clone(), move |path| {\n             let _tracing =\n-                tracing::info_span!(\"create root directory\", path = display(path.display()))\n+                tracing::info_span!(\"create root directory\", name = display(path.display()))\n                     .entered();\n \n             std::fs::create_dir_all(path)\n@@ -413,7 +413,7 @@ impl DiskFileSystemInner {\n                 .concurrency_limited(&self.semaphore)\n                 .instrument(tracing::info_span!(\n                     \"create directory\",\n-                    path = display(directory.display())\n+                    name = display(directory.display())\n                 ))\n                 .await?;\n             ApplyEffectsContext::with(|fs_context: &mut DiskFileSystemApplyContext| {\n@@ -558,7 +558,7 @@ impl FileSystem for DiskFileSystem {\n             .concurrency_limited(&self.inner.semaphore)\n             .instrument(tracing::info_span!(\n                 \"read file\",\n-                path = display(full_path.display())\n+                name = display(full_path.display())\n             ))\n             .await\n         {\n@@ -583,7 +583,7 @@ impl FileSystem for DiskFileSystem {\n         // node-file-trace\n         let read_dir = match retry_blocking(full_path.clone(), |path| {\n             let _span =\n-                tracing::info_span!(\"read directory\", path = display(path.display())).entered();\n+                tracing::info_span!(\"read directory\", name = display(path.display())).entered();\n             std::fs::read_dir(path)\n         })\n         .concurrency_limited(&self.inner.semaphore)\n@@ -640,7 +640,7 @@ impl FileSystem for DiskFileSystem {\n                 .concurrency_limited(&self.inner.semaphore)\n                 .instrument(tracing::info_span!(\n                     \"read symlink\",\n-                    path = display(full_path.display())\n+                    name = display(full_path.display())\n                 ))\n                 .await\n             {\n@@ -745,7 +745,7 @@ impl FileSystem for DiskFileSystem {\n                 .concurrency_limited(&inner.semaphore)\n                 .instrument(tracing::info_span!(\n                     \"read file before write\",\n-                    path = display(full_path.display())\n+                    name = display(full_path.display())\n                 ))\n                 .await?;\n             if compare == FileComparison::Equal {\n@@ -812,7 +812,7 @@ impl FileSystem for DiskFileSystem {\n                     .concurrency_limited(&inner.semaphore)\n                     .instrument(tracing::info_span!(\n                         \"write file\",\n-                        path = display(full_path.display())\n+                        name = display(full_path.display())\n                     ))\n                     .await\n                     .with_context(|| format!(\"failed to write to {}\", full_path.display()))?;\n@@ -824,7 +824,7 @@ impl FileSystem for DiskFileSystem {\n                     .concurrency_limited(&inner.semaphore)\n                     .instrument(tracing::info_span!(\n                         \"remove file\",\n-                        path = display(full_path.display())\n+                        name = display(full_path.display())\n                     ))\n                     .await\n                     .or_else(|err| {\n@@ -873,7 +873,7 @@ impl FileSystem for DiskFileSystem {\n             .concurrency_limited(&inner.semaphore)\n             .instrument(tracing::info_span!(\n                 \"read symlink before write\",\n-                path = display(full_path.display())\n+                name = display(full_path.display())\n             ))\n             .await\n             {\n@@ -923,7 +923,7 @@ impl FileSystem for DiskFileSystem {\n                     retry_blocking(target_path, move |target_path| {\n                         let _span = tracing::info_span!(\n                             \"write symlink\",\n-                            path = display(target_path.display())\n+                            name = display(target_path.display())\n                         )\n                         .entered();\n                         // we use the sync std method here because `symlink` is fast\n@@ -980,7 +980,7 @@ impl FileSystem for DiskFileSystem {\n             .concurrency_limited(&self.inner.semaphore)\n             .instrument(tracing::info_span!(\n                 \"read metadata\",\n-                path = display(full_path.display())\n+                name = display(full_path.display())\n             ))\n             .await\n             .with_context(|| format!(\"reading metadata for {}\", full_path.display()))?;"
        },
        {
            "sha": "0b70e283cd3e09b518dcac7d61b8f8490418375a",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -571,7 +571,7 @@ impl ChunkingContext for BrowserChunkingContext {\n         module_graph: Vc<ModuleGraph>,\n         availability_info: AvailabilityInfo,\n     ) -> Result<Vc<ChunkGroupResult>> {\n-        let span = tracing::info_span!(\"chunking\", ident = ident.to_string().await?.to_string());\n+        let span = tracing::info_span!(\"chunking\", name = ident.to_string().await?.to_string());\n         async move {\n             let this = self.await?;\n             let modules = chunk_group.entries();"
        },
        {
            "sha": "ad3a1947df191e184d91256836a0fe8f57876755",
            "filename": "turbopack/crates/turbopack-core/src/resolve/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -1573,7 +1573,7 @@ pub async fn resolve_inline(\n         tracing::info_span!(\n             \"resolving\",\n             lookup_path = lookup_path,\n-            request = request,\n+            name = request,\n             reference_type = display(&reference_type),\n         )\n     };\n@@ -1778,7 +1778,7 @@ async fn resolve_internal_inline(\n         tracing::info_span!(\n             \"internal resolving\",\n             lookup_path = lookup_path,\n-            request = request\n+            name = request\n         )\n     };\n     async move {"
        },
        {
            "sha": "498efdee64eaddfce47feb3388e8e9462295d462",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -810,7 +810,7 @@ impl EcmascriptChunkItem for ModuleChunkItem {\n     ) -> Result<Vc<EcmascriptChunkItemContent>> {\n         let span = tracing::info_span!(\n             \"code generation\",\n-            module = self.asset_ident().to_string().await?.to_string()\n+            name = self.asset_ident().to_string().await?.to_string()\n         );\n         async {\n             let this = self.await?;"
        },
        {
            "sha": "d24e50a94dfdaa174277958910210507dab4c6d1",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -495,7 +495,7 @@ pub(crate) async fn analyse_ecmascript_module(\n ) -> Result<Vc<AnalyzeEcmascriptModuleResult>> {\n     let span = {\n         let module = module.ident().to_string().await?.to_string();\n-        tracing::info_span!(\"analyse ecmascript module\", module = module)\n+        tracing::info_span!(\"analyse ecmascript module\", name = module)\n     };\n     let result = analyse_ecmascript_module_internal(module, part)\n         .instrument(span)"
        },
        {
            "sha": "535fd67cd6fbfe1bbeb3bdbc56818d624b45c5b7",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -384,7 +384,7 @@ impl ChunkingContext for NodeJsChunkingContext {\n         module_graph: Vc<ModuleGraph>,\n         availability_info: AvailabilityInfo,\n     ) -> Result<Vc<ChunkGroupResult>> {\n-        let span = tracing::info_span!(\"chunking\", module = ident.to_string().await?.to_string());\n+        let span = tracing::info_span!(\"chunking\", name = ident.to_string().await?.to_string());\n         async move {\n             let modules = chunk_group.entries();\n             let MakeChunkGroupResult {"
        },
        {
            "sha": "c29ef2f5328d9a5058d51355be7a7bdfec024c69",
            "filename": "turbopack/crates/turbopack-trace-server/src/bottom_up.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 11,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fbottom_up.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fbottom_up.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fbottom_up.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -5,12 +5,13 @@ use hashbrown::HashMap;\n use crate::{\n     span::{SpanBottomUp, SpanIndex},\n     span_ref::SpanRef,\n+    string_tuple_ref::StringTupleRef,\n };\n \n pub struct SpanBottomUpBuilder {\n     // These values won't change after creation:\n     pub self_spans: Vec<SpanIndex>,\n-    pub children: HashMap<String, SpanBottomUpBuilder>,\n+    pub children: HashMap<(String, String), SpanBottomUpBuilder>,\n     pub example_span: SpanIndex,\n }\n \n@@ -42,7 +43,7 @@ pub fn build_bottom_up_graph<'a>(\n         .ok()\n         .and_then(|s| s.parse().ok())\n         .unwrap_or(usize::MAX);\n-    let mut roots: HashMap<String, SpanBottomUpBuilder> = HashMap::default();\n+    let mut roots: HashMap<(String, String), SpanBottomUpBuilder> = HashMap::default();\n \n     // unfortunately there is a rustc bug that fails the typechecking here\n     // when using Either<impl Iterator, impl Iterator>. This error appears\n@@ -52,30 +53,40 @@ pub fn build_bottom_up_graph<'a>(\n     let mut current_iterators: Vec<Box<dyn Iterator<Item = SpanRef<'_>>>> =\n         vec![Box::new(spans.flat_map(|span| span.children()))];\n \n-    let mut current_path: Vec<(&'_ str, SpanIndex)> = vec![];\n+    let mut current_path: Vec<((&'_ str, &'_ str), SpanIndex)> = vec![];\n     while let Some(mut iter) = current_iterators.pop() {\n         if let Some(child) = iter.next() {\n             current_iterators.push(iter);\n \n-            let name = child.group_name();\n+            let (category, name) = child.group_name();\n             let (_, mut bottom_up) = roots\n                 .raw_entry_mut()\n-                .from_key(name)\n-                .or_insert_with(|| (name.to_string(), SpanBottomUpBuilder::new(child.index())));\n+                .from_key(&StringTupleRef(category, name))\n+                .or_insert_with(|| {\n+                    (\n+                        (category.to_string(), name.to_string()),\n+                        SpanBottomUpBuilder::new(child.index()),\n+                    )\n+                });\n             bottom_up.self_spans.push(child.index());\n             let mut prev = None;\n-            for &(name, example_span) in current_path.iter().rev().take(max_depth) {\n-                if prev == Some(name) {\n+            for &((category, title), example_span) in current_path.iter().rev().take(max_depth) {\n+                if prev == Some((category, title)) {\n                     continue;\n                 }\n                 let (_, child_bottom_up) = bottom_up\n                     .children\n                     .raw_entry_mut()\n-                    .from_key(name)\n-                    .or_insert_with(|| (name.to_string(), SpanBottomUpBuilder::new(example_span)));\n+                    .from_key(&StringTupleRef(category, title))\n+                    .or_insert_with(|| {\n+                        (\n+                            (category.to_string(), title.to_string()),\n+                            SpanBottomUpBuilder::new(example_span),\n+                        )\n+                    });\n                 child_bottom_up.self_spans.push(child.index());\n                 bottom_up = child_bottom_up;\n-                prev = Some(name);\n+                prev = Some((category, title));\n             }\n \n             current_path.push((child.group_name(), child.index()));"
        },
        {
            "sha": "0a086985455215f3528fb573037dc16b9efa8a20",
            "filename": "turbopack/crates/turbopack-trace-server/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -17,6 +17,7 @@ mod span_graph_ref;\n mod span_ref;\n mod store;\n mod store_container;\n+mod string_tuple_ref;\n mod timestamp;\n mod u64_empty_string;\n mod u64_string;"
        },
        {
            "sha": "7800b96a8d6ad9620311ce56a32253480e59fd65",
            "filename": "turbopack/crates/turbopack-trace-server/src/main.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fmain.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -18,6 +18,7 @@ mod span_graph_ref;\n mod span_ref;\n mod store;\n mod store_container;\n+mod string_tuple_ref;\n mod timestamp;\n mod u64_empty_string;\n mod u64_string;"
        },
        {
            "sha": "1fb66072851e1d8c0a69d99b254797d286b74af0",
            "filename": "turbopack/crates/turbopack-trace-server/src/span.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -71,7 +71,7 @@ pub struct SpanExtra {\n pub struct SpanNames {\n     // These values are computed when accessed (and maybe deleted during writing):\n     pub nice_name: OnceLock<(String, String)>,\n-    pub group_name: OnceLock<String>,\n+    pub group_name: OnceLock<(String, String)>,\n }\n \n impl Span {"
        },
        {
            "sha": "02f36e3e96efbfef85be081d83893f13cb9aaec4",
            "filename": "turbopack/crates/turbopack-trace-server/src/span_bottom_up_ref.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_bottom_up_ref.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_bottom_up_ref.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_bottom_up_ref.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -6,9 +6,9 @@ use std::{\n \n use crate::{\n     FxIndexMap,\n-    span::{SpanBottomUp, SpanGraphEvent, SpanIndex},\n+    span::{SpanBottomUp, SpanGraphEvent},\n     span_graph_ref::{SpanGraphEventRef, SpanGraphRef, event_map_to_list},\n-    span_ref::SpanRef,\n+    span_ref::{GroupNameToDirectAndRecusiveSpans, SpanRef},\n     store::{SpanId, Store},\n     timestamp::Timestamp,\n };\n@@ -54,15 +54,15 @@ impl<'a> SpanBottomUpRef<'a> {\n         self.bottom_up.self_spans.len()\n     }\n \n-    pub fn group_name(&self) -> &'a str {\n+    pub fn group_name(&self) -> (&'a str, &'a str) {\n         self.first_span().group_name()\n     }\n \n     pub fn nice_name(&self) -> (&'a str, &'a str) {\n         if self.count() == 1 {\n             self.example_span().nice_name()\n         } else {\n-            (\"\", self.example_span().group_name())\n+            self.example_span().group_name()\n         }\n     }\n \n@@ -85,8 +85,7 @@ impl<'a> SpanBottomUpRef<'a> {\n                     let _ = self.first_span().graph();\n                     self.first_span().extra().graph.get().unwrap().clone()\n                 } else {\n-                    let mut map: FxIndexMap<&str, (Vec<SpanIndex>, Vec<SpanIndex>)> =\n-                        FxIndexMap::default();\n+                    let mut map: GroupNameToDirectAndRecusiveSpans = FxIndexMap::default();\n                     let mut queue = VecDeque::with_capacity(8);\n                     for child in self.spans() {\n                         let name = child.group_name();"
        },
        {
            "sha": "3538f68a40aaf1196d313e466729659d0d490689",
            "filename": "turbopack/crates/turbopack-trace-server/src/span_graph_ref.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_graph_ref.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_graph_ref.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_graph_ref.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -9,9 +9,9 @@ use rayon::iter::{IntoParallelRefIterator, ParallelIterator};\n use crate::{\n     FxIndexMap,\n     bottom_up::build_bottom_up_graph,\n-    span::{SpanGraph, SpanGraphEvent, SpanIndex},\n+    span::{SpanGraph, SpanGraphEvent},\n     span_bottom_up_ref::SpanBottomUpRef,\n-    span_ref::SpanRef,\n+    span_ref::{GroupNameToDirectAndRecusiveSpans, SpanRef},\n     store::{SpanId, Store},\n     timestamp::Timestamp,\n };\n@@ -40,7 +40,7 @@ impl<'a> SpanGraphRef<'a> {\n         if self.count() == 1 {\n             self.first_span().nice_name()\n         } else {\n-            (\"\", self.first_span().group_name())\n+            self.first_span().group_name()\n         }\n     }\n \n@@ -87,8 +87,7 @@ impl<'a> SpanGraphRef<'a> {\n                 self.first_span().extra().graph.get().unwrap().clone()\n             } else {\n                 let self_group = self.first_span().group_name();\n-                let mut map: FxIndexMap<&str, (Vec<SpanIndex>, Vec<SpanIndex>)> =\n-                    FxIndexMap::default();\n+                let mut map: GroupNameToDirectAndRecusiveSpans = FxIndexMap::default();\n                 let mut queue = VecDeque::with_capacity(8);\n                 for span in self.recursive_spans() {\n                     for span in span.children() {\n@@ -303,9 +302,7 @@ impl<'a> SpanGraphRef<'a> {\n     }\n }\n \n-pub fn event_map_to_list(\n-    map: FxIndexMap<&str, (Vec<SpanIndex>, Vec<SpanIndex>)>,\n-) -> Vec<SpanGraphEvent> {\n+pub fn event_map_to_list(map: GroupNameToDirectAndRecusiveSpans) -> Vec<SpanGraphEvent> {\n     map.into_iter()\n         .map(|(_, (root_spans, recursive_spans))| {\n             let graph = SpanGraph {"
        },
        {
            "sha": "25adc8a234cb637461e0873c7e7fdab8ad0cc679",
            "filename": "turbopack/crates/turbopack-trace-server/src/span_ref.rs",
            "status": "modified",
            "additions": 26,
            "deletions": 17,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_ref.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_ref.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_ref.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -19,6 +19,9 @@ use crate::{\n     timestamp::Timestamp,\n };\n \n+pub type GroupNameToDirectAndRecusiveSpans<'l> =\n+    FxIndexMap<(&'l str, &'l str), (Vec<SpanIndex>, Vec<SpanIndex>)>;\n+\n #[derive(Copy, Clone)]\n pub struct SpanRef<'a> {\n     pub(crate) span: &'a Span,\n@@ -89,18 +92,17 @@ impl<'a> SpanRef<'a> {\n                 .find(|&(k, _)| k == \"name\")\n                 .map(|(_, v)| v.as_str())\n             {\n-                if matches!(\n+                if matches!(self.span.name.as_str(), \"turbo_tasks::function\") {\n+                    (self.span.name.clone(), name.to_string())\n+                } else if matches!(\n                     self.span.name.as_str(),\n                     \"turbo_tasks::resolve_call\" | \"turbo_tasks::resolve_trait_call\"\n                 ) {\n-                    (\n-                        format!(\"{} {}\", self.span.name, self.span.category),\n-                        format!(\"*{name}\"),\n-                    )\n+                    (self.span.name.clone(), format!(\"*{name}\"))\n                 } else {\n                     (\n-                        format!(\"{} {}\", self.span.name, self.span.category),\n-                        name.to_string(),\n+                        self.span.category.clone(),\n+                        format!(\"{} {name}\", self.span.name),\n                     )\n                 }\n             } else {\n@@ -110,29 +112,37 @@ impl<'a> SpanRef<'a> {\n         (category, title)\n     }\n \n-    pub fn group_name(&self) -> &'a str {\n-        self.names().group_name.get_or_init(|| {\n+    pub fn group_name(&self) -> (&'a str, &'a str) {\n+        let (category, title) = self.names().group_name.get_or_init(|| {\n             if matches!(self.span.name.as_str(), \"turbo_tasks::function\") {\n-                self.span\n+                let name = self\n+                    .span\n                     .args\n                     .iter()\n                     .find(|&(k, _)| k == \"name\")\n                     .map(|(_, v)| v.to_string())\n-                    .unwrap_or_else(|| self.span.name.to_string())\n+                    .unwrap_or_else(|| self.span.name.to_string());\n+                (self.span.name.clone(), name)\n             } else if matches!(\n                 self.span.name.as_str(),\n                 \"turbo_tasks::resolve_call\" | \"turbo_tasks::resolve_trait_call\"\n             ) {\n-                self.span\n+                let name = self\n+                    .span\n                     .args\n                     .iter()\n                     .find(|&(k, _)| k == \"name\")\n                     .map(|(_, v)| format!(\"*{v}\"))\n-                    .unwrap_or_else(|| self.span.name.to_string())\n+                    .unwrap_or_else(|| self.span.name.to_string());\n+                (\n+                    self.span.category.clone(),\n+                    format!(\"{} {name}\", self.span.name),\n+                )\n             } else {\n-                self.span.name.to_string()\n+                (self.span.category.clone(), self.span.name.clone())\n             }\n-        })\n+        });\n+        (category.as_str(), title.as_str())\n     }\n \n     pub fn args(&self) -> impl Iterator<Item = (&str, &str)> {\n@@ -349,8 +359,7 @@ impl<'a> SpanRef<'a> {\n                         Entry { span, recursive }\n                     })\n                     .collect_vec_list();\n-                let mut map: FxIndexMap<&str, (Vec<SpanIndex>, Vec<SpanIndex>)> =\n-                    FxIndexMap::default();\n+                let mut map: GroupNameToDirectAndRecusiveSpans = FxIndexMap::default();\n                 for Entry {\n                     span,\n                     mut recursive,"
        },
        {
            "sha": "4b7a24a754253a1f15c251d61d7c8929f723f8a1",
            "filename": "turbopack/crates/turbopack-trace-server/src/string_tuple_ref.rs",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fstring_tuple_ref.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1937a19fb9f342b0f5a4b982b88dff8971a27e38/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fstring_tuple_ref.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fstring_tuple_ref.rs?ref=1937a19fb9f342b0f5a4b982b88dff8971a27e38",
            "patch": "@@ -0,0 +1,28 @@\n+use hashbrown::Equivalent;\n+\n+#[derive(Hash)]\n+pub struct StringTupleRef<'a>(pub &'a str, pub &'a str);\n+\n+impl<'a> Equivalent<(String, String)> for StringTupleRef<'a> {\n+    fn equivalent(&self, other: &(String, String)) -> bool {\n+        self.0 == other.0 && self.1 == other.1\n+    }\n+}\n+\n+#[cfg(test)]\n+mod string_tuple_ref_tests {\n+    use std::hash::RandomState;\n+\n+    use super::*;\n+\n+    #[test]\n+    fn test_string_tuple_ref_hash() {\n+        use std::hash::BuildHasher;\n+\n+        let s = RandomState::new();\n+        assert_eq!(\n+            s.hash_one(StringTupleRef(\"abc\", \"def\")),\n+            s.hash_one(&(\"abc\".to_string(), \"def\".to_string()))\n+        );\n+    }\n+}"
        }
    ],
    "stats": {
        "total": 170,
        "additions": 108,
        "deletions": 62
    }
}