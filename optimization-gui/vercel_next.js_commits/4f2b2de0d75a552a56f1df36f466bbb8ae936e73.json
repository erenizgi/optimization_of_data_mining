{
    "author": "ijjk",
    "message": "Only share incremental cache for edge in next start (#79386)\n\nWhen in minimal mode we should not try leveraging a shared\n`IncrementalCache` instance across invocations as we pass in request\nheaders which are request specific. The only time we should share this\ninstance is in `next start` mode where the sandbox needs to be able to\naccess the filesystem-cache.\n\nx-ref: [slack\nthread](https://vercel.slack.com/archives/C07CGAA2RS6/p1747687927600699?thread_ts=1747142004.153739&cid=C07CGAA2RS6)",
    "sha": "4f2b2de0d75a552a56f1df36f466bbb8ae936e73",
    "files": [
        {
            "sha": "d9cf2abc4cf65d901d7cd6795e39fe717bd22f53",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/4f2b2de0d75a552a56f1df36f466bbb8ae936e73/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4f2b2de0d75a552a56f1df36f466bbb8ae936e73/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=4f2b2de0d75a552a56f1df36f466bbb8ae936e73",
            "patch": "@@ -1467,6 +1467,8 @@ export default abstract class Server<\n \n         incrementalCache.resetRequestCache()\n         addRequestMeta(req, 'incrementalCache', incrementalCache)\n+        // This is needed for pages router to leverage unstable_cache\n+        // TODO: re-work this handling to not use global and use a AsyncStore\n         ;(globalThis as any).__incrementalCache = incrementalCache\n       }\n \n@@ -2457,13 +2459,15 @@ export default abstract class Server<\n \n     // use existing incrementalCache instance if available\n     const incrementalCache: import('./lib/incremental-cache').IncrementalCache =\n-      (globalThis as any).__incrementalCache ||\n-      (await this.getIncrementalCache({\n-        requestHeaders: Object.assign({}, req.headers),\n-        requestProtocol: protocol.substring(0, protocol.length - 1) as\n-          | 'http'\n-          | 'https',\n-      }))\n+      process.env.NEXT_RUNTIME === 'edge' &&\n+      (globalThis as any).__incrementalCache\n+        ? (globalThis as any).__incrementalCache\n+        : await this.getIncrementalCache({\n+            requestHeaders: Object.assign({}, req.headers),\n+            requestProtocol: protocol.substring(0, protocol.length - 1) as\n+              | 'http'\n+              | 'https',\n+          })\n \n     // TODO: investigate, this is not safe across multiple concurrent requests\n     incrementalCache.resetRequestCache()"
        },
        {
            "sha": "3f27a3ac81172d92add568b81b344b3bb3dea4f1",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4f2b2de0d75a552a56f1df36f466bbb8ae936e73/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4f2b2de0d75a552a56f1df36f466bbb8ae936e73/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=4f2b2de0d75a552a56f1df36f466bbb8ae936e73",
            "patch": "@@ -186,7 +186,10 @@ export async function adapter(\n   }\n \n   if (\n-    !(globalThis as any).__incrementalCache &&\n+    // If we are inside of the next start sandbox\n+    // leverage the shared instance if not we need\n+    // to create a fresh cache instance each time\n+    !(globalThis as any).__incrementalCacheShared &&\n     (params as any).IncrementalCache\n   ) {\n     ;(globalThis as any).__incrementalCache = new ("
        },
        {
            "sha": "039cb50b4e313e5bd1e866b06af83b7669e398d6",
            "filename": "packages/next/src/server/web/sandbox/sandbox.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4f2b2de0d75a552a56f1df36f466bbb8ae936e73/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4f2b2de0d75a552a56f1df36f466bbb8ae936e73/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts?ref=4f2b2de0d75a552a56f1df36f466bbb8ae936e73",
            "patch": "@@ -77,6 +77,7 @@ export async function getRuntimeContext(\n   })\n \n   if (params.incrementalCache) {\n+    runtime.context.globalThis.__incrementalCacheShared = true\n     runtime.context.globalThis.__incrementalCache = params.incrementalCache\n   }\n "
        }
    ],
    "stats": {
        "total": 24,
        "additions": 16,
        "deletions": 8
    }
}