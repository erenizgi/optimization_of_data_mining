{
    "author": "unstubbable",
    "message": "Client router should discard stale prefetch entries for static pages (#79309)\n\nWhen navigating to a static page that was previously prefetched, the\nclient router should discard a stale prefetch entry, and fetch the page\nagain, if the stale time has passed.\n\nThe selected stale time is either the default value of 5 minutes, a\ncustom value set via `experimental.staleTimes.static`, or a stale value\nset via a `cacheLife` profile when using `\"use cache\"`.\n\nThis also fixes an issue where the client router interpreted the stale\ntime value as milliseconds, whereas the server sends it in seconds. This\nwas previously already fixed with `clientSegmentCache` enabled in\n#74759.\n\nfixes #74272\nfixes #79093\nCloses NEXT-4109",
    "sha": "b42b442eadbb5ae19494693888a2895df5caef68",
    "files": [
        {
            "sha": "a1749859259e14eee3a5996b5feb76d76dc8a3ad",
            "filename": "packages/next/src/client/components/router-reducer/fetch-server-response.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts?ref=b42b442eadbb5ae19494693888a2895df5caef68",
            "patch": "@@ -187,9 +187,13 @@ export async function fetchServerResponse(\n     const contentType = res.headers.get('content-type') || ''\n     const interception = !!res.headers.get('vary')?.includes(NEXT_URL)\n     const postponed = !!res.headers.get(NEXT_DID_POSTPONE_HEADER)\n-    const staleTimeHeader = res.headers.get(NEXT_ROUTER_STALE_TIME_HEADER)\n+    const staleTimeHeaderSeconds = res.headers.get(\n+      NEXT_ROUTER_STALE_TIME_HEADER\n+    )\n     const staleTime =\n-      staleTimeHeader !== null ? parseInt(staleTimeHeader, 10) : -1\n+      staleTimeHeaderSeconds !== null\n+        ? parseInt(staleTimeHeaderSeconds, 10) * 1000\n+        : -1\n     let isFlightResponse = contentType.startsWith(RSC_CONTENT_TYPE_HEADER)\n \n     if (process.env.NODE_ENV === 'production') {"
        },
        {
            "sha": "f99e8b56807fdb1cafa81ce0d14537dff3f6287d",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=b42b442eadbb5ae19494693888a2895df5caef68",
            "patch": "@@ -391,6 +391,7 @@ async function exportAppImpl(\n     experimental: {\n       clientTraceMetadata: nextConfig.experimental.clientTraceMetadata,\n       expireTime: nextConfig.expireTime,\n+      staleTimes: nextConfig.experimental.staleTimes,\n       dynamicIO: nextConfig.experimental.dynamicIO ?? false,\n       clientSegmentCache:\n         nextConfig.experimental.clientSegmentCache === 'client-only'"
        },
        {
            "sha": "890ba1e91859ffa967b1986643cbeb20a073bb1e",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 16,
            "deletions": 9,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=b42b442eadbb5ae19494693888a2895df5caef68",
            "patch": "@@ -2704,6 +2704,12 @@ async function prerenderToStream(\n     setMetadataHeader(name)\n   }\n \n+  const selectStaleTime = (stale: number) =>\n+    stale === INFINITE_CACHE &&\n+    typeof renderOpts.experimental.staleTimes?.static === 'number'\n+      ? renderOpts.experimental.staleTimes.static\n+      : stale\n+\n   let prerenderStore: PrerenderStore | null = null\n \n   try {\n@@ -3139,7 +3145,7 @@ async function prerenderToStream(\n             // TODO: Should this include the SSR pass?\n             collectedRevalidate: finalRenderPrerenderStore.revalidate,\n             collectedExpire: finalRenderPrerenderStore.expire,\n-            collectedStale: finalRenderPrerenderStore.stale,\n+            collectedStale: selectStaleTime(finalRenderPrerenderStore.stale),\n             collectedTags: finalRenderPrerenderStore.tags,\n           }\n         } else {\n@@ -3202,7 +3208,7 @@ async function prerenderToStream(\n             // TODO: Should this include the SSR pass?\n             collectedRevalidate: finalRenderPrerenderStore.revalidate,\n             collectedExpire: finalRenderPrerenderStore.expire,\n-            collectedStale: finalRenderPrerenderStore.stale,\n+            collectedStale: selectStaleTime(finalRenderPrerenderStore.stale),\n             collectedTags: finalRenderPrerenderStore.tags,\n           }\n         }\n@@ -3639,7 +3645,7 @@ async function prerenderToStream(\n           // TODO: Should this include the SSR pass?\n           collectedRevalidate: finalServerPrerenderStore.revalidate,\n           collectedExpire: finalServerPrerenderStore.expire,\n-          collectedStale: finalServerPrerenderStore.stale,\n+          collectedStale: selectStaleTime(finalServerPrerenderStore.stale),\n           collectedTags: finalServerPrerenderStore.tags,\n         }\n       }\n@@ -3789,7 +3795,7 @@ async function prerenderToStream(\n           // TODO: Should this include the SSR pass?\n           collectedRevalidate: reactServerPrerenderStore.revalidate,\n           collectedExpire: reactServerPrerenderStore.expire,\n-          collectedStale: reactServerPrerenderStore.stale,\n+          collectedStale: selectStaleTime(reactServerPrerenderStore.stale),\n           collectedTags: reactServerPrerenderStore.tags,\n         }\n       } else if (fallbackRouteParams && fallbackRouteParams.size > 0) {\n@@ -3809,7 +3815,7 @@ async function prerenderToStream(\n           // TODO: Should this include the SSR pass?\n           collectedRevalidate: reactServerPrerenderStore.revalidate,\n           collectedExpire: reactServerPrerenderStore.expire,\n-          collectedStale: reactServerPrerenderStore.stale,\n+          collectedStale: selectStaleTime(reactServerPrerenderStore.stale),\n           collectedTags: reactServerPrerenderStore.tags,\n         }\n       } else {\n@@ -3870,7 +3876,7 @@ async function prerenderToStream(\n           // TODO: Should this include the SSR pass?\n           collectedRevalidate: reactServerPrerenderStore.revalidate,\n           collectedExpire: reactServerPrerenderStore.expire,\n-          collectedStale: reactServerPrerenderStore.stale,\n+          collectedStale: selectStaleTime(reactServerPrerenderStore.stale),\n           collectedTags: reactServerPrerenderStore.tags,\n         }\n       }\n@@ -3964,7 +3970,7 @@ async function prerenderToStream(\n         // TODO: Should this include the SSR pass?\n         collectedRevalidate: prerenderLegacyStore.revalidate,\n         collectedExpire: prerenderLegacyStore.expire,\n-        collectedStale: prerenderLegacyStore.stale,\n+        collectedStale: selectStaleTime(prerenderLegacyStore.stale),\n         collectedTags: prerenderLegacyStore.tags,\n       }\n     }\n@@ -4146,8 +4152,9 @@ async function prerenderToStream(\n           prerenderStore !== null ? prerenderStore.revalidate : INFINITE_CACHE,\n         collectedExpire:\n           prerenderStore !== null ? prerenderStore.expire : INFINITE_CACHE,\n-        collectedStale:\n-          prerenderStore !== null ? prerenderStore.stale : INFINITE_CACHE,\n+        collectedStale: selectStaleTime(\n+          prerenderStore !== null ? prerenderStore.stale : INFINITE_CACHE\n+        ),\n         collectedTags: prerenderStore !== null ? prerenderStore.tags : null,\n       }\n     } catch (finalErr: any) {"
        },
        {
            "sha": "f997afe93ba1c36d7d768940cb1487d46a68b261",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=b42b442eadbb5ae19494693888a2895df5caef68",
            "patch": "@@ -1,6 +1,9 @@\n import type { LoadComponentsReturnType } from '../load-components'\n import type { ServerRuntime, SizeLimit } from '../../types'\n-import type { NextConfigComplete } from '../../server/config-shared'\n+import type {\n+  ExperimentalConfig,\n+  NextConfigComplete,\n+} from '../../server/config-shared'\n import type { ClientReferenceManifest } from '../../build/webpack/plugins/flight-manifest-plugin'\n import type { NextFontManifest } from '../../build/webpack/plugins/next-font-manifest-plugin'\n import type { ParsedUrlQuery } from 'querystring'\n@@ -228,6 +231,7 @@ export interface RenderOptsPartial {\n      */\n     isRoutePPREnabled?: boolean\n     expireTime: number | undefined\n+    staleTimes: ExperimentalConfig['staleTimes'] | undefined\n     clientTraceMetadata: string[] | undefined\n     dynamicIO: boolean\n     clientSegmentCache: boolean | 'client-only'"
        },
        {
            "sha": "02d0e24cc835244b2b4736a2bd408e8dbd1306ea",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b42b442eadbb5ae19494693888a2895df5caef68/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=b42b442eadbb5ae19494693888a2895df5caef68",
            "patch": "@@ -602,6 +602,7 @@ export default abstract class Server<\n       htmlLimitedBots: this.nextConfig.htmlLimitedBots,\n       experimental: {\n         expireTime: this.nextConfig.expireTime,\n+        staleTimes: this.nextConfig.experimental.staleTimes,\n         clientTraceMetadata: this.nextConfig.experimental.clientTraceMetadata,\n         dynamicIO: this.nextConfig.experimental.dynamicIO ?? false,\n         clientSegmentCache:"
        },
        {
            "sha": "2dc02b1853d9cf6fb87edc50cf56bdf90f550f1e",
            "filename": "test/e2e/app-dir/app-prefetch/prefetching.stale-times.test.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 44,
            "changes": 93,
            "blob_url": "https://github.com/vercel/next.js/blob/b42b442eadbb5ae19494693888a2895df5caef68/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b42b442eadbb5ae19494693888a2895df5caef68/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-prefetch%2Fprefetching.stale-times.test.ts?ref=b42b442eadbb5ae19494693888a2895df5caef68",
            "patch": "@@ -1,31 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { retry } from 'next-test-utils'\n-\n-import { NEXT_RSC_UNION_QUERY } from 'next/dist/client/components/app-router-headers'\n-\n-const browserConfigWithFixedTime = {\n-  beforePageLoad: (page) => {\n-    page.addInitScript(() => {\n-      const startTime = new Date()\n-      const fixedTime = new Date('2023-04-17T00:00:00Z')\n-\n-      // Override the Date constructor\n-      // @ts-ignore\n-      // eslint-disable-next-line no-native-reassign\n-      Date = class extends Date {\n-        constructor() {\n-          super()\n-          // @ts-ignore\n-          return new startTime.constructor(fixedTime)\n-        }\n-\n-        static now() {\n-          return fixedTime.getTime()\n-        }\n-      }\n-    })\n-  },\n-}\n+import { retry, waitFor } from 'next-test-utils'\n \n describe('app dir - prefetching (custom staleTime)', () => {\n   const { next, isNextDev } = nextTestSetup({\n@@ -34,8 +8,8 @@ describe('app dir - prefetching (custom staleTime)', () => {\n     nextConfig: {\n       experimental: {\n         staleTimes: {\n-          static: 180,\n-          dynamic: 30,\n+          static: 30,\n+          dynamic: 20,\n         },\n       },\n     },\n@@ -47,25 +21,18 @@ describe('app dir - prefetching (custom staleTime)', () => {\n   }\n \n   it('should not fetch again when a static page was prefetched when navigating to it twice', async () => {\n-    const browser = await next.browser('/404', browserConfigWithFixedTime)\n+    const browser = await next.browser('/404')\n     let requests: string[] = []\n \n     browser.on('request', (req) => {\n       requests.push(new URL(req.url()).pathname)\n     })\n     await browser.eval('location.href = \"/\"')\n \n-    await browser.eval(\n-      `window.nd.router.prefetch(\"/static-page\", {kind: \"auto\"})`\n-    )\n-\n     await retry(async () => {\n       expect(\n-        requests.filter(\n-          (request) =>\n-            request === '/static-page' || request.includes(NEXT_RSC_UNION_QUERY)\n-        ).length\n-      ).toBe(1)\n+        requests.filter((request) => request === '/static-page')\n+      ).toHaveLength(1)\n     })\n \n     await browser\n@@ -86,11 +53,49 @@ describe('app dir - prefetching (custom staleTime)', () => {\n \n     await retry(async () => {\n       expect(\n-        requests.filter(\n-          (request) =>\n-            request === '/static-page' || request.includes(NEXT_RSC_UNION_QUERY)\n-        ).length\n-      ).toBe(1)\n+        requests.filter((request) => request === '/static-page')\n+      ).toHaveLength(1)\n+    })\n+  })\n+\n+  it('should fetch again when a static page was prefetched when navigating to it after the stale time has passed', async () => {\n+    const browser = await next.browser('/404')\n+    let requests: string[] = []\n+\n+    browser.on('request', (req) => {\n+      requests.push(new URL(req.url()).pathname)\n+    })\n+    await browser.eval('location.href = \"/\"')\n+\n+    await retry(async () => {\n+      expect(\n+        requests.filter((request) => request === '/static-page')\n+      ).toHaveLength(1)\n+    })\n+\n+    await browser\n+      .elementByCss('#to-static-page')\n+      .click()\n+      .waitForElementByCss('#static-page')\n+\n+    const linkToStaticPage = await browser\n+      .elementByCss('#to-home')\n+      // Go back to home page\n+      .click()\n+      // Wait for homepage to load\n+      .waitForElementByCss('#to-static-page')\n+\n+    // Wait for the stale time to pass.\n+    await waitFor(30000)\n+    // Click on the link to the static page again\n+    await linkToStaticPage.click()\n+    // Wait for the static page to load again\n+    await browser.waitForElementByCss('#static-page')\n+\n+    await retry(async () => {\n+      expect(\n+        requests.filter((request) => request === '/static-page')\n+      ).toHaveLength(2)\n     })\n   })\n "
        }
    ],
    "stats": {
        "total": 134,
        "additions": 78,
        "deletions": 56
    }
}