{
    "author": "bgw",
    "message": "test(turbo-tasks-fs): Add a fuzzer for the filesystem watcher (#78160)\n\nAdds a very basic fuzzer for the filesystem watcher.\n\nThis already reveals that there's some undiagnosed bug with not re-watching deleted-and-recreated directories on Linux that does not occur on macos:\n\n**Debian:**\n![Screenshot 2025-04-14 at 11.59.14 AM.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/HAZVitxRNnZz8QMiPn4a/e5b26a76-0f9e-4623-9d56-b97115314041.png)\n\n**macos:**\n![Screenshot 2025-04-14 at 12.03.19 PM.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/HAZVitxRNnZz8QMiPn4a/ccbbf4b8-ab32-4489-b240-45206e9f0f66.png)",
    "sha": "581975d7cfa5c9aa8a008df3306d8779a175bfc7",
    "files": [
        {
            "sha": "5eca723de290c98ea6c6cfcf028620488774af08",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 140,
            "deletions": 38,
            "changes": 178,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -39,7 +39,7 @@ version = \"0.7.8\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"891477e0c6a8957309ee5c45a6368af3ae14bb510732d2684ffa19af310920f9\"\n dependencies = [\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"once_cell\",\n  \"version_check\",\n ]\n@@ -51,11 +51,11 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"e89da841a80418a9b391ebaea17f5c112ffaaa96f621d2c285b5174da76b9011\"\n dependencies = [\n  \"cfg-if\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"once_cell\",\n  \"serde\",\n  \"version_check\",\n- \"zerocopy\",\n+ \"zerocopy 0.7.32\",\n ]\n \n [[package]]\n@@ -2587,10 +2587,22 @@ dependencies = [\n  \"cfg-if\",\n  \"js-sys\",\n  \"libc\",\n- \"wasi\",\n+ \"wasi 0.11.0+wasi-snapshot-preview1\",\n  \"wasm-bindgen\",\n ]\n \n+[[package]]\n+name = \"getrandom\"\n+version = \"0.3.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"73fea8450eea4bac3940448fb7ae50d91f034f941199fcd9d909a5a07aa455f0\"\n+dependencies = [\n+ \"cfg-if\",\n+ \"libc\",\n+ \"r-efi\",\n+ \"wasi 0.14.2+wasi-0.2.4\",\n+]\n+\n [[package]]\n name = \"gif\"\n version = \"0.13.1\"\n@@ -3817,7 +3829,7 @@ dependencies = [\n  \"cssparser-color\",\n  \"dashmap 5.5.3\",\n  \"data-encoding\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"indexmap 2.7.1\",\n  \"itertools 0.10.5\",\n  \"lazy_static\",\n@@ -4225,7 +4237,7 @@ checksum = \"a4a650543ca06a924e8b371db273b2756685faae30f8487da1b56505a8f78b0c\"\n dependencies = [\n  \"libc\",\n  \"log\",\n- \"wasi\",\n+ \"wasi 0.11.0+wasi-snapshot-preview1\",\n  \"windows-sys 0.48.0\",\n ]\n \n@@ -4237,7 +4249,7 @@ checksum = \"2886843bf800fba2e3377cff24abf6379b4c4d5c6681eaf9ea5b0d15090450bd\"\n dependencies = [\n  \"libc\",\n  \"log\",\n- \"wasi\",\n+ \"wasi 0.11.0+wasi-snapshot-preview1\",\n  \"windows-sys 0.52.0\",\n ]\n \n@@ -4444,7 +4456,7 @@ dependencies = [\n  \"next-api\",\n  \"next-core\",\n  \"num_cpus\",\n- \"rand\",\n+ \"rand 0.9.0\",\n  \"serde_json\",\n  \"tokio\",\n  \"tokio-stream\",\n@@ -4572,7 +4584,7 @@ dependencies = [\n  \"console-subscriber\",\n  \"dashmap 6.1.0\",\n  \"dhat\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"iana-time-zone\",\n  \"indexmap 2.7.1\",\n  \"lightningcss-napi\",\n@@ -4587,7 +4599,7 @@ dependencies = [\n  \"once_cell\",\n  \"owo-colors 3.5.0\",\n  \"par-core\",\n- \"rand\",\n+ \"rand 0.9.0\",\n  \"rustc-hash 2.1.0\",\n  \"serde\",\n  \"serde_json\",\n@@ -5169,7 +5181,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"48e4cc64c2ad9ebe670cb8fd69dd50ae301650392e81c05f9bfcb2d5bdbc24b0\"\n dependencies = [\n  \"phf_shared\",\n- \"rand\",\n+ \"rand 0.8.5\",\n ]\n \n [[package]]\n@@ -5332,7 +5344,7 @@ version = \"0.1.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"be97d76faf1bfab666e1375477b23fde79eccf0276e9b63b92a39d676a889ba9\"\n dependencies = [\n- \"rand\",\n+ \"rand 0.8.5\",\n ]\n \n [[package]]\n@@ -5636,6 +5648,12 @@ dependencies = [\n  \"proc-macro2\",\n ]\n \n+[[package]]\n+name = \"r-efi\"\n+version = \"5.2.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"74765f6d916ee2faa39bc8e68e4f3ed8949b48cccdac59983d287a7cb71ce9c5\"\n+\n [[package]]\n name = \"radium\"\n version = \"0.7.0\"\n@@ -5664,8 +5682,19 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"34af8d1a0e25924bc5b7c43c079c942339d8f0a8b57c39049bef581b46327404\"\n dependencies = [\n  \"libc\",\n- \"rand_chacha\",\n- \"rand_core\",\n+ \"rand_chacha 0.3.1\",\n+ \"rand_core 0.6.4\",\n+]\n+\n+[[package]]\n+name = \"rand\"\n+version = \"0.9.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"3779b94aeb87e8bd4e834cee3650289ee9e0d5677f976ecdb6d219e5f4f6cd94\"\n+dependencies = [\n+ \"rand_chacha 0.9.0\",\n+ \"rand_core 0.9.3\",\n+ \"zerocopy 0.8.24\",\n ]\n \n [[package]]\n@@ -5675,7 +5704,17 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"e6c10a63a0fa32252be49d21e7709d4d4baf8d231c2dbce1eaa8141b9b127d88\"\n dependencies = [\n  \"ppv-lite86\",\n- \"rand_core\",\n+ \"rand_core 0.6.4\",\n+]\n+\n+[[package]]\n+name = \"rand_chacha\"\n+version = \"0.9.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"d3022b5f1df60f26e1ffddd6c66e8aa15de382ae63b3a0c1bfc0e4d3e3f325cb\"\n+dependencies = [\n+ \"ppv-lite86\",\n+ \"rand_core 0.9.3\",\n ]\n \n [[package]]\n@@ -5684,7 +5723,16 @@ version = \"0.6.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"ec0be4795e2f6a28069bec0b5ff3e2ac9bafc99e6a9a7dc3547996c5c816922c\"\n dependencies = [\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n+]\n+\n+[[package]]\n+name = \"rand_core\"\n+version = \"0.9.3\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"99d9a13982dcf210057a8a78572b2217b667c3beacbf3a0d8b454f6f82837d38\"\n+dependencies = [\n+ \"getrandom 0.3.2\",\n ]\n \n [[package]]\n@@ -5713,8 +5761,8 @@ dependencies = [\n  \"once_cell\",\n  \"paste\",\n  \"profiling\",\n- \"rand\",\n- \"rand_chacha\",\n+ \"rand 0.8.5\",\n+ \"rand_chacha 0.3.1\",\n  \"simd_helpers\",\n  \"system-deps\",\n  \"thiserror 1.0.69\",\n@@ -5992,7 +6040,7 @@ checksum = \"c17fa4cb658e3583423e915b9f3acc01cceaee1860e33d59ebae66adc3a2dc0d\"\n dependencies = [\n  \"cc\",\n  \"cfg-if\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"libc\",\n  \"spin 0.9.8\",\n  \"untrusted 0.9.0\",\n@@ -6102,7 +6150,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"45f80dcc84beab3a327bbe161f77db25f336a1452428176787c8c79ac79d7073\"\n dependencies = [\n  \"quote\",\n- \"rand\",\n+ \"rand 0.8.5\",\n  \"rustc_version 0.4.0\",\n  \"syn 1.0.109\",\n ]\n@@ -8926,7 +8974,7 @@ dependencies = [\n  \"indexmap 1.9.3\",\n  \"pin-project\",\n  \"pin-project-lite\",\n- \"rand\",\n+ \"rand 0.8.5\",\n  \"slab\",\n  \"tokio\",\n  \"tokio-util\",\n@@ -9095,7 +9143,7 @@ dependencies = [\n  \"http 0.2.11\",\n  \"httparse\",\n  \"log\",\n- \"rand\",\n+ \"rand 0.8.5\",\n  \"sha1\",\n  \"thiserror 1.0.69\",\n  \"url\",\n@@ -9114,7 +9162,7 @@ dependencies = [\n  \"http 0.2.11\",\n  \"httparse\",\n  \"log\",\n- \"rand\",\n+ \"rand 0.8.5\",\n  \"sha1\",\n  \"thiserror 1.0.69\",\n  \"url\",\n@@ -9133,7 +9181,7 @@ dependencies = [\n  \"http 1.1.0\",\n  \"httparse\",\n  \"log\",\n- \"rand\",\n+ \"rand 0.8.5\",\n  \"sha1\",\n  \"thiserror 1.0.69\",\n  \"url\",\n@@ -9152,7 +9200,7 @@ dependencies = [\n  \"pot\",\n  \"qfilter\",\n  \"quick_cache\",\n- \"rand\",\n+ \"rand 0.9.0\",\n  \"rayon\",\n  \"rustc-hash 2.1.0\",\n  \"serde\",\n@@ -9257,7 +9305,7 @@ dependencies = [\n  \"once_cell\",\n  \"parking_lot\",\n  \"pot\",\n- \"rand\",\n+ \"rand 0.9.0\",\n  \"rayon\",\n  \"regex\",\n  \"rustc-hash 2.1.0\",\n@@ -9381,6 +9429,22 @@ dependencies = [\n  \"urlencoding\",\n ]\n \n+[[package]]\n+name = \"turbo-tasks-fuzz\"\n+version = \"0.0.0\"\n+dependencies = [\n+ \"anyhow\",\n+ \"clap\",\n+ \"rand 0.9.0\",\n+ \"rustc-hash 2.1.0\",\n+ \"tokio\",\n+ \"turbo-rcstr\",\n+ \"turbo-tasks\",\n+ \"turbo-tasks-backend\",\n+ \"turbo-tasks-build\",\n+ \"turbo-tasks-fs\",\n+]\n+\n [[package]]\n name = \"turbo-tasks-hash\"\n version = \"0.1.0\"\n@@ -9448,7 +9512,7 @@ dependencies = [\n  \"num_cpus\",\n  \"once_cell\",\n  \"parking_lot\",\n- \"rand\",\n+ \"rand 0.9.0\",\n  \"ref-cast\",\n  \"regex\",\n  \"rstest\",\n@@ -9532,7 +9596,7 @@ dependencies = [\n  \"owo-colors 3.5.0\",\n  \"parking_lot\",\n  \"portpicker\",\n- \"rand\",\n+ \"rand 0.9.0\",\n  \"regex\",\n  \"rustc-hash 2.1.0\",\n  \"serde_json\",\n@@ -10136,7 +10200,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"97fee6b57c6a41524a810daee9286c02d7752c4253064d0b05472833a438f675\"\n dependencies = [\n  \"cfg-if\",\n- \"rand\",\n+ \"rand 0.8.5\",\n  \"static_assertions\",\n ]\n \n@@ -10146,7 +10210,7 @@ version = \"2.1.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"e7b17f197b3050ba473acf9181f7b1d3b66d1cf7356c6cc57886662276e65908\"\n dependencies = [\n- \"rand\",\n+ \"rand 0.8.5\",\n ]\n \n [[package]]\n@@ -10451,7 +10515,7 @@ dependencies = [\n  \"derivative\",\n  \"dunce\",\n  \"futures\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"indexmap 1.9.3\",\n  \"lazy_static\",\n  \"pin-project-lite\",\n@@ -10478,7 +10542,7 @@ dependencies = [\n  \"filetime\",\n  \"fs_extra\",\n  \"futures\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"indexmap 1.9.3\",\n  \"lazy_static\",\n  \"libc\",\n@@ -10658,13 +10722,22 @@ version = \"0.11.0+wasi-snapshot-preview1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"9c8d87e72b64a3b4db28d11ce29237c246188f4f51057d65a7eab63b7987e423\"\n \n+[[package]]\n+name = \"wasi\"\n+version = \"0.14.2+wasi-0.2.4\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"9683f9a5a998d873c0d21fcbe3c083009670149a8fab228644b8bd36b2c48cb3\"\n+dependencies = [\n+ \"wit-bindgen-rt\",\n+]\n+\n [[package]]\n name = \"wasm\"\n version = \"0.0.0\"\n dependencies = [\n  \"anyhow\",\n  \"console_error_panic_hook\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"js-sys\",\n  \"mdxjs\",\n  \"next-custom-transforms\",\n@@ -10981,7 +11054,7 @@ dependencies = [\n  \"bytecheck 0.6.11\",\n  \"enum-iterator\",\n  \"enumset\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"hex\",\n  \"indexmap 2.7.1\",\n  \"more-asserts\",\n@@ -11037,7 +11110,7 @@ dependencies = [\n  \"dashmap 6.1.0\",\n  \"derive_more 1.0.0\",\n  \"futures\",\n- \"getrandom\",\n+ \"getrandom 0.2.15\",\n  \"heapless\",\n  \"hex\",\n  \"http 1.1.0\",\n@@ -11051,7 +11124,7 @@ dependencies = [\n  \"petgraph 0.6.3\",\n  \"pin-project\",\n  \"pin-utils\",\n- \"rand\",\n+ \"rand 0.8.5\",\n  \"rkyv 0.8.9\",\n  \"rusty_pool\",\n  \"semver 1.0.23\",\n@@ -11204,7 +11277,7 @@ dependencies = [\n  \"libc\",\n  \"once_cell\",\n  \"path-clean 1.0.1\",\n- \"rand\",\n+ \"rand 0.8.5\",\n  \"serde\",\n  \"serde_json\",\n  \"sha2\",\n@@ -11629,6 +11702,15 @@ dependencies = [\n  \"windows-sys 0.48.0\",\n ]\n \n+[[package]]\n+name = \"wit-bindgen-rt\"\n+version = \"0.39.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"6f42320e61fe2cfd34354ecb597f86f413484a798ba44a8ca1165c58d42da6c1\"\n+dependencies = [\n+ \"bitflags 2.5.0\",\n+]\n+\n [[package]]\n name = \"write16\"\n version = \"1.0.0\"\n@@ -11730,7 +11812,16 @@ version = \"0.7.32\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"74d4d3961e53fa4c9a25a8637fc2bfaf2595b3d3ae34875568a5cf64787716be\"\n dependencies = [\n- \"zerocopy-derive\",\n+ \"zerocopy-derive 0.7.32\",\n+]\n+\n+[[package]]\n+name = \"zerocopy\"\n+version = \"0.8.24\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"2586fea28e186957ef732a5f8b3be2da217d65c5969d4b1e17f973ebbe876879\"\n+dependencies = [\n+ \"zerocopy-derive 0.8.24\",\n ]\n \n [[package]]\n@@ -11744,6 +11835,17 @@ dependencies = [\n  \"syn 2.0.95\",\n ]\n \n+[[package]]\n+name = \"zerocopy-derive\"\n+version = \"0.8.24\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"a996a8f63c5c4448cd959ac1bab0aaa3306ccfd060472f85943ee0750f0169be\"\n+dependencies = [\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn 2.0.95\",\n+]\n+\n [[package]]\n name = \"zerofrom\"\n version = \"0.1.5\""
        },
        {
            "sha": "6c07bfe1ec6d3baf6cfe1a4c121ac918b4693e00",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -385,7 +385,7 @@ pretty_assertions = \"1.3.0\"\n proc-macro2 = \"1.0.79\"\n qstring = \"0.7.2\"\n quote = \"1.0.23\"\n-rand = \"0.8.5\"\n+rand = \"0.9.0\"\n rayon = \"1.10.0\"\n regex = \"1.10.6\"\n reqwest = { version = \"=0.11.17\", default-features = false }"
        },
        {
            "sha": "303863a696d2d7d8a38aace23ca8d29a24ef1486",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -466,7 +466,7 @@ async fn benchmark_file_io(directory: Vc<FileSystemPath>) -> Result<Vc<Completio\n     ));\n \n     let mut random_buffer = [0u8; 512];\n-    rand::thread_rng().fill(&mut random_buffer[..]);\n+    rand::rng().fill(&mut random_buffer[..]);\n \n     // perform IO directly with tokio (skipping `tokio_tasks_fs`) to avoid the\n     // additional noise/overhead of tasks caching, invalidation, file locks,"
        },
        {
            "sha": "2790b79b9771c7c476f3753a5964db599e153f4a",
            "filename": "turbopack/crates/turbo-persistence/src/compaction/selector.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -264,7 +264,7 @@ mod tests {\n     fn simulate_compactions() {\n         let mut rnd = rand::rngs::SmallRng::from_seed([0; 32]);\n         let mut keys = (0..1000)\n-            .map(|_| rnd.gen_range(0..10000))\n+            .map(|_| rnd.random_range(0..10000))\n             .collect::<Vec<_>>();\n \n         let mut containers = keys\n@@ -274,7 +274,7 @@ mod tests {\n \n         let mut warm_keys = (0..100)\n             .map(|_| {\n-                let i = rnd.gen_range(0..keys.len());\n+                let i = rnd.random_range(0..keys.len());\n                 keys.swap_remove(i)\n             })\n             .collect::<Vec<_>>();\n@@ -310,8 +310,8 @@ mod tests {\n \n             // Change some warm keys\n             for _ in 0..10 {\n-                let i = rnd.gen_range(0..warm_keys.len());\n-                let j = rnd.gen_range(0..keys.len());\n+                let i = rnd.random_range(0..warm_keys.len());\n+                let j = rnd.random_range(0..keys.len());\n                 swap(&mut warm_keys[i], &mut keys[j]);\n             }\n         }"
        },
        {
            "sha": "111b9b4a2bac1515848620f344ffee10c28e4a98",
            "filename": "turbopack/crates/turbo-tasks-backend/src/utils/dash_map_multi.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdash_map_multi.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdash_map_multi.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdash_map_multi.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -215,7 +215,7 @@ mod tests {\n         let indicies = (0..THREADS)\n             .map(|_| {\n                 let mut vec = (0..N).collect::<Vec<_>>();\n-                vec.shuffle(&mut rand::thread_rng());\n+                vec.shuffle(&mut rand::rng());\n                 vec\n             })\n             .collect::<Vec<_>>();"
        },
        {
            "sha": "f3225c9737713a786bf29be20eabe07adda3b763",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -473,7 +473,8 @@ impl DiskFileSystem {\n     /// # Arguments\n     ///\n     /// * `name` - Name of the filesystem.\n-    /// * `root` - Path to the given filesystem's root.\n+    /// * `root` - Path to the given filesystem's root. Should be\n+    ///   [canonicalized][std::fs::canonicalize].\n     /// * `ignored_subpaths` - A list of subpaths that should not trigger invalidation. This should\n     ///   be a full path, since it is possible that root & project dir is different and requires to\n     ///   ignore specific subpaths from each."
        },
        {
            "sha": "ca662a1d6c0409a6e4adbbcb5d48287c43692fbd",
            "filename": "turbopack/crates/turbo-tasks-fuzz/Cargo.toml",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2FCargo.toml?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -0,0 +1,23 @@\n+[package]\n+name = \"turbo-tasks-fuzz\"\n+version = \"0.0.0\"\n+description = \"A collection of fuzzers for `turbo-tasks`\"\n+license = \"MIT\"\n+edition = \"2021\"\n+\n+[lints]\n+workspace = true\n+\n+[dependencies]\n+anyhow = { workspace = true }\n+clap = { workspace = true }\n+rand = { workspace = true, features = [\"thread_rng\"] }\n+rustc-hash = { workspace = true }\n+tokio = { workspace = true }\n+turbo-rcstr = { workspace = true }\n+turbo-tasks = { workspace = true }\n+turbo-tasks-backend = { workspace = true }\n+turbo-tasks-fs = { workspace = true }\n+\n+[build-dependencies]\n+turbo-tasks-build = { workspace = true }"
        },
        {
            "sha": "1673efed59cce6379c6a83d17829dfc0687e253f",
            "filename": "turbopack/crates/turbo-tasks-fuzz/build.rs",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fbuild.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fbuild.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fbuild.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -0,0 +1,5 @@\n+use turbo_tasks_build::generate_register;\n+\n+fn main() {\n+    generate_register();\n+}"
        },
        {
            "sha": "5aa87bd57455f32f898d98e4b8c0a5856aa0e55d",
            "filename": "turbopack/crates/turbo-tasks-fuzz/src/main.rs",
            "status": "added",
            "additions": 258,
            "deletions": 0,
            "changes": 258,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fuzz%2Fsrc%2Fmain.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -0,0 +1,258 @@\n+use std::{\n+    fs::OpenOptions,\n+    io::Write,\n+    iter,\n+    path::{Path, PathBuf},\n+    sync::{Arc, Mutex},\n+    time::Duration,\n+};\n+\n+use clap::{Args, Parser, Subcommand};\n+use rand::{Rng, RngCore, SeedableRng};\n+use rustc_hash::FxHashSet;\n+use tokio::time::sleep;\n+use turbo_rcstr::RcStr;\n+use turbo_tasks::{trace::TraceRawVcs, NonLocalValue, ResolvedVc, TransientInstance, Vc};\n+use turbo_tasks_backend::{noop_backing_storage, BackendOptions, TurboTasksBackend};\n+use turbo_tasks_fs::{DiskFileSystem, FileSystem, FileSystemPath};\n+\n+/// A collection of fuzzers for `turbo-tasks`. These are not test cases as they're slow and (in many\n+/// cases) non-deterministic.\n+///\n+/// It's recommend you build this with `--release`.\n+///\n+/// This is its own crate to avoid littering other crates with binary-only dependencies\n+/// <https://github.com/rust-lang/cargo/issues/1982>.\n+#[derive(Parser)]\n+#[command()]\n+struct Cli {\n+    #[command(subcommand)]\n+    command: Commands,\n+}\n+\n+#[derive(Subcommand)]\n+enum Commands {\n+    /// Continuously fuzzes the filesystem watcher until ctrl+c'd.\n+    FsWatcher(FsWatcher),\n+}\n+\n+#[derive(Args)]\n+struct FsWatcher {\n+    #[arg(long)]\n+    fs_root: PathBuf,\n+    #[arg(long, default_value_t = 4)]\n+    depth: usize,\n+    #[arg(long, default_value_t = 6)]\n+    width: usize,\n+    #[arg(long, default_value_t = 100)]\n+    notify_timeout_ms: u64,\n+    #[arg(long, default_value_t = 200)]\n+    file_modifications: u32,\n+    #[arg(long, default_value_t = 2)]\n+    directory_modifications: u32,\n+}\n+\n+#[tokio::main]\n+async fn main() -> anyhow::Result<()> {\n+    register();\n+    let cli = Cli::parse();\n+\n+    match cli.command {\n+        Commands::FsWatcher(args) => fuzz_fs_watcher(args).await,\n+    }\n+}\n+\n+#[derive(Default, NonLocalValue, TraceRawVcs)]\n+struct PathInvalidations(#[turbo_tasks(trace_ignore)] Arc<Mutex<FxHashSet<RcStr>>>);\n+\n+async fn fuzz_fs_watcher(args: FsWatcher) -> anyhow::Result<()> {\n+    std::fs::create_dir(&args.fs_root)?;\n+    let fs_root = args.fs_root.canonicalize()?;\n+    let _guard = FsCleanup {\n+        path: &fs_root.clone(),\n+    };\n+\n+    let tt = turbo_tasks::TurboTasks::new(TurboTasksBackend::new(\n+        BackendOptions::default(),\n+        noop_backing_storage(),\n+    ));\n+    tt.run_once(async move {\n+        let invalidations = TransientInstance::new(PathInvalidations::default());\n+        let fs_root_rcstr = RcStr::from(fs_root.to_str().unwrap());\n+        let project_fs = disk_file_system_operation(fs_root_rcstr.clone())\n+            .resolve_strongly_consistent()\n+            .await?;\n+        let project_root = disk_file_system_root_operation(project_fs)\n+            .resolve_strongly_consistent()\n+            .await?;\n+        create_directory_tree(&mut FxHashSet::default(), &fs_root, args.depth, args.width)?;\n+\n+        project_fs.await?.start_watching(None).await?;\n+\n+        let read_all_paths_op =\n+            read_all_paths_operation(invalidations.clone(), project_root, args.depth, args.width);\n+        read_all_paths_op.read_strongly_consistent().await?;\n+        {\n+            let mut invalidations = invalidations.0.lock().unwrap();\n+            println!(\"read all {} files\", invalidations.len());\n+            invalidations.clear();\n+        }\n+\n+        let mut rand_buf = [0; 16];\n+        let mut rng = rand::rngs::SmallRng::from_rng(&mut rand::rng());\n+        loop {\n+            let mut modified_file_paths = FxHashSet::default();\n+            for _ in 0..args.file_modifications {\n+                let path = fs_root.join(pick_random_file(args.depth, args.width));\n+                let mut f = OpenOptions::new().write(true).truncate(true).open(&path)?;\n+                rng.fill_bytes(&mut rand_buf);\n+                f.write_all(&rand_buf)?;\n+                f.flush()?;\n+                modified_file_paths.insert(path);\n+            }\n+            for _ in 0..args.directory_modifications {\n+                let dir = pick_random_directory(args.depth, args.width);\n+                let path = fs_root.join(dir.path);\n+                std::fs::remove_dir_all(&path)?;\n+                std::fs::create_dir(&path)?;\n+                create_directory_tree(\n+                    &mut modified_file_paths,\n+                    &path,\n+                    args.depth - dir.depth,\n+                    args.width,\n+                )?;\n+            }\n+            // there's no way to know when we've received all the pending events from the operating\n+            // system, so just sleep and pray\n+            sleep(Duration::from_millis(args.notify_timeout_ms)).await;\n+            read_all_paths_op.read_strongly_consistent().await?;\n+            {\n+                let mut invalidations = invalidations.0.lock().unwrap();\n+                println!(\n+                    \"modified {} files and found {} invalidations\",\n+                    modified_file_paths.len(),\n+                    invalidations.len()\n+                );\n+                invalidations.clear();\n+            }\n+        }\n+    })\n+    .await\n+}\n+\n+#[turbo_tasks::function(operation)]\n+fn disk_file_system_operation(fs_root: RcStr) -> Vc<DiskFileSystem> {\n+    DiskFileSystem::new(\"project\".into(), fs_root, Vec::new())\n+}\n+\n+#[turbo_tasks::function(operation)]\n+fn disk_file_system_root_operation(fs: ResolvedVc<DiskFileSystem>) -> Vc<FileSystemPath> {\n+    fs.root()\n+}\n+\n+#[turbo_tasks::function]\n+async fn read_path(\n+    invalidations: TransientInstance<PathInvalidations>,\n+    path: ResolvedVc<FileSystemPath>,\n+) -> anyhow::Result<()> {\n+    let path_str = path.await?.path.clone();\n+    invalidations.0.lock().unwrap().insert(path_str);\n+    let _ = path.track().await?;\n+    Ok(())\n+}\n+\n+#[turbo_tasks::function(operation)]\n+async fn read_all_paths_operation(\n+    invalidations: TransientInstance<PathInvalidations>,\n+    root: ResolvedVc<FileSystemPath>,\n+    depth: usize,\n+    width: usize,\n+) -> anyhow::Result<()> {\n+    async fn read_all_paths_inner(\n+        invalidations: TransientInstance<PathInvalidations>,\n+        parent: ResolvedVc<FileSystemPath>,\n+        depth: usize,\n+        width: usize,\n+    ) -> anyhow::Result<()> {\n+        for child_id in 0..width {\n+            let child_name = RcStr::from(child_id.to_string());\n+            let child_path = parent.join(child_name).to_resolved().await?;\n+            if depth == 1 {\n+                read_path(invalidations.clone(), *child_path).await?;\n+            } else {\n+                Box::pin(read_all_paths_inner(\n+                    invalidations.clone(),\n+                    child_path,\n+                    depth - 1,\n+                    width,\n+                ))\n+                .await?;\n+            }\n+        }\n+        Ok(())\n+    }\n+    read_all_paths_inner(invalidations, root, depth, width).await\n+}\n+\n+fn create_directory_tree(\n+    modified_file_paths: &mut FxHashSet<PathBuf>,\n+    parent: &Path,\n+    depth: usize,\n+    width: usize,\n+) -> anyhow::Result<()> {\n+    let mut rng = rand::rng();\n+    let mut rand_buf = [0; 16];\n+    for child_id in 0..width {\n+        let child_name = child_id.to_string();\n+        let child_path = parent.join(&child_name);\n+        if depth == 1 {\n+            let mut f = std::fs::File::create(&child_path)?;\n+            rng.fill_bytes(&mut rand_buf);\n+            f.write_all(&rand_buf)?;\n+            f.flush()?;\n+            modified_file_paths.insert(child_path);\n+        } else {\n+            std::fs::create_dir(&child_path)?;\n+            create_directory_tree(modified_file_paths, &child_path, depth - 1, width)?;\n+        }\n+    }\n+    Ok(())\n+}\n+\n+fn pick_random_file(depth: usize, width: usize) -> PathBuf {\n+    let mut rng = rand::rng();\n+    iter::repeat_with(|| rng.random_range(0..width).to_string())\n+        .take(depth)\n+        .collect()\n+}\n+\n+struct RandomDirectory {\n+    depth: usize,\n+    path: PathBuf,\n+}\n+\n+fn pick_random_directory(max_depth: usize, width: usize) -> RandomDirectory {\n+    let mut rng = rand::rng();\n+    // never use a depth of 0 because that would be the root directory\n+    let depth = rng.random_range(1..(max_depth - 1));\n+    let path = iter::repeat_with(|| rng.random_range(0..width).to_string())\n+        .take(depth)\n+        .collect();\n+    RandomDirectory { depth, path }\n+}\n+\n+struct FsCleanup<'a> {\n+    path: &'a Path,\n+}\n+\n+impl Drop for FsCleanup<'_> {\n+    fn drop(&mut self) {\n+        std::fs::remove_dir_all(self.path).unwrap();\n+    }\n+}\n+\n+fn register() {\n+    turbo_tasks::register();\n+    turbo_tasks_fs::register();\n+    include!(concat!(env!(\"OUT_DIR\"), \"/register.rs\"));\n+}"
        },
        {
            "sha": "b119a9d2d18504935bca783a45551b02630bcf82",
            "filename": "turbopack/crates/turbo-tasks-memory/src/aggregation/loom_tests.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Faggregation%2Floom_tests.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Faggregation%2Floom_tests.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Faggregation%2Floom_tests.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -250,17 +250,17 @@ fn fuzzy_loom(#[case] seed: u32, #[case] count: u32) {\n \n                 // setup graph\n                 for _ in 0..20 {\n-                    let parent = r.gen_range(0..nodes.len() - 1);\n-                    let child = r.gen_range(parent + 1..nodes.len());\n+                    let parent = r.random_range(0..nodes.len() - 1);\n+                    let child = r.random_range(parent + 1..nodes.len());\n                     let parent_node = nodes[parent].clone();\n                     let child_node = nodes[child].clone();\n                     parent_node.add_child(&ctx, child_node);\n                 }\n \n                 let mut edges = Vec::new();\n                 for _ in 0..2 {\n-                    let parent = r.gen_range(0..nodes.len() - 1);\n-                    let child = r.gen_range(parent + 1..nodes.len());\n+                    let parent = r.random_range(0..nodes.len() - 1);\n+                    let child = r.random_range(parent + 1..nodes.len());\n                     let parent_node = nodes[parent].clone();\n                     let child_node = nodes[child].clone();\n                     edges.push((parent_node, child_node));"
        },
        {
            "sha": "a8b24646c89d871b44ea02e68fab2edd436146b4",
            "filename": "turbopack/crates/turbo-tasks-memory/src/aggregation/tests.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Faggregation%2Ftests.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Faggregation%2Ftests.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-memory%2Fsrc%2Faggregation%2Ftests.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -1035,14 +1035,14 @@ fn fuzzy(#[case] seed: u32, #[case] count: u32) {\n     let mut edges = FxIndexSet::default();\n \n     for _ in 0..1000 {\n-        match r.gen_range(0..=2) {\n+        match r.random_range(0..=2) {\n             0 | 1 => {\n                 // if x == 47 {\n                 //     print_all(&ctx, nodes.iter().cloned().map(NodeRef), true);\n                 // }\n                 // add edge\n-                let parent = r.gen_range(0..nodes.len() - 1);\n-                let child = r.gen_range(parent + 1..nodes.len());\n+                let parent = r.random_range(0..nodes.len() - 1);\n+                let child = r.random_range(parent + 1..nodes.len());\n                 // println!(\"add edge {} -> {}\", parent, child);\n                 if edges.insert((parent, child)) {\n                     nodes[parent].add_child(&ctx, nodes[child].clone());\n@@ -1053,7 +1053,7 @@ fn fuzzy(#[case] seed: u32, #[case] count: u32) {\n                 if edges.is_empty() {\n                     continue;\n                 }\n-                let i = r.gen_range(0..edges.len());\n+                let i = r.random_range(0..edges.len());\n                 let (parent, child) = edges.swap_remove_index(i).unwrap();\n                 // println!(\"remove edge {} -> {}\", parent, child);\n                 nodes[parent].remove_child(&ctx, &nodes[child]);"
        },
        {
            "sha": "086e64751281fab894a8232722c95b60bb4d46ed",
            "filename": "turbopack/crates/turbopack-bench/src/util/module_picker.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbopack-bench%2Fsrc%2Futil%2Fmodule_picker.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/581975d7cfa5c9aa8a008df3306d8779a175bfc7/turbopack%2Fcrates%2Fturbopack-bench%2Fsrc%2Futil%2Fmodule_picker.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-bench%2Fsrc%2Futil%2Fmodule_picker.rs?ref=581975d7cfa5c9aa8a008df3306d8779a175bfc7",
            "patch": "@@ -1,6 +1,6 @@\n use std::path::PathBuf;\n \n-use rand::{rngs::StdRng, seq::SliceRandom, SeedableRng};\n+use rand::{rngs::StdRng, seq::IndexedRandom, SeedableRng};\n use rustc_hash::FxHashMap;\n \n /// Picks modules at random, but with a fixed seed so runs are somewhat"
        }
    ],
    "stats": {
        "total": 499,
        "additions": 444,
        "deletions": 55
    }
}