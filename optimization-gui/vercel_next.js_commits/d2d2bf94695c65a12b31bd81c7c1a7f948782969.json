{
    "author": "wyattjoh",
    "message": "fix: mark file system incremental cache as external so it's memory is shared (#80586)\n\nThis moves the in-memory LRU cache on the file system cache handler as\nexternal so that it's shared between different instances of the file\nsystem cache module.",
    "sha": "d2d2bf94695c65a12b31bd81c7c1a7f948782969",
    "files": [
        {
            "sha": "51bd58dabbf4cb95b9c9bb5d9fbc315f62390c31",
            "filename": "packages/next/src/server/lib/incremental-cache/file-system-cache.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 40,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/d2d2bf94695c65a12b31bd81c7c1a7f948782969/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d2d2bf94695c65a12b31bd81c7c1a7f948782969/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ffile-system-cache.ts?ref=d2d2bf94695c65a12b31bd81c7c1a7f948782969",
            "patch": "@@ -1,5 +1,5 @@\n import type { RouteMetadata } from '../../../export/routes/types'\n-import type { CacheHandler, CacheHandlerContext, CacheHandlerValue } from './'\n+import type { CacheHandler, CacheHandlerContext, CacheHandlerValue } from '.'\n import type { CacheFs } from '../../../shared/lib/utils'\n import {\n   CachedRouteKind,\n@@ -10,7 +10,7 @@ import {\n   type SetIncrementalResponseCacheContext,\n } from '../../response-cache'\n \n-import { LRUCache } from '../lru-cache'\n+import type { LRUCache } from '../lru-cache'\n import path from '../../../shared/lib/isomorphic/path'\n import {\n   NEXT_CACHE_TAGS_HEADER,\n@@ -23,6 +23,7 @@ import {\n } from '../../../lib/constants'\n import { isStale, tagsManifest } from './tags-manifest.external'\n import { MultiFileWriter } from '../../../lib/multi-file-writer'\n+import { getMemoryCache } from './memory-cache.external'\n \n type FileSystemCacheContext = Omit<\n   CacheHandlerContext,\n@@ -32,54 +33,31 @@ type FileSystemCacheContext = Omit<\n   serverDistDir: string\n }\n \n-let memoryCache: LRUCache<CacheHandlerValue> | undefined\n-\n export default class FileSystemCache implements CacheHandler {\n   private fs: FileSystemCacheContext['fs']\n   private flushToDisk?: FileSystemCacheContext['flushToDisk']\n   private serverDistDir: FileSystemCacheContext['serverDistDir']\n   private revalidatedTags: string[]\n-  private debug: boolean\n+  private static debug: boolean = !!process.env.NEXT_PRIVATE_DEBUG_CACHE\n+  private static memoryCache: LRUCache<CacheHandlerValue> | undefined\n \n   constructor(ctx: FileSystemCacheContext) {\n     this.fs = ctx.fs\n     this.flushToDisk = ctx.flushToDisk\n     this.serverDistDir = ctx.serverDistDir\n     this.revalidatedTags = ctx.revalidatedTags\n-    this.debug = !!process.env.NEXT_PRIVATE_DEBUG_CACHE\n \n     if (ctx.maxMemoryCacheSize) {\n-      if (!memoryCache) {\n-        if (this.debug) {\n+      if (!FileSystemCache.memoryCache) {\n+        if (FileSystemCache.debug) {\n           console.log('using memory store for fetch cache')\n         }\n \n-        memoryCache = new LRUCache(ctx.maxMemoryCacheSize, function length({\n-          value,\n-        }) {\n-          if (!value) {\n-            return 25\n-          } else if (value.kind === CachedRouteKind.REDIRECT) {\n-            return JSON.stringify(value.props).length\n-          } else if (value.kind === CachedRouteKind.IMAGE) {\n-            throw new Error('invariant image should not be incremental-cache')\n-          } else if (value.kind === CachedRouteKind.FETCH) {\n-            return JSON.stringify(value.data || '').length\n-          } else if (value.kind === CachedRouteKind.APP_ROUTE) {\n-            return value.body.length\n-          }\n-          // rough estimate of size of cache value\n-          return (\n-            value.html.length +\n-            (JSON.stringify(\n-              value.kind === CachedRouteKind.APP_PAGE\n-                ? value.rscData\n-                : value.pageData\n-            )?.length || 0)\n-          )\n-        })\n+        FileSystemCache.memoryCache = getMemoryCache(ctx.maxMemoryCacheSize)\n+      } else if (FileSystemCache.debug) {\n+        console.log('memory store already initialized')\n       }\n-    } else if (this.debug) {\n+    } else if (FileSystemCache.debug) {\n       console.log('not using memory store for fetch cache')\n     }\n   }\n@@ -92,7 +70,7 @@ export default class FileSystemCache implements CacheHandler {\n     let [tags] = args\n     tags = typeof tags === 'string' ? [tags] : tags\n \n-    if (this.debug) {\n+    if (FileSystemCache.debug) {\n       console.log('revalidateTag', tags)\n     }\n \n@@ -111,9 +89,9 @@ export default class FileSystemCache implements CacheHandler {\n     const [key, ctx] = args\n     const { kind } = ctx\n \n-    let data = memoryCache?.get(key)\n+    let data = FileSystemCache.memoryCache?.get(key)\n \n-    if (this.debug) {\n+    if (FileSystemCache.debug) {\n       if (kind === IncrementalCacheKind.FETCH) {\n         console.log('get', key, ctx.tags, kind, !!data)\n       } else {\n@@ -182,7 +160,7 @@ export default class FileSystemCache implements CacheHandler {\n             // TODO: remove this when we can send the tags\n             // via header on GET same as SET\n             if (!tags?.every((tag) => storedTags?.includes(tag))) {\n-              if (this.debug) {\n+              if (FileSystemCache.debug) {\n                 console.log('tags vs storedTags mismatch', tags, storedTags)\n               }\n               await this.set(key, data.value, {\n@@ -291,7 +269,7 @@ export default class FileSystemCache implements CacheHandler {\n         }\n \n         if (data) {\n-          memoryCache?.set(key, data)\n+          FileSystemCache.memoryCache?.set(key, data)\n         }\n       } catch {\n         return null\n@@ -345,12 +323,12 @@ export default class FileSystemCache implements CacheHandler {\n     data: IncrementalCacheValue | null,\n     ctx: SetIncrementalFetchCacheContext | SetIncrementalResponseCacheContext\n   ) {\n-    memoryCache?.set(key, {\n+    FileSystemCache.memoryCache?.set(key, {\n       value: data,\n       lastModified: Date.now(),\n     })\n \n-    if (this.debug) {\n+    if (FileSystemCache.debug) {\n       console.log('set', key)\n     }\n "
        },
        {
            "sha": "33ce99e47ed4b7786b75a3f121c7e926d78c1858",
            "filename": "packages/next/src/server/lib/incremental-cache/memory-cache.external.ts",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/d2d2bf94695c65a12b31bd81c7c1a7f948782969/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fmemory-cache.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d2d2bf94695c65a12b31bd81c7c1a7f948782969/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fmemory-cache.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Fmemory-cache.external.ts?ref=d2d2bf94695c65a12b31bd81c7c1a7f948782969",
            "patch": "@@ -0,0 +1,34 @@\n+import type { CacheHandlerValue } from '.'\n+import { CachedRouteKind } from '../../response-cache/types'\n+import { LRUCache } from '../lru-cache'\n+\n+let memoryCache: LRUCache<CacheHandlerValue> | undefined\n+\n+export function getMemoryCache(maxMemoryCacheSize: number) {\n+  if (!memoryCache) {\n+    memoryCache = new LRUCache(maxMemoryCacheSize, function length({ value }) {\n+      if (!value) {\n+        return 25\n+      } else if (value.kind === CachedRouteKind.REDIRECT) {\n+        return JSON.stringify(value.props).length\n+      } else if (value.kind === CachedRouteKind.IMAGE) {\n+        throw new Error('invariant image should not be incremental-cache')\n+      } else if (value.kind === CachedRouteKind.FETCH) {\n+        return JSON.stringify(value.data || '').length\n+      } else if (value.kind === CachedRouteKind.APP_ROUTE) {\n+        return value.body.length\n+      }\n+      // rough estimate of size of cache value\n+      return (\n+        value.html.length +\n+        (JSON.stringify(\n+          value.kind === CachedRouteKind.APP_PAGE\n+            ? value.rscData\n+            : value.pageData\n+        )?.length || 0)\n+      )\n+    })\n+  }\n+\n+  return memoryCache\n+}"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 52,
        "deletions": 40
    }
}