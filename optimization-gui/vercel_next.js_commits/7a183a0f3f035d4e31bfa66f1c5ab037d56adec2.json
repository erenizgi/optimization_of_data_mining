{
    "author": "acdlite",
    "message": "Fix: Unresolved param in x-nextjs-rewritten-query (#81991)\n\nFixes an issue with the x-nextjs-rewritten-query header where it\nresponded without the dynamic parts of the URL filled in.\n\nFor example, when rewriting to `/hello?id=123` to `/hello/123`:\n- Before: `x-nextjs-rewritten-query: id=__ESC_COLON_id`\n- After: `x-nextjs-rewritten-query: id=123`",
    "sha": "7a183a0f3f035d4e31bfa66f1c5ab037d56adec2",
    "files": [
        {
            "sha": "7b3f5c05ced75bba97c394fd93133a56ecde1a13",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 15,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/7a183a0f3f035d4e31bfa66f1c5ab037d56adec2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7a183a0f3f035d4e31bfa66f1c5ab037d56adec2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=7a183a0f3f035d4e31bfa66f1c5ab037d56adec2",
            "patch": "@@ -33,7 +33,6 @@ import { addRequestMeta } from '../../request-meta'\n import {\n   compileNonPath,\n   matchHas,\n-  parseDestination,\n   prepareDestination,\n } from '../../../shared/lib/router/utils/prepare-destination'\n import type { TLSSocket } from 'tls'\n@@ -761,16 +760,6 @@ export function getResolveRoutes(\n             // so we'll just use the params from the route matcher\n           }\n \n-          // We extract the search params of the destination so we can set it on\n-          // the response headers. We don't want to use the following\n-          // `parsedDestination` as the query object is mutated.\n-          const { search: destinationSearch, pathname: destinationPathname } =\n-            parseDestination({\n-              destination: route.destination,\n-              params: rewriteParams,\n-              query: parsedUrl.query,\n-            })\n-\n           const { parsedDestination } = prepareDestination({\n             appendParamsToQuery: true,\n             destination: route.destination,\n@@ -790,14 +779,17 @@ export function getResolveRoutes(\n           if (req.headers[RSC_HEADER.toLowerCase()] === '1') {\n             // We set the rewritten path and query headers on the response now\n             // that we know that the it's not an external rewrite.\n-            if (parsedUrl.pathname !== destinationPathname) {\n-              res.setHeader(NEXT_REWRITTEN_PATH_HEADER, destinationPathname)\n+            if (parsedUrl.pathname !== parsedDestination.pathname) {\n+              res.setHeader(\n+                NEXT_REWRITTEN_PATH_HEADER,\n+                parsedDestination.pathname\n+              )\n             }\n-            if (destinationSearch) {\n+            if (parsedUrl.search !== parsedDestination.search) {\n               res.setHeader(\n                 NEXT_REWRITTEN_QUERY_HEADER,\n                 // remove the leading ? from the search\n-                destinationSearch.slice(1)\n+                parsedDestination.search.slice(1)\n               )\n             }\n           }"
        },
        {
            "sha": "9cc4320a291a04a9c03061fdc9e88f774cef00d0",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/7a183a0f3f035d4e31bfa66f1c5ab037d56adec2/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7a183a0f3f035d4e31bfa66f1c5ab037d56adec2/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts?ref=7a183a0f3f035d4e31bfa66f1c5ab037d56adec2",
            "patch": "@@ -193,12 +193,18 @@ export function parseDestination(args: {\n     hash = unescapeSegments(hash)\n   }\n \n+  let search = parsed.search\n+  if (search) {\n+    search = unescapeSegments(search)\n+  }\n+\n   return {\n     ...parsed,\n     pathname,\n     hostname,\n     href,\n     hash,\n+    search,\n   }\n }\n \n@@ -210,7 +216,11 @@ export function prepareDestination(args: {\n }) {\n   const parsedDestination = parseDestination(args)\n \n-  const { hostname: destHostname, query: destQuery } = parsedDestination\n+  const {\n+    hostname: destHostname,\n+    query: destQuery,\n+    search: destSearch,\n+  } = parsedDestination\n \n   // The following code assumes that the pathname here includes the hash if it's\n   // present.\n@@ -311,7 +321,9 @@ export function prepareDestination(args: {\n     }\n     parsedDestination.pathname = pathname\n     parsedDestination.hash = `${hash ? '#' : ''}${hash || ''}`\n-    delete (parsedDestination as any).search\n+    parsedDestination.search = destSearch\n+      ? compileNonPath(destSearch, args.params)\n+      : ''\n   } catch (err: any) {\n     if (err.message.match(/Expected .*? to not repeat, but got an array/)) {\n       throw new Error("
        },
        {
            "sha": "26712a03853189e40a74c24a450855e97b0e3d36",
            "filename": "test/e2e/app-dir/rewrite-headers/next.config.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7a183a0f3f035d4e31bfa66f1c5ab037d56adec2/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7a183a0f3f035d4e31bfa66f1c5ab037d56adec2/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Fnext.config.js?ref=7a183a0f3f035d4e31bfa66f1c5ab037d56adec2",
            "patch": "@@ -18,6 +18,10 @@ module.exports = {\n         source: '/hello/(.*)/google',\n         destination: 'https://www.google.$1/',\n       },\n+      {\n+        source: '/rewrites-to-query/:name',\n+        destination: '/other?key=:name',\n+      },\n     ]\n   },\n }"
        },
        {
            "sha": "9f4247ab1e870c4c72793c91811b08ce3eb5cfe1",
            "filename": "test/e2e/app-dir/rewrite-headers/rewrite-headers.test.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/7a183a0f3f035d4e31bfa66f1c5ab037d56adec2/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7a183a0f3f035d4e31bfa66f1c5ab037d56adec2/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrite-headers%2Frewrite-headers.test.ts?ref=7a183a0f3f035d4e31bfa66f1c5ab037d56adec2",
            "patch": "@@ -368,6 +368,37 @@ const cases: {\n       'x-nextjs-rewritten-query': 'key=value',\n     },\n   },\n+  {\n+    name: 'next.config.js rewrites with path-matched query HTML',\n+    pathname: '/rewrites-to-query/andrew',\n+    expected: {\n+      'x-nextjs-rewritten-path': null,\n+      'x-nextjs-rewritten-query': null,\n+    },\n+  },\n+  {\n+    name: 'next.config.js rewrites with path-matched query RSC',\n+    pathname: '/rewrites-to-query/andrew',\n+    headers: {\n+      RSC: '1',\n+    },\n+    expected: {\n+      'x-nextjs-rewritten-path': '/other',\n+      'x-nextjs-rewritten-query': 'key=andrew',\n+    },\n+  },\n+  {\n+    name: 'next.config.js rewrites with path-matched query Prefetch RSC',\n+    pathname: '/rewrites-to-query/andrew',\n+    headers: {\n+      RSC: '1',\n+      'Next-Router-Prefetch': '1',\n+    },\n+    expected: {\n+      'x-nextjs-rewritten-path': '/other',\n+      'x-nextjs-rewritten-query': 'key=andrew',\n+    },\n+  },\n ]\n \n describe('rewrite-headers', () => {"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 56,
        "deletions": 17
    }
}