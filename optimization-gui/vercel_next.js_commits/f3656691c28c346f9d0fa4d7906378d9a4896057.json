{
    "author": "unstubbable",
    "message": "[test] Use `--debug-build-paths` instead of `NEXT_PRIVATE_APP_PATHS` (#85504)\n\nWith `--debug-build-paths` being added in #85052, we can now use this\nCLI flag in tests, instead of setting the private environment variable\n`NEXT_PRIVATE_APP_PATHS`.\n\nRelated to this change, this PR fixes how we print the dev, start and\nbuild commands during tests, by properly escaping the CLI arguments.\nThis ensures that the command is copy-pasteable even when the args\ncontain escaped characters.",
    "sha": "f3656691c28c346f9d0fa4d7906378d9a4896057",
    "files": [
        {
            "sha": "9dbb4746b62ecce44883a09d54656d657788b6b8",
            "filename": "package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f3656691c28c346f9d0fa4d7906378d9a4896057/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/f3656691c28c346f9d0fa4d7906378d9a4896057/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=f3656691c28c346f9d0fa4d7906378d9a4896057",
            "patch": "@@ -165,6 +165,7 @@\n     \"@types/react\": \"19.2.2\",\n     \"@types/react-dom\": \"19.2.1\",\n     \"@types/relay-runtime\": \"14.1.13\",\n+    \"@types/shell-quote\": \"1.7.1\",\n     \"@types/string-hash\": \"1.1.1\",\n     \"@types/trusted-types\": \"2.0.3\",\n     \"@vercel/devlow-bench\": \"workspace:*\","
        },
        {
            "sha": "d8ac691354a8311ad971df0aa3162f1a274d0fad",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f3656691c28c346f9d0fa4d7906378d9a4896057/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/f3656691c28c346f9d0fa4d7906378d9a4896057/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=f3656691c28c346f9d0fa4d7906378d9a4896057",
            "patch": "@@ -204,6 +204,9 @@ importers:\n       '@types/relay-runtime':\n         specifier: 14.1.13\n         version: 14.1.13\n+      '@types/shell-quote':\n+        specifier: 1.7.1\n+        version: 1.7.1\n       '@types/string-hash':\n         specifier: 1.1.1\n         version: 1.1.1"
        },
        {
            "sha": "debd4e8c8c3f980ab9351f45de14b31d5327208f",
            "filename": "test/e2e/app-dir/cache-components-console/cache-components.console.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 15,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Fcache-components.console.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Fcache-components.console.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Fcache-components.console.test.ts?ref=f3656691c28c346f9d0fa4d7906378d9a4896057",
            "patch": "@@ -119,9 +119,7 @@ describe.skip('cache-components - Console Dimming - Validation', () => {\n     } else {\n       try {\n         await next.build({\n-          env: {\n-            NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n-          },\n+          args: ['--debug-build-paths', `app${path}/page.tsx`],\n         })\n       } catch (err) {\n         const error = new Error(\n@@ -309,9 +307,7 @@ describe.skip('cache-components - Logging after Abort', () => {\n       } else {\n         try {\n           await next.build({\n-            env: {\n-              NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n-            },\n+            args: ['--debug-build-paths', `app${path}/page.tsx`],\n           })\n         } catch (err) {\n           const error = new Error(\n@@ -480,9 +476,7 @@ describe.skip('cache-components - Logging after Abort', () => {\n       } else {\n         try {\n           await next.build({\n-            env: {\n-              NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n-            },\n+            args: ['--debug-build-paths', `app${path}/page.tsx`],\n           })\n         } catch (err) {\n           const error = new Error(\n@@ -632,9 +626,7 @@ describe.skip('cache-components - Logging after Abort', () => {\n       } else {\n         try {\n           await next.build({\n-            env: {\n-              NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n-            },\n+            args: ['--debug-build-paths', `app${path}/page.tsx`],\n           })\n         } catch (err) {\n           const error = new Error(\n@@ -728,9 +720,7 @@ describe.skip('cache-components - Logging after Abort', () => {\n       } else {\n         try {\n           await next.build({\n-            env: {\n-              NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n-            },\n+            args: ['--debug-build-paths', `app${path}/page.tsx`],\n           })\n         } catch (err) {\n           const error = new Error("
        },
        {
            "sha": "c6d27d4c43537846c0b113647d06f13a5837aff2",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=f3656691c28c346f9d0fa4d7906378d9a4896057",
            "patch": "@@ -64,18 +64,19 @@ describe('Cache Components Errors', () => {\n     })\n \n     const prerender = async (pathname: string) => {\n-      const args = ['--experimental-build-mode', 'generate']\n+      const args = [\n+        '--experimental-build-mode',\n+        'generate',\n+        '--debug-build-paths',\n+        // Escape square brackets for pathnames with dynamic segments.\n+        `app${pathname.replace(/([[\\]])/g, '\\\\$1')}/page.tsx`,\n+      ]\n \n       if (isDebugPrerender) {\n         args.push('--debug-prerender')\n       }\n \n-      await next.build({\n-        env: {\n-          NEXT_PRIVATE_APP_PATHS: JSON.stringify([`${pathname}/page.tsx`]),\n-        },\n-        args,\n-      })\n+      await next.build({ args })\n     }\n \n     describe('Dynamic Metadata - Static Route', () => {"
        },
        {
            "sha": "6cdacff9a923b2f39660c55a0bb2e2a8c5767319",
            "filename": "test/e2e/app-dir/use-cache-search-params/use-cache-search-params.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fuse-cache-search-params.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fuse-cache-search-params.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fuse-cache-search-params.test.ts?ref=f3656691c28c346f9d0fa4d7906378d9a4896057",
            "patch": "@@ -203,11 +203,7 @@ describe('use-cache-search-params', () => {\n \n     it('should resume a cached page that does not access search params without hydration errors', async () => {\n       await next.build({\n-        env: {\n-          NEXT_PRIVATE_APP_PATHS: JSON.stringify([\n-            '/search-params-unused/page.tsx',\n-          ]),\n-        },\n+        args: ['--debug-build-paths', 'app/search-params-unused/page.tsx'],\n       })\n \n       await next.start({ skipBuild: true })"
        },
        {
            "sha": "efe2f91debdec6c2b164142f583e344c3b721124",
            "filename": "test/lib/next-modes/next-dev.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-dev.ts?ref=f3656691c28c346f9d0fa4d7906378d9a4896057",
            "patch": "@@ -3,6 +3,7 @@ import { Span } from 'next/dist/trace'\n import { NextInstance } from './base'\n import { retry, waitFor } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n+import { quote as shellQuote } from 'shell-quote'\n \n export class NextDevInstance extends NextInstance {\n   private _cliOutput: string = ''\n@@ -50,7 +51,7 @@ export class NextDevInstance extends NextInstance {\n       }\n     }\n \n-    console.log('running', startArgs.join(' '))\n+    console.log('running', shellQuote(startArgs))\n     await new Promise<void>((resolve, reject) => {\n       try {\n         this.childProcess = spawn(startArgs[0], startArgs.slice(1), {\n@@ -130,7 +131,7 @@ export class NextDevInstance extends NextInstance {\n         }\n         this.on('stdout', readyCb)\n       } catch (err) {\n-        require('console').error(`Failed to run ${startArgs.join(' ')}`, err)\n+        require('console').error(`Failed to run ${shellQuote(startArgs)}`, err)\n         setTimeout(() => process.exit(1), 0)\n       }\n     })"
        },
        {
            "sha": "23487720d3b68f7e95b9580c3b1c041068e3c9b9",
            "filename": "test/lib/next-modes/next-start.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f3656691c28c346f9d0fa4d7906378d9a4896057/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-start.ts?ref=f3656691c28c346f9d0fa4d7906378d9a4896057",
            "patch": "@@ -4,6 +4,7 @@ import { NextInstance } from './base'\n import spawn from 'cross-spawn'\n import { Span } from 'next/dist/trace'\n import stripAnsi from 'strip-ansi'\n+import { quote as shellQuote } from 'shell-quote'\n \n export class NextStartInstance extends NextInstance {\n   private _buildId: string\n@@ -64,7 +65,7 @@ export class NextStartInstance extends NextInstance {\n \n     if (!options.skipBuild) {\n       const buildArgs = this.getBuildArgs()\n-      console.log('running', buildArgs.join(' '))\n+      console.log('running', shellQuote(buildArgs))\n       await new Promise<void>((resolve, reject) => {\n         try {\n           this.childProcess = spawn(buildArgs[0], buildArgs.slice(1), spawnOpts)\n@@ -80,7 +81,10 @@ export class NextStartInstance extends NextInstance {\n             else resolve()\n           })\n         } catch (err) {\n-          require('console').error(`Failed to run ${buildArgs.join(' ')}`, err)\n+          require('console').error(\n+            `Failed to run ${shellQuote(buildArgs)}`,\n+            err\n+          )\n           setTimeout(() => process.exit(1), 0)\n         }\n       })\n@@ -99,7 +103,7 @@ export class NextStartInstance extends NextInstance {\n       ).trim()\n     }\n \n-    console.log('running', startArgs.join(' '))\n+    console.log('running', shellQuote(startArgs))\n     await new Promise<void>((resolve, reject) => {\n       try {\n         this.childProcess = spawn(startArgs[0], startArgs.slice(1), spawnOpts)\n@@ -141,7 +145,7 @@ export class NextStartInstance extends NextInstance {\n         }\n         this.on('stdout', readyCb)\n       } catch (err) {\n-        require('console').error(`Failed to run ${startArgs.join(' ')}`, err)\n+        require('console').error(`Failed to run ${shellQuote(startArgs)}`, err)\n         setTimeout(() => process.exit(1), 0)\n       }\n     })\n@@ -207,7 +211,7 @@ export class NextStartInstance extends NextInstance {\n       const spawnOpts = this.getSpawnOpts(options.env)\n       const buildArgs = this.getBuildArgs(options.args)\n \n-      console.log('running', buildArgs.join(' '))\n+      console.log('running', shellQuote(buildArgs))\n \n       this.childProcess = spawn(buildArgs[0], buildArgs.slice(1), spawnOpts)\n       this.handleStdio(this.childProcess)"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 30,
        "deletions": 34
    }
}