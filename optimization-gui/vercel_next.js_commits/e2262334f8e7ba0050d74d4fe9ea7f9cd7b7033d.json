{
    "author": "lukesandberg",
    "message": "[turbopack] Implement improved deobfuscation for free calls and module identifiers. (#85060)\n\nImprove deobfuscation of 'imported module identifier' and attempt to deobfuscate error messages logged by the server.\n\nBefore\n```\n â¨¯ TypeError: (0 , __TURBOPACK__imported__module__$5b$project$5d2f$examples$2f$with$2d$turbopack$2f$app$2f$foo$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__.foo) is not a function\n    at Page (app/page.tsx:5:6)\n  3 | export default function Page() {\n  4 |   /** @ts-ignore */\n> 5 |   foo();\n    |      ^\n  6 |   return <h1>Hello, Next.js!</h1>;\n  7 | }\n  8 | {\n```\nafter \n```\n â¨¯ TypeError: {imported module ./examples/with-turbopack/app/foo.ts}.foo is not a function\n    at Page (app/page.tsx:5:6)\n  3 | export default function Page() {\n  4 |   /** @ts-ignore */\n> 5 |   foo();\n    |      ^\n  6 |   return <h1>Hello, Next.js!</h1>;\n  7 | }\n  8 | {\n```\n\nSimilarly in devtools\nbefore:\n\n![image.png](https://app.graphite.dev/user-attachments/assets/fd50d94a-d34a-4026-862e-0ca8ee6658ba.png)\n\nafter\n\n![image.png](https://app.graphite.dev/user-attachments/assets/d9080ed7-29c8-428a-831a-9bbcd818cc3e.png)\n\n\nThis is definitely an improvement but i am not sure i put the deobfuscation logic in the best place for the console case.  Happy for feedback",
    "sha": "e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
    "files": [
        {
            "sha": "0266f849cde2bed2c8fd5a27289a7ebaa22edf84",
            "filename": "examples/basic-css/tsconfig.json",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/examples%2Fbasic-css%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/examples%2Fbasic-css%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fbasic-css%2Ftsconfig.json?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -21,6 +21,12 @@\n     \"strictNullChecks\": true,\n     \"target\": \"ES2017\"\n   },\n-  \"include\": [\"next-env.d.ts\", \".next/types/**/*.ts\", \"**/*.ts\", \"**/*.tsx\"],\n+  \"include\": [\n+    \"next-env.d.ts\",\n+    \".next/types/**/*.ts\",\n+    \"**/*.ts\",\n+    \"**/*.tsx\",\n+    \".next/dev/types/**/*.ts\"\n+  ],\n   \"exclude\": [\"node_modules\", \"**/*.test.ts\", \"**/*.test.tsx\"]\n }"
        },
        {
            "sha": "fbd3503469342cc52911d355efa2756807941c5b",
            "filename": "examples/with-turbopack/app/page.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/examples%2Fwith-turbopack%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/examples%2Fwith-turbopack%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-turbopack%2Fapp%2Fpage.tsx?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -1,3 +1,6 @@\n+import { foo } from \"./foo\";\n export default function Page() {\n+  /** @ts-ignore */\n+  foo();\n   return <h1>Hello, Next.js!</h1>;\n }"
        },
        {
            "sha": "dd0a84391b483f997a86d4d55350b9a64495b5a8",
            "filename": "examples/with-turbopack/tsconfig.json",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/examples%2Fwith-turbopack%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/examples%2Fwith-turbopack%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-turbopack%2Ftsconfig.json?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -20,6 +20,12 @@\n       }\n     ]\n   },\n-  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n+  \"include\": [\n+    \"next-env.d.ts\",\n+    \"**/*.ts\",\n+    \"**/*.tsx\",\n+    \".next/types/**/*.ts\",\n+    \".next/dev/types/**/*.ts\"\n+  ],\n   \"exclude\": [\"node_modules\"]\n }"
        },
        {
            "sha": "2f21f6fdfb63aab0c8637abeb998a6a235596bba",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/hot-linked-text/index.tsx",
            "status": "modified",
            "additions": 40,
            "deletions": 40,
            "changes": 80,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fhot-linked-text%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fhot-linked-text%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fhot-linked-text%2Findex.tsx?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -1,59 +1,59 @@\n import React from 'react'\n-import {\n-  decodeMagicIdentifier,\n-  MAGIC_IDENTIFIER_REGEX,\n-} from '../../../../shared/lib/magic-identifier'\n+import { deobfuscateTextParts } from '../../../../shared/lib/magic-identifier'\n \n const linkRegex = /https?:\\/\\/[^\\s/$.?#].[^\\s)'\"]*/i\n \n-const splitRegexp = new RegExp(`(${MAGIC_IDENTIFIER_REGEX.source}|\\\\s+)`)\n-\n export const HotlinkedText: React.FC<{\n   text: string\n   matcher?: (text: string) => boolean\n }> = function HotlinkedText(props) {\n   const { text, matcher } = props\n \n-  const wordsAndWhitespaces = text.split(splitRegexp)\n+  // Deobfuscate the entire text first\n+  const deobfuscatedParts = deobfuscateTextParts(text)\n \n   return (\n     <>\n-      {wordsAndWhitespaces.map((word, index) => {\n-        if (linkRegex.test(word)) {\n-          const link = linkRegex.exec(word)!\n-          const href = link[0]\n-          // If link matcher is present but the link doesn't match, don't turn it into a link\n-          if (typeof matcher === 'function' && !matcher(href)) {\n-            return word\n-          }\n-          return (\n-            <React.Fragment key={`link-${index}`}>\n-              <a href={href} target=\"_blank\" rel=\"noreferrer noopener\">\n-                {word}\n-              </a>\n-            </React.Fragment>\n-          )\n-        }\n-        try {\n-          const decodedWord = decodeMagicIdentifier(word)\n-          if (decodedWord !== word) {\n-            return (\n-              <i key={`ident-${index}`}>\n-                {'{'}\n-                {decodedWord}\n-                {'}'}\n-              </i>\n-            )\n-          }\n-        } catch (e) {\n+      {deobfuscatedParts.map(([type, part], outerIndex) => {\n+        if (type === 'raw') {\n           return (\n-            <i key={`ident-${index}`}>\n-              {'{'}\n-              {word} (decoding failed: {'' + e}){'}'}\n-            </i>\n+            part\n+              // Split on whitespace and links\n+              .split(/(\\s+|https?:\\/\\/[^\\s/$.?#].[^\\s)'\"]*)/)\n+              .map((rawPart, index) => {\n+                if (linkRegex.test(rawPart)) {\n+                  const link = linkRegex.exec(rawPart)!\n+                  const href = link[0]\n+                  // If link matcher is present but the link doesn't match, don't turn it into a link\n+                  if (typeof matcher === 'function' && !matcher(href)) {\n+                    return (\n+                      <React.Fragment key={`link-${outerIndex}-${index}`}>\n+                        {rawPart}\n+                      </React.Fragment>\n+                    )\n+                  }\n+                  return (\n+                    <React.Fragment key={`link-${outerIndex}-${index}`}>\n+                      <a href={href} target=\"_blank\" rel=\"noreferrer noopener\">\n+                        {rawPart}\n+                      </a>\n+                    </React.Fragment>\n+                  )\n+                } else {\n+                  return (\n+                    <React.Fragment key={`text-${outerIndex}-${index}`}>\n+                      {rawPart}\n+                    </React.Fragment>\n+                  )\n+                }\n+              })\n           )\n+        } else if (type === 'deobfuscated') {\n+          // italicize the deobfuscated part\n+          return <i key={`ident-${outerIndex}`}>{part}</i>\n+        } else {\n+          throw new Error(`Unknown text part type: ${type}`)\n         }\n-        return <React.Fragment key={`text-${index}`}>{word}</React.Fragment>\n       })}\n     </>\n   )"
        },
        {
            "sha": "986aa81f177d6f9e684fd1668830fcbb8ffc2f5e",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -88,6 +88,7 @@ import {\n import { isParallelRouteSegment } from '../../../shared/lib/segment'\n import { ensureLeadingSlash } from '../../../shared/lib/page-path/ensure-leading-slash'\n import { Lockfile } from '../../../build/lockfile'\n+import { deobfuscateText } from '../../../shared/lib/magic-identifier'\n \n export type SetupOpts = {\n   renderServer: LazyRenderServerInstance\n@@ -1224,6 +1225,9 @@ async function startWatcher(\n     err: unknown,\n     type?: 'unhandledRejection' | 'uncaughtException' | 'warning' | 'app-dir'\n   ) {\n+    if (err instanceof Error) {\n+      err.message = deobfuscateText(err.message)\n+    }\n     if (err instanceof ModuleBuildError) {\n       // Errors that may come from issues from the user's code\n       Log.error(err.message)"
        },
        {
            "sha": "33867e89833e6a0f2e7118b548eedd4ca34721ab",
            "filename": "packages/next/src/shared/lib/magic-identifier.test.ts",
            "status": "added",
            "additions": 178,
            "deletions": 0,
            "changes": 178,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmagic-identifier.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmagic-identifier.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmagic-identifier.test.ts?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -0,0 +1,178 @@\n+import {\n+  decodeMagicIdentifier,\n+  MAGIC_IDENTIFIER_REGEX,\n+  deobfuscateModuleId,\n+  removeFreeCallWrapper,\n+  deobfuscateText,\n+  deobfuscateTextParts,\n+} from './magic-identifier'\n+\n+describe('decodeMagicIdentifier', () => {\n+  // Basic decoding tests (ported from Rust)\n+  test('decodes module evaluation', () => {\n+    expect(decodeMagicIdentifier('__TURBOPACK__module__evaluation__')).toBe(\n+      'module evaluation'\n+    )\n+  })\n+\n+  test('decodes path with slashes', () => {\n+    expect(decodeMagicIdentifier('__TURBOPACK__Hello$2f$World__')).toBe(\n+      'Hello/World'\n+    )\n+  })\n+\n+  test('decodes emoji', () => {\n+    expect(decodeMagicIdentifier('__TURBOPACK__Hello$_1f600$World__')).toBe(\n+      'HelloðŸ˜€World'\n+    )\n+  })\n+\n+  test('returns unchanged if not a magic identifier', () => {\n+    expect(decodeMagicIdentifier('regular_identifier')).toBe(\n+      'regular_identifier'\n+    )\n+  })\n+})\n+\n+describe('MAGIC_IDENTIFIER_REGEX', () => {\n+  test('matches magic identifiers globally', () => {\n+    const text =\n+      'Hello __TURBOPACK__Hello__World__ and __TURBOPACK__foo$2f$bar__'\n+    const matches = text.match(MAGIC_IDENTIFIER_REGEX)\n+    expect(matches).toHaveLength(2)\n+  })\n+})\n+\n+describe('deobfuscateModuleId', () => {\n+  test('replaces [project] with .', () => {\n+    expect(\n+      deobfuscateModuleId('[project]/examples/with-turbopack/app/foo.ts')\n+    ).toBe('./examples/with-turbopack/app/foo.ts')\n+  })\n+\n+  test('removes content in square brackets', () => {\n+    expect(\n+      deobfuscateModuleId('./examples/with-turbopack/app/foo.ts [app-rsc]')\n+    ).toBe('./examples/with-turbopack/app/foo.ts')\n+  })\n+\n+  test('removes content in parentheses', () => {\n+    expect(\n+      deobfuscateModuleId('./examples/with-turbopack/app/foo.ts (ecmascript)')\n+    ).toBe('./examples/with-turbopack/app/foo.ts')\n+  })\n+\n+  test('removes content in angle brackets', () => {\n+    expect(\n+      deobfuscateModuleId('./examples/with-turbopack/app/foo.ts <locals>')\n+    ).toBe('./examples/with-turbopack/app/foo.ts')\n+  })\n+\n+  test('handles combined cleanup', () => {\n+    expect(\n+      deobfuscateModuleId(\n+        '[project]/examples/with-turbopack/app/foo.ts [app-rsc] (ecmascript)'\n+      )\n+    ).toBe('./examples/with-turbopack/app/foo.ts')\n+  })\n+\n+  test('handles parenthesis in path', () => {\n+    expect(\n+      deobfuscateModuleId(\n+        '[project]/examples/(group)/with-turbopack/app/foo.ts [app-rsc] (ecmascript)'\n+      )\n+    ).toBe('./examples/(group)/with-turbopack/app/foo.ts')\n+  })\n+})\n+\n+describe('removeFreeCallWrapper', () => {\n+  test('removes (0, ) wrapper', () => {\n+    expect(removeFreeCallWrapper('(0, __TURBOPACK__foo__.bar)')).toBe(\n+      '__TURBOPACK__foo__.bar'\n+    )\n+  })\n+\n+  test('removes (0 , ) wrapper with spaces', () => {\n+    expect(removeFreeCallWrapper('(0 , __TURBOPACK__foo__.bar)')).toBe(\n+      '__TURBOPACK__foo__.bar'\n+    )\n+  })\n+\n+  test('leaves non-free-call expressions unchanged', () => {\n+    expect(removeFreeCallWrapper('(foo, bar)')).toBe('(foo, bar)')\n+    expect(removeFreeCallWrapper('foo()')).toBe('foo()')\n+  })\n+})\n+\n+describe('deobfuscateText', () => {\n+  test('deobfuscates complete error message with imported module', () => {\n+    const input =\n+      '(0 , __TURBOPACK__imported__module__$5b$project$5d2f$examples$2f$with$2d$turbopack$2f$app$2f$foo$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__.foo) is not a function'\n+    const output = deobfuscateText(input)\n+    expect(output).toBe(\n+      '{imported module ./examples/with-turbopack/app/foo.ts}.foo is not a function'\n+    )\n+  })\n+\n+  test('handles multiple magic identifiers', () => {\n+    const input =\n+      '__TURBOPACK__module__evaluation__ called __TURBOPACK__foo$2f$bar__'\n+    const output = deobfuscateText(input)\n+    expect(output).toBe('{module evaluation} called {foo/bar}')\n+  })\n+\n+  test('leaves regular text unchanged', () => {\n+    const input = 'This is a regular error message'\n+    expect(deobfuscateText(input)).toBe(input)\n+  })\n+})\n+\n+describe('deobfuscateTextParts', () => {\n+  test('returns discriminated parts with raw and deobfuscated text', () => {\n+    const input = 'Error in __TURBOPACK__module__evaluation__ at line 10'\n+    const output = deobfuscateTextParts(input)\n+    expect(output).toEqual([\n+      ['raw', 'Error in '],\n+      ['deobfuscated', '{module evaluation}'],\n+      ['raw', ' at line 10'],\n+    ])\n+  })\n+\n+  test('handles multiple magic identifiers with interleaved raw text', () => {\n+    const input =\n+      '__TURBOPACK__module__evaluation__ called __TURBOPACK__foo$2f$bar__'\n+    const output = deobfuscateTextParts(input)\n+    expect(output).toEqual([\n+      ['deobfuscated', '{module evaluation}'],\n+      ['raw', ' called '],\n+      ['deobfuscated', '{foo/bar}'],\n+    ])\n+  })\n+\n+  test('returns single raw part for text without magic identifiers', () => {\n+    const input = 'This is a regular error message'\n+    const output = deobfuscateTextParts(input)\n+    expect(output).toEqual([['raw', 'This is a regular error message']])\n+  })\n+\n+  test('handles imported module with free call wrapper', () => {\n+    const input =\n+      '(0 , __TURBOPACK__imported__module__$5b$project$5d2f$examples$2f$with$2d$turbopack$2f$app$2f$foo$2e$ts__$5b$app$2d$rsc$5d$__$28$ecmascript$29$__.foo) is not a function'\n+    const output = deobfuscateTextParts(input)\n+    expect(output).toEqual([\n+      [\n+        'deobfuscated',\n+        '{imported module ./examples/with-turbopack/app/foo.ts}',\n+      ],\n+      ['raw', '.foo is not a function'],\n+    ])\n+  })\n+\n+  test('produces same result as deobfuscateText when joined', () => {\n+    const input =\n+      'Error in __TURBOPACK__module__evaluation__ at __TURBOPACK__foo$2f$bar__'\n+    const parts = deobfuscateTextParts(input)\n+    const joined = parts.map((part) => part[1]).join('')\n+    expect(joined).toBe(deobfuscateText(input))\n+  })\n+})"
        },
        {
            "sha": "6eea7b4a489a760dbdda03a960e388afbe3b7832",
            "filename": "packages/next/src/shared/lib/magic-identifier.ts",
            "status": "modified",
            "additions": 119,
            "deletions": 0,
            "changes": 119,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmagic-identifier.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmagic-identifier.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmagic-identifier.ts?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -93,3 +93,122 @@ export function decodeMagicIdentifier(identifier: string): string {\n }\n \n export const MAGIC_IDENTIFIER_REGEX = /__TURBOPACK__[a-zA-Z0-9_$]+__/g\n+\n+/**\n+ * Cleans up module IDs by removing implementation details.\n+ * - Replaces [project] with .\n+ * - Removes content in brackets [], parentheses (), and angle brackets <>\n+ */\n+export function deobfuscateModuleId(moduleId: string): string {\n+  return (\n+    moduleId\n+      // Replace [project] with .\n+      .replace(/\\[project\\]/g, '.')\n+      // Remove content in square brackets (e.g. [app-rsc])\n+      .replace(/\\s\\[([^\\]]*)\\]/g, '')\n+      // Remove content in parentheses (e.g. (ecmascript))\n+      .replace(/\\s\\(([^)]*)\\)/g, '')\n+      // Remove content in angle brackets (e.g. <locals>)\n+      .replace(/\\s<([^>]*)>/g, '')\n+      // Clean up any extra whitespace\n+      .trim()\n+  )\n+}\n+\n+/**\n+ * Removes the free call wrapper pattern (0, expr) from expressions.\n+ * This is a JavaScript pattern to call a function without binding 'this',\n+ * but it's noise for developers reading error messages.\n+ */\n+export function removeFreeCallWrapper(text: string): string {\n+  // Match (0, <ident>.<ident>) patterns anywhere in the text the beginning\n+  // Use Unicode property escapes (\\p{ID_Start}, \\p{ID_Continue}) for full JS identifier support\n+  // Requires the 'u' (unicode) flag in the regex\n+  return text.replace(\n+    /\\(0\\s*,\\s*(__TURBOPACK__[a-zA-Z0-9_$]+__\\.[\\p{ID_Start}_$][\\p{ID_Continue}$]*)\\)/u,\n+    '$1'\n+  )\n+}\n+\n+export type TextPartType = 'raw' | 'deobfuscated'\n+\n+/**\n+ * Deobfuscates text and returns an array of discriminated parts.\n+ * Each part is a tuple of [type, string] where type is either 'raw' (unchanged text)\n+ * or 'deobfuscated' (a magic identifier that was decoded).\n+ *\n+ * This is useful when you need to process or display deobfuscated and raw text differently.\n+ */\n+export function deobfuscateTextParts(\n+  text: string\n+): Array<[TextPartType, string]> {\n+  // First, remove free call wrappers\n+  const withoutFreeCall = removeFreeCallWrapper(text)\n+\n+  const parts: Array<[TextPartType, string]> = []\n+  let lastIndex = 0\n+\n+  // Create a new regex instance for global matching\n+  const regex = new RegExp(MAGIC_IDENTIFIER_REGEX.source, 'g')\n+\n+  for (\n+    let match = regex.exec(withoutFreeCall);\n+    match !== null;\n+    match = regex.exec(withoutFreeCall)\n+  ) {\n+    const matchStart = match.index\n+    const matchEnd = regex.lastIndex\n+    const ident = match[0]\n+\n+    // Add raw text before this match (if any)\n+    if (matchStart > lastIndex) {\n+      const rawText = withoutFreeCall.substring(lastIndex, matchStart)\n+      parts.push(['raw', rawText])\n+    }\n+\n+    // Process and add the deobfuscated part\n+    try {\n+      const decoded = decodeMagicIdentifier(ident)\n+      // If it was a magic identifier, clean up the module ID\n+      if (decoded !== ident) {\n+        // Check if this is an \"imported module\" reference\n+        const importedModuleMatch = decoded.match(/^imported module (.+)$/)\n+        if (importedModuleMatch) {\n+          // Clean the entire module path (which includes [app-rsc], etc.)\n+          const modulePathWithMetadata = importedModuleMatch[1]\n+          const cleaned = deobfuscateModuleId(modulePathWithMetadata)\n+          parts.push(['deobfuscated', `{imported module ${cleaned}}`])\n+        } else {\n+          const cleaned = deobfuscateModuleId(decoded)\n+          parts.push(['deobfuscated', `{${cleaned}}`])\n+        }\n+      } else {\n+        // Not actually a magic identifier, treat as raw\n+        parts.push(['raw', ident])\n+      }\n+    } catch (e) {\n+      parts.push(['deobfuscated', `{${ident} (decoding failed: ${e})}`])\n+    }\n+\n+    lastIndex = matchEnd\n+  }\n+\n+  // Add any remaining raw text after the last match\n+  if (lastIndex < withoutFreeCall.length) {\n+    const rawText = withoutFreeCall.substring(lastIndex)\n+    parts.push(['raw', rawText])\n+  }\n+\n+  return parts\n+}\n+\n+/**\n+ * Deobfuscates text by:\n+ * 1. Decoding magic identifiers\n+ * 2. Cleaning up module IDs\n+ * 3. Removing free call wrappers\n+ */\n+export function deobfuscateText(text: string): string {\n+  const parts = deobfuscateTextParts(text)\n+  return parts.map((part) => part[1]).join('')\n+}"
        },
        {
            "sha": "ed73764f9f92db5e82c06aaa5480d138501e8fa3",
            "filename": "packages/next/src/shared/lib/turbopack/utils.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 15,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Futils.ts?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -7,10 +7,7 @@ import type {\n \n import { bold, green, magenta, red } from '../../../lib/picocolors'\n import isInternal from '../is-internal'\n-import {\n-  decodeMagicIdentifier,\n-  MAGIC_IDENTIFIER_REGEX,\n-} from '../magic-identifier'\n+import { deobfuscateText } from '../magic-identifier'\n import type { EntryKey } from './entry-key'\n import * as Log from '../../../build/output/log'\n import type { NextConfigComplete } from '../../../server/config-shared'\n@@ -288,23 +285,20 @@ function isNodeModulesIssue(issue: Issue): boolean {\n }\n \n export function renderStyledStringToErrorAnsi(string: StyledString): string {\n-  function decodeMagicIdentifiers(str: string): string {\n-    return str.replaceAll(MAGIC_IDENTIFIER_REGEX, (ident) => {\n-      try {\n-        return magenta(`{${decodeMagicIdentifier(ident)}}`)\n-      } catch (e) {\n-        return magenta(`{${ident} (decoding failed: ${e})}`)\n-      }\n-    })\n+  function applyDeobfuscation(str: string): string {\n+    // Use shared deobfuscate function and apply magenta color to identifiers\n+    const deobfuscated = deobfuscateText(str)\n+    // Color any {...} wrapped identifiers with magenta\n+    return deobfuscated.replace(/\\{([^}]+)\\}/g, (match) => magenta(match))\n   }\n \n   switch (string.type) {\n     case 'text':\n-      return decodeMagicIdentifiers(string.value)\n+      return applyDeobfuscation(string.value)\n     case 'strong':\n-      return bold(red(decodeMagicIdentifiers(string.value)))\n+      return bold(red(applyDeobfuscation(string.value)))\n     case 'code':\n-      return green(decodeMagicIdentifiers(string.value))\n+      return green(applyDeobfuscation(string.value))\n     case 'line':\n       return string.value.map(renderStyledStringToErrorAnsi).join('')\n     case 'stack':"
        },
        {
            "sha": "e0e736846c308d3ae175f9bcca0cebf043bc7652",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -1222,7 +1222,7 @@ describe('Cache Components Errors', () => {\n                    ],\n                  },\n                  {\n-                   \"description\": \"(0 , <turbopack-module-id>.cookies)(...).get is not a function\",\n+                   \"description\": \"<turbopack-module-id>.cookies(...).get is not a function\",\n                    \"environmentLabel\": \"Prerender\",\n                    \"label\": \"Runtime TypeError\",\n                    \"source\": \"app/sync-cookies/page.tsx (18:36) @ CookiesReadingComponent\n@@ -1404,7 +1404,7 @@ describe('Cache Components Errors', () => {\n                    ],\n                  },\n                  {\n-                   \"description\": \"(0 , <turbopack-module-id>.cookies)(...).get is not a function\",\n+                   \"description\": \"<turbopack-module-id>.cookies(...).get is not a function\",\n                    \"environmentLabel\": \"Server\",\n                    \"label\": \"Runtime TypeError\",\n                    \"source\": \"app/sync-cookies-runtime/page.tsx (24:36) @ CookiesReadingComponent\n@@ -1573,7 +1573,7 @@ describe('Cache Components Errors', () => {\n                    ],\n                  },\n                  {\n-                   \"description\": \"(0 , <turbopack-module-id>.headers)(...).get is not a function\",\n+                   \"description\": \"<turbopack-module-id>.headers(...).get is not a function\",\n                    \"environmentLabel\": \"Prerender\",\n                    \"label\": \"Runtime TypeError\",\n                    \"source\": \"app/sync-headers/page.tsx (18:40) @ HeadersReadingComponent\n@@ -1755,7 +1755,7 @@ describe('Cache Components Errors', () => {\n                    ],\n                  },\n                  {\n-                   \"description\": \"(0 , <turbopack-module-id>.headers)(...).get is not a function\",\n+                   \"description\": \"<turbopack-module-id>.headers(...).get is not a function\",\n                    \"environmentLabel\": \"Server\",\n                    \"label\": \"Runtime TypeError\",\n                    \"source\": \"app/sync-headers-runtime/page.tsx (24:40) @ HeadersReadingComponent"
        },
        {
            "sha": "7663bd263c5add3ec0717de6bd9bf5fdf99a3759",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/base.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs?ref=e2262334f8e7ba0050d74d4fe9ea7f9cd7b7033d",
            "patch": "@@ -268,6 +268,8 @@ impl ReferencedAsset {\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ) -> Result<String> {\n         let id = asset.chunk_item_id(chunking_context).await?;\n+        // There are a number of places in `next` that match on this prefix.\n+        // See `packages/next/src/shared/lib/magic-identifier.ts`\n         Ok(magic_identifier::mangle(&format!(\"imported module {id}\")))\n     }\n }"
        }
    ],
    "stats": {
        "total": 434,
        "additions": 373,
        "deletions": 61
    }
}