{
    "author": "huozhi",
    "message": "[dev-overlay] handle ssrd nextjs internal errors in overlay (#76124)",
    "sha": "ec1fefca045239111e03403d9adcb1a9e355c3a3",
    "files": [
        {
            "sha": "be6569079fcb5975f76b053787db94f0af83f2c0",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ec1fefca045239111e03403d9adcb1a9e355c3a3/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ec1fefca045239111e03403d9adcb1a9e355c3a3/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=ec1fefca045239111e03403d9adcb1a9e355c3a3",
            "patch": "@@ -27,6 +27,7 @@ import { MissingSlotContext } from '../shared/lib/app-router-context.shared-runt\n import { setAppBuildId } from './app-build-id'\n import { shouldRenderRootLevelErrorOverlay } from './lib/is-error-thrown-while-rendering-rsc'\n import { handleClientError } from './components/errors/use-error-handler'\n+import { isNextRouterError } from './components/is-next-router-error'\n \n /// <reference types=\"react-dom/experimental\" />\n \n@@ -304,7 +305,15 @@ function devQueueSsrError(): Error | undefined {\n       'data-next-error-message'\n     )!\n     const stack = ssrErrorTemplateTag.getAttribute('data-next-error-stack')\n+    const digest = ssrErrorTemplateTag.getAttribute('data-next-error-digest')\n     const error = new Error(message)\n+    if (digest) {\n+      ;(error as any).digest = digest\n+    }\n+    // Skip Next.js SSR'd internal errors that which will be handled by the error boundaries.\n+    if (isNextRouterError(error)) {\n+      return\n+    }\n     error.stack = stack || ''\n     return error\n   }"
        },
        {
            "sha": "8a55b2cfe01caf8ffe78b3327bddf29c8c591565",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ec1fefca045239111e03403d9adcb1a9e355c3a3/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ec1fefca045239111e03403d9adcb1a9e355c3a3/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=ec1fefca045239111e03403d9adcb1a9e355c3a3",
            "patch": "@@ -994,6 +994,7 @@ async function getErrorRSCPayload(\n         {process.env.NODE_ENV !== 'production' && err ? (\n           <template\n             data-next-error-message={err.message}\n+            data-next-error-digest={'digest' in err ? err.digest : ''}\n             data-next-error-stack={err.stack}\n           />\n         ) : null}"
        },
        {
            "sha": "4bf3aa3d5e4f4f92f9257f182fc73ffb5fdbde68",
            "filename": "test/development/app-dir/error-overlay/error-ignored-frames/error-ignored-frames.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ec1fefca045239111e03403d9adcb1a9e355c3a3/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec1fefca045239111e03403d9adcb1a9e355c3a3/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Ferror-overlay%2Ferror-ignored-frames%2Ferror-ignored-frames.test.ts?ref=ec1fefca045239111e03403d9adcb1a9e355c3a3",
            "patch": "@@ -54,7 +54,7 @@ describe('error-ignored-frames', () => {\n        at OuterLayoutRouter (../src/client/components/layout-router.tsx (607:20))\n        at Router (../src/client/components/app-router.tsx (633:8))\n        at AppRouter (../src/client/components/app-router.tsx (679:8))\n-       at ServerRoot (../src/client/app-index.tsx (200:6))\"\n+       at ServerRoot (../src/client/app-index.tsx (201:6))\"\n       `)\n     }\n   })\n@@ -85,7 +85,7 @@ describe('error-ignored-frames', () => {\n        at ClientPageRoot (../src/client/components/client-page.tsx (60:13))\n        at Router (../src/client/components/app-router.tsx (633:8))\n        at AppRouter (../src/client/components/app-router.tsx (679:8))\n-       at ServerRoot (../src/client/app-index.tsx (200:6))\"\n+       at ServerRoot (../src/client/app-index.tsx (201:6))\"\n       `)\n     }\n   })\n@@ -128,7 +128,7 @@ describe('error-ignored-frames', () => {\n        at ClientPageRoot (../src/client/components/client-page.tsx (60:13))\n        at Router (../src/client/components/app-router.tsx (633:8))\n        at AppRouter (../src/client/components/app-router.tsx (679:8))\n-       at ServerRoot (../src/client/app-index.tsx (200:6))\"\n+       at ServerRoot (../src/client/app-index.tsx (201:6))\"\n       `)\n     }\n   })"
        },
        {
            "sha": "b50037824b94ff19f6fc0dae95d2e633e7de1571",
            "filename": "test/development/app-dir/ssr-only-error/app/notfound/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ec1fefca045239111e03403d9adcb1a9e355c3a3/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fapp%2Fnotfound%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ec1fefca045239111e03403d9adcb1a9e355c3a3/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fapp%2Fnotfound%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fapp%2Fnotfound%2Fpage.tsx?ref=ec1fefca045239111e03403d9adcb1a9e355c3a3",
            "patch": "@@ -0,0 +1,7 @@\n+import { notFound } from 'next/navigation'\n+\n+export default async function Home() {\n+  notFound()\n+}\n+\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "20fa2354686122d43822ec27df1e72ad6e162e9a",
            "filename": "test/development/app-dir/ssr-only-error/ssr-only-error.test.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/ec1fefca045239111e03403d9adcb1a9e355c3a3/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ec1fefca045239111e03403d9adcb1a9e355c3a3/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fssr-only-error%2Fssr-only-error.test.ts?ref=ec1fefca045239111e03403d9adcb1a9e355c3a3",
            "patch": "@@ -1,5 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n import {\n+  assertNoRedbox,\n   getRedboxDescription,\n   getRedboxSource,\n   hasErrorToast,\n@@ -40,4 +41,30 @@ describe('ssr-only-error', () => {\n      }\n     `)\n   })\n+\n+  it('should not handle internal nextjs errors that will be handled by error boundaries', async () => {\n+    const browser = await next.browser('/notfound', {\n+      pushErrorAsConsoleLog: true,\n+    })\n+\n+    await assertNoRedbox(browser)\n+    expect(await hasErrorToast(browser)).toBe(false)\n+\n+    const text = await browser.elementByCss('body').text()\n+    expect(text).toBe('404\\nThis page could not be found.')\n+\n+    // Assert there's only one console.error from browser itself\n+    const errorLogs = (await browser.log()).filter(\n+      (log) => log.source === 'error'\n+    )\n+\n+    expect(errorLogs).toEqual([\n+      expect.objectContaining({\n+        source: 'error',\n+        message: expect.stringContaining(\n+          'the server responded with a status of 404'\n+        ),\n+      }),\n+    ])\n+  })\n })"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 47,
        "deletions": 3
    }
}