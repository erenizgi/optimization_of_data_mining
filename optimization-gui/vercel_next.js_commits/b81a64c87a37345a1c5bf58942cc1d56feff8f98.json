{
    "author": "sokra",
    "message": "Turbopack: remove Stateful flag (#88196)\n\n### What?\n\nRemove unused code",
    "sha": "b81a64c87a37345a1c5bf58942cc1d56feff8f98",
    "files": [
        {
            "sha": "aeabbf9536e950635b09655d0fedb4226d1acb4f",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 12,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=b81a64c87a37345a1c5bf58942cc1d56feff8f98",
            "patch": "@@ -1755,7 +1755,6 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n         task_id: TaskId,\n         result: Result<RawVc, TurboTasksExecutionError>,\n         cell_counters: &AutoMap<ValueTypeId, u32, BuildHasherDefault<FxHasher>, 8>,\n-        stateful: bool,\n         has_invalidator: bool,\n         turbo_tasks: &dyn TurboTasksBackendApi<TurboTasksBackend<B>>,\n     ) -> bool {\n@@ -1806,7 +1805,6 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             task_id,\n             result,\n             cell_counters,\n-            stateful,\n             has_invalidator,\n         )\n         else {\n@@ -1877,7 +1875,6 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n         task_id: TaskId,\n         result: Result<RawVc, TurboTasksExecutionError>,\n         cell_counters: &AutoMap<ValueTypeId, u32, BuildHasherDefault<FxHasher>, 8>,\n-        stateful: bool,\n         has_invalidator: bool,\n     ) -> Option<TaskExecutionCompletePrepareResult> {\n         let mut task = ctx.task(task_id, TaskDataCategory::All);\n@@ -1943,11 +1940,6 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n         // take the children from the task to process them\n         let mut new_children = take(new_children);\n \n-        // handle stateful\n-        if stateful {\n-            let _ = task.add(CachedDataItem::Stateful { value: () });\n-        }\n-\n         // handle has_invalidator\n         if has_invalidator {\n             let _ = task.add(CachedDataItem::HasInvalidator { value: () });\n@@ -2366,8 +2358,8 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             old_content = task.insert(CachedDataItem::Output { value });\n         }\n \n-        // If the task is not stateful and has no mutable children, it does not have a way to be\n-        // invalidated and we can mark it as immutable.\n+        // If the task has no invalidator and has no mutable dependencies, it does not have a way\n+        // to be invalidated and we can mark it as immutable.\n         if is_now_immutable {\n             let _ = task.add(CachedDataItem::Immutable { value: () });\n         }\n@@ -3243,15 +3235,13 @@ impl<B: BackingStorage> Backend for TurboTasksBackend<B> {\n         task_id: TaskId,\n         result: Result<RawVc, TurboTasksExecutionError>,\n         cell_counters: &AutoMap<ValueTypeId, u32, BuildHasherDefault<FxHasher>, 8>,\n-        stateful: bool,\n         has_invalidator: bool,\n         turbo_tasks: &dyn TurboTasksBackendApi<Self>,\n     ) -> bool {\n         self.0.task_execution_completed(\n             task_id,\n             result,\n             cell_counters,\n-            stateful,\n             has_invalidator,\n             turbo_tasks,\n         )"
        },
        {
            "sha": "bff8af1c692df8c5039103e7a1a181647a5d373b",
            "filename": "turbopack/crates/turbo-tasks-backend/src/data.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdata.rs?ref=b81a64c87a37345a1c5bf58942cc1d56feff8f98",
            "patch": "@@ -323,9 +323,6 @@ pub enum CachedDataItem {\n     },\n \n     // Flags\n-    Stateful {\n-        value: (),\n-    },\n     HasInvalidator {\n         value: (),\n     },\n@@ -424,7 +421,6 @@ impl CachedDataItem {\n             }\n             CachedDataItem::AggregatedDirtyContainerCount { .. } => true,\n             CachedDataItem::AggregatedCurrentSessionCleanContainerCount { .. } => false,\n-            CachedDataItem::Stateful { .. } => true,\n             CachedDataItem::HasInvalidator { .. } => true,\n             CachedDataItem::Immutable { .. } => true,\n             CachedDataItem::Activeness { .. } => false,\n@@ -495,7 +491,6 @@ impl CachedDataItem {\n             | Self::AggregatedDirtyContainer { .. }\n             | Self::AggregatedCollectible { .. }\n             | Self::AggregatedDirtyContainerCount { .. }\n-            | Self::Stateful { .. }\n             | Self::HasInvalidator { .. }\n             | Self::Immutable { .. }\n             | Self::CollectiblesDependent { .. } => TaskDataCategory::Meta,\n@@ -556,7 +551,6 @@ impl CachedDataItemKey {\n             }\n             CachedDataItemKey::AggregatedDirtyContainerCount { .. } => true,\n             CachedDataItemKey::AggregatedCurrentSessionCleanContainerCount { .. } => false,\n-            CachedDataItemKey::Stateful { .. } => true,\n             CachedDataItemKey::HasInvalidator { .. } => true,\n             CachedDataItemKey::Immutable { .. } => true,\n             CachedDataItemKey::Activeness { .. } => false,\n@@ -595,7 +589,6 @@ impl CachedDataItemType {\n             | Self::AggregatedDirtyContainer { .. }\n             | Self::AggregatedCollectible { .. }\n             | Self::AggregatedDirtyContainerCount { .. }\n-            | Self::Stateful { .. }\n             | Self::HasInvalidator { .. }\n             | Self::Immutable { .. }\n             | Self::CollectiblesDependent { .. } => TaskDataCategory::Meta,\n@@ -634,7 +627,6 @@ impl CachedDataItemType {\n             | Self::AggregatedDirtyContainer\n             | Self::AggregatedCollectible\n             | Self::AggregatedDirtyContainerCount\n-            | Self::Stateful\n             | Self::HasInvalidator\n             | Self::Immutable => true,\n "
        },
        {
            "sha": "88ad2a697984834ee692abcc97984a41ec8a396d",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=b81a64c87a37345a1c5bf58942cc1d56feff8f98",
            "patch": "@@ -64,7 +64,7 @@ use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{\n     ApplyEffectsContext, Completion, InvalidationReason, Invalidator, NonLocalValue, ReadRef,\n     ResolvedVc, TaskInput, TurboTasksApi, ValueToString, Vc, debug::ValueDebugFormat, effect,\n-    mark_session_dependent, mark_stateful, parallel, trace::TraceRawVcs, turbo_tasks_weak,\n+    mark_session_dependent, parallel, trace::TraceRawVcs, turbo_tasks_weak,\n };\n use turbo_tasks_hash::{DeterministicHash, DeterministicHasher, hash_xxh3_hash64};\n use turbo_unix_path::{\n@@ -664,8 +664,6 @@ impl DiskFileSystem {\n impl DiskFileSystem {\n     #[turbo_tasks::function]\n     fn new_internal(name: RcStr, root: RcStr, denied_paths: Vec<RcStr>) -> Vc<Self> {\n-        mark_stateful();\n-\n         let instance = DiskFileSystem {\n             inner: Arc::new(DiskFileSystemInner {\n                 name,"
        },
        {
            "sha": "9a11ce9787da72aa6e428b7fc15ca49e46019c27",
            "filename": "turbopack/crates/turbo-tasks/src/backend.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs?ref=b81a64c87a37345a1c5bf58942cc1d56feff8f98",
            "patch": "@@ -427,7 +427,6 @@ pub trait Backend: Sync + Send {\n         task: TaskId,\n         result: Result<RawVc, TurboTasksExecutionError>,\n         cell_counters: &AutoMap<ValueTypeId, u32, BuildHasherDefault<FxHasher>, 8>,\n-        stateful: bool,\n         has_invalidator: bool,\n         turbo_tasks: &dyn TurboTasksBackendApi<Self>,\n     ) -> bool;"
        },
        {
            "sha": "54d4b17cf2c020e443942daed23f6000d01f9d49",
            "filename": "turbopack/crates/turbo-tasks/src/lib.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Flib.rs?ref=b81a64c87a37345a1c5bf58942cc1d56feff8f98",
            "patch": "@@ -112,9 +112,9 @@ pub use crate::{\n     manager::{\n         CurrentCellRef, ReadConsistency, ReadTracking, TaskPersistence, TurboTasks, TurboTasksApi,\n         TurboTasksBackendApi, TurboTasksCallApi, Unused, UpdateInfo, dynamic_call, emit,\n-        mark_finished, mark_root, mark_session_dependent, mark_stateful, prevent_gc, run, run_once,\n-        run_once_with_reason, trait_call, turbo_tasks, turbo_tasks_scope, turbo_tasks_weak,\n-        with_turbo_tasks,\n+        get_serialization_invalidator, mark_finished, mark_root, mark_session_dependent,\n+        prevent_gc, run, run_once, run_once_with_reason, trait_call, turbo_tasks,\n+        turbo_tasks_scope, turbo_tasks_weak, with_turbo_tasks,\n     },\n     output::OutputContent,\n     raw_vc::{CellId, RawVc, ReadRawVcFuture, ResolveTypeError},"
        },
        {
            "sha": "f0b7756d7832ccbb8e9a13c4e01361da8ad3d5a8",
            "filename": "turbopack/crates/turbo-tasks/src/manager.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 33,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs?ref=b81a64c87a37345a1c5bf58942cc1d56feff8f98",
            "patch": "@@ -377,9 +377,6 @@ struct CurrentTaskState {\n     task_id: Option<TaskId>,\n     execution_id: ExecutionId,\n \n-    /// True if the current task has state in cells\n-    stateful: bool,\n-\n     /// True if the current task uses an external invalidator\n     has_invalidator: bool,\n \n@@ -402,7 +399,6 @@ impl CurrentTaskState {\n         Self {\n             task_id: Some(task_id),\n             execution_id,\n-            stateful: false,\n             has_invalidator: false,\n             cell_counters: Some(AutoMap::default()),\n             local_tasks: Vec::new(),\n@@ -414,7 +410,6 @@ impl CurrentTaskState {\n         Self {\n             task_id: None,\n             execution_id,\n-            stateful: false,\n             has_invalidator: false,\n             cell_counters: None,\n             local_tasks: Vec::new(),\n@@ -732,17 +727,14 @@ impl<B: Backend + 'static> TurboTasks<B> {\n                             Err(err) => Err(TurboTasksExecutionError::Panic(Arc::new(err))),\n                         };\n \n-                        let FinishedTaskState {\n-                            stateful,\n-                            has_invalidator,\n-                        } = this.finish_current_task_state();\n+                        let FinishedTaskState { has_invalidator } =\n+                            this.finish_current_task_state();\n                         let cell_counters = CURRENT_TASK_STATE\n                             .with(|ts| ts.write().unwrap().cell_counters.take().unwrap());\n                         this.backend.task_execution_completed(\n                             task_id,\n                             result,\n                             &cell_counters,\n-                            stateful,\n                             has_invalidator,\n                             &*this,\n                         )\n@@ -1129,19 +1121,14 @@ impl<B: Backend + 'static> TurboTasks<B> {\n     }\n \n     fn finish_current_task_state(&self) -> FinishedTaskState {\n-        let (stateful, has_invalidator) = CURRENT_TASK_STATE.with(|cell| {\n+        let has_invalidator = CURRENT_TASK_STATE.with(|cell| {\n             let CurrentTaskState {\n-                stateful,\n-                has_invalidator,\n-                ..\n+                has_invalidator, ..\n             } = &mut *cell.write().unwrap();\n-            (*stateful, *has_invalidator)\n+            *has_invalidator\n         });\n \n-        FinishedTaskState {\n-            stateful,\n-            has_invalidator,\n-        }\n+        FinishedTaskState { has_invalidator }\n     }\n \n     pub fn backend(&self) -> &B {\n@@ -1150,9 +1137,6 @@ impl<B: Backend + 'static> TurboTasks<B> {\n }\n \n struct FinishedTaskState {\n-    /// True if the task has state in cells\n-    stateful: bool,\n-\n     /// True if the task uses an external invalidator\n     has_invalidator: bool,\n }\n@@ -1669,20 +1653,15 @@ pub fn mark_finished() {\n     });\n }\n \n-/// Marks the current task as stateful. This prevents the tasks from being\n-/// dropped without persisting the state.\n-///\n /// Returns a [`SerializationInvalidator`] that can be used to invalidate the\n /// serialization of the current task cells\n-pub fn mark_stateful() -> SerializationInvalidator {\n+pub fn get_serialization_invalidator() -> SerializationInvalidator {\n     CURRENT_TASK_STATE.with(|cell| {\n-        let CurrentTaskState {\n-            stateful, task_id, ..\n-        } = &mut *cell.write().unwrap();\n-        *stateful = true;\n+        let CurrentTaskState { task_id, .. } = &mut *cell.write().unwrap();\n         let Some(task_id) = *task_id else {\n             panic!(\n-                \"mark_stateful() can only be used in the context of a turbo_tasks task execution\"\n+                \"get_serialization_invalidator() can only be used in the context of a turbo_tasks \\\n+                 task execution\"\n             );\n         };\n         SerializationInvalidator::new(task_id)\n@@ -1699,8 +1678,7 @@ pub fn mark_invalidator() {\n }\n \n pub fn prevent_gc() {\n-    // There is a hack in UpdateCellOperation that need to be updated when this is changed.\n-    mark_stateful();\n+    // TODO implement garbage collection\n }\n \n pub fn emit<T: VcValueTrait + ?Sized>(collectible: ResolvedVc<T>) {"
        },
        {
            "sha": "cc44fe8419011e1a95f961b063bf4766b8e6da73",
            "filename": "turbopack/crates/turbo-tasks/src/state.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fstate.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b81a64c87a37345a1c5bf58942cc1d56feff8f98/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fstate.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fstate.rs?ref=b81a64c87a37345a1c5bf58942cc1d56feff8f98",
            "patch": "@@ -12,7 +12,8 @@ use tracing::trace_span;\n \n use crate::{\n     Invalidator, OperationValue, SerializationInvalidator, get_invalidator,\n-    manager::with_turbo_tasks, mark_session_dependent, mark_stateful, trace::TraceRawVcs,\n+    get_serialization_invalidator, manager::with_turbo_tasks, mark_session_dependent,\n+    trace::TraceRawVcs,\n };\n \n #[derive(Encode, Decode)]\n@@ -221,7 +222,7 @@ impl<T> State<T> {\n         T: OperationValue,\n     {\n         Self {\n-            serialization_invalidator: mark_stateful(),\n+            serialization_invalidator: get_serialization_invalidator(),\n             inner: Mutex::new(StateInner::new(value)),\n         }\n     }\n@@ -332,7 +333,6 @@ impl<T> Eq for TransientState<T> {}\n \n impl<T> TransientState<T> {\n     pub fn new() -> Self {\n-        mark_stateful();\n         Self {\n             inner: Mutex::new(StateInner::new(None)),\n         }"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 20,
        "deletions": 63
    }
}