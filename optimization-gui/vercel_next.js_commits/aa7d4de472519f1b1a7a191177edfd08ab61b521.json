{
    "author": "unstubbable",
    "message": "Enable `ppr` when `dynamicIO` is enabled (#79302)\n\nWith this PR, we're automatically enabling `ppr` when `dynamicIO` is enabled, and forbid using `ppr: 'incremental'` or `ppr: false` together with `dynamicIO: true`.\r\n\r\nWhile implementing the config validation, I noticed that the `userConfig`, `config`, and `result` objects in `assignDefaults` were untyped. This is fixed now.",
    "sha": "aa7d4de472519f1b1a7a191177edfd08ab61b521",
    "files": [
        {
            "sha": "84b8b97378321a3a5b157c3eba130b93c8832bec",
            "filename": ".changeset/dry-roses-nail.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/aa7d4de472519f1b1a7a191177edfd08ab61b521/.changeset%2Fdry-roses-nail.md",
            "raw_url": "https://github.com/vercel/next.js/raw/aa7d4de472519f1b1a7a191177edfd08ab61b521/.changeset%2Fdry-roses-nail.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Fdry-roses-nail.md?ref=aa7d4de472519f1b1a7a191177edfd08ab61b521",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+\"next\": patch\n+---\n+\n+Enable `ppr` when `dynamicIO` is enabled"
        },
        {
            "sha": "222c81ff167dd553613983899a1baa4676997090",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/aa7d4de472519f1b1a7a191177edfd08ab61b521/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/aa7d4de472519f1b1a7a191177edfd08ab61b521/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=aa7d4de472519f1b1a7a191177edfd08ab61b521",
            "patch": "@@ -679,5 +679,6 @@\n   \"678\": \"CacheSignal got more endRead() calls than beginRead() calls\",\n   \"679\": \"A CacheSignal cannot subscribe to itself\",\n   \"680\": \"CacheSignal cannot be used in the edge runtime, because `dynamicIO` does not support it.\",\n-  \"681\": \"Dynamic imports should not be instrumented in the edge runtime, because `dynamicIO` doesn't support it\"\n+  \"681\": \"Dynamic imports should not be instrumented in the edge runtime, because `dynamicIO` doesn't support it\",\n+  \"682\": \"\\\\`experimental.ppr\\\\` can not be \\\\`%s\\\\` when \\\\`experimental.dynamicIO\\\\` is \\\\`true\\\\`. PPR is implicitly enabled when Dynamic IO is enabled.\"\n }"
        },
        {
            "sha": "0b5314a1e346141bc8c2d0707059b7cd3e124fb9",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/aa7d4de472519f1b1a7a191177edfd08ab61b521/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa7d4de472519f1b1a7a191177edfd08ab61b521/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=aa7d4de472519f1b1a7a191177edfd08ab61b521",
            "patch": "@@ -637,8 +637,10 @@ export interface ExperimentalConfig {\n   serverComponentsHmrCache?: boolean\n \n   /**\n-   * When enabled will cause IO in App Router to be excluded from prerenders\n-   * unless explicitly cached.\n+   * When enabled, will cause IO in App Router to be excluded from prerenders,\n+   * unless explicitly cached. This also enables the experimental Partial\n+   * Prerendering feature of Next.js, and it enables `react@experimental` being\n+   * used for the `app` directory.\n    */\n   dynamicIO?: boolean\n \n@@ -1198,7 +1200,7 @@ export interface NextConfig extends Record<string, any> {\n   htmlLimitedBots?: RegExp\n }\n \n-export const defaultConfig: NextConfig = {\n+export const defaultConfig = {\n   env: {},\n   webpack: null,\n   eslint: {\n@@ -1391,7 +1393,7 @@ export const defaultConfig: NextConfig = {\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,\n-}\n+} satisfies NextConfig\n \n export async function normalizeConfig(phase: string, config: any) {\n   if (typeof config === 'function') {"
        },
        {
            "sha": "700ac089f368bcd5065cdb937a87a8f2ce8aa948",
            "filename": "packages/next/src/server/config.test.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/aa7d4de472519f1b1a7a191177edfd08ab61b521/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa7d4de472519f1b1a7a191177edfd08ab61b521/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.test.ts?ref=aa7d4de472519f1b1a7a191177edfd08ab61b521",
            "patch": "@@ -136,4 +136,44 @@ describe('loadConfig', () => {\n       )\n     })\n   })\n+\n+  describe('with a canary version', () => {\n+    beforeAll(() => {\n+      process.env.__NEXT_VERSION = '15.4.0-canary.35'\n+    })\n+\n+    afterAll(() => {\n+      delete process.env.__NEXT_VERSION\n+    })\n+\n+    it('errors when dynamicIO is enabled but PPR is disabled', async () => {\n+      await expect(\n+        loadConfig('', __dirname, {\n+          customConfig: {\n+            experimental: {\n+              dynamicIO: true,\n+              ppr: false,\n+            },\n+          },\n+        })\n+      ).rejects.toThrow(\n+        '`experimental.ppr` can not be `false` when `experimental.dynamicIO` is `true`. PPR is implicitly enabled when Dynamic IO is enabled.'\n+      )\n+    })\n+\n+    it('errors when dynamicIO is enabled but PPR set to \"incremental\"', async () => {\n+      await expect(\n+        loadConfig('', __dirname, {\n+          customConfig: {\n+            experimental: {\n+              dynamicIO: true,\n+              ppr: 'incremental',\n+            },\n+          },\n+        })\n+      ).rejects.toThrow(\n+        '`experimental.ppr` can not be `\"incremental\"` when `experimental.dynamicIO` is `true`. PPR is implicitly enabled when Dynamic IO is enabled.'\n+      )\n+    })\n+  })\n })"
        },
        {
            "sha": "f53de12325b43fb306d194a3517da2f870394493",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 11,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/aa7d4de472519f1b1a7a191177edfd08ab61b521/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa7d4de472519f1b1a7a191177edfd08ab61b521/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=aa7d4de472519f1b1a7a191177edfd08ab61b521",
            "patch": "@@ -143,9 +143,9 @@ function warnCustomizedOption(\n \n function assignDefaults(\n   dir: string,\n-  userConfig: { [key: string]: any },\n+  userConfig: NextConfig & { configFileName: string },\n   silent: boolean\n-) {\n+): NextConfigComplete {\n   const configFileName = userConfig.configFileName\n   if (typeof userConfig.exportTrailingSlash !== 'undefined') {\n     if (!silent) {\n@@ -213,9 +213,15 @@ function assignDefaults(\n         })\n       }\n \n-      if (!!value && value.constructor === Object) {\n+      const defaultValue = (defaultConfig as Record<string, unknown>)[key]\n+\n+      if (\n+        !!value &&\n+        value.constructor === Object &&\n+        typeof defaultValue === 'object'\n+      ) {\n         currentConfig[key] = {\n-          ...defaultConfig[key],\n+          ...defaultValue,\n           ...Object.keys(value).reduce<any>((c, k) => {\n             const v = value[k]\n             if (v !== undefined && v !== null) {\n@@ -231,7 +237,7 @@ function assignDefaults(\n       return currentConfig\n     },\n     {}\n-  )\n+  ) as NextConfig & { configFileName: string }\n \n   // TODO: remove these once we've made PPR default\n   // If this was defaulted to true, it implies that the configuration was\n@@ -532,7 +538,7 @@ function assignDefaults(\n   if (\n     hasWarnedBuildActivityPosition &&\n     result.devIndicators !== false &&\n-    result.devIndicators?.buildActivityPosition &&\n+    'buildActivityPosition' in result.devIndicators &&\n     result.devIndicators.buildActivityPosition !== result.devIndicators.position\n   ) {\n     Log.warnOnce(\n@@ -963,7 +969,11 @@ function assignDefaults(\n           reason: 'key must only use characters a-z and -',\n         })\n       } else {\n-        const handlerPath = result.experimental.cacheHandlers[key]\n+        const handlerPath = (\n+          result.experimental.cacheHandlers as {\n+            [handlerName: string]: string | undefined\n+          }\n+        )[key]\n \n         if (handlerPath && !existsSync(handlerPath)) {\n           invalidHandlerItems.push({\n@@ -1095,7 +1105,21 @@ function assignDefaults(\n     result.experimental.useCache = result.experimental.dynamicIO\n   }\n \n-  return result\n+  // If dynamicIO is enabled, we also enable PPR.\n+  if (result.experimental.dynamicIO) {\n+    if (\n+      userConfig.experimental?.ppr === false ||\n+      userConfig.experimental?.ppr === 'incremental'\n+    ) {\n+      throw new Error(\n+        `\\`experimental.ppr\\` can not be \\`${JSON.stringify(userConfig.experimental?.ppr)}\\` when \\`experimental.dynamicIO\\` is \\`true\\`. PPR is implicitly enabled when Dynamic IO is enabled.`\n+      )\n+    }\n+\n+    result.experimental.ppr = true\n+  }\n+\n+  return result as NextConfigComplete\n }\n \n async function applyModifyConfig(\n@@ -1401,10 +1425,9 @@ export default async function loadConfig(\n   // reactRoot can be updated correctly even with no next.config.js\n   const completeConfig = assignDefaults(\n     dir,\n-    defaultConfig,\n+    { ...defaultConfig, configFileName },\n     silent\n   ) as NextConfigComplete\n-  completeConfig.configFileName = configFileName\n   setHttpClientAndAgentOptions(completeConfig)\n   return await applyModifyConfig(completeConfig, phase, silent)\n }\n@@ -1438,7 +1461,7 @@ export function getConfiguredExperimentalFeatures(\n \n       if (\n         name in defaultConfig.experimental &&\n-        value !== defaultConfig.experimental[name]\n+        value !== (defaultConfig.experimental as Record<string, unknown>)[name]\n       ) {\n         configuredExperimentalFeatures.push(\n           typeof value === 'boolean'"
        }
    ],
    "stats": {
        "total": 103,
        "additions": 87,
        "deletions": 16
    }
}