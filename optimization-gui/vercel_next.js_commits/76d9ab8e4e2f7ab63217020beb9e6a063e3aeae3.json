{
    "author": "eps1lon",
    "message": "[test] Improve React performance track tests (#81359)",
    "sha": "76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3",
    "files": [
        {
            "sha": "8f4b80113e12499f772b63224efc972f3235e646",
            "filename": "test/development/app-dir/react-performance-track/app/ReactServerRequests.tsx",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FReactServerRequests.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FReactServerRequests.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FReactServerRequests.tsx?ref=76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3",
            "patch": "@@ -0,0 +1,42 @@\n+'use client'\n+\n+import { useSyncExternalStore } from 'react'\n+\n+const reactServerRequestsServerSnapshot: never[] = []\n+const ServerRequestsStore = {\n+  subscribe:\n+    typeof window === 'undefined'\n+      ? () => () => {}\n+      : window.reactServerRequests.subscribe,\n+  getSnapshot:\n+    typeof window === 'undefined'\n+      ? () => []\n+      : window.reactServerRequests.getSnapshot,\n+  getServerSnapshot: () => reactServerRequestsServerSnapshot,\n+}\n+\n+export function ReactServerRequests() {\n+  const reactServerRequests = useSyncExternalStore(\n+    ServerRequestsStore.subscribe,\n+    ServerRequestsStore.getSnapshot,\n+    ServerRequestsStore.getServerSnapshot\n+  )\n+\n+  return (\n+    <>\n+      <p>{reactServerRequests.length} Server Request entries</p>\n+      <ol>\n+        {reactServerRequests.map((request, index) => (\n+          <li key={index}>\n+            <details>\n+              <summary>\n+                <strong>{request.name}</strong>\n+              </summary>\n+              <pre>{JSON.stringify(request.properties, null, 2)}</pre>\n+            </details>\n+          </li>\n+        ))}\n+      </ol>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "8a1c665af506ddf4c02d84efae6dd125cfcad646",
            "filename": "test/development/app-dir/react-performance-track/app/layout.tsx",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Flayout.tsx?ref=76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3",
            "patch": "@@ -1,9 +1,29 @@\n import { ReactNode, Suspense } from 'react'\n+import { ReactServerRequests } from './ReactServerRequests'\n+import Link from 'next/link'\n+\n export default function Root({ children }: { children: ReactNode }) {\n   return (\n     <html>\n-      <body>\n-        <Suspense>{children}</Suspense>\n+      <body style={{ display: 'flex', flexDirection: 'row', gap: '1rem' }}>\n+        <ul>\n+          <li>\n+            <Link href=\"/\">Home</Link>\n+          </li>\n+          <li>\n+            <Link href=\"/fetch\">fetch</Link>\n+          </li>\n+          <li>\n+            <Link href=\"/set-timeout\">setTimeout</Link>\n+          </li>\n+        </ul>\n+        <main>\n+          <ReactServerRequests />\n+          <Suspense fallback=\"Loading Server Requests\">\n+            <div data-react-server-requests-done />\n+            {children}\n+          </Suspense>\n+        </main>\n       </body>\n     </html>\n   )"
        },
        {
            "sha": "9439a2b8835fd67e24f3203cd30215906b45a97d",
            "filename": "test/development/app-dir/react-performance-track/app/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fpage.tsx?ref=76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3",
            "patch": "@@ -1,5 +1,3 @@\n-const error = new Error('test')\n export default function Page() {\n-  console.error(error)\n-  return <p>hello world</p>\n+  return <p>Hello, World!</p>\n }"
        },
        {
            "sha": "f692037234ffd6ff6b553cf812ac29a2dda87083",
            "filename": "test/development/app-dir/react-performance-track/instrumentation-client.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 7,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts?ref=76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3",
            "patch": "@@ -1,33 +1,60 @@\n export {}\n \n+type ReactServerRequests = Array<{\n+  name: string\n+  properties: any\n+}>\n+\n declare global {\n   interface Window {\n-    reactServerRequests: Array<{\n-      name: string\n-      properties: any\n-    }>\n+    reactServerRequests: {\n+      getSnapshot(): ReactServerRequests\n+      subscribe(callback: () => void): () => void\n+    }\n   }\n \n   interface PerformanceEntry {\n     detail?: any\n   }\n }\n \n-window.reactServerRequests = []\n+let reactServerRequests: ReactServerRequests = []\n+const listeners = new Set<() => void>()\n+\n+// The store implementation is just a local debugging aid.\n+// Assertions should happen on `getSnapshot` not on the UI.\n+window.reactServerRequests = {\n+  getSnapshot: () => {\n+    return reactServerRequests\n+  },\n+  subscribe: (callback) => {\n+    listeners.add(callback)\n+    return () => {\n+      listeners.delete(callback)\n+    }\n+  },\n+}\n \n // We're trying to mock how the Chrome DevTools performance panel will display\n // React performance data. React might decide to use console.timeStamp instead\n // or any other method that will be picked up by the performance panel so this\n // logic may have to be adjusted when updating React. A change here, doesn't\n // mean it's a breaking change in React nor Next.js.\n new PerformanceObserver((entries) => {\n+  const newRequests: ReactServerRequests = []\n   for (const entry of entries.getEntries()) {\n     if (entry.detail?.devtools?.track === 'Server Requests âš›') {\n-      window.reactServerRequests.push({\n+      newRequests.push({\n         name: entry.name,\n         properties: entry.detail.devtools.properties,\n       })\n     }\n   }\n-  console.log(window.reactServerRequests)\n+\n+  if (newRequests.length > 0) {\n+    reactServerRequests = reactServerRequests.concat(newRequests)\n+    for (const listener of listeners) {\n+      listener()\n+    }\n+  }\n }).observe({ entryTypes: ['measure'] })"
        },
        {
            "sha": "62d64363e22e8785799507de11d2bec6edc07c85",
            "filename": "test/development/app-dir/react-performance-track/react-performance-track.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts?ref=76d9ab8e4e2f7ab63217020beb9e6a063e3aeae3",
            "patch": "@@ -7,8 +7,9 @@ describe('react-performance-track', () => {\n \n   it('should show setTimeout', async () => {\n     const browser = await next.browser('/set-timeout')\n+    await browser.elementByCss('[data-react-server-requests-done]')\n \n-    const track = await browser.eval('window.reactServerRequests')\n+    const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n     expect(track).toEqual([\n       { name: 'setTimeout', properties: [] },\n       { name: 'setTimeout', properties: [] },\n@@ -17,9 +18,10 @@ describe('react-performance-track', () => {\n \n   it('should show fetch', async () => {\n     const browser = await next.browser('/fetch')\n+    await browser.elementByCss('[data-react-server-requests-done]')\n \n-    const track = await browser.eval('window.reactServerRequests')\n-    // FIXME: Should show await fetch and await response.json()\n+    const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n+    // FIXME: Should show await fetch\n     expect(track).toEqual([])\n   })\n })"
        }
    ],
    "stats": {
        "total": 119,
        "additions": 104,
        "deletions": 15
    }
}