{
    "author": "wbinnssmith",
    "message": "bundle-analyzer: fix regression and add basic smoke test (#87010)",
    "sha": "8d3cbecb8b8257ed5f5c6c31edd325d1b4974505",
    "files": [
        {
            "sha": "6f148abe0bbbdb529f3a1a3f26c4dfbf695718b1",
            "filename": "packages/next/src/build/turbopack-analyze/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8d3cbecb8b8257ed5f5c6c31edd325d1b4974505/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d3cbecb8b8257ed5f5c6c31edd325d1b4974505/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts?ref=8d3cbecb8b8257ed5f5c6c31edd325d1b4974505",
            "patch": "@@ -1,3 +1,6 @@\n+import type { NextConfigComplete } from '../../server/config-shared'\n+import type { __ApiPreviewProps } from '../../server/api-utils'\n+\n import path from 'path'\n import { validateTurboNextConfig } from '../../lib/turbopack-warning'\n import { isFileSystemCacheEnabledForBuild } from '../../shared/lib/turbopack/utils'\n@@ -6,9 +9,7 @@ import { isCI } from '../../server/ci-info'\n import { backgroundLogCompilationEvents } from '../../shared/lib/turbopack/compilation-events'\n import { getSupportedBrowsers } from '../utils'\n import { normalizePath } from '../../lib/normalize-path'\n-import type { NextConfigComplete } from '../../server/config-shared'\n-import type { __ApiPreviewProps } from '../../server/api-utils'\n-import { PHASE_PRODUCTION_BUILD } from '../../api/constants'\n+import { PHASE_PRODUCTION_BUILD } from '../../shared/lib/constants'\n \n export type AnalyzeContext = {\n   config: NextConfigComplete"
        },
        {
            "sha": "0bd21c5bac776b2207e1e01878c12fde935a2dde",
            "filename": "test/e2e/next-analyze/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8d3cbecb8b8257ed5f5c6c31edd325d1b4974505/test%2Fe2e%2Fnext-analyze%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8d3cbecb8b8257ed5f5c6c31edd325d1b4974505/test%2Fe2e%2Fnext-analyze%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-analyze%2Fapp%2Fpage.tsx?ref=8d3cbecb8b8257ed5f5c6c31edd325d1b4974505",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello World</div>\n+}"
        },
        {
            "sha": "0b21179007069d1c5115aace2f1143a0c31fa910",
            "filename": "test/e2e/next-analyze/next-analyze.test.ts",
            "status": "added",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/vercel/next.js/blob/8d3cbecb8b8257ed5f5c6c31edd325d1b4974505/test%2Fe2e%2Fnext-analyze%2Fnext-analyze.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d3cbecb8b8257ed5f5c6c31edd325d1b4974505/test%2Fe2e%2Fnext-analyze%2Fnext-analyze.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-analyze%2Fnext-analyze.test.ts?ref=8d3cbecb8b8257ed5f5c6c31edd325d1b4974505",
            "patch": "@@ -0,0 +1,103 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { runNextCommand, shouldUseTurbopack } from 'next-test-utils'\n+import path from 'node:path'\n+import { ChildProcess, spawn } from 'node:child_process'\n+\n+describe('next experimental-analyze', () => {\n+  if (!shouldUseTurbopack()) {\n+    it('skips in non-Turbopack tests', () => {})\n+    return\n+  }\n+\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipStart: true,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    it('is skipped', () => {})\n+    return\n+  }\n+\n+  it('runs successfully without errors', async () => {\n+    const { code, stderr } = await runNextCommand(['experimental-analyze'], {\n+      cwd: next.testDir,\n+      stderr: true,\n+    })\n+\n+    expect(code).toBe(0)\n+    expect(stderr).not.toContain('Error')\n+\n+    const nextDir = path.dirname(require.resolve('next/package'))\n+    const nextBin = path.join(nextDir, 'dist/bin/next')\n+\n+    const serveProcess = spawn(\n+      'node',\n+      [nextBin, 'experimental-analyze', '--serve', '--port', '0'],\n+      {\n+        cwd: next.testDir,\n+        stdio: ['ignore', 'pipe', 'pipe'],\n+      }\n+    )\n+\n+    try {\n+      const url = await waitForServer(serveProcess)\n+      const response = await fetch(url)\n+      expect(response.status).toBe(200)\n+      expect(await response.text()).toContain(\n+        '<title>Next.js Bundle Analyzer</title>'\n+      )\n+    } finally {\n+      serveProcess.kill()\n+    }\n+  })\n+})\n+\n+function waitForServer(process: ChildProcess, timeoutMs: number = 30000) {\n+  const serverUrlPromise = new Promise<string>((resolve, reject) => {\n+    const timeout = setTimeout(() => {\n+      process.stdout.off('data', onStdout)\n+      process.off('error', onError)\n+      process.off('exit', onExit)\n+      reject(new Error('Server did not start within timeout'))\n+    }, timeoutMs)\n+\n+    function onStdout(data: Buffer) {\n+      const urlMatch = data.toString().match(/http:\\/\\/[^\\s]+/)\n+      if (urlMatch) {\n+        clearTimeout(timeout)\n+        process.stdout.off('data', onStdout)\n+        process.off('error', onError)\n+        process.off('exit', onExit)\n+        resolve(urlMatch[0])\n+      }\n+    }\n+\n+    function onError(error: Error) {\n+      clearTimeout(timeout)\n+      process.stdout.off('data', onStdout)\n+      process.off('error', onError)\n+      process.off('exit', onExit)\n+      reject(error)\n+    }\n+\n+    function onExit(code: number) {\n+      clearTimeout(timeout)\n+      process.stdout.off('data', onStdout)\n+      process.off('error', onError)\n+      process.off('exit', onExit)\n+      reject(\n+        new Error(\n+          `Server process exited with code ${code} before URL was emitted`\n+        )\n+      )\n+    }\n+\n+    process.stdout.on('data', onStdout)\n+    process.on('error', onError)\n+    process.on('exit', onExit)\n+  })\n+\n+  return serverUrlPromise\n+}"
        },
        {
            "sha": "767719fc4fba59345ae29e29159c9aff270f5819",
            "filename": "test/e2e/next-analyze/next.config.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8d3cbecb8b8257ed5f5c6c31edd325d1b4974505/test%2Fe2e%2Fnext-analyze%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8d3cbecb8b8257ed5f5c6c31edd325d1b4974505/test%2Fe2e%2Fnext-analyze%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-analyze%2Fnext.config.js?ref=8d3cbecb8b8257ed5f5c6c31edd325d1b4974505",
            "patch": "@@ -0,0 +1,4 @@\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 114,
        "deletions": 3
    }
}