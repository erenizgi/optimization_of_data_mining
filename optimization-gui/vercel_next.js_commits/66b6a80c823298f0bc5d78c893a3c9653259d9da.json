{
    "author": "wbinnssmith",
    "message": "Introduce `next analyze`: a built-in bundle analyzer for Turbopack (#85915)\n\nThis implements `next experimental-analyze`, which generates bundle analyzer data without without writing chunks or other artifacts to disk. It also optionally serves the bundle analyzer so it can be browsed easily.\r\n\r\nExamples:\r\n\r\n`next experimental-analyze` - writes analyzer data and UI to `.next/diagnostics/analyze`\r\n`next experimental-analyze --serve` - writes analyzer data and UI as well as serves the files on a static file server on localhost (by default on port 4000)\r\n`next experimental-analyze --serve --port 4001` -- runs the above on port 4001",
    "sha": "66b6a80c823298f0bc5d78c893a3c9653259d9da",
    "files": [
        {
            "sha": "aec9186696ca102c119bd5f09441d1cadca427ac",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -925,5 +925,7 @@\n   \"924\": \"Invalid interception route: %s\",\n   \"925\": \"You cannot define a route with the same specificity as an optional catch-all route (\\\"%s\\\" and \\\"/[[...%s]]\\\").\",\n   \"926\": \"Optional route parameters are not yet supported (\\\"[%s]\\\") in route \\\"%s\\\".\",\n-  \"927\": \"No debug targets found\"\n+  \"927\": \"No debug targets found\",\n+  \"928\": \"Unable to get server address\",\n+  \"929\": \"No pages or app directory found.\"\n }"
        },
        {
            "sha": "33c09c79f1d989d9aaef5c3de1a91b4664f4d26e",
            "filename": "packages/next/package.json",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fpackage.json?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -210,6 +210,7 @@\n     \"@types/react-is\": \"18.2.4\",\n     \"@types/semver\": \"7.3.1\",\n     \"@types/send\": \"0.14.4\",\n+    \"@types/serve-handler\": \"6.1.4\",\n     \"@types/shell-quote\": \"1.7.1\",\n     \"@types/tar\": \"6.1.5\",\n     \"@types/text-table\": \"0.2.1\",\n@@ -315,6 +316,7 @@\n     \"schema-utils3\": \"npm:schema-utils@3.0.0\",\n     \"semver\": \"7.3.2\",\n     \"send\": \"0.18.0\",\n+    \"serve-handler\": \"6.1.6\",\n     \"server-only\": \"0.0.1\",\n     \"setimmediate\": \"1.0.5\",\n     \"shell-quote\": \"1.7.3\","
        },
        {
            "sha": "64454ccd87c16393ed668e8b0748731689d9faae",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -27,6 +27,7 @@ import type { NextTelemetryOptions } from '../cli/next-telemetry.js'\n import type { NextStartOptions } from '../cli/next-start.js'\n import type { NextInfoOptions } from '../cli/next-info.js'\n import type { NextDevOptions } from '../cli/next-dev.js'\n+import type { NextAnalyzeOptions } from '../cli/next-analyze.js'\n import type { NextBuildOptions } from '../cli/next-build.js'\n import type { NextTypegenOptions } from '../cli/next-typegen.js'\n \n@@ -198,6 +199,42 @@ program\n   })\n   .usage('[directory] [options]')\n \n+program\n+  .command('experimental-analyze')\n+  .description(\n+    'Analyze bundle output. Does not produce build artifacts. Only compatible with Turbopack.'\n+  )\n+  .argument(\n+    '[directory]',\n+    `A directory on which to analyze the application. ${italic(\n+      'If no directory is provided, the current directory will be used.'\n+    )}`\n+  )\n+  .option('--no-mangling', 'Disables mangling.')\n+  .option('--profile', 'Enables production profiling for React.')\n+  .option('--serve', 'Serve the bundle analyzer in a browser after analysis.')\n+  .addOption(\n+    new Option(\n+      '--port <port>',\n+      'Specify a port number to serve the analyzer on.'\n+    )\n+      .implies({ serve: true })\n+      .argParser(parseValidPositiveInteger)\n+      .default(4000)\n+      .env('PORT')\n+  )\n+  .action((directory: string, options: NextAnalyzeOptions) => {\n+    return import('../cli/next-analyze.js')\n+      .then((mod) => mod.nextAnalyze(options, directory))\n+      .then(() => {\n+        if (!options.serve) {\n+          // The Next.js process is held open by something on the event loop. Exit manually like the `build` command does.\n+          // TODO: Fix the underlying issue so this is not necessary.\n+          process.exit(0)\n+        }\n+      })\n+  })\n+\n program\n   .command('dev', { isDefault: true })\n   .description("
        },
        {
            "sha": "e9a590fd2bbc9b227c045387f294571610ee0ebf",
            "filename": "packages/next/src/build/analyze/index.ts",
            "status": "added",
            "additions": 249,
            "deletions": 0,
            "changes": 249,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Fanalyze%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Fanalyze%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fanalyze%2Findex.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -0,0 +1,249 @@\n+import type { NextConfigComplete } from '../../server/config-shared'\n+import type { __ApiPreviewProps } from '../../server/api-utils'\n+\n+import { setGlobal } from '../../trace'\n+import * as Log from '../output/log'\n+import * as path from 'node:path'\n+import loadConfig from '../../server/config'\n+import { PHASE_ANALYZE } from '../../shared/lib/constants'\n+import { turbopackAnalyze, type AnalyzeContext } from '../turbopack-analyze'\n+import { durationToString } from '../duration-to-string'\n+import { cp, writeFile, mkdir } from 'node:fs/promises'\n+import {\n+  collectAppFiles,\n+  collectPagesFiles,\n+  createPagesMapping,\n+} from '../entries'\n+import { createValidFileMatcher } from '../../server/lib/find-page-file'\n+import { findPagesDir } from '../../lib/find-pages-dir'\n+import { PAGE_TYPES } from '../../lib/page-types'\n+import loadCustomRoutes from '../../lib/load-custom-routes'\n+import { generateRoutesManifest } from '../generate-routes-manifest'\n+import { checkIsAppPPREnabled } from '../../server/lib/experimental/ppr'\n+import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n+import http from 'node:http'\n+\n+// @ts-expect-error types are in @types/serve-handler\n+import serveHandler from 'next/dist/compiled/serve-handler'\n+import { Telemetry } from '../../telemetry/storage'\n+import { eventAnalyzeCompleted } from '../../telemetry/events'\n+import { traceGlobals } from '../../trace/shared'\n+import type { RoutesManifest } from '..'\n+\n+const ANALYZE_PATH = '.next/diagnostics/analyze'\n+\n+export type AnalyzeOptions = {\n+  dir: string\n+  reactProductionProfiling?: boolean\n+  noMangling?: boolean\n+  appDirOnly?: boolean\n+  serve?: boolean\n+  port?: number\n+}\n+\n+export default async function analyze({\n+  dir,\n+  reactProductionProfiling = false,\n+  noMangling = false,\n+  appDirOnly = false,\n+  serve = false,\n+  port = 4000,\n+}: AnalyzeOptions): Promise<void> {\n+  try {\n+    const config: NextConfigComplete = await loadConfig(PHASE_ANALYZE, dir, {\n+      silent: false,\n+      reactProductionProfiling,\n+    })\n+\n+    process.env.NEXT_DEPLOYMENT_ID = config.deploymentId || ''\n+\n+    const distDir = path.join(dir, '.next')\n+    const telemetry = new Telemetry({ distDir })\n+    setGlobal('phase', PHASE_ANALYZE)\n+    setGlobal('distDir', distDir)\n+    setGlobal('telemetry', telemetry)\n+\n+    Log.info('Analyzing a production build...')\n+\n+    const analyzeContext: AnalyzeContext = {\n+      config,\n+      dir,\n+      distDir,\n+      noMangling,\n+      appDirOnly,\n+    }\n+\n+    const { duration: analyzeDuration, shutdownPromise } =\n+      await turbopackAnalyze(analyzeContext)\n+\n+    const durationString = durationToString(analyzeDuration)\n+    Log.event(\n+      `Analyze data created successfully in ${durationString}. To explore it, run \\`next experimental-analyze --serve\\`.`\n+    )\n+\n+    await shutdownPromise\n+\n+    await cp(\n+      path.join(__dirname, '../../bundle-analyzer'),\n+      path.join(dir, ANALYZE_PATH),\n+      { recursive: true }\n+    )\n+\n+    // Collect and write routes for the bundle analyzer\n+    const routes = await collectRoutesForAnalyze(dir, config, appDirOnly)\n+\n+    await mkdir(path.join(dir, ANALYZE_PATH, 'data'), { recursive: true })\n+    await writeFile(\n+      path.join(dir, ANALYZE_PATH, 'data', 'routes.json'),\n+      JSON.stringify(routes, null, 2)\n+    )\n+\n+    telemetry.record(\n+      eventAnalyzeCompleted({\n+        success: true,\n+        durationInSeconds: Math.round(analyzeDuration),\n+        totalPageCount: routes.length,\n+      })\n+    )\n+\n+    if (serve) {\n+      await startServer(path.join(dir, ANALYZE_PATH), port)\n+    }\n+  } catch (e) {\n+    const telemetry = traceGlobals.get('telemetry') as Telemetry | undefined\n+    if (telemetry) {\n+      telemetry.record(\n+        eventAnalyzeCompleted({\n+          success: false,\n+        })\n+      )\n+    }\n+\n+    throw e\n+  }\n+}\n+\n+/**\n+ * Collects all routes from the project for the bundle analyzer.\n+ * Returns a list of route paths (both static and dynamic).\n+ */\n+async function collectRoutesForAnalyze(\n+  dir: string,\n+  config: NextConfigComplete,\n+  appDirOnly: boolean\n+): Promise<string[]> {\n+  const { pagesDir, appDir } = findPagesDir(dir)\n+  const validFileMatcher = createValidFileMatcher(config.pageExtensions, appDir)\n+\n+  let appType: RoutesManifest['appType']\n+  if (pagesDir && appDir) {\n+    appType = 'hybrid'\n+  } else if (pagesDir) {\n+    appType = 'pages'\n+  } else if (appDir) {\n+    appType = 'app'\n+  } else {\n+    throw new Error('No pages or app directory found.')\n+  }\n+\n+  const { appPaths } = appDir\n+    ? await collectAppFiles(appDir, validFileMatcher)\n+    : { appPaths: [] }\n+  const pagesPaths = pagesDir\n+    ? await collectPagesFiles(pagesDir, validFileMatcher)\n+    : null\n+\n+  const appMapping = await createPagesMapping({\n+    pagePaths: appPaths,\n+    isDev: false,\n+    pagesType: PAGE_TYPES.APP,\n+    pageExtensions: config.pageExtensions,\n+    pagesDir,\n+    appDir,\n+    appDirOnly,\n+  })\n+\n+  const pagesMapping = pagesPaths\n+    ? await createPagesMapping({\n+        pagePaths: pagesPaths,\n+        isDev: false,\n+        pagesType: PAGE_TYPES.PAGES,\n+        pageExtensions: config.pageExtensions,\n+        pagesDir,\n+        appDir,\n+        appDirOnly,\n+      })\n+    : null\n+\n+  const pageKeys = {\n+    pages: pagesMapping ? Object.keys(pagesMapping) : [],\n+    app: appMapping\n+      ? Object.keys(appMapping).map((key) => normalizeAppPath(key))\n+      : undefined,\n+  }\n+\n+  // Load custom routes\n+  const { redirects, headers, rewrites } = await loadCustomRoutes(config)\n+\n+  // Compute restricted redirect paths\n+  const restrictedRedirectPaths = ['/_next'].map((pathPrefix) =>\n+    config.basePath ? `${config.basePath}${pathPrefix}` : pathPrefix\n+  )\n+\n+  const isAppPPREnabled = checkIsAppPPREnabled(config.experimental.ppr)\n+\n+  // Generate routes manifest\n+  const { routesManifest } = generateRoutesManifest({\n+    appType,\n+    pageKeys,\n+    config,\n+    redirects,\n+    headers,\n+    rewrites,\n+    restrictedRedirectPaths,\n+    isAppPPREnabled,\n+  })\n+\n+  return routesManifest.dynamicRoutes\n+    .map((r) => r.page)\n+    .concat(routesManifest.staticRoutes.map((r) => r.page))\n+}\n+\n+function startServer(dir: string, port: number): Promise<void> {\n+  const server = http.createServer((req, res) => {\n+    return serveHandler(req, res, {\n+      public: dir,\n+    })\n+  })\n+\n+  return new Promise((resolve, reject) => {\n+    function onError(err: Error) {\n+      server.close(() => {\n+        reject(err)\n+      })\n+    }\n+\n+    server.on('error', onError)\n+\n+    server.listen(port, 'localhost', () => {\n+      const address = server.address()\n+      if (address == null) {\n+        reject(new Error('Unable to get server address'))\n+        return\n+      }\n+\n+      // No longer needed after startup\n+      server.removeListener('error', onError)\n+\n+      let addressString\n+      if (typeof address === 'string') {\n+        addressString = address\n+      } else {\n+        addressString = `${address.address === '::' ? 'localhost' : address.address}:${address.port}`\n+      }\n+\n+      Log.info(`Bundle analyzer available at http://${addressString}`)\n+      resolve()\n+    })\n+  })\n+}"
        },
        {
            "sha": "a863cc1e276956f6b12806d973cfd29bc633eb6e",
            "filename": "packages/next/src/build/generate-routes-manifest.ts",
            "status": "added",
            "additions": 155,
            "deletions": 0,
            "changes": 155,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Fgenerate-routes-manifest.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Fgenerate-routes-manifest.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fgenerate-routes-manifest.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -0,0 +1,155 @@\n+import type { NextConfigComplete } from '../server/config-shared'\n+import type { CustomRoutes } from '../lib/load-custom-routes'\n+import {\n+  RSC_HEADER,\n+  NEXT_ROUTER_STATE_TREE_HEADER,\n+  NEXT_ROUTER_PREFETCH_HEADER,\n+  NEXT_DID_POSTPONE_HEADER,\n+  RSC_CONTENT_TYPE_HEADER,\n+  NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n+  NEXT_REWRITTEN_PATH_HEADER,\n+  NEXT_REWRITTEN_QUERY_HEADER,\n+} from '../client/components/app-router-headers'\n+import {\n+  RSC_SUFFIX,\n+  RSC_PREFETCH_SUFFIX,\n+  RSC_SEGMENT_SUFFIX,\n+  RSC_SEGMENTS_DIR_SUFFIX,\n+  NEXT_RESUME_HEADER,\n+} from '../lib/constants'\n+import { isDynamicRoute } from '../shared/lib/router/utils'\n+import { buildCustomRoute } from '../lib/build-custom-route'\n+import { isReservedPage, pageToRoute } from './utils'\n+import type { DynamicManifestRoute } from './utils'\n+import type { RoutesManifest, ManifestRoute } from './index'\n+import { sortPages } from '../shared/lib/router/utils/sortable-routes'\n+\n+export interface GenerateRoutesManifestOptions {\n+  pageKeys: {\n+    pages: string[]\n+    app?: string[]\n+  }\n+  config: NextConfigComplete\n+  redirects: CustomRoutes['redirects']\n+  headers: CustomRoutes['headers']\n+  rewrites: CustomRoutes['rewrites']\n+  restrictedRedirectPaths: string[]\n+  isAppPPREnabled: boolean\n+  appType: 'pages' | 'app' | 'hybrid'\n+}\n+\n+export interface GenerateRoutesManifestResult {\n+  routesManifest: RoutesManifest\n+  dynamicRoutes: Array<DynamicManifestRoute>\n+  sourcePages: Map<string, string>\n+}\n+\n+/**\n+ * Generates the routes manifest from the given page keys and configuration.\n+ * This function extracts the route manifest generation logic to be reusable\n+ * across different build contexts (webpack build, turbopack build, analyze, etc.)\n+ */\n+export function generateRoutesManifest(\n+  options: GenerateRoutesManifestOptions\n+): GenerateRoutesManifestResult {\n+  const {\n+    pageKeys,\n+    config,\n+    redirects,\n+    headers,\n+    rewrites,\n+    restrictedRedirectPaths,\n+    isAppPPREnabled,\n+    appType,\n+  } = options\n+\n+  const sortedRoutes = sortPages([...pageKeys.pages, ...(pageKeys.app ?? [])])\n+  const staticRoutes: Array<ManifestRoute> = []\n+  const dynamicRoutes: Array<DynamicManifestRoute> = []\n+\n+  /**\n+   * A map of all the pages to their sourcePage value. This is only used for\n+   * routes that have PPR enabled and clientSegmentEnabled is true.\n+   */\n+  const sourcePages = new Map<string, string>()\n+\n+  for (const route of sortedRoutes) {\n+    if (isDynamicRoute(route)) {\n+      dynamicRoutes.push(\n+        pageToRoute(\n+          route,\n+          // This property is only relevant when PPR is enabled.\n+          undefined\n+        )\n+      )\n+    } else if (\n+      !isReservedPage(route) ||\n+      // don't consider /api reserved here\n+      route.match(/^\\/(api(\\/|$))/)\n+    ) {\n+      staticRoutes.push(pageToRoute(route))\n+    }\n+  }\n+\n+  const routesManifest: RoutesManifest = {\n+    version: 3,\n+    pages404: true,\n+    appType,\n+    caseSensitive: !!config.experimental.caseSensitiveRoutes,\n+    basePath: config.basePath,\n+    redirects: redirects.map((r) =>\n+      buildCustomRoute('redirect', r, restrictedRedirectPaths)\n+    ),\n+    headers: headers.map((r) => buildCustomRoute('header', r)),\n+    rewrites: {\n+      beforeFiles: rewrites.beforeFiles.map((r) =>\n+        buildCustomRoute('rewrite', r)\n+      ),\n+      afterFiles: rewrites.afterFiles.map((r) =>\n+        buildCustomRoute('rewrite', r)\n+      ),\n+      fallback: rewrites.fallback.map((r) => buildCustomRoute('rewrite', r)),\n+    },\n+    dynamicRoutes,\n+    staticRoutes,\n+    dataRoutes: [],\n+    i18n: config.i18n || undefined,\n+    rsc: {\n+      header: RSC_HEADER,\n+      // This vary header is used as a default. It is technically re-assigned in `base-server`,\n+      // and may include an additional Vary option for `Next-URL`.\n+      varyHeader: `${RSC_HEADER}, ${NEXT_ROUTER_STATE_TREE_HEADER}, ${NEXT_ROUTER_PREFETCH_HEADER}, ${NEXT_ROUTER_SEGMENT_PREFETCH_HEADER}`,\n+      prefetchHeader: NEXT_ROUTER_PREFETCH_HEADER,\n+      didPostponeHeader: NEXT_DID_POSTPONE_HEADER,\n+      contentTypeHeader: RSC_CONTENT_TYPE_HEADER,\n+      suffix: RSC_SUFFIX,\n+      prefetchSuffix: RSC_PREFETCH_SUFFIX,\n+      prefetchSegmentHeader: NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n+      prefetchSegmentSuffix: RSC_SEGMENT_SUFFIX,\n+      prefetchSegmentDirSuffix: RSC_SEGMENTS_DIR_SUFFIX,\n+      clientParamParsing: config.cacheComponents ?? false,\n+      clientParamParsingOrigins: config.experimental.clientParamParsingOrigins,\n+      dynamicRSCPrerender: isAppPPREnabled && config.cacheComponents === true,\n+    },\n+    rewriteHeaders: {\n+      pathHeader: NEXT_REWRITTEN_PATH_HEADER,\n+      queryHeader: NEXT_REWRITTEN_QUERY_HEADER,\n+    },\n+    skipProxyUrlNormalize: config.skipProxyUrlNormalize,\n+    ppr: isAppPPREnabled\n+      ? {\n+          chain: {\n+            headers: {\n+              [NEXT_RESUME_HEADER]: '1',\n+            },\n+          },\n+        }\n+      : undefined,\n+  }\n+\n+  return {\n+    routesManifest,\n+    dynamicRoutes,\n+    sourcePages,\n+  }\n+}"
        },
        {
            "sha": "156d92ae1ac295da5a65c77661a8545778746d7b",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 149,
            "changes": 174,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -26,14 +26,13 @@ import {\n   INSTRUMENTATION_HOOK_FILENAME,\n   RSC_PREFETCH_SUFFIX,\n   RSC_SUFFIX,\n-  NEXT_RESUME_HEADER,\n   PRERENDER_REVALIDATE_HEADER,\n   PRERENDER_REVALIDATE_ONLY_GENERATED_HEADER,\n   NEXT_CACHE_REVALIDATE_TAG_TOKEN_HEADER,\n   NEXT_CACHE_REVALIDATED_TAGS_HEADER,\n   MATCHED_PATH_HEADER,\n-  RSC_SEGMENTS_DIR_SUFFIX,\n-  RSC_SEGMENT_SUFFIX,\n+  type RSC_SEGMENTS_DIR_SUFFIX,\n+  type RSC_SEGMENT_SUFFIX,\n } from '../lib/constants'\n import { FileType, fileExists } from '../lib/file-exists'\n import { findPagesDir } from '../lib/find-pages-dir'\n@@ -140,8 +139,9 @@ import {\n   collectRoutesUsingEdgeRuntime,\n   collectMeta,\n   isProxyFile,\n+  pageToRoute,\n } from './utils'\n-import type { PageInfo, PageInfos } from './utils'\n+import type { DynamicManifestRoute, PageInfo, PageInfos } from './utils'\n import type { FallbackRouteParam, PrerenderedRoute } from './static-paths/types'\n import type { AppSegmentConfig } from './segment-config/app/app-segment-config'\n import { writeBuildId } from './write-build-id'\n@@ -158,14 +158,13 @@ import { eventSwcPlugins } from '../telemetry/events/swc-plugins'\n import { normalizeAppPath } from '../shared/lib/router/utils/app-paths'\n import {\n   ACTION_HEADER,\n-  NEXT_ROUTER_PREFETCH_HEADER,\n-  RSC_HEADER,\n-  RSC_CONTENT_TYPE_HEADER,\n-  NEXT_ROUTER_STATE_TREE_HEADER,\n-  NEXT_DID_POSTPONE_HEADER,\n-  NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n-  NEXT_REWRITTEN_PATH_HEADER,\n-  NEXT_REWRITTEN_QUERY_HEADER,\n+  type NEXT_ROUTER_PREFETCH_HEADER,\n+  type RSC_HEADER,\n+  type RSC_CONTENT_TYPE_HEADER,\n+  type NEXT_DID_POSTPONE_HEADER,\n+  type NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n+  type NEXT_REWRITTEN_PATH_HEADER,\n+  type NEXT_REWRITTEN_QUERY_HEADER,\n } from '../client/components/app-router-headers'\n import { webpackBuild } from './webpack-build'\n import { NextBuildContext, type MappedPages } from './build-context'\n@@ -188,7 +187,6 @@ import {\n import { getStartServerInfo, logStartInfo } from '../server/lib/app-info-log'\n import type { NextEnabledDirectories } from '../server/base-server'\n import { hasCustomExportOutput } from '../export/utils'\n-import { buildCustomRoute } from '../lib/build-custom-route'\n import { traceMemoryUsage } from '../lib/memory/trace'\n import { generateEncryptionKeyBase64 } from '../server/app-render/encryption-utils-server'\n import type { DeepReadonly } from '../shared/lib/deep-readonly'\n@@ -231,6 +229,7 @@ import {\n } from '../server/lib/router-utils/route-types-utils'\n import { Lockfile } from './lockfile'\n import { validateAppPaths } from './validate-app-paths'\n+import { generateRoutesManifest } from './generate-routes-manifest'\n \n type Fallback = null | boolean | string\n \n@@ -417,15 +416,6 @@ export type ManifestRoute = ManifestBuiltRoute & {\n   skipInternalRouting?: boolean\n }\n \n-type DynamicManifestRoute = ManifestRoute & {\n-  /**\n-   * The source page that this route is based on. This is used to determine the\n-   * source page for the route and is only relevant for app pages where PPR is\n-   * enabled and the page differs from the source page.\n-   */\n-  sourcePage: string | undefined\n-}\n-\n type ManifestDataRoute = {\n   page: string\n   routeKeys?: { [key: string]: string }\n@@ -508,42 +498,6 @@ export type RoutesManifest = {\n   }\n }\n \n-/**\n- * Converts a page to a manifest route.\n- *\n- * @param page The page to convert to a route.\n- * @returns A route object.\n- */\n-function pageToRoute(page: string): ManifestRoute\n-/**\n- * Converts a page to a dynamic manifest route.\n- *\n- * @param page The page to convert to a route.\n- * @param sourcePage The source page that this route is based on. This is used\n- * to determine the source page for the route and is only relevant for app\n- * pages when PPR is enabled on them.\n- * @returns A route object.\n- */\n-function pageToRoute(\n-  page: string,\n-  sourcePage: string | undefined\n-): DynamicManifestRoute\n-function pageToRoute(\n-  page: string,\n-  sourcePage?: string\n-): DynamicManifestRoute | ManifestRoute {\n-  const routeRegex = getNamedRouteRegex(page, {\n-    prefixRouteKeys: true,\n-  })\n-  return {\n-    sourcePage,\n-    page,\n-    regex: normalizeRouteRegex(routeRegex.re.source),\n-    routeKeys: routeRegex.routeKeys,\n-    namedRegex: routeRegex.namedRegex,\n-  }\n-}\n-\n function getCacheDir(distDir: string): string {\n   const cacheDir = path.join(distDir, 'cache')\n   if (ciEnvironment.isCI && !ciEnvironment.hasNextSupport) {\n@@ -1605,100 +1559,22 @@ export default async function build(\n       const isAppPPREnabled = checkIsAppPPREnabled(config.experimental.ppr)\n \n       const routesManifestPath = path.join(distDir, ROUTES_MANIFEST)\n-      const dynamicRoutes: Array<DynamicManifestRoute> = []\n \n-      /**\n-       * A map of all the pages to their sourcePage value. This is only used for\n-       * routes that have PPR enabled and clientSegmentEnabled is true.\n-       */\n-      const sourcePages = new Map<string, string>()\n-      const routesManifest: RoutesManifest = nextBuildSpan\n+      // Generate the routes manifest using the extracted helper\n+      const { routesManifest, dynamicRoutes, sourcePages } = nextBuildSpan\n         .traceChild('generate-routes-manifest')\n-        .traceFn(() => {\n-          const sortedRoutes = sortPages([\n-            ...pageKeys.pages,\n-            ...(pageKeys.app ?? []),\n-          ])\n-          const staticRoutes: Array<ManifestRoute> = []\n-\n-          for (const route of sortedRoutes) {\n-            if (isDynamicRoute(route)) {\n-              dynamicRoutes.push(\n-                pageToRoute(\n-                  route,\n-                  // This property is only relevant when PPR is enabled.\n-                  undefined\n-                )\n-              )\n-            } else if (\n-              !isReservedPage(route) ||\n-              // don't consider /api reserved here\n-              route.match(/^\\/(api(\\/|$))/)\n-            ) {\n-              staticRoutes.push(pageToRoute(route))\n-            }\n-          }\n-\n-          return {\n-            version: 3,\n-            pages404: true,\n+        .traceFn(() =>\n+          generateRoutesManifest({\n             appType,\n-            caseSensitive: !!config.experimental.caseSensitiveRoutes,\n-            basePath: config.basePath,\n-            redirects: redirects.map((r) =>\n-              buildCustomRoute('redirect', r, restrictedRedirectPaths)\n-            ),\n-            headers: headers.map((r) => buildCustomRoute('header', r)),\n-            rewrites: {\n-              beforeFiles: rewrites.beforeFiles.map((r) =>\n-                buildCustomRoute('rewrite', r)\n-              ),\n-              afterFiles: rewrites.afterFiles.map((r) =>\n-                buildCustomRoute('rewrite', r)\n-              ),\n-              fallback: rewrites.fallback.map((r) =>\n-                buildCustomRoute('rewrite', r)\n-              ),\n-            },\n-            dynamicRoutes,\n-            staticRoutes,\n-            dataRoutes: [],\n-            i18n: config.i18n || undefined,\n-            rsc: {\n-              header: RSC_HEADER,\n-              // This vary header is used as a default. It is technically re-assigned in `base-server`,\n-              // and may include an additional Vary option for `Next-URL`.\n-              varyHeader: `${RSC_HEADER}, ${NEXT_ROUTER_STATE_TREE_HEADER}, ${NEXT_ROUTER_PREFETCH_HEADER}, ${NEXT_ROUTER_SEGMENT_PREFETCH_HEADER}`,\n-              prefetchHeader: NEXT_ROUTER_PREFETCH_HEADER,\n-              didPostponeHeader: NEXT_DID_POSTPONE_HEADER,\n-              contentTypeHeader: RSC_CONTENT_TYPE_HEADER,\n-              suffix: RSC_SUFFIX,\n-              prefetchSuffix: RSC_PREFETCH_SUFFIX,\n-              prefetchSegmentHeader: NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n-              prefetchSegmentSuffix: RSC_SEGMENT_SUFFIX,\n-              prefetchSegmentDirSuffix: RSC_SEGMENTS_DIR_SUFFIX,\n-              clientParamParsing: config.cacheComponents ?? false,\n-              clientParamParsingOrigins:\n-                config.experimental.clientParamParsingOrigins,\n-              dynamicRSCPrerender:\n-                isAppPPREnabled && config.cacheComponents === true,\n-            },\n-            rewriteHeaders: {\n-              pathHeader: NEXT_REWRITTEN_PATH_HEADER,\n-              queryHeader: NEXT_REWRITTEN_QUERY_HEADER,\n-            },\n-            skipProxyUrlNormalize: config.skipProxyUrlNormalize,\n-            ppr: isAppPPREnabled\n-              ? {\n-                  chain: {\n-                    headers: {\n-                      [NEXT_RESUME_HEADER]: '1',\n-                    },\n-                  },\n-                }\n-              : undefined,\n-          } satisfies RoutesManifest\n-        })\n+            pageKeys,\n+            config,\n+            redirects,\n+            headers,\n+            rewrites,\n+            restrictedRedirectPaths,\n+            isAppPPREnabled,\n+          })\n+        )\n \n       // For pages directory, we run type checking after route collection but before build.\n       if (!appDir && !isCompileMode) {"
        },
        {
            "sha": "4695ab4a9e760d91fbb038d9db59f47ddc62a81f",
            "filename": "packages/next/src/build/turbopack-analyze/index.ts",
            "status": "added",
            "additions": 112,
            "deletions": 0,
            "changes": 112,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-analyze%2Findex.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -0,0 +1,112 @@\n+import path from 'path'\n+import { validateTurboNextConfig } from '../../lib/turbopack-warning'\n+import { isFileSystemCacheEnabledForBuild } from '../../shared/lib/turbopack/utils'\n+import { createDefineEnv, loadBindings } from '../swc'\n+import { isCI } from '../../server/ci-info'\n+import { backgroundLogCompilationEvents } from '../../shared/lib/turbopack/compilation-events'\n+import { getSupportedBrowsers } from '../utils'\n+import { normalizePath } from '../../lib/normalize-path'\n+import type { NextConfigComplete } from '../../server/config-shared'\n+import type { __ApiPreviewProps } from '../../server/api-utils'\n+\n+export type AnalyzeContext = {\n+  config: NextConfigComplete\n+  distDir: string\n+  dir: string\n+  noMangling: boolean\n+  appDirOnly: boolean\n+}\n+\n+export async function turbopackAnalyze(\n+  analyzeContext: AnalyzeContext\n+): Promise<{\n+  duration: number\n+  shutdownPromise: Promise<void>\n+}> {\n+  await validateTurboNextConfig({\n+    dir: analyzeContext.dir,\n+    isDev: false,\n+  })\n+\n+  const { config, dir, distDir, noMangling } = analyzeContext\n+  const currentNodeJsVersion = process.versions.node\n+\n+  const startTime = process.hrtime()\n+  const bindings = await loadBindings(config?.experimental?.useWasmBinary)\n+  const dev = false\n+\n+  const supportedBrowsers = getSupportedBrowsers(dir, dev)\n+\n+  const persistentCaching = isFileSystemCacheEnabledForBuild(config)\n+  const rootPath = config.turbopack?.root || config.outputFileTracingRoot || dir\n+  const project = await bindings.turbo.createProject(\n+    {\n+      rootPath: config.turbopack?.root || config.outputFileTracingRoot || dir,\n+      projectPath: normalizePath(path.relative(rootPath, dir) || '.'),\n+      distDir,\n+      nextConfig: config,\n+      watch: {\n+        enable: false,\n+      },\n+      dev,\n+      env: process.env as Record<string, string>,\n+      defineEnv: createDefineEnv({\n+        isTurbopack: true,\n+        config,\n+        dev,\n+        distDir,\n+        projectPath: dir,\n+        fetchCacheKeyPrefix: config.experimental.fetchCacheKeyPrefix,\n+        hasRewrites: false,\n+        // Implemented separately in Turbopack, doesn't have to be passed here.\n+        middlewareMatchers: undefined,\n+        rewrites: {\n+          beforeFiles: [],\n+          afterFiles: [],\n+          fallback: [],\n+        },\n+      }),\n+      buildId: 'analyze-build',\n+      encryptionKey: '',\n+      previewProps: {\n+        previewModeId: '',\n+        previewModeEncryptionKey: '',\n+        previewModeSigningKey: '',\n+      },\n+      browserslistQuery: supportedBrowsers.join(', '),\n+      noMangling,\n+      currentNodeJsVersion,\n+    },\n+    {\n+      persistentCaching,\n+      memoryLimit: config.experimental?.turbopackMemoryLimit,\n+      dependencyTracking: persistentCaching,\n+      isCi: isCI,\n+      isShortSession: true,\n+    }\n+  )\n+\n+  try {\n+    backgroundLogCompilationEvents(project)\n+\n+    await project.writeAnalyzeData(analyzeContext.appDirOnly)\n+\n+    const shutdownPromise = project.shutdown()\n+\n+    const time = process.hrtime(startTime)\n+    return {\n+      duration: time[0] + time[1] / 1e9,\n+      shutdownPromise,\n+    }\n+  } catch (err) {\n+    await project.shutdown()\n+    throw err\n+  }\n+}\n+\n+let shutdownPromise: Promise<void> | undefined\n+export async function waitForShutdown(): Promise<void> {\n+  if (shutdownPromise) {\n+    await shutdownPromise\n+  }\n+}"
        },
        {
            "sha": "b02db3628939c60ae168c7883a1f98b3508ef4a3",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 6,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -4,11 +4,12 @@ import { checkIsRoutePPREnabled } from '../server/lib/experimental/ppr'\n import type { AssetBinding } from './webpack/loaders/get-module-build-info'\n import type { ServerRuntime } from '../types'\n import type { BuildManifest } from '../server/get-page-files'\n-import type {\n-  CustomRoutes,\n-  Header,\n-  Redirect,\n-  Rewrite,\n+import {\n+  normalizeRouteRegex,\n+  type CustomRoutes,\n+  type Header,\n+  type Redirect,\n+  type Rewrite,\n } from '../lib/load-custom-routes'\n import type {\n   EdgeFunctionDefinition,\n@@ -75,10 +76,20 @@ import { formatExpire, formatRevalidate } from './output/format'\n import type { AppRouteRouteModule } from '../server/route-modules/app-route/module'\n import { formatIssue, isRelevantWarning } from '../shared/lib/turbopack/utils'\n import type { TurbopackResult } from './swc/types'\n-import type { FunctionsConfigManifest } from './index'\n+import type { FunctionsConfigManifest, ManifestRoute } from './index'\n+import { getNamedRouteRegex } from '../shared/lib/router/utils/route-regex'\n \n export type ROUTER_TYPE = 'pages' | 'app'\n \n+export type DynamicManifestRoute = ManifestRoute & {\n+  /**\n+   * The source page that this route is based on. This is used to determine the\n+   * source page for the route and is only relevant for app pages where PPR is\n+   * enabled and the page differs from the source page.\n+   */\n+  sourcePage: string | undefined\n+}\n+\n // Use `print()` for expected console output\n const print = console.log\n \n@@ -1599,3 +1610,39 @@ export function collectMeta({\n export const RSPACK_DEFAULT_LAYERS_REGEX = new RegExp(\n   `^(|${[WEBPACK_LAYERS.pagesDirBrowser, WEBPACK_LAYERS.pagesDirEdge, WEBPACK_LAYERS.pagesDirNode].join('|')})$`\n )\n+\n+/**\n+ * Converts a page to a manifest route.\n+ *\n+ * @param page The page to convert to a route.\n+ * @returns A route object.\n+ */\n+export function pageToRoute(page: string): ManifestRoute\n+/**\n+ * Converts a page to a dynamic manifest route.\n+ *\n+ * @param page The page to convert to a route.\n+ * @param sourcePage The source page that this route is based on. This is used\n+ * to determine the source page for the route and is only relevant for app\n+ * pages when PPR is enabled on them.\n+ * @returns A route object.\n+ */\n+export function pageToRoute(\n+  page: string,\n+  sourcePage: string | undefined\n+): DynamicManifestRoute\n+export function pageToRoute(\n+  page: string,\n+  sourcePage?: string\n+): DynamicManifestRoute | ManifestRoute {\n+  const routeRegex = getNamedRouteRegex(page, {\n+    prefixRouteKeys: true,\n+  })\n+  return {\n+    sourcePage,\n+    page,\n+    regex: normalizeRouteRegex(routeRegex.re.source),\n+    routeKeys: routeRegex.routeKeys,\n+    namedRegex: routeRegex.namedRegex,\n+  }\n+}"
        },
        {
            "sha": "925efc5d5c8fc89b699b5e5682ea83c2f9268a4b",
            "filename": "packages/next/src/cli/next-analyze.ts",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -0,0 +1,54 @@\n+#!/usr/bin/env node\n+\n+import '../server/lib/cpu-profile'\n+import { existsSync } from 'fs'\n+import { italic } from '../lib/picocolors'\n+import analyze from '../build/analyze'\n+import { warn } from '../build/output/log'\n+import { printAndExit } from '../server/lib/utils'\n+import { getProjectDir } from '../lib/get-project-dir'\n+\n+export type NextAnalyzeOptions = {\n+  experimentalAnalyze?: boolean\n+  profile?: boolean\n+  mangling: boolean\n+  port: number\n+  serve: boolean\n+  experimentalAppOnly?: boolean\n+}\n+\n+const nextAnalyze = async (options: NextAnalyzeOptions, directory?: string) => {\n+  process.on('SIGTERM', () => process.exit(143))\n+  process.on('SIGINT', () => process.exit(130))\n+\n+  const { profile, mangling, experimentalAppOnly, serve, port } = options\n+\n+  if (!mangling) {\n+    warn(\n+      `Mangling is disabled. ${italic('Note: This may affect performance and should only be used for debugging purposes.')}`\n+    )\n+  }\n+\n+  if (profile) {\n+    warn(\n+      `Profiling is enabled. ${italic('Note: This may affect performance.')}`\n+    )\n+  }\n+\n+  const dir = getProjectDir(directory)\n+\n+  if (!existsSync(dir)) {\n+    printAndExit(`> No such directory exists as the project root: ${dir}`)\n+  }\n+\n+  return analyze({\n+    dir,\n+    reactProductionProfiling: profile,\n+    noMangling: !mangling,\n+    appDirOnly: experimentalAppOnly,\n+    serve,\n+    port,\n+  })\n+}\n+\n+export { nextAnalyze }"
        },
        {
            "sha": "6fc3b93315019167fd0a9457fd8da2890d444a38",
            "filename": "packages/next/src/compiled/serve-handler/LICENSE",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2FLICENSE",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2FLICENSE",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2FLICENSE?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -0,0 +1,21 @@\n+MIT License\n+\n+Copyright (c) 2018 ZEIT, Inc.\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy\n+of this software and associated documentation files (the \"Software\"), to deal\n+in the Software without restriction, including without limitation the rights\n+to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+copies of the Software, and to permit persons to whom the Software is\n+furnished to do so, subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all\n+copies or substantial portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+SOFTWARE."
        },
        {
            "sha": "b56ceb2318d52a82bbfa3df4e61cf9d1cca9bc62",
            "filename": "packages/next/src/compiled/serve-handler/index.js",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2Findex.js?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da"
        },
        {
            "sha": "f22d724719ca7395e835faa72f4180ef7e5d6cff",
            "filename": "packages/next/src/compiled/serve-handler/package.json",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fserve-handler%2Fpackage.json?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -0,0 +1 @@\n+{\"name\":\"serve-handler\",\"main\":\"index.js\",\"author\":\"leo\",\"license\":\"MIT\"}"
        },
        {
            "sha": "b6c2d7771fddcc5c4e145fd85e19454ecd1f7c30",
            "filename": "packages/next/src/shared/lib/constants.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -68,6 +68,7 @@ export enum AdapterOutputType {\n }\n \n export const PHASE_EXPORT = 'phase-export'\n+export const PHASE_ANALYZE = 'phase-analyze'\n export const PHASE_PRODUCTION_BUILD = 'phase-production-build'\n export const PHASE_PRODUCTION_SERVER = 'phase-production-server'\n export const PHASE_DEVELOPMENT_SERVER = 'phase-development-server'\n@@ -78,6 +79,7 @@ export type PHASE_TYPE =\n   | typeof PHASE_INFO\n   | typeof PHASE_TEST\n   | typeof PHASE_EXPORT\n+  | typeof PHASE_ANALYZE\n   | typeof PHASE_PRODUCTION_BUILD\n   | typeof PHASE_PRODUCTION_SERVER\n   | typeof PHASE_DEVELOPMENT_SERVER"
        },
        {
            "sha": "345e078c01103bef7e9b46e762506da127b8379e",
            "filename": "packages/next/src/telemetry/events/build.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -52,6 +52,27 @@ export function eventLintCheckCompleted(event: EventLintCheckCompleted): {\n   }\n }\n \n+const EVENT_ANALYZE_COMPLETED = 'NEXT_ANALYZE_COMPLETED'\n+type AnalyzeEventCompleted =\n+  | {\n+      durationInSeconds: number\n+      success: true\n+      totalPageCount: number\n+    }\n+  | {\n+      success: false\n+    }\n+\n+export function eventAnalyzeCompleted(event: AnalyzeEventCompleted): {\n+  eventName: string\n+  payload: AnalyzeEventCompleted\n+} {\n+  return {\n+    eventName: EVENT_ANALYZE_COMPLETED,\n+    payload: event,\n+  }\n+}\n+\n const EVENT_BUILD_COMPLETED = 'NEXT_BUILD_COMPLETED'\n type EventBuildCompleted = {\n   bundler: 'webpack' | 'rspack' | 'turbopack'"
        },
        {
            "sha": "18844912ab55ef9e4b9348fb4ba93713533dc152",
            "filename": "packages/next/taskfile.js",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Ftaskfile.js",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/packages%2Fnext%2Ftaskfile.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile.js?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -1869,6 +1869,13 @@ export async function ncc_source_map08(task, opts) {\n     })\n     .target('src/compiled/source-map08')\n }\n+externals['serve-handler'] = 'next/dist/compiled/serve-handler'\n+export async function ncc_serve_handler(task, opts) {\n+  await task\n+    .source(relative(__dirname, require.resolve('serve-handler')))\n+    .ncc({ packageName: 'serve-handler', externals })\n+    .target('src/compiled/serve-handler')\n+}\n externals['string-hash'] = 'next/dist/compiled/string-hash'\n export async function ncc_string_hash(task, opts) {\n   await task\n@@ -2286,6 +2293,7 @@ export async function ncc(task, opts) {\n         'ncc_send',\n         'ncc_source_map',\n         'ncc_source_map08',\n+        'ncc_serve_handler',\n         'ncc_string_hash',\n         'ncc_strip_ansi',\n         'ncc_superstruct',"
        },
        {
            "sha": "1e837ece7dbf5b8cede74df8054f24ea250eb57d",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 26,
            "deletions": 9,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/66b6a80c823298f0bc5d78c893a3c9653259d9da/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/66b6a80c823298f0bc5d78c893a3c9653259d9da/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=66b6a80c823298f0bc5d78c893a3c9653259d9da",
            "patch": "@@ -742,7 +742,7 @@ importers:\n         version: 9.37.0(jiti@2.5.1)\n       eslint-config-next:\n         specifier: canary\n-        version: 16.0.2-canary.6(eslint-plugin-import-x@4.3.1(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2)\n+        version: 16.0.2-canary.9(eslint-plugin-import-x@4.3.1(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2)\n       tailwindcss:\n         specifier: 4.1.13\n         version: 4.1.13\n@@ -1341,6 +1341,9 @@ importers:\n       '@types/send':\n         specifier: 0.14.4\n         version: 0.14.4\n+      '@types/serve-handler':\n+        specifier: 6.1.4\n+        version: 6.1.4\n       '@types/shell-quote':\n         specifier: 1.7.1\n         version: 1.7.1\n@@ -1656,6 +1659,9 @@ importers:\n       send:\n         specifier: 0.18.0\n         version: 0.18.0\n+      serve-handler:\n+        specifier: 6.1.6\n+        version: 6.1.6\n       server-only:\n         specifier: 0.0.1\n         version: 0.0.1\n@@ -2956,6 +2962,7 @@ packages:\n   '@datadog/native-iast-rewriter@2.0.1':\n     resolution: {integrity: sha512-Mm+FG3XxEbPrAfJQPOMHts7iZZXRvg9gnGeeFRGkyirmRcQcOpZO4wFe/8K61DUVa5pXpgAJQ2ZkBGYF1O9STg==}\n     engines: {node: '>= 10'}\n+    deprecated: Package no longer supported. Contact Support at https://www.npmjs.com/support for more info.\n \n   '@datadog/native-iast-taint-tracking@1.5.0':\n     resolution: {integrity: sha512-SOWIk1M6PZH0osNB191Voz2rKBPoF5hISWVSK9GiJPrD40+xjib1Z/bFDV7EkDn3kjOyordSBdNPG5zOqZJdyg==}\n@@ -4367,8 +4374,8 @@ packages:\n   '@next/env@16.0.1':\n     resolution: {integrity: sha512-LFvlK0TG2L3fEOX77OC35KowL8D7DlFF45C0OvKMC4hy8c/md1RC4UMNDlUGJqfCoCS2VWrZ4dSE6OjaX5+8mw==}\n \n-  '@next/eslint-plugin-next@16.0.2-canary.6':\n-    resolution: {integrity: sha512-09uFg+CCkoEM6wE6oELax26zgSYWh3xW8bhA94zTGKwqsu9yUPWsNv7konBLcDV7AZlVxQ0w5rxftDsSEWHe0w==}\n+  '@next/eslint-plugin-next@16.0.2-canary.9':\n+    resolution: {integrity: sha512-tD2tHSOf512E9f/+XETez/A1j5cFNs0rCr7eDLjDTAiuxJiH2sQaf8txkIIwsP1z3wMDSOEFy0kyjqEaMVfWyQ==}\n \n   '@next/rspack-binding-android-arm-eabi@1.0.1':\n     resolution: {integrity: sha512-ZLEy3shsHk8FpJDeoU4gN3a7eVaOagA7AW2BXSVefBAO4hR6j3Kt/T732FUmf9G5328C2vsbMAWskHRHPbhTig==}\n@@ -6585,6 +6592,9 @@ packages:\n   '@types/send@0.14.4':\n     resolution: {integrity: sha512-SCVCRRjSbpwoKgA34wK8cq14OUPu4qrKigO85/ZH6J04NGws37khLtq7YQr17zyOH01p4T5oy8e1TxEzql01Pg==}\n \n+  '@types/serve-handler@6.1.4':\n+    resolution: {integrity: sha512-aXy58tNie0NkuSCY291xUxl0X+kGYy986l4kqW6Gi4kEXgr6Tx0fpSH7YwUSa5usPpG3s9DBeIR6hHcDtL2IvQ==}\n+\n   '@types/serve-index@1.9.4':\n     resolution: {integrity: sha512-qLpGZ/c2fhSs5gnYsQxtDEq3Oy8SXPClIXkW5ghvAvsNuVSA8k+gCONcUCS/UjLEYvYps+e8uBtfgXgvhwfNug==}\n \n@@ -9675,8 +9685,8 @@ packages:\n     engines: {node: '>=6.0'}\n     hasBin: true\n \n-  eslint-config-next@16.0.2-canary.6:\n-    resolution: {integrity: sha512-I0+bDWAkdumL67vpBJn5fBrPlHPtZKDyCPFPi5rUKF7Zr8q5Npt8PpyqSqECaXasO0PY1t6X8ypCjl+MAg4WfA==}\n+  eslint-config-next@16.0.2-canary.9:\n+    resolution: {integrity: sha512-XysPzo1pUNVJJUpEfHDKJwg3zbFVvZetVohFziDHX6A7l6lpyQBwmODEzDIkWGK0x3uSkvtWyqTolbhQDe7wyA==}\n     peerDependencies:\n       eslint: '>=9.0.0'\n       typescript: '>=3.3.1'\n@@ -10061,6 +10071,7 @@ packages:\n \n   expect-playwright@0.8.0:\n     resolution: {integrity: sha512-+kn8561vHAY+dt+0gMqqj1oY+g5xWrsuGMk4QGxotT2WS545nVqqjs37z6hrYfIuucwqthzwJfCJUEYqixyljg==}\n+    deprecated:  The 'expect-playwright' package is deprecated. The Playwright core assertions (via @playwright/test) now cover the same functionality. Please migrate to built-in expect. See https://playwright.dev/docs/test-assertions for migration.\n \n   expect-type@0.14.2:\n     resolution: {integrity: sha512-ed3+tr5ujbIYXZ8Pl/VgIphwJQ0q5tBLGGdn7Zvwt1WyPBRX83xjT5pT77P/GkuQbctx0K2ZNSSan7eruJqTCQ==}\n@@ -12015,6 +12026,7 @@ packages:\n \n   jest-playwright-preset@4.0.0:\n     resolution: {integrity: sha512-+dGZ1X2KqtwXaabVjTGxy0a3VzYfvYsWaRcuO8vMhyclHSOpGSI1+5cmlqzzCwQ3+fv0EjkTc7I5aV9lo08dYw==}\n+    deprecated:  The 'jest-playwright-preset' package is deprecated. Please migrate to Playwright's built-in test runner (@playwright/test) which now includes full Jest-style features and parallel testing. See https://playwright.dev/docs/intro for details.\n     peerDependencies:\n       jest: ^29.3.1\n       jest-circus: ^29.3.1\n@@ -12032,6 +12044,7 @@ packages:\n \n   jest-process-manager@0.4.0:\n     resolution: {integrity: sha512-80Y6snDyb0p8GG83pDxGI/kQzwVTkCxc7ep5FPe/F6JYdvRDhwr6RzRmPSP7SEwuLhxo80lBS/NqOdUIbHIfhw==}\n+    deprecated:  The 'jest-process-manager' package is deprecated. Please migrate to Playwright's built-in test runner (@playwright/test) which now includes full Jest-style features and parallel testing. See https://playwright.dev/docs/intro for details.\n \n   jest-regex-util@29.4.3:\n     resolution: {integrity: sha512-O4FglZaMmWXbGHSQInfXewIsd1LMn9p3ZXB/6r4FOkyhX2/iP/soMG98jGvk/A3HAN78+5VWcBGO0BJAPRh4kg==}\n@@ -16972,7 +16985,7 @@ packages:\n   superagent@3.8.3:\n     resolution: {integrity: sha512-GLQtLMCoEIK4eDv6OGtkOoSMt3D+oq0y3dsxMuYuDvaNUvuT8eFBuLmfR0iYYzHC1e8hpzC6ZsxbuP6DIalMFA==}\n     engines: {node: '>= 4.0'}\n-    deprecated: Please upgrade to v9.0.0+ as we have fixed a public vulnerability with formidable dependency. Note that v9.0.0+ requires Node.js v14.18.0+. See https://github.com/ladjs/superagent/pull/1800 for insight. This project is supported and maintained by the team at Forward Email @ https://forwardemail.net\n+    deprecated: Please upgrade to superagent v10.2.2+, see release notes at https://github.com/forwardemail/superagent/releases/tag/v10.2.2 - maintenance is supported by Forward Email @ https://forwardemail.net\n \n   superstruct@1.0.3:\n     resolution: {integrity: sha512-8iTn3oSS8nRGn+C2pgXSKPI3jmpm6FExNazNpjvqS6ZUJQCej3PUXEKM8NjHBOs54ExM+LPW/FBRhymrdcCiSg==}\n@@ -21528,7 +21541,7 @@ snapshots:\n \n   '@next/env@16.0.1': {}\n \n-  '@next/eslint-plugin-next@16.0.2-canary.6':\n+  '@next/eslint-plugin-next@16.0.2-canary.9':\n     dependencies:\n       fast-glob: 3.3.1\n \n@@ -23913,6 +23926,10 @@ snapshots:\n       '@types/mime': 2.0.1\n       '@types/node': 20.17.6(patch_hash=rvl3vkomen3tospgr67bzubfyu)\n \n+  '@types/serve-handler@6.1.4':\n+    dependencies:\n+      '@types/node': 20.17.6(patch_hash=rvl3vkomen3tospgr67bzubfyu)\n+\n   '@types/serve-index@1.9.4':\n     dependencies:\n       '@types/express': 4.17.21\n@@ -27608,9 +27625,9 @@ snapshots:\n     optionalDependencies:\n       source-map: 0.6.1\n \n-  eslint-config-next@16.0.2-canary.6(eslint-plugin-import-x@4.3.1(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2):\n+  eslint-config-next@16.0.2-canary.9(eslint-plugin-import-x@4.3.1(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2):\n     dependencies:\n-      '@next/eslint-plugin-next': 16.0.2-canary.6\n+      '@next/eslint-plugin-next': 16.0.2-canary.9\n       eslint: 9.37.0(jiti@2.5.1)\n       eslint-import-resolver-node: 0.3.9\n       eslint-import-resolver-typescript: 3.10.1(eslint-plugin-import-x@4.3.1(eslint@9.37.0(jiti@2.5.1))(typescript@5.9.2))(eslint-plugin-import@2.32.0(eslint@9.37.0(jiti@2.5.1)))(eslint@9.37.0(jiti@2.5.1))"
        }
    ],
    "stats": {
        "total": 953,
        "additions": 788,
        "deletions": 165
    }
}