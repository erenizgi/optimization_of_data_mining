{
    "author": "sokra",
    "message": "Turbopack: add random_change test case to test persistent caching changes (#78211)\n\n### What?\r\n\r\nAdd a test case that checks if we can apply changes to the app after restoring from cache.",
    "sha": "28ab6c97fdee3f6c14415c42ce559501e36b0c96",
    "files": [
        {
            "sha": "0791eca92a2b37221b5c058b8beb53f21e40e4b6",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/random_change.rs",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/28ab6c97fdee3f6c14415c42ce559501e36b0c96/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Frandom_change.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/28ab6c97fdee3f6c14415c42ce559501e36b0c96/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Frandom_change.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Frandom_change.rs?ref=28ab6c97fdee3f6c14415c42ce559501e36b0c96",
            "patch": "@@ -0,0 +1 @@\n+../../turbo-tasks-testing/tests/random_change.rs\n\\ No newline at end of file"
        },
        {
            "sha": "eac66a392b72c8f3359abef8f925ddec6d87ab7b",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/random_change.rs",
            "status": "added",
            "additions": 71,
            "deletions": 0,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/28ab6c97fdee3f6c14415c42ce559501e36b0c96/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frandom_change.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/28ab6c97fdee3f6c14415c42ce559501e36b0c96/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frandom_change.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frandom_change.rs?ref=28ab6c97fdee3f6c14415c42ce559501e36b0c96",
            "patch": "@@ -0,0 +1,71 @@\n+#![feature(arbitrary_self_types)]\n+#![feature(arbitrary_self_types_pointers)]\n+#![allow(clippy::needless_return)] // tokio macro-generated code doesn't respect this\n+\n+use anyhow::{bail, Result};\n+use rand::Rng;\n+use turbo_tasks::{State, Vc};\n+use turbo_tasks_testing::{register, run, Registration};\n+\n+static REGISTRATION: Registration = register!();\n+\n+#[tokio::test]\n+async fn random_change() {\n+    run(&REGISTRATION, || async {\n+        let state = make_state();\n+        let value = rand::rng().random_range(0..100);\n+        state.await?.state.set(value);\n+\n+        let result = func(state, 0).await?;\n+        assert_eq!(result.value, value);\n+\n+        let result = func2(state).await?;\n+        assert_eq!(result.value, value);\n+\n+        anyhow::Ok(())\n+    })\n+    .await\n+    .unwrap()\n+}\n+\n+#[turbo_tasks::value]\n+#[derive(Clone, Debug)]\n+struct Value {\n+    value: i32,\n+}\n+\n+#[turbo_tasks::value]\n+#[derive(Debug)]\n+struct ValueContainer {\n+    state: State<i32>,\n+}\n+\n+#[turbo_tasks::function]\n+fn make_state() -> Vc<ValueContainer> {\n+    ValueContainer {\n+        state: State::new(0),\n+    }\n+    .cell()\n+}\n+\n+#[turbo_tasks::function]\n+async fn func2(input: Vc<ValueContainer>) -> Result<Vc<Value>> {\n+    let state = input.await?;\n+    let value = state.state.get();\n+    println!(\"func2 {}\", *value);\n+    Ok(func(input, -*value))\n+}\n+\n+#[turbo_tasks::function]\n+async fn func(input: Vc<ValueContainer>, nesting: i32) -> Result<Vc<Value>> {\n+    let state = input.await?;\n+    let value = state.state.get();\n+    if nesting < *value {\n+        return Ok(func(input, nesting + 1));\n+    }\n+    if nesting == *value {\n+        println!(\"func {}\", nesting);\n+        return Ok(Value { value: *value }.cell());\n+    }\n+    bail!(\"func no longer valid {}\", nesting)\n+}"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 72,
        "deletions": 0
    }
}