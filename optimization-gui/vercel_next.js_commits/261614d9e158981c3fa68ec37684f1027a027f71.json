{
    "author": "eps1lon",
    "message": "[test] Deflake `app-dir-prevent-304-caching` (#86693)",
    "sha": "261614d9e158981c3fa68ec37684f1027a027f71",
    "files": [
        {
            "sha": "595a18a2cfe64b1a6a580526aebd10c38097b345",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/261614d9e158981c3fa68ec37684f1027a027f71/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/261614d9e158981c3fa68ec37684f1027a027f71/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=261614d9e158981c3fa68ec37684f1027a027f71",
            "patch": "@@ -904,4 +904,9 @@ export class NextInstance {\n       return this.cliOutput.slice(length)\n     }\n   }\n+\n+  public async waitForMinPrerenderAge(minAgeMS: number): Promise<void> {\n+    // For tests we usually have a low revalidate time.\n+    // We assume the prerender is old enough by default for those small revalidation times.\n+  }\n }"
        },
        {
            "sha": "5d024bb0d5a60be2deef65fd86b8dd822bbbec6e",
            "filename": "test/lib/next-modes/next-start.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/261614d9e158981c3fa68ec37684f1027a027f71/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/261614d9e158981c3fa68ec37684f1027a027f71/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-start.ts?ref=261614d9e158981c3fa68ec37684f1027a027f71",
            "patch": "@@ -10,6 +10,8 @@ export class NextStartInstance extends NextInstance {\n   private _buildId: string\n   private _cliOutput: string = ''\n \n+  private _prerenderFinishedTimeMS: number | null = null\n+\n   public get buildId() {\n     return this._buildId\n   }\n@@ -80,6 +82,16 @@ export class NextStartInstance extends NextInstance {\n               )\n             else resolve()\n           })\n+          const prerenderedCallback = (msg: string) => {\n+            const colorStrippedMsg = stripAnsi(msg)\n+            // This stage happens after all prerenders have finished.\n+            const prerenderFinishedPattern = /Finalizing page optimization/\n+            if (prerenderFinishedPattern.test(colorStrippedMsg)) {\n+              this._prerenderFinishedTimeMS = performance.now()\n+              this.off('stdout', prerenderedCallback)\n+            }\n+          }\n+          this.on('stdout', prerenderedCallback)\n         } catch (err) {\n           require('console').error(\n             `Failed to run ${shellQuote(buildArgs)}`,\n@@ -227,4 +239,26 @@ export class NextStartInstance extends NextInstance {\n       })\n     })\n   }\n+\n+  public async waitForMinPrerenderAge(minAgeMS: number): Promise<void> {\n+    if (this._prerenderFinishedTimeMS === null) {\n+      throw new Error(\n+        'Could not determine when prerender finished. ' +\n+          `Cannot guarantee a minimum prerender age of ${minAgeMS}ms.`\n+      )\n+    }\n+\n+    const prerenderAge = performance.now() - this._prerenderFinishedTimeMS\n+    const minWaitTime = minAgeMS - prerenderAge\n+    if (minWaitTime > 0) {\n+      console.log(\n+        'Need to wait %dms to guarantee prerender age of %dms',\n+        minWaitTime,\n+        minAgeMS\n+      )\n+      await new Promise((resolve) => {\n+        setTimeout(resolve, minWaitTime)\n+      })\n+    }\n+  }\n }"
        },
        {
            "sha": "973447b5033a62ee96cd4d48e160db3e40771dd4",
            "filename": "test/production/app-dir-prevent-304-caching/index.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/261614d9e158981c3fa68ec37684f1027a027f71/test%2Fproduction%2Fapp-dir-prevent-304-caching%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/261614d9e158981c3fa68ec37684f1027a027f71/test%2Fproduction%2Fapp-dir-prevent-304-caching%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir-prevent-304-caching%2Findex.test.ts?ref=261614d9e158981c3fa68ec37684f1027a027f71",
            "patch": "@@ -18,9 +18,10 @@ describe('app-dir-prevent-304-caching', () => {\n \n   // https://github.com/vercel/next.js/issues/56580\n   it('should not cache 304 status', async () => {\n-    // Fresh call\n-    const rFresh = await fetchViaHTTP(next.url, '/')\n-    expect(rFresh.status).toBe(200)\n+    // Ensure the first request hits a stale page triggering background revalidation.\n+    await next.waitForMinPrerenderAge(1000 + 50)\n+    const rStale = await fetchViaHTTP(next.url, '/')\n+    expect(rStale.status).toBe(200)\n \n     await waitFor(500)\n \n@@ -31,7 +32,7 @@ describe('app-dir-prevent-304-caching', () => {\n       {},\n       {\n         headers: {\n-          'If-None-Match': rFresh.headers.get('etag'),\n+          'If-None-Match': rStale.headers.get('etag'),\n         },\n       }\n     )"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 44,
        "deletions": 4
    }
}