{
    "author": "feedthejim",
    "message": "misc: remove vendored node-fetch usages (#75741)\n\n## What\n\nThis PR replaces the usage of node-fetch in the next/font/google loader\ncode, which runs as part of every next build. `node-fetch` relies on\n`punycode`, which shows a deprecration warning from Node.js 22,\naffecting every users on Next.js and Node 22.\n\nThis PR also removes any other references to the vendored node-fetch\nused in other parts of the codebase.\n\n~~Unfortunately, we can't remove it because other next.js dependencies\nlike the amp optimiser actually use node-fetch, so they would need to be\nupdated separately.~~\n\nnot a problem anymore because of @wowczarczyk suggestion of also\nrewriting the external in the dependencies to point to the correct one\n\nThis PR does not remove the node-fetch usage in tests.\n\n## How\n\nThis replaces the node-fetch call with a call to the native fetch\nexposed in Node.js. However, this fetch does not support proxies without\ntapping into Undici, so I've had to \"polyfill\" a usage because I did not\nwant to add a dependency to Undici for a minor use case.\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that\nyou follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the\nPR.\n- Read the Docs Contribution Guide to ensure your contribution follows\nthe docs guidelines:\nhttps://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc\nhttps://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See\nhttps://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature\nrequest has been accepted for implementation before opening a PR. (A\ndiscussion must be opened, see\nhttps://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added\n(https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to\nunderstand the PR)\n- When linking to a Slack thread, you might want to share details of the\nconclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic\nbehind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\n\n\n-->\nFixes #66289\nFixes #75313\nCloses NDX-730\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "52284fedb6b9acc677bccd54e877376599fbc047",
    "files": [
        {
            "sha": "01f9b793015e84cb71fc9ac13e81edad10c8fed2",
            "filename": "packages/font/src/google/fetch-css-from-google-fonts.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 47,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-css-from-google-fonts.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-css-from-google-fonts.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-css-from-google-fonts.ts?ref=52284fedb6b9acc677bccd54e877376599fbc047",
            "patch": "@@ -1,7 +1,5 @@\n-// @ts-ignore\n-import fetch from 'next/dist/compiled/node-fetch'\n import { nextFontError } from '../next-font-error'\n-import { getProxyAgent } from './get-proxy-agent'\n+import { fetchResource } from './fetch-resource'\n import { retry } from './retry'\n \n /**\n@@ -16,56 +14,23 @@ export async function fetchCSSFromGoogleFonts(\n   fontFamily: string,\n   isDev: boolean\n ): Promise<string> {\n-  // Check if mocked responses are defined, if so use them instead of fetching from Google Fonts\n-  let mockedResponse: string | undefined\n   if (process.env.NEXT_FONT_GOOGLE_MOCKED_RESPONSES) {\n     const mockFile = require(process.env.NEXT_FONT_GOOGLE_MOCKED_RESPONSES)\n-    mockedResponse = mockFile[url]\n+    const mockedResponse = mockFile[url]\n     if (!mockedResponse) {\n       nextFontError('Missing mocked response for URL: ' + url)\n     }\n+    return mockedResponse\n   }\n \n-  let cssResponse: string\n-  if (mockedResponse) {\n-    // Just use the mocked CSS if it's set\n-    cssResponse = mockedResponse\n-  } else {\n-    // Retry the fetch a few times in case of network issues as some font files\n-    // are quite large:\n-    // https://github.com/vercel/next.js/issues/45080\n-    cssResponse = await retry(async () => {\n-      const controller =\n-        isDev && typeof AbortController !== 'undefined'\n-          ? new AbortController()\n-          : undefined\n-      const signal = controller?.signal\n-      const timeoutId = controller\n-        ? setTimeout(() => controller.abort(), 3000)\n-        : undefined\n+  const buffer = await retry(async () => {\n+    return fetchResource(\n+      url,\n+      isDev,\n+      `Failed to fetch font \\`${fontFamily}\\`: ${url}\\n` +\n+        `Please check your network connection.`\n+    )\n+  }, 3)\n \n-      const res = await fetch(url, {\n-        agent: getProxyAgent(),\n-        // Add a timeout in dev\n-        signal,\n-        headers: {\n-          // The file format is based off of the user agent, make sure woff2 files are fetched\n-          'user-agent':\n-            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0 Safari/537.36',\n-        },\n-      }).finally(() => {\n-        timeoutId && clearTimeout(timeoutId)\n-      })\n-\n-      if (!res.ok) {\n-        nextFontError(\n-          `Failed to fetch font \\`${fontFamily}\\`.\\nURL: ${url}\\n\\nPlease check if the network is available.`\n-        )\n-      }\n-\n-      return res.text()\n-    }, 3)\n-  }\n-\n-  return cssResponse\n+  return buffer.toString('utf8')\n }"
        },
        {
            "sha": "b78428236ccf2ec6306b9417d27404d92c572759",
            "filename": "packages/font/src/google/fetch-font-file.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 20,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-font-file.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-font-file.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-font-file.ts?ref=52284fedb6b9acc677bccd54e877376599fbc047",
            "patch": "@@ -1,34 +1,24 @@\n-// @ts-ignore\n-import fetch from 'next/dist/compiled/node-fetch'\n-import { getProxyAgent } from './get-proxy-agent'\n+import fs from 'node:fs'\n import { retry } from './retry'\n+import { fetchResource } from './fetch-resource'\n \n /**\n- * Fetch the url and return a buffer with the font file.\n+ * Fetches a font file and returns its contents as a Buffer.\n+ * If NEXT_FONT_GOOGLE_MOCKED_RESPONSES is set, we handle mock data logic.\n  */\n export async function fetchFontFile(url: string, isDev: boolean) {\n-  // Check if we're using mocked data\n   if (process.env.NEXT_FONT_GOOGLE_MOCKED_RESPONSES) {\n-    // If it's an absolute path, read the file from the filesystem\n     if (url.startsWith('/')) {\n-      return require('fs').readFileSync(url)\n+      return fs.readFileSync(url)\n     }\n-    // Otherwise just return a unique buffer\n     return Buffer.from(url)\n   }\n \n   return await retry(async () => {\n-    const controller = new AbortController()\n-    const timeoutId = setTimeout(() => controller.abort(), 3000)\n-    const arrayBuffer = await fetch(url, {\n-      agent: getProxyAgent(),\n-      // Add a timeout in dev\n-      signal: isDev ? controller.signal : undefined,\n-    })\n-      .then((r: any) => r.arrayBuffer())\n-      .finally(() => {\n-        clearTimeout(timeoutId)\n-      })\n-    return Buffer.from(arrayBuffer)\n+    return fetchResource(\n+      url,\n+      isDev,\n+      `Failed to fetch font file from \\`${url}\\`.`\n+    )\n   }, 3)\n }"
        },
        {
            "sha": "7064ca60fff5d1435ee4ffcf3b96baf1d6997f6b",
            "filename": "packages/font/src/google/fetch-resource.ts",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-resource.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-resource.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Fgoogle%2Ffetch-resource.ts?ref=52284fedb6b9acc677bccd54e877376599fbc047",
            "patch": "@@ -0,0 +1,57 @@\n+import http from 'node:http'\n+import https from 'node:https'\n+import { getProxyAgent } from './get-proxy-agent'\n+\n+/**\n+ * Makes a simple GET request and returns the entire response as a Buffer.\n+ * - Throws if the response status is not 200.\n+ * - Applies a 3000 ms timeout when `isDev` is `true`.\n+ */\n+export function fetchResource(\n+  url: string,\n+  isDev: boolean,\n+  errorMessage?: string\n+): Promise<Buffer> {\n+  return new Promise((resolve, reject) => {\n+    const { protocol } = new URL(url)\n+    const client = protocol === 'https:' ? https : http\n+    const timeout = isDev ? 3000 : undefined\n+\n+    const req = client.request(\n+      url,\n+      {\n+        agent: getProxyAgent(),\n+        headers: {\n+          // The file format is based off of the user agent, make sure woff2 files are fetched\n+          'User-Agent':\n+            'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) ' +\n+            'AppleWebKit/537.36 (KHTML, like Gecko) ' +\n+            'Chrome/104.0.0.0 Safari/537.36',\n+        },\n+      },\n+      (res) => {\n+        if (res.statusCode !== 200) {\n+          reject(\n+            new Error(\n+              errorMessage ||\n+                `Request failed: ${url} (status: ${res.statusCode})`\n+            )\n+          )\n+          return\n+        }\n+        const chunks: Buffer[] = []\n+        res.on('data', (chunk) => chunks.push(Buffer.from(chunk)))\n+        res.on('end', () => resolve(Buffer.concat(chunks)))\n+      }\n+    )\n+\n+    if (timeout) {\n+      req.setTimeout(timeout, () => {\n+        req.destroy(new Error(`Request timed out after ${timeout}ms`))\n+      })\n+    }\n+\n+    req.on('error', (err) => reject(err))\n+    req.end()\n+  })\n+}"
        },
        {
            "sha": "f636443c718982dd056693e97978d44bc3434620",
            "filename": "packages/font/src/google/loader.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 9,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts?ref=52284fedb6b9acc677bccd54e877376599fbc047",
            "patch": "@@ -1,8 +1,9 @@\n import nextFontGoogleFontLoader from './loader'\n-// @ts-ignore\n-import fetch from 'next/dist/compiled/node-fetch'\n+import { fetchResource } from './fetch-resource'\n \n-jest.mock('next/dist/compiled/node-fetch')\n+jest.mock('./fetch-resource')\n+\n+const mockFetchResource = fetchResource as jest.Mock\n \n describe('next/font/google loader', () => {\n   afterEach(() => {\n@@ -120,10 +121,7 @@ describe('next/font/google loader', () => {\n         fontFunctionArguments: any,\n         expectedUrl: any\n       ) => {\n-        fetch.mockResolvedValue({\n-          ok: true,\n-          text: async () => 'OK',\n-        })\n+        mockFetchResource.mockResolvedValue(Buffer.from('OK'))\n         const { css } = await nextFontGoogleFontLoader({\n           functionName,\n           data: [\n@@ -141,8 +139,12 @@ describe('next/font/google loader', () => {\n           variableName: 'myFont',\n         })\n         expect(css).toBe('OK')\n-        expect(fetch).toHaveBeenCalledTimes(1)\n-        expect(fetch).toHaveBeenCalledWith(expectedUrl, expect.any(Object))\n+        expect(mockFetchResource).toHaveBeenCalledTimes(1)\n+        expect(mockFetchResource).toHaveBeenCalledWith(\n+          expectedUrl,\n+          false,\n+          expect.stringContaining('Failed to fetch font')\n+        )\n       }\n     )\n   })"
        },
        {
            "sha": "c95ebda90df094fa0c002f60af4d168dd3c5a4c0",
            "filename": "packages/next/src/compiled/node-fetch/index.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Fnext%2Fsrc%2Fcompiled%2Fnode-fetch%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Fnext%2Fsrc%2Fcompiled%2Fnode-fetch%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fnode-fetch%2Findex.js?ref=52284fedb6b9acc677bccd54e877376599fbc047"
        },
        {
            "sha": "05ac0ac35b596b763dbd307a5acf6aa1859a8e18",
            "filename": "packages/next/src/trace/trace-uploader.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Fnext%2Fsrc%2Ftrace%2Ftrace-uploader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Fnext%2Fsrc%2Ftrace%2Ftrace-uploader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftrace%2Ftrace-uploader.ts?ref=52284fedb6b9acc677bccd54e877376599fbc047",
            "patch": "@@ -2,7 +2,6 @@ import findUp from 'next/dist/compiled/find-up'\n import fsPromise from 'fs/promises'\n import child_process from 'child_process'\n import assert from 'assert'\n-import fetch from 'next/dist/compiled/node-fetch'\n import os from 'os'\n import { createInterface } from 'readline'\n import { createReadStream } from 'fs'"
        },
        {
            "sha": "ca09e0dbccfd43e1e3d4d2935b255aecde178a7e",
            "filename": "packages/next/taskfile.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Fnext%2Ftaskfile.js",
            "raw_url": "https://github.com/vercel/next.js/raw/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Fnext%2Ftaskfile.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile.js?ref=52284fedb6b9acc677bccd54e877376599fbc047",
            "patch": "@@ -77,6 +77,7 @@ const externals = {\n   'terser-webpack-plugin':\n     'next/dist/build/webpack/plugins/terser-webpack-plugin/src',\n \n+  punycode: 'punycode/',\n   // TODO: Add @swc/helpers to externals once @vercel/ncc switch to swc-loader\n }\n // eslint-disable-next-line camelcase"
        },
        {
            "sha": "bd202f33f9c9253330954514a2593078d0724b88",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/52284fedb6b9acc677bccd54e877376599fbc047/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=52284fedb6b9acc677bccd54e877376599fbc047",
            "patch": "@@ -351,12 +351,6 @@ declare module 'next/dist/compiled/@next/react-refresh-utils/dist/ReactRefreshWe\n   export = m\n }\n \n-declare module 'next/dist/compiled/node-fetch' {\n-  import fetch from 'node-fetch'\n-  export * from 'node-fetch'\n-  export default fetch\n-}\n-\n declare module 'next/dist/compiled/commander' {\n   import commander from 'commander'\n   export * from 'commander'"
        }
    ],
    "stats": {
        "total": 176,
        "additions": 92,
        "deletions": 84
    }
}