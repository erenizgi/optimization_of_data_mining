{
    "author": "huozhi",
    "message": "[metadata] re-enable streaming metadata with PPR (#76119)",
    "sha": "2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
    "files": [
        {
            "sha": "6a149844a0601d1d3ad9a8ce672e63e0eca0bf75",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
            "patch": "@@ -2776,10 +2776,7 @@ export default async function build(\n               },\n               // If it's PPR rendered non-static page, bypass the PPR cache when streaming metadata is enabled.\n               // This will skip the postpone data for those bots requests and instead produce a dynamic render.\n-              ...(isRoutePPREnabled &&\n-              // Disable streaming metadata for PPR on deployment where we don't have the special env.\n-              // TODO: enable streaming metadata in PPR mode by default once it's ready.\n-              process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n+              ...(isRoutePPREnabled\n                 ? [\n                     {\n                       type: 'header',"
        },
        {
            "sha": "b32f28352f8c7058012452127cd74c473e8a975e",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 14,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
            "patch": "@@ -433,17 +433,6 @@ function NonIndex({ ctx }: { ctx: AppRenderContext }) {\n   return null\n }\n \n-function getServeStreamingMetadata(ctx: AppRenderContext) {\n-  const isRoutePPREnabled = !!ctx.renderOpts.experimental.isRoutePPREnabled\n-  const serveStreamingMetadata = !!ctx.renderOpts.serveStreamingMetadata\n-  // If the route is in PPR and the special env is not set, disable the streaming metadata.\n-  // TODO: enable streaming metadata in PPR mode by default once it's ready.\n-  if (isRoutePPREnabled && process.env.__NEXT_EXPERIMENTAL_PPR !== 'true') {\n-    return false\n-  }\n-  return serveStreamingMetadata\n-}\n-\n /**\n  * This is used by server actions & client-side navigations to generate RSC data from a client-side request.\n  * This function is only called on \"dynamic\" requests (ie, there wasn't already a static response).\n@@ -483,7 +472,7 @@ async function generateDynamicRSCPayload(\n     url,\n   } = ctx\n \n-  const serveStreamingMetadata = getServeStreamingMetadata(ctx)\n+  const serveStreamingMetadata = !!ctx.renderOpts.serveStreamingMetadata\n \n   if (!options?.skipFlight) {\n     const preloadCallbacks: PreloadCallbacks = []\n@@ -803,7 +792,7 @@ async function getRSCPayload(\n     getDynamicParamFromSegment,\n     query\n   )\n-  const serveStreamingMetadata = getServeStreamingMetadata(ctx)\n+  const serveStreamingMetadata = !!ctx.renderOpts.serveStreamingMetadata\n \n   const searchParams = createServerSearchParamsForMetadata(query, workStore)\n   const {\n@@ -941,7 +930,7 @@ async function getErrorRSCPayload(\n     workStore,\n   } = ctx\n \n-  const serveStreamingMetadata = getServeStreamingMetadata(ctx)\n+  const serveStreamingMetadata = !!ctx.renderOpts.serveStreamingMetadata\n   const searchParams = createServerSearchParamsForMetadata(query, workStore)\n   const { MetadataTree, ViewportTree } = createMetadataComponents({\n     tree,"
        },
        {
            "sha": "9f53175c6846f021e8e794b3adcfde0bcfd52a24",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
            "patch": "@@ -56,6 +56,7 @@ export type WorkStoreContext = {\n     RenderOpts,\n     | 'assetPrefix'\n     | 'supportsDynamicResponse'\n+    | 'shouldWaitOnAllReady'\n     | 'isRevalidate'\n     | 'nextExport'\n     | 'isDraftMode'\n@@ -97,6 +98,7 @@ export function createWorkStore({\n    * coalescing, and ISR continue working as intended.\n    */\n   const isStaticGeneration =\n+    !renderOpts.shouldWaitOnAllReady &&\n     !renderOpts.supportsDynamicResponse &&\n     !renderOpts.isDraftMode &&\n     !renderOpts.isServerAction"
        },
        {
            "sha": "7c2580a2228d41c4ef74f8d6740bf5d0b20c47e1",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
            "patch": "@@ -2484,10 +2484,8 @@ export default abstract class Server<\n         query: origQuery,\n       })\n \n-      const shouldWaitOnAllReady =\n-        !supportsDynamicResponse ||\n-        // When html bots request PPR page, perform the full dynamic rendering.\n-        (isHtmlBot && isRoutePPREnabled)\n+      // When html bots request PPR page, perform the full dynamic rendering.\n+      const shouldWaitOnAllReady = isHtmlBot && isRoutePPREnabled\n \n       const renderOpts: LoadedRenderOpts = {\n         ...components,"
        },
        {
            "sha": "6423037ee78ad027b58c76f04df0798b553d1bf7",
            "filename": "test/e2e/app-dir/ppr-metadata-blocking/ppr-metadata-blocking-ppr-fallback.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking-ppr-fallback.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking-ppr-fallback.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-blocking%2Fppr-metadata-blocking-ppr-fallback.test.ts?ref=2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
            "patch": "@@ -4,10 +4,10 @@ function countSubstring(str: string, substr: string): number {\n   return str.split(substr).length - 1\n }\n \n-// The default ppr-metadata-blocking is covered by test/e2e/app-dir/ppr-metadata-streaming/ppr-metadata-streaming.test.ts\n describe('ppr-metadata-blocking-ppr-fallback', () => {\n   const { next, skipped } = nextTestSetup({\n     files: __dirname,\n+    // Need to skip deployment because the test uses the private env cannot be used in deployment\n     skipDeployment: true,\n     env: {\n       __NEXT_EXPERIMENTAL_STATIC_SHELL_DEBUGGING: '1',"
        },
        {
            "sha": "accdc5039632ccb0fe45264705ae0f7ee26c6270",
            "filename": "test/e2e/app-dir/ppr-metadata-streaming/ppr-metadata-streaming.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts?ref=2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
            "patch": "@@ -2,21 +2,15 @@ import { nextTestSetup } from 'e2e-utils'\n import cheerio from 'cheerio'\n import { assertNoConsoleErrors } from 'next-test-utils'\n \n-// TODO: remove this env once streaming metadata is available for ppr\n-process.env.__NEXT_EXPERIMENTAL_PPR = 'true'\n-\n function countSubstring(str: string, substr: string): number {\n   return str.split(substr).length - 1\n }\n \n describe('ppr-metadata-streaming', () => {\n-  const { next, isNextDev, isNextDeploy, skipped } = nextTestSetup({\n+  const { next, isNextDev, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n \n-  if (skipped) return\n-\n   // No dynamic APIs used in metadata\n   describe('static metadata', () => {\n     it('should generate metadata in head when page is fully static', async () => {"
        },
        {
            "sha": "826a95b122eb2789d95e662ed99f7023796d0175",
            "filename": "test/production/app-dir/metadata-streaming-config/metadata-streaming-config-customized.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts?ref=2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
            "patch": "@@ -1,10 +1,7 @@\n import { nextTestSetup } from 'e2e-utils'\n \n-// TODO: remove this env once streaming metadata is available for ppr\n-process.env.__NEXT_EXPERIMENTAL_PPR = 'true'\n-\n describe('app-dir - metadata-streaming-config-customized', () => {\n-  const { next, skipped } = nextTestSetup({\n+  const { next } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n     overrideFiles: {\n@@ -19,8 +16,6 @@ describe('app-dir - metadata-streaming-config-customized', () => {\n     },\n   })\n \n-  if (skipped) return\n-\n   it('should have the customized streaming metadata config output in routes-manifest.json', async () => {\n     const prerenderManifest = JSON.parse(\n       await next.readFile('.next/prerender-manifest.json')"
        },
        {
            "sha": "8aeea28410392f99a86a3dad8f40932ecf447dd5",
            "filename": "test/production/app-dir/metadata-streaming-config/metadata-streaming-config.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2a4ed14c13ae29f3ac4489dcf75202a74507ae5b/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts?ref=2a4ed14c13ae29f3ac4489dcf75202a74507ae5b",
            "patch": "@@ -1,16 +1,10 @@\n import { nextTestSetup } from 'e2e-utils'\n \n-// TODO: remove this env once streaming metadata is available for ppr\n-process.env.__NEXT_EXPERIMENTAL_PPR = 'true'\n-\n describe('app-dir - metadata-streaming-config', () => {\n-  const { next, skipped } = nextTestSetup({\n+  const { next } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n \n-  if (skipped) return\n-\n   it('should have the default streaming metadata config output in routes-manifest.json', async () => {\n     const requiredServerFiles = JSON.parse(\n       await next.readFile('.next/required-server-files.json')"
        },
        {
            "sha": "a065865841cbca3851753198c0bc52d9c6063274",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/dynamic/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Flayout.tsx?ref=bcb94e32226dcfc78c17d9335612894f407b883f",
            "patch": "@@ -1,5 +0,0 @@\n-import { Suspense } from 'react'\n-\n-export default function Root({ children }) {\n-  return <Suspense fallback={<p>Loading...</p>}>{children}</Suspense>\n-}"
        },
        {
            "sha": "a74d30071009fe1132cf190fae86e17c34b97e02",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/dynamic/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fdynamic%2Fpage.tsx?ref=bcb94e32226dcfc78c17d9335612894f407b883f",
            "patch": "@@ -1,12 +0,0 @@\n-import { connection } from 'next/server'\n-\n-export default async function Page() {\n-  return <p>hello world</p>\n-}\n-\n-// Dynamic metadata\n-export async function generateMetadata() {\n-  await connection()\n-  await new Promise((resolve) => setTimeout(resolve, 1000))\n-  return { title: 'dynamic-title' }\n-}"
        },
        {
            "sha": "3902c914da24b84be05ef4c77a2cba99fbf278a9",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Flayout.tsx?ref=bcb94e32226dcfc78c17d9335612894f407b883f",
            "patch": "@@ -1,16 +0,0 @@\n-import { ReactNode } from 'react'\n-import Link from 'next/link'\n-\n-export default function Root({ children }: { children: ReactNode }) {\n-  return (\n-    <html>\n-      <body>\n-        <nav>\n-          <Link href=\"/ppr\">ppr</Link>\n-          <Link href=\"/dynamic\">dynamic</Link>\n-        </nav>\n-        {children}\n-      </body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "a065865841cbca3851753198c0bc52d9c6063274",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/ppr/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Flayout.tsx?ref=bcb94e32226dcfc78c17d9335612894f407b883f",
            "patch": "@@ -1,5 +0,0 @@\n-import { Suspense } from 'react'\n-\n-export default function Root({ children }) {\n-  return <Suspense fallback={<p>Loading...</p>}>{children}</Suspense>\n-}"
        },
        {
            "sha": "d0385d61a5590b21811fd2eece0a65296fda9a2d",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/app/ppr/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fapp%2Fppr%2Fpage.tsx?ref=bcb94e32226dcfc78c17d9335612894f407b883f",
            "patch": "@@ -1,13 +0,0 @@\n-import { connection } from 'next/server'\n-\n-export default async function Page() {\n-  await connection()\n-  return <p>ppr</p>\n-}\n-\n-export async function generateMetadata() {\n-  await connection()\n-  return { title: 'ppr-title' }\n-}\n-\n-export const experimental_ppr = true"
        },
        {
            "sha": "17dfbe817837992ea828de327e28a35633c5781e",
            "filename": "test/production/app-dir/ppr-disable-streaming-metadata/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bcb94e32226dcfc78c17d9335612894f407b883f/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fppr-disable-streaming-metadata%2Fnext.config.js?ref=bcb94e32226dcfc78c17d9335612894f407b883f",
            "patch": "@@ -1,10 +0,0 @@\n-/**\n- * @type {import('next').NextConfig}\n- */\n-const nextConfig = {\n-  experimental: {\n-    ppr: 'incremental',\n-  },\n-}\n-\n-module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 116,
        "additions": 12,
        "deletions": 104
    }
}