{
    "author": "unstubbable",
    "message": "[dev] Define request ID for RSC requests on the client (#84605)\n\nPreviously, we defined a request ID for RSC requests on the server. The\nrequest ID is used to tag debug information sent via WebSocket to the\nclient, which then routes those chunks to the debug channel associated\nwith this ID.\n\nHowever, this meant that the client had to await the server response to\nretrieve the request ID from the response headers, before we could pass\nthe response (and the debug channel) to React.\n\nFor #84580, we want to pass the response promise directly to React, to\naccurately show timing information about the request in the React\nDevTools. To achieve this, we now define the request ID on the client,\nand send it to the server via a request header. This means that the\nclient can create the debug channel immediately, without waiting for the\nserver response.\n\ncloses NAR-426",
    "sha": "316c06295ca33cd8c340a64722cf9019b980efbf",
    "files": [
        {
            "sha": "0b3f1ee8a2a0abd8975d39935d6368a5c4c7a51b",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=316c06295ca33cd8c340a64722cf9019b980efbf",
            "patch": "@@ -851,5 +851,6 @@\n   \"850\": \"metadataBase is not a valid URL: %s\",\n   \"851\": \"Pass either `webpack` or `turbopack`, not both.\",\n   \"852\": \"Only custom servers can pass `webpack`, `turbo`, or `turbopack`.\",\n-  \"853\": \"Turbopack build failed\"\n+  \"853\": \"Turbopack build failed\",\n+  \"854\": \"Expected a %s request header.\"\n }"
        },
        {
            "sha": "3d19250610da2191b86d23021805d7087767526a",
            "filename": "packages/next/src/client/components/router-reducer/fetch-server-response.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 5,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts?ref=316c06295ca33cd8c340a64722cf9019b980efbf",
            "patch": "@@ -21,6 +21,7 @@ import {\n   NEXT_DID_POSTPONE_HEADER,\n   NEXT_ROUTER_STALE_TIME_HEADER,\n   NEXT_HTML_REQUEST_ID_HEADER,\n+  NEXT_REQUEST_ID_HEADER,\n } from '../app-router-headers'\n import { callServer } from '../../app-call-server'\n import { findSourceMapURL } from '../../app-find-source-map-url'\n@@ -77,6 +78,7 @@ export type RequestHeaders = {\n   // A header that is only added in test mode to assert on fetch priority\n   'Next-Test-Fetch-Priority'?: RequestInit['priority']\n   [NEXT_HTML_REQUEST_ID_HEADER]?: string // dev-only\n+  [NEXT_REQUEST_ID_HEADER]?: string // dev-only\n }\n \n function doMpaNavigation(url: string): FetchServerResponseResult {\n@@ -230,7 +232,7 @@ export async function fetchServerResponse(\n       : res.body\n     const response = await (createFromNextReadableStream(\n       flightStream,\n-      res.headers\n+      headers\n     ) as Promise<NavigationFlightResponse>)\n \n     if (getAppBuildId() !== response.b) {\n@@ -299,8 +301,17 @@ export async function createFetch(\n     headers['x-deployment-id'] = process.env.NEXT_DEPLOYMENT_ID\n   }\n \n-  if (process.env.NODE_ENV !== 'production' && self.__next_r) {\n-    headers[NEXT_HTML_REQUEST_ID_HEADER] = self.__next_r\n+  if (process.env.NODE_ENV !== 'production') {\n+    if (self.__next_r) {\n+      headers[NEXT_HTML_REQUEST_ID_HEADER] = self.__next_r\n+    }\n+\n+    // Create a new request ID for the server action request. The server uses\n+    // this to tag debug information sent via WebSocket to the client, which\n+    // then routes those chunks to the debug channel associated with this ID.\n+    headers[NEXT_REQUEST_ID_HEADER] = crypto\n+      .getRandomValues(new Uint32Array(1))[0]\n+      .toString(16)\n   }\n \n   const fetchOptions: RequestInit = {\n@@ -404,12 +415,12 @@ export async function createFetch(\n \n export function createFromNextReadableStream(\n   flightStream: ReadableStream<Uint8Array>,\n-  responseHeaders: Headers\n+  requestHeaders: RequestHeaders\n ): Promise<unknown> {\n   return createFromReadableStream(flightStream, {\n     callServer,\n     findSourceMapURL,\n-    debugChannel: createDebugChannel && createDebugChannel(responseHeaders),\n+    debugChannel: createDebugChannel && createDebugChannel(requestHeaders),\n   })\n }\n "
        },
        {
            "sha": "5898f08bee0724febc42cac716d4c355cf4fc332",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=316c06295ca33cd8c340a64722cf9019b980efbf",
            "patch": "@@ -12,6 +12,7 @@ import {\n   NEXT_ROUTER_STATE_TREE_HEADER,\n   NEXT_URL,\n   RSC_CONTENT_TYPE_HEADER,\n+  NEXT_REQUEST_ID_HEADER,\n } from '../../app-router-headers'\n import { UnrecognizedActionError } from '../../unrecognized-action-error'\n \n@@ -119,8 +120,17 @@ async function fetchServerAction(\n     headers[NEXT_URL] = nextUrl\n   }\n \n-  if (process.env.NODE_ENV !== 'production' && self.__next_r) {\n-    headers[NEXT_HTML_REQUEST_ID_HEADER] = self.__next_r\n+  if (process.env.NODE_ENV !== 'production') {\n+    if (self.__next_r) {\n+      headers[NEXT_HTML_REQUEST_ID_HEADER] = self.__next_r\n+    }\n+\n+    // Create a new request ID for the server action request. The server uses\n+    // this to tag debug information sent via WebSocket to the client, which\n+    // then routes those chunks to the debug channel associated with this ID.\n+    headers[NEXT_REQUEST_ID_HEADER] = crypto\n+      .getRandomValues(new Uint32Array(1))[0]\n+      .toString(16)\n   }\n \n   const res = await fetch(state.canonicalUrl, { method: 'POST', headers, body })\n@@ -198,7 +208,7 @@ async function fetchServerAction(\n         callServer,\n         findSourceMapURL,\n         temporaryReferences,\n-        debugChannel: createDebugChannel && createDebugChannel(res.headers),\n+        debugChannel: createDebugChannel && createDebugChannel(headers),\n       }\n     )\n "
        },
        {
            "sha": "4bf533b195c9567d74c9fd5d3f017d65b19a4e57",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=316c06295ca33cd8c340a64722cf9019b980efbf",
            "patch": "@@ -1432,7 +1432,7 @@ export async function fetchRouteOnCacheMiss(\n       )\n       const serverData = await (createFromNextReadableStream(\n         prefetchStream,\n-        response.headers\n+        headers\n       ) as Promise<RootTreePrefetch>)\n       if (serverData.buildId !== getAppBuildId()) {\n         // The server build does not match the client. Treat as a 404. During\n@@ -1484,7 +1484,7 @@ export async function fetchRouteOnCacheMiss(\n       )\n       const serverData = await (createFromNextReadableStream(\n         prefetchStream,\n-        response.headers\n+        headers\n       ) as Promise<NavigationFlightResponse>)\n       if (serverData.b !== getAppBuildId()) {\n         // The server build does not match the client. Treat as a 404. During\n@@ -1630,7 +1630,7 @@ export async function fetchSegmentOnCacheMiss(\n     )\n     const serverData = await (createFromNextReadableStream(\n       prefetchStream,\n-      response.headers\n+      headers\n     ) as Promise<SegmentPrefetch>)\n     if (serverData.buildId !== getAppBuildId()) {\n       // The server build does not match the client. Treat as a 404. During\n@@ -1750,7 +1750,7 @@ export async function fetchSegmentPrefetchesUsingDynamicRequest(\n     )\n     const serverData = await (createFromNextReadableStream(\n       prefetchStream,\n-      response.headers\n+      headers\n     ) as Promise<NavigationFlightResponse>)\n \n     const isResponsePartial ="
        },
        {
            "sha": "4a127e8678061265ac7a3fe553ea886d5acfa776",
            "filename": "packages/next/src/client/dev/debug-channel.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fdebug-channel.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fdebug-channel.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fdebug-channel.ts?ref=316c06295ca33cd8c340a64722cf9019b980efbf",
            "patch": "@@ -23,18 +23,20 @@ export function getOrCreateDebugChannelReadableWriterPair(\n   return pair\n }\n \n-export function createDebugChannel(responseHeaders: Headers | undefined): {\n+export function createDebugChannel(\n+  requestHeaders: Record<string, string> | undefined\n+): {\n   writable?: WritableStream\n   readable?: ReadableStream\n } {\n   let requestId: string | undefined\n \n-  if (responseHeaders) {\n-    requestId = responseHeaders.get(NEXT_REQUEST_ID_HEADER) ?? undefined\n+  if (requestHeaders) {\n+    requestId = requestHeaders[NEXT_REQUEST_ID_HEADER] ?? undefined\n \n     if (!requestId) {\n       throw new InvariantError(\n-        `Expected a ${JSON.stringify(NEXT_REQUEST_ID_HEADER)} response header.`\n+        `Expected a ${JSON.stringify(NEXT_REQUEST_ID_HEADER)} request header.`\n       )\n     }\n   } else {"
        },
        {
            "sha": "bc7decf5004de0fd8ac4de2523be25febd90e190",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 47,
            "deletions": 21,
            "changes": 68,
            "blob_url": "https://github.com/vercel/next.js/blob/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/316c06295ca33cd8c340a64722cf9019b980efbf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=316c06295ca33cd8c340a64722cf9019b980efbf",
            "patch": "@@ -287,6 +287,7 @@ interface ParsedRequestHeaders {\n   readonly isRSCRequest: boolean\n   readonly nonce: string | undefined\n   readonly previouslyRevalidatedTags: string[]\n+  readonly requestId: string | undefined\n   readonly htmlRequestId: string | undefined\n }\n \n@@ -332,10 +333,25 @@ function parseRequestHeaders(\n     options.previewModeId\n   )\n \n-  const htmlRequestId =\n-    typeof headers[NEXT_HTML_REQUEST_ID_HEADER] === 'string'\n-      ? headers[NEXT_HTML_REQUEST_ID_HEADER]\n-      : undefined\n+  let requestId: string | undefined\n+  let htmlRequestId: string | undefined\n+\n+  if (process.env.NODE_ENV !== 'production') {\n+    // The request IDs are only used in development mode to send debug\n+    // information to the matching client (identified by the HTML request ID\n+    // that was sent to the client with the HTML document) for the current\n+    // request (identified by the request ID, as defined by the client).\n+\n+    requestId =\n+      typeof headers[NEXT_REQUEST_ID_HEADER] === 'string'\n+        ? headers[NEXT_REQUEST_ID_HEADER]\n+        : undefined\n+\n+    htmlRequestId =\n+      typeof headers[NEXT_HTML_REQUEST_ID_HEADER] === 'string'\n+        ? headers[NEXT_HTML_REQUEST_ID_HEADER]\n+        : undefined\n+  }\n \n   return {\n     flightRouterState,\n@@ -347,6 +363,7 @@ function parseRequestHeaders(\n     isDevWarmupRequest,\n     nonce,\n     previouslyRevalidatedTags,\n+    requestId,\n     htmlRequestId,\n   }\n }\n@@ -1632,22 +1649,7 @@ async function renderToHTMLOrFlightImpl(\n   const { isStaticGeneration } = workStore\n \n   let requestId: string\n-\n-  if (isStaticGeneration) {\n-    requestId = Buffer.from(\n-      await crypto.subtle.digest('SHA-1', Buffer.from(req.url))\n-    ).toString('hex')\n-  } else if (process.env.NEXT_RUNTIME === 'edge') {\n-    requestId = crypto.randomUUID()\n-  } else {\n-    requestId = (\n-      require('next/dist/compiled/nanoid') as typeof import('next/dist/compiled/nanoid')\n-    ).nanoid()\n-  }\n-\n-  if (process.env.NODE_ENV !== 'production') {\n-    res.setHeader(NEXT_REQUEST_ID_HEADER, requestId)\n-  }\n+  let htmlRequestId: string\n \n   const {\n     flightRouterState,\n@@ -1657,9 +1659,33 @@ async function renderToHTMLOrFlightImpl(\n     isDevWarmupRequest,\n     isHmrRefresh,\n     nonce,\n-    htmlRequestId = requestId,\n   } = parsedRequestHeaders\n \n+  if (parsedRequestHeaders.requestId) {\n+    // If the client has provided a request ID (in development mode), we use it.\n+    requestId = parsedRequestHeaders.requestId\n+  } else {\n+    // Otherwise we generate a new request ID.\n+    if (isStaticGeneration) {\n+      requestId = Buffer.from(\n+        await crypto.subtle.digest('SHA-1', Buffer.from(req.url))\n+      ).toString('hex')\n+    } else if (process.env.NEXT_RUNTIME === 'edge') {\n+      requestId = crypto.randomUUID()\n+    } else {\n+      requestId = (\n+        require('next/dist/compiled/nanoid') as typeof import('next/dist/compiled/nanoid')\n+      ).nanoid()\n+    }\n+  }\n+\n+  // If the client has provided an HTML request ID, we use it to associate the\n+  // request with the HTML document from which it originated, which is used to\n+  // send debug information to the associated WebSocket client. Otherwise, this\n+  // is the request for the HTML document, so we use the request ID also as the\n+  // HTML request ID.\n+  htmlRequestId = parsedRequestHeaders.htmlRequestId || requestId\n+\n   /**\n    * Dynamic parameters. E.g. when you visit `/dashboard/vercel` which is rendered by `/dashboard/[slug]` the value will be {\"slug\": \"vercel\"}.\n    */"
        }
    ],
    "stats": {
        "total": 126,
        "additions": 88,
        "deletions": 38
    }
}