{
    "author": "devjiwonchoi",
    "message": "feat: Isolate dev build from prod (#83961)\n\n### Why?\n\nWhen running a dev server, it currently gets interrupted when running\n`next build`.\nThis is very common when using AI for app development, where it runs\n`next build` for whatever reason while the user is working on a dev\nserver.\n\n### How?\n\nThis PR creates an isolated `dev/` directory inside the `distDir` to be\nisolated from the build, and will not be cleared out during the `next\nbuild` like the `cache/` directory. Since the cache between the dev and\nprod isn't shared at the moment, it makes sense to let them have\nseparate `cache/` directories.\n\n\nhttps://github.com/user-attachments/assets/2005ba70-861c-4763-b47f-cf17c62c0571",
    "sha": "0f27700f3df6604215993cdbbeb8681ec19d42e2",
    "files": [
        {
            "sha": "eca816fa7ce7d3b8e2129a8d49975cb45cf1bacb",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0f27700f3df6604215993cdbbeb8681ec19d42e2/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f27700f3df6604215993cdbbeb8681ec19d42e2/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=0f27700f3df6604215993cdbbeb8681ec19d42e2",
            "patch": "@@ -1123,7 +1123,7 @@ export default async function build(\n       }\n \n       if (config.cleanDistDir && !isGenerateMode) {\n-        await recursiveDelete(distDir, /^cache/)\n+        await recursiveDelete(distDir, /^(cache|dev)/)\n       }\n \n       if (appDir && 'exportPathMap' in config) {"
        },
        {
            "sha": "dcc821539f51cde6f516dceb49b45de70ac096e4",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/0f27700f3df6604215993cdbbeb8681ec19d42e2/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f27700f3df6604215993cdbbeb8681ec19d42e2/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=0f27700f3df6604215993cdbbeb8681ec19d42e2",
            "patch": "@@ -414,6 +414,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         prerenderEarlyExit: z.boolean().optional(),\n         proxyTimeout: z.number().gte(0).optional(),\n         rootParams: z.boolean().optional(),\n+        isolatedDevBuild: z.boolean().optional(),\n         routerBFCache: z.boolean().optional(),\n         removeUncaughtErrorAndRejectionListeners: z.boolean().optional(),\n         validateRSCRequestHeaders: z.boolean().optional(),"
        },
        {
            "sha": "16b198b8b11e376f1231e2d7c704c31defe4fff6",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/0f27700f3df6604215993cdbbeb8681ec19d42e2/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f27700f3df6604215993cdbbeb8681ec19d42e2/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=0f27700f3df6604215993cdbbeb8681ec19d42e2",
            "patch": "@@ -804,6 +804,13 @@ export interface ExperimentalConfig {\n    * Enable accessing root params via the `next/root-params` module.\n    */\n   rootParams?: boolean\n+\n+  /**\n+   * Use an isolated directory for development builds to prevent conflicts\n+   * with production builds. Development builds will use `{distDir}/dev`\n+   * instead of `{distDir}`.\n+   */\n+  isolatedDevBuild?: boolean\n }\n \n export type ExportPathMap = {\n@@ -1496,6 +1503,7 @@ export const defaultConfig = Object.freeze({\n     globalNotFound: false,\n     browserDebugInfoInTerminal: false,\n     optimizeRouterScrolling: false,\n+    isolatedDevBuild: false,\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,"
        },
        {
            "sha": "8a49cd73928256acc6737b81aa45f66a1f04faa0",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/0f27700f3df6604215993cdbbeb8681ec19d42e2/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f27700f3df6604215993cdbbeb8681ec19d42e2/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=0f27700f3df6604215993cdbbeb8681ec19d42e2",
            "patch": "@@ -215,7 +215,8 @@ function assignDefaultsAndValidate(\n   dir: string,\n   userConfig: NextConfig & { configFileName: string },\n   silent: boolean,\n-  configuredExperimentalFeatures: ConfiguredExperimentalFeature[]\n+  configuredExperimentalFeatures: ConfiguredExperimentalFeature[],\n+  phase: PHASE_TYPE\n ): NextConfigComplete {\n   const configFileName = userConfig.configFileName\n   if (typeof userConfig.exportTrailingSlash !== 'undefined') {\n@@ -1198,6 +1199,13 @@ function assignDefaultsAndValidate(\n     )\n   }\n \n+  if (\n+    phase === PHASE_DEVELOPMENT_SERVER &&\n+    result.experimental?.isolatedDevBuild\n+  ) {\n+    result.distDir = join(result.distDir, 'dev')\n+  }\n+\n   return result as NextConfigComplete\n }\n \n@@ -1362,7 +1370,8 @@ export default async function loadConfig(\n           ...customConfig,\n         },\n         silent,\n-        configuredExperimentalFeatures\n+        configuredExperimentalFeatures,\n+        phase\n       ) as NextConfigComplete,\n       phase,\n       silent\n@@ -1569,7 +1578,8 @@ export default async function loadConfig(\n         ...userConfig,\n       },\n       silent,\n-      configuredExperimentalFeatures\n+      configuredExperimentalFeatures,\n+      phase\n     ) as NextConfigComplete\n \n     const finalConfig = await applyModifyConfig(completeConfig, phase, silent)\n@@ -1624,7 +1634,8 @@ export default async function loadConfig(\n     dir,\n     { ...clonedDefaultConfig, configFileName },\n     silent,\n-    configuredExperimentalFeatures\n+    configuredExperimentalFeatures,\n+    phase\n   ) as NextConfigComplete\n \n   setHttpClientAndAgentOptions(completeConfig)"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/development/app-dir/isolated-dev-build/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/0f27700f3df6604215993cdbbeb8681ec19d42e2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0f27700f3df6604215993cdbbeb8681ec19d42e2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fapp%2Flayout.tsx?ref=0f27700f3df6604215993cdbbeb8681ec19d42e2",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/development/app-dir/isolated-dev-build/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0f27700f3df6604215993cdbbeb8681ec19d42e2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0f27700f3df6604215993cdbbeb8681ec19d42e2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fapp%2Fpage.tsx?ref=0f27700f3df6604215993cdbbeb8681ec19d42e2",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "edf7dba2722de61bab523cfd2221e7f0a61266af",
            "filename": "test/development/app-dir/isolated-dev-build/isolated-dev-build.test.ts",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/0f27700f3df6604215993cdbbeb8681ec19d42e2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f27700f3df6604215993cdbbeb8681ec19d42e2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts?ref=0f27700f3df6604215993cdbbeb8681ec19d42e2",
            "patch": "@@ -0,0 +1,26 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n+\n+describe('isolated-dev-build', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should create dev artifacts in .next/dev/ directory', async () => {\n+    expect(await next.hasFile('.next/dev')).toBe(true)\n+    expect(await next.hasFile('.next/server')).toBe(false)\n+  })\n+\n+  it('should work with HMR', async () => {\n+    const browser = await next.browser('/')\n+    expect(await browser.elementByCss('p').text()).toBe('hello world')\n+\n+    await next.patchFile('app/page.tsx', (content) => {\n+      return content.replace('hello world', 'hello updated world')\n+    })\n+\n+    await retry(async () => {\n+      expect(await browser.elementByCss('p').text()).toBe('hello updated world')\n+    })\n+  })\n+})"
        },
        {
            "sha": "3c6fc6116a575d4d5a3858274237a2f1913d6db6",
            "filename": "test/development/app-dir/isolated-dev-build/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/0f27700f3df6604215993cdbbeb8681ec19d42e2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0f27700f3df6604215993cdbbeb8681ec19d42e2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fnext.config.js?ref=0f27700f3df6604215993cdbbeb8681ec19d42e2",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    isolatedDevBuild: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 72,
        "deletions": 5
    }
}