{
    "author": "huozhi",
    "message": "[test] fix react 19.1 related tests (#77809)\n\n* Update hydration tests for 19.1 where we can have proper stack\ndisplayed by owner stack\n* Fix version matching test for 19.0.0",
    "sha": "95b2c193d730cbeb09e9b63c94af7a577cf62077",
    "files": [
        {
            "sha": "6390ccf734a9af3ccb6fd4186ecd8c9cdb62f959",
            "filename": "test/development/acceptance/hydration-error.test.ts",
            "status": "modified",
            "additions": 89,
            "deletions": 24,
            "changes": 113,
            "blob_url": "https://github.com/vercel/next.js/blob/95b2c193d730cbeb09e9b63c94af7a577cf62077/test%2Fdevelopment%2Facceptance%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/95b2c193d730cbeb09e9b63c94af7a577cf62077/test%2Fdevelopment%2Facceptance%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2Fhydration-error.test.ts?ref=95b2c193d730cbeb09e9b63c94af7a577cf62077",
            "patch": "@@ -11,6 +11,11 @@ describe('Error overlay for hydration errors in Pages router', () => {\n   const { next } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n     skipStart: true,\n+    // TODO: once Next.js minimal React version is 19.1, remove this override.\n+    dependencies: {\n+      react: isReact18 ? '^18.3.1' : '^19.1.0',\n+      'react-dom': isReact18 ? '^18.3.1' : '^19.1.0',\n+    },\n   })\n \n   it('includes a React docs link when hydration error does occur', async () => {\n@@ -111,8 +116,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (5:9) @ Mismatch\n+       > 5 |         <main className=\"child\">{isClient ? \"client\" : \"server\"}</main>\n+           |         ^\",\n+         \"stack\": [\n+           \"main <anonymous> (0:0)\",\n+           \"Mismatch index.js (5:9)\",\n+         ],\n        }\n       `)\n     }\n@@ -193,8 +203,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (5:20) @ Mismatch\n+       > 5 |       {isClient && <main className=\"only\" />}\n+           |                    ^\",\n+         \"stack\": [\n+           \"main <anonymous> (0:0)\",\n+           \"Mismatch index.js (5:20)\",\n+         ],\n        }\n       `)\n     }\n@@ -264,8 +279,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (4:5) @ Mismatch\n+       > 4 |     <div className=\"parent\">\n+           |     ^\",\n+         \"stack\": [\n+           \"div <anonymous> (0:0)\",\n+           \"Mismatch index.js (4:5)\",\n+         ],\n        }\n       `)\n     }\n@@ -325,8 +345,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (4:5) @ Mismatch\n+       > 4 |     <div className=\"parent\">\n+           |     ^\",\n+         \"stack\": [\n+           \"div <anonymous> (0:0)\",\n+           \"Mismatch index.js (4:5)\",\n+         ],\n        }\n       `)\n     }\n@@ -384,8 +409,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (3:10) @ Mismatch\n+       > 3 |   return <div className=\"parent\">{!isClient && \"only\"}</div>;\n+           |          ^\",\n+         \"stack\": [\n+           \"div <anonymous> (0:0)\",\n+           \"Mismatch index.js (3:10)\",\n+         ],\n        }\n       `)\n     }\n@@ -455,8 +485,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (3:5) @ Page\n+       > 3 |     <table>\n+           |     ^\",\n+         \"stack\": [\n+           \"table <anonymous> (0:0)\",\n+           \"Page index.js (3:5)\",\n+         ],\n        }\n       `)\n     }\n@@ -520,8 +555,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (3:5) @ Page\n+       > 3 |     <table>\n+           |     ^\",\n+         \"stack\": [\n+           \"table <anonymous> (0:0)\",\n+           \"Page index.js (3:5)\",\n+         ],\n        }\n       `)\n     }\n@@ -593,8 +633,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (8:22) @ Mismatch\n+       >  8 |         {isClient && <main className=\"second\" />}\n+            |                      ^\",\n+         \"stack\": [\n+           \"main <anonymous> (0:0)\",\n+           \"Mismatch index.js (8:22)\",\n+         ],\n        }\n       `)\n     }\n@@ -692,8 +737,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n        This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (4:7) @ Page\n+       > 4 |       <p>Nested p tags</p>\n+           |       ^\",\n+         \"stack\": [\n+           \"p <anonymous> (0:0)\",\n+           \"Page index.js (4:7)\",\n+         ],\n        }\n       `)\n     }\n@@ -764,8 +814,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n        This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (6:11) @ Page\n+       > 6 |           <div>Nested div under p tag</div>\n+           |           ^\",\n+         \"stack\": [\n+           \"div <anonymous> (0:0)\",\n+           \"Page index.js (6:11)\",\n+         ],\n        }\n       `)\n     }\n@@ -826,8 +881,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n        This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (2:15) @ Page\n+       > 2 |   return <div><tr></tr></div>\n+           |               ^\",\n+         \"stack\": [\n+           \"tr <anonymous> (0:0)\",\n+           \"Page index.js (2:15)\",\n+         ],\n        }\n       `)\n     }\n@@ -898,8 +958,13 @@ describe('Error overlay for hydration errors in Pages router', () => {\n        This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Runtime Error\",\n-         \"source\": null,\n-         \"stack\": [],\n+         \"source\": \"index.js (3:32) @ Page\n+       > 3 |     <p><span><span><span><span><p>hello world</p></span></span></span></span></p>\n+           |                                ^\",\n+         \"stack\": [\n+           \"p <anonymous> (0:0)\",\n+           \"Page index.js (3:32)\",\n+         ],\n        }\n       `)\n     }"
        },
        {
            "sha": "7315fc68503c42e9c07801648b786f6627ba421a",
            "filename": "test/production/custom-server/custom-server.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 9,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/95b2c193d730cbeb09e9b63c94af7a577cf62077/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/95b2c193d730cbeb09e9b63c94af7a577cf62077/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fcustom-server%2Fcustom-server.test.ts?ref=95b2c193d730cbeb09e9b63c94af7a577cf62077",
            "patch": "@@ -1,8 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n \n const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n-// TODO(new-dev-overlay): Remove this once new dev overlay is stable\n-const isExperimentalReact = Boolean(process.env.__NEXT_EXPERIMENTAL_PPR)\n \n describe('custom server', () => {\n   const { next } = nextTestSetup({\n@@ -25,19 +23,17 @@ describe('custom server', () => {\n   })\n \n   describe('with app dir', () => {\n-    if (!isExperimentalReact) {\n-      it('should render app with react canary', async () => {\n-        const $ = await next.render$(`/1`)\n-        expect($('body').text()).toMatch(/app: .+-canary/)\n-      })\n-    }\n+    it('should render app with react canary', async () => {\n+      const $ = await next.render$(`/1`)\n+      expect($('body').text()).toMatch(/app: .+-canary/)\n+    })\n \n     it('should render pages with installed react', async () => {\n       const $ = await next.render$(`/2`)\n       if (isReact18) {\n         expect($('body').text()).toMatch(/pages: 18\\.\\d+\\.\\d+\\{/)\n       } else {\n-        expect($('body').text()).toMatch(/pages: 19.0.0/)\n+        expect($('body').text()).toMatch(/pages: 19\\.\\d+\\.\\d+/)\n       }\n     })\n   })"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 94,
        "deletions": 33
    }
}