{
    "author": "florianliebig",
    "message": "Add test for external middleware rewrite with changed headers (#49606)\n\n### What?\n\nWithin Issue https://github.com/vercel/next.js/issues/48040 / PR #49487\nthe middleware proxy for external rewrites was fixed. Unfortunately,\nthis does not work when you change the headers in your middleware\n(according to\nhttps://vercel.com/templates/next.js/edge-functions-modify-request-header)\n\n### Why?\n\nWe still have issues with the latest canary\n\n### How?\n\nUnfortunately I was not able to find the issue, just recreating the bug\nin a testcase\n\n---------\n\nCo-authored-by: Tim Neutkens <tim@timneutkens.nl>",
    "sha": "c0e8e55a6692fec7dfbb2a0293ee97cf3403a413",
    "files": [
        {
            "sha": "8fe5e0cd67735e3a168740ca04e3e9f1bbd68c97",
            "filename": "test/e2e/middleware-rewrites/app/middleware.js",
            "status": "modified",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/c0e8e55a6692fec7dfbb2a0293ee97cf3403a413/test%2Fe2e%2Fmiddleware-rewrites%2Fapp%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c0e8e55a6692fec7dfbb2a0293ee97cf3403a413/test%2Fe2e%2Fmiddleware-rewrites%2Fapp%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-rewrites%2Fapp%2Fmiddleware.js?ref=c0e8e55a6692fec7dfbb2a0293ee97cf3403a413",
            "patch": "@@ -23,6 +23,44 @@ export async function middleware(request) {\n     })\n   }\n \n+  if (\n+    url.pathname.includes(\n+      '/middleware-external-rewrite-body-headers-return-body'\n+    )\n+  ) {\n+    const tmpHeaders = new Headers(request.headers)\n+\n+    tmpHeaders.set('x-hello-from-middleware1', 'hello')\n+\n+    return NextResponse.rewrite(\n+      'https://next-data-api-endpoint.vercel.app/api/echo-body',\n+      {\n+        request: {\n+          headers: tmpHeaders,\n+        },\n+      }\n+    )\n+  }\n+\n+  if (\n+    url.pathname.includes(\n+      '/middleware-external-rewrite-body-headers-return-headers'\n+    )\n+  ) {\n+    const tmpHeaders = new Headers(request.headers)\n+\n+    tmpHeaders.set('x-hello-from-middleware1', 'hello')\n+\n+    return NextResponse.rewrite(\n+      'https://next-data-api-endpoint.vercel.app/api/echo-headers',\n+      {\n+        request: {\n+          headers: tmpHeaders,\n+        },\n+      }\n+    )\n+  }\n+\n   if (url.pathname.includes('/middleware-external-rewrite-body')) {\n     return NextResponse.rewrite(\n       'https://next-data-api-endpoint.vercel.app/api/echo-body'"
        },
        {
            "sha": "01c67e9d2c481c9439d4697734d71867106db639",
            "filename": "test/e2e/middleware-rewrites/test/index.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/c0e8e55a6692fec7dfbb2a0293ee97cf3403a413/test%2Fe2e%2Fmiddleware-rewrites%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c0e8e55a6692fec7dfbb2a0293ee97cf3403a413/test%2Fe2e%2Fmiddleware-rewrites%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-rewrites%2Ftest%2Findex.test.ts?ref=c0e8e55a6692fec7dfbb2a0293ee97cf3403a413",
            "patch": "@@ -72,6 +72,34 @@ describe('Middleware Rewrite', () => {\n       expect(await res.text()).toEqual(body)\n     })\n \n+    it('should handle middleware rewrite with body and headers correctly', async () => {\n+      const body = JSON.stringify({ hello: 'world' })\n+      const res = await next.fetch(\n+        '/middleware-external-rewrite-body-headers-return-body',\n+        {\n+          redirect: 'manual',\n+          method: 'POST',\n+          body,\n+        }\n+      )\n+\n+      expect(res.status).toBe(200)\n+      expect(await res.text()).toEqual(body)\n+\n+      const resWithHeaders = await next.fetch(\n+        '/middleware-external-rewrite-body-headers-return-headers',\n+        {\n+          redirect: 'manual',\n+          method: 'POST',\n+          body,\n+        }\n+      )\n+\n+      expect(resWithHeaders.status).toBe(200)\n+      const json = await resWithHeaders.json()\n+      expect(json.headers['x-hello-from-middleware1']).toBe('hello')\n+    })\n+\n     it('should handle static dynamic rewrite from middleware correctly', async () => {\n       const browser = await webdriver(next.url, '/rewrite-to-static')\n "
        }
    ],
    "stats": {
        "total": 66,
        "additions": 66,
        "deletions": 0
    }
}