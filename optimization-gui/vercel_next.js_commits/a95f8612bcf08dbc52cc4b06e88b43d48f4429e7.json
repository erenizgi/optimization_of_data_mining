{
    "author": "timneutkens",
    "message": "Turbopack: Disable LightningCSS MediaRangeSyntax feature (#85086)\n\n## What?\n\nAlways downlevels MediaRangeSyntax to ensure max-width doesn't get\nupleveled to MediaRangeSyntax which is shorter but doesn't work with\nChrome devtools `show media queries` feature.\n\nFixes #72559",
    "sha": "a95f8612bcf08dbc52cc4b06e88b43d48f4429e7",
    "files": [
        {
            "sha": "3e8ab4c4f95a0a48a5cd66466e673a0f4da91c6b",
            "filename": "test/e2e/app-dir/css-media-query/app/layout.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Flayout.tsx?ref=a95f8612bcf08dbc52cc4b06e88b43d48f4429e7",
            "patch": "@@ -0,0 +1,10 @@\n+import { ReactNode } from 'react'\n+import './styles.css'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "945bdd5c1bc5703c3f99bce339cd58dc70a35f87",
            "filename": "test/e2e/app-dir/css-media-query/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Fpage.tsx?ref=a95f8612bcf08dbc52cc4b06e88b43d48f4429e7",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <h1>CSS Media Query Test</h1>\n+}"
        },
        {
            "sha": "57053cb65295d8d826b46047161cef30b4eb35bf",
            "filename": "test/e2e/app-dir/css-media-query/app/styles.css",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Fstyles.css",
            "raw_url": "https://github.com/vercel/next.js/raw/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Fstyles.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fapp%2Fstyles.css?ref=a95f8612bcf08dbc52cc4b06e88b43d48f4429e7",
            "patch": "@@ -0,0 +1,9 @@\n+h1 {\n+  color: red;\n+}\n+\n+@media screen and (max-width: 768px) {\n+  h1 {\n+    color: blue;\n+  }\n+}"
        },
        {
            "sha": "3ed160aff23ffc77c5585ae056075fa910ef4f72",
            "filename": "test/e2e/app-dir/css-media-query/css-media-query.test.ts",
            "status": "added",
            "additions": 67,
            "deletions": 0,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fcss-media-query.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fcss-media-query.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fcss-media-query.test.ts?ref=a95f8612bcf08dbc52cc4b06e88b43d48f4429e7",
            "patch": "@@ -0,0 +1,67 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('css-media-query', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should preserve max-width media query syntax instead of transpiling to range syntax', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Get all stylesheets from the document\n+    const stylesheetContents = await browser.eval(() => {\n+      const stylesheets = Array.from(document.styleSheets)\n+      const contents: string[] = []\n+\n+      for (const stylesheet of stylesheets) {\n+        try {\n+          // Only check stylesheets that have cssRules (not external ones we can't access)\n+          if (stylesheet.cssRules) {\n+            const rules = Array.from(stylesheet.cssRules)\n+            for (const rule of rules) {\n+              contents.push(rule.cssText)\n+            }\n+          }\n+        } catch (e) {\n+          // Skip stylesheets we can't access due to CORS\n+          continue\n+        }\n+      }\n+\n+      return contents\n+    })\n+\n+    // Find the media query rule\n+    const mediaQueryRule = stylesheetContents.find(\n+      (rule) => rule.includes('@media') && rule.includes('max-width')\n+    )\n+\n+    expect(mediaQueryRule).toBeDefined()\n+\n+    // Verify that the media query uses the original max-width syntax\n+    // and not the newer range syntax (width <= 768px)\n+    expect(mediaQueryRule).toContain('max-width: 768px')\n+    expect(mediaQueryRule).not.toContain('width <= 768px')\n+    expect(mediaQueryRule).not.toContain('width<=768px')\n+\n+    // Also verify the rule contains our expected styles (CSS may convert blue to rgb format)\n+    expect(mediaQueryRule).toMatch(/color:\\s*(blue|rgb\\(0,\\s*0,\\s*255\\))/)\n+  })\n+\n+  it('should apply the correct styles based on media query', async () => {\n+    const browser = await next.browser('/')\n+\n+    // Check that the h1 element exists\n+    const h1Text = await browser.elementByCss('h1').text()\n+    expect(h1Text).toBe('CSS Media Query Test')\n+\n+    // Get the computed color (should be red by default, blue on small screens)\n+    const defaultColor = await browser.eval(() => {\n+      const h1 = document.querySelector('h1')\n+      return window.getComputedStyle(h1!).color\n+    })\n+\n+    // The exact color values may vary by browser, but we can check that styles are applied\n+    expect(defaultColor).toBeDefined()\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/css-media-query/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcss-media-query%2Fnext.config.js?ref=a95f8612bcf08dbc52cc4b06e88b43d48f4429e7",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "8cdca1084445f03c4ff8e908063e916f92c9fc67",
            "filename": "test/integration/css-features/test/browserslist.test.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fintegration%2Fcss-features%2Ftest%2Fbrowserslist.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/test%2Fintegration%2Fcss-features%2Ftest%2Fbrowserslist.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-features%2Ftest%2Fbrowserslist.test.js?ref=a95f8612bcf08dbc52cc4b06e88b43d48f4429e7",
            "patch": "@@ -110,7 +110,7 @@ describe('Browserslist: New', () => {\n \n         if (process.env.IS_TURBOPACK_TEST) {\n           expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n-            `\"a{all:initial}@media (resolution>=2x){.image{background-image:url(data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==)}}\"`\n+            `\"a{all:initial}@media (min-resolution:2x){.image{background-image:url(data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==)}}\"`\n           )\n         } else {\n           expect(cssContentWithoutSourceMap).toMatchInlineSnapshot("
        },
        {
            "sha": "65d6e7d84df96dfabe2478439db28b1847ebb032",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a95f8612bcf08dbc52cc4b06e88b43d48f4429e7/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=a95f8612bcf08dbc52cc4b06e88b43d48f4429e7",
            "patch": "@@ -78,12 +78,13 @@ async fn get_lightningcss_browser_targets(\n             Ok(if handle_nesting {\n                 Vc::cell(Targets {\n                     browsers: browserslist_browsers,\n-                    include: Features::Nesting,\n+                    include: Features::Nesting | Features::MediaRangeSyntax,\n                     ..Default::default()\n                 })\n             } else {\n                 Vc::cell(Targets {\n                     browsers: browserslist_browsers,\n+                    include: Features::MediaRangeSyntax,\n                     ..Default::default()\n                 })\n             })"
        }
    ],
    "stats": {
        "total": 100,
        "additions": 98,
        "deletions": 2
    }
}