{
    "author": "SyMind",
    "message": "feat: use Rspack persistent cache by default (#81399)\n\nRspack now enables persistent caching by default.\n\n## Performance Comparison\n\n### Pages Router\n\nI benchmarked performance using this repo:\nhttps://github.com/SyMind/chakra-ui-docs/tree/next-rspack to test the\nNext.js pages router.\n\nI tested the performance with the following steps:\n\n1. Execute `pnpm run dev`\n2. Wait for the server to be ready (indicated by the 'Ready' message)\n3. Run curl on the root endpoint (/)\n\nEach build was run 5 times, and the shortest time to reach \"Compiled\nsuccessfully\" was recorded.\n\nTest environment: Apple M1 Pro CPU\n\n| Tool | Build without cache | Build with cache | Dev without cache |\nDev with cache |\n\n|-------------|---------------------|------------------|---------------------------------|----------------|\n| Rspack | 3.8s | 2.6s | 1.7s | 3ms |\n| Webpack | 14.0s | 4.0s | 7.8s | 3.2s |\n\n### App Router\n\nI benchmarked performance using this repo:\nhttps://github.com/SyMind/shadcn-ui/tree/next-rspack to test the Next.js\napp router.\n\nI tested the performance with the following steps:\n\n1. Execute `pnpm run dev` or `pnpm run build`\n2. Wait for the server to be ready (indicated by the 'Ready' message)\n3. Run curl on the root endpoint (/)\n\nEach build was run 5 times, and the shortest time to reach \"Compiled\nsuccessfully\" was recorded.\n\nTest environment: Apple M1 Pro CPU\n\n| Bundler | Build (No Cache) | Build (Cache) | Dev (No Cache) | Dev\n(Cache) |\n\n|------------|----------------------|-------------------|--------------------|-----------------|\n| Rspack | 12.3s | 5.9s | 7.1s | 1941ms |\n| Webpack | 27.0s | 13.0s | 11s | 9.6s |\n\n## About Rspack Persistent Cache Strategy\n\n> packages/next/src/server/dev/hot-reloader-rspack.ts\n\nRspack's persistent caching differs from Webpack in how it manages\nmodule graphs. While Webpack incrementally updates modules, Rspack\noperates on complete module graph snapshots for cache restoration.\n\nProblem:\n- Next.js dev server starts with no page modules in the initial entry\npoints\n- When Rspack restores from persistent cache, it finds no modules and\npurges the entire module graph\n- Later page requests find no cached module information, preventing\ncache reuse\n\nSolution:\n- Track successfully built page entries after each compilation\n- Restore these entries on dev server restart to maintain module graph\ncontinuity\n- This ensures previously compiled pages can leverage persistent cache\nfor faster builds\n\n## Note\n\nI have updated the test case configuration in\n`test/integration/telemetry/next.config.use-cache` to disable persistent\ncache.\n\nThis is because, whether using webpack or Rspack, when persistent\ncaching is enabled, modules are no longer recompiled by loaders, which\nprevents the Telemetry plugin from collecting information.\n\nPlease note that this issue also exists with webpack. You can reproduce\nit locally by running `pnpm run test\ntest/integration/telemetry/test/config.test.js` twice.",
    "sha": "aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
    "files": [
        {
            "sha": "b12dbc1d9c28bec95407142e7e27dbae26b8cdd0",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -2361,7 +2361,7 @@ export default async function getBaseWebpackConfig(\n     serverReferenceHashSalt: encryptionKey,\n   })\n \n-  const cache: any = {\n+  const cache: webpack.Configuration['cache'] = {\n     type: 'filesystem',\n     // Disable memory cache in development in favor of our own MemoryWithGcCachePlugin.\n     maxMemoryGenerations: dev ? 0 : Infinity, // Infinity is default value for production in webpack currently.\n@@ -2407,6 +2407,30 @@ export default async function getBaseWebpackConfig(\n \n   webpack5Config.cache = cache\n \n+  if (isRspack) {\n+    const buildDependencies: string[] = []\n+    if (config.configFile) {\n+      buildDependencies.push(config.configFile)\n+    }\n+    if (babelConfigFile) {\n+      buildDependencies.push(babelConfigFile)\n+    }\n+    if (jsConfigPath) {\n+      buildDependencies.push(jsConfigPath)\n+    }\n+\n+    // @ts-ignore\n+    webpack5Config.experiments.cache = {\n+      type: 'persistent',\n+      buildDependencies,\n+      storage: {\n+        type: 'filesystem',\n+        directory: cache.cacheDirectory,\n+      },\n+      version: `${__dirname}|${process.env.__NEXT_VERSION}|${configVars}`,\n+    }\n+  }\n+\n   if (process.env.NEXT_WEBPACK_LOGGING) {\n     const infra = process.env.NEXT_WEBPACK_LOGGING.includes('infrastructure')\n     const profileClient ="
        },
        {
            "sha": "8ffbbc2bb0abf4a70f544463a1aa5ac5cc54013c",
            "filename": "packages/next/src/server/dev/hot-reloader-rspack.ts",
            "status": "added",
            "additions": 243,
            "deletions": 0,
            "changes": 243,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-rspack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-rspack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-rspack.ts?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -0,0 +1,243 @@\n+import path from 'path'\n+import fs from 'fs/promises'\n+import { createHash } from 'crypto'\n+import HotReloaderWebpack from './hot-reloader-webpack'\n+import { BUILT, EntryTypes, getEntries } from './on-demand-entry-handler'\n+import type { __ApiPreviewProps } from '../api-utils'\n+import type { RouteDefinition } from '../route-definitions/route-definition'\n+import type { MultiCompiler } from 'webpack'\n+import { COMPILER_NAMES } from '../../shared/lib/constants'\n+\n+/**\n+ * Rspack Persistent Cache Strategy for Next.js Development\n+ *\n+ * Rspack's persistent caching differs from Webpack in how it manages module graphs.\n+ * While Webpack incrementally updates modules, Rspack operates on complete module\n+ * graph snapshots for cache restoration.\n+ *\n+ * Problem:\n+ * - Next.js dev server starts with no page modules in the initial entry points\n+ * - When Rspack restores from persistent cache, it finds no modules and purges\n+ *   the entire module graph\n+ * - Later page requests find no cached module information, preventing cache reuse\n+ *\n+ * Solution:\n+ * - Track successfully built page entries after each compilation\n+ * - Restore these entries on dev server restart to maintain module graph continuity\n+ * - This ensures previously compiled pages can leverage persistent cache for faster builds\n+ */\n+export default class HotReloaderRspack extends HotReloaderWebpack {\n+  private builtEntriesCachePath?: string\n+\n+  private isClientCacheEnabled = false\n+  private isServerCacheEnabled = false\n+  private isEdgeServerCacheEnabled = false\n+\n+  public async afterCompile(multiCompiler: MultiCompiler): Promise<void> {\n+    // Always initialize the fallback error watcher for Rspack.\n+    // Rspack may restore/retain the previous build's error state, so without this\n+    // a page that previously failed to build might not be rebuilt on the next request.\n+    await super.buildFallbackError()\n+\n+    const rspackStartSpan = this.hotReloaderSpan.traceChild(\n+      'rspack-after-compile'\n+    )\n+    await rspackStartSpan.traceAsyncFn(async () => {\n+      const hash = createHash('sha1')\n+      multiCompiler.compilers.forEach((compiler) => {\n+        const cache = compiler.options.cache\n+        if (typeof cache === 'object' && 'version' in cache && cache.version) {\n+          hash.update(cache.version)\n+          if (compiler.name === COMPILER_NAMES.client) {\n+            this.isClientCacheEnabled = true\n+          } else if (compiler.name === COMPILER_NAMES.server) {\n+            this.isServerCacheEnabled = true\n+          } else if (compiler.name === COMPILER_NAMES.edgeServer) {\n+            this.isEdgeServerCacheEnabled = true\n+          }\n+        } else {\n+          hash.update('-')\n+        }\n+        return undefined\n+      })\n+      this.builtEntriesCachePath = path.join(\n+        this.distDir,\n+        'cache',\n+        'rspack',\n+        hash.digest('hex').substring(0, 16),\n+        'built-entries.json'\n+      )\n+\n+      const hasBuiltEntriesCache = await fs\n+        .access(this.builtEntriesCachePath)\n+        .then(\n+          () => true,\n+          () => false\n+        )\n+      if (hasBuiltEntriesCache) {\n+        try {\n+          const builtEntries: ReturnType<typeof getEntries> = JSON.parse(\n+            (await fs.readFile(this.builtEntriesCachePath, 'utf-8')) || '{}'\n+          )\n+\n+          await Promise.all(\n+            Object.keys(builtEntries).map(async (entryKey) => {\n+              const entryData = builtEntries[entryKey]\n+\n+              const isEntry = entryData.type === EntryTypes.ENTRY\n+              const isChildEntry = entryData.type === EntryTypes.CHILD_ENTRY\n+\n+              // Check if the page was removed or disposed and remove it\n+              if (isEntry) {\n+                const pageExists =\n+                  !entryData.dispose &&\n+                  (await fs.access(entryData.absolutePagePath).then(\n+                    () => true,\n+                    () => false\n+                  ))\n+                if (!pageExists) {\n+                  delete builtEntries[entryKey]\n+                  return\n+                } else if (\n+                  !('hash' in builtEntries[entryKey]) ||\n+                  builtEntries[entryKey].hash !==\n+                    (await calculateFileHash(entryData.absolutePagePath))\n+                ) {\n+                  delete builtEntries[entryKey]\n+                  return\n+                }\n+              }\n+\n+              // For child entries, if it has an entry file and it's gone, remove it\n+              if (isChildEntry) {\n+                if (entryData.absoluteEntryFilePath) {\n+                  const pageExists =\n+                    !entryData.dispose &&\n+                    (await fs.access(entryData.absoluteEntryFilePath).then(\n+                      () => true,\n+                      () => false\n+                    ))\n+                  if (!pageExists) {\n+                    delete builtEntries[entryKey]\n+                    return\n+                  } else {\n+                    if (\n+                      !('hash' in builtEntries[entryKey]) ||\n+                      builtEntries[entryKey].hash !==\n+                        (await calculateFileHash(\n+                          entryData.absoluteEntryFilePath\n+                        ))\n+                    ) {\n+                      delete builtEntries[entryKey]\n+                      return\n+                    }\n+                  }\n+                }\n+              }\n+            })\n+          )\n+          Object.assign(getEntries(multiCompiler.outputPath), builtEntries)\n+        } catch (error) {\n+          console.error('Rspack failed to read built entries cache: ', error)\n+        }\n+      }\n+    })\n+  }\n+\n+  public async ensurePage({\n+    page,\n+    clientOnly,\n+    appPaths,\n+    definition,\n+    isApp,\n+    url,\n+  }: {\n+    page: string\n+    clientOnly: boolean\n+    appPaths?: ReadonlyArray<string> | null\n+    isApp?: boolean\n+    definition?: RouteDefinition\n+    url?: string\n+  }): Promise<void> {\n+    await super.ensurePage({\n+      page,\n+      clientOnly,\n+      appPaths,\n+      definition,\n+      isApp,\n+      url,\n+    })\n+    const entries = getEntries(this.multiCompiler!.outputPath)\n+    const builtEntries: { [entryName: string]: any } = {}\n+    await Promise.all(\n+      Object.keys(entries).map(async (entryName) => {\n+        const entry = entries[entryName]\n+        if (entry.status !== BUILT) return\n+        const result =\n+          /^(client|server|edge-server)@(app|pages|root)@(.*)/g.exec(entryName)\n+        const [, key /* pageType */, ,] = result! // this match should always happen\n+        if (key === 'client' && !this.isClientCacheEnabled) return\n+        if (key === 'server' && !this.isServerCacheEnabled) return\n+        if (key === 'edge-server' && !this.isEdgeServerCacheEnabled) return\n+\n+        // TODO: Rspack does not store middleware entries in persistent cache, causing\n+        // test/integration/middleware-src/test/index.test.ts to fail. This is a temporary\n+        // workaround to skip middleware entry caching until Rspack properly supports it.\n+        if (page === '/middleware') {\n+          return\n+        }\n+\n+        let hash: string | undefined\n+        if (entry.type === EntryTypes.ENTRY) {\n+          hash = await calculateFileHash(entry.absolutePagePath)\n+        } else if (entry.absoluteEntryFilePath) {\n+          hash = await calculateFileHash(entry.absoluteEntryFilePath)\n+        }\n+        if (!hash) {\n+          return\n+        }\n+\n+        builtEntries[entryName] = entry\n+        builtEntries[entryName].hash = hash\n+      })\n+    )\n+\n+    const hasBuitEntriesCache = await fs\n+      .access(this.builtEntriesCachePath!)\n+      .then(\n+        () => true,\n+        () => false\n+      )\n+    try {\n+      if (!hasBuitEntriesCache) {\n+        await fs.mkdir(path.dirname(this.builtEntriesCachePath!), {\n+          recursive: true,\n+        })\n+      }\n+      await fs.writeFile(\n+        this.builtEntriesCachePath!,\n+        JSON.stringify(builtEntries, null, 2)\n+      )\n+    } catch (error) {\n+      console.error('Rspack failed to write built entries cache: ', error)\n+    }\n+  }\n+}\n+\n+async function calculateFileHash(\n+  filePath: string,\n+  algorithm: string = 'sha256'\n+): Promise<string | undefined> {\n+  if (\n+    !(await fs.access(filePath).then(\n+      () => true,\n+      () => false\n+    ))\n+  ) {\n+    return\n+  }\n+  const fileBuffer = await fs.readFile(filePath)\n+  const hash = createHash(algorithm)\n+  hash.update(fileBuffer)\n+  return hash.digest('hex')\n+}"
        },
        {
            "sha": "a821c78ccdcb8172f804baf75be0296564eb32d6",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 13,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -226,18 +226,18 @@ function erroredPages(compilation: webpack.Compilation) {\n export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n   private hasAppRouterEntrypoints: boolean\n   private hasPagesRouterEntrypoints: boolean\n-  private dir: string\n-  private buildId: string\n+  protected dir: string\n+  protected buildId: string\n   private encryptionKey: string\n-  private middlewares: ((\n+  protected middlewares: ((\n     req: IncomingMessage,\n     res: ServerResponse,\n     next: () => void\n   ) => Promise<void>)[]\n-  private pagesDir?: string\n-  private distDir: string\n+  protected pagesDir?: string\n+  protected distDir: string\n   private webpackHotMiddleware?: WebpackHotMiddleware\n-  private config: NextConfigComplete\n+  protected config: NextConfigComplete\n   private clientStats: webpack.Stats | null\n   private clientError: Error | null = null\n   private serverError: Error | null = null\n@@ -246,13 +246,13 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n   private serverChunkNames?: Set<string>\n   private prevChunkNames?: Set<any>\n   private onDemandEntries?: ReturnType<typeof onDemandEntryHandler>\n-  private previewProps: __ApiPreviewProps\n+  protected previewProps: __ApiPreviewProps\n   private watcher: any\n   private rewrites: CustomRoutes['rewrites']\n   private fallbackWatcher: any\n-  private hotReloaderSpan: Span\n+  protected hotReloaderSpan: Span\n   private pagesMapping: { [key: string]: string } = {}\n-  private appDir?: string\n+  protected appDir?: string\n   private telemetry: Telemetry\n   private resetFetch: () => void\n   private lockfile: Lockfile | undefined\n@@ -1243,6 +1243,8 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       this.activeWebpackConfigs\n     ) as unknown as webpack.MultiCompiler\n \n+    await this.afterCompile(this.multiCompiler)\n+\n     // Copy over the filesystem so that it is shared between all compilers.\n     const inputFileSystem = this.multiCompiler.compilers[0].inputFileSystem\n     for (const compiler of this.multiCompiler.compilers) {\n@@ -1643,7 +1645,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       }),\n     })\n \n-    this.middlewares = [\n+    this.middlewares.push(\n       getOverlayMiddleware({\n         rootDirectory: this.dir,\n         isSrcDir: this.isSrcDir,\n@@ -1694,9 +1696,8 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n               getDevServerUrl: () => process.env.__NEXT_PRIVATE_ORIGIN,\n             }),\n           ]\n-        : []),\n-    ]\n-\n+        : [])\n+    )\n     setStackFrameResolver(async (request) => {\n       return getOriginalStackFrames({\n         isServer: request.isServer,\n@@ -1711,6 +1712,8 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     })\n   }\n \n+  protected async afterCompile(_multiCompiler: webpack.MultiCompiler) {}\n+\n   public invalidate(\n     { reloadAfterInvalidation }: { reloadAfterInvalidation: boolean } = {\n       reloadAfterInvalidation: false,"
        },
        {
            "sha": "6054c5331f3dc7658568f05ab747c00362130291",
            "filename": "packages/next/src/server/dev/on-demand-entry-handler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -8,7 +8,6 @@ import type {\n } from '../../shared/lib/app-router-types'\n import type { CompilerNameValues } from '../../shared/lib/constants'\n import type { RouteDefinition } from '../route-definitions/route-definition'\n-import type HotReloaderWebpack from './hot-reloader-webpack'\n \n import createDebug from 'next/dist/compiled/debug'\n import { EventEmitter } from 'events'\n@@ -39,6 +38,7 @@ import { PAGE_SEGMENT_KEY } from '../../shared/lib/segment'\n import {\n   HMR_MESSAGE_SENT_TO_BROWSER,\n   HMR_MESSAGE_SENT_TO_SERVER,\n+  type NextJsHotReloaderInterface,\n } from './hot-reloader-types'\n import { isAppPageRouteDefinition } from '../route-definitions/app-page-route-definition'\n import { scheduleOnNextTick } from '../../lib/scheduler'\n@@ -548,7 +548,7 @@ export function onDemandEntryHandler({\n   rootDir,\n   appDir,\n }: {\n-  hotReloader: HotReloaderWebpack\n+  hotReloader: NextJsHotReloaderInterface\n   maxInactiveAge: number\n   multiCompiler: webpack.MultiCompiler\n   nextConfig: NextConfigComplete"
        },
        {
            "sha": "c2d8b8c9f96ec272d8c1154048e49ebe87532aa3",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -215,10 +215,14 @@ async function startWatcher(\n         )\n       })()\n     : await (async () => {\n-        const HotReloaderWebpack = (\n-          require('../../dev/hot-reloader-webpack') as typeof import('../../dev/hot-reloader-webpack')\n-        ).default\n-        return new HotReloaderWebpack(opts.dir, {\n+        const HotReloader = process.env.NEXT_RSPACK\n+          ? (\n+              require('../../dev/hot-reloader-rspack') as typeof import('../../dev/hot-reloader-rspack')\n+            ).default\n+          : (\n+              require('../../dev/hot-reloader-webpack') as typeof import('../../dev/hot-reloader-webpack')\n+            ).default\n+        return new HotReloader(opts.dir, {\n           isSrcDir: opts.isSrcDir,\n           appDir,\n           pagesDir,"
        },
        {
            "sha": "272cde36a999d10f347cd12f103ff1b132e9f3de",
            "filename": "test/development/app-dir/ssr-in-rsc/next.config.js",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fdevelopment%2Fapp-dir%2Fssr-in-rsc%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fdevelopment%2Fapp-dir%2Fssr-in-rsc%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fssr-in-rsc%2Fnext.config.js?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -1,6 +1,19 @@\n /**\n  * @type {import('next').NextConfig}\n  */\n-const nextConfig = {}\n+const nextConfig = {\n+  webpack(config) {\n+    if (process.env.NEXT_RSPACK) {\n+      // Disable persistent cache when using Rspack.\n+      // Rspack may reuse previously compiled pages from its persistent cache.\n+      // In development, webpack typically compiles only the page being requested.\n+      // Keeping Rspack's persistent cache enabled can cause tests to surface errors\n+      // from previously compiled pages, making it hard to assert errors for the\n+      // currently requested page only.\n+      config.cache = false\n+    }\n+    return config\n+  },\n+}\n \n module.exports = nextConfig"
        },
        {
            "sha": "8948583200ffb5ffab17609ab75fb3aeffd1baa9",
            "filename": "test/development/basic/hmr/run-error-recovery-hmr-test.util.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 71,
            "changes": 142,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -163,16 +163,16 @@ export function runErrorRecoveryHmrTest(nextConfig: {\n \n         if (process.env.IS_TURBOPACK_TEST) {\n           expect(source).toMatchInlineSnapshot(`\n-       \"./pages/hmr/about2.js (7:1)\n-       Parsing ecmascript source code failed\n-         5 |     div\n-         6 |   )\n-       > 7 | }\n-           | ^\n-         8 |\n-\n-       Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\"\n-      `)\n+                  \"./pages/hmr/about2.js (7:1)\n+                  Parsing ecmascript source code failed\n+                    5 |     div\n+                    6 |   )\n+                  > 7 | }\n+                      | ^\n+                    8 |\n+\n+                  Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\"\n+                `)\n         } else if (process.env.NEXT_RSPACK) {\n           expect(trimEndMultiline(source)).toMatchInlineSnapshot(`\n            \"./pages/hmr/about2.js\n@@ -200,28 +200,28 @@ export function runErrorRecoveryHmrTest(nextConfig: {\n           `)\n         } else {\n           expect(source).toMatchInlineSnapshot(`\n-          \"./pages/hmr/about2.js\n-          Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n-             ,-[7:1]\n-           4 |       <p>This is the about page.</p>\n-           5 |     div\n-           6 |   )\n-           7 | }\n-             : ^\n-             \\`----\n-            x Expected '</', got '<eof>'\n-             ,-[7:3]\n-           5 |     div\n-           6 |   )\n-           7 | }\n-             \\`----\n-\n-          Caused by:\n-              Syntax Error\n-\n-          Import trace for requested module:\n-          ./pages/hmr/about2.js\"\n-        `)\n+                     \"./pages/hmr/about2.js\n+                     Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+                        ,-[7:1]\n+                      4 |       <p>This is the about page.</p>\n+                      5 |     div\n+                      6 |   )\n+                      7 | }\n+                        : ^\n+                        \\`----\n+                       x Expected '</', got '<eof>'\n+                        ,-[7:3]\n+                      5 |     div\n+                      6 |   )\n+                      7 | }\n+                        \\`----\n+\n+                     Caused by:\n+                         Syntax Error\n+\n+                     Import trace for requested module:\n+                     ./pages/hmr/about2.js\"\n+                  `)\n         }\n       }\n     )\n@@ -442,25 +442,25 @@ export function runErrorRecoveryHmrTest(nextConfig: {\n         } else if (process.env.NEXT_RSPACK) {\n           expect(trimEndMultiline(await getRedboxSource(browser)))\n             .toMatchInlineSnapshot(`\n-         \"./components/parse-error.xyz\n-           × Module parse failed:\n-           ╰─▶   × JavaScript parse error: Expression expected\n-                  ╭─[3:0]\n-                1 │ This\n-                2 │ is\n-                3 │ }}}\n-                  · ─\n-                4 │ invalid\n-                5 │ js\n-                  ╰────\n-\n-           help:\n-                 You may need an appropriate loader to handle this file type.\n-\n-         Import trace for requested module:\n-         ./components/parse-error.xyz\n-         ./pages/hmr/about8.js\"\n-        `)\n+           \"./components/parse-error.xyz\n+             × Module parse failed:\n+             ╰─▶   × JavaScript parse error: Expression expected\n+                    ╭─[3:0]\n+                  1 │ This\n+                  2 │ is\n+                  3 │ }}}\n+                    · ─\n+                  4 │ invalid\n+                  5 │ js\n+                    ╰────\n+\n+             help:\n+                   You may need an appropriate loader to handle this file type.\n+\n+           Import trace for requested module:\n+           ./components/parse-error.xyz\n+           ./pages/hmr/about8.js\"\n+          `)\n         } else {\n           expect(await getRedboxSource(browser)).toMatchInlineSnapshot(`\n                       \"./components/parse-error.xyz\n@@ -513,26 +513,26 @@ export function runErrorRecoveryHmrTest(nextConfig: {\n         if (process.env.IS_TURBOPACK_TEST) {\n           expect(next.normalizeTestDirContent(redboxSource))\n             .toMatchInlineSnapshot(`\n-         \"./components/parse-error.js (3:1)\n-         Parsing ecmascript source code failed\n-           1 | This\n-           2 | is\n-         > 3 | }}}\n-             | ^\n-           4 | invalid\n-           5 | js\n-\n-         Expression expected\n-\n-         Import traces:\n-           Browser:\n-             ./components/parse-error.js\n-             ./pages/hmr/about9.js\n-\n-           SSR:\n-             ./components/parse-error.js\n-             ./pages/hmr/about9.js\"\n-        `)\n+                    \"./components/parse-error.js (3:1)\n+                    Parsing ecmascript source code failed\n+                      1 | This\n+                      2 | is\n+                    > 3 | }}}\n+                        | ^\n+                      4 | invalid\n+                      5 | js\n+\n+                    Expression expected\n+\n+                    Import traces:\n+                      Browser:\n+                        ./components/parse-error.js\n+                        ./pages/hmr/about9.js\n+\n+                      SSR:\n+                        ./components/parse-error.js\n+                        ./pages/hmr/about9.js\"\n+                  `)\n         } else if (process.env.NEXT_RSPACK) {\n           expect(trimEndMultiline(next.normalizeTestDirContent(redboxSource)))\n             .toMatchInlineSnapshot(`"
        },
        {
            "sha": "cff376874299b3c4c652c429994744652f45364f",
            "filename": "test/development/mcp-server/fixtures/default-template/next.config.js",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fnext.config.js?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -1 +1,14 @@\n-module.exports = {}\n+module.exports = {\n+  webpack(config) {\n+    if (process.env.NEXT_RSPACK) {\n+      // Disable persistent cache when using Rspack.\n+      // Rspack may reuse previously compiled pages from its persistent cache.\n+      // In development, webpack typically compiles only the page being requested.\n+      // Keeping Rspack's persistent cache enabled can cause tests to surface errors\n+      // from previously compiled pages, making it hard to assert errors for the\n+      // currently requested page only.\n+      config.cache = false\n+    }\n+    return config\n+  },\n+}"
        },
        {
            "sha": "92206b02961a0573bc729661a50aeead8fd1f644",
            "filename": "test/integration/css/test/basic-global-support.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss%2Ftest%2Fbasic-global-support.test.ts?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -404,6 +404,13 @@ module.exports = {\n              .blue-text{color:#00f}\",\n              ]\n             `)\n+          } else if (process.env.NEXT_RSPACK && useLightningcss) {\n+            expect(cssContent).toMatchInlineSnapshot(`\n+             [\n+               \"/_next/static/css/HASH.css:\n+             .red-text{color:red;font-weight:bolder}.blue-text{color:#00f;font-weight:bolder}\",\n+             ]\n+            `)\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              [\n@@ -571,6 +578,13 @@ module.exports = {\n              .blue-text{color:#00f}\",\n              ]\n             `)\n+          } else if (process.env.NEXT_RSPACK && useLightningcss) {\n+            expect(cssContent).toMatchInlineSnapshot(`\n+             [\n+               \"/_next/static/css/HASH.css:\n+             .red-text{color:red;background-image:url(/_next/static/media/dark.6b01655b.svg),url(/_next/static/media/dark2.6b01655b.svg)}.blue-text{color:#00f;background-image:url(/_next/static/media/light.2da1d3d6.svg);font-weight:bolder}\",\n+             ]\n+            `)\n           } else if (useLightningcss) {\n             expect(cssContent).toMatchInlineSnapshot(`\n              ["
        },
        {
            "sha": "3aac2973a6e2f8fa6319c3b93c41c04b850d1be0",
            "filename": "test/integration/css/test/css-compilation.test.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 0,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.ts?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -91,6 +91,10 @@ module.exports = {\n                 expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n                   `\"@media (min-width:480px) and (not (min-width:768px)){::placeholder{color:green}}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}.transform-parsing{transform:translate3d(0px,0px)}.css-grid-shorthand{grid-column:span 2}.g-docs-sidenav .filter::-webkit-input-placeholder{opacity:.8}\"`\n                 )\n+              } else if (process.env.NEXT_RSPACK && useLightningcss) {\n+                expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n+                  `\"@media (min-width:480px) and (not (min-width:768px)){::placeholder{color:green}}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}.transform-parsing{transform:translate3d(0px,0px)}.css-grid-shorthand{grid-column:span 2}.g-docs-sidenav .filter::-webkit-input-placeholder{opacity:.8}\"`\n+                )\n               } else if (useLightningcss) {\n                 expect(cssContentWithoutSourceMap).toMatchInlineSnapshot(\n                   `\"@media (min-width:480px) and (not (min-width:768px)){::placeholder{color:green}}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}.transform-parsing{transform:translate3d(0,0)}.css-grid-shorthand{grid-column:span 2}.g-docs-sidenav .filter::-webkit-input-placeholder{opacity:.8}\"`\n@@ -147,6 +151,38 @@ module.exports = {\n                    grid-column: span 2;\n                  }\n \n+                 .g-docs-sidenav .filter::-webkit-input-placeholder {\n+                   opacity: 80%;\n+                 }\n+                 \",\n+                   ],\n+                   \"version\": 3,\n+                 }\n+                `)\n+              } else if (process.env.NEXT_RSPACK && !useLightningcss) {\n+                expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n+                 {\n+                   \"mappings\": \"AAAA,+CACE,cACE,WACF,CACF,CAEA,cACE,2CACF,CAEA,mBACE,0BACF,CAEA,oBACE,kBACF,CAEA,mDACE,WACF\",\n+                   \"names\": [],\n+                   \"sourcesContent\": [\n+                     \"@media (480px <= width < 768px) {\n+                   ::placeholder {\n+                     color: green;\n+                   }\n+                 }\n+\n+                 .flex-parsing {\n+                   flex: 0 0 calc(50% - var(--vertical-gutter));\n+                 }\n+\n+                 .transform-parsing {\n+                   transform: translate3d(0px, 0px);\n+                 }\n+\n+                 .css-grid-shorthand {\n+                   grid-column: span 2;\n+                 }\n+\n                  .g-docs-sidenav .filter::-webkit-input-placeholder {\n                    opacity: 80%;\n                  }"
        },
        {
            "sha": "bf1570454dd148d64f14f3581e3821aeff598b71",
            "filename": "test/integration/telemetry/next.config.use-cache",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fintegration%2Ftelemetry%2Fnext.config.use-cache",
            "raw_url": "https://github.com/vercel/next.js/raw/aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229/test%2Fintegration%2Ftelemetry%2Fnext.config.use-cache",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Fnext.config.use-cache?ref=aa8a243e7213d77abeb71c48f6ab5e7f5c2c1229",
            "patch": "@@ -3,4 +3,13 @@ module.exports = {\n   cacheHandlers: {\n     custom: require.resolve('next/dist/server/lib/cache-handlers/default.external'),\n   },\n+  webpack(config) {\n+    if (process.env.NEXT_RSPACK) {\n+      // Disable persistent cache.\n+      // If enabled, test case modules will not be recompiled by loaders,\n+      // which prevents the Telemetry plugin from collecting information.\n+      config.cache = false\n+    }\n+    return config\n+  }\n }"
        }
    ],
    "stats": {
        "total": 545,
        "additions": 452,
        "deletions": 93
    }
}