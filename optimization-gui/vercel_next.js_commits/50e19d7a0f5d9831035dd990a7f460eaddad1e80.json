{
    "author": "huozhi",
    "message": "[metadata] set bypass ua regex string for ppr routes (#75977)",
    "sha": "50e19d7a0f5d9831035dd990a7f460eaddad1e80",
    "files": [
        {
            "sha": "b4e767e01a4c477f87b0666da91e51dbc4cc4cdd",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 22,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/50e19d7a0f5d9831035dd990a7f460eaddad1e80/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/50e19d7a0f5d9831035dd990a7f460eaddad1e80/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=50e19d7a0f5d9831035dd990a7f460eaddad1e80",
            "patch": "@@ -80,7 +80,6 @@ import {\n   UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n   UNDERSCORE_NOT_FOUND_ROUTE,\n   DYNAMIC_CSS_MANIFEST,\n-  RESPONSE_CONFIG_MANIFEST,\n } from '../shared/lib/constants'\n import {\n   getSortedRoutes,\n@@ -1341,24 +1340,6 @@ export default async function build(\n         NextBuildContext.clientRouterFilters = clientRouterFilters\n       }\n \n-      if (config.experimental.streamingMetadata) {\n-        // Write html limited bots config to response-config-manifest\n-        const responseConfigManifestPath = path.join(\n-          distDir,\n-          RESPONSE_CONFIG_MANIFEST\n-        )\n-        const responseConfigManifest: {\n-          version: number\n-          htmlLimitedBots: string\n-        } = {\n-          version: 0,\n-          htmlLimitedBots:\n-            config.experimental.htmlLimitedBots ||\n-            HTML_LIMITED_BOT_UA_RE_STRING,\n-        }\n-        await writeManifest(responseConfigManifestPath, responseConfigManifest)\n-      }\n-\n       // Ensure commonjs handling is used for files in the distDir (generally .next)\n       // Files outside of the distDir can be \"type\": \"module\"\n       await writeFileUtf8(\n@@ -2269,9 +2250,6 @@ export default async function build(\n               path.join(SERVER_DIRECTORY, FUNCTIONS_CONFIG_MANIFEST),\n               path.join(SERVER_DIRECTORY, MIDDLEWARE_MANIFEST),\n               path.join(SERVER_DIRECTORY, MIDDLEWARE_BUILD_MANIFEST + '.js'),\n-              ...(config.experimental.streamingMetadata\n-                ? [RESPONSE_CONFIG_MANIFEST]\n-                : []),\n               ...(!process.env.TURBOPACK\n                 ? [\n                     path.join(\n@@ -2778,6 +2756,10 @@ export default async function build(\n                 ? true\n                 : undefined\n \n+            const htmlBotsRegexString =\n+              config.experimental.htmlLimitedBots ||\n+              HTML_LIMITED_BOT_UA_RE_STRING\n+\n             // this flag is used to selectively bypass the static cache and invoke the lambda directly\n             // to enable server actions on static routes\n             const bypassFor: RouteHas[] = [\n@@ -2787,6 +2769,17 @@ export default async function build(\n                 key: 'content-type',\n                 value: 'multipart/form-data;.*',\n               },\n+              // If it's PPR rendered non-static page, bypass the PPR cache when streaming metadata is enabled.\n+              // This will skip the postpone data for those bots requests and instead produce a dynamic render.\n+              ...(isRoutePPREnabled && config.experimental.streamingMetadata\n+                ? [\n+                    {\n+                      type: 'header',\n+                      key: 'user-agent',\n+                      value: htmlBotsRegexString,\n+                    },\n+                  ]\n+                : []),\n             ]\n \n             // We should collect all the dynamic routes into a single array for"
        },
        {
            "sha": "82f1b064100c1c80f8a87d9002441b90ef8a3619",
            "filename": "packages/next/src/shared/lib/constants.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/50e19d7a0f5d9831035dd990a7f460eaddad1e80/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/50e19d7a0f5d9831035dd990a7f460eaddad1e80/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts?ref=50e19d7a0f5d9831035dd990a7f460eaddad1e80",
            "patch": "@@ -42,7 +42,6 @@ export const EXPORT_DETAIL = 'export-detail.json'\n export const PRERENDER_MANIFEST = 'prerender-manifest.json'\n export const ROUTES_MANIFEST = 'routes-manifest.json'\n export const IMAGES_MANIFEST = 'images-manifest.json'\n-export const RESPONSE_CONFIG_MANIFEST = 'response-config-manifest.json'\n export const SERVER_FILES_MANIFEST = 'required-server-files.json'\n export const DEV_CLIENT_PAGES_MANIFEST = '_devPagesManifest.json'\n export const MIDDLEWARE_MANIFEST = 'middleware-manifest.json'"
        },
        {
            "sha": "3747c70a3f46ceed0e08eed63cd390d4338e9ada",
            "filename": "test/production/app-dir/metadata-streaming-config/app/dynamic/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fdynamic%2Fpage.tsx?ref=50e19d7a0f5d9831035dd990a7f460eaddad1e80",
            "patch": "@@ -0,0 +1,6 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+  return <p>dynamic</p>\n+}"
        },
        {
            "sha": "a065865841cbca3851753198c0bc52d9c6063274",
            "filename": "test/production/app-dir/metadata-streaming-config/app/ppr/layout.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fppr%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fppr%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fppr%2Flayout.tsx?ref=50e19d7a0f5d9831035dd990a7f460eaddad1e80",
            "patch": "@@ -0,0 +1,5 @@\n+import { Suspense } from 'react'\n+\n+export default function Root({ children }) {\n+  return <Suspense fallback={<p>Loading...</p>}>{children}</Suspense>\n+}"
        },
        {
            "sha": "e350f0d435c840569fb0e4faf94af79cc9c7f06f",
            "filename": "test/production/app-dir/metadata-streaming-config/app/ppr/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fppr%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fppr%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fapp%2Fppr%2Fpage.tsx?ref=50e19d7a0f5d9831035dd990a7f460eaddad1e80",
            "patch": "@@ -0,0 +1,8 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+  return <p>ppr</p>\n+}\n+\n+export const experimental_ppr = true"
        },
        {
            "sha": "80bb8d81ffe1b438dd30a3641dacf13489761c6a",
            "filename": "test/production/app-dir/metadata-streaming-config/metadata-streaming-config-customized.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 15,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config-customized.test.ts?ref=50e19d7a0f5d9831035dd990a7f460eaddad1e80",
            "patch": "@@ -7,6 +7,7 @@ describe('app-dir - metadata-streaming-config-customized', () => {\n       'next.config.js': `\n         module.exports = {\n           experimental: {\n+            ppr: 'incremental',\n             streamingMetadata: true,\n             htmlLimitedBots: /MyBot/i,\n           }\n@@ -15,25 +16,27 @@ describe('app-dir - metadata-streaming-config-customized', () => {\n     },\n   })\n \n-  it('should have the default streaming metadata config output in routes-manifest.json', async () => {\n-    const requiredServerFiles = JSON.parse(\n-      await next.readFile('.next/required-server-files.json')\n+  it('should have the customized streaming metadata config output in routes-manifest.json', async () => {\n+    const prerenderManifest = JSON.parse(\n+      await next.readFile('.next/prerender-manifest.json')\n     )\n-    expect(requiredServerFiles.files).toContain(\n-      '.next/response-config-manifest.json'\n-    )\n-    expect(\n-      requiredServerFiles.config.experimental.htmlLimitedBots\n-    ).toMatchInlineSnapshot(`\"MyBot\"`)\n+    const { routes } = prerenderManifest\n \n-    const responseConfigManifest = JSON.parse(\n-      await next.readFile('.next/response-config-manifest.json')\n-    )\n+    const bypassConfigs = Object.keys(routes)\n+      .map((route) => [route, routes[route].experimentalBypassFor?.[2]])\n+      .filter(([, bypassConfig]) => Boolean(bypassConfig))\n+      .reduce((acc, [route, bypassConfig]) => {\n+        acc[route] = bypassConfig\n+        return acc\n+      }, {})\n \n-    expect(responseConfigManifest).toMatchInlineSnapshot(`\n+    expect(bypassConfigs).toMatchInlineSnapshot(`\n      {\n-       \"htmlLimitedBots\": \"MyBot\",\n-       \"version\": 0,\n+       \"/ppr\": {\n+         \"key\": \"user-agent\",\n+         \"type\": \"header\",\n+         \"value\": \"MyBot\",\n+       },\n      }\n     `)\n   })"
        },
        {
            "sha": "7805c0493713e711fdc204b82c68a883181f9f29",
            "filename": "test/production/app-dir/metadata-streaming-config/metadata-streaming-config.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 8,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fmetadata-streaming-config.test.ts?ref=50e19d7a0f5d9831035dd990a7f460eaddad1e80",
            "patch": "@@ -9,23 +9,39 @@ describe('app-dir - metadata-streaming-config', () => {\n     const requiredServerFiles = JSON.parse(\n       await next.readFile('.next/required-server-files.json')\n     )\n-    expect(requiredServerFiles.files).toContain(\n-      '.next/response-config-manifest.json'\n-    )\n+\n     expect(\n       requiredServerFiles.config.experimental.htmlLimitedBots\n     ).toMatchInlineSnapshot(\n       `\"Mediapartners-Google|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview\"`\n     )\n \n-    const responseConfigManifest = JSON.parse(\n-      await next.readFile('.next/response-config-manifest.json')\n+    const prerenderManifest = JSON.parse(\n+      await next.readFile('.next/prerender-manifest.json')\n     )\n+    const { routes } = prerenderManifest\n+\n+    const bypassConfigs = Object.keys(routes)\n+      // Pick the user-agent bypass config of each route\n+      .map((route) => [\n+        route,\n+        routes[route].experimentalBypassFor?.find(\n+          (bypassConfig) => bypassConfig.key === 'user-agent'\n+        ),\n+      ])\n+      .filter(([, bypassConfig]) => Boolean(bypassConfig))\n+      .reduce((acc, [route, bypassConfig]) => {\n+        acc[route] = bypassConfig\n+        return acc\n+      }, {})\n \n-    expect(responseConfigManifest).toMatchInlineSnapshot(`\n+    expect(bypassConfigs).toMatchInlineSnapshot(`\n      {\n-       \"htmlLimitedBots\": \"Mediapartners-Google|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview\",\n-       \"version\": 0,\n+       \"/ppr\": {\n+         \"key\": \"user-agent\",\n+         \"type\": \"header\",\n+         \"value\": \"Mediapartners-Google|Slurp|DuckDuckBot|baiduspider|yandex|sogou|bitlybot|tumblr|vkShare|quora link preview|redditbot|ia_archiver|Bingbot|BingPreview|applebot|facebookexternalhit|facebookcatalog|Twitterbot|LinkedInBot|Slackbot|Discordbot|WhatsApp|SkypeUriPreview\",\n+       },\n      }\n     `)\n   })"
        },
        {
            "sha": "13d4d0eb7b1e4d0c2f34861737632a4181eaf20b",
            "filename": "test/production/app-dir/metadata-streaming-config/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/50e19d7a0f5d9831035dd990a7f460eaddad1e80/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-streaming-config%2Fnext.config.js?ref=50e19d7a0f5d9831035dd990a7f460eaddad1e80",
            "patch": "@@ -3,6 +3,7 @@\n  */\n const nextConfig = {\n   experimental: {\n+    ppr: 'incremental',\n     streamingMetadata: true,\n   },\n }"
        }
    ],
    "stats": {
        "total": 123,
        "additions": 77,
        "deletions": 46
    }
}