{
    "author": "huozhi",
    "message": "[segment explorer] fix route url is missing cases (#81622)",
    "sha": "d04d65b5e69e8b60823de0e80162ff4e93445fe4",
    "files": [
        {
            "sha": "d31a4235b2a637a74e33d50799a54792b85c2948",
            "filename": "packages/next/src/client/components/layout-router.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/d04d65b5e69e8b60823de0e80162ff4e93445fe4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d04d65b5e69e8b60823de0e80162ff4e93445fe4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx?ref=d04d65b5e69e8b60823de0e80162ff4e93445fe4",
            "patch": "@@ -40,6 +40,7 @@ import { createRouterCacheKey } from './router-reducer/create-router-cache-key'\n import { hasInterceptionRouteInCurrentTree } from './router-reducer/reducers/has-interception-route-in-current-tree'\n import { dispatchAppRouterAction } from './use-action-queue'\n import { useRouterBFCache, type RouterBFCacheEntry } from './bfcache'\n+import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n \n const Activity = process.env.__NEXT_ROUTER_BF_CACHE\n   ? (require('react') as typeof import('react')).unstable_Activity\n@@ -616,13 +617,19 @@ export default function OuterLayoutRouter({\n       : ErrorBoundary\n \n     let segmentBoundaryTriggerNode: React.ReactNode = null\n+    let segmentViewStateNode: React.ReactNode = null\n     if (\n       process.env.NODE_ENV !== 'production' &&\n       process.env.__NEXT_DEVTOOL_SEGMENT_EXPLORER\n     ) {\n-      const { SegmentBoundaryTriggerNode } =\n+      const { SegmentBoundaryTriggerNode, SegmentViewStateNode } =\n         require('../../next-devtools/userspace/app/segment-explorer-node') as typeof import('../../next-devtools/userspace/app/segment-explorer-node')\n \n+      const pagePrefix = normalizeAppPath(url)\n+      segmentViewStateNode = (\n+        <SegmentViewStateNode key={pagePrefix} page={pagePrefix} />\n+      )\n+\n       segmentBoundaryTriggerNode = (\n         <>\n           <SegmentBoundaryTriggerNode />\n@@ -667,6 +674,7 @@ export default function OuterLayoutRouter({\n                 </HTTPAccessFallbackBoundary>\n               </LoadingBoundary>\n             </ErrorBoundaryComponent>\n+            {segmentViewStateNode}\n           </ScrollAndFocusHandler>\n         }\n       >"
        },
        {
            "sha": "28a540432aa46a7e586b423dd15ce005173efe17",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d04d65b5e69e8b60823de0e80162ff4e93445fe4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d04d65b5e69e8b60823de0e80162ff4e93445fe4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=d04d65b5e69e8b60823de0e80162ff4e93445fe4",
            "patch": "@@ -105,7 +105,6 @@ async function createComponentTreeInternal({\n     workStore,\n     componentMod: {\n       SegmentViewNode,\n-      SegmentViewStateNode,\n       HTTPAccessFallbackBoundary,\n       LayoutRouter,\n       RenderFromTemplateContext,\n@@ -800,7 +799,6 @@ async function createComponentTreeInternal({\n         pageElement\n       )\n \n-    const pagePrefix = ctx.renderOpts.page.replace(/\\/page$/, '')\n     return [\n       actualSegment,\n       <React.Fragment key={cacheNodeKey}>\n@@ -810,7 +808,6 @@ async function createComponentTreeInternal({\n           <MetadataOutlet ready={getViewportReady} />\n           {metadataOutlet}\n         </OutletBoundary>\n-        <SegmentViewStateNode page={pagePrefix} />\n       </React.Fragment>,\n       parallelRouteCacheNodeSeedData,\n       loadingData,"
        },
        {
            "sha": "2881299d42b571896fa5b7e555a0311c2cf6cd60",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 1,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/d04d65b5e69e8b60823de0e80162ff4e93445fe4/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d04d65b5e69e8b60823de0e80162ff4e93445fe4/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=d04d65b5e69e8b60823de0e80162ff4e93445fe4",
            "patch": "@@ -1,5 +1,9 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { getSegmentExplorerContent, retry } from 'next-test-utils'\n+import {\n+  getSegmentExplorerContent,\n+  getSegmentExplorerRoute,\n+  retry,\n+} from 'next-test-utils'\n \n describe('segment-explorer', () => {\n   const { next } = nextTestSetup({\n@@ -14,6 +18,7 @@ describe('segment-explorer', () => {\n      @bar/ [layout.tsx, page.tsx]\n      @foo/ [layout.tsx, page.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/parallel-routes')\n   })\n \n   it('should render the segment explorer for parallel routes in edge runtime', async () => {\n@@ -24,6 +29,7 @@ describe('segment-explorer', () => {\n      @bar/ [layout.tsx, page.tsx]\n      @foo/ [layout.tsx, page.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/parallel-routes-edge')\n   })\n \n   it('should render the segment explorer for nested routes', async () => {\n@@ -35,6 +41,7 @@ describe('segment-explorer', () => {\n      ~ / (overview)/ [layout.tsx]\n      grid/ [page.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/blog/~/grid')\n   })\n \n   it('should cleanup on soft navigation', async () => {\n@@ -43,6 +50,7 @@ describe('segment-explorer', () => {\n      \"app/ [layout.tsx]\n      soft-navigation / a/ [page.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/soft-navigation/a')\n \n     await browser.elementByCss('[href=\"/soft-navigation/b\"]').click()\n     await retry(async () => {\n@@ -53,6 +61,7 @@ describe('segment-explorer', () => {\n      \"app/ [layout.tsx]\n      soft-navigation / b/ [page.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/soft-navigation/b')\n   })\n \n   it('should handle show file segments in order', async () => {\n@@ -61,6 +70,7 @@ describe('segment-explorer', () => {\n      \"app/ [layout.tsx]\n      (all) / file-segments/ [layout.tsx, template.tsx, page.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/file-segments')\n   })\n \n   it('should indicate segment explorer is not available for pages router', async () => {\n@@ -73,13 +83,16 @@ describe('segment-explorer', () => {\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(\n       `\"app/ [layout.tsx, not-found.js]\"`\n     )\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/404')\n   })\n \n   it('should show global-error segment', async () => {\n     const browser = await next.browser('/runtime-error')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(\n       `\"app/ [global-error.js]\"`\n     )\n+    // FIXME: handle preserve the url when hitting global-error\n+    expect(await getSegmentExplorerRoute(browser)).toBe('')\n   })\n \n   it('should show navigation boundaries of the segment', async () => {\n@@ -88,6 +101,9 @@ describe('segment-explorer', () => {\n      \"app/ [layout.tsx]\n      boundary/ [layout.tsx, not-found.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe(\n+      '/boundary?name=not-found'\n+    )\n \n     await browser.loadPage(`${next.url}/boundary?name=forbidden`)\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n@@ -116,6 +132,7 @@ describe('segment-explorer', () => {\n      \"app/ [layout.tsx]\n      search/ [layout.tsx, loading.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/search?q=abc')\n   })\n \n   it('should show the custom error boundary when present', async () => {\n@@ -124,6 +141,9 @@ describe('segment-explorer', () => {\n      \"app/ [layout.tsx]\n      runtime-error / boundary/ [error.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe(\n+      '/runtime-error/boundary'\n+    )\n   })\n \n   it('should display parallel routes default page when present', async () => {\n@@ -135,6 +155,9 @@ describe('segment-explorer', () => {\n      subroute/ [page.tsx]\n      @foo/ [default.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe(\n+      '/parallel-default/subroute'\n+    )\n   })\n \n   it('should display boundary selector when a segment has only boundary files', async () => {\n@@ -145,5 +168,16 @@ describe('segment-explorer', () => {\n      framework/ [layout.tsx]\n      blog/ [layout.tsx, page.tsx]\"\n     `)\n+    expect(await getSegmentExplorerRoute(browser)).toBe(\n+      '/no-layout/framework/blog'\n+    )\n+  })\n+\n+  it('should render route for index page', async () => {\n+    const browser = await next.browser('/')\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(\n+      `\"app/ [layout.tsx, page.tsx]\"`\n+    )\n+    expect(await getSegmentExplorerRoute(browser)).toBe('/')\n   })\n })"
        },
        {
            "sha": "0e5979ee6c8e773a2dffcb5fad0997ec4077329e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/d04d65b5e69e8b60823de0e80162ff4e93445fe4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d04d65b5e69e8b60823de0e80162ff4e93445fe4/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=d04d65b5e69e8b60823de0e80162ff4e93445fe4",
            "patch": "@@ -237,13 +237,13 @@ describe('Dynamic IO Errors', () => {\n                    at ScrollAndFocusHandler (webpack://<next-src>)\n                    at RenderFromTemplateContext (webpack://<next-src>)\n                    at OuterLayoutRouter (webpack://<next-src>)\n-                 332 |  */\n-                 333 | function InnerLayoutRouter({\n-               > 334 |   tree,\n+                 333 |  */\n+                 334 | function InnerLayoutRouter({\n+               > 335 |   tree,\n                      |  ^\n-                 335 |   segmentPath,\n-                 336 |   cacheNode,\n-                 337 |   url,\n+                 336 |   segmentPath,\n+                 337 |   cacheNode,\n+                 338 |   url,\n                To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/dynamic-metadata-error-route\" in your browser to investigate the error.\n                Error occurred prerendering page \"/dynamic-metadata-error-route\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n@@ -739,13 +739,13 @@ describe('Dynamic IO Errors', () => {\n                    at ScrollAndFocusHandler (webpack://<next-src>)\n                    at RenderFromTemplateContext (webpack://<next-src>)\n                    at OuterLayoutRouter (webpack://<next-src>)\n-                 332 |  */\n-                 333 | function InnerLayoutRouter({\n-               > 334 |   tree,\n+                 333 |  */\n+                 334 | function InnerLayoutRouter({\n+               > 335 |   tree,\n                      |  ^\n-                 335 |   segmentPath,\n-                 336 |   cacheNode,\n-                 337 |   url,\n+                 336 |   segmentPath,\n+                 337 |   cacheNode,\n+                 338 |   url,\n                To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/dynamic-root\" in your browser to investigate the error.\n                Error occurred prerendering page \"/dynamic-root\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n@@ -1860,13 +1860,13 @@ describe('Dynamic IO Errors', () => {\n                      at ScrollAndFocusHandler (webpack://<next-src>)\n                      at RenderFromTemplateContext (<anonymous>)\n                      at OuterLayoutRouter (webpack://<next-src>)\n-                   332 |  */\n-                   333 | function InnerLayoutRouter({\n-                 > 334 |   tree,\n+                   333 |  */\n+                   334 | function InnerLayoutRouter({\n+                 > 335 |   tree,\n                        |  ^\n-                   335 |   segmentPath,\n-                   336 |   cacheNode,\n-                   337 |   url,\n+                   336 |   segmentPath,\n+                   337 |   cacheNode,\n+                   338 |   url,\n                  To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/sync-attribution/unguarded-async-guarded-clientsync\" in your browser to investigate the error.\n                  Error occurred prerendering page \"/sync-attribution/unguarded-async-guarded-clientsync\". Read more: https://nextjs.org/docs/messages/prerender-error\n "
        },
        {
            "sha": "a71a15b3d88ca01ded0074ff30fca9611f9a9f4f",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d04d65b5e69e8b60823de0e80162ff4e93445fe4/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d04d65b5e69e8b60823de0e80162ff4e93445fe4/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=d04d65b5e69e8b60823de0e80162ff4e93445fe4",
            "patch": "@@ -13,7 +13,7 @@ const EXTERNAL = {\n const COLLECTOR_PORT = 9001\n \n describe('opentelemetry', () => {\n-  const { next, skipped, isNextDev } = nextTestSetup({\n+  const { next, skipped } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n     dependencies: require('./package.json').dependencies,\n@@ -170,7 +170,7 @@ describe('opentelemetry', () => {\n                       },\n                       {\n                         attributes: {\n-                          'next.clientComponentLoadCount': isNextDev ? 8 : 7,\n+                          'next.clientComponentLoadCount': 7,\n                           'next.span_type':\n                             'NextNodeServer.clientComponentLoading',\n                         },"
        },
        {
            "sha": "75ced90f24790ac6372b87699be0fd9078b92787",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d04d65b5e69e8b60823de0e80162ff4e93445fe4/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d04d65b5e69e8b60823de0e80162ff4e93445fe4/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=d04d65b5e69e8b60823de0e80162ff4e93445fe4",
            "patch": "@@ -962,6 +962,12 @@ export async function openDevToolsIndicatorPopover(\n   }\n }\n \n+export async function getSegmentExplorerRoute(browser: Playwright) {\n+  return await browser\n+    .elementByCss('.segment-explorer-page-route-bar-path')\n+    .text()\n+}\n+\n export async function getSegmentExplorerContent(browser: Playwright) {\n   // open the devtool button\n   await openDevToolsIndicatorPopover(browser)"
        }
    ],
    "stats": {
        "total": 95,
        "additions": 70,
        "deletions": 25
    }
}