{
    "author": "ijjk",
    "message": "Pages API handler interface follow-ups (#78638)\n\nApplies some clean-up/follow-ups from review on\nhttps://github.com/vercel/next.js/pull/78166",
    "sha": "d5bb4477b3c68141eecb82f1594ecb69cc64b6b7",
    "files": [
        {
            "sha": "515e1880c09a88157559fed64fbd105670e6ee81",
            "filename": "packages/next/src/build/templates/pages-api.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 18,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/d5bb4477b3c68141eecb82f1594ecb69cc64b6b7/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d5bb4477b3c68141eecb82f1594ecb69cc64b6b7/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts?ref=d5bb4477b3c68141eecb82f1594ecb69cc64b6b7",
            "patch": "@@ -1,34 +1,34 @@\n import type { NextApiResponse } from '../../types'\n import type { IncomingMessage, ServerResponse } from 'node:http'\n+import type { PrerenderManifest } from '..'\n+import type { DevRoutesManifest } from '../../server/lib/router-utils/setup-dev-bundler'\n+import type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\n \n import { parse } from 'node:url'\n-import { RouteKind } from '../../server/route-kind'\n import { sendError } from '../../server/api-utils'\n+import { RouteKind } from '../../server/route-kind'\n+import type { Span } from '../../server/lib/trace/tracer'\n import { PagesAPIRouteModule } from '../../server/route-modules/pages-api/module.compiled'\n \n import { hoist } from './helpers'\n \n // Import the userland code.\n import * as userland from 'VAR_USERLAND'\n import { getTracer, SpanKind } from '../../server/lib/trace/tracer'\n-import type { Span } from '../../server/lib/trace/tracer'\n import { BaseServerSpan } from '../../server/lib/trace/constants'\n import {\n   ensureInstrumentationRegistered,\n   instrumentationOnRequestError,\n } from '../../server/lib/router-utils/instrumentation-globals.external'\n-import type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\n import { getUtils } from '../../server/server-utils'\n import { PRERENDER_MANIFEST, ROUTES_MANIFEST } from '../../api/constants'\n import { isDynamicRoute } from '../../shared/lib/router/utils'\n-import type { BaseNextRequest } from '../../server/base-http'\n import {\n   RouterServerContextSymbol,\n   routerServerGlobal,\n } from '../../server/lib/router-utils/router-server-context'\n import { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\n import { normalizeLocalePath } from '../../shared/lib/i18n/normalize-locale-path'\n-import type { PrerenderManifest, RoutesManifest } from '..'\n import { loadManifestFromRelativePath } from '../../server/load-manifest.external'\n \n // Re-export the handler (should be the default export).\n@@ -62,17 +62,18 @@ export async function handler(\n   const distDir = process.env.__NEXT_RELATIVE_DIST_DIR || ''\n   const isDev = process.env.NODE_ENV === 'development'\n \n-  const routesManifest = await loadManifestFromRelativePath<RoutesManifest>(\n-    projectDir,\n-    distDir,\n-    ROUTES_MANIFEST\n-  )\n-  const prerenderManifest =\n-    await loadManifestFromRelativePath<PrerenderManifest>(\n+  const [routesManifest, prerenderManifest] = await Promise.all([\n+    loadManifestFromRelativePath<DevRoutesManifest>(\n+      projectDir,\n+      distDir,\n+      ROUTES_MANIFEST\n+    ),\n+    loadManifestFromRelativePath<PrerenderManifest>(\n       projectDir,\n       distDir,\n       PRERENDER_MANIFEST\n-    )\n+    ),\n+  ])\n   let srcPage = 'VAR_DEFINITION_PAGE'\n \n   // turbopack doesn't normalize `/index` in the page name\n@@ -114,9 +115,9 @@ export async function handler(\n     caseSensitive: Boolean(routesManifest.caseSensitive),\n   })\n   const rewriteParamKeys = Object.keys(\n-    serverUtils.handleRewrites(req as any as BaseNextRequest, parsedUrl)\n+    serverUtils.handleRewrites(req, parsedUrl)\n   )\n-  serverUtils.normalizeCdnUrl(req as any as BaseNextRequest, [\n+  serverUtils.normalizeCdnUrl(req, [\n     ...rewriteParamKeys,\n     ...Object.keys(serverUtils.defaultRouteRegex?.groups || {}),\n   ])\n@@ -150,8 +151,8 @@ export async function handler(\n \n     const activeSpan = tracer.getActiveScopeSpan()\n \n-    const invokeRouteModule = async (span?: Span) => {\n-      await routeModule\n+    const invokeRouteModule = async (span?: Span) =>\n+      routeModule\n         .render(req, res, {\n           query,\n           params,\n@@ -210,7 +211,6 @@ export async function handler(\n             span.updateName(`${method} ${req.url}`)\n           }\n         })\n-    }\n \n     // TODO: activeSpan code path is for when wrapped by\n     // next-server can be removed when this is no longer used"
        },
        {
            "sha": "e7d77170f2671d2e4c301907f72022efdb94f6f1",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d5bb4477b3c68141eecb82f1594ecb69cc64b6b7/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d5bb4477b3c68141eecb82f1594ecb69cc64b6b7/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=d5bb4477b3c68141eecb82f1594ecb69cc64b6b7",
            "patch": "@@ -101,6 +101,17 @@ export type SetupOpts = {\n   resetFetch: () => void\n }\n \n+export interface DevRoutesManifest {\n+  version: number\n+  caseSensitive: RoutesManifest['caseSensitive']\n+  basePath: RoutesManifest['basePath']\n+  rewrites: RoutesManifest['rewrites']\n+  redirects: RoutesManifest['redirects']\n+  headers: RoutesManifest['headers']\n+  i18n: RoutesManifest['i18n']\n+  skipMiddlewareUrlNormalize: RoutesManifest['skipMiddlewareUrlNormalize']\n+}\n+\n export type ServerFields = {\n   actualMiddlewareFile?: string | undefined\n   actualInstrumentationHookFile?: string | undefined\n@@ -200,14 +211,13 @@ async function startWatcher(opts: SetupOpts) {\n   // have to write this after starting hot-reloader since that\n   // cleans the dist dir\n   const routesManifestPath = path.join(distDir, ROUTES_MANIFEST)\n-  const routesManifest: Partial<RoutesManifest> = {\n+  const routesManifest: DevRoutesManifest = {\n     version: 3,\n     caseSensitive: !!nextConfig.experimental.caseSensitiveRoutes,\n     basePath: nextConfig.basePath,\n     rewrites: opts.fsChecker.rewrites,\n     redirects: opts.fsChecker.redirects,\n     headers: opts.fsChecker.headers,\n-    dataRoutes: [],\n     i18n: nextConfig.i18n || undefined,\n     skipMiddlewareUrlNormalize: nextConfig.skipMiddlewareUrlNormalize,\n   }"
        },
        {
            "sha": "c480db8632dec589791e0f2cae1fe6a2d4432d39",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/d5bb4477b3c68141eecb82f1594ecb69cc64b6b7/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d5bb4477b3c68141eecb82f1594ecb69cc64b6b7/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=d5bb4477b3c68141eecb82f1594ecb69cc64b6b7",
            "patch": "@@ -23,12 +23,12 @@ import {\n   NEXT_QUERY_PARAM_PREFIX,\n } from '../lib/constants'\n import { normalizeNextQueryParam } from './web/utils'\n-import type { IncomingHttpHeaders } from 'http'\n+import type { IncomingHttpHeaders, IncomingMessage } from 'http'\n import { decodeQueryPathParameter } from './lib/decode-query-path-parameter'\n import type { DeepReadonly } from '../shared/lib/deep-readonly'\n \n export function normalizeCdnUrl(\n-  req: BaseNextRequest,\n+  req: BaseNextRequest | IncomingMessage,\n   paramKeys: string[],\n   defaultRouteRegex: ReturnType<typeof getNamedRouteRegex> | undefined\n ) {\n@@ -198,7 +198,10 @@ export function getUtils({\n     defaultRouteMatches = dynamicRouteMatcher(page) as ParsedUrlQuery\n   }\n \n-  function handleRewrites(req: BaseNextRequest, parsedUrl: UrlWithParsedQuery) {\n+  function handleRewrites(\n+    req: BaseNextRequest | IncomingMessage,\n+    parsedUrl: UrlWithParsedQuery\n+  ) {\n     const rewriteParams = {}\n     let fsPathname = parsedUrl.pathname\n \n@@ -416,8 +419,10 @@ export function getUtils({\n         ignoreMissingOptional\n       )\n     },\n-    normalizeCdnUrl: (req: BaseNextRequest, paramKeys: string[]) =>\n-      normalizeCdnUrl(req, paramKeys, defaultRouteRegex),\n+    normalizeCdnUrl: (\n+      req: BaseNextRequest | IncomingMessage,\n+      paramKeys: string[]\n+    ) => normalizeCdnUrl(req, paramKeys, defaultRouteRegex),\n     interpolateDynamicPath: (\n       pathname: string,\n       params: Record<string, undefined | string | string[]>"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 40,
        "deletions": 25
    }
}