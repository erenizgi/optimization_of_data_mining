{
    "author": "sokra",
    "message": "Turbopack: use mimalloc v3 (#82221)\n\n### What?\n\n* Upgrade to mimalloc 3\n* Compute allocations size more accurately (for tracing)",
    "sha": "80cff8c843cbc3db86415e83c3334b26bc64b9f9",
    "files": [
        {
            "sha": "47680a12f92fab1598501659f8b905d3c85bd751",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 23,
            "deletions": 15,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/80cff8c843cbc3db86415e83c3334b26bc64b9f9/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/80cff8c843cbc3db86415e83c3334b26bc64b9f9/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=80cff8c843cbc3db86415e83c3334b26bc64b9f9",
            "patch": "@@ -1748,6 +1748,12 @@ dependencies = [\n  \"windows-sys 0.52.0\",\n ]\n \n+[[package]]\n+name = \"cty\"\n+version = \"0.2.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"b365fabc795046672053e29c954733ec3b05e4be654ab130fe8f1f94d7051f35\"\n+\n [[package]]\n name = \"darling\"\n version = \"0.14.4\"\n@@ -3654,16 +3660,6 @@ dependencies = [\n  \"windows-sys 0.48.0\",\n ]\n \n-[[package]]\n-name = \"libmimalloc-sys\"\n-version = \"0.1.43\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"bf88cd67e9de251c1781dbe2f641a1a3ad66eaae831b8a2c38fbdc5ddae16d4d\"\n-dependencies = [\n- \"cc\",\n- \"libc\",\n-]\n-\n [[package]]\n name = \"libunwind\"\n version = \"1.3.3\"\n@@ -4034,12 +4030,12 @@ dependencies = [\n ]\n \n [[package]]\n-name = \"mimalloc\"\n-version = \"0.1.47\"\n+name = \"mimalloc-rspack\"\n+version = \"0.2.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"b1791cbe101e95af5764f06f20f6760521f7158f69dbf9d6baf941ee1bf6bc40\"\n+checksum = \"de20bb33bf95d9c060030d53bcb5d5dc03cbbedfbd1dcda5f6f285b946dae2c0\"\n dependencies = [\n- \"libmimalloc-sys\",\n+ \"rspack-libmimalloc-sys\",\n ]\n \n [[package]]\n@@ -6091,6 +6087,17 @@ dependencies = [\n  \"serde\",\n ]\n \n+[[package]]\n+name = \"rspack-libmimalloc-sys\"\n+version = \"0.2.4\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"4c741844b1fbe0cfbae8dfeb73b5e5fdc95daf7be58bdd72afb3fd85c86bccdb\"\n+dependencies = [\n+ \"cc\",\n+ \"cty\",\n+ \"libc\",\n+]\n+\n [[package]]\n name = \"rstest\"\n version = \"0.16.0\"\n@@ -9455,7 +9462,8 @@ dependencies = [\n name = \"turbo-tasks-malloc\"\n version = \"0.1.0\"\n dependencies = [\n- \"mimalloc\",\n+ \"mimalloc-rspack\",\n+ \"rspack-libmimalloc-sys\",\n ]\n \n [[package]]"
        },
        {
            "sha": "b3765f1badb6c28324b962ef0026a7ac02195c9b",
            "filename": "turbopack/crates/turbo-tasks-malloc/Cargo.toml",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/80cff8c843cbc3db86415e83c3334b26bc64b9f9/turbopack%2Fcrates%2Fturbo-tasks-malloc%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/80cff8c843cbc3db86415e83c3334b26bc64b9f9/turbopack%2Fcrates%2Fturbo-tasks-malloc%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-malloc%2FCargo.toml?ref=80cff8c843cbc3db86415e83c3334b26bc64b9f9",
            "patch": "@@ -9,14 +9,22 @@ autobenches = false\n [lib]\n bench = false\n \n+[dependencies]\n+rspack-libmimalloc-sys = { version = \"0.2.4\", default-features = false, features = [], optional = true }\n+\n [target.'cfg(not(any(target_os = \"linux\", target_family = \"wasm\", target_env = \"musl\")))'.dependencies]\n-mimalloc = { version = \"0.1.47\", features = [], optional = true }\n+mimalloc-rspack = { version = \"0.2.4\", features = [\n+  \"v3\",\n+  \"extended\"\n+], optional = true }\n \n [target.'cfg(all(target_os = \"linux\", not(any(target_family = \"wasm\", target_env = \"musl\"))))'.dependencies]\n-mimalloc = { version = \"0.1.47\", features = [\n+mimalloc-rspack = { version = \"0.2.4\", features = [\n+  \"v3\",\n+  \"extended\",\n   \"local_dynamic_tls\",\n ], optional = true }\n \n [features]\n-custom_allocator = [\"dep:mimalloc\"]\n+custom_allocator = [\"dep:mimalloc-rspack\", \"dep:rspack-libmimalloc-sys\"]\n default = [\"custom_allocator\"]"
        },
        {
            "sha": "5f2df85ee628242d1b34878343bdbe68c64bb1fd",
            "filename": "turbopack/crates/turbo-tasks-malloc/src/lib.rs",
            "status": "modified",
            "additions": 26,
            "deletions": 5,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/80cff8c843cbc3db86415e83c3334b26bc64b9f9/turbopack%2Fcrates%2Fturbo-tasks-malloc%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/80cff8c843cbc3db86415e83c3334b26bc64b9f9/turbopack%2Fcrates%2Fturbo-tasks-malloc%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-malloc%2Fsrc%2Flib.rs?ref=80cff8c843cbc3db86415e83c3334b26bc64b9f9",
            "patch": "@@ -84,40 +84,61 @@ fn base_alloc() -> &'static impl GlobalAlloc {\n         feature = \"custom_allocator\",\n         not(any(target_family = \"wasm\", target_env = \"musl\"))\n     ))]\n-    return &mimalloc::MiMalloc;\n+    return &mimalloc_rspack::MiMalloc;\n     #[cfg(any(\n         not(feature = \"custom_allocator\"),\n         any(target_family = \"wasm\", target_env = \"musl\")\n     ))]\n     return &std::alloc::System;\n }\n \n+#[allow(unused_variables)]\n+unsafe fn base_alloc_size(ptr: *const u8, layout: Layout) -> usize {\n+    #[cfg(all(\n+        feature = \"custom_allocator\",\n+        not(any(target_family = \"wasm\", target_env = \"musl\"))\n+    ))]\n+    return unsafe { mimalloc_rspack::MiMalloc.usable_size(ptr) };\n+    #[cfg(any(\n+        not(feature = \"custom_allocator\"),\n+        any(target_family = \"wasm\", target_env = \"musl\")\n+    ))]\n+    return layout.size();\n+}\n+\n unsafe impl GlobalAlloc for TurboMalloc {\n     unsafe fn alloc(&self, layout: Layout) -> *mut u8 {\n         let ret = unsafe { base_alloc().alloc(layout) };\n         if !ret.is_null() {\n-            add(layout.size());\n+            let size = unsafe { base_alloc_size(ret, layout) };\n+            add(size);\n         }\n         ret\n     }\n \n     unsafe fn dealloc(&self, ptr: *mut u8, layout: Layout) {\n+        let size = unsafe { base_alloc_size(ptr, layout) };\n         unsafe { base_alloc().dealloc(ptr, layout) };\n-        remove(layout.size());\n+        remove(size);\n     }\n \n     unsafe fn alloc_zeroed(&self, layout: Layout) -> *mut u8 {\n         let ret = unsafe { base_alloc().alloc_zeroed(layout) };\n         if !ret.is_null() {\n-            add(layout.size());\n+            let size = unsafe { base_alloc_size(ret, layout) };\n+            add(size);\n         }\n         ret\n     }\n \n     unsafe fn realloc(&self, ptr: *mut u8, layout: Layout, new_size: usize) -> *mut u8 {\n+        let old_size = unsafe { base_alloc_size(ptr, layout) };\n         let ret = unsafe { base_alloc().realloc(ptr, layout, new_size) };\n         if !ret.is_null() {\n-            let old_size = layout.size();\n+            // SAFETY: the caller must ensure that the `new_size` does not overflow.\n+            // `layout.align()` comes from a `Layout` and is thus guaranteed to be valid.\n+            let new_layout = unsafe { Layout::from_size_align_unchecked(new_size, layout.align()) };\n+            let new_size = unsafe { base_alloc_size(ret, new_layout) };\n             update(old_size, new_size);\n         }\n         ret"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 60,
        "deletions": 23
    }
}