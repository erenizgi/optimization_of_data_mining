{
    "author": "wyattjoh",
    "message": "fix: prevent URL mutation in router rewrites (#83963)\n\n### What?\n\nThis PR fixes critical URL mutation issues in Next.js routing that were\ncausing state pollution between requests and breaking compatibility\nbetween App Router and Pages Router during rewrite handling.\n\n### Why?\n\nSeveral interconnected problems were discovered in the routing system:\n\n1. **URL Object Mutation**: The original `parsedUrl` objects were being\nmutated during rewrite processing, causing state to leak between\nrequests and potentially affecting subsequent routing decisions.\n\n2. **Router Type Confusion**: The routing system lacked explicit\ntracking of whether a route belonged to the App Router or Pages Router,\nleading to incorrect query parameter handling and normalization logic\nbeing applied inconsistently.\n\n3. **Query Parameter Pollution**: App Router RSC payloads were being\npolluted with rewrite query parameters that should only be applied to\nPages Router routes, breaking the separation of concerns between the two\nrouting systems.\n\n4. **Catch-all Route Normalization**: Pages Router catch-all routes\nrequire specific array normalization (e.g., `[\"hello\", \"world\"]`) but\nthis was being applied inconsistently or to the wrong router type.\n\n5. **Middleware Filtering Bypass**: The x-matched-path header handling\nwas bypassing proper middleware query filtering in deployment scenarios.\n\nThese issues manifested as test failures where Pages Router catch-all\nroutes weren't receiving proper array values, App Router routes were\ngetting contaminated with rewrite parameters, and the routing behavior\nwas inconsistent between development and deployment environments.\n\n### Dependant PR's\n\nhttps://github.com/vercel/vercel/pull/13927\n\n[NAR-398](https://linear.app/vercel/issue/NAR-398)",
    "sha": "2921fb33503e45bc29626f64dbe8071a09a7569d",
    "files": [
        {
            "sha": "1f4fb64e6b07d97074eac8d4f6f0a2f2772d4d73",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -678,6 +678,39 @@ jobs:\n \n     secrets: inherit\n \n+  test-new-tests-deploy-experimental:\n+    name: Test new tests when deployed (experimental)\n+    needs:\n+      [\n+        'optimize-ci',\n+        'test-experimental-prod',\n+        'test-new-tests-dev',\n+        'test-new-tests-start',\n+      ]\n+    # test-new-tests-if\n+    if: ${{ needs.optimize-ci.outputs.skip == 'false' }}\n+    # test-new-tests-end-if\n+\n+    strategy:\n+      fail-fast: false\n+      matrix:\n+        group: [1/5, 2/5, 3/5, 4/5, 5/5]\n+\n+    uses: ./.github/workflows/build_reusable.yml\n+    with:\n+      afterBuild: |\n+        export __NEXT_EXPERIMENTAL_PPR=true # for compatibility with the existing tests\n+        export __NEXT_EXPERIMENTAL_CACHE_COMPONENTS=true\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"test/experimental-tests-manifest.json\"\n+        export NEXT_E2E_TEST_TIMEOUT=240000\n+        export GH_PR_NUMBER=${{ github.event.pull_request && github.event.pull_request.number || '' }}\n+        node scripts/test-new-tests.mjs \\\n+          --mode deploy \\\n+          --group ${{ matrix.group }}\n+      stepName: 'test-new-tests-deploy-experimental-${{matrix.group}}'\n+\n+    secrets: inherit\n+\n   test-dev:\n     name: test dev\n     needs: ['optimize-ci', 'changes', 'build-native', 'build-next']\n@@ -1043,6 +1076,7 @@ jobs:\n         'test-new-tests-dev',\n         'test-new-tests-start',\n         'test-new-tests-deploy',\n+        'test-new-tests-deploy-experimental',\n         'test-turbopack-production',\n         'test-turbopack-production-integration',\n         'test-unit-windows',"
        },
        {
            "sha": "1b599ff4adeafab225e98cfdc54ed074229525aa",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 24,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -149,6 +149,7 @@ import { setCacheBustingSearchParamWithHash } from '../client/components/router-\n import type { CacheControl } from './lib/cache-control'\n import type { PrerenderedRoute } from '../build/static-paths/types'\n import { createOpaqueFallbackRouteParams } from './request/fallback-params'\n+import { RouteKind } from './route-kind'\n \n export type FindComponentsResult = {\n   components: LoadComponentsReturnType\n@@ -1132,23 +1133,21 @@ export default abstract class Server<\n             hasValidParams: false,\n           }\n \n-          if (!pageIsDynamic) {\n-            const match = await this.matchers.match(srcPathname, {\n-              i18n: localeAnalysisResult,\n-            })\n+          const match = await this.matchers.match(srcPathname, {\n+            i18n: localeAnalysisResult,\n+          })\n \n+          if (!pageIsDynamic && match) {\n             // Update the source pathname to the matched page's pathname.\n-            if (match) {\n-              srcPathname = match.definition.pathname\n-\n-              // The page is dynamic if the params are defined. We know at this\n-              // stage that the matched path is not a static page if the params\n-              // were parsed from the matched path header.\n-              if (typeof match.params !== 'undefined') {\n-                pageIsDynamic = true\n-                paramsResult.params = match.params\n-                paramsResult.hasValidParams = true\n-              }\n+            srcPathname = match.definition.pathname\n+\n+            // The page is dynamic if the params are defined. We know at this\n+            // stage that the matched path is not a static page if the params\n+            // were parsed from the matched path header.\n+            if (typeof match.params !== 'undefined') {\n+              pageIsDynamic = true\n+              paramsResult.params = match.params\n+              paramsResult.hasValidParams = true\n             }\n           }\n \n@@ -1183,18 +1182,21 @@ export default abstract class Server<\n           const originQueryParams = { ...parsedUrl.query }\n \n           const pathnameBeforeRewrite = parsedUrl.pathname\n-          const rewriteParamKeys = Object.keys(\n-            utils.handleRewrites(req, parsedUrl)\n+          const { rewriteParams, rewrittenParsedUrl } = utils.handleRewrites(\n+            req,\n+            parsedUrl\n           )\n+          const rewriteParamKeys = Object.keys(rewriteParams)\n \n           // Create a copy of the query params to avoid mutating the original\n           // object. This prevents any overlapping query params that have the\n           // same normalized key from causing issues.\n-          const queryParams = { ...parsedUrl.query }\n-          const didRewrite = pathnameBeforeRewrite !== parsedUrl.pathname\n+          const rewrittenQueryParams = { ...rewrittenParsedUrl.query }\n+          const didRewrite =\n+            pathnameBeforeRewrite !== rewrittenParsedUrl.pathname\n \n-          if (didRewrite && parsedUrl.pathname) {\n-            addRequestMeta(req, 'rewroteURL', parsedUrl.pathname)\n+          if (didRewrite && rewrittenParsedUrl.pathname) {\n+            addRequestMeta(req, 'rewroteURL', rewrittenParsedUrl.pathname)\n           }\n \n           const routeParamKeys = new Set<string>()\n@@ -1209,7 +1211,7 @@ export default abstract class Server<\n \n             if (typeof value === 'undefined') continue\n \n-            queryParams[normalizedKey] = Array.isArray(value)\n+            rewrittenQueryParams[normalizedKey] = Array.isArray(value)\n               ? value.map((v) => decodeQueryPathParameter(v))\n               : decodeQueryPathParameter(value)\n           }\n@@ -1222,7 +1224,7 @@ export default abstract class Server<\n             // the query params.\n             if (!paramsResult.hasValidParams) {\n               paramsResult = utils.normalizeDynamicRouteParams(\n-                queryParams,\n+                rewrittenQueryParams,\n                 false\n               )\n             }\n@@ -1302,7 +1304,7 @@ export default abstract class Server<\n             // from the route matches but ignore missing optional params.\n             if (!paramsResult.hasValidParams) {\n               paramsResult = utils.normalizeDynamicRouteParams(\n-                queryParams,\n+                rewrittenQueryParams,\n                 true\n               )\n \n@@ -1368,6 +1370,7 @@ export default abstract class Server<\n               ...Object.keys(utils.defaultRouteRegex?.groups || {}),\n             ])\n           }\n+\n           // Remove the route `params` keys from `parsedUrl.query` if they are\n           // not in the original query params.\n           // If it's used in both route `params` and query `searchParams`, it should be kept.\n@@ -1376,8 +1379,21 @@ export default abstract class Server<\n               delete parsedUrl.query[key]\n             }\n           }\n+\n           parsedUrl.pathname = matchedPath\n           url.pathname = parsedUrl.pathname\n+\n+          // For Pages Router routes, use the normalized queryParams from\n+          // handleRewrites to ensure catch-all routes get proper array values.\n+          // App Router routes should not include rewrite query params as they\n+          // affect RSC payload.\n+          if (\n+            match?.definition.kind === RouteKind.PAGES ||\n+            match?.definition.kind === RouteKind.PAGES_API\n+          ) {\n+            parsedUrl.query = rewrittenQueryParams\n+          }\n+\n           finished = await this.normalizeAndAttachMetadata(req, res, parsedUrl)\n           if (finished) return\n         } catch (err) {"
        },
        {
            "sha": "e02f4c10930073dc1e960c7ad2b53016c84b4431",
            "filename": "packages/next/src/server/route-modules/app-page/module.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-page%2Fmodule.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -71,13 +71,6 @@ export class AppPageRouteModule extends RouteModule<\n   AppPageRouteDefinition,\n   AppPageUserlandModule\n > {\n-  constructor(\n-    options: RouteModuleOptions<AppPageRouteDefinition, AppPageUserlandModule>\n-  ) {\n-    super(options)\n-    this.isAppRouter = true\n-  }\n-\n   private matchers = new WeakMap<\n     DeepReadonly<PrerenderManifest>,\n     PrerenderManifestMatcher"
        },
        {
            "sha": "d77adc27be1f58eb6ac6487de59f3918a963cf88",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -229,7 +229,6 @@ export class AppRouteRouteModule extends RouteModule<\n     // Automatically implement some methods if they aren't implemented by the\n     // userland module.\n     this.methods = autoImplementMethods(userland)\n-    this.isAppRouter = true\n \n     // Get the non-static methods for this route.\n     this.hasNonStaticMethods = hasNonStaticMethods(userland)"
        },
        {
            "sha": "97515e5098ba8f1e69e873a7624ac2efaf6c85e8",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 18,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -48,7 +48,7 @@ import { isStaticMetadataRoute } from '../../lib/metadata/is-metadata-route'\n import { IncrementalCache } from '../lib/incremental-cache'\n import { initializeCacheHandlers, setCacheHandler } from '../use-cache/handlers'\n import { interopDefault } from '../app-render/interop-default'\n-import type { RouteKind } from '../route-kind'\n+import { RouteKind } from '../route-kind'\n import type { BaseNextRequest } from '../base-http'\n import type { I18NConfig, NextConfigComplete } from '../config-shared'\n import ResponseCache, { type ResponseGenerator } from '../response-cache'\n@@ -120,7 +120,6 @@ export abstract class RouteModule<\n \n   public isDev: boolean\n   public distDir: string\n-  public isAppRouter?: boolean\n   public relativeProjectDir: string\n   public incrementCache?: IncrementalCache\n   public responseCache?: ResponseCache\n@@ -245,6 +244,12 @@ export abstract class RouteModule<\n         require('../load-manifest.external') as typeof import('../load-manifest.external')\n       const normalizedPagePath = normalizePagePath(srcPage)\n \n+      const router =\n+        this.definition.kind === RouteKind.PAGES ||\n+        this.definition.kind === RouteKind.PAGES_API\n+          ? 'pages'\n+          : 'app'\n+\n       const [\n         routesManifest,\n         prerenderManifest,\n@@ -290,7 +295,7 @@ export abstract class RouteModule<\n           projectDir,\n           distDir: this.distDir,\n           manifest: process.env.TURBOPACK\n-            ? `server/${this.isAppRouter ? 'app' : 'pages'}${normalizedPagePath}/${REACT_LOADABLE_MANIFEST}`\n+            ? `server/${router === 'app' ? 'app' : 'pages'}${normalizedPagePath}/${REACT_LOADABLE_MANIFEST}`\n             : REACT_LOADABLE_MANIFEST,\n           handleMissing: true,\n           shouldCache: !this.isDev,\n@@ -301,7 +306,7 @@ export abstract class RouteModule<\n           manifest: `server/${NEXT_FONT_MANIFEST}.json`,\n           shouldCache: !this.isDev,\n         }),\n-        this.isAppRouter && !isStaticMetadataRoute(srcPage)\n+        router === 'app' && !isStaticMetadataRoute(srcPage)\n           ? loadManifestFromRelativePath({\n               distDir: this.distDir,\n               projectDir,\n@@ -311,7 +316,7 @@ export abstract class RouteModule<\n               shouldCache: !this.isDev,\n             })\n           : undefined,\n-        this.isAppRouter\n+        router === 'app'\n           ? loadManifestFromRelativePath<any>({\n               distDir: this.distDir,\n               projectDir,\n@@ -636,11 +641,12 @@ export abstract class RouteModule<\n \n     // we apply rewrites against cloned URL so that we don't\n     // modify the original with the rewrite destination\n-    const clonedParsedUrl = structuredClone(parsedUrl)\n-    const rewriteParamKeys = Object.keys(\n-      serverUtils.handleRewrites(req, clonedParsedUrl)\n+    const { rewriteParams, rewrittenParsedUrl } = serverUtils.handleRewrites(\n+      req,\n+      parsedUrl\n     )\n-    Object.assign(parsedUrl.query, clonedParsedUrl.query)\n+    const rewriteParamKeys = Object.keys(rewriteParams)\n+    Object.assign(parsedUrl.query, rewrittenParsedUrl.query)\n \n     // after processing rewrites we want to remove locale\n     // from parsedUrl pathname\n@@ -650,8 +656,8 @@ export abstract class RouteModule<\n         i18n.locales\n       ).pathname\n \n-      clonedParsedUrl.pathname = normalizeLocalePath(\n-        clonedParsedUrl.pathname || '/',\n+      rewrittenParsedUrl.pathname = normalizeLocalePath(\n+        rewrittenParsedUrl.pathname || '/',\n         i18n.locales\n       ).pathname\n     }\n@@ -663,7 +669,7 @@ export abstract class RouteModule<\n     if (!params && serverUtils.dynamicRouteMatcher) {\n       const paramsMatch = serverUtils.dynamicRouteMatcher(\n         normalizeDataPath(\n-          clonedParsedUrl?.pathname || parsedUrl.pathname || '/'\n+          rewrittenParsedUrl?.pathname || parsedUrl.pathname || '/'\n         )\n       )\n       const paramsResult = serverUtils.normalizeDynamicRouteParams(\n@@ -692,11 +698,14 @@ export abstract class RouteModule<\n     const routeParamKeys = new Set<string>()\n     const combinedParamKeys = []\n \n-    // we don't include rewriteParamKeys in the combinedParamKeys\n+    // We don't include rewriteParamKeys in the combinedParamKeys\n     // for app router since the searchParams is populated from the\n     // URL so we don't want to strip the rewrite params from the URL\n-    // so that searchParams can include them\n-    if (!this.isAppRouter) {\n+    // so that searchParams can include them.\n+    if (\n+      this.definition.kind === RouteKind.PAGES ||\n+      this.definition.kind === RouteKind.PAGES_API\n+    ) {\n       for (const key of [\n         ...rewriteParamKeys,\n         ...Object.keys(serverUtils.defaultRouteMatches || {}),\n@@ -816,9 +825,7 @@ export abstract class RouteModule<\n     const nextConfig =\n       routerServerContext?.nextConfig || serverFilesManifest.config\n \n-    let resolvedPathname =\n-      getRequestMeta(req, 'rewroteURL') || normalizedSrcPage\n-\n+    let resolvedPathname = normalizedSrcPage\n     if (isDynamicRoute(resolvedPathname) && params) {\n       resolvedPathname = serverUtils.interpolateDynamicPath(\n         resolvedPathname,"
        },
        {
            "sha": "09fe92c872ae713533ca06c962dd3f03c85ab987",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 16,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -220,10 +220,13 @@ export function getServerUtils({\n \n   function handleRewrites(\n     req: BaseNextRequest | IncomingMessage,\n-    parsedUrl: UrlWithParsedQuery\n+    parsedUrl: DeepReadonly<UrlWithParsedQuery>\n   ) {\n+    // Here we deep clone the parsedUrl to avoid mutating the original. We also\n+    // cast this to a mutable type so we can mutate it within this scope.\n+    const rewrittenParsedUrl = structuredClone(parsedUrl) as UrlWithParsedQuery\n     const rewriteParams: Record<string, string> = {}\n-    let fsPathname = parsedUrl.pathname\n+    let fsPathname = rewrittenParsedUrl.pathname\n \n     const matchesPage = () => {\n       const fsPathnameNoSlash = removeTrailingSlash(fsPathname || '')\n@@ -243,14 +246,14 @@ export function getServerUtils({\n         }\n       )\n \n-      if (!parsedUrl.pathname) return false\n+      if (!rewrittenParsedUrl.pathname) return false\n \n-      let params = matcher(parsedUrl.pathname)\n+      let params = matcher(rewrittenParsedUrl.pathname)\n \n       if ((rewrite.has || rewrite.missing) && params) {\n         const hasParams = matchHas(\n           req,\n-          parsedUrl.query,\n+          rewrittenParsedUrl.query,\n           rewrite.has as Rewrite['has'],\n           rewrite.missing as Rewrite['missing']\n         )\n@@ -288,7 +291,7 @@ export function getServerUtils({\n           appendParamsToQuery: true,\n           destination: rewrite.destination,\n           params: params,\n-          query: parsedUrl.query,\n+          query: rewrittenParsedUrl.query,\n         })\n \n         // if the rewrite destination is external break rewrite chain\n@@ -297,26 +300,26 @@ export function getServerUtils({\n         }\n \n         Object.assign(rewriteParams, destQuery, params)\n-        Object.assign(parsedUrl.query, parsedDestination.query)\n+        Object.assign(rewrittenParsedUrl.query, parsedDestination.query)\n         delete (parsedDestination as any).query\n \n-        // for each property in parsedUrl.query, if the value is parametrized (eg :foo), look up the value\n+        // for each property in rewrittenParsedUrl.query, if the value is parametrized (eg :foo), look up the value\n         // in rewriteParams and replace the parametrized value with the actual value\n         // this is used when the rewrite destination does not contain the original source param\n         // and so the value is still parametrized and needs to be replaced with the actual rewrite param\n-        Object.entries(parsedUrl.query).forEach(([key, value]) => {\n+        Object.entries(rewrittenParsedUrl.query).forEach(([key, value]) => {\n           if (value && typeof value === 'string' && value.startsWith(':')) {\n             const paramName = value.slice(1)\n             const actualValue = rewriteParams[paramName]\n             if (actualValue) {\n-              parsedUrl.query[key] = actualValue\n+              rewrittenParsedUrl.query[key] = actualValue\n             }\n           }\n         })\n \n-        Object.assign(parsedUrl, parsedDestination)\n+        Object.assign(rewrittenParsedUrl, parsedDestination)\n \n-        fsPathname = parsedUrl.pathname\n+        fsPathname = rewrittenParsedUrl.pathname\n         if (!fsPathname) return false\n \n         if (basePath) {\n@@ -326,7 +329,7 @@ export function getServerUtils({\n         if (i18n) {\n           const result = normalizeLocalePath(fsPathname, i18n.locales)\n           fsPathname = result.pathname\n-          parsedUrl.query.nextInternalLocale =\n+          rewrittenParsedUrl.query.nextInternalLocale =\n             result.detectedLocale || params.nextInternalLocale\n         }\n \n@@ -337,14 +340,15 @@ export function getServerUtils({\n         if (pageIsDynamic && dynamicRouteMatcher) {\n           const dynamicParams = dynamicRouteMatcher(fsPathname)\n           if (dynamicParams) {\n-            parsedUrl.query = {\n-              ...parsedUrl.query,\n+            rewrittenParsedUrl.query = {\n+              ...rewrittenParsedUrl.query,\n               ...dynamicParams,\n             }\n             return true\n           }\n         }\n       }\n+\n       return false\n     }\n \n@@ -367,7 +371,8 @@ export function getServerUtils({\n         }\n       }\n     }\n-    return rewriteParams\n+\n+    return { rewriteParams, rewrittenParsedUrl }\n   }\n \n   function getParamsFromRouteMatches(routeMatchesHeader: string) {"
        },
        {
            "sha": "f62b101ea0f9e57cce4d089f3239d049e43e4149",
            "filename": "scripts/test-new-tests.mjs",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/scripts%2Ftest-new-tests.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/scripts%2Ftest-new-tests.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Ftest-new-tests.mjs?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -130,14 +130,29 @@ async function main() {\n \n   for (let i = 0; i < attempts; i++) {\n     console.log(`\\n\\nRun ${i + 1}/${attempts} for ${testMode} tests (Webpack)`)\n+\n+    // We apply the external tests filter before the process.env so that if\n+    // it's defined in the environment, it overrides the default filter.\n+    // This is required for supporting the experimental tests setup.\n+    const NEXT_EXTERNAL_TESTS_FILTERS = process.env.NEXT_EXTERNAL_TESTS_FILTERS\n+      ? process.env.NEXT_EXTERNAL_TESTS_FILTERS\n+      : testMode === 'deploy'\n+        ? 'test/deploy-tests-manifest.json'\n+        : undefined\n+\n+    if (NEXT_EXTERNAL_TESTS_FILTERS) {\n+      console.log(\n+        `Applying external tests filter: ${NEXT_EXTERNAL_TESTS_FILTERS}`\n+      )\n+    }\n+\n     await execa('node', [...RUN_TESTS_ARGS, ...currentTests], {\n       ...EXECA_OPTS_STDIO,\n       env: {\n         ...process.env,\n+        NEXT_EXTERNAL_TESTS_FILTERS,\n         NEXT_TEST_MODE: testMode,\n         NEXT_TEST_VERSION: nextTestVersion,\n-        NEXT_EXTERNAL_TESTS_FILTERS:\n-          testMode === 'deploy' ? 'test/deploy-tests-manifest.json' : undefined,\n       },\n     })\n   }"
        },
        {
            "sha": "4b318bf85520afbb698eb09975c213f5230016a9",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/[first]/~/overview/grid/page.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%7E%2Foverview%2Fgrid%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%7E%2Foverview%2Fgrid%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2F%5Bfirst%5D%2F%7E%2Foverview%2Fgrid%2Fpage.tsx?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -0,0 +1,25 @@\n+async function getMetadata() {\n+  'use cache'\n+  return {\n+    title: `Grid Page ${Math.random()}`,\n+  }\n+}\n+\n+export async function generateMetadata() {\n+  return await getMetadata()\n+}\n+\n+export default async function GridPage({\n+  params,\n+}: {\n+  params: Promise<{\n+    first: string\n+  }>\n+}) {\n+  const { first } = await params\n+  return (\n+    <div data-slug={`${first}/~/overview/grid`}>\n+      Page /{first}/~/overview/grid\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "bfc83f2f80ee60d43fc6ccc759c1ac1af591e50a",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/app/api/route.ts",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fapi%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fapi%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fapp%2Fapi%2Froute.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -0,0 +1,16 @@\n+import { revalidatePath } from 'next/cache'\n+import { NextRequest } from 'next/server'\n+\n+export async function GET(request: NextRequest) {\n+  // Parse the path to revalidate from the request query params.\n+  const paths = request.nextUrl.searchParams.getAll('path')\n+\n+  // Revalidate the paths.\n+  for (const path of paths) {\n+    const isPage = path.includes('[') && path.includes(']')\n+\n+    revalidatePath(path, isPage ? 'page' : undefined)\n+  }\n+\n+  return new Response('Revalidated paths')\n+}"
        },
        {
            "sha": "0bc697d2116c42e4fc0b634579bf2ebdb54295f4",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/next.config.js",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fnext.config.js?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -1,6 +1,31 @@\n /**\n  * @type {import('next').NextConfig}\n  */\n-const nextConfig = {}\n+const nextConfig = {\n+  experimental: {\n+    useCache: true,\n+  },\n+  rewrites: async () => {\n+    return {\n+      beforeFiles: [\n+        {\n+          source: '/:first/~/overview/:path*',\n+          destination: '/404',\n+        },\n+        {\n+          source: '/:first',\n+          has: [\n+            {\n+              type: 'cookie',\n+              key: 'overview-param',\n+              value: 'grid',\n+            },\n+          ],\n+          destination: '/:first/~/overview/grid',\n+        },\n+      ],\n+    }\n+  },\n+}\n \n module.exports = nextConfig"
        },
        {
            "sha": "7180f9e73a5c325eee2fc555322a14437f31b958",
            "filename": "test/e2e/app-dir/sub-shell-generation-middleware/sub-shell-generation-middleware.test.ts",
            "status": "modified",
            "additions": 86,
            "deletions": 0,
            "changes": 86,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fsub-shell-generation-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fsub-shell-generation-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsub-shell-generation-middleware%2Fsub-shell-generation-middleware.test.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -1,6 +1,7 @@\n import { nextTestSetup } from 'e2e-utils'\n import * as cheerio from 'cheerio'\n import { retry } from 'next-test-utils'\n+import { computeCacheBustingSearchParam } from 'next/dist/shared/lib/router/utils/cache-busting-search-param'\n \n describe('middleware-static-rewrite', () => {\n   const { next, isNextDeploy, isNextDev } = nextTestSetup({\n@@ -123,6 +124,91 @@ describe('middleware-static-rewrite', () => {\n         'runtime'\n       )\n     })\n+\n+    it('should revalidate the overview page without replacing it with a 404', async () => {\n+      const url = new URL('/my-team', 'http://localhost')\n+      const rsc = computeCacheBustingSearchParam(\n+        '1',\n+        '/_tree',\n+        undefined,\n+        undefined\n+      )\n+\n+      url.searchParams.set('_rsc', rsc)\n+\n+      let res = await next.fetch(url.pathname + url.search, {\n+        headers: {\n+          Cookie: 'overview-param=grid',\n+          RSC: '1',\n+          'Next-Router-Prefetch': '1',\n+          'Next-Router-Segment-Prefetch': '/_tree',\n+        },\n+      })\n+\n+      // A 404 here represents a routing issue that was resolved by an upstream\n+      // PR in the builder: https://github.com/vercel/vercel/pull/13927\n+      expect(res.status).toBe(200)\n+\n+      // Now, let's verify that we both got rewritten to the correct page, and\n+      // that we're being served the prerender shell.\n+      expect(res.headers.get('x-nextjs-rewritten-path')).toBe(\n+        '/my-team/~/overview/grid'\n+      )\n+      expect(res.headers.get('x-nextjs-postponed')).toBe('2')\n+      expect(res.headers.get('x-nextjs-prerender')).toBe('1')\n+\n+      // Grab the RSC content.\n+      const rsc1 = await res.text()\n+\n+      // Grab the title which includes the random number.\n+      const title1 = rsc1.match(/Grid Page (\\d+\\.\\d+)/)?.[1]\n+      expect(title1).toBeDefined()\n+\n+      // Now, let's trigger a revalidation for the page.\n+      res = await next.fetch(\n+        '/api?path=/my-team&path=/my-team/~/overview/grid&path=/[first]/~/overview/grid'\n+      )\n+\n+      // Now, let's keep polling the prefetch until it's revalidated.\n+      let rsc2: string\n+      await retry(async () => {\n+        res = await next.fetch(url.pathname + url.search, {\n+          headers: {\n+            Cookie: 'overview-param=grid',\n+            RSC: '1',\n+            'Next-Router-Prefetch': '1',\n+            'Next-Router-Segment-Prefetch': '/_tree',\n+          },\n+        })\n+\n+        // A 404 here represents a routing issue that was resolved by an upstream\n+        // PR in the builder: https://github.com/vercel/vercel/pull/13927\n+        expect(res.status).toBe(200)\n+\n+        // We're expecting that the title has changed, so let's compare that the\n+        // rsc payload is different.\n+        rsc2 = await res.text()\n+        expect(rsc1).not.toBe(rsc2)\n+      })\n+\n+      // Now that the revalidation has been completed, let's also verify that\n+      // it revalidated correctly.\n+      expect(res.headers.get('x-nextjs-postponed')).toBe('2')\n+      expect(res.headers.get('x-nextjs-rewritten-path')).toBe(\n+        '/my-team/~/overview/grid'\n+      )\n+\n+      // We expect that the only difference between the two RSC contents is the\n+      // title.\n+      const title2 = rsc2.match(/Grid Page (\\d+\\.\\d+)/)?.[1]\n+      expect(title2).toBeDefined()\n+      expect(title2).not.toBe(title1)\n+\n+      // Let's compare the RSC contents, with the titles removed.\n+      const cleaned1 = rsc1.replace(/Grid Page (\\d+\\.\\d+)/, 'Grid Page')\n+      const cleaned2 = rsc2.replace(/Grid Page (\\d+\\.\\d+)/, 'Grid Page')\n+      expect(cleaned1).toBe(cleaned2)\n+    })\n   } else {\n     // Here we're validating that there is a static page generated for the\n     // rewritten path."
        },
        {
            "sha": "cd3207eb1bd38c2ed8b973882d2d9822a7d829c2",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -393,6 +393,14 @@ export class NextInstance {\n           if (process.env.NEXT_PRIVATE_TEST_MODE) {\n             process.env.__NEXT_TEST_MODE = process.env.NEXT_PRIVATE_TEST_MODE\n           }\n+\n+          // alias experimental feature flags for deployment compatibility\n+          if (process.env.NEXT_PRIVATE_EXPERIMENTAL_PPR) {\n+            process.env.__NEXT_EXPERIMENTAL_PPR = process.env.NEXT_PRIVATE_EXPERIMENTAL_PPR\n+          }\n+          if (process.env.NEXT_PRIVATE_EXPERIMENTAL_CACHE_COMPONENTS) {\n+            process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS = process.env.NEXT_PRIVATE_EXPERIMENTAL_CACHE_COMPONENTS\n+          }\n         `\n           )\n "
        },
        {
            "sha": "289c9f0ac948754a63d69c9ddf2a13bf36aa4cfe",
            "filename": "test/lib/next-modes/next-deploy.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2921fb33503e45bc29626f64dbe8071a09a7569d/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-deploy.ts?ref=2921fb33503e45bc29626f64dbe8071a09a7569d",
            "patch": "@@ -91,17 +91,26 @@ export class NextDeployInstance extends NextInstance {\n     const additionalEnv: string[] = []\n \n     for (const key of Object.keys(this.env || {})) {\n-      additionalEnv.push('--build-env')\n-      additionalEnv.push(`${key}=${this.env[key]}`)\n-      additionalEnv.push('--env')\n       additionalEnv.push(`${key}=${this.env[key]}`)\n     }\n \n-    additionalEnv.push('--build-env')\n     additionalEnv.push(\n       `VERCEL_CLI_VERSION=${process.env.VERCEL_CLI_VERSION || 'vercel@latest'}`\n     )\n \n+    // Add experimental feature flags\n+    if (process.env.__NEXT_EXPERIMENTAL_PPR) {\n+      additionalEnv.push(\n+        `NEXT_PRIVATE_EXPERIMENTAL_PPR=${process.env.__NEXT_EXPERIMENTAL_PPR}`\n+      )\n+    }\n+\n+    if (process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS) {\n+      additionalEnv.push(\n+        `NEXT_PRIVATE_EXPERIMENTAL_CACHE_COMPONENTS=${process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS}`\n+      )\n+    }\n+\n     const deployRes = await execa(\n       'vercel',\n       [\n@@ -112,7 +121,12 @@ export class NextDeployInstance extends NextInstance {\n         'NEXT_TELEMETRY_DISABLED=1',\n         '--build-env',\n         'VERCEL_NEXT_BUNDLED_SERVER=1',\n-        ...additionalEnv,\n+        ...additionalEnv.flatMap((pair) => [\n+          '--env',\n+          pair,\n+          '--build-env',\n+          pair,\n+        ]),\n         '--force',\n         ...vercelFlags,\n       ],"
        }
    ],
    "stats": {
        "total": 391,
        "additions": 317,
        "deletions": 74
    }
}