{
    "author": "lubieowoce",
    "message": "test: attempt to de-flake rsc-basic (#77934)\n\nI've been seeing this test flake with some regularity:\n\n---\n● app dir - rsc basics › should be able to navigate between rsc routes\n\n```\nrequest.allHeaders: Target page, context or browser has been closed\n\n  168 |         page.on('request', (request) => {\n  169 |           requestsCount++\n> 170 |           return request.allHeaders().then((headers) => {\n      |                          ^\n  171 |             if (\n  172 |               headers['RSC'.toLowerCase()] === '1' &&\n  173 |               // Prefetches also include `RSC`\n\n  at Page.allHeaders (e2e/app-dir/rsc-basic/rsc-basic.test.ts:170:26)\n```\n---\n\n[Example test run\nhere](https://github.com/vercel/next.js/actions/runs/14313872710/job/40115445718?pr=77898#step:33:3431)\n\nThe error is actually unrelated to `should be able to navigate between\nrsc routes`, and is coming from async operations (that haven't completed\nin time) in another test in the same suite, `should reuse the inline\nflight response without sending extra requests` .\n\nI've de-asyncified the test's `page.on('request')` handler -- we don't\nneed the async `allHeaders()`, `headers()` is enough.\n(I verified this by adding a client component that manually sends a\nrequest with `RSC: 1`, and that does indeed trigger our request\nlistener).\nI've also added a `waitForIdleNetwork` to hopefully make it complete all\nrequests before the test ends.",
    "sha": "8370d498cc4e303c4f91f553cce5aac47a630365",
    "files": [
        {
            "sha": "2df3252119e5c4b379964ae7a70e84219343cd7a",
            "filename": "test/e2e/app-dir/rsc-basic/rsc-basic.test.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 13,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/8370d498cc4e303c4f91f553cce5aac47a630365/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8370d498cc4e303c4f91f553cce5aac47a630365/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts?ref=8370d498cc4e303c4f91f553cce5aac47a630365",
            "patch": "@@ -2,6 +2,7 @@ import path from 'path'\n import { check } from 'next-test-utils'\n import { nextTestSetup } from 'e2e-utils'\n import cheerio from 'cheerio'\n+import { Page } from 'playwright'\n \n // TODO: We should decide on an established pattern for gating test assertions\n // on experimental flags. For example, as a first step we could all the common\n@@ -161,27 +162,28 @@ describe('app dir - rsc basics', () => {\n   })\n \n   it('should reuse the inline flight response without sending extra requests', async () => {\n-    let hasFlightRequest = false\n+    const flightRequests: string[] = []\n     let requestsCount = 0\n-    await next.browser('/root', {\n-      beforePageLoad(page) {\n+    const browser = await next.browser('/root', {\n+      beforePageLoad(page: Page) {\n         page.on('request', (request) => {\n           requestsCount++\n-          return request.allHeaders().then((headers) => {\n-            if (\n-              headers['RSC'.toLowerCase()] === '1' &&\n-              // Prefetches also include `RSC`\n-              headers['Next-Router-Prefetch'.toLowerCase()] !== '1'\n-            ) {\n-              hasFlightRequest = true\n-            }\n-          })\n+          const headers = request.headers()\n+          if (\n+            headers['RSC'.toLowerCase()] === '1' &&\n+            // Prefetches also include `RSC`\n+            headers['Next-Router-Prefetch'.toLowerCase()] !== '1'\n+          ) {\n+            flightRequests.push(request.url())\n+          }\n         })\n       },\n     })\n \n+    await browser.waitForIdleNetwork()\n+\n     expect(requestsCount).toBeGreaterThan(0)\n-    expect(hasFlightRequest).toBe(false)\n+    expect(flightRequests).toEqual([])\n   })\n \n   it('should support multi-level server component imports', async () => {"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 15,
        "deletions": 13
    }
}