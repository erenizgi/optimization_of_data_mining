{
    "author": "timneutkens",
    "message": "Development: Implement request log time details (#84906)\n\n## What?\n\nAdds more detailed time for each request, showing what time is spent in\nNext.js (i.e. routing, Turbopack compilation, etc.) and what time is\nspent executing the application code which includes time spent in React\n/ React rendering, requiring the application code, etc.\n\nThe additional info is dimmed:\n\n<img width=\"744\" height=\"124\" alt=\"CleanShot 2025-10-15 at 19 27 01@2x\"\nsrc=\"https://github.com/user-attachments/assets/b6ce973e-4687-4865-9ebb-be54865331b1\"\n/>\n\n\nText:\n\n```\n GET / 200 in 626ms (compile: 500ms, render: 125ms)\n GET / 200 in 24ms (compile: 2ms, render: 22ms)\n GET / 200 in 20ms (compile: 2ms, render: 18ms)\n GET / 200 in 16ms (compile: 1ms, render: 15ms)\n GET / 200 in 16ms (compile: 1ms, render: 14ms)\n```\n\nWhile working on this I found that the existing time (the `in 22ms`\npart) did not include time spent in proxy.ts, which is unexpected as\nyou'd want to see the total time spent on a request, including running\nproxy.ts. I've fixed that bug in this PR, as well as added tracking of\nthe time spent in proxy:\n\nTo test I added a middleware that adds 1 second delay on all requests:\n\nBefore (note: request took more than 1 second):\n\n```\n GET / 200 in 16ms\n GET / 200 in 20ms\n```\n\nAfter (note: request still takes the same time, but now correctly logs\nit):\n\n```\n GET / 200 in 1610ms (compile: 450ms, proxy.ts: 1039ms, render: 121ms)\n GET / 200 in 1038ms (compile: 5ms, proxy.ts: 1007ms, render: 27ms)\n GET / 200 in 1034ms (compile: 5ms, proxy.ts: 1004ms, render: 25ms)\n```",
    "sha": "94f849e17a3b2b00f0dc2a493bce1217a3052691",
    "files": [
        {
            "sha": "30c1c96baa0acb83684c15642a67b4db2b27ae97",
            "filename": "packages/next/src/build/duration-to-string.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 19,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts?ref=94f849e17a3b2b00f0dc2a493bce1217a3052691",
            "patch": "@@ -1,32 +1,54 @@\n+// Time thresholds in seconds\n+const SECONDS_IN_MINUTE = 60\n+const MINUTES_THRESHOLD_SECONDS = 120 // 2 minutes\n+const SECONDS_THRESHOLD_HIGH = 40\n+const SECONDS_THRESHOLD_LOW = 2\n+const MILLISECONDS_PER_SECOND = 1000\n+\n+// Time thresholds and conversion factors for nanoseconds\n+const NANOSECONDS_PER_SECOND = 1_000_000_000\n+const NANOSECONDS_PER_MILLISECOND = 1_000_000\n+const NANOSECONDS_PER_MICROSECOND = 1_000\n+const NANOSECONDS_IN_MINUTE = 60_000_000_000 // 60 * 1_000_000_000\n+const MINUTES_THRESHOLD_NANOSECONDS = 120_000_000_000 // 2 minutes in nanoseconds\n+const SECONDS_THRESHOLD_HIGH_NANOSECONDS = 40_000_000_000 // 40 seconds in nanoseconds\n+const SECONDS_THRESHOLD_LOW_NANOSECONDS = 2_000_000_000 // 2 seconds in nanoseconds\n+const MILLISECONDS_THRESHOLD_NANOSECONDS = 1_000_000 // 1 millisecond in nanoseconds\n+\n export function durationToString(compilerDuration: number) {\n-  let durationString\n-  if (compilerDuration > 120) {\n-    durationString = `${(compilerDuration / 60).toFixed(1)}min`\n-  } else if (compilerDuration > 40) {\n-    durationString = `${compilerDuration.toFixed(0)}s`\n-  } else if (compilerDuration > 2) {\n-    durationString = `${compilerDuration.toFixed(1)}s`\n+  if (compilerDuration > MINUTES_THRESHOLD_SECONDS) {\n+    return `${(compilerDuration / SECONDS_IN_MINUTE).toFixed(1)}min`\n+  } else if (compilerDuration > SECONDS_THRESHOLD_HIGH) {\n+    return `${compilerDuration.toFixed(0)}s`\n+  } else if (compilerDuration > SECONDS_THRESHOLD_LOW) {\n+    return `${compilerDuration.toFixed(1)}s`\n   } else {\n-    durationString = `${(compilerDuration * 1000).toFixed(0)}ms`\n+    return `${(compilerDuration * MILLISECONDS_PER_SECOND).toFixed(1)}ms`\n   }\n-  return durationString\n-}\n-\n-export function hrtimeToSeconds(hrtime: [number, number]): number {\n-  // hrtime is a tuple of [seconds, nanoseconds]\n-  return hrtime[0] + hrtime[1] / 1e9\n }\n \n-function nanosecondsBigIntToSeconds(nanoseconds: bigint): number {\n-  return Number(nanoseconds) / 1000000000\n+function durationToStringWithNanoseconds(durationBigInt: bigint): string {\n+  const duration = Number(durationBigInt)\n+  if (duration > MINUTES_THRESHOLD_NANOSECONDS) {\n+    return `${(duration / NANOSECONDS_IN_MINUTE).toFixed(1)}min`\n+  } else if (duration > SECONDS_THRESHOLD_HIGH_NANOSECONDS) {\n+    return `${(duration / NANOSECONDS_PER_SECOND).toFixed(0)}s`\n+  } else if (duration > SECONDS_THRESHOLD_LOW_NANOSECONDS) {\n+    return `${(duration / NANOSECONDS_PER_SECOND).toFixed(1)}s`\n+  } else if (duration > MILLISECONDS_THRESHOLD_NANOSECONDS) {\n+    return `${(duration / NANOSECONDS_PER_MILLISECOND).toFixed(0)}ms`\n+  } else {\n+    return `${(duration / NANOSECONDS_PER_MICROSECOND).toFixed(0)}Âµs`\n+  }\n }\n \n-function hrtimeBigIntToSeconds(hrtime: bigint): number {\n-  return nanosecondsBigIntToSeconds(hrtime)\n+export function hrtimeToSeconds(hrtime: [number, number]): number {\n+  // hrtime is a tuple of [seconds, nanoseconds]\n+  return hrtime[0] + hrtime[1] / NANOSECONDS_PER_SECOND\n }\n \n export function hrtimeBigIntDurationToString(hrtime: bigint) {\n-  return durationToString(hrtimeBigIntToSeconds(hrtime))\n+  return durationToStringWithNanoseconds(hrtime)\n }\n \n export function hrtimeDurationToString(hrtime: [number, number]): string {"
        },
        {
            "sha": "9bd24d98bd2fde32d5e890300801ceacf90e94cc",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=94f849e17a3b2b00f0dc2a493bce1217a3052691",
            "patch": "@@ -10,7 +10,7 @@ import { RouteKind } from '../../server/route-kind' with { 'turbopack-transition\n \n import { getRevalidateReason } from '../../server/instrumentation/utils'\n import { getTracer, SpanKind, type Span } from '../../server/lib/trace/tracer'\n-import { getRequestMeta } from '../../server/request-meta'\n+import { addRequestMeta, getRequestMeta } from '../../server/request-meta'\n import { BaseServerSpan } from '../../server/lib/trace/constants'\n import { interopDefault } from '../../server/app-render/interop-default'\n import { stripFlightHeaders } from '../../server/app-render/strip-flight-headers'\n@@ -118,6 +118,9 @@ export async function handler(\n     waitUntil: (prom: Promise<void>) => void\n   }\n ) {\n+  if (routeModule.isDev) {\n+    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n+  }\n   let srcPage = 'VAR_DEFINITION_PAGE'\n \n   // turbopack doesn't normalize `/index` in the page name"
        },
        {
            "sha": "69610823491a3c4e57c33b82dffde8faaab7d834",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=94f849e17a3b2b00f0dc2a493bce1217a3052691",
            "patch": "@@ -6,7 +6,7 @@ import {\n import { RouteKind } from '../../server/route-kind'\n import { patchFetch as _patchFetch } from '../../server/lib/patch-fetch'\n import type { IncomingMessage, ServerResponse } from 'node:http'\n-import { getRequestMeta } from '../../server/request-meta'\n+import { addRequestMeta, getRequestMeta } from '../../server/request-meta'\n import { getTracer, type Span, SpanKind } from '../../server/lib/trace/tracer'\n import { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\n import { createServerModuleMap } from '../../server/app-render/action-utils'\n@@ -85,6 +85,9 @@ export async function handler(\n     waitUntil: (prom: Promise<void>) => void\n   }\n ) {\n+  if (routeModule.isDev) {\n+    addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n+  }\n   let srcPage = 'VAR_DEFINITION_PAGE'\n \n   // turbopack doesn't normalize `/index` in the page name"
        },
        {
            "sha": "892c20c02a354466782fdde1751baf5e441806fb",
            "filename": "packages/next/src/server/dev/log-requests.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 4,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Flog-requests.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Flog-requests.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Flog-requests.ts?ref=94f849e17a3b2b00f0dc2a493bce1217a3052691",
            "patch": "@@ -7,6 +7,7 @@ import {\n   red,\n   white,\n   yellow,\n+  dim,\n } from '../../lib/picocolors'\n import { stripNextRscUnionQuery } from '../../lib/url'\n import type { FetchMetric } from '../base-http'\n@@ -43,14 +44,18 @@ export function logRequests(\n   response: NodeNextResponse,\n   loggingConfig: LoggingConfig,\n   requestStartTime: bigint,\n-  requestEndTime: bigint\n+  requestEndTime: bigint,\n+  devRequestTimingMiddlewareStart: bigint | undefined,\n+  devRequestTimingMiddlewareEnd: bigint | undefined\n ): void {\n   if (!ignoreLoggingIncomingRequests(request, loggingConfig)) {\n     logIncomingRequests(\n       request,\n       requestStartTime,\n       requestEndTime,\n-      response.statusCode\n+      response.statusCode,\n+      devRequestTimingMiddlewareStart,\n+      devRequestTimingMiddlewareEnd\n     )\n   }\n \n@@ -65,9 +70,15 @@ function logIncomingRequests(\n   request: NodeNextRequest,\n   requestStartTime: bigint,\n   requestEndTime: bigint,\n-  statusCode: number\n+  statusCode: number,\n+  devRequestTimingMiddlewareStart: bigint | undefined,\n+  devRequestTimingMiddlewareEnd: bigint | undefined\n ): void {\n   const isRSC = getRequestMeta(request, 'isRSCRequest')\n+  const devRequestTimingInternalsEnd = getRequestMeta(\n+    request,\n+    'devRequestTimingInternalsEnd'\n+  )\n   const url = isRSC ? stripNextRscUnionQuery(request.url) : request.url\n \n   const statusCodeColor =\n@@ -83,8 +94,31 @@ function logIncomingRequests(\n \n   const coloredStatus = statusCodeColor(statusCode.toString())\n \n+  const totalRequestTime = requestEndTime - requestStartTime\n+\n+  const times: Array<[label: string, time: bigint]> = []\n+\n+  let middlewareTime: bigint | undefined\n+  if (devRequestTimingMiddlewareStart && devRequestTimingMiddlewareEnd) {\n+    middlewareTime =\n+      devRequestTimingMiddlewareEnd - devRequestTimingMiddlewareStart\n+    times.push(['proxy.ts', middlewareTime])\n+  }\n+\n+  if (devRequestTimingInternalsEnd) {\n+    let frameworkTime = devRequestTimingInternalsEnd - requestStartTime\n+\n+    /* Middleware runs during the internals so we have to subtract it from the framework time */\n+    if (middlewareTime) {\n+      frameworkTime -= middlewareTime\n+    }\n+    // Insert as the first item to be rendered in the list\n+    times.unshift(['compile', frameworkTime])\n+    times.push(['render', requestEndTime - devRequestTimingInternalsEnd])\n+  }\n+\n   return writeLine(\n-    `${request.method} ${url} ${coloredStatus} in ${hrtimeBigIntDurationToString(requestEndTime - requestStartTime)}`\n+    `${request.method} ${url} ${coloredStatus} in ${hrtimeBigIntDurationToString(totalRequestTime)}${times.length > 0 ? dim(` (${times.map(([label, time]) => `${label}: ${hrtimeBigIntDurationToString(time)}`).join(', ')})`) : ''}`\n   )\n }\n "
        },
        {
            "sha": "ba4370461b251285a863473d896ba9b08b265387",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 3,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=94f849e17a3b2b00f0dc2a493bce1217a3052691",
            "patch": "@@ -466,8 +466,14 @@ export default class DevServer extends Server {\n       const loggingConfig = this.nextConfig.logging\n \n       if (loggingConfig !== false) {\n-        const requestStart = process.hrtime.bigint()\n-        const isMiddlewareRequest = getRequestMeta(req, 'middlewareInvoke')\n+        // The closure variable is not used here because the request handler may be invoked twice for one request when middleware is added in the application.\n+        // By setting the start time we can ensure that the middleware timing is correctly included.\n+        if (!getRequestMeta(req, 'devRequestTimingStart')) {\n+          const requestStart = process.hrtime.bigint()\n+          addRequestMeta(req, 'devRequestTimingStart', requestStart)\n+        }\n+        const isMiddlewareRequest =\n+          getRequestMeta(req, 'middlewareInvoke') ?? false\n \n         if (!isMiddlewareRequest) {\n           response.originalResponse.once('close', () => {\n@@ -480,13 +486,21 @@ export default class DevServer extends Server {\n               return\n             }\n \n+            // The closure variable is not used here because the request handler may be invoked twice for one request when middleware is added in the application.\n+            // By setting the start time we can ensure that the middleware timing is correctly included.\n+            const requestStart = getRequestMeta(req, 'devRequestTimingStart')\n+            if (!requestStart) {\n+              return\n+            }\n             const requestEnd = process.hrtime.bigint()\n             logRequests(\n               request,\n               response,\n               loggingConfig,\n               requestStart,\n-              requestEnd\n+              requestEnd,\n+              getRequestMeta(req, 'devRequestTimingMiddlewareStart'),\n+              getRequestMeta(req, 'devRequestTimingMiddlewareEnd')\n             )\n           })\n         }"
        },
        {
            "sha": "57aa9274bfde42a78831b56089c5ebba7903c2fc",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=94f849e17a3b2b00f0dc2a493bce1217a3052691",
            "patch": "@@ -519,6 +519,13 @@ export function getResolveRoutes(\n             addRequestMeta(req, 'invokeOutput', '')\n             addRequestMeta(req, 'invokeQuery', {})\n             addRequestMeta(req, 'middlewareInvoke', true)\n+            if (opts.dev) {\n+              addRequestMeta(\n+                req,\n+                'devRequestTimingMiddlewareStart',\n+                process.hrtime.bigint()\n+              )\n+            }\n             debug('invoking middleware', req.url, req.headers)\n \n             let middlewareRes: Response | undefined = undefined\n@@ -543,6 +550,14 @@ export function getResolveRoutes(\n                     },\n                   })\n                 }\n+              } finally {\n+                if (opts.dev) {\n+                  addRequestMeta(\n+                    req,\n+                    'devRequestTimingMiddlewareEnd',\n+                    process.hrtime.bigint()\n+                  )\n+                }\n               }\n             } catch (e) {\n               // If the client aborts before we can receive a response object"
        },
        {
            "sha": "4701795ecdc0843234a4580bc14fa65ade8c4448",
            "filename": "packages/next/src/server/request-meta.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/94f849e17a3b2b00f0dc2a493bce1217a3052691/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts?ref=94f849e17a3b2b00f0dc2a493bce1217a3052691",
            "patch": "@@ -262,6 +262,14 @@ export interface RequestMeta {\n    * DEV only: The fallback params that should be used when validating prerenders during dev\n    */\n   devValidatingFallbackParams?: OpaqueFallbackRouteParams\n+\n+  /**\n+   * DEV only: Request timings in process.hrtime.bigint()\n+   */\n+  devRequestTimingStart?: bigint\n+  devRequestTimingMiddlewareStart?: bigint\n+  devRequestTimingMiddlewareEnd?: bigint\n+  devRequestTimingInternalsEnd?: bigint\n }\n \n /**"
        }
    ],
    "stats": {
        "total": 155,
        "additions": 127,
        "deletions": 28
    }
}