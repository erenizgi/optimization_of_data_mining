{
    "author": "sokra",
    "message": "[Turbopack] add tracing to turbopack-tests (#76033)\n\n### What?\r\n\r\n* add tracing to turbopack-tests\r\n* remove env-filter from turbopack-cli\r\n* add empty feature list",
    "sha": "4abde4f15f894b0d7531bb83d788a6d18633d445",
    "files": [
        {
            "sha": "c63b639e734e7424bb5e872569ba8b0e0f36e988",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/4abde4f15f894b0d7531bb83d788a6d18633d445/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/4abde4f15f894b0d7531bb83d788a6d18633d445/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=4abde4f15f894b0d7531bb83d788a6d18633d445",
            "patch": "@@ -9984,6 +9984,8 @@ dependencies = [\n  \"serde_json\",\n  \"testing\",\n  \"tokio\",\n+ \"tracing\",\n+ \"tracing-subscriber\",\n  \"turbo-rcstr\",\n  \"turbo-tasks\",\n  \"turbo-tasks-backend\",\n@@ -10002,6 +10004,7 @@ dependencies = [\n  \"turbopack-nodejs\",\n  \"turbopack-resolve\",\n  \"turbopack-test-utils\",\n+ \"turbopack-trace-utils\",\n ]\n \n [[package]]"
        },
        {
            "sha": "a154ba90ed19df8c22f482ed421b851e787e343d",
            "filename": "turbopack/crates/turbo-tasks/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4abde4f15f894b0d7531bb83d788a6d18633d445/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/4abde4f15f894b0d7531bb83d788a6d18633d445/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml?ref=4abde4f15f894b0d7531bb83d788a6d18633d445",
            "patch": "@@ -9,6 +9,7 @@ edition = \"2021\"\n bench = false\n \n [features]\n+default = []\n tokio_tracing = [\"tokio/tracing\"]\n hanging_detection = []\n "
        },
        {
            "sha": "376037f39a639555d2e2c409ca1744dbc8a0910d",
            "filename": "turbopack/crates/turbopack-cli/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4abde4f15f894b0d7531bb83d788a6d18633d445/turbopack%2Fcrates%2Fturbopack-cli%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/4abde4f15f894b0d7531bb83d788a6d18633d445/turbopack%2Fcrates%2Fturbopack-cli%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2FCargo.toml?ref=4abde4f15f894b0d7531bb83d788a6d18633d445",
            "patch": "@@ -44,7 +44,7 @@ rustc-hash = { workspace = true }\n serde = { workspace = true }\n tokio = { workspace = true, features = [\"full\"] }\n tracing = { workspace = true }\n-tracing-subscriber = { workspace = true, features = [\"env-filter\", \"json\"] }\n+tracing-subscriber = { workspace = true, features = [\"json\"] }\n turbo-rcstr = { workspace = true }\n turbo-tasks = { workspace = true }\n turbo-tasks-backend = { workspace = true }"
        },
        {
            "sha": "beb6ff21026d0b0f450c64bf846bca28d8107c25",
            "filename": "turbopack/crates/turbopack-tests/Cargo.toml",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/4abde4f15f894b0d7531bb83d788a6d18633d445/turbopack%2Fcrates%2Fturbopack-tests%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/4abde4f15f894b0d7531bb83d788a6d18633d445/turbopack%2Fcrates%2Fturbopack-tests%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2FCargo.toml?ref=4abde4f15f894b0d7531bb83d788a6d18633d445",
            "patch": "@@ -26,6 +26,8 @@ serde = { workspace = true }\n serde_json = { workspace = true }\n testing = { workspace = true }\n tokio = { workspace = true }\n+tracing = { workspace = true }\n+tracing-subscriber = { workspace = true, features = [\"json\"] }\n turbo-rcstr = { workspace = true }\n turbo-tasks = { workspace = true }\n turbo-tasks-bytes = { workspace = true }\n@@ -44,6 +46,7 @@ turbopack-node = { workspace = true }\n turbopack-nodejs = { workspace = true, features = [\"test\"] }\n turbopack-resolve = { workspace = true }\n turbopack-test-utils = { workspace = true }\n+turbopack-trace-utils = { workspace = true }\n \n [build-dependencies]\n turbo-tasks-build = { workspace = true }"
        },
        {
            "sha": "a5c17162edce86c92e81a395d7348ea6d51bfdad",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 34,
            "deletions": 9,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/4abde4f15f894b0d7531bb83d788a6d18633d445/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4abde4f15f894b0d7531bb83d788a6d18633d445/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=4abde4f15f894b0d7531bb83d788a6d18633d445",
            "patch": "@@ -10,6 +10,7 @@ use std::path::PathBuf;\n use anyhow::{Context, Result};\n use dunce::canonicalize;\n use serde::{Deserialize, Serialize};\n+use tracing_subscriber::{layer::SubscriberExt, util::SubscriberInitExt, Registry};\n use turbo_rcstr::RcStr;\n use turbo_tasks::{\n     apply_effects, debug::ValueDebugFormat, fxindexmap, trace::TraceRawVcs, Completion,\n@@ -47,6 +48,10 @@ use turbopack_node::{debug::should_debug, evaluate::evaluate};\n use turbopack_nodejs::NodeJsChunkingContext;\n use turbopack_resolve::resolve_options_context::ResolveOptionsContext;\n use turbopack_test_utils::jest::JestRunResult;\n+use turbopack_trace_utils::{\n+    filter_layer::FilterLayer, raw_trace::RawTraceLayer, trace_writer::TraceWriter,\n+    tracing_presets::TRACING_TURBO_TASKS_TARGETS,\n+};\n \n use crate::util::REPO_ROOT;\n \n@@ -168,6 +173,21 @@ async fn run(resource: PathBuf, snapshot_mode: IssueSnapshotMode) -> Result<JsRe\n         std::fs::remove_dir_all(&output_path)?;\n     }\n \n+    let subscriber = Registry::default();\n+\n+    let trace = TRACING_TURBO_TASKS_TARGETS.join(\",\");\n+    let subscriber = subscriber.with(FilterLayer::try_new(&trace).unwrap());\n+\n+    std::fs::create_dir_all(&output_path)\n+        .context(\"Unable to create output directory\")\n+        .unwrap();\n+    let trace_file = output_path.join(\"trace-turbopack\");\n+    let trace_writer = std::fs::File::create(trace_file.clone()).unwrap();\n+    let (trace_writer, trace_writer_guard) = TraceWriter::new(trace_writer);\n+    let subscriber = subscriber.with(RawTraceLayer::new(trace_writer));\n+\n+    subscriber.init();\n+\n     let tt = TurboTasks::new(TurboTasksBackend::new(\n         BackendOptions {\n             storage_mode: None,\n@@ -176,15 +196,20 @@ async fn run(resource: PathBuf, snapshot_mode: IssueSnapshotMode) -> Result<JsRe\n         },\n         noop_backing_storage(),\n     ));\n-    tt.run_once(async move {\n-        let emit_op =\n-            run_inner_operation(resource.to_str().unwrap().into(), Value::new(snapshot_mode));\n-        let result = emit_op.read_strongly_consistent().owned().await?;\n-        apply_effects(emit_op).await?;\n-\n-        Ok(result)\n-    })\n-    .await\n+    let result = tt\n+        .run_once(async move {\n+            let emit_op =\n+                run_inner_operation(resource.to_str().unwrap().into(), Value::new(snapshot_mode));\n+            let result = emit_op.read_strongly_consistent().owned().await?;\n+            apply_effects(emit_op).await?;\n+\n+            Ok(result)\n+        })\n+        .await;\n+\n+    drop(trace_writer_guard);\n+\n+    result\n }\n \n #[turbo_tasks::function(operation)]"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 42,
        "deletions": 10
    }
}