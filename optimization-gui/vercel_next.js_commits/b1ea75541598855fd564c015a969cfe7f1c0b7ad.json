{
    "author": "lukesandberg",
    "message": "[turbopack[ Fix a bug in top level `this` analysis (#81076)\n\n### What\n\nFix a bug where we incorrectly identified a `this` reference in a getter prop of an object literal as being 'top level'.\n\nReported here: https://github.com/vercel/next.js/pull/80925#issuecomment-3018327194",
    "sha": "b1ea75541598855fd564c015a969cfe7f1c0b7ad",
    "files": [
        {
            "sha": "c7faa2d7d3d9012822631fe7c09dc711c0e6dc97",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/graph.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/b1ea75541598855fd564c015a969cfe7f1c0b7ad/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b1ea75541598855fd564c015a969cfe7f1c0b7ad/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs?ref=b1ea75541598855fd564c015a969cfe7f1c0b7ad",
            "patch": "@@ -797,11 +797,13 @@ pub fn is_in_try(ast_path: &AstNodePath<AstParentNodeRef<'_>>) -> bool {\n         .iter()\n         .rev()\n         .find_map(|ast_ref| match ast_ref.kind() {\n-            AstParentKind::ArrowExpr(ArrowExprField::Body) => Some(false),\n-            AstParentKind::Function(FunctionField::Body) => Some(false),\n-            AstParentKind::Constructor(ConstructorField::Body) => Some(false),\n-            AstParentKind::ClassMethod(ClassMethodField::Function) => Some(false),\n-            AstParentKind::MethodProp(MethodPropField::Function) => Some(false),\n+            AstParentKind::ArrowExpr(ArrowExprField::Body)\n+            | AstParentKind::Function(FunctionField::Body)\n+            | AstParentKind::Constructor(ConstructorField::Body)\n+            | AstParentKind::ClassMethod(ClassMethodField::Function)\n+            | AstParentKind::GetterProp(GetterPropField::Body)\n+            | AstParentKind::SetterProp(SetterPropField::Body)\n+            | AstParentKind::MethodProp(MethodPropField::Function) => Some(false),\n             AstParentKind::TryStmt(TryStmtField::Block) => Some(true),\n             _ => None,\n         })\n@@ -1928,6 +1930,8 @@ impl VisitAstPath for Analyzer<'_> {\n             matches!(\n                 node.kind(),\n                 AstParentKind::MethodProp(MethodPropField::Function)\n+                    | AstParentKind::GetterProp(GetterPropField::Body)\n+                    | AstParentKind::SetterProp(SetterPropField::Body)\n                     | AstParentKind::Constructor(ConstructorField::Body)\n                     | AstParentKind::ClassMethod(ClassMethodField::Function)\n                     | AstParentKind::ClassDecl(ClassDeclField::Class)"
        },
        {
            "sha": "6e0f12bb6be93de102a01c10b746b9d10d0fc59f",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/cjs-this/input/index.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b1ea75541598855fd564c015a969cfe7f1c0b7ad/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fcjs-this%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b1ea75541598855fd564c015a969cfe7f1c0b7ad/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fcjs-this%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fcjs-this%2Finput%2Findex.js?ref=b1ea75541598855fd564c015a969cfe7f1c0b7ad",
            "patch": "@@ -2,6 +2,13 @@ const t = this\n \n it('`this` in cjs should be exports', () => {\n   expect(t).toBe(exports)\n+  let o = {\n+    get foo() {\n+      return this\n+    },\n+  }\n+  // Regression test for a bug where we didn't identify the `this` ref in `foo` as being bound.\n+  expect(o.foo).toBe(o)\n })\n \n // Use a dummy assignment to ensure we are parsed as a cjs module"
        },
        {
            "sha": "9ad9f0a97b368ea38106b40a41a052da759d1a19",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/esm-this/input/index.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b1ea75541598855fd564c015a969cfe7f1c0b7ad/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fesm-this%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b1ea75541598855fd564c015a969cfe7f1c0b7ad/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fesm-this%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fesm-this%2Finput%2Findex.js?ref=b1ea75541598855fd564c015a969cfe7f1c0b7ad",
            "patch": "@@ -2,6 +2,13 @@ const t = this\n \n it('`this` in esm should be undefined', () => {\n   expect(t).toBeUndefined()\n+  let o = {\n+    get foo() {\n+      return this\n+    },\n+  }\n+  // Regression test for a bug where we didn't identify the `this` ref in `foo` as being bound.\n+  expect(o.foo).toBe(o)\n })\n \n // Use a dummy export to ensure this is parsed as an esm module"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 23,
        "deletions": 5
    }
}