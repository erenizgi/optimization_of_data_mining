{
    "author": "timneutkens",
    "message": "Turbopack Build: Fix next/font test (#79502)\n\n## What?\n\nFixes the test which assumed specific hashes.\n\nWhile digging into this with @sokra and @mischnic we found that the\nreason it currently preloads 4 instead of 2 files is because of source\nbased side-effects detection that Turbopack does not have yet. We've\ncreated an issue to track that so that this PR can land.",
    "sha": "65858a8480d65ede48b47676b5f817a0dde5cfe5",
    "files": [
        {
            "sha": "38e118bca9916f1eea54491ab189cf36d036afa9",
            "filename": "test/e2e/next-font/with-font-declarations-file.test.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 24,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/65858a8480d65ede48b47676b5f817a0dde5cfe5/test%2Fe2e%2Fnext-font%2Fwith-font-declarations-file.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/65858a8480d65ede48b47676b5f817a0dde5cfe5/test%2Fe2e%2Fnext-font%2Fwith-font-declarations-file.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-font%2Fwith-font-declarations-file.test.ts?ref=65858a8480d65ede48b47676b5f817a0dde5cfe5",
            "patch": "@@ -1,5 +1,5 @@\n import cheerio from 'cheerio'\n-import { createNext, FileRef } from 'e2e-utils'\n+import { createNext } from 'e2e-utils'\n import { NextInstance } from 'e2e-utils'\n import { renderViaHTTP } from 'next-test-utils'\n import { join } from 'path'\n@@ -20,20 +20,7 @@ describe('next/font/google with-font-declarations-file', () => {\n \n   beforeAll(async () => {\n     next = await createNext({\n-      files: {\n-        pages: new FileRef(\n-          join(__dirname, 'with-font-declarations-file/pages')\n-        ),\n-        components: new FileRef(\n-          join(__dirname, 'with-font-declarations-file/components')\n-        ),\n-        'fonts.js': new FileRef(\n-          join(__dirname, 'with-font-declarations-file/fonts.js')\n-        ),\n-        'my-font-roboto.woff2': new FileRef(\n-          join(__dirname, 'with-font-declarations-file/my-font-roboto.woff2')\n-        ),\n-      },\n+      files: join(__dirname, 'with-font-declarations-file'),\n       env: {\n         NEXT_FONT_GOOGLE_MOCKED_RESPONSES: mockedGoogleFontResponses,\n       },\n@@ -53,12 +40,17 @@ describe('next/font/google with-font-declarations-file', () => {\n       expect($('link[as=\"font\"]').length).toBe(4)\n     } else {\n       // Preload\n-      expect($('link[as=\"font\"]').length).toBe(2)\n+      expect($('link[as=\"font\"]').length).toBe(\n+        // TODO: Remove this once tree shaking PACK-4656\n+        process.env.IS_TURBOPACK_TEST ? 4 : 2\n+      )\n       // From /_app\n       expect($('link[as=\"font\"]').get(0).attribs).toEqual({\n         as: 'font',\n         crossorigin: 'anonymous',\n-        href: '/_next/static/media/0812efcfaefec5ea-s.p.woff2',\n+        href: expect.stringMatching(\n+          /\\/_next\\/static\\/media\\/.*-s\\.p(\\..*)?\\.woff2/\n+        ),\n         rel: 'preload',\n         type: 'font/woff2',\n         'data-next-font': 'size-adjust',\n@@ -67,7 +59,9 @@ describe('next/font/google with-font-declarations-file', () => {\n       expect($('link[as=\"font\"]').get(1).attribs).toEqual({\n         as: 'font',\n         crossorigin: 'anonymous',\n-        href: '/_next/static/media/4a7f86e553ee7e51-s.p.woff2',\n+        href: expect.stringMatching(\n+          /\\/_next\\/static\\/media\\/.*-s\\.p(\\..*)?\\.woff2/\n+        ),\n         rel: 'preload',\n         type: 'font/woff2',\n         'data-next-font': 'size-adjust',\n@@ -87,12 +81,17 @@ describe('next/font/google with-font-declarations-file', () => {\n       expect($('link[as=\"font\"]').length).toBe(4)\n     } else {\n       // Preload\n-      expect($('link[as=\"font\"]').length).toBe(2)\n+      expect($('link[as=\"font\"]').length).toBe(\n+        // TODO: Remove this once tree shaking PACK-4656\n+        process.env.IS_TURBOPACK_TEST ? 4 : 2\n+      )\n       // From /_app\n       expect($('link[as=\"font\"]').get(0).attribs).toEqual({\n         as: 'font',\n         crossorigin: 'anonymous',\n-        href: '/_next/static/media/0812efcfaefec5ea-s.p.woff2',\n+        href: expect.stringMatching(\n+          /\\/_next\\/static\\/media\\/.*-s\\.p(\\..*)?\\.woff2/\n+        ),\n         rel: 'preload',\n         type: 'font/woff2',\n         'data-next-font': 'size-adjust',\n@@ -101,7 +100,9 @@ describe('next/font/google with-font-declarations-file', () => {\n       expect($('link[as=\"font\"]').get(1).attribs).toEqual({\n         as: 'font',\n         crossorigin: 'anonymous',\n-        href: '/_next/static/media/9a7e84b4dd095b33-s.p.woff2',\n+        href: expect.stringMatching(\n+          /\\/_next\\/static\\/media\\/.*-s\\.p(\\..*)?\\.woff2/\n+        ),\n         rel: 'preload',\n         type: 'font/woff2',\n         'data-next-font': 'size-adjust',\n@@ -121,12 +122,17 @@ describe('next/font/google with-font-declarations-file', () => {\n       expect($('link[as=\"font\"]').length).toBe(4)\n     } else {\n       // Preload\n-      expect($('link[as=\"font\"]').length).toBe(2)\n+      expect($('link[as=\"font\"]').length).toBe(\n+        // TODO: Remove this once tree shaking PACK-4656\n+        process.env.IS_TURBOPACK_TEST ? 4 : 2\n+      )\n       // From /_app\n       expect($('link[as=\"font\"]').get(0).attribs).toEqual({\n         as: 'font',\n         crossorigin: 'anonymous',\n-        href: '/_next/static/media/0812efcfaefec5ea-s.p.woff2',\n+        href: expect.stringMatching(\n+          /\\/_next\\/static\\/media\\/.*-s\\.p(\\..*)?\\.woff2/\n+        ),\n         rel: 'preload',\n         type: 'font/woff2',\n         'data-next-font': 'size-adjust',\n@@ -135,7 +141,9 @@ describe('next/font/google with-font-declarations-file', () => {\n       expect($('link[as=\"font\"]').get(1).attribs).toEqual({\n         as: 'font',\n         crossorigin: 'anonymous',\n-        href: '/_next/static/media/934c4b7cb736f2a3-s.p.woff2',\n+        href: expect.stringMatching(\n+          /\\/_next\\/static\\/media\\/.*-s\\.p(\\..*)?\\.woff2/\n+        ),\n         rel: 'preload',\n         type: 'font/woff2',\n         'data-next-font': 'size-adjust',"
        },
        {
            "sha": "b270df8e7f1a3f237242639d4908a85276882932",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/65858a8480d65ede48b47676b5f817a0dde5cfe5/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/65858a8480d65ede48b47676b5f817a0dde5cfe5/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=65858a8480d65ede48b47676b5f817a0dde5cfe5",
            "patch": "@@ -7773,12 +7773,12 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/next-font/with-font-declarations-file.test.ts\": {\n-    \"passed\": [],\n-    \"failed\": [\n+    \"passed\": [\n       \"next/font/google with-font-declarations-file preload correct files at /inter\",\n       \"next/font/google with-font-declarations-file preload correct files at /local-font\",\n       \"next/font/google with-font-declarations-file preload correct files at /roboto\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 34,
        "deletions": 26
    }
}