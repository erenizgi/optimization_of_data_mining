{
    "author": "sokra",
    "message": "Turbopack: fix race condition in unit test (#82989)",
    "sha": "3596c0334303f464e201d74941a49d2fbe650ecf",
    "files": [
        {
            "sha": "7192b88383b5eddb13c93733e16d415fb0fddbdd",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/trait_ref_cell.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3596c0334303f464e201d74941a49d2fbe650ecf/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftrait_ref_cell.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3596c0334303f464e201d74941a49d2fbe650ecf/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftrait_ref_cell.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftrait_ref_cell.rs?ref=3596c0334303f464e201d74941a49d2fbe650ecf",
            "patch": "@@ -2,7 +2,7 @@\n #![feature(arbitrary_self_types_pointers)]\n #![allow(clippy::needless_return)] // tokio macro-generated code doesn't respect this\n \n-use std::sync::Mutex;\n+use std::{collections::HashSet, mem::take, sync::Mutex};\n \n use anyhow::Result;\n use turbo_tasks::{IntoTraitRef, Invalidator, TraitRef, Vc, get_invalidator};\n@@ -14,7 +14,7 @@ static REGISTRATION: Registration = register!();\n async fn trait_ref() {\n     run(&REGISTRATION, || async {\n         let counter = Counter::cell(Counter {\n-            value: Mutex::new((0, None)),\n+            value: Mutex::new((0, Default::default())),\n         });\n \n         let counter_value = counter.get_value();\n@@ -64,14 +64,14 @@ struct CounterValue(usize);\n #[turbo_tasks::value(serialization = \"none\", cell = \"new\", eq = \"manual\")]\n struct Counter {\n     #[turbo_tasks(debug_ignore, trace_ignore)]\n-    value: Mutex<(usize, Option<Invalidator>)>,\n+    value: Mutex<(usize, HashSet<Invalidator>)>,\n }\n \n impl Counter {\n     fn incr(&self) {\n         let mut lock = self.value.lock().unwrap();\n         lock.0 += 1;\n-        if let Some(i) = lock.1.take() {\n+        for i in take(&mut lock.1) {\n             i.invalidate();\n         }\n     }\n@@ -90,7 +90,7 @@ impl CounterTrait for Counter {\n     #[turbo_tasks::function]\n     fn get_value(&self) -> Result<Vc<CounterValue>> {\n         let mut lock = self.value.lock().unwrap();\n-        lock.1 = Some(get_invalidator());\n+        lock.1.insert(get_invalidator());\n         Ok(Vc::cell(lock.0))\n     }\n "
        }
    ],
    "stats": {
        "total": 10,
        "additions": 5,
        "deletions": 5
    }
}