{
    "author": "mischnic",
    "message": "Turbopack: fix duplicate unsupported edge import modules (#78236)\n\n1. Add the import in question to the module ident: `[project]/test/e2e/on-request-error/isr (unsupported edge import fs)`\n2. Wrap the source creation into a separate turbotask, so that `fs` and `fs/promises` get the same Source cell (instead of two different Sources with the same ident)",
    "sha": "1411821cdd88e93b0cbb44bf19a96386014921c6",
    "files": [
        {
            "sha": "b3f803e126bec9d8eda39cf22539fbb6dcf30995",
            "filename": "crates/next-core/src/next_edge/unsupported.rs",
            "status": "modified",
            "additions": 33,
            "deletions": 29,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/1411821cdd88e93b0cbb44bf19a96386014921c6/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Funsupported.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1411821cdd88e93b0cbb44bf19a96386014921c6/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Funsupported.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Funsupported.rs?ref=1411821cdd88e93b0cbb44bf19a96386014921c6",
            "patch": "@@ -1,9 +1,11 @@\n use anyhow::Result;\n use indoc::formatdoc;\n+use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Vc};\n use turbo_tasks_fs::{File, FileSystemPath};\n use turbopack_core::{\n     asset::AssetContent,\n+    ident::AssetIdent,\n     resolve::{\n         options::{ImportMapResult, ImportMappingReplacement, ReplacedImportMapping},\n         parse::Request,\n@@ -13,30 +15,20 @@ use turbopack_core::{\n     virtual_source::VirtualSource,\n };\n use turbopack_ecmascript::runtime_functions::TURBOPACK_EXPORT_NAMESPACE;\n-use turbopack_node::execution_context::ExecutionContext;\n \n /// Intercepts requests for the given request to `unsupported` error messages\n /// by returning a VirtualSource proxies to any import request to raise a\n /// runtime error.\n ///\n /// This can be used by import map alias, refer `next_import_map` for the setup.\n #[turbo_tasks::value(shared)]\n-pub struct NextEdgeUnsupportedModuleReplacer {\n-    project_path: ResolvedVc<FileSystemPath>,\n-    execution_context: ResolvedVc<ExecutionContext>,\n-}\n+pub struct NextEdgeUnsupportedModuleReplacer {}\n \n #[turbo_tasks::value_impl]\n impl NextEdgeUnsupportedModuleReplacer {\n     #[turbo_tasks::function]\n-    pub fn new(\n-        project_path: ResolvedVc<FileSystemPath>,\n-        execution_context: ResolvedVc<ExecutionContext>,\n-    ) -> Vc<Self> {\n-        Self::cell(NextEdgeUnsupportedModuleReplacer {\n-            project_path,\n-            execution_context,\n-        })\n+    pub fn new() -> Vc<Self> {\n+        NextEdgeUnsupportedModuleReplacer {}.cell()\n     }\n }\n \n@@ -50,25 +42,37 @@ impl ImportMappingReplacement for NextEdgeUnsupportedModuleReplacer {\n     #[turbo_tasks::function]\n     async fn result(\n         &self,\n-        root_path: Vc<FileSystemPath>,\n+        lookup_path: Vc<FileSystemPath>,\n         request: Vc<Request>,\n     ) -> Result<Vc<ImportMapResult>> {\n         let request = &*request.await?;\n         if let Request::Module { module, .. } = request {\n-            // packages/next/src/server/web/globals.ts augments global with\n-            // `__import_unsupported` and necessary functions.\n-            let code = formatdoc! {\n-              r#\"\n-              {TURBOPACK_EXPORT_NAMESPACE}(__import_unsupported(`{module}`));\n-              \"#\n-            };\n-            let content = AssetContent::file(File::from(code).into());\n-            let source = VirtualSource::new(root_path, content).to_resolved().await?;\n-            return Ok(\n-                ImportMapResult::Result(ResolveResult::source(ResolvedVc::upcast(source))).cell(),\n-            );\n-        };\n-\n-        Ok(ImportMapResult::NoEntry.cell())\n+            // Call out to separate `unsupported_module_source` to only have a single Source cell\n+            // for requests with different subpaths: `fs` and `fs/promises`.\n+            let source = unsupported_module_source(lookup_path.root(), module.clone())\n+                .to_resolved()\n+                .await?;\n+            Ok(ImportMapResult::Result(ResolveResult::source(ResolvedVc::upcast(source))).cell())\n+        } else {\n+            Ok(ImportMapResult::NoEntry.cell())\n+        }\n     }\n }\n+\n+#[turbo_tasks::function]\n+fn unsupported_module_source(root_path: Vc<FileSystemPath>, module: RcStr) -> Vc<VirtualSource> {\n+    // packages/next/src/server/web/globals.ts augments global with\n+    // `__import_unsupported` and necessary functions.\n+    let code = formatdoc! {\n+        r#\"\n+        {TURBOPACK_EXPORT_NAMESPACE}(__import_unsupported(`{module}`));\n+        \"#\n+    };\n+    let content = AssetContent::file(File::from(code).into());\n+    VirtualSource::new_with_ident(\n+        AssetIdent::from_path(root_path).with_modifier(Vc::cell(\n+            format!(\"unsupported edge import {}\", module).into(),\n+        )),\n+        content,\n+    )\n+}"
        },
        {
            "sha": "cf9bc88bcaadb94dea93908d365e46407c122aac",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 12,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/1411821cdd88e93b0cbb44bf19a96386014921c6/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1411821cdd88e93b0cbb44bf19a96386014921c6/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=1411821cdd88e93b0cbb44bf19a96386014921c6",
            "patch": "@@ -485,12 +485,7 @@ pub async fn get_next_edge_import_map(\n         | ServerContextType::Pages { .. }\n         | ServerContextType::PagesData { .. }\n         | ServerContextType::PagesApi { .. } => {\n-            insert_unsupported_node_internal_aliases(\n-                &mut import_map,\n-                *project_path,\n-                execution_context,\n-            )\n-            .await?;\n+            insert_unsupported_node_internal_aliases(&mut import_map).await?;\n         }\n     }\n \n@@ -500,13 +495,9 @@ pub async fn get_next_edge_import_map(\n /// Insert default aliases for the node.js's internal to raise unsupported\n /// runtime errors. User may provide polyfills for their own by setting user\n /// config's alias.\n-async fn insert_unsupported_node_internal_aliases(\n-    import_map: &mut ImportMap,\n-    project_path: Vc<FileSystemPath>,\n-    execution_context: Vc<ExecutionContext>,\n-) -> Result<()> {\n+async fn insert_unsupported_node_internal_aliases(import_map: &mut ImportMap) -> Result<()> {\n     let unsupported_replacer = ImportMapping::Dynamic(ResolvedVc::upcast(\n-        NextEdgeUnsupportedModuleReplacer::new(project_path, execution_context)\n+        NextEdgeUnsupportedModuleReplacer::new()\n             .to_resolved()\n             .await?,\n     ))"
        }
    ],
    "stats": {
        "total": 77,
        "additions": 36,
        "deletions": 41
    }
}