{
    "author": "unstubbable",
    "message": "Handle cross-page client reference contamination in development (#86591)",
    "sha": "8303bbd4600b08fd56cf14209423cfc0404646bf",
    "files": [
        {
            "sha": "30792573c713dbddc565b82285c69bf59fa504c2",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -947,5 +947,9 @@\n   \"946\": \"Failed to deserialize errors.\",\n   \"947\": \"Expected `sendErrorsToBrowser` to be defined in renderOpts.\",\n   \"948\": \"Failed to serialize errors.\",\n-  \"949\": \"Route %s errored during %s. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled.\\n          \\nOriginal Error: %s\"\n+  \"949\": \"Route %s errored during %s. These errors are normally ignored and may not prevent the route from prerendering but are logged here because build debugging is enabled.\\n          \\nOriginal Error: %s\",\n+  \"950\": \"The manifests singleton was not initialized.\",\n+  \"951\": \"The client reference manifest for route \\\"%s\\\" does not exist.\",\n+  \"952\": \"Cannot access \\\"%s\\\" without a work store.\",\n+  \"953\": \"This is a proxied client reference manifest. The property \\\"%s\\\" is not handled.\"\n }"
        },
        {
            "sha": "b0123ecdc9bbd2527c656f694795550f8496c084",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -21,12 +21,11 @@ import {\n   createOpaqueFallbackRouteParams,\n   type OpaqueFallbackRouteParams,\n } from '../../server/request/fallback-params'\n-import { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\n+import { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\n import {\n   isHtmlBotRequest,\n   shouldServeStreamingMetadata,\n } from '../../server/lib/streaming-metadata'\n-import { createServerModuleMap } from '../../server/app-render/action-utils'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { getIsPossibleServerAction } from '../../server/lib/server-action-request-meta'\n import {\n@@ -400,13 +399,10 @@ export async function handler(\n   // set the reference manifests to our global store so Server Action's\n   // encryption util can access to them at the top level of the page module.\n   if (serverActionsManifest && clientReferenceManifest) {\n-    setReferenceManifestsSingleton({\n+    setManifestsSingleton({\n       page: srcPage,\n       clientReferenceManifest,\n       serverActionsManifest,\n-      serverModuleMap: createServerModuleMap({\n-        serverActionsManifest,\n-      }),\n     })\n   }\n \n@@ -540,8 +536,6 @@ export async function handler(\n           nextFontManifest,\n           reactLoadableManifest,\n           subresourceIntegrityManifest,\n-          serverActionsManifest,\n-          clientReferenceManifest,\n           setCacheStatus: routerServerContext?.setCacheStatus,\n           setIsrStatus: routerServerContext?.setIsrStatus,\n           setReactDebugChannel: routerServerContext?.setReactDebugChannel,"
        },
        {
            "sha": "51885144ef010131dd0343011d37b04fb26932c2",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -8,8 +8,7 @@ import { patchFetch as _patchFetch } from '../../server/lib/patch-fetch'\n import type { IncomingMessage, ServerResponse } from 'node:http'\n import { addRequestMeta, getRequestMeta } from '../../server/request-meta'\n import { getTracer, type Span, SpanKind } from '../../server/lib/trace/tracer'\n-import { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\n-import { createServerModuleMap } from '../../server/app-render/action-utils'\n+import { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { NodeNextRequest, NodeNextResponse } from '../../server/base-http/node'\n import {\n@@ -185,13 +184,10 @@ export async function handler(\n   // set the reference manifests to our global store so Server Action's\n   // encryption util can access to them at the top level of the page module.\n   if (serverActionsManifest && clientReferenceManifest) {\n-    setReferenceManifestsSingleton({\n+    setManifestsSingleton({\n       page: srcPage,\n       clientReferenceManifest,\n       serverActionsManifest,\n-      serverModuleMap: createServerModuleMap({\n-        serverActionsManifest,\n-      }),\n     })\n   }\n "
        },
        {
            "sha": "79fb78ff1f0cf549b116d9a97e79ebcb70985b1a",
            "filename": "packages/next/src/build/templates/edge-app-route.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -1,5 +1,4 @@\n-import { createServerModuleMap } from '../../server/app-render/action-utils'\n-import { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\n+import { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\n import type { NextConfigComplete } from '../../server/config-shared'\n import { EdgeRouteModuleWrapper } from '../../server/web/edge-route-module-wrapper'\n \n@@ -16,13 +15,10 @@ const rscManifest = self.__RSC_MANIFEST?.['VAR_PAGE']\n const rscServerManifest = maybeJSONParse(self.__RSC_SERVER_MANIFEST)\n \n if (rscManifest && rscServerManifest) {\n-  setReferenceManifestsSingleton({\n+  setManifestsSingleton({\n     page: 'VAR_PAGE',\n     clientReferenceManifest: rscManifest,\n     serverActionsManifest: rscServerManifest,\n-    serverModuleMap: createServerModuleMap({\n-      serverActionsManifest: rscServerManifest,\n-    }),\n   })\n }\n "
        },
        {
            "sha": "800d63ba7ca87b257b3139198b70af1f34038853",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -6,8 +6,7 @@ import * as pageMod from 'VAR_USERLAND'\n \n import type { RequestData } from '../../server/web/types'\n import type { NextConfigComplete } from '../../server/config-shared'\n-import { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\n-import { createServerModuleMap } from '../../server/app-render/action-utils'\n+import { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\n import { initializeCacheHandlers } from '../../server/use-cache/handlers'\n import { BaseServerSpan } from '../../server/lib/trace/constants'\n import { getTracer, SpanKind, type Span } from '../../server/lib/trace/tracer'\n@@ -40,13 +39,10 @@ const rscManifest = self.__RSC_MANIFEST?.['VAR_PAGE']\n const rscServerManifest = maybeJSONParse(self.__RSC_SERVER_MANIFEST)\n \n if (rscManifest && rscServerManifest) {\n-  setReferenceManifestsSingleton({\n+  setManifestsSingleton({\n     page: 'VAR_PAGE',\n     clientReferenceManifest: rscManifest,\n     serverActionsManifest: rscServerManifest,\n-    serverModuleMap: createServerModuleMap({\n-      serverActionsManifest: rscServerManifest,\n-    }),\n   })\n }\n \n@@ -81,12 +77,10 @@ async function requestHandler(\n     buildManifest,\n     prerenderManifest,\n     reactLoadableManifest,\n-    clientReferenceManifest,\n     subresourceIntegrityManifest,\n     dynamicCssManifest,\n     nextFontManifest,\n     resolvedPathname,\n-    serverActionsManifest,\n     interceptionRoutePatterns,\n     routerServerContext,\n   } = prepareResult\n@@ -129,8 +123,6 @@ async function requestHandler(\n       reactLoadableManifest,\n       subresourceIntegrityManifest,\n       dynamicCssManifest,\n-      serverActionsManifest,\n-      clientReferenceManifest,\n       setIsrStatus: routerServerContext?.setIsrStatus,\n \n       dir: pageRouteModule.relativeProjectDir,"
        },
        {
            "sha": "e9fe2cc607125fb9dc596c96ea75a882dd0de325",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -682,7 +682,14 @@ const nextAppLoader: AppLoader = async function nextAppLoader() {\n \n   const buildInfo = getModuleBuildInfo((this as any)._module)\n   const collectedDeclarations: [string, string][] = []\n-  const page = name.replace(/^app/, '')\n+\n+  // Use the page from loaderOptions directly instead of deriving it from name.\n+  // The name (bundlePath) may have been normalized with normalizePagePath()\n+  // which is designed for Pages Router and incorrectly duplicates /index paths\n+  // (e.g., /index/page -> /index/index/page). The page parameter contains the\n+  // correct unnormalized value.\n+  const page = loaderOptions.page\n+\n   const middlewareConfig: ProxyConfig = JSON.parse(\n     Buffer.from(middlewareConfigBase64, 'base64').toString()\n   )"
        },
        {
            "sha": "6726d4a601835d5c25a62ccfb31fdd1c252d4dc9",
            "filename": "packages/next/src/build/webpack/plugins/flight-manifest-plugin.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -41,7 +41,7 @@ interface Options {\n type ModuleId = string | number /*| null*/\n \n // double indexed chunkId, filename\n-export type ManifestChunks = Array<string>\n+export type ManifestChunks = ReadonlyArray<string>\n \n const pluginState = getProxiedPluginState({\n   ssrModules: {} as { [ssrModuleId: string]: ModuleInfo },"
        },
        {
            "sha": "c736915c4c162146baee14a2942f5e2ab42f4f72",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -385,11 +385,6 @@ async function exportAppImpl(\n       join(distDir, 'server', `${NEXT_FONT_MANIFEST}.json`)\n     ),\n     images: nextConfig.images,\n-    ...(enabledDirectories.app\n-      ? {\n-          serverActionsManifest,\n-        }\n-      : {}),\n     deploymentId: nextConfig.deploymentId,\n     htmlLimitedBots: nextConfig.htmlLimitedBots.source,\n     experimental: {"
        },
        {
            "sha": "3283d261eccddaabed3da3fe62331820b98bf6d9",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 19,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -49,7 +49,7 @@ import { warn } from '../../build/output/log'\n import { RequestCookies, ResponseCookies } from '../web/spec-extension/cookies'\n import { HeadersAdapter } from '../web/spec-extension/adapters/headers'\n import { fromNodeOutgoingHttpHeaders } from '../web/utils'\n-import { selectWorkerForForwarding } from './action-utils'\n+import { selectWorkerForForwarding, type ServerModuleMap } from './action-utils'\n import { isNodeNextRequest, isWebNextRequest } from '../base-http/helpers'\n import { RedirectStatusCode } from '../../client/components/redirect-status-code'\n import { synchronizeMutableCookies } from '../async-storage/request-store'\n@@ -59,7 +59,7 @@ import { InvariantError } from '../../shared/lib/invariant-error'\n import { executeRevalidates } from '../revalidation-utils'\n import { getRequestMeta } from '../request-meta'\n import { setCacheBustingSearchParam } from '../../client/components/router-reducer/set-cache-busting-search-param'\n-import { getServerModuleMap } from './encryption-utils'\n+import { getServerModuleMap } from './manifests-singleton'\n \n function formDataFromSearchQueryString(query: string) {\n   const searchParams = new URLSearchParams(query)\n@@ -473,15 +473,6 @@ export function parseHostHeader(\n       : undefined\n }\n \n-type ServerModuleMap = Record<\n-  string,\n-  {\n-    id: string\n-    chunks: string[]\n-    name: string\n-  }\n->\n-\n type ServerActionsConfig = {\n   bodySizeLimit?: SizeLimit\n   allowedOrigins?: string[]\n@@ -522,7 +513,7 @@ export async function handleAction({\n   metadata: AppPageRenderResultMetadata\n }): Promise<HandleActionResult> {\n   const contentType = req.headers['content-type']\n-  const { serverActionsManifest, page } = ctx.renderOpts\n+  const { page } = ctx.renderOpts\n   const serverModuleMap = getServerModuleMap()\n \n   const {\n@@ -640,11 +631,7 @@ export async function handleAction({\n   const actionWasForwarded = Boolean(req.headers['x-action-forwarded'])\n \n   if (actionId) {\n-    const forwardedWorker = selectWorkerForForwarding(\n-      actionId,\n-      page,\n-      serverActionsManifest\n-    )\n+    const forwardedWorker = selectWorkerForForwarding(actionId, page)\n \n     // If forwardedWorker is truthy, it means there isn't a worker for the action\n     // in the current handler, so we forward the request to a worker that has the action.\n@@ -685,7 +672,7 @@ export async function handleAction({\n       { isAction: true },\n       async (): Promise<HandleActionResult> => {\n         // We only use these for fetch actions -- MPA actions handle them inside `decodeAction`.\n-        let actionModId: string | undefined\n+        let actionModId: string | number | undefined\n         let boundActionArguments: unknown[] = []\n \n         if (\n@@ -1214,7 +1201,7 @@ async function executeActionAndPrepareForRender<\n function getActionModIdOrError(\n   actionId: string | null,\n   serverModuleMap: ServerModuleMap\n-): string {\n+): string | number {\n   // if we're missing the action ID header, we can't do any further processing\n   if (!actionId) {\n     throw new InvariantError(\"Missing 'next-action' header.\")"
        },
        {
            "sha": "422286764c97feb106e46b826b784b50620b3b87",
            "filename": "packages/next/src/server/app-render/action-utils.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 6,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-utils.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -2,8 +2,18 @@ import type { ActionManifest } from '../../build/webpack/plugins/flight-client-e\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { pathHasPrefix } from '../../shared/lib/router/utils/path-has-prefix'\n import { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\n+import { getServerActionsManifest } from './manifests-singleton'\n import { workAsyncStorage } from './work-async-storage.external'\n \n+export interface ServerModuleMap {\n+  readonly [name: string]: {\n+    readonly id: string | number\n+    readonly name: string\n+    readonly chunks: Readonly<Array<string>> // currently not used\n+    readonly async?: boolean\n+  }\n+}\n+\n // This function creates a Flight-acceptable server module map proxy from our\n // Server Reference Manifest similar to our client module map.\n // This is because our manifest contains a lot of internal Next.js data that\n@@ -12,7 +22,7 @@ export function createServerModuleMap({\n   serverActionsManifest,\n }: {\n   serverActionsManifest: ActionManifest\n-}) {\n+}): ServerModuleMap {\n   return new Proxy(\n     {},\n     {\n@@ -61,11 +71,8 @@ export function createServerModuleMap({\n  * Checks if the requested action has a worker for the current page.\n  * If not, it returns the first worker that has a handler for the action.\n  */\n-export function selectWorkerForForwarding(\n-  actionId: string,\n-  pageName: string,\n-  serverActionsManifest: ActionManifest\n-) {\n+export function selectWorkerForForwarding(actionId: string, pageName: string) {\n+  const serverActionsManifest = getServerActionsManifest()\n   const workers =\n     serverActionsManifest[\n       process.env.NEXT_RUNTIME === 'edge' ? 'edge' : 'node'"
        },
        {
            "sha": "5d4802c2b6b8f471587c56e7db5ee8a83e223dba",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 48,
            "deletions": 126,
            "changes": 174,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -23,11 +23,6 @@ import type {\n import type { NextParsedUrlQuery } from '../request-meta'\n import type { LoaderTree } from '../lib/app-dir-module'\n import type { AppPageModule } from '../route-modules/app-page/module'\n-import type {\n-  ClientReferenceManifest,\n-  ManifestNode,\n-} from '../../build/webpack/plugins/flight-manifest-plugin'\n-import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n import type { BaseNextRequest, BaseNextResponse } from '../base-http'\n import type { IncomingHttpHeaders } from 'http'\n import * as ReactClient from 'react'\n@@ -100,7 +95,10 @@ import { makeGetServerInsertedHTML } from './make-get-server-inserted-html'\n import { walkTreeWithFlightRouterState } from './walk-tree-with-flight-router-state'\n import { createComponentTree, getRootParams } from './create-component-tree'\n import { getAssetQueryString } from './get-asset-query-string'\n-import { getServerModuleMap } from './encryption-utils'\n+import {\n+  getClientReferenceManifest,\n+  getServerModuleMap,\n+} from './manifests-singleton'\n import {\n   DynamicState,\n   type PostponedState,\n@@ -255,7 +253,6 @@ export type AppRenderContext = {\n   requestId: string\n   htmlRequestId: string\n   pagePath: string\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>\n   assetPrefix: string\n   isNotFoundPath: boolean\n   nonce: string | undefined\n@@ -598,7 +595,6 @@ async function generateDynamicFlightRenderResult(\n   }\n ): Promise<RenderResult> {\n   const {\n-    clientReferenceManifest,\n     componentMod: { renderToReadableStream },\n     htmlRequestId,\n     renderOpts,\n@@ -635,6 +631,8 @@ async function generateDynamicFlightRenderResult(\n     setReactDebugChannel(debugChannel.clientSide, htmlRequestId, requestId)\n   }\n \n+  const { clientModules } = getClientReferenceManifest()\n+\n   // For app dir, use the bundled version of Flight server renderer (renderToReadableStream)\n   // which contains the subset React.\n   const rscPayload = await workUnitAsyncStorage.run(\n@@ -648,7 +646,7 @@ async function generateDynamicFlightRenderResult(\n     requestStore,\n     renderToReadableStream,\n     rscPayload,\n-    clientReferenceManifest.clientModules,\n+    clientModules,\n     {\n       onError,\n       temporaryReferences: options?.temporaryReferences,\n@@ -674,7 +672,6 @@ async function stagedRenderToReadableStreamWithoutCachesInDev(\n   ctx: AppRenderContext,\n   requestStore: RequestStore,\n   getPayload: (requestStore: RequestStore) => Promise<RSCPayload>,\n-  clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>,\n   options: Omit<RenderToReadableStreamServerOptions, 'environmentName'>\n ) {\n   const {\n@@ -722,21 +719,18 @@ async function stagedRenderToReadableStreamWithoutCachesInDev(\n     requestStore.headers\n   )\n \n+  const { clientModules } = getClientReferenceManifest()\n   const rscPayload = await getPayload(requestStore)\n \n   return await workUnitAsyncStorage.run(\n     requestStore,\n     scheduleInSequentialTasks,\n     () => {\n       stageController.advanceStage(RenderStage.Static)\n-      return renderToReadableStream(\n-        rscPayload,\n-        clientReferenceManifest.clientModules,\n-        {\n-          ...options,\n-          environmentName,\n-        }\n-      )\n+      return renderToReadableStream(rscPayload, clientModules, {\n+        ...options,\n+        environmentName,\n+      })\n     },\n     () => {\n       stageController.advanceStage(RenderStage.Dynamic)\n@@ -769,10 +763,8 @@ async function generateDynamicFlightRenderResultWithStagesInDev(\n     onInstrumentationRequestError,\n     setReactDebugChannel,\n     setCacheStatus,\n-    clientReferenceManifest,\n     nextExport = false,\n   } = renderOpts\n-  assertClientReferenceManifest(clientReferenceManifest)\n \n   function onFlightDataRenderError(err: DigestedError, silenceLog: boolean) {\n     return onInstrumentationRequestError?.(\n@@ -871,7 +863,6 @@ async function generateDynamicFlightRenderResultWithStagesInDev(\n         staticStageEndTime,\n         runtimeStageEndTime,\n         ctx,\n-        clientReferenceManifest,\n         finalRequestStore,\n         devFallbackParams,\n         validationDebugChannelClient\n@@ -895,7 +886,6 @@ async function generateDynamicFlightRenderResultWithStagesInDev(\n       ctx,\n       initialRequestStore,\n       getPayload,\n-      clientReferenceManifest,\n       {\n         onError: onError,\n         filterStackFrame,\n@@ -1006,10 +996,7 @@ async function prospectiveRuntimeServerPrerender(\n   draftMode: PrerenderStoreModernRuntime['draftMode']\n ) {\n   const { implicitTags, renderOpts, workStore } = ctx\n-\n-  const { clientReferenceManifest, ComponentMod } = renderOpts\n-\n-  assertClientReferenceManifest(clientReferenceManifest)\n+  const { ComponentMod } = renderOpts\n \n   // Prerender controller represents the lifetime of the prerender.\n   // It will be aborted when a Task is complete or a synchronously aborting\n@@ -1056,6 +1043,8 @@ async function prospectiveRuntimeServerPrerender(\n     draftMode,\n   }\n \n+  const { clientModules } = getClientReferenceManifest()\n+\n   // We're not going to use the result of this render because the only time it could be used\n   // is if it completes in a microtask and that's likely very rare for any non-trivial app\n   const initialServerPayload = await workUnitAsyncStorage.run(\n@@ -1067,7 +1056,7 @@ async function prospectiveRuntimeServerPrerender(\n     initialServerPrerenderStore,\n     ComponentMod.prerender,\n     initialServerPayload,\n-    clientReferenceManifest.clientModules,\n+    clientModules,\n     {\n       filterStackFrame,\n       onError: (err) => {\n@@ -1260,16 +1249,7 @@ async function finalRuntimeServerPrerender(\n   runtimePrefetchSentinel: number\n ) {\n   const { implicitTags, renderOpts } = ctx\n-\n-  const {\n-    clientReferenceManifest,\n-    ComponentMod,\n-    experimental,\n-    isDebugDynamicAccesses,\n-  } = renderOpts\n-\n-  assertClientReferenceManifest(clientReferenceManifest)\n-\n+  const { ComponentMod, experimental, isDebugDynamicAccesses } = renderOpts\n   const selectStaleTime = createSelectStaleTime(experimental)\n \n   let serverIsDynamic = false\n@@ -1309,6 +1289,8 @@ async function finalRuntimeServerPrerender(\n     draftMode,\n   }\n \n+  const { clientModules } = getClientReferenceManifest()\n+\n   const finalRSCPayload = await workUnitAsyncStorage.run(\n     finalServerPrerenderStore,\n     getPayload\n@@ -1322,7 +1304,7 @@ async function finalRuntimeServerPrerender(\n         finalServerPrerenderStore,\n         ComponentMod.prerender,\n         finalRSCPayload,\n-        clientReferenceManifest.clientModules,\n+        clientModules,\n         {\n           filterStackFrame,\n           onError,\n@@ -1682,23 +1664,12 @@ async function getErrorRSCPayload(\n   } satisfies InitialRSCPayload\n }\n \n-function assertClientReferenceManifest(\n-  clientReferenceManifest: RenderOpts['clientReferenceManifest']\n-): asserts clientReferenceManifest is NonNullable<\n-  RenderOpts['clientReferenceManifest']\n-> {\n-  if (!clientReferenceManifest) {\n-    throw new InvariantError('Expected clientReferenceManifest to be defined.')\n-  }\n-}\n-\n // This component must run in an SSR context. It will render the RSC root component\n function App<T>({\n   reactServerStream,\n   reactDebugStream,\n   debugEndTime,\n   preinitScripts,\n-  clientReferenceManifest,\n   ServerInsertedHTMLProvider,\n   nonce,\n   images,\n@@ -1708,7 +1679,6 @@ function App<T>({\n   reactDebugStream: Readable | ReadableStream<Uint8Array> | undefined\n   debugEndTime: number | undefined\n   preinitScripts: () => void\n-  clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedHTMLProvider: ComponentType<{\n     children: JSX.Element\n   }>\n@@ -1721,7 +1691,6 @@ function App<T>({\n       reactServerStream,\n       reactDebugStream,\n       debugEndTime,\n-      clientReferenceManifest,\n       nonce\n     )\n   )\n@@ -1767,14 +1736,12 @@ function App<T>({\n function ErrorApp<T>({\n   reactServerStream,\n   preinitScripts,\n-  clientReferenceManifest,\n   ServerInsertedHTMLProvider,\n   nonce,\n   images,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n   preinitScripts: () => void\n-  clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedHTMLProvider: ComponentType<{\n     children: JSX.Element\n   }>\n@@ -1788,7 +1755,6 @@ function ErrorApp<T>({\n       reactServerStream,\n       undefined,\n       undefined,\n-      clientReferenceManifest,\n       nonce\n     )\n   )\n@@ -1852,7 +1818,6 @@ async function renderToHTMLOrFlightImpl(\n   const requestTimestamp = Date.now()\n \n   const {\n-    clientReferenceManifest,\n     ComponentMod,\n     nextFontManifest,\n     serverActions,\n@@ -1977,8 +1942,6 @@ async function renderToHTMLOrFlightImpl(\n \n   const appUsingSizeAdjustment = !!nextFontManifest?.appUsingSizeAdjust\n \n-  assertClientReferenceManifest(clientReferenceManifest)\n-\n   ComponentMod.patchFetch()\n \n   // Pull out the hooks/references from the component.\n@@ -2070,7 +2033,6 @@ async function renderToHTMLOrFlightImpl(\n     requestId,\n     htmlRequestId,\n     pagePath,\n-    clientReferenceManifest,\n     assetPrefix,\n     isNotFoundPath,\n     nonce,\n@@ -2548,7 +2510,6 @@ async function renderToStream(\n   const {\n     basePath,\n     buildManifest,\n-    clientReferenceManifest,\n     ComponentMod: {\n       createElement,\n       renderToReadableStream: serverRenderToReadableStream,\n@@ -2567,8 +2528,6 @@ async function renderToStream(\n     cacheComponents,\n   } = renderOpts\n \n-  assertClientReferenceManifest(clientReferenceManifest)\n-\n   const { ServerInsertedHTMLProvider, renderServerInsertedHTML } =\n     createServerInsertedHTML()\n   const getServerInsertedMetadata = createServerInsertedMetadata(nonce)\n@@ -2656,6 +2615,7 @@ async function renderToStream(\n \n   const setHeader = res.setHeader.bind(res)\n   const appendHeader = res.appendHeader.bind(res)\n+  const { clientModules } = getClientReferenceManifest()\n \n   try {\n     if (\n@@ -2739,7 +2699,6 @@ async function renderToStream(\n           staticStageEndTime,\n           runtimeStageEndTime,\n           ctx,\n-          clientReferenceManifest,\n           finalRequestStore,\n           devFallbackParams,\n           validationDebugChannelClient\n@@ -2759,7 +2718,6 @@ async function renderToStream(\n             ctx,\n             requestStore,\n             getPayload,\n-            clientReferenceManifest,\n             {\n               onError: serverComponentsErrorHandler,\n               filterStackFrame,\n@@ -2812,7 +2770,7 @@ async function renderToStream(\n           requestStore,\n           serverRenderToReadableStream,\n           RSCPayload,\n-          clientReferenceManifest.clientModules,\n+          clientModules,\n           {\n             filterStackFrame,\n             onError: serverComponentsErrorHandler,\n@@ -2860,7 +2818,6 @@ async function renderToStream(\n             reactDebugStream={reactDebugStream}\n             debugEndTime={undefined}\n             preinitScripts={preinitScripts}\n-            clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             nonce={nonce}\n             images={ctx.renderOpts.images}\n@@ -2907,7 +2864,6 @@ async function renderToStream(\n         reactDebugStream={reactDebugStream}\n         debugEndTime={undefined}\n         preinitScripts={preinitScripts}\n-        clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n         nonce={nonce}\n         images={ctx.renderOpts.images}\n@@ -3043,7 +2999,7 @@ async function renderToStream(\n       requestStore,\n       serverRenderToReadableStream,\n       errorRSCPayload,\n-      clientReferenceManifest.clientModules,\n+      clientModules,\n       {\n         filterStackFrame,\n         onError: serverComponentsErrorHandler,\n@@ -3068,7 +3024,6 @@ async function renderToStream(\n               reactServerStream={errorServerStream}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               preinitScripts={errorPreinitScripts}\n-              clientReferenceManifest={clientReferenceManifest}\n               nonce={nonce}\n               images={ctx.renderOpts.images}\n             />\n@@ -3154,13 +3109,8 @@ async function renderWithRestartOnCacheMissInDev(\n       },\n     },\n   } = ctx\n-  const {\n-    clientReferenceManifest,\n-    ComponentMod,\n-    setCacheStatus,\n-    setReactDebugChannel,\n-  } = renderOpts\n-  assertClientReferenceManifest(clientReferenceManifest)\n+\n+  const { ComponentMod, setCacheStatus, setReactDebugChannel } = renderOpts\n \n   const hasRuntimePrefetch =\n     await anySegmentHasRuntimePrefetchEnabled(loaderTree)\n@@ -3224,6 +3174,7 @@ async function renderWithRestartOnCacheMissInDev(\n   requestStore.cacheSignal = cacheSignal\n \n   let debugChannel = setReactDebugChannel && createDebugChannel()\n+  const { clientModules } = getClientReferenceManifest()\n \n   // Note: The stage controller starts out in the `Before` stage,\n   // where sync IO does not cause aborts, so it's okay if it happens before render.\n@@ -3239,7 +3190,7 @@ async function renderWithRestartOnCacheMissInDev(\n \n           const stream = ComponentMod.renderToReadableStream(\n             initialRscPayload,\n-            clientReferenceManifest.clientModules,\n+            clientModules,\n             {\n               onError,\n               environmentName,\n@@ -3392,7 +3343,7 @@ async function renderWithRestartOnCacheMissInDev(\n \n         const stream = ComponentMod.renderToReadableStream(\n           finalRscPayload,\n-          clientReferenceManifest.clientModules,\n+          clientModules,\n           {\n             onError,\n             environmentName,\n@@ -3602,13 +3553,7 @@ async function logMessagesAndSendErrorsToBrowser(\n   messages: unknown[],\n   ctx: AppRenderContext\n ): Promise<void> {\n-  const {\n-    clientReferenceManifest,\n-    componentMod: ComponentMod,\n-    htmlRequestId,\n-    renderOpts,\n-  } = ctx\n-\n+  const { componentMod: ComponentMod, htmlRequestId, renderOpts } = ctx\n   const { sendErrorsToBrowser } = renderOpts\n \n   const errors: Error[] = []\n@@ -3637,9 +3582,11 @@ async function logMessagesAndSendErrorsToBrowser(\n       )\n     }\n \n+    const { clientModules } = getClientReferenceManifest()\n+\n     const errorsRscStream = ComponentMod.renderToReadableStream(\n       errors,\n-      clientReferenceManifest.clientModules,\n+      clientModules,\n       { filterStackFrame }\n     )\n \n@@ -3660,7 +3607,6 @@ async function spawnStaticShellValidationInDev(\n   staticStageEndTime: number,\n   runtimeStageEndTime: number,\n   ctx: AppRenderContext,\n-  clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>,\n   requestStore: RequestStore,\n   fallbackRouteParams: OpaqueFallbackRouteParams | null,\n   debugChannelClient: Readable | undefined\n@@ -3708,8 +3654,7 @@ async function spawnStaticShellValidationInDev(\n     rootParams,\n     fallbackRouteParams,\n     allowEmptyStaticShell,\n-    ctx,\n-    clientReferenceManifest\n+    ctx\n   )\n \n   let debugChunks: Uint8Array[] | null = null\n@@ -3727,7 +3672,6 @@ async function spawnStaticShellValidationInDev(\n     fallbackRouteParams,\n     allowEmptyStaticShell,\n     ctx,\n-    clientReferenceManifest,\n     hmrRefreshHash,\n     trackDynamicHoleInRuntimeShell\n   )\n@@ -3747,7 +3691,6 @@ async function spawnStaticShellValidationInDev(\n     fallbackRouteParams,\n     allowEmptyStaticShell,\n     ctx,\n-    clientReferenceManifest,\n     hmrRefreshHash,\n     trackDynamicHoleInStaticShell\n   )\n@@ -3761,8 +3704,7 @@ async function warmupModuleCacheForRuntimeValidationInDev(\n   rootParams: Params,\n   fallbackRouteParams: OpaqueFallbackRouteParams | null,\n   allowEmptyStaticShell: boolean,\n-  ctx: AppRenderContext,\n-  clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n+  ctx: AppRenderContext\n ) {\n   const { implicitTags, nonce, workStore } = ctx\n \n@@ -3815,7 +3757,6 @@ async function warmupModuleCacheForRuntimeValidationInDev(\n       reactDebugStream={undefined}\n       debugEndTime={undefined}\n       preinitScripts={preinitScripts}\n-      clientReferenceManifest={clientReferenceManifest}\n       ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n       nonce={nonce}\n       images={ctx.renderOpts.images}\n@@ -3903,7 +3844,6 @@ async function validateStagedShell(\n   fallbackRouteParams: OpaqueFallbackRouteParams | null,\n   allowEmptyStaticShell: boolean,\n   ctx: AppRenderContext,\n-  clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>,\n   hmrRefreshHash: string | undefined,\n   trackDynamicHole:\n     | typeof trackDynamicHoleInStaticShell\n@@ -3974,7 +3914,6 @@ async function validateStagedShell(\n               reactDebugStream={debugChannelClient}\n               debugEndTime={debugEndTime}\n               preinitScripts={preinitScripts}\n-              clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               nonce={nonce}\n               images={ctx.renderOpts.images}\n@@ -4104,7 +4043,6 @@ async function prerenderToStream(\n     allowEmptyStaticShell = false,\n     basePath,\n     buildManifest,\n-    clientReferenceManifest,\n     ComponentMod,\n     crossOrigin,\n     dev = false,\n@@ -4118,8 +4056,6 @@ async function prerenderToStream(\n     cacheComponents,\n   } = renderOpts\n \n-  assertClientReferenceManifest(clientReferenceManifest)\n-\n   const rootParams = getRootParams(tree, getDynamicParamFromSegment)\n \n   const { ServerInsertedHTMLProvider, renderServerInsertedHTML } =\n@@ -4224,6 +4160,7 @@ async function prerenderToStream(\n   }\n \n   const selectStaleTime = createSelectStaleTime(experimental)\n+  const { clientModules } = getClientReferenceManifest()\n \n   let prerenderStore: PrerenderStore | null = null\n \n@@ -4352,7 +4289,7 @@ async function prerenderToStream(\n         initialServerPrerenderStore,\n         ComponentMod.prerender,\n         initialServerPayload,\n-        clientReferenceManifest.clientModules,\n+        clientModules,\n         {\n           filterStackFrame,\n           onError: (err) => {\n@@ -4479,7 +4416,6 @@ async function prerenderToStream(\n             reactDebugStream={undefined}\n             debugEndTime={undefined}\n             preinitScripts={preinitScripts}\n-            clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             nonce={nonce}\n             images={ctx.renderOpts.images}\n@@ -4631,7 +4567,7 @@ async function prerenderToStream(\n                 ComponentMod.prerender,\n                 // ... the arguments for the function to run\n                 finalAttemptRSCPayload,\n-                clientReferenceManifest.clientModules,\n+                clientModules,\n                 {\n                   filterStackFrame,\n                   onError: (err: unknown) => {\n@@ -4721,7 +4657,6 @@ async function prerenderToStream(\n                 reactDebugStream={undefined}\n                 debugEndTime={undefined}\n                 preinitScripts={preinitScripts}\n-                clientReferenceManifest={clientReferenceManifest}\n                 ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n                 nonce={nonce}\n                 images={ctx.renderOpts.images}\n@@ -4881,7 +4816,6 @@ async function prerenderToStream(\n               reactDebugStream={undefined}\n               debugEndTime={undefined}\n               preinitScripts={() => {}}\n-              clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               nonce={nonce}\n               images={ctx.renderOpts.images}\n@@ -4920,14 +4854,10 @@ async function prerenderToStream(\n           // segments, since those are the only ones whose data is not complete.\n           const emptyReactServerResult =\n             await createReactServerPrerenderResultFromRender(\n-              ComponentMod.renderToReadableStream(\n-                [],\n-                clientReferenceManifest.clientModules,\n-                {\n-                  filterStackFrame,\n-                  onError: serverComponentsErrorHandler,\n-                }\n-              )\n+              ComponentMod.renderToReadableStream([], clientModules, {\n+                filterStackFrame,\n+                onError: serverComponentsErrorHandler,\n+              })\n             )\n           finalStream = await continueStaticFallbackPrerender(htmlStream, {\n             inlinedDataStream: createInlinedDataReadableStream(\n@@ -5005,7 +4935,7 @@ async function prerenderToStream(\n             ComponentMod.renderToReadableStream,\n             // ... the arguments for the function to run\n             RSCPayload,\n-            clientReferenceManifest.clientModules,\n+            clientModules,\n             {\n               filterStackFrame,\n               onError: serverComponentsErrorHandler,\n@@ -5039,7 +4969,6 @@ async function prerenderToStream(\n             reactDebugStream={undefined}\n             debugEndTime={undefined}\n             preinitScripts={preinitScripts}\n-            clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             nonce={nonce}\n             images={ctx.renderOpts.images}\n@@ -5183,7 +5112,6 @@ async function prerenderToStream(\n               reactDebugStream={undefined}\n               debugEndTime={undefined}\n               preinitScripts={() => {}}\n-              clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               nonce={nonce}\n               images={ctx.renderOpts.images}\n@@ -5250,7 +5178,7 @@ async function prerenderToStream(\n             prerenderLegacyStore,\n             ComponentMod.renderToReadableStream,\n             RSCPayload,\n-            clientReferenceManifest.clientModules,\n+            clientModules,\n             {\n               filterStackFrame,\n               onError: serverComponentsErrorHandler,\n@@ -5270,7 +5198,6 @@ async function prerenderToStream(\n           reactDebugStream={undefined}\n           debugEndTime={undefined}\n           preinitScripts={preinitScripts}\n-          clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n           nonce={nonce}\n           images={ctx.renderOpts.images}\n@@ -5423,7 +5350,7 @@ async function prerenderToStream(\n       prerenderLegacyStore,\n       ComponentMod.renderToReadableStream,\n       errorRSCPayload,\n-      clientReferenceManifest.clientModules,\n+      clientModules,\n       {\n         filterStackFrame,\n         onError: serverComponentsErrorHandler,\n@@ -5446,7 +5373,6 @@ async function prerenderToStream(\n               reactServerStream={errorServerStream}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               preinitScripts={errorPreinitScripts}\n-              clientReferenceManifest={clientReferenceManifest}\n               nonce={nonce}\n               images={ctx.renderOpts.images}\n             />\n@@ -5613,10 +5539,8 @@ async function collectSegmentData(\n   // generating the initial page HTML. The Flight stream for the whole page is\n   // decomposed into a separate stream per segment.\n \n-  const clientReferenceManifest = renderOpts.clientReferenceManifest\n-  if (!clientReferenceManifest) {\n-    return\n-  }\n+  const { clientModules, edgeRscModuleMapping, rscModuleMapping } =\n+    getClientReferenceManifest()\n \n   // Manifest passed to the Flight client for reading the full-page Flight\n   // stream. Based off similar code in use-cache-wrapper.ts.\n@@ -5626,9 +5550,7 @@ async function collectSegmentData(\n     // to be added to the consumer. Instead, we'll wait for any ClientReference to be emitted\n     // which themselves will handle the preloading.\n     moduleLoading: null,\n-    moduleMap: isEdgeRuntime\n-      ? clientReferenceManifest.edgeRscModuleMapping\n-      : clientReferenceManifest.rscModuleMapping,\n+    moduleMap: isEdgeRuntime ? edgeRscModuleMapping : rscModuleMapping,\n     serverModuleMap: getServerModuleMap(),\n   }\n \n@@ -5638,7 +5560,7 @@ async function collectSegmentData(\n     renderOpts.cacheComponents,\n     fullPageDataBuffer,\n     staleTime,\n-    clientReferenceManifest.clientModules as ManifestNode,\n+    clientModules,\n     serverConsumerManifest\n   )\n }"
        },
        {
            "sha": "2b7e47eac3b98574ed1e7095b4e30755b13f860b",
            "filename": "packages/next/src/server/app-render/create-component-styles-and-scripts.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-styles-and-scripts.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-styles-and-scripts.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-styles-and-scripts.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -22,7 +22,6 @@ export async function createComponentStylesAndScripts({\n     componentMod: { createElement },\n   } = ctx\n   const { styles: entryCssFiles, scripts: jsHrefs } = getLinkAndScriptTags(\n-    ctx.clientReferenceManifest,\n     filePath,\n     injectedCSS,\n     injectedJS"
        },
        {
            "sha": "8b8329ee2f2b397616887fbe47312bc74dbe4d63",
            "filename": "packages/next/src/server/app-render/encryption-utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 154,
            "changes": 157,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption-utils.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -1,12 +1,5 @@\n-import type { ActionManifest } from '../../build/webpack/plugins/flight-client-entry-plugin'\n-import type {\n-  ClientReferenceManifest,\n-  ClientReferenceManifestForRsc,\n-} from '../../build/webpack/plugins/flight-manifest-plugin'\n-import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n import { InvariantError } from '../../shared/lib/invariant-error'\n-import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n-import { workAsyncStorage } from './work-async-storage.external'\n+import { getServerActionsManifest } from './manifests-singleton'\n \n let __next_loaded_action_key: CryptoKey\n \n@@ -71,127 +64,16 @@ export function decrypt(\n   )\n }\n \n-// This is a global singleton that is used to encode/decode the action bound args from\n-// the closure. This can't be using a AsyncLocalStorage as it might happen on the module\n-// level. Since the client reference manifest won't be mutated, let's use a global singleton\n-// to keep it.\n-const SERVER_ACTION_MANIFESTS_SINGLETON = Symbol.for(\n-  'next.server.action-manifests'\n-)\n-\n-export function setReferenceManifestsSingleton({\n-  page,\n-  clientReferenceManifest,\n-  serverActionsManifest,\n-  serverModuleMap,\n-}: {\n-  page: string\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>\n-  serverActionsManifest: DeepReadonly<ActionManifest>\n-  serverModuleMap: {\n-    [id: string]: {\n-      id: string\n-      chunks: string[]\n-      name: string\n-    }\n-  }\n-}) {\n-  // @ts-expect-error\n-  const clientReferenceManifestsPerPage = globalThis[\n-    SERVER_ACTION_MANIFESTS_SINGLETON\n-  ]?.clientReferenceManifestsPerPage as\n-    | undefined\n-    | DeepReadonly<Record<string, ClientReferenceManifest>>\n-\n-  // @ts-expect-error\n-  globalThis[SERVER_ACTION_MANIFESTS_SINGLETON] = {\n-    clientReferenceManifestsPerPage: {\n-      ...clientReferenceManifestsPerPage,\n-      [normalizeAppPath(page)]: clientReferenceManifest,\n-    },\n-    serverActionsManifest,\n-    serverModuleMap,\n-  }\n-}\n-\n-export function getServerModuleMap() {\n-  const serverActionsManifestSingleton = (globalThis as any)[\n-    SERVER_ACTION_MANIFESTS_SINGLETON\n-  ] as {\n-    serverModuleMap: {\n-      [id: string]: {\n-        id: string\n-        chunks: string[]\n-        name: string\n-      }\n-    }\n-  }\n-\n-  if (!serverActionsManifestSingleton) {\n-    throw new InvariantError('Missing manifest for Server Actions.')\n-  }\n-\n-  return serverActionsManifestSingleton.serverModuleMap\n-}\n-\n-export function getClientReferenceManifestForRsc(): DeepReadonly<ClientReferenceManifestForRsc> {\n-  const serverActionsManifestSingleton = (globalThis as any)[\n-    SERVER_ACTION_MANIFESTS_SINGLETON\n-  ] as {\n-    clientReferenceManifestsPerPage: DeepReadonly<\n-      Record<string, ClientReferenceManifest>\n-    >\n-  }\n-\n-  if (!serverActionsManifestSingleton) {\n-    throw new InvariantError('Missing manifest for Server Actions.')\n-  }\n-\n-  const { clientReferenceManifestsPerPage } = serverActionsManifestSingleton\n-  const workStore = workAsyncStorage.getStore()\n-\n-  if (!workStore) {\n-    // If there's no work store defined, we can assume that a client reference\n-    // manifest is needed during module evaluation, e.g. to create a server\n-    // action using a higher-order function. This might also use client\n-    // components which need to be serialized by Flight, and therefore client\n-    // references need to be resolvable. To make this work, we're returning a\n-    // merged manifest across all pages. This is fine as long as the module IDs\n-    // are not page specific, which they are not for Webpack. TODO: Fix this in\n-    // Turbopack.\n-    return mergeClientReferenceManifests(clientReferenceManifestsPerPage)\n-  }\n-\n-  const clientReferenceManifest =\n-    clientReferenceManifestsPerPage[workStore.route]\n-\n-  if (!clientReferenceManifest) {\n-    throw new InvariantError(\n-      `Missing Client Reference Manifest for ${workStore.route}.`\n-    )\n-  }\n-\n-  return clientReferenceManifest\n-}\n-\n export async function getActionEncryptionKey() {\n   if (__next_loaded_action_key) {\n     return __next_loaded_action_key\n   }\n \n-  const serverActionsManifestSingleton = (globalThis as any)[\n-    SERVER_ACTION_MANIFESTS_SINGLETON\n-  ] as {\n-    serverActionsManifest: DeepReadonly<ActionManifest>\n-  }\n-\n-  if (!serverActionsManifestSingleton) {\n-    throw new InvariantError('Missing manifest for Server Actions.')\n-  }\n+  const serverActionsManifest = getServerActionsManifest()\n \n   const rawKey =\n     process.env.NEXT_SERVER_ACTIONS_ENCRYPTION_KEY ||\n-    serverActionsManifestSingleton.serverActionsManifest.encryptionKey\n+    serverActionsManifest.encryptionKey\n \n   if (rawKey === undefined) {\n     throw new InvariantError('Missing encryption key for Server Actions')\n@@ -207,36 +89,3 @@ export async function getActionEncryptionKey() {\n \n   return __next_loaded_action_key\n }\n-\n-function mergeClientReferenceManifests(\n-  clientReferenceManifestsPerPage: DeepReadonly<\n-    Record<string, ClientReferenceManifest>\n-  >\n-): ClientReferenceManifestForRsc {\n-  const clientReferenceManifests = Object.values(\n-    clientReferenceManifestsPerPage as Record<string, ClientReferenceManifest>\n-  )\n-\n-  const mergedClientReferenceManifest: ClientReferenceManifestForRsc = {\n-    clientModules: {},\n-    edgeRscModuleMapping: {},\n-    rscModuleMapping: {},\n-  }\n-\n-  for (const clientReferenceManifest of clientReferenceManifests) {\n-    mergedClientReferenceManifest.clientModules = {\n-      ...mergedClientReferenceManifest.clientModules,\n-      ...clientReferenceManifest.clientModules,\n-    }\n-    mergedClientReferenceManifest.edgeRscModuleMapping = {\n-      ...mergedClientReferenceManifest.edgeRscModuleMapping,\n-      ...clientReferenceManifest.edgeRscModuleMapping,\n-    }\n-    mergedClientReferenceManifest.rscModuleMapping = {\n-      ...mergedClientReferenceManifest.rscModuleMapping,\n-      ...clientReferenceManifest.rscModuleMapping,\n-    }\n-  }\n-\n-  return mergedClientReferenceManifest\n-}"
        },
        {
            "sha": "86852170c8996a45f5a036e6cf3b62ce12a8dd97",
            "filename": "packages/next/src/server/app-render/encryption.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -12,10 +12,12 @@ import {\n   decrypt,\n   encrypt,\n   getActionEncryptionKey,\n-  getClientReferenceManifestForRsc,\n-  getServerModuleMap,\n   stringToUint8Array,\n } from './encryption-utils'\n+import {\n+  getClientReferenceManifest,\n+  getServerModuleMap,\n+} from './manifests-singleton'\n import {\n   getCacheSignal,\n   getPrerenderResumeDataCache,\n@@ -111,7 +113,7 @@ export const encryptActionBoundArgs = React.cache(\n       ? getCacheSignal(workUnitStore)\n       : undefined\n \n-    const { clientModules } = getClientReferenceManifestForRsc()\n+    const { clientModules } = getClientReferenceManifest()\n \n     // Create an error before any asynchronous calls, to capture the original\n     // call stack in case we need it when the serialization errors.\n@@ -250,7 +252,7 @@ export async function decryptActionBoundArgs(\n   }\n \n   const { edgeRscModuleMapping, rscModuleMapping } =\n-    getClientReferenceManifestForRsc()\n+    getClientReferenceManifest()\n \n   // Using Flight to deserialize the args from the string.\n   const deserialized = await createFromReadableStream("
        },
        {
            "sha": "91aada324f9c1a77a10a1fb729af98c98fcb948f",
            "filename": "packages/next/src/server/app-render/get-css-inlined-link-tags.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 15,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-css-inlined-link-tags.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-css-inlined-link-tags.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-css-inlined-link-tags.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -1,14 +1,10 @@\n-import type {\n-  ClientReferenceManifest,\n-  CssResource,\n-} from '../../build/webpack/plugins/flight-manifest-plugin'\n-import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n+import type { CssResource } from '../../build/webpack/plugins/flight-manifest-plugin'\n+import { getClientReferenceManifest } from './manifests-singleton'\n \n /**\n  * Get external stylesheet link hrefs based on server CSS manifest.\n  */\n export function getLinkAndScriptTags(\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>,\n   filePath: string,\n   injectedCSS: Set<string>,\n   injectedScripts: Set<string>,\n@@ -17,14 +13,12 @@ export function getLinkAndScriptTags(\n   const filePathWithoutExt = filePath.replace(/\\.[^.]+$/, '')\n   const cssChunks = new Set<CssResource>()\n   const jsChunks = new Set<string>()\n+  const { entryCSSFiles, entryJSFiles } = getClientReferenceManifest()\n+  const cssFiles = entryCSSFiles[filePathWithoutExt]\n+  const jsFiles = entryJSFiles?.[filePathWithoutExt]\n \n-  const entryCSSFiles =\n-    clientReferenceManifest.entryCSSFiles[filePathWithoutExt]\n-  const entryJSFiles =\n-    clientReferenceManifest.entryJSFiles?.[filePathWithoutExt] ?? []\n-\n-  if (entryCSSFiles) {\n-    for (const css of entryCSSFiles) {\n+  if (cssFiles) {\n+    for (const css of cssFiles) {\n       if (!injectedCSS.has(css.path)) {\n         if (collectNewImports) {\n           injectedCSS.add(css.path)\n@@ -34,8 +28,8 @@ export function getLinkAndScriptTags(\n     }\n   }\n \n-  if (entryJSFiles) {\n-    for (const file of entryJSFiles) {\n+  if (jsFiles) {\n+    for (const file of jsFiles) {\n       if (!injectedScripts.has(file)) {\n         if (collectNewImports) {\n           injectedScripts.add(file)"
        },
        {
            "sha": "8f133810a77159bf97502722aa9efbac1ff7bdad",
            "filename": "packages/next/src/server/app-render/get-layer-assets.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -26,7 +26,6 @@ export function getLayerAssets({\n   } = ctx\n   const { styles: styleTags, scripts: scriptTags } = layoutOrPagePath\n     ? getLinkAndScriptTags(\n-        ctx.clientReferenceManifest,\n         layoutOrPagePath,\n         injectedCSSWithCurrentLayout,\n         injectedJSWithCurrentLayout,"
        },
        {
            "sha": "7cf3fc467cd70ec6452c5818f933939abd9717c1",
            "filename": "packages/next/src/server/app-render/manifests-singleton.ts",
            "status": "added",
            "additions": 230,
            "deletions": 0,
            "changes": 230,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmanifests-singleton.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmanifests-singleton.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fmanifests-singleton.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -0,0 +1,230 @@\n+import type { ActionManifest } from '../../build/webpack/plugins/flight-client-entry-plugin'\n+import type { ClientReferenceManifest } from '../../build/webpack/plugins/flight-manifest-plugin'\n+import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n+import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n+import { createServerModuleMap, type ServerModuleMap } from './action-utils'\n+import { workAsyncStorage } from './work-async-storage.external'\n+\n+// This is a global singleton that is, among other things, also used to\n+// encode/decode bound args of server function closures. This can't be using a\n+// AsyncLocalStorage as it might happen at the module level.\n+const MANIFESTS_SINGLETON = Symbol.for('next.server.manifests')\n+\n+interface ManifestsSingleton {\n+  readonly clientReferenceManifestsPerRoute: Map<\n+    string,\n+    DeepReadonly<ClientReferenceManifest>\n+  >\n+  readonly proxiedClientReferenceManifest: DeepReadonly<ClientReferenceManifest>\n+  serverActionsManifest: DeepReadonly<ActionManifest>\n+  serverModuleMap: ServerModuleMap\n+}\n+\n+type GlobalThisWithManifests = typeof globalThis & {\n+  [MANIFESTS_SINGLETON]?: ManifestsSingleton\n+}\n+\n+type ClientReferenceManifestMappingProp =\n+  | 'clientModules'\n+  | 'rscModuleMapping'\n+  | 'edgeRscModuleMapping'\n+  | 'ssrModuleMapping'\n+  | 'edgeSSRModuleMapping'\n+\n+const globalThisWithManifests = globalThis as GlobalThisWithManifests\n+\n+function createProxiedClientReferenceManifest(\n+  clientReferenceManifestsPerRoute: Map<\n+    string,\n+    DeepReadonly<ClientReferenceManifest>\n+  >\n+): DeepReadonly<ClientReferenceManifest> {\n+  const createMappingProxy = (prop: ClientReferenceManifestMappingProp) => {\n+    return new Proxy(\n+      {},\n+      {\n+        get(_, id: string) {\n+          const workStore = workAsyncStorage.getStore()\n+\n+          if (workStore) {\n+            const currentManifest = clientReferenceManifestsPerRoute.get(\n+              workStore.route\n+            )\n+\n+            if (currentManifest?.[prop][id]) {\n+              return currentManifest[prop][id]\n+            }\n+\n+            // In development, we also check all other manifests to see if the\n+            // module exists there. This is to support a scenario where React's\n+            // I/O tracking (dev-only) creates a connection from one page to\n+            // another through an emitted async I/O node that references client\n+            // components from the other page, e.g. in owner props.\n+            // TODO: Maybe we need to add a `debugBundlerConfig` option to React\n+            // to avoid this workaround. The current workaround has the\n+            // disadvantage that one might accidentally or intentionally share\n+            // client references across pages (e.g. by storing them in a global\n+            // variable), which would then only be caught in production.\n+            if (process.env.NODE_ENV !== 'production') {\n+              for (const [\n+                route,\n+                manifest,\n+              ] of clientReferenceManifestsPerRoute) {\n+                if (route === workStore.route) {\n+                  continue\n+                }\n+\n+                const entry = manifest[prop][id]\n+\n+                if (entry !== undefined) {\n+                  return entry\n+                }\n+              }\n+            }\n+          } else {\n+            // If there's no work store defined, we can assume that a client\n+            // reference manifest is needed during module evaluation, e.g. to\n+            // create a server function using a higher-order function. This\n+            // might also use client components which need to be serialized by\n+            // Flight, and therefore client references need to be resolvable. In\n+            // that case we search all page manifests to find the module.\n+            for (const manifest of clientReferenceManifestsPerRoute.values()) {\n+              const entry = manifest[prop][id]\n+\n+              if (entry !== undefined) {\n+                return entry\n+              }\n+            }\n+          }\n+\n+          return undefined\n+        },\n+      }\n+    )\n+  }\n+\n+  const mappingProxies = new Map<\n+    ClientReferenceManifestMappingProp,\n+    ReturnType<typeof createMappingProxy>\n+  >()\n+\n+  return new Proxy(\n+    {},\n+    {\n+      get(_, prop) {\n+        const workStore = workAsyncStorage.getStore()\n+\n+        switch (prop) {\n+          case 'moduleLoading':\n+          case 'entryCSSFiles':\n+          case 'entryJSFiles': {\n+            if (!workStore) {\n+              throw new InvariantError(\n+                `Cannot access \"${prop}\" without a work store.`\n+              )\n+            }\n+\n+            const currentManifest = clientReferenceManifestsPerRoute.get(\n+              workStore.route\n+            )\n+\n+            if (!currentManifest) {\n+              throw new InvariantError(\n+                `The client reference manifest for route \"${workStore.route}\" does not exist.`\n+              )\n+            }\n+\n+            return currentManifest[prop]\n+          }\n+          case 'clientModules':\n+          case 'rscModuleMapping':\n+          case 'edgeRscModuleMapping':\n+          case 'ssrModuleMapping':\n+          case 'edgeSSRModuleMapping': {\n+            let proxy = mappingProxies.get(prop)\n+\n+            if (!proxy) {\n+              proxy = createMappingProxy(prop)\n+              mappingProxies.set(prop, proxy)\n+            }\n+\n+            return proxy\n+          }\n+          default: {\n+            throw new InvariantError(\n+              `This is a proxied client reference manifest. The property \"${String(prop)}\" is not handled.`\n+            )\n+          }\n+        }\n+      },\n+    }\n+  ) as DeepReadonly<ClientReferenceManifest>\n+}\n+\n+export function setManifestsSingleton({\n+  page,\n+  clientReferenceManifest,\n+  serverActionsManifest,\n+}: {\n+  page: string\n+  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>\n+  serverActionsManifest: DeepReadonly<ActionManifest>\n+}) {\n+  const existingSingleton = globalThisWithManifests[MANIFESTS_SINGLETON]\n+\n+  if (existingSingleton) {\n+    existingSingleton.clientReferenceManifestsPerRoute.set(\n+      normalizeAppPath(page),\n+      clientReferenceManifest\n+    )\n+\n+    existingSingleton.serverActionsManifest = serverActionsManifest\n+\n+    existingSingleton.serverModuleMap = createServerModuleMap({\n+      serverActionsManifest,\n+    })\n+  } else {\n+    const clientReferenceManifestsPerRoute = new Map<\n+      string,\n+      DeepReadonly<ClientReferenceManifest>\n+    >([[normalizeAppPath(page), clientReferenceManifest]])\n+\n+    const proxiedClientReferenceManifest = createProxiedClientReferenceManifest(\n+      clientReferenceManifestsPerRoute\n+    )\n+\n+    const serverModuleMap = createServerModuleMap({\n+      serverActionsManifest,\n+    })\n+\n+    globalThisWithManifests[MANIFESTS_SINGLETON] = {\n+      clientReferenceManifestsPerRoute,\n+      proxiedClientReferenceManifest,\n+      serverActionsManifest,\n+      serverModuleMap,\n+    }\n+  }\n+}\n+\n+function getManifestsSingleton(): ManifestsSingleton {\n+  const manifestSingleton = globalThisWithManifests[MANIFESTS_SINGLETON]\n+\n+  if (!manifestSingleton) {\n+    throw new InvariantError('The manifests singleton was not initialized.')\n+  }\n+\n+  return manifestSingleton\n+}\n+\n+export function getClientReferenceManifest(): DeepReadonly<ClientReferenceManifest> {\n+  return getManifestsSingleton().proxiedClientReferenceManifest\n+}\n+\n+export function getServerActionsManifest(): DeepReadonly<ActionManifest> {\n+  return getManifestsSingleton().serverActionsManifest\n+}\n+\n+export function getServerModuleMap() {\n+  return getManifestsSingleton().serverModuleMap\n+}"
        },
        {
            "sha": "d98b94b864f75c3d83ddf413ef79264cb1450bac",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -4,7 +4,6 @@ import type {\n   ExperimentalConfig,\n   NextConfigComplete,\n } from '../../server/config-shared'\n-import type { ClientReferenceManifest } from '../../build/webpack/plugins/flight-manifest-plugin'\n import type { NextFontManifest } from '../../build/webpack/plugins/next-font-manifest-plugin'\n import type { ParsedUrlQuery } from 'querystring'\n import type { AppPageModule } from '../route-modules/app-page/module'\n@@ -94,7 +93,6 @@ export interface RenderOptsPartial {\n   cacheComponents: boolean\n   trailingSlash: boolean\n   images: ImageConfigComplete\n-  clientReferenceManifest?: DeepReadonly<ClientReferenceManifest>\n   supportsDynamicResponse: boolean\n   runtime?: ServerRuntime\n   serverComponents?: boolean"
        },
        {
            "sha": "4de9babcde0fd30670c0f53330a9636a77e37074",
            "filename": "packages/next/src/server/app-render/use-flight-response.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 11,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -1,11 +1,10 @@\n-import type { ClientReferenceManifest } from '../../build/webpack/plugins/flight-manifest-plugin'\n import type { BinaryStreamOf } from './app-render'\n import type { Readable } from 'node:stream'\n \n import { htmlEscapeJsonString } from '../htmlescape'\n-import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n import { workUnitAsyncStorage } from './work-unit-async-storage.external'\n import { InvariantError } from '../../shared/lib/invariant-error'\n+import { getClientReferenceManifest } from './manifests-singleton'\n \n const isEdgeRuntime = process.env.NEXT_RUNTIME === 'edge'\n \n@@ -34,7 +33,6 @@ export function getFlightStream<T>(\n   flightStream: Readable | BinaryStreamOf<T>,\n   debugStream: Readable | ReadableStream<Uint8Array> | undefined,\n   debugEndTime: number | undefined,\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>,\n   nonce: string | undefined\n ): Promise<T> {\n   const response = flightResponses.get(flightStream)\n@@ -43,6 +41,9 @@ export function getFlightStream<T>(\n     return response\n   }\n \n+  const { moduleLoading, edgeSSRModuleMapping, ssrModuleMapping } =\n+    getClientReferenceManifest()\n+\n   let newResponse: Promise<T>\n   if (flightStream instanceof ReadableStream) {\n     // The types of flightStream and debugStream should match.\n@@ -58,10 +59,8 @@ export function getFlightStream<T>(\n     newResponse = createFromReadableStream<T>(flightStream, {\n       findSourceMapURL,\n       serverConsumerManifest: {\n-        moduleLoading: clientReferenceManifest.moduleLoading,\n-        moduleMap: isEdgeRuntime\n-          ? clientReferenceManifest.edgeSSRModuleMapping\n-          : clientReferenceManifest.ssrModuleMapping,\n+        moduleLoading,\n+        moduleMap: isEdgeRuntime ? edgeSSRModuleMapping : ssrModuleMapping,\n         serverModuleMap: null,\n       },\n       nonce,\n@@ -90,10 +89,8 @@ export function getFlightStream<T>(\n       newResponse = createFromNodeStream<T>(\n         flightStream,\n         {\n-          moduleLoading: clientReferenceManifest.moduleLoading,\n-          moduleMap: isEdgeRuntime\n-            ? clientReferenceManifest.edgeSSRModuleMapping\n-            : clientReferenceManifest.ssrModuleMapping,\n+          moduleLoading,\n+          moduleMap: isEdgeRuntime ? edgeSSRModuleMapping : ssrModuleMapping,\n           serverModuleMap: null,\n         },\n         {"
        },
        {
            "sha": "0c9e6b791961a421284608356ac6278d10ccc1f2",
            "filename": "packages/next/src/server/app-render/walk-tree-with-flight-router-state.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -252,7 +252,6 @@ export async function walkTreeWithFlightRouterState({\n   )\n   if (layoutPath) {\n     getLinkAndScriptTags(\n-      ctx.clientReferenceManifest,\n       layoutPath,\n       injectedCSSWithCurrentLayout,\n       injectedJSWithCurrentLayout,"
        },
        {
            "sha": "ebf6f0adbbacbc815e85fb15c0e3d1f24061e160",
            "filename": "packages/next/src/server/load-components.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -29,8 +29,7 @@ import { getTracer } from './lib/trace/tracer'\n import { LoadComponentsSpan } from './lib/trace/constants'\n import { evalManifest, loadManifest } from './load-manifest.external'\n import { wait } from '../lib/wait'\n-import { setReferenceManifestsSingleton } from './app-render/encryption-utils'\n-import { createServerModuleMap } from './app-render/action-utils'\n+import { setManifestsSingleton } from './app-render/manifests-singleton'\n import type { DeepReadonly } from '../shared/lib/deep-readonly'\n import { normalizePagePath } from '../shared/lib/page-path/normalize-page-path'\n import { isStaticMetadataRoute } from '../lib/metadata/is-metadata-route'\n@@ -66,8 +65,6 @@ export type LoadComponentsReturnType<NextModule = any> = {\n   subresourceIntegrityManifest?: DeepReadonly<Record<string, string>>\n   reactLoadableManifest: DeepReadonly<ReactLoadableManifest>\n   dynamicCssManifest?: DeepReadonly<DynamicCssManifest>\n-  clientReferenceManifest?: DeepReadonly<ClientReferenceManifest>\n-  serverActionsManifest?: any\n   Document: DocumentType\n   App: AppType\n   getStaticProps?: GetStaticProps\n@@ -279,13 +276,10 @@ async function loadComponentsImpl<N = any>({\n     // manifests to our global store so Server Action's encryption util can access\n     // to them at the top level of the page module.\n     if (serverActionsManifest && clientReferenceManifest) {\n-      setReferenceManifestsSingleton({\n+      setManifestsSingleton({\n         page,\n         clientReferenceManifest,\n         serverActionsManifest,\n-        serverModuleMap: createServerModuleMap({\n-          serverActionsManifest,\n-        }),\n       })\n     }\n \n@@ -311,8 +305,6 @@ async function loadComponentsImpl<N = any>({\n       getServerSideProps,\n       getStaticProps,\n       getStaticPaths,\n-      clientReferenceManifest,\n-      serverActionsManifest,\n       isAppPath,\n       page,\n       routeModule,"
        },
        {
            "sha": "511d75500966f3c4998ce01dc9c02dcfd7b25281",
            "filename": "packages/next/src/server/load-default-error-components.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fload-default-error-components.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fload-default-error-components.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fload-default-error-components.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -3,7 +3,6 @@ import type {\n   DocumentType,\n   NextComponentType,\n } from '../shared/lib/utils'\n-import type { ClientReferenceManifest } from '../build/webpack/plugins/flight-manifest-plugin'\n import type {\n   PageConfig,\n   GetStaticPaths,\n@@ -32,8 +31,6 @@ export type LoadComponentsReturnType = {\n   buildManifest: BuildManifest\n   subresourceIntegrityManifest?: Record<string, string>\n   reactLoadableManifest: ReactLoadableManifest\n-  clientReferenceManifest?: ClientReferenceManifest\n-  serverActionsManifest?: any\n   Document: DocumentType\n   App: AppType\n   getStaticProps?: GetStaticProps"
        },
        {
            "sha": "3d1d3e5f985e81eb2d429cd815b9c3ff1000e3a2",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -42,12 +42,12 @@ import {\n   makeHangingPromise,\n } from '../dynamic-rendering-utils'\n \n-import type { ClientReferenceManifestForRsc } from '../../build/webpack/plugins/flight-manifest-plugin'\n+import type { ClientReferenceManifest } from '../../build/webpack/plugins/flight-manifest-plugin'\n \n import {\n-  getClientReferenceManifestForRsc,\n+  getClientReferenceManifest,\n   getServerModuleMap,\n-} from '../app-render/encryption-utils'\n+} from '../app-render/manifests-singleton'\n import type { CacheEntry } from '../lib/cache-handlers/types'\n import type { CacheSignal } from '../app-render/cache-signal'\n import { decryptActionBoundArgs } from '../app-render/encryption'\n@@ -134,7 +134,7 @@ const findSourceMapURL =\n function generateCacheEntry(\n   workStore: WorkStore,\n   cacheContext: CacheContext,\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n+  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>,\n   encodedArguments: FormData | string,\n   fn: (...args: unknown[]) => Promise<unknown>,\n   timeoutError: UseCacheTimeoutError\n@@ -158,7 +158,7 @@ function generateCacheEntry(\n function generateCacheEntryWithRestoredWorkStore(\n   workStore: WorkStore,\n   cacheContext: CacheContext,\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n+  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>,\n   encodedArguments: FormData | string,\n   fn: (...args: unknown[]) => Promise<unknown>,\n   timeoutError: UseCacheTimeoutError\n@@ -281,7 +281,7 @@ function assertDefaultCacheLife(\n function generateCacheEntryWithCacheContext(\n   workStore: WorkStore,\n   cacheContext: CacheContext,\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n+  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>,\n   encodedArguments: FormData | string,\n   fn: (...args: unknown[]) => Promise<unknown>,\n   timeoutError: UseCacheTimeoutError\n@@ -521,7 +521,7 @@ async function generateCacheEntryImpl(\n   workStore: WorkStore,\n   cacheContext: CacheContext,\n   innerCacheStore: UseCacheStore,\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n+  clientReferenceManifest: DeepReadonly<ClientReferenceManifest>,\n   encodedArguments: FormData | string,\n   fn: (...args: unknown[]) => Promise<unknown>,\n   timeoutError: UseCacheTimeoutError\n@@ -978,7 +978,7 @@ export async function cache(\n \n   // Get the clientReferenceManifest while we're still in the outer Context.\n   // In case getClientReferenceManifestSingleton is implemented using AsyncLocalStorage.\n-  const clientReferenceManifest = getClientReferenceManifestForRsc()\n+  const clientReferenceManifest = getClientReferenceManifest()\n \n   // Because the Action ID is not yet unique per implementation of that Action we can't\n   // safely reuse the results across builds yet. In the meantime we add the buildId to the"
        },
        {
            "sha": "a75c8560c11543c892c953b1ebf35845924680ba",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -226,9 +226,9 @@ declare module 'react-server-dom-webpack/server.node' {\n   export type TemporaryReferenceSet = WeakMap<any, string>\n \n   export type ImportManifestEntry = {\n-    id: string\n+    id: string | number\n     // chunks is a double indexed array of chunkId / chunkFilename pairs\n-    chunks: Array<string>\n+    chunks: ReadonlyArray<string>\n     name: string\n     async?: boolean\n   }\n@@ -279,7 +279,7 @@ declare module 'react-server-dom-webpack/static' {\n     webpackMap: {\n       readonly [id: string]: {\n         readonly id: string | number\n-        readonly chunks: readonly string[]\n+        readonly chunks: ReadonlyArray<string>\n         readonly name: string\n         readonly async?: boolean\n       }"
        },
        {
            "sha": "58aba64f8c42f02e06b3ce8d121bfdde7cd4b53d",
            "filename": "packages/react-refresh-utils/ReactRefreshWebpackPlugin.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Freact-refresh-utils%2FReactRefreshWebpackPlugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/packages%2Freact-refresh-utils%2FReactRefreshWebpackPlugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Freact-refresh-utils%2FReactRefreshWebpackPlugin.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -105,6 +105,13 @@ function webpack5(this: ReactFreshWebpackPlugin, compiler: WebpackCompiler) {\n           `options.factory = ${runtimeTemplate.basicFunction(\n             'moduleObject, moduleExports, webpackRequire',\n             [\n+              // If the original factory is missing, e.g. due to race condition\n+              // when compiling multiple entries concurrently, recover by doing\n+              // a full page reload.\n+              'if (!originalFactory) {',\n+              Template.indent('document.location.reload();'),\n+              Template.indent('return;'),\n+              '}',\n               // Legacy CSS implementations will `eval` browser code in a Node.js\n               // context to extract CSS. For backwards compatibility, we need to check\n               // we're in a browser context before continuing."
        },
        {
            "sha": "b78620f344b2f16c26d19cac5cb306ffb94e93be",
            "filename": "test/development/app-dir/hmr-iframe/app/layout.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Flayout.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -0,0 +1,5 @@\n+import { Suspense } from 'react'\n+\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return <Suspense>{children}</Suspense>\n+}"
        },
        {
            "sha": "04755dd3be09f3e952823ed3af48456b3d2b426b",
            "filename": "test/development/app-dir/hmr-iframe/app/page1/Component.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2FComponent.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2FComponent.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2FComponent.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export function Component() {\n+  return <p>Component</p>\n+}"
        },
        {
            "sha": "f5ade055497dcabe943c0b7b669f4d0bc18df342",
            "filename": "test/development/app-dir/hmr-iframe/app/page1/page.tsx",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2Fpage.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -0,0 +1,22 @@\n+import { subscribeToHMR } from './subscribeToHMR'\n+import { Component } from './Component'\n+\n+// The (unused) client component prop is crucial to reproduce the issue. It will\n+// be serialized as a client reference in the props of this component, which\n+// acts as the owner of the I/O inside subscribeToHMR, which is also serialized\n+// as part of the async I/O sequence in page 2.\n+const RootPage = async ({ Component }: { Component: React.ComponentType }) => {\n+  await subscribeToHMR()\n+\n+  return (\n+    <html>\n+      <body>\n+        <iframe src=\"/page2\" />\n+      </body>\n+    </html>\n+  )\n+}\n+\n+export default function Page1() {\n+  return <RootPage Component={Component} />\n+}"
        },
        {
            "sha": "844ae5415db7e692ca39a79296094a68537aa697",
            "filename": "test/development/app-dir/hmr-iframe/app/page1/subscribeToHMR.ts",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2FsubscribeToHMR.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2FsubscribeToHMR.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage1%2FsubscribeToHMR.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -0,0 +1,47 @@\n+declare global {\n+  var _testState: {\n+    initialized: boolean\n+    reload: boolean | Promise<void>\n+  }\n+}\n+\n+if (!globalThis._testState) {\n+  globalThis._testState = {\n+    initialized: false,\n+    reload: false,\n+  }\n+}\n+\n+export const subscribeToHMR = async () => {\n+  const state = globalThis._testState\n+\n+  if (state.initialized) {\n+    if (state.reload === true) {\n+      let resolve: () => void\n+      state.reload = new Promise<void>((res) => (resolve = res))\n+      await new Promise((resolve) => setTimeout(resolve, 200))\n+      resolve()\n+    }\n+\n+    if (state.reload instanceof Promise) {\n+      await state.reload\n+    }\n+\n+    return\n+  }\n+\n+  state.initialized = true\n+\n+  const ws = new WebSocket(\n+    `ws://localhost:${process.env.PORT}/_next/webpack-hmr`\n+  )\n+\n+  ws.onmessage = (event: any) => {\n+    if (typeof event.data === 'string') {\n+      const data = JSON.parse(event.data)\n+      if (data.type === 'serverComponentChanges') {\n+        state.reload = true\n+      }\n+    }\n+  }\n+}"
        },
        {
            "sha": "de16b7a9973504c0cf58aa11d9abbe33a285f98a",
            "filename": "test/development/app-dir/hmr-iframe/app/page2/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage2%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage2%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fapp%2Fpage2%2Fpage.tsx?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -0,0 +1,13 @@\n+import { subscribeToHMR } from '../page1/subscribeToHMR'\n+\n+export default async function Page2() {\n+  await subscribeToHMR()\n+\n+  return (\n+    <html>\n+      <body>\n+        <p>content</p>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "6f320fe82b2f17036c0678e3da681636fe0c6668",
            "filename": "test/development/app-dir/hmr-iframe/hmr-iframe.test.ts",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fhmr-iframe.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8303bbd4600b08fd56cf14209423cfc0404646bf/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fhmr-iframe.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-iframe%2Fhmr-iframe.test.ts?ref=8303bbd4600b08fd56cf14209423cfc0404646bf",
            "patch": "@@ -0,0 +1,38 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { waitForNoRedbox } from 'next-test-utils'\n+\n+describe('hmr-iframe', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should do HMR when rendering two server component changes at the same time', async () => {\n+    let browser = await next.browser('/page1')\n+\n+    expect(\n+      await (await (await browser.elementByCss('iframe')).contentFrame())\n+        .locator('p')\n+        .innerText()\n+    ).toEqual('content')\n+\n+    let cliOutputLength = next.cliOutput.length\n+\n+    await next.patchFile('app/page2/page.tsx', (content) =>\n+      content.replace('content', 'content-new')\n+    )\n+\n+    await waitForNoRedbox(browser)\n+    expect(\n+      await (await (await browser.elementByCss('iframe')).contentFrame())\n+        .locator('p')\n+        .innerText()\n+    ).toEqual('content-new')\n+\n+    const cliOutput = next.cliOutput.slice(cliOutputLength)\n+    expect(cliOutput).not.toContain('Error')\n+    expect(cliOutput).not.toContain('Could not find the module')\n+\n+    await next.stop()\n+    await next.clean()\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 897,
        "additions": 495,
        "deletions": 402
    }
}