{
    "author": "blurrah",
    "message": "Remove tracestate header from fetch cache key (#76041)",
    "sha": "a79950dc8c3b543fbc40a8e9e90d840b59e435cd",
    "files": [
        {
            "sha": "fab59b0a10469dcba05f3d3581bb2bb71b021343",
            "filename": "packages/next/src/server/lib/incremental-cache/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a79950dc8c3b543fbc40a8e9e90d840b59e435cd/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a79950dc8c3b543fbc40a8e9e90d840b59e435cd/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Findex.ts?ref=a79950dc8c3b543fbc40a8e9e90d840b59e435cd",
            "patch": "@@ -354,7 +354,10 @@ export class IncrementalCache implements IncrementalCacheType {\n         ? Object.fromEntries(init.headers as Headers)\n         : Object.assign({}, init.headers)\n \n+    // w3c trace context headers can break request caching and deduplication\n+    // so we remove them from the cache key\n     if ('traceparent' in headers) delete headers['traceparent']\n+    if ('tracestate' in headers) delete headers['tracestate']\n \n     const cacheString = JSON.stringify([\n       MAIN_KEY_PREFIX,"
        },
        {
            "sha": "2e106deb8a4b79ad28111244986a7661fa32172f",
            "filename": "test/e2e/app-dir/app-static/app-static.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 14,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/a79950dc8c3b543fbc40a8e9e90d840b59e435cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a79950dc8c3b543fbc40a8e9e90d840b59e435cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts?ref=a79950dc8c3b543fbc40a8e9e90d840b59e435cd",
            "patch": "@@ -105,20 +105,25 @@ describe('app-dir static/dynamic handling', () => {\n     expect(initialRouteData).not.toEqual(newRouteData)\n   })\n \n-  it('should still cache even though the `traceparent` header was different', async () => {\n-    const res = await next.fetch('/strip-header-traceparent')\n+  it('should still cache even though the W3C trace context headers `traceparent` and `tracestate` were different', async () => {\n+    const res = await next.fetch('/strip-w3c-trace-context-headers')\n     expect(res.status).toBe(200)\n \n     const html = await res.text()\n     const $ = cheerio.load(html)\n \n-    const data1 = $('#data1').text()\n-    const data2 = $('#data2').text()\n-    expect(data1).toBeTruthy()\n-    expect(data1).toBe(data2)\n+    const traceparent1 = $('#traceparent1').text()\n+    const traceparent2 = $('#traceparent2').text()\n+    const tracestate1 = $('#tracestate1').text()\n+    const tracestate2 = $('#tracestate2').text()\n+    expect(traceparent1).toBeTruthy()\n+    expect(traceparent1).toBe(traceparent2)\n+    expect(tracestate1).toBeTruthy()\n+    expect(tracestate1).toBe(tracestate2)\n \n     const echoedHeaders = JSON.parse($('#echoedHeaders').text())\n-    expect(echoedHeaders.headers.traceparent).toEqual('C')\n+    expect(echoedHeaders.headers.traceparent).toEqual('A')\n+    expect(echoedHeaders.headers.tracestate).toEqual('A')\n   })\n \n   // Runtime logs aren't queryable in deploy mode\n@@ -1030,10 +1035,10 @@ describe('app-dir static/dynamic handling', () => {\n          \"static-to-dynamic-error-forced/[id]/page_client-reference-manifest.js\",\n          \"static-to-dynamic-error/[id]/page.js\",\n          \"static-to-dynamic-error/[id]/page_client-reference-manifest.js\",\n-         \"strip-header-traceparent.html\",\n-         \"strip-header-traceparent.rsc\",\n-         \"strip-header-traceparent/page.js\",\n-         \"strip-header-traceparent/page_client-reference-manifest.js\",\n+         \"strip-w3c-trace-context-headers.html\",\n+         \"strip-w3c-trace-context-headers.rsc\",\n+         \"strip-w3c-trace-context-headers/page.js\",\n+         \"strip-w3c-trace-context-headers/page_client-reference-manifest.js\",\n          \"too-many-cache-tags/page.js\",\n          \"too-many-cache-tags/page_client-reference-manifest.js\",\n          \"unstable-cache/dynamic-undefined/page.js\",\n@@ -2192,7 +2197,7 @@ describe('app-dir static/dynamic handling', () => {\n            \"initialRevalidateSeconds\": false,\n            \"srcRoute\": \"/ssg-draft-mode/[[...route]]\",\n          },\n-         \"/strip-header-traceparent\": {\n+         \"/strip-w3c-trace-context-headers\": {\n            \"allowHeader\": [\n              \"host\",\n              \"x-matched-path\",\n@@ -2201,7 +2206,7 @@ describe('app-dir static/dynamic handling', () => {\n              \"x-next-revalidated-tags\",\n              \"x-next-revalidate-tag-token\",\n            ],\n-           \"dataRoute\": \"/strip-header-traceparent.rsc\",\n+           \"dataRoute\": \"/strip-w3c-trace-context-headers.rsc\",\n            \"experimentalBypassFor\": [\n              {\n                \"key\": \"Next-Action\",\n@@ -2214,7 +2219,7 @@ describe('app-dir static/dynamic handling', () => {\n              },\n            ],\n            \"initialRevalidateSeconds\": 50,\n-           \"srcRoute\": \"/strip-header-traceparent\",\n+           \"srcRoute\": \"/strip-w3c-trace-context-headers\",\n          },\n          \"/unstable-cache/fetch/no-cache\": {\n            \"allowHeader\": ["
        },
        {
            "sha": "7c67f7b08c67bee0b388dc2b1ec47a4704b59e0b",
            "filename": "test/e2e/app-dir/app-static/app/strip-header-traceparent/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 33,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstrip-header-traceparent%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstrip-header-traceparent%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstrip-header-traceparent%2Fpage.tsx?ref=a8d36ddb21a59840f1d32e29c7b84c2c09ffea7e",
            "patch": "@@ -1,33 +0,0 @@\n-export default async function Page() {\n-  const data1 = await fetch(\n-    'https://next-data-api-endpoint.vercel.app/api/random',\n-    {\n-      headers: { traceparent: 'A' },\n-      next: { revalidate: 50 },\n-    }\n-  ).then((res) => res.text())\n-\n-  const data2 = await fetch(\n-    'https://next-data-api-endpoint.vercel.app/api/random',\n-    {\n-      headers: { traceparent: 'B' },\n-      next: { revalidate: 50 },\n-    }\n-  ).then((res) => res.text())\n-\n-  const echoedHeaders = await fetch(\n-    'https://next-data-api-endpoint.vercel.app/api/echo-headers',\n-    {\n-      headers: { traceparent: 'C' },\n-      next: { revalidate: 50 },\n-    }\n-  ).then((res) => res.text())\n-\n-  return (\n-    <>\n-      <p id=\"data1\">{data1}</p>\n-      <p id=\"data2\">{data2}</p>\n-      <p id=\"echoedHeaders\">{echoedHeaders}</p>\n-    </>\n-  )\n-}"
        },
        {
            "sha": "6b5e777a5df91e9bf37494135ef640695af71360",
            "filename": "test/e2e/app-dir/app-static/app/strip-w3c-trace-context-headers/page.tsx",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/a79950dc8c3b543fbc40a8e9e90d840b59e435cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstrip-w3c-trace-context-headers%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a79950dc8c3b543fbc40a8e9e90d840b59e435cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstrip-w3c-trace-context-headers%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstrip-w3c-trace-context-headers%2Fpage.tsx?ref=a79950dc8c3b543fbc40a8e9e90d840b59e435cd",
            "patch": "@@ -0,0 +1,51 @@\n+export default async function Page() {\n+  const traceparent1 = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random',\n+    {\n+      headers: { traceparent: 'A' },\n+      next: { revalidate: 50 },\n+    }\n+  ).then((res) => res.text())\n+\n+  const traceparent2 = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random',\n+    {\n+      headers: { traceparent: 'B' },\n+      next: { revalidate: 50 },\n+    }\n+  ).then((res) => res.text())\n+\n+  const tracestate1 = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random',\n+    {\n+      headers: { tracestate: 'B' },\n+      next: { revalidate: 50 },\n+    }\n+  ).then((res) => res.text())\n+\n+  const tracestate2 = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random',\n+    {\n+      headers: { tracestate: 'B' },\n+      next: { revalidate: 50 },\n+    }\n+  ).then((res) => res.text())\n+\n+  const echoedHeaders = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/echo-headers',\n+    {\n+      headers: { traceparent: 'A', tracestate: 'A' },\n+      next: { revalidate: 50 },\n+    }\n+  ).then((res) => res.text())\n+\n+  return (\n+    <>\n+      <p id=\"traceparent1\">{traceparent1}</p>\n+      <p id=\"traceparent2\">{traceparent2}</p>\n+      <p id=\"tracestate1\">{tracestate1}</p>\n+      <p id=\"tracestate2\">{tracestate2}</p>\n+      <p id=\"echoedHeaders\">{echoedHeaders}</p>\n+    </>\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 73,
        "deletions": 47
    }
}