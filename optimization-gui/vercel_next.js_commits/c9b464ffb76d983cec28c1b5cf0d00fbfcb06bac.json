{
    "author": "ztanner",
    "message": "[cache components] show when cache components is enabled in the CLI (#85047)\n\nSince it won't show in the experimental list anymore, this shows if\nCache Components is enabled in the CLI (for build).",
    "sha": "c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac",
    "files": [
        {
            "sha": "a371952ada63187c6bc20e803697014a5d4670fd",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac",
            "patch": "@@ -1115,18 +1115,20 @@ export default async function build(\n       )\n \n       // Always log next version first then start rest jobs\n-      const { envInfo, experimentalFeatures } = await getStartServerInfo({\n-        dir,\n-        dev: false,\n-        debugPrerender,\n-      })\n+      const { envInfo, experimentalFeatures, cacheComponents } =\n+        await getStartServerInfo({\n+          dir,\n+          dev: false,\n+          debugPrerender,\n+        })\n \n       logStartInfo({\n         networkUrl: null,\n         appUrl: null,\n         envInfo,\n         experimentalFeatures,\n         logBundler: true,\n+        cacheComponents,\n       })\n \n       const typeCheckingOptions: Parameters<typeof startTypeChecking>[0] = {"
        },
        {
            "sha": "5a5d36755b416d30e42eb804aa5eb34d85ff6ba0",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac",
            "patch": "@@ -1791,15 +1791,6 @@ function enforceExperimentalFeatures(\n       (isDefaultConfig && !config.cacheComponents))\n   ) {\n     config.cacheComponents = true\n-\n-    if (configuredExperimentalFeatures) {\n-      addConfiguredExperimentalFeature(\n-        configuredExperimentalFeatures,\n-        'cacheComponents',\n-        true,\n-        'enabled by `__NEXT_CACHE_COMPONENTS`'\n-      )\n-    }\n   }\n \n   // TODO: Remove this once using the debug channel is the default."
        },
        {
            "sha": "41cb8f6866d4a19e4bfcca0816bc26edba122138",
            "filename": "packages/next/src/server/lib/app-info-log.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 6,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts?ref=c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac",
            "patch": "@@ -14,28 +14,40 @@ export function logStartInfo({\n   envInfo,\n   experimentalFeatures,\n   logBundler,\n+  cacheComponents,\n }: {\n   networkUrl: string | null\n   appUrl: string | null\n   envInfo?: string[]\n   experimentalFeatures?: ConfiguredExperimentalFeature[]\n   logBundler: boolean\n+  cacheComponents?: boolean\n }) {\n-  let bundlerSuffix = ''\n+  let versionSuffix = ''\n+  const parts = []\n+\n   if (logBundler) {\n     if (process.env.TURBOPACK) {\n-      bundlerSuffix = ' (Turbopack)'\n+      parts.push('Turbopack')\n     } else if (process.env.NEXT_RSPACK) {\n-      bundlerSuffix = ' (Rspack)'\n+      parts.push('Rspack')\n     } else {\n-      bundlerSuffix = ' (webpack)'\n+      parts.push('webpack')\n     }\n   }\n \n+  if (cacheComponents) {\n+    parts.push('Cache Components')\n+  }\n+\n+  if (parts.length > 0) {\n+    versionSuffix = ` (${parts.join(', ')})`\n+  }\n+\n   Log.bootstrap(\n     `${bold(\n       purple(`${Log.prefixes.ready} Next.js ${process.env.__NEXT_VERSION}`)\n-    )}${bundlerSuffix}`\n+    )}${versionSuffix}`\n   )\n   if (appUrl) {\n     Log.bootstrap(`- Local:        ${appUrl}`)\n@@ -91,9 +103,11 @@ export async function getStartServerInfo({\n }): Promise<{\n   envInfo?: string[]\n   experimentalFeatures?: ConfiguredExperimentalFeature[]\n+  cacheComponents?: boolean\n }> {\n   let experimentalFeatures: ConfiguredExperimentalFeature[] = []\n-  await loadConfig(\n+  let cacheComponents = false\n+  const config = await loadConfig(\n     dev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_BUILD,\n     dir,\n     {\n@@ -107,6 +121,8 @@ export async function getStartServerInfo({\n     }\n   )\n \n+  cacheComponents = !!config.cacheComponents\n+\n   // we need to reset env if we are going to create\n   // the worker process with the esm loader so that the\n   // initial env state is correct\n@@ -119,5 +135,6 @@ export async function getStartServerInfo({\n   return {\n     envInfo,\n     experimentalFeatures,\n+    cacheComponents,\n   }\n }"
        },
        {
            "sha": "c48db001e3f18382798d527d674903092b733805",
            "filename": "test/production/app-dir/build-output-prerender/build-output-prerender.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 51,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts?ref=c9b464ffb76d983cec28c1b5cf0d00fbfcb06bac",
            "patch": "@@ -18,59 +18,48 @@ describe('build-output-prerender', () => {\n \n       beforeAll(() => next.build())\n \n-      // TODO: Re-enable this test once we move the cache components flag\n-      it.skip('prints only the user-selected experimental flags (and the ones enabled via env variable)', async () => {\n+      it('prints only the user-selected experimental flags (and the ones enabled via env variable)', async () => {\n         if (cacheComponentsEnabled) {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (Turbopack)\n+             \"▲ Next.js x.y.z (Turbopack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\"\n             `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (webpack)\n+             \"▲ Next.js x.y.z (webpack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\"\n             `)\n           }\n         } else if (pprEnabled) {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (Turbopack)\n+             \"▲ Next.js x.y.z (Turbopack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\"\n             `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (webpack)\n+             \"▲ Next.js x.y.z (webpack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\"\n             `)\n           }\n         } else {\n           if (isTurbopack) {\n-            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (Turbopack)\n-                - Experiments (use with caution):\n-                  ✓ cacheComponents\"\n-            `)\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n+              `\"▲ Next.js x.y.z (Turbopack, Cache Components)\"`\n+            )\n           } else if (isRspack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (Rspack)\n-                - Experiments (use with caution):\n-                  ✓ cacheComponents\"\n+             \"▲ Next.js x.y.z (Rspack, Cache Components)\"\n             `)\n           } else {\n-            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (webpack)\n-                - Experiments (use with caution):\n-                  ✓ cacheComponents\"\n-            `)\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n+              `\"▲ Next.js x.y.z (webpack, Cache Components)\"`\n+            )\n           }\n         }\n       })\n@@ -116,15 +105,13 @@ describe('build-output-prerender', () => {\n \n       beforeAll(() => next.build())\n \n-      // TODO: Re-enable this test once we move the cache components flag\n-      it.skip('prints a warning and the customized experimental flags', async () => {\n+      it('prints a warning and the customized experimental flags', async () => {\n         if (cacheComponentsEnabled) {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (Turbopack)\n+                ▲ Next.js x.y.z (Turbopack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\n                   ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n@@ -133,9 +120,8 @@ describe('build-output-prerender', () => {\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (webpack)\n+                ▲ Next.js x.y.z (webpack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\n                   ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n@@ -146,9 +132,8 @@ describe('build-output-prerender', () => {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (Turbopack)\n+                ▲ Next.js x.y.z (Turbopack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n@@ -157,9 +142,8 @@ describe('build-output-prerender', () => {\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (webpack)\n+                ▲ Next.js x.y.z (webpack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n@@ -170,29 +154,26 @@ describe('build-output-prerender', () => {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (Turbopack)\n+                ▲ Next.js x.y.z (Turbopack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n                   ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\"\n             `)\n           } else if (isRspack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (Rspack)\n+                ▲ Next.js x.y.z (Rspack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n                   ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\"\n             `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (webpack)\n+                ▲ Next.js x.y.z (webpack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n                   ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\"\n@@ -241,21 +222,18 @@ describe('build-output-prerender', () => {\n \n       beforeAll(() => next.build())\n \n-      // TODO: Re-enable this test once we move the cache components flag\n-      it.skip('prints no experimental flags (unless enabled via env variable)', async () => {\n+      it('prints no experimental flags (unless enabled via env variable)', async () => {\n         if (cacheComponentsEnabled) {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (Turbopack)\n+             \"▲ Next.js x.y.z (Turbopack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents (enabled by \\`__NEXT_CACHE_COMPONENTS\\`)\n                   ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\"\n             `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (webpack)\n+             \"▲ Next.js x.y.z (webpack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents (enabled by \\`__NEXT_CACHE_COMPONENTS\\`)\n                   ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\"\n             `)\n           }\n@@ -300,15 +278,13 @@ describe('build-output-prerender', () => {\n \n       beforeAll(() => next.build())\n \n-      // TODO: Re-enable this test once we move the cache components flag\n-      it.skip('prints a warning and the customized experimental flags', async () => {\n+      it('prints a warning and the customized experimental flags', async () => {\n         if (cacheComponentsEnabled) {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (Turbopack)\n+                ▲ Next.js x.y.z (Turbopack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents (enabled by \\`__NEXT_CACHE_COMPONENTS\\`)\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\n                   ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n@@ -317,9 +293,8 @@ describe('build-output-prerender', () => {\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-                ▲ Next.js x.y.z (webpack)\n+                ▲ Next.js x.y.z (webpack, Cache Components)\n                 - Experiments (use with caution):\n-                  ✓ cacheComponents (enabled by \\`__NEXT_CACHE_COMPONENTS\\`)\n                   ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                   ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\n                   ⨯ serverMinification (disabled by \\`--debug-prerender\\`)"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 56,
        "deletions": 71
    }
}