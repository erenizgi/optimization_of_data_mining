{
    "author": "mischnic",
    "message": "Turbopack: don't resolve traced references in dev (#78623)\n\nRelated to https://github.com/vercel/next.js/issues/78509\n\nWe still call `ref.resolve_reference()` in dev on `ChunkingType::Traced` but never look at the result (and unnecessarily call `read_matches` potentially).",
    "sha": "76747986daa7ede0f40ad97ce9c4a85d241a95ae",
    "files": [
        {
            "sha": "35f020581b1f9076d602af0db164ad82a718eb8e",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -850,6 +850,7 @@ impl AppProject {\n             .map(|m| ResolvedVc::upcast(*m))\n             .collect();\n \n+        let should_trace = self.project.next_mode().await?.is_production();\n         if *self.project.per_page_module_graph().await? {\n             // Implements layout segment optimization to compute a graph \"chain\" for each layout\n             // segment\n@@ -862,7 +863,7 @@ impl AppProject {\n                     let ServerEntries {\n                         server_utils,\n                         server_component_entries,\n-                    } = &*find_server_entries(*rsc_entry).await?;\n+                    } = &*find_server_entries(*rsc_entry, should_trace).await?;\n \n                     let graph = SingleModuleGraph::new_with_entries_visited_intern(\n                         vec![\n@@ -878,6 +879,7 @@ impl AppProject {\n                             ChunkGroupEntry::Entry(client_shared_entries),\n                         ],\n                         VisitedModules::empty(),\n+                        should_trace,\n                     );\n                     graphs.push(graph);\n                     let mut visited_modules = VisitedModules::from_graph(graph);\n@@ -894,6 +896,7 @@ impl AppProject {\n                             // but that breaks everything for some reason.\n                             vec![ChunkGroupEntry::Entry(vec![ResolvedVc::upcast(*module)])],\n                             visited_modules,\n+                            should_trace,\n                         );\n                         graphs.push(graph);\n                         let is_layout =\n@@ -915,6 +918,7 @@ impl AppProject {\n                     let graph = SingleModuleGraph::new_with_entries_visited_intern(\n                         vec![ChunkGroupEntry::Entry(client_shared_entries)],\n                         VisitedModules::empty(),\n+                        should_trace,\n                     );\n                     graphs.push(graph);\n                     VisitedModules::from_graph(graph)\n@@ -923,6 +927,7 @@ impl AppProject {\n                 let graph = SingleModuleGraph::new_with_entries_visited_intern(\n                     vec![rsc_entry_chunk_group],\n                     visited_modules,\n+                    should_trace,\n                 );\n                 graphs.push(graph);\n                 visited_modules = visited_modules.concatenate(graph);\n@@ -932,6 +937,7 @@ impl AppProject {\n                 let additional_module_graph = SingleModuleGraph::new_with_entries_visited_intern(\n                     additional_entries.owned().await?,\n                     visited_modules,\n+                    should_trace,\n                 );\n                 graphs.push(additional_module_graph);\n \n@@ -1249,6 +1255,7 @@ impl AppEndpoint {\n             .get_client_references_for_endpoint(\n                 *rsc_entry,\n                 matches!(this.ty, AppEndpointType::Page { .. }),\n+                project.next_mode().await?.is_production(),\n             )\n             .to_resolved()\n             .await?;"
        },
        {
            "sha": "4c4e978d8b113b25d703762bbba18fef038727fc",
            "filename": "crates/next-api/src/module_graph.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -532,6 +532,7 @@ impl ReducedGraphs {\n         &self,\n         entry: Vc<Box<dyn Module>>,\n         has_layout_segments: bool,\n+        include_traced: bool,\n     ) -> Result<Vc<ClientReferenceGraphResult>> {\n         let span = tracing::info_span!(\"collect all client references for endpoint\");\n         async move {\n@@ -567,7 +568,7 @@ impl ReducedGraphs {\n                 let ServerEntries {\n                     server_utils,\n                     server_component_entries,\n-                } = &*find_server_entries(entry).await?;\n+                } = &*find_server_entries(entry, include_traced).await?;\n                 result.server_utils = server_utils.clone();\n                 result.server_component_entries = server_component_entries.clone();\n             }"
        },
        {
            "sha": "27607830cd4f309e2b3866ecc1770e2be5351cad",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -795,6 +795,7 @@ impl PageEndpoint {\n         let this = self.await?;\n         let project = this.pages_project.project();\n \n+        let should_trace = project.next_mode().await?.is_production();\n         if *project.per_page_module_graph().await? {\n             let ssr_chunk_module = self.internal_ssr_chunk_module().await?;\n             // Implements layout segment optimization to compute a graph \"chain\" for document, app,\n@@ -811,6 +812,7 @@ impl PageEndpoint {\n                 let graph = SingleModuleGraph::new_with_entries_visited_intern(\n                     vec![ChunkGroupEntry::Shared(module)],\n                     visited_modules,\n+                    should_trace,\n                 );\n                 graphs.push(graph);\n                 visited_modules = visited_modules.concatenate(graph);\n@@ -819,6 +821,7 @@ impl PageEndpoint {\n             let graph = SingleModuleGraph::new_with_entries_visited_intern(\n                 vec![ChunkGroupEntry::Entry(vec![ssr_chunk_module.ssr_module])],\n                 visited_modules,\n+                should_trace,\n             );\n             graphs.push(graph);\n "
        },
        {
            "sha": "ba17325370d3e44a2693907605478f1c81e957b0",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 6,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -896,7 +896,7 @@ impl Project {\n         entry: ResolvedVc<Box<dyn Module>>,\n     ) -> Result<Vc<ModuleGraph>> {\n         Ok(if *self.per_page_module_graph().await? {\n-            ModuleGraph::from_entry_module(*entry)\n+            ModuleGraph::from_entry_module(*entry, self.next_mode().await?.is_production())\n         } else {\n             *self.whole_app_module_graphs().await?.full\n         })\n@@ -914,7 +914,10 @@ impl Project {\n                 .copied()\n                 .map(ResolvedVc::upcast)\n                 .collect();\n-            ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(entries)]))\n+            ModuleGraph::from_modules(\n+                Vc::cell(vec![ChunkGroupEntry::Entry(entries)]),\n+                self.next_mode().await?.is_production(),\n+            )\n         } else {\n             *self.whole_app_module_graphs().await?.full\n         })\n@@ -926,7 +929,7 @@ impl Project {\n         entries: Vc<GraphEntries>,\n     ) -> Result<Vc<ModuleGraph>> {\n         Ok(if *self.per_page_module_graph().await? {\n-            ModuleGraph::from_modules(entries)\n+            ModuleGraph::from_modules(entries, self.next_mode().await?.is_production())\n         } else {\n             *self.whole_app_module_graphs().await?.full\n         })\n@@ -1747,14 +1750,20 @@ async fn whole_app_module_graph_operation(\n     project: ResolvedVc<Project>,\n ) -> Result<Vc<ModuleGraphs>> {\n     mark_root();\n-    let base_single_module_graph = SingleModuleGraph::new_with_entries(project.get_all_entries());\n+\n+    let should_trace = project.next_mode().await?.is_production();\n+    let base_single_module_graph =\n+        SingleModuleGraph::new_with_entries(project.get_all_entries(), should_trace);\n     let base_visited_modules = VisitedModules::from_graph(base_single_module_graph);\n \n     let base = ModuleGraph::from_single_graph(base_single_module_graph);\n     let additional_entries = project.get_all_additional_entries(base);\n \n-    let additional_module_graph =\n-        SingleModuleGraph::new_with_entries_visited(additional_entries, base_visited_modules);\n+    let additional_module_graph = SingleModuleGraph::new_with_entries_visited(\n+        additional_entries,\n+        base_visited_modules,\n+        should_trace,\n+    );\n \n     let full = ModuleGraph::from_graphs(vec![base_single_module_graph, additional_module_graph]);\n     Ok(ModuleGraphs {"
        },
        {
            "sha": "833862bbe260eb022b8ea4f84fbbf47d67259a7c",
            "filename": "crates/next-core/src/next_client_reference/visit_client_reference.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -151,7 +151,10 @@ pub struct ServerEntries {\n }\n \n #[turbo_tasks::function]\n-pub async fn find_server_entries(entry: ResolvedVc<Box<dyn Module>>) -> Result<Vc<ServerEntries>> {\n+pub async fn find_server_entries(\n+    entry: ResolvedVc<Box<dyn Module>>,\n+    include_traced: bool,\n+) -> Result<Vc<ServerEntries>> {\n     async move {\n         let entry_path = entry.ident().path().to_resolved().await?;\n         let graph = AdjacencyMap::new()\n@@ -166,6 +169,7 @@ pub async fn find_server_entries(entry: ResolvedVc<Box<dyn Module>>) -> Result<V\n                 }],\n                 VisitClientReference {\n                     stop_at_server_entries: true,\n+                    include_traced,\n                 },\n             )\n             .await\n@@ -198,6 +202,8 @@ pub async fn find_server_entries(entry: ResolvedVc<Box<dyn Module>>) -> Result<V\n }\n \n struct VisitClientReference {\n+    /// Whether to walk ChunkingType::Traced references\n+    include_traced: bool,\n     /// Used to discover ServerComponents and ServerUtils\n     stop_at_server_entries: bool,\n }\n@@ -300,6 +306,7 @@ impl Visit<VisitClientReferenceNode> for VisitClientReference {\n \n     fn edges(&mut self, node: &VisitClientReferenceNode) -> Self::EdgesFuture {\n         let node = node.clone();\n+        let include_traced = self.include_traced;\n         async move {\n             let parent_module = match node.ty {\n                 // This should never occur since we always skip visiting these\n@@ -314,7 +321,8 @@ impl Visit<VisitClientReferenceNode> for VisitClientReference {\n                 }\n             };\n \n-            let referenced_modules = primary_chunkable_referenced_modules(*parent_module).await?;\n+            let referenced_modules =\n+                primary_chunkable_referenced_modules(*parent_module, include_traced).await?;\n \n             let referenced_modules = referenced_modules\n                 .iter()"
        },
        {
            "sha": "1a4326ed70bdf3782daeaaee4cf88c6ec2de6273",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -303,8 +303,10 @@ async fn build_internal(\n     .instrument(tracing::info_span!(\"resolve entries\"))\n     .await?;\n \n-    let module_graph =\n-        ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(entries.clone())]));\n+    let module_graph = ModuleGraph::from_modules(\n+        Vc::cell(vec![ChunkGroupEntry::Entry(entries.clone())]),\n+        false,\n+    );\n     let module_id_strategy = ResolvedVc::upcast(\n         get_global_module_id_strategy(module_graph)\n             .to_resolved()"
        },
        {
            "sha": "cfb8982ef32ca3c10a2ead4c29e24aca8f9013fb",
            "filename": "turbopack/crates/turbopack-cli/src/dev/web_entry_source.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fweb_entry_source.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fweb_entry_source.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fdev%2Fweb_entry_source.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -156,7 +156,7 @@ pub async fn create_web_entry_source(\n         )\n         .collect::<Vec<ResolvedVc<Box<dyn Module>>>>();\n     let module_graph =\n-        ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(all_modules)]))\n+        ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(all_modules)]), false)\n             .to_resolved()\n             .await?;\n "
        },
        {
            "sha": "551bd809ba001b9dbff3133a1954420726e38b27",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 37,
            "deletions": 12,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -187,6 +187,7 @@ impl SingleModuleGraph {\n     async fn new_inner(\n         entries: &GraphEntriesT,\n         visited_modules: &FxIndexMap<ResolvedVc<Box<dyn Module>>, GraphNodeIndex>,\n+        include_traced: bool,\n     ) -> Result<Vc<Self>> {\n         let root_edges = entries\n             .iter()\n@@ -201,7 +202,13 @@ impl SingleModuleGraph {\n \n         let (children_nodes_iter, visited_nodes) = AdjacencyMap::new()\n             .skip_duplicates()\n-            .visit(root_edges, SingleModuleGraphBuilder { visited_modules })\n+            .visit(\n+                root_edges,\n+                SingleModuleGraphBuilder {\n+                    visited_modules,\n+                    include_traced,\n+                },\n+            )\n             .await\n             .completed()?\n             .into_inner_with_visited();\n@@ -726,15 +733,19 @@ impl ModuleGraph {\n     }\n \n     #[turbo_tasks::function]\n-    pub fn from_entry_module(module: ResolvedVc<Box<dyn Module>>) -> Vc<Self> {\n-        Self::from_single_graph(SingleModuleGraph::new_with_entries(Vc::cell(vec![\n-            ChunkGroupEntry::Entry(vec![module]),\n-        ])))\n+    pub fn from_entry_module(\n+        module: ResolvedVc<Box<dyn Module>>,\n+        include_traced: bool,\n+    ) -> Vc<Self> {\n+        Self::from_single_graph(SingleModuleGraph::new_with_entries(\n+            Vc::cell(vec![ChunkGroupEntry::Entry(vec![module])]),\n+            include_traced,\n+        ))\n     }\n \n     #[turbo_tasks::function]\n-    pub fn from_modules(modules: Vc<GraphEntries>) -> Vc<Self> {\n-        Self::from_single_graph(SingleModuleGraph::new_with_entries(modules))\n+    pub fn from_modules(modules: Vc<GraphEntries>, include_traced: bool) -> Vc<Self> {\n+        Self::from_single_graph(SingleModuleGraph::new_with_entries(modules, include_traced))\n     }\n \n     #[turbo_tasks::function]\n@@ -1159,25 +1170,36 @@ impl ModuleGraph {\n #[turbo_tasks::value_impl]\n impl SingleModuleGraph {\n     #[turbo_tasks::function]\n-    pub async fn new_with_entries(entries: Vc<GraphEntries>) -> Result<Vc<Self>> {\n-        SingleModuleGraph::new_inner(&*entries.await?, &Default::default()).await\n+    pub async fn new_with_entries(\n+        entries: Vc<GraphEntries>,\n+        include_traced: bool,\n+    ) -> Result<Vc<Self>> {\n+        SingleModuleGraph::new_inner(&*entries.await?, &Default::default(), include_traced).await\n     }\n \n     #[turbo_tasks::function]\n     pub async fn new_with_entries_visited(\n         entries: Vc<GraphEntries>,\n         visited_modules: Vc<VisitedModules>,\n+        include_traced: bool,\n     ) -> Result<Vc<Self>> {\n-        SingleModuleGraph::new_inner(&*entries.await?, &visited_modules.await?.modules).await\n+        SingleModuleGraph::new_inner(\n+            &*entries.await?,\n+            &visited_modules.await?.modules,\n+            include_traced,\n+        )\n+        .await\n     }\n \n     #[turbo_tasks::function]\n     pub async fn new_with_entries_visited_intern(\n         // This must not be a Vc<Vec<_>> to ensure layout segment optimization hits the cache\n         entries: GraphEntriesT,\n         visited_modules: Vc<VisitedModules>,\n+        include_traced: bool,\n     ) -> Result<Vc<Self>> {\n-        SingleModuleGraph::new_inner(&entries, &visited_modules.await?.modules).await\n+        SingleModuleGraph::new_inner(&entries, &visited_modules.await?.modules, include_traced)\n+            .await\n     }\n }\n \n@@ -1299,6 +1321,8 @@ const COMMON_CHUNKING_TYPE: ChunkingType = ChunkingType::ParallelInheritAsync;\n \n struct SingleModuleGraphBuilder<'a> {\n     visited_modules: &'a FxIndexMap<ResolvedVc<Box<dyn Module>>, GraphNodeIndex>,\n+    /// Whether to walk ChunkingType::Traced references\n+    include_traced: bool,\n }\n impl Visit<SingleModuleGraphBuilderNode> for SingleModuleGraphBuilder<'_> {\n     type Edge = SingleModuleGraphBuilderEdge;\n@@ -1333,10 +1357,11 @@ impl Visit<SingleModuleGraphBuilderNode> for SingleModuleGraphBuilder<'_> {\n             | SingleModuleGraphBuilderNode::Issues(_) => unreachable!(),\n         };\n         let visited_modules = self.visited_modules;\n+        let include_traced = self.include_traced;\n         async move {\n             Ok(match (module, chunkable_ref_target) {\n                 (Some(module), None) => {\n-                    let refs_cell = primary_chunkable_referenced_modules(*module);\n+                    let refs_cell = primary_chunkable_referenced_modules(*module, include_traced);\n                     let refs = match refs_cell.await {\n                         Ok(refs) => refs,\n                         Err(e) => {"
        },
        {
            "sha": "79e2bcdfca9d045c13f7c8a711e3b0954c44b395",
            "filename": "turbopack/crates/turbopack-core/src/reference/mod.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -282,6 +282,7 @@ pub struct ModulesWithChunkingType(Vec<(ChunkingType, ModulesVec)>);\n #[turbo_tasks::function]\n pub async fn primary_chunkable_referenced_modules(\n     module: Vc<Box<dyn Module>>,\n+    include_traced: bool,\n ) -> Result<Vc<ModulesWithChunkingType>> {\n     let modules = module\n         .references()\n@@ -292,6 +293,10 @@ pub async fn primary_chunkable_referenced_modules(\n                 ResolvedVc::try_downcast::<Box<dyn ChunkableModuleReference>>(*reference)\n             {\n                 if let Some(chunking_type) = &*reference.chunking_type().await? {\n+                    if !include_traced && matches!(chunking_type, ChunkingType::Traced) {\n+                        return Ok(None);\n+                    }\n+\n                     let resolved = reference\n                         .resolve_reference()\n                         .resolve()"
        },
        {
            "sha": "6ae85d87166b167bd9b59592a1caaf03090153f8",
            "filename": "turbopack/crates/turbopack-node/src/evaluate.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -156,11 +156,14 @@ async fn emit_evaluate_pool_assets_operation(\n         entries\n     };\n \n-    let module_graph = ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(\n-        iter::once(entry_module)\n-            .chain(runtime_entries.iter().copied().map(ResolvedVc::upcast))\n-            .collect(),\n-    )]));\n+    let module_graph = ModuleGraph::from_modules(\n+        Vc::cell(vec![ChunkGroupEntry::Entry(\n+            iter::once(entry_module)\n+                .chain(runtime_entries.iter().copied().map(ResolvedVc::upcast))\n+                .collect(),\n+        )]),\n+        false,\n+    );\n \n     let bootstrap = chunking_context.root_entry_chunk_group_asset(\n         entrypoint,"
        },
        {
            "sha": "27726e12b0f2fedea786beaa8f4981bef4af34ea",
            "filename": "turbopack/crates/turbopack-node/src/lib.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -257,15 +257,18 @@ pub async fn get_intermediate_asset(\n     Ok(Vc::upcast(chunking_context.root_entry_chunk_group_asset(\n         chunking_context.chunk_path(None, main_entry.ident(), \".js\".into()),\n         other_entries.with_entry(*main_entry),\n-        ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(\n+        ModuleGraph::from_modules(\n+            Vc::cell(vec![ChunkGroupEntry::Entry(\n                 other_entries\n                     .await?\n                     .into_iter()\n                     .copied()\n                     .chain(std::iter::once(main_entry))\n                     .map(ResolvedVc::upcast)\n                     .collect(),\n-            )])),\n+            )]),\n+            false,\n+        ),\n         OutputAssets::empty(),\n     )))\n }"
        },
        {
            "sha": "8d1f775ea6ee633e396bcd018f31494d750b481a",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -400,8 +400,10 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n             .copied()\n             .map(ResolvedVc::upcast)\n             .collect::<Vec<_>>();\n-        let module_graph =\n-            ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(all_modules.clone())]));\n+        let module_graph = ModuleGraph::from_modules(\n+            Vc::cell(vec![ChunkGroupEntry::Entry(all_modules.clone())]),\n+            false,\n+        );\n         // TODO: Load runtime entries from snapshots\n         match options.runtime {\n             Runtime::Browser => chunking_context.evaluated_chunk_group_assets("
        }
    ],
    "stats": {
        "total": 136,
        "additions": 102,
        "deletions": 34
    }
}