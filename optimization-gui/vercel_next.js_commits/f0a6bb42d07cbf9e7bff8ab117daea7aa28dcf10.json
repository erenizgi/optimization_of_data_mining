{
    "author": "huozhi",
    "message": "[metadata] skip head cache in default slot (#78206)",
    "sha": "f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
    "files": [
        {
            "sha": "471b1804e7ac33f5a9f815a3f29e7ad62d59415a",
            "filename": "packages/next/src/client/components/router-reducer/reducers/find-head-in-cache.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -1,5 +1,6 @@\n import type { FlightRouterState } from '../../../../server/app-render/types'\n import type { CacheNode } from '../../../../shared/lib/app-router-context.shared-runtime'\n+import { DEFAULT_SEGMENT_KEY } from '../../../../shared/lib/segment'\n import { createRouterCacheKey } from '../create-router-cache-key'\n \n export function findHeadInCache(\n@@ -33,6 +34,11 @@ function findHeadInCacheImpl(\n \n   for (const key of parallelRoutesKeys) {\n     const [segment, childParallelRoutes] = parallelRoutes[key]\n+    // If the parallel is not matched and using the default segment,\n+    // skip searching the head from it.\n+    if (segment === DEFAULT_SEGMENT_KEY) {\n+      continue\n+    }\n     const childSegmentMap = cache.parallelRoutes.get(key)\n     if (!childSegmentMap) {\n       continue"
        },
        {
            "sha": "1f882fc919b725e3102476b028559763a1077fc4",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/layout.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Flayout.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -14,6 +14,11 @@ export default function Root({ children }: { children: ReactNode }) {\n             {`to /parallel-routes-default`}\n           </Link>\n           <br />\n+\n+          <Link href=\"/parallel-routes-no-children\" id=\"to-no-children\">\n+            {`to /parallel-routes-no-children`}\n+          </Link>\n+          <br />\n         </div>\n         {children}\n       </body>"
        },
        {
            "sha": "e355998a4433c4d5dbc1dd3722978a2c5abe0b4a",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@bar/default.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fdefault.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fdefault.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fdefault.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'default @bar'\n+}"
        },
        {
            "sha": "85375256fc6db1560dbe18372a4f1cb2047741db",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@bar/first/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Ffirst%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Ffirst%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Ffirst%2Fpage.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Page() {\n+  return <p id=\"bar-page\">test-page @bar - 1</p>\n+}\n+\n+export const metadata = {\n+  title: 'first page - @bar',\n+}"
        },
        {
            "sha": "1e18e748cf81e93f454e9cd71ce7617948880703",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@bar/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Flayout.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Layout({ children }) {\n+  return (\n+    <div>\n+      <h2>@bar Layout</h2>\n+      <div id=\"bar-children\">{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "eb4a3e2e9df71d0f81f102128ee52511d9c00b22",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@bar/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fpage.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'page @bar'\n+}"
        },
        {
            "sha": "ce3b2fa4875901ba9820fa083b14e2eeeef7099a",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@bar/second/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fsecond%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fsecond%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40bar%2Fsecond%2Fpage.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Page() {\n+  return <p id=\"bar-page\">test-page @bar - 2</p>\n+}\n+\n+export const metadata = {\n+  title: 'second page - @bar',\n+}"
        },
        {
            "sha": "408576f1876b586e90b61480df9db74ef6568ea8",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@foo/default.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fdefault.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fdefault.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fdefault.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'default @foo'\n+}"
        },
        {
            "sha": "05a3bda4f7be80fce7cf6de65a53e33e8c9bab6f",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@foo/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Flayout.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,8 @@\n+export default function Layout({ children }) {\n+  return (\n+    <div>\n+      <h2>@foo Layout</h2>\n+      <div id=\"foo-children\">{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "44ab40e2ddfce8edb4eacbe5002a952280294d72",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@foo/no-bar/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fno-bar%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fno-bar%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fno-bar%2Fpage.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'no-bar @foo'\n+}"
        },
        {
            "sha": "3536981cea3ff4875f8b1ffea941e755e6268832",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@foo/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Fpage.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'page @foo'\n+}"
        },
        {
            "sha": "8eff01dbe6deca778649eae4eacb6e07e14a0d3c",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/@foo/test-page/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Ftest-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Ftest-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2F%40foo%2Ftest-page%2Fpage.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'test-page @foo'\n+}"
        },
        {
            "sha": "90ff6a8eb804296ad71182eaa86341bfb9fdd91c",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/app/parallel-routes-no-children/layout.tsx",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fapp%2Fparallel-routes-no-children%2Flayout.tsx?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -0,0 +1,34 @@\n+import { connection } from 'next/server'\n+import Link from 'next/link'\n+\n+// skip rendering children\n+export default function Layout({ bar, foo }) {\n+  return (\n+    <div>\n+      <h1>Parallel Routes Layout - No Children</h1>\n+\n+      <Link href=\"/parallel-routes-no-children/first\" id=\"to-no-children-first\">\n+        {`to /parallel-routes-no-children/first`}\n+      </Link>\n+      <br />\n+      <Link\n+        href=\"/parallel-routes-no-children/second\"\n+        id=\"to-no-children-second\"\n+      >\n+        {`to /parallel-routes-no-children/second`}\n+      </Link>\n+      <br />\n+\n+      <div id=\"foo-slot\">{foo}</div>\n+      <div id=\"bar-slot\">{bar}</div>\n+    </div>\n+  )\n+}\n+\n+export async function generateMetadata() {\n+  await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 300))\n+  return {\n+    title: 'parallel-routes-default layout title',\n+  }\n+}"
        },
        {
            "sha": "36e10dff4ab3d59a82f0318daa25efb18e92f674",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/metadata-streaming-parallel-routes.test.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts?ref=f0a6bb42d07cbf9e7bff8ab117daea7aa28dcf10",
            "patch": "@@ -57,4 +57,29 @@ describe('app-dir - metadata-streaming', () => {\n     expect($('title').length).toBe(1)\n     expect($('body title').text()).toBe('parallel-routes-default layout title')\n   })\n+\n+  it('should change metadata when navigating between two pages under a slot when children is not rendered', async () => {\n+    // first page is /parallel-routes-no-children/first,\n+    // second page is /parallel-routes-no-children/second\n+    // navigating between them should change the title metadata\n+    const browser = await next.browser('/parallel-routes-no-children/first')\n+    await retry(async () => {\n+      expect(await browser.elementByCss('title').text()).toBe(\n+        'first page - @bar'\n+      )\n+    })\n+    // go to second page\n+    await browser\n+      .elementByCss('[href=\"/parallel-routes-no-children/second\"]')\n+      .click()\n+    // wait for navigation to finish\n+    await retry(async () => {\n+      expect(await browser.elementByCss('#bar-page').text()).toBe(\n+        'test-page @bar - 2'\n+      )\n+    })\n+    expect(await browser.elementByCss('title').text()).toBe(\n+      'second page - @bar'\n+    )\n+  })\n })"
        }
    ],
    "stats": {
        "total": 118,
        "additions": 118,
        "deletions": 0
    }
}