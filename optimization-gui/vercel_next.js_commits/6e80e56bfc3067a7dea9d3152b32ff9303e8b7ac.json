{
    "author": "kdy1",
    "message": "chore(ci): Configure automated benchmark for turbopack (#79791)\n\n### What?\n\nThis PR configures an automated benchmark for turbopack. We can run small benchmarks for all turbopack PRs, and I'll add more benchmarks with follow-up PRs.\n\n\n### Why?\n\nWe need a way to track performance consistently.",
    "sha": "6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac",
    "files": [
        {
            "sha": "f116ec5a09e42110169d03362b4511f405d6f9ef",
            "filename": ".github/workflows/bench.yml",
            "status": "removed",
            "additions": 0,
            "deletions": 70,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/2b7a259169b85d82643b95eaf8d0601f1a9f3e7e/.github%2Fworkflows%2Fbench.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/2b7a259169b85d82643b95eaf8d0601f1a9f3e7e/.github%2Fworkflows%2Fbench.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbench.yml?ref=2b7a259169b85d82643b95eaf8d0601f1a9f3e7e",
            "patch": "@@ -1,70 +0,0 @@\n-name: Benchmark\n-\n-on:\n-  push:\n-    branches:\n-      - canary\n-    paths:\n-      - '**/crates/**'\n-  pull_request:\n-    types: ['labeled']\n-\n-concurrency:\n-  group: ${{ github.workflow }}-${{ github.sha }}\n-  cancel-in-progress: ${{ github.event_name == 'pull_request' }}\n-\n-env:\n-  CI: 1\n-  CARGO_INCREMENTAL: 0\n-  # For faster CI\n-  RUST_LOG: 'off'\n-\n-jobs:\n-  list-crates:\n-    name: List crates to benchmark\n-    runs-on:\n-      - 'self-hosted'\n-      - 'linux'\n-      - 'x64'\n-      - 'metal'\n-    if: ${{ github.event.label.name == 'benchmark' }}\n-    outputs:\n-      crates: ${{ steps.list-crates.outputs.crates }}\n-    steps:\n-      - uses: actions/checkout@v4\n-\n-      - name: List crates\n-        id: list-crates\n-        run: echo \"crates=$(./scripts/cargo/bench/list-crates-with-bench.sh)\" >> $GITHUB_OUTPUT\n-\n-  benchmark-crate:\n-    name: Benchmark ${{ matrix.crate }}\n-    runs-on: ubuntu-22.04\n-    needs: list-crates\n-    # Limit the number of concurrent jobs to 1\n-    concurrency:\n-      group: ${{ github.workflow }}\n-    strategy:\n-      matrix:\n-        crate: ${{fromJson(needs.list-crates.outputs.crates)}}\n-    steps:\n-      - uses: actions/checkout@v4\n-\n-      - name: Install Rust\n-        uses: actions-rs/toolchain@v1\n-        with:\n-          profile: minimal\n-\n-      - name: Install cargo-codspeed\n-        uses: taiki-e/install-action@v2\n-        with:\n-          tool: cargo-codspeed@2.8.1\n-\n-      - name: Build the benchmark target(s)\n-        run: cargo codspeed build -p ${{ matrix.crate }}\n-\n-      - name: Run the benchmarks\n-        uses: CodSpeedHQ/action@v3\n-        with:\n-          run: cargo codspeed run\n-          token: ${{ secrets.CODSPEED_TOKEN }}"
        },
        {
            "sha": "6cc0b04a1be0b27a0fbb33e9a476ee2816168a2e",
            "filename": ".github/workflows/turbopack-benchmark.yml",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac/.github%2Fworkflows%2Fturbopack-benchmark.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac/.github%2Fworkflows%2Fturbopack-benchmark.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fturbopack-benchmark.yml?ref=6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac",
            "patch": "@@ -0,0 +1,51 @@\n+name: Turbopack Benchmark\n+\n+on:\n+  workflow_dispatch:\n+  push:\n+    branches:\n+      - canary\n+    paths:\n+      - '**/crates/**'\n+      - '**/Cargo.toml'\n+      - '**/Cargo.lock'\n+  pull_request:\n+    types: ['opened', 'reopened', 'synchronize']\n+    paths:\n+      - '**/crates/**'\n+      - '**/Cargo.toml'\n+      - '**/Cargo.lock'\n+\n+concurrency:\n+  group: ${{ github.workflow }}-${{ github.sha }}\n+  cancel-in-progress: ${{ github.event_name == 'pull_request' }}\n+\n+env:\n+  CI: 1\n+  CARGO_INCREMENTAL: 0\n+  # For faster CI\n+  RUST_LOG: 'off'\n+\n+jobs:\n+  benchmark-small:\n+    name: Benchmark Rust Crates (small)\n+    runs-on: ubuntu-22.04\n+    steps:\n+      - uses: actions/checkout@v4\n+\n+      - name: Setup Rust toolchain\n+        uses: ./.github/actions/setup-rust\n+\n+      - name: Install cargo-codspeed\n+        uses: taiki-e/install-action@v2\n+        with:\n+          tool: cargo-codspeed@2.10.1\n+\n+      - name: Build the benchmark target(s)\n+        run: cargo codspeed build -p turbo-rcstr -p turbopack-ecmascript\n+\n+      - name: Run the benchmarks\n+        uses: CodSpeedHQ/action@v3\n+        with:\n+          run: cargo codspeed run\n+          token: ${{ secrets.CODSPEED_TOKEN }}"
        },
        {
            "sha": "dcd7c1892ade1dc62ca6734b84bb0668388d4fd8",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 80,
            "deletions": 38,
            "changes": 118,
            "blob_url": "https://github.com/vercel/next.js/blob/6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac",
            "patch": "@@ -1313,6 +1313,61 @@ version = \"0.2.3\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"67ba02a97a2bd10f4b59b25c7973101c79642302776489e030cd13cdab09ed15\"\n \n+[[package]]\n+name = \"codspeed\"\n+version = \"2.10.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"93f4cce9c27c49c4f101fffeebb1826f41a9df2e7498b7cd4d95c0658b796c6c\"\n+dependencies = [\n+ \"colored\",\n+ \"libc\",\n+ \"serde\",\n+ \"serde_json\",\n+ \"uuid\",\n+]\n+\n+[[package]]\n+name = \"codspeed-criterion-compat\"\n+version = \"2.10.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"c3c23d880a28a2aab52d38ca8481dd7a3187157d0a952196b6db1db3c8499725\"\n+dependencies = [\n+ \"codspeed\",\n+ \"codspeed-criterion-compat-walltime\",\n+ \"colored\",\n+ \"futures\",\n+ \"tokio\",\n+]\n+\n+[[package]]\n+name = \"codspeed-criterion-compat-walltime\"\n+version = \"2.10.1\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"7b0a2f7365e347f4f22a67e9ea689bf7bc89900a354e22e26cf8a531a42c8fbb\"\n+dependencies = [\n+ \"anes\",\n+ \"cast\",\n+ \"ciborium\",\n+ \"clap\",\n+ \"codspeed\",\n+ \"criterion-plot\",\n+ \"futures\",\n+ \"is-terminal\",\n+ \"itertools 0.10.5\",\n+ \"num-traits\",\n+ \"once_cell\",\n+ \"oorandom\",\n+ \"plotters\",\n+ \"rayon\",\n+ \"regex\",\n+ \"serde\",\n+ \"serde_derive\",\n+ \"serde_json\",\n+ \"tinytemplate\",\n+ \"tokio\",\n+ \"walkdir\",\n+]\n+\n [[package]]\n name = \"color_quant\"\n version = \"1.1.0\"\n@@ -1325,6 +1380,16 @@ version = \"1.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"acbf1af155f9b9ef647e42cdc158db4b64a1b61f743629225fde6f3e0be2a7c7\"\n \n+[[package]]\n+name = \"colored\"\n+version = \"2.2.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"117725a109d387c937a1533ce01b450cbde6b88abceea8473c4d7a85853cda3c\"\n+dependencies = [\n+ \"lazy_static\",\n+ \"windows-sys 0.59.0\",\n+]\n+\n [[package]]\n name = \"combine\"\n version = \"4.6.7\"\n@@ -1615,34 +1680,6 @@ dependencies = [\n  \"cfg-if\",\n ]\n \n-[[package]]\n-name = \"criterion\"\n-version = \"0.5.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"f2b12d017a929603d80db1831cd3a24082f8137ce19c69e6447f54f5fc8d692f\"\n-dependencies = [\n- \"anes\",\n- \"cast\",\n- \"ciborium\",\n- \"clap\",\n- \"criterion-plot\",\n- \"futures\",\n- \"is-terminal\",\n- \"itertools 0.10.5\",\n- \"num-traits\",\n- \"once_cell\",\n- \"oorandom\",\n- \"plotters\",\n- \"rayon\",\n- \"regex\",\n- \"serde\",\n- \"serde_derive\",\n- \"serde_json\",\n- \"tinytemplate\",\n- \"tokio\",\n- \"walkdir\",\n-]\n-\n [[package]]\n name = \"criterion-plot\"\n version = \"0.5.0\"\n@@ -2996,7 +3033,7 @@ dependencies = [\n  \"httpdate\",\n  \"itoa\",\n  \"pin-project-lite\",\n- \"socket2 0.4.9\",\n+ \"socket2 0.5.8\",\n  \"tokio\",\n  \"tower-service\",\n  \"tracing\",\n@@ -9520,7 +9557,7 @@ version = \"0.1.0\"\n name = \"turbo-rcstr\"\n version = \"0.1.0\"\n dependencies = [\n- \"criterion\",\n+ \"codspeed-criterion-compat\",\n  \"new_debug_unreachable\",\n  \"serde\",\n  \"shrink-to-fit\",\n@@ -9599,7 +9636,7 @@ dependencies = [\n  \"auto-hash-map\",\n  \"bitfield\",\n  \"byteorder\",\n- \"criterion\",\n+ \"codspeed-criterion-compat\",\n  \"dashmap 6.1.0\",\n  \"either\",\n  \"hashbrown 0.14.5\",\n@@ -9697,8 +9734,8 @@ dependencies = [\n  \"auto-hash-map\",\n  \"bitflags 1.3.2\",\n  \"bytes\",\n+ \"codspeed-criterion-compat\",\n  \"concurrent-queue\",\n- \"criterion\",\n  \"dashmap 6.1.0\",\n  \"dunce\",\n  \"futures\",\n@@ -9819,7 +9856,7 @@ name = \"turbopack\"\n version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n- \"criterion\",\n+ \"codspeed-criterion-compat\",\n  \"difference\",\n  \"futures\",\n  \"indexmap 2.7.1\",\n@@ -9860,7 +9897,7 @@ version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n  \"chromiumoxide\",\n- \"criterion\",\n+ \"codspeed-criterion-compat\",\n  \"futures\",\n  \"nix 0.26.4\",\n  \"once_cell\",\n@@ -9911,8 +9948,8 @@ version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n  \"clap\",\n+ \"codspeed-criterion-compat\",\n  \"console-subscriber\",\n- \"criterion\",\n  \"dunce\",\n  \"futures\",\n  \"mime\",\n@@ -10089,7 +10126,7 @@ version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n  \"async-trait\",\n- \"criterion\",\n+ \"codspeed-criterion-compat\",\n  \"data-encoding\",\n  \"either\",\n  \"indexmap 2.7.1\",\n@@ -10670,9 +10707,14 @@ checksum = \"711b9620af191e0cdc7468a8d14e709c3dcdb115b36f838e601583af800a370a\"\n \n [[package]]\n name = \"uuid\"\n-version = \"1.5.0\"\n+version = \"1.17.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"88ad59a7560b41a70d191093a945f0b87bc1deeda46fb237479708a1d6b6cdfc\"\n+checksum = \"3cf4199d1e5d15ddd86a694e4d0dffa9c323ce759fea589f00fef9d81cc1931d\"\n+dependencies = [\n+ \"getrandom 0.3.2\",\n+ \"js-sys\",\n+ \"wasm-bindgen\",\n+]\n \n [[package]]\n name = \"v_frame\""
        },
        {
            "sha": "8fdf644a3aa6bf7f84924e54f16b2c9ae6d26504",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac",
            "patch": "@@ -340,7 +340,7 @@ concurrent-queue = \"2.5.0\"\n console = \"0.15.5\"\n console-subscriber = \"0.4.1\"\n const_format = \"0.2.30\"\n-criterion = \"0.5.1\"\n+criterion = { package = \"codspeed-criterion-compat\", version = \"2.10.1\" }\n crossbeam-channel = \"0.5.8\"\n dashmap = \"6.1.0\"\n data-encoding = \"2.3.3\""
        },
        {
            "sha": "1bc78dc3401f61b40430bde18d90325d4d470dec",
            "filename": "turbopack/crates/turbo-tasks-macros/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac/turbopack%2Fcrates%2Fturbo-tasks-macros%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac/turbopack%2Fcrates%2Fturbo-tasks-macros%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2FCargo.toml?ref=6e80e56bfc3067a7dea9d3152b32ff9303e8b7ac",
            "patch": "@@ -19,5 +19,5 @@ proc-macro2 = { workspace = true }\n quote = { workspace = true }\n regex = { workspace = true }\n rustc-hash = { workspace = true }\n-syn = { workspace = true, features = [\"full\", \"extra-traits\", \"visit-mut\"] }\n+syn = { workspace = true, features = [\"full\", \"extra-traits\", \"visit\", \"visit-mut\"] }\n turbo-tasks-macros-shared = { workspace = true }"
        }
    ],
    "stats": {
        "total": 243,
        "additions": 133,
        "deletions": 110
    }
}