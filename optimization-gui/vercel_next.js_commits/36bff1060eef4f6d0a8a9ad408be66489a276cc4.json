{
    "author": "ztanner",
    "message": "[breaking]: enable router scroll optimization by default (#84102)\n\nThis removes the env gate that opted into old behavior. Without\nexplicitly setting `scroll-behavior: 'smooth'` on the document, Next.js\nwill not attempt to programmatically disable smooth scrolling when\nperforming certain router events. This is a performance optimization in\nall cases that do not care about smooth scroll.",
    "sha": "36bff1060eef4f6d0a8a9ad408be66489a276cc4",
    "files": [
        {
            "sha": "86f09bded994b8567d528b98bf012a856230f459",
            "filename": "errors/missing-data-scroll-behavior.mdx",
            "status": "modified",
            "additions": 2,
            "deletions": 21,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/36bff1060eef4f6d0a8a9ad408be66489a276cc4/errors%2Fmissing-data-scroll-behavior.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/36bff1060eef4f6d0a8a9ad408be66489a276cc4/errors%2Fmissing-data-scroll-behavior.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/errors%2Fmissing-data-scroll-behavior.mdx?ref=36bff1060eef4f6d0a8a9ad408be66489a276cc4",
            "patch": "@@ -8,11 +8,9 @@ Your application has smooth scrolling enabled via CSS (`scroll-behavior: smooth`\n \n Next.js automatically attempts to detect the smooth scrolling configuration to ensure that navigating back/forward through the router doesn't also trigger the smooth scrolling behavior, as this is often not desired.\n \n-In a future version of Next.js, this behavior will no longer be automatically detected, and you will need to add the `data-scroll-behavior` attribute to your `<html>` element to opt-in to having Next.js disable smooth scrolling during route transitions.\n-\n ## Possible Ways to Fix It\n \n-Add `data-scroll-behavior=\"smooth\"` to your `<html>` element to prepare for the upcoming optimization:\n+Add `data-scroll-behavior=\"smooth\"` to your `<html>` element if you want to disable smooth scrolling when routing via Next.js.\n \n ```html filename=\"app/layout.tsx\"\n export default function RootLayout({ children, }: { children: React.ReactNode })\n@@ -42,21 +40,4 @@ function Document() { return (\n \n ## Why This Optimization Matters\n \n-Without the data attribute, Next.js must modify the `scroll-behavior` style on the `<html>` element on every navigation to ensure smooth scrolling isn't triggered. This can cause unnecessary style recalculation and impact performance.\n-\n-With the data attribute, Next.js can instantly detect smooth scrolling configuration without triggering style recalculation, resulting in faster navigation and making this behavior opt-in.\n-\n-## Enabling the Optimization Early\n-\n-You can enable this optimization early by adding the experimental flag to your `next.config.js`:\n-\n-```js filename=\"next.config.js\"\n-/** @type {import('next').NextConfig} */\n-const nextConfig = {\n-  experimental: {\n-    optimizeRouterScrolling: true,\n-  },\n-}\n-\n-module.exports = nextConfig\n-```\n+Next.js will only attempt to modify the `scroll-behavior` style on the `<html>` element when the data attribute is present to ensure smooth scrolling isn't triggered. This avoids unnecessary style recalculation unless explicitly opted into."
        },
        {
            "sha": "d601899577cf4de0fee34584d66079fa9d1596f9",
            "filename": "packages/next/src/build/define-env.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/36bff1060eef4f6d0a8a9ad408be66489a276cc4/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/36bff1060eef4f6d0a8a9ad408be66489a276cc4/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fdefine-env.ts?ref=36bff1060eef4f6d0a8a9ad408be66489a276cc4",
            "patch": "@@ -331,8 +331,6 @@ export function getDefineEnv({\n     // no-op that just restarts the development server.\n     'process.env.__NEXT_BUNDLER_HAS_PERSISTENT_CACHE':\n       !isTurbopack || (config.experimental.turbopackPersistentCaching ?? false),\n-    'process.env.__NEXT_OPTIMIZE_ROUTER_SCROLL':\n-      config.experimental.optimizeRouterScrolling ?? false,\n     'process.env.__NEXT_REACT_DEBUG_CHANNEL':\n       config.experimental.reactDebugChannel ?? false,\n   }"
        },
        {
            "sha": "c6cc5f80a1f7944591311412162a4b19c960a6a1",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/36bff1060eef4f6d0a8a9ad408be66489a276cc4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/36bff1060eef4f6d0a8a9ad408be66489a276cc4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=36bff1060eef4f6d0a8a9ad408be66489a276cc4",
            "patch": "@@ -525,7 +525,6 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n             }),\n           ])\n           .optional(),\n-        optimizeRouterScrolling: z.boolean().optional(),\n       })\n       .optional(),\n     exportPathMap: z"
        },
        {
            "sha": "3c867a20e320fce046c6ca91779f1bf0da46033f",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/36bff1060eef4f6d0a8a9ad408be66489a276cc4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/36bff1060eef4f6d0a8a9ad408be66489a276cc4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=36bff1060eef4f6d0a8a9ad408be66489a276cc4",
            "patch": "@@ -826,15 +826,6 @@ export interface ExperimentalConfig {\n         showSourceLocation?: boolean\n       }\n \n-  /**\n-   * When enabled, will only opt-in to special smooth scroll handling when\n-   * data-scroll-behavior=\"smooth\" is present on the <html> element.\n-   * This will be the default, non-configurable behavior in the next major version.\n-   *\n-   * @default false\n-   */\n-  optimizeRouterScrolling?: boolean\n-\n   /**\n    * Enable accessing root params via the `next/root-params` module.\n    */\n@@ -1521,7 +1512,6 @@ export const defaultConfig = Object.freeze({\n     slowModuleDetection: undefined,\n     globalNotFound: false,\n     browserDebugInfoInTerminal: false,\n-    optimizeRouterScrolling: false,\n     isolatedDevBuild: false,\n   },\n   htmlLimitedBots: undefined,"
        },
        {
            "sha": "0fd4d7ffbb6c2101f9f5f43ceb23af26da7d4ec0",
            "filename": "packages/next/src/shared/lib/router/utils/disable-smooth-scroll.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 16,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/36bff1060eef4f6d0a8a9ad408be66489a276cc4/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fdisable-smooth-scroll.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/36bff1060eef4f6d0a8a9ad408be66489a276cc4/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fdisable-smooth-scroll.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fdisable-smooth-scroll.ts?ref=36bff1060eef4f6d0a8a9ad408be66489a276cc4",
            "patch": "@@ -18,31 +18,21 @@ export function disableSmoothScrollDuringRouteTransition(\n   const htmlElement = document.documentElement\n   const hasDataAttribute = htmlElement.dataset.scrollBehavior === 'smooth'\n \n-  // Since this is a breaking change, this is temporarily flagged\n-  // and will be false by default.\n-  // In the next major (v16), this will be automatically enabled\n-  if (process.env.__NEXT_OPTIMIZE_ROUTER_SCROLL) {\n-    if (!hasDataAttribute) {\n-      // No smooth scrolling configured, run directly without style manipulation\n-      fn()\n-      return\n-    }\n-  } else {\n-    // Old behavior: always manipulate styles, but warn about upcoming change\n-\n+  if (!hasDataAttribute) {\n     // Warn if smooth scrolling is detected but no data attribute is present\n     if (\n       process.env.NODE_ENV === 'development' &&\n-      !hasDataAttribute &&\n       getComputedStyle(htmlElement).scrollBehavior === 'smooth'\n     ) {\n       warnOnce(\n-        'Detected `scroll-behavior: smooth` on the `<html>` element. In a future version, ' +\n-          'Next.js will no longer automatically disable smooth scrolling during route transitions. ' +\n-          'To prepare for this change, add `data-scroll-behavior=\"smooth\"` to your <html> element. ' +\n+        'Detected `scroll-behavior: smooth` on the `<html>` element. To disable smooth scrolling during route transitions, ' +\n+          'add `data-scroll-behavior=\"smooth\"` to your <html> element. ' +\n           'Learn more: https://nextjs.org/docs/messages/missing-data-scroll-behavior'\n       )\n     }\n+    // No smooth scrolling configured, run directly without style manipulation\n+    fn()\n+    return\n   }\n \n   // Proceed with temporarily disabling smooth scrolling"
        },
        {
            "sha": "3e663f0b339c3e9bd53eca378204716994c2dbe7",
            "filename": "test/e2e/app-dir/router-disable-smooth-scroll/router-disable-smooth-scroll.legacy.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 143,
            "changes": 143,
            "blob_url": "https://github.com/vercel/next.js/blob/3c42dfb313e45d58bfc21ed3db6b173f078153fb/test%2Fe2e%2Fapp-dir%2Frouter-disable-smooth-scroll%2Frouter-disable-smooth-scroll.legacy.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c42dfb313e45d58bfc21ed3db6b173f078153fb/test%2Fe2e%2Fapp-dir%2Frouter-disable-smooth-scroll%2Frouter-disable-smooth-scroll.legacy.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frouter-disable-smooth-scroll%2Frouter-disable-smooth-scroll.legacy.test.ts?ref=3c42dfb313e45d58bfc21ed3db6b173f078153fb",
            "patch": "@@ -1,143 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import { retry } from 'next-test-utils'\n-\n-describe('router smooth scroll optimization (legacy)', () => {\n-  const { next, isNextDev } = nextTestSetup({\n-    files: __dirname + '/fixtures/legacy',\n-    nextConfig: {\n-      experimental: {\n-        optimizeRouterScrolling: false,\n-      },\n-    },\n-  })\n-\n-  const getTopScroll = async (browser: any) =>\n-    await browser.eval('document.documentElement.scrollTop')\n-\n-  const waitForScrollToComplete = async (browser: any, expectedY: number) => {\n-    await retry(async () => {\n-      const top = await getTopScroll(browser)\n-      expect(top).toBe(expectedY)\n-    })\n-  }\n-\n-  const scrollTo = async (browser: any, y: number) => {\n-    await browser.eval(`window.scrollTo(0, ${y})`)\n-    // Add a small delay for scroll to complete\n-    await browser.eval('new Promise(resolve => setTimeout(resolve, 100))')\n-    await waitForScrollToComplete(browser, y)\n-  }\n-\n-  it('should work with smooth scroll CSS and warn in development', async () => {\n-    const browser = await next.browser('/page1')\n-\n-    await scrollTo(browser, 1000)\n-    expect(await getTopScroll(browser)).toBe(1000)\n-\n-    // Wait for page to be rendered\n-    await browser.waitForElementByCss('#to-page2')\n-\n-    // Click navigation and wait for new page to load\n-    await browser.elementByCss('#to-page2').click()\n-\n-    // Wait for the new page to load completely\n-    await browser.waitForElementByCss('h1')\n-    await retry(async () => {\n-      const text = await browser.elementByCss('h1').text()\n-      expect(text).toBe('Legacy Page 2')\n-    })\n-\n-    await waitForScrollToComplete(browser, 0)\n-\n-    // In legacy mode, all smooth scroll usage should warn in dev mode\n-    await retry(async () => {\n-      const logs = await browser.log()\n-      const hasWarning = logs.some((log) =>\n-        log.message.includes(\n-          'Detected `scroll-behavior: smooth` on the `<html>` element. In a future version'\n-        )\n-      )\n-\n-      if (isNextDev) {\n-        expect(hasWarning).toBe(true)\n-      } else {\n-        expect(hasWarning).toBe(false)\n-      }\n-    })\n-  })\n-})\n-\n-describe('router smooth scroll optimization (legacy with data attribute)', () => {\n-  const { next, isNextDev: _isNextDev } = nextTestSetup({\n-    files: __dirname + '/fixtures/legacy-with-data',\n-    nextConfig: {\n-      experimental: {\n-        optimizeRouterScrolling: false,\n-      },\n-    },\n-  })\n-\n-  const getTopScroll = async (browser: any) =>\n-    await browser.eval('document.documentElement.scrollTop')\n-\n-  const waitForScrollToComplete = async (browser: any, expectedY: number) => {\n-    await retry(async () => {\n-      const top = await getTopScroll(browser)\n-      expect(top).toBe(expectedY)\n-    })\n-  }\n-\n-  const scrollTo = async (browser: any, y: number) => {\n-    await browser.eval(`window.scrollTo(0, ${y})`)\n-    // Add a small delay for scroll to complete\n-    await browser.eval('new Promise(resolve => setTimeout(resolve, 100))')\n-    await waitForScrollToComplete(browser, y)\n-  }\n-\n-  it('should not warn when data attribute is present even in legacy mode', async () => {\n-    const browser = await next.browser('/page1')\n-\n-    // Verify both CSS and data attribute are present\n-    const scrollBehavior = await browser.eval(\n-      'getComputedStyle(document.documentElement).scrollBehavior'\n-    )\n-    expect(scrollBehavior).toBe('smooth')\n-\n-    const hasDataAttribute = await browser.eval(\n-      'document.documentElement.dataset.scrollBehavior === \"smooth\"'\n-    )\n-    expect(hasDataAttribute).toBe(true)\n-\n-    await scrollTo(browser, 1000)\n-    expect(await getTopScroll(browser)).toBe(1000)\n-\n-    // Wait for page to be rendered\n-    await browser.waitForElementByCss('#to-page2')\n-\n-    // Click navigation and wait for new page to load\n-    await browser.elementByCss('#to-page2').click()\n-\n-    // Wait for the new page to load completely\n-    await browser.waitForElementByCss('h1')\n-    await retry(async () => {\n-      const text = await browser.elementByCss('h1').text()\n-      expect(text).toBe('Legacy Page 2')\n-    })\n-\n-    await waitForScrollToComplete(browser, 0)\n-\n-    // Both legacy and optimized modes respect the data attribute for warnings\n-    // The difference is in when style manipulation occurs, not when warnings appear\n-    await retry(async () => {\n-      const logs = await browser.log()\n-      const hasWarning = logs.some((log) =>\n-        log.message.includes(\n-          'Detected `scroll-behavior: smooth` on the `<html>` element. In a future version'\n-        )\n-      )\n-\n-      // No warning should appear when data attribute is present\n-      expect(hasWarning).toBe(false)\n-    })\n-  })\n-})"
        },
        {
            "sha": "66a82a1c625d0a49b9ae6c38d5276c20cac21007",
            "filename": "test/e2e/app-dir/router-disable-smooth-scroll/router-disable-smooth-scroll.optimized.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 18,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/36bff1060eef4f6d0a8a9ad408be66489a276cc4/test%2Fe2e%2Fapp-dir%2Frouter-disable-smooth-scroll%2Frouter-disable-smooth-scroll.optimized.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/36bff1060eef4f6d0a8a9ad408be66489a276cc4/test%2Fe2e%2Fapp-dir%2Frouter-disable-smooth-scroll%2Frouter-disable-smooth-scroll.optimized.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frouter-disable-smooth-scroll%2Frouter-disable-smooth-scroll.optimized.test.ts?ref=36bff1060eef4f6d0a8a9ad408be66489a276cc4",
            "patch": "@@ -1,14 +1,9 @@\n import { nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n \n-describe('router smooth scroll optimization (optimized)', () => {\n+describe('router smooth scroll optimization', () => {\n   const { next } = nextTestSetup({\n     files: __dirname + '/fixtures/optimized',\n-    nextConfig: {\n-      experimental: {\n-        optimizeRouterScrolling: true,\n-      },\n-    },\n   })\n \n   const getTopScroll = async (browser: any) =>\n@@ -55,7 +50,7 @@ describe('router smooth scroll optimization (optimized)', () => {\n       expect(\n         logs.some((log) =>\n           log.message.includes(\n-            'Detected `scroll-behavior: smooth` on the `<html>` element. In a future version'\n+            'Detected `scroll-behavior: smooth` on the `<html>` element.'\n           )\n         )\n       ).toBe(false)\n@@ -64,13 +59,8 @@ describe('router smooth scroll optimization (optimized)', () => {\n })\n \n describe('router smooth scroll optimization (optimized early exit)', () => {\n-  const { next } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname + '/fixtures/optimized-no-data',\n-    nextConfig: {\n-      experimental: {\n-        optimizeRouterScrolling: true,\n-      },\n-    },\n   })\n \n   const getTopScroll = async (browser: any) =>\n@@ -90,7 +80,7 @@ describe('router smooth scroll optimization (optimized early exit)', () => {\n     await waitForScrollToComplete(browser, y)\n   }\n \n-  it('should exit early when CSS smooth scroll detected but no data attribute', async () => {\n+  it('should warn in dev when CSS smooth scroll detected but no data attribute', async () => {\n     const browser = await next.browser('/page1')\n \n     // Verify CSS smooth scrolling is present\n@@ -123,17 +113,16 @@ describe('router smooth scroll optimization (optimized early exit)', () => {\n \n     await waitForScrollToComplete(browser, 0)\n \n-    // No warning should appear in optimized mode even with CSS smooth scroll\n-    // because the function exits early when no data attribute is present\n+    const shouldWarn = isNextDev\n     await retry(async () => {\n       const logs = await browser.log()\n       expect(\n         logs.some((log) =>\n           log.message.includes(\n-            'Detected `scroll-behavior: smooth` on the `<html>` element. In a future version'\n+            'Detected `scroll-behavior: smooth` on the `<html>` element.'\n           )\n         )\n-      ).toBe(false)\n+      ).toBe(shouldWarn)\n     })\n   })\n })"
        }
    ],
    "stats": {
        "total": 226,
        "additions": 15,
        "deletions": 211
    }
}