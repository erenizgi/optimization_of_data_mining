{
    "author": "gnoff",
    "message": "[dynamicIO] Do not skip dynamic validation when metadata is dynamic (#78574)\n\nMetadata can be dynamic without that being an error. A bug was\nintroduced in a recent refactor where the presence of dynamic metadata\nwas incorrectly interpreted as a sign that the metadata did not have a\nSuspense boundary around it. This would be a problem because metadata is\nnow streaming however it was actually a misuse of the tracking flag and\nwould incorrectly error if you had dynamic metadata at all. This fix\naddresses the incorrect invariant by removing it.\n\nthere is arguably a second bug here in that InvariantError causes the\nvalidation of the page to be skipped but it doesn't error the build.\nThat is concerning but not the focus of this change. regardless by\nremoving the incorrect invariant error code the validation begins to\nwork again as expected.",
    "sha": "6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe",
    "files": [
        {
            "sha": "928439f5e6d8ae3ff619613fd58a0061cd4312c0",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe",
            "patch": "@@ -42,7 +42,6 @@ import {\n   OUTLET_BOUNDARY_NAME,\n } from '../../lib/metadata/metadata-constants'\n import { scheduleOnNextTick } from '../../lib/scheduler'\n-import { InvariantError } from '../../shared/lib/invariant-error'\n \n const hasPostpone = typeof React.unstable_postpone === 'function'\n \n@@ -653,15 +652,6 @@ export function throwIfDisallowedEmptyStaticShell(\n   serverDynamic: DynamicTrackingState,\n   clientDynamic: DynamicTrackingState\n ): void {\n-  // TODO: Now that metadata is streaming we don't really need to check if it is blocking\n-  // the root. We leave this here for now to ensure we've actually covered all our bases here\n-  // but we can actually remove this in a future update\n-  if (dynamicValidation.hasDynamicMetadata) {\n-    throw new InvariantError(\n-      'Expected `generateMetadata` not to block the application shell but it did.'\n-    )\n-  }\n-\n   if (dynamicValidation.hasSuspenseAboveBody) {\n     // This route has opted into allowing fully dynamic rendering\n     // by including a Suspense boundary above the body. In this case"
        },
        {
            "sha": "c3a0a652b9990c2d286d2359b22a9c1563ab057e",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe",
            "patch": "@@ -87,6 +87,48 @@ function runTests(options: { withMinification: boolean }) {\n         expect($('#sentinel').text()).toBe('sentinel')\n       })\n     })\n+    describe('Dynamic Metadata - Error Route', () => {\n+      const { next, isNextDev, skipped } = nextTestSetup({\n+        files: __dirname + '/fixtures/dynamic-metadata-error-route',\n+        skipStart: true,\n+        skipDeployment: true,\n+      })\n+\n+      if (skipped) {\n+        return\n+      }\n+\n+      if (isNextDev) {\n+        it('does not run in dev', () => {})\n+        return\n+      }\n+\n+      beforeEach(async () => {\n+        if (!withMinification) {\n+          await next.patchFile('next.config.js', (content) =>\n+            content.replace(\n+              'serverMinification: true,',\n+              'serverMinification: false,'\n+            )\n+          )\n+        }\n+      })\n+\n+      // This test is just here because there was a bug when dynamic metadata was used alongside another dynamic IO violation which caused the validation to be skipped.\n+      it('should error the build for the correct reason when there is a dynamic IO violation alongside dynamic metadata', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n+        }\n+        const expectError = createExpectError(next.cliOutput)\n+\n+        expectError(\n+          'Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary'\n+        )\n+        expectError('Error occurred prerendering page \"/\"')\n+      })\n+    })\n     describe('Dynamic Metadata - Static Route With Suspense', () => {\n       const { next, isNextDev, skipped } = nextTestSetup({\n         files: __dirname + '/fixtures/dynamic-metadata-static-with-suspense',"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-metadata-error-route/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fapp%2Flayout.tsx?ref=6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "833020f4a1bab6bff1a69c4e781ecfd660cf4a16",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-metadata-error-route/app/page.tsx",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fapp%2Fpage.tsx?ref=6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe",
            "patch": "@@ -0,0 +1,23 @@\n+export async function generateMetadata() {\n+  await new Promise((r) => setTimeout(r, 0))\n+  return { title: 'Dynamic Metadata' }\n+}\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page has dynamic metadata and is also dynamic in the page without a\n+        Suspense boundary. This is violation of dynamic IO rules. This test\n+        exists however because there was previously a bug that would incorrectly\n+        report this as an invariant error.\n+      </p>\n+      <Dynamic />\n+    </>\n+  )\n+}\n+\n+async function Dynamic() {\n+  await new Promise((r) => setTimeout(r))\n+  return <p id=\"dynamic\">Dynamic</p>\n+}"
        },
        {
            "sha": "b23633baadc7b7b8b37f9cf65d34c35c3f090adb",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/dynamic-metadata-error-route/next.config.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdynamic-metadata-error-route%2Fnext.config.js?ref=6b6782bcd6dd735e24eaa24cb49e1e7df38bd4fe",
            "patch": "@@ -0,0 +1,12 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    ppr: process.env.__NEXT_EXPERIMENTAL_PPR === 'true',\n+    dynamicIO: true,\n+    serverMinification: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 86,
        "deletions": 10
    }
}