{
    "author": "huozhi",
    "message": "[metadata] use generateStaticParams for getImageMetadata (#83374)",
    "sha": "82cfc5efff9e81158a08b15ae68a7ca53e96af2f",
    "files": [
        {
            "sha": "0f8c3d0fcc6f9f6cb958a1061dc45e4dfd0c40ba",
            "filename": "crates/next-core/src/next_app/metadata/image.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fimage.rs?ref=82cfc5efff9e81158a08b15ae68a7ca53e96af2f",
            "patch": "@@ -93,7 +93,7 @@ async fn dynamic_image_metadata_with_generator_source(\n \n                 const imageMetadataArray = await generateImageMetadata({{ params }})\n                 return imageMetadataArray.map((imageMetadata, index) => {{\n-                    const idParam = (imageMetadata.id || index) + ''\n+                    const idParam = imageMetadata.id + ''\n                     return getImageMetadata(imageMetadata, idParam)\n                 }})\n             }}"
        },
        {
            "sha": "99bbe0ba95c748f140baefee1c3a1adca2ee5473",
            "filename": "crates/next-core/src/next_app/metadata/route.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 2,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs?ref=82cfc5efff9e81158a08b15ae68a7ca53e96af2f",
            "patch": "@@ -48,7 +48,7 @@ pub async fn get_app_metadata_route_source(\n             } else if stem == \"sitemap\" {\n                 dynamic_site_map_route_source(mode, path, is_multi_dynamic)\n             } else {\n-                dynamic_image_route_source(path, is_multi_dynamic)\n+                dynamic_image_route_source(mode, path, is_multi_dynamic)\n             }\n         }\n     })\n@@ -371,12 +371,31 @@ async fn dynamic_site_map_route_source(\n }\n \n async fn dynamic_image_route_with_metadata_source(\n+    mode: NextMode,\n     path: FileSystemPath,\n ) -> Result<Vc<Box<dyn Source>>> {\n     let stem = path.file_stem();\n     let stem = stem.unwrap_or_default();\n     let ext = path.extension();\n \n+    let mut static_generation_code = \"\";\n+\n+    if mode.is_production() {\n+        static_generation_code = indoc! {\n+            r#\"\n+                export async function generateStaticParams({ params }) {\n+                    const imageMetadata = await generateImageMetadata({ params })\n+                    const staticParams = []\n+\n+                    for (const item of imageMetadata) {\n+                        staticParams.push({ __metadata_id__: item.id.toString() })\n+                    }\n+                    return staticParams\n+                }\n+            \"#,\n+        };\n+    }\n+\n     let code = formatdoc! {\n         r#\"\n             import {{ NextResponse }} from 'next/server'\n@@ -417,8 +436,11 @@ async fn dynamic_image_route_with_metadata_source(\n             }}\n \n             export * from {resource_path}\n+\n+            {static_generation_code}\n         \"#,\n         resource_path = StringifyJs(&format!(\"./{stem}.{ext}\")),\n+        static_generation_code = static_generation_code,\n     };\n \n     let file = File::from(code);\n@@ -466,11 +488,12 @@ async fn dynamic_image_route_without_metadata_source(\n \n #[turbo_tasks::function]\n async fn dynamic_image_route_source(\n+    mode: NextMode,\n     path: FileSystemPath,\n     is_multi_dynamic: bool,\n ) -> Result<Vc<Box<dyn Source>>> {\n     if is_multi_dynamic {\n-        dynamic_image_route_with_metadata_source(path).await\n+        dynamic_image_route_with_metadata_source(mode, path).await\n     } else {\n         dynamic_image_route_without_metadata_source(path).await\n     }"
        },
        {
            "sha": "f0c27fd49e1e29a6f2ac3a47c6543de2c79b8428",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-image-loader.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts?ref=82cfc5efff9e81158a08b15ae68a7ca53e96af2f",
            "patch": "@@ -90,9 +90,9 @@ async function nextMetadataImageLoader(\n       const data = {\n         alt: imageMetadata.alt,\n         type: imageMetadata.contentType || 'image/png',\n-        url: imageUrl + (idParam ? ('/' + idParam) : '') + ${JSON.stringify(\n-          hashQuery\n-        )},\n+      url: imageUrl + (idParam ? ('/' + idParam) : '') + ${JSON.stringify(\n+        hashQuery\n+      )},\n       }\n       const { size } = imageMetadata\n       if (size) {\n@@ -112,7 +112,7 @@ async function nextMetadataImageLoader(\n       if (generateImageMetadata) {\n         const imageMetadataArray = await generateImageMetadata({ params: resolvedParams })\n         return imageMetadataArray.map((imageMetadata, index) => {\n-          const idParam = (imageMetadata.id || index) + ''\n+          const idParam = imageMetadata.id + ''\n           return getImageMetadata(imageMetadata, idParam, resolvedParams)\n         })\n       } else {"
        },
        {
            "sha": "14e9c49d2248db90c0e34358d6243472fa2449b2",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-route-loader.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts?ref=82cfc5efff9e81158a08b15ae68a7ca53e96af2f",
            "patch": "@@ -157,6 +157,22 @@ async function getDynamicImageRouteCode(\n   resourcePath: string,\n   loaderContext: webpack.LoaderContext<any>\n ) {\n+  let staticGenerationCode = ''\n+\n+  if (process.env.NODE_ENV === 'production') {\n+    staticGenerationCode = `\\\n+export async function generateStaticParams({ params }) {\n+  const imageMetadata = await generateImageMetadata({ params })\n+  const staticParams = []\n+\n+  for (const item of imageMetadata) {\n+    staticParams.push({ __metadata_id__: item.id.toString() })\n+  }\n+  return staticParams\n+}\n+`\n+  }\n+\n   return `\\\n /* dynamic image route with generateImageMetadata */\n import { NextResponse } from 'next/server'\n@@ -186,6 +202,8 @@ export async function GET(_, ctx) {\n \n   return handler({ params: restParams, id })\n }\n+\n+${staticGenerationCode}\n `\n }\n "
        },
        {
            "sha": "380da2f14d0562290d9f856bda329560d4dbe7e8",
            "filename": "test/e2e/app-dir/metadata-dynamic-routes/app/(group)/dynamic/[size]/apple-icon.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Fapple-icon.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Fapple-icon.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Fapple-icon.tsx?ref=82cfc5efff9e81158a08b15ae68a7ca53e96af2f",
            "patch": "@@ -1,15 +1,16 @@\n import { ImageResponse } from 'next/og'\n \n-// without id\n export async function generateImageMetadata({ params }) {\n   return [\n     {\n       contentType: 'image/png',\n       size: { width: 48, height: 48 },\n+      id: '0',\n     },\n     {\n       contentType: 'image/png',\n       size: { width: 64, height: 64 },\n+      id: '1',\n     },\n   ]\n }"
        },
        {
            "sha": "58b57a1b98e9c589b662414ffc9db499872674e2",
            "filename": "test/e2e/app-dir/metadata-dynamic-routes/index.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/82cfc5efff9e81158a08b15ae68a7ca53e96af2f/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts?ref=82cfc5efff9e81158a08b15ae68a7ca53e96af2f",
            "patch": "@@ -522,6 +522,8 @@ describe('app dir - metadata dynamic routes', () => {\n          \"/blog\",\n          \"/client-ref-dependency/sitemap.xml\",\n          \"/gsp\",\n+         \"/gsp/icon/medium\",\n+         \"/gsp/icon/small\",\n          \"/gsp/sitemap/child0.xml\",\n          \"/gsp/sitemap/child1.xml\",\n          \"/gsp/sitemap/child2.xml\",\n@@ -530,6 +532,8 @@ describe('app dir - metadata dynamic routes', () => {\n          \"/lang/sitemap.xml\",\n          \"/manifest.webmanifest\",\n          \"/metadata-base/unset\",\n+         \"/metadata-base/unset/opengraph-image2/100\",\n+         \"/metadata-base/unset/opengraph-image2/101\",\n          \"/metadata-base/unset/twitter-image.png\",\n          \"/opengraph-image\",\n          \"/opengraph-image-1ow20b\","
        }
    ],
    "stats": {
        "total": 62,
        "additions": 54,
        "deletions": 8
    }
}