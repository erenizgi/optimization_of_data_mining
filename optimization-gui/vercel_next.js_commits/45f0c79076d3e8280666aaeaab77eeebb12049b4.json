{
    "author": "mischnic",
    "message": "Introduce NextConfigRuntime (#86812)\n\nTo only include the keys we actually at runtime in the server in `required-server-files.json` and in `.next/standalone/server.js`\r\n\r\nThere is some chance I missed some property that's needed at runtime (and is incorrectly filtered out by `getNextConfigRuntime`)",
    "sha": "45f0c79076d3e8280666aaeaab77eeebb12049b4",
    "files": [
        {
            "sha": "881b655830c8136919d45b43682455b8e6a6ee4a",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -964,5 +964,6 @@\n   \"963\": \"Fast setImmediate is not available in the edge runtime.\",\n   \"964\": \"An unexpected error occurred while starting to capture immediates\",\n   \"965\": \"Expected setImmediate to reject invalid arguments\",\n-  \"966\": \"Expected process.nextTick to reject invalid arguments\"\n+  \"966\": \"Expected process.nextTick to reject invalid arguments\",\n+  \"967\": \"The key \\\"%s\\\" under \\\"env\\\" in %sconfig is not allowed. https://nextjs.org/docs/messages/env-key-not-allowed\"\n }"
        },
        {
            "sha": "39145ac03820dc90b46f9496ac7ed676af0625c2",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 13,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -1,5 +1,9 @@\n import type { PagesManifest } from './webpack/plugins/pages-manifest-plugin'\n-import type { ExportPathMap, NextConfigComplete } from '../server/config-shared'\n+import type {\n+  ExportPathMap,\n+  NextConfigComplete,\n+  NextConfigRuntime,\n+} from '../server/config-shared'\n import type { MiddlewareManifest } from './webpack/plugins/middleware-plugin'\n import type { ActionManifest } from './webpack/plugins/flight-client-entry-plugin'\n import type { CacheControl, Revalidate } from '../server/lib/cache-control'\n@@ -12,7 +16,7 @@ import { makeRe } from 'next/dist/compiled/picomatch'\n import { existsSync, promises as fs } from 'fs'\n import os from 'os'\n import { Worker } from '../lib/worker'\n-import { defaultConfig } from '../server/config-shared'\n+import { defaultConfig, getNextConfigRuntime } from '../server/config-shared'\n import devalue from 'next/dist/compiled/devalue'\n import findUp from 'next/dist/compiled/find-up'\n import { nanoid } from 'next/dist/compiled/nanoid/index.cjs'\n@@ -605,7 +609,7 @@ async function writeFunctionsConfigManifest(\n \n export interface RequiredServerFilesManifest {\n   version: number\n-  config: NextConfigComplete\n+  config: NextConfigRuntime\n   appDir: string\n   relativeAppDir: string\n   files: string[]\n@@ -2412,8 +2416,6 @@ export default async function build(\n         )\n       }\n \n-      const { cacheHandler } = config\n-\n       const instrumentationHookEntryFiles: string[] = []\n       if (hasInstrumentationHook) {\n         instrumentationHookEntryFiles.push(\n@@ -2437,10 +2439,11 @@ export default async function build(\n       const requiredServerFilesManifest = nextBuildSpan\n         .traceChild('generate-required-server-files')\n         .traceFn(() => {\n-          const normalizedCacheHandlers: Record<string, string> = {}\n+          let runtimeConfig = getNextConfigRuntime(config)\n \n+          const normalizedCacheHandlers: Record<string, string> = {}\n           for (const [key, value] of Object.entries(\n-            config.cacheHandlers || {}\n+            runtimeConfig.cacheHandlers || {}\n           )) {\n             if (key && value) {\n               normalizedCacheHandlers[key] = path.relative(distDir, value)\n@@ -2450,19 +2453,18 @@ export default async function build(\n           const serverFilesManifest: RequiredServerFilesManifest = {\n             version: 1,\n             config: {\n-              ...config,\n-              configFile: undefined,\n+              ...runtimeConfig,\n               ...(ciEnvironment.hasNextSupport\n                 ? {\n                     compress: false,\n                   }\n                 : {}),\n-              cacheHandler: cacheHandler\n-                ? path.relative(distDir, cacheHandler)\n-                : config.cacheHandler,\n+              cacheHandler: runtimeConfig.cacheHandler\n+                ? path.relative(distDir, runtimeConfig.cacheHandler)\n+                : runtimeConfig.cacheHandler,\n               cacheHandlers: normalizedCacheHandlers,\n               experimental: {\n-                ...config.experimental,\n+                ...runtimeConfig.experimental,\n                 trustHostHeader: ciEnvironment.hasNextSupport,\n                 isExperimentalCompile: isCompileMode,\n               },"
        },
        {
            "sha": "d9d75d21a571b99d1ded7240b7222e8577e4cf96",
            "filename": "packages/next/src/build/templates/edge-app-route.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -1,13 +1,13 @@\n import { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\n-import type { NextConfigComplete } from '../../server/config-shared'\n+import type { NextConfigRuntime } from '../../server/config-shared'\n import type { EdgeHandler } from '../../server/web/adapter'\n import { EdgeRouteModuleWrapper } from '../../server/web/edge-route-module-wrapper'\n \n // Import the userland code.\n import * as module from 'VAR_USERLAND'\n \n // injected by the loader afterwards.\n-declare const nextConfig: NextConfigComplete\n+declare const nextConfig: NextConfigRuntime\n // INJECT:nextConfig\n \n const maybeJSONParse = (str?: string) => (str ? JSON.parse(str) : undefined)"
        },
        {
            "sha": "c084441edf283e3a4d9886ad8cabf4c50e7ba6b1",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -8,7 +8,7 @@ import { IncrementalCache } from '../../server/lib/incremental-cache'\n \n import * as pageMod from 'VAR_USERLAND'\n \n-import type { NextConfigComplete } from '../../server/config-shared'\n+import type { NextConfigRuntime } from '../../server/config-shared'\n import { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\n import { initializeCacheHandlers } from '../../server/use-cache/handlers'\n import { BaseServerSpan } from '../../server/lib/trace/constants'\n@@ -29,7 +29,7 @@ import { checkIsOnDemandRevalidate } from '../../server/api-utils'\n import { CloseController } from '../../server/web/web-on-close'\n \n declare const incrementalCacheHandler: any\n-declare const nextConfig: NextConfigComplete\n+declare const nextConfig: NextConfigRuntime\n // OPTIONAL_IMPORT:incrementalCacheHandler\n // INJECT:nextConfig\n "
        },
        {
            "sha": "b68a87cadeafa6b43d0666f8dd8232f554e52e94",
            "filename": "packages/next/src/build/templates/edge-ssr.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -22,7 +22,7 @@ import RouteModule, {\n } from '../../server/route-modules/pages/module'\n import { WebNextRequest, WebNextResponse } from '../../server/base-http/web'\n \n-import type { NextConfigComplete } from '../../server/config-shared'\n+import type { NextConfigRuntime } from '../../server/config-shared'\n import type { NextFetchEvent } from '../../server/web/spec-extension/fetch-event'\n import type RenderResult from '../../server/render-result'\n import type { RenderResultMetadata } from '../../server/render-result'\n@@ -31,7 +31,7 @@ import { BaseServerSpan } from '../../server/lib/trace/constants'\n import { HTML_CONTENT_TYPE_HEADER } from '../../lib/constants'\n \n // injected by the loader afterwards.\n-declare const nextConfig: NextConfigComplete\n+declare const nextConfig: NextConfigRuntime\n declare const pageRouteModuleOptions: any\n declare const errorRouteModuleOptions: any\n declare const user500RouteModuleOptions: any"
        },
        {
            "sha": "7c451c07e52111d00ac3e47cde97913de60502fd",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -1,4 +1,7 @@\n-import type { NextConfigComplete } from '../server/config-shared'\n+import type {\n+  NextConfigComplete,\n+  NextConfigRuntime,\n+} from '../server/config-shared'\n import type { ExperimentalPPRConfig } from '../server/lib/experimental/ppr'\n import { checkIsRoutePPREnabled } from '../server/lib/experimental/ppr'\n import type { AssetBinding } from './webpack/loaders/get-module-build-info'\n@@ -1211,7 +1214,7 @@ export async function copyTracedFiles(\n   pageKeys: readonly string[],\n   appPageKeys: readonly string[] | undefined,\n   tracingRoot: string,\n-  serverConfig: NextConfigComplete,\n+  serverConfig: NextConfigRuntime,\n   middlewareManifest: MiddlewareManifest,\n   hasNodeMiddleware: boolean,\n   hasInstrumentationHook: boolean,"
        },
        {
            "sha": "e1b75c0dcfdcff0244d83c744f7a9762cc4cc33f",
            "filename": "packages/next/src/lib/static-env.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Flib%2Fstatic-env.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Flib%2Fstatic-env.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fstatic-env.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -1,12 +1,18 @@\n-import type { NextConfigComplete } from '../server/config-shared'\n+import type {\n+  NextConfigComplete,\n+  NextConfigRuntime,\n+} from '../server/config-shared'\n \n-function errorIfEnvConflicted(config: NextConfigComplete, key: string) {\n+function errorIfEnvConflicted(\n+  config: NextConfigComplete | NextConfigRuntime,\n+  key: string\n+) {\n   const isPrivateKey = /^(?:NODE_.+)|^(?:__.+)$/i.test(key)\n   const hasNextRuntimeKey = key === 'NEXT_RUNTIME'\n \n   if (isPrivateKey || hasNextRuntimeKey) {\n     throw new Error(\n-      `The key \"${key}\" under \"env\" in ${config.configFileName} is not allowed. https://nextjs.org/docs/messages/env-key-not-allowed`\n+      `The key \"${key}\" under \"env\" in ${config.configFileName || 'config'} is not allowed. https://nextjs.org/docs/messages/env-key-not-allowed`\n     )\n   }\n }\n@@ -31,7 +37,9 @@ export function getNextPublicEnvironmentVariables() {\n /**\n  * Collects the `env` config value from the Next.js config.\n  */\n-export function getNextConfigEnv(config: NextConfigComplete) {\n+export function getNextConfigEnv(\n+  config: NextConfigComplete | NextConfigRuntime\n+) {\n   // Refactored code below to use for-of\n   const defineEnv: Record<string, string | undefined> = {}\n   const env = config.env\n@@ -45,7 +53,7 @@ export function getNextConfigEnv(config: NextConfigComplete) {\n   return defineEnv\n }\n \n-export function getStaticEnv(config: NextConfigComplete) {\n+export function getStaticEnv(config: NextConfigComplete | NextConfigRuntime) {\n   const staticEnv: Record<string, string | undefined> = {\n     ...getNextPublicEnvironmentVariables(),\n     ...getNextConfigEnv(config),\n@@ -54,7 +62,9 @@ export function getStaticEnv(config: NextConfigComplete) {\n   return staticEnv\n }\n \n-export function populateStaticEnv(config: NextConfigComplete) {\n+export function populateStaticEnv(\n+  config: NextConfigComplete | NextConfigRuntime\n+) {\n   // since inlining comes after static generation we need\n   // to ensure this value is assigned to process env so it\n   // can still be accessed"
        },
        {
            "sha": "97e88238ac0cc01dc301b7a2bc0641a64073081e",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -5,7 +5,7 @@ import type {\n } from './load-components'\n import type { MiddlewareRouteMatch } from '../shared/lib/router/utils/middleware-route-matcher'\n import type { Params } from './request/params'\n-import type { NextConfig, NextConfigComplete } from './config-shared'\n+import type { NextConfig, NextConfigRuntime } from './config-shared'\n import type {\n   NextParsedUrlQuery,\n   NextUrlWithParsedQuery,\n@@ -311,7 +311,7 @@ export default abstract class Server<\n   public readonly port?: number\n   protected readonly dir: string\n   protected readonly quiet: boolean\n-  protected readonly nextConfig: NextConfigComplete\n+  protected readonly nextConfig: NextConfigRuntime\n   protected readonly distDir: string\n   protected readonly publicDir: string\n   protected readonly hasStaticDir: boolean\n@@ -446,7 +446,7 @@ export default abstract class Server<\n \n     // TODO: should conf be normalized to prevent missing\n     // values from causing issues as this can be user provided\n-    this.nextConfig = conf as NextConfigComplete\n+    this.nextConfig = conf as NextConfigRuntime\n     this.hostname = hostname\n     if (this.hostname) {\n       // we format the hostname so that it can be fetched"
        },
        {
            "sha": "ba598c124481c376da67820718056579127a7917",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 180,
            "deletions": 0,
            "changes": 180,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -1571,3 +1571,183 @@ export async function normalizeConfig(phase: string, config: any) {\n   // Support `new Promise` and `async () =>` as return values of the config export\n   return await config\n }\n+\n+// This should be a supertype of NextConfigComplete\n+//\n+// The Vercel builder needs these fields (read `config` in required-server-files.json)\n+// {\n+//   pageExtensions: string[];\n+//   experimental?: {\n+//     cacheComponents?: boolean;\n+//     clientParamParsingOrigins?: string[];\n+//     clientSegmentCache?: boolean;\n+//     ppr?: boolean | 'incremental';\n+//     serverActions?: Record<string, never>;\n+//   };\n+// };\n+export interface NextConfigRuntime {\n+  // TODO remove in some cases\n+  deploymentId: NextConfigComplete['deploymentId']\n+\n+  configFileName?: string\n+  // Should only be included when using isExperimentalCompile\n+  env?: NextConfigComplete['env']\n+\n+  distDir: NextConfigComplete['distDir']\n+  cacheComponents: NextConfigComplete['cacheComponents']\n+  htmlLimitedBots: NextConfigComplete['htmlLimitedBots']\n+  assetPrefix: NextConfigComplete['assetPrefix']\n+  output: NextConfigComplete['output']\n+  crossOrigin: NextConfigComplete['crossOrigin']\n+  trailingSlash: NextConfigComplete['trailingSlash']\n+  images: NextConfigComplete['images']\n+  reactMaxHeadersLength: NextConfigComplete['reactMaxHeadersLength']\n+  cacheLife: NextConfigComplete['cacheLife']\n+  basePath: NextConfigComplete['basePath']\n+  expireTime: NextConfigComplete['expireTime']\n+  generateEtags: NextConfigComplete['generateEtags']\n+  poweredByHeader: NextConfigComplete['poweredByHeader']\n+  cacheHandler: NextConfigComplete['cacheHandler']\n+  cacheHandlers: NextConfigComplete['cacheHandlers']\n+  cacheMaxMemorySize: NextConfigComplete['cacheMaxMemorySize']\n+  compress: NextConfigComplete['compress']\n+  i18n: NextConfigComplete['i18n']\n+  httpAgentOptions: NextConfigComplete['httpAgentOptions']\n+  skipProxyUrlNormalize: NextConfigComplete['skipProxyUrlNormalize']\n+  pageExtensions: NextConfigComplete['pageExtensions']\n+  useFileSystemPublicRoutes: NextConfigComplete['useFileSystemPublicRoutes']\n+\n+  experimental: Pick<\n+    NextConfigComplete['experimental'],\n+    | 'ppr'\n+    | 'taint'\n+    | 'serverActions'\n+    | 'staleTimes'\n+    | 'dynamicOnHover'\n+    | 'inlineCss'\n+    | 'authInterrupts'\n+    | 'clientTraceMetadata'\n+    | 'clientParamParsingOrigins'\n+    | 'adapterPath'\n+    | 'allowedRevalidateHeaderKeys'\n+    | 'fetchCacheKeyPrefix'\n+    | 'isrFlushToDisk'\n+    | 'optimizeCss'\n+    | 'nextScriptWorkers'\n+    | 'disableOptimizedLoading'\n+    | 'largePageDataBytes'\n+    | 'serverComponentsHmrCache'\n+    | 'caseSensitiveRoutes'\n+    | 'validateRSCRequestHeaders'\n+    | 'sri'\n+    | 'useSkewCookie'\n+    | 'preloadEntriesOnStart'\n+    | 'hideLogsAfterAbort'\n+    | 'removeUncaughtErrorAndRejectionListeners'\n+    | 'imgOptConcurrency'\n+    | 'imgOptMaxInputPixels'\n+    | 'imgOptSequentialRead'\n+    | 'imgOptSkipMetadata'\n+    | 'imgOptTimeoutInSeconds'\n+    | 'proxyClientMaxBodySize'\n+    | 'proxyTimeout'\n+    | 'testProxy'\n+  > & {\n+    // Pick on @internal fields generates invalid .d.ts files\n+    /** @internal */\n+    trustHostHeader?: NextConfigComplete['experimental']['trustHostHeader']\n+    /** @internal */\n+    isExperimentalCompile?: NextConfigComplete['experimental']['isExperimentalCompile']\n+  }\n+}\n+\n+export function getNextConfigRuntime(\n+  config: NextConfigComplete | NextConfigRuntime\n+): NextConfigRuntime {\n+  let ex = config.experimental\n+\n+  type Requiredish<T> = {\n+    [K in keyof Required<T>]: T[K]\n+  }\n+\n+  let experimental = ex\n+    ? ({\n+        ppr: ex.ppr,\n+        taint: ex.taint,\n+        serverActions: ex.serverActions,\n+        staleTimes: ex.staleTimes,\n+        dynamicOnHover: ex.dynamicOnHover,\n+        inlineCss: ex.inlineCss,\n+        authInterrupts: ex.authInterrupts,\n+        clientTraceMetadata: ex.clientTraceMetadata,\n+        clientParamParsingOrigins: ex.clientParamParsingOrigins,\n+        adapterPath: ex.adapterPath,\n+        allowedRevalidateHeaderKeys: ex.allowedRevalidateHeaderKeys,\n+        fetchCacheKeyPrefix: ex.fetchCacheKeyPrefix,\n+        isrFlushToDisk: ex.isrFlushToDisk,\n+        optimizeCss: ex.optimizeCss,\n+        nextScriptWorkers: ex.nextScriptWorkers,\n+        disableOptimizedLoading: ex.disableOptimizedLoading,\n+        largePageDataBytes: ex.largePageDataBytes,\n+        serverComponentsHmrCache: ex.serverComponentsHmrCache,\n+        caseSensitiveRoutes: ex.caseSensitiveRoutes,\n+        validateRSCRequestHeaders: ex.validateRSCRequestHeaders,\n+        sri: ex.sri,\n+        useSkewCookie: ex.useSkewCookie,\n+        preloadEntriesOnStart: ex.preloadEntriesOnStart,\n+        hideLogsAfterAbort: ex.hideLogsAfterAbort,\n+        removeUncaughtErrorAndRejectionListeners:\n+          ex.removeUncaughtErrorAndRejectionListeners,\n+        imgOptConcurrency: ex.imgOptConcurrency,\n+        imgOptMaxInputPixels: ex.imgOptMaxInputPixels,\n+        imgOptSequentialRead: ex.imgOptSequentialRead,\n+        imgOptSkipMetadata: ex.imgOptSkipMetadata,\n+        imgOptTimeoutInSeconds: ex.imgOptTimeoutInSeconds,\n+        proxyClientMaxBodySize: ex.proxyClientMaxBodySize,\n+        proxyTimeout: ex.proxyTimeout,\n+        testProxy: ex.testProxy,\n+\n+        trustHostHeader: ex.trustHostHeader,\n+        isExperimentalCompile: ex.isExperimentalCompile,\n+      } satisfies Requiredish<NextConfigRuntime['experimental']>)\n+    : {}\n+\n+  let runtimeConfig: Requiredish<NextConfigRuntime> = {\n+    deploymentId: config.deploymentId,\n+\n+    configFileName: undefined,\n+    env: undefined,\n+\n+    distDir: config.distDir,\n+    cacheComponents: config.cacheComponents,\n+    htmlLimitedBots: config.htmlLimitedBots,\n+    assetPrefix: config.assetPrefix,\n+    output: config.output,\n+    crossOrigin: config.crossOrigin,\n+    trailingSlash: config.trailingSlash,\n+    images: config.images,\n+    reactMaxHeadersLength: config.reactMaxHeadersLength,\n+    cacheLife: config.cacheLife,\n+    basePath: config.basePath,\n+    expireTime: config.expireTime,\n+    generateEtags: config.generateEtags,\n+    poweredByHeader: config.poweredByHeader,\n+    cacheHandler: config.cacheHandler,\n+    cacheHandlers: config.cacheHandlers,\n+    cacheMaxMemorySize: config.cacheMaxMemorySize,\n+    compress: config.compress,\n+    i18n: config.i18n,\n+    httpAgentOptions: config.httpAgentOptions,\n+    skipProxyUrlNormalize: config.skipProxyUrlNormalize,\n+    pageExtensions: config.pageExtensions,\n+    useFileSystemPublicRoutes: config.useFileSystemPublicRoutes,\n+\n+    experimental,\n+  }\n+\n+  if (config.experimental.isExperimentalCompile) {\n+    runtimeConfig.env = config.env\n+  }\n+\n+  return runtimeConfig\n+}"
        },
        {
            "sha": "3392926b5cbdddb25616674c90509c65fe1d581d",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 31,
            "deletions": 10,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -9,13 +9,15 @@ import {\n   PHASE_DEVELOPMENT_SERVER,\n   PHASE_EXPORT,\n   PHASE_PRODUCTION_BUILD,\n+  type PHASE_PRODUCTION_SERVER,\n   type PHASE_TYPE,\n } from '../shared/lib/constants'\n import { defaultConfig, normalizeConfig } from './config-shared'\n import type {\n   ExperimentalConfig,\n   NextConfigComplete,\n   NextConfig,\n+  NextConfigRuntime,\n } from './config-shared'\n \n import { loadWebpackHook } from './config-utils'\n@@ -1411,6 +1413,34 @@ function getCacheKey(\n \n   return djb2Hash(keyData).toString(36)\n }\n+\n+type LoadConfigOptions = {\n+  customConfig?: object | null\n+  rawConfig?: boolean\n+  silent?: boolean\n+  reportExperimentalFeatures?: (\n+    configuredExperimentalFeatures: ConfiguredExperimentalFeature[]\n+  ) => void\n+  reactProductionProfiling?: boolean\n+  debugPrerender?: boolean\n+}\n+\n+export default async function loadConfig(\n+  phase: typeof PHASE_DEVELOPMENT_SERVER,\n+  dir: string,\n+  opts?: LoadConfigOptions\n+): Promise<NextConfigComplete>\n+export default async function loadConfig(\n+  phase: typeof PHASE_PRODUCTION_SERVER | typeof PHASE_DEVELOPMENT_SERVER,\n+  dir: string,\n+  opts?: LoadConfigOptions\n+): Promise<NextConfigRuntime | NextConfigComplete>\n+export default async function loadConfig(\n+  phase: PHASE_TYPE,\n+  dir: string,\n+  opts?: LoadConfigOptions\n+): Promise<NextConfigComplete>\n+\n export default async function loadConfig(\n   phase: PHASE_TYPE,\n   dir: string,\n@@ -1421,16 +1451,7 @@ export default async function loadConfig(\n     reportExperimentalFeatures,\n     reactProductionProfiling,\n     debugPrerender,\n-  }: {\n-    customConfig?: object | null\n-    rawConfig?: boolean\n-    silent?: boolean\n-    reportExperimentalFeatures?: (\n-      configuredExperimentalFeatures: ConfiguredExperimentalFeature[]\n-    ) => void\n-    reactProductionProfiling?: boolean\n-    debugPrerender?: boolean\n-  } = {}\n+  }: LoadConfigOptions = {}\n ): Promise<NextConfigComplete> {\n   // Generate cache key based on parameters that affect config output\n   // Include process.pid to invalidate cache on server restart"
        },
        {
            "sha": "40f64288442e157ba7d96a7f37f47f368f7e80a3",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -51,7 +51,7 @@ import {\n import { DecodeError, MiddlewareNotFoundError } from '../../shared/lib/utils'\n import * as Log from '../../build/output/log'\n import isError, { getProperError } from '../../lib/is-error'\n-import { defaultConfig } from '../config-shared'\n+import { defaultConfig, type NextConfigComplete } from '../config-shared'\n import { isMiddlewareFile } from '../../build/utils'\n import { formatServerError } from '../../lib/format-server-error'\n import { DevRouteMatcherManager } from '../route-matcher-managers/dev-route-matcher-manager'\n@@ -95,6 +95,8 @@ const ReactDevOverlay: PagesDevOverlayBridgeType = (props) => {\n }\n \n export interface Options extends ServerOptions {\n+  // Override type to make the full config available instead of only NextConfigRuntime\n+  conf: NextConfigComplete\n   /**\n    * Tells of Next.js is running from the `next dev` command\n    */\n@@ -112,6 +114,9 @@ export interface Options extends ServerOptions {\n }\n \n export default class DevServer extends Server {\n+  // Override type to make the full config available instead of only NextConfigRuntime\n+  protected readonly nextConfig: NextConfigComplete\n+\n   /**\n    * The promise that resolves when the server is ready. When this is unset\n    * the server is ready.\n@@ -171,6 +176,7 @@ export default class DevServer extends Server {\n       Error.stackTraceLimit = 50\n     } catch {}\n     super({ ...options, dev: true })\n+    this.nextConfig = options.conf\n     this.bundlerService = options.bundlerService\n     this.startServerSpan =\n       options.startServerSpan ?? trace('start-next-dev-server')"
        },
        {
            "sha": "ffb0206412d96863128b40afd0bac8915ba7743b",
            "filename": "packages/next/src/server/image-optimizer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -13,7 +13,7 @@ import { getImageBlurSvg } from '../shared/lib/image-blur-svg'\n import type { ImageConfigComplete } from '../shared/lib/image-config'\n import { hasLocalMatch } from '../shared/lib/match-local-pattern'\n import { hasRemoteMatch } from '../shared/lib/match-remote-pattern'\n-import type { NextConfigComplete } from './config-shared'\n+import type { NextConfigComplete, NextConfigRuntime } from './config-shared'\n import { createRequestResponseMocks } from './lib/mock-request'\n import type { NextUrlWithParsedQuery } from './request-meta'\n import {\n@@ -314,12 +314,12 @@ export async function detectContentType(\n \n export class ImageOptimizerCache {\n   private cacheDir: string\n-  private nextConfig: NextConfigComplete\n+  private nextConfig: NextConfigRuntime\n \n   static validateParams(\n     req: IncomingMessage,\n     query: UrlWithParsedQuery['query'],\n-    nextConfig: NextConfigComplete,\n+    nextConfig: NextConfigRuntime,\n     isDev: boolean\n   ): ImageParamsResult | { errorMessage: string } {\n     const imageData = nextConfig.images\n@@ -497,7 +497,7 @@ export class ImageOptimizerCache {\n     nextConfig,\n   }: {\n     distDir: string\n-    nextConfig: NextConfigComplete\n+    nextConfig: NextConfigRuntime\n   }) {\n     this.cacheDir = join(/* turbopackIgnore: true */ distDir, 'cache', 'images')\n     this.nextConfig = nextConfig"
        },
        {
            "sha": "45bef5f202c368872394f97875386977512e5be8",
            "filename": "packages/next/src/server/lib/chrome-devtools-workspace.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fchrome-devtools-workspace.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fchrome-devtools-workspace.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fchrome-devtools-workspace.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -1,5 +1,5 @@\n import type { ServerResponse } from 'http'\n-import type { NextConfigComplete } from '../config-shared'\n+import type { NextConfigRuntime } from '../config-shared'\n \n import { randomUUID } from 'crypto'\n import * as fs from 'fs'\n@@ -18,7 +18,7 @@ export function isChromeDevtoolsWorkspaceUrl(\n export async function handleChromeDevtoolsWorkspaceRequest(\n   response: ServerResponse,\n   opts: { dir: string },\n-  config: NextConfigComplete\n+  config: NextConfigRuntime\n ): Promise<void> {\n   response.setHeader('Content-Type', 'application/json')\n   response.end("
        },
        {
            "sha": "2814270b86c0b1a54d9a34049ddcc7d378863957",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 29,
            "changes": 88,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -59,6 +59,7 @@ import {\n   handleChromeDevtoolsWorkspaceRequest,\n   isChromeDevtoolsWorkspaceUrl,\n } from './chrome-devtools-workspace'\n+import { getNextConfigRuntime, type NextConfigComplete } from '../config-shared'\n \n const debug = setupDebug('next:router-server:main')\n const isNextFont = (pathname: string | null) =>\n@@ -118,9 +119,13 @@ export async function initialize(opts: {\n \n   const renderServer: LazyRenderServerInstance = {}\n \n-  let developmentBundler: DevBundler | undefined\n-\n-  let devBundlerService: DevBundlerService | undefined\n+  let development:\n+    | {\n+        bundler: DevBundler\n+        service: DevBundlerService\n+        config: NextConfigComplete\n+      }\n+    | undefined = undefined\n \n   let originalFetch = globalThis.fetch\n \n@@ -146,7 +151,11 @@ export async function initialize(opts: {\n     const setupDevBundlerSpan = opts.startServerSpan\n       ? opts.startServerSpan.traceChild('setup-dev-bundler')\n       : trace('setup-dev-bundler')\n-    developmentBundler = await setupDevBundlerSpan.traceAsyncFn(() =>\n+\n+    // In development, it's always the complete config.\n+    let developmentConfig = config as NextConfigComplete\n+\n+    let developmentBundler = await setupDevBundlerSpan.traceAsyncFn(() =>\n       setupDevBundler({\n         // Passed here but the initialization of this object happens below, doing the initialization before the setupDev call breaks.\n         renderServer,\n@@ -155,7 +164,7 @@ export async function initialize(opts: {\n         telemetry,\n         fsChecker,\n         dir: opts.dir,\n-        nextConfig: config,\n+        nextConfig: developmentConfig,\n         isCustomServer: opts.customServer,\n         turbo: !!process.env.TURBOPACK,\n         port: opts.port,\n@@ -164,14 +173,20 @@ export async function initialize(opts: {\n       })\n     )\n \n-    devBundlerService = new DevBundlerService(\n+    let devBundlerService = new DevBundlerService(\n       developmentBundler,\n       // The request handler is assigned below, this allows us to create a lazy\n       // reference to it.\n       (req, res) => {\n         return requestHandlers[opts.dir](req, res)\n       }\n     )\n+\n+    development = {\n+      bundler: developmentBundler,\n+      service: devBundlerService,\n+      config: developmentConfig,\n+    }\n   }\n \n   renderServer.instance =\n@@ -328,8 +343,15 @@ export async function initialize(opts: {\n       }\n \n       // handle hot-reloader first\n-      if (developmentBundler) {\n-        if (blockCrossSite(req, res, config.allowedDevOrigins, opts.hostname)) {\n+      if (development) {\n+        if (\n+          blockCrossSite(\n+            req,\n+            res,\n+            development.config.allowedDevOrigins,\n+            opts.hostname\n+          )\n+        ) {\n           return\n         }\n \n@@ -348,7 +370,7 @@ export async function initialize(opts: {\n \n         const parsedUrl = url.parse(req.url || '/')\n \n-        const hotReloaderResult = await developmentBundler.hotReloader.run(\n+        const hotReloaderResult = await development.bundler.hotReloader.run(\n           req,\n           res,\n           parsedUrl\n@@ -380,7 +402,7 @@ export async function initialize(opts: {\n         return\n       }\n \n-      if (developmentBundler && matchedOutput?.type === 'devVirtualFsItem') {\n+      if (development && matchedOutput?.type === 'devVirtualFsItem') {\n         const origUrl = req.url || '/'\n \n         if (config.basePath && pathHasPrefix(origUrl, config.basePath)) {\n@@ -397,7 +419,7 @@ export async function initialize(opts: {\n             res.setHeader(key, resHeaders[key])\n           }\n         }\n-        const result = await developmentBundler.requestHandler(req, res)\n+        const result = await development.bundler.requestHandler(req, res)\n \n         if (result.finished) {\n           return\n@@ -576,7 +598,7 @@ export async function initialize(opts: {\n       }\n \n       // We want the original pathname without any basePath or proxy rewrites.\n-      if (opts.dev && isChromeDevtoolsWorkspaceUrl(req.url)) {\n+      if (development && isChromeDevtoolsWorkspaceUrl(req.url)) {\n         await handleChromeDevtoolsWorkspaceRequest(res, opts, config)\n         return\n       }\n@@ -625,7 +647,7 @@ export async function initialize(opts: {\n       }\n \n       const appNotFound = opts.dev\n-        ? developmentBundler?.serverFields.hasAppNotFound\n+        ? development?.bundler?.serverFields.hasAppNotFound\n         : await fsChecker.getItem(UNDERSCORE_NOT_FOUND_ROUTE)\n \n       res.statusCode = 404\n@@ -692,12 +714,14 @@ export async function initialize(opts: {\n     dev: !!opts.dev,\n     server: opts.server,\n     serverFields: {\n-      ...(developmentBundler?.serverFields || {}),\n-      setIsrStatus: devBundlerService?.setIsrStatus.bind(devBundlerService),\n+      ...(development?.bundler?.serverFields || {}),\n+      setIsrStatus: development?.service?.setIsrStatus.bind(\n+        development?.service\n+      ),\n     } satisfies ServerFields,\n     experimentalTestProxy: !!config.experimental.testProxy,\n     experimentalHttpsServer: !!opts.experimentalHttpsServer,\n-    bundlerService: devBundlerService,\n+    bundlerService: development?.service,\n     startServerSpan: opts.startServerSpan,\n     quiet: opts.quiet,\n     onDevServerCleanup: opts.onDevServerCleanup,\n@@ -715,7 +739,7 @@ export async function initialize(opts: {\n   const relativeProjectDir = path.relative(process.cwd(), opts.dir)\n \n   routerServerGlobal[RouterServerContextSymbol][relativeProjectDir] = {\n-    nextConfig: config,\n+    nextConfig: getNextConfigRuntime(config),\n     hostname: handlers.server.hostname,\n     revalidate: handlers.server.revalidate.bind(handlers.server),\n     render404: handlers.server.render404.bind(handlers.server),\n@@ -724,14 +748,15 @@ export async function initialize(opts: {\n       ? handlers.server.logErrorWithOriginalStack.bind(handlers.server)\n       : (err: unknown) => !opts.quiet && Log.error(err),\n     setCacheStatus: config.cacheComponents\n-      ? devBundlerService?.setCacheStatus.bind(devBundlerService)\n+      ? development?.service?.setCacheStatus.bind(development?.service)\n       : undefined,\n-    setIsrStatus: devBundlerService?.setIsrStatus.bind(devBundlerService),\n-    setReactDebugChannel: config.experimental.reactDebugChannel\n-      ? devBundlerService?.setReactDebugChannel.bind(devBundlerService)\n+    setIsrStatus: development?.service?.setIsrStatus.bind(development?.service),\n+    setReactDebugChannel: development?.config.experimental.reactDebugChannel\n+      ? development?.service?.setReactDebugChannel.bind(development?.service)\n       : undefined,\n-    sendErrorsToBrowser:\n-      devBundlerService?.sendErrorsToBrowser.bind(devBundlerService),\n+    sendErrorsToBrowser: development?.service?.sendErrorsToBrowser.bind(\n+      development?.service\n+    ),\n   }\n \n   const logError = async (\n@@ -759,7 +784,7 @@ export async function initialize(opts: {\n     opts,\n     renderServer.instance,\n     renderServerOpts,\n-    developmentBundler?.ensureMiddleware\n+    development?.bundler?.ensureMiddleware\n   )\n \n   const upgradeHandler: WorkerUpgradeHandler = async (req, socket, head) => {\n@@ -773,9 +798,14 @@ export async function initialize(opts: {\n         // console.error(_err);\n       })\n \n-      if (opts.dev && developmentBundler && req.url) {\n+      if (opts.dev && development && req.url) {\n         if (\n-          blockCrossSite(req, socket, config.allowedDevOrigins, opts.hostname)\n+          blockCrossSite(\n+            req,\n+            socket,\n+            development.config.allowedDevOrigins,\n+            opts.hostname\n+          )\n         ) {\n           return\n         }\n@@ -802,7 +832,7 @@ export async function initialize(opts: {\n         // only handle HMR requests if the basePath in the request\n         // matches the basePath for the handler responding to the request\n         if (isHMRRequest) {\n-          return developmentBundler.hotReloader.onHMR(\n+          return development.bundler.hotReloader.onHMR(\n             req,\n             socket,\n             head,\n@@ -818,7 +848,7 @@ export async function initialize(opts: {\n                 client.send(\n                   JSON.stringify({\n                     type: HMR_MESSAGE_SENT_TO_BROWSER.ISR_MANIFEST,\n-                    data: devBundlerService?.appIsrManifest || {},\n+                    data: development.service?.appIsrManifest || {},\n                   } satisfies AppIsrManifestMessage)\n                 )\n               }\n@@ -864,7 +894,7 @@ export async function initialize(opts: {\n     upgradeHandler,\n     server: handlers.server,\n     closeUpgraded() {\n-      developmentBundler?.hotReloader?.close()\n+      development?.bundler?.hotReloader?.close()\n     },\n   }\n }"
        },
        {
            "sha": "287e7efd6b49f91da67c9e6992a94e02e61c107e",
            "filename": "packages/next/src/server/lib/router-utils/filesystem.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -4,7 +4,7 @@ import type {\n   PrerenderManifest,\n   RoutesManifest,\n } from '../../../build'\n-import type { NextConfigComplete } from '../../config-shared'\n+import type { NextConfigRuntime } from '../../config-shared'\n import type { MiddlewareManifest } from '../../../build/webpack/plugins/middleware-plugin'\n import type { UnwrapPromise } from '../../../lib/coalesced-function'\n import type { PatchMatcher } from '../../../shared/lib/router/utils/path-match'\n@@ -109,7 +109,7 @@ export async function setupFsCheck(opts: {\n   dir: string\n   dev: boolean\n   minimalMode?: boolean\n-  config: NextConfigComplete\n+  config: NextConfigRuntime\n }) {\n   const getItemsLru = !opts.dev\n     ? new LRUCache<FsOutput | null>(1024 * 1024, function length(value) {"
        },
        {
            "sha": "ea76e0d63afb73f1e7afa5eb7621b7b402cd3380",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -1,6 +1,6 @@\n import type { FsOutput } from './filesystem'\n import type { IncomingMessage, ServerResponse } from 'http'\n-import type { NextConfigComplete } from '../../config-shared'\n+import type { NextConfigRuntime } from '../../config-shared'\n import type { RenderServer, initialize } from '../router-server'\n import type { PatchMatcher } from '../../../shared/lib/router/utils/path-match'\n import type { Redirect } from '../../../types'\n@@ -51,7 +51,7 @@ export function getResolveRoutes(\n   fsChecker: UnwrapPromise<\n     ReturnType<typeof import('./filesystem').setupFsCheck>\n   >,\n-  config: NextConfigComplete,\n+  config: NextConfigRuntime,\n   opts: Parameters<typeof initialize>[0],\n   renderServer: RenderServer,\n   renderServerOpts: Parameters<RenderServer['initialize']>[0],"
        },
        {
            "sha": "80a7365495e817ad5b1e069dacfa551498ae5c1a",
            "filename": "packages/next/src/server/lib/router-utils/router-server-context.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -1,5 +1,5 @@\n import type { IncomingMessage, ServerResponse } from 'node:http'\n-import type { NextConfigComplete } from '../../config-shared'\n+import type { NextConfigRuntime } from '../../config-shared'\n import type { UrlWithParsedQuery } from 'node:url'\n import type { ServerCacheStatus } from '../../../next-devtools/dev-overlay/cache-indicator'\n \n@@ -30,7 +30,7 @@ export type RouterServerContext = Record<\n       setHeaders?: boolean\n     ) => Promise<void>\n     // exposing nextConfig for dev mode specifically\n-    nextConfig?: NextConfigComplete\n+    nextConfig?: NextConfigRuntime\n     // whether running in custom server mode\n     isCustomServer?: boolean\n     // whether test proxy is enabled"
        },
        {
            "sha": "b574e91d9ba5f4fe2b408b25572ff4b81130f403",
            "filename": "packages/next/src/server/node-environment-extensions/global-behaviors.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fglobal-behaviors.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fglobal-behaviors.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fglobal-behaviors.tsx?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -3,12 +3,13 @@\n  * an extension itself but it exposes a function to install config based global\n  * behaviors that should be loaded whenever a Node Server or Node Worker are created.\n  */\n-import type { NextConfigComplete } from '../config-shared'\n import { InvariantError } from '../../shared/lib/invariant-error'\n \n import { setAbortedLogsStyle } from './console-dim.external'\n \n-export function installGlobalBehaviors(config: NextConfigComplete) {\n+export function installGlobalBehaviors(config: {\n+  experimental?: { hideLogsAfterAbort?: boolean }\n+}) {\n   if (process.env.NEXT_RUNTIME === 'edge') {\n     throw new InvariantError(\n       'Expected not to install Node.js global behaviors in the edge runtime.'"
        },
        {
            "sha": "5ee7590ab0baf101e2393c1afc4beb5090c5ec62",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -50,7 +50,7 @@ import { initializeCacheHandlers, setCacheHandler } from '../use-cache/handlers'\n import { interopDefault } from '../app-render/interop-default'\n import { RouteKind } from '../route-kind'\n import type { BaseNextRequest } from '../base-http'\n-import type { I18NConfig, NextConfigComplete } from '../config-shared'\n+import type { I18NConfig, NextConfigRuntime } from '../config-shared'\n import ResponseCache, { type ResponseGenerator } from '../response-cache'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import {\n@@ -378,7 +378,7 @@ export abstract class RouteModule<\n \n   public async loadCustomCacheHandlers(\n     req: IncomingMessage | BaseNextRequest,\n-    nextConfig: NextConfigComplete\n+    nextConfig: NextConfigRuntime\n   ) {\n     if (process.env.NEXT_RUNTIME !== 'edge') {\n       const { cacheMaxMemorySize, cacheHandlers } = nextConfig\n@@ -418,7 +418,7 @@ export abstract class RouteModule<\n \n   public async getIncrementalCache(\n     req: IncomingMessage | BaseNextRequest,\n-    nextConfig: NextConfigComplete,\n+    nextConfig: NextConfigRuntime,\n     prerenderManifest: DeepReadonly<PrerenderManifest>,\n     isMinimalMode: boolean\n   ): Promise<IncrementalCache> {\n@@ -542,7 +542,7 @@ export abstract class RouteModule<\n         subresourceIntegrityManifest?: DeepReadonly<Record<string, string>>\n         isOnDemandRevalidate: boolean\n         revalidateOnlyGenerated: boolean\n-        nextConfig: NextConfigComplete\n+        nextConfig: NextConfigRuntime\n         routerServerContext?: RouterServerContext[string]\n         interceptionRoutePatterns?: any\n       }\n@@ -923,7 +923,7 @@ export abstract class RouteModule<\n     isMinimalMode,\n   }: {\n     req: IncomingMessage | BaseNextRequest\n-    nextConfig: NextConfigComplete\n+    nextConfig: NextConfigRuntime\n     cacheKey: string | null\n     routeKind: RouteKind\n     isFallback?: boolean"
        },
        {
            "sha": "b9f598c9a24d3e44bfec2a37b966618aef65c3e9",
            "filename": "packages/next/src/server/web/edge-route-module-wrapper.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45f0c79076d3e8280666aaeaab77eeebb12049b4/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts?ref=45f0c79076d3e8280666aaeaab77eeebb12049b4",
            "patch": "@@ -15,10 +15,10 @@ import { getServerUtils } from '../server-utils'\n import { searchParamsToUrlQuery } from '../../shared/lib/router/utils/querystring'\n import { CloseController, trackStreamConsumed } from './web-on-close'\n import { getEdgePreviewProps } from './get-edge-preview-props'\n-import type { NextConfigComplete } from '../config-shared'\n+import type { NextConfigRuntime } from '../config-shared'\n \n export interface WrapOptions {\n-  nextConfig: NextConfigComplete\n+  nextConfig: NextConfigRuntime\n   page: string\n }\n \n@@ -38,7 +38,7 @@ export class EdgeRouteModuleWrapper {\n    */\n   private constructor(\n     private readonly routeModule: AppRouteRouteModule,\n-    private readonly nextConfig: NextConfigComplete\n+    private readonly nextConfig: NextConfigRuntime\n   ) {\n     // TODO: (wyattjoh) possibly allow the module to define it's own matcher\n     this.matcher = new RouteMatcher(routeModule.definition)"
        }
    ],
    "stats": {
        "total": 440,
        "additions": 347,
        "deletions": 93
    }
}