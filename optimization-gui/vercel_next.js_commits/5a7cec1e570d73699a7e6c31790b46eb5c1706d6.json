{
    "author": "skt-t1-byungi",
    "message": "fix(router): Prevent redirect loop on root data requests with basePath (#81096)\n\nFixes #64910\n\nThis PR resolves an issue where a client-side navigation to the root\npage fails when both `basePath` and `middleware` are active. This is\ncaused by an incorrect redirect loop on the `/_next/data` request.\n\nThe sequence of events is as follows:\n1. Next.js enforces its `trailingSlash: false` policy by adding an\ninternal redirect from `{basePath}/` to `{basePath}`.\n2. For middleware to be invoked correctly, a data request for the root\npage is normalized to `/`.\n3. The path is then re-joined with the `basePath` using\n`path.posix.join(config.basePath, '/')`, which incorrectly results in\n`{basePath}/`.\n4. This malformed path triggers the redirect from step 1, causing the\ndata fetch to fail with a 308 status code and resulting in empty\n`pageProps`.\n\nThis fix isolates the root path (`/`) during path normalization to\nprevent an extra trailing slash from being added. By ensuring the path\nresolves to `{basePath}` instead of `{basePath}/`, the redirect loop is\navoided.\n\nThe change correctly handles the root path while leaving the logic for\nall other paths untouched.\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "5a7cec1e570d73699a7e6c31790b46eb5c1706d6",
    "files": [
        {
            "sha": "f4831df1b29bfceb76b0197270b2552dbaa9f3c4",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5a7cec1e570d73699a7e6c31790b46eb5c1706d6/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a7cec1e570d73699a7e6c31790b46eb5c1706d6/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=5a7cec1e570d73699a7e6c31790b46eb5c1706d6",
            "patch": "@@ -423,7 +423,10 @@ export function getResolveRoutes(\n             // base path.\n             if (updated) {\n               if (hadBasePath) {\n-                normalized = path.posix.join(config.basePath, normalized)\n+                normalized =\n+                  normalized === '/'\n+                    ? config.basePath\n+                    : path.posix.join(config.basePath, normalized)\n               }\n \n               // Re-add the trailing slash (if required)."
        },
        {
            "sha": "e423f021e5cc24c2da5fed1fb229b1a96b9b98cf",
            "filename": "test/e2e/middleware-base-path/app/pages/other.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5a7cec1e570d73699a7e6c31790b46eb5c1706d6/test%2Fe2e%2Fmiddleware-base-path%2Fapp%2Fpages%2Fother.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5a7cec1e570d73699a7e6c31790b46eb5c1706d6/test%2Fe2e%2Fmiddleware-base-path%2Fapp%2Fpages%2Fother.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-base-path%2Fapp%2Fpages%2Fother.js?ref=5a7cec1e570d73699a7e6c31790b46eb5c1706d6",
            "patch": "@@ -0,0 +1,12 @@\n+import Link from 'next/link'\n+\n+export default function Other() {\n+  return (\n+    <div>\n+      <h1>Other page</h1>\n+      <Link href=\"/\" id=\"go-to-home\">\n+        Go to home\n+      </Link>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "af39eae4b441708f05c9500b88da85dd9bad228d",
            "filename": "test/e2e/middleware-base-path/test/index.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/5a7cec1e570d73699a7e6c31790b46eb5c1706d6/test%2Fe2e%2Fmiddleware-base-path%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5a7cec1e570d73699a7e6c31790b46eb5c1706d6/test%2Fe2e%2Fmiddleware-base-path%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-base-path%2Ftest%2Findex.test.ts?ref=5a7cec1e570d73699a7e6c31790b46eb5c1706d6",
            "patch": "@@ -35,6 +35,7 @@ describe('Middleware base tests', () => {\n     const $ = cheerio.load(html)\n     expect($('.title').text()).toBe('About Page')\n   })\n+\n   it('router.query must exist when Link clicked page routing', async () => {\n     const browser = await webdriver(next.url, '/root')\n     try {\n@@ -45,4 +46,15 @@ describe('Middleware base tests', () => {\n       await browser.close()\n     }\n   })\n+\n+  it('should allow client-side navigation to the root', async () => {\n+    const browser = await webdriver(next.url, '/root/other')\n+    try {\n+      await browser.elementById('go-to-home').click()\n+      const title = await browser.waitForElementByCss('.title').text()\n+      expect(title).toMatch('Hello World')\n+    } finally {\n+      await browser.close()\n+    }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 29,
        "additions": 28,
        "deletions": 1
    }
}