{
    "author": "eps1lon",
    "message": "Move off of deprecated url.parse (#87257)",
    "sha": "ad39fe86ca04a73412f030e08013025fc70910c1",
    "files": [
        {
            "sha": "207d5f213fb8bd9886f6380350c3306f60f1a1d7",
            "filename": "packages/create-next-app/helpers/is-online.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fcreate-next-app%2Fhelpers%2Fis-online.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fcreate-next-app%2Fhelpers%2Fis-online.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fcreate-next-app%2Fhelpers%2Fis-online.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -1,6 +1,6 @@\n import { execSync } from 'node:child_process'\n import { lookup } from 'node:dns/promises'\n-import url from 'node:url'\n+import { URL } from 'node:url'\n \n function getProxy(): string | undefined {\n   if (process.env.https_proxy) {\n@@ -27,7 +27,14 @@ export async function getOnline(): Promise<boolean> {\n       return false\n     }\n \n-    const { hostname } = url.parse(proxy)\n+    let url: URL\n+    try {\n+      url = new URL(proxy)\n+    } catch {\n+      // Invalid proxy URL\n+      return false\n+    }\n+    const { hostname } = url\n     if (!hostname) {\n       // Invalid proxy URL\n       return false"
        },
        {
            "sha": "2c35dc57f45456b1255cc9950f5ce1f6adca460d",
            "filename": "packages/next/src/lib/try-to-parse-path.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Flib%2Ftry-to-parse-path.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Flib%2Ftry-to-parse-path.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftry-to-parse-path.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -1,6 +1,5 @@\n import type { Token } from 'next/dist/compiled/path-to-regexp'\n import { parse, tokensToRegexp } from 'next/dist/compiled/path-to-regexp'\n-import { parse as parseURL } from 'url'\n import isError from './is-error'\n import { normalizeTokensForRegexp } from './route-pattern-normalizer'\n \n@@ -67,8 +66,8 @@ export function tryToParsePath(\n   const result: ParseResult = { route, parsedPath: route }\n   try {\n     if (options?.handleUrl) {\n-      const parsed = parseURL(route, true)\n-      result.parsedPath = `${parsed.pathname!}${parsed.hash || ''}`\n+      const parsed = new URL(route, 'http://n')\n+      result.parsedPath = `${parsed.pathname}${parsed.hash || ''}`\n     }\n \n     result.tokens = parse(result.parsedPath)"
        },
        {
            "sha": "c6a4dd004ff268141eb68f18dee224707ef977d4",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -18,7 +18,6 @@ import type {\n   ServerOnInstrumentationRequestError,\n } from './app-render/types'\n import type { ServerComponentsHmrCache } from './response-cache'\n-import type { UrlWithParsedQuery } from 'url'\n import {\n   NormalizeError,\n   DecodeError,\n@@ -46,7 +45,7 @@ import type { PathnameNormalizer } from './normalizers/request/pathname-normaliz\n import type { InstrumentationModule } from './instrumentation/types'\n \n import * as path from 'path'\n-import { format as formatUrl, parse as parseUrl } from 'url'\n+import { format as formatUrl } from 'url'\n import { formatHostname } from './lib/format-hostname'\n import {\n   APP_PATHS_MANIFEST,\n@@ -75,7 +74,10 @@ import {\n import { removePathPrefix } from '../shared/lib/router/utils/remove-path-prefix'\n import { normalizeAppPath } from '../shared/lib/router/utils/app-paths'\n import { getHostname } from '../shared/lib/get-hostname'\n-import { parseUrl as parseUrlUtil } from '../shared/lib/router/utils/parse-url'\n+import {\n+  parseUrl,\n+  parseUrl as parseUrlUtil,\n+} from '../shared/lib/router/utils/parse-url'\n import { getNextPathnameInfo } from '../shared/lib/router/utils/get-next-pathname-info'\n import {\n   RSC_HEADER,\n@@ -953,7 +955,7 @@ export default abstract class Server<\n           throw new Error('Invariant: url can not be undefined')\n         }\n \n-        parsedUrl = parseUrl(req.url!, true)\n+        parsedUrl = parseUrl(req.url)\n       }\n \n       if (!parsedUrl.pathname) {\n@@ -1681,7 +1683,7 @@ export default abstract class Server<\n   protected async run(\n     req: ServerRequest,\n     res: ServerResponse,\n-    parsedUrl: UrlWithParsedQuery\n+    parsedUrl: NextUrlWithParsedQuery\n   ): Promise<void> {\n     return getTracer().trace(BaseServerSpan.run, async () =>\n       this.runImpl(req, res, parsedUrl)\n@@ -1691,7 +1693,7 @@ export default abstract class Server<\n   private async runImpl(\n     req: ServerRequest,\n     res: ServerResponse,\n-    parsedUrl: UrlWithParsedQuery\n+    parsedUrl: NextUrlWithParsedQuery\n   ): Promise<void> {\n     await this.handleCatchallRenderRequest(req, res, parsedUrl)\n   }\n@@ -2963,7 +2965,7 @@ export default abstract class Server<\n     parsedUrl?: Pick<NextUrlWithParsedQuery, 'pathname' | 'query'>,\n     setHeaders = true\n   ): Promise<void> {\n-    const { pathname, query } = parsedUrl ? parsedUrl : parseUrl(req.url!, true)\n+    const { pathname, query } = parsedUrl ? parsedUrl : parseUrl(req.url)\n \n     // Ensure the locales are provided on the request meta.\n     if (this.nextConfig.i18n) {"
        },
        {
            "sha": "ea8c8e2661899336c7157a90e0947ed9c82c428b",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -368,7 +368,7 @@ export async function initialize(opts: {\n           req.url = removePathPrefix(origUrl, config.assetPrefix)\n         }\n \n-        const parsedUrl = url.parse(req.url || '/')\n+        const parsedUrl = parseUrlUtil(req.url || '/')\n \n         const hotReloaderResult = await development.bundler.hotReloader.run(\n           req,\n@@ -508,14 +508,9 @@ export async function initialize(opts: {\n         if (!(req.method === 'GET' || req.method === 'HEAD')) {\n           res.setHeader('Allow', ['GET', 'HEAD'])\n           res.statusCode = 405\n-          return await invokeRender(\n-            url.parse('/405', true),\n-            '/405',\n-            handleIndex,\n-            {\n-              invokeStatus: 405,\n-            }\n-          )\n+          return await invokeRender(parseUrlUtil('/405'), '/405', handleIndex, {\n+            invokeStatus: 405,\n+          })\n         }\n \n         try {\n@@ -574,7 +569,7 @@ export async function initialize(opts: {\n             const invokeStatus = err.statusCode\n             res.statusCode = err.statusCode\n             return await invokeRender(\n-              url.parse(invokePath, true),\n+              parseUrlUtil(invokePath),\n               invokePath,\n               handleIndex,\n               {\n@@ -684,7 +679,7 @@ export async function initialize(opts: {\n           console.error(err)\n         }\n         res.statusCode = Number(invokeStatus)\n-        return await invokeRender(url.parse(invokePath, true), invokePath, 0, {\n+        return await invokeRender(parseUrlUtil(invokePath), invokePath, 0, {\n           invokeStatus: res.statusCode,\n         })\n       } catch (err2) {"
        },
        {
            "sha": "6a8c772c09a0c9aa61b2dfdd7ac906d92f9cff8a",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 11,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -8,7 +8,6 @@ import type { Header } from '../../../lib/load-custom-routes'\n import type { UnwrapPromise } from '../../../lib/coalesced-function'\n import type { NextUrlWithParsedQuery } from '../../request-meta'\n \n-import url from 'url'\n import path from 'node:path'\n import setupDebug from 'next/dist/compiled/debug'\n import { getCloneableBody } from '../../body-streams'\n@@ -26,6 +25,7 @@ import { normalizeRepeatedSlashes } from '../../../shared/lib/utils'\n import { getRelativeURL } from '../../../shared/lib/router/utils/relativize-url'\n import { addPathPrefix } from '../../../shared/lib/router/utils/add-path-prefix'\n import { pathHasPrefix } from '../../../shared/lib/router/utils/path-has-prefix'\n+import { parseUrl } from '../../../shared/lib/router/utils/parse-url'\n import { detectDomainLocale } from '../../../shared/lib/i18n/detect-domain-locale'\n import { normalizeLocalePath } from '../../../shared/lib/i18n/normalize-locale-path'\n import { removePathPrefix } from '../../../shared/lib/router/utils/remove-path-prefix'\n@@ -124,7 +124,7 @@ export function getResolveRoutes(\n     let finished = false\n     let resHeaders: Record<string, string | string[]> = {}\n     let matchedOutput: FsOutput | null = null\n-    let parsedUrl = url.parse(req.url || '', true) as NextUrlWithParsedQuery\n+    let parsedUrl = parseUrl(req.url || '') as NextUrlWithParsedQuery\n     let didRewrite = false\n \n     const urlParts = (req.url || '').split('?', 1)\n@@ -142,7 +142,7 @@ export function getResolveRoutes(\n     // handle trailing slash as that is handled the same as a next.config.js\n     // redirect\n     if (urlNoQuery?.match(/(\\\\|\\/\\/)/)) {\n-      parsedUrl = url.parse(normalizeRepeatedSlashes(req.url!), true)\n+      parsedUrl = parseUrl(normalizeRepeatedSlashes(req.url!))\n       return {\n         parsedUrl,\n         resHeaders,\n@@ -662,7 +662,7 @@ export function getResolveRoutes(\n               const destination = getRelativeURL(value, initUrl)\n               resHeaders['x-middleware-rewrite'] = destination\n \n-              parsedUrl = url.parse(destination, true)\n+              parsedUrl = parseUrl(destination)\n \n               if (parsedUrl.protocol) {\n                 return {\n@@ -697,7 +697,7 @@ export function getResolveRoutes(\n                 // Process as redirect: update parsedUrl and convert to relative URL\n                 const rel = getRelativeURL(value, initUrl)\n                 resHeaders['location'] = rel\n-                parsedUrl = url.parse(rel, true)\n+                parsedUrl = parseUrl(rel)\n \n                 return {\n                   parsedUrl,\n@@ -752,11 +752,9 @@ export function getResolveRoutes(\n             parsedDestination.pathname\n           )\n \n-          // @ts-expect-error // custom ParsedUrl\n-          const unsafeParsedUrl: NextUrlWithParsedQuery = parsedDestination\n           return {\n             finished: true,\n-            parsedUrl: unsafeParsedUrl,\n+            parsedUrl: parsedDestination,\n             resHeaders: null,\n             statusCode: getRedirectStatus(route),\n           }\n@@ -828,10 +826,8 @@ export function getResolveRoutes(\n           }\n \n           if (parsedDestination.protocol) {\n-            // @ts-expect-error // custom ParsedUrl\n-            const unsafeParsedUrl: NextUrlWithParsedQuery = parsedDestination\n             return {\n-              parsedUrl: unsafeParsedUrl,\n+              parsedUrl: parsedDestination,\n               resHeaders: null,\n               finished: true,\n             }"
        },
        {
            "sha": "b35b44fbecb13dd8062b8b0157fcec6dcb7b1cd6",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -10,7 +10,6 @@ import type { NextJsHotReloaderInterface } from '../../dev/hot-reloader-types'\n import { createDefineEnv } from '../../../build/swc'\n import { installBindings } from '../../../build/swc/install-bindings'\n import fs from 'fs'\n-import url from 'url'\n import path from 'path'\n import qs from 'querystring'\n import Watchpack from 'next/dist/compiled/watchpack'\n@@ -81,6 +80,7 @@ import {\n   MIDDLEWARE_FILENAME,\n   PROXY_FILENAME,\n } from '../../../lib/constants'\n+import { parseUrl } from '../../../lib/url'\n import {\n   createRouteTypesManifest,\n   writeRouteTypesManifest,\n@@ -1213,9 +1213,10 @@ async function startWatcher(\n   opts.fsChecker.devVirtualFsItems.add(devTurbopackMiddlewareManifestPath)\n \n   async function requestHandler(req: IncomingMessage, res: ServerResponse) {\n-    const parsedUrl = url.parse(req.url || '/')\n+    const parsedUrl = parseUrl(req.url || '/')\n+    const pathname = parsedUrl !== undefined ? parsedUrl.pathname : null\n \n-    if (parsedUrl.pathname?.includes(clientPagesManifestPath)) {\n+    if (pathname !== null && pathname.includes(clientPagesManifestPath)) {\n       res.statusCode = 200\n       res.setHeader('Content-Type', JSON_CONTENT_TYPE_HEADER)\n       res.end(\n@@ -1229,8 +1230,9 @@ async function startWatcher(\n     }\n \n     if (\n-      parsedUrl.pathname?.includes(devMiddlewareManifestPath) ||\n-      parsedUrl.pathname?.includes(devTurbopackMiddlewareManifestPath)\n+      pathname !== null &&\n+      (pathname.includes(devMiddlewareManifestPath) ||\n+        pathname.includes(devTurbopackMiddlewareManifestPath))\n     ) {\n       res.statusCode = 200\n       res.setHeader('Content-Type', JSON_CONTENT_TYPE_HEADER)"
        },
        {
            "sha": "77a4c94973ded553696c2e17aab9b5098485cd6c",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -22,7 +22,6 @@ import type { Params } from './request/params'\n import type { MiddlewareRouteMatch } from '../shared/lib/router/utils/middleware-route-matcher'\n import type { RouteMatch } from './route-matches/route-match'\n import type { IncomingMessage, ServerResponse } from 'http'\n-import type { UrlWithParsedQuery } from 'url'\n import type { ParsedUrlQuery } from 'querystring'\n import type { ParsedUrl } from '../shared/lib/router/utils/parse-url'\n import type { CacheControl } from './lib/cache-control'\n@@ -1636,7 +1635,7 @@ export default class NextNodeServer extends BaseServer<\n     request: NodeNextRequest\n     response: NodeNextResponse\n     parsedUrl: ParsedUrl\n-    parsed: UrlWithParsedQuery\n+    parsed: NextUrlWithParsedQuery\n     onWarning?: (warning: Error) => void\n   }) {\n     if (process.env.NEXT_MINIMAL) {"
        },
        {
            "sha": "9f84f7410d87cfc63461608b40bfe609fe2f7a8f",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -3,7 +3,6 @@ import type {\n   NodeRequestHandler,\n   Options as ServerOptions,\n } from './next-server'\n-import type { UrlWithParsedQuery } from 'url'\n import type { IncomingMessage, ServerResponse } from 'http'\n import type { Duplex } from 'stream'\n import type { NextUrlWithParsedQuery, RequestMeta } from './request-meta'\n@@ -148,7 +147,7 @@ export class NextServer implements NextWrapperServer {\n     return async (\n       req: IncomingMessage,\n       res: ServerResponse,\n-      parsedUrl?: UrlWithParsedQuery\n+      parsedUrl?: NextUrlWithParsedQuery\n     ) => {\n       return getTracer().trace(NextServerSpan.getRequestHandler, async () => {\n         const requestHandler = await this.getServerRequestHandler()\n@@ -165,7 +164,7 @@ export class NextServer implements NextWrapperServer {\n     return async (\n       req: IncomingMessage,\n       res: ServerResponse,\n-      parsedUrl?: UrlWithParsedQuery\n+      parsedUrl?: NextUrlWithParsedQuery\n     ) => {\n       return getTracer().trace(\n         NextServerSpan.getRequestHandlerWithMetadata,\n@@ -444,7 +443,7 @@ class NextCustomServer implements NextWrapperServer {\n     return async (\n       req: IncomingMessage,\n       res: ServerResponse,\n-      parsedUrl?: UrlWithParsedQuery\n+      parsedUrl?: NextUrlWithParsedQuery\n     ) => {\n       this.setupWebSocketHandler(this.options.httpServer, req)\n "
        },
        {
            "sha": "e1e6164b290ee7b04775132ed2ae619d9baca1ab",
            "filename": "packages/next/src/server/request-meta.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -1,6 +1,5 @@\n import type { IncomingMessage } from 'http'\n import type { ParsedUrlQuery } from 'querystring'\n-import type { UrlWithParsedQuery } from 'url'\n import type { BaseNextRequest } from './base-http'\n import type { CloneableBody } from './body-streams'\n import type { RouteMatch } from './route-matches/route-match'\n@@ -357,6 +356,26 @@ type NextQueryMetadata = {\n \n export type NextParsedUrlQuery = ParsedUrlQuery & NextQueryMetadata\n \n-export interface NextUrlWithParsedQuery extends UrlWithParsedQuery {\n+/**\n+ * subset of `url.parse` return value\n+ */\n+interface LegacyUrl {\n+  auth?: string | null\n+  hash: string | null\n+  hostname: string | null\n+  href: string\n+  pathname: string | null\n+  protocol: string | null\n+  search: string | null\n+  slashes: boolean | null\n+  port: string | null\n+  query: string | null | ParsedUrlQuery\n+}\n+interface LegacyUrlWithParsedQuery extends LegacyUrl {\n+  query: ParsedUrlQuery\n+}\n+\n+// TODO: Remove in favor of WHATWG URLs\n+export interface NextUrlWithParsedQuery extends LegacyUrlWithParsedQuery {\n   query: NextParsedUrlQuery\n }"
        },
        {
            "sha": "7b0e9f7d0e64590023501f8eff724e8be1e4d3d6",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -2,8 +2,8 @@ import type { Rewrite } from '../lib/load-custom-routes'\n import type { RouteMatchFn } from '../shared/lib/router/utils/route-matcher'\n import type { NextConfig } from './config'\n import type { BaseNextRequest } from './base-http'\n+import type { NextUrlWithParsedQuery } from './request-meta'\n import type { ParsedUrlQuery } from 'querystring'\n-import type { UrlWithParsedQuery } from 'url'\n \n import { normalizeLocalePath } from '../shared/lib/i18n/normalize-locale-path'\n import { getPathMatch } from '../shared/lib/router/utils/path-match'\n@@ -218,11 +218,13 @@ export function getServerUtils({\n \n   function handleRewrites(\n     req: BaseNextRequest | IncomingMessage,\n-    parsedUrl: DeepReadonly<UrlWithParsedQuery>\n+    parsedUrl: DeepReadonly<NextUrlWithParsedQuery>\n   ) {\n     // Here we deep clone the parsedUrl to avoid mutating the original. We also\n     // cast this to a mutable type so we can mutate it within this scope.\n-    const rewrittenParsedUrl = structuredClone(parsedUrl) as UrlWithParsedQuery\n+    const rewrittenParsedUrl = structuredClone(\n+      parsedUrl\n+    ) as NextUrlWithParsedQuery\n     const rewriteParams: Record<string, string> = {}\n     let fsPathname = rewrittenParsedUrl.pathname\n "
        },
        {
            "sha": "490e3b8a35f2992f1aa40c2cffb68884009c6911",
            "filename": "packages/next/src/shared/lib/router/utils/parse-relative-url.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.test.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -4,11 +4,12 @@ describe('relative urls', () => {\n   it('should return valid pathname', () => {\n     expect(parseRelativeUrl('/').pathname).toBe('/')\n     expect(parseRelativeUrl('/abc').pathname).toBe('/abc')\n+    expect(parseRelativeUrl('//**y/\\\\').pathname).toBe('//**y//')\n+    expect(parseRelativeUrl('//google.com').pathname).toBe('//google.com')\n   })\n \n   it('should throw for invalid pathname', () => {\n-    expect(() => parseRelativeUrl('//**y/\\\\')).toThrow()\n-    expect(() => parseRelativeUrl('//google.com')).toThrow()\n+    expect(() => parseRelativeUrl('http://example.com/abc')).toThrow()\n   })\n })\n "
        },
        {
            "sha": "f8ff5adb3bf0f568b6222ecc0d0d5dcb3670d26d",
            "filename": "packages/next/src/shared/lib/router/utils/parse-relative-url.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -3,12 +3,17 @@ import { getLocationOrigin } from '../../utils'\n import { searchParamsToUrlQuery } from './querystring'\n \n export interface ParsedRelativeUrl {\n+  auth: string | null\n   hash: string\n+  host: string | null\n+  hostname: string | null\n   href: string\n   pathname: string\n+  port: string | null\n+  protocol: string | null\n   query: ParsedUrlQuery\n   search: string\n-  slashes: undefined\n+  slashes: null\n }\n \n /**\n@@ -44,23 +49,32 @@ export function parseRelativeUrl(\n         )\n       : globalBase\n \n-  const { pathname, searchParams, search, hash, href, origin } = new URL(\n-    url,\n-    resolvedBase\n+  const { pathname, searchParams, search, hash, href, origin } = url.startsWith(\n+    '/'\n   )\n+    ? // 'http://localhost:3000///' would be received as '///' in Node.js' IncomingMessage\n+      // See https://nodejs.org/api/http.html#messageurl\n+      // Not using `origin` to support other protocols\n+      new URL(`${resolvedBase.protocol}//${resolvedBase.host}${url}`)\n+    : new URL(url, resolvedBase)\n \n   if (origin !== globalBase.origin) {\n     throw new Error(`invariant: invalid relative URL, router received ${url}`)\n   }\n \n   return {\n+    auth: null,\n+    host: null,\n+    hostname: null,\n     pathname,\n+    port: null,\n+    protocol: null,\n     query: parseQuery ? searchParamsToUrlQuery(searchParams) : undefined,\n     search,\n     hash,\n     href: href.slice(origin.length),\n     // We don't know for relative URLs at this point since we set a custom, internal\n     // base that isn't surfaced to users.\n-    slashes: undefined,\n+    slashes: null,\n   }\n }"
        },
        {
            "sha": "99b3bf53e5b9abe729cc502a15403573e433a147",
            "filename": "packages/next/src/shared/lib/router/utils/parse-url.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 7,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -4,16 +4,17 @@ import { searchParamsToUrlQuery } from './querystring'\n import { parseRelativeUrl } from './parse-relative-url'\n \n export interface ParsedUrl {\n+  auth: string | null\n   hash: string\n-  hostname?: string | null\n+  hostname: string | null\n   href: string\n+  origin?: string | null\n   pathname: string\n-  port?: string | null\n-  protocol?: string | null\n+  port: string | null\n+  protocol: string | null\n   query: ParsedUrlQuery\n-  origin?: string | null\n   search: string\n-  slashes: boolean | undefined\n+  slashes: boolean | null\n }\n \n export function parseUrl(url: string): ParsedUrl {\n@@ -22,15 +23,25 @@ export function parseUrl(url: string): ParsedUrl {\n   }\n \n   const parsedURL = new URL(url)\n+  const username = parsedURL.username\n+  const password = parsedURL.password\n+  const auth = username\n+    ? password\n+      ? `${username}:${password}`\n+      : username\n+    : null\n+  const pathname = parsedURL.pathname\n+  const search = parsedURL.search\n   return {\n+    auth,\n     hash: parsedURL.hash,\n     hostname: parsedURL.hostname,\n     href: parsedURL.href,\n-    pathname: parsedURL.pathname,\n+    pathname,\n     port: parsedURL.port,\n     protocol: parsedURL.protocol,\n     query: searchParamsToUrlQuery(parsedURL.searchParams),\n-    search: parsedURL.search,\n+    search,\n     origin: parsedURL.origin,\n     slashes:\n       parsedURL.href.slice("
        },
        {
            "sha": "55ce6e365f0fbbfd546bde157b23c3a10dd2803a",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -14,14 +14,18 @@ describe('parseDestination', () => {\n \n     expect(result).toMatchInlineSnapshot(`\n      {\n+       \"auth\": null,\n        \"hash\": \"\",\n-       \"hostname\": undefined,\n+       \"host\": null,\n+       \"hostname\": null,\n        \"href\": \"/hello/:name\",\n        \"origin\": undefined,\n        \"pathname\": \"/hello/:name\",\n+       \"port\": null,\n+       \"protocol\": null,\n        \"query\": {},\n        \"search\": \"\",\n-       \"slashes\": undefined,\n+       \"slashes\": null,\n      }\n     `)\n   })\n@@ -39,6 +43,7 @@ describe('parseDestination', () => {\n \n     expect(result).toMatchInlineSnapshot(`\n      {\n+       \"auth\": null,\n        \"hash\": \"#bar\",\n        \"hostname\": \"o:foo.com\",\n        \"href\": \"https://o:foo.com/hello/:name#bar\",\n@@ -66,6 +71,7 @@ describe('parseDestination', () => {\n \n     expect(result).toMatchInlineSnapshot(`\n      {\n+       \"auth\": null,\n        \"hash\": \"\",\n        \"hostname\": \"o:foo.com\",\n        \"href\": \"https://o:foo.com/hello/:name?foo=:bar\","
        },
        {
            "sha": "e137d29609b01862b61f1f5762edcbfc2b6ccf54",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -5,7 +5,7 @@ import type { RouteHas } from '../../../../lib/load-custom-routes'\n import type { BaseNextRequest } from '../../../../server/base-http'\n \n import { escapeStringRegexp } from '../../escape-regexp'\n-import { parseUrl } from './parse-url'\n+import { parseUrl, type ParsedUrl } from './parse-url'\n import {\n   INTERCEPTION_ROUTE_MARKERS,\n   isInterceptionRouteAppPath,\n@@ -163,7 +163,7 @@ export function parseDestination(args: {\n   destination: string\n   params: Readonly<Params>\n   query: Readonly<NextParsedUrlQuery>\n-}) {\n+}): ParsedUrl {\n   let escaped = args.destination\n   for (const param of Object.keys({ ...args.params, ...args.query })) {\n     if (!param) continue"
        },
        {
            "sha": "572e22706913584db50cbf62e5378419c4fd7a48",
            "filename": "packages/next/src/shared/lib/router/utils/resolve-rewrites.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fresolve-rewrites.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fresolve-rewrites.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fresolve-rewrites.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -6,11 +6,9 @@ import { removeTrailingSlash } from './remove-trailing-slash'\n import { normalizeLocalePath } from '../../i18n/normalize-locale-path'\n import { removeBasePath } from '../../../../client/remove-base-path'\n import { parseRelativeUrl, type ParsedRelativeUrl } from './parse-relative-url'\n+import type { ParsedUrl } from './parse-url'\n \n-interface ParsedAs extends Omit<ParsedRelativeUrl, 'slashes'> {\n-  slashes: boolean | undefined\n-}\n-\n+type ParsedAs = ParsedRelativeUrl | ParsedUrl\n export default function resolveRewrites(\n   asPath: string,\n   pages: string[],"
        },
        {
            "sha": "c9c04a5ac88f56a238ddd59041aab2feceeab62e",
            "filename": "test/e2e/i18n-ignore-redirect-source-locale/redirects-with-basepath.test.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 8,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/ad39fe86ca04a73412f030e08013025fc70910c1/test%2Fe2e%2Fi18n-ignore-redirect-source-locale%2Fredirects-with-basepath.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ad39fe86ca04a73412f030e08013025fc70910c1/test%2Fe2e%2Fi18n-ignore-redirect-source-locale%2Fredirects-with-basepath.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-ignore-redirect-source-locale%2Fredirects-with-basepath.test.ts?ref=ad39fe86ca04a73412f030e08013025fc70910c1",
            "patch": "@@ -1,6 +1,6 @@\n import { createNext, FileRef } from 'e2e-utils'\n import { NextInstance } from 'e2e-utils'\n-import { check } from 'next-test-utils'\n+import { retry } from 'next-test-utils'\n import { join } from 'path'\n import webdriver from 'next-webdriver'\n \n@@ -58,34 +58,41 @@ describe('i18n-ignore-redirect-source-locale with basepath', () => {\n     'get redirected to the new page, from: %s to: sv',\n     async (locale) => {\n       const browser = await webdriver(next.url, `basepath/${locale}/to-sv`)\n-      await check(() => browser.elementById('current-locale').text(), 'sv')\n+      await retry(async () => {\n+        expect(await browser.elementById('current-locale').text()).toBe('sv')\n+      })\n     }\n   )\n \n   test.each(locales)(\n     'get redirected to the new page, from: %s to: en',\n     async (locale) => {\n       const browser = await webdriver(next.url, `basepath/${locale}/to-en`)\n-      await check(() => browser.elementById('current-locale').text(), 'en')\n+      await retry(async () => {\n+        expect(await browser.elementById('current-locale').text()).toBe('en')\n+      })\n     }\n   )\n \n   test.each(locales)(\n     'get redirected to the new page, from: %s to: /',\n     async (locale) => {\n       const browser = await webdriver(next.url, `basepath/${locale}/to-slash`)\n-      await check(() => browser.elementById('current-locale').text(), 'en')\n+      await retry(async () => {\n+        expect(await browser.elementById('current-locale').text()).toBe('en')\n+      })\n     }\n   )\n \n   test.each(locales)(\n     'get redirected to the new page, from and to: %s',\n     async (locale) => {\n       const browser = await webdriver(next.url, `basepath/${locale}/to-same`)\n-      await check(\n-        () => browser.elementById('current-locale').text(),\n-        locale === '' ? 'en' : locale.slice(1)\n-      )\n+      await retry(async () => {\n+        expect(await browser.elementById('current-locale').text()).toBe(\n+          locale === '' ? 'en' : locale.slice(1)\n+        )\n+      })\n     }\n   )\n })"
        }
    ],
    "stats": {
        "total": 217,
        "additions": 137,
        "deletions": 80
    }
}