{
    "author": "huozhi",
    "message": "Add graceful error boundary for bots requests (#78298)",
    "sha": "527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
    "files": [
        {
            "sha": "07444bb78cafdae00ce8c24183f7793e5a047bb8",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "patch": "@@ -46,6 +46,7 @@ import {\n import { getRedirectTypeFromError, getURLFromRedirectError } from './redirect'\n import { isRedirectError, RedirectType } from './redirect-error'\n import { pingVisibleLinks } from './links'\n+import GracefulDegradeBoundary from './errors/graceful-degrade-boundary'\n \n const globalMutable: {\n   pendingMpaPath?: string\n@@ -515,7 +516,9 @@ function Router({\n   } else {\n     // If gracefully degrading is applied in production,\n     // leave the app as it is rather than caught by GlobalError boundary.\n-    if (!gracefullyDegrade) {\n+    if (gracefullyDegrade) {\n+      content = <GracefulDegradeBoundary>{content}</GracefulDegradeBoundary>\n+    } else {\n       content = (\n         <ErrorBoundary\n           errorComponent={globalError[0]}"
        },
        {
            "sha": "9e96382a2244d97a473e7db0b5e9c2f499a943e0",
            "filename": "packages/next/src/client/components/errors/graceful-degrade-boundary.tsx",
            "status": "added",
            "additions": 77,
            "deletions": 0,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fgraceful-degrade-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fgraceful-degrade-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Fgraceful-degrade-boundary.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "patch": "@@ -0,0 +1,77 @@\n+'use client'\n+\n+import { Component, createRef, type ReactNode } from 'react'\n+\n+interface ErrorBoundaryProps {\n+  children: ReactNode\n+}\n+\n+interface ErrorBoundaryState {\n+  hasError: boolean\n+}\n+\n+function getDomNodeAttributes(node: HTMLElement): Record<string, string> {\n+  const result: Record<string, string> = {}\n+  for (let i = 0; i < node.attributes.length; i++) {\n+    const attr = node.attributes[i]\n+    result[attr.name] = attr.value\n+  }\n+  return result\n+}\n+\n+export class GracefulDegradeBoundary extends Component<\n+  ErrorBoundaryProps,\n+  ErrorBoundaryState\n+> {\n+  private rootHtml: string\n+  private htmlAttributes: Record<string, string>\n+  private htmlRef: React.RefObject<HTMLHtmlElement | null>\n+\n+  constructor(props: ErrorBoundaryProps) {\n+    super(props)\n+    this.state = { hasError: false }\n+    this.rootHtml = ''\n+    this.htmlAttributes = {}\n+    this.htmlRef = createRef<HTMLHtmlElement>()\n+  }\n+\n+  static getDerivedStateFromError(_: unknown): ErrorBoundaryState {\n+    return { hasError: true }\n+  }\n+\n+  componentDidMount() {\n+    const htmlNode = this.htmlRef.current\n+    if (this.state.hasError && htmlNode) {\n+      // Reapply the cached HTML attributes to the root element\n+      Object.entries(this.htmlAttributes).forEach(([key, value]) => {\n+        htmlNode.setAttribute(key, value)\n+      })\n+    }\n+  }\n+\n+  render() {\n+    const { hasError } = this.state\n+    // Cache the root HTML content on the first render\n+    if (typeof window !== 'undefined' && !this.rootHtml) {\n+      this.rootHtml = document.documentElement.innerHTML\n+      this.htmlAttributes = getDomNodeAttributes(document.documentElement)\n+    }\n+\n+    if (hasError) {\n+      // Render the current HTML content without hydration\n+      return (\n+        <html\n+          ref={this.htmlRef}\n+          suppressHydrationWarning\n+          dangerouslySetInnerHTML={{\n+            __html: this.rootHtml,\n+          }}\n+        />\n+      )\n+    }\n+\n+    return this.props.children\n+  }\n+}\n+\n+export default GracefulDegradeBoundary"
        },
        {
            "sha": "e02e4395af3d877e744f615e7df293958bd2b746",
            "filename": "test/production/app-dir/graceful-degrade/app/browser-crash-error-boundary/error.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash-error-boundary%2Ferror.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash-error-boundary%2Ferror.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash-error-boundary%2Ferror.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "previous_filename": "test/production/app-dir/graceful-degrade/custom-error/app/blog/error.tsx"
        },
        {
            "sha": "47f1720e2303e09af311dda304b37481ed9ea67f",
            "filename": "test/production/app-dir/graceful-degrade/app/browser-crash-error-boundary/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash-error-boundary%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash-error-boundary%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash-error-boundary%2Fpage.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+\n+export default function Page() {\n+  if (typeof window !== 'undefined') {\n+    throw new Error('boom')\n+  }\n+  return <p>fine</p>\n+}"
        },
        {
            "sha": "47f1720e2303e09af311dda304b37481ed9ea67f",
            "filename": "test/production/app-dir/graceful-degrade/app/browser-crash/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fbrowser-crash%2Fpage.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+\n+export default function Page() {\n+  if (typeof window !== 'undefined') {\n+    throw new Error('boom')\n+  }\n+  return <p>fine</p>\n+}"
        },
        {
            "sha": "436cd68a7caecf8d1ef5db1d3e04f52c31cbf5a8",
            "filename": "test/production/app-dir/graceful-degrade/app/chunk-loading-failed/async-content.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fasync-content.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fasync-content.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fasync-content.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "previous_filename": "test/production/app-dir/graceful-degrade/basic/app/async-content.tsx"
        },
        {
            "sha": "5f723c0b11c023d58b677b4af9064efbfbac14bf",
            "filename": "test/production/app-dir/graceful-degrade/app/chunk-loading-failed/content.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fcontent.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fcontent.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fcontent.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "previous_filename": "test/production/app-dir/graceful-degrade/basic/app/content.tsx"
        },
        {
            "sha": "1314b13f0d034687c53daa8a1fb840078c646f23",
            "filename": "test/production/app-dir/graceful-degrade/app/chunk-loading-failed/page-client.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fpage-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fpage-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fpage-client.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "previous_filename": "test/production/app-dir/graceful-degrade/basic/app/page-client.tsx"
        },
        {
            "sha": "67686cd31a09097770bb03df083f013fbca17251",
            "filename": "test/production/app-dir/graceful-degrade/app/chunk-loading-failed/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Fchunk-loading-failed%2Fpage.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "previous_filename": "test/production/app-dir/graceful-degrade/basic/app/page.tsx"
        },
        {
            "sha": "4584d389e5fdc6f0a24ac0125e73a74171fd70a1",
            "filename": "test/production/app-dir/graceful-degrade/app/layout.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fapp%2Flayout.tsx?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "previous_filename": "test/production/app-dir/graceful-degrade/basic/app/layout.tsx"
        },
        {
            "sha": "436cd68a7caecf8d1ef5db1d3e04f52c31cbf5a8",
            "filename": "test/production/app-dir/graceful-degrade/custom-error/app/blog/async-content.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fasync-content.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fasync-content.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fasync-content.tsx?ref=f9a12ba50b99407b93d68441c2d61bc59837e739",
            "patch": "@@ -1,5 +0,0 @@\n-'use client'\n-\n-import dynamic from 'next/dynamic'\n-\n-export const Large = dynamic(() => import('./content'))"
        },
        {
            "sha": "5f723c0b11c023d58b677b4af9064efbfbac14bf",
            "filename": "test/production/app-dir/graceful-degrade/custom-error/app/blog/content.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fcontent.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fcontent.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fcontent.tsx?ref=f9a12ba50b99407b93d68441c2d61bc59837e739",
            "patch": "@@ -1,5 +0,0 @@\n-'use client'\n-\n-export default function Large() {\n-  return <p>large test content</p>\n-}"
        },
        {
            "sha": "1314b13f0d034687c53daa8a1fb840078c646f23",
            "filename": "test/production/app-dir/graceful-degrade/custom-error/app/blog/page-client.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fpage-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fpage-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fpage-client.tsx?ref=f9a12ba50b99407b93d68441c2d61bc59837e739",
            "patch": "@@ -1,12 +0,0 @@\n-'use client'\n-\n-import { Large } from './async-content'\n-\n-export default function Page() {\n-  return (\n-    <div className=\"page\">\n-      <p>hello world von server</p>\n-      <Large />\n-    </div>\n-  )\n-}"
        },
        {
            "sha": "67686cd31a09097770bb03df083f013fbca17251",
            "filename": "test/production/app-dir/graceful-degrade/custom-error/app/blog/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Fblog%2Fpage.tsx?ref=f9a12ba50b99407b93d68441c2d61bc59837e739",
            "patch": "@@ -1,2 +0,0 @@\n-export { default } from './page-client'\n-export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "4584d389e5fdc6f0a24ac0125e73a74171fd70a1",
            "filename": "test/production/app-dir/graceful-degrade/custom-error/app/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fapp%2Flayout.tsx?ref=f9a12ba50b99407b93d68441c2d61bc59837e739",
            "patch": "@@ -1,9 +0,0 @@\n-'use client'\n-\n-export default function Root({ children }: { children: React.ReactNode }) {\n-  return (\n-    <html className=\"layout-cls\">\n-      <body className=\"body-cls\">{children}</body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "3d39df9e239c0160d0d17645473725662b62a424",
            "filename": "test/production/app-dir/graceful-degrade/custom-error/graceful-degrade-custom-error-non-bot.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 40,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fgraceful-degrade-custom-error-non-bot.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fgraceful-degrade-custom-error-non-bot.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fgraceful-degrade-custom-error-non-bot.test.ts?ref=f9a12ba50b99407b93d68441c2d61bc59837e739",
            "patch": "@@ -1,40 +0,0 @@\n-// Duplicate the test file of graceful-degrade-error-bot.test.ts since we need to\n-// restart with a new browser context for UA setting. Otherwise the browser context\n-// will not be closed and reset properly. TODO: investigate why browser.close didn't help.\n-\n-import { nextTestSetup } from 'e2e-utils'\n-import { deleteBrowserDynamicChunks } from '../delete-dynamic-chunk'\n-\n-describe('graceful-degrade - custom-error - non bot', () => {\n-  const { next } = nextTestSetup({\n-    files: __dirname,\n-  })\n-\n-  // Delete client chunks to simulate chunk loading failure\n-  beforeAll(() => {\n-    deleteBrowserDynamicChunks(next)\n-  })\n-\n-  it('should not degrade to graceful error when chunk loading fails in ssr for non-bot user agents', async () => {\n-    const browser = await next.browser('/blog')\n-\n-    const logs = await browser.log()\n-    const errors = logs\n-      .filter((x) => x.source === 'error')\n-      .map((x) => x.message)\n-      .join('\\n')\n-\n-    expect(errors).toMatch(/Failed to load resource./)\n-    // Should show the same layout content\n-    const html = await browser.elementByCss('html')\n-    const body = await browser.elementByCss('body')\n-    expect(await html.getAttribute('class')).toBe('layout-cls')\n-    expect(await body.getAttribute('class')).toBe('body-cls')\n-\n-    // Show the custom error boundary text\n-    const errorBoundaryText = await browser\n-      .elementByCss('.error-boundary')\n-      .text()\n-    expect(errorBoundaryText).toMatch(/Custom error boundary/)\n-  })\n-})"
        },
        {
            "sha": "cfbc116133eb108caaa3d34966563868c3234a33",
            "filename": "test/production/app-dir/graceful-degrade/custom-error/graceful-degrade-custom-error.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 36,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fgraceful-degrade-custom-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a12ba50b99407b93d68441c2d61bc59837e739/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fgraceful-degrade-custom-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fcustom-error%2Fgraceful-degrade-custom-error.test.ts?ref=f9a12ba50b99407b93d68441c2d61bc59837e739",
            "patch": "@@ -1,36 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-import { deleteBrowserDynamicChunks } from '../delete-dynamic-chunk'\n-\n-describe('graceful-degrade - custom error', () => {\n-  const { next } = nextTestSetup({\n-    files: __dirname,\n-  })\n-\n-  // Delete client chunks to simulate chunk loading failure\n-  beforeAll(() => {\n-    deleteBrowserDynamicChunks(next)\n-  })\n-\n-  it('should degrade to graceful error when chunk loading fails in ssr for bot', async () => {\n-    const browser = await next.browser('/blog', {\n-      userAgent: 'Googlebot',\n-    })\n-\n-    const logs = await browser.log()\n-    const errors = logs\n-      .filter((x) => x.source === 'error')\n-      .map((x) => x.message)\n-      .join('\\n')\n-\n-    expect(errors).toMatch(/Failed to load resource./)\n-    // Should show the original content\n-    const html = await browser.elementByCss('html')\n-    const body = await browser.elementByCss('body')\n-    expect(await html.getAttribute('class')).toBe('layout-cls')\n-    expect(await body.getAttribute('class')).toBe('body-cls')\n-\n-    // Do not contain the custom error boundary text\n-    const bodyText = await body.text()\n-    expect(bodyText).not.toMatch(/Custom error boundary/)\n-  })\n-})"
        },
        {
            "sha": "731a8743999df62a9a19754215f3e312564466ab",
            "filename": "test/production/app-dir/graceful-degrade/graceful-degrade-non-bot.test.ts",
            "status": "renamed",
            "additions": 18,
            "deletions": 2,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fgraceful-degrade-non-bot.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fgraceful-degrade-non-bot.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fgraceful-degrade-non-bot.test.ts?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "patch": "@@ -3,7 +3,7 @@\n // will not be closed and reset properly. TODO: investigate why browser.close didn't help.\n \n import { nextTestSetup } from 'e2e-utils'\n-import { deleteBrowserDynamicChunks } from '../delete-dynamic-chunk'\n+import { deleteBrowserDynamicChunks } from './delete-dynamic-chunk'\n \n describe('graceful-degrade - non bot', () => {\n   const { next } = nextTestSetup({\n@@ -16,7 +16,7 @@ describe('graceful-degrade - non bot', () => {\n   })\n \n   it('should not degrade to graceful error when chunk loading fails in ssr for non-bot user agents', async () => {\n-    const browser = await next.browser('/')\n+    const browser = await next.browser('/chunk-loading-failed')\n \n     const logs = await browser.log()\n     const errors = logs\n@@ -36,4 +36,20 @@ describe('graceful-degrade - non bot', () => {\n       /Application error: a client-side exception has occurred while loading/\n     )\n   })\n+\n+  it('should show error boundary when browser errors when error boundary is defined', async () => {\n+    const browser = await next.browser('/browser-crash-error-boundary')\n+\n+    const logs = await browser.log()\n+    const errors = logs\n+      .filter((x) => x.source === 'error')\n+      .map((x) => x.message)\n+      .join('\\n')\n+\n+    expect(errors).toMatch(/Error: boom/)\n+\n+    const bodyText = await browser.elementByCss('body').text()\n+    expect(bodyText).toMatch(/Custom error boundary/)\n+    expect(bodyText).not.toMatch(/fine/)\n+  })\n })",
            "previous_filename": "test/production/app-dir/graceful-degrade/basic/graceful-degrade-non-bot.test.ts"
        },
        {
            "sha": "e71d801c7d464d14fb7b2fab13c0c967bcdcac94",
            "filename": "test/production/app-dir/graceful-degrade/graceful-degrade.test.ts",
            "status": "renamed",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fgraceful-degrade.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fgraceful-degrade.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade%2Fgraceful-degrade.test.ts?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { deleteBrowserDynamicChunks } from '../delete-dynamic-chunk'\n+import { deleteBrowserDynamicChunks } from './delete-dynamic-chunk'\n \n describe('graceful-degrade', () => {\n   const { next } = nextTestSetup({\n@@ -12,7 +12,7 @@ describe('graceful-degrade', () => {\n   })\n \n   it('should degrade to graceful error when chunk loading fails in ssr for bot', async () => {\n-    const browser = await next.browser('/', {\n+    const browser = await next.browser('/chunk-loading-failed', {\n       userAgent: 'Googlebot',\n     })\n \n@@ -35,4 +35,24 @@ describe('graceful-degrade', () => {\n       /Application error: a client-side exception has occurred while loading/\n     )\n   })\n+\n+  it('should preserve the ssr html when browser errors for bot', async () => {\n+    const browser = await next.browser('/browser-crash', {\n+      userAgent: 'Googlebot',\n+    })\n+\n+    const logs = await browser.log()\n+    const errors = logs\n+      .filter((x) => x.source === 'error')\n+      .map((x) => x.message)\n+      .join('\\n')\n+\n+    expect(errors).toMatch(/Error: boom/)\n+\n+    const bodyText = await browser.elementByCss('body').text()\n+    expect(bodyText).not.toMatch(\n+      /Application error: a client-side exception has occurred while loading/\n+    )\n+    expect(bodyText).toMatch(/fine/)\n+  })\n })",
            "previous_filename": "test/production/app-dir/graceful-degrade/basic/graceful-degrade.test.ts"
        },
        {
            "sha": "4250e6e5ed7f46149b2f73fb71fc45da2be38b3f",
            "filename": "tsec-exemptions.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/tsec-exemptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/527fe7a0565e4896b7baa7365dbfb5a08f7fd730/tsec-exemptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/tsec-exemptions.json?ref=527fe7a0565e4896b7baa7365dbfb5a08f7fd730",
            "patch": "@@ -12,7 +12,8 @@\n     \"packages/next/src/client/set-attributes-from-props.ts\",\n     \"packages/next/src/build/webpack/loaders/next-style-loader/runtime/injectStylesIntoLinkTag.ts\",\n     \"packages/next/src/build/webpack/loaders/next-style-loader/runtime/injectStylesIntoStyleTag.ts\",\n-    \"packages/next/src/client/app-bootstrap.ts\"\n+    \"packages/next/src/client/app-bootstrap.ts\",\n+    \"packages/next/src/client/components/errors/graceful-degrade-boundary.tsx\"\n   ],\n   \"ban-script-content-assignments\": [\"packages/next/src/client/script.tsx\"],\n   \"ban-script-src-assignments\": ["
        }
    ],
    "stats": {
        "total": 254,
        "additions": 139,
        "deletions": 115
    }
}