{
    "author": "sokra",
    "message": "Turbopack: refactor resolve_url_reference to avoid chunk_path (#77732)\n\n### What?\n\nrefactor resolve_url_reference to avoid chunk_path and use chunk_root_path instead",
    "sha": "2c3c12f9389c1bb17e60fe726f23e0937b849733",
    "files": [
        {
            "sha": "aebcfb627815bbf7aab34611a0edcbd5b63bc43b",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2c3c12f9389c1bb17e60fe726f23e0937b849733/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2c3c12f9389c1bb17e60fe726f23e0937b849733/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=2c3c12f9389c1bb17e60fe726f23e0937b849733",
            "patch": "@@ -329,6 +329,11 @@ impl ChunkingContext for BrowserChunkingContext {\n         *self.environment\n     }\n \n+    #[turbo_tasks::function]\n+    async fn chunk_root_path(&self) -> Vc<FileSystemPath> {\n+        *self.chunk_root_path\n+    }\n+\n     #[turbo_tasks::function]\n     async fn chunk_path(\n         &self,"
        },
        {
            "sha": "ee59a07f383a6be373949deb7f4aee6e9b7ccd24",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking_context.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/2c3c12f9389c1bb17e60fe726f23e0937b849733/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2c3c12f9389c1bb17e60fe726f23e0937b849733/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs?ref=2c3c12f9389c1bb17e60fe726f23e0937b849733",
            "patch": "@@ -123,18 +123,22 @@ pub struct ChunkingConfigs(FxHashMap<ResolvedVc<Box<dyn ChunkType>>, ChunkingCon\n pub trait ChunkingContext {\n     fn name(self: Vc<Self>) -> Vc<RcStr>;\n     fn should_use_file_source_map_uris(self: Vc<Self>) -> Vc<bool>;\n-    // The root path of the project\n+    /// The root path of the project\n     fn root_path(self: Vc<Self>) -> Vc<FileSystemPath>;\n-    // The output root path in the output filesystem\n+    /// The output root path in the output filesystem\n     fn output_root(self: Vc<Self>) -> Vc<FileSystemPath>;\n-    // A relative path how to reach the root path from the output root. This is used to compute\n-    // original paths at runtime relative to the output files. e. g. import.meta.url needs that.\n+    /// A relative path how to reach the root path from the output root. This is used to compute\n+    /// original paths at runtime relative to the output files. e. g. import.meta.url needs that.\n     fn output_root_to_root_path(self: Vc<Self>) -> Vc<RcStr>;\n \n     // TODO remove this, a chunking context should not be bound to a specific\n     // environment since this can change due to transitions in the module graph\n     fn environment(self: Vc<Self>) -> Vc<Environment>;\n \n+    /// The path to the folder where all chunks are placed. This can be used to compute relative\n+    /// paths.\n+    fn chunk_root_path(self: Vc<Self>) -> Vc<FileSystemPath>;\n+\n     // TODO(alexkirsz) Remove this from the chunking context. This should be at the\n     // discretion of chunking context implementors. However, we currently use this\n     // in a couple of places in `turbopack-css`, so we need to remove that"
        },
        {
            "sha": "f86934e3b9db82a45912b95bdd14ebad8f6659e4",
            "filename": "turbopack/crates/turbopack-css/src/references/url.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 11,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/2c3c12f9389c1bb17e60fe726f23e0937b849733/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Furl.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2c3c12f9389c1bb17e60fe726f23e0937b849733/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Furl.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Furl.rs?ref=2c3c12f9389c1bb17e60fe726f23e0937b849733",
            "patch": "@@ -11,7 +11,6 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Value, ValueToString, Vc};\n use turbopack_core::{\n     chunk::{ChunkableModuleReference, ChunkingContext},\n-    ident::AssetIdent,\n     issue::IssueSource,\n     output::OutputAsset,\n     reference::ModuleReference,\n@@ -103,18 +102,9 @@ pub async fn resolve_url_reference(\n     url: Vc<UrlAssetReference>,\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n ) -> Result<Vc<Option<RcStr>>> {\n-    let this = url.await?;\n-    // TODO(WEB-662) This is not the correct way to get the current chunk path. It\n-    // currently works as all chunks are in the same directory.\n-    let chunk_path = chunking_context.chunk_path(\n-        AssetIdent::from_path(this.origin.origin_path()),\n-        \".css\".into(),\n-    );\n-    let context_path = chunk_path.parent().await?;\n+    let context_path = chunking_context.chunk_root_path().await?;\n \n     if let ReferencedAsset::Some(asset) = &*url.get_referenced_asset(chunking_context).await? {\n-        // TODO(WEB-662) This is not the correct way to get the path of the asset.\n-        // `asset` is on module-level, but we need the output-level asset instead.\n         let path = asset.path().await?;\n         let relative_path = context_path\n             .get_relative_path_to(&path)"
        },
        {
            "sha": "6ff272898c05cb63531887886619ef1905a0a1b4",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2c3c12f9389c1bb17e60fe726f23e0937b849733/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2c3c12f9389c1bb17e60fe726f23e0937b849733/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=2c3c12f9389c1bb17e60fe726f23e0937b849733",
            "patch": "@@ -268,6 +268,11 @@ impl ChunkingContext for NodeJsChunkingContext {\n         ))\n     }\n \n+    #[turbo_tasks::function]\n+    async fn chunk_root_path(&self) -> Vc<FileSystemPath> {\n+        *self.chunk_root_path\n+    }\n+\n     #[turbo_tasks::function]\n     async fn chunk_path(\n         &self,"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 19,
        "deletions": 15
    }
}