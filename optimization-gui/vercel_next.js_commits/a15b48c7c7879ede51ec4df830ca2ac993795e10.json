{
    "author": "mischnic",
    "message": "Turbopack: support ignore comments for NFT fs access tracing (#78460)\n\nSupport `readFileSync(/* turbopackIgnore: true */ path, 'utf8')` (and same for `path.resolve` and `path.join`) to ignore it during NFT tracing\r\n\r\nWe already had the infrastructure, just member calls and then specifically the NFT access functions needed to be handled.\r\n\r\nWould fix the failing test in https://github.com/vercel/next.js/pull/78358\r\nPart of PACK-4426",
    "sha": "a15b48c7c7879ede51ec4df830ca2ac993795e10",
    "files": [
        {
            "sha": "6abf9dde68bf7adc8b09b9b514579b76ac1569f5",
            "filename": "turbopack/crates/turbopack-core/src/resolve/pattern.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs?ref=a15b48c7c7879ede51ec4df830ca2ac993795e10",
            "patch": "@@ -122,9 +122,11 @@ impl Pattern {\n         }\n     }\n \n+    /// Whether the pattern has any significant constant parts (everything except `/`).\n+    /// E.g. `<dynamic>/<dynamic>` doesn't really have constant parts\n     pub fn has_constant_parts(&self) -> bool {\n         match self {\n-            Pattern::Constant(_) => true,\n+            Pattern::Constant(str) => str != \"/\",\n             Pattern::Dynamic => false,\n             Pattern::Alternatives(list) | Pattern::Concatenation(list) => {\n                 list.iter().any(|p| p.has_constant_parts())"
        },
        {
            "sha": "f0c0d47bacbe637afc9a53457b63abee6ba57956",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/imports.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs?ref=a15b48c7c7879ede51ec4df830ca2ac993795e10",
            "patch": "@@ -697,14 +697,11 @@ impl Visit for Analyzer<'_> {\n         // we could actually unwrap thanks to the optimisation above but it can't hurt to be safe...\n         if let Some(comments) = self.comments {\n             let callee_span = match &n.callee {\n-                Callee::Import(Import { span, .. }) => Some(span),\n-                Callee::Expr(box Expr::Ident(Ident { span, sym, .. })) if sym == \"require\" => {\n-                    Some(span)\n-                }\n+                Callee::Import(Import { span, .. }) => Some(*span),\n+                Callee::Expr(e) => Some(e.span()),\n                 _ => None,\n             };\n \n-            // we are interested here in the last comment with a valid directive\n             let ignore_directive = parse_ignore_directive(comments, n.args.first());\n \n             if let Some((callee_span, ignore_directive)) = callee_span.zip(ignore_directive) {"
        },
        {
            "sha": "41fb93371d2856eea0b07cf1ee7da53c5d4fc94f",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=a15b48c7c7879ede51ec4df830ca2ac993795e10",
            "patch": "@@ -1820,7 +1820,7 @@ impl JsValue {\n                         \"The Node.js process.cwd method: https://nodejs.org/api/process.html#processcwd\",\n                     ),\n                     WellKnownFunctionKind::NodePreGypFind => (\n-                        \"find\".to_string(),\n+                        \"binary.find\".to_string(),\n                         \"The Node.js @mapbox/node-pre-gyp module: https://github.com/mapbox/node-pre-gyp\",\n                     ),\n                     WellKnownFunctionKind::NodeGypBuild => ("
        },
        {
            "sha": "d5fcf4375117d3fd42d12ba2e20215de9507fa1e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 2,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=a15b48c7c7879ede51ec4df830ca2ac993795e10",
            "patch": "@@ -1312,7 +1312,7 @@ pub(crate) async fn analyse_ecmascript_module_internal(\n                     let func = analysis_state\n                         .link_value(\n                             JsValue::member(Box::new(obj.clone()), Box::new(prop)),\n-                            ImportAttributes::empty_ref(),\n+                            eval_context.imports.get_attributes(span),\n                         )\n                         .await?;\n \n@@ -2875,7 +2875,7 @@ async fn value_visitor_inner(\n             ),\n             _,\n         ) => {\n-            // TODO: figure out how to do static analysis without invalidating the while\n+            // TODO: figure out how to do static analysis without invalidating the whole\n             // analysis when a new file gets added\n             v.into_unknown(\n                 true,\n@@ -2903,6 +2903,20 @@ async fn value_visitor_inner(\n                 v.into_unknown(true, \"new non constant\")\n             }\n         }\n+        JsValue::WellKnownFunction(\n+            WellKnownFunctionKind::PathJoin\n+            | WellKnownFunctionKind::PathResolve(_)\n+            | WellKnownFunctionKind::FsReadMethod(_),\n+        ) => {\n+            if ignore {\n+                return Ok((\n+                    JsValue::unknown(v, true, \"ignored well known function\"),\n+                    true,\n+                ));\n+            } else {\n+                return Ok((v, false));\n+            }\n+        }\n         JsValue::FreeVar(ref kind) => match &**kind {\n             \"__dirname\" => as_abs_path(origin.origin_path().parent()).await?,\n             \"__filename\" => as_abs_path(origin.origin_path()).await?,"
        },
        {
            "sha": "d6547b6e7cb0afab9207394f5bc831d723c66a26",
            "filename": "turbopack/crates/turbopack-ecmascript/src/utils.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs?ref=a15b48c7c7879ede51ec4df830ca2ac993795e10",
            "patch": "@@ -184,7 +184,9 @@ pub fn module_value_to_well_known_object(module_value: &ModuleValue) -> Option<J\n         }\n         \"node:os\" | \"os\" => JsValue::WellKnownObject(WellKnownObjectKind::OsModule),\n         \"node:process\" | \"process\" => JsValue::WellKnownObject(WellKnownObjectKind::NodeProcess),\n-        \"@mapbox/node-pre-gyp\" => JsValue::WellKnownObject(WellKnownObjectKind::NodePreGyp),\n+        \"node-pre-gyp\" | \"@mapbox/node-pre-gyp\" => {\n+            JsValue::WellKnownObject(WellKnownObjectKind::NodePreGyp)\n+        }\n         \"node-gyp-build\" => JsValue::WellKnownFunction(WellKnownFunctionKind::NodeGypBuild),\n         \"node:bindings\" | \"bindings\" => {\n             JsValue::WellKnownFunction(WellKnownFunctionKind::NodeBindings)"
        },
        {
            "sha": "22d3095a1820e40d43593c2c78f4857643bba1b0",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a15b48c7c7879ede51ec4df830ca2ac993795e10/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=a15b48c7c7879ede51ec4df830ca2ac993795e10",
            "patch": "@@ -668,6 +668,9 @@ async fn externals_tracing_module_context(ty: ExternalType) -> Result<Vc<ModuleA\n     Ok(ModuleAssetContext::new_without_replace_externals(\n         Default::default(),\n         CompileTimeInfo::builder(env).cell().await?,\n+        // Keep these options more or less in sync with\n+        // turbopack/crates/turbopack/tests/node-file-trace.rs to ensure that the NFT unit tests\n+        // are actually representative of what Turbopack does.\n         ModuleOptionsContext {\n             ecmascript: EcmascriptOptionsContext {\n                 source_maps: SourceMapsType::None,"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 28,
        "deletions": 10
    }
}