{
    "author": "timneutkens",
    "message": "Tests: Move build-indicator test to test/development (#83591)\n\n## What?\n\nMove build-indicator test to be isolated using the modern test utils.\nIt's still flaking so ruling out the other causes.",
    "sha": "89ab752acdb2c5e39228e67a8b7a7852778a7863",
    "files": [
        {
            "sha": "2d268750b169c97c46604123da1e3bb00ff9869a",
            "filename": "test/e2e/build-indicator/app/app/a/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fa%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fa%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fa%2Fpage.js?ref=89ab752acdb2c5e39228e67a8b7a7852778a7863",
            "previous_filename": "test/integration/build-indicator/app/app/a/page.js"
        },
        {
            "sha": "ca7c8b405d622840755c3302e57b1768df1db87b",
            "filename": "test/e2e/build-indicator/app/app/b/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fb%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fb%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fb%2Fpage.js?ref=89ab752acdb2c5e39228e67a8b7a7852778a7863",
            "previous_filename": "test/integration/build-indicator/app/app/b/page.js"
        },
        {
            "sha": "d9c859d20358c9d5c7c68df329b898ceff32ea44",
            "filename": "test/e2e/build-indicator/app/app/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Fapp%2Fapp%2Fpage.js?ref=89ab752acdb2c5e39228e67a8b7a7852778a7863",
            "previous_filename": "test/integration/build-indicator/app/app/page.js"
        },
        {
            "sha": "8525f5f8c0b2a141bd773685bf9951fc9afcc707",
            "filename": "test/e2e/build-indicator/app/layout.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Fapp%2Flayout.js?ref=89ab752acdb2c5e39228e67a8b7a7852778a7863",
            "previous_filename": "test/integration/build-indicator/app/layout.js"
        },
        {
            "sha": "45361f18d6af33ac51ee163b697ea21cb7b50849",
            "filename": "test/e2e/build-indicator/pages/a.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fpages%2Fa.js",
            "raw_url": "https://github.com/vercel/next.js/raw/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fpages%2Fa.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Fpages%2Fa.js?ref=89ab752acdb2c5e39228e67a8b7a7852778a7863",
            "previous_filename": "test/integration/build-indicator/pages/a.js"
        },
        {
            "sha": "fb38aab0d4496af179f897d02fcdecfd2feeb021",
            "filename": "test/e2e/build-indicator/pages/b.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fpages%2Fb.js",
            "raw_url": "https://github.com/vercel/next.js/raw/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fpages%2Fb.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Fpages%2Fb.js?ref=89ab752acdb2c5e39228e67a8b7a7852778a7863",
            "previous_filename": "test/integration/build-indicator/pages/b.js"
        },
        {
            "sha": "db0a7a5f4c3e1aaf6c3be297840cda8c355f05a9",
            "filename": "test/e2e/build-indicator/pages/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Fpages%2Findex.js?ref=89ab752acdb2c5e39228e67a8b7a7852778a7863",
            "previous_filename": "test/integration/build-indicator/pages/index.js"
        },
        {
            "sha": "442f1b70b6721e54fd7e73fd51660d469f6407d7",
            "filename": "test/e2e/build-indicator/test/index.test.ts",
            "status": "added",
            "additions": 86,
            "deletions": 0,
            "changes": 86,
            "blob_url": "https://github.com/vercel/next.js/blob/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/89ab752acdb2c5e39228e67a8b7a7852778a7863/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts?ref=89ab752acdb2c5e39228e67a8b7a7852778a7863",
            "patch": "@@ -0,0 +1,86 @@\n+/* eslint-env jest */\n+import { join } from 'path'\n+import { retry } from 'next-test-utils'\n+import { nextTestSetup, isNextDev, isNextStart } from 'e2e-utils'\n+\n+const installCheckVisible = (browser) => {\n+  return browser.eval(`(function() {\n+      window.checkInterval = setInterval(function() {\n+      const root = document.querySelector('nextjs-portal').shadowRoot;\n+      const indicator = root.querySelector('[data-next-mark]')\n+      if(!indicator) return\n+      window.showedBuilder = window.showedBuilder || (\n+        indicator.getAttribute('data-next-mark-loading') === 'true'\n+      )\n+      if (window.showedBuilder) clearInterval(window.checkInterval)\n+    }, 5)\n+  })()`)\n+}\n+\n+describe('Build Activity Indicator', () => {\n+  // Use describe.skip so that this suite does not fail with \"no tests\" during deploy tests.\n+  ;(isNextStart ? describe : describe.skip)('Invalid position config', () => {\n+    const { next } = nextTestSetup({\n+      files: join(__dirname, '..'),\n+      skipStart: true,\n+      startServerTimeout: 1000,\n+      nextConfig: {\n+        devIndicators: {\n+          // Intentionally invalid position to test error\n+          position: 'ttop-leff' as any,\n+        },\n+      },\n+    })\n+\n+    it('should validate position config', async () => {\n+      const result = await next.build()\n+\n+      expect(result.exitCode).toBe(1)\n+      expect(result.cliOutput).toContain(\n+        `Invalid \"devIndicator.position\" provided, expected one of top-left, top-right, bottom-left, bottom-right, received ttop-leff`\n+      )\n+    })\n+  })\n+\n+  if (isNextDev) {\n+    describe.each(['pages', 'app'])('Enabled - (%s)', (pagesOrApp) => {\n+      const { next } = nextTestSetup({\n+        files: join(__dirname, '..'),\n+      })\n+\n+      ;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n+        'webpack only',\n+        () => {\n+          it('Shows the build indicator when a page is built during navigation', async () => {\n+            const browser = await next.browser(\n+              pagesOrApp === 'pages' ? '/' : '/app'\n+            )\n+            await installCheckVisible(browser)\n+            await browser.elementByCss('#to-a').click()\n+            await retry(async () => {\n+              const wasVisible = await browser.eval('window.showedBuilder')\n+              expect(wasVisible).toBe(true)\n+            })\n+          })\n+        }\n+      )\n+\n+      it('Shows build indicator when page is built from modifying', async () => {\n+        const browser = await next.browser(\n+          pagesOrApp === 'pages' ? '/b' : '/app/b'\n+        )\n+        await installCheckVisible(browser)\n+        const pagePath =\n+          pagesOrApp === 'pages' ? 'pages/b.js' : 'app/app/b/page.js'\n+\n+        await next.patchFile(pagePath, (content) => content.replace('b', 'c'))\n+\n+        await retry(async () => {\n+          const wasVisible = await browser.eval('window.showedBuilder')\n+\n+          expect(wasVisible).toBe(true)\n+        })\n+      })\n+    })\n+  }\n+})"
        },
        {
            "sha": "efc305a161b7d17da418fd3827eb7f58f551e6bd",
            "filename": "test/integration/build-indicator/test/index.test.js",
            "status": "removed",
            "additions": 0,
            "deletions": 115,
            "changes": 115,
            "blob_url": "https://github.com/vercel/next.js/blob/ffee9aabc430075f59d22b5b8b435c98515f085d/test%2Fintegration%2Fbuild-indicator%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ffee9aabc430075f59d22b5b8b435c98515f085d/test%2Fintegration%2Fbuild-indicator%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbuild-indicator%2Ftest%2Findex.test.js?ref=ffee9aabc430075f59d22b5b8b435c98515f085d",
            "patch": "@@ -1,115 +0,0 @@\n-/* eslint-env jest */\n-\n-import fs from 'fs-extra'\n-import { join } from 'path'\n-import webdriver from 'next-webdriver'\n-import { findPort, launchApp, killApp, retry } from 'next-test-utils'\n-import stripAnsi from 'strip-ansi'\n-\n-const appDir = join(__dirname, '..')\n-const nextConfig = join(appDir, 'next.config.js')\n-let appPort\n-let app\n-\n-const installCheckVisible = (browser) => {\n-  return browser.eval(`(function() {\n-      window.checkInterval = setInterval(function() {\n-      const root = document.querySelector('nextjs-portal').shadowRoot;\n-      const indicator = root.querySelector('[data-next-mark]')\n-      window.showedBuilder = window.showedBuilder || (\n-        indicator.getAttribute('data-next-mark-loading') === 'true'\n-      )\n-      if (window.showedBuilder) clearInterval(window.checkInterval)\n-    }, 5)\n-  })()`)\n-}\n-\n-describe('Build Activity Indicator', () => {\n-  it('should validate position config', async () => {\n-    let stderr = ''\n-    const configPath = join(appDir, 'next.config.js')\n-    await fs.writeFile(\n-      configPath,\n-      `\n-      module.exports = {\n-        devIndicators: {\n-          position: 'ttop-leff'\n-        }\n-      }\n-    `\n-    )\n-    const app = await launchApp(appDir, await findPort(), {\n-      onStderr(msg) {\n-        stderr += msg\n-      },\n-    }).catch((err) => {\n-      console.error('got err', err)\n-    })\n-    await fs.remove(configPath)\n-\n-    await retry(async () => {\n-      const content = stripAnsi(stderr)\n-      expect(content).toMatch(\n-        new RegExp(\n-          `Invalid \"devIndicator.position\" provided, expected one of top-left, top-right, bottom-left, bottom-right, received ttop-leff`\n-        )\n-      )\n-    })\n-\n-    if (app) {\n-      await killApp(app)\n-    }\n-  })\n-\n-  describe.each(['pages', 'app'])('Enabled - (%s)', (pagesOrApp) => {\n-    beforeAll(async () => {\n-      await fs.remove(nextConfig)\n-      appPort = await findPort()\n-      app = await launchApp(appDir, appPort)\n-    })\n-    afterAll(() => killApp(app))\n-    ;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n-      'webpack only',\n-      () => {\n-        it('Shows the build indicator when a page is built during navigation', async () => {\n-          const browser = await webdriver(\n-            appPort,\n-            pagesOrApp === 'pages' ? '/' : '/app'\n-          )\n-          await installCheckVisible(browser)\n-          await browser.elementByCss('#to-a').click()\n-          await retry(async () => {\n-            const wasVisible = await browser.eval('window.showedBuilder')\n-            expect(wasVisible).toBe(true)\n-          })\n-\n-          await browser.close()\n-        })\n-      }\n-    )\n-\n-    it('Shows build indicator when page is built from modifying', async () => {\n-      const browser = await webdriver(\n-        appPort,\n-        pagesOrApp === 'pages' ? '/b' : '/app/b'\n-      )\n-      await installCheckVisible(browser)\n-      const pagePath = join(\n-        appDir,\n-        pagesOrApp === 'pages' ? 'pages/b.js' : 'app/app/b/page.js'\n-      )\n-      const origContent = await fs.readFile(pagePath, 'utf8')\n-      const newContent = origContent.replace('b', 'c')\n-\n-      await fs.writeFile(pagePath, newContent, 'utf8')\n-\n-      await retry(async () => {\n-        const wasVisible = await browser.eval('window.showedBuilder')\n-\n-        expect(wasVisible).toBe(true)\n-      })\n-      await fs.writeFile(pagePath, origContent, 'utf8')\n-      await browser.close()\n-    })\n-  })\n-})"
        }
    ],
    "stats": {
        "total": 201,
        "additions": 86,
        "deletions": 115
    }
}