{
    "author": "huozhi",
    "message": "telemetry: mcp tool call (#85120)",
    "sha": "98adcb3f86e198265b8f72f2b133aa22564e250b",
    "files": [
        {
            "sha": "caa6ddbc3c5ca26f9ac9e81c7a58c8453f332a16",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -119,6 +119,7 @@ import { getMcpMiddleware } from '../mcp/get-mcp-middleware'\n import { handleErrorStateResponse } from '../mcp/tools/get-errors'\n import { handlePageMetadataResponse } from '../mcp/tools/get-page-metadata'\n import { setStackFrameResolver } from '../mcp/tools/utils/format-errors'\n+import { recordMcpTelemetry } from '../mcp/mcp-telemetry-tracker'\n import { getFileLogger } from './browser-logs/file-logger'\n import type { ServerCacheStatus } from '../../next-devtools/dev-overlay/cache-indicator'\n import type { Lockfile } from '../../build/lockfile'\n@@ -1393,6 +1394,9 @@ export async function createHotReloaderTurbopack(\n         })\n     },\n     close() {\n+      // Report MCP telemetry if MCP server is enabled\n+      recordMcpTelemetry(opts.telemetry)\n+\n       for (const wsClient of [\n         ...clientsWithoutRequestId,\n         ...clientsByRequestId.values(),"
        },
        {
            "sha": "05c42dc03b284b60f8a0762ff5cdfb687da34135",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -109,6 +109,7 @@ import {\n } from './hot-reloader-shared-utils'\n import { getMcpMiddleware } from '../mcp/get-mcp-middleware'\n import { setStackFrameResolver } from '../mcp/tools/utils/format-errors'\n+import { recordMcpTelemetry } from '../mcp/mcp-telemetry-tracker'\n import { getFileLogger } from './browser-logs/file-logger'\n import type { ServerCacheStatus } from '../../next-devtools/dev-overlay/cache-indicator'\n import type { Lockfile } from '../../build/lockfile'\n@@ -1821,6 +1822,9 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n   }\n \n   public close() {\n+    // Report MCP telemetry if MCP server is enabled\n+    recordMcpTelemetry(this.telemetry)\n+\n     this.webpackHotMiddleware?.close()\n   }\n }"
        },
        {
            "sha": "c31a74b5b7fe364c4e7cf2a54f7b62398b51b023",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -419,6 +419,24 @@ export async function startServer(\n               cleanupListeners?.runAll().catch(console.error),\n             ])\n \n+            // Flush telemetry if this is a dev server\n+            if (isDev) {\n+              try {\n+                const { traceGlobals } =\n+                  require('../../trace/shared') as typeof import('../../trace/shared')\n+                const telemetry = traceGlobals.get('telemetry') as\n+                  | InstanceType<\n+                      typeof import('../../telemetry/storage').Telemetry\n+                    >\n+                  | undefined\n+                if (telemetry) {\n+                  await telemetry.flush()\n+                }\n+              } catch (_) {\n+                // Ignore telemetry errors during cleanup\n+              }\n+            }\n+\n             debug('start-server process cleanup finished')\n             process.exit(0)\n           })()"
        },
        {
            "sha": "95aece08fdeb141b1f16bfefe7c2744978db464d",
            "filename": "packages/next/src/server/mcp/mcp-telemetry-tracker.test.ts",
            "status": "added",
            "additions": 131,
            "deletions": 0,
            "changes": 131,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fmcp-telemetry-tracker.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fmcp-telemetry-tracker.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fmcp-telemetry-tracker.test.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -0,0 +1,131 @@\n+/**\n+ * @jest-environment node\n+ */\n+\n+import { mcpTelemetryTracker } from './mcp-telemetry-tracker'\n+\n+describe('MCP Telemetry Tracker', () => {\n+  beforeEach(() => {\n+    // Reset tracker state before each test\n+    mcpTelemetryTracker.reset()\n+  })\n+\n+  afterAll(() => {\n+    // Clean up after all tests\n+    mcpTelemetryTracker.reset()\n+  })\n+\n+  it('should start with no usage', () => {\n+    expect(mcpTelemetryTracker.hasUsage()).toBe(false)\n+    expect(mcpTelemetryTracker.getUsages()).toEqual([])\n+  })\n+\n+  it('should track single tool call', () => {\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors')\n+\n+    expect(mcpTelemetryTracker.hasUsage()).toBe(true)\n+    expect(mcpTelemetryTracker.getUsages()).toEqual([\n+      {\n+        featureName: 'mcp/get_errors',\n+        invocationCount: 1,\n+      },\n+    ])\n+  })\n+\n+  it('should increment invocation count for repeated calls', () => {\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors')\n+\n+    const usages = mcpTelemetryTracker.getUsages()\n+    expect(usages).toHaveLength(1)\n+    expect(usages[0]).toEqual({\n+      featureName: 'mcp/get_errors',\n+      invocationCount: 3,\n+    })\n+  })\n+\n+  it('should track multiple different tools', () => {\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_logs')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_page_metadata')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors') // Duplicate\n+\n+    const usages = mcpTelemetryTracker.getUsages()\n+    expect(usages).toHaveLength(3)\n+\n+    // Find each tool in the results\n+    const errorsUsage = usages.find((u) => u.featureName === 'mcp/get_errors')\n+    const logsUsage = usages.find((u) => u.featureName === 'mcp/get_logs')\n+    const pageMetadataUsage = usages.find(\n+      (u) => u.featureName === 'mcp/get_page_metadata'\n+    )\n+\n+    expect(errorsUsage).toEqual({\n+      featureName: 'mcp/get_errors',\n+      invocationCount: 2,\n+    })\n+    expect(logsUsage).toEqual({\n+      featureName: 'mcp/get_logs',\n+      invocationCount: 1,\n+    })\n+    expect(pageMetadataUsage).toEqual({\n+      featureName: 'mcp/get_page_metadata',\n+      invocationCount: 1,\n+    })\n+  })\n+\n+  it('should track all 5 MCP tools', () => {\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_logs')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_page_metadata')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_project_metadata')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_server_action_by_id')\n+\n+    const usages = mcpTelemetryTracker.getUsages()\n+    expect(usages).toHaveLength(5)\n+\n+    const toolNames = usages.map((u) => u.featureName)\n+    expect(toolNames).toContain('mcp/get_errors')\n+    expect(toolNames).toContain('mcp/get_logs')\n+    expect(toolNames).toContain('mcp/get_page_metadata')\n+    expect(toolNames).toContain('mcp/get_project_metadata')\n+    expect(toolNames).toContain('mcp/get_server_action_by_id')\n+  })\n+\n+  it('should reset tracking', () => {\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors')\n+    mcpTelemetryTracker.recordToolCall('mcp/get_logs')\n+\n+    expect(mcpTelemetryTracker.hasUsage()).toBe(true)\n+    expect(mcpTelemetryTracker.getUsages()).toHaveLength(2)\n+\n+    mcpTelemetryTracker.reset()\n+\n+    expect(mcpTelemetryTracker.hasUsage()).toBe(false)\n+    expect(mcpTelemetryTracker.getUsages()).toEqual([])\n+  })\n+\n+  it('should maintain accurate counts across multiple operations', () => {\n+    // Simulate realistic usage pattern\n+    mcpTelemetryTracker.recordToolCall('mcp/get_project_metadata') // 1\n+    mcpTelemetryTracker.recordToolCall('mcp/get_page_metadata') // 1\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors') // 1\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors') // 2\n+    mcpTelemetryTracker.recordToolCall('mcp/get_page_metadata') // 2\n+    mcpTelemetryTracker.recordToolCall('mcp/get_errors') // 3\n+    mcpTelemetryTracker.recordToolCall('mcp/get_logs') // 1\n+\n+    const usages = mcpTelemetryTracker.getUsages()\n+    expect(usages).toHaveLength(4)\n+\n+    const counts = new Map(\n+      usages.map((u) => [u.featureName, u.invocationCount])\n+    )\n+\n+    expect(counts.get('mcp/get_errors')).toBe(3)\n+    expect(counts.get('mcp/get_page_metadata')).toBe(2)\n+    expect(counts.get('mcp/get_project_metadata')).toBe(1)\n+    expect(counts.get('mcp/get_logs')).toBe(1)\n+  })\n+})"
        },
        {
            "sha": "64d0f745d3ef7fb3d15712640de2cb18bf34c86a",
            "filename": "packages/next/src/server/mcp/mcp-telemetry-tracker.ts",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fmcp-telemetry-tracker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fmcp-telemetry-tracker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fmcp-telemetry-tracker.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -0,0 +1,83 @@\n+/**\n+ * Telemetry tracker for MCP tool call usage.\n+ * Tracks invocation counts for each MCP tool to be reported via telemetry.\n+ */\n+\n+import type { McpToolName } from '../../telemetry/events/build'\n+\n+export interface McpToolUsage {\n+  featureName: McpToolName\n+  invocationCount: number\n+}\n+\n+class McpTelemetryTracker {\n+  private usageMap = new Map<McpToolName, number>()\n+\n+  /**\n+   * Record a tool call invocation\n+   */\n+  recordToolCall(toolName: McpToolName): void {\n+    const current = this.usageMap.get(toolName) || 0\n+    this.usageMap.set(toolName, current + 1)\n+  }\n+\n+  /**\n+   * Get all tool usages as an array\n+   */\n+  getUsages(): McpToolUsage[] {\n+    return Array.from(this.usageMap.entries()).map(([featureName, count]) => ({\n+      featureName,\n+      invocationCount: count,\n+    }))\n+  }\n+\n+  /**\n+   * Reset all usage tracking\n+   */\n+  reset(): void {\n+    this.usageMap.clear()\n+  }\n+\n+  /**\n+   * Check if any tools have been called\n+   */\n+  hasUsage(): boolean {\n+    return this.usageMap.size > 0\n+  }\n+}\n+\n+// Singleton instance\n+export const mcpTelemetryTracker = new McpTelemetryTracker()\n+\n+/**\n+ * Get MCP tool usage telemetry\n+ */\n+export function getMcpTelemetryUsage(): McpToolUsage[] {\n+  return mcpTelemetryTracker.getUsages()\n+}\n+\n+/**\n+ * Reset MCP telemetry tracker\n+ */\n+export function resetMcpTelemetry(): void {\n+  mcpTelemetryTracker.reset()\n+}\n+\n+/**\n+ * Record MCP telemetry usage to the telemetry instance\n+ */\n+export function recordMcpTelemetry(telemetry: {\n+  record: (event: any) => void\n+}): void {\n+  const mcpUsages = getMcpTelemetryUsage()\n+  if (mcpUsages.length === 0) {\n+    return\n+  }\n+\n+  const { eventMcpToolUsage } =\n+    require('../../telemetry/events/build') as typeof import('../../telemetry/events/build')\n+  const events = eventMcpToolUsage(mcpUsages)\n+  for (const event of events) {\n+    telemetry.record(event)\n+  }\n+}"
        },
        {
            "sha": "a14bbc911f1ff0f1e85a7bed018f624c773df7ef",
            "filename": "packages/next/src/server/mcp/tools/get-errors.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -26,6 +26,7 @@ import {\n   DEFAULT_BROWSER_REQUEST_TIMEOUT_MS,\n } from './utils/browser-communication'\n import { NextInstanceErrorState } from './next-instance-error-state'\n+import { mcpTelemetryTracker } from '../mcp-telemetry-tracker'\n \n export function registerGetErrorsTool(\n   server: McpServer,\n@@ -40,6 +41,9 @@ export function registerGetErrorsTool(\n       inputSchema: {},\n     },\n     async (_request) => {\n+      // Track telemetry\n+      mcpTelemetryTracker.recordToolCall('mcp/get_errors')\n+\n       try {\n         const connectionCount = getActiveConnectionCount()\n         if (connectionCount === 0) {"
        },
        {
            "sha": "4c9c2631cf5b0f30098809f1d2123945f12ab112",
            "filename": "packages/next/src/server/mcp/tools/get-logs.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-logs.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-logs.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-logs.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -7,6 +7,7 @@\n import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n import { stat } from 'fs/promises'\n import { join } from 'path'\n+import { mcpTelemetryTracker } from '../mcp-telemetry-tracker'\n \n export function registerGetLogsTool(server: McpServer, distDir: string) {\n   server.registerTool(\n@@ -16,6 +17,9 @@ export function registerGetLogsTool(server: McpServer, distDir: string) {\n         'Get the path to the Next.js development log file. Returns the file path so the agent can read the logs directly.',\n     },\n     async () => {\n+      // Track telemetry\n+      mcpTelemetryTracker.recordToolCall('mcp/get_logs')\n+\n       try {\n         const logFilePath = join(distDir, 'logs', 'next-development.log')\n "
        },
        {
            "sha": "7008e9343a5b7e2e9828d0b598a8ca8eb47e5082",
            "filename": "packages/next/src/server/mcp/tools/get-page-metadata.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -14,6 +14,7 @@ import type {\n   SegmentTrieData,\n } from '../../../shared/lib/mcp-page-metadata-types'\n import type { SegmentTrieNode } from '../../../next-devtools/dev-overlay/segment-explorer-trie'\n+import { mcpTelemetryTracker } from '../mcp-telemetry-tracker'\n \n export function registerGetPageMetadataTool(\n   server: McpServer,\n@@ -28,6 +29,9 @@ export function registerGetPageMetadataTool(\n       inputSchema: {},\n     },\n     async (_request) => {\n+      // Track telemetry\n+      mcpTelemetryTracker.recordToolCall('mcp/get_page_metadata')\n+\n       try {\n         const connectionCount = getActiveConnectionCount()\n         if (connectionCount === 0) {"
        },
        {
            "sha": "0e058859b5d2e9c18128717f337d8f3d039fed9d",
            "filename": "packages/next/src/server/mcp/tools/get-project-metadata.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-metadata.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -1,4 +1,5 @@\n import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n+import { mcpTelemetryTracker } from '../mcp-telemetry-tracker'\n \n export function registerGetProjectMetadataTool(\n   server: McpServer,\n@@ -13,6 +14,9 @@ export function registerGetProjectMetadataTool(\n       inputSchema: {},\n     },\n     async (_request) => {\n+      // Track telemetry\n+      mcpTelemetryTracker.recordToolCall('mcp/get_project_metadata')\n+\n       try {\n         if (!projectPath) {\n           return {"
        },
        {
            "sha": "5662383fa7b29bcc9103f47365c2c4aeff76ee8e",
            "filename": "packages/next/src/server/mcp/tools/get-server-action-by-id.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-server-action-by-id.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-server-action-by-id.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-server-action-by-id.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -2,6 +2,7 @@ import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/ser\n import { z } from 'next/dist/compiled/zod'\n import { promises as fs } from 'fs'\n import { join } from 'path'\n+import { mcpTelemetryTracker } from '../mcp-telemetry-tracker'\n \n const INLINE_ACTION_PREFIX = '$$RSC_SERVER_ACTION_'\n \n@@ -29,6 +30,9 @@ export function registerGetActionByIdTool(server: McpServer, distDir: string) {\n       },\n     },\n     async (request) => {\n+      // Track telemetry\n+      mcpTelemetryTracker.recordToolCall('mcp/get_server_action_by_id')\n+\n       try {\n         const { actionId } = request\n "
        },
        {
            "sha": "1defc69eaeac12c6a5ce5858841553ea238ff9ed",
            "filename": "packages/next/src/telemetry/events/build.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -230,6 +230,32 @@ export function eventPackageUsedInGetServerSideProps(\n   }))\n }\n \n+export const EVENT_MCP_TOOL_USAGE = 'NEXT_MCP_TOOL_USAGE'\n+\n+export type McpToolName =\n+  | 'mcp/get_errors'\n+  | 'mcp/get_logs'\n+  | 'mcp/get_page_metadata'\n+  | 'mcp/get_project_metadata'\n+  | 'mcp/get_server_action_by_id'\n+\n+export type EventMcpToolUsage = {\n+  toolName: McpToolName\n+  invocationCount: number\n+}\n+\n+export function eventMcpToolUsage(\n+  usages: Array<{ featureName: McpToolName; invocationCount: number }>\n+): Array<{ eventName: string; payload: EventMcpToolUsage }> {\n+  return usages.map(({ featureName, invocationCount }) => ({\n+    eventName: EVENT_MCP_TOOL_USAGE,\n+    payload: {\n+      toolName: featureName,\n+      invocationCount,\n+    },\n+  }))\n+}\n+\n export const ERROR_THROWN_EVENT = 'NEXT_ERROR_THROWN'\n type ErrorThrownEvent = {\n   eventName: typeof ERROR_THROWN_EVENT"
        },
        {
            "sha": "3484b4633859c76b2fdb29b2b0b65211ff21735c",
            "filename": "packages/next/src/telemetry/events/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Findex.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -1,3 +1,7 @@\n export * from './version'\n export * from './build'\n export * from './plugins'\n+\n+// Re-export MCP-specific types and functions\n+export type { McpToolName, EventMcpToolUsage } from './build'\n+export { EVENT_MCP_TOOL_USAGE, eventMcpToolUsage } from './build'"
        },
        {
            "sha": "c73891209f31789e37a5403e59a6c2d390162f17",
            "filename": "packages/next/src/telemetry/events/mcp-telemetry.test.ts",
            "status": "added",
            "additions": 123,
            "deletions": 0,
            "changes": 123,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fmcp-telemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fmcp-telemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fmcp-telemetry.test.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -0,0 +1,123 @@\n+/**\n+ * @jest-environment node\n+ */\n+\n+import { eventMcpToolUsage, EVENT_MCP_TOOL_USAGE } from './build'\n+import type { McpToolName } from './build'\n+\n+describe('MCP Telemetry Events', () => {\n+  it('should generate correct telemetry events for single tool', () => {\n+    const usages = [\n+      {\n+        featureName: 'mcp/get_errors' as McpToolName,\n+        invocationCount: 5,\n+      },\n+    ]\n+\n+    const events = eventMcpToolUsage(usages)\n+\n+    expect(events).toHaveLength(1)\n+    expect(events[0]).toEqual({\n+      eventName: EVENT_MCP_TOOL_USAGE,\n+      payload: {\n+        toolName: 'mcp/get_errors',\n+        invocationCount: 5,\n+      },\n+    })\n+  })\n+\n+  it('should generate correct telemetry events for multiple tools', () => {\n+    const usages = [\n+      {\n+        featureName: 'mcp/get_errors' as McpToolName,\n+        invocationCount: 3,\n+      },\n+      {\n+        featureName: 'mcp/get_logs' as McpToolName,\n+        invocationCount: 1,\n+      },\n+      {\n+        featureName: 'mcp/get_page_metadata' as McpToolName,\n+        invocationCount: 7,\n+      },\n+    ]\n+\n+    const events = eventMcpToolUsage(usages)\n+\n+    expect(events).toHaveLength(3)\n+\n+    expect(events[0]).toEqual({\n+      eventName: EVENT_MCP_TOOL_USAGE,\n+      payload: {\n+        toolName: 'mcp/get_errors',\n+        invocationCount: 3,\n+      },\n+    })\n+\n+    expect(events[1]).toEqual({\n+      eventName: EVENT_MCP_TOOL_USAGE,\n+      payload: {\n+        toolName: 'mcp/get_logs',\n+        invocationCount: 1,\n+      },\n+    })\n+\n+    expect(events[2]).toEqual({\n+      eventName: EVENT_MCP_TOOL_USAGE,\n+      payload: {\n+        toolName: 'mcp/get_page_metadata',\n+        invocationCount: 7,\n+      },\n+    })\n+  })\n+\n+  it('should handle all MCP tool types', () => {\n+    const allTools: McpToolName[] = [\n+      'mcp/get_errors',\n+      'mcp/get_logs',\n+      'mcp/get_page_metadata',\n+      'mcp/get_project_metadata',\n+      'mcp/get_server_action_by_id',\n+    ]\n+\n+    const usages = allTools.map((tool, index) => ({\n+      featureName: tool,\n+      invocationCount: index + 1,\n+    }))\n+\n+    const events = eventMcpToolUsage(usages)\n+\n+    expect(events).toHaveLength(5)\n+\n+    events.forEach((event, index) => {\n+      expect(event.eventName).toBe(EVENT_MCP_TOOL_USAGE)\n+      expect(event.payload.toolName).toBe(allTools[index])\n+      expect(event.payload.invocationCount).toBe(index + 1)\n+    })\n+  })\n+\n+  it('should handle empty usage array', () => {\n+    const events = eventMcpToolUsage([])\n+    expect(events).toEqual([])\n+  })\n+\n+  it('should use correct event name constant', () => {\n+    expect(EVENT_MCP_TOOL_USAGE).toBe('NEXT_MCP_TOOL_USAGE')\n+  })\n+\n+  it('should transform featureName to toolName in payload', () => {\n+    const usages = [\n+      {\n+        featureName: 'mcp/get_project_metadata' as McpToolName,\n+        invocationCount: 2,\n+      },\n+    ]\n+\n+    const events = eventMcpToolUsage(usages)\n+\n+    // Verify the input has 'featureName' but output has 'toolName'\n+    expect(usages[0]).toHaveProperty('featureName')\n+    expect(events[0].payload).toHaveProperty('toolName')\n+    expect(events[0].payload).not.toHaveProperty('featureName')\n+  })\n+})"
        },
        {
            "sha": "83068eda784613a3dda7d528313e6f21939ecc1b",
            "filename": "packages/next/src/telemetry/events/version.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fversion.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fversion.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fversion.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -40,7 +40,6 @@ type EventCliSessionStarted = {\n   reactCompiler: boolean\n   reactCompilerCompilationMode: string | null\n   reactCompilerPanicThreshold: string | null\n-  mcpServer: boolean | null\n }\n \n export function eventCliSession(\n@@ -75,7 +74,6 @@ export function eventCliSession(\n     | 'reactCompiler'\n     | 'reactCompilerCompilationMode'\n     | 'reactCompilerPanicThreshold'\n-    | 'mcpServer'\n     | 'isRspack'\n   >\n ): { eventName: string; payload: EventCliSessionStarted }[] {\n@@ -134,11 +132,6 @@ export function eventCliSession(\n       typeof nextConfig.reactCompiler !== 'boolean'\n         ? (nextConfig.reactCompiler?.panicThreshold ?? null)\n         : null,\n-    // Default mcpServer to true if not set\n-    mcpServer:\n-      typeof nextConfig.experimental.mcpServer === 'boolean'\n-        ? nextConfig.experimental.mcpServer\n-        : true,\n   }\n   return [{ eventName: EVENT_VERSION, payload }]\n }"
        },
        {
            "sha": "96d3372cdde9407e7587b2f99b0a721a4b62d6fd",
            "filename": "test/development/mcp-server/mcp-server-telemetry.test.ts",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/98adcb3f86e198265b8f72f2b133aa22564e250b/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-telemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/98adcb3f86e198265b8f72f2b133aa22564e250b/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-telemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-telemetry.test.ts?ref=98adcb3f86e198265b8f72f2b133aa22564e250b",
            "patch": "@@ -0,0 +1,81 @@\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+import { findAllTelemetryEvents } from 'next-test-utils'\n+import path from 'path'\n+\n+describe('mcp-server telemetry tracking', () => {\n+  const { next } = nextTestSetup({\n+    files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n+    env: {\n+      NEXT_TELEMETRY_DEBUG: '1',\n+    },\n+  })\n+\n+  async function callMcpTool(\n+    toolName: string,\n+    params: Record<string, any> = {}\n+  ) {\n+    const response = await fetch(`${next.url}/_next/mcp`, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+        Accept: 'application/json, text/event-stream',\n+      },\n+      body: JSON.stringify({\n+        jsonrpc: '2.0',\n+        id: `telemetry-test-${Date.now()}`,\n+        method: 'tools/call',\n+        params: { name: toolName, arguments: params },\n+      }),\n+    })\n+\n+    const text = await response.text()\n+    const match = text.match(/data: ({.*})/s)\n+    if (!match) {\n+      throw new Error(`Failed to parse response for tool ${toolName}`)\n+    }\n+    return JSON.parse(match[1])\n+  }\n+\n+  it('should record MCP tool usage telemetry on server shutdown', async () => {\n+    // Call different MCP tools\n+    await callMcpTool('get_project_metadata')\n+    await callMcpTool('get_logs')\n+    await callMcpTool('get_errors')\n+\n+    // Open browser and call page_metadata\n+    await next.browser('/')\n+    await callMcpTool('get_page_metadata')\n+\n+    // Call some tools multiple times\n+    await callMcpTool('get_project_metadata')\n+    await callMcpTool('get_errors')\n+\n+    // Stop the dev server to trigger telemetry recording\n+    // Use SIGTERM so cleanup handlers can run\n+    await next.stop('SIGTERM')\n+\n+    // Parse telemetry from CLI output\n+    const output = next.cliOutput\n+    const events = findAllTelemetryEvents(output, 'NEXT_MCP_TOOL_USAGE')\n+\n+    // Verify telemetry events were recorded\n+    expect(events.length).toBeGreaterThan(0)\n+\n+    // Check that specific tools were tracked\n+    const toolUsages = new Map(\n+      events.map((e) => [e.toolName, e.invocationCount])\n+    )\n+\n+    // get_project_metadata was called 2 times\n+    expect(toolUsages.get('mcp/get_project_metadata')).toBe(2)\n+\n+    // get_errors was called 2 times\n+    expect(toolUsages.get('mcp/get_errors')).toBe(2)\n+\n+    // get_logs was called 1 time\n+    expect(toolUsages.get('mcp/get_logs')).toBe(1)\n+\n+    // get_page_metadata was called 1 time\n+    expect(toolUsages.get('mcp/get_page_metadata')).toBe(1)\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 501,
        "additions": 494,
        "deletions": 7
    }
}