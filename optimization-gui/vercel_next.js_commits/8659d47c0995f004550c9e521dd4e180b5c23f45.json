{
    "author": "hf",
    "message": "chore: Update `with-supabase` example to use `getClaims()` (#81383)\n\nUpdates the `with-supabase` example to use the new and much faster (when\nproject is configured with asymmetric JWT support)\n`supabase.auth.getClaims()` function instead of `getUser()`.\n\n---------\n\nCo-authored-by: Benjamin Woodruff <benjamin.woodruff@vercel.com>",
    "sha": "8659d47c0995f004550c9e521dd4e180b5c23f45",
    "files": [
        {
            "sha": "05972aba8b5156104f1a40cf3bb063ddc2f81be2",
            "filename": "examples/with-supabase/.env.example",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2F.env.example",
            "raw_url": "https://github.com/vercel/next.js/raw/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2F.env.example",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-supabase%2F.env.example?ref=8659d47c0995f004550c9e521dd4e180b5c23f45",
            "patch": "@@ -1,4 +1,4 @@\n # Update these with your Supabase details from your project settings > API\n # https://app.supabase.com/project/_/settings/api\n NEXT_PUBLIC_SUPABASE_URL=your-project-url\n-NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key\n+NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY=your-anon-key"
        },
        {
            "sha": "c735e7f601f3b8d9925a375dd7fee47ff757f412",
            "filename": "examples/with-supabase/app/protected/page.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Fapp%2Fprotected%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Fapp%2Fprotected%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-supabase%2Fapp%2Fprotected%2Fpage.tsx?ref=8659d47c0995f004550c9e521dd4e180b5c23f45",
            "patch": "@@ -7,8 +7,8 @@ import { FetchDataSteps } from \"@/components/tutorial/fetch-data-steps\";\n export default async function ProtectedPage() {\n   const supabase = await createClient();\n \n-  const { data, error } = await supabase.auth.getUser();\n-  if (error || !data?.user) {\n+  const { data, error } = await supabase.auth.getClaims();\n+  if (error || !data?.claims) {\n     redirect(\"/auth/login\");\n   }\n \n@@ -24,7 +24,7 @@ export default async function ProtectedPage() {\n       <div className=\"flex flex-col gap-2 items-start\">\n         <h2 className=\"font-bold text-2xl mb-4\">Your user details</h2>\n         <pre className=\"text-xs font-mono p-3 rounded border max-h-32 overflow-auto\">\n-          {JSON.stringify(data.user, null, 2)}\n+          {JSON.stringify(data.claims, null, 2)}\n         </pre>\n       </div>\n       <div>"
        },
        {
            "sha": "29f696c713f563662243394f879e862dc858b35d",
            "filename": "examples/with-supabase/components/auth-button.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Fcomponents%2Fauth-button.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Fcomponents%2Fauth-button.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-supabase%2Fcomponents%2Fauth-button.tsx?ref=8659d47c0995f004550c9e521dd4e180b5c23f45",
            "patch": "@@ -6,9 +6,10 @@ import { LogoutButton } from \"./logout-button\";\n export async function AuthButton() {\n   const supabase = await createClient();\n \n-  const {\n-    data: { user },\n-  } = await supabase.auth.getUser();\n+  // You can also use getUser() which will be slower.\n+  const { data } = await supabase.auth.getClaims();\n+\n+  const user = data?.claims;\n \n   return user ? (\n     <div className=\"flex items-center gap-4\">"
        },
        {
            "sha": "a1b5fce9225f26385e8efe4129d1d8b4911d14a2",
            "filename": "examples/with-supabase/lib/supabase/client.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fclient.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fclient.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fclient.ts?ref=8659d47c0995f004550c9e521dd4e180b5c23f45",
            "patch": "@@ -3,6 +3,6 @@ import { createBrowserClient } from \"@supabase/ssr\";\n export function createClient() {\n   return createBrowserClient(\n     process.env.NEXT_PUBLIC_SUPABASE_URL!,\n-    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n+    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY!,\n   );\n }"
        },
        {
            "sha": "1ba5ce680dabae564dd4f75ff1be0824d16509c0",
            "filename": "examples/with-supabase/lib/supabase/middleware.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fmiddleware.ts?ref=8659d47c0995f004550c9e521dd4e180b5c23f45",
            "patch": "@@ -7,14 +7,17 @@ export async function updateSession(request: NextRequest) {\n     request,\n   });\n \n-  // If the env vars are not set, skip middleware check. You can remove this once you setup the project.\n+  // If the env vars are not set, skip middleware check. You can remove this\n+  // once you setup the project.\n   if (!hasEnvVars) {\n     return supabaseResponse;\n   }\n \n+  // With Fluid compute, don't put this client in a global environment\n+  // variable. Always create a new one on each request.\n   const supabase = createServerClient(\n     process.env.NEXT_PUBLIC_SUPABASE_URL!,\n-    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n+    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY!,\n     {\n       cookies: {\n         getAll() {\n@@ -36,14 +39,13 @@ export async function updateSession(request: NextRequest) {\n   );\n \n   // Do not run code between createServerClient and\n-  // supabase.auth.getUser(). A simple mistake could make it very hard to debug\n+  // supabase.auth.getClaims(). A simple mistake could make it very hard to debug\n   // issues with users being randomly logged out.\n \n-  // IMPORTANT: DO NOT REMOVE auth.getUser()\n-\n-  const {\n-    data: { user },\n-  } = await supabase.auth.getUser();\n+  // IMPORTANT: If you remove getClaims() and you use server-side rendering\n+  // with the Supabase client, your users may be randomly logged out.\n+  const { data } = await supabase.auth.getClaims();\n+  const user = data?.claims;\n \n   if (\n     request.nextUrl.pathname !== \"/\" &&"
        },
        {
            "sha": "04c943d537396261e6c075c7db5067143b66de96",
            "filename": "examples/with-supabase/lib/supabase/server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fserver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fserver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-supabase%2Flib%2Fsupabase%2Fserver.ts?ref=8659d47c0995f004550c9e521dd4e180b5c23f45",
            "patch": "@@ -1,12 +1,17 @@\n import { createServerClient } from \"@supabase/ssr\";\n import { cookies } from \"next/headers\";\n \n+/**\n+ * Especially important if using Fluid compute: Don't put this client in a\n+ * global variable. Always create a new client within each function when using\n+ * it.\n+ */\n export async function createClient() {\n   const cookieStore = await cookies();\n \n   return createServerClient(\n     process.env.NEXT_PUBLIC_SUPABASE_URL!,\n-    process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n+    process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY!,\n     {\n       cookies: {\n         getAll() {"
        },
        {
            "sha": "fc5da2436c5349f50ff7fd7df7115293f752401c",
            "filename": "examples/with-supabase/lib/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Flib%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8659d47c0995f004550c9e521dd4e180b5c23f45/examples%2Fwith-supabase%2Flib%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/examples%2Fwith-supabase%2Flib%2Futils.ts?ref=8659d47c0995f004550c9e521dd4e180b5c23f45",
            "patch": "@@ -8,4 +8,4 @@ export function cn(...inputs: ClassValue[]) {\n // This check can be removed, it is just for tutorial purposes\n export const hasEnvVars =\n   process.env.NEXT_PUBLIC_SUPABASE_URL &&\n-  process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n+  process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_OR_ANON_KEY;"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 26,
        "deletions": 18
    }
}