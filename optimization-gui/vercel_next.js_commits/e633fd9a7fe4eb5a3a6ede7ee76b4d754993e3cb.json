{
    "author": "ijjk",
    "message": "Refactor to share handler logic in route-module (#79106)\n\nThis pulls the logic added in `templates/pages-api` that is needed to\nsupport the `handler` interface into the `route-module` interface so\nthat it can shared with the other templates as the `handler` interface\nis added for them as well.\n\nValidated against deploy tests here:\nhttps://github.com/vercel/vercel/actions/runs/14982451661/job/42089544277?pr=13326",
    "sha": "e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
    "files": [
        {
            "sha": "fd3a1ffd4b7e52af515559c1e6c991821c53847a",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -48,4 +48,5 @@ export const routeModule = new AppPageRouteModule({\n   userland: {\n     loaderTree: tree,\n   },\n+  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n })"
        },
        {
            "sha": "7def79fa4ae8f32b0fc2eeead29448b1a516c124",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -24,6 +24,7 @@ const routeModule = new AppRouteRouteModule({\n     filename: 'VAR_DEFINITION_FILENAME',\n     bundlePath: 'VAR_DEFINITION_BUNDLE_PATH',\n   },\n+  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n   resolvedPagePath: 'VAR_RESOLVED_PAGE_PATH',\n   nextConfigOutput,\n   userland,"
        },
        {
            "sha": "f028d79504e0031a60c70a7845b6dd3b1909e590",
            "filename": "packages/next/src/build/templates/pages-api.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 126,
            "changes": 133,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -1,8 +1,5 @@\n import type { NextApiResponse } from '../../types'\n import type { IncomingMessage, ServerResponse } from 'node:http'\n-import type { PrerenderManifest } from '..'\n-import type { DevRoutesManifest } from '../../server/lib/router-utils/setup-dev-bundler'\n-import type { InstrumentationOnRequestError } from '../../server/instrumentation/types'\n \n import { sendError } from '../../server/api-utils'\n import { RouteKind } from '../../server/route-kind'\n@@ -15,26 +12,6 @@ import { hoist } from './helpers'\n import * as userland from 'VAR_USERLAND'\n import { getTracer, SpanKind } from '../../server/lib/trace/tracer'\n import { BaseServerSpan } from '../../server/lib/trace/constants'\n-import {\n-  ensureInstrumentationRegistered,\n-  instrumentationOnRequestError,\n-} from '../../server/lib/router-utils/instrumentation-globals.external'\n-import { getUtils } from '../../server/server-utils'\n-import { PRERENDER_MANIFEST, ROUTES_MANIFEST } from '../../api/constants'\n-import { isDynamicRoute } from '../../shared/lib/router/utils'\n-import {\n-  RouterServerContextSymbol,\n-  routerServerGlobal,\n-} from '../../server/lib/router-utils/router-server-context'\n-import { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\n-import {\n-  normalizeLocalePath,\n-  type PathLocale,\n-} from '../../shared/lib/i18n/normalize-locale-path'\n-import { loadManifestFromRelativePath } from '../../server/load-manifest.external'\n-import { getHostname } from '../../shared/lib/get-hostname'\n-import { detectDomainLocale } from '../../shared/lib/i18n/detect-domain-locale'\n-import { parseReqUrl } from '../../lib/url'\n \n // Re-export the handler (should be the default export).\n export default hoist(userland, 'default')\n@@ -53,6 +30,7 @@ const routeModule = new PagesAPIRouteModule({\n     filename: '',\n   },\n   userland,\n+  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n })\n \n export async function handler(\n@@ -62,23 +40,6 @@ export async function handler(\n     waitUntil?: (prom: Promise<void>) => void\n   }\n ): Promise<void> {\n-  const projectDir =\n-    routerServerGlobal[RouterServerContextSymbol]?.dir || process.cwd()\n-  const distDir = process.env.__NEXT_RELATIVE_DIST_DIR || ''\n-  const isDev = process.env.NODE_ENV === 'development'\n-\n-  const [routesManifest, prerenderManifest] = await Promise.all([\n-    loadManifestFromRelativePath<DevRoutesManifest>(\n-      projectDir,\n-      distDir,\n-      ROUTES_MANIFEST\n-    ),\n-    loadManifestFromRelativePath<PrerenderManifest>(\n-      projectDir,\n-      distDir,\n-      PRERENDER_MANIFEST\n-    ),\n-  ])\n   let srcPage = 'VAR_DEFINITION_PAGE'\n \n   // turbopack doesn't normalize `/index` in the page name\n@@ -87,95 +48,16 @@ export async function handler(\n     srcPage = srcPage.replace(/\\/index$/, '')\n   }\n \n-  // We need to parse dynamic route params\n-  // and do URL normalization here.\n-  // TODO: move this into server-utils for re-use\n-  const { basePath, i18n, rewrites } = routesManifest\n-\n-  if (basePath) {\n-    req.url = removePathPrefix(req.url || '/', basePath)\n-  }\n-\n-  let localeResult: PathLocale | undefined\n-\n-  if (i18n) {\n-    const urlParts = (req.url || '/').split('?')\n-    localeResult = normalizeLocalePath(urlParts[0] || '/', i18n.locales)\n-\n-    if (localeResult.detectedLocale) {\n-      req.url = `${localeResult.pathname}${\n-        urlParts[1] ? `?${urlParts[1]}` : ''\n-      }`\n-    }\n-  }\n-\n-  const parsedUrl = parseReqUrl(req.url || '/')\n+  const prepareResult = await routeModule.prepare(req, srcPage)\n \n-  if (!parsedUrl) {\n+  if (!prepareResult) {\n     res.statusCode = 400\n     res.end('Bad Request')\n     ctx.waitUntil?.(Promise.resolve())\n     return\n   }\n \n-  const pageIsDynamic = isDynamicRoute(srcPage)\n-\n-  const serverUtils = getUtils({\n-    page: srcPage,\n-    i18n,\n-    basePath,\n-    rewrites,\n-    pageIsDynamic,\n-    trailingSlash: process.env.__NEXT_TRAILING_SLASH as any as boolean,\n-    caseSensitive: Boolean(routesManifest.caseSensitive),\n-  })\n-\n-  const domainLocale = detectDomainLocale(\n-    i18n?.domains,\n-    getHostname(parsedUrl, req.headers),\n-    localeResult?.detectedLocale\n-  )\n-\n-  const defaultLocale = domainLocale?.defaultLocale || i18n?.defaultLocale\n-\n-  // Ensure parsedUrl.pathname includes locale before processing\n-  // rewrites or they won't match correctly.\n-  if (defaultLocale && !localeResult?.detectedLocale) {\n-    parsedUrl.pathname = `/${defaultLocale}${parsedUrl.pathname}`\n-  }\n-\n-  const rewriteParamKeys = Object.keys(\n-    serverUtils.handleRewrites(req, parsedUrl)\n-  )\n-  serverUtils.normalizeCdnUrl(req, [\n-    ...rewriteParamKeys,\n-    ...Object.keys(serverUtils.defaultRouteRegex?.groups || {}),\n-  ])\n-\n-  const params: Record<string, undefined | string | string[]> =\n-    serverUtils.dynamicRouteMatcher\n-      ? serverUtils.dynamicRouteMatcher(\n-          localeResult?.pathname || parsedUrl.pathname || ''\n-        ) || {}\n-      : {}\n-\n-  const query = {\n-    ...parsedUrl.query,\n-    ...params,\n-  }\n-  serverUtils.normalizeQueryParams(query)\n-\n-  if (pageIsDynamic) {\n-    const result = serverUtils.normalizeDynamicRouteParams(query, true)\n-\n-    if (result.hasValidParams) {\n-      Object.assign(query, result.params)\n-    }\n-  }\n-\n-  // ensure instrumentation is registered and pass\n-  // onRequestError below\n-  await ensureInstrumentationRegistered(projectDir, distDir)\n+  const { query, params, prerenderManifest } = prepareResult\n \n   try {\n     const method = req.method || 'GET'\n@@ -197,11 +79,10 @@ export async function handler(\n           // doesn't need to load\n           previewProps: prerenderManifest.preview,\n           propagateError: false,\n-          dev: isDev,\n+          dev: routeModule.isDev,\n           page: 'VAR_DEFINITION_PAGE',\n \n-          onError: (...args: Parameters<InstrumentationOnRequestError>) =>\n-            instrumentationOnRequestError(projectDir, distDir, ...args),\n+          onError: routeModule.instrumentationOnRequestError.bind(routeModule),\n         })\n         .finally(() => {\n           if (!span) return\n@@ -266,7 +147,7 @@ export async function handler(\n     }\n   } catch (err) {\n     // we re-throw in dev to show the error overlay\n-    if (isDev) {\n+    if (routeModule.isDev) {\n       throw err\n     }\n     // this is technically an invariant as error handling"
        },
        {
            "sha": "23a4833b787c14148f664214f187cfcd43f02c13",
            "filename": "packages/next/src/build/templates/pages.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -51,6 +51,7 @@ export const routeModule = new PagesRouteModule({\n     bundlePath: '',\n     filename: '',\n   },\n+  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n   components: {\n     // default export might not exist when optimized for data only\n     App: app.default,"
        },
        {
            "sha": "37f9e156a2786783d23283fda1078e603a83a0fb",
            "filename": "packages/next/src/build/webpack/loaders/next-edge-ssr-loader/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -55,6 +55,8 @@ function getRouteModuleOptions(page: string) {\n       bundlePath: '',\n       filename: '',\n     },\n+    // edge runtime doesn't read from distDir\n+    distDir: '',\n   }\n \n   return options"
        },
        {
            "sha": "b2fa17540d72f1a8ccc96a4d48bc5db376881303",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -84,7 +84,7 @@ import RenderResult from './render-result'\n import { removeTrailingSlash } from '../shared/lib/router/utils/remove-trailing-slash'\n import { denormalizePagePath } from '../shared/lib/page-path/denormalize-page-path'\n import * as Log from '../build/output/log'\n-import { getPreviouslyRevalidatedTags, getUtils } from './server-utils'\n+import { getPreviouslyRevalidatedTags, getServerUtils } from './server-utils'\n import isError, { getProperError } from '../lib/is-error'\n import {\n   addRequestMeta,\n@@ -1191,7 +1191,7 @@ export default abstract class Server<\n             matchedPath = localeAnalysisResult.pathname\n           }\n \n-          const utils = getUtils({\n+          const utils = getServerUtils({\n             pageIsDynamic,\n             page: srcPathname,\n             i18n: this.nextConfig.i18n,"
        },
        {
            "sha": "d2ba2b88ce8a56ceee025b8c497592e8e11653c0",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -215,10 +215,11 @@ export class AppRouteRouteModule extends RouteModule<\n   constructor({\n     userland,\n     definition,\n+    distDir,\n     resolvedPagePath,\n     nextConfigOutput,\n   }: AppRouteRouteModuleOptions) {\n-    super({ userland, definition })\n+    super({ userland, definition, distDir })\n \n     this.resolvedPagePath = resolvedPagePath\n     this.nextConfigOutput = nextConfigOutput"
        },
        {
            "sha": "f23918b4f3ac3b27706326103a6a44e01b476c94",
            "filename": "packages/next/src/server/route-modules/pages/builtin/_error.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fbuiltin%2F_error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fbuiltin%2F_error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fbuiltin%2F_error.tsx?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -15,6 +15,7 @@ export const routeModule = new PagesRouteModule({\n     filename: '',\n     bundlePath: '',\n   },\n+  distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n   components: {\n     App,\n     Document,"
        },
        {
            "sha": "f741d20152d33c5c7f73232b8b0eb71f7b07d600",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 189,
            "deletions": 1,
            "changes": 190,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -1,4 +1,27 @@\n+import type { IncomingMessage } from 'node:http'\n+import type { InstrumentationOnRequestError } from '../instrumentation/types'\n+import type { ParsedUrlQuery } from 'node:querystring'\n+import type { UrlWithParsedQuery } from 'node:url'\n+import type { PrerenderManifest } from '../../build'\n+import type { DevRoutesManifest } from '../lib/router-utils/setup-dev-bundler'\n import type { RouteDefinition } from '../route-definitions/route-definition'\n+import type { DeepReadonly } from '../../shared/lib/deep-readonly'\n+\n+import { PRERENDER_MANIFEST, ROUTES_MANIFEST } from '../../shared/lib/constants'\n+import { parseReqUrl } from '../../lib/url'\n+import {\n+  normalizeLocalePath,\n+  type PathLocale,\n+} from '../../shared/lib/i18n/normalize-locale-path'\n+import { isDynamicRoute } from '../../shared/lib/router/utils'\n+import { removePathPrefix } from '../../shared/lib/router/utils/remove-path-prefix'\n+import {\n+  RouterServerContextSymbol,\n+  routerServerGlobal,\n+} from '../lib/router-utils/router-server-context'\n+import { getServerUtils } from '../server-utils'\n+import { detectDomainLocale } from '../../shared/lib/i18n/detect-domain-locale'\n+import { getHostname } from '../../shared/lib/get-hostname'\n \n /**\n  * RouteModuleOptions is the options that are passed to the route module, other\n@@ -11,6 +34,7 @@ export interface RouteModuleOptions<\n > {\n   readonly definition: Readonly<D>\n   readonly userland: Readonly<U>\n+  readonly distDir: string\n }\n \n /**\n@@ -49,8 +73,172 @@ export abstract class RouteModule<\n    */\n   public static readonly sharedModules: any\n \n-  constructor({ userland, definition }: RouteModuleOptions<D, U>) {\n+  public isDev: boolean\n+  public distDir: string\n+  public projectDir: string\n+\n+  constructor({ userland, definition, distDir }: RouteModuleOptions<D, U>) {\n     this.userland = userland\n     this.definition = definition\n+    this.isDev = process.env.NODE_ENV === 'development'\n+    this.distDir = distDir\n+\n+    if (process.env.NEXT_RUNTIME === 'edge') {\n+      this.projectDir = ''\n+    } else {\n+      this.projectDir =\n+        routerServerGlobal[RouterServerContextSymbol]?.dir || process.cwd()\n+    }\n+  }\n+\n+  public async instrumentationOnRequestError(\n+    ...args: Parameters<InstrumentationOnRequestError>\n+  ) {\n+    // this is only handled here for node, for edge it\n+    // is handled in the adapter/loader instead\n+    if (process.env.NEXT_RUNTIME !== 'edge') {\n+      const { instrumentationOnRequestError } = await import(\n+        '../lib/router-utils/instrumentation-globals.external'\n+      )\n+\n+      return instrumentationOnRequestError(\n+        this.projectDir,\n+        this.distDir,\n+        ...args\n+      )\n+    }\n+  }\n+\n+  public async prepare(\n+    req: IncomingMessage,\n+    srcPage: string\n+  ): Promise<\n+    | {\n+        query: ParsedUrlQuery\n+        params: ParsedUrlQuery\n+        parsedUrl: UrlWithParsedQuery\n+        routesManifest: DeepReadonly<DevRoutesManifest>\n+        prerenderManifest: DeepReadonly<PrerenderManifest>\n+      }\n+    | undefined\n+  > {\n+    // \"prepare\" is only needed for node runtime currently\n+    // if we want to share the normalizing logic here\n+    // we ill need to allow passing in the i18n and similar info\n+    if (process.env.NEXT_RUNTIME !== 'edge') {\n+      const { loadManifestFromRelativePath } = await import(\n+        '../load-manifest.external'\n+      )\n+      const { ensureInstrumentationRegistered } = await import(\n+        '../lib/router-utils/instrumentation-globals.external'\n+      )\n+\n+      const [routesManifest, prerenderManifest] = await Promise.all([\n+        loadManifestFromRelativePath<DevRoutesManifest>(\n+          this.projectDir,\n+          this.distDir,\n+          ROUTES_MANIFEST\n+        ),\n+        loadManifestFromRelativePath<PrerenderManifest>(\n+          this.projectDir,\n+          this.distDir,\n+          PRERENDER_MANIFEST\n+        ),\n+        // ensure instrumentation is registered and pass\n+        // onRequestError below\n+        ensureInstrumentationRegistered(this.projectDir, this.distDir),\n+      ])\n+      // We need to parse dynamic route params\n+      // and do URL normalization here.\n+      // TODO: move this into server-utils for re-use\n+      const { basePath, i18n, rewrites } = routesManifest\n+\n+      if (basePath) {\n+        req.url = removePathPrefix(req.url || '/', basePath)\n+      }\n+\n+      let localeResult: PathLocale | undefined\n+\n+      if (i18n) {\n+        const urlParts = (req.url || '/').split('?')\n+        localeResult = normalizeLocalePath(urlParts[0] || '/', i18n.locales)\n+\n+        if (localeResult.detectedLocale) {\n+          req.url = `${localeResult.pathname}${\n+            urlParts[1] ? `?${urlParts[1]}` : ''\n+          }`\n+        }\n+      }\n+\n+      const parsedUrl = parseReqUrl(req.url || '/')\n+\n+      // if we couldn't parse the URL we can't continue\n+      if (!parsedUrl) {\n+        return\n+      }\n+\n+      const pageIsDynamic = isDynamicRoute(srcPage)\n+\n+      const serverUtils = getServerUtils({\n+        page: srcPage,\n+        i18n,\n+        basePath,\n+        rewrites,\n+        pageIsDynamic,\n+        trailingSlash: process.env.__NEXT_TRAILING_SLASH as any as boolean,\n+        caseSensitive: Boolean(routesManifest.caseSensitive),\n+      })\n+\n+      const domainLocale = detectDomainLocale(\n+        i18n?.domains,\n+        getHostname(parsedUrl, req.headers),\n+        localeResult?.detectedLocale\n+      )\n+\n+      const defaultLocale = domainLocale?.defaultLocale || i18n?.defaultLocale\n+\n+      // Ensure parsedUrl.pathname includes locale before processing\n+      // rewrites or they won't match correctly.\n+      if (defaultLocale && !localeResult?.detectedLocale) {\n+        parsedUrl.pathname = `/${defaultLocale}${parsedUrl.pathname}`\n+      }\n+\n+      const rewriteParamKeys = Object.keys(\n+        serverUtils.handleRewrites(req, parsedUrl)\n+      )\n+      serverUtils.normalizeCdnUrl(req, [\n+        ...rewriteParamKeys,\n+        ...Object.keys(serverUtils.defaultRouteRegex?.groups || {}),\n+      ])\n+\n+      const params: Record<string, undefined | string | string[]> =\n+        serverUtils.dynamicRouteMatcher\n+          ? serverUtils.dynamicRouteMatcher(\n+              localeResult?.pathname || parsedUrl.pathname || ''\n+            ) || {}\n+          : {}\n+\n+      const query = {\n+        ...parsedUrl.query,\n+        ...params,\n+      }\n+      serverUtils.normalizeQueryParams(query)\n+\n+      if (pageIsDynamic) {\n+        const result = serverUtils.normalizeDynamicRouteParams(query, true)\n+\n+        if (result.hasValidParams) {\n+          Object.assign(query, result.params)\n+        }\n+      }\n+\n+      return {\n+        query,\n+        params,\n+        parsedUrl,\n+        routesManifest,\n+        prerenderManifest,\n+      }\n+    }\n   }\n }"
        },
        {
            "sha": "e141dfe9c8121326191dcf0d591e082afb169101",
            "filename": "packages/next/src/server/server-utils.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.test.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -1,8 +1,8 @@\n-import { getUtils } from './server-utils'\n+import { getServerUtils } from './server-utils'\n \n describe('getParamsFromRouteMatches', () => {\n   it('should return nothing for a non-dynamic route', () => {\n-    const { getParamsFromRouteMatches } = getUtils({\n+    const { getParamsFromRouteMatches } = getServerUtils({\n       page: '/',\n       basePath: '',\n       rewrites: {},\n@@ -16,7 +16,7 @@ describe('getParamsFromRouteMatches', () => {\n   })\n \n   it('should return the params from the route matches', () => {\n-    const { getParamsFromRouteMatches } = getUtils({\n+    const { getParamsFromRouteMatches } = getServerUtils({\n       page: '/[slug]',\n       basePath: '',\n       rewrites: {},\n@@ -30,7 +30,7 @@ describe('getParamsFromRouteMatches', () => {\n   })\n \n   it('should handle optional params', () => {\n-    const { getParamsFromRouteMatches } = getUtils({\n+    const { getParamsFromRouteMatches } = getServerUtils({\n       page: '/[slug]/[[...optional]]',\n       basePath: '',\n       rewrites: {},\n@@ -51,7 +51,7 @@ describe('getParamsFromRouteMatches', () => {\n   })\n \n   it('should handle rest params', () => {\n-    const { getParamsFromRouteMatches } = getUtils({\n+    const { getParamsFromRouteMatches } = getServerUtils({\n       page: '/[slug]/[...rest]',\n       basePath: '',\n       rewrites: {},"
        },
        {
            "sha": "a8a47fe82582db18006f9c039fabd6985641c684",
            "filename": "packages/next/src/server/server-utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fserver-utils.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -172,7 +172,7 @@ export function normalizeDynamicRouteParams(\n   }\n }\n \n-export function getUtils({\n+export function getServerUtils({\n   page,\n   i18n,\n   basePath,"
        },
        {
            "sha": "d1b09d0b1c7be51739bd00f5cc67707651614d5f",
            "filename": "packages/next/src/server/web/edge-route-module-wrapper.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts?ref=e633fd9a7fe4eb5a3a6ede7ee76b4d754993e3cb",
            "patch": "@@ -11,7 +11,7 @@ import { IncrementalCache } from '../lib/incremental-cache'\n import { RouteMatcher } from '../route-matchers/route-matcher'\n import type { NextFetchEvent } from './spec-extension/fetch-event'\n import { internal_getCurrentFunctionWaitUntil } from './internal-edge-wait-until'\n-import { getUtils } from '../server-utils'\n+import { getServerUtils } from '../server-utils'\n import { searchParamsToUrlQuery } from '../../shared/lib/router/utils/querystring'\n import { CloseController, trackStreamConsumed } from './web-on-close'\n import { getEdgePreviewProps } from './get-edge-preview-props'\n@@ -71,7 +71,7 @@ export class EdgeRouteModuleWrapper {\n     request: NextRequest,\n     evt: NextFetchEvent\n   ): Promise<Response> {\n-    const utils = getUtils({\n+    const utils = getServerUtils({\n       pageIsDynamic: this.matcher.isDynamic,\n       page: this.matcher.definition.pathname,\n       basePath: request.nextUrl.basePath,"
        }
    ],
    "stats": {
        "total": 352,
        "additions": 214,
        "deletions": 138
    }
}