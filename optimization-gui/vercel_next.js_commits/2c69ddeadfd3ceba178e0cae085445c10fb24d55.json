{
    "author": "ijjk",
    "message": "Update otel test assertions and pages span_name (#84393)\n\nThis updates our otel tests to remove extra span assertions from `next\nstart` with edge runtime that can cause confusion and fixes a couple\nspan_names for pages handlers.\n\nx-ref:\nhttps://github.com/vercel/next.js/pull/75416#discussion_r2393016147",
    "sha": "2c69ddeadfd3ceba178e0cae085445c10fb24d55",
    "files": [
        {
            "sha": "8c9a1a80a3e7f405216e194ec117960d3599f3e1",
            "filename": "packages/next/src/server/route-modules/pages/pages-handler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2c69ddeadfd3ceba178e0cae085445c10fb24d55/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c69ddeadfd3ceba178e0cae085445c10fb24d55/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts?ref=2c69ddeadfd3ceba178e0cae085445c10fb24d55",
            "patch": "@@ -400,7 +400,7 @@ export const getHandler = ({\n                     })\n                     span.updateName(name)\n                   } else {\n-                    span.updateName(`${method} ${req.url}`)\n+                    span.updateName(`${method} ${srcPage}`)\n                   }\n                 })\n             } catch (err: unknown) {\n@@ -722,7 +722,7 @@ export const getHandler = ({\n           tracer.trace(\n             BaseServerSpan.handleRequest,\n             {\n-              spanName: `${method} ${req.url}`,\n+              spanName: `${method} ${srcPage}`,\n               kind: SpanKind.SERVER,\n               attributes: {\n                 'http.method': method,"
        },
        {
            "sha": "3522944b2af46ec504284b0c2d9a16f63f0fa592",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2c69ddeadfd3ceba178e0cae085445c10fb24d55/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c69ddeadfd3ceba178e0cae085445c10fb24d55/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=2c69ddeadfd3ceba178e0cae085445c10fb24d55",
            "patch": "@@ -252,7 +252,7 @@ export async function adapter(\n       return getTracer().trace(\n         MiddlewareSpan.execute,\n         {\n-          spanName: `middleware ${request.method} ${request.nextUrl.pathname}`,\n+          spanName: `middleware ${request.method}`,\n           attributes: {\n             'http.target': request.nextUrl.pathname,\n             'http.method': request.method,"
        },
        {
            "sha": "9d8f55b8e932f3536839037e9cfeb8e7a593d17b",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 200,
            "deletions": 282,
            "changes": 482,
            "blob_url": "https://github.com/vercel/next.js/blob/2c69ddeadfd3ceba178e0cae085445c10fb24d55/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2c69ddeadfd3ceba178e0cae085445c10fb24d55/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=2c69ddeadfd3ceba178e0cae085445c10fb24d55",
            "patch": "@@ -225,137 +225,115 @@ describe('opentelemetry', () => {\n           it('should handle RSC with fetch on edge', async () => {\n             await next.fetch('/app/param/rsc-fetch/edge', env.fetchInit)\n \n-            await expectTrace(getCollector(), [\n-              {\n-                traceId: env.span.traceId,\n-                parentId: env.span.rootParentId,\n-                runtime: 'edge',\n-                name: 'GET /app/[param]/rsc-fetch/edge',\n-                kind: 1,\n-                attributes: {\n-                  'next.span_name': 'GET /app/[param]/rsc-fetch/edge',\n-                  'next.span_type': 'BaseServer.handleRequest',\n-                  'http.method': 'GET',\n-                  'http.target': '/app/param/rsc-fetch/edge?param=param',\n-                  'http.status_code': 200,\n-                  'next.route': '/app/[param]/rsc-fetch/edge',\n-                  'http.route': '/app/[param]/rsc-fetch/edge',\n-                },\n-                status: { code: 0 },\n-                spans: [\n-                  {\n-                    name: 'render route (app) /app/[param]/rsc-fetch/edge',\n-                    kind: 0,\n-                    attributes: {\n-                      'next.span_name':\n-                        'render route (app) /app/[param]/rsc-fetch/edge',\n-                      'next.span_type': 'AppRender.getBodyResult',\n-                      'next.route': '/app/[param]/rsc-fetch/edge',\n-                    },\n-                    status: { code: 0 },\n-                    spans: [\n-                      {\n-                        name: 'build component tree',\n-                        kind: 0,\n-                        attributes: {\n-                          'next.span_name': 'build component tree',\n-                          'next.span_type':\n-                            'NextNodeServer.createComponentTree',\n-                        },\n-                        status: { code: 0 },\n-                        spans: [\n-                          {\n-                            name: 'resolve segment modules',\n-                            kind: 0,\n-                            attributes: {\n-                              'next.span_name': 'resolve segment modules',\n-                              'next.span_type':\n-                                'NextNodeServer.getLayoutOrPageModule',\n-                              'next.segment': '__PAGE__',\n-                            },\n-                            status: { code: 0 },\n+            await expectTrace(\n+              getCollector(),\n+              [\n+                {\n+                  traceId: env.span.traceId,\n+                  parentId: env.span.rootParentId,\n+                  runtime: 'edge',\n+                  name: 'GET /app/[param]/rsc-fetch/edge',\n+                  kind: 1,\n+                  attributes: {\n+                    'next.span_name': 'GET /app/[param]/rsc-fetch/edge',\n+                    'next.span_type': 'BaseServer.handleRequest',\n+                    'http.method': 'GET',\n+                    'http.target': '/app/param/rsc-fetch/edge?param=param',\n+                    'http.status_code': 200,\n+                    'next.route': '/app/[param]/rsc-fetch/edge',\n+                    'http.route': '/app/[param]/rsc-fetch/edge',\n+                  },\n+                  status: { code: 0 },\n+                  spans: [\n+                    {\n+                      name: 'render route (app) /app/[param]/rsc-fetch/edge',\n+                      kind: 0,\n+                      attributes: {\n+                        'next.span_name':\n+                          'render route (app) /app/[param]/rsc-fetch/edge',\n+                        'next.span_type': 'AppRender.getBodyResult',\n+                        'next.route': '/app/[param]/rsc-fetch/edge',\n+                      },\n+                      status: { code: 0 },\n+                      spans: [\n+                        {\n+                          name: 'build component tree',\n+                          kind: 0,\n+                          attributes: {\n+                            'next.span_name': 'build component tree',\n+                            'next.span_type':\n+                              'NextNodeServer.createComponentTree',\n                           },\n-                          {\n-                            name: 'resolve segment modules',\n-                            kind: 0,\n-                            attributes: {\n-                              'next.span_name': 'resolve segment modules',\n-                              'next.span_type':\n-                                'NextNodeServer.getLayoutOrPageModule',\n-                              'next.segment': '[param]',\n+                          status: { code: 0 },\n+                          spans: [\n+                            {\n+                              name: 'resolve segment modules',\n+                              kind: 0,\n+                              attributes: {\n+                                'next.span_name': 'resolve segment modules',\n+                                'next.span_type':\n+                                  'NextNodeServer.getLayoutOrPageModule',\n+                                'next.segment': '__PAGE__',\n+                              },\n+                              status: { code: 0 },\n                             },\n-                            status: { code: 0 },\n+                            {\n+                              name: 'resolve segment modules',\n+                              kind: 0,\n+                              attributes: {\n+                                'next.span_name': 'resolve segment modules',\n+                                'next.span_type':\n+                                  'NextNodeServer.getLayoutOrPageModule',\n+                                'next.segment': '[param]',\n+                              },\n+                              status: { code: 0 },\n+                            },\n+                          ],\n+                        },\n+                        {\n+                          name: 'fetch GET https://example.vercel.sh/',\n+                          kind: 2,\n+                          attributes: {\n+                            'next.span_name':\n+                              'fetch GET https://example.vercel.sh/',\n+                            'next.span_type': 'AppRender.fetch',\n+                            'http.url': 'https://example.vercel.sh/',\n+                            'http.method': 'GET',\n+                            'net.peer.name': 'example.vercel.sh',\n                           },\n-                        ],\n-                      },\n-                      {\n-                        name: 'fetch GET https://example.vercel.sh/',\n-                        kind: 2,\n-                        attributes: {\n-                          'next.span_name':\n-                            'fetch GET https://example.vercel.sh/',\n-                          'next.span_type': 'AppRender.fetch',\n-                          'http.url': 'https://example.vercel.sh/',\n-                          'http.method': 'GET',\n-                          'net.peer.name': 'example.vercel.sh',\n+                          status: { code: 0 },\n                         },\n-                        status: { code: 0 },\n-                      },\n-                      {\n-                        name: 'generateMetadata /app/[param]/layout',\n-                        kind: 0,\n-                        attributes: {\n-                          'next.span_name':\n-                            'generateMetadata /app/[param]/layout',\n-                          'next.span_type': 'ResolveMetadata.generateMetadata',\n-                          'next.page': '/app/[param]/layout',\n+                        {\n+                          name: 'generateMetadata /app/[param]/layout',\n+                          kind: 0,\n+                          attributes: {\n+                            'next.span_name':\n+                              'generateMetadata /app/[param]/layout',\n+                            'next.span_type':\n+                              'ResolveMetadata.generateMetadata',\n+                            'next.page': '/app/[param]/layout',\n+                          },\n+                          status: { code: 0 },\n                         },\n-                        status: { code: 0 },\n-                      },\n-                      {\n-                        name: 'generateMetadata /app/[param]/rsc-fetch/edge/page',\n-                        kind: 0,\n-                        attributes: {\n-                          'next.span_name':\n-                            'generateMetadata /app/[param]/rsc-fetch/edge/page',\n-                          'next.span_type': 'ResolveMetadata.generateMetadata',\n-                          'next.page': '/app/[param]/rsc-fetch/edge/page',\n+                        {\n+                          name: 'generateMetadata /app/[param]/rsc-fetch/edge/page',\n+                          kind: 0,\n+                          attributes: {\n+                            'next.span_name':\n+                              'generateMetadata /app/[param]/rsc-fetch/edge/page',\n+                            'next.span_type':\n+                              'ResolveMetadata.generateMetadata',\n+                            'next.page': '/app/[param]/rsc-fetch/edge/page',\n+                          },\n+                          status: { code: 0 },\n                         },\n-                        status: { code: 0 },\n-                      },\n-                    ],\n-                  },\n-                ],\n-              },\n-\n-              // TODO: what is this trace? What's the value in it?\n-              {\n-                traceId: env.span.traceId,\n-                parentId: env.span.rootParentId,\n-                runtime: 'nodejs',\n-                name: 'GET',\n-                kind: 1,\n-                attributes: {\n-                  'next.span_name': 'GET',\n-                  'next.span_type': 'BaseServer.handleRequest',\n-                  'http.method': 'GET',\n-                  'http.target': '/app/param/rsc-fetch/edge',\n-                  'http.status_code': 200,\n-                },\n-                status: { code: 0 },\n-                spans: [\n-                  {\n-                    name: 'start response',\n-                    kind: 0,\n-                    attributes: {\n-                      'next.span_name': 'start response',\n-                      'next.span_type': 'NextNodeServer.startResponse',\n+                      ],\n                     },\n-                    status: { code: 0 },\n-                  },\n-                ],\n-              },\n-            ])\n+                  ],\n+                },\n+              ],\n+              true\n+            )\n           })\n \n           it('should handle RSC with fetch in RSC mode', async () => {\n@@ -447,50 +425,26 @@ describe('opentelemetry', () => {\n           it('should handle route handlers in app router on edge', async () => {\n             await next.fetch('/api/app/param/data/edge', env.fetchInit)\n \n-            await expectTrace(getCollector(), [\n-              {\n-                runtime: 'edge',\n-                traceId: env.span.traceId,\n-                parentId: env.span.rootParentId,\n-                name: 'executing api route (app) /api/app/[param]/data/edge',\n-                attributes: {\n-                  'next.route': '/api/app/[param]/data/edge',\n-                  'next.span_name':\n-                    'executing api route (app) /api/app/[param]/data/edge',\n-                  'next.span_type': 'AppRouteRouteHandlers.runHandler',\n-                },\n-                kind: 0,\n-                status: { code: 0 },\n-              },\n-\n-              // TODO: what is this trace? What's the value in it?\n-              {\n-                runtime: 'nodejs',\n-                traceId: env.span.traceId,\n-                parentId: env.span.rootParentId,\n-                name: 'GET',\n-                kind: 1,\n-                attributes: {\n-                  'next.span_name': 'GET',\n-                  'next.span_type': 'BaseServer.handleRequest',\n-                  'http.method': 'GET',\n-                  'http.target': '/api/app/param/data/edge',\n-                  'http.status_code': 200,\n-                },\n-                status: { code: 0 },\n-                spans: [\n-                  {\n-                    name: 'start response',\n-                    kind: 0,\n-                    attributes: {\n-                      'next.span_name': 'start response',\n-                      'next.span_type': 'NextNodeServer.startResponse',\n-                    },\n-                    status: { code: 0 },\n+            await expectTrace(\n+              getCollector(),\n+              [\n+                {\n+                  runtime: 'edge',\n+                  traceId: env.span.traceId,\n+                  parentId: env.span.rootParentId,\n+                  name: 'executing api route (app) /api/app/[param]/data/edge',\n+                  attributes: {\n+                    'next.route': '/api/app/[param]/data/edge',\n+                    'next.span_name':\n+                      'executing api route (app) /api/app/[param]/data/edge',\n+                    'next.span_type': 'AppRouteRouteHandlers.runHandler',\n                   },\n-                ],\n-              },\n-            ])\n+                  kind: 0,\n+                  status: { code: 0 },\n+                },\n+              ],\n+              true\n+            )\n           })\n \n           it('should trace middleware', async () => {\n@@ -501,11 +455,11 @@ describe('opentelemetry', () => {\n                 runtime: 'edge',\n                 traceId: env.span.traceId,\n                 parentId: env.span.rootParentId,\n-                name: 'middleware GET /behind-middleware',\n+                name: 'middleware GET',\n                 attributes: {\n                   'http.method': 'GET',\n                   'http.target': '/behind-middleware',\n-                  'next.span_name': 'middleware GET /behind-middleware',\n+                  'next.span_name': 'middleware GET',\n                   'next.span_type': 'Middleware.execute',\n                 },\n                 status: { code: 0 },\n@@ -781,79 +735,55 @@ describe('opentelemetry', () => {\n               env.fetchInit\n             )\n \n-            await expectTrace(getCollector(), [\n-              {\n-                runtime: 'edge',\n-                traceId: env.span.traceId,\n-                parentId: env.span.rootParentId,\n-                name: 'GET /pages/[param]/edge/getServerSideProps',\n-                kind: 1,\n-                attributes: {\n-                  'next.span_name':\n-                    'GET /pages/[param]/edge/getServerSideProps',\n-                  'next.span_type': 'BaseServer.handleRequest',\n-                  'http.method': 'GET',\n-                  'http.target':\n-                    '/pages/param/edge/getServerSideProps?param=param',\n-                  'http.status_code': 200,\n-                  'next.route': '/pages/[param]/edge/getServerSideProps',\n-                  'http.route': '/pages/[param]/edge/getServerSideProps',\n-                },\n-                status: { code: 0 },\n-                spans: [\n-                  {\n-                    name: 'getServerSideProps /pages/[param]/edge/getServerSideProps',\n-                    kind: 0,\n-                    attributes: {\n-                      'next.span_name':\n-                        'getServerSideProps /pages/[param]/edge/getServerSideProps',\n-                      'next.span_type': 'Render.getServerSideProps',\n-                      'next.route': '/pages/[param]/edge/getServerSideProps',\n-                    },\n-                    status: { code: 0 },\n+            await expectTrace(\n+              getCollector(),\n+              [\n+                {\n+                  runtime: 'edge',\n+                  traceId: env.span.traceId,\n+                  parentId: env.span.rootParentId,\n+                  name: 'GET /pages/[param]/edge/getServerSideProps',\n+                  kind: 1,\n+                  attributes: {\n+                    'next.span_name':\n+                      'GET /pages/[param]/edge/getServerSideProps',\n+                    'next.span_type': 'BaseServer.handleRequest',\n+                    'http.method': 'GET',\n+                    'http.target':\n+                      '/pages/param/edge/getServerSideProps?param=param',\n+                    'http.status_code': 200,\n+                    'next.route': '/pages/[param]/edge/getServerSideProps',\n+                    'http.route': '/pages/[param]/edge/getServerSideProps',\n                   },\n-                  {\n-                    name: 'render route (pages) /pages/[param]/edge/getServerSideProps',\n-                    kind: 0,\n-                    attributes: {\n-                      'next.span_name':\n-                        'render route (pages) /pages/[param]/edge/getServerSideProps',\n-                      'next.span_type': 'Render.renderDocument',\n-                      'next.route': '/pages/[param]/edge/getServerSideProps',\n+                  status: { code: 0 },\n+                  spans: [\n+                    {\n+                      name: 'getServerSideProps /pages/[param]/edge/getServerSideProps',\n+                      kind: 0,\n+                      attributes: {\n+                        'next.span_name':\n+                          'getServerSideProps /pages/[param]/edge/getServerSideProps',\n+                        'next.span_type': 'Render.getServerSideProps',\n+                        'next.route': '/pages/[param]/edge/getServerSideProps',\n+                      },\n+                      status: { code: 0 },\n                     },\n-                    status: { code: 0 },\n-                  },\n-                ],\n-              },\n-\n-              // TODO: what is this trace? What's the value in it?\n-              {\n-                runtime: 'nodejs',\n-                traceId: env.span.traceId,\n-                parentId: env.span.rootParentId,\n-                name: 'GET',\n-                kind: 1,\n-                attributes: {\n-                  'next.span_name': 'GET',\n-                  'next.span_type': 'BaseServer.handleRequest',\n-                  'http.method': 'GET',\n-                  'http.target': '/pages/param/edge/getServerSideProps',\n-                  'http.status_code': 200,\n-                },\n-                status: { code: 0 },\n-                spans: [\n-                  {\n-                    name: 'start response',\n-                    kind: 0,\n-                    attributes: {\n-                      'next.span_name': 'start response',\n-                      'next.span_type': 'NextNodeServer.startResponse',\n+                    {\n+                      name: 'render route (pages) /pages/[param]/edge/getServerSideProps',\n+                      kind: 0,\n+                      attributes: {\n+                        'next.span_name':\n+                          'render route (pages) /pages/[param]/edge/getServerSideProps',\n+                        'next.span_type': 'Render.renderDocument',\n+                        'next.route': '/pages/[param]/edge/getServerSideProps',\n+                      },\n+                      status: { code: 0 },\n                     },\n-                    status: { code: 0 },\n-                  },\n-                ],\n-              },\n-            ])\n+                  ],\n+                },\n+              ],\n+              true\n+            )\n           })\n \n           it('should handle getServerSideProps exceptions', async () => {\n@@ -1080,49 +1010,25 @@ describe('opentelemetry', () => {\n           it('should handle api routes in pages on edge', async () => {\n             await next.fetch('/api/pages/param/edge', env.fetchInit)\n \n-            await expectTrace(getCollector(), [\n-              {\n-                runtime: 'edge',\n-                traceId: env.span.traceId,\n-                parentId: env.span.rootParentId,\n-                name: 'executing api route (pages) /api/pages/[param]/edge',\n-                attributes: {\n-                  'next.span_name':\n-                    'executing api route (pages) /api/pages/[param]/edge',\n-                  'next.span_type': 'Node.runHandler',\n-                },\n-                kind: 0,\n-                status: { code: 0 },\n-              },\n-\n-              // TODO: what is this trace? What's the value in it?\n-              {\n-                runtime: 'nodejs',\n-                traceId: env.span.traceId,\n-                parentId: env.span.rootParentId,\n-                name: 'GET',\n-                kind: 1,\n-                attributes: {\n-                  'next.span_name': 'GET',\n-                  'next.span_type': 'BaseServer.handleRequest',\n-                  'http.method': 'GET',\n-                  'http.target': '/api/pages/param/edge',\n-                  'http.status_code': 200,\n-                },\n-                status: { code: 0 },\n-                spans: [\n-                  {\n-                    name: 'start response',\n-                    kind: 0,\n-                    attributes: {\n-                      'next.span_name': 'start response',\n-                      'next.span_type': 'NextNodeServer.startResponse',\n-                    },\n-                    status: { code: 0 },\n+            await expectTrace(\n+              getCollector(),\n+              [\n+                {\n+                  runtime: 'edge',\n+                  traceId: env.span.traceId,\n+                  parentId: env.span.rootParentId,\n+                  name: 'executing api route (pages) /api/pages/[param]/edge',\n+                  attributes: {\n+                    'next.span_name':\n+                      'executing api route (pages) /api/pages/[param]/edge',\n+                    'next.span_type': 'Node.runHandler',\n                   },\n-                ],\n-              },\n-            ])\n+                  kind: 0,\n+                  status: { code: 0 },\n+                },\n+              ],\n+              true\n+            )\n           })\n         })\n       }\n@@ -1214,7 +1120,11 @@ describe('opentelemetry with disabled fetch tracing', () => {\n type HierSavedSpan = SavedSpan & { spans?: HierSavedSpan[] }\n type SpanMatch = Omit<Partial<HierSavedSpan>, 'spans'> & { spans?: SpanMatch[] }\n \n-async function expectTrace(collector: Collector, match: SpanMatch[]) {\n+async function expectTrace(\n+  collector: Collector,\n+  match: SpanMatch[],\n+  edgeOnly?: boolean\n+) {\n   await check(async () => {\n     const traces = collector.getSpans()\n \n@@ -1224,6 +1134,14 @@ async function expectTrace(collector: Collector, match: SpanMatch[]) {\n       spans: [],\n     }))\n     for (const span of spansForTree) {\n+      // for edge runtime with `next start` the nodejs runtime spans\n+      // will not be updated as the sandbox can't update spans across\n+      // node -> edge boundary, these spans also are not present when\n+      // deployed as next-server is not invoking edge functions there\n+      if (span.runtime === 'nodejs' && edgeOnly) {\n+        continue\n+      }\n+\n       const parent =\n         !span.parentId || span.parentId === EXTERNAL.spanId\n           ? null"
        }
    ],
    "stats": {
        "total": 488,
        "additions": 203,
        "deletions": 285
    }
}