{
    "author": "unstubbable",
    "message": "Allow `beforePageLoad` to be async (#81650)",
    "sha": "af42dadd69070c6d34d0f711697fd0fc76775325",
    "files": [
        {
            "sha": "8e3d16abe40275074713fd4fca2306e6b2bbf20d",
            "filename": "test/e2e/app-dir/segment-cache/staleness/segment-cache-stale-time.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/af42dadd69070c6d34d0f711697fd0fc76775325/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/af42dadd69070c6d34d0f711697fd0fc76775325/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts?ref=af42dadd69070c6d34d0f711697fd0fc76775325",
            "patch": "@@ -81,16 +81,17 @@ describe('segment cache (staleness)', () => {\n \n   it('reuses dynamic data up to the staleTimes.dynamic threshold', async () => {\n     let page: Playwright.Page\n+    const startDate = Date.now()\n+\n     const browser = await next.browser('/', {\n-      beforePageLoad(p: Playwright.Page) {\n+      async beforePageLoad(p: Playwright.Page) {\n         page = p\n+        await page.clock.install()\n+        await page.clock.setFixedTime(startDate)\n       },\n     })\n-    const act = createRouterAct(page)\n \n-    await page.clock.install()\n-    const startDate = Date.now()\n-    await page.clock.setFixedTime(startDate)\n+    const act = createRouterAct(page)\n \n     // Navigate to the dynamic page\n     await act("
        },
        {
            "sha": "32586f0780676cdc59529bb8578f0a537b0fb400",
            "filename": "test/lib/browsers/playwright.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/af42dadd69070c6d34d0f711697fd0fc76775325/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/af42dadd69070c6d34d0f711697fd0fc76775325/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fplaywright.ts?ref=af42dadd69070c6d34d0f711697fd0fc76775325",
            "patch": "@@ -228,7 +228,7 @@ export class Playwright<TCurrent = undefined> {\n       disableCache?: boolean\n       cpuThrottleRate?: number\n       pushErrorAsConsoleLog?: boolean\n-      beforePageLoad?: (page: Page) => void\n+      beforePageLoad?: (page: Page) => void | Promise<void>\n     }\n   ) {\n     await this.close()\n@@ -310,7 +310,7 @@ export class Playwright<TCurrent = undefined> {\n       })\n     })\n \n-    opts?.beforePageLoad?.(page)\n+    await opts?.beforePageLoad?.(page)\n \n     await page.goto(url, { waitUntil: 'load' })\n   }"
        },
        {
            "sha": "c3a7b3f1274d64d3fc361e7c6b2dd70bad1cbb52",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/af42dadd69070c6d34d0f711697fd0fc76775325/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/af42dadd69070c6d34d0f711697fd0fc76775325/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=af42dadd69070c6d34d0f711697fd0fc76775325",
            "patch": "@@ -703,8 +703,8 @@ export class NextInstance {\n     const [browser, response] = await Promise.all([\n       webdriver(this.url, url, {\n         ...options,\n-        beforePageLoad(page: Page) {\n-          options.beforePageLoad?.(page)\n+        async beforePageLoad(page: Page) {\n+          await options.beforePageLoad?.(page)\n \n           page.on('response', async (response) => {\n             if (response.url() === absoluteUrl) {"
        },
        {
            "sha": "ed1adfc87205359e9266105d9ee2b6128b85f3ef",
            "filename": "test/lib/next-webdriver.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/af42dadd69070c6d34d0f711697fd0fc76775325/test%2Flib%2Fnext-webdriver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/af42dadd69070c6d34d0f711697fd0fc76775325/test%2Flib%2Fnext-webdriver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-webdriver.ts?ref=af42dadd69070c6d34d0f711697fd0fc76775325",
            "patch": "@@ -62,7 +62,7 @@ export interface WebdriverOptions {\n    * @param page\n    * @returns\n    */\n-  beforePageLoad?: (page: Page) => void\n+  beforePageLoad?: (page: Page) => void | Promise<void>\n   /**\n    * browser locale\n    */"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 11,
        "deletions": 10
    }
}