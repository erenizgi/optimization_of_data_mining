{
    "author": "sokra",
    "message": "Turbopack: delete .next folder before throwing due to \"pages/app directory must be in the same folder\" (#84553)\n\n### What?\r\n\r\nI expect an empty .next folder after an error, so it should delete it before doing the check, so that an error doesn't result in a stale .next folder",
    "sha": "9962fa563c34a471fc1817aefff60377d8800c45",
    "files": [
        {
            "sha": "cd81837f82675c6eb77b4e03d1044650a5716f5e",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 28,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/9962fa563c34a471fc1817aefff60377d8800c45/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9962fa563c34a471fc1817aefff60377d8800c45/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=9962fa563c34a471fc1817aefff60377d8800c45",
            "patch": "@@ -1016,6 +1016,34 @@ export default async function build(\n       NextBuildContext.originalRewrites = config._originalRewrites\n       NextBuildContext.originalRedirects = config._originalRedirects\n \n+      const distDirCreated = await nextBuildSpan\n+        .traceChild('create-dist-dir')\n+        .traceAsyncFn(async () => {\n+          try {\n+            await fs.mkdir(distDir, { recursive: true })\n+            return true\n+          } catch (err) {\n+            if (isError(err) && err.code === 'EPERM') {\n+              return false\n+            }\n+            throw err\n+          }\n+        })\n+\n+      if (!distDirCreated || !(await isWriteable(distDir))) {\n+        throw new Error(\n+          '> Build directory is not writeable. https://nextjs.org/docs/messages/build-dir-not-writeable'\n+        )\n+      }\n+\n+      if (config.cleanDistDir && !isGenerateMode) {\n+        await nextBuildSpan\n+          .traceChild('clean')\n+          .traceAsyncFn(() =>\n+            recursiveDeleteSyncWithAsyncRetries(distDir, /^(cache|dev)/)\n+          )\n+      }\n+\n       const cacheDir = getCacheDir(distDir)\n \n       const telemetry = new Telemetry({ distDir })\n@@ -1102,34 +1130,6 @@ export default async function build(\n         cacheDir,\n       }\n \n-      const distDirCreated = await nextBuildSpan\n-        .traceChild('create-dist-dir')\n-        .traceAsyncFn(async () => {\n-          try {\n-            await fs.mkdir(distDir, { recursive: true })\n-            return true\n-          } catch (err) {\n-            if (isError(err) && err.code === 'EPERM') {\n-              return false\n-            }\n-            throw err\n-          }\n-        })\n-\n-      if (!distDirCreated || !(await isWriteable(distDir))) {\n-        throw new Error(\n-          '> Build directory is not writeable. https://nextjs.org/docs/messages/build-dir-not-writeable'\n-        )\n-      }\n-\n-      if (config.cleanDistDir && !isGenerateMode) {\n-        await nextBuildSpan\n-          .traceChild('clean')\n-          .traceAsyncFn(() =>\n-            recursiveDeleteSyncWithAsyncRetries(distDir, /^(cache|dev)/)\n-          )\n-      }\n-\n       if (appDir && 'exportPathMap' in config) {\n         Log.error(\n           'The \"exportPathMap\" configuration cannot be used with the \"app\" directory. Please use generateStaticParams() instead.'"
        },
        {
            "sha": "121014f1cbbd7fe691de6cc52ddd0912e6d0233f",
            "filename": "packages/next/src/lib/recursive-delete.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9962fa563c34a471fc1817aefff60377d8800c45/packages%2Fnext%2Fsrc%2Flib%2Frecursive-delete.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9962fa563c34a471fc1817aefff60377d8800c45/packages%2Fnext%2Fsrc%2Flib%2Frecursive-delete.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Frecursive-delete.ts?ref=9962fa563c34a471fc1817aefff60377d8800c45",
            "patch": "@@ -74,7 +74,7 @@ export async function recursiveDeleteSyncWithAsyncRetries(\n   dir: string,\n   /** Exclude based on relative file path */\n   exclude?: RegExp,\n-  /** Ensures that parameter dir exists, this is not passed recursively */\n+  /** Relative path to the directory being deleted, used for exclude */\n   previousPath: string = ''\n ): Promise<void> {\n   let result"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 29,
        "deletions": 29
    }
}