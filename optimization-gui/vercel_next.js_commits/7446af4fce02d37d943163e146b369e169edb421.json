{
    "author": "lubieowoce",
    "message": "add git merge driver for errors.json (#80722)\n\nAdds a merge driver that can automatically re-number messages added to\n`errors.json` if a merge conflict occurs. Now, it would be easier to\njust run `pnpm update-error-codes`, but that's slow and requires\ninstalling deps + building everything, so i'm just manually merging +\nrenumbering instead.\n\nTo avoid disrupting people's workflows (in case this is buggy, or\nsomething), it's currently *not enabled by default*. To enable the merge\ndriver, run:\n```shell\nscripts/merge-errors-json/install\n```\nwhich will add it to your `.git/config`. Once it's been confirmed to\nwork well, we can make this command run by default in `postinstall`.\n\n### Testing\n\nOther than the test i added (which doesn't run git), i've tested this\nmanually with this script that rebases some stacked branches:\n\n<details>\n<summary>merge-driver-test.sh</summary>\n\n```bash\n#!/usr/bin/env bash\nset -eu -o pipefail\n\ncd \"$1\"\ncurrent_branch=\"$(git branch --show-current)\"\n\n(\n  set -eu -o pipefail\n  \n  git switch lubieowoce/errors-json-merge-driver\n\n  git switch --force-create 'test/errors-json/base'\n  echo '{\n    \"1\": \"base message\"\n  }\n  ' > packages/next/errors.json\n  git commit -am 'base commit'\n\n\n  git switch --force-create 'test/errors-json/one';\n  echo '{\n    \"1\": \"base message\",\n    \"2\": \"message from branch one\"\n  }\n  ' > packages/next/errors.json\n  git commit -am 'commit 1'\n\n\n  git switch 'test/errors-json/base'\n\n  git switch --force-create 'test/errors-json/stacked-1'\n  echo '{\n    \"1\": \"base message\",\n    \"2\": \"message from stacked 1\"\n  }\n  ' > packages/next/errors.json\n  git commit -am 'stacked 1'\n\n\n  git switch --force-create 'test/errors-json/stacked-2'\n  echo '{\n    \"1\": \"base message\",\n    \"2\": \"message from stacked 1\",\n    \"3\": \"message from stacked 2\"\n  }\n  ' > packages/next/errors.json\n  git commit -am 'stacked 2'\n\n  git rebase 'test/errors-json/one' --update-refs || true\n  bat packages/next/errors.json\n  git rebase --abort || true\n)\n\ngit switch \"$current_branch\"\n```\n</details>\n\nThe script does a bunch of git operations, so it's easiest to put it\noutside of your next.js repo and call `bash merge-driver-test.sh\npath/to/next.js`.",
    "sha": "7446af4fce02d37d943163e146b369e169edb421",
    "files": [
        {
            "sha": "a032aa154c986f690423fe045e74e80332abf749",
            "filename": ".gitattributes",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7446af4fce02d37d943163e146b369e169edb421/.gitattributes",
            "raw_url": "https://github.com/vercel/next.js/raw/7446af4fce02d37d943163e146b369e169edb421/.gitattributes",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.gitattributes?ref=7446af4fce02d37d943163e146b369e169edb421",
            "patch": "@@ -4,3 +4,6 @@ packages/next/compiled/** -text linguist-vendored\n \n # Make next/src/build folder indexable for github search\n build/** linguist-generated=false\n+\n+# Custom merge driver for auto-generated errors.json\n+packages/next/errors.json merge=errors-json"
        },
        {
            "sha": "e4c25d1798b13a2a10eebc3528dcf12d85b6a2fe",
            "filename": "scripts/merge-errors-json/install",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7446af4fce02d37d943163e146b369e169edb421/scripts%2Fmerge-errors-json%2Finstall",
            "raw_url": "https://github.com/vercel/next.js/raw/7446af4fce02d37d943163e146b369e169edb421/scripts%2Fmerge-errors-json%2Finstall",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fmerge-errors-json%2Finstall?ref=7446af4fce02d37d943163e146b369e169edb421",
            "patch": "@@ -0,0 +1,4 @@\n+#!/bin/sh\n+driver_name='errors-json'\n+git config merge.\"$driver_name\".name 'Automatically merge packages/next/errors.json'\n+git config merge.\"$driver_name\".driver 'node scripts/merge-errors-json/merge.mjs %A %O %B'"
        },
        {
            "sha": "1c4903fe5c81154754538f6e081ab1ca07db4078",
            "filename": "scripts/merge-errors-json/merge.mjs",
            "status": "added",
            "additions": 111,
            "deletions": 0,
            "changes": 111,
            "blob_url": "https://github.com/vercel/next.js/blob/7446af4fce02d37d943163e146b369e169edb421/scripts%2Fmerge-errors-json%2Fmerge.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/7446af4fce02d37d943163e146b369e169edb421/scripts%2Fmerge-errors-json%2Fmerge.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fmerge-errors-json%2Fmerge.mjs?ref=7446af4fce02d37d943163e146b369e169edb421",
            "patch": "@@ -0,0 +1,111 @@\n+// @ts-check\n+\n+/**\n+ * Git merge driver for packages/next/errors.json\n+ *\n+ * This script automatically resolves merge conflicts in the auto-generated\n+ * errors.json file by reassigning error codes to avoid conflicts.\n+ *\n+ * Usage: node merge-errors-json.mjs <current> <base> <other> [<marker-size>]\n+ *\n+ * Arguments:\n+ * - current: Path to the current version (our changes)\n+ * - base: Path to the common ancestor version\n+ * - other: Path to the other version (their changes)\n+ * - marker-size: Size of conflict markers (optional, defaults to 7)\n+ *\n+ * Exit codes:\n+ * - 0: Merge successful, result written to current file\n+ * - 1: Merge failed, conflicts remain\n+ */\n+\n+import { readFileSync, writeFileSync } from 'node:fs'\n+\n+function main() {\n+  const args = process.argv.slice(2)\n+\n+  if (args.length < 3) {\n+    console.error(\n+      'Usage: node merge-errors-json.mjs <current> <base> <other> [<marker-size>]'\n+    )\n+    process.exit(1)\n+  }\n+\n+  const [currentPath, basePath, otherPath] = args\n+\n+  try {\n+    const base = readJsonSync(basePath)\n+    const current = readJsonSync(currentPath)\n+    const other = readJsonSync(otherPath)\n+\n+    const merged = mergeErrors(base, current, other)\n+\n+    // Git expects the result to be written to the \"current\" file\n+    writeJsonSync(currentPath, merged)\n+\n+    const addedCount = Object.keys(merged).length - Object.keys(current).length\n+    console.log(\n+      `merge-errors-json: added ${addedCount === 1 ? '1 new message' : `${addedCount} new messages`} to errors.json`\n+    )\n+    process.exit(0)\n+  } catch (error) {\n+    console.error('merge-errors-json: merge failed:', error.message)\n+    process.exit(1)\n+  }\n+}\n+\n+/**\n+ * @typedef {Record<string, string>} ErrorsMap\n+ */\n+\n+/**\n+ * Merge three versions of errors.json, resolving conflicts by assigning new sequential IDs\n+ * @param {ErrorsMap} base - Base version (common ancestor)\n+ * @param {ErrorsMap} current - Current version (our changes, or the state of the branch we're rebasing onto)\n+ * @param {ErrorsMap} other - Other version (their changes, or the state the branch we're rebasing, a.k.a. \"incoming\")\n+ * @returns {ErrorsMap}\n+ */\n+function mergeErrors(base, current, other) {\n+  /** @type {ErrorsMap} */\n+  const result = { ...current }\n+\n+  /** @type {Set<string>} */\n+  const existingMessages = new Set(Object.values(result))\n+\n+  let nextKey = Object.keys(result).length + 1\n+\n+  for (const message of getNewMessages(base, other)) {\n+    if (existingMessages.has(message)) {\n+      continue\n+    }\n+\n+    const key = nextKey++\n+    result[key] = message\n+    existingMessages.add(message)\n+  }\n+\n+  return result\n+}\n+\n+function getNewMessages(\n+  /** @type {ErrorsMap} */ prev,\n+  /** @type {ErrorsMap} */ current\n+) {\n+  const existing = new Set(Object.values(prev))\n+  return Object.values(current).filter((msg) => !existing.has(msg))\n+}\n+\n+function readJsonSync(/** @type {string} */ filePath) {\n+  const content = readFileSync(filePath, 'utf8')\n+  return JSON.parse(content)\n+}\n+\n+function writeJsonSync(\n+  /** @type {string} */ filePath,\n+  /** @type {any} */ value\n+) {\n+  const content = JSON.stringify(value, null, 2) + '\\n'\n+  writeFileSync(filePath, content, 'utf8')\n+}\n+\n+main()"
        },
        {
            "sha": "4b19a0e0eab88323c2d3a74db4354c94e50f0cdd",
            "filename": "test/scripts/merge-errors-json/merge-errors-json.test.ts",
            "status": "added",
            "additions": 124,
            "deletions": 0,
            "changes": 124,
            "blob_url": "https://github.com/vercel/next.js/blob/7446af4fce02d37d943163e146b369e169edb421/test%2Fscripts%2Fmerge-errors-json%2Fmerge-errors-json.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7446af4fce02d37d943163e146b369e169edb421/test%2Fscripts%2Fmerge-errors-json%2Fmerge-errors-json.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fscripts%2Fmerge-errors-json%2Fmerge-errors-json.test.ts?ref=7446af4fce02d37d943163e146b369e169edb421",
            "patch": "@@ -0,0 +1,124 @@\n+import { mkdtempSync, rmSync } from 'fs'\n+import { writeJSONSync, readJSONSync } from 'fs-extra'\n+import { join } from 'path'\n+import { tmpdir } from 'os'\n+import execa from 'execa'\n+\n+describe('merge-errors-json driver', () => {\n+  it('should correctly merge errors.json files with conflicting new entries', async () => {\n+    const base = {\n+      '1': 'Original message 1',\n+      '2': 'Original message 2',\n+    }\n+    const current = {\n+      ...base,\n+      '3': 'From a conflicting branch that was merged first 1',\n+      '4': 'From a conflicting branch that was merged first 2',\n+    }\n+    const rebased = await simulateRebase({\n+      base,\n+      current,\n+      incoming: {\n+        ...base,\n+        '3': 'From our branch 1',\n+        '4': 'From our branch 2',\n+      },\n+    })\n+    expect(rebased).toEqual({\n+      ...current,\n+      '5': 'From our branch 1',\n+      '6': 'From our branch 2',\n+    })\n+  })\n+\n+  it('should handle empty base file', async () => {\n+    const base = {}\n+    const current = {\n+      '1': 'Message from a conflicting branch that was merged first',\n+    }\n+    const rebased = await simulateRebase({\n+      base,\n+      current,\n+      incoming: { '1': 'New message from our branch' },\n+    })\n+    expect(rebased).toEqual({\n+      ...current,\n+      '2': 'New message from our branch',\n+    })\n+  })\n+\n+  it('should handle stacked PRs', async () => {\n+    const base = {\n+      '1': 'Original message 1',\n+      '2': 'Original message 2',\n+    }\n+    const current = {\n+      ...base,\n+      '3': 'Message from a conflicting branch that was merged first',\n+    }\n+    const ourBranch1 = {\n+      ...base,\n+      '3': 'New message from our-branch-1',\n+    }\n+    const ourBranch2 = {\n+      ...ourBranch1,\n+      '4': 'New message from our-branch-2', // will conflict after our-branch-1 is rebased and its error is renumbered to 4\n+    }\n+\n+    const branch1Rebased = await simulateRebase({\n+      base: base,\n+      current: current,\n+      incoming: ourBranch1,\n+    })\n+    expect(branch1Rebased).toEqual({\n+      ...current,\n+      '4': 'New message from our-branch-1',\n+    })\n+\n+    const branch2Rebased = await simulateRebase({\n+      base: ourBranch1,\n+      current: branch1Rebased,\n+      incoming: ourBranch2,\n+    })\n+    expect(branch2Rebased).toEqual({\n+      ...branch1Rebased,\n+      '5': 'New message from our-branch-2',\n+    })\n+  })\n+})\n+\n+type Contents = Record<string, string>\n+\n+async function simulateRebase({\n+  base,\n+  current,\n+  incoming,\n+}: {\n+  base: Contents\n+  current: Contents\n+  incoming: Contents\n+}) {\n+  const tempDir = mkdtempSync(join(tmpdir(), 'merge-driver-test-'))\n+\n+  const paths = {\n+    base: join(tempDir, 'base.json'),\n+    current: join(tempDir, 'current.json'),\n+    other: join(tempDir, 'other.json'),\n+  }\n+\n+  writeJSONSync(paths.base, base, { spaces: 2 })\n+  // during a rebase, the branch we're rebasing onto will be \"current\", and our commit will be \"other\"\n+  writeJSONSync(paths.current, current, { spaces: 2 })\n+  writeJSONSync(paths.other, incoming, { spaces: 2 })\n+\n+  await execa('node', [\n+    'scripts/merge-errors-json/merge.mjs',\n+    paths.current,\n+    paths.base,\n+    paths.other,\n+  ])\n+\n+  const result = readJSONSync(paths.current)\n+  rmSync(tempDir, { recursive: true, force: true })\n+  return result\n+}"
        }
    ],
    "stats": {
        "total": 242,
        "additions": 242,
        "deletions": 0
    }
}