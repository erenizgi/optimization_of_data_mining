{
    "author": "devjiwonchoi",
    "message": "fix: build CLI output not displaying Proxy (Middleware) when nodejs runtime (#85403)",
    "sha": "d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7",
    "files": [
        {
            "sha": "51d56ac3b9bad7295ffac1057f72387113467480",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7",
            "patch": "@@ -4268,6 +4268,7 @@ export default async function build(\n           pageExtensions: config.pageExtensions,\n           buildManifest,\n           middlewareManifest,\n+          functionsConfigManifest,\n           hasGSPAndRevalidateZero,\n         })\n       )"
        },
        {
            "sha": "78517025cff37342ad78710f50cbaea7518a1b46",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7",
            "patch": "@@ -75,6 +75,7 @@ import { formatExpire, formatRevalidate } from './output/format'\n import type { AppRouteRouteModule } from '../server/route-modules/app-route/module'\n import { formatIssue, isRelevantWarning } from '../shared/lib/turbopack/utils'\n import type { TurbopackResult } from './swc/types'\n+import type { FunctionsConfigManifest } from './index'\n \n export type ROUTER_TYPE = 'pages' | 'app'\n \n@@ -274,13 +275,15 @@ export async function printTreeView(\n     pagesDir,\n     pageExtensions,\n     middlewareManifest,\n+    functionsConfigManifest,\n     useStaticPages404,\n     hasGSPAndRevalidateZero,\n   }: {\n     pagesDir?: string\n     pageExtensions: PageExtensions\n     buildManifest: BuildManifest\n     middlewareManifest: MiddlewareManifest\n+    functionsConfigManifest: FunctionsConfigManifest\n     useStaticPages404: boolean\n     hasGSPAndRevalidateZero: Set<string>\n   }\n@@ -533,8 +536,12 @@ export async function printTreeView(\n     list: lists.pages,\n   })\n \n-  const middlewareInfo = middlewareManifest.middleware?.['/']\n-  if (middlewareInfo?.files.length > 0) {\n+  if (\n+    middlewareManifest.middleware?.['/']?.files.length > 0 ||\n+    // 'nodejs' runtime middleware or proxy is set to\n+    // functions-config-manifest instead of middleware-manifest.\n+    functionsConfigManifest.functions?.['/_middleware']\n+  ) {\n     messages.push([])\n     messages.push(['ƒ Proxy (Middleware)'])\n   }"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/production/app-dir/proxy-build-cli-output/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fapp%2Flayout.tsx?ref=d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/production/app-dir/proxy-build-cli-output/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fapp%2Fpage.tsx?ref=d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/app-dir/proxy-build-cli-output/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fnext.config.js?ref=d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "4d063aa94ae299ef995427cacb2468a2d120d615",
            "filename": "test/production/app-dir/proxy-build-cli-output/proxy-build-cli-output.test.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fproxy-build-cli-output.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fproxy-build-cli-output.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fproxy-build-cli-output.test.ts?ref=d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7",
            "patch": "@@ -0,0 +1,14 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('proxy-build-cli-output', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should print proxy in the build CLI output', async () => {\n+    expect(next.cliOutput).toContain('ƒ Proxy (Middleware)')\n+\n+    const browser = await next.browser('/foo')\n+    expect(await browser.elementByCss('p').text()).toBe('hello world')\n+  })\n+})"
        },
        {
            "sha": "32050b6eb4aee76320a62ad618a5e15d2fb3893c",
            "filename": "test/production/app-dir/proxy-build-cli-output/proxy.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fproxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fproxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-build-cli-output%2Fproxy.ts?ref=d8cde2a57d586bfe7db588d8bfe4ff3d6830a4a7",
            "patch": "@@ -0,0 +1,8 @@\n+import { NextRequest, NextResponse } from 'next/server'\n+\n+export default function proxy(request: NextRequest) {\n+  if (request.nextUrl.pathname === '/foo') {\n+    return NextResponse.redirect(new URL('/', request.url))\n+  }\n+  return NextResponse.next()\n+}"
        }
    ],
    "stats": {
        "total": 51,
        "additions": 49,
        "deletions": 2
    }
}