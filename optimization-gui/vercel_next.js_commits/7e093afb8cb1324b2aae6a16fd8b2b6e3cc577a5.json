{
    "author": "shrink",
    "message": "Eslint: Improve Google Tag manager third parties message (#51903)\n\nNote: new PR description written by @timneutkens \n\n## What?\n\nImproves the detection of Google Tag Manager vs Google Analytics.\nAs indicated by the author of this PR it was confusing that when you\nhave Google Tag Manager set up it gives you an error message saying\nyou're adding Google Analytics even though it's Tag Manager.\n\nI've updated the PR to have a separate message for Google Tag Manager\nand expanded the error message docs too.\n\nIt also mentioned `next/script` in a bunch of places even though the\nerror doc recommends `@next/third-parties`. I've updated all cases to\nrefer to `@next/third-parties` instead.\n\n<details>\n<summary>Previous PR description</summary>\nGoogle has multiple products with similar names: the \"Google Tag\" and\n\"Google Tag Manager\". Google Tag Manager uses `gtm.js` whereas the\n\"Google Tag\" uses `gtag`. Google Analytics previously used\n`analytics.js` (<2017) and is now delivered via the \"Google Tag\".\n\nGoogle Tag: `www.googletagmanager.com/gtag/js`\nGoogle Tag Manager: `www.googletagmanager.com/gtm.js`\n\nThe `next-script-for-ga.ts` rule's matching list\n(`SUPPORTED_HTML_CONTENT_URLS`) includes `gtm.js` which means when a\ndeveloper adds Google Tag Manager to their NextJS website, they'll\nreceive the warning and be encouraged to swap from `gtm.js` to `gtag`. A\ndeveloper asleep at the wheel (...me) may think...\n\n> I'm using Google Analytics via Google Tag Manager, and NextJS is\nsuggesting I swap `gtm.js` for `gtag` because it will improve\nperformance. `gtag` sounds like it is part of \"Google Tag Manager\" so I\nam going to follow the instructions so that my website is faster.\n\nHowever, `gtag` is **not** compatible with `gtm.js` (they're different\nproducts with similar names and similar purposes) and so making this\nchange will cause very confusing Google Tag Manager behaviour. I am\nsuggesting that `gtm.js` is removed completely from the rule, because\nanyone using `gtm.js` should not be following these instructions. A\nseparate rule could be added specifically for Google Tag Manager, that\ndoes not refer to `gtag`.\n</details>\n\n---------\n\nCo-authored-by: Tim Neutkens <tim@timneutkens.nl>",
    "sha": "7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5",
    "files": [
        {
            "sha": "c1d67f8af5e0b3370297f2f86db8104d49cf7ff8",
            "filename": "errors/next-script-for-ga.mdx",
            "status": "modified",
            "additions": 38,
            "deletions": 7,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5/errors%2Fnext-script-for-ga.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5/errors%2Fnext-script-for-ga.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/errors%2Fnext-script-for-ga.mdx?ref=7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5",
            "patch": "@@ -1,8 +1,8 @@\n ---\n-title: Using Google Analytics with Next.js (through `next/script`)\n+title: Using Google Analytics with Next.js (through `@next/third-parties/google`)\n ---\n \n-> Prefer `next/script` component when using the inline script for Google Analytics.\n+> Prefer `@next/third-parties/google` when using the inline script for Google Analytics and Tag Manager.\n \n ## Why This Error Occurred\n \n@@ -63,11 +63,42 @@ export default function Page() {\n }\n ```\n \n-> **Good to know:**\n->\n-> - If you are using the Pages Router, please refer to the [`pages/` documentation](/docs/pages/guides/third-party-libraries).\n-> - `@next/third-parties` also supports [Google Tag Manager](/docs/app/guides/third-party-libraries#google-tag-manager) and other third parties.\n-> - Using `@next/third-parties` is not required. You can also use the `next/script` component directly. Refer to the [`next/script` documentation](/docs/app/guides/scripts) to learn more.\n+### Use `@next/third-parties` to add Google Tag Manager\n+\n+The `GoogleTagManager` component can be used to add [Google Tag Manager](https://developers.google.com/tag-manager/quickstart) to your page.\n+\n+```tsx filename=\"app/layout.tsx\" switcher\n+import { GoogleTagManager } from '@next/third-parties/google'\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <GoogleTagManager gtmId=\"GTM-XYZ\" />\n+      <body>{children}</body>\n+    </html>\n+  )\n+}\n+```\n+\n+To load Google Tag Manager for a single route, include the component in your page file:\n+\n+```jsx filename=\"app/page.js\"\n+import { GoogleTagManager } from '@next/third-parties/google'\n+\n+export default function Page() {\n+  return <GoogleTagManager gtmId=\"GTM-XYZ\" />\n+}\n+```\n+\n+## Good to know\n+\n+- If you are using the Pages Router, please refer to the [`pages/` documentation](/docs/pages/guides/third-party-libraries).\n+- `@next/third-parties` also supports [other third parties](/docs/app/guides/third-party-libraries#google-tag-manager).\n+- Using `@next/third-parties` is not required. You can also use the `next/script` component directly. Refer to the [`next/script` documentation](/docs/app/guides/scripts) to learn more.\n \n ## Useful Links\n "
        },
        {
            "sha": "d06809f1972cefd8c9c744bfefc646cd6273e564",
            "filename": "packages/eslint-plugin-next/src/rules/next-script-for-ga.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 30,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5/packages%2Feslint-plugin-next%2Fsrc%2Frules%2Fnext-script-for-ga.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5/packages%2Feslint-plugin-next%2Fsrc%2Frules%2Fnext-script-for-ga.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Feslint-plugin-next%2Fsrc%2Frules%2Fnext-script-for-ga.ts?ref=7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5",
            "patch": "@@ -1,23 +1,17 @@\n import { defineRule } from '../utils/define-rule'\n import NodeAttributes from '../utils/node-attributes'\n \n-const SUPPORTED_SRCS = [\n-  'www.google-analytics.com/analytics.js',\n-  'www.googletagmanager.com/gtag/js',\n-]\n-const SUPPORTED_HTML_CONTENT_URLS = [\n-  'www.google-analytics.com/analytics.js',\n-  'www.googletagmanager.com/gtm.js',\n-]\n+const GOOGLE_ANALYTICS_URL = 'www.google-analytics.com/analytics.js'\n+const GOOGLE_TAG_MANAGER_URL = 'www.googletagmanager.com/gtag/js'\n+\n+const GOOGLE_ANALYTICS_SRC = GOOGLE_ANALYTICS_URL\n+const GOOGLE_TAG_MANAGER_SRC = 'www.googletagmanager.com/gtm.js'\n+\n const description =\n-  'Prefer `next/script` component when using the inline script for Google Analytics.'\n+  'Prefer `@next/third-parties/google` when using the inline script for Google Analytics and Tag Manager.'\n const url = 'https://nextjs.org/docs/messages/next-script-for-ga'\n-const ERROR_MSG = `${description} See: ${url}`\n-\n-// Check if one of the items in the list is a substring of the passed string\n-const containsStr = (str, strList) => {\n-  return strList.some((s) => str.includes(s))\n-}\n+const ERROR_MSG_GOOGLE_ANALYTICS = `Prefer \\`GoogleAnalytics\\` component from \\`@next/third-parties/google\\` when using the inline script for Google Analytics. See: ${url}`\n+const ERROR_MSG_GOOGLE_TAG_MANAGER = `Prefer \\`GoogleTagManager\\` component from \\`@next/third-parties/google\\` when using the inline script for Google Tag Manager. See: ${url}`\n \n export default defineRule({\n   meta: {\n@@ -40,37 +34,46 @@ export default defineRule({\n         }\n         const attributes = new NodeAttributes(node)\n \n+        const src = attributes.value('src')\n         // Check if the Alternative async tag is being used to add GA.\n         // https://developers.google.com/analytics/devguides/collection/analyticsjs#alternative_async_tag\n         // https://developers.google.com/analytics/devguides/collection/gtagjs\n-        if (\n-          typeof attributes.value('src') === 'string' &&\n-          containsStr(attributes.value('src'), SUPPORTED_SRCS)\n+        if (typeof src === 'string' && src.includes(GOOGLE_ANALYTICS_URL)) {\n+          return context.report({\n+            node,\n+            message: ERROR_MSG_GOOGLE_ANALYTICS,\n+          })\n+        } else if (\n+          typeof src === 'string' &&\n+          src.includes(GOOGLE_TAG_MANAGER_URL)\n         ) {\n           return context.report({\n             node,\n-            message: ERROR_MSG,\n+            message: ERROR_MSG_GOOGLE_TAG_MANAGER,\n           })\n         }\n \n+        const dangerouslySetInnerHTML = attributes.value(\n+          'dangerouslySetInnerHTML'\n+        )\n         // Check if inline script is being used to add GA.\n         // https://developers.google.com/analytics/devguides/collection/analyticsjs#the_google_analytics_tag\n         // https://developers.google.com/tag-manager/quickstart\n-        if (\n-          attributes.value('dangerouslySetInnerHTML') &&\n-          attributes.value('dangerouslySetInnerHTML').length > 0\n-        ) {\n-          const htmlContent =\n-            attributes.value('dangerouslySetInnerHTML')[0].value.quasis &&\n-            attributes.value('dangerouslySetInnerHTML')[0].value.quasis[0].value\n-              .raw\n-          if (\n+        if (dangerouslySetInnerHTML && dangerouslySetInnerHTML.length > 0) {\n+          const quasis = dangerouslySetInnerHTML[0].value.quasis\n+          const htmlContent = quasis?.[0]?.value?.raw\n+          if (htmlContent && htmlContent.includes(GOOGLE_ANALYTICS_SRC)) {\n+            context.report({\n+              node,\n+              message: ERROR_MSG_GOOGLE_ANALYTICS,\n+            })\n+          } else if (\n             htmlContent &&\n-            containsStr(htmlContent, SUPPORTED_HTML_CONTENT_URLS)\n+            htmlContent.includes(GOOGLE_TAG_MANAGER_SRC)\n           ) {\n             context.report({\n               node,\n-              message: ERROR_MSG,\n+              message: ERROR_MSG_GOOGLE_TAG_MANAGER,\n             })\n           }\n         }"
        },
        {
            "sha": "cbd288cd0d7c20578fb22932e06e1450d50a2b39",
            "filename": "test/unit/eslint-plugin-next/next-script-for-ga.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 35,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5/test%2Funit%2Feslint-plugin-next%2Fnext-script-for-ga.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5/test%2Funit%2Feslint-plugin-next%2Fnext-script-for-ga.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Feslint-plugin-next%2Fnext-script-for-ga.test.ts?ref=7e093afb8cb1324b2aae6a16fd8b2b6e3cc577a5",
            "patch": "@@ -3,8 +3,9 @@ import { rules } from '@next/eslint-plugin-next'\n \n const NextESLintRule = rules['next-script-for-ga']\n \n-const ERROR_MSG =\n-  'Prefer `next/script` component when using the inline script for Google Analytics. See: https://nextjs.org/docs/messages/next-script-for-ga'\n+const url = 'https://nextjs.org/docs/messages/next-script-for-ga'\n+const ERROR_MSG_GOOGLE_ANALYTICS = `Prefer \\`GoogleAnalytics\\` component from \\`@next/third-parties/google\\` when using the inline script for Google Analytics. See: ${url}`\n+const ERROR_MSG_GOOGLE_TAG_MANAGER = `Prefer \\`GoogleTagManager\\` component from \\`@next/third-parties/google\\` when using the inline script for Google Tag Manager. See: ${url}`\n \n const tests = {\n   valid: [\n@@ -108,36 +109,7 @@ const tests = {\n       }`,\n       errors: [\n         {\n-          message: ERROR_MSG,\n-          type: 'JSXOpeningElement',\n-        },\n-      ],\n-    },\n-    {\n-      code: `\n-        export class Blah extends Head {\n-          render() {\n-            return (\n-              <div>\n-                <h1>Hello title</h1> qqq\n-                {/* Google Tag Manager - Global base code */}\n-                <script\n-                dangerouslySetInnerHTML={{\n-                  __html: \\`\n-                    (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':\n-                    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],\n-                    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=\n-                    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);\n-                    })(window,document,'script','dataLayer', '\\${GTM_ID}');\n-                  \\`,\n-                }}/>\n-              </div>\n-            );\n-          }\n-      }`,\n-      errors: [\n-        {\n-          message: ERROR_MSG,\n+          message: ERROR_MSG_GOOGLE_TAG_MANAGER,\n           type: 'JSXOpeningElement',\n         },\n       ],\n@@ -166,7 +138,7 @@ const tests = {\n       }`,\n       errors: [\n         {\n-          message: ERROR_MSG,\n+          message: ERROR_MSG_GOOGLE_ANALYTICS,\n           type: 'JSXOpeningElement',\n         },\n       ],\n@@ -192,7 +164,7 @@ const tests = {\n       }`,\n       errors: [\n         {\n-          message: ERROR_MSG,\n+          message: ERROR_MSG_GOOGLE_ANALYTICS,\n           type: 'JSXOpeningElement',\n         },\n       ],\n@@ -222,7 +194,7 @@ const tests = {\n       }`,\n       errors: [\n         {\n-          message: ERROR_MSG,\n+          message: ERROR_MSG_GOOGLE_ANALYTICS,\n           type: 'JSXOpeningElement',\n         },\n       ],"
        }
    ],
    "stats": {
        "total": 150,
        "additions": 78,
        "deletions": 72
    }
}