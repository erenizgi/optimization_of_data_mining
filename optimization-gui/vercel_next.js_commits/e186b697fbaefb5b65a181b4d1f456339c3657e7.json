{
    "author": "unstubbable",
    "message": "[Segment Cache] Enable deploy tests (#80947)\n\nWith this PR, we're enabling deployment testing for the existing Segment\nCache test suites (excluding those that need a custom server setup).\n\nTwo timing issues were fixed, and one bug was uncovered. For details see\nthe inline comments below.",
    "sha": "e186b697fbaefb5b65a181b4d1f456339c3657e7",
    "files": [
        {
            "sha": "af0879b15893621af4dea5317c7d87793106ca43",
            "filename": "test/e2e/app-dir/segment-cache/basic/segment-cache-basic.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -2,11 +2,10 @@ import { nextTestSetup } from 'e2e-utils'\n import { createRouterAct } from '../router-act'\n \n describe('segment cache (basic tests)', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('ppr is disabled', () => {})\n     return\n   }"
        },
        {
            "sha": "c9a8e293d50a821e668cf33d36d8e87c07161bdc",
            "filename": "test/e2e/app-dir/segment-cache/client-only-opt-in/client-only-opt-in.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fclient-only-opt-in.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fclient-only-opt-in.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fclient-only-opt-in%2Fclient-only-opt-in.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -3,11 +3,10 @@ import type * as Playwright from 'playwright'\n import { createRouterAct } from '../router-act'\n \n describe('segment cache prefetch scheduling', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('prefetching is disabled', () => {})\n     return\n   }"
        },
        {
            "sha": "1b4c0b35248aa2cd2f47d3c7f1be51915b0d9904",
            "filename": "test/e2e/app-dir/segment-cache/dynamic-on-hover/dynamic-on-hover.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fdynamic-on-hover%2Fdynamic-on-hover.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fdynamic-on-hover%2Fdynamic-on-hover.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fdynamic-on-hover%2Fdynamic-on-hover.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -3,11 +3,10 @@ import type * as Playwright from 'playwright'\n import { createRouterAct } from '../router-act'\n \n describe('dynamic on hover', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('prefetching is disabled', () => {})\n     return\n   }"
        },
        {
            "sha": "de6705a824bc68aeb7816ba0771a736ce0ff0539",
            "filename": "test/e2e/app-dir/segment-cache/incremental-opt-in/segment-cache-incremental-opt-in.test.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 19,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -1,12 +1,12 @@\n import { nextTestSetup } from 'e2e-utils'\n import { createRouterAct } from '../router-act'\n+import { Page } from 'playwright'\n \n describe('segment cache (incremental opt in)', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDeploy, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('ppr is disabled', () => {})\n     return\n   }\n@@ -21,21 +21,22 @@ describe('segment cache (incremental opt in)', () => {\n     // that occur. Then at the end we confirm there are no duplicates.\n     const prefetches = new Map()\n     const duplicatePrefetches = new Map()\n+    const unexpectedResponses = []\n \n-    let act\n+    let currentPage: Page\n     const browser = await next.browser('/', {\n       async beforePageLoad(page) {\n-        act = createRouterAct(page)\n+        currentPage = page\n         await page.route('**/*', async (route) => {\n           const request = route.request()\n+          const headers = await request.allHeaders()\n           const isPrefetch =\n-            request.headerValue('rsc') !== null &&\n-            request.headerValue('next-router-prefetch') !== null\n+            headers['rsc'] !== undefined &&\n+            headers['next-router-prefetch'] !== undefined\n           if (isPrefetch) {\n-            const request = route.request()\n-            const headers = await request.allHeaders()\n+            const url = request.url()\n             const prefetchInfo = {\n-              href: new URL(request.url()).pathname,\n+              href: new URL(url).pathname,\n               segment: headers['Next-Router-Segment-Prefetch'.toLowerCase()],\n               base: headers['Next-Router-State-Tree'.toLowerCase()] ?? null,\n             }\n@@ -45,6 +46,19 @@ describe('segment cache (incremental opt in)', () => {\n             } else {\n               prefetches.set(key, prefetchInfo)\n             }\n+            const response = await page.request.fetch(request, {\n+              maxRedirects: 0,\n+            })\n+            const status = response.status()\n+            if (status !== 200) {\n+              unexpectedResponses.push({\n+                status,\n+                url,\n+                headers: response.headers(),\n+                response: await response.text(),\n+              })\n+            }\n+            return route.fulfill({ response })\n           }\n           route.continue()\n         })\n@@ -60,10 +74,8 @@ describe('segment cache (incremental opt in)', () => {\n     expect(await checkbox.isChecked()).toBe(false)\n \n     // Click the checkbox to reveal the link and trigger a prefetch\n-    await act(async () => {\n-      await checkbox.click()\n-      await browser.elementByCss(`a[href=\"${linkHref}\"]`)\n-    })\n+    await checkbox.click()\n+    await browser.elementByCss(`a[href=\"${linkHref}\"]`)\n \n     // Toggle the visibility of the link. Prefetches are initiated on viewport,\n     // so if the cache does not dedupe then properly, this test will detect it.\n@@ -78,15 +90,23 @@ describe('segment cache (incremental opt in)', () => {\n     await browser.elementById('page-content')\n     expect(new URL(await browser.url()).pathname).toBe(linkHref)\n \n-    // Finally, assert there were no duplicate prefetches\n-    expect(prefetches.size).not.toBe(0)\n-    expect(duplicatePrefetches.size).toBe(0)\n+    // Wait for all pending requests to complete.\n+    await currentPage.unrouteAll({ behavior: 'wait' })\n+\n+    // Finally, assert there were no duplicate prefetches and no unexpected\n+    // responses.\n+    expect(prefetches).not.toBeEmpty()\n+    expect(duplicatePrefetches).toBeEmpty()\n+    expect(unexpectedResponses).toBeEmpty()\n   }\n \n   describe('multiple prefetches to same link are deduped', () => {\n     it('page with PPR enabled', () => testPrefetchDeduping('/ppr-enabled'))\n-    it('page with PPR enabled, and has a dynamic param', () =>\n-      testPrefetchDeduping('/ppr-enabled/dynamic-param'))\n+    // FIXME: When deployed, the _tree prefetch request returns an empty 204.\n+    ;(isNextDeploy ? it.failing : it)(\n+      'page with PPR enabled, and has a dynamic param',\n+      () => testPrefetchDeduping('/ppr-enabled/dynamic-param')\n+    )\n     it('page with PPR disabled', () => testPrefetchDeduping('/ppr-disabled'))\n     it('page with PPR disabled, and has a loading boundary', () =>\n       testPrefetchDeduping('/ppr-disabled-with-loading-boundary'))"
        },
        {
            "sha": "bcb7a0f2fec50b98312a370c03159327f0e63a9c",
            "filename": "test/e2e/app-dir/segment-cache/memory-pressure/segment-cache-memory-pressure.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmemory-pressure%2Fsegment-cache-memory-pressure.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmemory-pressure%2Fsegment-cache-memory-pressure.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmemory-pressure%2Fsegment-cache-memory-pressure.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -2,11 +2,10 @@ import { nextTestSetup } from 'e2e-utils'\n import { createRouterAct } from '../router-act'\n \n describe('segment cache memory pressure', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('disabled in development / deployment', () => {})\n     return\n   }"
        },
        {
            "sha": "4097c282fc9cb531ebda98f0503080927153e23a",
            "filename": "test/e2e/app-dir/segment-cache/mpa-navigations/mpa-navigations.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 13,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmpa-navigations%2Fmpa-navigations.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmpa-navigations%2Fmpa-navigations.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fmpa-navigations%2Fmpa-navigations.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -1,11 +1,11 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n \n describe('segment cache (MPA navigations)', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('ppr is disabled', () => {})\n     return\n   }\n@@ -26,10 +26,14 @@ describe('segment cache (MPA navigations)', () => {\n     await link.click()\n \n     // The expando should not be present because we did a full-page navigation.\n-    const htmlAfterNav = await browser.elementByCss('html')\n-    expect(\n-      await htmlAfterNav.evaluate((el) => (el as ElementWithExpando).__expando)\n-    ).toBe(undefined)\n+    await retry(async () => {\n+      const htmlAfterNav = await browser.elementByCss('html')\n+      expect(\n+        await htmlAfterNav.evaluate(\n+          (el) => (el as ElementWithExpando).__expando\n+        )\n+      ).toBe(undefined)\n+    })\n   })\n \n   it(\n@@ -53,12 +57,14 @@ describe('segment cache (MPA navigations)', () => {\n       await link.click()\n \n       // The expando should not be present because we did a full-page navigation.\n-      const htmlAfterNav = await browser.elementByCss('html')\n-      expect(\n-        await htmlAfterNav.evaluate(\n-          (el) => (el as ElementWithExpando).__expando\n-        )\n-      ).toBe(undefined)\n+      await retry(async () => {\n+        const htmlAfterNav = await browser.elementByCss('html')\n+        expect(\n+          await htmlAfterNav.evaluate(\n+            (el) => (el as ElementWithExpando).__expando\n+          )\n+        ).toBe(undefined)\n+      })\n     }\n   )\n })"
        },
        {
            "sha": "fb2c6f4fc98821a33ab22df5a16dcbd53512f81f",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-auto/prefetch-auto.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fprefetch-auto.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fprefetch-auto.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fprefetch-auto.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -3,11 +3,10 @@ import type * as Playwright from 'playwright'\n import { createRouterAct } from '../router-act'\n \n describe('<Link prefetch=\"auto\">', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     it('disabled in development / deployment', () => {})\n     return\n   }"
        },
        {
            "sha": "5783ef8f6db10d949def44b0c4f8703b4350a94e",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-scheduling/prefetch-scheduling.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-scheduling%2Fprefetch-scheduling.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-scheduling%2Fprefetch-scheduling.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-scheduling%2Fprefetch-scheduling.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -3,11 +3,10 @@ import type * as Playwright from 'playwright'\n import { createRouterAct } from '../router-act'\n \n describe('segment cache prefetch scheduling', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('prefetching is disabled', () => {})\n     return\n   }"
        },
        {
            "sha": "bee0620620d0099ea262be232e8bee5e485bca9e",
            "filename": "test/e2e/app-dir/segment-cache/search-params/segment-cache-search-params.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsearch-params%2Fsegment-cache-search-params.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsearch-params%2Fsegment-cache-search-params.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fsearch-params%2Fsegment-cache-search-params.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -2,11 +2,10 @@ import { nextTestSetup } from 'e2e-utils'\n import { createRouterAct } from '../router-act'\n \n describe('segment cache (search params)', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('ppr is disabled', () => {})\n     return\n   }"
        },
        {
            "sha": "a7cad5d72a9a396d8c4552118152fb61f8d48ef5",
            "filename": "test/e2e/app-dir/segment-cache/staleness/segment-cache-stale-time.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e186b697fbaefb5b65a181b4d1f456339c3657e7/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fstaleness%2Fsegment-cache-stale-time.test.ts?ref=e186b697fbaefb5b65a181b4d1f456339c3657e7",
            "patch": "@@ -3,11 +3,10 @@ import type * as Playwright from 'playwright'\n import { createRouterAct } from '../router-act'\n \n describe('segment cache (staleness)', () => {\n-  const { next, isNextDev, skipped } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n-    skipDeployment: true,\n   })\n-  if (isNextDev || skipped) {\n+  if (isNextDev) {\n     test('disabled in development / deployment', () => {})\n     return\n   }\n@@ -90,6 +89,8 @@ describe('segment cache (staleness)', () => {\n     const act = createRouterAct(page)\n \n     await page.clock.install()\n+    const startDate = Date.now()\n+    await page.clock.setFixedTime(startDate)\n \n     // Navigate to the dynamic page\n     await act(\n@@ -111,10 +112,10 @@ describe('segment cache (staleness)', () => {\n \n     await browser.back()\n \n-    // Fast forward 29 seconds. staleTimes.dynamic is configured as 30s, so if\n-    // we navigate to the same link again, the old data should be reused without\n-    // a new network request.\n-    await page.clock.fastForward(29 * 1000)\n+    // Advance time by 29 seconds. staleTimes.dynamic is configured as 30s, so\n+    // if we navigate to the same link again, the old data should be reused\n+    // without a new network request.\n+    await page.clock.setFixedTime(startDate + 29 * 1000)\n \n     await act(async () => {\n       const toggle = await browser.elementByCss(\n@@ -131,9 +132,9 @@ describe('segment cache (staleness)', () => {\n \n     await browser.back()\n \n-    // Fast forward an additional second. This time, if we navigate to the link\n+    // Advance an additional second. This time, if we navigate to the link\n     // again, the data is stale, so we issue a new request.\n-    await page.clock.fastForward(1 * 1000)\n+    await page.clock.setFixedTime(startDate + 30 * 1000)\n \n     await act(\n       async () => {"
        }
    ],
    "stats": {
        "total": 144,
        "additions": 82,
        "deletions": 62
    }
}