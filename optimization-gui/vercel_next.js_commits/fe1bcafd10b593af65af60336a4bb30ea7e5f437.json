{
    "author": "timneutkens",
    "message": "Turbopack: Implement next/font/local declarations option (#85051)\n\n## What?\n\nFixes #82822. Implements `declarations` which was missing in the implementation of `next/font/local`",
    "sha": "fe1bcafd10b593af65af60336a4bb30ea7e5f437",
    "files": [
        {
            "sha": "bb1aef545a303fc63336f0c16f9e07ec8d3567f2",
            "filename": "crates/next-core/src/next_font/local/options.rs",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/fe1bcafd10b593af65af60336a4bb30ea7e5f437/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Foptions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fe1bcafd10b593af65af60336a4bb30ea7e5f437/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Foptions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Foptions.rs?ref=fe1bcafd10b593af65af60336a4bb30ea7e5f437",
            "patch": "@@ -9,6 +9,7 @@ use super::request::{\n     AdjustFontFallback, NextFontLocalRequest, NextFontLocalRequestArguments, SrcDescriptor,\n     SrcRequest,\n };\n+use crate::next_font::local::request::NextFontLocalDeclaration;\n \n /// A normalized, Vc-friendly struct derived from validating and transforming\n /// [[NextFontLocalRequest]]\n@@ -32,6 +33,8 @@ pub(super) struct NextFontLocalOptions {\n     /// The name of the variable assigned to the results of calling the\n     /// `localFont` function. This is used as the font family's base name.\n     pub variable_name: RcStr,\n+    /// A list of custom properties to be included in the @font-face declaration.\n+    pub declarations: Option<Vec<NextFontLocalDeclaration>>,\n }\n \n impl NextFontLocalOptions {\n@@ -174,6 +177,7 @@ pub(super) fn options_from_request(request: &NextFontLocalRequest) -> Result<Nex\n         src,\n         adjust_font_fallback,\n         variable,\n+        declarations,\n     } = &request.arguments.0;\n \n     let fonts = match src {\n@@ -202,6 +206,15 @@ pub(super) fn options_from_request(request: &NextFontLocalRequest) -> Result<Nex\n         variable_name: request.variable_name.to_owned(),\n         default_weight: weight.as_ref().and_then(|s| s.parse().ok()),\n         default_style: style.to_owned(),\n+        declarations: declarations.as_ref().map(|decls| {\n+            decls\n+                .iter()\n+                .map(|decl| NextFontLocalDeclaration {\n+                    prop: decl.prop.clone(),\n+                    value: decl.value.clone(),\n+                })\n+                .collect()\n+        }),\n     })\n }\n \n@@ -248,7 +261,8 @@ mod tests {\n                 fallback: None,\n                 adjust_font_fallback: AdjustFontFallback::Arial,\n                 variable: None,\n-                variable_name: rcstr!(\"myFont\")\n+                variable_name: rcstr!(\"myFont\"),\n+                declarations: None,\n             },\n         );\n \n@@ -303,7 +317,8 @@ mod tests {\n                 fallback: None,\n                 adjust_font_fallback: AdjustFontFallback::Arial,\n                 variable: None,\n-                variable_name: rcstr!(\"myFont\")\n+                variable_name: rcstr!(\"myFont\"),\n+                declarations: None,\n             },\n         );\n \n@@ -377,7 +392,8 @@ mod tests {\n                 fallback: Some(vec![rcstr!(\"Fallback\")]),\n                 adjust_font_fallback: AdjustFontFallback::TimesNewRoman,\n                 variable: Some(rcstr!(\"myvar\")),\n-                variable_name: rcstr!(\"myFont\")\n+                variable_name: rcstr!(\"myFont\"),\n+                declarations: None,\n             },\n         );\n "
        },
        {
            "sha": "93da711afe02ad555465b441062e3eb58a703958",
            "filename": "crates/next-core/src/next_font/local/request.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/fe1bcafd10b593af65af60336a4bb30ea7e5f437/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Frequest.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fe1bcafd10b593af65af60336a4bb30ea7e5f437/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Frequest.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Frequest.rs?ref=fe1bcafd10b593af65af60336a4bb30ea7e5f437",
            "patch": "@@ -12,6 +12,25 @@ pub(super) struct NextFontLocalRequest {\n     pub variable_name: RcStr,\n }\n \n+#[derive(\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    PartialOrd,\n+    Ord,\n+    Hash,\n+    TaskInput,\n+    Serialize,\n+    Deserialize,\n+    TraceRawVcs,\n+    NonLocalValue,\n+)]\n+pub(super) struct NextFontLocalDeclaration {\n+    pub prop: RcStr,\n+    pub value: RcStr,\n+}\n+\n #[derive(Debug, Deserialize)]\n #[serde(rename_all = \"camelCase\")]\n pub(super) struct NextFontLocalRequestArguments {\n@@ -29,6 +48,7 @@ pub(super) struct NextFontLocalRequestArguments {\n     )]\n     pub adjust_font_fallback: AdjustFontFallback,\n     pub variable: Option<RcStr>,\n+    pub declarations: Option<Vec<NextFontLocalDeclaration>>,\n }\n \n #[derive(Debug, Deserialize)]"
        },
        {
            "sha": "91a3fd070c5ef3ebbef6e06793e8582973c60688",
            "filename": "crates/next-core/src/next_font/local/stylesheet.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/fe1bcafd10b593af65af60336a4bb30ea7e5f437/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Fstylesheet.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fe1bcafd10b593af65af60336a4bb30ea7e5f437/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Fstylesheet.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Flocal%2Fstylesheet.rs?ref=fe1bcafd10b593af65af60336a4bb30ea7e5f437",
            "patch": "@@ -1,5 +1,6 @@\n use anyhow::{Result, bail};\n use indoc::formatdoc;\n+use itertools::Itertools;\n use turbo_rcstr::RcStr;\n use turbo_tasks::Vc;\n \n@@ -64,12 +65,20 @@ pub(super) async fn build_font_face_definitions(\n         definitions.push_str(&formatdoc!(\n             r#\"\n                 @font-face {{\n+                    {}\n                     font-family: '{}';\n                     src: url('@vercel/turbopack-next/internal/font/local/font?{}') format('{}');\n                     font-display: {};\n                     {}{}\n                 }}\n             \"#,\n+            options.declarations.as_ref().map_or_else(\n+                || \"\".to_owned(),\n+                |declarations| declarations\n+                    .iter()\n+                    .map(|declaration| format!(\"{}: {};\", declaration.prop, declaration.value))\n+                    .join(\"\\n\")\n+            ),\n             scoped_font_family,\n             query_str,\n             ext_to_format(&font.ext)?,"
        },
        {
            "sha": "e1f9360fa015f8bbd0ddb35b407b2097bc8a392c",
            "filename": "test/e2e/next-font/app/pages/with-local-fonts.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/fe1bcafd10b593af65af60336a4bb30ea7e5f437/test%2Fe2e%2Fnext-font%2Fapp%2Fpages%2Fwith-local-fonts.js",
            "raw_url": "https://github.com/vercel/next.js/raw/fe1bcafd10b593af65af60336a4bb30ea7e5f437/test%2Fe2e%2Fnext-font%2Fapp%2Fpages%2Fwith-local-fonts.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-font%2Fapp%2Fpages%2Fwith-local-fonts.js?ref=fe1bcafd10b593af65af60336a4bb30ea7e5f437",
            "patch": "@@ -6,6 +6,7 @@ const myFont1 = localFont({\n   weight: '100',\n   fallback: ['system-ui'],\n   adjustFontFallback: 'Times New Roman',\n+  declarations: [{ prop: 'ascent-override', value: '90%' }],\n })\n const myFont2 = localFont({\n   src: '../fonts/my-other-font.woff2',"
        },
        {
            "sha": "a85329f13fe0613447786277a239f8d9a160da44",
            "filename": "test/e2e/next-font/index.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/fe1bcafd10b593af65af60336a4bb30ea7e5f437/test%2Fe2e%2Fnext-font%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fe1bcafd10b593af65af60336a4bb30ea7e5f437/test%2Fe2e%2Fnext-font%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-font%2Findex.test.ts?ref=fe1bcafd10b593af65af60336a4bb30ea7e5f437",
            "patch": "@@ -642,4 +642,28 @@ describe('next/font', () => {\n       })\n     })\n   })\n+\n+  describe('custom declarations', () => {\n+    test('local font with custom declarations', async () => {\n+      const browser = await webdriver(next.url, '/with-local-fonts')\n+\n+      // Get all stylesheets\n+      const stylesheets = await browser.eval(`\n+        Array.from(document.styleSheets)\n+          .map(sheet => {\n+            try {\n+              return Array.from(sheet.cssRules || sheet.rules || [])\n+                .map(rule => rule.cssText)\n+                .join('\\\\n')\n+            } catch (e) {\n+              return ''\n+            }\n+          })\n+          .join('\\\\n')\n+      `)\n+\n+      // Check that the custom declaration is included in the CSS\n+      expect(stylesheets).toContain('ascent-override: 90%')\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 73,
        "deletions": 3
    }
}