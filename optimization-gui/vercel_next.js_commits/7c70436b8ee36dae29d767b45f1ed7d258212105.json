{
    "author": "mischnic",
    "message": "Turbopack: don't include AMP optimizer in NFT (#77242)\n\nWebpack has this in the NFT ignore list, but [Turbopack doesn't support\nAMP at\nall](https://nextjs.org/docs/app/api-reference/turbopack#unsupported-and-unplanned-features).\nSo just completely disable that code path so that it also doesn't get\nincluded in NFT and upload unnecessary files to the server.\n\nAlso disables all not-already disabled AMP tests for Turbopack",
    "sha": "7c70436b8ee36dae29d767b45f1ed7d258212105",
    "files": [
        {
            "sha": "bd3542a053151f60dee2ffa341b3d4acc021890c",
            "filename": "packages/next/src/server/post-process.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7c70436b8ee36dae29d767b45f1ed7d258212105/packages%2Fnext%2Fsrc%2Fserver%2Fpost-process.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7c70436b8ee36dae29d767b45f1ed7d258212105/packages%2Fnext%2Fsrc%2Fserver%2Fpost-process.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fpost-process.ts?ref=7c70436b8ee36dae29d767b45f1ed7d258212105",
            "patch": "@@ -21,7 +21,7 @@ async function postProcessHTML(\n   { inAmpMode, hybridAmp }: { inAmpMode: boolean; hybridAmp: boolean }\n ) {\n   const postProcessors: Array<PostProcessorFunction> = [\n-    process.env.NEXT_RUNTIME !== 'edge' && inAmpMode\n+    process.env.NEXT_RUNTIME !== 'edge' && inAmpMode && !process.env.TURBOPACK\n       ? async (html: string) => {\n           const optimizeAmp = require('./optimize-amp')\n             .default as typeof import('./optimize-amp').default"
        },
        {
            "sha": "f904b2ec95061e0c9c10f772580d4ca30cd57dc4",
            "filename": "test/integration/amp-export-validation/test/index.test.js",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famp-export-validation%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famp-export-validation%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Famp-export-validation%2Ftest%2Findex.test.js?ref=7c70436b8ee36dae29d767b45f1ed7d258212105",
            "patch": "@@ -12,10 +12,11 @@ const nextConfig = new File(join(appDir, 'next.config.js'))\n \n let buildOutput\n \n-describe('AMP Validation on Export', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n+  // Turbopack does not support AMP rendering.\n+;(process.env.TURBOPACK ? describe.skip : describe)(\n+  'AMP Validation on Export',\n+  () => {\n+    describe('production mode', () => {\n       beforeAll(async () => {\n         const { stdout = '', stderr = '' } = await nextBuild(appDir, [], {\n           stdout: true,\n@@ -120,6 +121,6 @@ describe('AMP Validation on Export', () => {\n           nextConfig.restore()\n         }\n       })\n-    }\n-  )\n-})\n+    })\n+  }\n+)"
        },
        {
            "sha": "2f3283fff4f5562fe9bd6f2628a16b9c86e5058c",
            "filename": "test/integration/amphtml-custom-optimizer/test/index.test.js",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml-custom-optimizer%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml-custom-optimizer%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Famphtml-custom-optimizer%2Ftest%2Findex.test.js?ref=7c70436b8ee36dae29d767b45f1ed7d258212105",
            "patch": "@@ -13,10 +13,11 @@ let app\n let appPort\n const appDir = join(__dirname, '../')\n \n-describe('AMP Custom Optimizer', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n+// Turbopack does not support AMP rendering.\n+;(process.env.TURBOPACK ? describe.skip : describe)(\n+  'AMP Custom Optimizer',\n+  () => {\n+    describe('production mode', () => {\n       it('should build and start for static page', async () => {\n         const { code } = await nextBuild(appDir)\n         expect(code).toBe(0)\n@@ -54,6 +55,6 @@ describe('AMP Custom Optimizer', () => {\n           'script async src=\"https://cdn.ampproject.org/rtv/001515617716922/v0.mjs\"'\n         )\n       })\n-    }\n-  )\n-})\n+    })\n+  }\n+)"
        },
        {
            "sha": "cfe230b782f681da67d78b6c61b5e051ef33c4ef",
            "filename": "test/integration/amphtml-custom-validator/test/index.test.js",
            "status": "modified",
            "additions": 11,
            "deletions": 14,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml-custom-validator%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml-custom-validator%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Famphtml-custom-validator%2Ftest%2Findex.test.js?ref=7c70436b8ee36dae29d767b45f1ed7d258212105",
            "patch": "@@ -18,23 +18,20 @@ const appDir = join(__dirname, '../')\n ;(process.env.TURBOPACK ? describe.skip : describe)(\n   'AMP Custom Validator',\n   () => {\n-    ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-      'production mode',\n-      () => {\n-        it('should build and start successfully', async () => {\n-          const { code } = await nextBuild(appDir)\n-          expect(code).toBe(0)\n+    describe('production mode', () => {\n+      it('should build and start successfully', async () => {\n+        const { code } = await nextBuild(appDir)\n+        expect(code).toBe(0)\n \n-          appPort = await findPort()\n-          app = await nextStart(appDir, appPort)\n+        appPort = await findPort()\n+        app = await nextStart(appDir, appPort)\n \n-          const html = await renderViaHTTP(appPort, '/')\n-          await killApp(app)\n+        const html = await renderViaHTTP(appPort, '/')\n+        await killApp(app)\n \n-          expect(html).toContain('Hello from AMP')\n-        })\n-      }\n-    )\n+        expect(html).toContain('Hello from AMP')\n+      })\n+    })\n     ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n       'development mode',\n       () => {"
        },
        {
            "sha": "a52d299d5f7c2e439e6c30464cbe89066bce0f39",
            "filename": "test/integration/amphtml-fragment-style/test/index.test.js",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml-fragment-style%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml-fragment-style%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Famphtml-fragment-style%2Ftest%2Findex.test.js?ref=7c70436b8ee36dae29d767b45f1ed7d258212105",
            "patch": "@@ -15,10 +15,11 @@ const appDir = join(__dirname, '../')\n let appPort\n let app\n \n-describe('AMP Fragment Styles', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n+  // Turbopack does not support AMP rendering.\n+;(process.env.TURBOPACK ? describe.skip : describe)(\n+  'AMP Fragment Styles',\n+  () => {\n+    describe('production mode', () => {\n       beforeAll(async () => {\n         await nextBuild(appDir, [])\n         appPort = await findPort()\n@@ -34,6 +35,6 @@ describe('AMP Fragment Styles', () => {\n         expect(styles).toMatch(/background:(.*|)hotpink/)\n         expect(styles).toMatch(/font-size:(.*|)16\\.4px/)\n       })\n-    }\n-  )\n-})\n+    })\n+  }\n+)"
        },
        {
            "sha": "3be2f804e9919b38e107bbd38d9a53799cf8dcfd",
            "filename": "test/integration/amphtml-ssg/test/index.test.js",
            "status": "modified",
            "additions": 51,
            "deletions": 57,
            "changes": 108,
            "blob_url": "https://github.com/vercel/next.js/blob/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml-ssg%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml-ssg%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Famphtml-ssg%2Ftest%2Findex.test.js?ref=7c70436b8ee36dae29d767b45f1ed7d258212105",
            "patch": "@@ -98,66 +98,60 @@ const runTests = (isDev = false) => {\n   }\n }\n \n-describe('AMP SSG Support', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n+// Turbopack does not support AMP rendering.\n+;(process.env.TURBOPACK ? describe.skip : describe)('AMP SSG Support', () => {\n+  describe('production mode', () => {\n+    beforeAll(async () => {\n+      await nextBuild(appDir)\n+      appPort = await findPort()\n+      app = await nextStart(appDir, appPort)\n+      // TODO: use browser instead to do checks that now need filesystem access\n+      builtServerPagesDir = join(appDir, '.next', 'server', 'pages')\n+    })\n+    afterAll(() => killApp(app))\n+    runTests()\n+  })\n+\n+  describe('development mode', () => {\n+    beforeAll(async () => {\n+      appPort = await findPort()\n+      app = await launchApp(appDir, appPort)\n+    })\n+    afterAll(() => killApp(app))\n+    runTests(true)\n+  })\n+\n+  describe('export mode', () => {\n+    describe('production mode', () => {\n+      let buildId\n+\n       beforeAll(async () => {\n+        nextConfig.write(`module.exports = { output: 'export' }`)\n         await nextBuild(appDir)\n-        appPort = await findPort()\n-        app = await nextStart(appDir, appPort)\n-        // TODO: use browser instead to do checks that now need filesystem access\n-        builtServerPagesDir = join(appDir, '.next', 'server', 'pages')\n+        buildId = await fs.readFile(join(appDir, '.next/BUILD_ID'), 'utf8')\n       })\n-      afterAll(() => killApp(app))\n-      runTests()\n-    }\n-  )\n-  ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n-    'development mode',\n-    () => {\n-      beforeAll(async () => {\n-        appPort = await findPort()\n-        app = await launchApp(appDir, appPort)\n+\n+      afterAll(() => nextConfig.delete())\n+\n+      it('should have copied SSG files correctly', async () => {\n+        const outFile = (file) => join(appDir, 'out', file)\n+\n+        expect(await fsExists(outFile('amp.html'))).toBe(true)\n+        expect(await fsExists(outFile('index.html'))).toBe(true)\n+        expect(await fsExists(outFile('hybrid.html'))).toBe(true)\n+        expect(await fsExists(outFile('amp.amp.html'))).toBe(false)\n+        expect(await fsExists(outFile('hybrid.amp.html'))).toBe(true)\n+        expect(await fsExists(outFile('blog/post-1.html'))).toBe(true)\n+        expect(await fsExists(outFile('blog/post-1.amp.html'))).toBe(true)\n+\n+        expect(\n+          await fsExists(outFile(join('_next/data', buildId, 'amp.json')))\n+        ).toBe(true)\n+\n+        expect(\n+          await fsExists(outFile(join('_next/data', buildId, 'hybrid.json')))\n+        ).toBe(true)\n       })\n-      afterAll(() => killApp(app))\n-      runTests(true)\n-    }\n-  )\n-  describe('export mode', () => {\n-    ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-      'production mode',\n-      () => {\n-        let buildId\n-\n-        beforeAll(async () => {\n-          nextConfig.write(`module.exports = { output: 'export' }`)\n-          await nextBuild(appDir)\n-          buildId = await fs.readFile(join(appDir, '.next/BUILD_ID'), 'utf8')\n-        })\n-\n-        afterAll(() => nextConfig.delete())\n-\n-        it('should have copied SSG files correctly', async () => {\n-          const outFile = (file) => join(appDir, 'out', file)\n-\n-          expect(await fsExists(outFile('amp.html'))).toBe(true)\n-          expect(await fsExists(outFile('index.html'))).toBe(true)\n-          expect(await fsExists(outFile('hybrid.html'))).toBe(true)\n-          expect(await fsExists(outFile('amp.amp.html'))).toBe(false)\n-          expect(await fsExists(outFile('hybrid.amp.html'))).toBe(true)\n-          expect(await fsExists(outFile('blog/post-1.html'))).toBe(true)\n-          expect(await fsExists(outFile('blog/post-1.amp.html'))).toBe(true)\n-\n-          expect(\n-            await fsExists(outFile(join('_next/data', buildId, 'amp.json')))\n-          ).toBe(true)\n-\n-          expect(\n-            await fsExists(outFile(join('_next/data', buildId, 'hybrid.json')))\n-          ).toBe(true)\n-        })\n-      }\n-    )\n+    })\n   })\n })"
        },
        {
            "sha": "dec94518394c4a331f875e004bf33c8776532b7f",
            "filename": "test/integration/amphtml/test/index.test.js",
            "status": "modified",
            "additions": 257,
            "deletions": 281,
            "changes": 538,
            "blob_url": "https://github.com/vercel/next.js/blob/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7c70436b8ee36dae29d767b45f1ed7d258212105/test%2Fintegration%2Famphtml%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Famphtml%2Ftest%2Findex.test.js?ref=7c70436b8ee36dae29d767b45f1ed7d258212105",
            "patch": "@@ -24,9 +24,9 @@ let app\n \n const context = {}\n \n-describe('AMP Usage', () => {\n-  // AMP is not supported with Turbopack.\n-  ;(process.env.TURBOPACK ? describe.skip : describe)('production mode', () => {\n+// Turbopack does not support AMP rendering.\n+;(process.env.TURBOPACK ? describe.skip : describe)('AMP Usage', () => {\n+  describe('production mode', () => {\n     let output = ''\n \n     beforeAll(async () => {\n@@ -257,342 +257,318 @@ describe('AMP Usage', () => {\n       })\n     })\n   })\n-  ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n-    'AMP dev no-warn',\n-    () => {\n-      let dynamicAppPort\n-      let ampDynamic\n-\n-      it('should not warn on valid amp', async () => {\n-        let inspectPayload = ''\n-        dynamicAppPort = await findPort()\n-        ampDynamic = await launchApp(join(__dirname, '../'), dynamicAppPort, {\n-          onStdout(msg) {\n-            inspectPayload += msg\n-          },\n-          onStderr(msg) {\n-            inspectPayload += msg\n-          },\n-        })\n-\n-        await renderViaHTTP(dynamicAppPort, '/only-amp')\n-\n-        await killApp(ampDynamic)\n-\n-        expect(inspectPayload).not.toContain('warn')\n-      })\n-    }\n-  )\n-  ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n-    'AMP development mode',\n-    () => {\n-      let dynamicAppPort\n-      let ampDynamic\n-      let output = ''\n-\n-      beforeAll(async () => {\n-        dynamicAppPort = await findPort()\n-        ampDynamic = await launchApp(join(__dirname, '../'), dynamicAppPort, {\n-          onStdout(msg) {\n-            output += msg\n-          },\n-          onStderr(msg) {\n-            output += msg\n-          },\n-        })\n-      })\n-\n-      afterAll(() => killApp(ampDynamic))\n \n-      it('should navigate from non-AMP to AMP without error', async () => {\n-        const browser = await webdriver(dynamicAppPort, '/normal')\n-        await browser.elementByCss('#to-amp').click()\n-        await browser.waitForElementByCss('#only-amp')\n-        expect(await browser.elementByCss('#only-amp').text()).toMatch(\n-          /Only AMP/\n-        )\n-      })\n+  describe('AMP dev no-warn', () => {\n+    let dynamicAppPort\n+    let ampDynamic\n \n-      it('should add data-ampdevmode to development script tags', async () => {\n-        const html = await renderViaHTTP(dynamicAppPort, '/only-amp')\n-        const $ = cheerio.load(html)\n-        expect($('html').attr('data-ampdevmode')).toBe('')\n-        expect(\n-          [].slice\n-            .apply($('script[data-ampdevmode]'))\n-            .map((el) => el.attribs.src || el.attribs.id)\n-            .map((e) =>\n-              e.startsWith('/') ? new URL(e, 'http://x.x').pathname : e\n-            )\n-        ).not.toBeEmpty()\n+    it('should not warn on valid amp', async () => {\n+      let inspectPayload = ''\n+      dynamicAppPort = await findPort()\n+      ampDynamic = await launchApp(join(__dirname, '../'), dynamicAppPort, {\n+        onStdout(msg) {\n+          inspectPayload += msg\n+        },\n+        onStderr(msg) {\n+          inspectPayload += msg\n+        },\n       })\n \n-      it.skip('should detect the changes and display it', async () => {\n-        let browser\n-        try {\n-          browser = await webdriver(dynamicAppPort, '/hmr/test')\n-          const text = await browser.elementByCss('p').text()\n-          expect(text).toBe('This is the hot AMP page.')\n-\n-          const hmrTestPagePath = join(\n-            __dirname,\n-            '../',\n-            'pages',\n-            'hmr',\n-            'test.js'\n-          )\n-\n-          const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n-          const editedContent = originalContent.replace(\n-            'This is the hot AMP page',\n-            'This is a cold AMP page'\n-          )\n+      await renderViaHTTP(dynamicAppPort, '/only-amp')\n \n-          // change the content\n-          writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n+      await killApp(ampDynamic)\n \n-          await check(\n-            () => getBrowserBodyText(browser),\n-            /This is a cold AMP page/\n-          )\n+      expect(inspectPayload).not.toContain('warn')\n+    })\n+  })\n \n-          // add the original content\n-          writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n+  describe('AMP development mode', () => {\n+    let dynamicAppPort\n+    let ampDynamic\n+    let output = ''\n \n-          await check(\n-            () => getBrowserBodyText(browser),\n-            /This is the hot AMP page/\n-          )\n-        } finally {\n-          await browser.close()\n-        }\n+    beforeAll(async () => {\n+      dynamicAppPort = await findPort()\n+      ampDynamic = await launchApp(join(__dirname, '../'), dynamicAppPort, {\n+        onStdout(msg) {\n+          output += msg\n+        },\n+        onStderr(msg) {\n+          output += msg\n+        },\n       })\n+    })\n \n-      it.skip('should detect changes and refresh an AMP page', async () => {\n-        let browser\n-        try {\n-          browser = await webdriver(dynamicAppPort, '/hmr/amp')\n-          const text = await browser.elementByCss('p').text()\n-          expect(text).toBe(`I'm an AMP page!`)\n-\n-          const hmrTestPagePath = join(\n-            __dirname,\n-            '../',\n-            'pages',\n-            'hmr',\n-            'amp.js'\n-          )\n+    afterAll(() => killApp(ampDynamic))\n \n-          const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n-          const editedContent = originalContent.replace(\n-            `I'm an AMP page!`,\n-            'replaced it!'\n+    it('should navigate from non-AMP to AMP without error', async () => {\n+      const browser = await webdriver(dynamicAppPort, '/normal')\n+      await browser.elementByCss('#to-amp').click()\n+      await browser.waitForElementByCss('#only-amp')\n+      expect(await browser.elementByCss('#only-amp').text()).toMatch(/Only AMP/)\n+    })\n+\n+    it('should add data-ampdevmode to development script tags', async () => {\n+      const html = await renderViaHTTP(dynamicAppPort, '/only-amp')\n+      const $ = cheerio.load(html)\n+      expect($('html').attr('data-ampdevmode')).toBe('')\n+      expect(\n+        [].slice\n+          .apply($('script[data-ampdevmode]'))\n+          .map((el) => el.attribs.src || el.attribs.id)\n+          .map((e) =>\n+            e.startsWith('/') ? new URL(e, 'http://x.x').pathname : e\n           )\n+      ).not.toBeEmpty()\n+    })\n \n-          // change the content\n-          writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n+    it.skip('should detect the changes and display it', async () => {\n+      let browser\n+      try {\n+        browser = await webdriver(dynamicAppPort, '/hmr/test')\n+        const text = await browser.elementByCss('p').text()\n+        expect(text).toBe('This is the hot AMP page.')\n \n-          await check(() => getBrowserBodyText(browser), /replaced it!/)\n+        const hmrTestPagePath = join(\n+          __dirname,\n+          '../',\n+          'pages',\n+          'hmr',\n+          'test.js'\n+        )\n \n-          // add the original content\n-          writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n+        const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n+        const editedContent = originalContent.replace(\n+          'This is the hot AMP page',\n+          'This is a cold AMP page'\n+        )\n \n-          await check(() => getBrowserBodyText(browser), /I'm an AMP page!/)\n-        } finally {\n-          await browser.close()\n-        }\n-      })\n+        // change the content\n+        writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n \n-      it.skip('should detect changes to component and refresh an AMP page', async () => {\n-        const browser = await webdriver(dynamicAppPort, '/hmr/comp')\n-        await check(() => browser.elementByCss('#hello-comp').text(), /hello/)\n+        await check(\n+          () => getBrowserBodyText(browser),\n+          /This is a cold AMP page/\n+        )\n \n-        const testComp = join(__dirname, '../components/hello.js')\n+        // add the original content\n+        writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n \n-        const origContent = readFileSync(testComp, 'utf8')\n-        const newContent = origContent.replace('>hello<', '>hi<')\n+        await check(\n+          () => getBrowserBodyText(browser),\n+          /This is the hot AMP page/\n+        )\n+      } finally {\n+        await browser.close()\n+      }\n+    })\n \n-        writeFileSync(testComp, newContent, 'utf8')\n-        await check(() => browser.elementByCss('#hello-comp').text(), /hi/)\n+    it.skip('should detect changes and refresh an AMP page', async () => {\n+      let browser\n+      try {\n+        browser = await webdriver(dynamicAppPort, '/hmr/amp')\n+        const text = await browser.elementByCss('p').text()\n+        expect(text).toBe(`I'm an AMP page!`)\n \n-        writeFileSync(testComp, origContent, 'utf8')\n-        await check(() => browser.elementByCss('#hello-comp').text(), /hello/)\n-      })\n+        const hmrTestPagePath = join(__dirname, '../', 'pages', 'hmr', 'amp.js')\n \n-      it.skip('should not reload unless the page is edited for an AMP page', async () => {\n-        let browser\n-        const hmrTestPagePath = join(\n-          __dirname,\n-          '../',\n-          'pages',\n-          'hmr',\n-          'test.js'\n-        )\n         const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n-        try {\n-          await renderViaHTTP(dynamicAppPort, '/hmr/test')\n+        const editedContent = originalContent.replace(\n+          `I'm an AMP page!`,\n+          'replaced it!'\n+        )\n \n-          browser = await webdriver(dynamicAppPort, '/hmr/amp')\n-          await check(\n-            () => browser.elementByCss('p').text(),\n-            /I'm an AMP page!/\n-          )\n+        // change the content\n+        writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n \n-          const origDate = await browser.elementByCss('span').text()\n+        await check(() => getBrowserBodyText(browser), /replaced it!/)\n \n-          const editedContent = originalContent.replace(\n-            `This is the hot AMP page.`,\n-            'replaced it!'\n-          )\n+        // add the original content\n+        writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n \n-          // change the content\n-          writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n+        await check(() => getBrowserBodyText(browser), /I'm an AMP page!/)\n+      } finally {\n+        await browser.close()\n+      }\n+    })\n \n-          let checks = 5\n-          let i = 0\n-          while (i < checks) {\n-            const curText = await browser.elementByCss('span').text()\n-            expect(curText).toBe(origDate)\n-            await waitFor(1000)\n-            i++\n-          }\n+    it.skip('should detect changes to component and refresh an AMP page', async () => {\n+      const browser = await webdriver(dynamicAppPort, '/hmr/comp')\n+      await check(() => browser.elementByCss('#hello-comp').text(), /hello/)\n \n-          // add the original content\n-          writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n+      const testComp = join(__dirname, '../components/hello.js')\n \n-          const otherHmrTestPage = join(__dirname, '../pages/hmr/amp.js')\n+      const origContent = readFileSync(testComp, 'utf8')\n+      const newContent = origContent.replace('>hello<', '>hi<')\n \n-          const otherOrigContent = readFileSync(otherHmrTestPage, 'utf8')\n-          const otherEditedContent = otherOrigContent.replace(\n-            `I'm an AMP page!`,\n-            `replaced it!`\n-          )\n+      writeFileSync(testComp, newContent, 'utf8')\n+      await check(() => browser.elementByCss('#hello-comp').text(), /hi/)\n+\n+      writeFileSync(testComp, origContent, 'utf8')\n+      await check(() => browser.elementByCss('#hello-comp').text(), /hello/)\n+    })\n+\n+    it.skip('should not reload unless the page is edited for an AMP page', async () => {\n+      let browser\n+      const hmrTestPagePath = join(__dirname, '../', 'pages', 'hmr', 'test.js')\n+      const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n+      try {\n+        await renderViaHTTP(dynamicAppPort, '/hmr/test')\n \n-          // change the content\n-          writeFileSync(otherHmrTestPage, otherEditedContent, 'utf8')\n+        browser = await webdriver(dynamicAppPort, '/hmr/amp')\n+        await check(() => browser.elementByCss('p').text(), /I'm an AMP page!/)\n \n-          await check(() => getBrowserBodyText(browser), /replaced it!/)\n+        const origDate = await browser.elementByCss('span').text()\n \n-          // restore original content\n-          writeFileSync(otherHmrTestPage, otherOrigContent, 'utf8')\n+        const editedContent = originalContent.replace(\n+          `This is the hot AMP page.`,\n+          'replaced it!'\n+        )\n+\n+        // change the content\n+        writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n \n-          await check(() => getBrowserBodyText(browser), /I'm an AMP page!/)\n-        } finally {\n-          writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n-          await browser.close()\n+        let checks = 5\n+        let i = 0\n+        while (i < checks) {\n+          const curText = await browser.elementByCss('span').text()\n+          expect(curText).toBe(origDate)\n+          await waitFor(1000)\n+          i++\n         }\n-      })\n \n-      it.skip('should detect changes and refresh a hybrid AMP page', async () => {\n-        let browser\n-        try {\n-          browser = await webdriver(dynamicAppPort, '/hmr/hybrid?amp=1')\n-          const text = await browser.elementByCss('p').text()\n-          expect(text).toBe(`I'm a hybrid AMP page!`)\n-\n-          const hmrTestPagePath = join(\n-            __dirname,\n-            '../',\n-            'pages',\n-            'hmr',\n-            'hybrid.js'\n-          )\n+        // add the original content\n+        writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n \n-          const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n-          const editedContent = originalContent.replace(\n-            `I'm a hybrid AMP page!`,\n-            'replaced it!'\n-          )\n+        const otherHmrTestPage = join(__dirname, '../pages/hmr/amp.js')\n \n-          // change the content\n-          writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n+        const otherOrigContent = readFileSync(otherHmrTestPage, 'utf8')\n+        const otherEditedContent = otherOrigContent.replace(\n+          `I'm an AMP page!`,\n+          `replaced it!`\n+        )\n \n-          await check(() => getBrowserBodyText(browser), /replaced it!/)\n+        // change the content\n+        writeFileSync(otherHmrTestPage, otherEditedContent, 'utf8')\n \n-          // add the original content\n-          writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n+        await check(() => getBrowserBodyText(browser), /replaced it!/)\n \n-          await check(\n-            () => getBrowserBodyText(browser),\n-            /I'm a hybrid AMP page!/\n-          )\n-        } finally {\n-          await browser.close()\n-        }\n-      })\n+        // restore original content\n+        writeFileSync(otherHmrTestPage, otherOrigContent, 'utf8')\n \n-      it.skip('should detect changes and refresh an AMP page at root pages/', async () => {\n-        let browser\n-        try {\n-          browser = await webdriver(dynamicAppPort, '/root-hmr')\n-          const text = await browser.elementByCss('p').text()\n-          expect(text).toBe(`I'm an AMP page!`)\n+        await check(() => getBrowserBodyText(browser), /I'm an AMP page!/)\n+      } finally {\n+        writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n+        await browser.close()\n+      }\n+    })\n \n-          const hmrTestPagePath = join(__dirname, '../', 'pages', 'root-hmr.js')\n+    it.skip('should detect changes and refresh a hybrid AMP page', async () => {\n+      let browser\n+      try {\n+        browser = await webdriver(dynamicAppPort, '/hmr/hybrid?amp=1')\n+        const text = await browser.elementByCss('p').text()\n+        expect(text).toBe(`I'm a hybrid AMP page!`)\n \n-          const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n-          const editedContent = originalContent.replace(\n-            `I'm an AMP page!`,\n-            'replaced it!'\n-          )\n+        const hmrTestPagePath = join(\n+          __dirname,\n+          '../',\n+          'pages',\n+          'hmr',\n+          'hybrid.js'\n+        )\n \n-          // change the content\n-          writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n+        const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n+        const editedContent = originalContent.replace(\n+          `I'm a hybrid AMP page!`,\n+          'replaced it!'\n+        )\n \n-          await check(() => getBrowserBodyText(browser), /replaced it!/)\n+        // change the content\n+        writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n \n-          // add the original content\n-          writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n+        await check(() => getBrowserBodyText(browser), /replaced it!/)\n \n-          await check(() => getBrowserBodyText(browser), /I'm an AMP page!/)\n-        } finally {\n-          await browser.close()\n-        }\n-      })\n+        // add the original content\n+        writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n \n-      it('should detect amp validator warning on invalid amp', async () => {\n-        let inspectPayload = ''\n-        dynamicAppPort = await findPort()\n-        ampDynamic = await launchApp(join(__dirname, '../'), dynamicAppPort, {\n-          onStdout(msg) {\n-            inspectPayload += msg\n-          },\n-          onStderr(msg) {\n-            inspectPayload += msg\n-          },\n-        })\n+        await check(() => getBrowserBodyText(browser), /I'm a hybrid AMP page!/)\n+      } finally {\n+        await browser.close()\n+      }\n+    })\n \n-        await renderViaHTTP(dynamicAppPort, '/invalid-amp')\n+    it.skip('should detect changes and refresh an AMP page at root pages/', async () => {\n+      let browser\n+      try {\n+        browser = await webdriver(dynamicAppPort, '/root-hmr')\n+        const text = await browser.elementByCss('p').text()\n+        expect(text).toBe(`I'm an AMP page!`)\n \n-        await killApp(ampDynamic)\n+        const hmrTestPagePath = join(__dirname, '../', 'pages', 'root-hmr.js')\n \n-        expect(inspectPayload).toContain('error')\n-      })\n+        const originalContent = readFileSync(hmrTestPagePath, 'utf8')\n+        const editedContent = originalContent.replace(\n+          `I'm an AMP page!`,\n+          'replaced it!'\n+        )\n+\n+        // change the content\n+        writeFileSync(hmrTestPagePath, editedContent, 'utf8')\n \n-      it('should detect amp validator warning on custom scripts', async () => {\n-        let inspectPayload = ''\n-        dynamicAppPort = await findPort()\n-        ampDynamic = await launchApp(join(__dirname, '../'), dynamicAppPort, {\n-          onStdout(msg) {\n-            inspectPayload += msg\n-          },\n-          onStderr(msg) {\n-            inspectPayload += msg\n-          },\n-        })\n+        await check(() => getBrowserBodyText(browser), /replaced it!/)\n \n-        await renderViaHTTP(dynamicAppPort, '/custom-scripts')\n+        // add the original content\n+        writeFileSync(hmrTestPagePath, originalContent, 'utf8')\n \n-        await killApp(ampDynamic)\n+        await check(() => getBrowserBodyText(browser), /I'm an AMP page!/)\n+      } finally {\n+        await browser.close()\n+      }\n+    })\n \n-        expect(inspectPayload).toContain('error')\n+    it('should detect amp validator warning on invalid amp', async () => {\n+      let inspectPayload = ''\n+      dynamicAppPort = await findPort()\n+      ampDynamic = await launchApp(join(__dirname, '../'), dynamicAppPort, {\n+        onStdout(msg) {\n+          inspectPayload += msg\n+        },\n+        onStderr(msg) {\n+          inspectPayload += msg\n+        },\n       })\n \n-      // eslint-disable-next-line jest/no-identical-title\n-      it('should not contain missing files warning', async () => {\n-        expect(output).toContain('Compiled /only-amp')\n-        expect(output).not.toContain('Could not find files for')\n+      await renderViaHTTP(dynamicAppPort, '/invalid-amp')\n+\n+      await killApp(ampDynamic)\n+\n+      expect(inspectPayload).toContain('error')\n+    })\n+\n+    it('should detect amp validator warning on custom scripts', async () => {\n+      let inspectPayload = ''\n+      dynamicAppPort = await findPort()\n+      ampDynamic = await launchApp(join(__dirname, '../'), dynamicAppPort, {\n+        onStdout(msg) {\n+          inspectPayload += msg\n+        },\n+        onStderr(msg) {\n+          inspectPayload += msg\n+        },\n       })\n-    }\n-  )\n+\n+      await renderViaHTTP(dynamicAppPort, '/custom-scripts')\n+\n+      await killApp(ampDynamic)\n+\n+      expect(inspectPayload).toContain('error')\n+    })\n+\n+    // eslint-disable-next-line jest/no-identical-title\n+    it('should not contain missing files warning', async () => {\n+      expect(output).toContain('Compiled /only-amp')\n+      expect(output).not.toContain('Could not find files for')\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 718,
        "additions": 344,
        "deletions": 374
    }
}