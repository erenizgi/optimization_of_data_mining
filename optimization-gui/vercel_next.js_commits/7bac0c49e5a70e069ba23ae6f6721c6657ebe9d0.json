{
    "author": "eps1lon",
    "message": "[test] Use new Redbox matchers in app/ dynamic-error-trace (#76783)",
    "sha": "7bac0c49e5a70e069ba23ae6f6721c6657ebe9d0",
    "files": [
        {
            "sha": "8d40d89826a67a358962b233cd9e40878acabef6",
            "filename": "test/development/acceptance-app/dynamic-error.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 49,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/059c255c37f7ddd5b56af4a21150fc06ef2b63cd/test%2Fdevelopment%2Facceptance-app%2Fdynamic-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/059c255c37f7ddd5b56af4a21150fc06ef2b63cd/test%2Fdevelopment%2Facceptance-app%2Fdynamic-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fdynamic-error.test.ts?ref=059c255c37f7ddd5b56af4a21150fc06ef2b63cd",
            "patch": "@@ -1,49 +0,0 @@\n-/* eslint-env jest */\n-import { createSandbox } from 'development-sandbox'\n-import { FileRef, nextTestSetup } from 'e2e-utils'\n-import path from 'path'\n-import { outdent } from 'outdent'\n-\n-describe('dynamic = \"error\" in devmode', () => {\n-  const { next } = nextTestSetup({\n-    files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n-  })\n-\n-  it('should show error overlay when dynamic is forced', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/server/page.js',\n-          outdent`\n-          import { cookies } from 'next/headers';\n-\n-          export default async function Page() {\n-            await cookies()\n-            return null\n-          }\n-\n-          export const dynamic = \"error\"\n-        `,\n-        ],\n-      ]),\n-      '/server'\n-    )\n-    const { browser } = sandbox\n-\n-    await expect(browser).toDisplayRedbox(`\n-     {\n-       \"count\": 1,\n-       \"description\": \"Error: Route /server with \\`dynamic = \"error\"\\` couldn't be rendered statically because it used \\`cookies\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering\",\n-       \"environmentLabel\": \"Server\",\n-       \"label\": \"Unhandled Runtime Error\",\n-       \"source\": \"app/server/page.js (4:16) @ Page\n-     > 4 |   await cookies()\n-         |                ^\",\n-       \"stack\": [\n-         \"Page app/server/page.js (4:16)\",\n-       ],\n-     }\n-    `)\n-  })\n-})"
        },
        {
            "sha": "543504d52a8e8aece0c3e3558f895c8d5c9f7f4f",
            "filename": "test/development/app-dir/dynamic-error-trace/index.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 48,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/7bac0c49e5a70e069ba23ae6f6721c6657ebe9d0/test%2Fdevelopment%2Fapp-dir%2Fdynamic-error-trace%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7bac0c49e5a70e069ba23ae6f6721c6657ebe9d0/test%2Fdevelopment%2Fapp-dir%2Fdynamic-error-trace%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdynamic-error-trace%2Findex.test.ts?ref=7bac0c49e5a70e069ba23ae6f6721c6657ebe9d0",
            "patch": "@@ -1,14 +1,4 @@\n import { nextTestSetup } from 'e2e-utils'\n-import {\n-  assertHasRedbox,\n-  getRedboxSource,\n-  hasRedboxCallStack,\n-} from 'next-test-utils'\n-import { outdent } from 'outdent'\n-\n-function normalizeStackTrace(trace) {\n-  return trace.replace(/ \\(.*\\)/g, '')\n-}\n \n describe('app dir - dynamic error trace', () => {\n   const { next, skipped } = nextTestSetup({\n@@ -20,44 +10,20 @@ describe('app dir - dynamic error trace', () => {\n   it('should show the error trace', async () => {\n     const browser = await next.browser('/')\n \n-    await assertHasRedbox(browser)\n-\n-    await expect(\n-      browser.hasElementByCssSelector(\n-        '[data-nextjs-data-runtime-error-collapsed-action]'\n-      )\n-    ).resolves.toEqual(false)\n-\n-    await hasRedboxCallStack(browser)\n-    const stackFrameElements = await browser.elementsByCss(\n-      '[data-nextjs-call-stack-frame]'\n-    )\n-    const stackFramesContent = // TODO: Why is this text empty?\n-      (await Promise.all(stackFrameElements.map((f) => f.innerText())))\n-        // Filter out the frames having code snippet but without methodName and source\n-        .filter(Boolean)\n-        .join('\\n')\n-\n-    // TODO: Show useful stack\n-    const normalizedStack = normalizeStackTrace(stackFramesContent)\n-    expect(normalizedStack).toMatchInlineSnapshot(`\n-     \"Foo\n-     app/lib.js\"\n+    // TODO(veil): Where is the stackframe for app/page.js?\n+    await expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"Error: Route / with \\`dynamic = \"error\"\\` couldn't be rendered statically because it used \\`headers\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering\",\n+       \"environmentLabel\": \"Server\",\n+       \"label\": \"Unhandled Runtime Error\",\n+       \"source\": \"app/lib.js (4:13) @ Foo\n+     > 4 |   useHeaders()\n+         |             ^\",\n+       \"stack\": [\n+         \"Foo app/lib.js (4:13)\",\n+       ],\n+     }\n     `)\n-\n-    const codeframe = await getRedboxSource(browser)\n-    expect(codeframe).toEqual(\n-      outdent`\n-            app/lib.js (4:13) @ Foo\n-\n-              2 |\n-              3 | export function Foo() {\n-            > 4 |   useHeaders()\n-                |             ^\n-              5 |   return 'foo'\n-              6 | }\n-              7 |\n-          `\n-    )\n   })\n })"
        }
    ],
    "stats": {
        "total": 111,
        "additions": 14,
        "deletions": 97
    }
}