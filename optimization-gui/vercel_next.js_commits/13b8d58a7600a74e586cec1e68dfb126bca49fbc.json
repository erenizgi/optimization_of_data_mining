{
    "author": "huozhi",
    "message": "[metadata] only render one metadata outlet (#80146)",
    "sha": "13b8d58a7600a74e586cec1e68dfb126bca49fbc",
    "files": [
        {
            "sha": "1ee07993556e5b321d508e4529b16b75f667e12b",
            "filename": "packages/next/src/lib/metadata/metadata.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/13b8d58a7600a74e586cec1e68dfb126bca49fbc/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/13b8d58a7600a74e586cec1e68dfb126bca49fbc/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx?ref=13b8d58a7600a74e586cec1e68dfb126bca49fbc",
            "patch": "@@ -78,7 +78,7 @@ export function createMetadataComponents({\n   ViewportTree: React.ComponentType\n   getMetadataReady: () => Promise<void>\n   getViewportReady: () => Promise<void>\n-  StreamingMetadataOutlet: React.ComponentType\n+  StreamingMetadataOutlet: React.ComponentType | null\n } {\n   const searchParams = createServerSearchParamsForMetadata(\n     parsedQuery,\n@@ -243,13 +243,14 @@ export function createMetadataComponents({\n     return undefined\n   }\n \n-  function StreamingMetadataOutlet() {\n-    if (serveStreamingMetadata) {\n-      return <AsyncMetadataOutlet promise={resolveFinalMetadata()} />\n-    }\n-    return null\n+  function StreamingMetadataOutletImpl() {\n+    return <AsyncMetadataOutlet promise={resolveFinalMetadata()} />\n   }\n \n+  const StreamingMetadataOutlet = serveStreamingMetadata\n+    ? StreamingMetadataOutletImpl\n+    : null\n+\n   return {\n     ViewportTree,\n     MetadataTree,"
        },
        {
            "sha": "85fc79d669e30fed05d5ce82d8aa960108acb52e",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/13b8d58a7600a74e586cec1e68dfb126bca49fbc/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/13b8d58a7600a74e586cec1e68dfb126bca49fbc/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=13b8d58a7600a74e586cec1e68dfb126bca49fbc",
            "patch": "@@ -42,7 +42,7 @@ export function createComponentTree(props: {\n   missingSlots?: Set<string>\n   preloadCallbacks: PreloadCallbacks\n   authInterrupts: boolean\n-  StreamingMetadataOutlet: React.ComponentType\n+  StreamingMetadataOutlet: React.ComponentType | null\n }): Promise<CacheNodeSeedData> {\n   return getTracer().trace(\n     NextNodeServerSpan.createComponentTree,\n@@ -395,7 +395,9 @@ async function createComponentTreeInternal({\n   // Use the same condition to render metadataOutlet as metadata\n   const metadataOutlet = StreamingMetadataOutlet ? (\n     <StreamingMetadataOutlet />\n-  ) : undefined\n+  ) : (\n+    <MetadataOutlet ready={getMetadataReady} />\n+  )\n \n   const notFoundElement = NotFound ? (\n     <>\n@@ -716,9 +718,6 @@ async function createComponentTreeInternal({\n         {layerAssets}\n         <OutletBoundary>\n           <MetadataOutlet ready={getViewportReady} />\n-          {/* Blocking metadata outlet */}\n-          <MetadataOutlet ready={getMetadataReady} />\n-          {/* Streaming metadata outlet */}\n           {metadataOutlet}\n         </OutletBoundary>\n       </React.Fragment>,"
        },
        {
            "sha": "60127bc49ce9ebc56c7e19a3e1e9935a96d0b192",
            "filename": "packages/next/src/server/app-render/walk-tree-with-flight-router-state.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/13b8d58a7600a74e586cec1e68dfb126bca49fbc/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/13b8d58a7600a74e586cec1e68dfb126bca49fbc/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx?ref=13b8d58a7600a74e586cec1e68dfb126bca49fbc",
            "patch": "@@ -56,7 +56,7 @@ export async function walkTreeWithFlightRouterState({\n   getViewportReady: () => Promise<void>\n   ctx: AppRenderContext\n   preloadCallbacks: PreloadCallbacks\n-  StreamingMetadataOutlet: React.ComponentType\n+  StreamingMetadataOutlet: React.ComponentType | null\n }): Promise<FlightDataPath[]> {\n   const {\n     renderOpts: { nextFontManifest, experimental },"
        },
        {
            "sha": "03d635ad976e1fa8e861998e824edaa0313f0ec7",
            "filename": "test/e2e/app-dir/metadata-streaming-parallel-routes/metadata-streaming-parallel-routes.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/13b8d58a7600a74e586cec1e68dfb126bca49fbc/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/13b8d58a7600a74e586cec1e68dfb126bca49fbc/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-parallel-routes%2Fmetadata-streaming-parallel-routes.test.ts?ref=13b8d58a7600a74e586cec1e68dfb126bca49fbc",
            "patch": "@@ -9,13 +9,12 @@ describe('app-dir - metadata-streaming', () => {\n   it('should only insert metadata once for parallel routes when slots match', async () => {\n     const browser = await next.browser('/parallel-routes')\n \n-    expect((await browser.elementsByCss('head title')).length).toBe(1)\n-    expect((await browser.elementsByCss('body title')).length).toBe(0)\n+    expect((await browser.elementsByCss('title')).length).toBe(1)\n     expect(await browser.elementByCss('title').text()).toBe('parallel title')\n \n     const $ = await next.render$('/parallel-routes')\n     expect($('title').length).toBe(1)\n-    // We can't ensure if it's inserted into  head or body since it's a race condition,\n+    // We can't ensure if it's inserted into head or body since it's a race condition,\n     // where sometimes the metadata can be suspended.\n     expect($('title').text()).toBe('parallel title')\n \n@@ -51,7 +50,7 @@ describe('app-dir - metadata-streaming', () => {\n     const browser = await next.browser('/parallel-routes-default')\n \n     expect((await browser.elementsByCss('title')).length).toBe(1)\n-    expect(await browser.elementByCss('body title').text()).toBe(\n+    expect(await browser.elementByCss('title').text()).toBe(\n       'parallel-routes-default layout title'\n     )\n "
        }
    ],
    "stats": {
        "total": 31,
        "additions": 15,
        "deletions": 16
    }
}