{
    "author": "mischnic",
    "message": "Enable more tests for Turbopack, II (#83600)",
    "sha": "de4f2f03bb5dd22898fa3443491fd5ee5737073d",
    "files": [
        {
            "sha": "7df183c4ff12a8555d427490f48600a2513b98ce",
            "filename": "test/development/basic/barrel-optimization/barrel-optimization-mui.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fdevelopment%2Fbasic%2Fbarrel-optimization%2Fbarrel-optimization-mui.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fdevelopment%2Fbasic%2Fbarrel-optimization%2Fbarrel-optimization-mui.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fbarrel-optimization%2Fbarrel-optimization-mui.test.ts?ref=de4f2f03bb5dd22898fa3443491fd5ee5737073d",
            "patch": "@@ -2,7 +2,7 @@ import { join } from 'path'\n import { nextTestSetup } from 'e2e-utils'\n import { assertNoRedbox } from 'next-test-utils'\n \n-// Skipped in Turbopack, will be added later.\n+// This is implemented in Turbopack, but Turbopack doesn't log the module count.\n ;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n   'Skipped in Turbopack',\n   () => {"
        },
        {
            "sha": "7a40d7dd13ca1618825aee04cfb73f269073f29f",
            "filename": "test/development/basic/barrel-optimization/barrel-optimization.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fdevelopment%2Fbasic%2Fbarrel-optimization%2Fbarrel-optimization.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fdevelopment%2Fbasic%2Fbarrel-optimization%2Fbarrel-optimization.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fbarrel-optimization%2Fbarrel-optimization.test.ts?ref=de4f2f03bb5dd22898fa3443491fd5ee5737073d",
            "patch": "@@ -1,6 +1,7 @@\n import { join } from 'path'\n import { nextTestSetup } from 'e2e-utils'\n-// Skipped in Turbopack, will be added later.\n+\n+// This is implemented in Turbopack, but Turbopack doesn't log the module count.\n ;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n   'Skipped in Turbopack',\n   () => {"
        },
        {
            "sha": "ce3c3b3467982494cd9250c5af41b9445455fc30",
            "filename": "test/development/basic/styled-components-disabled.test.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 45,
            "changes": 85,
            "blob_url": "https://github.com/vercel/next.js/blob/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fdevelopment%2Fbasic%2Fstyled-components-disabled.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fdevelopment%2Fbasic%2Fstyled-components-disabled.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fstyled-components-disabled.test.ts?ref=de4f2f03bb5dd22898fa3443491fd5ee5737073d",
            "patch": "@@ -6,53 +6,48 @@ import { retry } from 'next-test-utils'\n \n // TODO: Somehow the warning doesn't show up with Turbopack, even though the transform is not enabled.\n // TODO: It no longer shows up with Webpack either in tests.\n-;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe.skip)(\n-  'styled-components SWC transform',\n-  () => {\n-    let next: NextInstance\n+describe.skip('styled-components SWC transform', () => {\n+  let next: NextInstance\n \n-    beforeAll(async () => {\n-      next = await createNext({\n-        files: {\n-          'next.config.js': new FileRef(\n-            join(__dirname, 'styled-components-disabled/next.config.js')\n-          ),\n-          pages: new FileRef(\n-            join(__dirname, 'styled-components-disabled/pages')\n-          ),\n-        },\n-        dependencies: {\n-          'styled-components': '6.1.16',\n-        },\n-      })\n+  beforeAll(async () => {\n+    next = await createNext({\n+      files: {\n+        'next.config.js': new FileRef(\n+          join(__dirname, 'styled-components-disabled/next.config.js')\n+        ),\n+        pages: new FileRef(join(__dirname, 'styled-components-disabled/pages')),\n+      },\n+      dependencies: {\n+        'styled-components': '6.1.16',\n+      },\n     })\n-    afterAll(() => next.destroy())\n+  })\n+  afterAll(() => next.destroy())\n \n-    it('should have hydration mismatch with styled-components transform disabled', async () => {\n-      let browser\n-      try {\n-        // Compile /_error\n-        browser = await webdriver(next.url, '/404')\n-        await browser.loadPage(new URL('/', next.url).toString())\n+  it('should have hydration mismatch with styled-components transform disabled', async () => {\n+    let browser\n+    try {\n+      // Compile /_error\n+      browser = await webdriver(next.url, '/404')\n+      await browser.loadPage(new URL('/', next.url).toString())\n \n-        await retry(async () => {\n-          const logs = await browser.log()\n-          expect(logs).toEqual(\n-            expect.arrayContaining([\n-              {\n-                message: expect.stringContaining(\n-                  'https://react.dev/link/hydration-mismatch'\n-                ),\n-                source: 'error',\n-              },\n-            ])\n-          )\n-        })\n-      } finally {\n-        if (browser) {\n-          await browser.close()\n-        }\n+      await retry(async () => {\n+        const logs = await browser.log()\n+        expect(logs).toEqual(\n+          expect.arrayContaining([\n+            {\n+              message: expect.stringContaining(\n+                'https://react.dev/link/hydration-mismatch'\n+              ),\n+              source: 'error',\n+            },\n+          ])\n+        )\n+      })\n+    } finally {\n+      if (browser) {\n+        await browser.close()\n       }\n-    })\n-  }\n-)\n+    }\n+  })\n+})"
        },
        {
            "sha": "7f02f1428a4bc8bc4cdadacdce81ea79ffbbf254",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 24,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=de4f2f03bb5dd22898fa3443491fd5ee5737073d",
            "patch": "@@ -55,34 +55,30 @@ describe('use-cache', () => {\n     expect(await browser.waitForElementByCss('#r').text()).toContain('rnd')\n   })\n \n-  if (!process.env.TURBOPACK_BUILD) {\n-    it('should cache results custom handler', async () => {\n-      const browser = await next.browser(`/custom-handler?n=1`)\n-      expect(await browser.waitForElementByCss('#x').text()).toBe('1')\n-      const random1a = await browser.waitForElementByCss('#y').text()\n-\n-      await browser.loadPage(\n-        new URL(`/custom-handler?n=2`, next.url).toString()\n-      )\n-      expect(await browser.waitForElementByCss('#x').text()).toBe('2')\n-      const random2 = await browser.waitForElementByCss('#y').text()\n+  it('should cache results custom handler', async () => {\n+    const browser = await next.browser(`/custom-handler?n=1`)\n+    expect(await browser.waitForElementByCss('#x').text()).toBe('1')\n+    const random1a = await browser.waitForElementByCss('#y').text()\n \n-      await browser.loadPage(\n-        new URL(`/custom-handler?n=1&unrelated`, next.url).toString()\n-      )\n-      expect(await browser.waitForElementByCss('#x').text()).toBe('1')\n-      const random1b = await browser.waitForElementByCss('#y').text()\n+    await browser.loadPage(new URL(`/custom-handler?n=2`, next.url).toString())\n+    expect(await browser.waitForElementByCss('#x').text()).toBe('2')\n+    const random2 = await browser.waitForElementByCss('#y').text()\n \n-      // The two navigations to n=1 should use a cached value.\n-      expect(random1a).toBe(random1b)\n+    await browser.loadPage(\n+      new URL(`/custom-handler?n=1&unrelated`, next.url).toString()\n+    )\n+    expect(await browser.waitForElementByCss('#x').text()).toBe('1')\n+    const random1b = await browser.waitForElementByCss('#y').text()\n \n-      // The navigation to n=2 should be some other random value.\n-      expect(random1a).not.toBe(random2)\n+    // The two navigations to n=1 should use a cached value.\n+    expect(random1a).toBe(random1b)\n \n-      // Client component child should have rendered but not invalidated the cache.\n-      expect(await browser.waitForElementByCss('#r').text()).toContain('rnd')\n-    })\n-  }\n+    // The navigation to n=2 should be some other random value.\n+    expect(random1a).not.toBe(random2)\n+\n+    // Client component child should have rendered but not invalidated the cache.\n+    expect(await browser.waitForElementByCss('#r').text()).toContain('rnd')\n+  })\n \n   it('should cache complex args', async () => {\n     // Use two bytes that can't be encoded as UTF-8 to ensure serialization works."
        },
        {
            "sha": "3a483a7ee67c8dcf8a7b8ebb1ad780eb218f73e5",
            "filename": "test/e2e/socket-io/app/page.js",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fe2e%2Fsocket-io%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fe2e%2Fsocket-io%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fsocket-io%2Fapp%2Fpage.js?ref=de4f2f03bb5dd22898fa3443491fd5ee5737073d",
            "patch": "@@ -6,6 +6,7 @@ import io from 'socket.io-client'\n let socket\n \n export default function Home() {\n+  const [connected, setConnected] = useState(false)\n   const [value, setValue] = useState('')\n \n   const socketInitializer = async () => {\n@@ -26,16 +27,26 @@ export default function Home() {\n   }\n \n   const sendMessageHandler = async (e) => {\n-    if (!socket) return\n+    if (!socket) {\n+      console.error('No socket connection yet for message')\n+      return\n+    }\n     const value = e.target.value\n \n     setValue(value)\n     socket.emit('createdMessage', value)\n   }\n \n   useEffect(() => {\n-    socketInitializer()\n+    socketInitializer().then(() => {\n+      setConnected(true)\n+    })\n   }, [])\n \n-  return <input value={value} onChange={sendMessageHandler} />\n+  return (\n+    <>\n+      <span id=\"status\">{connected ? 'Connected' : 'Disconnected'}</span>\n+      <input value={value} onChange={sendMessageHandler} />\n+    </>\n+  )\n }"
        },
        {
            "sha": "28f8ca2464f78f0f0c5d213b7ead5bf111cc8514",
            "filename": "test/e2e/socket-io/index.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fe2e%2Fsocket-io%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fe2e%2Fsocket-io%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fsocket-io%2Findex.test.ts?ref=de4f2f03bb5dd22898fa3443491fd5ee5737073d",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { check } from 'next-test-utils'\n+import { retry } from 'next-test-utils'\n \n describe('socket-io', () => {\n   const { next } = nextTestSetup({\n@@ -27,17 +27,32 @@ describe('socket-io', () => {\n       },\n     })\n \n+    await Promise.all([\n+      retry(async () =>\n+        expect(await browser1.elementByCss('#status').text()).toBe('Connected')\n+      ),\n+      retry(async () =>\n+        expect(await browser2.elementByCss('#status').text()).toBe('Connected')\n+      ),\n+    ])\n+\n     const input1 = await browser1.elementByCss('input')\n     const input2 = await browser2.elementByCss('input')\n \n     await input1.fill('hello world')\n-    await check(() => input2.inputValue(), /hello world/)\n+    await retry(\n+      async () => expect(await input2.inputValue()).toContain('hello world'),\n+      10000\n+    )\n \n     expect(requestsCount).toBeGreaterThan(0)\n     const currentRequestsCount = requestsCount\n \n     await input1.fill('123456')\n-    await check(() => input2.inputValue(), /123456/)\n+    await retry(\n+      async () => expect(await input2.inputValue()).toContain('123456'),\n+      10000\n+    )\n \n     // There should be no new requests (polling) and using the existing WS connection\n     expect(requestsCount).toBe(currentRequestsCount)"
        },
        {
            "sha": "70e19775aa866f16717be5451925d089d6d6dea8",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files-node-middleware.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-node-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-node-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files-node-middleware.test.ts?ref=de4f2f03bb5dd22898fa3443491fd5ee5737073d",
            "patch": "@@ -1,7 +1,3 @@\n process.env.TEST_NODE_MIDDLEWARE = '1'\n \n-if (process.env.IS_TURBOPACK_TEST) {\n-  it('should skip for now', () => {})\n-} else {\n-  require('./required-server-files.test')\n-}\n+require('./required-server-files.test')"
        },
        {
            "sha": "0e15087eb7e7585d7d82e6341c0c12bec71bc87a",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files.test.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 17,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/de4f2f03bb5dd22898fa3443491fd5ee5737073d/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts?ref=de4f2f03bb5dd22898fa3443491fd5ee5737073d",
            "patch": "@@ -377,29 +377,35 @@ describe('required server files', () => {\n     ).toContain('\"cacheMaxMemorySize\":0')\n   })\n \n-  // TODO(mischnic) do these files even exist in turbopack?\n-  ;(process.env.IS_TURBOPACK_TEST ? it.skip : it)(\n-    'should output middleware correctly',\n-    async () => {\n-      if (!process.env.TEST_NODE_MIDDLEWARE) {\n-        // eslint-disable-next-line jest/no-standalone-expect\n-        expect(\n-          await fs.pathExists(\n-            join(\n-              next.testDir,\n-              'standalone/.next/server/edge-runtime-webpack.js'\n-            )\n-          )\n-        ).toBe(true)\n-      }\n-      // eslint-disable-next-line jest/no-standalone-expect\n+  it('should output middleware correctly', async () => {\n+    if (process.env.TEST_NODE_MIDDLEWARE) {\n       expect(\n         await fs.pathExists(\n           join(next.testDir, 'standalone/.next/server/middleware.js')\n         )\n       ).toBe(true)\n+    } else {\n+      let manifest = await fs.readJSON(\n+        join(next.testDir, 'standalone/.next/server/middleware-manifest.json')\n+      )\n+      let middleware = manifest.middleware['/']\n+      let files = [\n+        ...middleware.files,\n+        ...middleware.wasm.map((f) => f.filePath),\n+        ...middleware.assets.map((f) => f.filePath),\n+      ]\n+      console.log(files)\n+      for (const file of files) {\n+        try {\n+          expect(\n+            await fs.pathExists(join(next.testDir, 'standalone/.next', file))\n+          ).toBe(true)\n+        } catch (err) {\n+          throw new Error('Missing file ' + file)\n+        }\n+      }\n     }\n-  )\n+  })\n \n   it('should output required-server-files manifest correctly', async () => {\n     expect(requiredFilesManifest.version).toBe(1)"
        }
    ],
    "stats": {
        "total": 218,
        "additions": 119,
        "deletions": 99
    }
}