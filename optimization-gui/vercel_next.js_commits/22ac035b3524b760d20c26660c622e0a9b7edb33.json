{
    "author": "lukesandberg",
    "message": "Normalize filepaths when parsing patterns from js values (#80511)\n\n## Normalize Windows file paths in pattern construction\n\nWhen interpreting js_values as `Pattern` objects for interpretation, normalize windows file endings away.\n\nAlso enable debug_assertions in unit tests.\n\n### Why?\nEnabling debug assertions on CI will prevent us from making mistakes\n\n### Alternates?\n\nHonestly, i am kind of confused about where to put this logic\nhttps://vercel.slack.com/archives/C03EWR7LGEN/p1749854016509599?thread_ts=1749833045.978729&cid=C03EWR7LGEN\n\n`Pattern::normalize` and `Pattern::with_normalized_path` are both reasonable alternatives.  However, the fact that `normalize` doesn't call `with_normalized_path` was a bit concerning, as was the complex nature of the Pattern type.\n\nFixes PACK-3279\nPart of PACK-4578",
    "sha": "22ac035b3524b760d20c26660c622e0a9b7edb33",
    "files": [
        {
            "sha": "4d3e5c2d92e61698540371bf944d713faf1a896b",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/22ac035b3524b760d20c26660c622e0a9b7edb33/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/22ac035b3524b760d20c26660c622e0a9b7edb33/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=22ac035b3524b760d20c26660c622e0a9b7edb33",
            "patch": "@@ -241,6 +241,12 @@ opt-level = 3\n [profile.release.package.serde]\n opt-level = 3\n \n+# Use a custom profile for CI where many tests are performance sensitive but we still want the additional validation of debug-assertions\n+[profile.release-with-assertions]\n+inherits = \"release\"\n+debug-assertions = true\n+overflow-checks = true\n+\n [workspace.dependencies]\n # Workspace crates\n next-api = { path = \"crates/next-api\" }"
        },
        {
            "sha": "c39e3a35bc1e731fa83e65420b392a5a5fb2e6b0",
            "filename": "packages/next-swc/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/22ac035b3524b760d20c26660c622e0a9b7edb33/packages%2Fnext-swc%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/22ac035b3524b760d20c26660c622e0a9b7edb33/packages%2Fnext-swc%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-swc%2Fpackage.json?ref=22ac035b3524b760d20c26660c622e0a9b7edb33",
            "patch": "@@ -17,7 +17,7 @@\n     \"rust-check-fmt\": \"cd ../..; cargo fmt -- --check\",\n     \"rust-check-clippy\": \"cargo clippy --workspace --all-targets -- -D warnings -A deprecated\",\n     \"rust-check-napi\": \"cargo check -p next-swc-napi\",\n-    \"test-cargo-unit\": \"cargo nextest run --workspace --exclude next-swc-napi --exclude turbo-tasks-macros --release --no-fail-fast\"\n+    \"test-cargo-unit\": \"cargo nextest run --workspace --exclude next-swc-napi --exclude turbo-tasks-macros --cargo-profile release-with-assertions --no-fail-fast\"\n   },\n   \"napi\": {\n     \"name\": \"next-swc\","
        },
        {
            "sha": "0e19035d43113beac44c67583a64b38afcba1ca8",
            "filename": "turbopack/crates/turbopack-core/src/resolve/pattern.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 10,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/22ac035b3524b760d20c26660c622e0a9b7edb33/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22ac035b3524b760d20c26660c622e0a9b7edb33/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs?ref=22ac035b3524b760d20c26660c622e0a9b7edb33",
            "patch": "@@ -532,17 +532,9 @@ impl Pattern {\n     /// Order into Alternatives -> Concatenation -> Constant/Dynamic\n     /// Merge when possible\n     pub fn normalize(&mut self) {\n-        let mut alternatives = [Vec::new()];\n         match self {\n-            Pattern::Constant(c) => {\n-                for alt in alternatives.iter_mut() {\n-                    alt.push(Pattern::Constant(c.clone()));\n-                }\n-            }\n-            Pattern::Dynamic => {\n-                for alt in alternatives.iter_mut() {\n-                    alt.push(Pattern::Dynamic);\n-                }\n+            Pattern::Dynamic | Pattern::Constant(_) => {\n+                // already normalized\n             }\n             Pattern::Alternatives(list) => {\n                 for alt in list.iter_mut() {\n@@ -630,6 +622,7 @@ impl Pattern {\n                             })\n                             .collect(),\n                     );\n+                    // The recursive call will deduplicate the alternatives after simplifying them\n                     self.normalize();\n                 } else {\n                     let mut new_parts = Vec::new();"
        },
        {
            "sha": "c173741e3b0d1ff5d93db20da130a2d44360d908",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/mod.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/22ac035b3524b760d20c26660c622e0a9b7edb33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22ac035b3524b760d20c26660c622e0a9b7edb33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fmod.rs?ref=22ac035b3524b760d20c26660c622e0a9b7edb33",
            "patch": "@@ -111,6 +111,13 @@ impl ConstantString {\n         }\n     }\n \n+    pub fn as_rcstr(&self) -> RcStr {\n+        match self {\n+            Self::Atom(s) => RcStr::from(s.as_str()),\n+            Self::RcStr(s) => s.clone(),\n+        }\n+    }\n+\n     pub fn as_atom(&self) -> Cow<Atom> {\n         match self {\n             Self::Atom(s) => Cow::Borrowed(s),"
        },
        {
            "sha": "98156e26c29c42ebda64b16762a5027706285dfa",
            "filename": "turbopack/crates/turbopack-ecmascript/src/utils.rs",
            "status": "modified",
            "additions": 56,
            "deletions": 12,
            "changes": 68,
            "blob_url": "https://github.com/vercel/next.js/blob/22ac035b3524b760d20c26660c622e0a9b7edb33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22ac035b3524b760d20c26660c622e0a9b7edb33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Futils.rs?ref=22ac035b3524b760d20c26660c622e0a9b7edb33",
            "patch": "@@ -6,6 +6,7 @@ use swc_core::{\n         visit::AstParentKind,\n     },\n };\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{NonLocalValue, trace::TraceRawVcs};\n use turbopack_core::{chunk::ModuleId, resolve::pattern::Pattern};\n \n@@ -24,36 +25,50 @@ pub fn unparen(expr: &Expr) -> &Expr {\n     expr\n }\n \n+/// Converts a js-value into a Pattern for matching resources.\n pub fn js_value_to_pattern(value: &JsValue) -> Pattern {\n-    let mut result = match value {\n+    match value {\n         JsValue::Constant(v) => Pattern::Constant(match v {\n-            ConstantValue::Str(str) => str.as_str().into(),\n-            ConstantValue::True => \"true\".into(),\n-            ConstantValue::False => \"false\".into(),\n-            ConstantValue::Null => \"null\".into(),\n+            ConstantValue::Str(str) => {\n+                // Normalize windows file paths when constructing the pattern.\n+                // See PACK-3279\n+                if str.as_str().contains(\"\\\\\") {\n+                    RcStr::from(str.to_string().replace('\\\\', \"/\"))\n+                } else {\n+                    str.as_rcstr()\n+                }\n+            }\n+            ConstantValue::True => rcstr!(\"true\"),\n+            ConstantValue::False => rcstr!(\"false\"),\n+            ConstantValue::Null => rcstr!(\"null\"),\n             ConstantValue::Num(ConstantNumber(n)) => n.to_string().into(),\n             ConstantValue::BigInt(n) => n.to_string().into(),\n             ConstantValue::Regex(box (exp, flags)) => format!(\"/{exp}/{flags}\").into(),\n-            ConstantValue::Undefined => \"undefined\".into(),\n+            ConstantValue::Undefined => rcstr!(\"undefined\"),\n         }),\n-        JsValue::Url(v, JsValueUrlKind::Relative) => Pattern::Constant(v.as_str().into()),\n+        JsValue::Url(v, JsValueUrlKind::Relative) => Pattern::Constant(v.as_rcstr()),\n         JsValue::Alternatives {\n             total_nodes: _,\n             values,\n             logical_property: _,\n-        } => Pattern::Alternatives(values.iter().map(js_value_to_pattern).collect()),\n+        } => {\n+            let mut alts = Pattern::Alternatives(values.iter().map(js_value_to_pattern).collect());\n+            alts.normalize();\n+            alts\n+        }\n         JsValue::Concat(_, parts) => {\n-            Pattern::Concatenation(parts.iter().map(js_value_to_pattern).collect())\n+            let mut concats =\n+                Pattern::Concatenation(parts.iter().map(js_value_to_pattern).collect());\n+            concats.normalize();\n+            concats\n         }\n         JsValue::Add(..) => {\n             // TODO do we need to handle that here\n             // or is that already covered by normalization of JsValue\n             Pattern::Dynamic\n         }\n         _ => Pattern::Dynamic,\n-    };\n-    result.normalize();\n-    result\n+    }\n }\n \n const JS_MAX_SAFE_INTEGER: u64 = (1u64 << 53) - 1;\n@@ -200,3 +215,32 @@ pub fn module_value_to_well_known_object(module_value: &ModuleValue) -> Option<J\n         _ => return None,\n     })\n }\n+\n+#[cfg(test)]\n+mod tests {\n+    use turbo_rcstr::rcstr;\n+    use turbopack_core::resolve::pattern::Pattern;\n+\n+    use crate::{\n+        analyzer::{ConstantString, ConstantValue, JsValue},\n+        utils::js_value_to_pattern,\n+    };\n+\n+    #[test]\n+    fn test_path_normalization_in_pattern() {\n+        assert_eq!(\n+            Pattern::Constant(rcstr!(\"hello/world\")),\n+            js_value_to_pattern(&JsValue::Constant(ConstantValue::Str(\n+                ConstantString::RcStr(rcstr!(\"hello\\\\world\"))\n+            )))\n+        );\n+\n+        assert_eq!(\n+            Pattern::Constant(rcstr!(\"hello/world\")),\n+            js_value_to_pattern(&JsValue::Concat(\n+                1,\n+                vec![\"hello\".into(), \"\\\\\".into(), \"world\".into()]\n+            ))\n+        );\n+    }\n+}"
        },
        {
            "sha": "b7ddb8b3ba82a38999850f070642bed1bcd4b40d",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/22ac035b3524b760d20c26660c622e0a9b7edb33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22ac035b3524b760d20c26660c622e0a9b7edb33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=22ac035b3524b760d20c26660c622e0a9b7edb33",
            "patch": "@@ -12,8 +12,7 @@ use serde::Deserialize;\n use serde_json::json;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{\n-    ReadConsistency, ReadRef, ResolvedVc, TryJoinIterExt, TurboTasks, ValueToString, Vc,\n-    apply_effects,\n+    ReadConsistency, ReadRef, ResolvedVc, TurboTasks, ValueToString, Vc, apply_effects,\n };\n use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n use turbo_tasks_env::DotenvProcessEnv;\n@@ -495,11 +494,7 @@ async fn walk_asset(\n             .await?\n             .iter()\n             .copied()\n-            .map(|asset| async move { Ok(ResolvedVc::try_downcast::<Box<dyn OutputAsset>>(asset)) })\n-            .try_join()\n-            .await?\n-            .into_iter()\n-            .flatten(),\n+            .flat_map(ResolvedVc::try_downcast::<Box<dyn OutputAsset>>),\n     );\n \n     Ok(())"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 75,
        "deletions": 30
    }
}