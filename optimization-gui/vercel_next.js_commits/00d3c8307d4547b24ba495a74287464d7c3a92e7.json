{
    "author": "conico974",
    "message": "Revalidate `\"use cache\"` caches during on-demand revalidation (#76100)\n\n### What?\nWhen doing an On Demand revalidation (with `res.revalidate` or using\n`x-prerender-revalidate` header ), `use cache` entry will never get\nrevalidated\n\n### Why?\nIt should behave the same as the fetch cache or `unstable_cache`\n\n### How?\n\nWe force revalidation of `use cache` entry when doing an on demand\nrevalidation\n\n---------\n\nCo-authored-by: Hendrik Liebau <mail@hendrik-liebau.de>",
    "sha": "00d3c8307d4547b24ba495a74287464d7c3a92e7",
    "files": [
        {
            "sha": "02f1d4d3e38f514f3c447c05735146f408f9837f",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/00d3c8307d4547b24ba495a74287464d7c3a92e7/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00d3c8307d4547b24ba495a74287464d7c3a92e7/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=00d3c8307d4547b24ba495a74287464d7c3a92e7",
            "patch": "@@ -910,6 +910,10 @@ function shouldForceRevalidate(\n   workStore: WorkStore,\n   workUnitStore: WorkUnitStore | undefined\n ): boolean {\n+  if (workStore.isOnDemandRevalidate) {\n+    return true\n+  }\n+\n   if (workStore.dev && workUnitStore) {\n     if (workUnitStore.type === 'request') {\n       return workUnitStore.headers.get('cache-control') === 'no-cache'"
        },
        {
            "sha": "f4c4b6107e592cf9c9ab894ea895cf9df30c14b5",
            "filename": "test/e2e/app-dir/use-cache/app/on-demand-revalidate/page.tsx",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/00d3c8307d4547b24ba495a74287464d7c3a92e7/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/00d3c8307d4547b24ba495a74287464d7c3a92e7/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Fpage.tsx?ref=00d3c8307d4547b24ba495a74287464d7c3a92e7",
            "patch": "@@ -0,0 +1,22 @@\n+import { revalidatePath } from 'next/cache'\n+import { RevalidateButtons } from './revalidate-buttons'\n+\n+async function cachedValue() {\n+  'use cache'\n+  return Math.random()\n+}\n+\n+export default async function Page() {\n+  const value = await cachedValue()\n+  return (\n+    <div>\n+      <p id=\"value\">{value}</p>\n+      <RevalidateButtons\n+        revalidatePath={async () => {\n+          'use server'\n+          revalidatePath('/on-demand-revalidate')\n+        }}\n+      />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "3ce55077d4d96d348db0ed6f011e6a9bbb18a457",
            "filename": "test/e2e/app-dir/use-cache/app/on-demand-revalidate/revalidate-buttons.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/00d3c8307d4547b24ba495a74287464d7c3a92e7/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Frevalidate-buttons.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/00d3c8307d4547b24ba495a74287464d7c3a92e7/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Frevalidate-buttons.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fon-demand-revalidate%2Frevalidate-buttons.tsx?ref=00d3c8307d4547b24ba495a74287464d7c3a92e7",
            "patch": "@@ -0,0 +1,25 @@\n+'use client'\n+\n+export function RevalidateButtons({\n+  revalidatePath,\n+}: {\n+  revalidatePath: () => Promise<void>\n+}) {\n+  return (\n+    <form>\n+      <button id=\"revalidate-path\" formAction={revalidatePath}>\n+        revalidate with revalidatePath()\n+      </button>{' '}\n+      <button\n+        id=\"revalidate-api-route\"\n+        formAction={async () => {\n+          await fetch('/api/revalidate?path=/on-demand-revalidate', {\n+            method: 'POST',\n+          })\n+        }}\n+      >\n+        revalidate with API route\n+      </button>\n+    </form>\n+  )\n+}"
        },
        {
            "sha": "dd8e6f4e08f7d280afd0121d5645b4c497930218",
            "filename": "test/e2e/app-dir/use-cache/pages/api/revalidate.ts",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/00d3c8307d4547b24ba495a74287464d7c3a92e7/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fpages%2Fapi%2Frevalidate.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00d3c8307d4547b24ba495a74287464d7c3a92e7/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fpages%2Fapi%2Frevalidate.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fpages%2Fapi%2Frevalidate.ts?ref=00d3c8307d4547b24ba495a74287464d7c3a92e7",
            "patch": "@@ -0,0 +1,22 @@\n+import type { NextApiRequest, NextApiResponse } from 'next'\n+\n+export default async function handler(\n+  req: NextApiRequest,\n+  res: NextApiResponse\n+) {\n+  const pathParam = req.query['path']\n+\n+  if (!pathParam) {\n+    return res.status(400).send(`Missing required query param \"path\"`)\n+  }\n+\n+  const paths = Array.isArray(pathParam) ? pathParam : [pathParam]\n+\n+  try {\n+    await Promise.all(paths.map((path) => res.revalidate(path)))\n+    return res.json({ revalidated: true })\n+  } catch (err) {\n+    console.error(err)\n+    return res.status(500).send(`Error revalidating ${paths}`)\n+  }\n+}"
        },
        {
            "sha": "8f9f653b6dbeb4b0c2033746ab79de508c42c9de",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/00d3c8307d4547b24ba495a74287464d7c3a92e7/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/00d3c8307d4547b24ba495a74287464d7c3a92e7/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=00d3c8307d4547b24ba495a74287464d7c3a92e7",
            "patch": "@@ -304,6 +304,30 @@ describe('use-cache', () => {\n   }\n \n   if (isNextStart) {\n+    // res.revalidate does not work in dev mode\n+    it('should revalidate caches during on-demand revalidation', async () => {\n+      const browser = await next.browser('/on-demand-revalidate')\n+      const initial = await browser.elementById('value').text()\n+\n+      // Bust the ISR cache first to populate the \"use cache\" in-memory cache for\n+      // the subsequent on-demand revalidation.\n+      await browser.elementById('revalidate-path').click()\n+\n+      await retry(async () => {\n+        expect(await browser.elementById('value').text()).not.toBe(initial)\n+      })\n+\n+      const value = await browser.elementById('value').text()\n+\n+      await browser.elementById('revalidate-api-route').click()\n+      await browser.waitForIdleNetwork()\n+\n+      await retry(async () => {\n+        await browser.refresh()\n+        expect(await browser.elementById('value').text()).not.toBe(value)\n+      })\n+    })\n+\n     it('should prerender fully cacheable pages as static HTML', async () => {\n       const prerenderManifest = JSON.parse(\n         await next.readFile('.next/prerender-manifest.json')\n@@ -336,6 +360,7 @@ describe('use-cache', () => {\n         '/logs',\n         '/method-props',\n         '/not-found',\n+        '/on-demand-revalidate',\n         '/passed-to-client',\n         '/react-cache',\n         '/referential-equality',"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 98,
        "deletions": 0
    }
}