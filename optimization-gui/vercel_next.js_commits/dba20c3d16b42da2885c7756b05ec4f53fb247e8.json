{
    "author": "wbinnssmith",
    "message": "Turbopack: Add react refresh runtime stubs to workers (#78433)\n\nAnalogous to https://github.com/vercel/next.js/pull/15145, this adds\nno-op stubs to take the place of the react refresh runtime in workers.\n\nThis prevents workers from failing when they use react components, such\nas in non-dom react renderers like\n[`@react-three/offscreen`](https://github.com/pmndrs/react-three-offscreen).\n\nThis code is only added in dev, and the base runtime was parameterized\nto allow this.\n\nTest Plan:\n- Manually create a worker that uses `@react-three/offscreen` to render\na component and use it in dev.\n- [x] Automated test",
    "sha": "dba20c3d16b42da2885c7756b05ec4f53fb247e8",
    "files": [
        {
            "sha": "3f8e9a50add385b564a52c4e7899471cd7573830",
            "filename": "test/e2e/worker-react-refresh/app/client.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fclient.tsx?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -0,0 +1,11 @@\n+'use client'\n+\n+import { useEffect } from 'react'\n+\n+export default function ClientComponent() {\n+  useEffect(() => {\n+    new Worker(new URL('./worker.tsx', import.meta.url))\n+  }, [])\n+\n+  return <p>This is a client component</p>\n+}"
        },
        {
            "sha": "e7077399c03ce1479a655dc647c0545b64531628",
            "filename": "test/e2e/worker-react-refresh/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Flayout.tsx?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "0fe3d266b2630579b13884bdbd44000a3a5409da",
            "filename": "test/e2e/worker-react-refresh/app/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fpage.tsx?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -0,0 +1,5 @@\n+import ClientComponent from './client'\n+\n+export default function Page() {\n+  return <ClientComponent />\n+}"
        },
        {
            "sha": "5cae1b2a09e805c20bf757eea7fd8530fc5c134a",
            "filename": "test/e2e/worker-react-refresh/app/worker.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fworker.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fworker.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fworker-react-refresh%2Fapp%2Fworker.tsx?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -0,0 +1,12 @@\n+import { render } from '@react-three/offscreen'\n+\n+render(<Scene />)\n+\n+function Scene() {\n+  return (\n+    <mesh>\n+      <boxGeometry />\n+      <meshStandardMaterial color=\"orange\" />\n+    </mesh>\n+  )\n+}"
        },
        {
            "sha": "9a301e27ffa4b269bda0fe372bc246df9504971a",
            "filename": "test/e2e/worker-react-refresh/package.json",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fworker-react-refresh%2Fpackage.json?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -0,0 +1,5 @@\n+{\n+  \"dependencies\": {\n+    \"@react-three/offscreen\": \"^0.0.8\"\n+  }\n+}"
        },
        {
            "sha": "68076494fc8ddcd27d8ccd4b8decc448a4c86aaa",
            "filename": "test/e2e/worker-react-refresh/worker-react-refresh.test.tsx",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fworker-react-refresh.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/test%2Fe2e%2Fworker-react-refresh%2Fworker-react-refresh.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fworker-react-refresh%2Fworker-react-refresh.test.tsx?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -0,0 +1,29 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('worker-react-refresh', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+    dependencies: require('./package.json').dependencies,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('does not cause any runtime errors', async () => {\n+    const pageErrors: unknown[] = []\n+    await next.browser('/', {\n+      beforePageLoad: (page) => {\n+        page.on('pageerror', (error: unknown) => {\n+          pageErrors.push(error)\n+        })\n+      },\n+    })\n+\n+    // If the worker runtime does not implement the React Refresh API (i.e.\n+    // `register` and `signature`), transformed React code attempts to call it\n+    // and fails.\n+    expect(pageErrors).toBeEmpty()\n+  })\n+})"
        },
        {
            "sha": "7b34e190ea9765e8ef5aad40bc73876c13dc8d62",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/js/src/browser/runtime/base/dev-base.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fdev-base.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fdev-base.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fdev-base.ts?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -131,6 +131,15 @@ const getOrInstantiateModuleFromParent: GetOrInstantiateModuleFromParent<HotModu\n   });\n };\n \n+function getDevWorkerBlobURL(chunks) {\n+  return getWorkerBlobURL(\n+    chunks,\n+    `// noop fns to prevent runtime errors during initialization\n+self.$RefreshReg$ = function() {};\n+self.$RefreshSig$ = function() {};`\n+  );\n+}\n+\n // @ts-ignore Defined in `runtime-base.ts`\n function instantiateModule(id: ModuleId, source: SourceInfo): Module {\n   const moduleFactory = moduleFactories[id];\n@@ -223,7 +232,7 @@ function instantiateModule(id: ModuleId, source: SourceInfo): Module {\n           U: relativeURL,\n           k: refresh,\n           R: createResolvePathFromModule(r),\n-          b: getWorkerBlobURL,\n+          b: getDevWorkerBlobURL,\n           z: requireStub,\n           d: typeof module.id === \"string\" ? module.id.replace(/(^|\\/)\\/+$/, \"\") : module.id\n         })"
        },
        {
            "sha": "3c249aca5743b668546164664f11ff017386c886",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/js/src/browser/runtime/base/runtime-base.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fruntime-base.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fruntime-base.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fruntime-base.ts?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -252,9 +252,15 @@ function resolveAbsolutePath(modulePath?: string): string {\n   return `/ROOT/${modulePath ?? \"\"}`;\n }\n \n-function getWorkerBlobURL(chunks: ChunkPath[]): string {\n+/**\n+ * Returns a blob URL for the worker.\n+ * @param chunks list of chunks to load\n+ * @param beforeLoad code to run before code is loaded. Used in dev for HMR setup.\n+ */\n+function getWorkerBlobURL(chunks: ChunkPath[], beforeLoad: string | undefined): string {\n   let bootstrap = `self.TURBOPACK_WORKER_LOCATION = ${JSON.stringify(location.origin)};\n self.TURBOPACK_NEXT_CHUNK_URLS = ${JSON.stringify(chunks.reverse().map(getChunkRelativeUrl), null, 2)};\n+${beforeLoad || \"\"}\n importScripts(...self.TURBOPACK_NEXT_CHUNK_URLS.map(c => self.TURBOPACK_WORKER_LOCATION + c).reverse());`;\n   let blob = new Blob([bootstrap], { type: \"text/javascript\" });\n   return URL.createObjectURL(blob);"
        },
        {
            "sha": "7faff3fc306b0260a3286777005d9f95648807d8",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/runtime/default_dev_runtime/output/b1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8",
            "patch": "@@ -493,9 +493,14 @@ async function loadChunkPath(source, chunkPath) {\n  */ function resolveAbsolutePath(modulePath) {\n     return `/ROOT/${modulePath ?? \"\"}`;\n }\n-function getWorkerBlobURL(chunks) {\n+/**\n+ * Returns a blob URL for the worker.\n+ * @param chunks list of chunks to load\n+ * @param beforeLoad code to run before code is loaded. Used in dev for HMR setup.\n+ */ function getWorkerBlobURL(chunks, beforeLoad) {\n     let bootstrap = `self.TURBOPACK_WORKER_LOCATION = ${JSON.stringify(location.origin)};\n self.TURBOPACK_NEXT_CHUNK_URLS = ${JSON.stringify(chunks.reverse().map(getChunkRelativeUrl), null, 2)};\n+${beforeLoad || \"\"}\n importScripts(...self.TURBOPACK_NEXT_CHUNK_URLS.map(c => self.TURBOPACK_WORKER_LOCATION + c).reverse());`;\n     let blob = new Blob([\n         bootstrap\n@@ -655,6 +660,11 @@ const getOrInstantiateModuleFromParent = (id, sourceModule)=>{\n         parentId: sourceModule.id\n     });\n };\n+function getDevWorkerBlobURL(chunks) {\n+    return getWorkerBlobURL(chunks, `// noop fns to prevent runtime errors during initialization\n+self.$RefreshReg$ = function() {};\n+self.$RefreshSig$ = function() {};`);\n+}\n // @ts-ignore Defined in `runtime-base.ts`\n function instantiateModule(id, source) {\n     const moduleFactory = moduleFactories[id];\n@@ -742,7 +752,7 @@ function instantiateModule(id, source) {\n                 U: relativeURL,\n                 k: refresh,\n                 R: createResolvePathFromModule(r),\n-                b: getWorkerBlobURL,\n+                b: getDevWorkerBlobURL,\n                 z: requireStub,\n                 d: typeof module.id === \"string\" ? module.id.replace(/(^|\\/)\\/+$/, \"\") : module.id\n             }));"
        },
        {
            "sha": "11da31604ee628e1cf7f23a09a4271eee1d3625e",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/runtime/default_dev_runtime/output/b1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js.map",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/dba20c3d16b42da2885c7756b05ec4f53fb247e8/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/dba20c3d16b42da2885c7756b05ec4f53fb247e8/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js.map?ref=dba20c3d16b42da2885c7756b05ec4f53fb247e8"
        }
    ],
    "stats": {
        "total": 110,
        "additions": 102,
        "deletions": 8
    }
}