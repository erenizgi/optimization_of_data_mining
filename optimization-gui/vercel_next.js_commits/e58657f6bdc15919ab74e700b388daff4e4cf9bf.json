{
    "author": "lukesandberg",
    "message": "[turbopack] Change where `cell`s are created in `resolve_raw` to make cell allocation order deterministic. (#85525)\n\nConstructing cells within a `try_flat_join` will lead to racy creation.  Instead we just need to do a second pass after the fact\n\nAlso eliminate a clone while we are there.",
    "sha": "e58657f6bdc15919ab74e700b388daff4e4cf9bf",
    "files": [
        {
            "sha": "7c5cb7388beec8ed07ce9be4d7b71f2d334e5a5c",
            "filename": "turbopack/crates/turbopack-core/src/resolve/mod.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 20,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/e58657f6bdc15919ab74e700b388daff4e4cf9bf/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e58657f6bdc15919ab74e700b388daff4e4cf9bf/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs?ref=e58657f6bdc15919ab74e700b388daff4e4cf9bf",
            "patch": "@@ -575,30 +575,25 @@ impl ResolveResult {\n     }\n \n     pub fn source(source: ResolvedVc<Box<dyn Source>>) -> ResolvedVc<Self> {\n-        Self::source_with_key(RequestKey::default(), source)\n+        Self::source_with_key(RequestKey::default(), source).resolved_cell()\n     }\n \n-    pub fn source_with_key(\n-        request_key: RequestKey,\n-        source: ResolvedVc<Box<dyn Source>>,\n-    ) -> ResolvedVc<Self> {\n+    fn source_with_key(request_key: RequestKey, source: ResolvedVc<Box<dyn Source>>) -> Self {\n         ResolveResult {\n             primary: vec![(request_key, ResolveResultItem::Source(source))].into_boxed_slice(),\n             affecting_sources: Default::default(),\n         }\n-        .resolved_cell()\n     }\n \n-    pub fn source_with_affecting_sources(\n+    fn source_with_affecting_sources(\n         request_key: RequestKey,\n         source: ResolvedVc<Box<dyn Source>>,\n         affecting_sources: Vec<ResolvedVc<Box<dyn Source>>>,\n-    ) -> ResolvedVc<Self> {\n+    ) -> Self {\n         ResolveResult {\n             primary: vec![(request_key, ResolveResultItem::Source(source))].into_boxed_slice(),\n             affecting_sources: affecting_sources.into_boxed_slice(),\n         }\n-        .resolved_cell()\n     }\n }\n \n@@ -1416,17 +1411,17 @@ pub async fn resolve_raw(\n ) -> Result<Vc<ResolveResult>> {\n     async fn to_result(\n         request: RcStr,\n-        path: FileSystemPath,\n+        path: &FileSystemPath,\n         collect_affecting_sources: bool,\n-    ) -> Result<Vc<ResolveResult>> {\n+    ) -> Result<ResolveResult> {\n         let result = &*path.realpath_with_links().await?;\n         let path = match &result.path_result {\n             Ok(path) => path,\n-            Err(e) => bail!(e.as_error_message(&path, result)),\n+            Err(e) => bail!(e.as_error_message(path, result)),\n         };\n         let request_key = RequestKey::new(request);\n         let source = ResolvedVc::upcast(FileSource::new(path.clone()).to_resolved().await?);\n-        Ok(*if collect_affecting_sources {\n+        Ok(if collect_affecting_sources {\n             ResolveResult::source_with_affecting_sources(\n                 request_key,\n                 source,\n@@ -1449,17 +1444,22 @@ pub async fn resolve_raw(\n         matches: &[PatternMatch],\n         collect_affecting_sources: bool,\n     ) -> Result<Vec<Vc<ResolveResult>>> {\n-        matches\n+        Ok(matches\n             .iter()\n             .map(|m| async move {\n                 Ok(if let PatternMatch::File(request, path) = m {\n-                    Some(to_result(request.clone(), path.clone(), collect_affecting_sources).await?)\n+                    Some(to_result(request.clone(), path, collect_affecting_sources).await?)\n                 } else {\n                     None\n                 })\n             })\n             .try_flat_join()\n-            .await\n+            .await?\n+            // Construct all the cells after resolving the results to ensure they are constructed in\n+            // a deterministic order.\n+            .into_iter()\n+            .map(|res| res.cell())\n+            .collect())\n     }\n \n     let mut results = Vec::new();\n@@ -2847,8 +2847,8 @@ async fn resolved(\n             .to_resolved()\n             .await?,\n     );\n-    if options_value.collect_affecting_sources {\n-        Ok(*ResolveResult::source_with_affecting_sources(\n+    Ok(if options_value.collect_affecting_sources {\n+        ResolveResult::source_with_affecting_sources(\n             request_key,\n             source,\n             result\n@@ -2861,10 +2861,11 @@ async fn resolved(\n                 })\n                 .try_join()\n                 .await?,\n-        ))\n+        )\n     } else {\n-        Ok(*ResolveResult::source_with_key(request_key, source))\n+        ResolveResult::source_with_key(request_key, source)\n     }\n+    .cell())\n }\n \n async fn handle_exports_imports_field("
        }
    ],
    "stats": {
        "total": 41,
        "additions": 21,
        "deletions": 20
    }
}