{
    "author": "styfle",
    "message": "fix: add `?dpl` to fonts in `/_next/static/media` (#82384)\n\nFonts were not protected from version skew so this PR fixes it\n\n\nhttps://nextjs.org/docs/14/app/building-your-application/deploying#version-skew",
    "sha": "fc70d77d571ad7fd7ade56ddbf5dd640585563bb",
    "files": [
        {
            "sha": "e1576d1760a166e931b52825894f967beb4fff20",
            "filename": "packages/next/src/pages/_document.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/fc70d77d571ad7fd7ade56ddbf5dd640585563bb/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc70d77d571ad7fd7ade56ddbf5dd640585563bb/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx?ref=fc70d77d571ad7fd7ade56ddbf5dd640585563bb",
            "patch": "@@ -363,7 +363,8 @@ function getAmpPath(ampPath: string, asPath: string): string {\n function getNextFontLinkTags(\n   nextFontManifest: DeepReadonly<NextFontManifest> | undefined,\n   dangerousAsPath: string,\n-  assetPrefix: string = ''\n+  assetPrefix: string = '',\n+  assetQueryString: string = ''\n ) {\n   if (!nextFontManifest) {\n     return {\n@@ -403,7 +404,7 @@ function getNextFontLinkTags(\n             <link\n               key={fontFile}\n               rel=\"preload\"\n-              href={`${assetPrefix}/_next/${encodeURIPath(fontFile)}`}\n+              href={`${assetPrefix}/_next/${encodeURIPath(fontFile)}${assetQueryString}`}\n               as=\"font\"\n               type={`font/${ext}`}\n               crossOrigin=\"anonymous\"\n@@ -755,7 +756,8 @@ export class Head extends React.Component<HeadProps> {\n     const nextFontLinkTags = getNextFontLinkTags(\n       nextFontManifest,\n       dangerousAsPath,\n-      assetPrefix\n+      assetPrefix,\n+      this.context.assetQueryString\n     )\n \n     const tracingMetadata = getTracedMetadata("
        },
        {
            "sha": "e25dc21a4b6d4a8921e3f0125bcbdfaff5d04aa5",
            "filename": "packages/next/src/server/app-render/get-layer-assets.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fc70d77d571ad7fd7ade56ddbf5dd640585563bb/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fc70d77d571ad7fd7ade56ddbf5dd640585563bb/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fget-layer-assets.tsx?ref=fc70d77d571ad7fd7ade56ddbf5dd640585563bb",
            "patch": "@@ -46,7 +46,7 @@ export function getLayerAssets({\n         const fontFilename = preloadedFontFiles[i]\n         const ext = /\\.(woff|woff2|eot|ttf|otf)$/.exec(fontFilename)![1]\n         const type = `font/${ext}`\n-        const href = `${ctx.assetPrefix}/_next/${encodeURIPath(fontFilename)}`\n+        const href = `${ctx.assetPrefix}/_next/${encodeURIPath(fontFilename)}${getAssetQueryString(ctx, false)}`\n \n         preloadCallbacks.push(() => {\n           ctx.componentMod.preloadFont("
        },
        {
            "sha": "d841e5ff26c219487d288494a55234a02e2f0b6f",
            "filename": "test/production/deployment-id-handling/deployment-id-cookie-handling.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fc70d77d571ad7fd7ade56ddbf5dd640585563bb/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc70d77d571ad7fd7ade56ddbf5dd640585563bb/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-cookie-handling.test.ts?ref=fc70d77d571ad7fd7ade56ddbf5dd640585563bb",
            "patch": "@@ -45,11 +45,7 @@ describe('deployment-id-handling disabled', () => {\n \n       for (const link of links) {\n         if (link.attribs.href) {\n-          if (link.attribs.as === 'font') {\n-            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n-          } else {\n-            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n-          }\n+          expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n         }\n       }\n "
        },
        {
            "sha": "e4ae21037ffb7b539fe7c53be10eaa4f32633f61",
            "filename": "test/production/deployment-id-handling/deployment-id-handling.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/fc70d77d571ad7fd7ade56ddbf5dd640585563bb/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-handling.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fc70d77d571ad7fd7ade56ddbf5dd640585563bb/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-handling.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fdeployment-id-handling%2Fdeployment-id-handling.test.ts?ref=fc70d77d571ad7fd7ade56ddbf5dd640585563bb",
            "patch": "@@ -39,11 +39,7 @@ describe.each(['NEXT_DEPLOYMENT_ID', 'CUSTOM_DEPLOYMENT_ID'])(\n \n         for (const link of links) {\n           if (link.attribs.href && link.attribs.rel !== 'expect') {\n-            if (link.attribs.as === 'font') {\n-              expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n-            } else {\n-              expect(link.attribs.href).toContain('dpl=' + deploymentId)\n-            }\n+            expect(link.attribs.href).toContain('dpl=' + deploymentId)\n           }\n         }\n \n@@ -173,11 +169,7 @@ describe('deployment-id-handling disabled', () => {\n \n       for (const link of links) {\n         if (link.attribs.href) {\n-          if (link.attribs.as === 'font') {\n-            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n-          } else {\n-            expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n-          }\n+          expect(link.attribs.href).not.toContain('dpl=' + deploymentId)\n         }\n       }\n "
        }
    ],
    "stats": {
        "total": 28,
        "additions": 9,
        "deletions": 19
    }
}