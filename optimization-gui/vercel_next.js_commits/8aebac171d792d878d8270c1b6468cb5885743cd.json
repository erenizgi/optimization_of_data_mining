{
    "author": "timneutkens",
    "message": "Development: Don't import app-router / hot-reloader through next/link in application code (#83656)\n\n## What?\n\nRemoves imports from the app-ssr layer that cause transitive\ndependencies to be included during compilation in development.\n\nFor the trace that I received from an application there was quite a bit\nof overhead for them because of this issue.\n\nTrace:\n\n![CleanShot 2025-09-10 at\n21.32.27@2x.png](https://app.graphite.dev/user-attachments/assets/8a7e5323-ed3c-4aec-8723-7fbbae89a99d.png)",
    "sha": "8aebac171d792d878d8270c1b6468cb5885743cd",
    "files": [
        {
            "sha": "b4bb7a25636a4b9345b2eb3d337a8bb17836a4c3",
            "filename": "packages/next/src/client/app-dir/link.tsx",
            "status": "modified",
            "additions": 38,
            "deletions": 34,
            "changes": 72,
            "blob_url": "https://github.com/vercel/next.js/blob/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx?ref=8aebac171d792d878d8270c1b6468cb5885743cd",
            "patch": "@@ -18,7 +18,6 @@ import {\n   type LinkInstance,\n } from '../components/links'\n import { isLocalURL } from '../../shared/lib/router/utils/is-local-url'\n-import { dispatchNavigateAction } from '../components/app-router-instance'\n import {\n   FetchStrategy,\n   type PrefetchTaskFetchStrategy,\n@@ -221,47 +220,52 @@ function linkClicked(\n   scroll?: boolean,\n   onNavigate?: OnNavigateEventHandler\n ): void {\n-  if (isModifiedEvent(e) || e.currentTarget.hasAttribute('download')) {\n-    // ignore click for browser’s default behavior\n-    return\n-  }\n-\n-  if (!isLocalURL(href)) {\n-    if (replace) {\n-      // browser default behavior does not replace the history state\n-      // so we need to do it manually\n-      e.preventDefault()\n-      location.replace(href)\n+  if (typeof window !== 'undefined') {\n+    if (isModifiedEvent(e) || e.currentTarget.hasAttribute('download')) {\n+      // ignore click for browser’s default behavior\n+      return\n     }\n \n-    // ignore click for browser’s default behavior\n-    return\n-  }\n+    if (!isLocalURL(href)) {\n+      if (replace) {\n+        // browser default behavior does not replace the history state\n+        // so we need to do it manually\n+        e.preventDefault()\n+        location.replace(href)\n+      }\n \n-  e.preventDefault()\n+      // ignore click for browser’s default behavior\n+      return\n+    }\n \n-  if (onNavigate) {\n-    let isDefaultPrevented = false\n+    e.preventDefault()\n \n-    onNavigate({\n-      preventDefault: () => {\n-        isDefaultPrevented = true\n-      },\n-    })\n+    if (onNavigate) {\n+      let isDefaultPrevented = false\n \n-    if (isDefaultPrevented) {\n-      return\n+      onNavigate({\n+        preventDefault: () => {\n+          isDefaultPrevented = true\n+        },\n+      })\n+\n+      if (isDefaultPrevented) {\n+        return\n+      }\n     }\n-  }\n \n-  React.startTransition(() => {\n-    dispatchNavigateAction(\n-      as || href,\n-      replace ? 'replace' : 'push',\n-      scroll ?? true,\n-      linkInstanceRef.current\n-    )\n-  })\n+    const { dispatchNavigateAction } =\n+      require('../components/app-router-instance') as typeof import('../components/app-router-instance')\n+\n+    React.startTransition(() => {\n+      dispatchNavigateAction(\n+        as || href,\n+        replace ? 'replace' : 'push',\n+        scroll ?? true,\n+        linkInstanceRef.current\n+      )\n+    })\n+  }\n }\n \n function formatStringOrUrl(urlObjOrString: UrlObject | string): string {"
        },
        {
            "sha": "5855b165616f07706e0cc9a3343ad1b18c549c29",
            "filename": "packages/next/src/client/components/app-router-instance.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts?ref=8aebac171d792d878d8270c1b6468cb5885743cd",
            "patch": "@@ -21,7 +21,7 @@ import {\n } from './segment-cache'\n import { dispatchAppRouterAction } from './use-action-queue'\n import { addBasePath } from '../add-base-path'\n-import { createPrefetchURL, isExternalURL } from './app-router'\n+import { createPrefetchURL, isExternalURL } from './app-router-utils'\n import { prefetchReducer } from './router-reducer/reducers/prefetch-reducer'\n import type {\n   AppRouterInstance,"
        },
        {
            "sha": "049967f6d9c269f0e4b58e3a2b3c3ab9ad6dc773",
            "filename": "packages/next/src/client/components/app-router-utils.ts",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-utils.ts?ref=8aebac171d792d878d8270c1b6468cb5885743cd",
            "patch": "@@ -0,0 +1,43 @@\n+import { isBot } from '../../shared/lib/router/utils/is-bot'\n+import { addBasePath } from '../add-base-path'\n+\n+export function isExternalURL(url: URL) {\n+  return url.origin !== window.location.origin\n+}\n+\n+/**\n+ * Given a link href, constructs the URL that should be prefetched. Returns null\n+ * in cases where prefetching should be disabled, like external URLs, or\n+ * during development.\n+ * @param href The href passed to <Link>, router.prefetch(), or similar\n+ * @returns A URL object to prefetch, or null if prefetching should be disabled\n+ */\n+export function createPrefetchURL(href: string): URL | null {\n+  // Don't prefetch for bots as they don't navigate.\n+  if (isBot(window.navigator.userAgent)) {\n+    return null\n+  }\n+\n+  let url: URL\n+  try {\n+    url = new URL(addBasePath(href), window.location.href)\n+  } catch (_) {\n+    // TODO: Does this need to throw or can we just console.error instead? Does\n+    // anyone rely on this throwing? (Seems unlikely.)\n+    throw new Error(\n+      `Cannot prefetch '${href}' because it cannot be converted to a URL.`\n+    )\n+  }\n+\n+  // Don't prefetch during development (improves compilation performance)\n+  if (process.env.NODE_ENV === 'development') {\n+    return null\n+  }\n+\n+  // External urls can't be prefetched in the same way.\n+  if (isExternalURL(url)) {\n+    return null\n+  }\n+\n+  return url\n+}"
        },
        {
            "sha": "43f6c019f599a27e2f494cea57a53a2d62571d0a",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 45,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=8aebac171d792d878d8270c1b6468cb5885743cd",
            "patch": "@@ -1,5 +1,3 @@\n-'use client'\n-\n import React, {\n   useEffect,\n   useMemo,\n@@ -25,8 +23,6 @@ import {\n   PathParamsContext,\n } from '../../shared/lib/hooks-client-context.shared-runtime'\n import { dispatchAppRouterAction, useActionQueue } from './use-action-queue'\n-import { isBot } from '../../shared/lib/router/utils/is-bot'\n-import { addBasePath } from '../add-base-path'\n import { AppRouterAnnouncer } from './app-router-announcer'\n import { RedirectBoundary } from './redirect-boundary'\n import { findHeadInCache } from './router-reducer/reducers/find-head-in-cache'\n@@ -53,47 +49,6 @@ const globalMutable: {\n   pendingMpaPath?: string\n } = {}\n \n-export function isExternalURL(url: URL) {\n-  return url.origin !== window.location.origin\n-}\n-\n-/**\n- * Given a link href, constructs the URL that should be prefetched. Returns null\n- * in cases where prefetching should be disabled, like external URLs, or\n- * during development.\n- * @param href The href passed to <Link>, router.prefetch(), or similar\n- * @returns A URL object to prefetch, or null if prefetching should be disabled\n- */\n-export function createPrefetchURL(href: string): URL | null {\n-  // Don't prefetch for bots as they don't navigate.\n-  if (isBot(window.navigator.userAgent)) {\n-    return null\n-  }\n-\n-  let url: URL\n-  try {\n-    url = new URL(addBasePath(href), window.location.href)\n-  } catch (_) {\n-    // TODO: Does this need to throw or can we just console.error instead? Does\n-    // anyone rely on this throwing? (Seems unlikely.)\n-    throw new Error(\n-      `Cannot prefetch '${href}' because it cannot be converted to a URL.`\n-    )\n-  }\n-\n-  // Don't prefetch during development (improves compilation performance)\n-  if (process.env.NODE_ENV === 'development') {\n-    return null\n-  }\n-\n-  // External urls can't be prefetched in the same way.\n-  if (isExternalURL(url)) {\n-    return null\n-  }\n-\n-  return url\n-}\n-\n function HistoryUpdater({\n   appRouterState,\n }: {"
        },
        {
            "sha": "e4a771688d7051715a5bedaea7273edac3712f37",
            "filename": "packages/next/src/client/components/links.ts",
            "status": "modified",
            "additions": 68,
            "deletions": 57,
            "changes": 125,
            "blob_url": "https://github.com/vercel/next.js/blob/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts?ref=8aebac171d792d878d8270c1b6468cb5885743cd",
            "patch": "@@ -1,7 +1,5 @@\n import type { FlightRouterState } from '../../shared/lib/app-router-types'\n import type { AppRouterInstance } from '../../shared/lib/app-router-context.shared-runtime'\n-import { getCurrentAppRouterState } from './app-router-instance'\n-import { createPrefetchURL } from './app-router'\n import {\n   FetchStrategy,\n   isPrefetchTaskDirty,\n@@ -122,19 +120,26 @@ function observeVisibility(element: Element, instance: PrefetchableInstance) {\n }\n \n function coercePrefetchableUrl(href: string): URL | null {\n-  try {\n-    return createPrefetchURL(href)\n-  } catch {\n-    // createPrefetchURL sometimes throws an error if an invalid URL is\n-    // provided, though I'm not sure if it's actually necessary.\n-    // TODO: Consider removing the throw from the inner function, or change it\n-    // to reportError. Or maybe the error isn't even necessary for automatic\n-    // prefetches, just navigations.\n-    const reportErrorFn =\n-      typeof reportError === 'function' ? reportError : console.error\n-    reportErrorFn(\n-      `Cannot prefetch '${href}' because it cannot be converted to a URL.`\n-    )\n+  if (typeof window !== 'undefined') {\n+    const { createPrefetchURL } =\n+      require('./app-router-utils') as typeof import('./app-router-utils')\n+\n+    try {\n+      return createPrefetchURL(href)\n+    } catch {\n+      // createPrefetchURL sometimes throws an error if an invalid URL is\n+      // provided, though I'm not sure if it's actually necessary.\n+      // TODO: Consider removing the throw from the inner function, or change it\n+      // to reportError. Or maybe the error isn't even necessary for automatic\n+      // prefetches, just navigations.\n+      const reportErrorFn =\n+        typeof reportError === 'function' ? reportError : console.error\n+      reportErrorFn(\n+        `Cannot prefetch '${href}' because it cannot be converted to a URL.`\n+      )\n+      return null\n+    }\n+  } else {\n     return null\n   }\n }\n@@ -274,51 +279,57 @@ function rescheduleLinkPrefetch(\n   instance: PrefetchableInstance,\n   priority: PrefetchPriority.Default | PrefetchPriority.Intent\n ) {\n-  const existingPrefetchTask = instance.prefetchTask\n-\n-  if (!instance.isVisible) {\n-    // Cancel any in-progress prefetch task. (If it already finished then this\n-    // is a no-op.)\n-    if (existingPrefetchTask !== null) {\n-      cancelPrefetchTask(existingPrefetchTask)\n+  // Ensures that app-router-instance is not compiled in the server bundle\n+  if (typeof window !== 'undefined') {\n+    const existingPrefetchTask = instance.prefetchTask\n+\n+    if (!instance.isVisible) {\n+      // Cancel any in-progress prefetch task. (If it already finished then this\n+      // is a no-op.)\n+      if (existingPrefetchTask !== null) {\n+        cancelPrefetchTask(existingPrefetchTask)\n+      }\n+      // We don't need to reset the prefetchTask to null upon cancellation; an\n+      // old task object can be rescheduled with reschedulePrefetchTask. This is a\n+      // micro-optimization but also makes the code simpler (don't need to\n+      // worry about whether an old task object is stale).\n+      return\n     }\n-    // We don't need to reset the prefetchTask to null upon cancellation; an\n-    // old task object can be rescheduled with reschedulePrefetchTask. This is a\n-    // micro-optimization but also makes the code simpler (don't need to\n-    // worry about whether an old task object is stale).\n-    return\n-  }\n \n-  if (!process.env.__NEXT_CLIENT_SEGMENT_CACHE) {\n-    // The old prefetch implementation does not have different priority levels.\n-    // Just schedule a new prefetch task.\n-    prefetchWithOldCacheImplementation(instance)\n-    return\n-  }\n+    if (!process.env.__NEXT_CLIENT_SEGMENT_CACHE) {\n+      // The old prefetch implementation does not have different priority levels.\n+      // Just schedule a new prefetch task.\n+      prefetchWithOldCacheImplementation(instance)\n+      return\n+    }\n \n-  const appRouterState = getCurrentAppRouterState()\n-  if (appRouterState !== null) {\n-    const treeAtTimeOfPrefetch = appRouterState.tree\n-    if (existingPrefetchTask === null) {\n-      // Initiate a prefetch task.\n-      const nextUrl = appRouterState.nextUrl\n-      const cacheKey = createCacheKey(instance.prefetchHref, nextUrl)\n-      instance.prefetchTask = scheduleSegmentPrefetchTask(\n-        cacheKey,\n-        treeAtTimeOfPrefetch,\n-        instance.fetchStrategy,\n-        priority,\n-        null\n-      )\n-    } else {\n-      // We already have an old task object that we can reschedule. This is\n-      // effectively the same as canceling the old task and creating a new one.\n-      reschedulePrefetchTask(\n-        existingPrefetchTask,\n-        treeAtTimeOfPrefetch,\n-        instance.fetchStrategy,\n-        priority\n-      )\n+    const { getCurrentAppRouterState } =\n+      require('./app-router-instance') as typeof import('./app-router-instance')\n+\n+    const appRouterState = getCurrentAppRouterState()\n+    if (appRouterState !== null) {\n+      const treeAtTimeOfPrefetch = appRouterState.tree\n+      if (existingPrefetchTask === null) {\n+        // Initiate a prefetch task.\n+        const nextUrl = appRouterState.nextUrl\n+        const cacheKey = createCacheKey(instance.prefetchHref, nextUrl)\n+        instance.prefetchTask = scheduleSegmentPrefetchTask(\n+          cacheKey,\n+          treeAtTimeOfPrefetch,\n+          instance.fetchStrategy,\n+          priority,\n+          null\n+        )\n+      } else {\n+        // We already have an old task object that we can reschedule. This is\n+        // effectively the same as canceling the old task and creating a new one.\n+        reschedulePrefetchTask(\n+          existingPrefetchTask,\n+          treeAtTimeOfPrefetch,\n+          instance.fetchStrategy,\n+          priority\n+        )\n+      }\n     }\n   }\n }"
        },
        {
            "sha": "49ce56baa695c21de93c7933786a7199e8376510",
            "filename": "packages/next/src/client/components/segment-cache-impl/prefetch.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fprefetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8aebac171d792d878d8270c1b6468cb5885743cd/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fprefetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fprefetch.ts?ref=8aebac171d792d878d8270c1b6468cb5885743cd",
            "patch": "@@ -1,5 +1,5 @@\n import type { FlightRouterState } from '../../../shared/lib/app-router-types'\n-import { createPrefetchURL } from '../app-router'\n+import { createPrefetchURL } from '../app-router-utils'\n import { createCacheKey } from './cache-key'\n import { schedulePrefetchTask } from './scheduler'\n import {"
        }
    ],
    "stats": {
        "total": 289,
        "additions": 151,
        "deletions": 138
    }
}