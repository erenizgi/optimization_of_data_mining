{
    "author": "gnoff",
    "message": "Model prerender store as separate server and client scopes (#79429)\n\nWhen we adopted the architecture of WorkUnitStore the idea was that code\ncould be running in only one scope at a time. The point was to limit\naccidental leakage of incorrect data into a scope, for instance by\ncarrying request data into a cache function where it would poison the\ncache entry that reads from it. However the model of these stores did\nnot discriminate between rendering for RSC and rendering for the client.\nThere are many APIs that are only available in RSC and that should not\nwork when performing an HTML render on the server but without\ndiscriminating between the render type it is impossible to make such\ndifferentiations at runtime and we must rely on other means to prevent\nincorrect usage of APIs in the wrong scope.\n\nThis change forks the prerender store (dynamicIO) into a server\n('prerender') and client ('prerender-client') type. At the moment they\nstill share all the same store properties but in later updates I will be\nremoving all the unnecessary properties from the client version of this\nstore.",
    "sha": "a2cc0734a456e6cdc5076d16c63039d550f193fa",
    "files": [
        {
            "sha": "34d2d4919a8dd0cb20826cb96df013fe118d668a",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -690,5 +690,7 @@\n   \"689\": \"The \\\\`compiler.defineServer\\\\` option is configured to replace the \\\\`%s\\\\` variable. This variable is either part of a Next.js built-in or is already configured.\",\n   \"690\": \"Invariant: loadManifests called for edge runtime\",\n   \"691\": \"Accessed fallback \\\\`params\\\\` during prerendering.\",\n-  \"692\": \"Expected clientReferenceManifest to be defined.\"\n+  \"692\": \"Expected clientReferenceManifest to be defined.\",\n+  \"693\": \"%s must not be used within a client component. Next.js should be preventing %s from being included in client components statically, but did not in this case.\",\n+  \"694\": \"createPrerenderPathname was called inside a client component scope.\"\n }"
        },
        {
            "sha": "b15524af8087981a16018e294b7009e508f8e56a",
            "filename": "packages/next/src/client/components/bailout-to-client-rendering.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -12,6 +12,7 @@ export function bailoutToClientRendering(reason: string): void | never {\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n+      case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         throw new BailoutToCSRError(reason)"
        },
        {
            "sha": "83fcb2c9bf1a37a2a4f35bfd6231acd48bff8939",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -1223,7 +1223,9 @@ async function renderToHTMLOrFlightImpl(\n       const workUnitStore = workUnitAsyncStorage.getStore()\n       return !!(\n         workUnitStore &&\n-        (workUnitStore.type === 'prerender' || workUnitStore.type === 'cache')\n+        (workUnitStore.type === 'prerender' ||\n+          workUnitStore.type === 'prerender-client' ||\n+          workUnitStore.type === 'cache')\n       )\n     }\n \n@@ -2398,7 +2400,7 @@ async function spawnDynamicValidationInDev(\n   if (initialServerResult) {\n     const initialClientController = new AbortController()\n     const initialClientPrerenderStore: PrerenderStore = {\n-      type: 'prerender',\n+      type: 'prerender-client',\n       phase: 'render',\n       rootParams,\n       implicitTags,\n@@ -2546,7 +2548,7 @@ async function spawnDynamicValidationInDev(\n   )\n   const finalClientController = new AbortController()\n   const finalClientPrerenderStore: PrerenderStore = {\n-    type: 'prerender',\n+    type: 'prerender-client',\n     phase: 'render',\n     rootParams,\n     implicitTags,\n@@ -2997,7 +2999,7 @@ async function prerenderToStream(\n       if (initialServerResult) {\n         const initialClientController = new AbortController()\n         const initialClientPrerenderStore: PrerenderStore = {\n-          type: 'prerender',\n+          type: 'prerender-client',\n           phase: 'render',\n           rootParams,\n           implicitTags,\n@@ -3153,7 +3155,7 @@ async function prerenderToStream(\n       )\n       const finalClientController = new AbortController()\n       const finalClientPrerenderStore: PrerenderStore = {\n-        type: 'prerender',\n+        type: 'prerender-client',\n         phase: 'render',\n         rootParams,\n         implicitTags,"
        },
        {
            "sha": "c53a625ba608ca4e8cf4be879c4aec3bb2c18635",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -237,8 +237,10 @@ export function trackDynamicDataInDynamicRender(\n       // forbidden inside a cache scope.\n       return\n     }\n+    // TODO: it makes no sense to have these work unit store types during a dev render.\n     if (\n       workUnitStore.type === 'prerender' ||\n+      workUnitStore.type === 'prerender-client' ||\n       workUnitStore.type === 'prerender-legacy'\n     ) {\n       workUnitStore.revalidate = 0\n@@ -578,7 +580,7 @@ export function useDynamicRouteParams(expression: string) {\n     const workUnitStore = workUnitAsyncStorage.getStore()\n     if (workUnitStore) {\n       // We're prerendering with dynamicIO or PPR or both\n-      if (workUnitStore.type === 'prerender') {\n+      if (workUnitStore.type === 'prerender-client') {\n         // We are in a prerender with dynamicIO semantics\n         // We are going to hang here and never resolve. This will cause the currently\n         // rendering component to effectively be a dynamic hole"
        },
        {
            "sha": "3f8e15745b3bd02881a327ff88fd03b86422fdd1",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -79,7 +79,10 @@ export interface RequestStore extends CommonWorkUnitStore {\n  * to fill all caches.\n  */\n export interface PrerenderStoreModern extends CommonWorkUnitStore {\n-  type: 'prerender'\n+  // In the future the prerender-client variant will get it's own type.\n+  // prerender represents the RSC scope of the prerender.\n+  // prerender-client represents the HTML scope of the prerender.\n+  type: 'prerender' | 'prerender-client'\n \n   /**\n    * This signal is aborted when the React render is complete. (i.e. it is the same signal passed to react)\n@@ -221,6 +224,7 @@ export function getExpectedRequestStore(\n       return workUnitStore\n \n     case 'prerender':\n+    case 'prerender-client':\n     case 'prerender-ppr':\n     case 'prerender-legacy':\n       // This should not happen because we should have checked it already.\n@@ -255,6 +259,8 @@ export function getPrerenderResumeDataCache(\n ): PrerenderResumeDataCache | null {\n   if (\n     workUnitStore.type === 'prerender' ||\n+    // TODO eliminate fetch caching in client scope and stop exposing this data cache during SSR\n+    workUnitStore.type === 'prerender-client' ||\n     workUnitStore.type === 'prerender-ppr'\n   ) {\n     return workUnitStore.prerenderResumeDataCache"
        },
        {
            "sha": "8c89bec4a629b6d191bf9185add05fa851e03c91",
            "filename": "packages/next/src/server/lib/patch-fetch.ts",
            "status": "modified",
            "additions": 72,
            "deletions": 42,
            "changes": 114,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -256,6 +256,8 @@ export function createPatchedFetcher(\n           workUnitStore &&\n           (workUnitStore.type === 'cache' ||\n             workUnitStore.type === 'prerender' ||\n+            // TODO: stop accumulating tags in client prerender\n+            workUnitStore.type === 'prerender-client' ||\n             workUnitStore.type === 'prerender-ppr' ||\n             workUnitStore.type === 'prerender-legacy')\n             ? workUnitStore\n@@ -405,7 +407,11 @@ export function createPatchedFetcher(\n         if (\n           hasNoExplicitCacheConfig &&\n           workUnitStore !== undefined &&\n-          workUnitStore.type === 'prerender'\n+          (workUnitStore.type === 'prerender' ||\n+            // While we don't want to do caching in the client scope\n+            // we know the fetch will be dynamic for dynamicIO so we\n+            // may as well avoid the call here\n+            workUnitStore.type === 'prerender-client')\n         ) {\n           // If we have no cache config, and we're in Dynamic I/O prerendering, it'll be a dynamic call.\n           // We don't have to issue that dynamic call.\n@@ -500,22 +506,28 @@ export function createPatchedFetcher(\n           // If we were setting the revalidate value to 0, we should try to\n           // postpone instead first.\n           if (finalRevalidate === 0) {\n-            if (workUnitStore && workUnitStore.type === 'prerender') {\n-              if (cacheSignal) {\n-                cacheSignal.endRead()\n-                cacheSignal = null\n+            if (workUnitStore) {\n+              switch (workUnitStore.type) {\n+                case 'prerender':\n+                case 'prerender-client':\n+                  if (cacheSignal) {\n+                    cacheSignal.endRead()\n+                    cacheSignal = null\n+                  }\n+                  return makeHangingPromise<Response>(\n+                    workUnitStore.renderSignal,\n+                    'fetch()'\n+                  )\n+                default:\n+                // fallthrough\n               }\n-              return makeHangingPromise<Response>(\n-                workUnitStore.renderSignal,\n-                'fetch()'\n-              )\n-            } else {\n-              markCurrentScopeAsDynamic(\n-                workStore,\n-                workUnitStore,\n-                `revalidate: 0 fetch ${input} ${workStore.route}`\n-              )\n             }\n+\n+            markCurrentScopeAsDynamic(\n+              workStore,\n+              workUnitStore,\n+              `revalidate: 0 fetch ${input} ${workStore.route}`\n+            )\n           }\n \n           // We only want to set the revalidate store's revalidate time if it\n@@ -633,7 +645,11 @@ export function createPatchedFetcher(\n                     ? CACHE_ONE_YEAR\n                     : finalRevalidate\n \n-                if (workUnitStore && workUnitStore.type === 'prerender') {\n+                if (\n+                  workUnitStore &&\n+                  (workUnitStore.type === 'prerender' ||\n+                    workUnitStore.type === 'prerender-client')\n+                ) {\n                   // We are prerendering at build time or revalidate time with dynamicIO so we need to\n                   // buffer the response so we can guarantee it can be read in a microtask\n                   const bodyBuffer = await res.arrayBuffer()\n@@ -780,7 +796,11 @@ export function createPatchedFetcher(\n               // We sometimes use the cache to dedupe fetches that do not specify a cache configuration\n               // In these cases we want to make sure we still exclude them from prerenders if dynamicIO is on\n               // so we introduce an artificial Task boundary here.\n-              if (workUnitStore && workUnitStore.type === 'prerender') {\n+              if (\n+                workUnitStore &&\n+                (workUnitStore.type === 'prerender' ||\n+                  workUnitStore.type === 'prerender-client')\n+              ) {\n                 await waitAtLeastOneReactRenderTask()\n               }\n             }\n@@ -863,22 +883,27 @@ export function createPatchedFetcher(\n \n           if (cache === 'no-store') {\n             // If enabled, we should bail out of static generation.\n-            if (workUnitStore && workUnitStore.type === 'prerender') {\n-              if (cacheSignal) {\n-                cacheSignal.endRead()\n-                cacheSignal = null\n+            if (workUnitStore) {\n+              switch (workUnitStore.type) {\n+                case 'prerender':\n+                case 'prerender-client':\n+                  if (cacheSignal) {\n+                    cacheSignal.endRead()\n+                    cacheSignal = null\n+                  }\n+                  return makeHangingPromise<Response>(\n+                    workUnitStore.renderSignal,\n+                    'fetch()'\n+                  )\n+                default:\n+                // fallthrough\n               }\n-              return makeHangingPromise<Response>(\n-                workUnitStore.renderSignal,\n-                'fetch()'\n-              )\n-            } else {\n-              markCurrentScopeAsDynamic(\n-                workStore,\n-                workUnitStore,\n-                `no-store fetch ${input} ${workStore.route}`\n-              )\n             }\n+            markCurrentScopeAsDynamic(\n+              workStore,\n+              workUnitStore,\n+              `no-store fetch ${input} ${workStore.route}`\n+            )\n           }\n \n           const hasNextConfig = 'next' in init\n@@ -890,18 +915,23 @@ export function createPatchedFetcher(\n           ) {\n             if (next.revalidate === 0) {\n               // If enabled, we should bail out of static generation.\n-              if (workUnitStore && workUnitStore.type === 'prerender') {\n-                return makeHangingPromise<Response>(\n-                  workUnitStore.renderSignal,\n-                  'fetch()'\n-                )\n-              } else {\n-                markCurrentScopeAsDynamic(\n-                  workStore,\n-                  workUnitStore,\n-                  `revalidate: 0 fetch ${input} ${workStore.route}`\n-                )\n+              if (workUnitStore) {\n+                switch (workUnitStore.type) {\n+                  case 'prerender':\n+                  case 'prerender-client':\n+                    return makeHangingPromise<Response>(\n+                      workUnitStore.renderSignal,\n+                      'fetch()'\n+                    )\n+                  default:\n+                  // fallthrough\n+                }\n               }\n+              markCurrentScopeAsDynamic(\n+                workStore,\n+                workUnitStore,\n+                `revalidate: 0 fetch ${input} ${workStore.route}`\n+              )\n             }\n \n             if (!workStore.forceStatic || next.revalidate !== 0) {"
        },
        {
            "sha": "0110f39e012caaf994c2dbaa7784896ba4d33f1b",
            "filename": "packages/next/src/server/node-environment-extensions/utils.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -11,7 +11,10 @@ type ApiType = 'time' | 'random' | 'crypto'\n export function io(expression: string, type: ApiType) {\n   const workUnitStore = workUnitAsyncStorage.getStore()\n   if (workUnitStore) {\n-    if (workUnitStore.type === 'prerender') {\n+    if (\n+      workUnitStore.type === 'prerender' ||\n+      workUnitStore.type === 'prerender-client'\n+    ) {\n       const prerenderSignal = workUnitStore.controller.signal\n       if (prerenderSignal.aborted === false) {\n         // If the prerender signal is already aborted we don't need to construct any stacks"
        },
        {
            "sha": "d7cbc767065dfd722a87b22b2c17a5b6872f02ab",
            "filename": "packages/next/src/server/request/connection.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -53,7 +53,10 @@ export function connection(): Promise<void> {\n     }\n \n     if (workUnitStore) {\n-      if (workUnitStore.type === 'prerender') {\n+      if (\n+        workUnitStore.type === 'prerender' ||\n+        workUnitStore.type === 'prerender-client'\n+      ) {\n         // dynamicIO Prerender\n         // We return a promise that never resolves to allow the prender to stall at this point\n         return makeHangingPromise(workUnitStore.renderSignal, '`connection()`')"
        },
        {
            "sha": "e76252f7c7610d8fcdc0331dcb86103043b2023e",
            "filename": "packages/next/src/server/request/cookies.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 26,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -23,6 +23,7 @@ import { makeHangingPromise } from '../dynamic-rendering-utils'\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n import { scheduleImmediate } from '../../lib/scheduler'\n import { isRequestAPICallableInsideAfter } from './utils'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n \n /**\n  * In this version of Next.js `cookies()` returns a Promise however you can still reference the properties of the underlying cookies object\n@@ -89,32 +90,42 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n     }\n \n     if (workUnitStore) {\n-      if (workUnitStore.type === 'prerender') {\n-        // dynamicIO Prerender\n-        // We don't track dynamic access here because access will be tracked when you access\n-        // one of the properties of the cookies object.\n-        return makeDynamicallyTrackedExoticCookies(\n-          workStore.route,\n-          workUnitStore\n-        )\n-      } else if (workUnitStore.type === 'prerender-ppr') {\n-        // PPR Prerender (no dynamicIO)\n-        // We are prerendering with PPR. We need track dynamic access here eagerly\n-        // to keep continuity with how cookies has worked in PPR without dynamicIO.\n-        postponeWithTracking(\n-          workStore.route,\n-          callingExpression,\n-          workUnitStore.dynamicTracking\n-        )\n-      } else if (workUnitStore.type === 'prerender-legacy') {\n-        // Legacy Prerender\n-        // We track dynamic access here so we don't need to wrap the cookies in\n-        // individual property access tracking.\n-        throwToInterruptStaticGeneration(\n-          callingExpression,\n-          workStore,\n-          workUnitStore\n-        )\n+      switch (workUnitStore.type) {\n+        case 'prerender':\n+          // dynamicIO Prerender\n+          // We don't track dynamic access here because access will be tracked when you access\n+          // one of the properties of the cookies object.\n+          return makeDynamicallyTrackedExoticCookies(\n+            workStore.route,\n+            workUnitStore\n+          )\n+        case 'prerender-client':\n+          const exportName = '`cookies`'\n+          throw new InvariantError(\n+            `${exportName} must not be used within a client component. Next.js should be preventing ${exportName} from being included in client components statically, but did not in this case.`\n+          )\n+        case 'prerender-ppr':\n+          // PPR Prerender (no dynamicIO)\n+          // We are prerendering with PPR. We need track dynamic access here eagerly\n+          // to keep continuity with how cookies has worked in PPR without dynamicIO.\n+          postponeWithTracking(\n+            workStore.route,\n+            callingExpression,\n+            workUnitStore.dynamicTracking\n+          )\n+          break\n+        case 'prerender-legacy':\n+          // Legacy Prerender\n+          // We track dynamic access here so we don't need to wrap the cookies in\n+          // individual property access tracking.\n+          throwToInterruptStaticGeneration(\n+            callingExpression,\n+            workStore,\n+            workUnitStore\n+          )\n+          break\n+        default:\n+        // fallthrough\n       }\n     }\n     // We fall through to the dynamic context below but we still track dynamic access"
        },
        {
            "sha": "57a3069e2f0fab0a3fea7aa303380048bfe5352d",
            "filename": "packages/next/src/server/request/draft-mode.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 35,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -18,6 +18,7 @@ import {\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n import { DynamicServerError } from '../../client/components/hooks-server-context'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n \n /**\n  * In this version of Next.js `draftMode()` returns a Promise however you can still reference the properties of the underlying draftMode object\n@@ -75,6 +76,7 @@ export function draftMode(): Promise<DraftMode> {\n     // Otherwise, we fall through to providing an empty draft mode.\n     // eslint-disable-next-line no-fallthrough\n     case 'prerender':\n+    case 'prerender-client':\n     case 'prerender-ppr':\n     case 'prerender-legacy':\n       // Return empty draft mode\n@@ -268,41 +270,50 @@ function trackDynamicDraftMode(expression: string) {\n     }\n \n     if (workUnitStore) {\n-      if (workUnitStore.type === 'prerender') {\n-        // dynamicIO Prerender\n-        const error = new Error(\n-          `Route ${store.route} used ${expression} without first calling \\`await connection()\\`. See more info here: https://nextjs.org/docs/messages/next-prerender-sync-headers`\n-        )\n-        abortAndThrowOnSynchronousRequestDataAccess(\n-          store.route,\n-          expression,\n-          error,\n-          workUnitStore\n-        )\n-      } else if (workUnitStore.type === 'prerender-ppr') {\n-        // PPR Prerender\n-        postponeWithTracking(\n-          store.route,\n-          expression,\n-          workUnitStore.dynamicTracking\n-        )\n-      } else if (workUnitStore.type === 'prerender-legacy') {\n-        // legacy Prerender\n-        workUnitStore.revalidate = 0\n-\n-        const err = new DynamicServerError(\n-          `Route ${store.route} couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`\n-        )\n-        store.dynamicUsageDescription = expression\n-        store.dynamicUsageStack = err.stack\n-\n-        throw err\n-      } else if (\n-        process.env.NODE_ENV === 'development' &&\n-        workUnitStore &&\n-        workUnitStore.type === 'request'\n-      ) {\n-        workUnitStore.usedDynamic = true\n+      switch (workUnitStore.type) {\n+        case 'prerender':\n+          // dynamicIO Prerender\n+          const error = new Error(\n+            `Route ${store.route} used ${expression} without first calling \\`await connection()\\`. See more info here: https://nextjs.org/docs/messages/next-prerender-sync-headers`\n+          )\n+          abortAndThrowOnSynchronousRequestDataAccess(\n+            store.route,\n+            expression,\n+            error,\n+            workUnitStore\n+          )\n+          break\n+        case 'prerender-client':\n+          const exportName = '`draftMode`'\n+          throw new InvariantError(\n+            `${exportName} must not be used within a client component. Next.js should be preventing ${exportName} from being included in client components statically, but did not in this case.`\n+          )\n+        case 'prerender-ppr':\n+          // PPR Prerender\n+          postponeWithTracking(\n+            store.route,\n+            expression,\n+            workUnitStore.dynamicTracking\n+          )\n+          break\n+        case 'prerender-legacy':\n+          // legacy Prerender\n+          workUnitStore.revalidate = 0\n+\n+          const err = new DynamicServerError(\n+            `Route ${store.route} couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`\n+          )\n+          store.dynamicUsageDescription = expression\n+          store.dynamicUsageStack = err.stack\n+\n+          throw err\n+        case 'request':\n+          if (process.env.NODE_ENV === 'development') {\n+            workUnitStore.usedDynamic = true\n+          }\n+          break\n+        default:\n+        // fallthrough\n       }\n     }\n   }"
        },
        {
            "sha": "840b72f45b0c474c41e9fc43172818e9a815327b",
            "filename": "packages/next/src/server/request/headers.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 24,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -20,6 +20,7 @@ import { makeHangingPromise } from '../dynamic-rendering-utils'\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n import { scheduleImmediate } from '../../lib/scheduler'\n import { isRequestAPICallableInsideAfter } from './utils'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n \n /**\n  * In this version of Next.js `headers()` returns a Promise however you can still reference the properties of the underlying Headers instance\n@@ -93,30 +94,40 @@ export function headers(): Promise<ReadonlyHeaders> {\n     }\n \n     if (workUnitStore) {\n-      if (workUnitStore.type === 'prerender') {\n-        // dynamicIO Prerender\n-        // We don't track dynamic access here because access will be tracked when you access\n-        // one of the properties of the headers object.\n-        return makeDynamicallyTrackedExoticHeaders(\n-          workStore.route,\n-          workUnitStore\n-        )\n-      } else if (workUnitStore.type === 'prerender-ppr') {\n-        // PPR Prerender (no dynamicIO)\n-        // We are prerendering with PPR. We need track dynamic access here eagerly\n-        // to keep continuity with how headers has worked in PPR without dynamicIO.\n-        // TODO consider switching the semantic to throw on property access instead\n-        postponeWithTracking(\n-          workStore.route,\n-          'headers',\n-          workUnitStore.dynamicTracking\n-        )\n-      } else if (workUnitStore.type === 'prerender-legacy') {\n-        // Legacy Prerender\n-        // We are in a legacy static generation mode while prerendering\n-        // We track dynamic access here so we don't need to wrap the headers in\n-        // individual property access tracking.\n-        throwToInterruptStaticGeneration('headers', workStore, workUnitStore)\n+      switch (workUnitStore.type) {\n+        case 'prerender':\n+          // dynamicIO Prerender\n+          // We don't track dynamic access here because access will be tracked when you access\n+          // one of the properties of the headers object.\n+          return makeDynamicallyTrackedExoticHeaders(\n+            workStore.route,\n+            workUnitStore\n+          )\n+        case 'prerender-client':\n+          const exportName = '`headers`'\n+          throw new InvariantError(\n+            `${exportName} must not be used within a client component. Next.js should be preventing ${exportName} from being included in client components statically, but did not in this case.`\n+          )\n+        case 'prerender-ppr':\n+          // PPR Prerender (no dynamicIO)\n+          // We are prerendering with PPR. We need track dynamic access here eagerly\n+          // to keep continuity with how headers has worked in PPR without dynamicIO.\n+          // TODO consider switching the semantic to throw on property access instead\n+          postponeWithTracking(\n+            workStore.route,\n+            'headers',\n+            workUnitStore.dynamicTracking\n+          )\n+          break\n+        case 'prerender-legacy':\n+          // Legacy Prerender\n+          // We are in a legacy static generation mode while prerendering\n+          // We track dynamic access here so we don't need to wrap the headers in\n+          // individual property access tracking.\n+          throwToInterruptStaticGeneration('headers', workStore, workUnitStore)\n+          break\n+        default:\n+        // fallthrough\n       }\n     }\n     // We fall through to the dynamic context below but we still track dynamic access"
        },
        {
            "sha": "707577c3f220690823d571e133fc38f2eb62bb9b",
            "filename": "packages/next/src/server/request/params.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 18,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -65,6 +65,7 @@ export function createParamsFromClient(\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n+      case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n@@ -88,6 +89,7 @@ export function createServerParamsForRoute(\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n+      case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n@@ -106,6 +108,7 @@ export function createServerParamsForServerSegment(\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n+      case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n@@ -121,7 +124,11 @@ export function createPrerenderParamsForClientSegment(\n   workStore: WorkStore\n ): Promise<Params> {\n   const prerenderStore = workUnitAsyncStorage.getStore()\n-  if (prerenderStore && prerenderStore.type === 'prerender') {\n+  if (\n+    prerenderStore &&\n+    (prerenderStore.type === 'prerender' ||\n+      prerenderStore.type === 'prerender-client')\n+  ) {\n     const fallbackParams = workStore.fallbackRouteParams\n     if (fallbackParams) {\n       for (let key in underlyingParams) {\n@@ -157,24 +164,23 @@ function createPrerenderParams(\n \n     if (hasSomeFallbackParams) {\n       // params need to be treated as dynamic because we have at least one fallback param\n-      if (prerenderStore.type === 'prerender') {\n-        // We are in a dynamicIO (PPR or otherwise) prerender\n-        return makeAbortingExoticParams(\n-          underlyingParams,\n-          workStore.route,\n-          prerenderStore\n-        )\n+      switch (prerenderStore.type) {\n+        case 'prerender':\n+        case 'prerender-client':\n+          // We are in a dynamicIO prerender\n+          return makeAbortingExoticParams(\n+            underlyingParams,\n+            workStore.route,\n+            prerenderStore\n+          )\n+        default:\n+          return makeErroringExoticParams(\n+            underlyingParams,\n+            fallbackParams,\n+            workStore,\n+            prerenderStore\n+          )\n       }\n-      // remaining cases are prerender-ppr and prerender-legacy\n-      // We aren't in a dynamicIO prerender but we do have fallback params at this\n-      // level so we need to make an erroring exotic params object which will postpone\n-      // if you access the fallback params\n-      return makeErroringExoticParams(\n-        underlyingParams,\n-        fallbackParams,\n-        workStore,\n-        prerenderStore\n-      )\n     }\n   }\n "
        },
        {
            "sha": "cc2cb61d338c613124d66766b09498988a5f0973",
            "filename": "packages/next/src/server/request/pathname.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -10,6 +10,7 @@ import {\n   type PrerenderStore,\n } from '../app-render/work-unit-async-storage.external'\n import { makeHangingPromise } from '../dynamic-rendering-utils'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n \n export function createServerPathnameForMetadata(\n   underlyingPathname: string,\n@@ -19,6 +20,7 @@ export function createServerPathnameForMetadata(\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n+      case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy': {\n         return createPrerenderPathname(\n@@ -47,6 +49,10 @@ function createPrerenderPathname(\n           prerenderStore.renderSignal,\n           '`pathname`'\n         )\n+      case 'prerender-client':\n+        throw new InvariantError(\n+          'createPrerenderPathname was called inside a client component scope.'\n+        )\n       case 'prerender-ppr':\n         return makeErroringPathname(workStore, prerenderStore.dynamicTracking)\n         break"
        },
        {
            "sha": "3d004f268b1ca972f06fcbc83d089705f04885e1",
            "filename": "packages/next/src/server/request/root-params.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 22,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -46,6 +46,7 @@ export async function unstable_rootParams(): Promise<Params> {\n       )\n     }\n     case 'prerender':\n+    case 'prerender-client':\n     case 'prerender-ppr':\n     case 'prerender-legacy':\n       return createPrerenderRootParams(\n@@ -75,31 +76,38 @@ function createPrerenderRootParams(\n \n     if (hasSomeFallbackParams) {\n       // params need to be treated as dynamic because we have at least one fallback param\n-      if (prerenderStore.type === 'prerender') {\n-        // We are in a dynamicIO (PPR or otherwise) prerender\n-        const cachedParams = CachedParams.get(underlyingParams)\n-        if (cachedParams) {\n-          return cachedParams\n-        }\n+      switch (prerenderStore.type) {\n+        case 'prerender':\n+          // We are in a dynamicIO prerender\n+          const cachedParams = CachedParams.get(underlyingParams)\n+          if (cachedParams) {\n+            return cachedParams\n+          }\n \n-        const promise = makeHangingPromise<Params>(\n-          prerenderStore.renderSignal,\n-          '`unstable_rootParams`'\n-        )\n-        CachedParams.set(underlyingParams, promise)\n+          const promise = makeHangingPromise<Params>(\n+            prerenderStore.renderSignal,\n+            '`unstable_rootParams`'\n+          )\n+          CachedParams.set(underlyingParams, promise)\n \n-        return promise\n+          return promise\n+        case 'prerender-client':\n+          const exportName = '`unstable_rootParams`'\n+          throw new InvariantError(\n+            `${exportName} must not be used within a client component. Next.js should be preventing ${exportName} from being included in client components statically, but did not in this case.`\n+          )\n+        default:\n+          // remaining cases are prerender-ppr and prerender-legacy\n+          // We aren't in a dynamicIO prerender but we do have fallback params at this\n+          // level so we need to make an erroring params object which will postpone\n+          // if you access the fallback params\n+          return makeErroringRootParams(\n+            underlyingParams,\n+            fallbackParams,\n+            workStore,\n+            prerenderStore\n+          )\n       }\n-      // remaining cases are prerender-ppr and prerender-legacy\n-      // We aren't in a dynamicIO prerender but we do have fallback params at this\n-      // level so we need to make an erroring params object which will postpone\n-      // if you access the fallback params\n-      return makeErroringRootParams(\n-        underlyingParams,\n-        fallbackParams,\n-        workStore,\n-        prerenderStore\n-      )\n     }\n   }\n "
        },
        {
            "sha": "f081e2da90fa33918daa90cb521ed897d9d9f9b7",
            "filename": "packages/next/src/server/request/search-params.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 9,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -69,6 +69,7 @@ export function createSearchParamsFromClient(\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n+      case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderSearchParams(workStore, workUnitStore)\n@@ -91,6 +92,7 @@ export function createServerSearchParamsForServerPage(\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n+      case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderSearchParams(workStore, workUnitStore)\n@@ -111,7 +113,11 @@ export function createPrerenderSearchParamsForClientPage(\n   }\n \n   const prerenderStore = workUnitAsyncStorage.getStore()\n-  if (prerenderStore && prerenderStore.type === 'prerender') {\n+  if (\n+    prerenderStore &&\n+    (prerenderStore.type === 'prerender' ||\n+      prerenderStore.type === 'prerender-client')\n+  ) {\n     // dynamicIO Prerender\n     // We're prerendering in a mode that aborts (dynamicIO) and should stall\n     // the promise to ensure the RSC side is considered dynamic\n@@ -133,15 +139,17 @@ function createPrerenderSearchParams(\n     return Promise.resolve({})\n   }\n \n-  if (prerenderStore.type === 'prerender') {\n-    // We are in a dynamicIO (PPR or otherwise) prerender\n-    return makeAbortingExoticSearchParams(workStore.route, prerenderStore)\n+  switch (prerenderStore.type) {\n+    case 'prerender':\n+    case 'prerender-client':\n+      // We are in a dynamicIO (PPR or otherwise) prerender\n+      return makeAbortingExoticSearchParams(workStore.route, prerenderStore)\n+    default:\n+      // The remaining cases are prerender-ppr and prerender-legacy\n+      // We are in a legacy static generation and need to interrupt the prerender\n+      // when search params are accessed.\n+      return makeErroringExoticSearchParams(workStore, prerenderStore)\n   }\n-\n-  // The remaining cases are prerender-ppr and prerender-legacy\n-  // We are in a legacy static generation and need to interrupt the prerender\n-  // when search params are accessed.\n-  return makeErroringExoticSearchParams(workStore, prerenderStore)\n }\n \n function createRenderSearchParams("
        },
        {
            "sha": "c63cadc92a7813e445c372953c1d8b36fb49d55b",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -1132,7 +1132,7 @@ function createDynamicIOError(route: string) {\n   )\n }\n \n-export function trackDynamic(\n+function trackDynamic(\n   store: WorkStore,\n   workUnitStore: undefined | WorkUnitStore,\n   expression: string"
        },
        {
            "sha": "6a56ca7b26b9f1fd7171490796a4d4986aa4bdaf",
            "filename": "packages/next/src/server/web/spec-extension/revalidate.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 35,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -10,6 +10,7 @@ import {\n import { workAsyncStorage } from '../../app-render/work-async-storage.external'\n import { workUnitAsyncStorage } from '../../app-render/work-unit-async-storage.external'\n import { DynamicServerError } from '../../../client/components/hooks-server-context'\n+import { InvariantError } from '../../../shared/lib/invariant-error'\n \n /**\n  * This function allows you to purge [cached data](https://nextjs.org/docs/app/building-your-application/caching) on-demand for a specific cache tag.\n@@ -107,41 +108,49 @@ function revalidate(tags: string[], expression: string) {\n       )\n     }\n \n-    if (workUnitStore.type === 'prerender') {\n-      // dynamicIO Prerender\n-      const error = new Error(\n-        `Route ${store.route} used ${expression} without first calling \\`await connection()\\`.`\n-      )\n-      abortAndThrowOnSynchronousRequestDataAccess(\n-        store.route,\n-        expression,\n-        error,\n-        workUnitStore\n-      )\n-    } else if (workUnitStore.type === 'prerender-ppr') {\n-      // PPR Prerender\n-      postponeWithTracking(\n-        store.route,\n-        expression,\n-        workUnitStore.dynamicTracking\n-      )\n-    } else if (workUnitStore.type === 'prerender-legacy') {\n-      // legacy Prerender\n-      workUnitStore.revalidate = 0\n-\n-      const err = new DynamicServerError(\n-        `Route ${store.route} couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`\n-      )\n-      store.dynamicUsageDescription = expression\n-      store.dynamicUsageStack = err.stack\n-\n-      throw err\n-    } else if (\n-      process.env.NODE_ENV === 'development' &&\n-      workUnitStore &&\n-      workUnitStore.type === 'request'\n-    ) {\n-      workUnitStore.usedDynamic = true\n+    switch (workUnitStore.type) {\n+      case 'prerender':\n+        // dynamicIO Prerender\n+        const error = new Error(\n+          `Route ${store.route} used ${expression} without first calling \\`await connection()\\`.`\n+        )\n+        abortAndThrowOnSynchronousRequestDataAccess(\n+          store.route,\n+          expression,\n+          error,\n+          workUnitStore\n+        )\n+        break\n+      case 'prerender-client':\n+        throw new InvariantError(\n+          `${expression} must not be used within a client component. Next.js should be preventing ${expression} from being included in client components statically, but did not in this case.`\n+        )\n+      case 'prerender-ppr':\n+        // PPR Prerender\n+        postponeWithTracking(\n+          store.route,\n+          expression,\n+          workUnitStore.dynamicTracking\n+        )\n+        break\n+      case 'prerender-legacy':\n+        // legacy Prerender\n+        workUnitStore.revalidate = 0\n+\n+        const err = new DynamicServerError(\n+          `Route ${store.route} couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`\n+        )\n+        store.dynamicUsageDescription = expression\n+        store.dynamicUsageStack = err.stack\n+\n+        throw err\n+      case 'request':\n+        if (process.env.NODE_ENV === 'development') {\n+          workUnitStore.usedDynamic = true\n+        }\n+        break\n+      default:\n+      // fallthrough\n     }\n   }\n "
        },
        {
            "sha": "c769aa9cc46b9048d06851bbc2933f346a0b35ca",
            "filename": "packages/next/src/server/web/spec-extension/unstable-no-store.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-no-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a2cc0734a456e6cdc5076d16c63039d550f193fa/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-no-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-no-store.ts?ref=a2cc0734a456e6cdc5076d16c63039d550f193fa",
            "patch": "@@ -30,10 +30,16 @@ export function unstable_noStore() {\n     return\n   } else {\n     store.isUnstableNoStore = true\n-    if (workUnitStore && workUnitStore.type === 'prerender') {\n-      // unstable_noStore() is a noop in Dynamic I/O.\n-    } else {\n-      markCurrentScopeAsDynamic(store, workUnitStore, callingExpression)\n+    if (workUnitStore) {\n+      switch (workUnitStore.type) {\n+        case 'prerender':\n+        case 'prerender-client':\n+          // unstable_noStore() is a noop in Dynamic I/O.\n+          return\n+        default:\n+        // fallthrough\n+      }\n     }\n+    markCurrentScopeAsDynamic(store, workUnitStore, callingExpression)\n   }\n }"
        }
    ],
    "stats": {
        "total": 577,
        "additions": 351,
        "deletions": 226
    }
}