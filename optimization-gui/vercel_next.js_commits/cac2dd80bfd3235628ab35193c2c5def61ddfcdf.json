{
    "author": "eps1lon",
    "message": "[test] Disallow custom `RegExp`-like implementations in `check` (#85537)",
    "sha": "cac2dd80bfd3235628ab35193c2c5def61ddfcdf",
    "files": [
        {
            "sha": "54023d03f5e236640edc62346206b895c9b987d8",
            "filename": "test/e2e/basepath/basepath.test.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 22,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts?ref=cac2dd80bfd3235628ab35193c2c5def61ddfcdf",
            "patch": "@@ -126,33 +126,26 @@ describe('basePath', () => {\n           '/gssp'\n         )\n \n-        await check(\n-          async () => {\n-            const links = await browser.elementsByCss('link[rel=prefetch]')\n-\n-            for (const link of links) {\n-              const href = await link.getAttribute('href')\n-              if (href.includes(chunk)) {\n-                return true\n-              }\n+        await check(async () => {\n+          const links = await browser.elementsByCss('link[rel=prefetch]')\n+\n+          for (const link of links) {\n+            const href = await link.getAttribute('href')\n+            if (href.includes(chunk)) {\n+              return true\n             }\n+          }\n \n-            const scripts = await browser.elementsByCss('script')\n+          const scripts = await browser.elementsByCss('script')\n \n-            for (const script of scripts) {\n-              const src = await script.getAttribute('src')\n-              if (src.includes(chunk)) {\n-                return true\n-              }\n+          for (const script of scripts) {\n+            const src = await script.getAttribute('src')\n+            if (src.includes(chunk)) {\n+              return true\n             }\n-            return false\n-          },\n-          {\n-            test(result) {\n-              return result === true\n-            },\n           }\n-        )\n+          return false\n+        }, true)\n       })\n \n       it('should prefetch pages correctly in viewport with <Link>', async () => {"
        },
        {
            "sha": "30156362e6261b1005128b22c1ee08927eeab4e6",
            "filename": "test/e2e/basepath/error-pages.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Fbasepath%2Ferror-pages.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Fbasepath%2Ferror-pages.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbasepath%2Ferror-pages.test.ts?ref=cac2dd80bfd3235628ab35193c2c5def61ddfcdf",
            "patch": "@@ -1,6 +1,6 @@\n import webdriver from 'next-webdriver'\n import { nextTestSetup } from 'e2e-utils'\n-import { check, renderViaHTTP } from 'next-test-utils'\n+import { check, renderViaHTTP, retry } from 'next-test-utils'\n \n describe('basePath', () => {\n   const basePath = '/docs'\n@@ -121,10 +121,8 @@ describe('basePath', () => {\n       await browser.eval('window.beforeNav = \"hi\"')\n       await browser.elementByCss('#other-page-link').click()\n \n-      await check(() => browser.eval('window.beforeNav'), {\n-        test(content) {\n-          return content !== 'hi'\n-        },\n+      await retry(async () => {\n+        expect(await browser.eval('window.beforeNav')).not.toEqual('hi')\n       })\n \n       await check(\n@@ -138,10 +136,8 @@ describe('basePath', () => {\n       await browser.eval('window.beforeNav = \"hi\"')\n       await browser.eval(`window.next.router.push(\"${basePath}/other-page\")`)\n \n-      await check(() => browser.eval('window.beforeNav'), {\n-        test(content) {\n-          return content !== 'hi'\n-        },\n+      await retry(async () => {\n+        expect(await browser.eval('window.beforeNav')).not.toEqual('hi')\n       })\n \n       const html = await browser.eval('document.documentElement.innerHTML')\n@@ -153,10 +149,8 @@ describe('basePath', () => {\n       await browser.eval('window.beforeNav = \"hi\"')\n       await browser.eval(`window.next.router.replace(\"${basePath}/other-page\")`)\n \n-      await check(() => browser.eval('window.beforeNav'), {\n-        test(content) {\n-          return content !== 'hi'\n-        },\n+      await retry(async () => {\n+        expect(await browser.eval('window.beforeNav')).not.toEqual('hi')\n       })\n \n       const html = await browser.eval('document.documentElement.innerHTML')"
        },
        {
            "sha": "63b2253d1bf9cf90bde7326ff552c09a35e96623",
            "filename": "test/e2e/getserversideprops/test/index.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Fgetserversideprops%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Fgetserversideprops%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fgetserversideprops%2Ftest%2Findex.test.ts?ref=cac2dd80bfd3235628ab35193c2c5def61ddfcdf",
            "patch": "@@ -638,13 +638,9 @@ const runTests = (isDev = false, isDeploy = false) => {\n     await waitFor(500)\n     await browser.eval('window.beforeClick = \"abc\"')\n     await browser.elementByCss('#broken-post').click()\n-    expect(\n-      await check(() => browser.eval('window.beforeClick'), {\n-        test(v) {\n-          return v !== 'abc'\n-        },\n-      })\n-    ).toBe(true)\n+    await retry(async () => {\n+      expect(await browser.eval('window.beforeClick')).not.toEqual('abc')\n+    })\n   })\n \n   it('should always call getServerSideProps without caching', async () => {"
        },
        {
            "sha": "955987ee4f397d4c73e7c9f23f6b1df2a77fcf3b",
            "filename": "test/e2e/link-with-api-rewrite/index.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Flink-with-api-rewrite%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Flink-with-api-rewrite%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Flink-with-api-rewrite%2Findex.test.ts?ref=cac2dd80bfd3235628ab35193c2c5def61ddfcdf",
            "patch": "@@ -1,6 +1,6 @@\n import { createNext, FileRef } from 'e2e-utils'\n import { NextInstance } from 'e2e-utils'\n-import { check } from 'next-test-utils'\n+import { retry } from 'next-test-utils'\n import { join } from 'path'\n import webdriver from 'next-webdriver'\n \n@@ -27,8 +27,8 @@ describe('link-with-api-rewrite', () => {\n       // unset).\n       await browser.eval('window.beforeNav = \"hi\"')\n       await browser.elementById('rewrite').click()\n-      await check(() => browser.eval('window.beforeNav'), {\n-        test: (content) => content !== 'hi',\n+      await retry(async () => {\n+        expect(await browser.eval('window.beforeNav')).not.toEqual('hi')\n       })\n \n       // Check to see that we were in fact navigated to the correct page.\n@@ -54,8 +54,8 @@ describe('link-with-api-rewrite', () => {\n       // unset).\n       await browser.eval('window.beforeNav = \"hi\"')\n       await browser.elementById('direct').click()\n-      await check(() => browser.eval('window.beforeNav'), {\n-        test: (content) => content !== 'hi',\n+      await retry(async () => {\n+        expect(await browser.eval('window.beforeNav')).not.toEqual('hi')\n       })\n \n       // Check to see that we were in fact navigated to the correct page."
        },
        {
            "sha": "a7eb74944f2a47b54bb86855000e1ede38094ccb",
            "filename": "test/e2e/prerender.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 14,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Fprerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Fe2e%2Fprerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender.test.ts?ref=cac2dd80bfd3235628ab35193c2c5def61ddfcdf",
            "patch": "@@ -772,13 +772,9 @@ describe('Prerender', () => {\n       const browser = await webdriver(next.url, '/')\n       await browser.eval('window.beforeClick = \"abc\"')\n       await browser.elementByCss('#broken-post').click()\n-      expect(\n-        await check(() => browser.eval('window.beforeClick'), {\n-          test(v) {\n-            return v !== 'abc'\n-          },\n-        })\n-      ).toBe(true)\n+      await retry(async () => {\n+        expect(await browser.eval('window.beforeClick')).not.toEqual('abc')\n+      })\n     })\n \n     it('should SSR dynamic page with brackets in param as object', async () => {\n@@ -906,13 +902,9 @@ describe('Prerender', () => {\n         const browser = await webdriver(next.url, '/')\n         await browser.eval('window.beforeClick = \"abc\"')\n         await browser.elementByCss('#broken-at-first-post').click()\n-        expect(\n-          await check(() => browser.eval('window.beforeClick'), {\n-            test(v) {\n-              return v !== 'abc'\n-            },\n-          })\n-        ).toBe(true)\n+        await retry(async () => {\n+          expect(await browser.eval('window.beforeClick')).not.toEqual('abc')\n+        })\n \n         const text = await browser.elementByCss('#params').text()\n         expect(text).toMatch(/post.*?post-999/)"
        },
        {
            "sha": "47617dab304b84eb8a5ddb23cb247753b2c14c2a",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/cac2dd80bfd3235628ab35193c2c5def61ddfcdf/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=cac2dd80bfd3235628ab35193c2c5def61ddfcdf",
            "patch": "@@ -700,7 +700,7 @@ export async function startCleanStaticServer(dir: string) {\n  */\n export async function check(\n   contentFn: () => unknown | Promise<unknown>,\n-  regex: any\n+  regex: boolean | number | string | RegExp\n ): Promise<boolean> {\n   let content: unknown\n   let lastErr: unknown\n@@ -712,7 +712,7 @@ export async function check(\n         if (regex === content) {\n           return true\n         }\n-      } else if (regex.test(content)) {\n+      } else if (regex.test('' + content)) {\n         // found the content\n         return true\n       }"
        }
    ],
    "stats": {
        "total": 101,
        "additions": 38,
        "deletions": 63
    }
}