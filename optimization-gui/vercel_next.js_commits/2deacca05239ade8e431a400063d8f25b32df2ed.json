{
    "author": "eps1lon",
    "message": "[devtools] Move ShadowRoot into context (#82296)\n\nOur shadow root was always defined but each callsite guarded against the portal and therefore the shadow root not being defined.\r\nThis caution also required authoring cascading updates.\r\n\r\nAll of this is not required. We just expose the ShadowRoot in context so that everybody can use it directly.",
    "sha": "2deacca05239ade8e431a400063d8f25b32df2ed",
    "files": [
        {
            "sha": "52b15f6438c8220cf7849569c9f520759ec2a972",
            "filename": "packages/next/.storybook/preview-body.html",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2F.storybook%2Fpreview-body.html",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2F.storybook%2Fpreview-body.html",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2F.storybook%2Fpreview-body.html?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -0,0 +1 @@\n+<nextjs-portal></nextjs-portal>"
        },
        {
            "sha": "fc22e275a47427f0f0cd81d17747fbf5b35eee58",
            "filename": "packages/next/.storybook/preview.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 22,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2F.storybook%2Fpreview.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2F.storybook%2Fpreview.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2F.storybook%2Fpreview.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -1,19 +1,8 @@\n import type { Preview } from '@storybook/react'\n-import { useInsertionEffect } from 'react'\n import { withDevOverlayContexts } from '../src/next-devtools/dev-overlay/storybook/with-dev-overlay-contexts'\n \n-function CreatePortalNode() {\n-  useInsertionEffect(() => {\n-    const portalNode = document.createElement('nextjs-portal')\n-    document.body.appendChild(portalNode)\n-\n-    return () => {\n-      document.body.removeChild(portalNode)\n-    }\n-  })\n-\n-  return null\n-}\n+const portalNode = document.querySelector('nextjs-portal')!\n+const shadowRoot = portalNode.attachShadow({ mode: 'open' })\n \n const preview: Preview = {\n   parameters: {\n@@ -63,15 +52,7 @@ const preview: Preview = {\n       manual: true,\n     },\n   },\n-  decorators: [\n-    withDevOverlayContexts(),\n-    (Story) => (\n-      <>\n-        <CreatePortalNode />\n-        <Story />\n-      </>\n-    ),\n-  ],\n+  decorators: [withDevOverlayContexts({ shadowRoot })],\n }\n \n export default preview"
        },
        {
            "sha": "a57ac0b0f4d53c810262fdf938cac9e747fb8d5a",
            "filename": "packages/next/src/next-devtools/dev-overlay.browser.tsx",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -28,6 +28,7 @@ import {\n   startTransition,\n   useContext,\n   useInsertionEffect,\n+  useLayoutEffect,\n   type ActionDispatch,\n } from 'react'\n import { createRoot } from 'react-dom/client'\n@@ -189,18 +190,34 @@ function DevOverlayRoot({\n   getSquashedHydrationErrorDetails,\n   isRecoverableError,\n   routerType,\n+  shadowRoot,\n }: {\n   getOwnerStack: (error: Error) => string | null | undefined\n   getSquashedHydrationErrorDetails: (error: Error) => HydrationErrorState | null\n   isRecoverableError: (error: Error) => boolean\n   routerType: 'app' | 'pages'\n+  shadowRoot: ShadowRoot\n }) {\n   const [state, dispatch] = useErrorOverlayReducer(\n     routerType,\n     getOwnerStack,\n     isRecoverableError\n   )\n \n+  useLayoutEffect(() => {\n+    const portalNode = shadowRoot.host\n+    if (state.theme === 'dark') {\n+      portalNode.classList.add('dark')\n+      portalNode.classList.remove('light')\n+    } else if (state.theme === 'light') {\n+      portalNode.classList.add('light')\n+      portalNode.classList.remove('dark')\n+    } else {\n+      portalNode.classList.remove('dark')\n+      portalNode.classList.remove('light')\n+    }\n+  }, [shadowRoot, state.theme])\n+\n   useInsertionEffect(() => {\n     maybeDispatch = dispatch\n \n@@ -225,6 +242,7 @@ function DevOverlayRoot({\n         value={{\n           dispatch,\n           getSquashedHydrationErrorDetails,\n+          shadowRoot,\n           state,\n         }}\n       >\n@@ -234,6 +252,7 @@ function DevOverlayRoot({\n   )\n }\n export const DevOverlayContext = createContext<{\n+  shadowRoot: ShadowRoot\n   state: OverlayState & {\n     routerType: 'pages' | 'app'\n   }\n@@ -284,6 +303,8 @@ export function renderAppDevOverlay(\n       identifierPrefix: 'ndt-',\n     })\n \n+    const shadowRoot = container.attachShadow({ mode: 'open' })\n+\n     startTransition(() => {\n       // TODO: Dedicated error boundary or root error callbacks?\n       // At least it won't unmount any user code if it errors.\n@@ -293,6 +314,7 @@ export function renderAppDevOverlay(\n           getSquashedHydrationErrorDetails={getSquashedHydrationErrorDetailsApp}\n           isRecoverableError={isRecoverableError}\n           routerType=\"app\"\n+          shadowRoot={shadowRoot}\n         />\n       )\n     })\n@@ -344,7 +366,9 @@ export function renderPagesDevOverlay(\n     })\n     document.body.appendChild(container)\n \n-    const root = createRoot(container)\n+    const root = createRoot(container, { identifierPrefix: 'ndt-' })\n+\n+    const shadowRoot = container.attachShadow({ mode: 'open' })\n \n     startTransition(() => {\n       // TODO: Dedicated error boundary or root error callbacks?\n@@ -355,6 +379,7 @@ export function renderPagesDevOverlay(\n           getSquashedHydrationErrorDetails={getSquashedHydrationErrorDetails}\n           isRecoverableError={isRecoverableError}\n           routerType=\"pages\"\n+          shadowRoot={shadowRoot}\n         />\n       )\n     })"
        },
        {
            "sha": "07a91c99d4104c769e8a0d466fd57360da79c621",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/dialog/dialog.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdialog%2Fdialog.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdialog%2Fdialog.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdialog%2Fdialog.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -29,6 +29,7 @@ const Dialog: React.FC<DialogProps> = function Dialog({\n   ...props\n }) {\n   const dialogRef = React.useRef<HTMLDivElement | null>(null)\n+  // TODO: Document is an external store. Either use useSyncExternalStore or always set the role.\n   const [role, setRole] = React.useState<string | undefined>(\n     typeof document !== 'undefined' && document.hasFocus()\n       ? 'dialog'"
        },
        {
            "sha": "238275888998683c7eed02bf2c11e5b385dd540d",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/dev-tools-info/user-preferences.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-info%2Fuser-preferences.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -4,6 +4,7 @@ import type {\n   DevToolsScale,\n } from '../../../../shared'\n \n+import { useDevOverlayContext } from '../../../../../dev-overlay.browser'\n import { css } from '../../../../utils/css'\n import EyeIcon from '../../../../icons/eye-icon'\n import { NEXT_DEV_TOOLS_SCALE } from '../../../../shared'\n@@ -73,13 +74,10 @@ export function UserPreferencesBody({\n   setScale: (value: DevToolsScale) => void\n }) {\n   const { restartServer, isPending } = useRestartServer()\n+  const { shadowRoot } = useDevOverlayContext()\n \n   const handleThemeChange = (e: React.ChangeEvent<HTMLSelectElement>) => {\n-    const portal = document.querySelector('nextjs-portal')\n-    if (!portal) {\n-      return\n-    }\n-\n+    const portal = shadowRoot.host\n     if (e.target.value === 'system') {\n       portal.classList.remove('dark')\n       portal.classList.remove('light')"
        },
        {
            "sha": "261d528840e668a52505ce578dfeda3e9fc47ec2",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Futils.ts?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -1,10 +1,5 @@\n import { useEffect } from 'react'\n \n-export const getShadowRoot = () => {\n-  const portal = document.querySelector('nextjs-portal')\n-  return portal?.shadowRoot\n-}\n-\n export function useFocusTrap(\n   rootRef: React.RefObject<HTMLElement | null>,\n   triggerRef: React.RefObject<HTMLButtonElement | null> | null,"
        },
        {
            "sha": "6c27b607b07440e43a8c867e7cb2d0ba91862a10",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-boundary-trigger.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-boundary-trigger.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -1,6 +1,7 @@\n import './segment-boundary-trigger.css'\n import { useCallback, useState, useRef, useMemo } from 'react'\n import { Menu } from '@base-ui-components/react/menu'\n+import { useDevOverlayContext } from '../../../dev-overlay.browser'\n import type {\n   SegmentBoundaryType,\n   SegmentNodeState,\n@@ -31,12 +32,7 @@ export function SegmentBoundaryTrigger({\n   const { pagePath, boundaryType, setBoundaryType: onSelectBoundary } = currNode\n \n   const [isOpen, setIsOpen] = useState(false)\n-  // TODO: move this shadowRoot ref util to a shared hook or into context\n-  const [shadowRoot] = useState<ShadowRoot>(() => {\n-    const ownerDocument = document\n-    const portalNode = ownerDocument.querySelector('nextjs-portal')!\n-    return portalNode.shadowRoot! as ShadowRoot\n-  })\n+  const { shadowRoot } = useDevOverlayContext()\n   const triggerRef = useRef<HTMLButtonElement>(null)\n   const popupRef = useRef<HTMLDivElement>(null)\n "
        },
        {
            "sha": "4a3fd9c37cb1827a35ae112d379404df06fae38b",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/shadow-portal.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 38,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fshadow-portal.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fshadow-portal.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fshadow-portal.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -1,44 +1,8 @@\n-import * as React from 'react'\n import { createPortal } from 'react-dom'\n import { useDevOverlayContext } from '../../dev-overlay.browser'\n \n export function ShadowPortal({ children }: { children: React.ReactNode }) {\n-  const { state } = useDevOverlayContext()\n-  let portalNode = React.useRef<HTMLElement | null>(null)\n-  let shadowNode = React.useRef<ShadowRoot | null>(null)\n-  let [, forceUpdate] = React.useState<{} | undefined>()\n+  const { shadowRoot } = useDevOverlayContext()\n \n-  // Don't use useLayoutEffect here, as it will cause warnings during SSR in React 18.\n-  // Don't use useSyncExternalStore as an SSR gate unless you verified it doesn't\n-  // downgrade a Transition of the initial root render to a sync render or\n-  // we can assure the root render is not a Transition.\n-  React.useEffect(() => {\n-    const ownerDocument = document\n-    portalNode.current = ownerDocument.querySelector('nextjs-portal')!\n-\n-    if (state.theme === 'dark') {\n-      portalNode.current.classList.add('dark')\n-      portalNode.current.classList.remove('light')\n-    } else if (state.theme === 'light') {\n-      portalNode.current.classList.add('light')\n-      portalNode.current.classList.remove('dark')\n-    } else {\n-      portalNode.current.classList.remove('dark')\n-      portalNode.current.classList.remove('light')\n-    }\n-\n-    // We can only attach but never detach a shadow root.\n-    // So if this is a remount, we don't need to attach a shadow root. Only\n-    // on the very first, DOM-wide mount.\n-    // This is mostly guarding against faulty _app implementations that\n-    // create React Root in getInitialProps but don't clean it up like test/integration/app-tree/pages/_app.tsx\n-    if (portalNode.current.shadowRoot === null) {\n-      shadowNode.current = portalNode.current.attachShadow({ mode: 'open' })\n-    }\n-    forceUpdate({})\n-  }, [state.theme])\n-\n-  // eslint-disable-next-line react-hooks/react-compiler -- TODO\n-  const shadowRoot = shadowNode.current\n-  return shadowRoot ? createPortal(children, shadowRoot as any) : null\n+  return createPortal(children, shadowRoot)\n }"
        },
        {
            "sha": "f605fb5f6d4f05a067d621fcd57e0d0d2d66cb32",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/tooltip/tooltip.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ftooltip%2Ftooltip.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ftooltip%2Ftooltip.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ftooltip%2Ftooltip.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -1,5 +1,6 @@\n-import { forwardRef, useState } from 'react'\n+import { forwardRef } from 'react'\n import { Tooltip as BaseTooltip } from '@base-ui-components/react/tooltip'\n+import { useDevOverlayContext } from '../../../dev-overlay.browser'\n import { cx } from '../../utils/cx'\n import './tooltip.css'\n \n@@ -26,11 +27,7 @@ export const Tooltip = forwardRef<HTMLDivElement, TooltipProps>(\n     },\n     ref\n   ) {\n-    const [shadowRoot] = useState<ShadowRoot>(() => {\n-      const ownerDocument = document\n-      const portalNode = ownerDocument.querySelector('nextjs-portal')!\n-      return portalNode.shadowRoot! as ShadowRoot\n-    })\n+    const { shadowRoot } = useDevOverlayContext()\n     if (!title) {\n       return children\n     }"
        },
        {
            "sha": "11e6e573f4ba3fbe140f815a113f78a5dc1e1278",
            "filename": "packages/next/src/next-devtools/dev-overlay/dev-overlay.stories.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fdev-overlay.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fdev-overlay.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fdev-overlay.stories.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -10,7 +10,7 @@ import {\n   storybookDefaultOverlayState,\n   useStorybookOverlayReducer,\n } from './storybook/use-overlay-reducer'\n-import { DevOverlayContext } from '../dev-overlay.browser'\n+import { DevOverlayContext, useDevOverlayContext } from '../dev-overlay.browser'\n \n const meta: Meta<typeof DevOverlay> = {\n   component: DevOverlay,\n@@ -46,6 +46,7 @@ const initialState: OverlayState = {\n export const Default: Story = {\n   render: function DevOverlayStory() {\n     const [state, dispatch] = useStorybookOverlayReducer(initialState)\n+    const { shadowRoot } = useDevOverlayContext()\n     return (\n       <div\n         style={{\n@@ -67,6 +68,7 @@ export const Default: Story = {\n             dispatch,\n             getSquashedHydrationErrorDetails:\n               getNoSquashedHydrationErrorDetails,\n+            shadowRoot,\n             state,\n           }}\n         >\n@@ -81,6 +83,7 @@ export const Default: Story = {\n export const WithPanel: Story = {\n   render: function DevOverlayStory() {\n     const [state, dispatch] = useStorybookOverlayReducer(initialState)\n+    const { shadowRoot } = useDevOverlayContext()\n     return (\n       <>\n         <img\n@@ -96,6 +99,7 @@ export const WithPanel: Story = {\n             dispatch,\n             getSquashedHydrationErrorDetails:\n               getNoSquashedHydrationErrorDetails,\n+            shadowRoot,\n             state,\n           }}\n         >"
        },
        {
            "sha": "902de23fc2fda3011b4a51d04d5c413ba6ca7e8f",
            "filename": "packages/next/src/next-devtools/dev-overlay/menu/panel-router.tsx",
            "status": "modified",
            "additions": 14,
            "deletions": 17,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fpanel-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fpanel-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fmenu%2Fpanel-router.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -10,7 +10,6 @@ import { TurbopackInfoBody } from '../components/errors/dev-tools-indicator/dev-\n import { DevToolsHeader } from '../components/errors/dev-tools-indicator/dev-tools-info/dev-tools-header'\n import { useDelayedRender } from '../hooks/use-delayed-render'\n import {\n-  getShadowRoot,\n   MENU_CURVE,\n   MENU_DURATION_MS,\n } from '../components/errors/dev-tools-indicator/utils'\n@@ -110,29 +109,27 @@ const MenuPanel = () => {\n \n // a little hacky but it does the trick\n const useToggleDevtoolsVisibility = () => {\n-  const { state, dispatch } = useDevOverlayContext()\n+  const { state, dispatch, shadowRoot } = useDevOverlayContext()\n   return () => {\n     dispatch({\n       type: ACTION_DEV_INDICATOR_SET,\n       disabled: !state.disableDevIndicator,\n     })\n-    const portal = getShadowRoot()\n-    if (portal) {\n-      const menuElement = portal.getElementById('panel-route') as HTMLElement\n-      const indicatorElement = portal.getElementById(\n-        'data-devtools-indicator'\n-      ) as HTMLElement\n \n-      if (menuElement && menuElement.firstElementChild) {\n-        const firstChild = menuElement.firstElementChild as HTMLElement\n-        const isCurrentlyHidden = firstChild.style.display === 'none'\n-        firstChild.style.display = isCurrentlyHidden ? '' : 'none'\n-      }\n+    const menuElement = shadowRoot.getElementById('panel-route') as HTMLElement\n+    const indicatorElement = shadowRoot.getElementById(\n+      'data-devtools-indicator'\n+    ) as HTMLElement\n+\n+    if (menuElement && menuElement.firstElementChild) {\n+      const firstChild = menuElement.firstElementChild as HTMLElement\n+      const isCurrentlyHidden = firstChild.style.display === 'none'\n+      firstChild.style.display = isCurrentlyHidden ? '' : 'none'\n+    }\n \n-      if (indicatorElement) {\n-        const isCurrentlyHidden = indicatorElement.style.display === 'none'\n-        indicatorElement.style.display = isCurrentlyHidden ? '' : 'none'\n-      }\n+    if (indicatorElement) {\n+      const isCurrentlyHidden = indicatorElement.style.display === 'none'\n+      indicatorElement.style.display = isCurrentlyHidden ? '' : 'none'\n     }\n   }\n }"
        },
        {
            "sha": "97a783dca2f0b036918fc65c59db51ff367fdad9",
            "filename": "packages/next/src/next-devtools/dev-overlay/storybook/with-dev-overlay-contexts.tsx",
            "status": "modified",
            "additions": 24,
            "deletions": 11,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstorybook%2Fwith-dev-overlay-contexts.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2deacca05239ade8e431a400063d8f25b32df2ed/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstorybook%2Fwith-dev-overlay-contexts.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fstorybook%2Fwith-dev-overlay-contexts.tsx?ref=2deacca05239ade8e431a400063d8f25b32df2ed",
            "patch": "@@ -1,12 +1,15 @@\n import { useRef, useState, type Dispatch, type SetStateAction } from 'react'\n-import { DevOverlayContext } from '../../dev-overlay.browser'\n+import {\n+  DevOverlayContext,\n+  useDevOverlayContext,\n+} from '../../dev-overlay.browser'\n import { RenderErrorContext } from '../dev-overlay'\n import { PanelRouterContext, type PanelStateKind } from '../menu/context'\n import { INITIAL_OVERLAY_STATE } from '../shared'\n import type { OverlayState, DispatcherEvent } from '../shared'\n import type { ReadyRuntimeError } from '../utils/get-error-by-type'\n \n-interface WithDevOverlayContextsProps {\n+interface WithDevOverlayContextsOptions {\n   state?: Partial<OverlayState>\n   dispatch?: (action: DispatcherEvent) => void\n   runtimeErrors?: ReadyRuntimeError[]\n@@ -15,48 +18,58 @@ interface WithDevOverlayContextsProps {\n   setPanel?: Dispatch<SetStateAction<PanelStateKind | null>>\n   selectedIndex?: number\n   setSelectedIndex?: Dispatch<SetStateAction<number>>\n+  shadowRoot?: ShadowRoot\n }\n \n export const withDevOverlayContexts =\n-  (props?: WithDevOverlayContextsProps) => (Story: any) => {\n+  (options?: WithDevOverlayContextsOptions) => (Story: any) => {\n+    const parentContext = useDevOverlayContext()\n     const [panel, setPanel] = useState<PanelStateKind | null>(\n-      props?.panel ?? null\n+      options?.panel ?? null\n     )\n     const [selectedIndex, setSelectedIndex] = useState(\n-      props?.selectedIndex ?? -1\n+      options?.selectedIndex ?? -1\n     )\n     const triggerRef = useRef<HTMLButtonElement>(null)\n \n     const defaultState: OverlayState = {\n       ...INITIAL_OVERLAY_STATE,\n       routerType: 'app',\n       isErrorOverlayOpen: false,\n-      ...props?.state,\n+      ...options?.state,\n     }\n \n-    const defaultDispatch = props?.dispatch || (() => {})\n+    const defaultDispatch = options?.dispatch || (() => {})\n+\n+    const shadowRoot = options?.shadowRoot ?? parentContext?.shadowRoot\n+    if (shadowRoot == null) {\n+      throw new Error(\n+        '`options.shadowRoot` is required without a parent context'\n+      )\n+    }\n \n     return (\n       <DevOverlayContext.Provider\n         value={{\n           state: defaultState,\n           dispatch: defaultDispatch,\n           getSquashedHydrationErrorDetails: () => null,\n+          shadowRoot,\n         }}\n       >\n         <RenderErrorContext.Provider\n           value={{\n-            runtimeErrors: props?.runtimeErrors ?? [],\n-            totalErrorCount: props?.totalErrorCount ?? 0,\n+            runtimeErrors: options?.runtimeErrors ?? [],\n+            totalErrorCount: options?.totalErrorCount ?? 0,\n           }}\n         >\n           <PanelRouterContext.Provider\n             value={{\n               panel,\n-              setPanel: props?.setPanel ?? setPanel,\n+              setPanel: options?.setPanel ?? setPanel,\n               triggerRef,\n               selectedIndex,\n-              setSelectedIndex: props?.setSelectedIndex ?? setSelectedIndex,\n+              setSelectedIndex: options?.setSelectedIndex ?? setSelectedIndex,\n             }}\n           >\n             <Story />"
        }
    ],
    "stats": {
        "total": 196,
        "additions": 84,
        "deletions": 112
    }
}