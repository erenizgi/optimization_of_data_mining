{
    "author": "huozhi",
    "message": "[metadata] update metadata routes cache headers (#83215)",
    "sha": "d8e1aca88ccb079ded1d6c1e5ef0c3049b953236",
    "files": [
        {
            "sha": "eb16fcb3edabed562733bc61e97ee5618508899c",
            "filename": "crates/next-core/src/next_app/metadata/route.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs?ref=d8e1aca88ccb079ded1d6c1e5ef0c3049b953236",
            "patch": "@@ -112,7 +112,6 @@ pub async fn get_app_metadata_route_entry(\n }\n \n const CACHE_HEADER_NONE: &str = \"no-cache, no-store\";\n-const CACHE_HEADER_LONG_CACHE: &str = \"public, immutable, no-transform, max-age=31536000\";\n const CACHE_HEADER_REVALIDATE: &str = \"public, max-age=0, must-revalidate\";\n \n async fn get_base64_file_content(path: FileSystemPath) -> Result<String> {\n@@ -137,10 +136,8 @@ async fn static_route_source(mode: NextMode, path: FileSystemPath) -> Result<Vc<\n     let stem = path.file_stem();\n     let stem = stem.unwrap_or_default();\n \n-    let cache_control = if stem == \"favicon\" {\n+    let cache_control = if mode.is_production() {\n         CACHE_HEADER_REVALIDATE\n-    } else if mode.is_production() {\n-        CACHE_HEADER_LONG_CACHE\n     } else {\n         CACHE_HEADER_NONE\n     };"
        },
        {
            "sha": "7dab38c427507796117ff2d48628cc4cc5e94b7e",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-image-loader.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts?ref=d8e1aca88ccb079ded1d6c1e5ef0c3049b953236",
            "patch": "@@ -43,11 +43,7 @@ async function nextMetadataImageLoader(\n \n   const opts = { context, content }\n \n-  // No hash query for favicon.ico\n-  const contentHash =\n-    type === 'favicon'\n-      ? ''\n-      : loaderUtils.interpolateName(this, '[contenthash]', opts)\n+  const contentHash = loaderUtils.interpolateName(this, '[contenthash]', opts)\n \n   const interpolatedName = loaderUtils.interpolateName(\n     this,\n@@ -179,7 +175,7 @@ async function nextMetadataImageLoader(\n \n     return [{\n       ...imageData,\n-      url: imageUrl + ${JSON.stringify(type === 'favicon' ? '' : hashQuery)},\n+      url: imageUrl + ${JSON.stringify(hashQuery)},\n     }]\n   }`\n }"
        },
        {
            "sha": "9604182479043c254bf13f62702ae2de45ead035",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-route-loader.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 11,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts?ref=d8e1aca88ccb079ded1d6c1e5ef0c3049b953236",
            "patch": "@@ -35,10 +35,9 @@ async function createReExportsCode(\n     : ''\n }\n \n-const cacheHeader = {\n-  none: 'no-cache, no-store',\n-  longCache: 'public, immutable, no-transform, max-age=31536000',\n-  revalidate: 'public, max-age=0, must-revalidate',\n+const CACHE_HEADERS = {\n+  NO_CACHE: 'no-cache, no-store',\n+  REVALIDATE: 'public, max-age=0, must-revalidate',\n }\n \n export type MetadataRouteLoaderOptions = {\n@@ -77,11 +76,9 @@ async function getStaticAssetRouteCode(\n   fileBaseName: string\n ) {\n   const cache =\n-    fileBaseName === 'favicon'\n-      ? 'public, max-age=0, must-revalidate'\n-      : process.env.NODE_ENV !== 'production'\n-        ? cacheHeader.none\n-        : cacheHeader.longCache\n+    process.env.NODE_ENV !== 'production'\n+      ? CACHE_HEADERS.NO_CACHE\n+      : CACHE_HEADERS.REVALIDATE\n \n   const isTwitter = fileBaseName === 'twitter-image'\n   const isOpenGraph = fileBaseName === 'opengraph-image'\n@@ -149,7 +146,7 @@ export async function GET() {\n   return new NextResponse(content, {\n     headers: {\n       'Content-Type': contentType,\n-      'Cache-Control': ${JSON.stringify(cacheHeader.revalidate)},\n+      'Cache-Control': ${JSON.stringify(CACHE_HEADERS.REVALIDATE)},\n     },\n   })\n }\n@@ -271,7 +268,7 @@ export async function GET(_, ctx) {\n   return new NextResponse(content, {\n     headers: {\n       'Content-Type': contentType,\n-      'Cache-Control': ${JSON.stringify(cacheHeader.revalidate)},\n+      'Cache-Control': ${JSON.stringify(CACHE_HEADERS.REVALIDATE)},\n     },\n   })\n }"
        },
        {
            "sha": "018c03742924423320b45163466ec7f879678a3e",
            "filename": "packages/next/src/server/og/image-response.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/packages%2Fnext%2Fsrc%2Fserver%2Fog%2Fimage-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/packages%2Fnext%2Fsrc%2Fserver%2Fog%2Fimage-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fog%2Fimage-response.ts?ref=d8e1aca88ccb079ded1d6c1e5ef0c3049b953236",
            "patch": "@@ -49,7 +49,7 @@ export class ImageResponse extends Response {\n       'cache-control':\n         process.env.NODE_ENV === 'development'\n           ? 'no-cache, no-store'\n-          : 'public, immutable, no-transform, max-age=31536000',\n+          : 'public, max-age=0, must-revalidate',\n     })\n     if (options.headers) {\n       const newHeaders = new Headers(options.headers)"
        },
        {
            "sha": "2c195f179af2d075439057de29c8194aa4f734b0",
            "filename": "test/e2e/app-dir/metadata-dynamic-routes/index.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts?ref=d8e1aca88ccb079ded1d6c1e5ef0c3049b953236",
            "patch": "@@ -4,7 +4,6 @@ import { check } from 'next-test-utils'\n \n const CACHE_HEADERS = {\n   NONE: 'no-cache, no-store',\n-  LONG: 'public, immutable, no-transform, max-age=31536000',\n   REVALIDATE: 'public, max-age=0, must-revalidate',\n }\n \n@@ -209,7 +208,7 @@ describe('app dir - metadata dynamic routes', () => {\n \n       expect(res.headers.get('content-type')).toBe('image/png')\n       expect(res.headers.get('cache-control')).toBe(\n-        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.LONG\n+        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.REVALIDATE\n       )\n     })\n \n@@ -219,7 +218,7 @@ describe('app dir - metadata dynamic routes', () => {\n \n       expect(res.headers.get('content-type')).toBe('image/png')\n       expect(res.headers.get('cache-control')).toBe(\n-        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.LONG\n+        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.REVALIDATE\n       )\n \n       if (isNextDev) {\n@@ -241,7 +240,7 @@ describe('app dir - metadata dynamic routes', () => {\n       res = await next.fetch('/twitter-image2')\n       expect(res.headers.get('content-type')).toBe('image/png')\n       expect(res.headers.get('cache-control')).toBe(\n-        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.LONG\n+        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.REVALIDATE\n       )\n     })\n \n@@ -338,7 +337,7 @@ describe('app dir - metadata dynamic routes', () => {\n \n       expect(res.headers.get('content-type')).toBe('image/png')\n       expect(res.headers.get('cache-control')).toBe(\n-        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.LONG\n+        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.REVALIDATE\n       )\n     })\n \n@@ -347,7 +346,7 @@ describe('app dir - metadata dynamic routes', () => {\n \n       expect(res.headers.get('content-type')).toBe('image/png')\n       expect(res.headers.get('cache-control')).toBe(\n-        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.LONG\n+        isNextDev ? CACHE_HEADERS.NONE : CACHE_HEADERS.REVALIDATE\n       )\n     })\n   })"
        },
        {
            "sha": "d2a4c4352a7a5774b45fb9c7b0c3105e3dc03169",
            "filename": "test/e2e/app-dir/metadata/metadata.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 16,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8e1aca88ccb079ded1d6c1e5ef0c3049b953236/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts?ref=d8e1aca88ccb079ded1d6c1e5ef0c3049b953236",
            "patch": "@@ -12,6 +12,10 @@ import {\n import fs from 'fs/promises'\n import path from 'path'\n \n+// Webpack: /favicon.ico?<hash>\n+// Turbopack: /favicon.ico?favicon.<hash>.ico\n+const FAVICON_REGEX = /\\/favicon.ico\\?\\w+/\n+\n describe('app dir - metadata', () => {\n   const { next, isNextDev, isNextStart, isNextDeploy } = nextTestSetup({\n     files: __dirname,\n@@ -428,7 +432,7 @@ describe('app dir - metadata', () => {\n       })\n \n       // favicon shouldn't be overridden\n-      expect($('link[rel=\"icon\"]').attr('href')).toMatch('/favicon.ico')\n+      expect($('link[rel=\"icon\"]').attr('href')).toMatch(FAVICON_REGEX)\n     })\n \n     it('should override file based images when opengraph-image and twitter-image specify images property', async () => {\n@@ -450,7 +454,7 @@ describe('app dir - metadata', () => {\n         .toArray()\n         .map((i) => $(i).attr('href'))\n \n-      expect(favicon).toMatch('/favicon.ico')\n+      expect(favicon).toMatch(FAVICON_REGEX)\n       expect(icons).toEqual(['https://custom-icon-1.png'])\n     })\n \n@@ -485,7 +489,7 @@ describe('app dir - metadata', () => {\n \n       await checkLink(browser, 'shortcut icon', '/shortcut-icon.png')\n       await checkLink(browser, 'icon', [\n-        expect.stringMatching(/favicon\\.ico/),\n+        expect.stringMatching(FAVICON_REGEX),\n         '/icon.png',\n         'https://example.com/icon.png',\n       ])\n@@ -524,7 +528,7 @@ describe('app dir - metadata', () => {\n     it('should support root level of favicon.ico', async () => {\n       let $ = await next.render$('/')\n       const favIcon = $('link[rel=\"icon\"]')\n-      expect(favIcon.attr('href')).toMatch('/favicon.ico')\n+      expect(favIcon.attr('href')).toMatch(FAVICON_REGEX)\n       expect(favIcon.attr('type')).toBe('image/x-icon')\n       // Turbopack renders / emits image differently\n       expect(['16x16', '48x48']).toContain(favIcon.attr('sizes'))\n@@ -536,7 +540,7 @@ describe('app dir - metadata', () => {\n \n       $ = await next.render$('/basic')\n       const icon = $('link[rel=\"icon\"]')\n-      expect(icon.attr('href')).toMatch('/favicon.ico')\n+      expect(icon.attr('href')).toMatch(FAVICON_REGEX)\n       expect(['16x16', '48x48']).toContain(favIcon.attr('sizes'))\n \n       if (!isNextDeploy) {\n@@ -676,7 +680,7 @@ describe('app dir - metadata', () => {\n       expect(res.status).toBe(200)\n       expect(res.headers.get('content-type')).toBe('image/x-icon')\n       expect(res.headers.get('cache-control')).toBe(\n-        'public, max-age=0, must-revalidate'\n+        isNextDev ? 'no-cache, no-store' : 'public, max-age=0, must-revalidate'\n       )\n     })\n \n@@ -689,20 +693,12 @@ describe('app dir - metadata', () => {\n       expect(resAppleIcon.status).toBe(200)\n       expect(resAppleIcon.headers.get('content-type')).toBe('image/png')\n       expect(resAppleIcon.headers.get('cache-control')).toBe(\n-        isNextDev\n-          ? 'no-cache, no-store'\n-          : isNextDeploy\n-            ? 'public, max-age=0, must-revalidate'\n-            : 'public, immutable, no-transform, max-age=31536000'\n+        isNextDev ? 'no-cache, no-store' : 'public, max-age=0, must-revalidate'\n       )\n       expect(resIcon.status).toBe(200)\n       expect(resIcon.headers.get('content-type')).toBe('image/png')\n       expect(resIcon.headers.get('cache-control')).toBe(\n-        isNextDev\n-          ? 'no-cache, no-store'\n-          : isNextDeploy\n-            ? 'public, max-age=0, must-revalidate'\n-            : 'public, immutable, no-transform, max-age=31536000'\n+        isNextDev ? 'no-cache, no-store' : 'public, max-age=0, must-revalidate'\n       )\n     })\n "
        }
    ],
    "stats": {
        "total": 73,
        "additions": 29,
        "deletions": 44
    }
}