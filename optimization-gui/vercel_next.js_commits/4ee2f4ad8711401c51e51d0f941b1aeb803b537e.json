{
    "author": "sokra",
    "message": "Turbopack: allow gzip compression on trace files (#84685)\n\n### What?\r\n\r\n* allow to compress traces with gzip\r\n* allow to combine custom filters with presets\r\n* auto-detect compression in the trace server",
    "sha": "4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
    "files": [
        {
            "sha": "a883e1e70168981afcaf9193f9612371ff3b4f24",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -4396,6 +4396,7 @@ dependencies = [\n  \"console-subscriber\",\n  \"dhat\",\n  \"either\",\n+ \"flate2\",\n  \"futures-util\",\n  \"getrandom 0.2.15\",\n  \"iana-time-zone\","
        },
        {
            "sha": "0576427a5ef30f14fc20b67ace81ebcd53863bc6",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -367,6 +367,7 @@ dhat = { version = \"0.3.2\" }\n dunce = \"1.0.3\"\n either = \"1.9.0\"\n erased-serde = \"0.4.5\"\n+flate2 = \"1.0.28\"\n futures = \"0.3.31\"\n futures-util = \"0.3.31\"\n futures-retry = \"0.6.0\""
        },
        {
            "sha": "a0a3ddec1f0397d8930b49ed9cb22c2963bda0f9",
            "filename": "crates/napi/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/crates%2Fnapi%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/crates%2Fnapi%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2FCargo.toml?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -55,10 +55,11 @@ ignored = [\n ]\n \n [dependencies]\n-anyhow = \"1.0.66\"\n+anyhow = { workspace = true }\n console-subscriber = { workspace = true, optional = true }\n dhat = { workspace = true, optional = true }\n either = { workspace = true }\n+flate2 = { workspace = true }\n futures-util = { workspace = true }\n owo-colors = { workspace = true }\n napi = { workspace = true }"
        },
        {
            "sha": "24dacb72b44da2f1ca646d2faef5770f3a69a545",
            "filename": "crates/napi/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/crates%2Fnapi%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/crates%2Fnapi%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Flib.rs?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -30,6 +30,7 @@ DEALINGS IN THE SOFTWARE.\n //#![deny(clippy::all)]\n #![feature(arbitrary_self_types)]\n #![feature(arbitrary_self_types_pointers)]\n+#![feature(iter_intersperse)]\n \n #[macro_use]\n extern crate napi_derive;"
        },
        {
            "sha": "200cc1fafb88c223efcb4ff8ee3b78d8988ea119",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 49,
            "deletions": 19,
            "changes": 68,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -1,6 +1,7 @@\n use std::{borrow::Cow, io::Write, path::PathBuf, sync::Arc, thread, time::Duration};\n \n use anyhow::{Context, Result, anyhow, bail};\n+use flate2::write::GzEncoder;\n use futures_util::TryFutureExt;\n use napi::{\n     Env, JsFunction, JsObject, Status,\n@@ -362,23 +363,35 @@ pub fn project_new(\n         trace = Some(\"overview\".to_owned());\n     }\n \n+    enum Compression {\n+        None,\n+        GzipFast,\n+        GzipBest,\n+    }\n+    let mut compress = Compression::None;\n     if let Some(mut trace) = trace {\n-        // Trace presets\n-        match trace.as_str() {\n-            \"overview\" | \"1\" => {\n-                trace = TRACING_NEXT_OVERVIEW_TARGETS.join(\",\");\n-            }\n-            \"next\" => {\n-                trace = TRACING_NEXT_TARGETS.join(\",\");\n-            }\n-            \"turbopack\" => {\n-                trace = TRACING_NEXT_TURBOPACK_TARGETS.join(\",\");\n-            }\n-            \"turbo-tasks\" => {\n-                trace = TRACING_NEXT_TURBO_TASKS_TARGETS.join(\",\");\n-            }\n-            _ => {}\n-        }\n+        trace = trace\n+            .split(\",\")\n+            .filter_map(|item| {\n+                // Trace presets\n+                Some(match item {\n+                    \"overview\" | \"1\" => Cow::Owned(TRACING_NEXT_OVERVIEW_TARGETS.join(\",\")),\n+                    \"next\" => Cow::Owned(TRACING_NEXT_TARGETS.join(\",\")),\n+                    \"turbopack\" => Cow::Owned(TRACING_NEXT_TURBOPACK_TARGETS.join(\",\")),\n+                    \"turbo-tasks\" => Cow::Owned(TRACING_NEXT_TURBO_TASKS_TARGETS.join(\",\")),\n+                    \"gz\" => {\n+                        compress = Compression::GzipFast;\n+                        return None;\n+                    }\n+                    \"gz-best\" => {\n+                        compress = Compression::GzipBest;\n+                        return None;\n+                    }\n+                    _ => Cow::Borrowed(item),\n+                })\n+            })\n+            .intersperse_with(|| Cow::Borrowed(\",\"))\n+            .collect::<String>();\n \n         let subscriber = Registry::default();\n \n@@ -396,9 +409,26 @@ pub fn project_new(\n         std::fs::create_dir_all(&internal_dir)\n             .context(\"Unable to create .next directory\")\n             .unwrap();\n-        let trace_file = internal_dir.join(\"trace-turbopack\");\n-        let trace_writer = std::fs::File::create(trace_file.clone()).unwrap();\n-        let (trace_writer, trace_writer_guard) = TraceWriter::new(trace_writer);\n+        let trace_file;\n+        let (trace_writer, trace_writer_guard) = match compress {\n+            Compression::None => {\n+                trace_file = internal_dir.join(\"trace-turbopack\");\n+                let trace_writer = std::fs::File::create(trace_file.clone()).unwrap();\n+                TraceWriter::new(trace_writer)\n+            }\n+            Compression::GzipFast => {\n+                trace_file = internal_dir.join(\"trace-turbopack\");\n+                let trace_writer = std::fs::File::create(trace_file.clone()).unwrap();\n+                let trace_writer = GzEncoder::new(trace_writer, flate2::Compression::fast());\n+                TraceWriter::new(trace_writer)\n+            }\n+            Compression::GzipBest => {\n+                trace_file = internal_dir.join(\"trace-turbopack\");\n+                let trace_writer = std::fs::File::create(trace_file.clone()).unwrap();\n+                let trace_writer = GzEncoder::new(trace_writer, flate2::Compression::best());\n+                TraceWriter::new(trace_writer)\n+            }\n+        };\n         let subscriber = subscriber.with(RawTraceLayer::new(trace_writer));\n \n         exit.on_exit(async move {"
        },
        {
            "sha": "c98c3d46d281be67a0004ab8c78b068b3ae885ab",
            "filename": "turbopack/crates/turbopack-trace-server/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/turbopack%2Fcrates%2Fturbopack-trace-server%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/turbopack%2Fcrates%2Fturbopack-trace-server%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2FCargo.toml?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -14,7 +14,7 @@ bench = false\n [dependencies]\n anyhow = { workspace = true, features = [\"backtrace\"] }\n either = { workspace = true }\n-flate2 = { version = \"1.0.28\" }\n+flate2 = { workspace = true }\n hashbrown = { workspace = true, features = [\"raw\"] }\n indexmap = { workspace = true, features = [\"serde\"] }\n itertools = { workspace = true }"
        },
        {
            "sha": "e36464a2794e6734bb433a680cfd95754da5871a",
            "filename": "turbopack/crates/turbopack-trace-server/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Flib.rs?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -1,5 +1,6 @@\n #![feature(iter_intersperse)]\n #![feature(box_patterns)]\n+#![feature(bufreader_peek)]\n \n use std::{hash::BuildHasherDefault, path::PathBuf, sync::Arc};\n "
        },
        {
            "sha": "c9145ad5ce94aea50b2f4ca4b56f3fbf5a5de2c4",
            "filename": "turbopack/crates/turbopack-trace-server/src/main.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fmain.rs?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -1,5 +1,6 @@\n #![feature(iter_intersperse)]\n #![feature(box_patterns)]\n+#![feature(bufreader_peek)]\n \n use std::{hash::BuildHasherDefault, sync::Arc};\n "
        },
        {
            "sha": "b741dc1c4b0d1560a6dd4bc0e39c209016189621",
            "filename": "turbopack/crates/turbopack-trace-server/src/reader/mod.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 10,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Freader%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4ee2f4ad8711401c51e51d0f941b1aeb803b537e/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Freader%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Freader%2Fmod.rs?ref=4ee2f4ad8711401c51e51d0f941b1aeb803b537e",
            "patch": "@@ -75,7 +75,7 @@ impl ObjectSafeTraceFormat for ErasedTraceFormat {\n \n #[derive(Default)]\n enum TraceFile {\n-    Raw(File),\n+    Raw(BufReader<File>),\n     Zstd(zstd::Decoder<'static, BufReader<File>>),\n     Gz(GzDecoder<BufReader<File>>),\n     #[default]\n@@ -112,7 +112,7 @@ impl TraceFile {\n \n     fn size(&mut self) -> io::Result<u64> {\n         match self {\n-            Self::Raw(file) => file.metadata().map(|m| m.len()),\n+            Self::Raw(file) => file.get_ref().metadata().map(|m| m.len()),\n             Self::Zstd(decoder) => decoder.get_mut().get_ref().metadata().map(|m| m.len()),\n             Self::Gz(decoder) => decoder.get_mut().get_ref().metadata().map(|m| m.len()),\n             Self::Unloaded => unreachable!(),\n@@ -145,13 +145,21 @@ impl TraceReader {\n \n     fn trace_file_from_file(&self, file: File) -> io::Result<TraceFile> {\n         let path = &self.path.to_string_lossy();\n-        Ok(if path.ends_with(\".zst\") {\n-            TraceFile::Zstd(zstd::Decoder::new(file)?)\n-        } else if path.ends_with(\".gz\") {\n-            TraceFile::Gz(GzDecoder::new(BufReader::new(file)))\n-        } else {\n-            TraceFile::Raw(file)\n-        })\n+        let mut file = BufReader::with_capacity(\n+            // zstd max block size (1 << 17) + block header (3) + magic bytes (4)\n+            (1 << 17) + 7,\n+            file,\n+        );\n+        let magic_bytes = file.peek(4)?;\n+        Ok(\n+            if path.ends_with(\".zst\") || magic_bytes == [0x28, 0xb5, 0x2f, 0xfd] {\n+                TraceFile::Zstd(zstd::Decoder::with_buffer(file)?)\n+            } else if path.ends_with(\".gz\") || matches!(magic_bytes, [0x1f, 0x8b, _, _]) {\n+                TraceFile::Gz(GzDecoder::new(file))\n+            } else {\n+                TraceFile::Raw(file)\n+            },\n+        )\n     }\n \n     fn try_read(&mut self) -> bool {\n@@ -293,7 +301,9 @@ impl TraceReader {\n                     }\n                 }\n                 Err(err) => {\n-                    if err.kind() == io::ErrorKind::UnexpectedEof {\n+                    if err.kind() == io::ErrorKind::UnexpectedEof\n+                        || err.kind() == io::ErrorKind::InvalidInput\n+                    {\n                         if let Some(value) = self.wait_for_more_data(\n                             &mut file,\n                             &mut initial_read,"
        }
    ],
    "stats": {
        "total": 108,
        "additions": 77,
        "deletions": 31
    }
}