{
    "author": "bgw",
    "message": "chore(swc-wasm): Fix and clean up various issues with swc-wasm tests (#80471)\n\n- Follow the naming conventions of other environment variables and prefix `TEST_WASM` with `NEXT_TEST_WASM` so that there's less chance of conflicts with user code\n- Remove the logic in `setup-wasm.mjs` that modifies the repository (not great for running tests locally) and instead try to match the environment-variable-override behavior used for native (non-wasm) bindings via `NEXT_TEST_WASM_DIR`.\n- Hard-fail if `NEXT_TEST_WASM` is set and we fail to load wasm bindings instead of silently using fallback logic that loads native bindings instead.\n- We don't need to install `wasm-pack` with `curl | sh` for tests: `pnpm` already installs it (and pins a specific version).\n- The whole dance of renaming the directory from `pkg` to `pkg-nextjs` is a hack we use when publishing the package, as we're building both \"web\" and \"nextjs\" targets. We don't need to do that for tests.\n- Fix handling of `undefined` values in SWC options objects.\n- Remove hacks for Next v12.2",
    "sha": "2502c0a40c78b4eaa284c5b2925430764c384137",
    "files": [
        {
            "sha": "d53410fa454b352a6ba166568e8220b1422adca3",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2502c0a40c78b4eaa284c5b2925430764c384137/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/2502c0a40c78b4eaa284c5b2925430764c384137/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=2502c0a40c78b4eaa284c5b2925430764c384137",
            "patch": "@@ -473,15 +473,12 @@ jobs:\n       skipNativeInstall: 'yes'\n       afterBuild: |\n         rustup target add wasm32-unknown-unknown\n-        curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh\n         node ./scripts/normalize-version-bump.js\n         pnpm dlx turbo@${TURBO_VERSION} run build-wasm -- --target nodejs\n         git checkout .\n-        mv crates/wasm/pkg crates/wasm/pkg-nodejs\n-        node ./scripts/setup-wasm.mjs\n \n         export NEXT_TEST_MODE=start\n-        export TEST_WASM=true\n+        export NEXT_TEST_WASM=true\n         node run-tests.js \\\n           test/production/pages-dir/production/test/index.test.ts \\\n           test/e2e/streaming-ssr/index.test.ts"
        },
        {
            "sha": "c5896248569a9bfcaec46d468d50341ab8e91dfa",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2502c0a40c78b4eaa284c5b2925430764c384137/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2502c0a40c78b4eaa284c5b2925430764c384137/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=2502c0a40c78b4eaa284c5b2925430764c384137",
            "patch": "@@ -711,5 +711,6 @@\n   \"710\": \"Unable to remove an invalidated webpack cache. If this issue persists you can work around it by deleting %s\",\n   \"711\": \"Can't resolve %s\",\n   \"712\": \"`rspack.warnForEdgeRuntime` is not supported by the wasm bindings.\",\n-  \"713\": \"Unexpected error during process lookup\"\n+  \"713\": \"Unexpected error during process lookup\",\n+  \"714\": \"cannot run loadNative when `NEXT_TEST_WASM` is set\"\n }"
        },
        {
            "sha": "b8e0a27be72939b2c7b69839fa3861932c710f58",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 188,
            "deletions": 122,
            "changes": 310,
            "blob_url": "https://github.com/vercel/next.js/blob/2502c0a40c78b4eaa284c5b2925430764c384137/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2502c0a40c78b4eaa284c5b2925430764c384137/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=2502c0a40c78b4eaa284c5b2925430764c384137",
            "patch": "@@ -160,15 +160,27 @@ let lastNativeBindingsLoadErrorCode:\n   | 'unsupported_target'\n   | string\n   | undefined = undefined\n+// Used to cache calls to `loadBindings`\n+let pendingBindings: Promise<Binding>\n+// some things call `loadNative` directly instead of `loadBindings`... Cache calls to that\n+// separately.\n let nativeBindings: Binding\n+// can allow hacky sync access to bindings for loadBindingsSync\n let wasmBindings: Binding\n let downloadWasmPromise: any\n-let pendingBindings: any\n let swcTraceFlushGuard: any\n let downloadNativeBindingsPromise: Promise<void> | undefined = undefined\n \n export const lockfilePatchPromise: { cur?: Promise<void> } = {}\n \n+/**\n+ * Attempts to load a native or wasm binding.\n+ *\n+ * By default, this first tries to use a native binding, falling back to a wasm binding if that\n+ * fails.\n+ *\n+ * This function is `async` as wasm requires an asynchronous import in browsers.\n+ */\n export async function loadBindings(\n   useWasmBinary: boolean = false\n ): Promise<Binding> {\n@@ -181,6 +193,10 @@ export async function loadBindings(\n     return pendingBindings\n   }\n \n+  if (process.env.NEXT_TEST_WASM) {\n+    useWasmBinary = true\n+  }\n+\n   // rust needs stdout to be blocking, otherwise it will throw an error (on macOS at least) when writing a lot of data (logs) to it\n   // see https://github.com/napi-rs/napi-rs/issues/1630\n   // and https://github.com/nodejs/node/blob/main/doc/api/process.md#a-note-on-process-io\n@@ -292,7 +308,10 @@ async function tryLoadNativeWithFallback(attempts: Array<string>) {\n   return undefined\n }\n \n-async function tryLoadWasmWithFallback(attempts: any[]) {\n+// helper for loadBindings\n+async function tryLoadWasmWithFallback(\n+  attempts: any[]\n+): Promise<Binding | undefined> {\n   try {\n     let bindings = await loadWasm('')\n     // @ts-expect-error TODO: this event has a wrong type.\n@@ -344,8 +363,8 @@ function loadBindingsSync() {\n     attempts = attempts.concat(a)\n   }\n \n-  // we can leverage the wasm bindings if they are already\n-  // loaded\n+  // HACK: we can leverage the wasm bindings if they are already loaded\n+  // this may introduce race conditions\n   if (wasmBindings) {\n     return wasmBindings\n   }\n@@ -1059,127 +1078,53 @@ function bindingToApi(\n   }\n }\n \n-async function loadWasm(importPath = '') {\n-  if (wasmBindings) {\n-    return wasmBindings\n-  }\n-\n+// helper for loadWasm\n+async function loadWasmRawBindings(importPath = ''): Promise<RawWasmBindings> {\n   let attempts = []\n-  for (let pkg of ['@next/swc-wasm-nodejs', '@next/swc-wasm-web']) {\n-    try {\n-      let pkgPath = pkg\n \n-      if (importPath) {\n-        // the import path must be exact when not in node_modules\n-        pkgPath = path.join(importPath, pkg, 'wasm.js')\n-      }\n-      let bindings: RawWasmBindings = await import(\n-        pathToFileURL(pkgPath).toString()\n-      )\n-      if (pkg === '@next/swc-wasm-web') {\n-        bindings = await bindings.default!()\n-      }\n-      infoLog('next-swc build: wasm build @next/swc-wasm-web')\n-\n-      // Note wasm binary does not support async intefaces yet, all async\n-      // interface coereces to sync interfaces.\n-      wasmBindings = {\n-        css: {\n-          lightning: {\n-            transform: function (_options: any) {\n-              throw new Error(\n-                '`css.lightning.transform` is not supported by the wasm bindings.'\n-              )\n-            },\n-            transformStyleAttr: function (_options: any) {\n-              throw new Error(\n-                '`css.lightning.transformStyleAttr` is not supported by the wasm bindings.'\n-              )\n-            },\n-          },\n-        },\n-        isWasm: true,\n-        transform(src: string, options: any) {\n-          // TODO: we can remove fallback to sync interface once new stable version of next-swc gets published (current v12.2)\n-          return bindings?.transform\n-            ? bindings.transform(src.toString(), options)\n-            : Promise.resolve(bindings.transformSync(src.toString(), options))\n-        },\n-        transformSync(src: string, options: any) {\n-          return bindings.transformSync(src.toString(), options)\n-        },\n-        minify(src: string, options: any) {\n-          return bindings?.minify\n-            ? bindings.minify(src.toString(), options)\n-            : Promise.resolve(bindings.minifySync(src.toString(), options))\n-        },\n-        minifySync(src: string, options: any) {\n-          return bindings.minifySync(src.toString(), options)\n-        },\n-        parse(src: string, options: any) {\n-          return bindings?.parse\n-            ? bindings.parse(src.toString(), options)\n-            : Promise.resolve(bindings.parseSync(src.toString(), options))\n-        },\n-        getTargetTriple() {\n-          return undefined\n-        },\n-        turbo: {\n-          createProject: function (\n-            _options: ProjectOptions,\n-            _turboEngineOptions?: TurboEngineOptions | undefined\n-          ): Promise<Project> {\n-            throw new Error(\n-              '`turbo.createProject` is not supported by the wasm bindings.'\n-            )\n-          },\n-          startTurbopackTraceServer: function (_traceFilePath: string): void {\n-            throw new Error(\n-              '`turbo.startTurbopackTraceServer` is not supported by the wasm bindings.'\n-            )\n-          },\n-        },\n-        mdx: {\n-          compile(src: string, options: any) {\n-            return bindings.mdxCompile(src, getMdxOptions(options))\n-          },\n-          compileSync(src: string, options: any) {\n-            return bindings.mdxCompileSync(src, getMdxOptions(options))\n-          },\n-        },\n-        reactCompiler: {\n-          isReactCompilerRequired(_filename: string) {\n-            return Promise.resolve(true)\n-          },\n-        },\n-        rspack: {\n-          getModuleNamedExports: function (\n-            _resourcePath: string\n-          ): Promise<string[]> {\n-            throw new Error(\n-              '`rspack.getModuleNamedExports` is not supported by the wasm bindings.'\n-            )\n-          },\n-          warnForEdgeRuntime: function (\n-            _source: string,\n-            _isProduction: boolean\n-          ): Promise<NapiSourceDiagnostic[]> {\n-            throw new Error(\n-              '`rspack.warnForEdgeRuntime` is not supported by the wasm bindings.'\n-            )\n-          },\n-        },\n-      }\n-      return wasmBindings\n-    } catch (e: any) {\n-      // Only log attempts for loading wasm when loading as fallback\n-      if (importPath) {\n-        if (e?.code === 'ERR_MODULE_NOT_FOUND') {\n-          attempts.push(`Attempted to load ${pkg}, but it was not installed`)\n+  // Used by `run-tests` to force use of a locally-built wasm binary. This environment variable is\n+  // unstable and subject to change.\n+  const testWasmDir = process.env.NEXT_TEST_WASM_DIR\n+\n+  if (testWasmDir) {\n+    // assume these are node.js bindings and don't need a call to `.default()`\n+    const rawBindings = await import(\n+      pathToFileURL(path.join(testWasmDir, 'wasm.js')).toString()\n+    )\n+    infoLog(`next-swc build: wasm build ${testWasmDir}`)\n+    return rawBindings\n+  } else {\n+    for (let pkg of ['@next/swc-wasm-nodejs', '@next/swc-wasm-web']) {\n+      try {\n+        let pkgPath = pkg\n+\n+        if (importPath) {\n+          // the import path must be exact when not in node_modules\n+          pkgPath = path.join(importPath, pkg, 'wasm.js')\n+        }\n+        const importedRawBindings = await import(\n+          pathToFileURL(pkgPath).toString()\n+        )\n+        let rawBindings\n+        if (pkg === '@next/swc-wasm-web') {\n+          // https://rustwasm.github.io/docs/wasm-bindgen/examples/without-a-bundler.html\n+          // `default` must be called to initialize the module\n+          rawBindings = await importedRawBindings.default!()\n         } else {\n-          attempts.push(\n-            `Attempted to load ${pkg}, but an error occurred: ${e.message ?? e}`\n-          )\n+          rawBindings = importedRawBindings\n+        }\n+        infoLog(`next-swc build: wasm build ${pkg}`)\n+        return rawBindings\n+      } catch (e: any) {\n+        // Only log attempts for loading wasm when loading as fallback\n+        if (importPath) {\n+          if (e?.code === 'ERR_MODULE_NOT_FOUND') {\n+            attempts.push(`Attempted to load ${pkg}, but it was not installed`)\n+          } else {\n+            attempts.push(\n+              `Attempted to load ${pkg}, but an error occurred: ${e.message ?? e}`\n+            )\n+          }\n         }\n       }\n     }\n@@ -1188,11 +1133,132 @@ async function loadWasm(importPath = '') {\n   throw attempts\n }\n \n+// helper for tryLoadWasmWithFallback / loadBindings.\n+async function loadWasm(importPath = '') {\n+  const rawBindings = await loadWasmRawBindings(importPath)\n+\n+  function removeUndefined(obj: any): any {\n+    // serde-wasm-bindgen expect that `undefined` values map to `()` in rust, but we want to treat\n+    // those fields as non-existent, so remove them before passing them to rust.\n+    //\n+    // The native (non-wasm) bindings use `JSON.stringify`, which strips undefined values.\n+    if (typeof obj !== 'object' || obj === null) {\n+      return obj\n+    }\n+    if (Array.isArray(obj)) {\n+      return obj.map(removeUndefined)\n+    }\n+    const newObj: { [key: string]: any } = {}\n+    for (const [k, v] of Object.entries(obj)) {\n+      if (typeof v !== 'undefined') {\n+        newObj[k] = removeUndefined(v)\n+      }\n+    }\n+    return newObj\n+  }\n+\n+  // Note wasm binary does not support async intefaces yet, all async\n+  // interface coereces to sync interfaces.\n+  wasmBindings = {\n+    css: {\n+      lightning: {\n+        transform: function (_options: any) {\n+          throw new Error(\n+            '`css.lightning.transform` is not supported by the wasm bindings.'\n+          )\n+        },\n+        transformStyleAttr: function (_options: any) {\n+          throw new Error(\n+            '`css.lightning.transformStyleAttr` is not supported by the wasm bindings.'\n+          )\n+        },\n+      },\n+    },\n+    isWasm: true,\n+    transform(src: string, options: any): Promise<any> {\n+      return rawBindings.transform(src.toString(), removeUndefined(options))\n+    },\n+    transformSync(src: string, options: any) {\n+      return rawBindings.transformSync(src.toString(), removeUndefined(options))\n+    },\n+    minify(src: string, options: any): Promise<any> {\n+      return rawBindings.minify(src.toString(), removeUndefined(options))\n+    },\n+    minifySync(src: string, options: any) {\n+      return rawBindings.minifySync(src.toString(), removeUndefined(options))\n+    },\n+    parse(src: string, options: any): Promise<any> {\n+      return rawBindings.parse(src.toString(), removeUndefined(options))\n+    },\n+    getTargetTriple() {\n+      return undefined\n+    },\n+    turbo: {\n+      createProject(\n+        _options: ProjectOptions,\n+        _turboEngineOptions?: TurboEngineOptions | undefined\n+      ): Promise<Project> {\n+        throw new Error(\n+          '`turbo.createProject` is not supported by the wasm bindings.'\n+        )\n+      },\n+      startTurbopackTraceServer(_traceFilePath: string): void {\n+        throw new Error(\n+          '`turbo.startTurbopackTraceServer` is not supported by the wasm bindings.'\n+        )\n+      },\n+    },\n+    mdx: {\n+      compile(src: string, options: any) {\n+        return rawBindings.mdxCompile(\n+          src,\n+          removeUndefined(getMdxOptions(options))\n+        )\n+      },\n+      compileSync(src: string, options: any) {\n+        return rawBindings.mdxCompileSync(\n+          src,\n+          removeUndefined(getMdxOptions(options))\n+        )\n+      },\n+    },\n+    reactCompiler: {\n+      isReactCompilerRequired(_filename: string) {\n+        return Promise.resolve(true)\n+      },\n+    },\n+    rspack: {\n+      getModuleNamedExports(_resourcePath: string): Promise<string[]> {\n+        throw new Error(\n+          '`rspack.getModuleNamedExports` is not supported by the wasm bindings.'\n+        )\n+      },\n+      warnForEdgeRuntime(\n+        _source: string,\n+        _isProduction: boolean\n+      ): Promise<NapiSourceDiagnostic[]> {\n+        throw new Error(\n+          '`rspack.warnForEdgeRuntime` is not supported by the wasm bindings.'\n+        )\n+      },\n+    },\n+  }\n+  return wasmBindings\n+}\n+\n+/**\n+ * Loads the native (non-wasm) bindings. Prefer `loadBindings` over this API, as that includes a\n+ * wasm fallback.\n+ */\n function loadNative(importPath?: string) {\n   if (nativeBindings) {\n     return nativeBindings\n   }\n \n+  if (process.env.NEXT_TEST_WASM) {\n+    throw new Error('cannot run loadNative when `NEXT_TEST_WASM` is set')\n+  }\n+\n   const customBindings: RawBindings = !!__INTERNAL_CUSTOM_TURBOPACK_BINDINGS\n     ? require(__INTERNAL_CUSTOM_TURBOPACK_BINDINGS)\n     : null"
        },
        {
            "sha": "295c47ac5f1759f84a91d224268f3d18f1f9b225",
            "filename": "scripts/setup-wasm.mjs",
            "status": "removed",
            "additions": 0,
            "deletions": 32,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/baf3a7123f0fa8734ec5e452cc325cd2b1926991/scripts%2Fsetup-wasm.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/baf3a7123f0fa8734ec5e452cc325cd2b1926991/scripts%2Fsetup-wasm.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fsetup-wasm.mjs?ref=baf3a7123f0fa8734ec5e452cc325cd2b1926991",
            "patch": "@@ -1,32 +0,0 @@\n-import path from 'path'\n-import fs from 'fs'\n-;(async function () {\n-  try {\n-    let wasmDir = path.join(process.cwd(), 'crates/wasm')\n-    let wasmTarget = 'nodejs'\n-\n-    // CI restores artifact at pkg-${wasmTarget}\n-    // This only runs locally\n-    let folderName = fs.existsSync(path.join(wasmDir, 'pkg'))\n-      ? 'pkg'\n-      : `pkg-${wasmTarget}`\n-\n-    let wasmPkg = JSON.parse(\n-      fs.readFileSync(path.join(wasmDir, `${folderName}/package.json`))\n-    )\n-    wasmPkg.name = `@next/swc-wasm-${wasmTarget}`\n-\n-    fs.writeFileSync(\n-      path.join(wasmDir, `${folderName}/package.json`),\n-      JSON.stringify(wasmPkg, null, 2)\n-    )\n-\n-    fs.cpSync(\n-      path.join(wasmDir, folderName),\n-      path.join(process.cwd(), `node_modules/@next/swc-wasm-${wasmTarget}`),\n-      { force: true, recursive: true }\n-    )\n-  } catch (e) {\n-    console.error(e)\n-  }\n-})()"
        },
        {
            "sha": "286bc33a562dedccec1de06c4e43b4e0f058f499",
            "filename": "test/lib/create-next-install.js",
            "status": "modified",
            "additions": 27,
            "deletions": 17,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Flib%2Fcreate-next-install.js",
            "raw_url": "https://github.com/vercel/next.js/raw/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Flib%2Fcreate-next-install.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fcreate-next-install.js?ref=2502c0a40c78b4eaa284c5b2925430764c384137",
            "patch": "@@ -103,28 +103,38 @@ async function createNextInstall({\n             )\n         }\n \n-        const nativePath = path.join(origRepoDir, 'packages/next-swc/native')\n-\n-        const hasNativeBinary = fs.existsSync(nativePath)\n-          ? fs.readdirSync(nativePath).some((item) => item.endsWith('.node'))\n-          : false\n-\n-        if (hasNativeBinary) {\n-          process.env.NEXT_TEST_NATIVE_DIR = nativePath\n-        } else {\n-          const swcDirectory = fs\n-            .readdirSync(path.join(origRepoDir, 'node_modules/@next'))\n-            .find((directory) => directory.startsWith('swc-'))\n-          process.env.NEXT_TEST_NATIVE_DIR = path.join(\n-            origRepoDir,\n-            'node_modules/@next',\n-            swcDirectory\n+        if (process.env.NEXT_TEST_WASM) {\n+          const wasmPath = path.join(origRepoDir, 'crates', 'wasm', 'pkg')\n+          const hasWasmBinary = fs.existsSync(\n+            path.join(wasmPath, 'package.json')\n           )\n+          if (hasWasmBinary) {\n+            process.env.NEXT_TEST_WASM_DIR = wasmPath\n+          }\n+        } else {\n+          const nativePath = path.join(origRepoDir, 'packages/next-swc/native')\n+          const hasNativeBinary = fs.existsSync(nativePath)\n+            ? fs.readdirSync(nativePath).some((item) => item.endsWith('.node'))\n+            : false\n+\n+          if (hasNativeBinary) {\n+            process.env.NEXT_TEST_NATIVE_DIR = nativePath\n+          } else {\n+            const swcDirectory = fs\n+              .readdirSync(path.join(origRepoDir, 'node_modules/@next'))\n+              .find((directory) => directory.startsWith('swc-'))\n+            process.env.NEXT_TEST_NATIVE_DIR = path.join(\n+              origRepoDir,\n+              'node_modules/@next',\n+              swcDirectory\n+            )\n+          }\n         }\n \n         // log for clarity of which version we're using\n         require('console').log({\n-          swcDirectory: process.env.NEXT_TEST_NATIVE_DIR,\n+          swcNativeDirectory: process.env.NEXT_TEST_NATIVE_DIR,\n+          swcWasmDirectory: process.env.NEXT_TEST_WASM_DIR,\n         })\n \n         pkgPaths = await rootSpan"
        },
        {
            "sha": "4ea3e6c48c89556afa836c9a870b2d13dea7ee91",
            "filename": "test/lib/e2e-utils/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Flib%2Fe2e-utils%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Flib%2Fe2e-utils%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fe2e-utils%2Findex.ts?ref=2502c0a40c78b4eaa284c5b2925430764c384137",
            "patch": "@@ -164,7 +164,7 @@ export async function createNext(\n \n     setupTracing()\n     return await trace('createNext').traceAsyncFn(async (rootSpan) => {\n-      const useTurbo = !!process.env.TEST_WASM\n+      const useTurbo = !!process.env.NEXT_TEST_WASM\n         ? false\n         : opts?.turbo ?? shouldRunTurboDevTest()\n \n@@ -291,7 +291,8 @@ export function nextTestSetup(\n     },\n     get isTurbopack(): boolean {\n       return Boolean(\n-        !process.env.TEST_WASM && (options.turbo ?? shouldRunTurboDevTest())\n+        !process.env.NEXT_TEST_WASM &&\n+          (options.turbo ?? shouldRunTurboDevTest())\n       )\n     },\n "
        },
        {
            "sha": "fea11eea096d3309713717060b5262a898271442",
            "filename": "test/lib/next-modes/next-dev.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Flib%2Fnext-modes%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-dev.ts?ref=2502c0a40c78b4eaa284c5b2925430764c384137",
            "patch": "@@ -27,7 +27,7 @@ export class NextDevInstance extends NextInstance {\n     }\n \n     const useTurbo =\n-      !process.env.TEST_WASM &&\n+      !process.env.NEXT_TEST_WASM &&\n       ((this as any).turbo || (this as any).experimentalTurbo)\n \n     let startArgs = ["
        },
        {
            "sha": "d6ccd17e99c135f410a15d8a68fe5c48b83981f3",
            "filename": "test/lib/turbo.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Flib%2Fturbo.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Flib%2Fturbo.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fturbo.ts?ref=2502c0a40c78b4eaa284c5b2925430764c384137",
            "patch": "@@ -10,7 +10,7 @@ let loggedTurbopack = false\n  * update test cases accordingly as turbopack changes enable more test cases.\n  */\n export function shouldRunTurboDevTest(): boolean {\n-  if (!!process.env.TEST_WASM) {\n+  if (!!process.env.NEXT_TEST_WASM) {\n     return false\n   }\n "
        },
        {
            "sha": "253b1fd0a0bf67387f326899b34d1766983de42b",
            "filename": "test/production/pages-dir/production/test/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2502c0a40c78b4eaa284c5b2925430764c384137/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Findex.test.ts?ref=2502c0a40c78b4eaa284c5b2925430764c384137",
            "patch": "@@ -25,7 +25,7 @@ import { nextTestSetup } from 'e2e-utils'\n \n const glob = promisify(globOriginal)\n \n-if (process.env.TEST_WASM) {\n+if (process.env.NEXT_TEST_WASM) {\n   jest.setTimeout(120 * 1000)\n }\n "
        }
    ],
    "stats": {
        "total": 405,
        "additions": 224,
        "deletions": 181
    }
}