{
    "author": "bgw",
    "message": "babel-loader: Avoid calling expensive `isReactCompilerRequired` check when we must run Babel anyways (#84103)\n\nThis check uses SWC, so it's expensive.\n\nThis can be worth it if it lets us avoid running Babel entirely, but if you've got a custom babel config, we're forced to run Babel anyways, so it's probably not worth it in that case.",
    "sha": "06207d84eb9d980fbfc472499da8cc60633540bf",
    "files": [
        {
            "sha": "42da032432337701f6c3752092d0047a551a21fd",
            "filename": "packages/next/src/build/babel/loader/get-config.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 8,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/06207d84eb9d980fbfc472499da8cc60633540bf/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/06207d84eb9d980fbfc472499da8cc60633540bf/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts?ref=06207d84eb9d980fbfc472499da8cc60633540bf",
            "patch": "@@ -64,6 +64,18 @@ interface CharacteristicsGermaneToCaching {\n   configFilePath: string | undefined\n }\n \n+function shouldSkipBabel(\n+  transformMode: 'standalone' | 'default',\n+  configFilePath: string | undefined,\n+  hasReactCompiler: boolean\n+) {\n+  return (\n+    transformMode === 'standalone' &&\n+    configFilePath == null &&\n+    !hasReactCompiler\n+  )\n+}\n+\n const fileExtensionRegex = /\\.([a-z]+)$/\n async function getCacheCharacteristics(\n   loaderOptions: NextBabelLoaderOptions,\n@@ -91,19 +103,39 @@ async function getCacheCharacteristics(\n   const hasModuleExports = source.indexOf('module.exports') !== -1\n   const fileExt = fileExtensionRegex.exec(filename)?.[1] || 'unknown'\n \n+  let {\n+    reactCompilerPlugins,\n+    reactCompilerExclude,\n+    configFile: configFilePath,\n+    transformMode,\n+  } = loaderOptions\n+\n   // Compute `hasReactCompiler` as part of the cache characteristics / key,\n   // rather than inside of `getFreshConfig`:\n   // - `isReactCompilerRequired` depends on the file contents\n   // - `node_modules` and `reactCompilerExclude` depend on the file path, which\n   //   isn't part of the cache characteristics\n-  let { reactCompilerPlugins, reactCompilerExclude } = loaderOptions\n-  reactCompilerPlugins ??= []\n-  const hasReactCompiler =\n+  let hasReactCompiler =\n+    reactCompilerPlugins != null &&\n     reactCompilerPlugins.length !== 0 &&\n     !loaderOptions.isServer &&\n     !/[/\\\\]node_modules[/\\\\]/.test(filename) &&\n-    !reactCompilerExclude?.(filename) &&\n-    (await isReactCompilerRequired(filename))\n+    // Assumption: `reactCompilerExclude` is cheap because it should only\n+    // operate on the file path and *not* the file contents (it's sync)\n+    !reactCompilerExclude?.(filename)\n+\n+  // `isReactCompilerRequired` is expensive to run (parses/visits with SWC), so\n+  // only run it if there's a good chance we might be able to skip calling Babel\n+  // entirely (speculatively call `shouldSkipBabel`).\n+  //\n+  // Otherwise, we can let react compiler handle this logic for us. It should\n+  // behave equivalently.\n+  if (\n+    hasReactCompiler &&\n+    shouldSkipBabel(transformMode, configFilePath, /*hasReactCompiler*/ false)\n+  ) {\n+    hasReactCompiler &&= await isReactCompilerRequired(filename)\n+  }\n \n   return {\n     isStandalone,\n@@ -113,7 +145,7 @@ async function getCacheCharacteristics(\n     hasModuleExports,\n     hasReactCompiler,\n     fileExt,\n-    configFilePath: loaderOptions.configFile,\n+    configFilePath,\n   }\n }\n \n@@ -336,8 +368,9 @@ async function getFreshConfig(\n   const { hasReactCompiler, configFilePath, fileExt } = cacheCharacteristics\n \n   let customConfig = configFilePath && getCustomBabelConfig(configFilePath)\n-  if (transformMode === 'standalone' && !customConfig && !hasReactCompiler) {\n-    // Optimization: There's nothing useful to do, bail out and skip babel on this file\n+  if (shouldSkipBabel(transformMode, configFilePath, hasReactCompiler)) {\n+    // Optimization: There's nothing useful to do, bail out and skip babel on\n+    // this file\n     return null\n   }\n "
        }
    ],
    "stats": {
        "total": 49,
        "additions": 41,
        "deletions": 8
    }
}