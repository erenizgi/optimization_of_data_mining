{
    "author": "bgw",
    "message": "[devtools] Add a query parameter to restart endpoint to invalidate the persistent cache (#79425)\n\nCreates and passes through an option to turbopack to invalidate the cache. The dev overlay can then (not implemented) call this endpoint.\n\nInvalidation is performed by writing a marker file to disk, and then actually deleting the cache upon the next startup because:\n\n- Getting the database to drop all file handles is tricky.\n- You can't delete open files on Windows.\n- Writing an invalidation file is atomic, recursively deleting a directory is not.\n\n### Testing\n\nSet up a small app with a large dependency (three.js). Ran the build, restarted the dev server, saw that the cached run was fast.\n\nRan\n\n```\ncurl -v --request POST --header \"Content-Type: application/json\" --data '{}' http://localhost:3000/__nextjs_restart_dev\\?invalidatePersistentCache\\=\n```\n\nAnd saw that the server restarted and the next page load was slow.\n\n### Remaining Work (will come in subsequent PRs)\n\nIn rough order of priority:\n\n- A separate endpoint to poll to see when the server is back up.\n- A webpack+rspack implementation. It looks like I can do a hack to forcibly change the webpack cache version, which should trigger similar behavior upon the next restart.\n- Passing a boolean to the dev overlay telling it if persistent caching is enabled or not.\n- The devtools UI implementation.\n- Telemetry.\n- A CLI subcommand that leverages this, so that you can do it from the terminal.",
    "sha": "2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
    "files": [
        {
            "sha": "af4984c19840dfaad3492ec9dc1cceb4f14f3397",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -568,6 +568,18 @@ pub async fn project_update(\n     Ok(())\n }\n \n+/// Invalidates the persistent cache so that it will be deleted next time that a turbopack project\n+/// is created with persistent caching enabled.\n+#[napi]\n+pub async fn project_invalidate_persistent_cache(\n+    #[napi(ts_arg_type = \"{ __napiType: \\\"Project\\\" }\")] project: External<ProjectInstance>,\n+) -> napi::Result<()> {\n+    tokio::task::spawn_blocking(move || project.turbo_tasks.invalidate_persistent_cache())\n+        .await\n+        .context(\"panicked while invalidating persistent cache\")??;\n+    Ok(())\n+}\n+\n /// Runs exit handlers for the project registered using the [`ExitHandler`] API.\n ///\n /// This is called by `project_shutdown`, so if you're calling that API, you shouldn't call this"
        },
        {
            "sha": "8add9e80042638023f41938e1338aad83d16ad09",
            "filename": "crates/napi/src/next_api/utils.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -149,6 +149,16 @@ impl NextTurboTasks {\n             }\n         }\n     }\n+\n+    pub fn invalidate_persistent_cache(&self) -> Result<()> {\n+        match self {\n+            NextTurboTasks::Memory(_) => {}\n+            NextTurboTasks::PersistentCaching(turbo_tasks) => {\n+                turbo_tasks.backend().invalidate_storage()?\n+            }\n+        }\n+        Ok(())\n+    }\n }\n \n pub fn create_turbo_tasks("
        },
        {
            "sha": "c921677f8317fb1255fee6790f374896451b59ef",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -204,6 +204,13 @@ export declare function projectUpdate(\n   project: { __napiType: 'Project' },\n   options: NapiPartialProjectOptions\n ): Promise<void>\n+/**\n+ * Invalidates the persistent cache so that it will be deleted next time that a turbopack project\n+ * is created with persistent caching enabled.\n+ */\n+export declare function projectInvalidatePersistentCache(project: {\n+  __napiType: 'Project'\n+}): Promise<void>\n /**\n  * Runs exit handlers for the project registered using the [`ExitHandler`] API.\n  *"
        },
        {
            "sha": "840f11c3f71fbb715357add27df9a58dc54a0471",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -723,6 +723,10 @@ function bindingToApi(\n       )\n     }\n \n+    invalidatePersistentCache(): Promise<void> {\n+      return binding.projectInvalidatePersistentCache(this._nativeProject)\n+    }\n+\n     shutdown(): Promise<void> {\n       return binding.projectShutdown(this._nativeProject)\n     }"
        },
        {
            "sha": "a003c0132168fc833e54126ef702145a38328cc4",
            "filename": "packages/next/src/build/swc/types.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Ftypes.ts?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -226,6 +226,8 @@ export interface Project {\n     TurbopackResult<CompilationEvent>\n   >\n \n+  invalidatePersistentCache(): Promise<void>\n+\n   shutdown(): Promise<void>\n \n   onExit(): Promise<void>"
        },
        {
            "sha": "b4135c65f0ad242b376d9722b209ee6adb6a4a58",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/restart-dev-server-middleware.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 3,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Frestart-dev-server-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Frestart-dev-server-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Frestart-dev-server-middleware.ts?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -2,23 +2,39 @@ import type { ServerResponse, IncomingMessage } from 'http'\n import type { Telemetry } from '../../../../telemetry/storage'\n import { RESTART_EXIT_CODE } from '../../../../server/lib/utils'\n import { middlewareResponse } from './middleware-response'\n+import type { Project } from '../../../../build/swc/types'\n \n const EVENT_DEV_OVERLAY_RESTART_SERVER = 'DEV_OVERLAY_RESTART_SERVER'\n \n-export function getRestartDevServerMiddleware(telemetry: Telemetry) {\n+interface RestartDevServerMiddlewareConfig {\n+  telemetry: Telemetry\n+  turbopackProject?: Project\n+}\n+\n+export function getRestartDevServerMiddleware({\n+  telemetry,\n+  turbopackProject,\n+}: RestartDevServerMiddlewareConfig) {\n   return async function (\n     req: IncomingMessage,\n     res: ServerResponse,\n     next: () => void\n   ): Promise<void> {\n-    const { pathname } = new URL(`http://n${req.url}`)\n+    const { pathname, searchParams } = new URL(`http://n${req.url}`)\n     if (pathname !== '/__nextjs_restart_dev' || req.method !== 'POST') {\n       return next()\n     }\n \n+    const invalidatePersistentCache = searchParams.has(\n+      'invalidatePersistentCache'\n+    )\n+    if (invalidatePersistentCache) {\n+      await turbopackProject?.invalidatePersistentCache()\n+    }\n+\n     telemetry.record({\n       eventName: EVENT_DEV_OVERLAY_RESTART_SERVER,\n-      payload: {},\n+      payload: { invalidatePersistentCache },\n     })\n \n     // TODO: Use flushDetached"
        },
        {
            "sha": "3318f289f164fc589d6e3d2f1e3502ddf0e8ed25",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -650,7 +650,10 @@ export async function createHotReloaderTurbopack(\n     getNextErrorFeedbackMiddleware(opts.telemetry),\n     getDevOverlayFontMiddleware(),\n     getDisableDevIndicatorMiddleware(),\n-    getRestartDevServerMiddleware(opts.telemetry),\n+    getRestartDevServerMiddleware({\n+      telemetry: opts.telemetry,\n+      turbopackProject: project,\n+    }),\n   ]\n \n   const versionInfoPromise = getVersionInfo()"
        },
        {
            "sha": "1d878b399e360a289554465ec39a080255833872",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -1570,7 +1570,9 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       getNextErrorFeedbackMiddleware(this.telemetry),\n       getDevOverlayFontMiddleware(),\n       getDisableDevIndicatorMiddleware(),\n-      getRestartDevServerMiddleware(this.telemetry),\n+      getRestartDevServerMiddleware({\n+        telemetry: this.telemetry,\n+      }),\n     ]\n   }\n "
        },
        {
            "sha": "fb08b80ee95a62d206c2500c4c0f9e0c705a5c9e",
            "filename": "turbopack/crates/turbo-persistence/src/db.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -190,7 +190,7 @@ impl TurboPersistence {\n         Ok(db)\n     }\n \n-    /// Performas the initial check on the database directory.\n+    /// Performs the initial check on the database directory.\n     fn open_directory(&mut self) -> Result<()> {\n         match fs::read_dir(&self.path) {\n             Ok(entries) => {"
        },
        {
            "sha": "1336c4ef95008c549ea56a3fbf4f181708dbe04b",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -207,6 +207,10 @@ impl<B: BackingStorage> TurboTasksBackend<B> {\n             backing_storage,\n         )))\n     }\n+\n+    pub fn invalidate_storage(&self) -> Result<()> {\n+        self.0.backing_storage.invalidate()\n+    }\n }\n \n impl<B: BackingStorage> TurboTasksBackendInner<B> {"
        },
        {
            "sha": "c94d6fd7f6c8e7f871699eb147b40a28aa8f6a42",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backing_storage.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbacking_storage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbacking_storage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbacking_storage.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -63,6 +63,16 @@ pub trait BackingStorage: 'static + Send + Sync {\n         category: TaskDataCategory,\n     ) -> Result<Vec<CachedDataItem>>;\n \n+    /// Called when the database should be invalidated upon re-initialization.\n+    ///\n+    /// This typically means that we'll restart the process or `turbo-tasks` soon with a fresh\n+    /// database. If this happens, there's no point in writing anything else to disk, or flushing\n+    /// during [`KeyValueDatabase::shutdown`].\n+    ///\n+    /// This can be implemented by calling [`crate::database::db_invalidation::invalidate_db`] with\n+    /// the database's non-versioned base path.\n+    fn invalidate(&self) -> Result<()>;\n+\n     fn shutdown(&self) -> Result<()> {\n         Ok(())\n     }"
        },
        {
            "sha": "47018d9f3292f5284b2c43a750b2faae0127ed61",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/db_invalidation.rs",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_invalidation.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -0,0 +1,69 @@\n+use std::{\n+    fs::{self, read_dir},\n+    io,\n+    path::Path,\n+};\n+\n+use anyhow::Context;\n+\n+const INVALIDATION_MARKER: &str = \"__turbo_tasks_invalidated_db\";\n+\n+/// Atomically write an invalidation marker.\n+///\n+/// Because attempting to delete currently open database files could cause issues, actual deletion\n+/// of files is deferred until the next start-up (in [`check_db_invalidation_and_cleanup`]).\n+///\n+/// In the case that no database is currently open (e.g. via a separate CLI subcommand), you should\n+/// call [`cleanup_db`] *after* this to eagerly remove the database files.\n+///\n+/// This should be run with the base (non-versioned) path, as that likely aligns closest with user\n+/// expectations (e.g. if they're clearing the cache for disk space reasons).\n+pub fn invalidate_db(base_path: &Path) -> anyhow::Result<()> {\n+    fs::write(base_path.join(INVALIDATION_MARKER), [0u8; 0])?;\n+    Ok(())\n+}\n+\n+/// Called during startup. See if the db is in a partially-completed invalidation state. Find and\n+/// delete any invalidated database files.\n+///\n+/// This should be run with the base (non-versioned) path.\n+pub fn check_db_invalidation_and_cleanup(base_path: &Path) -> anyhow::Result<()> {\n+    if fs::exists(base_path.join(INVALIDATION_MARKER))? {\n+        // if this cleanup fails, we might try to open an invalid database later, so it's best to\n+        // just propagate the error here.\n+        cleanup_db(base_path)?;\n+    };\n+    Ok(())\n+}\n+\n+/// Helper for [`check_db_invalidation_and_cleanup`]. You can call this to explicitly clean up a\n+/// database after running [`invalidate_db`] when turbo-tasks is not running.\n+///\n+/// You should not run this if the database has not yet been invalidated, as this operation is not\n+/// atomic and could result in a partially-deleted and corrupted database.\n+pub fn cleanup_db(base_path: &Path) -> anyhow::Result<()> {\n+    cleanup_db_inner(base_path).with_context(|| {\n+        format!(\n+            \"Unable to remove invalid database. If this issue persists you can work around by \\\n+             deleting {base_path:?}.\"\n+        )\n+    })\n+}\n+\n+fn cleanup_db_inner(base_path: &Path) -> io::Result<()> {\n+    let Ok(contents) = read_dir(base_path) else {\n+        return Ok(());\n+    };\n+\n+    // delete everything except the invalidation marker\n+    for entry in contents {\n+        let entry = entry?;\n+        if entry.file_name() != INVALIDATION_MARKER {\n+            fs::remove_dir_all(entry.path())?;\n+        }\n+    }\n+\n+    // delete the invalidation marker last, once we're sure everything is cleaned up\n+    fs::remove_file(base_path.join(INVALIDATION_MARKER))?;\n+    Ok(())\n+}"
        },
        {
            "sha": "449a1ba7a5fac12b16cf04ccf3b2da3d53324516",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/key_value_database.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fkey_value_database.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fkey_value_database.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fkey_value_database.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -52,6 +52,20 @@ pub trait KeyValueDatabase {\n         &self,\n     ) -> Result<WriteBatch<'_, Self::SerialWriteBatch<'_>, Self::ConcurrentWriteBatch<'_>>>;\n \n+    /// Called when the database has been invalidated via\n+    /// [`crate::backing_storage::BackingStorage::invalidate`]\n+    ///\n+    /// This typically means that we'll restart the process or `turbo-tasks` soon with a fresh\n+    /// database. If this happens, there's no point in writing anything else to disk, or flushing\n+    /// during [`KeyValueDatabase::shutdown`].\n+    ///\n+    /// This is a best-effort optimization hint, and the database may choose to ignore this and\n+    /// continue file writes. This happens after the database is invalidated, so it is valid for\n+    /// this to leave the database in a half-updated and corrupted state.\n+    fn prevent_writes(&self) {\n+        // this is an optional performance hint to the database\n+    }\n+\n     fn shutdown(&self) -> Result<()> {\n         Ok(())\n     }"
        },
        {
            "sha": "5b8ec3c7c2952ef17daa1ea675999f911e751ff3",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fmod.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -1,5 +1,6 @@\n #[cfg(feature = \"lmdb\")]\n mod by_key_space;\n+pub mod db_invalidation;\n pub mod db_versioning;\n #[cfg(feature = \"lmdb\")]\n pub mod fresh_db_optimization;"
        },
        {
            "sha": "4ad244bd0aaa386f66976e4e6f0d3a7791b10580",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/turbo.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -23,8 +23,8 @@ pub struct TurboKeyValueDatabase {\n }\n \n impl TurboKeyValueDatabase {\n-    pub fn new(path: PathBuf) -> Result<Self> {\n-        let db = Arc::new(TurboPersistence::open(path.to_path_buf())?);\n+    pub fn new(versioned_path: PathBuf) -> Result<Self> {\n+        let db = Arc::new(TurboPersistence::open(versioned_path)?);\n         let mut this = Self {\n             db: db.clone(),\n             compact_join_handle: Mutex::new(None),\n@@ -99,6 +99,8 @@ impl KeyValueDatabase for TurboKeyValueDatabase {\n         }))\n     }\n \n+    fn prevent_writes(&self) {}\n+\n     fn shutdown(&self) -> Result<()> {\n         // Wait for the compaction to finish\n         if let Some(join_handle) = self.compact_join_handle.lock().take() {"
        },
        {
            "sha": "dc616ebbf804a349df2f314943639aa077a9ee96",
            "filename": "turbopack/crates/turbo-tasks-backend/src/kv_backing_storage.rs",
            "status": "modified",
            "additions": 38,
            "deletions": 3,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -1,4 +1,4 @@\n-use std::{borrow::Borrow, cmp::max, sync::Arc};\n+use std::{borrow::Borrow, cmp::max, path::PathBuf, sync::Arc};\n \n use anyhow::{Context, Result, anyhow};\n use rayon::iter::{IndexedParallelIterator, IntoParallelIterator, ParallelIterator};\n@@ -8,10 +8,13 @@ use tracing::Span;\n use turbo_tasks::{SessionId, TaskId, backend::CachedTaskType, turbo_tasks_scope};\n \n use crate::{\n+    GitVersionInfo,\n     backend::{AnyOperation, TaskDataCategory},\n     backing_storage::BackingStorage,\n     data::CachedDataItem,\n     database::{\n+        db_invalidation::{check_db_invalidation_and_cleanup, invalidate_db},\n+        db_versioning::handle_db_versioning,\n         key_value_database::{KeySpace, KeyValueDatabase},\n         write_batch::{\n             BaseWriteBatch, ConcurrentWriteBatch, SerialWriteBatch, WriteBatch, WriteBatchRef,\n@@ -82,11 +85,31 @@ fn as_u32(bytes: impl Borrow<[u8]>) -> Result<u32> {\n \n pub struct KeyValueDatabaseBackingStorage<T: KeyValueDatabase> {\n     database: T,\n+    /// Used when calling [`BackingStorage::invalidate`]. Can be `None` in the memory-only/no-op\n+    /// storage case.\n+    base_path: Option<PathBuf>,\n }\n \n impl<T: KeyValueDatabase> KeyValueDatabaseBackingStorage<T> {\n-    pub fn new(database: T) -> Self {\n-        Self { database }\n+    pub fn new_in_memory(database: T) -> Self {\n+        Self {\n+            database,\n+            base_path: None,\n+        }\n+    }\n+\n+    pub fn open_versioned_on_disk(\n+        base_path: PathBuf,\n+        version_info: &GitVersionInfo,\n+        is_ci: bool,\n+        database: impl FnOnce(PathBuf) -> Result<T>,\n+    ) -> Result<Self> {\n+        check_db_invalidation_and_cleanup(&base_path)?;\n+        let versioned_path = handle_db_versioning(&base_path, version_info, is_ci)?;\n+        Ok(Self {\n+            database: (database)(versioned_path)?,\n+            base_path: Some(base_path),\n+        })\n     }\n \n     fn with_tx<R>(\n@@ -442,6 +465,18 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorage\n             .with_context(|| format!(\"Looking up data for {task_id} from database failed\"))\n     }\n \n+    fn invalidate(&self) -> Result<()> {\n+        // `base_path` can be `None` for a `NoopKvDb`\n+        if let Some(base_path) = &self.base_path {\n+            // Invalidate first, as it's a very fast atomic operation. `prevent_writes` is allowed\n+            // to be slower (e.g. wait for a lock) and is allowed to corrupt the database with\n+            // partial writes.\n+            invalidate_db(base_path)?;\n+            self.database.prevent_writes()\n+        }\n+        Ok(())\n+    }\n+\n     fn shutdown(&self) -> Result<()> {\n         self.database.shutdown()\n     }"
        },
        {
            "sha": "fc266b2a0dff8025245d5bb825fbd40aadf48865",
            "filename": "turbopack/crates/turbo-tasks-backend/src/lib.rs",
            "status": "modified",
            "additions": 23,
            "deletions": 16,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2ef787b12ed9e0efd1469506a344e2cbf5c79b17/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs?ref=2ef787b12ed9e0efd1469506a344e2cbf5c79b17",
            "patch": "@@ -15,9 +15,7 @@ use std::path::Path;\n \n use anyhow::Result;\n \n-use crate::database::{\n-    db_versioning::handle_db_versioning, noop_kv::NoopKvDb, turbo::TurboKeyValueDatabase,\n-};\n+use crate::database::{noop_kv::NoopKvDb, turbo::TurboKeyValueDatabase};\n pub use crate::{\n     backend::{BackendOptions, StorageMode, TurboTasksBackend},\n     database::db_versioning::GitVersionInfo,\n@@ -37,7 +35,7 @@ pub type LmdbBackingStorage = KeyValueDatabaseBackingStorage<\n \n #[cfg(feature = \"lmdb\")]\n pub fn lmdb_backing_storage(\n-    path: &Path,\n+    base_path: &Path,\n     version_info: &GitVersionInfo,\n     is_ci: bool,\n ) -> Result<LmdbBackingStorage> {\n@@ -47,31 +45,40 @@ pub fn lmdb_backing_storage(\n         startup_cache::StartupCacheLayer,\n     };\n \n-    let path = handle_db_versioning(path, version_info, is_ci)?;\n-    let fresh_db = is_fresh(&path);\n-    let database = crate::database::lmdb::LmbdKeyValueDatabase::new(&path)?;\n-    let database = FreshDbOptimization::new(database, fresh_db);\n-    let database = StartupCacheLayer::new(database, path.join(\"startup.cache\"), fresh_db)?;\n-    let database = ReadTransactionCache::new(database);\n-    Ok(KeyValueDatabaseBackingStorage::new(database))\n+    KeyValueDatabaseBackingStorage::open_versioned_on_disk(\n+        base_path.to_owned(),\n+        version_info,\n+        is_ci,\n+        |versioned_path| {\n+            let fresh_db = is_fresh(&versioned_path);\n+            let database = crate::database::lmdb::LmbdKeyValueDatabase::new(&versioned_path)?;\n+            let database = FreshDbOptimization::new(database, fresh_db);\n+            let database =\n+                StartupCacheLayer::new(database, versioned_path.join(\"startup.cache\"), fresh_db)?;\n+            Ok(ReadTransactionCache::new(database))\n+        },\n+    )\n }\n \n pub type TurboBackingStorage = KeyValueDatabaseBackingStorage<TurboKeyValueDatabase>;\n \n pub fn turbo_backing_storage(\n-    path: &Path,\n+    base_path: &Path,\n     version_info: &GitVersionInfo,\n     is_ci: bool,\n ) -> Result<TurboBackingStorage> {\n-    let path = handle_db_versioning(path, version_info, is_ci)?;\n-    let database = TurboKeyValueDatabase::new(path)?;\n-    Ok(KeyValueDatabaseBackingStorage::new(database))\n+    KeyValueDatabaseBackingStorage::open_versioned_on_disk(\n+        base_path.to_owned(),\n+        version_info,\n+        is_ci,\n+        TurboKeyValueDatabase::new,\n+    )\n }\n \n pub type NoopBackingStorage = KeyValueDatabaseBackingStorage<NoopKvDb>;\n \n pub fn noop_backing_storage() -> NoopBackingStorage {\n-    KeyValueDatabaseBackingStorage::new(NoopKvDb)\n+    KeyValueDatabaseBackingStorage::new_in_memory(NoopKvDb)\n }\n \n #[cfg(feature = \"lmdb\")]"
        }
    ],
    "stats": {
        "total": 252,
        "additions": 225,
        "deletions": 27
    }
}