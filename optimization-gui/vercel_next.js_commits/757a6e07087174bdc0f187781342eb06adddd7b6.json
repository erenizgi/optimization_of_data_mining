{
    "author": "lubieowoce",
    "message": "test: ensure that router identity stays stable when navigating (#77356)\n\nI've added some tests to make sure the return value of `useRouter()`\nstays stable when we dispatch an action to the action queue. Honestly, i\nthought we had some, but it looks like we didn't.\nThe motivation for this is that\nhttps://github.com/vercel/next.js/pull/76976 accidentally made\n`useRouter()` return a new value after each action (or navigation). This\naffected userspace code, which generally assumes that the return value\nof `useRouter` is stable (which it should be).\n\n---\n\nThe bug was here, in our `useReducer` (used for dispatching to the\nactionQueue):\n\n\nhttps://github.com/vercel/next.js/blob/5576edd3124277be568734d5d26923e9d75e520a/packages/next/src/client/components/use-reducer.ts#L45-L49\n\nthe `useCallback()` wrapping `dispatchCallback` also has\n`dispatchCallback` listed in the dependencies, and `dispatchCallback` is\na fresh closure on every render, so in the end `useCallback` has no\neffect.\n\nas a result, the returned `dispatch` function is always changing, which\nleads to a cascade of changes everywhere.\nfor example, we'll recreate `appRouter` each time `Router` rerenders\n(which mainly happens because of an action/navigation), because\n`dispatch` is one of its dependencies:\n\nhttps://github.com/vercel/next.js/blob/5b9d66a9b872ad28336988b768af34852a85e9e3/packages/next/src/client/components/app-router.tsx#L355-L356\n\nOriginally, i also had a fix for that here, but in the meantime, the bad\nmemoization was fixed in https://github.com/vercel/next.js/pull/77354,\nso this is just tests now.",
    "sha": "757a6e07087174bdc0f187781342eb06adddd7b6",
    "files": [
        {
            "sha": "b6d09adeb2d05c66093af15801ef7bfb6fafdbaf",
            "filename": "test/e2e/app-dir/navigation/app/use-router/navigate.js",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fnavigate.js",
            "raw_url": "https://github.com/vercel/next.js/raw/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fnavigate.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fnavigate.js?ref=757a6e07087174bdc0f187781342eb06adddd7b6",
            "patch": "@@ -0,0 +1,35 @@\n+'use client'\n+import { useRouter } from 'next/navigation'\n+import { useEffect, useState } from 'react'\n+\n+export function NavigateAndTrackRouterIdentity({ href }) {\n+  const router = useRouter()\n+\n+  const [changedCount, setChangedCount] = useState(-1)\n+  useEffect(() => {\n+    setChangedCount((p) => p + 1)\n+  }, [router])\n+\n+  const [navigationCount, setNavigationCount] = useState(0)\n+  const navigate = () => {\n+    setNavigationCount((p) => p + 1)\n+    console.log('navigating to', href)\n+    router.push(href)\n+  }\n+\n+  return (\n+    <>\n+      <div>\n+        navigations (without unmounting this component):{' '}\n+        <span id=\"count-from-client-state\">{navigationCount}</span>\n+      </div>\n+      <div>\n+        router identity changes:{' '}\n+        <span id=\"router-change-count\">{changedCount}</span>\n+      </div>\n+      <button id=\"trigger-push\" onClick={navigate}>\n+        navigate\n+      </button>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "48333214b49a4e9c53a53d92d7f905575a03db28",
            "filename": "test/e2e/app-dir/navigation/app/use-router/same-page/page.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fsame-page%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fsame-page%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fsame-page%2Fpage.js?ref=757a6e07087174bdc0f187781342eb06adddd7b6",
            "patch": "@@ -0,0 +1,22 @@\n+import { connection } from 'next/server'\n+import { NavigateAndTrackRouterIdentity } from '../navigate'\n+\n+export default async function Page({ searchParams }) {\n+  // the page should be dynamic so that `router.push()` to the current path actually does a request + navigates.\n+  await connection()\n+  const { count: countStr = '0' } = await searchParams\n+  const count = Number.parseInt(countStr)\n+  return (\n+    <>\n+      {/* add a changing element to know that we actually navigated */}\n+      <div id=\"count-from-server\">{count}</div>\n+      <NavigateAndTrackRouterIdentity\n+        href={\n+          '/use-router/same-page' +\n+          '?' +\n+          new URLSearchParams({ count: count + 1 })\n+        }\n+      />\n+    </>\n+  )\n+}"
        },
        {
            "sha": "37341f42f0ca9e7d0e51c1c516dbdc37117bd22b",
            "filename": "test/e2e/app-dir/navigation/app/use-router/shared-layout/layout.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Flayout.js?ref=757a6e07087174bdc0f187781342eb06adddd7b6",
            "patch": "@@ -0,0 +1,10 @@\n+import { NavigateToOther } from './navigate-to-other'\n+export default function Layout({ children }) {\n+  return (\n+    <>\n+      <NavigateToOther />\n+      <hr />\n+      {children}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "9e311b852b47b43286b0438a5dea02cca2a1761a",
            "filename": "test/e2e/app-dir/navigation/app/use-router/shared-layout/navigate-to-other.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Fnavigate-to-other.js",
            "raw_url": "https://github.com/vercel/next.js/raw/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Fnavigate-to-other.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Fnavigate-to-other.js?ref=757a6e07087174bdc0f187781342eb06adddd7b6",
            "patch": "@@ -0,0 +1,16 @@\n+'use client'\n+import { usePathname } from 'next/navigation'\n+import { NavigateAndTrackRouterIdentity } from '../navigate'\n+\n+export function NavigateToOther() {\n+  const pathname = usePathname()\n+  const otherPage = pathname.endsWith('/one')\n+    ? pathname.replace('/one', '/two')\n+    : pathname.endsWith('/two')\n+      ? pathname.replace('/two', '/one')\n+      : (() => {\n+          throw new Error('Unrecognized pathname: ' + pathname)\n+        })()\n+\n+  return <NavigateAndTrackRouterIdentity href={otherPage} />\n+}"
        },
        {
            "sha": "238dde944dc3630e08bad93cc27dc727aa5a3e76",
            "filename": "test/e2e/app-dir/navigation/app/use-router/shared-layout/one/page.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Fone%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Fone%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Fone%2Fpage.js?ref=757a6e07087174bdc0f187781342eb06adddd7b6",
            "patch": "@@ -0,0 +1,6 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+  return <h1>One</h1>\n+}"
        },
        {
            "sha": "d881491110801664c6e040ddc097641f90d7417e",
            "filename": "test/e2e/app-dir/navigation/app/use-router/shared-layout/two/page.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Ftwo%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Ftwo%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fapp%2Fuse-router%2Fshared-layout%2Ftwo%2Fpage.js?ref=757a6e07087174bdc0f187781342eb06adddd7b6",
            "patch": "@@ -0,0 +1,6 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+  return <h1>Two</h1>\n+}"
        },
        {
            "sha": "9f998b1b88d9d0c0ef8e42d05c8cff69d8c89cfb",
            "filename": "test/e2e/app-dir/navigation/navigation.test.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fnavigation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/757a6e07087174bdc0f187781342eb06adddd7b6/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fnavigation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnavigation%2Fnavigation.test.ts?ref=757a6e07087174bdc0f187781342eb06adddd7b6",
            "patch": "@@ -1011,4 +1011,65 @@ describe('app dir - navigation', () => {\n       })\n     })\n   }\n+\n+  describe('useRouter identity between navigations', () => {\n+    it('should preserve identity when navigating to the same page', async () => {\n+      const browser = await next.browser('/use-router/same-page')\n+\n+      expect(await browser.elementByCss('#count-from-server').text()).toBe('0')\n+      expect(\n+        await browser.elementByCss('#count-from-client-state').text()\n+      ).toBe('0')\n+      expect(await browser.elementByCss('#router-change-count').text()).toBe(\n+        '0'\n+      )\n+\n+      for (let i = 1; i <= 3; i++) {\n+        await browser.elementByCss('#trigger-push').click()\n+        await retry(async () => {\n+          expect(await browser.elementByCss('#count-from-server').text()).toBe(\n+            `${i}`\n+          )\n+          // the client state is independent from the count we keep in the queryparam.\n+          // we expect it to stay mounted and thus keep its own count.\n+          // if it was getting unmounted, then its count of router changes would always stay at 0.\n+          expect(\n+            await browser.elementByCss('#count-from-client-state').text()\n+          ).toBe(`${i}`)\n+          expect(\n+            await browser.elementByCss('#router-change-count').text()\n+          ).toBe('0')\n+        })\n+      }\n+    })\n+\n+    it('should preserve identity when navigating between different pages', async () => {\n+      const browser = await next.browser('/use-router/shared-layout/one')\n+\n+      expect(await browser.elementByCss('h1').text()).toBe('One')\n+      expect(\n+        await browser.elementByCss('#count-from-client-state').text()\n+      ).toBe('0')\n+      expect(await browser.elementByCss('#router-change-count').text()).toBe(\n+        '0'\n+      )\n+\n+      for (let i = 1; i <= 3; i++) {\n+        await browser.elementByCss('#trigger-push').click()\n+        await retry(async () => {\n+          expect(await browser.elementByCss('h1').text()).toBe(\n+            i % 2 === 0 ? 'One' : 'Two'\n+          )\n+          // we expect the client part to stay mounted and thus keep its own count.\n+          // if it was getting unmounted, then its count of router changes would always be 0.\n+          expect(\n+            await browser.elementByCss('#count-from-client-state').text()\n+          ).toBe(`${i}`)\n+          expect(\n+            await browser.elementByCss('#router-change-count').text()\n+          ).toBe('0')\n+        })\n+      }\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 156,
        "additions": 156,
        "deletions": 0
    }
}