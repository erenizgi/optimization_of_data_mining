{
    "author": "eps1lon",
    "message": "Preserve slashes when custom URL schemes are used in redirects (#78176)\n\nResolves https://github.com/vercel/next.js/pull/77932#issuecomment-2800131282",
    "sha": "dbc50c25a983b46abe657b047514ccc8ac61ef6f",
    "files": [
        {
            "sha": "a53c20519a22d014961f2cb8c82f43a423a92aa6",
            "filename": "packages/next/src/shared/lib/router/utils/parse-relative-url.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/dbc50c25a983b46abe657b047514ccc8ac61ef6f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dbc50c25a983b46abe657b047514ccc8ac61ef6f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-relative-url.ts?ref=dbc50c25a983b46abe657b047514ccc8ac61ef6f",
            "patch": "@@ -8,6 +8,7 @@ export interface ParsedRelativeUrl {\n   pathname: string\n   query: ParsedUrlQuery\n   search: string\n+  slashes: undefined\n }\n \n /**\n@@ -58,5 +59,8 @@ export function parseRelativeUrl(\n     search,\n     hash,\n     href: href.slice(origin.length),\n+    // We don't know for relative URLs at this point since we set a custom, internal\n+    // base that isn't surfaced to users.\n+    slashes: undefined,\n   }\n }"
        },
        {
            "sha": "b716b5c14beb2cdaf01c869471787863aefc16ed",
            "filename": "packages/next/src/shared/lib/router/utils/parse-url.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/dbc50c25a983b46abe657b047514ccc8ac61ef6f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dbc50c25a983b46abe657b047514ccc8ac61ef6f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts?ref=dbc50c25a983b46abe657b047514ccc8ac61ef6f",
            "patch": "@@ -12,6 +12,7 @@ export interface ParsedUrl {\n   protocol?: string | null\n   query: ParsedUrlQuery\n   search: string\n+  slashes: boolean | undefined\n }\n \n export function parseUrl(url: string): ParsedUrl {\n@@ -29,5 +30,10 @@ export function parseUrl(url: string): ParsedUrl {\n     protocol: parsedURL.protocol,\n     query: searchParamsToUrlQuery(parsedURL.searchParams),\n     search: parsedURL.search,\n+    slashes:\n+      parsedURL.href.slice(\n+        parsedURL.protocol.length,\n+        parsedURL.protocol.length + 2\n+      ) === '//',\n   }\n }"
        },
        {
            "sha": "569fd54395e6e1caf8f834c746d07c29c0937329",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/dbc50c25a983b46abe657b047514ccc8ac61ef6f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dbc50c25a983b46abe657b047514ccc8ac61ef6f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts?ref=dbc50c25a983b46abe657b047514ccc8ac61ef6f",
            "patch": "@@ -20,6 +20,7 @@ describe('parseDestination', () => {\n        \"pathname\": \"/hello/:name\",\n        \"query\": {},\n        \"search\": \"\",\n+       \"slashes\": undefined,\n      }\n     `)\n   })\n@@ -45,6 +46,7 @@ describe('parseDestination', () => {\n        \"protocol\": \"https:\",\n        \"query\": {},\n        \"search\": \"\",\n+       \"slashes\": true,\n      }\n     `)\n   })\n@@ -72,6 +74,7 @@ describe('parseDestination', () => {\n          \"foo\": \":bar\",\n        },\n        \"search\": \"?foo=:bar\",\n+       \"slashes\": true,\n      }\n     `)\n   })"
        },
        {
            "sha": "5e3d38990b4327ab4bcd50e81085d9b2ad7d83f5",
            "filename": "packages/next/src/shared/lib/router/utils/resolve-rewrites.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/dbc50c25a983b46abe657b047514ccc8ac61ef6f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fresolve-rewrites.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dbc50c25a983b46abe657b047514ccc8ac61ef6f/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fresolve-rewrites.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fresolve-rewrites.ts?ref=dbc50c25a983b46abe657b047514ccc8ac61ef6f",
            "patch": "@@ -7,6 +7,10 @@ import { normalizeLocalePath } from '../../i18n/normalize-locale-path'\n import { removeBasePath } from '../../../../client/remove-base-path'\n import { parseRelativeUrl, type ParsedRelativeUrl } from './parse-relative-url'\n \n+interface ParsedAs extends Omit<ParsedRelativeUrl, 'slashes'> {\n+  slashes: boolean | undefined\n+}\n+\n export default function resolveRewrites(\n   asPath: string,\n   pages: string[],\n@@ -20,14 +24,14 @@ export default function resolveRewrites(\n   locales?: readonly string[]\n ): {\n   matchedPage: boolean\n-  parsedAs: ParsedRelativeUrl\n+  parsedAs: ParsedAs\n   asPath: string\n   resolvedHref?: string\n   externalDest?: boolean\n } {\n   let matchedPage = false\n   let externalDest = false\n-  let parsedAs = parseRelativeUrl(asPath)\n+  let parsedAs: ParsedAs = parseRelativeUrl(asPath)\n   let fsPathname = removeTrailingSlash(\n     normalizeLocalePath(removeBasePath(parsedAs.pathname), locales).pathname\n   )"
        },
        {
            "sha": "8479671fbf2449bd817d6bfd51b185b422222ecd",
            "filename": "test/e2e/app-dir/rewrites-redirects/next.config.js",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/dbc50c25a983b46abe657b047514ccc8ac61ef6f/test%2Fe2e%2Fapp-dir%2Frewrites-redirects%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/dbc50c25a983b46abe657b047514ccc8ac61ef6f/test%2Fe2e%2Fapp-dir%2Frewrites-redirects%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrites-redirects%2Fnext.config.js?ref=dbc50c25a983b46abe657b047514ccc8ac61ef6f",
            "patch": "@@ -20,6 +20,18 @@ module.exports = {\n         destination: '/config-redirect-catchall-after/:path*',\n         permanent: true,\n       },\n+      {\n+        source: '/config-redirect-itms-apps-slashes',\n+        destination:\n+          'itms-apps://apps.apple.com/de/app/xcode/id497799835?l=en-GB&mt=12',\n+        permanent: true,\n+      },\n+      {\n+        source: '/config-redirect-itms-apps-no-slashes',\n+        destination:\n+          'itms-apps:apps.apple.com/de/app/xcode/id497799835?l=en-GB&mt=12',\n+        permanent: true,\n+      },\n     ]\n   },\n }"
        },
        {
            "sha": "d0e04f7b074958ffdb9f1a9f63f09c601726cd96",
            "filename": "test/e2e/app-dir/rewrites-redirects/rewrites-redirects.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/dbc50c25a983b46abe657b047514ccc8ac61ef6f/test%2Fe2e%2Fapp-dir%2Frewrites-redirects%2Frewrites-redirects.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dbc50c25a983b46abe657b047514ccc8ac61ef6f/test%2Fe2e%2Fapp-dir%2Frewrites-redirects%2Frewrites-redirects.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrites-redirects%2Frewrites-redirects.test.ts?ref=dbc50c25a983b46abe657b047514ccc8ac61ef6f",
            "patch": "@@ -78,4 +78,26 @@ describe('redirects and rewrites', () => {\n       expect(url.pathname).toEndWith('-after')\n     })\n   })\n+\n+  it('redirects to exotic url schemes preserving slashes', async () => {\n+    const response = await next.fetch('/config-redirect-itms-apps-slashes', {\n+      redirect: 'manual',\n+    })\n+\n+    expect(response.headers.get('location')).toEqual(\n+      'itms-apps://apps.apple.com/de/app/xcode/id497799835?l=en-GB&mt=12'\n+    )\n+    expect(response.status).toBe(308)\n+  })\n+\n+  it('redirects to exotic url schemes without adding unwanted slashes', async () => {\n+    const response = await next.fetch('/config-redirect-itms-apps-no-slashes', {\n+      redirect: 'manual',\n+    })\n+\n+    expect(response.headers.get('location')).toEqual(\n+      'itms-apps:apps.apple.com/de/app/xcode/id497799835?l=en-GB&mt=12'\n+    )\n+    expect(response.status).toBe(308)\n+  })\n })"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 53,
        "deletions": 2
    }
}