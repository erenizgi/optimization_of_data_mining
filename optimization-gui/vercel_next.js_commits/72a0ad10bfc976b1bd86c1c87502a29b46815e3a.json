{
    "author": "huozhi",
    "message": "[perf] skip loading client manifest for static metadata routes (#77260)\n\n### What\n\nDuring development we had a retry logic to load the client manifest for\nApp Router routes, which is the requirement since #74835. But for static\nmetadata routes like `favicon.ico` it doesn't generate client manifest,\nloading it will cause extra loading time.\n\nRefactoring the metadata helpers to determine the static metadata routes\nmore strictly, mostly only cover the image one as their pathname and\nentry filename is pretty consistent. For sitemap or robots.txt it's\nstill fine to leave as it in dev for now. The delay is mostly waiting\nfor manifest.\n\nLong term goal is to build the static metadata routes as static output\nrather than compile each time.",
    "sha": "72a0ad10bfc976b1bd86c1c87502a29b46815e3a",
    "files": [
        {
            "sha": "ab468725ae4a910125381b7114c0a603bace1ef9",
            "filename": "packages/next/src/build/webpack/plugins/next-trace-entrypoints-plugin.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/72a0ad10bfc976b1bd86c1c87502a29b46815e3a/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72a0ad10bfc976b1bd86c1c87502a29b46815e3a/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts?ref=72a0ad10bfc976b1bd86c1c87502a29b46815e3a",
            "patch": "@@ -18,7 +18,7 @@ import picomatch from 'next/dist/compiled/picomatch'\n import { getModuleBuildInfo } from '../loaders/get-module-build-info'\n import { getPageFilePath } from '../../entries'\n import { resolveExternal } from '../../handle-externals'\n-import { isStaticMetadataRoute } from '../../../lib/metadata/is-metadata-route'\n+import { isStaticMetadataRoutePage } from '../../../lib/metadata/is-metadata-route'\n import { getCompilationSpan } from '../utils'\n \n const PLUGIN_NAME = 'TraceEntryPointsPlugin'\n@@ -243,7 +243,7 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n \n           const entryIsStaticMetadataRoute =\n             appDirRelativeEntryPath &&\n-            isStaticMetadataRoute(appDirRelativeEntryPath)\n+            isStaticMetadataRoutePage(appDirRelativeEntryPath)\n \n           // Include the client reference manifest in the trace, but not for\n           // static metadata routes, for which we don't generate those."
        },
        {
            "sha": "1d053fe4ae69a7a06df25f945669416c2159986e",
            "filename": "packages/next/src/lib/metadata/is-metadata-route.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 5,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/72a0ad10bfc976b1bd86c1c87502a29b46815e3a/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72a0ad10bfc976b1bd86c1c87502a29b46815e3a/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fis-metadata-route.ts?ref=72a0ad10bfc976b1bd86c1c87502a29b46815e3a",
            "patch": "@@ -1,5 +1,6 @@\n import type { PageExtensions } from '../../build/page-extensions-type'\n import { normalizePathSep } from '../../shared/lib/page-path/normalize-path-sep'\n+import { isAppRouteRoute } from '../is-app-route-route'\n \n export const STATIC_METADATA_IMAGES = {\n   icon: {\n@@ -127,15 +128,24 @@ export function isMetadataRouteFile(\n   )\n }\n \n-export function isStaticMetadataRouteFile(appDirRelativePath: string) {\n+export function isStaticMetadataRoutePage(appDirRelativePath: string) {\n   return isMetadataRouteFile(appDirRelativePath, [], true)\n }\n \n-export function isStaticMetadataRoute(page: string) {\n+// Check if the route is a static metadata route, with /route suffix\n+// e.g. /favicon.ico/route, /icon.png/route, etc.\n+// But skip the text routes like robots.txt since they might also be dynamic.\n+// Checking route path is not enough to determine if text routes is dynamic.\n+export function isStaticMetadataRoute(route: string) {\n+  const pathname = route.slice(0, -'/route'.length)\n   return (\n-    page === '/robots' ||\n-    page === '/manifest' ||\n-    isStaticMetadataRouteFile(page)\n+    isAppRouteRoute(route) &&\n+    isStaticMetadataRoutePage(pathname) &&\n+    // These routes can either be built by static or dynamic entrypoints,\n+    // so we assume they're dynamic\n+    pathname !== '/robots.txt' &&\n+    pathname !== '/manifest.webmanifest' &&\n+    !pathname.endsWith('/sitemap.xml')\n   )\n }\n "
        },
        {
            "sha": "00cfba7f2c2baed3a584955f1ec523e93b21097b",
            "filename": "packages/next/src/server/load-components.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/72a0ad10bfc976b1bd86c1c87502a29b46815e3a/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72a0ad10bfc976b1bd86c1c87502a29b46815e3a/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts?ref=72a0ad10bfc976b1bd86c1c87502a29b46815e3a",
            "patch": "@@ -33,6 +33,7 @@ import { setReferenceManifestsSingleton } from './app-render/encryption-utils'\n import { createServerModuleMap } from './app-render/action-utils'\n import type { DeepReadonly } from '../shared/lib/deep-readonly'\n import { normalizePagePath } from '../shared/lib/page-path/normalize-page-path'\n+import { isStaticMetadataRoute } from '../lib/metadata/is-metadata-route'\n \n export type ManifestItem = {\n   id: number | string\n@@ -195,6 +196,9 @@ async function loadComponentsImpl<N = any>({\n     )\n   }\n \n+  // Make sure to avoid loading the manifest for static metadata routes for better performance.\n+  const hasClientManifest = !isStaticMetadataRoute(page)\n+\n   // Load the manifest files first\n   //\n   // Loading page-specific manifests shouldn't throw an error if the manifest couldn't be found, so\n@@ -223,7 +227,7 @@ async function loadComponentsImpl<N = any>({\n           join(distDir, `${DYNAMIC_CSS_MANIFEST}.json`),\n           manifestLoadAttempts\n         ).catch(() => undefined),\n-    isAppPath\n+    isAppPath && hasClientManifest\n       ? tryLoadClientReferenceManifest(\n           join(\n             distDir,"
        },
        {
            "sha": "454f0ab896b158b68fbb27186e652ba0aab08a89",
            "filename": "packages/next/src/server/route-matcher-providers/dev/dev-app-route-route-matcher-provider.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/72a0ad10bfc976b1bd86c1c87502a29b46815e3a/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72a0ad10bfc976b1bd86c1c87502a29b46815e3a/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-matcher-providers%2Fdev%2Fdev-app-route-route-matcher-provider.ts?ref=72a0ad10bfc976b1bd86c1c87502a29b46815e3a",
            "patch": "@@ -53,7 +53,7 @@ export class DevAppRouteRouteMatcherProvider extends FileCacheRouteMatcherProvid\n         true\n       )\n \n-      if (!isStaticMetadataRoute(page) && isEntryMetadataRouteFile) {\n+      if (isEntryMetadataRouteFile && !isStaticMetadataRoute(page)) {\n         // Matching dynamic metadata routes.\n         // Add 2 possibilities for both single and multiple routes:\n         {"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 23,
        "deletions": 9
    }
}