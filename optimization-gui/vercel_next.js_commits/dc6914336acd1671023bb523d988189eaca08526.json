{
    "author": "eps1lon",
    "message": "Ensure constructor for `useSearchParams` can be imported for `instanceof` checks (#87269)",
    "sha": "dc6914336acd1671023bb523d988189eaca08526",
    "files": [
        {
            "sha": "203ceb449f668364df56474126188bcedb679cca",
            "filename": "packages/next/src/client/components/navigation-devtools.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/dc6914336acd1671023bb523d988189eaca08526/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-devtools.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dc6914336acd1671023bb523d988189eaca08526/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-devtools.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation-devtools.ts?ref=dc6914336acd1671023bb523d988189eaca08526",
            "patch": "@@ -2,14 +2,14 @@ import type { FlightRouterState } from '../../shared/lib/app-router-types'\n import type { Params } from '../../server/request/params'\n import {\n   createDevToolsInstrumentedPromise,\n+  ReadonlyURLSearchParams,\n   type InstrumentedPromise,\n   type NavigationPromises,\n } from '../../shared/lib/hooks-client-context.shared-runtime'\n import {\n   computeSelectedLayoutSegment,\n   getSelectedLayoutSegmentPath,\n } from '../../shared/lib/segment'\n-import { ReadonlyURLSearchParams } from './readonly-url-search-params'\n \n /**\n  * Promises are cached by tree to ensure stability across suspense retries.\n@@ -28,7 +28,7 @@ const layoutSegmentPromisesCache = new WeakMap<\n  * Creates instrumented promises for layout segment hooks at a given tree level.\n  * This is dev-only code for React Suspense DevTools instrumentation.\n  */\n-export function createLayoutSegmentPromises(\n+function createLayoutSegmentPromises(\n   tree: FlightRouterState\n ): LayoutSegmentPromisesCache | null {\n   if (process.env.NODE_ENV === 'production') {"
        },
        {
            "sha": "a92c93ad53f42873ee6bdf1be8944e099c05742d",
            "filename": "packages/next/src/client/components/navigation.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/dc6914336acd1671023bb523d988189eaca08526/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dc6914336acd1671023bb523d988189eaca08526/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fnavigation.ts?ref=dc6914336acd1671023bb523d988189eaca08526",
            "patch": "@@ -11,12 +11,12 @@ import {\n   PathnameContext,\n   PathParamsContext,\n   NavigationPromisesContext,\n+  ReadonlyURLSearchParams,\n } from '../../shared/lib/hooks-client-context.shared-runtime'\n import {\n   computeSelectedLayoutSegment,\n   getSelectedLayoutSegmentPath,\n } from '../../shared/lib/segment'\n-import { ReadonlyURLSearchParams } from './readonly-url-search-params'\n \n const useDynamicRouteParams =\n   typeof window === 'undefined'\n@@ -61,15 +61,15 @@ export function useSearchParams(): ReadonlyURLSearchParams {\n   // In the case where this is `null`, the compat types added in\n   // `next-env.d.ts` will add a new overload that changes the return type to\n   // include `null`.\n-  const readonlySearchParams = useMemo(() => {\n+  const readonlySearchParams = useMemo((): ReadonlyURLSearchParams => {\n     if (!searchParams) {\n       // When the router is not ready in pages, we won't have the search params\n       // available.\n-      return null\n+      return null!\n     }\n \n     return new ReadonlyURLSearchParams(searchParams)\n-  }, [searchParams]) as ReadonlyURLSearchParams\n+  }, [searchParams])\n \n   // Instrument with Suspense DevTools (dev-only)\n   if (process.env.NODE_ENV !== 'production' && 'use' in React) {\n@@ -285,13 +285,17 @@ export function useSelectedLayoutSegment(\n export { unstable_isUnrecognizedActionError } from './unrecognized-action-error'\n \n // Shared components APIs\n+export {\n+  // We need the same class that was used to instantiate the context value\n+  // Otherwise instanceof checks will fail in usercode\n+  ReadonlyURLSearchParams,\n+}\n export {\n   notFound,\n   forbidden,\n   unauthorized,\n   redirect,\n   permanentRedirect,\n   RedirectType,\n-  ReadonlyURLSearchParams,\n   unstable_rethrow,\n } from './navigation.react-server'"
        },
        {
            "sha": "995cae98ce1cf27ddeb878356f615fa6342a3717",
            "filename": "packages/next/src/shared/lib/hooks-client-context.shared-runtime.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/dc6914336acd1671023bb523d988189eaca08526/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhooks-client-context.shared-runtime.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dc6914336acd1671023bb523d988189eaca08526/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhooks-client-context.shared-runtime.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fhooks-client-context.shared-runtime.ts?ref=dc6914336acd1671023bb523d988189eaca08526",
            "patch": "@@ -2,6 +2,7 @@\n \n import { createContext } from 'react'\n import type { Params } from '../../server/request/params'\n+import { ReadonlyURLSearchParams } from '../../client/components/readonly-url-search-params'\n \n export const SearchParamsContext = createContext<URLSearchParams | null>(null)\n export const PathnameContext = createContext<string | null>(null)\n@@ -17,8 +18,8 @@ export type InstrumentedPromise<T> = Promise<T> & {\n \n export type NavigationPromises = {\n   pathname: InstrumentedPromise<string>\n-  searchParams: InstrumentedPromise<any> // ReadonlyURLSearchParams\n-  params: InstrumentedPromise<any> // Params\n+  searchParams: InstrumentedPromise<ReadonlyURLSearchParams>\n+  params: InstrumentedPromise<Params>\n   // Layout segment hooks (updated at each layout boundary)\n   selectedLayoutSegmentPromises?: Map<\n     string,\n@@ -44,6 +45,8 @@ export function createDevToolsInstrumentedPromise<T>(\n   return promise\n }\n \n+export { ReadonlyURLSearchParams }\n+\n if (process.env.NODE_ENV !== 'production') {\n   SearchParamsContext.displayName = 'SearchParamsContext'\n   PathnameContext.displayName = 'PathnameContext'"
        },
        {
            "sha": "f14d18d40b7bd1f0d9e617db1a7e9710ab06c7a1",
            "filename": "test/e2e/app-dir/hooks/app/hooks/use-search-params/instanceof/page.js",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/dc6914336acd1671023bb523d988189eaca08526/test%2Fe2e%2Fapp-dir%2Fhooks%2Fapp%2Fhooks%2Fuse-search-params%2Finstanceof%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/dc6914336acd1671023bb523d988189eaca08526/test%2Fe2e%2Fapp-dir%2Fhooks%2Fapp%2Fhooks%2Fuse-search-params%2Finstanceof%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fhooks%2Fapp%2Fhooks%2Fuse-search-params%2Finstanceof%2Fpage.js?ref=dc6914336acd1671023bb523d988189eaca08526",
            "patch": "@@ -0,0 +1,42 @@\n+'use client'\n+\n+import { useSearchParams, ReadonlyURLSearchParams } from 'next/navigation'\n+import { useSyncExternalStore } from 'react'\n+\n+export default function Page() {\n+  const searchParams = useSearchParams()\n+  const searchParamsClient = useSyncExternalStore(\n+    () => {\n+      return () => {}\n+    },\n+    () => {\n+      return searchParams\n+    },\n+    () => {\n+      return null\n+    }\n+  )\n+\n+  return (\n+    <ul>\n+      <li>\n+        server:{' '}\n+        <span data-testid=\"server\" suppressHydrationWarning>\n+          {searchParams instanceof ReadonlyURLSearchParams\n+            ? 'PASS instanceof check'\n+            : `FAILED Received: \"${String(searchParams)}\" instead instanceof ${searchParams.constructor.name}`}\n+        </span>\n+      </li>\n+      <li>\n+        client:{' '}\n+        <span data-testid=\"client\">\n+          {searchParamsClient === null\n+            ? '<pending>'\n+            : searchParamsClient instanceof ReadonlyURLSearchParams\n+              ? 'PASS instanceof check'\n+              : `FAILED Received: \"${String(searchParamsClient)}\" instead instanceof ${searchParamsClient.constructor.name}`}\n+        </span>\n+      </li>\n+    </ul>\n+  )\n+}"
        },
        {
            "sha": "ba6ae1c2ad9a46080a328ea96541fb1b81319792",
            "filename": "test/e2e/app-dir/hooks/hooks.test.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/dc6914336acd1671023bb523d988189eaca08526/test%2Fe2e%2Fapp-dir%2Fhooks%2Fhooks.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dc6914336acd1671023bb523d988189eaca08526/test%2Fe2e%2Fapp-dir%2Fhooks%2Fhooks.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fhooks%2Fhooks.test.ts?ref=dc6914336acd1671023bb523d988189eaca08526",
            "patch": "@@ -71,6 +71,26 @@ describe('app dir - hooks', () => {\n         expect($('#params-not-real').text()).toBe('N/A')\n       })\n     }\n+\n+    it('should be able to use instanceof ReadonlyURLSearchParams', async () => {\n+      const browser = await next.browser(\n+        '/hooks/use-search-params/instanceof?foo=bar'\n+      )\n+\n+      const [server, client] = await Promise.all([\n+        browser\n+          .elementByCss('[data-testid=\"server\"]')\n+          .then((handle) => handle.text()),\n+        browser\n+          .elementByCss('[data-testid=\"client\"]')\n+          .then((handle) => handle.text()),\n+      ])\n+\n+      expect({ client, server }).toEqual({\n+        server: 'PASS instanceof check',\n+        client: 'PASS instanceof check',\n+      })\n+    })\n   })\n \n   describe('useDraftMode', () => {"
        }
    ],
    "stats": {
        "total": 87,
        "additions": 78,
        "deletions": 9
    }
}