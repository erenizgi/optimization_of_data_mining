{
    "author": "mischnic",
    "message": "Turbopack: drop ASTs when only tracing (#84185)\n\nThese modules are never codgen-ed, so we can drop the AST after the analysis.\n\n```\nbefore:\nanalyze ecmascript module [project]/packages/next/dist/compiled/babel-packages/packages-bundle.js [externals-tracing] (ecmascript)\nAllocated memory: 274.32MB, Deallocated memory: 250.51MB\n\nafter:\nanalyze ecmascript module [project]/packages/next/dist/compiled/babel-packages/packages-bundle.js [externals-tracing] (ecmascript)\nAllocated memory: 273.46MB, Deallocated memory: 271.77MB\n```",
    "sha": "3b86694d9dd39f807cebf0800ae4311f1afad738",
    "files": [
        {
            "sha": "2b8096f44e1ff87f00419fd1cfee4f7dd5aefe4c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/3b86694d9dd39f807cebf0800ae4311f1afad738/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3b86694d9dd39f807cebf0800ae4311f1afad738/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=3b86694d9dd39f807cebf0800ae4311f1afad738",
            "patch": "@@ -401,6 +401,10 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n \n         let references: Vec<_> = self.references.into_iter().collect();\n \n+        if !self.analyze_mode.is_code_gen() {\n+            debug_assert!(self.code_gens.is_empty());\n+        }\n+\n         self.code_gens.shrink_to_fit();\n         Ok(AnalyzeEcmascriptModuleResult::cell(\n             AnalyzeEcmascriptModuleResult {\n@@ -575,7 +579,12 @@ async fn analyze_ecmascript_module_internal(\n         .await?;\n     }\n \n-    let parsed = parsed.await?;\n+    let parsed = if !analyze_mode.is_code_gen() {\n+        // We are never code-gening the module, so we can drop the AST after the analysis.\n+        parsed.final_read_hint().await?\n+    } else {\n+        parsed.await?\n+    };\n \n     let ParseResult::Ok {\n         program,"
        }
    ],
    "stats": {
        "total": 11,
        "additions": 10,
        "deletions": 1
    }
}