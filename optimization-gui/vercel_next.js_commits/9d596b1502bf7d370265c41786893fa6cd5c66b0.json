{
    "author": "bgw",
    "message": "Turbopack: Fix babel-loader (allowing built-in or manual configuration) (#82676)\n\n## Context: What's broken?\n\nFor using `styled-jsx` with `react-compiler`, we need to use `babel-loader`, but it turns out that outside of our current narrow use of `react-compiler`, our usage of `babel-loader` in Turbopack is totally broken:\n* Babel configs cause us to exit with an error claiming it's not supported.\n* We have code in Turbopack for enabling `babel-loader`, but we try to use the version from NPM instead of the one bundled internally with Next.js. We should use the one bundled internally with Next.js.\n* We shouldn't run all the babel transforms in the `next/babel` preset because they're redundant with SWC. `react-compiler` added a \"standalone\" mode to the babel-loader that's close to what we want, but I need to extend it for Turbopack's use-case.\n\n## This PR\n\n- Remove the warnings/errors that say babel isn't supported with Turbopack.\n- Automatically enable babel when a config file is present.\n- Modify the `next/babel` preset in Turbopack (I'm re-using/extending `'standalone'` mode) to enable syntax plugins, but disable any transformations or down-leveling (we expect SWC to do this). This is a bit hacky because babel's presets aren't designed to support this configuration.\n- Pre-bundle `plugin-syntax-typescript`. This is a stub package that's also used by the typescript preset, so this really just exposes an extra entrypoint into the babel bundle.\n- Migrate one of the legacy babel `test/integration` tests (that uses flow syntax) to `test/e2e`. The turbopack `foreign` condition doesn't work correctly without test isolation.\n- Enable Turbopack for all the babel-related integration and e2e tests I could find.\n\n## Follow-ups\n\n- [ ] https://github.com/vercel/next.js/pull/83502 React compiler can cause babel to run *twice*. Merge the logic for automatic configuration of `react-compiler` (currently in JS) and `babel` (in Rust), so that this can't happen.\n- [ ] https://github.com/vercel/next.js/pull/84002 Update the docs to show that Babel is now supported.",
    "sha": "9d596b1502bf7d370265c41786893fa6cd5c66b0",
    "files": [
        {
            "sha": "d3a3db832b4a05d842a82b9387ec4299c0021c87",
            "filename": "crates/next-core/src/next_shared/webpack_rules/babel.rs",
            "status": "modified",
            "additions": 37,
            "deletions": 76,
            "changes": 113,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fbabel.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fbabel.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fbabel.rs?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -1,16 +1,11 @@\n use std::sync::LazyLock;\n \n-use anyhow::Result;\n+use anyhow::{Context, Result};\n use regex::Regex;\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::{self, FileSystemEntryType, FileSystemPath};\n+use turbo_tasks::ResolvedVc;\n+use turbo_tasks_fs::{self, FileSystemEntryType, FileSystemPath, to_sys_path};\n use turbopack::module_options::{ConditionItem, LoaderRuleItem};\n-use turbopack_core::{\n-    issue::{Issue, IssueExt, IssueSeverity, IssueStage, OptionStyledString, StyledString},\n-    reference_type::{CommonJsReferenceSubType, ReferenceType},\n-    resolve::{node::node_cjs_resolve_options, parse::Request, pattern::Pattern, resolve},\n-};\n use turbopack_node::transforms::webpack::WebpackLoaderItem;\n \n use crate::next_shared::webpack_rules::WebpackLoaderBuiltinCondition;\n@@ -32,6 +27,10 @@ const BABEL_CONFIG_FILES: &[&str] = &[\n static BABEL_LOADER_RE: LazyLock<Regex> =\n     LazyLock::new(|| Regex::new(r\"(^|/)@?babel[-/]loader($|/|\\.)\").unwrap());\n \n+/// The forked version of babel-loader that we should use for automatic configuration. This version\n+/// is always available, as it's installed as part of next.js.\n+const NEXT_JS_BABEL_LOADER: &str = \"next/dist/build/babel/loader\";\n+\n pub async fn detect_likely_babel_loader(\n     webpack_rules: &[(RcStr, LoaderRuleItem)],\n ) -> Result<Option<RcStr>> {\n@@ -54,41 +53,39 @@ pub async fn detect_likely_babel_loader(\n pub async fn get_babel_loader_rules(\n     project_root: FileSystemPath,\n ) -> Result<Vec<(RcStr, LoaderRuleItem)>> {\n-    let mut has_babel_config = false;\n+    let mut babel_config_path = None;\n     for &filename in BABEL_CONFIG_FILES {\n-        let filetype = *project_root.join(filename)?.get_type().await?;\n+        let path = project_root.join(filename)?;\n+        let filetype = *path.get_type().await?;\n         if matches!(filetype, FileSystemEntryType::File) {\n-            has_babel_config = true;\n+            babel_config_path = Some(path);\n             break;\n         }\n     }\n-    if !has_babel_config {\n+    let Some(babel_config_path) = babel_config_path else {\n         return Ok(Vec::new());\n-    }\n+    };\n \n-    if !*is_babel_loader_available(project_root.clone()).await? {\n-        BabelIssue {\n-            path: project_root.clone(),\n-            title: StyledString::Text(rcstr!(\n-                \"Unable to resolve babel-loader, but a babel config is present\"\n-            ))\n-            .resolved_cell(),\n-            description: StyledString::Text(rcstr!(\n-                \"Make sure babel-loader is installed via your package manager.\"\n-            ))\n-            .resolved_cell(),\n-            severity: IssueSeverity::Fatal,\n-        }\n-        .resolved_cell()\n-        .emit();\n-    }\n+    // - See `packages/next/src/build/babel/loader/types.d.ts` for all the configuration options.\n+    // - See `packages/next/src/build/get-babel-loader-config.ts` for how we use this in webpack.\n+    let serde_json::Value::Object(loader_options) = serde_json::json!({\n+        // `transformMode: default` (what the webpack implementation does) would run all of the\n+        // Next.js-specific transforms as babel transforms. Because we always have to pay the cost\n+        // of parsing with SWC after the webpack loader runs, we want to keep running those\n+        // transforms using SWC, so use `standalone` instead.\n+        \"transformMode\": \"standalone\",\n+        \"cwd\": to_sys_path_str(project_root).await?,\n+        \"configFile\": to_sys_path_str(babel_config_path).await?,\n+    }) else {\n+        unreachable!(\"is an object\")\n+    };\n \n     Ok(vec![(\n         rcstr!(\"*.{js,jsx,ts,tsx,cjs,mjs,mts,cts}\"),\n         LoaderRuleItem {\n             loaders: ResolvedVc::cell(vec![WebpackLoaderItem {\n-                loader: rcstr!(\"babel-loader\"),\n-                options: Default::default(),\n+                loader: rcstr!(NEXT_JS_BABEL_LOADER),\n+                options: loader_options,\n             }]),\n             rename_as: Some(rcstr!(\"*\")),\n             condition: Some(ConditionItem::Not(Box::new(ConditionItem::Builtin(\n@@ -98,49 +95,13 @@ pub async fn get_babel_loader_rules(\n     )])\n }\n \n-#[turbo_tasks::function]\n-pub async fn is_babel_loader_available(project_path: FileSystemPath) -> Result<Vc<bool>> {\n-    let result = resolve(\n-        project_path.clone(),\n-        ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined),\n-        Request::parse(Pattern::Constant(rcstr!(\"babel-loader/package.json\"))),\n-        node_cjs_resolve_options(project_path),\n-    );\n-    let assets = result.primary_sources().await?;\n-    Ok(Vc::cell(!assets.is_empty()))\n-}\n-\n-#[turbo_tasks::value]\n-struct BabelIssue {\n-    path: FileSystemPath,\n-    title: ResolvedVc<StyledString>,\n-    description: ResolvedVc<StyledString>,\n-    severity: IssueSeverity,\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Issue for BabelIssue {\n-    #[turbo_tasks::function]\n-    fn stage(&self) -> Vc<IssueStage> {\n-        IssueStage::Transform.into()\n-    }\n-\n-    fn severity(&self) -> IssueSeverity {\n-        self.severity\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn file_path(&self) -> Vc<FileSystemPath> {\n-        self.path.clone().cell()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn title(&self) -> Vc<StyledString> {\n-        *self.title\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn description(&self) -> Vc<OptionStyledString> {\n-        Vc::cell(Some(self.description))\n-    }\n+/// A system path that can be passed to the webpack loader\n+async fn to_sys_path_str(path: FileSystemPath) -> Result<String> {\n+    let sys_path = to_sys_path(path)\n+        .await?\n+        .context(\"path should use a DiskFileSystem\")?;\n+    Ok(sys_path\n+        .to_str()\n+        .with_context(|| format!(\"{sys_path:?} is not valid utf-8\"))?\n+        .to_owned())\n }"
        },
        {
            "sha": "09e5374a281a3f06d7e00005ac1805cad182980c",
            "filename": "package.json",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -100,7 +100,6 @@\n     \"@babel/parser\": \"7.27.0\",\n     \"@babel/plugin-syntax-explicit-resource-management\": \"7.25.7\",\n     \"@babel/plugin-transform-object-rest-spread\": \"7.25.9\",\n-    \"@babel/preset-flow\": \"7.25.9\",\n     \"@babel/preset-react\": \"7.26.3\",\n     \"@changesets/changelog-github\": \"0.5.1\",\n     \"@changesets/cli\": \"2.29.3\","
        },
        {
            "sha": "f1baf3d34e24d421e148a2f5a868e2d6841725e4",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -808,5 +808,6 @@\n   \"807\": \"Expected a %s response header.\",\n   \"808\": \"Invalid binary HMR message: insufficient data (expected %s bytes, got %s)\",\n   \"809\": \"Invalid binary HMR message of type %s\",\n-  \"810\": \"React debug channel stream error\"\n+  \"810\": \"React debug channel stream error\",\n+  \"811\": \"unsupported transformMode in loader options: %s\"\n }"
        },
        {
            "sha": "299a4e5be59a0674df44a7ad36de8aacdc703b38",
            "filename": "packages/next/src/build/babel/loader/get-config.ts",
            "status": "modified",
            "additions": 117,
            "deletions": 99,
            "changes": 216,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -1,17 +1,21 @@\n-import { readFileSync } from 'fs'\n+import { readFileSync } from 'node:fs'\n+import { inspect } from 'node:util'\n import JSON5 from 'next/dist/compiled/json5'\n \n import { createConfigItem, loadOptions } from 'next/dist/compiled/babel/core'\n import loadFullConfig from 'next/dist/compiled/babel/core-lib-config'\n \n-import type { NextBabelLoaderOptions, NextJsLoaderContext } from './types'\n+import type {\n+  NextBabelLoaderOptionDefaultPresets,\n+  NextBabelLoaderOptions,\n+  NextJsLoaderContext,\n+} from './types'\n import {\n   consumeIterator,\n   type SourceMap,\n   type BabelLoaderTransformOptions,\n } from './util'\n import * as Log from '../../output/log'\n-import jsx from 'next/dist/compiled/babel/plugin-syntax-jsx'\n import { isReactCompilerRequired } from '../../swc'\n \n /**\n@@ -50,35 +54,51 @@ const nextDistPath =\n  * transformations.\n  */\n interface CharacteristicsGermaneToCaching {\n-  isServer: boolean\n-  isPageFile: boolean\n+  isStandalone: boolean\n+  isServer: boolean | undefined\n+  isPageFile: boolean | undefined\n   isNextDist: boolean\n   hasModuleExports: boolean\n   fileNameOrExt: string\n+  configFilePath: string | undefined\n }\n \n const fileExtensionRegex = /\\.([a-z]+)$/\n function getCacheCharacteristics(\n   loaderOptions: NextBabelLoaderOptions,\n   source: string,\n-  filename: string,\n-  transformMode: 'default' | 'standalone'\n+  filename: string\n ): CharacteristicsGermaneToCaching {\n-  const { isServer, pagesDir } = loaderOptions\n-  const isPageFile = filename.startsWith(pagesDir)\n+  let isStandalone, isServer, pagesDir, fileNameOrExt\n+  switch (loaderOptions.transformMode) {\n+    case 'default':\n+      isStandalone = false\n+      isServer = loaderOptions.isServer\n+      pagesDir = loaderOptions.pagesDir\n+      fileNameOrExt = fileExtensionRegex.exec(filename)?.[1] || 'unknown'\n+      break\n+    case 'standalone':\n+      isStandalone = true\n+      fileNameOrExt = filename\n+      break\n+    default:\n+      throw new Error(\n+        `unsupported transformMode in loader options: ${inspect(loaderOptions)}`\n+      )\n+  }\n+\n+  const isPageFile = pagesDir != null && filename.startsWith(pagesDir)\n   const isNextDist = nextDistPath.test(filename)\n   const hasModuleExports = source.indexOf('module.exports') !== -1\n-  const fileNameOrExt =\n-    transformMode === 'default'\n-      ? fileExtensionRegex.exec(filename)?.[1] || 'unknown'\n-      : filename\n \n   return {\n+    isStandalone,\n     isServer,\n     isPageFile,\n     isNextDist,\n     hasModuleExports,\n     fileNameOrExt,\n+    configFilePath: loaderOptions.configFile,\n   }\n }\n \n@@ -87,17 +107,13 @@ function getCacheCharacteristics(\n  * source file characteristics.\n  */\n function getPlugins(\n-  loaderOptions: NextBabelLoaderOptions,\n+  loaderOptions: NextBabelLoaderOptionDefaultPresets,\n   cacheCharacteristics: CharacteristicsGermaneToCaching\n ) {\n   const { isServer, isPageFile, isNextDist, hasModuleExports } =\n     cacheCharacteristics\n \n-  const { development } = loaderOptions\n-  const hasReactRefresh =\n-    loaderOptions.transformMode !== 'standalone'\n-      ? loaderOptions.hasReactRefresh\n-      : false\n+  const { development, hasReactRefresh } = loaderOptions\n \n   const applyCommonJsItem = hasModuleExports\n     ? createConfigItem(\n@@ -299,22 +315,23 @@ async function getFreshConfig(\n   filename: string,\n   inputSourceMap?: SourceMap\n ): Promise<ResolvedBabelConfig | null> {\n+  const {\n+    transformMode,\n+    configFile,\n+    reactCompilerPlugins,\n+    reactCompilerExclude,\n+  } = loaderOptions\n+\n   const hasReactCompiler = await (async () => {\n-    if (\n-      loaderOptions.reactCompilerPlugins &&\n-      loaderOptions.reactCompilerPlugins.length === 0\n-    ) {\n+    if (reactCompilerPlugins && reactCompilerPlugins.length === 0) {\n       return false\n     }\n \n     if (/[/\\\\]node_modules[/\\\\]/.test(filename)) {\n       return false\n     }\n \n-    if (\n-      loaderOptions.reactCompilerExclude &&\n-      loaderOptions.reactCompilerExclude(filename)\n-    ) {\n+    if (reactCompilerExclude && reactCompilerExclude(filename)) {\n       return false\n     }\n \n@@ -325,11 +342,25 @@ async function getFreshConfig(\n     return true\n   })()\n \n+  let customConfig = configFile && getCustomBabelConfig(configFile)\n+  if (transformMode === 'standalone' && !customConfig && !hasReactCompiler) {\n+    // Optimization: There's nothing useful to do, bail out and skip babel on this file\n+    return null\n+  }\n+\n+  checkCustomBabelConfigDeprecation(customConfig)\n+\n   const reactCompilerPluginsIfEnabled = hasReactCompiler\n     ? (loaderOptions.reactCompilerPlugins ?? [])\n     : []\n \n-  let { isServer, pagesDir, srcDir, development } = loaderOptions\n+  let isServer, pagesDir, srcDir, development\n+  if (transformMode === 'default') {\n+    isServer = loaderOptions.isServer\n+    pagesDir = loaderOptions.pagesDir\n+    srcDir = loaderOptions.srcDir\n+    development = loaderOptions.development\n+  }\n \n   let options: BabelLoaderTransformOptions = {\n     babelrc: false,\n@@ -341,7 +372,13 @@ async function getFreshConfig(\n     // so that it can properly map the module back to its internal cached\n     // modules.\n     sourceFileName: filename,\n-    sourceMaps: ctx.sourceMap,\n+\n+    // Set the default sourcemap behavior based on Webpack's mapping flag,\n+    // but allow users to override if they want.\n+    sourceMaps:\n+      loaderOptions.sourceMaps === undefined\n+        ? ctx.sourceMap\n+        : loaderOptions.sourceMaps,\n   }\n \n   const baseCaller = {\n@@ -363,70 +400,46 @@ async function getFreshConfig(\n     pagesDir,\n     isDev: development,\n \n+    transformMode,\n+\n     ...loaderOptions.caller,\n   }\n \n-  if (loaderOptions.transformMode === 'standalone') {\n-    if (!reactCompilerPluginsIfEnabled.length) {\n-      return null\n-    }\n+  options.plugins = [\n+    ...(transformMode === 'default'\n+      ? getPlugins(loaderOptions, cacheCharacteristics)\n+      : []),\n+    ...reactCompilerPluginsIfEnabled,\n+    ...(customConfig?.plugins || []),\n+  ]\n \n-    options.plugins = [jsx, ...reactCompilerPluginsIfEnabled]\n-    options.presets = [\n-      [\n-        require('next/dist/compiled/babel/preset-typescript') as typeof import('next/dist/compiled/babel/preset-typescript'),\n-        { allowNamespaces: true },\n-      ],\n-    ]\n-    options.caller = baseCaller\n-  } else {\n-    let { configFile, hasJsxRuntime } = loaderOptions\n-    let customConfig: any = configFile\n-      ? getCustomBabelConfig(configFile)\n-      : undefined\n-\n-    checkCustomBabelConfigDeprecation(customConfig)\n+  // target can be provided in babelrc\n+  options.target = isServer ? undefined : customConfig?.target\n \n-    // Set the default sourcemap behavior based on Webpack's mapping flag,\n-    // but allow users to override if they want.\n-    options.sourceMaps =\n-      loaderOptions.sourceMaps === undefined\n-        ? ctx.sourceMap\n-        : loaderOptions.sourceMaps\n-\n-    options.plugins = [\n-      ...getPlugins(loaderOptions, cacheCharacteristics),\n-      ...reactCompilerPluginsIfEnabled,\n-      ...(customConfig?.plugins || []),\n-    ]\n-\n-    // target can be provided in babelrc\n-    options.target = isServer ? undefined : customConfig?.target\n-\n-    // env can be provided in babelrc\n-    options.env = customConfig?.env\n+  // env can be provided in babelrc\n+  options.env = customConfig?.env\n \n-    options.presets = (() => {\n-      // If presets is defined the user will have next/babel in their babelrc\n-      if (customConfig?.presets) {\n-        return customConfig.presets\n-      }\n+  options.presets = (() => {\n+    // If presets is defined the user will have next/babel in their babelrc\n+    if (customConfig?.presets) {\n+      return customConfig.presets\n+    }\n \n-      // If presets is not defined the user will likely have \"env\" in their babelrc\n-      if (customConfig) {\n-        return undefined\n-      }\n+    // If presets is not defined the user will likely have \"env\" in their babelrc\n+    if (customConfig) {\n+      return undefined\n+    }\n \n-      // If no custom config is provided the default is to use next/babel\n-      return ['next/babel']\n-    })()\n+    // If no custom config is provided the default is to use next/babel\n+    return ['next/babel']\n+  })()\n \n-    options.overrides = loaderOptions.overrides\n+  options.overrides = loaderOptions.overrides\n \n-    options.caller = {\n-      ...baseCaller,\n-      hasJsxRuntime,\n-    }\n+  options.caller = {\n+    ...baseCaller,\n+    hasJsxRuntime:\n+      transformMode === 'default' ? loaderOptions.hasJsxRuntime : undefined,\n   }\n \n   // Babel does strict checks on the config so undefined is not allowed\n@@ -457,17 +470,27 @@ async function getFreshConfig(\n  * file attributes and Next.js compiler states: `CharacteristicsGermaneToCaching`.\n  */\n function getCacheKey(cacheCharacteristics: CharacteristicsGermaneToCaching) {\n-  const { isServer, isPageFile, isNextDist, hasModuleExports, fileNameOrExt } =\n-    cacheCharacteristics\n+  const {\n+    isStandalone,\n+    isServer,\n+    isPageFile,\n+    isNextDist,\n+    hasModuleExports,\n+    fileNameOrExt,\n+    configFilePath,\n+  } = cacheCharacteristics\n \n   const flags =\n     0 |\n-    (isServer ? 0b0001 : 0) |\n-    (isPageFile ? 0b0010 : 0) |\n-    (isNextDist ? 0b0100 : 0) |\n-    (hasModuleExports ? 0b1000 : 0)\n-\n-  return fileNameOrExt + flags\n+    (isStandalone ? 0b00001 : 0) |\n+    (isServer ? 0b00010 : 0) |\n+    (isPageFile ? 0b00100 : 0) |\n+    (isNextDist ? 0b01000 : 0) |\n+    (hasModuleExports ? 0b10000 : 0)\n+\n+  // separate strings will null bytes, assuming null bytes are not valid in file\n+  // paths\n+  return `${configFilePath || ''}\\x00${fileNameOrExt}\\x00${flags}`\n }\n \n const configCache: Map<any, ResolvedBabelConfig | null> = new Map()\n@@ -492,11 +515,10 @@ export default async function getConfig(\n   const cacheCharacteristics = getCacheCharacteristics(\n     loaderOptions,\n     source,\n-    filename,\n-    loaderOptions.transformMode\n+    filename\n   )\n \n-  if (loaderOptions.transformMode === 'default' && loaderOptions.configFile) {\n+  if (loaderOptions.configFile) {\n     // Ensures webpack invalidates the cache for this loader when the config file changes\n     ctx.addDependency(loaderOptions.configFile)\n   }\n@@ -520,11 +542,7 @@ export default async function getConfig(\n     }\n   }\n \n-  if (\n-    loaderOptions.transformMode === 'default' &&\n-    loaderOptions.configFile &&\n-    !configFiles.has(loaderOptions.configFile)\n-  ) {\n+  if (loaderOptions.configFile && !configFiles.has(loaderOptions.configFile)) {\n     configFiles.add(loaderOptions.configFile)\n     Log.info(\n       `Using external babel configuration from ${loaderOptions.configFile}`"
        },
        {
            "sha": "0b8dcf4b91c8da4d0085382b25c8d99482eaf941",
            "filename": "packages/next/src/build/babel/loader/types.d.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 13,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftypes.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftypes.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftypes.d.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -7,17 +7,34 @@ export interface NextJsLoaderContext extends webpack.LoaderContext<{}> {\n }\n \n export interface NextBabelLoaderBaseOptions {\n-  isServer: boolean\n-  distDir: string\n-  pagesDir: string\n   cwd: string\n-  srcDir: string\n-  caller: any\n-  development: boolean\n \n-  // Custom plugins to be added to the generated babel options.\n+  /**\n+   * Should we read the user-provided custom babel config? Used in both `transformMode`s.\n+   */\n+  configFile?: string\n+\n+  /**\n+   * Custom plugins to be added to the generated babel options.\n+   */\n   reactCompilerPlugins?: Array<any>\n+\n+  /**\n+   * Paths that the loader should not apply the react-compiler to.\n+   */\n   reactCompilerExclude?: (excludePath: string) => boolean\n+\n+  overrides?: any\n+\n+  /**\n+   * Extra fields to pass to presets/plugins via the Babel 'caller' API.\n+   */\n+  caller?: any\n+\n+  /**\n+   * Advanced: Can override webpack's sourcemap behavior (see `NextJsLoaderContext[\"sourceMap\"]`).\n+   */\n+  sourceMaps?: boolean | 'inline' | 'both' | null | undefined\n }\n \n /**\n@@ -28,19 +45,26 @@ export interface NextBabelLoaderBaseOptions {\n  */\n export type NextBabelLoaderOptionDefaultPresets = NextBabelLoaderBaseOptions & {\n   transformMode: 'default'\n+\n+  isServer: boolean\n+  distDir: string\n+  pagesDir: string | undefined\n+  srcDir: string\n+  development: boolean\n   hasJsxRuntime: boolean\n   hasReactRefresh: boolean\n-  sourceMaps?: boolean | 'inline' | 'both' | null | undefined\n-  overrides: any\n-  configFile: string | undefined\n }\n \n /**\n  * Options to create babel loader for 'standalone' transformations.\n  *\n- * This'll create a babel loader does not enable any of the default presets or plugins,\n- * only the ones specified in the options where swc loader is enabled but need to inject\n- * a babel specific plugins like react compiler.\n+ * This'll create a babel loader does not enable any of the default Next.js\n+ * presets or plugins that perform transformations. Non-transforming syntax\n+ * plugins (e.g. Typescript) will still be enabled.\n+ *\n+ * This is useful when Babel is used in combination with SWC, and we expect SWC\n+ * to perform downleveling and Next.js-specific transforms. Standalone mode is\n+ * used in Turbopack and when React Compiler is used with webpack.\n  */\n export type NextBabelLoaderOptionStandalone = NextBabelLoaderBaseOptions & {\n   transformMode: 'standalone'"
        },
        {
            "sha": "e108a95297e31efbf963e67bb65cbe17982a367f",
            "filename": "packages/next/src/build/babel/preset.ts",
            "status": "modified",
            "additions": 134,
            "deletions": 18,
            "changes": 152,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fpreset.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fpreset.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fpreset.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -42,7 +42,25 @@ type NextBabelPresetOptions = {\n   'class-properties'?: any\n   'transform-runtime'?: any\n   'styled-jsx'?: StyledJsxBabelOptions\n+  /**\n+   * `syntax-typescript` is a subset of `preset-typescript`.\n+   *\n+   * - When babel is used in \"standalone\" mode (e.g. alongside SWC when using\n+   *   react-compiler or turbopack) we'll prefer the options in\n+   *   'syntax-typescript`, and fall back to `preset-typescript`.\n+   *\n+   * - When babel is used in \"default\" mode (e.g. with a babel config in\n+   *   webpack) we'll prefer the options in `preset-typescript`, and fall back\n+   *   to `syntax-typescript`.\n+   */\n   'preset-typescript'?: any\n+  'syntax-typescript'?: {\n+    disallowAmbiguousJSXLike?: boolean\n+    dts?: boolean\n+    isTSX?: boolean\n+    allExtensions?: boolean\n+    ignoreExtensions?: boolean\n+  }\n }\n \n type BabelPreset = {\n@@ -57,12 +75,112 @@ function supportsStaticESM(caller: any): boolean {\n   return !!caller?.supportsStaticESM\n }\n \n+/**\n+ * HACK: A drop-in replacement for `@babel/preset-typescript` that only enables\n+ * `@babel/plugin-syntax-typescript` and does not transform the typescript.\n+ *\n+ * This is used for standalone mode, where Babel is being used alongside SWC\n+ * (i.e. Turbopack or with React Compiler on webpack).\n+ *\n+ * This should match the logic/behavior here:\n+ * https://github.com/babel/babel/blob/7f57d3a2e97b7e2800fb82cff9284a3591377971/packages/babel-preset-typescript/src/index.ts#L63\n+ */\n+function presetTypescriptSyntaxOnly(_api: unknown, options: any) {\n+  const { allExtensions, ignoreExtensions, ...restOptions } = options\n+  const disableExtensionDetect = allExtensions || ignoreExtensions\n+\n+  function getPlugins(isTSX: boolean, disallowAmbiguousJSXLike: boolean) {\n+    return [\n+      [\n+        require('next/dist/compiled/babel/plugin-syntax-typescript') as typeof import('next/dist/compiled/babel/plugin-syntax-typescript'),\n+        {\n+          isTSX,\n+          disallowAmbiguousJSXLike,\n+          ...restOptions,\n+        },\n+      ],\n+    ]\n+  }\n+\n+  return {\n+    plugins: [],\n+    overrides: disableExtensionDetect\n+      ? [\n+          {\n+            plugins: getPlugins(\n+              options.isTSX,\n+              options.disallowAmbiguousJSXLike\n+            ),\n+          },\n+        ]\n+      : // Only set 'test' if explicitly requested, since it requires that\n+        // Babel is being called with a filename.\n+        [\n+          {\n+            test: /\\.ts$/,\n+            plugins: getPlugins(false, false),\n+          },\n+          {\n+            test: /\\.mts$/,\n+            sourceType: 'module',\n+            plugins: getPlugins(false, true),\n+          },\n+          {\n+            test: /\\.cts$/,\n+            sourceType: 'unambiguous',\n+            plugins: getPlugins(false, true),\n+          },\n+          {\n+            test: /\\.tsx$/,\n+            plugins: getPlugins(true, false),\n+          },\n+        ],\n+  }\n+}\n+\n export default (\n   api: any,\n   options: NextBabelPresetOptions = {}\n ): BabelPreset => {\n-  const supportsESM = api.caller(supportsStaticESM)\n+  const isStandalone = api.caller(\n+    // NOTE: `transformMode` may be undefined if the user configured `babel-loader` themselves. In\n+    // this case, we should assume we're in 'default' mode.\n+    (caller: any) => caller.transformMode === 'standalone'\n+  )\n   const isServer = api.caller((caller: any) => !!caller && caller.isServer)\n+\n+  // syntax plugins that are used in both standalone and default modes\n+  const sharedSyntaxPlugins = [\n+    require('next/dist/compiled/babel/plugin-syntax-dynamic-import') as typeof import('next/dist/compiled/babel/plugin-syntax-dynamic-import'),\n+    [\n+      require('next/dist/compiled/babel/plugin-syntax-import-attributes') as typeof import('next/dist/compiled/babel/plugin-syntax-import-attributes'),\n+      {\n+        deprecatedAssertSyntax: true,\n+      },\n+    ],\n+    (isStandalone || isServer) &&\n+      (require('next/dist/compiled/babel/plugin-syntax-bigint') as typeof import('next/dist/compiled/babel/plugin-syntax-bigint')),\n+  ].filter(Boolean)\n+\n+  if (isStandalone) {\n+    // Just enable a few syntax plugins, we'll let SWC handle any of the downleveling or\n+    // next.js-specific transforms.\n+    return {\n+      sourceType: 'unambiguous',\n+      presets: [\n+        [\n+          presetTypescriptSyntaxOnly,\n+          options['syntax-typescript'] ?? options['preset-typescript'] ?? {},\n+        ],\n+      ],\n+      plugins: [\n+        require('next/dist/compiled/babel/plugin-syntax-jsx') as typeof import('next/dist/compiled/babel/plugin-syntax-jsx'),\n+        ...sharedSyntaxPlugins,\n+      ],\n+    }\n+  }\n+\n+  const supportsESM = api.caller(supportsStaticESM)\n   const isCallerDevelopment = api.caller((caller: any) => caller?.isDev)\n \n   // Look at external intent if used without a caller (e.g. via Jest):\n@@ -114,6 +232,9 @@ export default (\n     }\n   }\n \n+  const runtimeModuleName = isBabelLoader\n+    ? 'next/dist/compiled/@babel/runtime'\n+    : null\n   return {\n     sourceType: 'unambiguous',\n     presets: [\n@@ -133,10 +254,14 @@ export default (\n       ],\n       [\n         require('next/dist/compiled/babel/preset-typescript') as typeof import('next/dist/compiled/babel/preset-typescript'),\n-        { allowNamespaces: true, ...options['preset-typescript'] },\n+        {\n+          allowNamespaces: true,\n+          ...(options['preset-typescript'] || options['syntax-typescript']),\n+        },\n       ],\n     ],\n     plugins: [\n+      ...sharedSyntaxPlugins,\n       !useJsxRuntime && [\n         require('./plugins/jsx-pragma') as typeof import('./plugins/jsx-pragma'),\n         {\n@@ -156,13 +281,6 @@ export default (\n           lib: true,\n         },\n       ],\n-      require('next/dist/compiled/babel/plugin-syntax-dynamic-import') as typeof import('next/dist/compiled/babel/plugin-syntax-dynamic-import'),\n-      [\n-        require('next/dist/compiled/babel/plugin-syntax-import-attributes') as typeof import('next/dist/compiled/babel/plugin-syntax-import-attributes'),\n-        {\n-          deprecatedAssertSyntax: true,\n-        },\n-      ],\n       require('./plugins/react-loadable-plugin') as typeof import('./plugins/react-loadable-plugin'),\n       // only enable this plugin if custom config for it was provided\n       // otherwise we will only enable it if their browserslist triggers\n@@ -184,13 +302,13 @@ export default (\n           helpers: true,\n           regenerator: true,\n           useESModules: supportsESM && presetEnvConfig.modules !== 'commonjs',\n-          absoluteRuntime: isBabelLoader\n-            ? dirname(\n-                require.resolve(\n-                  'next/dist/compiled/@babel/runtime/package.json'\n-                )\n-              )\n-            : undefined,\n+          absoluteRuntime:\n+            runtimeModuleName != null\n+              ? dirname(require.resolve(`${runtimeModuleName}/package.json`))\n+              : undefined,\n+          // regenerator needs `moduleName` to be set in addition to\n+          // `absoluteRuntime`.\n+          moduleName: runtimeModuleName,\n           ...options['transform-runtime'],\n         },\n       ],\n@@ -207,8 +325,6 @@ export default (\n           removeImport: true,\n         },\n       ],\n-      isServer &&\n-        (require('next/dist/compiled/babel/plugin-syntax-bigint') as typeof import('next/dist/compiled/babel/plugin-syntax-bigint')),\n       // Always compile numeric separator because the resulting number is\n       // smaller.\n       require('next/dist/compiled/babel/plugin-proposal-numeric-separator') as typeof import('next/dist/compiled/babel/plugin-proposal-numeric-separator'),"
        },
        {
            "sha": "43b68cf31486c408500c21b0c0e29a3cf7053fa4",
            "filename": "packages/next/src/build/get-babel-loader-config.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 34,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fget-babel-loader-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fget-babel-loader-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fget-babel-loader-config.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -1,5 +1,9 @@\n import path from 'path'\n-import type { ReactCompilerOptions } from '../server/config-shared'\n+import type {\n+  ReactCompilerOptions,\n+  TurbopackLoaderOptions,\n+} from '../server/config-shared'\n+import type { NextBabelLoaderOptions } from './babel/loader/types'\n \n function getReactCompiler() {\n   try {\n@@ -15,7 +19,6 @@ function getReactCompiler() {\n \n const getReactCompilerPlugins = (\n   options: boolean | ReactCompilerOptions | undefined,\n-  isDev: boolean,\n   isServer: boolean\n ) => {\n   if (!options || isServer) {\n@@ -28,7 +31,8 @@ const getReactCompilerPlugins = (\n       [\n         getReactCompiler(),\n         {\n-          panicThreshold: isDev ? undefined : 'NONE',\n+          // https://react.dev/reference/react-compiler/panicThreshold\n+          panicThreshold: 'none',\n           ...compilerOptions,\n         },\n       ],\n@@ -51,26 +55,28 @@ const getBabelLoader = (\n   reactCompilerExclude: ((excludePath: string) => boolean) | undefined\n ) => {\n   if (!useSWCLoader) {\n+    // Make sure these options are kept in sync with\n+    // `packages/next/src/build/get-babel-loader-config.ts`\n+    const options: NextBabelLoaderOptions = {\n+      transformMode: 'default',\n+      configFile: babelConfigFile,\n+      isServer,\n+      distDir,\n+      pagesDir,\n+      cwd,\n+      srcDir: path.dirname(srcDir),\n+      development: dev,\n+      hasReactRefresh: dev && isClient,\n+      hasJsxRuntime: true,\n+      reactCompilerPlugins: getReactCompilerPlugins(\n+        reactCompilerOptions,\n+        isServer\n+      ),\n+      reactCompilerExclude,\n+    }\n     return {\n       loader: require.resolve('./babel/loader/index'),\n-      options: {\n-        transformMode: 'default',\n-        configFile: babelConfigFile,\n-        isServer,\n-        distDir,\n-        pagesDir,\n-        cwd,\n-        srcDir: path.dirname(srcDir),\n-        development: dev,\n-        hasReactRefresh: dev && isClient,\n-        hasJsxRuntime: true,\n-        reactCompilerPlugins: getReactCompilerPlugins(\n-          reactCompilerOptions,\n-          dev,\n-          isServer\n-        ),\n-        reactCompilerExclude,\n-      },\n+      options,\n     }\n   }\n \n@@ -84,31 +90,32 @@ const getBabelLoader = (\n  * > For best results, compiler must run as the first plugin in your Babel pipeline so it receives input as close to the original source as possible.\n  */\n const getReactCompilerLoader = (\n-  options: boolean | ReactCompilerOptions | undefined,\n+  reactCompilerOptions: boolean | ReactCompilerOptions | undefined,\n   cwd: string,\n-  isDev: boolean,\n   isServer: boolean,\n   reactCompilerExclude: ((excludePath: string) => boolean) | undefined\n ) => {\n-  const reactCompilerPlugins = getReactCompilerPlugins(options, isDev, isServer)\n+  const reactCompilerPlugins = getReactCompilerPlugins(\n+    reactCompilerOptions,\n+    isServer\n+  )\n   if (!reactCompilerPlugins) {\n     return undefined\n   }\n \n-  const config: any = {\n-    loader: require.resolve('./babel/loader/index'),\n-    options: {\n-      transformMode: 'standalone',\n-      cwd,\n-      reactCompilerPlugins,\n-    },\n+  const babelLoaderOptions: NextBabelLoaderOptions & TurbopackLoaderOptions = {\n+    transformMode: 'standalone',\n+    cwd,\n+    reactCompilerPlugins,\n   }\n-\n   if (reactCompilerExclude) {\n-    config.options.reactCompilerExclude = reactCompilerExclude\n+    babelLoaderOptions.reactCompilerExclude = reactCompilerExclude\n   }\n \n-  return config\n+  return {\n+    loader: require.resolve('./babel/loader/index'),\n+    options: babelLoaderOptions,\n+  }\n }\n \n export { getBabelLoader, getReactCompilerLoader }"
        },
        {
            "sha": "abc202b37057a72a11988bc17ed1118cadea3f3a",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 12,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -807,11 +807,16 @@ function bindingToApi(\n   ): Record<string, any> {\n     let nextConfig = { ...originalNextConfig }\n \n-    const reactCompilerOptions = nextConfig.experimental?.reactCompiler\n-\n     // TODO: Merge this with `crates/next-core/src/next_shared/webpack_rules/babel.rs` so that we're\n     // not configuring babel in two different places (potentially causing it to run twice)\n-    if (reactCompilerOptions) {\n+    const reactCompilerOptions = nextConfig.experimental?.reactCompiler\n+    const reactCompilerLoader = getReactCompilerLoader(\n+      nextConfig.experimental?.reactCompiler,\n+      projectPath,\n+      /* isServer */ false,\n+      /* reactCompilerExclude */ undefined\n+    )\n+    if (reactCompilerLoader != null) {\n       const options: ReactCompilerOptions =\n         typeof reactCompilerOptions === 'object' ? reactCompilerOptions : {}\n       nextConfig.turbopack = {\n@@ -820,15 +825,7 @@ function bindingToApi(\n           ...originalNextConfig.turbopack.rules,\n           // assumption: there is no collision with this glob key\n           '{*.{js,jsx,ts,tsx,cjs,mjs,mts,cts},react-compiler-builtin-rule}': {\n-            loaders: [\n-              getReactCompilerLoader(\n-                reactCompilerOptions,\n-                projectPath,\n-                nextConfig.dev,\n-                /* isServer */ false,\n-                /* reactCompilerExclude */ undefined\n-              ),\n-            ],\n+            loaders: [reactCompilerLoader],\n             condition: {\n               all: [\n                 'browser',"
        },
        {
            "sha": "e4fa52f80b7421d5a794e5dd8fd563c8445a06b7",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -491,7 +491,6 @@ export default async function getBaseWebpackConfig(\n     : getReactCompilerLoader(\n         config.experimental?.reactCompiler,\n         dir,\n-        dev,\n         isNodeOrEdgeCompilation,\n         codeCondition.exclude\n       )"
        },
        {
            "sha": "2f3ba50c7cae7dcfd4d7ad34668bea9b6b26b064",
            "filename": "packages/next/src/bundles/babel/bundle.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fbundle.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fbundle.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fbundle.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -80,6 +80,10 @@ function pluginSyntaxJsx() {\n   return require('next/dist/compiled/babel-packages').pluginSyntaxJsx()\n }\n \n+function pluginSyntaxTypescript() {\n+  return require('next/dist/compiled/babel-packages').pluginSyntaxTypescript()\n+}\n+\n function pluginTransformDefine() {\n   return require('next/dist/compiled/babel-packages').pluginTransformDefine()\n }\n@@ -129,6 +133,7 @@ module.exports = {\n   pluginSyntaxDynamicImport,\n   pluginSyntaxImportAttributes,\n   pluginSyntaxJsx,\n+  pluginSyntaxTypescript,\n   pluginTransformDefine,\n   pluginTransformModulesCommonjs,\n   pluginTransformReactRemovePropTypes,"
        },
        {
            "sha": "3445a30273664de191cf47280f279520ab32004a",
            "filename": "packages/next/src/bundles/babel/packages-bundle.js",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fpackages-bundle.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fpackages-bundle.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fpackages-bundle.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -36,6 +36,10 @@ function pluginSyntaxJsx() {\n   return require('@babel/plugin-syntax-jsx')\n }\n \n+function pluginSyntaxTypescript() {\n+  return require('@babel/plugin-syntax-typescript')\n+}\n+\n function pluginTransformDefine() {\n   return require('babel-plugin-transform-define')\n }\n@@ -74,6 +78,7 @@ module.exports = {\n   pluginSyntaxDynamicImport,\n   pluginSyntaxImportAttributes,\n   pluginSyntaxJsx,\n+  pluginSyntaxTypescript,\n   pluginTransformDefine,\n   pluginTransformModulesCommonjs,\n   pluginTransformReactRemovePropTypes,"
        },
        {
            "sha": "e93e1a4485ae6fa91b5e2003f8a30b089a4458d9",
            "filename": "packages/next/src/bundles/babel/packages/plugin-syntax-typescript.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fpackages%2Fplugin-syntax-typescript.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fpackages%2Fplugin-syntax-typescript.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbundles%2Fbabel%2Fpackages%2Fplugin-syntax-typescript.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -0,0 +1 @@\n+module.exports = require('./bundle').pluginSyntaxTypescript()"
        },
        {
            "sha": "5fb3a597786c09929c97d70215a970e9505fd358",
            "filename": "packages/next/src/compiled/babel-packages/packages-bundle.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel-packages%2Fpackages-bundle.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel-packages%2Fpackages-bundle.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel-packages%2Fpackages-bundle.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0"
        },
        {
            "sha": "6a69e57f417a9bbbae58ff4e7bae1228fa7e5923",
            "filename": "packages/next/src/compiled/babel/bundle.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel%2Fbundle.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel%2Fbundle.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel%2Fbundle.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0"
        },
        {
            "sha": "e93e1a4485ae6fa91b5e2003f8a30b089a4458d9",
            "filename": "packages/next/src/compiled/babel/plugin-syntax-typescript.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel%2Fplugin-syntax-typescript.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel%2Fplugin-syntax-typescript.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fbabel%2Fplugin-syntax-typescript.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -0,0 +1 @@\n+module.exports = require('./bundle').pluginSyntaxTypescript()"
        },
        {
            "sha": "1419761d0995d8e332b5a98dbd8ac42a6f761e6c",
            "filename": "packages/next/src/lib/turbopack-warning.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 46,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fturbopack-warning.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -1,5 +1,4 @@\n import type { NextConfig } from '../server/config-shared'\n-import path from 'path'\n import loadConfig from '../server/config'\n import * as Log from '../build/output/log'\n import {\n@@ -53,28 +52,21 @@ const unsupportedProductionSpecificTurbopackNextConfigOptions: string[] = [\n   // 'productionBrowserSourceMaps',\n ]\n \n-// check for babelrc, swc plugins\n export async function validateTurboNextConfig({\n   dir,\n   isDev,\n }: {\n   dir: string\n   isDev?: boolean\n }) {\n-  const { getPkgManager } =\n-    require('../lib/helpers/get-pkg-manager') as typeof import('../lib/helpers/get-pkg-manager')\n-  const { getBabelConfigFile } =\n-    require('../build/get-babel-config-file') as typeof import('../build/get-babel-config-file')\n   const { defaultConfig } =\n     require('../server/config-shared') as typeof import('../server/config-shared')\n-  const { bold, cyan, red, underline } =\n+  const { cyan, red, underline } =\n     require('../lib/picocolors') as typeof import('../lib/picocolors')\n   const { interopDefault } =\n     require('../lib/interop-default') as typeof import('../lib/interop-default')\n \n   let unsupportedParts = ''\n-  let babelrc = await getBabelConfigFile(dir)\n-  if (babelrc) babelrc = path.basename(babelrc)\n \n   let hasWebpackConfig = false\n   let hasTurboConfig = false\n@@ -170,10 +162,6 @@ export async function validateTurboNextConfig({\n     Log.error('Unexpected error occurred while checking config', e)\n   }\n \n-  const feedbackMessage = `Learn more about Next.js and Turbopack: ${underline(\n-    'https://nextjs.org/docs/architecture/turbopack'\n-  )}\\n`\n-\n   if (hasWebpackConfig && !hasTurboConfig) {\n     Log.warn(\n       `Webpack is configured while Turbopack is not, which may cause problems.`\n@@ -183,49 +171,25 @@ export async function validateTurboNextConfig({\n     )\n   }\n \n-  if (babelrc) {\n-    unsupportedParts += `Babel detected (${cyan(\n-      babelrc\n-    )})\\n  Babel is not yet supported. To use Turbopack at the moment,\\n  you'll need to remove your usage of Babel.`\n-  }\n-\n-  if (\n-    unsupportedConfig.length === 1 &&\n-    unsupportedConfig[0] === 'experimental.optimizePackageImports'\n-  ) {\n-    Log.warn(\n-      `'experimental.optimizePackageImports' is not yet supported by Turbopack and will be ignored.`\n-    )\n-  } else if (unsupportedConfig.length) {\n+  if (unsupportedConfig.length) {\n     unsupportedParts += `\\n\\n- Unsupported Next.js configuration option(s) (${cyan(\n       'next.config.js'\n-    )})\\n  To use Turbopack, remove the following configuration options:\\n${unsupportedConfig\n+    )})\\n  Turbopack will ignore the following configuration options:\\n${unsupportedConfig\n       .map((name) => `    - ${red(name)}\\n`)\n       .join('')}`\n   }\n \n   if (unsupportedParts) {\n-    const pkgManager = getPkgManager(dir)\n-\n     Log.error(\n-      `You are using configuration and/or tools that are not yet\\nsupported by Next.js with Turbopack:\\n${unsupportedParts}\\n\n-If you cannot make the changes above, but still want to try out\\nNext.js with Turbopack, create the Next.js playground app\\nby running the following commands:\n-\n-  ${bold(\n-    cyan(\n-      `${\n-        pkgManager === 'npm'\n-          ? 'npx create-next-app'\n-          : `${pkgManager} create next-app`\n-      } --example with-turbopack with-turbopack-app`\n-    )\n-  )}\\n  cd with-turbopack-app\\n  ${pkgManager} run dev\n-        `\n+      `You are using configuration and/or tools that are not yet\\nsupported by Next.js with Turbopack:\\n${unsupportedParts}\\n`\n     )\n \n-    Log.warn(feedbackMessage)\n-\n-    process.exit(1)\n+    Log.warn(\n+      'Learn more about how to configure Turbopack with Next.js:\\n' +\n+        underline(\n+          'https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack'\n+        )\n+    )\n   }\n \n   return rawNextConfig"
        },
        {
            "sha": "ac9c160e303d45efedbeaa61a3f515f34b480666",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -496,7 +496,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n                 .enum(['infer', 'annotation', 'all'])\n                 .optional(),\n               panicThreshold: z\n-                .enum(['ALL_ERRORS', 'CRITICAL_ERRORS', 'NONE'])\n+                .enum(['none', 'critical_errors', 'all_errors'])\n                 .optional(),\n             })\n             .optional(),"
        },
        {
            "sha": "05a06cd4302c9a26f2768bff2e40c034b77a1093",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 7,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -96,12 +96,14 @@ type JSONValue =\n   | JSONValue[]\n   | { [k: string]: JSONValue }\n \n+// At the moment, Turbopack options must be JSON-serializable, so restrict values.\n+export type TurbopackLoaderOptions = Record<string, JSONValue>\n+\n export type TurbopackLoaderItem =\n   | string\n   | {\n       loader: string\n-      // At the moment, Turbopack options must be JSON-serializable, so restrict values.\n-      options?: Record<string, JSONValue>\n+      options?: TurbopackLoaderOptions\n     }\n \n export type TurbopackLoaderBuiltinCondition =\n@@ -248,15 +250,36 @@ export interface NextJsWebpackConfig {\n }\n \n /**\n- * Set of options for the react compiler next.js\n- * currently supports.\n+ * Set of options for React Compiler that Next.js currently supports.\n+ *\n+ * These options may be changed in breaking ways at any time without notice\n+ * while support for React Compiler is experimental.\n  *\n- * This can be changed without breaking changes while supporting\n- * react compiler in the experimental phase.\n+ * @see https://react.dev/reference/react-compiler/configuration\n  */\n export interface ReactCompilerOptions {\n+  /**\n+   * Controls the strategy for determining which functions the React Compiler\n+   * will optimize.\n+   *\n+   * The default is `'infer'`, which uses intelligent heuristics to identify\n+   * React components and hooks.\n+   *\n+   * When using `infer`, Next.js applies its own heuristics before calling\n+   * `react-compiler`. This improves compilation performance by avoiding extra\n+   * invocations of Babel and reducing redundant parsing of code.\n+   *\n+   * @see https://react.dev/reference/react-compiler/compilationMode\n+   */\n   compilationMode?: 'infer' | 'annotation' | 'all'\n-  panicThreshold?: 'ALL_ERRORS' | 'CRITICAL_ERRORS' | 'NONE'\n+  /**\n+   * Controls how the React Compiler handles errors during compilation.\n+   *\n+   * The default is `'none'`, which skips components which cannot be compiled.\n+   *\n+   * @see https://react.dev/reference/react-compiler/panicThreshold\n+   */\n+  panicThreshold?: 'none' | 'critical_errors' | 'all_errors'\n }\n \n export interface IncomingRequestLoggingConfig {"
        },
        {
            "sha": "4c2ab7d371b1579371e3309831f8c4e495258438",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -8,6 +8,7 @@ declare module 'next/dist/compiled/postcss-modules-extract-imports'\n declare module 'next/dist/compiled/postcss-modules-scope'\n declare module 'next/dist/compiled/babel/plugin-transform-modules-commonjs'\n declare module 'next/dist/compiled/babel/plugin-syntax-jsx'\n+declare module 'next/dist/compiled/babel/plugin-syntax-typescript'\n declare module 'next/dist/compiled/loader-utils2'\n declare module 'next/dist/compiled/react-server-dom-webpack/client'\n declare module 'next/dist/compiled/react-server-dom-webpack/client.edge'"
        },
        {
            "sha": "c691b3356eea5f780e0492edc9dea8b43bef2579",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 0,
            "deletions": 39,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -69,9 +69,6 @@ importers:\n       '@babel/plugin-transform-object-rest-spread':\n         specifier: 7.25.9\n         version: 7.25.9(@babel/core@7.26.10)\n-      '@babel/preset-flow':\n-        specifier: 7.25.9\n-        version: 7.25.9(@babel/core@7.26.10)\n       '@babel/preset-react':\n         specifier: 7.26.3\n         version: 7.26.3(@babel/core@7.26.10)\n@@ -2267,12 +2264,6 @@ packages:\n     peerDependencies:\n       '@babel/core': 7.26.10\n \n-  '@babel/plugin-syntax-flow@7.26.0':\n-    resolution: {integrity: sha512-B+O2DnPc0iG+YXFqOxv2WNuNU97ToWjOomUQ78DouOENWUaM5sVrmet9mcomUGQFwpJd//gvUagXBSdzO1fRKg==}\n-    engines: {node: '>=6.9.0'}\n-    peerDependencies:\n-      '@babel/core': 7.26.10\n-\n   '@babel/plugin-syntax-import-assertions@7.26.0':\n     resolution: {integrity: sha512-QCWT5Hh830hK5EQa7XzuqIkQU9tT/whqbDz7kuaZMHFl1inRRg7JnuAEOQ0Ur0QUl0NufCk1msK2BeY79Aj/eg==}\n     engines: {node: '>=6.9.0'}\n@@ -2463,12 +2454,6 @@ packages:\n     peerDependencies:\n       '@babel/core': 7.26.10\n \n-  '@babel/plugin-transform-flow-strip-types@7.26.5':\n-    resolution: {integrity: sha512-eGK26RsbIkYUns3Y8qKl362juDDYK+wEdPGHGrhzUl6CewZFo55VZ7hg+CyMFU4dd5QQakBN86nBMpRsFpRvbQ==}\n-    engines: {node: '>=6.9.0'}\n-    peerDependencies:\n-      '@babel/core': 7.26.10\n-\n   '@babel/plugin-transform-for-of@7.26.9':\n     resolution: {integrity: sha512-Hry8AusVm8LW5BVFgiyUReuoGzPUpdHQQqJY5bZnbbf+ngOHWuCuYFKw/BqaaWlvEUrF91HMhDtEaI1hZzNbLg==}\n     engines: {node: '>=6.9.0'}\n@@ -2757,12 +2742,6 @@ packages:\n     peerDependencies:\n       '@babel/core': 7.26.10\n \n-  '@babel/preset-flow@7.25.9':\n-    resolution: {integrity: sha512-EASHsAhE+SSlEzJ4bzfusnXSHiU+JfAYzj+jbw2vgQKgq5HrUr8qs+vgtiEL5dOH6sEweI+PNt2D7AqrDSHyqQ==}\n-    engines: {node: '>=6.9.0'}\n-    peerDependencies:\n-      '@babel/core': 7.26.10\n-\n   '@babel/preset-modules@0.1.6-no-external-plugins':\n     resolution: {integrity: sha512-HrcgcIESLm9aIR842yhJ5RWan/gebQUJ6E/E5+rf0y9o6oj7w0Br+sWuL6kEQ/o/AdfvR1Je9jG18/gnpwjEyA==}\n     peerDependencies:\n@@ -18287,11 +18266,6 @@ snapshots:\n       '@babel/core': 7.26.10\n       '@babel/helper-plugin-utils': 7.26.5\n \n-  '@babel/plugin-syntax-flow@7.26.0(@babel/core@7.26.10)':\n-    dependencies:\n-      '@babel/core': 7.26.10\n-      '@babel/helper-plugin-utils': 7.26.5\n-\n   '@babel/plugin-syntax-import-assertions@7.26.0(@babel/core@7.26.10)':\n     dependencies:\n       '@babel/core': 7.26.10\n@@ -18484,12 +18458,6 @@ snapshots:\n       '@babel/helper-plugin-utils': 7.26.5\n       '@babel/plugin-syntax-flow': 7.24.7(@babel/core@7.26.10)\n \n-  '@babel/plugin-transform-flow-strip-types@7.26.5(@babel/core@7.26.10)':\n-    dependencies:\n-      '@babel/core': 7.26.10\n-      '@babel/helper-plugin-utils': 7.26.5\n-      '@babel/plugin-syntax-flow': 7.26.0(@babel/core@7.26.10)\n-\n   '@babel/plugin-transform-for-of@7.26.9(@babel/core@7.26.10)':\n     dependencies:\n       '@babel/core': 7.26.10\n@@ -18886,13 +18854,6 @@ snapshots:\n       '@babel/helper-validator-option': 7.25.9\n       '@babel/plugin-transform-flow-strip-types': 7.25.2(@babel/core@7.26.10)\n \n-  '@babel/preset-flow@7.25.9(@babel/core@7.26.10)':\n-    dependencies:\n-      '@babel/core': 7.26.10\n-      '@babel/helper-plugin-utils': 7.26.5\n-      '@babel/helper-validator-option': 7.25.9\n-      '@babel/plugin-transform-flow-strip-types': 7.26.5(@babel/core@7.26.10)\n-\n   '@babel/preset-modules@0.1.6-no-external-plugins(@babel/core@7.26.10)':\n     dependencies:\n       '@babel/core': 7.26.10"
        },
        {
            "sha": "024d9134c8fad74d0eef854eef591e41407b2c30",
            "filename": "test/e2e/app-dir/with-babel/with-babel.test.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 20,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fapp-dir%2Fwith-babel%2Fwith-babel.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fapp-dir%2Fwith-babel%2Fwith-babel.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwith-babel%2Fwith-babel.test.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -1,31 +1,34 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n \n-// Tests Babel, not needed for Turbopack\n-;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n-  'with babel',\n-  () => {\n-    describe('with babel', () => {\n-      const { next, isNextStart, skipped } = nextTestSetup({\n-        files: __dirname,\n-        skipDeployment: true,\n-      })\n+describe('with babel', () => {\n+  const { next, isNextStart, isTurbopack, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n \n-      if (skipped) {\n-        return\n-      }\n+  if (skipped) {\n+    return\n+  }\n \n-      it('should support babel in app dir', async () => {\n-        const $ = await next.render$('/')\n-        expect($('h1').text()).toBe('hello')\n-      })\n+  it('should support babel in app dir', async () => {\n+    const $ = await next.render$('/')\n+    expect($('h1').text()).toBe('hello')\n+  })\n \n-      if (isNextStart) {\n-        it('should contain og package files in middleware', async () => {\n+  if (isNextStart) {\n+    // Turbopack always runs SWC, so this shouldn't be an issue, but this test\n+    // refers to a webpack-specific output path.\n+    // https://github.com/vercel/next.js/pull/51067\n+    ;(isTurbopack ? it.skip : it)(\n+      'should contain og package files in middleware',\n+      async () => {\n+        await retry(async () => {\n           const middleware = await next.readFile('.next/server/middleware.js')\n           // @vercel/og default font should be bundled\n           expect(middleware).not.toContain('noto-sans-v27-latin-regular.ttf')\n         })\n       }\n-    })\n+    )\n   }\n-)\n+})"
        },
        {
            "sha": "f9a98e420859bddfb250656690c5208644e032f9",
            "filename": "test/e2e/babel/fixture/.babelrc",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Ffixture%2F.babelrc",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Ffixture%2F.babelrc",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbabel%2Ffixture%2F.babelrc?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"presets\": [\"next/babel\", \"@babel/preset-flow\"]\n+}"
        },
        {
            "sha": "3a150e40a33089809cc27d3c2f9cf8b7860bc13f",
            "filename": "test/e2e/babel/fixture/lib/mycomponent.js",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Ffixture%2Flib%2Fmycomponent.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Ffixture%2Flib%2Fmycomponent.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbabel%2Ffixture%2Flib%2Fmycomponent.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -1,6 +1,6 @@\n // @flow\n // This page is written in flowtype to test Babel's functionality\n-import { React } from '../test/namespace-exported-react'\n+import { React } from '../namespace-exported-react'\n \n type Props = {}\n ",
            "previous_filename": "test/integration/babel/pages/index.js"
        },
        {
            "sha": "2593247284f2dd4d29c34a9eeb4329923fb109b3",
            "filename": "test/e2e/babel/fixture/namespace-exported-react.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Ffixture%2Fnamespace-exported-react.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Ffixture%2Fnamespace-exported-react.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbabel%2Ffixture%2Fnamespace-exported-react.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "previous_filename": "test/integration/babel/test/namespace-exported-react.js"
        },
        {
            "sha": "78e20aad0553b98f3c8fe07c1dc4b4ec7600c792",
            "filename": "test/e2e/babel/fixture/pages/index.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Ffixture%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Ffixture%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbabel%2Ffixture%2Fpages%2Findex.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -0,0 +1,12 @@\n+import MyComponent from '../lib/mycomponent'\n+import { React } from '../namespace-exported-react'\n+\n+// Note: Flow syntax doesn't work in routes, except in a very narrow case of pages router on webpack\n+// without a route segment config.\n+//\n+// See https://github.com/vercel/next.js/pull/83919 for a full explanation why. This could be fixed\n+// if/when edge runtime is deprecated and removed from Next.js.\n+\n+export default function App() {\n+  return <MyComponent />\n+}"
        },
        {
            "sha": "089afd1075e755c5864562940dcc4566465a5103",
            "filename": "test/e2e/babel/index.test.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Fbabel%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbabel%2Findex.test.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -0,0 +1,16 @@\n+import path from 'node:path'\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('Babel', () => {\n+  const { next } = nextTestSetup({\n+    files: path.join(__dirname, 'fixture'),\n+    dependencies: {\n+      '@babel/preset-flow': '7.25.9',\n+    },\n+  })\n+\n+  it('Should compile a page with flowtype correctly', async () => {\n+    const $ = await next.render$('/')\n+    expect($('#text').text()).toBe('Test Babel')\n+  })\n+})"
        },
        {
            "sha": "51baf5f3a07ed4187e9fc698639955b51f899114",
            "filename": "test/e2e/react-compiler/react-compiler.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Freact-compiler%2Freact-compiler.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fe2e%2Freact-compiler%2Freact-compiler.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Freact-compiler%2Freact-compiler.test.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -16,11 +16,7 @@ function normalizeCodeLocInfo(str) {\n   )\n }\n \n-describe.each(\n-  ['default', process.env.IS_TURBOPACK_TEST ? undefined : 'babelrc'].filter(\n-    Boolean\n-  )\n-)('react-compiler %s', (variant) => {\n+describe.each(['default', 'babelrc'])('react-compiler %s', (variant) => {\n   const dependencies = (global as any).isNextDeploy\n     ? // `link` is incompatible with the npm version used when this test is deployed\n       {"
        },
        {
            "sha": "3f99c1a46f662138fdfdfa2b15e88f7de1867421",
            "filename": "test/integration/babel-custom/test/index.test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fintegration%2Fbabel-custom%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fintegration%2Fbabel-custom%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbabel-custom%2Ftest%2Findex.test.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -2,7 +2,8 @@\n \n import { join } from 'path'\n import { nextBuild } from 'next-test-utils'\n-;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)('Babel', () => {\n+\n+describe('Babel', () => {\n   it('should allow setting babelrc env', async () => {\n     await nextBuild(join(__dirname, '../fixtures/babel-env'))\n   })"
        },
        {
            "sha": "eb1e5b4ad8773bb54baed46178caade6b8e1abbb",
            "filename": "test/integration/babel/.babelrc",
            "status": "removed",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/0761a925146d45b11bbadf8c87141968c48a1160/test%2Fintegration%2Fbabel%2F.babelrc",
            "raw_url": "https://github.com/vercel/next.js/raw/0761a925146d45b11bbadf8c87141968c48a1160/test%2Fintegration%2Fbabel%2F.babelrc",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbabel%2F.babelrc?ref=0761a925146d45b11bbadf8c87141968c48a1160",
            "patch": "@@ -1,4 +0,0 @@\n-{\n-  \"presets\": [\"next/babel\", \"@babel/preset-flow\"],\n-  \"plugins\": [[\"transform-define\", { \"TEST_VAR\": \"hello\" }]]\n-}"
        },
        {
            "sha": "b423f17883221e2513df630d7eac22dfbaeca0a1",
            "filename": "test/integration/babel/test/.babelrc",
            "status": "removed",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/0761a925146d45b11bbadf8c87141968c48a1160/test%2Fintegration%2Fbabel%2Ftest%2F.babelrc",
            "raw_url": "https://github.com/vercel/next.js/raw/0761a925146d45b11bbadf8c87141968c48a1160/test%2Fintegration%2Fbabel%2Ftest%2F.babelrc",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbabel%2Ftest%2F.babelrc?ref=0761a925146d45b11bbadf8c87141968c48a1160",
            "patch": "@@ -1,12 +0,0 @@\n-{\n-  \"presets\": [\n-    [\n-      \"next/babel\",\n-      {\n-        \"preset-env\": {\n-          \"modules\": \"commonjs\"\n-        }\n-      }\n-    ]\n-  ]\n-}"
        },
        {
            "sha": "3e666d794750135943a67bdf0bf46a25350ad75e",
            "filename": "test/integration/babel/test/index.test.js",
            "status": "removed",
            "additions": 0,
            "deletions": 33,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/0761a925146d45b11bbadf8c87141968c48a1160/test%2Fintegration%2Fbabel%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0761a925146d45b11bbadf8c87141968c48a1160/test%2Fintegration%2Fbabel%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbabel%2Ftest%2Findex.test.js?ref=0761a925146d45b11bbadf8c87141968c48a1160",
            "patch": "@@ -1,33 +0,0 @@\n-/* eslint-env jest */\n-\n-import { join } from 'path'\n-import {\n-  renderViaHTTP,\n-  fetchViaHTTP,\n-  findPort,\n-  launchApp,\n-  killApp,\n-} from 'next-test-utils'\n-\n-// test suits\n-import rendering from './rendering'\n-\n-const context = {}\n-\n-;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)('Babel', () => {\n-  beforeAll(async () => {\n-    context.appPort = await findPort()\n-    context.server = await launchApp(join(__dirname, '../'), context.appPort)\n-\n-    // pre-build all pages at the start\n-    await Promise.all([renderViaHTTP(context.appPort, '/')])\n-  })\n-  afterAll(() => killApp(context.server))\n-\n-  rendering(\n-    context,\n-    'Rendering via HTTP',\n-    (p, q) => renderViaHTTP(context.appPort, p, q),\n-    (p, q) => fetchViaHTTP(context.appPort, p, q)\n-  )\n-})"
        },
        {
            "sha": "dd3c253dbe2f4c3837e82df5d1a8c71a190144ca",
            "filename": "test/integration/babel/test/rendering.js",
            "status": "removed",
            "additions": 0,
            "deletions": 17,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/0761a925146d45b11bbadf8c87141968c48a1160/test%2Fintegration%2Fbabel%2Ftest%2Frendering.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0761a925146d45b11bbadf8c87141968c48a1160/test%2Fintegration%2Fbabel%2Ftest%2Frendering.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fbabel%2Ftest%2Frendering.js?ref=0761a925146d45b11bbadf8c87141968c48a1160",
            "patch": "@@ -1,17 +0,0 @@\n-/* eslint-env jest */\n-\n-import cheerio from 'cheerio'\n-\n-export default function ({ app }, suiteName, render, fetch) {\n-  async function get$(path, query) {\n-    const html = await render(path, query)\n-    return cheerio.load(html)\n-  }\n-\n-  describe(suiteName, () => {\n-    it('Should compile a page with flowtype correctly', async () => {\n-      const $ = await get$('/')\n-      expect($('#text').text()).toBe('Test Babel')\n-    })\n-  })\n-}"
        },
        {
            "sha": "7571bb9b8528b3ea300c65f88dcf95c788096576",
            "filename": "test/integration/telemetry/next.config.reactCompiler-options",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fintegration%2Ftelemetry%2Fnext.config.reactCompiler-options",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fintegration%2Ftelemetry%2Fnext.config.reactCompiler-options",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Fnext.config.reactCompiler-options?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -2,7 +2,7 @@ module.exports = {\n   experimental: {\n     reactCompiler: {\n       compilationMode: 'annotation',\n-      panicThreshold: 'CRITICAL_ERRORS'\n+      panicThreshold: 'critical_errors'\n     }\n   }\n-}\n\\ No newline at end of file\n+}"
        },
        {
            "sha": "623660b04d58172e67f708e5a43e70bddb2c2b47",
            "filename": "test/integration/telemetry/test/config.test.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -704,7 +704,7 @@ describe('config telemetry', () => {\n           expect(event).toMatch(/\"reactCompiler\": true/)\n           expect(event).toMatch(/\"reactCompilerCompilationMode\": \"annotation\"/)\n           expect(event).toMatch(\n-            /\"reactCompilerPanicThreshold\": \"CRITICAL_ERRORS\"/\n+            /\"reactCompilerPanicThreshold\": \"critical_errors\"/\n           )\n         } catch (err) {\n           require('console').error('failing stderr', stderr, err)"
        },
        {
            "sha": "b058d664028d2ab049ed8784407c741387f62984",
            "filename": "test/unit/next-babel-loader-dev.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Funit%2Fnext-babel-loader-dev.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Funit%2Fnext-babel-loader-dev.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fnext-babel-loader-dev.test.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -21,6 +21,7 @@ const babel = async (code: string, queryOpts = {} as any) => {\n     cache: false,\n     development: true,\n     hasReactRefresh: !isServer,\n+    transformMode: 'default',\n   }\n   return new Promise<string>((resolve, reject) => {\n     function callback(err, content) {"
        },
        {
            "sha": "db828a7b62f673d6b29411432af49368e774a63a",
            "filename": "test/unit/next-babel-loader-prod.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Funit%2Fnext-babel-loader-prod.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/test%2Funit%2Fnext-babel-loader-prod.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fnext-babel-loader-prod.test.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -30,6 +30,7 @@ const babel = async (code: string, queryOpts = {} as any) => {\n           : path.resolve(dir, 'pages'),\n       cache: false,\n       hasReactRefresh: false,\n+      transformMode: 'default',\n     }\n \n     const res = loader.bind({"
        },
        {
            "sha": "724d48e5b8c0f478dc2cb33bd15c0de71c32b70f",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/transforms.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9d596b1502bf7d370265c41786893fa6cd5c66b0/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9d596b1502bf7d370265c41786893fa6cd5c66b0/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts?ref=9d596b1502bf7d370265c41786893fa6cd5c66b0",
            "patch": "@@ -50,7 +50,10 @@ export const toPath = (file: string) => {\n   return sep !== '/' ? relPath.replaceAll(sep, '/') : relPath\n }\n export const fromPath = (path: string) => {\n-  return join(contextDir, sep !== '/' ? path.replaceAll('/', sep) : path)\n+  return join(\n+    /* turbopackIgnore: true */ contextDir,\n+    sep !== '/' ? path.replaceAll('/', sep) : path\n+  )\n }\n \n // Patch process.env to track which env vars are read"
        }
    ],
    "stats": {
        "total": 949,
        "additions": 501,
        "deletions": 448
    }
}