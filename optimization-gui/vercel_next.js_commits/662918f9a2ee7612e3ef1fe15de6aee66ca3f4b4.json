{
    "author": "unstubbable",
    "message": "[Cache Components] Disallow sync access of cookies & headers at runtime (#82564)\n\nIn #81162 we removed the support for accessing request data\nsynchronously when `experimental.cacheComponents` is enabled. However,\nwe missed updating the `cookies()` and `headers()` promises that are\ncreated at runtime to not be \"exotic\" promises, i.e. promises that also\nhave the cookies/headers methods defined on them. Those two cases are\nnow updated as well with this PR. (Params, search params, and draft mode\nwere already handled correctly in the original PR.)\n\nIn the next major version we'll remove the support for the legacy\nsynchronous access independent of the `cacheComponents` flag.",
    "sha": "662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
    "files": [
        {
            "sha": "bfb67ce0ae05f172839fe15ad27e7ec8686f4776",
            "filename": "packages/next/src/server/request/cookies.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 1,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -121,9 +121,13 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n         case 'prerender-runtime':\n           return delayUntilRuntimeStage(\n             workUnitStore,\n-            makeUntrackedExoticCookies(workUnitStore.cookies)\n+            makeUntrackedCookies(workUnitStore.cookies)\n           )\n         case 'private-cache':\n+          if (process.env.__NEXT_CACHE_COMPONENTS) {\n+            return makeUntrackedCookies(workUnitStore.cookies)\n+          }\n+\n           return makeUntrackedExoticCookies(workUnitStore.cookies)\n         case 'request':\n           trackDynamicDataInDynamicRender(workUnitStore)\n@@ -155,6 +159,10 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n               workStore?.route\n             )\n           } else {\n+            if (process.env.__NEXT_CACHE_COMPONENTS) {\n+              return makeUntrackedCookies(underlyingCookies)\n+            }\n+\n             return makeUntrackedExoticCookies(underlyingCookies)\n           }\n         default:\n@@ -196,6 +204,20 @@ function makeHangingCookies(\n   return promise\n }\n \n+function makeUntrackedCookies(\n+  underlyingCookies: ReadonlyRequestCookies\n+): Promise<ReadonlyRequestCookies> {\n+  const cachedCookies = CachedCookies.get(underlyingCookies)\n+  if (cachedCookies) {\n+    return cachedCookies\n+  }\n+\n+  const promise = Promise.resolve(underlyingCookies)\n+  CachedCookies.set(underlyingCookies, promise)\n+\n+  return promise\n+}\n+\n function makeUntrackedExoticCookies(\n   underlyingCookies: ReadonlyRequestCookies\n ): Promise<ReadonlyRequestCookies> {"
        },
        {
            "sha": "2af6e5c2aa1dd1ee1f636178ab9553e4ac76e9eb",
            "filename": "packages/next/src/server/request/headers.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -169,6 +169,10 @@ export function headers(): Promise<ReadonlyHeaders> {\n               workStore?.route\n             )\n           } else {\n+            if (process.env.__NEXT_CACHE_COMPONENTS) {\n+              return makeUntrackedHeaders(workUnitStore.headers)\n+            }\n+\n             return makeUntrackedExoticHeaders(workUnitStore.headers)\n           }\n           break\n@@ -204,6 +208,20 @@ function makeHangingHeaders(\n   return promise\n }\n \n+function makeUntrackedHeaders(\n+  underlyingHeaders: ReadonlyHeaders\n+): Promise<ReadonlyHeaders> {\n+  const cachedHeaders = CachedHeaders.get(underlyingHeaders)\n+  if (cachedHeaders) {\n+    return cachedHeaders\n+  }\n+\n+  const promise = Promise.resolve(underlyingHeaders)\n+  CachedHeaders.set(underlyingHeaders, promise)\n+\n+  return promise\n+}\n+\n function makeUntrackedExoticHeaders(\n   underlyingHeaders: ReadonlyHeaders\n ): Promise<ReadonlyHeaders> {"
        },
        {
            "sha": "53b43250a4a3563fbd52d55e564aff673843015d",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 260,
            "deletions": 72,
            "changes": 332,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -1,6 +1,9 @@\n import { isNextDev, nextTestSetup } from 'e2e-utils'\n-import { assertNoErrorToast } from 'next-test-utils'\n-import { getPrerenderOutput } from './utils'\n+import { assertNoErrorToast, retry } from 'next-test-utils'\n+import {\n+  convertModuleFunctionSequenceExpression,\n+  getPrerenderOutput,\n+} from './utils'\n \n const isRspack = process.env.NEXT_RSPACK !== undefined\n \n@@ -1115,60 +1118,60 @@ describe('Cache Components Errors', () => {\n \n             if (isTurbopack) {\n               await expect(browser).toDisplayRedbox(`\n-                            [\n-                              {\n-                                \"description\": \"Route \"/sync-cookies\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-                                \"environmentLabel\": \"Prerender\",\n-                                \"label\": \"Console Error\",\n-                                \"source\": \"app/sync-cookies/page.tsx (17:26) @ CookiesReadingComponent\n-                            > 17 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-                                 |                          ^\",\n-                                \"stack\": [\n-                                  \"CookiesReadingComponent app/sync-cookies/page.tsx (17:26)\",\n-                                  \"Page app/sync-cookies/page.tsx (11:7)\",\n-                                ],\n-                              },\n-                              {\n-                                \"description\": \"(0 , <turbopack-module-id>.cookies)(...).get is not a function\",\n-                                \"environmentLabel\": \"Prerender\",\n-                                \"label\": \"Runtime TypeError\",\n-                                \"source\": \"app/sync-cookies/page.tsx (17:67) @ CookiesReadingComponent\n-                            > 17 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-                                 |                                                                   ^\",\n-                                \"stack\": [\n-                                  \"CookiesReadingComponent app/sync-cookies/page.tsx (17:67)\",\n-                                ],\n-                              },\n-                            ]\n-                          `)\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-cookies\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-cookies/page.tsx (17:25) @ CookiesReadingComponent\n+               > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                         ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies/page.tsx (17:25)\",\n+                     \"Page app/sync-cookies/page.tsx (11:7)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <turbopack-module-id>.cookies)(...).get is not a function\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-cookies/page.tsx (17:66) @ CookiesReadingComponent\n+               > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                                                                  ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies/page.tsx (17:66)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n             } else {\n               await expect(browser).toDisplayRedbox(`\n-                            [\n-                              {\n-                                \"description\": \"Route \"/sync-cookies\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-                                \"environmentLabel\": \"Prerender\",\n-                                \"label\": \"Console Error\",\n-                                \"source\": \"app/sync-cookies/page.tsx (17:18) @ CookiesReadingComponent\n-                            > 17 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-                                 |                  ^\",\n-                                \"stack\": [\n-                                  \"CookiesReadingComponent app/sync-cookies/page.tsx (17:18)\",\n-                                  \"Page app/sync-cookies/page.tsx (11:7)\",\n-                                ],\n-                              },\n-                              {\n-                                \"description\": \"(0 , <webpack-module-id>.cookies)(...).get is not a function\",\n-                                \"environmentLabel\": \"Prerender\",\n-                                \"label\": \"Runtime TypeError\",\n-                                \"source\": \"app/sync-cookies/page.tsx (17:67) @ CookiesReadingComponent\n-                            > 17 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-                                 |                                                                   ^\",\n-                                \"stack\": [\n-                                  \"CookiesReadingComponent app/sync-cookies/page.tsx (17:67)\",\n-                                ],\n-                              },\n-                            ]\n-                          `)\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-cookies\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-cookies/page.tsx (17:17) @ CookiesReadingComponent\n+               > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                 ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies/page.tsx (17:17)\",\n+                     \"Page app/sync-cookies/page.tsx (11:7)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <webpack-module-id>.cookies)(...).get is not a function\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-cookies/page.tsx (17:66) @ CookiesReadingComponent\n+               > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                                                                  ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies/page.tsx (17:66)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n             }\n           })\n         } else {\n@@ -1189,15 +1192,15 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at CookiesReadingComponent (bundler:///app/sync-cookies/page.tsx:17:67)\n+                     at CookiesReadingComponent (bundler:///app/sync-cookies/page.tsx:17:66)\n                      at stringify (<anonymous>)\n                    15 |\n                    16 | async function CookiesReadingComponent() {\n-                 > 17 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-                      |                                                                   ^\n-                   18 |   return <div>this component reads the \\`token\\` cookie synchronously</div>\n-                   19 | }\n-                   20 | {\n+                 > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                      |                                                                  ^\n+                   18 |\n+                   19 |   return (\n+                   20 |     <div> {\n                    digest: '<error-digest>'\n                  }\n \n@@ -1208,15 +1211,15 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at a (bundler:///app/sync-cookies/page.tsx:17:67)\n+                     at a (bundler:///app/sync-cookies/page.tsx:17:66)\n                      at b (<anonymous>)\n                    15 |\n                    16 | async function CookiesReadingComponent() {\n-                 > 17 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-                      |                                                                   ^\n-                   18 |   return <div>this component reads the \\`token\\` cookie synchronously</div>\n-                   19 | }\n-                   20 | {\n+                 > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                      |                                                                  ^\n+                   18 |\n+                   19 |   return (\n+                   20 |     <div> {\n                    digest: '<error-digest>'\n                  }\n                  Export encountered an error on /sync-cookies/page: /sync-cookies, exiting the build.\"\n@@ -1227,15 +1230,15 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at CookiesReadingComponent (bundler:///app/sync-cookies/page.tsx:17:67)\n+                     at CookiesReadingComponent (bundler:///app/sync-cookies/page.tsx:17:66)\n                      at stringify (<anonymous>)\n                    15 |\n                    16 | async function CookiesReadingComponent() {\n-                 > 17 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-                      |                                                                   ^\n-                   18 |   return <div>this component reads the \\`token\\` cookie synchronously</div>\n-                   19 | }\n-                   20 | {\n+                 > 17 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                      |                                                                  ^\n+                   18 |\n+                   19 |   return (\n+                   20 |     <div> {\n                    digest: '<error-digest>'\n                  }\n \n@@ -1258,6 +1261,98 @@ describe('Cache Components Errors', () => {\n         }\n       })\n \n+      describe('cookies at runtime', () => {\n+        if (skipped) {\n+          return\n+        }\n+\n+        if (isNextDev) {\n+          it('should show a redbox with a sync access error and a runtime error', async () => {\n+            const browser = await next.browser('/sync-cookies-runtime')\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-cookies-runtime\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-cookies-runtime/page.tsx (24:25) @ CookiesReadingComponent\n+               > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                         ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies-runtime/page.tsx (24:25)\",\n+                     \"Page app/sync-cookies-runtime/page.tsx (14:9)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <turbopack-module-id>.cookies)(...).get is not a function\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-cookies-runtime/page.tsx (24:66) @ CookiesReadingComponent\n+               > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                                                                  ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies-runtime/page.tsx (24:66)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-cookies-runtime\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-cookies-runtime/page.tsx (24:17) @ CookiesReadingComponent\n+               > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                 ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies-runtime/page.tsx (24:17)\",\n+                     \"Page app/sync-cookies-runtime/page.tsx (14:9)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <webpack-module-id>.cookies)(...).get is not a function\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-cookies-runtime/page.tsx (24:66) @ CookiesReadingComponent\n+               > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                    |                                                                  ^\",\n+                   \"stack\": [\n+                     \"CookiesReadingComponent app/sync-cookies-runtime/page.tsx (24:66)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n+            }\n+          })\n+        } else {\n+          it('should not error the build, but fail at runtime', async () => {\n+            try {\n+              await prerender('/sync-cookies-runtime')\n+            } catch (error) {\n+              throw new Error('expected build not to fail', { cause: error })\n+            }\n+\n+            expect(next.cliOutput).toContain('◐ /sync-cookies-runtime')\n+            await next.start({ skipBuild: true })\n+            cliOutputLength = next.cliOutput.length\n+            await next.fetch('/sync-cookies-runtime')\n+\n+            await retry(() => {\n+              const output = convertModuleFunctionSequenceExpression(\n+                next.cliOutput.slice(cliOutputLength)\n+              )\n+              expect(output).toInclude(\n+                'TypeError: <module-function>().get is not a function'\n+              )\n+            })\n+          })\n+        }\n+      })\n+\n       describe('draftMode', () => {\n         const pathname = '/sync-draft-mode'\n \n@@ -1483,6 +1578,99 @@ describe('Cache Components Errors', () => {\n         }\n       })\n \n+      describe('headers at runtime', () => {\n+        if (skipped) {\n+          return\n+        }\n+\n+        if (isNextDev) {\n+          it('should show a redbox with a sync access error and a runtime error', async () => {\n+            const browser = await next.browser('/sync-headers-runtime')\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-headers-runtime\" used \\`headers().get\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-headers-runtime/page.tsx (24:29) @ HeadersReadingComponent\n+               > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                    |                             ^\",\n+                   \"stack\": [\n+                     \"HeadersReadingComponent app/sync-headers-runtime/page.tsx (24:29)\",\n+                     \"Page app/sync-headers-runtime/page.tsx (14:9)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <turbopack-module-id>.headers)(...).get is not a function\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-headers-runtime/page.tsx (24:70) @ HeadersReadingComponent\n+               > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                    |                                                                      ^\",\n+                   \"stack\": [\n+                     \"HeadersReadingComponent app/sync-headers-runtime/page.tsx (24:70)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               [\n+                 {\n+                   \"description\": \"Route \"/sync-headers-runtime\" used \\`headers().get\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Console Error\",\n+                   \"source\": \"app/sync-headers-runtime/page.tsx (24:21) @ HeadersReadingComponent\n+               > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                    |                     ^\",\n+                   \"stack\": [\n+                     \"HeadersReadingComponent app/sync-headers-runtime/page.tsx (24:21)\",\n+                     \"Page app/sync-headers-runtime/page.tsx (14:9)\",\n+                   ],\n+                 },\n+                 {\n+                   \"description\": \"(0 , <webpack-module-id>.headers)(...).get is not a function\",\n+                   \"environmentLabel\": \"Prerender\",\n+                   \"label\": \"Runtime TypeError\",\n+                   \"source\": \"app/sync-headers-runtime/page.tsx (24:70) @ HeadersReadingComponent\n+               > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+                    |                                                                      ^\",\n+                   \"stack\": [\n+                     \"HeadersReadingComponent app/sync-headers-runtime/page.tsx (24:70)\",\n+                   ],\n+                 },\n+               ]\n+              `)\n+            }\n+          })\n+        } else {\n+          it('should not error the build, but fail at runtime', async () => {\n+            try {\n+              await prerender('/sync-headers-runtime')\n+            } catch (error) {\n+              throw new Error('expected build not to fail', { cause: error })\n+            }\n+\n+            expect(next.cliOutput).toContain('◐ /sync-headers-runtime')\n+            await next.start({ skipBuild: true })\n+            cliOutputLength = next.cliOutput.length\n+            await next.fetch('/sync-headers-runtime')\n+\n+            await retry(() => {\n+              const output = convertModuleFunctionSequenceExpression(\n+                next.cliOutput.slice(cliOutputLength)\n+              )\n+\n+              expect(output).toInclude(\n+                'TypeError: <module-function>().get is not a function'\n+              )\n+            })\n+          })\n+        }\n+      })\n+\n       describe('client params', () => {\n         const pathname = '/sync-client-params'\n "
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/sync-cookies-runtime/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies-runtime%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies-runtime%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies-runtime%2Flayout.tsx?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "04ac527c421d437081273ad8d9b771939c7b3424",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/sync-cookies-runtime/page.tsx",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies-runtime%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies-runtime%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies-runtime%2Fpage.tsx?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -0,0 +1,31 @@\n+import { cookies, type UnsafeUnwrappedCookies } from 'next/headers'\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page accesses cookies synchronously at runtime. This triggers a\n+        type error. In dev mode, we also log an explicit error that `cookies()`\n+        should be awaited.\n+      </p>\n+      <Suspense>\n+        <CookiesReadingComponent />\n+      </Suspense>\n+    </>\n+  )\n+}\n+\n+async function CookiesReadingComponent() {\n+  // Await a connection to test the subsequent sync cookies access at runtime.\n+  await connection()\n+\n+  const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+\n+  return (\n+    <div>\n+      this component reads the `token` cookie synchronously: {token?.value}\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "1d84a9593132b012f01a774f8c74f5b336913ddc",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/sync-cookies/page.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-cookies%2Fpage.tsx?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -14,6 +14,11 @@ export default async function Page() {\n }\n \n async function CookiesReadingComponent() {\n-  const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-  return <div>this component reads the `token` cookie synchronously</div>\n+  const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+\n+  return (\n+    <div>\n+      this component reads the `token` cookie synchronously: {token?.value}\n+    </div>\n+  )\n }"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/sync-headers-runtime/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-headers-runtime%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-headers-runtime%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-headers-runtime%2Flayout.tsx?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "86715c8fbaf08bda3065ea663309b9836356c254",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/sync-headers-runtime/page.tsx",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-headers-runtime%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-headers-runtime%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fsync-headers-runtime%2Fpage.tsx?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -0,0 +1,32 @@\n+import { headers, type UnsafeUnwrappedHeaders } from 'next/headers'\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page accesses headers synchronously at runtime. This triggers a\n+        type error. In dev mode, we also log an explicit error that `headers()`\n+        should be awaited.\n+      </p>\n+      <Suspense>\n+        <HeadersReadingComponent />\n+      </Suspense>\n+    </>\n+  )\n+}\n+\n+async function HeadersReadingComponent() {\n+  // Await a connection to test the subsequent sync headers access at runtime.\n+  await connection()\n+\n+  const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n+    'user-agent'\n+  )\n+  return (\n+    <div>\n+      this component reads the `user-agent` header synchronously: {userAgent}\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "771e218fd7998849712edffdf2e3bbf7a88edd13",
            "filename": "test/e2e/app-dir/cache-components-errors/utils.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts?ref=662918f9a2ee7612e3ef1fe15de6aee66ca3f4b4",
            "patch": "@@ -3,6 +3,20 @@ const abc = 'abcdefghijklmnopqrstuvwxyz'\n const hostElementsUsedInFixtures = ['html', 'body', 'main', 'div']\n const ignoredLines = ['Generating static pages', 'Inlining static env']\n \n+/**\n+ * Converts a module function sequence expression, e.g.:\n+ * - (0 , __TURBOPACK__imported__module__1836__.cookies)(...)\n+ * - (0 , c.cookies)(...)\n+ * - (0 , cookies.U)(...)\n+ * - (0 , e.U)(...)\n+ * to a deterministic, bundler-agnostic representation.\n+ */\n+export function convertModuleFunctionSequenceExpression(\n+  output: string\n+): string {\n+  return output.replace(/\\(0 , \\w+\\.(\\w+)\\)\\(\\.\\.\\.\\)/, '<module-function>()')\n+}\n+\n export function getPrerenderOutput(\n   cliOutput: string,\n   { isMinified }: { isMinified: boolean }\n@@ -61,17 +75,11 @@ export function getPrerenderOutput(\n         )\n         .replace(/at \\d+ \\(/, replaceNumericModuleId)\n         .replace(/digest: '\\d+'/, \"digest: '<error-digest>'\")\n-        // Convert a module function sequence expression, e.g.:\n-        // - (0 , __TURBOPACK__imported__module__1836__.cookies)(...)\n-        // - (0 , c.cookies)(...)\n-        // - (0 , cookies.U)(...)\n-        // - (0 , e.U)(...)\n-        .replace(/\\(0 , \\w+\\.(\\w+)\\)\\(\\.\\.\\.\\)/, '<module-function>()')\n         // TODO(veil): Bundler protocols should not appear in stack frames.\n         .replace('webpack:///', 'bundler:///')\n         .replace('turbopack:///[project]/', 'bundler:///')\n \n-      lines.push(line)\n+      lines.push(convertModuleFunctionSequenceExpression(line))\n     }\n   }\n "
        }
    ],
    "stats": {
        "total": 486,
        "additions": 404,
        "deletions": 82
    }
}