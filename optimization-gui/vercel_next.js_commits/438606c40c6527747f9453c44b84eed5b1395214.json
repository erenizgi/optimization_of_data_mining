{
    "author": "lukesandberg",
    "message": "[turbopack] Remove the `turbo_tasks::function` attributes from a number of tasks that do not get cache hits. (#83241)\n\nDrop `turbo_tasks::function` annotation from functions that never get cache hits.\n\nWe only do this in cases where:\n* there are no cache hits in production or dev builds\n* There is a structural reason for it.  Typically, because that task is 'dominated' by another one.\n* Or, the task being cached is so small that we shouldn't worry about even theoretical hits.\n\nTasks being modified or removed (numbers are from a vercel-site build):\n* `turbopack-ecmascript::parse::parse`  (63398 tasks)\n    - this task gets no hits due to a few 'dominating' tasks. In this case we remove turbotasks::function from `EcmascriptModuleAsset::parse`, since there are some theoretical hits.\n* `EcmascriptChunkItemContent::module_factory` (55804 tasks)\n    - This function is completely 'dominated' by `module_factory_with_code_generation_issue` so we don't need it, even in a PC environment we should expect this to be the case\n* `Module::style_type` (63237 tasks, though we don't save all of them)\n    * Only gets called once for each module so there were no cache hits.  However, it is useful for HMR and PC to ensure we don't recompute style groups. So move this to a new trait and call it conditionally which eliminates all overhead while preseving cacheability\n*  `track_glob` (11432 tasks)\n     * this is used to set up dependencies on files read by webpack loaders.  This was made conditional on whether or not any dependencies are being tracked. at all\n* `apply_module_type` (152887 tasks) and `apply_reexport_treeshaking` (57527 tasks):\n    - both of these are dominated by other tasks\n* `EcmascriptAnalyzable::module_content` (40310 tasks)\n    - This one is trivially dominated and really just plugs two other Vcs together, so i dropped `turbo_tasks::function`, as default trait method this actually required a new feature in the macro gencode.\n\nSo altogether this eliminates about 4.97% (444595/8939581)  tasks from a build of vercel-site. \n\nFrom measuring the builds I also see a progression\n\n![image.png](https://app.graphite.dev/user-attachments/assets/f7d960e1-30d6-4430-8712-ae94723adaae.png)\n\nWhich is  (@P50) 1.7 seconds faster (-2.6%) and uses 290 MB less memory (-2%).  The micro benchmarks show bigger progressions, but that makes sense, they are more sensitive to overheads.",
    "sha": "438606c40c6527747f9453c44b84eed5b1395214",
    "files": [
        {
            "sha": "121ef834281149e42f34ae4126b442e8cbc41bd5",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -438,8 +438,7 @@ pub fn project_new(\n         )?;\n         let turbopack_ctx = NextTurbopackContext::new(turbo_tasks.clone(), napi_callbacks);\n \n-        let stats_path = std::env::var_os(\"NEXT_TURBOPACK_TASK_STATISTICS\");\n-        if let Some(stats_path) = stats_path {\n+        if let Some(stats_path) = std::env::var_os(\"NEXT_TURBOPACK_TASK_STATISTICS\") {\n             let task_stats = turbo_tasks.task_statistics().enable().clone();\n             exit.on_exit(async move {\n                 tokio::task::spawn_blocking(move || {"
        },
        {
            "sha": "34bbde461f4321d5ea6019df10cff229ce2673fc",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -3077,6 +3077,10 @@ impl<B: BackingStorage> Backend for TurboTasksBackend<B> {\n     fn task_statistics(&self) -> &TaskStatisticsApi {\n         &self.0.task_statistics\n     }\n+\n+    fn is_tracking_dependencies(&self) -> bool {\n+        self.0.options.dependency_tracking\n+    }\n }\n \n enum DebugTraceTransientTask {"
        },
        {
            "sha": "36f657711ce6fd8714e179af2f57861db1c9c764",
            "filename": "turbopack/crates/turbo-tasks-testing/src/lib.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks-testing%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks-testing%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Fsrc%2Flib.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -324,6 +324,10 @@ impl TurboTasksApi for VcStorage {\n     fn send_compilation_event(&self, _event: Arc<dyn CompilationEvent>) {\n         unimplemented!()\n     }\n+\n+    fn is_tracking_dependencies(&self) -> bool {\n+        false\n+    }\n }\n \n impl VcStorage {"
        },
        {
            "sha": "b444551b60c51285adef1fab1a01eed41523b560",
            "filename": "turbopack/crates/turbo-tasks/src/backend.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fbackend.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -726,4 +726,6 @@ pub trait Backend: Sync + Send {\n     fn dispose_root_task(&self, task: TaskId, turbo_tasks: &dyn TurboTasksBackendApi<Self>);\n \n     fn task_statistics(&self) -> &TaskStatisticsApi;\n+\n+    fn is_tracking_dependencies(&self) -> bool;\n }"
        },
        {
            "sha": "6519073943b6f8aaa1de0bff957bb2f9a64ac4a8",
            "filename": "turbopack/crates/turbo-tasks/src/manager.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -202,6 +202,9 @@ pub trait TurboTasksApi: TurboTasksCallApi + Sync + Send {\n         event_types: Option<Vec<String>>,\n     ) -> Receiver<Arc<dyn CompilationEvent>>;\n     fn send_compilation_event(&self, event: Arc<dyn CompilationEvent>);\n+\n+    // Returns true if TurboTasks is configured to track dependencies.\n+    fn is_tracking_dependencies(&self) -> bool;\n }\n \n /// A wrapper around a value that is unused.\n@@ -1442,6 +1445,10 @@ impl<B: Backend + 'static> TurboTasksApi for TurboTasks<B> {\n             tracing::warn!(\"Failed to send compilation event: {e}\");\n         }\n     }\n+\n+    fn is_tracking_dependencies(&self) -> bool {\n+        self.backend.is_tracking_dependencies()\n+    }\n }\n \n impl<B: Backend + 'static> TurboTasksBackendApi<B> for TurboTasks<B> {"
        },
        {
            "sha": "e91791c74e8e7d68991fe7cf1cde779086242c70",
            "filename": "turbopack/crates/turbo-tasks/src/vc/resolved.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fresolved.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fresolved.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fresolved.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -243,7 +243,7 @@ where\n     /// Returns `None` if the underlying value type does not implement `K`.\n     ///\n     /// **Note:** if the trait `T` is required to implement `K`, use [`ResolvedVc::upcast`] instead.\n-    /// This provides stronger guarantees, removing the need for a [`Result`] return type.\n+    /// This provides stronger guarantees, removing the need for a [`Option`] return type.\n     ///\n     /// See also: [`Vc::try_resolve_sidecast`].\n     pub fn try_sidecast<K>(this: Self) -> Option<ResolvedVc<K>>"
        },
        {
            "sha": "97db55d8ec248852aa45ea514c59d59284a081b5",
            "filename": "turbopack/crates/turbopack-core/src/module.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -1,17 +1,14 @@\n-use serde::{Deserialize, Serialize};\n-use turbo_tasks::{NonLocalValue, ResolvedVc, Vc, trace::TraceRawVcs};\n+use turbo_tasks::{ResolvedVc, TaskInput, Vc};\n \n use crate::{asset::Asset, ident::AssetIdent, reference::ModuleReferences};\n \n-#[derive(Clone, Copy, Debug, Serialize, Deserialize, PartialEq, Eq, TraceRawVcs, NonLocalValue)]\n+#[derive(Clone, Copy, Debug, TaskInput, Hash)]\n+#[turbo_tasks::value(shared)]\n pub enum StyleType {\n     IsolatedStyle,\n     GlobalStyle,\n }\n \n-#[turbo_tasks::value(transparent)]\n-pub struct OptionStyleType(Option<StyleType>);\n-\n /// A module. This usually represents parsed source code, which has references\n /// to other modules.\n #[turbo_tasks::value_trait]\n@@ -33,12 +30,13 @@ pub trait Module: Asset {\n     fn is_self_async(self: Vc<Self>) -> Vc<bool> {\n         Vc::cell(false)\n     }\n+}\n \n+#[turbo_tasks::value_trait]\n+pub trait StyleModule: Module + Asset {\n     /// The style type of the module.\n     #[turbo_tasks::function]\n-    fn style_type(self: Vc<Self>) -> Vc<OptionStyleType> {\n-        Vc::cell(None)\n-    }\n+    fn style_type(&self) -> Vc<StyleType>;\n }\n \n #[turbo_tasks::value(transparent)]"
        },
        {
            "sha": "ec8a550d65d8642902aaab2286b3d8453a720e80",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/style_groups.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fstyle_groups.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fstyle_groups.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fstyle_groups.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -15,7 +15,7 @@ use crate::{\n         ChunkItem, ChunkItemBatchWithAsyncModuleInfo, ChunkItemWithAsyncModuleInfo, ChunkType,\n         ChunkableModule, ChunkingContext, chunk_item_batch::attach_async_info_to_chunkable_module,\n     },\n-    module::{Module, StyleType},\n+    module::{Module, StyleModule, StyleType},\n     module_graph::{\n         GraphTraversalAction, ModuleGraph, module_batch::ModuleOrBatch,\n         module_batches::ModuleBatchesGraphEdge,\n@@ -129,8 +129,10 @@ pub async fn compute_style_groups(\n                     }\n                 }\n                 Entry::Vacant(e) => {\n-                    let style_type = *module.style_type().await?;\n-                    if let Some(style_type) = style_type {\n+                    if let Some(style_module) =\n+                        ResolvedVc::try_sidecast::<Box<dyn StyleModule>>(module)\n+                    {\n+                        let style_type = *style_module.style_type().await?;\n                         let mut info =\n                             ModuleInfo::new(style_type, module.ident().to_string().owned().await?);\n                         info.chunk_group_indices.insert(idx, styles.len());"
        },
        {
            "sha": "48aeeeb691507ff615ca9eb401412f4e860b531a",
            "filename": "turbopack/crates/turbopack-css/src/asset.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 7,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -8,7 +8,7 @@ use turbopack_core::{\n     context::AssetContext,\n     environment::Environment,\n     ident::AssetIdent,\n-    module::{Module, OptionStyleType, StyleType},\n+    module::{Module, StyleModule, StyleType},\n     module_graph::ModuleGraph,\n     output::OutputAssets,\n     reference::{ModuleReference, ModuleReferences},\n@@ -148,14 +148,16 @@ impl Module for CssModuleAsset {\n             ParseCssResult::NotFound => Ok(ModuleReferences::empty()),\n         }\n     }\n+}\n \n+#[turbo_tasks::value_impl]\n+impl StyleModule for CssModuleAsset {\n     #[turbo_tasks::function]\n-    fn style_type(&self) -> Vc<OptionStyleType> {\n-        let style_type = match self.ty {\n-            CssModuleAssetType::Default => StyleType::GlobalStyle,\n-            CssModuleAssetType::Module => StyleType::IsolatedStyle,\n-        };\n-        Vc::cell(Some(style_type))\n+    fn style_type(&self) -> Vc<StyleType> {\n+        match self.ty {\n+            CssModuleAssetType::Default => StyleType::GlobalStyle.cell(),\n+            CssModuleAssetType::Module => StyleType::IsolatedStyle.cell(),\n+        }\n     }\n }\n "
        },
        {
            "sha": "15bd1106055a8ce72488fe23719dd6e27b91f08c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/chunk/item.rs",
            "status": "modified",
            "additions": 36,
            "deletions": 35,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fitem.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fitem.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fitem.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -85,9 +85,10 @@ impl EcmascriptChunkItemContent {\n         }\n         .cell())\n     }\n+}\n \n-    #[turbo_tasks::function]\n-    pub async fn module_factory(&self) -> Result<Vc<Code>> {\n+impl EcmascriptChunkItemContent {\n+    async fn module_factory(&self) -> Result<ResolvedVc<Code>> {\n         let mut code = CodeBuilder::default();\n         for additional_id in self.additional_ids.iter().try_join().await? {\n             writeln!(code, \"{}, \", StringifyJs(&*additional_id))?;\n@@ -130,7 +131,7 @@ impl EcmascriptChunkItemContent {\n \n         code += \"})\";\n \n-        Ok(code.build().cell())\n+        Ok(code.build().resolved_cell())\n     }\n }\n \n@@ -221,37 +222,37 @@ async fn module_factory_with_code_generation_issue(\n     chunk_item: Vc<Box<dyn EcmascriptChunkItem>>,\n     async_module_info: Option<Vc<AsyncModuleInfo>>,\n ) -> Result<Vc<Code>> {\n-    Ok(\n-        match chunk_item\n-            .content_with_async_module_info(async_module_info)\n-            .module_factory()\n-            .resolve()\n-            .await\n-        {\n-            Ok(factory) => factory,\n-            Err(error) => {\n-                let id = chunk_item.asset_ident().to_string().await;\n-                let id = id.as_ref().map_or_else(|_| \"unknown\", |id| &**id);\n-                let error = error.context(format!(\n-                    \"An error occurred while generating the chunk item {id}\"\n-                ));\n-                let error_message = format!(\"{}\", PrettyPrintError(&error)).into();\n-                let js_error_message = serde_json::to_string(&error_message)?;\n-                CodeGenerationIssue {\n-                    severity: IssueSeverity::Error,\n-                    path: chunk_item.asset_ident().path().owned().await?,\n-                    title: StyledString::Text(rcstr!(\"Code generation for chunk item errored\"))\n-                        .resolved_cell(),\n-                    message: StyledString::Text(error_message).resolved_cell(),\n-                }\n-                .resolved_cell()\n-                .emit();\n-                let mut code = CodeBuilder::default();\n-                code += \"(() => {{\\n\\n\";\n-                writeln!(code, \"throw new Error({error});\", error = &js_error_message)?;\n-                code += \"\\n}})\";\n-                code.build().cell()\n+    let content = match chunk_item\n+        .content_with_async_module_info(async_module_info)\n+        .await\n+    {\n+        Ok(item) => item.module_factory().await,\n+        Err(err) => Err(err),\n+    };\n+    Ok(match content {\n+        Ok(factory) => *factory,\n+        Err(error) => {\n+            let id = chunk_item.asset_ident().to_string().await;\n+            let id = id.as_ref().map_or_else(|_| \"unknown\", |id| &**id);\n+            let error = error.context(format!(\n+                \"An error occurred while generating the chunk item {id}\"\n+            ));\n+            let error_message = format!(\"{}\", PrettyPrintError(&error)).into();\n+            let js_error_message = serde_json::to_string(&error_message)?;\n+            CodeGenerationIssue {\n+                severity: IssueSeverity::Error,\n+                path: chunk_item.asset_ident().path().owned().await?,\n+                title: StyledString::Text(rcstr!(\"Code generation for chunk item errored\"))\n+                    .resolved_cell(),\n+                message: StyledString::Text(error_message).resolved_cell(),\n             }\n-        },\n-    )\n+            .resolved_cell()\n+            .emit();\n+            let mut code = CodeBuilder::default();\n+            code += \"(() => {{\\n\\n\";\n+            writeln!(code, \"throw new Error({error});\", error = &js_error_message)?;\n+            code += \"\\n}})\";\n+            code.build().cell()\n+        }\n+    })\n }"
        },
        {
            "sha": "316408ad4e379474085815e8fac33f56144094db",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -432,8 +432,8 @@ impl ModuleTypeResult {\n impl EcmascriptParsable for EcmascriptModuleAsset {\n     #[turbo_tasks::function]\n     async fn failsafe_parse(self: Vc<Self>) -> Result<Vc<ParseResult>> {\n-        let real_result = self.parse();\n         let this = self.await?;\n+        let real_result = this.parse();\n         if this.options.await?.keep_last_successful_parse {\n             let real_result_value = real_result.await?;\n             let result_value = if matches!(*real_result_value, ParseResult::Ok { .. }) {\n@@ -476,7 +476,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n     ) -> Result<Vc<EcmascriptModuleContent>> {\n         let this = self.await?;\n \n-        let parsed = self.parse();\n+        let parsed = this.parse();\n \n         Ok(EcmascriptModuleContent::new_without_analysis(\n             parsed,\n@@ -492,7 +492,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContentOptions>> {\n-        let parsed = self.parse().to_resolved().await?;\n+        let parsed = self.await?.parse().to_resolved().await?;\n \n         let analyze = self.analyze();\n         let analyze_ref = analyze.await?;\n@@ -622,14 +622,13 @@ impl EcmascriptModuleAsset {\n     pub fn options(&self) -> Vc<EcmascriptOptions> {\n         *self.options\n     }\n+}\n \n-    #[turbo_tasks::function]\n+impl EcmascriptModuleAsset {\n     pub fn parse(&self) -> Vc<ParseResult> {\n         parse(*self.source, self.ty, *self.transforms)\n     }\n-}\n \n-impl EcmascriptModuleAsset {\n     #[tracing::instrument(level = \"trace\", skip_all)]\n     pub(crate) async fn determine_module_type(self: Vc<Self>) -> Result<ReadRef<ModuleTypeResult>> {\n         let this = self.await?;"
        },
        {
            "sha": "f36130382f6b216bc4fbcbc958642288fb6a1c64",
            "filename": "turbopack/crates/turbopack-ecmascript/src/parse.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 7,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -195,7 +195,7 @@ impl SourceMapGenConfig for InlineSourcesContentConfig {\n pub async fn parse(\n     source: ResolvedVc<Box<dyn Source>>,\n     ty: EcmascriptModuleAssetType,\n-    transforms: Vc<EcmascriptInputTransforms>,\n+    transforms: ResolvedVc<EcmascriptInputTransforms>,\n ) -> Result<Vc<ParseResult>> {\n     let name = source.ident().to_string().await?.to_string();\n     let span = tracing::info_span!(\"parse ecmascript\", name = name, ty = display(&ty));\n@@ -215,11 +215,10 @@ pub async fn parse(\n async fn parse_internal(\n     source: ResolvedVc<Box<dyn Source>>,\n     ty: EcmascriptModuleAssetType,\n-    transforms: Vc<EcmascriptInputTransforms>,\n+    transforms: ResolvedVc<EcmascriptInputTransforms>,\n ) -> Result<Vc<ParseResult>> {\n     let content = source.content();\n-    let fs_path_vc = source.ident().path().owned().await?;\n-    let fs_path = fs_path_vc.clone();\n+    let fs_path = source.ident().path().owned().await?;\n     let ident = &*source.ident().to_string().await?;\n     let file_path_hash = hash_xxh3_hash64(&*source.ident().to_string().await?) as u128;\n     let content = match content.await {\n@@ -248,7 +247,6 @@ async fn parse_internal(\n                         let transforms = &*transforms.await?;\n                         match parse_file_content(\n                             string,\n-                            fs_path_vc.clone(),\n                             &fs_path,\n                             ident,\n                             source.ident().await?.query.clone(),\n@@ -297,7 +295,6 @@ async fn parse_internal(\n \n async fn parse_file_content(\n     string: BytesStr,\n-    fs_path_vc: FileSystemPath,\n     fs_path: &FileSystemPath,\n     ident: &str,\n     query: RcStr,\n@@ -458,7 +455,7 @@ async fn parse_file_content(\n                 file_name_str: fs_path.file_name(),\n                 file_name_hash: file_path_hash,\n                 query_str: query,\n-                file_path: fs_path_vc.clone(),\n+                file_path: fs_path.clone(),\n                 source\n             };\n             let span = tracing::trace_span!(\"transforms\");"
        },
        {
            "sha": "83b4ab74fc3f3ddb596dea85aa3b386d3f830f23",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -143,7 +143,6 @@ use crate::{\n     code_gen::{CodeGen, CodeGens, IntoCodeGenReference},\n     export::Liveness,\n     magic_identifier,\n-    parse::parse,\n     references::{\n         async_module::{AsyncModule, OptionAsyncModule},\n         cjs::{CjsRequireAssetReference, CjsRequireCacheAccess, CjsRequireResolveAssetReference},\n@@ -163,7 +162,7 @@ use crate::{\n         TURBOPACK_EXPORT_NAMESPACE, TURBOPACK_EXPORT_VALUE, TURBOPACK_EXPORTS, TURBOPACK_GLOBAL,\n         TURBOPACK_REQUIRE_REAL, TURBOPACK_REQUIRE_STUB, TURBOPACK_RUNTIME_FUNCTION_SHORTCUTS,\n     },\n-    tree_shake::{find_turbopack_part_id_in_asserts, part_of_module, split},\n+    tree_shake::{find_turbopack_part_id_in_asserts, part_of_module, split_module},\n     utils::{AstPathRange, module_value_to_well_known_object},\n };\n \n@@ -530,9 +529,8 @@ pub async fn analyse_ecmascript_module_internal(\n     };\n \n     let parsed = if let Some(part) = part {\n-        let parsed = parse(*source, ty, *transforms);\n-        let split_data = split(source.ident(), *source, parsed);\n-        part_of_module(split_data, part.clone())\n+        let split_data = split_module(*module);\n+        part_of_module(split_data, part)\n     } else {\n         module.failsafe_parse()\n     };"
        },
        {
            "sha": "ab1f08a494ee687f22d6870d00c2cc1e6424992d",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/locals/module.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -100,7 +100,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleLocalsModule {\n     ) -> Result<Vc<EcmascriptModuleContentOptions>> {\n         let exports = self.get_exports().to_resolved().await?;\n         let original_module = self.await?.module;\n-        let parsed = original_module.parse().to_resolved().await?;\n+        let parsed = original_module.await?.parse().to_resolved().await?;\n \n         let analyze = original_module.analyze();\n         let analyze_result = analyze.await?;"
        },
        {
            "sha": "3238b479826ca5b2fa7690352f064cc6107c3bdf",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/asset.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -14,7 +14,7 @@ use turbopack_core::{\n };\n \n use super::{\n-    SplitResult, chunk_item::EcmascriptModulePartChunkItem, get_part_id, part_of_module, split,\n+    SplitResult, chunk_item::EcmascriptModulePartChunkItem, get_part_id, part_of_module,\n     split_module,\n };\n use crate::{\n@@ -43,8 +43,7 @@ pub struct EcmascriptModulePartAsset {\n impl EcmascriptParsable for EcmascriptModulePartAsset {\n     #[turbo_tasks::function]\n     fn failsafe_parse(&self) -> Result<Vc<ParseResult>> {\n-        let parsed = self.full_module.failsafe_parse();\n-        let split_data = split(self.full_module.ident(), self.full_module.source(), parsed);\n+        let split_data = split_module(*self.full_module);\n         Ok(part_of_module(split_data, self.part.clone()))\n     }\n     #[turbo_tasks::function]"
        },
        {
            "sha": "50806c306a7a115e236dc0c3b0203f5d34f35e7a",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/mod.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 11,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fmod.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -20,7 +20,9 @@ use self::graph::{DepGraph, ItemData, ItemId, ItemIdGroupKind, Mode, SplitModule\n pub(crate) use self::graph::{\n     PartId, create_turbopack_part_id_assert, find_turbopack_part_id_in_asserts,\n };\n-use crate::{EcmascriptModuleAsset, analyzer::graph::EvalContext, parse::ParseResult};\n+use crate::{\n+    EcmascriptModuleAsset, EcmascriptParsable, analyzer::graph::EvalContext, parse::ParseResult,\n+};\n \n pub mod asset;\n pub mod chunk_item;\n@@ -469,16 +471,9 @@ impl PartialEq for SplitResult {\n }\n \n #[turbo_tasks::function]\n-pub(super) fn split_module(asset: Vc<EcmascriptModuleAsset>) -> Result<Vc<SplitResult>> {\n-    Ok(split(asset.source().ident(), asset.source(), asset.parse()))\n-}\n-\n-#[turbo_tasks::function]\n-pub(super) async fn split(\n-    ident: ResolvedVc<AssetIdent>,\n-    source: ResolvedVc<Box<dyn Source>>,\n-    parsed: ResolvedVc<ParseResult>,\n-) -> Result<Vc<SplitResult>> {\n+pub(super) async fn split_module(asset: Vc<EcmascriptModuleAsset>) -> Result<Vc<SplitResult>> {\n+    let parsed: ResolvedVc<ParseResult> = asset.failsafe_parse().to_resolved().await?;\n+    let ident = asset.source().ident().to_resolved().await?;\n     // Do not split already split module\n     if !ident.await?.parts.is_empty() {\n         return Ok(SplitResult::Failed {\n@@ -498,6 +493,7 @@ pub(super) async fn split(\n     }\n \n     let parse_result = parsed.await?;\n+    let source = asset.source().to_resolved().await?;\n \n     match &*parse_result {\n         ParseResult::Ok {"
        },
        {
            "sha": "64609dcd49da5b243f6c5659d1fc76280c12c6d8",
            "filename": "turbopack/crates/turbopack-node/src/transforms/webpack.rs",
            "status": "modified",
            "additions": 41,
            "deletions": 37,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -497,44 +497,48 @@ impl EvaluateContext for WebpackLoaderContext {\n                 directories,\n                 build_file_paths,\n             } => {\n-                // Track dependencies of the loader task\n-                // TODO: Because these are reported _after_ the loader actually read the dependency\n-                // there is a race condition where we may miss updates that race\n-                // with the loader execution.\n-\n-                // Track all the subscriptions in parallel, since certain loaders like tailwind\n-                // might add thousands of subscriptions.\n-                let env_subscriptions = env_variables\n-                    .iter()\n-                    .map(|e| self.env.read(e.clone()))\n-                    .try_join();\n-                let file_subscriptions = file_paths\n-                    .iter()\n-                    .map(|p| async move { self.cwd.join(p)?.read().await })\n-                    .try_join();\n-                let directory_subscriptions = directories\n-                    .iter()\n-                    .map(|(dir, glob)| async move {\n-                        self.cwd\n-                            .join(dir)?\n-                            .track_glob(Glob::new(glob.clone(), GlobOptions::default()), false)\n-                            .await\n-                    })\n-                    .try_join();\n-                try_join!(\n-                    env_subscriptions,\n-                    file_subscriptions,\n-                    directory_subscriptions\n-                )?;\n-\n-                for build_path in build_file_paths {\n-                    let build_path = self.cwd.join(&build_path)?;\n-                    BuildDependencyIssue {\n-                        source: IssueSource::from_source_only(self.context_source_for_issue),\n-                        path: build_path,\n+                // We only process these dependencies to help with tracking, so if it is disabled\n+                // dont bother.\n+                if turbo_tasks::turbo_tasks().is_tracking_dependencies() {\n+                    // Track dependencies of the loader task\n+                    // TODO: Because these are reported _after_ the loader actually read the\n+                    // dependency there is a race condition where we may miss\n+                    // updates that race with the loader execution.\n+\n+                    // Track all the subscriptions in parallel, since certain loaders like tailwind\n+                    // might add thousands of subscriptions.\n+                    let env_subscriptions = env_variables\n+                        .iter()\n+                        .map(|e| self.env.read(e.clone()))\n+                        .try_join();\n+                    let file_subscriptions = file_paths\n+                        .iter()\n+                        .map(|p| async move { self.cwd.join(p)?.read().await })\n+                        .try_join();\n+                    let directory_subscriptions = directories\n+                        .iter()\n+                        .map(|(dir, glob)| async move {\n+                            self.cwd\n+                                .join(dir)?\n+                                .track_glob(Glob::new(glob.clone(), GlobOptions::default()), false)\n+                                .await\n+                        })\n+                        .try_join();\n+                    try_join!(\n+                        env_subscriptions,\n+                        file_subscriptions,\n+                        directory_subscriptions\n+                    )?;\n+\n+                    for build_path in build_file_paths {\n+                        let build_path = self.cwd.join(&build_path)?;\n+                        BuildDependencyIssue {\n+                            source: IssueSource::from_source_only(self.context_source_for_issue),\n+                            path: build_path,\n+                        }\n+                        .resolved_cell()\n+                        .emit();\n                     }\n-                    .resolved_cell()\n-                    .emit();\n                 }\n             }\n             InfoMessage::EmittedError { error, severity } => {"
        },
        {
            "sha": "b5f1c8d21566b3fe107fd8d6b67c73aa05b58177",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/imports/json/issues/Code generation for chunk item errored-3558b1.txt",
            "status": "renamed",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fimports%2Fjson%2Fissues%2FCode%20generation%20for%20chunk%20item%20errored-3558b1.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fimports%2Fjson%2Fissues%2FCode%20generation%20for%20chunk%20item%20errored-3558b1.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fimports%2Fjson%2Fissues%2FCode%20generation%20for%20chunk%20item%20errored-3558b1.txt?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -7,7 +7,6 @@ error - [code gen] /turbopack/crates/turbopack-tests/tests/snapshot/imports/json\n   \n   Debug info:\n   - An error occurred while generating the chunk item [project]/turbopack/crates/turbopack-tests/tests/snapshot/imports/json/input/invalid.json (json)\n-  - Execution of *EcmascriptChunkItemContent::module_factory failed\n   - Execution of <JsonChunkItem as EcmascriptChunkItem>::content failed\n   - Unable to make a module from invalid JSON: expected `,` or `}` at line 3 column 26\n       at nested.?",
            "previous_filename": "turbopack/crates/turbopack-tests/tests/snapshot/imports/json/issues/Code generation for chunk item errored-229157.txt"
        },
        {
            "sha": "32d3539e47c1af2ff00544219d04930438c6083e",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/imports/json/output/turbopack_crates_turbopack-tests_tests_snapshot_imports_json_input_fc5f1049._.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fimports%2Fjson%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_imports_json_input_fc5f1049._.js",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fimports%2Fjson%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_imports_json_input_fc5f1049._.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fimports%2Fjson%2Foutput%2Fturbopack_crates_turbopack-tests_tests_snapshot_imports_json_input_fc5f1049._.js?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -7,7 +7,7 @@ __turbopack_context__.v({\"name\":\"json-snapshot\"});}),\n __turbopack_context__.v(JSON.parse(\"[\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\",\\\"foofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoofoo\\\"]\"));}),\n \"[project]/turbopack/crates/turbopack-tests/tests/snapshot/imports/json/input/invalid.json (json)\", (() => {{\n \n-throw new Error(\"An error occurred while generating the chunk item [project]/turbopack/crates/turbopack-tests/tests/snapshot/imports/json/input/invalid.json (json)\\n\\nCaused by:\\n- Unable to make a module from invalid JSON: expected `,` or `}` at line 3 column 26\\n\\nDebug info:\\n- An error occurred while generating the chunk item [project]/turbopack/crates/turbopack-tests/tests/snapshot/imports/json/input/invalid.json (json)\\n- Execution of *EcmascriptChunkItemContent::module_factory failed\\n- Execution of <JsonChunkItem as EcmascriptChunkItem>::content failed\\n- Unable to make a module from invalid JSON: expected `,` or `}` at line 3 column 26\\n    at nested.?\\n       1 | {\\n       2 |   \\\"nested\\\": {\\n         |                          v\\n       3 +     \\\"this-is\\\": \\\"invalid\\\" // lint-staged will remove trailing commas, so here's a comment\\n         |                          ^\\n       4 |   }\\n       5 | }\");\n+throw new Error(\"An error occurred while generating the chunk item [project]/turbopack/crates/turbopack-tests/tests/snapshot/imports/json/input/invalid.json (json)\\n\\nCaused by:\\n- Unable to make a module from invalid JSON: expected `,` or `}` at line 3 column 26\\n\\nDebug info:\\n- An error occurred while generating the chunk item [project]/turbopack/crates/turbopack-tests/tests/snapshot/imports/json/input/invalid.json (json)\\n- Execution of <JsonChunkItem as EcmascriptChunkItem>::content failed\\n- Unable to make a module from invalid JSON: expected `,` or `}` at line 3 column 26\\n    at nested.?\\n       1 | {\\n       2 |   \\\"nested\\\": {\\n         |                          v\\n       3 +     \\\"this-is\\\": \\\"invalid\\\" // lint-staged will remove trailing commas, so here's a comment\\n         |                          ^\\n       4 |   }\\n       5 | }\");\n \n }}),\n \"[project]/turbopack/crates/turbopack-tests/tests/snapshot/imports/json/input/index.js [test] (ecmascript)\", ((__turbopack_context__) => {"
        },
        {
            "sha": "7e04671dfb6f13bb8dc75a02602ad550448835f6",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/438606c40c6527747f9453c44b84eed5b1395214/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=438606c40c6527747f9453c44b84eed5b1395214",
            "patch": "@@ -71,14 +71,13 @@ use turbopack_wasm::{module_asset::WebAssemblyModuleAsset, source::WebAssemblySo\n use self::transition::{Transition, TransitionOptions};\n use crate::module_options::{CssOptionsContext, CustomModuleType, EcmascriptOptionsContext};\n \n-#[turbo_tasks::function]\n async fn apply_module_type(\n     source: ResolvedVc<Box<dyn Source>>,\n     module_asset_context: Vc<ModuleAssetContext>,\n     module_type: Vc<ModuleType>,\n     part: Option<ModulePart>,\n     inner_assets: Option<ResolvedVc<InnerAssets>>,\n-    css_import_context: Option<Vc<ImportContext>>,\n+    css_import_context: Option<ResolvedVc<ImportContext>>,\n     runtime_code: bool,\n ) -> Result<Vc<ProcessResult>> {\n     let module_type = &*module_type.await?;\n@@ -206,12 +205,14 @@ async fn apply_module_type(\n                                             part,\n                                             side_effect_free_packages,\n                                         )\n+                                        .await?\n                                     } else {\n                                         apply_reexport_tree_shaking(\n                                             Vc::upcast(*module),\n                                             part,\n                                             side_effect_free_packages,\n                                         )\n+                                        .await?\n                                     }\n                                 }\n                                 _ => bail!(\n@@ -251,7 +252,7 @@ async fn apply_module_type(\n                 *source,\n                 Vc::upcast(module_asset_context),\n                 *ty,\n-                css_import_context,\n+                css_import_context.map(|c| *c),\n                 environment.as_deref().copied(),\n             )\n             .to_resolved()\n@@ -281,7 +282,6 @@ async fn apply_module_type(\n     .cell())\n }\n \n-#[turbo_tasks::function]\n async fn apply_reexport_tree_shaking(\n     module: Vc<Box<dyn EcmascriptChunkPlaceable>>,\n     part: ModulePart,\n@@ -656,19 +656,20 @@ async fn process_default_internal(\n         return Ok(ProcessResult::Unknown(current_source).cell());\n     };\n \n-    Ok(apply_module_type(\n-        *current_source,\n+    apply_module_type(\n+        current_source,\n         module_asset_context,\n         module_type.cell(),\n         part,\n-        inner_assets.map(|v| *v),\n+        inner_assets,\n         if let ReferenceType::Css(CssReferenceSubType::AtImport(import)) = reference_type {\n-            import.map(|v| *v)\n+            import\n         } else {\n             None\n         },\n         matches!(reference_type, ReferenceType::Runtime),\n-    ))\n+    )\n+    .await\n }\n \n #[turbo_tasks::function]"
        }
    ],
    "stats": {
        "total": 288,
        "additions": 150,
        "deletions": 138
    }
}