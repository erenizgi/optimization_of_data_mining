{
    "author": "mischnic",
    "message": "Turbopack: delete module_context.remove_unused_exports (#81239)\n\n#81238 moved this into the chunking context.",
    "sha": "1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
    "files": [
        {
            "sha": "9acf8f13d47ae0912ea20c9f43a3a49b207cfeea",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -325,7 +325,6 @@ pub async fn get_client_module_options_context(\n         enable_postcss_transform,\n         side_effect_free_packages: next_config.optimize_package_imports().owned().await?,\n         keep_last_successful_parse: next_mode.is_development(),\n-        remove_unused_exports: *next_config.turbopack_remove_unused_exports(mode).await?,\n         ..Default::default()\n     };\n "
        },
        {
            "sha": "6fb1f77b549aed399246e64a59420aa299d0fe03",
            "filename": "turbopack/crates/turbopack-core/src/reference/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -319,7 +319,7 @@ pub async fn primary_chunkable_referenced_modules(\n                     .primary_modules()\n                     .owned()\n                     .await?;\n-                let export = (*reference.export_usage().await?).clone();\n+                let export = reference.export_usage().owned().await?;\n \n                 return Ok(Some((chunking_type.clone(), export, resolved)));\n             }"
        },
        {
            "sha": "3f064c7a77fd43227ae1675eb514c0bccb0650bd",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -201,8 +201,6 @@ pub struct EcmascriptOptions {\n     /// parsing fails. This is useful to keep the module graph structure intact when syntax errors\n     /// are temporarily introduced.\n     pub keep_last_successful_parse: bool,\n-\n-    pub remove_unused_exports: bool,\n }\n \n #[turbo_tasks::value]"
        },
        {
            "sha": "a44dcd59441b076e92e99a4a2ae0d35a8ebbcf8b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/module.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 45,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -38,7 +38,6 @@ use crate::{\n pub struct EcmascriptModuleFacadeModule {\n     module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     part: ModulePart,\n-    remove_unused_exports: bool,\n }\n \n #[turbo_tasks::value_impl]\n@@ -47,14 +46,8 @@ impl EcmascriptModuleFacadeModule {\n     pub fn new(\n         module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n         part: ModulePart,\n-        remove_unused_exports: bool,\n     ) -> Vc<Self> {\n-        EcmascriptModuleFacadeModule {\n-            module,\n-            part,\n-            remove_unused_exports,\n-        }\n-        .cell()\n+        EcmascriptModuleFacadeModule { module, part }.cell()\n     }\n \n     #[turbo_tasks::function]\n@@ -97,13 +90,9 @@ impl EcmascriptModuleFacadeModule {\n                 (\n                     result.esm_evaluation_references,\n                     vec![\n-                        EcmascriptModulePartReference::new_part(\n-                            *self.module,\n-                            ModulePart::locals(),\n-                            self.remove_unused_exports,\n-                        )\n-                        .to_resolved()\n-                        .await?,\n+                        EcmascriptModulePartReference::new_part(*self.module, ModulePart::locals())\n+                            .to_resolved()\n+                            .await?,\n                     ],\n                 )\n             }\n@@ -120,33 +109,21 @@ impl EcmascriptModuleFacadeModule {\n                 (\n                     result.esm_reexport_references,\n                     vec![\n-                        EcmascriptModulePartReference::new_part(\n-                            *self.module,\n-                            ModulePart::locals(),\n-                            self.remove_unused_exports,\n-                        )\n-                        .to_resolved()\n-                        .await?,\n+                        EcmascriptModulePartReference::new_part(*self.module, ModulePart::locals())\n+                            .to_resolved()\n+                            .await?,\n                     ],\n                 )\n             }\n             ModulePart::Facade => (\n                 EsmAssetReferences::empty().to_resolved().await?,\n                 vec![\n-                    EcmascriptModulePartReference::new_part(\n-                        *self.module,\n-                        ModulePart::evaluation(),\n-                        self.remove_unused_exports,\n-                    )\n-                    .to_resolved()\n-                    .await?,\n-                    EcmascriptModulePartReference::new_part(\n-                        *self.module,\n-                        ModulePart::exports(),\n-                        self.remove_unused_exports,\n-                    )\n-                    .to_resolved()\n-                    .await?,\n+                    EcmascriptModulePartReference::new_part(*self.module, ModulePart::evaluation())\n+                        .to_resolved()\n+                        .await?,\n+                    EcmascriptModulePartReference::new_part(*self.module, ModulePart::exports())\n+                        .to_resolved()\n+                        .await?,\n                 ],\n             ),\n             ModulePart::RenamedNamespace { .. } => (\n@@ -287,7 +264,6 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                                         EcmascriptModulePartReference::new_part(\n                                             *self.module,\n                                             ModulePart::locals(),\n-                                            self.remove_unused_exports,\n                                         )\n                                         .to_resolved()\n                                         .await?,\n@@ -335,7 +311,6 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                                 EcmascriptModulePartReference::new_part(\n                                     *self.module,\n                                     ModulePart::exports(),\n-                                    self.remove_unused_exports,\n                                 )\n                                 .to_resolved()\n                                 .await?,\n@@ -346,13 +321,9 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                     );\n                 }\n                 star_exports.push(ResolvedVc::upcast(\n-                    EcmascriptModulePartReference::new_part(\n-                        *self.module,\n-                        ModulePart::exports(),\n-                        self.remove_unused_exports,\n-                    )\n-                    .to_resolved()\n-                    .await?,\n+                    EcmascriptModulePartReference::new_part(*self.module, ModulePart::exports())\n+                        .to_resolved()\n+                        .await?,\n                 ));\n             }\n             ModulePart::RenamedExport {"
        },
        {
            "sha": "87b7d930dfbc0716231f4c813421d44c5d92d668",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/reference.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 15,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -31,7 +31,7 @@ use crate::{\n \n #[derive(Debug, Clone, Eq, PartialEq, Hash, Serialize, Deserialize, NonLocalValue, TraceRawVcs)]\n enum EcmascriptModulePartReferenceMode {\n-    Synthesize { remove_unused_exports: bool },\n+    Synthesize,\n     Normal,\n }\n \n@@ -51,14 +51,11 @@ impl EcmascriptModulePartReference {\n     pub fn new_part(\n         module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n         part: ModulePart,\n-        remove_unused_exports: bool,\n     ) -> Vc<Self> {\n         EcmascriptModulePartReference {\n             module,\n             part,\n-            mode: EcmascriptModulePartReferenceMode::Synthesize {\n-                remove_unused_exports,\n-            },\n+            mode: EcmascriptModulePartReferenceMode::Synthesize,\n         }\n         .cell()\n     }\n@@ -91,9 +88,7 @@ impl ModuleReference for EcmascriptModulePartReference {\n     #[turbo_tasks::function]\n     async fn resolve_reference(&self) -> Result<Vc<ModuleResolveResult>> {\n         let module = match self.mode {\n-            EcmascriptModulePartReferenceMode::Synthesize {\n-                remove_unused_exports,\n-            } => {\n+            EcmascriptModulePartReferenceMode::Synthesize => {\n                 match &self.part {\n                     ModulePart::Locals => {\n                         let Some(module) = ResolvedVc::try_downcast_type(self.module) else {\n@@ -108,13 +103,9 @@ impl ModuleReference for EcmascriptModulePartReference {\n                     | ModulePart::Evaluation\n                     | ModulePart::Facade\n                     | ModulePart::RenamedExport { .. }\n-                    | ModulePart::RenamedNamespace { .. } => {\n-                        Vc::upcast(EcmascriptModuleFacadeModule::new(\n-                            *self.module,\n-                            self.part.clone(),\n-                            remove_unused_exports,\n-                        ))\n-                    }\n+                    | ModulePart::RenamedNamespace { .. } => Vc::upcast(\n+                        EcmascriptModuleFacadeModule::new(*self.module, self.part.clone()),\n+                    ),\n                     ModulePart::Export(..) | ModulePart::Internal(..) => {\n                         bail!(\n                             \"Unexpected ModulePart \\\"{}\\\" for EcmascriptModulePartReference\","
        },
        {
            "sha": "0df0c9686d26afb002fa4b16d36d9104c6bed613",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/asset.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -200,7 +200,6 @@ impl EcmascriptModulePartAsset {\n                             EcmascriptModuleFacadeModule::new(\n                                 **final_module,\n                                 ModulePart::renamed_export(new_export.clone(), export.clone()),\n-                                module.options().await?.remove_unused_exports,\n                             )\n                             .to_resolved()\n                             .await?,\n@@ -211,7 +210,6 @@ impl EcmascriptModulePartAsset {\n                         EcmascriptModuleFacadeModule::new(\n                             **final_module,\n                             ModulePart::renamed_namespace(export.clone()),\n-                            module.options().await?.remove_unused_exports,\n                         )\n                         .to_resolved()\n                         .await?,"
        },
        {
            "sha": "1ac93b2e96a7cf5811d63aeed04b203cd85cf7ba",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -385,12 +385,10 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n                 ContextCondition::InDirectory(\"node_modules\".into()),\n                 ModuleOptionsContext {\n                     tree_shaking_mode: options.tree_shaking_mode,\n-                    remove_unused_exports,\n                     ..Default::default()\n                 }\n                 .resolved_cell(),\n             )],\n-            remove_unused_exports,\n             ..Default::default()\n         }\n         .into(),"
        },
        {
            "sha": "ffa0c9b8d56a8deb1b4b8df0a720913547ce1822",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -318,14 +318,12 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n                     },\n                     environment: Some(env),\n                     tree_shaking_mode: options.tree_shaking_mode,\n-                    remove_unused_exports: options.remove_unused_exports,\n                     ..Default::default()\n                 }\n                 .resolved_cell(),\n             )],\n             module_rules: vec![module_rules],\n             tree_shaking_mode: options.tree_shaking_mode,\n-            remove_unused_exports: options.remove_unused_exports,\n             ..Default::default()\n         }\n         .into(),"
        },
        {
            "sha": "8c6fd7b18e212f46b6b8f9c999b318f30445df11",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -171,7 +171,6 @@ async fn apply_module_type(\n                                         Vc::upcast(EcmascriptModuleFacadeModule::new(\n                                             Vc::upcast(*module),\n                                             part,\n-                                            options.await?.remove_unused_exports,\n                                         ))\n                                     } else {\n                                         Vc::upcast(*module)\n@@ -189,21 +188,18 @@ async fn apply_module_type(\n                                                 EcmascriptModuleFacadeModule::new(\n                                                     Vc::upcast(*module),\n                                                     ModulePart::exports(),\n-                                                    options.await?.remove_unused_exports,\n                                                 )\n                                                 .resolve()\n                                                 .await?,\n                                             ),\n                                             part,\n                                             side_effect_free_packages,\n-                                            options.await?.remove_unused_exports,\n                                         )\n                                     } else {\n                                         apply_reexport_tree_shaking(\n                                             Vc::upcast(*module),\n                                             part,\n                                             side_effect_free_packages,\n-                                            options.await?.remove_unused_exports,\n                                         )\n                                     }\n                                 }\n@@ -217,7 +213,6 @@ async fn apply_module_type(\n                             Vc::upcast(EcmascriptModuleFacadeModule::new(\n                                 Vc::upcast(*module),\n                                 ModulePart::facade(),\n-                                options.await?.remove_unused_exports,\n                             ))\n                         } else {\n                             Vc::upcast(*module)\n@@ -282,7 +277,6 @@ async fn apply_reexport_tree_shaking(\n     module: Vc<Box<dyn EcmascriptChunkPlaceable>>,\n     part: ModulePart,\n     side_effect_free_packages: Vc<Glob>,\n-    remove_unused_exports: bool,\n ) -> Result<Vc<Box<dyn Module>>> {\n     if let ModulePart::Export(export) = &part {\n         let FollowExportsResult {\n@@ -297,14 +291,12 @@ async fn apply_reexport_tree_shaking(\n                 Vc::upcast(EcmascriptModuleFacadeModule::new(\n                     **final_module,\n                     ModulePart::renamed_export(new_export.clone(), export.clone()),\n-                    remove_unused_exports,\n                 ))\n             }\n         } else {\n             Vc::upcast(EcmascriptModuleFacadeModule::new(\n                 **final_module,\n                 ModulePart::renamed_namespace(export.clone()),\n-                remove_unused_exports,\n             ))\n         };\n         return Ok(module);"
        },
        {
            "sha": "566804ec80fd87f5d43877a6a97168bc3dbc7261",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -143,7 +143,6 @@ impl ModuleOptions {\n             execution_context,\n             tree_shaking_mode,\n             keep_last_successful_parse,\n-            remove_unused_exports,\n             ..\n         } = *module_options_context.await?;\n \n@@ -174,7 +173,6 @@ impl ModuleOptions {\n             refresh,\n             extract_source_map: matches!(ecmascript_source_maps, SourceMapsType::Full),\n             keep_last_successful_parse,\n-            remove_unused_exports,\n             ..Default::default()\n         };\n         let ecmascript_options_vc = ecmascript_options.resolved_cell();"
        },
        {
            "sha": "003e3ed59042df33f04903578fa37dc4c30a9896",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1296528038a0c1aa011c4b7bb406f3f090c0c6e8/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=1296528038a0c1aa011c4b7bb406f3f090c0c6e8",
            "patch": "@@ -170,10 +170,6 @@ pub struct ModuleOptionsContext {\n     /// context paths. The first matching is used.\n     pub rules: Vec<(ContextCondition, ResolvedVc<ModuleOptionsContext>)>,\n \n-    /// `matches!(tree_shaking_mode, Some(TreeShakingMode::Intermediate))` is not enough because we\n-    /// use different tree shaking modes for user code and foreign code while intermediate tree\n-    /// shaking is a global option.\n-    pub remove_unused_exports: bool,\n     pub placeholder_for_future_extensions: (),\n }\n "
        }
    ],
    "stats": {
        "total": 107,
        "additions": 23,
        "deletions": 84
    }
}