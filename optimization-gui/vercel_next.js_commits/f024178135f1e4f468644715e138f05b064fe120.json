{
    "author": "mischnic",
    "message": "Turbopack: fix `@opentelemetry/api` resolve fallback (#81541)\n\nPreviously, it tried `[project]/node_modules/@opentelemetry/api` and then fell back to `node_modules/next/dist/compiled/@opentelemetry/api`.\r\n\r\nBut that doesn't work if the dependency is installed in a monorepo subpackage and should have been resolved from `packages/my-app/node_modules/@opentelemetry/api`.\r\n\r\nWe already have `fallback_import_map` which is exactly what's needed here.\r\n\r\nCloses PACK-5054",
    "sha": "f024178135f1e4f468644715e138f05b064fe120",
    "files": [
        {
            "sha": "8c884d71fd25ebad47ed848c82c9f4824e4e595e",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f024178135f1e4f468644715e138f05b064fe120/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f024178135f1e4f468644715e138f05b064fe120/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=f024178135f1e4f468644715e138f05b064fe120",
            "patch": "@@ -22,7 +22,7 @@ use crate::{\n     mode::NextMode,\n     next_config::NextConfig,\n     next_font::local::NextFontLocalResolvePlugin,\n-    next_import_map::get_next_edge_import_map,\n+    next_import_map::{get_next_edge_and_server_fallback_import_map, get_next_edge_import_map},\n     next_server::context::ServerContextType,\n     next_shared::resolve::{\n         ModuleFeatureReportResolvePlugin, NextSharedRuntimeResolvePlugin,\n@@ -94,6 +94,10 @@ pub async fn get_edge_resolve_options_context(\n     )\n     .to_resolved()\n     .await?;\n+    let next_edge_fallback_import_map =\n+        get_next_edge_and_server_fallback_import_map(project_path.clone(), NextRuntime::Edge)\n+            .to_resolved()\n+            .await?;\n \n     let mut before_resolve_plugins = vec![ResolvedVc::upcast(\n         ModuleFeatureReportResolvePlugin::new(project_path.clone())\n@@ -158,6 +162,7 @@ pub async fn get_edge_resolve_options_context(\n         enable_edge_node_externals: true,\n         custom_conditions,\n         import_map: Some(next_edge_import_map),\n+        fallback_import_map: Some(next_edge_fallback_import_map),\n         module: true,\n         browser: true,\n         after_resolve_plugins,"
        },
        {
            "sha": "6685ba4f6d39e3d3ee1b4fb81cb65abeda58fde7",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 26,
            "deletions": 13,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/f024178135f1e4f468644715e138f05b064fe120/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f024178135f1e4f468644715e138f05b064fe120/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=f024178135f1e4f468644715e138f05b064fe120",
            "patch": "@@ -516,6 +516,32 @@ pub async fn get_next_edge_import_map(\n     Ok(import_map.cell())\n }\n \n+/// Computes the Next-specific server-side and edge-side fallback import map.\n+#[turbo_tasks::function]\n+pub async fn get_next_edge_and_server_fallback_import_map(\n+    project_path: FileSystemPath,\n+    runtime: NextRuntime,\n+) -> Result<Vc<ImportMap>> {\n+    let mut fallback_import_map = ImportMap::empty();\n+\n+    let external_cjs_if_node = move |context_dir: FileSystemPath, request: &str| match runtime {\n+        NextRuntime::Edge => request_to_import_mapping(context_dir, request),\n+        NextRuntime::NodeJs => external_request_to_cjs_import_mapping(context_dir, request),\n+    };\n+\n+    fallback_import_map.insert_exact_alias(\n+        \"@opentelemetry/api\",\n+        // It needs to prefer the local version of @opentelemetry/api, so put this in the fallback\n+        // import map\n+        ImportMapping::Alternatives(vec![external_cjs_if_node(\n+            project_path,\n+            \"next/dist/compiled/@opentelemetry/api\",\n+        )])\n+        .resolved_cell(),\n+    );\n+    Ok(fallback_import_map.cell())\n+}\n+\n /// Insert default aliases for the node.js's internal to raise unsupported\n /// runtime errors. User may provide polyfills for their own by setting user\n /// config's alias.\n@@ -604,19 +630,6 @@ async fn insert_next_server_special_aliases(\n         .resolved_cell(),\n     );\n \n-    import_map.insert_exact_alias(\n-        \"@opentelemetry/api\",\n-        // It needs to prefer the local version of @opentelemetry/api\n-        ImportMapping::Alternatives(vec![\n-            external_cjs_if_node(project_path.clone(), \"@opentelemetry/api\"),\n-            external_cjs_if_node(\n-                project_path.clone(),\n-                \"next/dist/compiled/@opentelemetry/api\",\n-            ),\n-        ])\n-        .resolved_cell(),\n-    );\n-\n     match &ty {\n         ServerContextType::Pages { .. } | ServerContextType::PagesApi { .. } => {}\n         ServerContextType::PagesData { .. } => {}"
        },
        {
            "sha": "4a3b58642a0cfe5ccd80bb94955176b03908376c",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f024178135f1e4f468644715e138f05b064fe120/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f024178135f1e4f468644715e138f05b064fe120/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=f024178135f1e4f468644715e138f05b064fe120",
            "patch": "@@ -47,7 +47,7 @@ use crate::{\n     next_client::RuntimeEntries,\n     next_config::NextConfig,\n     next_font::local::NextFontLocalResolvePlugin,\n-    next_import_map::get_next_server_import_map,\n+    next_import_map::{get_next_edge_and_server_fallback_import_map, get_next_server_import_map},\n     next_server::resolve::ExternalPredicate,\n     next_shared::{\n         resolve::{\n@@ -139,6 +139,11 @@ pub async fn get_server_resolve_options_context(\n     )\n     .to_resolved()\n     .await?;\n+    let next_server_fallback_import_map =\n+        get_next_edge_and_server_fallback_import_map(project_path.clone(), NextRuntime::NodeJs)\n+            .to_resolved()\n+            .await?;\n+\n     let foreign_code_context_condition =\n         foreign_code_context_condition(next_config, project_path.clone()).await?;\n     let root_dir = project_path.root().owned().await?;\n@@ -319,6 +324,7 @@ pub async fn get_server_resolve_options_context(\n         module: true,\n         custom_conditions,\n         import_map: Some(next_server_import_map),\n+        fallback_import_map: Some(next_server_fallback_import_map),\n         before_resolve_plugins,\n         after_resolve_plugins,\n         ..Default::default()"
        },
        {
            "sha": "6641e6ed29a46a472531714aa5971c60d5143a99",
            "filename": "test/integration/edge-runtime-dynamic-code/test/index.test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 6,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f024178135f1e4f468644715e138f05b064fe120/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f024178135f1e4f468644715e138f05b064fe120/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js?ref=f024178135f1e4f468644715e138f05b064fe120",
            "patch": "@@ -126,9 +126,7 @@ describe.each([\n                     // TODO(veil): Turbopack duplicates project path\n                     '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/utils.js:11:16)' +\n                     '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:13:22)' +\n-                    // @opentelemetry/api internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-                    '\\n    at'\n+                    '\\n   9 | export async function usingEval() {'\n                 : '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/lib/utils.js:11:18)' +\n                     '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:13:23)' +\n                     '\\n   9 | export async function usingEval() {'\n@@ -192,9 +190,7 @@ describe.each([\n                     // TODO(veil): Turbopack duplicates project path\n                     '\\n    at usingWebAssemblyCompile (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/wasm.js:22:17)' +\n                     '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:17:42)' +\n-                    // Next.js internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-                    '\\n    at'\n+                    '\\n  20 |'\n                 : '' +\n                     '\\n    at usingWebAssemblyCompile (../../test/integration/edge-runtime-dynamic-code/lib/wasm.js:22:23)' +\n                     '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:17:42)' +"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 41,
        "deletions": 21
    }
}