{
    "author": "mischnic",
    "message": "Turbopack: move write_version feature to env var (#81250)\n\nThis is useful for debugging infinite file write loop situations. Put it behind the env var `TURBO_ENGINE_WRITE_VERSION=1` to be able to debug this if other people want to debug this without recompiling Next.js",
    "sha": "b8d5f262429f6543e975fd11255297883dace1d6",
    "files": [
        {
            "sha": "5305b785ec0765ed59269dc893dac344859271cf",
            "filename": "turbopack/crates/turbo-tasks-fs/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b8d5f262429f6543e975fd11255297883dace1d6/turbopack%2Fcrates%2Fturbo-tasks-fs%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/b8d5f262429f6543e975fd11255297883dace1d6/turbopack%2Fcrates%2Fturbo-tasks-fs%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2FCargo.toml?ref=b8d5f262429f6543e975fd11255297883dace1d6",
            "patch": "@@ -18,8 +18,6 @@ default = []\n # A binary built with this option **is not portable**, the directory\n # path will be embedded into the binary.\n dynamic_embed_contents = []\n-# Write a hashed version of each file to allow to debug conflicting writes\n-write_version = []\n \n [lints]\n workspace = true"
        },
        {
            "sha": "1b18a2c0dd88475146c6e51d992e21253a5a0208",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/b8d5f262429f6543e975fd11255297883dace1d6/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b8d5f262429f6543e975fd11255297883dace1d6/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=b8d5f262429f6543e975fd11255297883dace1d6",
            "patch": "@@ -32,7 +32,7 @@ use std::{\n     io::{self, BufRead, BufReader, ErrorKind, Read},\n     mem::take,\n     path::{MAIN_SEPARATOR, Path, PathBuf},\n-    sync::Arc,\n+    sync::{Arc, LazyLock},\n     time::Duration,\n };\n \n@@ -786,8 +786,12 @@ impl FileSystem for DiskFileSystem {\n                         #[cfg(target_family = \"unix\")]\n                         f.set_permissions(file.meta.permissions.into())?;\n                         f.flush()?;\n-                        #[cfg(feature = \"write_version\")]\n-                        {\n+\n+                        static WRITE_VERSION: LazyLock<bool> = LazyLock::new(|| {\n+                            std::env::var_os(\"TURBO_ENGINE_WRITE_VERSION\")\n+                                .is_some_and(|v| v == \"1\" || v == \"true\")\n+                        });\n+                        if *WRITE_VERSION {\n                             let mut full_path = full_path.to_owned();\n                             let hash = hash_xxh3_hash64(file);\n                             let ext = full_path.extension();"
        }
    ],
    "stats": {
        "total": 12,
        "additions": 7,
        "deletions": 5
    }
}