{
    "author": "timneutkens",
    "message": "Turbopack: Better error for sassOptions.functions as it's unsupported (#85073)\n\n## What?\n\nImplements an error for the case where Turbopack is used with\nsassOptions.functions.\n\nFixes #65241",
    "sha": "0f09c40ac98d71179f974a74fde3797d46f38f11",
    "files": [
        {
            "sha": "138c7d08b5f5205361c8dfedc1d159e53efc3908",
            "filename": "docs/01-app/03-api-reference/05-config/01-next-config-js/sassOptions.mdx",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0f09c40ac98d71179f974a74fde3797d46f38f11/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FsassOptions.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/0f09c40ac98d71179f974a74fde3797d46f38f11/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FsassOptions.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FsassOptions.mdx?ref=0f09c40ac98d71179f974a74fde3797d46f38f11",
            "patch": "@@ -43,4 +43,7 @@ const nextConfig = {\n module.exports = nextConfig\n ```\n \n-> **Good to know:** `sassOptions` are not typed outside of `implementation` because Next.js does not maintain the other possible properties.\n+> **Good to know:**\n+>\n+> - `sassOptions` are not typed outside of `implementation` because Next.js does not maintain the other possible properties.\n+> - The `functions` property for defining custom Sass functions is only supported with webpack. When using Turbopack, custom Sass functions are not available because Turbopack's Rust-based architecture cannot directly execute JavaScript functions passed through this option."
        },
        {
            "sha": "dab526faffeebf16996cbed58ed22d8c5110f0d8",
            "filename": "docs/01-app/03-api-reference/08-turbopack.mdx",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/0f09c40ac98d71179f974a74fde3797d46f38f11/docs%2F01-app%2F03-api-reference%2F08-turbopack.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/0f09c40ac98d71179f974a74fde3797d46f38f11/docs%2F01-app%2F03-api-reference%2F08-turbopack.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F08-turbopack.mdx?ref=0f09c40ac98d71179f974a74fde3797d46f38f11",
            "patch": "@@ -72,16 +72,16 @@ Turbopack in Next.js has **zero-configuration** for the common use cases. Below\n \n ### CSS and styling\n \n-| Feature            | Status                  | Notes                                                                                                                                                                                                           |\n-| ------------------ | ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n-| **Global CSS**     | **Supported**           | Import `.css` files directly in your application.                                                                                                                                                               |\n-| **CSS Modules**    | **Supported**           | `.module.css` files work natively (Lightning CSS).                                                                                                                                                              |\n-| **CSS Nesting**    | **Supported**           | Lightning CSS supports [modern CSS nesting](https://lightningcss.dev/).                                                                                                                                         |\n-| **@import syntax** | **Supported**           | Combine multiple CSS files.                                                                                                                                                                                     |\n-| **PostCSS**        | **Supported**           | Automatically processes `postcss.config.js` in a Node.js worker pool. Useful for Tailwind, Autoprefixer, etc.                                                                                                   |\n-| **Sass / SCSS**    | **Supported** (Next.js) | For Next.js, Sass is supported out of the box. In the future, Turbopack standalone usage will likely require a loader config.                                                                                   |\n-| **Less**           | Planned via plugins     | Not yet supported by default. Will likely require a loader config once custom loaders are stable.                                                                                                               |\n-| **Lightning CSS**  | **In Use**              | Handles CSS transformations. Some low-usage CSS Modules features (like `:local/:global` as standalone pseudo-classes) are not yet supported. [See below for more details.](#unsupported-and-unplanned-features) |\n+| Feature            | Status                  | Notes                                                                                                                                                                                                                                                                                                                                                                 |\n+| ------------------ | ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n+| **Global CSS**     | **Supported**           | Import `.css` files directly in your application.                                                                                                                                                                                                                                                                                                                     |\n+| **CSS Modules**    | **Supported**           | `.module.css` files work natively (Lightning CSS).                                                                                                                                                                                                                                                                                                                    |\n+| **CSS Nesting**    | **Supported**           | Lightning CSS supports [modern CSS nesting](https://lightningcss.dev/).                                                                                                                                                                                                                                                                                               |\n+| **@import syntax** | **Supported**           | Combine multiple CSS files.                                                                                                                                                                                                                                                                                                                                           |\n+| **PostCSS**        | **Supported**           | Automatically processes `postcss.config.js` in a Node.js worker pool. Useful for Tailwind, Autoprefixer, etc.                                                                                                                                                                                                                                                         |\n+| **Sass / SCSS**    | **Supported** (Next.js) | For Next.js, Sass is supported out of the box. Custom Sass functions (`sassOptions.functions`) are not supported because Turbopack's Rust-based architecture cannot directly execute JavaScript functions, unlike webpack's Node.js environment. Use webpack if you need this feature. In the future, Turbopack standalone usage will likely require a loader config. |\n+| **Less**           | Planned via plugins     | Not yet supported by default. Will likely require a loader config once custom loaders are stable.                                                                                                                                                                                                                                                                     |\n+| **Lightning CSS**  | **In Use**              | Handles CSS transformations. Some low-usage CSS Modules features (like `:local/:global` as standalone pseudo-classes) are not yet supported. [See below for more details.](#unsupported-and-unplanned-features)                                                                                                                                                       |\n \n ### Assets\n \n@@ -175,6 +175,8 @@ Some features are not yet implemented or not planned:\n   - `:import` and `:export` ICSS rules.\n   - `composes` in `.module.css` composing a `.css` file. In webpack this would treat the `.css` file as a CSS Module, with Turbopack the `.css` file will always be global. This means that if you want to use `composes` in a CSS Module, you need to change the `.css` file to a `.module.css` file.\n   - `@import` in CSS Modules importing `.css` as a CSS Module. In webpack this would treat the `.css` file as a CSS Module, with Turbopack the `.css` file will always be global. This means that if you want to use `@import` in a CSS Module, you need to change the `.css` file to a `.module.css` file.\n+- **`sassOptions.functions`**\n+  Custom Sass functions defined in `sassOptions.functions` are not supported. This feature allows defining JavaScript functions that can be called from Sass code during compilation. Turbopack's Rust-based architecture cannot directly execute JavaScript functions passed through `sassOptions.functions`, unlike webpack's Node.js-based sass-loader which runs entirely in JavaScript. If you're using custom Sass functions, you'll need to use webpack instead of Turbopack.\n - **`webpack()` configuration** in `next.config.js`\n   Turbopack replaces webpack, so `webpack()` configs are not recognized. Use the [`turbopack` config](/docs/app/api-reference/config/next-config-js/turbopack) instead.\n - **Yarn PnP**"
        },
        {
            "sha": "0d1aed0ca08a478ee76aba441033856d789bcc26",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0f09c40ac98d71179f974a74fde3797d46f38f11/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/0f09c40ac98d71179f974a74fde3797d46f38f11/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=0f09c40ac98d71179f974a74fde3797d46f38f11",
            "patch": "@@ -890,5 +890,6 @@\n   \"889\": \"Unknown \\\\`cacheLife()\\\\` profile \\\"%s\\\" is not configured in next.config.js\\\\nmodule.exports = {\\n  cacheLife: {\\n      \\\"%s\\\": ...\\\\n    }\\n}\",\n   \"890\": \"Received an underlying cookies object that does not match either `cookies` or `mutableCookies`\",\n   \"891\": \"Failed to read build paths file \\\"%s\\\": %s\",\n-  \"892\": \"Failed to resolve glob pattern \\\"%s\\\": %s\"\n+  \"892\": \"Failed to resolve glob pattern \\\"%s\\\": %s\",\n+  \"893\": \"The \\\"sassOptions.functions\\\" option is not supported when using Turbopack. Custom Sass functions are only available with webpack. Please remove the \\\"functions\\\" property from your sassOptions in %s.\"\n }"
        },
        {
            "sha": "0fbf30bc9dba831008076cc852cb09ebdced087f",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/0f09c40ac98d71179f974a74fde3797d46f38f11/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f09c40ac98d71179f974a74fde3797d46f38f11/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=0f09c40ac98d71179f974a74fde3797d46f38f11",
            "patch": "@@ -378,6 +378,19 @@ function assignDefaultsAndValidate(\n     )\n   }\n \n+  // Validate sassOptions.functions is not used with Turbopack\n+  if (\n+    process.env.TURBOPACK &&\n+    result.sassOptions &&\n+    'functions' in result.sassOptions\n+  ) {\n+    throw new Error(\n+      `The \"sassOptions.functions\" option is not supported when using Turbopack. ` +\n+        `Custom Sass functions are only available with webpack. ` +\n+        `Please remove the \"functions\" property from your sassOptions in ${configFileName}.`\n+    )\n+  }\n+\n   if (isStableBuild()) {\n     // Prevents usage of certain experimental features outside of canary\n     if (result.experimental?.turbopackFileSystemCacheForBuild) {"
        },
        {
            "sha": "7fdc7a285047242a4f973ba7cdea606d825aca20",
            "filename": "test/unit/isolated/config.test.ts",
            "status": "modified",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/0f09c40ac98d71179f974a74fde3797d46f38f11/test%2Funit%2Fisolated%2Fconfig.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0f09c40ac98d71179f974a74fde3797d46f38f11/test%2Funit%2Fisolated%2Fconfig.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fisolated%2Fconfig.test.ts?ref=0f09c40ac98d71179f974a74fde3797d46f38f11",
            "patch": "@@ -102,6 +102,60 @@ describe('config', () => {\n     )\n   })\n \n+  it('Should throw an error when sassOptions.functions is used with Turbopack', async () => {\n+    const originalTurbopack = process.env.TURBOPACK\n+    process.env.TURBOPACK = '1'\n+\n+    try {\n+      await expect(async () => {\n+        // Use a unique directory to avoid cache conflicts\n+        await loadConfig(PHASE_DEVELOPMENT_SERVER, '<rootDir>-turbopack-test', {\n+          customConfig: {\n+            sassOptions: {\n+              functions: {\n+                'get($keys)': function (keys) {\n+                  return 'test'\n+                },\n+              },\n+            },\n+          },\n+        })\n+      }).rejects.toThrow(\n+        /The \"sassOptions\\.functions\" option is not supported when using Turbopack/\n+      )\n+    } finally {\n+      if (originalTurbopack === undefined) {\n+        delete process.env.TURBOPACK\n+      } else {\n+        process.env.TURBOPACK = originalTurbopack\n+      }\n+    }\n+  })\n+\n+  it('Should allow sassOptions.functions when not using Turbopack', async () => {\n+    const originalTurbopack = process.env.TURBOPACK\n+    delete process.env.TURBOPACK\n+\n+    try {\n+      const config = await loadConfig(PHASE_DEVELOPMENT_SERVER, '<rootDir>', {\n+        customConfig: {\n+          sassOptions: {\n+            functions: {\n+              'get($keys)': function (keys) {\n+                return 'test'\n+              },\n+            },\n+          },\n+        },\n+      })\n+      expect((config as any).sassOptions.functions).toBeDefined()\n+    } finally {\n+      if (originalTurbopack !== undefined) {\n+        process.env.TURBOPACK = originalTurbopack\n+      }\n+    }\n+  })\n+\n   it('Should not throw an error when two versions of next.config.js are present', async () => {\n     const config = await loadConfig(\n       PHASE_DEVELOPMENT_SERVER,"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 85,
        "deletions": 12
    }
}