{
    "author": "acdlite",
    "message": "Lift public router instance to module level  (#77426)\n\nThere's only one instance for the whole app, and it conceptually lives\noutside of the React tree. We don't need to create it during render.\n\nThe intent here is also to provide a clearer separation between the\npublic router interface (returned by `useRouter`) and internal routing\nimplementation used by Next.js itself, e.g. in the Link component. Right\nnow, most internals go through the public interface, but going forward\nwe should call the lower level methods directly. This helps prevent\nimplementation details from accidentally leaking into public APIs.",
    "sha": "310597bb90bba8a8841e3b64e9e9aff6d050c507",
    "files": [
        {
            "sha": "37126cb01f8c1bdabe3edc4c331f3de79c66f5c4",
            "filename": "packages/next/src/client/app-dir/link.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx?ref=310597bb90bba8a8841e3b64e9e9aff6d050c507",
            "patch": "@@ -278,6 +278,8 @@ function linkClicked(\n     }\n \n     // If the router is an NextRouter instance it will have `beforePopState`\n+    // TODO: This should access the router methods directly, rather than\n+    // go through the public interface.\n     const routerScroll = scroll ?? true\n     if ('beforePopState' in router) {\n       router[replace ? 'replace' : 'push'](href, as, {"
        },
        {
            "sha": "f0e5e01061b806856b16fc84467ca6eb8e7ec355",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=310597bb90bba8a8841e3b64e9e9aff6d050c507",
            "patch": "@@ -19,7 +19,7 @@ import { findSourceMapURL } from './app-find-source-map-url'\n import {\n   type AppRouterActionQueue,\n   createMutableActionQueue,\n-} from '../shared/lib/router/action-queue'\n+} from './components/app-router-instance'\n import AppRouter from './components/app-router'\n import type { InitialRSCPayload } from '../server/app-render/types'\n import { createInitialRouterState } from './components/router-reducer/create-initial-router-state'"
        },
        {
            "sha": "5807e9371d3effd8e2d951d4f9bf554c150eb904",
            "filename": "packages/next/src/client/components/app-router-instance.ts",
            "status": "renamed",
            "additions": 126,
            "deletions": 3,
            "changes": 129,
            "blob_url": "https://github.com/vercel/next.js/blob/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts?ref=310597bb90bba8a8841e3b64e9e9aff6d050c507",
            "patch": "@@ -6,10 +6,24 @@ import {\n   ACTION_SERVER_ACTION,\n   ACTION_NAVIGATE,\n   ACTION_RESTORE,\n-} from '../../../client/components/router-reducer/router-reducer-types'\n-import { reducer } from '../../../client/components/router-reducer/router-reducer'\n+  type NavigateAction,\n+  ACTION_HMR_REFRESH,\n+  PrefetchKind,\n+  ACTION_PREFETCH,\n+} from './router-reducer/router-reducer-types'\n+import { reducer } from './router-reducer/router-reducer'\n import { startTransition } from 'react'\n-import { isThenable } from '../is-thenable'\n+import { isThenable } from '../../shared/lib/is-thenable'\n+import { prefetch as prefetchWithSegmentCache } from './segment-cache'\n+import { dispatchAppRouterAction } from './use-action-queue'\n+import { addBasePath } from '../add-base-path'\n+import { createPrefetchURL, isExternalURL } from './app-router'\n+import { prefetchReducer } from './router-reducer/reducers/prefetch-reducer'\n+import type {\n+  AppRouterInstance,\n+  NavigateOptions,\n+  PrefetchOptions,\n+} from '../../shared/lib/app-router-context.shared-runtime'\n \n export type DispatchStatePromise = React.Dispatch<ReducerState>\n \n@@ -211,3 +225,112 @@ export function createMutableActionQueue(\n export function getCurrentAppRouterState(): AppRouterState | null {\n   return globalActionQueue !== null ? globalActionQueue.state : null\n }\n+\n+function getAppRouterActionQueue(): AppRouterActionQueue {\n+  if (globalActionQueue === null) {\n+    throw new Error(\n+      'Internal Next.js error: Router action dispatched before initialization.'\n+    )\n+  }\n+  return globalActionQueue\n+}\n+\n+function dispatchNavigateAction(\n+  href: string,\n+  navigateType: NavigateAction['navigateType'],\n+  shouldScroll: boolean\n+): void {\n+  // TODO: This stuff could just go into the reducer. Leaving as-is for now\n+  // since we're about to rewrite all the router reducer stuff anyway.\n+  const url = new URL(addBasePath(href), location.href)\n+  if (process.env.__NEXT_APP_NAV_FAIL_HANDLING) {\n+    window.next.__pendingUrl = url\n+  }\n+  dispatchAppRouterAction({\n+    type: ACTION_NAVIGATE,\n+    url,\n+    isExternalUrl: isExternalURL(url),\n+    locationSearch: location.search,\n+    shouldScroll,\n+    navigateType,\n+    allowAliasing: true,\n+  })\n+}\n+\n+/**\n+ * The app router that is exposed through `useRouter`. These are public API\n+ * methods. Internal Next.js code should call the lower level methods directly\n+ * (although there's lots of existing code that doesn't do that).\n+ */\n+export const publicAppRouterInstance: AppRouterInstance = {\n+  back: () => window.history.back(),\n+  forward: () => window.history.forward(),\n+  prefetch: process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? // Unlike the old implementation, the Segment Cache doesn't store its\n+      // data in the router reducer state; it writes into a global mutable\n+      // cache. So we don't need to dispatch an action.\n+      (href: string, options?: PrefetchOptions) => {\n+        const actionQueue = getAppRouterActionQueue()\n+        prefetchWithSegmentCache(\n+          href,\n+          actionQueue.state.nextUrl,\n+          actionQueue.state.tree,\n+          options?.kind === PrefetchKind.FULL\n+        )\n+      }\n+    : (href: string, options?: PrefetchOptions) => {\n+        // Use the old prefetch implementation.\n+        const actionQueue = getAppRouterActionQueue()\n+        const url = createPrefetchURL(href)\n+        if (url !== null) {\n+          // The prefetch reducer doesn't actually update any state or\n+          // trigger a rerender. It just writes to a mutable cache. So we\n+          // shouldn't bother calling setState/dispatch; we can just re-run\n+          // the reducer directly using the current state.\n+          // TODO: Refactor this away from a \"reducer\" so it's\n+          // less confusing.\n+          prefetchReducer(actionQueue.state, {\n+            type: ACTION_PREFETCH,\n+            url,\n+            kind: options?.kind ?? PrefetchKind.FULL,\n+          })\n+        }\n+      },\n+  replace: (href: string, options?: NavigateOptions) => {\n+    startTransition(() => {\n+      dispatchNavigateAction(href, 'replace', options?.scroll ?? true)\n+    })\n+  },\n+  push: (href: string, options?: NavigateOptions) => {\n+    startTransition(() => {\n+      dispatchNavigateAction(href, 'push', options?.scroll ?? true)\n+    })\n+  },\n+  refresh: () => {\n+    startTransition(() => {\n+      dispatchAppRouterAction({\n+        type: ACTION_REFRESH,\n+        origin: window.location.origin,\n+      })\n+    })\n+  },\n+  hmrRefresh: () => {\n+    if (process.env.NODE_ENV !== 'development') {\n+      throw new Error(\n+        'hmrRefresh can only be used in development mode. Please use refresh instead.'\n+      )\n+    } else {\n+      startTransition(() => {\n+        dispatchAppRouterAction({\n+          type: ACTION_HMR_REFRESH,\n+          origin: window.location.origin,\n+        })\n+      })\n+    }\n+  },\n+}\n+\n+// Exists for debugging purposes. Don't use in application code.\n+if (typeof window !== 'undefined' && window.next) {\n+  window.next.router = publicAppRouterInstance\n+}",
            "previous_filename": "packages/next/src/shared/lib/router/action-queue.ts"
        },
        {
            "sha": "c814af273a53e088de8f7fd6ee702f45363db537",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 21,
            "deletions": 127,
            "changes": 148,
            "blob_url": "https://github.com/vercel/next.js/blob/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=310597bb90bba8a8841e3b64e9e9aff6d050c507",
            "patch": "@@ -13,22 +13,9 @@ import {\n   LayoutRouterContext,\n   GlobalLayoutRouterContext,\n } from '../../shared/lib/app-router-context.shared-runtime'\n-import type {\n-  CacheNode,\n-  AppRouterInstance,\n-} from '../../shared/lib/app-router-context.shared-runtime'\n-import {\n-  ACTION_HMR_REFRESH,\n-  ACTION_NAVIGATE,\n-  ACTION_PREFETCH,\n-  ACTION_REFRESH,\n-  ACTION_RESTORE,\n-  PrefetchKind,\n-} from './router-reducer/router-reducer-types'\n-import type {\n-  AppRouterState,\n-  NavigateAction,\n-} from './router-reducer/router-reducer-types'\n+import type { CacheNode } from '../../shared/lib/app-router-context.shared-runtime'\n+import { ACTION_RESTORE } from './router-reducer/router-reducer-types'\n+import type { AppRouterState } from './router-reducer/router-reducer-types'\n import { createHrefFromUrl } from './router-reducer/create-href-from-url'\n import {\n   SearchParamsContext,\n@@ -52,18 +39,19 @@ import { hasBasePath } from '../has-base-path'\n import { getSelectedParams } from './router-reducer/compute-changed-path'\n import type { FlightRouterState } from '../../server/app-render/types'\n import { useNavFailureHandler } from './nav-failure-handler'\n-import type { AppRouterActionQueue } from '../../shared/lib/router/action-queue'\n-import { prefetch as prefetchWithSegmentCache } from './segment-cache'\n+import {\n+  publicAppRouterInstance,\n+  type AppRouterActionQueue,\n+} from './app-router-instance'\n import { getRedirectTypeFromError, getURLFromRedirectError } from './redirect'\n import { isRedirectError, RedirectType } from './redirect-error'\n-import { prefetchReducer } from './router-reducer/reducers/prefetch-reducer'\n import { pingVisibleLinks } from './links'\n \n const globalMutable: {\n   pendingMpaPath?: string\n } = {}\n \n-function isExternalURL(url: URL) {\n+export function isExternalURL(url: URL) {\n   return url.origin !== window.location.origin\n }\n \n@@ -164,28 +152,6 @@ export function createEmptyCacheNode(): CacheNode {\n   }\n }\n \n-function dispatchNavigateAction(\n-  href: string,\n-  navigateType: NavigateAction['navigateType'],\n-  shouldScroll: boolean\n-): void {\n-  // TODO: This stuff could just go into the reducer. Leaving as-is for now\n-  // since we're about to rewrite all the router reducer stuff anyway.\n-  const url = new URL(addBasePath(href), location.href)\n-  if (process.env.__NEXT_APP_NAV_FAIL_HANDLING) {\n-    window.next.__pendingUrl = url\n-  }\n-  dispatchAppRouterAction({\n-    type: ACTION_NAVIGATE,\n-    url,\n-    isExternalUrl: isExternalURL(url),\n-    locationSearch: location.search,\n-    shouldScroll,\n-    navigateType,\n-    allowAliasing: true,\n-  })\n-}\n-\n function copyNextJsInternalHistoryState(data: any) {\n   if (data == null) data = {}\n   const currentState = window.history.state\n@@ -253,85 +219,6 @@ function Router({\n     }\n   }, [canonicalUrl])\n \n-  /**\n-   * The app router that is exposed through `useRouter`. It's only concerned with dispatching actions to the reducer, does not hold state.\n-   */\n-  const appRouter = useMemo<AppRouterInstance>(() => {\n-    const routerInstance: AppRouterInstance = {\n-      back: () => window.history.back(),\n-      forward: () => window.history.forward(),\n-      prefetch: process.env.__NEXT_CLIENT_SEGMENT_CACHE\n-        ? // Unlike the old implementation, the Segment Cache doesn't store its\n-          // data in the router reducer state; it writes into a global mutable\n-          // cache. So we don't need to dispatch an action.\n-          (href, options) =>\n-            prefetchWithSegmentCache(\n-              href,\n-              actionQueue.state.nextUrl,\n-              actionQueue.state.tree,\n-              options?.kind === PrefetchKind.FULL\n-            )\n-        : (href, options) => {\n-            // Use the old prefetch implementation.\n-            const url = createPrefetchURL(href)\n-            if (url !== null) {\n-              // The prefetch reducer doesn't actually update any state or\n-              // trigger a rerender. It just writes to a mutable cache. So we\n-              // shouldn't bother calling setState/dispatch; we can just re-run\n-              // the reducer directly using the current state.\n-              // TODO: Refactor this away from a \"reducer\" so it's\n-              // less confusing.\n-              prefetchReducer(actionQueue.state, {\n-                type: ACTION_PREFETCH,\n-                url,\n-                kind: options?.kind ?? PrefetchKind.FULL,\n-              })\n-            }\n-          },\n-      replace: (href, options = {}) => {\n-        startTransition(() => {\n-          dispatchNavigateAction(href, 'replace', options.scroll ?? true)\n-        })\n-      },\n-      push: (href, options = {}) => {\n-        startTransition(() => {\n-          dispatchNavigateAction(href, 'push', options.scroll ?? true)\n-        })\n-      },\n-      refresh: () => {\n-        startTransition(() => {\n-          dispatchAppRouterAction({\n-            type: ACTION_REFRESH,\n-            origin: window.location.origin,\n-          })\n-        })\n-      },\n-      hmrRefresh: () => {\n-        if (process.env.NODE_ENV !== 'development') {\n-          throw new Error(\n-            'hmrRefresh can only be used in development mode. Please use refresh instead.'\n-          )\n-        } else {\n-          startTransition(() => {\n-            dispatchAppRouterAction({\n-              type: ACTION_HMR_REFRESH,\n-              origin: window.location.origin,\n-            })\n-          })\n-        }\n-      },\n-    }\n-\n-    return routerInstance\n-  }, [actionQueue])\n-\n-  useEffect(() => {\n-    // Exists for debugging purposes. Don't use in application code.\n-    if (window.next) {\n-      window.next.router = appRouter\n-    }\n-  }, [appRouter])\n-\n   if (process.env.NODE_ENV !== 'production') {\n     // eslint-disable-next-line react-hooks/rules-of-hooks\n     const { cache, prefetchCache, tree } = state\n@@ -343,12 +230,12 @@ function Router({\n       // This is not meant for use in applications as concurrent rendering will affect the cache/tree/router.\n       // @ts-ignore this is for debugging\n       window.nd = {\n-        router: appRouter,\n+        router: publicAppRouterInstance,\n         cache,\n         prefetchCache,\n         tree,\n       }\n-    }, [appRouter, cache, prefetchCache, tree])\n+    }, [cache, prefetchCache, tree])\n   }\n \n   useEffect(() => {\n@@ -394,10 +281,12 @@ function Router({\n         event.preventDefault()\n         const url = getURLFromRedirectError(error)\n         const redirectType = getRedirectTypeFromError(error)\n+        // TODO: This should access the router methods directly, rather than\n+        // go through the public interface.\n         if (redirectType === RedirectType.push) {\n-          appRouter.push(url, {})\n+          publicAppRouterInstance.push(url, {})\n         } else {\n-          appRouter.replace(url, {})\n+          publicAppRouterInstance.replace(url, {})\n         }\n       }\n     }\n@@ -408,7 +297,7 @@ function Router({\n       window.removeEventListener('error', handleUnhandledRedirect)\n       window.removeEventListener('unhandledrejection', handleUnhandledRedirect)\n     }\n-  }, [appRouter])\n+  }, [])\n \n   // When mpaNavigation flag is set do a hard navigation to the new url.\n   // Infinitely suspend because we don't actually want to rerender any child\n@@ -643,7 +532,12 @@ function Router({\n             <GlobalLayoutRouterContext.Provider\n               value={globalLayoutRouterContext}\n             >\n-              <AppRouterContext.Provider value={appRouter}>\n+              {/* TODO: We should be able to remove this context. useRouter\n+                  should import from app-router-instance instead. It's only\n+                  necessary because useRouter is shared between Pages and\n+                  App Router. We should fork that module, then remove this\n+                  context provider. */}\n+              <AppRouterContext.Provider value={publicAppRouterInstance}>\n                 <LayoutRouterContext.Provider value={layoutRouterContext}>\n                   {content}\n                 </LayoutRouterContext.Provider>"
        },
        {
            "sha": "c000b41976ad6c27dacc472adddced35f7c3ce31",
            "filename": "packages/next/src/client/components/links.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts?ref=310597bb90bba8a8841e3b64e9e9aff6d050c507",
            "patch": "@@ -1,6 +1,6 @@\n import type { FlightRouterState } from '../../server/app-render/types'\n import type { AppRouterInstance } from '../../shared/lib/app-router-context.shared-runtime'\n-import { getCurrentAppRouterState } from '../../shared/lib/router/action-queue'\n+import { getCurrentAppRouterState } from './app-router-instance'\n import { createPrefetchURL } from './app-router'\n import { PrefetchKind } from './router-reducer/router-reducer-types'\n import { getCurrentCacheVersion } from './segment-cache'"
        },
        {
            "sha": "1e4406c9f99f2ef26e4b2c4352180014c40e8f31",
            "filename": "packages/next/src/client/components/use-action-queue.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fuse-action-queue.ts?ref=310597bb90bba8a8841e3b64e9e9aff6d050c507",
            "patch": "@@ -1,7 +1,7 @@\n import type { Dispatch } from 'react'\n import React, { use } from 'react'\n import { isThenable } from '../../shared/lib/is-thenable'\n-import type { AppRouterActionQueue } from '../../shared/lib/router/action-queue'\n+import type { AppRouterActionQueue } from './app-router-instance'\n import type {\n   AppRouterState,\n   ReducerActions,"
        },
        {
            "sha": "3a55ad448d366598052e3fb78a967429095edb32",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/310597bb90bba8a8841e3b64e9e9aff6d050c507/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=310597bb90bba8a8841e3b64e9e9aff6d050c507",
            "patch": "@@ -148,7 +148,7 @@ import type { ServerComponentsHmrCache } from '../response-cache'\n import type { RequestErrorContext } from '../instrumentation/types'\n import { getServerActionRequestMetadata } from '../lib/server-action-request-meta'\n import { createInitialRouterState } from '../../client/components/router-reducer/create-initial-router-state'\n-import { createMutableActionQueue } from '../../shared/lib/router/action-queue'\n+import { createMutableActionQueue } from '../../client/components/app-router-instance'\n import { getRevalidateReason } from '../instrumentation/utils'\n import { PAGE_SEGMENT_KEY } from '../../shared/lib/segment'\n import type { FallbackRouteParams } from '../request/fallback-params'"
        }
    ],
    "stats": {
        "total": 287,
        "additions": 153,
        "deletions": 134
    }
}