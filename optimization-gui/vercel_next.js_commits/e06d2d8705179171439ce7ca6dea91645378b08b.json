{
    "author": "timneutkens",
    "message": "Turbopack build: Fix production-browser-sourcemaps test (#79374)\n\n## What?\n\nThe test assumes that the sourcemap files live at a certain place and\nmatch the js filename. In Turbopack they don't because they're content\nhashed.\n\nThis fixes the tests by reading the sourcemap path and reading using\nthat path instead.",
    "sha": "e06d2d8705179171439ce7ca6dea91645378b08b",
    "files": [
        {
            "sha": "c7ddaa15dd8b7b9130eb5ee4e97c5c0b119f440c",
            "filename": "test/integration/production-browser-sourcemaps/test/index.test.js",
            "status": "modified",
            "additions": 38,
            "deletions": 32,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/e06d2d8705179171439ce7ca6dea91645378b08b/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e06d2d8705179171439ce7ca6dea91645378b08b/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js?ref=e06d2d8705179171439ce7ca6dea91645378b08b",
            "patch": "@@ -1,41 +1,26 @@\n /* eslint-env jest */\n import fs from 'fs-extra'\n-import { join } from 'path'\n-import { nextBuild, getPageFileFromBuildManifest } from 'next-test-utils'\n+import { dirname, join } from 'path'\n+import { nextBuild, getPageFilesFromBuildManifest } from 'next-test-utils'\n import { recursiveReadDir } from 'next/dist/lib/recursive-readdir'\n \n const appDir = join(__dirname, '../')\n \n-function runTests() {\n-  it('includes sourcemaps for all browser files', async () => {\n-    const browserFiles = await recursiveReadDir(join(appDir, '.next', 'static'))\n-    const jsFiles = browserFiles.filter(\n-      (file) => file.endsWith('.js') && file.includes('/pages/')\n-    )\n-    expect(jsFiles).not.toBeEmpty()\n-\n-    jsFiles.forEach((file) => {\n-      expect(browserFiles.includes(`${file}.map`)).toBe(true)\n-    })\n-  })\n-\n-  it('correctly generated the source map', async () => {\n-    const map = JSON.parse(\n-      await fs.readFile(\n-        join(\n-          appDir,\n-          '.next',\n-          (await getPageFileFromBuildManifest(appDir, '/static')) + '.map'\n-        ),\n-        'utf8'\n-      )\n-    )\n+function extractSourceMappingURL(jsContent) {\n+  // Matches both //# and //@ sourceMappingURL=...\n+  const match = jsContent.match(/\\/\\/[#@] sourceMappingURL=([^\\s]+)/)\n+  return match ? match[1] : null\n+}\n \n-    expect(map.sources).toContainEqual(\n-      expect.stringMatching(/pages[/\\\\]static\\.js/)\n-    )\n-    expect(map.names).toContainEqual('StaticPage')\n-  })\n+async function checkSourceMapExistsForFile(jsFilePath) {\n+  const jsContent = await fs.readFile(jsFilePath, 'utf8')\n+  const sourceMappingURL = extractSourceMappingURL(jsContent)\n+  if (!sourceMappingURL) {\n+    return\n+  }\n+  expect(sourceMappingURL).toBeTruthy()\n+  const mapPath = join(dirname(jsFilePath), sourceMappingURL)\n+  expect(await fs.pathExists(mapPath)).toBe(true)\n }\n \n describe('Production browser sourcemaps', () => {\n@@ -47,7 +32,28 @@ describe('Production browser sourcemaps', () => {\n           await nextBuild(appDir, [], {})\n         })\n \n-        runTests()\n+        it('includes sourcemaps for all browser files', async () => {\n+          const staticDir = join(appDir, '.next', 'static')\n+          const browserFiles = await recursiveReadDir(staticDir)\n+          const jsFiles = browserFiles.filter(\n+            (file) => file.endsWith('.js') && file.includes('/pages/')\n+          )\n+          expect(jsFiles).not.toBeEmpty()\n+\n+          for (const file of jsFiles) {\n+            const jsPath = join(staticDir, file)\n+            checkSourceMapExistsForFile(jsPath)\n+          }\n+        })\n+\n+        it('correctly generated the source map', async () => {\n+          const dotNextDir = join(appDir, '.next')\n+          const jsFiles = getPageFilesFromBuildManifest(appDir, '/static')\n+          for (const file of jsFiles) {\n+            const jsPath = join(dotNextDir, file)\n+            checkSourceMapExistsForFile(jsPath)\n+          }\n+        })\n       })\n     }\n   )"
        },
        {
            "sha": "927a56007f21a20c0f5d6411d9a51957206f6bcd",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e06d2d8705179171439ce7ca6dea91645378b08b/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e06d2d8705179171439ce7ca6dea91645378b08b/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=e06d2d8705179171439ce7ca6dea91645378b08b",
            "patch": "@@ -16971,11 +16971,11 @@\n     \"runtimeError\": false\n   },\n   \"test/integration/production-browser-sourcemaps/test/index.test.js\": {\n-    \"passed\": [],\n-    \"failed\": [\n+    \"passed\": [\n       \"Production browser sourcemaps production mode Server support correctly generated the source map\",\n       \"Production browser sourcemaps production mode Server support includes sourcemaps for all browser files\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 40,
        "deletions": 34
    }
}