{
    "author": "lubieowoce",
    "message": "add build script for next-error-code-swc-plugin (#77931)\n\nAdds a build script for `next-error-code-swc-plugin`, runnable via `pnpm\nbuild-error-code-plugin`. The script compiles the plugin and moves the\nresult to its expected location in\n`packages/next/next_error_code_swc_plugin.wasm`.\n\nI've also rebuilt the plugin and committed it -- i was getting a\ndifferent compiled output that what's currently there. Not sure if the\nbuild is non-deterministic, a dependency changed, or if someone forgot\nto recompile it, but it can't hurt.",
    "sha": "9d3b56337230b1cd2868f31b12077cb6ab6c3eed",
    "files": [
        {
            "sha": "9c0a51bc90fec23cfcbf5f473098030b2343de1c",
            "filename": "crates/next-error-code-swc-plugin/README.md",
            "status": "modified",
            "additions": 6,
            "deletions": 19,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/9d3b56337230b1cd2868f31b12077cb6ab6c3eed/crates%2Fnext-error-code-swc-plugin%2FREADME.md",
            "raw_url": "https://github.com/vercel/next.js/raw/9d3b56337230b1cd2868f31b12077cb6ab6c3eed/crates%2Fnext-error-code-swc-plugin%2FREADME.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-error-code-swc-plugin%2FREADME.md?ref=9d3b56337230b1cd2868f31b12077cb6ab6c3eed",
            "patch": "@@ -9,7 +9,7 @@ This plugin transforms Next.js source code by:\n \n ## Error Code Mapping\n \n-- **File Location:** `/packages/next/errors.json`\n+- **File Location:** `packages/next/errors.json`\n - **Structure:** Append-only, increment-based mapping of error codes to messages.\n - **Automation:**\n   - Running `pnpm build` automatically updates `errors.json` if new errors are introduced.\n@@ -20,10 +20,10 @@ This plugin transforms Next.js source code by:\n - **Two-Pass Build:**\n \n   1. **First Pass:**\n-     - Extracts new errors and temporarily stores them in `/packages/next/.errors/*.json`.\n+     - Extracts new errors and temporarily stores them in `packages/next/.errors/*.json`.\n      - In CI, a build with new errors will fail.\n   2. **Second Pass:**\n-     - Updates `/packages/next/errors.json` and reruns the build step to confirm no further new errors.\n+     - Updates `packages/next/errors.json` and reruns the build step to confirm no further new errors.\n      - Inspired by React's [error mapping mechanism](https://github.com/facebook/react/tree/main/scripts/error-codes).\n \n - **Concurrency Handling:** The two-pass system ensures reliable ordering of inserted error codes during concurrent builds.\n@@ -32,20 +32,7 @@ This plugin transforms Next.js source code by:\n \n - **WASM Rebuild Required:**\n \n-  - After modifying the plugin, rebuild the WASM file and commit it to the repository.\n-  - **Reason:** Pre-built artefacts simplify the build process (`pnpm build` runs without requiring `cargo`).\n+  - After modifying the plugin, rebuild the WASM file via `pnpm build-error-code-plugin` and commit it to the repository.\n+  - **Reason:** Pre-built artifacts simplify the build process (`pnpm build` runs without requiring `cargo`).\n \n-- **Rebuild Script Example:**\n-\n-  ```bash\n-  #!/usr/bin/env bash\n-  set -e\n-  NEXT_JS_ROOT=\"/Users/judegao/repos/next.js\"\n-  cd \"$NEXT_JS_ROOT/crates/next-error-code-swc-plugin\"\n-  rustup target add wasm32-wasip1\n-  CARGO_PROFILE_RELEASE_STRIP=true CARGO_PROFILE_RELEASE_LTO=true cargo build --target wasm32-wasip1 --release\n-  mv \"$NEXT_JS_ROOT/crates/next-error-code-swc-plugin/target/wasm32-wasip1/release/next_error_code_swc_plugin.wasm\" \"$NEXT_JS_ROOT/packages/next/\"\n-  echo \"âœ¨ Successfully built and moved WASM plugin! ðŸš€\"\n-  ```\n-\n-- **Testing:** Navigate to `/crates/next-error-code-swc-plugin` and run `cargo test` to test the plugin\n+- **Testing:** Run `cargo test` inside the `crates/next-error-code-swc-plugin` directory to test the plugin."
        },
        {
            "sha": "07d191504370ff42509c6c2cd13e86f09f4130af",
            "filename": "crates/next-error-code-swc-plugin/build-and-move.sh",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/9d3b56337230b1cd2868f31b12077cb6ab6c3eed/crates%2Fnext-error-code-swc-plugin%2Fbuild-and-move.sh",
            "raw_url": "https://github.com/vercel/next.js/raw/9d3b56337230b1cd2868f31b12077cb6ab6c3eed/crates%2Fnext-error-code-swc-plugin%2Fbuild-and-move.sh",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-error-code-swc-plugin%2Fbuild-and-move.sh?ref=9d3b56337230b1cd2868f31b12077cb6ab6c3eed",
            "patch": "@@ -0,0 +1,28 @@\n+#!/usr/bin/env bash\n+set -eu -o pipefail\n+\n+echo \"Building next-error-code-swc-plugin...\" >&2\n+\n+# assumes this script sits in the root of the plugin directory\n+plugin_dir=\"$(cd -- \"$(dirname -- \"${BASH_SOURCE[0]}\")\" &> /dev/null && pwd)\"\n+\n+repo_root=\"$(realpath \"${plugin_dir}/../..\")\"\n+\n+nextjs_dir=\"$repo_root/packages/next\"\n+if ! [ -d \"$nextjs_dir\" ]; then\n+  echo \"Expected to find next.js directory at '$nextjs_dir'\" >&2\n+  echo \"(based on computed repository root '$repo_root')\" >&2\n+  exit 1\n+fi\n+\n+BUILD_TARGET='wasm32-wasip1'\n+\n+cd \"$plugin_dir\"\n+rustup target add \"$BUILD_TARGET\"\n+CARGO_PROFILE_RELEASE_STRIP=true CARGO_PROFILE_RELEASE_LTO=true cargo build --target \"$BUILD_TARGET\" --release\n+output_file=\"$nextjs_dir/next_error_code_swc_plugin.wasm\"\n+mv \"$plugin_dir/target/$BUILD_TARGET/release/next_error_code_swc_plugin.wasm\" \"$output_file\"\n+\n+echo \"âœ¨ Plugin built successfully ðŸš€\" >&2\n+echo \"   (Don't forget to commit the generated .wasm file!)\" >&2\n+echo \"$output_file\""
        },
        {
            "sha": "684aed47d0aaed8975731c783d159c0d469d1cf3",
            "filename": "package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9d3b56337230b1cd2868f31b12077cb6ab6c3eed/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9d3b56337230b1cd2868f31b12077cb6ab6c3eed/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=9d3b56337230b1cd2868f31b12077cb6ab6c3eed",
            "patch": "@@ -74,6 +74,7 @@\n     \"sweep\": \"tsx scripts/sweep.cjs\",\n     \"check-error-codes\": \"node packages/next/check-error-codes.js\",\n     \"update-error-codes\": \"cd packages/next && pnpm taskr compile check_error_codes\",\n+    \"build-error-code-plugin\": \"crates/next-error-code-swc-plugin/build-and-move.sh\",\n     \"storybook\": \"turbo run storybook\",\n     \"build-storybook\": \"turbo run build-storybook\",\n     \"test-storybook\": \"turbo run test-storybook\","
        }
    ],
    "stats": {
        "total": 54,
        "additions": 35,
        "deletions": 19
    }
}