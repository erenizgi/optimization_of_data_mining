{
    "author": "gaojude",
    "message": "Feat: `get_page_metadata` MCP endpoint (#84211)\n\nEnables AI agents to programmatically access the runtime metadata of the\ncurrent page. At the moment, we only include the segment trie details,\nbut this endpoint will be open to extension. Like `get_errors`, we\nsupport collecting information from multiple tabs.",
    "sha": "64b0986c05ee1b49d98b7055a38f5edfed886322",
    "files": [
        {
            "sha": "67fe278657ba331972a9cbbc04b4451cdce6c980",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -822,5 +822,6 @@\n   \"821\": \"Unprocessable request\",\n   \"822\": \"Stack frame resolver not initialized. This is a bug in Next.js.\",\n   \"823\": \"Timeout waiting for error state from frontend. The browser may not be responding to HMR messages.\",\n-  \"824\": \"URL is required in MCP error state response. This is a bug in Next.js.\"\n+  \"824\": \"URL is required in MCP browser response. This is a bug in Next.js.\",\n+  \"825\": \"Timeout waiting for response from frontend. The browser may not be responding to HMR messages.\"\n }"
        },
        {
            "sha": "4030e4666db26a8262542a832622c1aabc2d405c",
            "filename": "packages/next/src/client/dev/hot-reloader/app/hot-reloader-app.tsx",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -11,6 +11,7 @@ import {\n import {\n   dispatcher,\n   getSerializedOverlayState,\n+  getSegmentTrieData,\n } from 'next/dist/compiled/next-devtools'\n import { ReplaySsrOnlyErrors } from '../../../../next-devtools/userspace/app/errors/replay-ssr-only-errors'\n import { AppDevOverlayErrorBoundary } from '../../../../next-devtools/userspace/app/app-dev-overlay-error-boundary'\n@@ -26,6 +27,7 @@ import type {\n   TurbopackMessageSentToBrowser,\n } from '../../../../server/dev/hot-reloader-types'\n import type { McpErrorStateResponse } from '../../../../shared/lib/mcp-error-types'\n+import type { McpPageMetadataResponse } from '../../../../shared/lib/mcp-page-metadata-types'\n import { useUntrackedPathname } from '../../../components/navigation-untracked'\n import reportHmrLatency from '../../report-hmr-latency'\n import { TurbopackHmr } from '../turbopack-hot-reloader-common'\n@@ -487,6 +489,17 @@ export function processMessage(\n       sendMessage(JSON.stringify(response))\n       return\n     }\n+    case HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_PAGE_METADATA: {\n+      const segmentTrieData = getSegmentTrieData()\n+      const response: McpPageMetadataResponse = {\n+        event: HMR_MESSAGE_SENT_TO_SERVER.MCP_PAGE_METADATA_RESPONSE,\n+        requestId: message.requestId,\n+        segmentTrieData,\n+        url: window.location.href,\n+      }\n+      sendMessage(JSON.stringify(response))\n+      return\n+    }\n     case HMR_MESSAGE_SENT_TO_BROWSER.MIDDLEWARE_CHANGES:\n     case HMR_MESSAGE_SENT_TO_BROWSER.CLIENT_CHANGES:\n     case HMR_MESSAGE_SENT_TO_BROWSER.SERVER_ONLY_CHANGES:"
        },
        {
            "sha": "c22424f52ff949cf10b46660c50409794589fe1f",
            "filename": "packages/next/src/client/dev/hot-reloader/pages/hot-reloader-pages.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -35,11 +35,13 @@\n import {\n   dispatcher,\n   getSerializedOverlayState,\n+  getSegmentTrieData,\n } from 'next/dist/compiled/next-devtools'\n import { register } from '../../../../next-devtools/userspace/pages/pages-dev-overlay-setup'\n import stripAnsi from 'next/dist/compiled/strip-ansi'\n import { addMessageListener, sendMessage } from './websocket'\n import formatWebpackMessages from '../../../../shared/lib/format-webpack-messages'\n+import type { McpPageMetadataResponse } from '../../../../shared/lib/mcp-page-metadata-types'\n import {\n   HMR_MESSAGE_SENT_TO_BROWSER,\n   HMR_MESSAGE_SENT_TO_SERVER,\n@@ -410,6 +412,17 @@ function processMessage(message: HmrMessageSentToBrowser) {\n       sendMessage(JSON.stringify(response))\n       break\n     }\n+    case HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_PAGE_METADATA: {\n+      const segmentTrieData = getSegmentTrieData()\n+      const response: McpPageMetadataResponse = {\n+        event: HMR_MESSAGE_SENT_TO_SERVER.MCP_PAGE_METADATA_RESPONSE,\n+        requestId: message.requestId,\n+        segmentTrieData,\n+        url: window.location.href,\n+      }\n+      sendMessage(JSON.stringify(response))\n+      return\n+    }\n     default:\n       message satisfies never\n   }"
        },
        {
            "sha": "763c8bd67f34f9758f3efa5af871bf9765cf7f26",
            "filename": "packages/next/src/client/page-bootstrap.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -122,6 +122,7 @@ export function pageBootstrap(assetPrefix: string) {\n         case HMR_MESSAGE_SENT_TO_BROWSER.DEVTOOLS_CONFIG:\n         case HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK:\n         case HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_CURRENT_ERROR_STATE:\n+        case HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_PAGE_METADATA:\n           // Most of these action types are handled in\n           // src/client/dev/hot-reloader/pages/hot-reloader-pages.ts and\n           // src/client/dev/hot-reloader/app/hot-reloader-app.tsx"
        },
        {
            "sha": "98a848cd7f83e2850578f78c38b1f7bc35ce5a27",
            "filename": "packages/next/src/next-devtools/dev-overlay.browser.tsx",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -42,9 +42,11 @@ import type { VersionInfo } from '../server/dev/parse-version-info'\n import {\n   insertSegmentNode,\n   removeSegmentNode,\n+  getSegmentTrieRoot,\n } from './dev-overlay/segment-explorer-trie'\n import type { SegmentNodeState } from './userspace/app/segment-explorer-node'\n import type { DevToolsConfig } from './dev-overlay/shared'\n+import type { SegmentTrieData } from '../shared/lib/mcp-page-metadata-types'\n \n export interface Dispatcher {\n   onBuildOk(): void\n@@ -79,10 +81,6 @@ type OverlayStateWithRouter = OverlayState & { routerType: 'pages' | 'app' }\n \n let currentOverlayState: OverlayStateWithRouter | null = null\n \n-export function getCurrentOverlayState(): OverlayStateWithRouter | null {\n-  return currentOverlayState\n-}\n-\n export function getSerializedOverlayState(): OverlayStateWithRouter | null {\n   // Serialize error objects properly since Error properties are non-enumerable\n   // This is used when sending state via HMR/JSON.stringify\n@@ -103,6 +101,17 @@ export function getSerializedOverlayState(): OverlayStateWithRouter | null {\n   }\n }\n \n+export function getSegmentTrieData(): SegmentTrieData | null {\n+  if (!currentOverlayState) {\n+    return null\n+  }\n+  const trieRoot = getSegmentTrieRoot()\n+  return {\n+    segmentTrie: trieRoot,\n+    routerType: currentOverlayState.routerType,\n+  }\n+}\n+\n // Events might be dispatched before we get a `dispatch` from React (e.g. console.error during module eval).\n // We need to queue them until we have a `dispatch` function available.\n function createQueuable<Args extends any[]>("
        },
        {
            "sha": "8145fe3e82729a07b22ae5263b598e75d11855bb",
            "filename": "packages/next/src/next-devtools/dev-overlay/segment-explorer-trie.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer-trie.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer-trie.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fsegment-explorer-trie.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -148,6 +148,7 @@ const trie: SegmentTrie = createTrie({\n })\n export const insertSegmentNode = trie.insert\n export const removeSegmentNode = trie.remove\n+export const getSegmentTrieRoot = trie.getRoot\n \n export function useSegmentTree(): SegmentTrieNode {\n   const state = useSyncExternalStore(subscribe, getSnapshot, getServerSnapshot)"
        },
        {
            "sha": "c27a23f531ab2bae0dc71e217cbd17f61810fef7",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -114,6 +114,7 @@ import {\n } from './hot-reloader-shared-utils'\n import { getMcpMiddleware } from '../mcp/get-mcp-middleware'\n import { handleErrorStateResponse } from '../mcp/tools/get-errors'\n+import { handlePageMetadataResponse } from '../mcp/tools/get-page-metadata'\n import { setStackFrameResolver } from '../mcp/tools/utils/format-errors'\n \n const wsServer = new ws.Server({ noServer: true })\n@@ -948,6 +949,15 @@ export async function createHotReloaderTurbopack(\n               break\n             }\n \n+            case 'mcp-page-metadata-response': {\n+              handlePageMetadataResponse(\n+                parsedData.requestId,\n+                parsedData.segmentTrieData,\n+                parsedData.url\n+              )\n+              break\n+            }\n+\n             default:\n               // Might be a Turbopack message...\n               if (!parsedData.type) {"
        },
        {
            "sha": "9de7d17e4ac3ed4ea6b00bc85e8554dbb910935d",
            "filename": "packages/next/src/server/dev/hot-reloader-types.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -31,6 +31,7 @@ export const enum HMR_MESSAGE_SENT_TO_BROWSER {\n   DEV_INDICATOR = 'devIndicator',\n   DEVTOOLS_CONFIG = 'devtoolsConfig',\n   REQUEST_CURRENT_ERROR_STATE = 'requestCurrentErrorState',\n+  REQUEST_PAGE_METADATA = 'requestPageMetadata',\n \n   // Binary messages:\n   REACT_DEBUG_CHUNK = 0,\n@@ -39,6 +40,7 @@ export const enum HMR_MESSAGE_SENT_TO_BROWSER {\n export const enum HMR_MESSAGE_SENT_TO_SERVER {\n   // JSON messages:\n   MCP_ERROR_STATE_RESPONSE = 'mcp-error-state-response',\n+  MCP_PAGE_METADATA_RESPONSE = 'mcp-page-metadata-response',\n   PING = 'ping',\n }\n \n@@ -155,6 +157,11 @@ export interface RequestCurrentErrorStateMessage {\n   requestId: string\n }\n \n+export interface RequestPageMetadataMessage {\n+  type: HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_PAGE_METADATA\n+  requestId: string\n+}\n+\n export type HmrMessageSentToBrowser =\n   | TurbopackMessage\n   | TurbopackConnectedMessage\n@@ -174,6 +181,7 @@ export type HmrMessageSentToBrowser =\n   | DevToolsConfigMessage\n   | ReactDebugChunkMessage\n   | RequestCurrentErrorStateMessage\n+  | RequestPageMetadataMessage\n \n export type BinaryHmrMessageSentToBrowser = Extract<\n   HmrMessageSentToBrowser,"
        },
        {
            "sha": "a883ba99d4b5766ea105772590e4e04d374ee82f",
            "filename": "packages/next/src/server/dev/on-demand-entry-handler.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -47,6 +47,7 @@ import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { PAGE_TYPES } from '../../lib/page-types'\n import { getNextFlightSegmentPath } from '../../client/flight-data-helpers'\n import { handleErrorStateResponse } from '../mcp/tools/get-errors'\n+import { handlePageMetadataResponse } from '../mcp/tools/get-page-metadata'\n \n const debug = createDebug('next:on-demand-entry-handler')\n \n@@ -1011,6 +1012,15 @@ export function onDemandEntryHandler({\n               parsedData.errorState,\n               parsedData.url\n             )\n+          } else if (\n+            parsedData.event ===\n+            HMR_MESSAGE_SENT_TO_SERVER.MCP_PAGE_METADATA_RESPONSE\n+          ) {\n+            handlePageMetadataResponse(\n+              parsedData.requestId,\n+              parsedData.segmentTrieData,\n+              parsedData.url\n+            )\n           }\n         } catch {}\n       })"
        },
        {
            "sha": "023611a3848212567880c03dbeb24897902b3a63",
            "filename": "packages/next/src/server/mcp/get-or-create-mcp-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -1,6 +1,7 @@\n import { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n import { registerGetProjectPathTool } from './tools/get-project-path'\n import { registerGetErrorsTool } from './tools/get-errors'\n+import { registerGetPageMetadataTool } from './tools/get-page-metadata'\n import type { HmrMessageSentToBrowser } from '../dev/hot-reloader-types'\n \n let mcpServer: McpServer | undefined\n@@ -21,6 +22,11 @@ export const getOrCreateMcpServer = (\n \n   registerGetProjectPathTool(mcpServer, projectPath)\n   registerGetErrorsTool(mcpServer, sendHmrMessage, getActiveConnectionCount)\n+  registerGetPageMetadataTool(\n+    mcpServer,\n+    sendHmrMessage,\n+    getActiveConnectionCount\n+  )\n \n   return mcpServer\n }"
        },
        {
            "sha": "a84cca300c4e796b5227f85b38f7eac7d30649d0",
            "filename": "packages/next/src/server/mcp/tools/get-errors.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 73,
            "changes": 93,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -15,23 +15,12 @@ import {\n   HMR_MESSAGE_SENT_TO_BROWSER,\n   type HmrMessageSentToBrowser,\n } from '../../dev/hot-reloader-types'\n-import { nanoid } from 'next/dist/compiled/nanoid'\n-import type { OverlayStateWithUrl } from '../../../shared/lib/mcp-error-types'\n import { formatErrors } from './utils/format-errors'\n-\n-// These promises are created when the MCP endpoint is called but before the browser has responded\n-// with its error state. They are resolved when the browser has responded with its error state\n-// or when the timeout is reached.\n-const pendingRequests = new Map<\n-  string,\n-  {\n-    responses: OverlayStateWithUrl[]\n-    expectedCount: number\n-    resolve: (value: OverlayStateWithUrl[]) => void\n-    reject: (reason?: any) => void\n-    timeout: NodeJS.Timeout\n-  }\n->()\n+import {\n+  createBrowserRequest,\n+  handleBrowserPageResponse,\n+  DEFAULT_BROWSER_REQUEST_TIMEOUT_MS,\n+} from './utils/browser-communication'\n \n export function registerGetErrorsTool(\n   server: McpServer,\n@@ -59,49 +48,17 @@ export function registerGetErrorsTool(\n           }\n         }\n \n-        const requestId = `mcp-error-state-${nanoid()}`\n-\n-        // The promise will be resolved when all active browser sessions have responded\n-        // with their respective error states. We will resolve the promise after 5 seconds\n-        // with whatever responses we have received so far.\n-        const responsePromise = new Promise<OverlayStateWithUrl[]>(\n-          (resolve, reject) => {\n-            const timeout = setTimeout(() => {\n-              const pending = pendingRequests.get(requestId)\n-              if (pending && pending.responses.length > 0) {\n-                resolve(pending.responses)\n-              } else {\n-                reject(\n-                  new Error(\n-                    'Timeout waiting for error state from frontend. The browser may not be responding to HMR messages.'\n-                  )\n-                )\n-              }\n-              pendingRequests.delete(requestId)\n-            }, 5000)\n-            pendingRequests.set(requestId, {\n-              responses: [],\n-              expectedCount: connectionCount,\n-              resolve,\n-              reject,\n-              timeout,\n-            })\n-          }\n+        const responses = await createBrowserRequest<OverlayState>(\n+          HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_CURRENT_ERROR_STATE,\n+          sendHmrMessage,\n+          getActiveConnectionCount,\n+          DEFAULT_BROWSER_REQUEST_TIMEOUT_MS\n         )\n \n-        // When browser receives this HMR message, it will send back a response with\n-        // its client-side error state, which will be handled by `handleErrorStateResponse`.\n-        sendHmrMessage({\n-          type: HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_CURRENT_ERROR_STATE,\n-          requestId,\n-        })\n-\n-        const clientStates = await responsePromise\n-\n         const errorsByUrl = new Map<string, OverlayState>()\n-        for (const state of clientStates) {\n-          if (state.errorState) {\n-            errorsByUrl.set(state.url, state.errorState)\n+        for (const response of responses) {\n+          if (response.data) {\n+            errorsByUrl.set(response.url, response.data)\n           }\n         }\n \n@@ -115,9 +72,9 @@ export function registerGetErrorsTool(\n               {\n                 type: 'text',\n                 text:\n-                  clientStates.length === 0\n+                  responses.length === 0\n                     ? 'No browser sessions responded.'\n-                    : `No errors detected in ${clientStates.length} browser session(s).`,\n+                    : `No errors detected in ${responses.length} browser session(s).`,\n               },\n             ],\n           }\n@@ -155,19 +112,9 @@ export function handleErrorStateResponse(\n   errorState: OverlayState | null,\n   url: string | undefined\n ) {\n-  if (!url) {\n-    throw new Error(\n-      'URL is required in MCP error state response. This is a bug in Next.js.'\n-    )\n-  }\n-\n-  const pending = pendingRequests.get(requestId)\n-  if (pending) {\n-    pending.responses.push({ url, errorState })\n-    if (pending.responses.length >= pending.expectedCount) {\n-      clearTimeout(pending.timeout)\n-      pending.resolve(pending.responses)\n-      pendingRequests.delete(requestId)\n-    }\n-  }\n+  handleBrowserPageResponse<OverlayState | null>(\n+    requestId,\n+    errorState,\n+    url || ''\n+  )\n }"
        },
        {
            "sha": "af9a7b92d1a61ce81bf5730fa311d9ff0d13f280",
            "filename": "packages/next/src/server/mcp/tools/get-page-metadata.ts",
            "status": "added",
            "additions": 212,
            "deletions": 0,
            "changes": 212,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-page-metadata.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,212 @@\n+import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  type HmrMessageSentToBrowser,\n+} from '../../dev/hot-reloader-types'\n+import {\n+  createBrowserRequest,\n+  handleBrowserPageResponse,\n+  DEFAULT_BROWSER_REQUEST_TIMEOUT_MS,\n+} from './utils/browser-communication'\n+import type {\n+  PageMetadata,\n+  PageSegment,\n+  SegmentTrieData,\n+} from '../../../shared/lib/mcp-page-metadata-types'\n+import type { SegmentTrieNode } from '../../../next-devtools/dev-overlay/segment-explorer-trie'\n+\n+export function registerGetPageMetadataTool(\n+  server: McpServer,\n+  sendHmrMessage: (message: HmrMessageSentToBrowser) => void,\n+  getActiveConnectionCount: () => number\n+) {\n+  server.registerTool(\n+    'get_page_metadata',\n+    {\n+      description:\n+        'Get runtime metadata about what contributes to the current page render from active browser sessions.',\n+      inputSchema: {},\n+    },\n+    async (_request) => {\n+      try {\n+        const connectionCount = getActiveConnectionCount()\n+        if (connectionCount === 0) {\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: 'No browser sessions connected. Please open your application in a browser to retrieve page metadata.',\n+              },\n+            ],\n+          }\n+        }\n+\n+        const responses = await createBrowserRequest<SegmentTrieData>(\n+          HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_PAGE_METADATA,\n+          sendHmrMessage,\n+          getActiveConnectionCount,\n+          DEFAULT_BROWSER_REQUEST_TIMEOUT_MS\n+        )\n+\n+        if (responses.length === 0) {\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: 'No browser sessions responded.',\n+              },\n+            ],\n+          }\n+        }\n+\n+        const metadataByUrl = new Map<string, PageMetadata>()\n+        for (const response of responses) {\n+          if (response.data) {\n+            // TODO: Add other metadata for the current page render here. Currently, we only have segment trie data.\n+            const pageMetadata = convertSegmentTrieToPageMetadata(response.data)\n+            metadataByUrl.set(response.url, pageMetadata)\n+          }\n+        }\n+\n+        if (metadataByUrl.size === 0) {\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: `No page metadata available from ${responses.length} browser session(s).`,\n+              },\n+            ],\n+          }\n+        }\n+\n+        const output = formatPageMetadata(metadataByUrl)\n+\n+        return {\n+          content: [\n+            {\n+              type: 'text',\n+              text: output,\n+            },\n+          ],\n+        }\n+      } catch (error) {\n+        return {\n+          content: [\n+            {\n+              type: 'text',\n+              text: `Error: ${error instanceof Error ? error.message : String(error)}`,\n+            },\n+          ],\n+        }\n+      }\n+    }\n+  )\n+}\n+\n+export function handlePageMetadataResponse(\n+  requestId: string,\n+  segmentTrieData: SegmentTrieData | null,\n+  url: string | undefined\n+) {\n+  handleBrowserPageResponse<SegmentTrieData | null>(\n+    requestId,\n+    segmentTrieData,\n+    url || ''\n+  )\n+}\n+\n+function convertSegmentTrieToPageMetadata(data: SegmentTrieData): PageMetadata {\n+  const segments: PageSegment[] = []\n+\n+  if (data.segmentTrie) {\n+    // Traverse the trie and collect all segments\n+    function traverseTrie(node: SegmentTrieNode): void {\n+      if (node.value) {\n+        segments.push({\n+          type: node.value.type,\n+          pagePath: node.value.pagePath,\n+          boundaryType: node.value.boundaryType,\n+        })\n+      }\n+\n+      for (const childNode of Object.values(node.children)) {\n+        if (childNode) {\n+          traverseTrie(childNode)\n+        }\n+      }\n+    }\n+\n+    traverseTrie(data.segmentTrie)\n+  }\n+\n+  return {\n+    segments,\n+    routerType: data.routerType,\n+  }\n+}\n+\n+function formatPageMetadata(metadataByUrl: Map<string, PageMetadata>): string {\n+  let output = `# Page metadata from ${metadataByUrl.size} browser session(s)\\n\\n`\n+\n+  for (const [url, metadata] of metadataByUrl) {\n+    let displayUrl = url\n+    try {\n+      const urlObj = new URL(url)\n+      displayUrl = urlObj.pathname + urlObj.search + urlObj.hash\n+    } catch {\n+      // If URL parsing fails, use the original URL\n+    }\n+\n+    output += `## Session: ${displayUrl}\\n\\n`\n+    output += `**Router type:** ${metadata.routerType}\\n\\n`\n+\n+    if (metadata.segments.length === 0) {\n+      output += '*No segments found*\\n\\n'\n+    } else {\n+      output += '### Files powering this page:\\n\\n'\n+\n+      // Ensure consistent output to avoid flaky tests\n+      const sortedSegments = [...metadata.segments].sort((a, b) => {\n+        const typeOrder = (segment: PageSegment): number => {\n+          const type = segment.boundaryType || segment.type\n+          if (type === 'layout') return 0\n+          if (type.startsWith('boundary:')) return 1\n+          if (type === 'page') return 2\n+          return 3\n+        }\n+        const aOrder = typeOrder(a)\n+        const bOrder = typeOrder(b)\n+        if (aOrder !== bOrder) return aOrder - bOrder\n+        return a.pagePath.localeCompare(b.pagePath)\n+      })\n+\n+      for (const segment of sortedSegments) {\n+        const path = segment.pagePath\n+        const isBuiltin = path.startsWith('__next_builtin__')\n+        const type = segment.boundaryType || segment.type\n+        const isBoundary = type.startsWith('boundary:')\n+\n+        let displayPath = path\n+          .replace(/@boundary$/, '')\n+          .replace(/^__next_builtin__/, '')\n+\n+        if (!isBuiltin && !displayPath.startsWith('app/')) {\n+          displayPath = `app/${displayPath}`\n+        }\n+\n+        const descriptors: string[] = []\n+        if (isBoundary) descriptors.push('boundary')\n+        if (isBuiltin) descriptors.push('builtin')\n+\n+        const descriptor =\n+          descriptors.length > 0 ? ` (${descriptors.join(', ')})` : ''\n+        output += `- ${displayPath}${descriptor}\\n`\n+      }\n+      output += '\\n'\n+    }\n+\n+    output += '---\\n\\n'\n+  }\n+\n+  return output.trim()\n+}"
        },
        {
            "sha": "930e94c5c594ac0d1e607dc14077cf6201c6c097",
            "filename": "packages/next/src/server/mcp/tools/utils/browser-communication.ts",
            "status": "added",
            "additions": 97,
            "deletions": 0,
            "changes": 97,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fbrowser-communication.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fbrowser-communication.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fbrowser-communication.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,97 @@\n+/**\n+ * Shared utilities for MCP tools that communicate with the browser.\n+ * This module provides a common infrastructure for request-response\n+ * communication between MCP endpoints and browser sessions via HMR.\n+ */\n+\n+import { nanoid } from 'next/dist/compiled/nanoid'\n+import type {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  HmrMessageSentToBrowser,\n+} from '../../../dev/hot-reloader-types'\n+\n+export const DEFAULT_BROWSER_REQUEST_TIMEOUT_MS = 5000\n+\n+export type BrowserResponse<T> = {\n+  url: string\n+  data: T\n+}\n+\n+type PendingRequest<T> = {\n+  responses: BrowserResponse<T>[]\n+  expectedCount: number\n+  resolve: (value: BrowserResponse<T>[]) => void\n+  reject: (reason?: unknown) => void\n+  timeout: NodeJS.Timeout\n+}\n+\n+const pendingRequests = new Map<string, PendingRequest<unknown>>()\n+\n+export function createBrowserRequest<T>(\n+  messageType: HMR_MESSAGE_SENT_TO_BROWSER,\n+  sendHmrMessage: (message: HmrMessageSentToBrowser) => void,\n+  getActiveConnectionCount: () => number,\n+  timeoutMs: number\n+): Promise<BrowserResponse<T>[]> {\n+  const connectionCount = getActiveConnectionCount()\n+  if (connectionCount === 0) {\n+    return Promise.resolve([])\n+  }\n+\n+  const requestId = `mcp-${messageType}-${nanoid()}`\n+\n+  const responsePromise = new Promise<BrowserResponse<T>[]>(\n+    (resolve, reject) => {\n+      const timeout = setTimeout(() => {\n+        const pending = pendingRequests.get(requestId)\n+        if (pending && pending.responses.length > 0) {\n+          resolve(pending.responses as BrowserResponse<T>[])\n+        } else {\n+          reject(\n+            new Error(\n+              `Timeout waiting for response from frontend. The browser may not be responding to HMR messages.`\n+            )\n+          )\n+        }\n+        pendingRequests.delete(requestId)\n+      }, timeoutMs)\n+\n+      pendingRequests.set(requestId, {\n+        responses: [],\n+        expectedCount: connectionCount,\n+        resolve: resolve as (value: BrowserResponse<unknown>[]) => void,\n+        reject,\n+        timeout,\n+      })\n+    }\n+  )\n+\n+  sendHmrMessage({\n+    type: messageType,\n+    requestId,\n+  } as HmrMessageSentToBrowser)\n+\n+  return responsePromise\n+}\n+\n+export function handleBrowserPageResponse<T>(\n+  requestId: string,\n+  data: T,\n+  url: string\n+): void {\n+  if (!url) {\n+    throw new Error(\n+      'URL is required in MCP browser response. This is a bug in Next.js.'\n+    )\n+  }\n+\n+  const pending = pendingRequests.get(requestId)\n+  if (pending) {\n+    pending.responses.push({ url, data })\n+    if (pending.responses.length >= pending.expectedCount) {\n+      clearTimeout(pending.timeout)\n+      pending.resolve(pending.responses)\n+      pendingRequests.delete(requestId)\n+    }\n+  }\n+}"
        },
        {
            "sha": "7a4117b1a2d6c0a2faad66f0772bfeb38cae7f09",
            "filename": "packages/next/src/shared/lib/mcp-page-metadata-types.ts",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmcp-page-metadata-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmcp-page-metadata-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmcp-page-metadata-types.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,29 @@\n+import type { SegmentTrieNode } from '../../next-devtools/dev-overlay/segment-explorer-trie'\n+\n+export type SegmentTrieData = {\n+  segmentTrie: SegmentTrieNode | null\n+  routerType: 'app' | 'pages'\n+}\n+\n+export type PageSegment = {\n+  type: string\n+  pagePath: string\n+  boundaryType: string | null\n+}\n+\n+export type PageMetadata = {\n+  segments: PageSegment[]\n+  routerType: 'app' | 'pages'\n+}\n+\n+export type PageMetadataWithUrl = {\n+  url: string\n+  metadata: PageMetadata | null\n+}\n+\n+export interface McpPageMetadataResponse {\n+  event: string\n+  requestId: string\n+  segmentTrieData: SegmentTrieData | null\n+  url: string\n+}"
        },
        {
            "sha": "af294f9d05ca22846065e1fe7afc67cfe9020e0e",
            "filename": "test/development/mcp-server/fixtures/pages-router-template/next.config.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fnext.config.js?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,5 @@\n+module.exports = {\n+  experimental: {\n+    mcpServer: true,\n+  },\n+}"
        },
        {
            "sha": "76ad5420b1e1e763f310780749c83f4fa1b28fb1",
            "filename": "test/development/mcp-server/fixtures/pages-router-template/pages/_app.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2F_app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2F_app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2F_app.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,5 @@\n+import type { AppProps } from 'next/app'\n+\n+export default function MyApp({ Component, pageProps }: AppProps) {\n+  return <Component {...pageProps} />\n+}"
        },
        {
            "sha": "725c5a15b20b9fb761128fd9d8f6085e6c8329e6",
            "filename": "test/development/mcp-server/fixtures/pages-router-template/pages/about.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2Fabout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2Fabout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2Fabout.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,8 @@\n+export default function AboutPage() {\n+  return (\n+    <div>\n+      <h1>About Page</h1>\n+      <p>This is the about page using pages router.</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "c238611f3b7e6cafaf61f56146f17a2b1e168527",
            "filename": "test/development/mcp-server/fixtures/pages-router-template/pages/index.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2Findex.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2Findex.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fpages-router-template%2Fpages%2Findex.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,8 @@\n+export default function HomePage() {\n+  return (\n+    <div>\n+      <h1>Pages Router Home</h1>\n+      <p>This is a pages router page.</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "46af09232f54e722fa19216f7779d8330af61525",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/error.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Ferror.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Ferror.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Ferror.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,16 @@\n+'use client'\n+\n+export default function RootError({\n+  error,\n+  reset,\n+}: {\n+  error: Error\n+  reset: () => void\n+}) {\n+  return (\n+    <div>\n+      <h2>Root Error: {error.message}</h2>\n+      <button onClick={reset}>Try again</button>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Flayout.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "badc2009b58d5ba77a37cb2c658927dcae6f200d",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Floading.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,3 @@\n+export default function RootLoading() {\n+  return <div>Root Loading...</div>\n+}"
        },
        {
            "sha": "1fef57330cc8de92b78bb7f6a01a130b54f95aef",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/not-found.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fnot-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fnot-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fnot-found.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,8 @@\n+export default function NotFound() {\n+  return (\n+    <div>\n+      <h2>404 - Page Not Found</h2>\n+      <p>Could not find the requested page.</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "3647c421b9ce62616104ea4cbda3e8c58c45db50",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fpage.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,3 @@\n+export default function HomePage() {\n+  return <div>Home Page</div>\n+}"
        },
        {
            "sha": "d871b2ead8b674bf3154190a6e3e0c2836bd23fe",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/parallel/@content/error.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40content%2Ferror.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40content%2Ferror.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40content%2Ferror.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,16 @@\n+'use client'\n+\n+export default function ContentError({\n+  error,\n+  reset,\n+}: {\n+  error: Error\n+  reset: () => void\n+}) {\n+  return (\n+    <div>\n+      <h2>Content Error: {error.message}</h2>\n+      <button onClick={reset}>Try again</button>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "6983ae07e3595c5abeb8eb14132aa8b7da252ef0",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/parallel/@content/page.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40content%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40content%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40content%2Fpage.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,8 @@\n+export default function ContentPage() {\n+  return (\n+    <div>\n+      <h2>Main Content</h2>\n+      <p>This is the main content area with parallel routing.</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "cecd3b83b0bc76bed9fe321eaa00ef35f5cfb164",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/parallel/@sidebar/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40sidebar%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40sidebar%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40sidebar%2Floading.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,3 @@\n+export default function SidebarLoading() {\n+  return <div>Sidebar Loading...</div>\n+}"
        },
        {
            "sha": "b493a21b2c14c8518b1a5f4c55925c71b957941d",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/parallel/@sidebar/page.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40sidebar%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40sidebar%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2F%40sidebar%2Fpage.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,12 @@\n+export default function SidebarPage() {\n+  return (\n+    <div>\n+      <h3>Sidebar</h3>\n+      <ul>\n+        <li>Item 1</li>\n+        <li>Item 2</li>\n+        <li>Item 3</li>\n+      </ul>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "f8e603f7615ebdfef34f0a0d127333f7c4648e3c",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/parallel/error.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Ferror.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Ferror.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Ferror.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,16 @@\n+'use client'\n+\n+export default function ParallelError({\n+  error,\n+  reset,\n+}: {\n+  error: Error\n+  reset: () => void\n+}) {\n+  return (\n+    <div>\n+      <h2>Parallel Error: {error.message}</h2>\n+      <button onClick={reset}>Try again</button>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "535ec8876b174caf0660a37637ccdf07d3eee8f7",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/parallel/layout.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Flayout.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,19 @@\n+export default function ParallelLayout({\n+  children,\n+  sidebar,\n+  content,\n+}: {\n+  children: React.ReactNode\n+  sidebar: React.ReactNode\n+  content: React.ReactNode\n+}) {\n+  return (\n+    <div style={{ display: 'flex' }}>\n+      <div style={{ flex: '0 0 200px', borderRight: '1px solid #ccc' }}>\n+        {sidebar}\n+      </div>\n+      <div style={{ flex: 1 }}>{content}</div>\n+      <div>{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "1f2798c3328580e79cf86ad19c8a6601ae3ff856",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/parallel/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Floading.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,3 @@\n+export default function ParallelLoading() {\n+  return <div>Parallel Page Loading...</div>\n+}"
        },
        {
            "sha": "564debbeefd75e91e2903b6b6915565ef2a0e403",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/app/parallel/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fapp%2Fparallel%2Fpage.tsx?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,3 @@\n+export default function ParallelPage() {\n+  return <div>Default parallel page (children slot)</div>\n+}"
        },
        {
            "sha": "af294f9d05ca22846065e1fe7afc67cfe9020e0e",
            "filename": "test/development/mcp-server/fixtures/parallel-routes-template/next.config.js",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fparallel-routes-template%2Fnext.config.js?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,5 @@\n+module.exports = {\n+  experimental: {\n+    mcpServer: true,\n+  },\n+}"
        },
        {
            "sha": "1b1085188627b0c24ddaf75abd7aca493903ae50",
            "filename": "test/development/mcp-server/mcp-server-get-page-metadata.test.ts",
            "status": "added",
            "additions": 238,
            "deletions": 0,
            "changes": 238,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-page-metadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-page-metadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-page-metadata.test.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,238 @@\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+import { retry } from 'next-test-utils'\n+import stripAnsi from 'strip-ansi'\n+import { launchStandaloneSession } from './test-utils'\n+\n+describe('mcp-server get_page_metadata tool', () => {\n+  async function callGetPageMetadata(url: string, id: string) {\n+    const response = await fetch(`${url}/_next/mcp`, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+        Accept: 'application/json, text/event-stream',\n+      },\n+      body: JSON.stringify({\n+        jsonrpc: '2.0',\n+        id,\n+        method: 'tools/call',\n+        params: { name: 'get_page_metadata', arguments: {} },\n+      }),\n+    })\n+\n+    const text = await response.text()\n+    const match = text.match(/data: ({.*})/s)\n+    const result = JSON.parse(match![1])\n+    return result.result?.content?.[0]?.text\n+  }\n+\n+  describe('app router', () => {\n+    const { next } = nextTestSetup({\n+      files: new FileRef(\n+        path.join(__dirname, 'fixtures', 'parallel-routes-template')\n+      ),\n+    })\n+\n+    it('should return metadata for basic page', async () => {\n+      await next.browser('/')\n+      const metadata = await callGetPageMetadata(next.url, 'test-basic')\n+\n+      expect(stripAnsi(metadata)).toMatchInlineSnapshot(`\n+       \"# Page metadata from 1 browser session(s)\n+\n+       ## Session: /\n+\n+       **Router type:** app\n+\n+       ### Files powering this page:\n+\n+       - app/layout.tsx\n+       - global-error.js (boundary, builtin)\n+       - app/error.tsx (boundary)\n+       - app/loading.tsx (boundary)\n+       - app/not-found.tsx (boundary)\n+       - app/page.tsx\n+\n+       ---\"\n+      `)\n+    })\n+\n+    it('should return metadata for parallel routes', async () => {\n+      await next.browser('/parallel')\n+\n+      let metadata: string = ''\n+      await retry(async () => {\n+        const sessionId = 'test-parallel-' + Date.now()\n+        metadata = await callGetPageMetadata(next.url, sessionId)\n+        expect(metadata).toContain('Page metadata from 1 browser session')\n+        expect(metadata).toContain('Files powering this page')\n+        // Ensure we have the parallel route files\n+        expect(metadata).toContain('app/parallel/@sidebar/page.tsx')\n+        expect(metadata).toContain('app/parallel/@content/page.tsx')\n+        expect(metadata).toContain('app/parallel/page.tsx')\n+      })\n+\n+      expect(stripAnsi(metadata)).toMatchInlineSnapshot(`\n+       \"# Page metadata from 1 browser session(s)\n+\n+       ## Session: /parallel\n+\n+       **Router type:** app\n+\n+       ### Files powering this page:\n+\n+       - app/layout.tsx\n+       - app/parallel/layout.tsx\n+       - global-error.js (boundary, builtin)\n+       - app/error.tsx (boundary)\n+       - app/loading.tsx (boundary)\n+       - app/not-found.tsx (boundary)\n+       - app/parallel/@content/error.tsx (boundary)\n+       - app/parallel/@sidebar/loading.tsx (boundary)\n+       - app/parallel/error.tsx (boundary)\n+       - app/parallel/loading.tsx (boundary)\n+       - app/parallel/@content/page.tsx\n+       - app/parallel/@sidebar/page.tsx\n+       - app/parallel/page.tsx\n+\n+       ---\"\n+      `)\n+    })\n+\n+    it('should handle multiple browser sessions', async () => {\n+      // Open two browser tabs using standalone sessions for true concurrent tabs\n+      const session1 = await launchStandaloneSession(next.url, '/')\n+      const session2 = await launchStandaloneSession(next.url, '/parallel')\n+\n+      try {\n+        await new Promise((resolve) => setTimeout(resolve, 1000))\n+\n+        let metadata: string = ''\n+        await retry(async () => {\n+          const sessionId = 'test-multi-' + Date.now()\n+          metadata = await callGetPageMetadata(next.url, sessionId)\n+          expect(metadata).toMatch(/Page metadata from \\d+ browser session/)\n+          // Ensure both our sessions are present\n+          expect(metadata).toContain('Session: /')\n+          expect(metadata).toContain('Session: /parallel')\n+        })\n+\n+        const strippedMetadata = stripAnsi(metadata)\n+\n+        // Extract each session's content to check them independently\n+        const session1Match = strippedMetadata.match(\n+          /## Session: \\/\\n[\\s\\S]*?(?=(\\n## Session:|\\n?$))/\n+        )\n+        const session2Match = strippedMetadata.match(\n+          /## Session: \\/parallel\\n[\\s\\S]*?(?=(\\n## Session:|\\n?$))/\n+        )\n+\n+        // Trim trailing newline if present\n+        if (session1Match) session1Match[0] = session1Match[0].trimEnd()\n+        if (session2Match) session2Match[0] = session2Match[0].trimEnd()\n+\n+        expect(session1Match).toBeTruthy()\n+        expect(session2Match).toBeTruthy()\n+\n+        expect(session1Match?.[0]).toMatchInlineSnapshot(`\n+         \"## Session: /\n+\n+         **Router type:** app\n+\n+         ### Files powering this page:\n+\n+         - app/layout.tsx\n+         - global-error.js (boundary, builtin)\n+         - app/error.tsx (boundary)\n+         - app/loading.tsx (boundary)\n+         - app/not-found.tsx (boundary)\n+         - app/page.tsx\n+\n+         ---\"\n+        `)\n+\n+        expect(session2Match?.[0]).toMatchInlineSnapshot(`\n+         \"## Session: /parallel\n+\n+         **Router type:** app\n+\n+         ### Files powering this page:\n+\n+         - app/layout.tsx\n+         - app/parallel/layout.tsx\n+         - global-error.js (boundary, builtin)\n+         - app/error.tsx (boundary)\n+         - app/loading.tsx (boundary)\n+         - app/not-found.tsx (boundary)\n+         - app/parallel/@content/error.tsx (boundary)\n+         - app/parallel/@sidebar/loading.tsx (boundary)\n+         - app/parallel/error.tsx (boundary)\n+         - app/parallel/loading.tsx (boundary)\n+         - app/parallel/@content/page.tsx\n+         - app/parallel/@sidebar/page.tsx\n+         - app/parallel/page.tsx\n+\n+         ---\"\n+        `)\n+      } finally {\n+        // Clean up sessions\n+        await session1.close()\n+        await session2.close()\n+      }\n+    })\n+  })\n+\n+  describe('pages router', () => {\n+    const { next } = nextTestSetup({\n+      files: new FileRef(\n+        path.join(__dirname, 'fixtures', 'pages-router-template')\n+      ),\n+    })\n+\n+    it('should return metadata showing pages router type', async () => {\n+      await next.browser('/')\n+\n+      let metadata: string = ''\n+      await retry(async () => {\n+        const sessionId = 'test-pages-' + Date.now()\n+        metadata = await callGetPageMetadata(next.url, sessionId)\n+        expect(metadata).toContain('Page metadata from 1 browser session')\n+      })\n+\n+      expect(stripAnsi(metadata)).toMatchInlineSnapshot(`\n+          \"# Page metadata from 1 browser session(s)\n+\n+          ## Session: /\n+\n+          **Router type:** pages\n+\n+          *No segments found*\n+\n+          ---\"\n+        `)\n+    })\n+\n+    it('should show pages router type for about page', async () => {\n+      await next.browser('/about')\n+\n+      let metadata: string = ''\n+      await retry(async () => {\n+        const sessionId = 'test-pages-about-' + Date.now()\n+        metadata = await callGetPageMetadata(next.url, sessionId)\n+        expect(metadata).toContain('Page metadata from 1 browser session')\n+      })\n+\n+      expect(stripAnsi(metadata)).toMatchInlineSnapshot(`\n+          \"# Page metadata from 1 browser session(s)\n+\n+          ## Session: /about\n+\n+          **Router type:** pages\n+\n+          *No segments found*\n+\n+          ---\"\n+        `)\n+    })\n+  })\n+})"
        },
        {
            "sha": "d68c0e8470fc883e7aae63bfcb1194d19ee1e562",
            "filename": "test/development/mcp-server/test-utils.ts",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ftest-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/64b0986c05ee1b49d98b7055a38f5edfed886322/test%2Fdevelopment%2Fmcp-server%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ftest-utils.ts?ref=64b0986c05ee1b49d98b7055a38f5edfed886322",
            "patch": "@@ -0,0 +1,42 @@\n+import { chromium, firefox, webkit, type Browser } from 'playwright'\n+\n+function getFullUrl(appPortOrUrl: string | number, url: string): string {\n+  const appUrl =\n+    typeof appPortOrUrl === 'string'\n+      ? appPortOrUrl\n+      : `http://localhost:${appPortOrUrl}`\n+  return url.startsWith('/') ? `${appUrl}${url}` : url\n+}\n+\n+/**\n+ * Minimal standalone browser session launcher for testing multiple concurrent browser tabs.\n+ * The standard test harness (next.browser) uses a singleton browser instance which doesn't\n+ * support concurrent tabs needed for testing errors across multiple browser sessions.\n+ */\n+export async function launchStandaloneSession(\n+  appPortOrUrl: string | number,\n+  url: string\n+) {\n+  const headless = !!process.env.HEADLESS\n+  const browserName = (process.env.BROWSER_NAME || 'chrome').toLowerCase()\n+  let browser: Browser\n+  if (browserName === 'safari') {\n+    browser = await webkit.launch({ headless })\n+  } else if (browserName === 'firefox') {\n+    browser = await firefox.launch({ headless })\n+  } else {\n+    browser = await chromium.launch({ headless })\n+  }\n+  const context = await browser.newContext()\n+  const page = await context.newPage()\n+  const fullUrl = getFullUrl(appPortOrUrl, url)\n+  await page.goto(fullUrl, { waitUntil: 'load' })\n+  return {\n+    page,\n+    close: async () => {\n+      await page.close().catch(() => {})\n+      await context.close().catch(() => {})\n+      await browser.close().catch(() => {})\n+    },\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 945,
        "additions": 867,
        "deletions": 78
    }
}