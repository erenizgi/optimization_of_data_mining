{
    "author": "eps1lon",
    "message": "Dim console logs from prospective prerender in dev (#81515)",
    "sha": "a7a42b389d5568fb699a5533e129a5b43d2174f4",
    "files": [
        {
            "sha": "086114f949b14e6dd498245872a09c86fe437b6d",
            "filename": "packages/next/src/server/node-environment-extensions/console-dev.tsx",
            "status": "added",
            "additions": 163,
            "deletions": 0,
            "changes": 163,
            "blob_url": "https://github.com/vercel/next.js/blob/a7a42b389d5568fb699a5533e129a5b43d2174f4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a7a42b389d5568fb699a5533e129a5b43d2174f4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx?ref=a7a42b389d5568fb699a5533e129a5b43d2174f4",
            "patch": "@@ -0,0 +1,163 @@\n+import { dim } from '../../lib/picocolors'\n+import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n+\n+type InterceptableConsoleMethod =\n+  | 'error'\n+  | 'assert'\n+  | 'debug'\n+  | 'dir'\n+  | 'dirxml'\n+  | 'group'\n+  | 'groupCollapsed'\n+  | 'groupEnd'\n+  | 'info'\n+  | 'log'\n+  | 'table'\n+  | 'trace'\n+  | 'warn'\n+\n+// This function could be used from multiple places, including hook.\n+// Skips CSS and object arguments, inlines other in the first argument as a template string\n+/**\n+ * Copyright (c) Meta Platforms, Inc. and affiliates.\n+ *\n+ * This source code is licensed under the MIT license found in the\n+ * LICENSE file in the root directory of this source tree.\n+ *\n+ * @source https://github.com/facebook/react/blob/b44a99bf58d69d52b5288d9eadcc6d226d705e11/packages/react-devtools-shared/src/backend/utils/formatConsoleArguments.js#L14\n+ */\n+function formatConsoleArguments(maybeMessage: any, ...inputArgs: any[]): any[] {\n+  if (inputArgs.length === 0 || typeof maybeMessage !== 'string') {\n+    return [maybeMessage, ...inputArgs]\n+  }\n+\n+  const args = inputArgs.slice()\n+\n+  let template = ''\n+  let argumentsPointer = 0\n+  for (let i = 0; i < maybeMessage.length; ++i) {\n+    const currentChar = maybeMessage[i]\n+    if (currentChar !== '%') {\n+      template += currentChar\n+      continue\n+    }\n+\n+    const nextChar = maybeMessage[i + 1]\n+    ++i\n+\n+    // Only keep CSS and objects, inline other arguments\n+    switch (nextChar) {\n+      case 'c':\n+      case 'O':\n+      case 'o': {\n+        ++argumentsPointer\n+        template += `%${nextChar}`\n+\n+        break\n+      }\n+      case 'd':\n+      case 'i': {\n+        const [arg] = args.splice(argumentsPointer, 1)\n+        template += parseInt(arg, 10).toString()\n+\n+        break\n+      }\n+      case 'f': {\n+        const [arg] = args.splice(argumentsPointer, 1)\n+        template += parseFloat(arg).toString()\n+\n+        break\n+      }\n+      case 's': {\n+        const [arg] = args.splice(argumentsPointer, 1)\n+        template += String(arg)\n+\n+        break\n+      }\n+\n+      default:\n+        template += `%${nextChar}`\n+    }\n+  }\n+\n+  return [template, ...args]\n+}\n+\n+const isColorSupported = dim('test') !== 'test'\n+// TODO: Breaks when complex objects are logged\n+// dim(\"%s\") does not work in Chrome\n+const ANSI_STYLE_DIMMING_TEMPLATE = isColorSupported\n+  ? '\\x1b[2;38;2;124;124;124m%s\\x1b[0m'\n+  : '%s'\n+\n+function dimConsoleCall(\n+  methodName: InterceptableConsoleMethod,\n+  args: any[]\n+): any[] {\n+  switch (methodName) {\n+    case 'dir':\n+    case 'dirxml':\n+    case 'groupEnd':\n+    case 'table': {\n+      // These methods cannot be colorized because they don't take a formatting string.\n+      return args\n+    }\n+    case 'assert': {\n+      // assert takes formatting options as the second argument.\n+      return [args[0]].concat(\n+        ANSI_STYLE_DIMMING_TEMPLATE,\n+        ...formatConsoleArguments(args[1], ...args.slice(2))\n+      )\n+    }\n+    default:\n+      return [ANSI_STYLE_DIMMING_TEMPLATE].concat(\n+        ...formatConsoleArguments(args[0], ...args.slice(1))\n+      )\n+  }\n+}\n+\n+// Based on https://github.com/facebook/react/blob/28dc0776be2e1370fe217549d32aee2519f0cf05/packages/react-server/src/ReactFlightServer.js#L248\n+function patchConsoleMethodDEV(methodName: InterceptableConsoleMethod): void {\n+  const descriptor = Object.getOwnPropertyDescriptor(console, methodName)\n+  if (\n+    descriptor &&\n+    (descriptor.configurable || descriptor.writable) &&\n+    typeof descriptor.value === 'function'\n+  ) {\n+    const originalMethod = descriptor.value\n+    const originalName = Object.getOwnPropertyDescriptor(originalMethod, 'name')\n+    const wrapperMethod = function (this: typeof console, ...args: any[]) {\n+      const workUnitStore = workUnitAsyncStorage.getStore()\n+      const isPrerenderValidation =\n+        workUnitStore !== undefined &&\n+        (workUnitStore.type === 'prerender-client' ||\n+          workUnitStore.type === 'prerender')\n+\n+      if (isPrerenderValidation) {\n+        originalMethod.apply(this, dimConsoleCall(methodName, args))\n+      } else {\n+        originalMethod.apply(this, args)\n+      }\n+    }\n+    if (originalName) {\n+      Object.defineProperty(wrapperMethod, 'name', originalName)\n+    }\n+    Object.defineProperty(console, methodName, {\n+      value: wrapperMethod,\n+    })\n+  }\n+}\n+\n+patchConsoleMethodDEV('error')\n+patchConsoleMethodDEV('assert')\n+patchConsoleMethodDEV('debug')\n+patchConsoleMethodDEV('dir')\n+patchConsoleMethodDEV('dirxml')\n+patchConsoleMethodDEV('group')\n+patchConsoleMethodDEV('groupCollapsed')\n+patchConsoleMethodDEV('groupEnd')\n+patchConsoleMethodDEV('info')\n+patchConsoleMethodDEV('log')\n+patchConsoleMethodDEV('table')\n+patchConsoleMethodDEV('trace')\n+patchConsoleMethodDEV('warn')"
        },
        {
            "sha": "4026475d595c822fb0a6bb26037c7c3b8cd34f66",
            "filename": "packages/next/src/server/node-environment.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a7a42b389d5568fb699a5533e129a5b43d2174f4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7a42b389d5568fb699a5533e129a5b43d2174f4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment.ts?ref=a7a42b389d5568fb699a5533e129a5b43d2174f4",
            "patch": "@@ -9,3 +9,7 @@ import './node-environment-extensions/random'\n import './node-environment-extensions/date'\n import './node-environment-extensions/web-crypto'\n import './node-environment-extensions/node-crypto'\n+\n+if (process.env.NODE_ENV === 'development') {\n+  require('./node-environment-extensions/console-dev') as typeof import('./node-environment-extensions/console-dev')\n+}"
        },
        {
            "sha": "2e55265c403defab0e313d2fb5876f7c874fa02d",
            "filename": "test/e2e/app-dir/dynamic-io/app/console/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/a7a42b389d5568fb699a5533e129a5b43d2174f4/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fconsole%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a7a42b389d5568fb699a5533e129a5b43d2174f4/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fconsole%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fapp%2Fconsole%2Fpage.tsx?ref=a7a42b389d5568fb699a5533e129a5b43d2174f4",
            "patch": "@@ -0,0 +1,13 @@\n+export default function ConsolePage() {\n+  console.info('/console: template(one: %s, two: %s)', 'one', 'two')\n+  console.log('/console: This is a console page')\n+  console.warn('/console: not a template', { foo: 'just-some-object' })\n+  console.error(new Error('/console: test'))\n+  console.assert(\n+    false,\n+    '/console: This is an assert message with a %s',\n+    'template'\n+  )\n+  console.assert(true, '/console: This is an assert message without a template')\n+  return null\n+}"
        },
        {
            "sha": "f50e14ce39a4d525619df269d1bc2bad3dbcc479",
            "filename": "test/e2e/app-dir/dynamic-io/dynamic-io.console.test.ts",
            "status": "added",
            "additions": 100,
            "deletions": 0,
            "changes": 100,
            "blob_url": "https://github.com/vercel/next.js/blob/a7a42b389d5568fb699a5533e129a5b43d2174f4/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fdynamic-io.console.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7a42b389d5568fb699a5533e129a5b43d2174f4/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fdynamic-io.console.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io%2Fdynamic-io.console.test.ts?ref=a7a42b389d5568fb699a5533e129a5b43d2174f4",
            "patch": "@@ -0,0 +1,100 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n+import stripAnsi from 'strip-ansi'\n+\n+describe('dynamic-io', () => {\n+  const { isNextDev, isTurbopack, next, skipped } = nextTestSetup({\n+    env: {\n+      FORCE_COLOR: '1',\n+    },\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('dims console calls during prospective rendering', async () => {\n+    const browser = await next.browser('/console', {})\n+\n+    if (isNextDev) {\n+      await retry(() => {\n+        expect(stripAnsi(next.cliOutput)).toContain('GET /console 200')\n+      })\n+\n+      // do not strip ANSI codes here since we're explicitly testing coloring.\n+      const cliOutputFromPage = next.cliOutput.match(\n+        /Compiled \\/console[^\\n]+\\n(.*)\\n GET \\/console /s\n+      )[1]\n+\n+      expect(cliOutputFromPage).toMatchInlineSnapshot(`\n+       \"/console: template(one: one, two: two)\n+       /console: This is a console page\n+       /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Error: /console: test\n+           at ConsolePage (app/console/page.tsx:5:16)\n+       \u001b[0m \u001b[90m 3 |\u001b[39m   console\u001b[33m.\u001b[39mlog(\u001b[32m'/console: This is a console page'\u001b[39m)\n+        \u001b[90m 4 |\u001b[39m   console\u001b[33m.\u001b[39mwarn(\u001b[32m'/console: not a template'\u001b[39m\u001b[33m,\u001b[39m { foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m })\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 5 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m'/console: test'\u001b[39m))\n+        \u001b[90m   |\u001b[39m                \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 6 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 7 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+        \u001b[90m 8 |\u001b[39m     \u001b[32m'/console: This is an assert message with a %s'\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+       Assertion failed: /console: This is an assert message with a template\n+       \u001b[2;38;2;124;124;124m/console: template(one: one, two: two)\u001b[0m\n+       \u001b[2;38;2;124;124;124m/console: This is a console page\u001b[0m\n+       \u001b[2;38;2;124;124;124m/console: not a template\u001b[0m { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       \u001b[2;38;2;124;124;124mError: /console: test\n+           at ConsolePage (app/console/page.tsx:5:16)\n+         3 |   console.log('/console: This is a console page')\n+         4 |   console.warn('/console: not a template', { foo: 'just-some-object' })\n+       > 5 |   console.error(new Error('/console: test'))\n+           |                ^\n+         6 |   console.assert(\n+         7 |     false,\n+         8 |     '/console: This is an assert message with a %s',\u001b[0m\n+       \u001b[2;38;2;124;124;124mAssertion failed: \u001b[2;38;2;124;124;124m/console: This is an assert message with a template\u001b[0m\u001b[0m\n+       \u001b[2;38;2;124;124;124m/console: template(one: one, two: two)\u001b[0m\n+       \u001b[2;38;2;124;124;124m/console: This is a console page\u001b[0m\n+       \u001b[2;38;2;124;124;124m/console: not a template\u001b[0m { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       \u001b[2;38;2;124;124;124mError: /console: test\n+           at ConsolePage (app/console/page.tsx:5:16)\n+         3 |   console.log('/console: This is a console page')\n+         4 |   console.warn('/console: not a template', { foo: 'just-some-object' })\n+       > 5 |   console.error(new Error('/console: test'))\n+           |                ^\n+         6 |   console.assert(\n+         7 |     false,\n+         8 |     '/console: This is an assert message with a %s',\u001b[0m\n+       \u001b[2;38;2;124;124;124mAssertion failed: \u001b[2;38;2;124;124;124m/console: This is an assert message with a template\u001b[0m\u001b[0m\"\n+      `)\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"description\": \"/console: test\",\n+         \"environmentLabel\": \"Prerender\",\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/console/page.tsx (5:17) @ ConsolePage\n+       > 5 |   console.error(new Error('/console: test'))\n+           |                 ^\",\n+         \"stack\": [\n+           \"ConsolePage app/console/page.tsx (5:17)\",\n+           \"ConsolePage <anonymous>\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      // prewarm + render\n+      // Neither is dimmed in production\n+      const pageInvocations = Array.from(\n+        next.cliOutput.matchAll(/\\/console: This is a console page/g)\n+      )\n+      expect(pageInvocations).toHaveLength(\n+        isTurbopack\n+          ? // TODO: Why?\n+            4\n+          : 2\n+      )\n+    }\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 280,
        "additions": 280,
        "deletions": 0
    }
}