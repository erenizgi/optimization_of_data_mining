{
    "author": "wyattjoh",
    "message": "fix: remove boundary sentinel from RSC responses (#81857)\n\n## Summary\n\nThis PR fixes an issue where the test mode boundary sentinel was being\nincorrectly added to RSC (React Server Component) responses. The\nsentinel should only be added to HTML responses during PPR (Partial\nPrerendering) test mode.\n\n## Changes\n\n- Added check to prevent boundary sentinel insertion when the response\nis an RSC content type\n- Added check to prevent boundary sentinel insertion when the request is\nan RSC request\n- Correctly set the response type to 'rsc' instead of 'html' for RSC\nrequests\n\n## Test plan\n\n- [x] Existing tests should pass\n- [x] RSC responses should not contain the test mode boundary sentinel\n- [x] HTML responses in PPR test mode should still contain the boundary\nsentinel as expected",
    "sha": "5fbf29ca10480f509a0e0ac61e5206947d3e088a",
    "files": [
        {
            "sha": "49dc627d05a61767ac1f9f1fcad612a4f59d8c9a",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/5fbf29ca10480f509a0e0ac61e5206947d3e088a/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5fbf29ca10480f509a0e0ac61e5206947d3e088a/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=5fbf29ca10480f509a0e0ac61e5206947d3e088a",
            "patch": "@@ -32,6 +32,7 @@ import {\n   NEXT_ROUTER_PREFETCH_HEADER,\n   NEXT_IS_PRERENDER_HEADER,\n   NEXT_DID_POSTPONE_HEADER,\n+  RSC_CONTENT_TYPE_HEADER,\n } from '../../client/components/app-router-headers'\n import { getBotType, isBot } from '../../shared/lib/router/utils/is-bot'\n import {\n@@ -1074,11 +1075,19 @@ export async function handler(\n       // If there's no postponed state, we should just serve the HTML. This\n       // should also be the case for a resume request because it's completed\n       // as a server render (rather than a static render).\n-      if (!didPostpone || minimalMode) {\n+      if (!didPostpone || minimalMode || isRSCRequest) {\n         // If we're in test mode, we should add a sentinel chunk to the response\n         // that's between the static and dynamic parts so we can compare the\n         // chunks and add assertions.\n-        if (process.env.__NEXT_TEST_MODE && minimalMode && isRoutePPREnabled) {\n+        if (\n+          process.env.__NEXT_TEST_MODE &&\n+          minimalMode &&\n+          isRoutePPREnabled &&\n+          // If the response body is an RSC content type of the request was for\n+          // an RSC request then we shouldn't add the sentinel.\n+          body.contentType !== RSC_CONTENT_TYPE_HEADER &&\n+          !isRSCRequest\n+        ) {\n           // As we're in minimal mode, the static part would have already been\n           // streamed first. The only part that this streams is the dynamic part\n           // so we should FIRST stream the sentinel and THEN the dynamic part.\n@@ -1088,7 +1097,7 @@ export async function handler(\n         return sendRenderResult({\n           req,\n           res,\n-          type: 'html',\n+          type: isRSCRequest ? 'rsc' : 'html',\n           generateEtags: nextConfig.generateEtags,\n           poweredByHeader: nextConfig.poweredByHeader,\n           result: body,"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 12,
        "deletions": 3
    }
}