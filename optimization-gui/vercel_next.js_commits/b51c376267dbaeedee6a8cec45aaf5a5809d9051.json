{
    "author": "mischnic",
    "message": "Turbopack: support more dynamic request with import map (#84178)\n\nAdd support to resolve arbitrarily dynamic requests into a `'@/*\": \"./@\"` import mapping, such as\r\n\r\n```js\r\nimport(`@/styles/themes/theme-${themeName}/theme-${themeName}`)\r\n```\r\n\r\nCloses [#83785](https://github.com/vercel/next.js/issues/83785)\r\nCloses PACK-5451\r\n\r\nThis was basically a regression from #82757",
    "sha": "b51c376267dbaeedee6a8cec45aaf5a5809d9051",
    "files": [
        {
            "sha": "b346206e57518d4afcd61f4d4b5ed6a6d813e8b0",
            "filename": "turbopack/crates/turbopack-core/src/resolve/alias_map.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/b51c376267dbaeedee6a8cec45aaf5a5809d9051/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Falias_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b51c376267dbaeedee6a8cec45aaf5a5809d9051/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Falias_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Falias_map.rs?ref=b51c376267dbaeedee6a8cec45aaf5a5809d9051",
            "patch": "@@ -562,6 +562,10 @@ where\n                         }\n                     }\n                     AliasKey::Wildcard { suffix } => {\n+                        // This is quite messy as we'd have to match against the FS to do this\n+                        // properly. For now, try to support as many cases as possible (and as are\n+                        // actually used).\n+\n                         let is_match = if let Some(request) = self.request.as_constant_string() {\n                             // The request is a constant string, so the PatriciaMap lookup already\n                             // ensured that the prefix is matching the request.\n@@ -587,9 +591,16 @@ where\n                             ] = req.as_slice()\n                         {\n                             req_prefix.starts_with(&**prefix) && req_suffix.ends_with(&**suffix)\n+                        } else if !self.request.could_match(prefix) {\n+                            // There's no way it could match if the prefix can't match.\n+                            false\n+                        } else if suffix.is_empty() {\n+                            // Prefix matches the request, and suffix is empty.\n+                            true\n                         } else {\n+                            // It may or may not match, throw an error.\n                             return Some(Err(anyhow::anyhow!(\n-                                \"complex patterns into wildcard exports fields are not \\\n+                                \"Complex patterns into wildcard exports fields are not \\\n                                  implemented yet: {} into '{}*{}'\",\n                                 self.request.describe_as_string(),\n                                 prefix,"
        },
        {
            "sha": "66d887e6489a58764c6698216a4ff9921eb159ba",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/resolving/tsconfig-paths-dynamic/input/index.js",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/b51c376267dbaeedee6a8cec45aaf5a5809d9051/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Ftsconfig-paths-dynamic%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b51c376267dbaeedee6a8cec45aaf5a5809d9051/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Ftsconfig-paths-dynamic%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Ftsconfig-paths-dynamic%2Finput%2Findex.js?ref=b51c376267dbaeedee6a8cec45aaf5a5809d9051",
            "patch": "@@ -1,4 +1,4 @@\n-import { loadSub, /* loadSubNested, */ loadSubFallback } from './src/foo'\n+import { loadSub, loadSubNested, loadSubFallback } from './src/foo'\n \n it('should support dynamic requests with tsconfig.paths', () => {\n   expect(loadSub('file2.js').default).toBe('file2')\n@@ -8,9 +8,9 @@ it('should support dynamic requests with tsconfig.paths and without extension',\n   expect(loadSub('file2').default).toBe('file2')\n })\n \n-// it('should support dynamic requests with tsconfig.paths and multiple dynamic parts', () => {\n-//   expect(loadSubNested('file2').default).toBe('file2')\n-// })\n+it('should support dynamic requests with tsconfig.paths and multiple dynamic parts', () => {\n+  expect(loadSubNested('file2').default).toBe('file2')\n+})\n \n it('should support dynamic requests with tsconfig.paths fallbacks', () => {\n   expect(loadSubFallback('file1').default).toBe('file1')"
        },
        {
            "sha": "12f6d3fb6647bc7be8f5b17cb51b620f530b030f",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/resolving/tsconfig-paths-dynamic/input/src/foo.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/b51c376267dbaeedee6a8cec45aaf5a5809d9051/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Ftsconfig-paths-dynamic%2Finput%2Fsrc%2Ffoo.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b51c376267dbaeedee6a8cec45aaf5a5809d9051/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Ftsconfig-paths-dynamic%2Finput%2Fsrc%2Ffoo.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fresolving%2Ftsconfig-paths-dynamic%2Finput%2Fsrc%2Ffoo.ts?ref=b51c376267dbaeedee6a8cec45aaf5a5809d9051",
            "patch": "@@ -2,10 +2,9 @@ export function loadSub(v: string) {\n   return require(`@/sub/${v}`)\n }\n \n-// TODO not supported\n-// export function loadSubNested(v: string) {\n-//   return require(`@/sub-nested/${v}/${v}.js`)\n-// }\n+export function loadSubNested(v: string) {\n+  return require(`@/sub-nested/${v}/${v}.js`)\n+}\n \n export function loadSubFallback(v: string) {\n   return require(`@sub/${v}`)"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 19,
        "deletions": 9
    }
}