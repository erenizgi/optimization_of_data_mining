{
    "author": "gaojude",
    "message": "Fix: Do not force BLOCKING_STATIC_RENDER for DOM bots (#82427)\n\nThe issue was that DOM bots with PPR-enabled routes were being forced to\nuse BLOCKING_STATIC_RENDER mode, which prevented them from using the\nfallback cache lookup mechanism. This caused them to generate new\ncontent with isRevalidating: true, which blocks postponed data and\ntriggers the Math.random() static generation bailout error.\n\nFor HTML bots, they keep using BLOCKING_STATIC_RENDER because SSG was\nturned off for them and won't see the SSG bailout error. For DOM bots,\nthey should behave like a normal user.\n\nFixes NAR-273",
    "sha": "6797a087e54184b4cbe1b0ce18d3fe64d89e40eb",
    "files": [
        {
            "sha": "9d4a74b86f30dea4789cc502b1bf701420ce4591",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=6797a087e54184b4cbe1b0ce18d3fe64d89e40eb",
            "patch": "@@ -653,11 +653,13 @@ export async function handler(\n         fallbackMode = parseFallbackField(prerenderInfo.fallback)\n       }\n \n-      // When serving a bot request, we want to serve a blocking render and not\n-      // the prerendered page. This ensures that the correct content is served\n+      // When serving a HTML bot request, we want to serve a blocking render and\n+      // not the prerendered page. This ensures that the correct content is served\n       // to the bot in the head.\n       if (fallbackMode === FallbackMode.PRERENDER && isBot(userAgent)) {\n-        fallbackMode = FallbackMode.BLOCKING_STATIC_RENDER\n+        if (!isRoutePPREnabled || isHtmlBot) {\n+          fallbackMode = FallbackMode.BLOCKING_STATIC_RENDER\n+        }\n       }\n \n       if (previousCacheEntry?.isStale === -1) {"
        },
        {
            "sha": "178f3c205c4783d2b8d9066a082066ffa00a5dae",
            "filename": "test/e2e/app-dir/cache-components-bot-ua/app/[slug]/page.tsx",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fapp%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fapp%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fapp%2F%5Bslug%5D%2Fpage.tsx?ref=6797a087e54184b4cbe1b0ce18d3fe64d89e40eb",
            "patch": "@@ -0,0 +1,29 @@\n+import React from 'react'\n+\n+import type { Metadata } from 'next'\n+\n+export async function generateMetadata(): Promise<Metadata> {\n+  await new Promise((resolve) => setTimeout(resolve, 1000)) // Simulate a delay\n+  return {\n+    title: 'Home',\n+    description: 'Welcome to the home page',\n+  }\n+}\n+\n+export default async function Home({\n+  params,\n+}: {\n+  params: Promise<{ slug: string }>\n+}) {\n+  const { slug } = await params\n+  // Math.random() will cause SSG_BAILOUT if static generation runs\n+  // Bots should bypass static generation in PPR to avoid this error\n+  const randomValue = Math.random()\n+\n+  return (\n+    <>\n+      <h1>{slug}</h1>\n+      <p>{randomValue}</p>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "ce84d225964bac0c4ad3120bb3706f6c2786de14",
            "filename": "test/e2e/app-dir/cache-components-bot-ua/app/layout.tsx",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fapp%2Flayout.tsx?ref=6797a087e54184b4cbe1b0ce18d3fe64d89e40eb",
            "patch": "@@ -0,0 +1,22 @@\n+import React, { Suspense } from 'react'\n+import type { Metadata } from 'next'\n+\n+export const metadata: Metadata = {\n+  title: 'PPR Bot SSG Bypass Test',\n+  description:\n+    'Test bot static generation bypass with PPR and cache components',\n+}\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>\n+        <Suspense>{children}</Suspense>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "1da9c7eb0f850904e480c3b45d0b554de073770c",
            "filename": "test/e2e/app-dir/cache-components-bot-ua/cache-components-bot-ua.test.ts",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fcache-components-bot-ua.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fcache-components-bot-ua.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fcache-components-bot-ua.test.ts?ref=6797a087e54184b4cbe1b0ce18d3fe64d89e40eb",
            "patch": "@@ -0,0 +1,32 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('cache-components PPR bot static generation bypass', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should bypass static generation for DOM bot requests to avoid SSG_BAILOUT', async () => {\n+    const res = await next.fetch('/foo', {\n+      headers: {\n+        'user-agent': 'Googlebot',\n+      },\n+    })\n+    // With cache components + PPR enabled, DOM bots should behave like regular users\n+    // and use the fallback cache mechanism. This allows them to handle dynamic content\n+    // like Math.random() without triggering SSG_BAILOUT errors.\n+    expect(res.status).toBe(200)\n+\n+    // Verify that the response contains the page content\n+    const html = await res.text()\n+\n+    // Check that the page rendered successfully\n+    // With PPR, content is streamed via script tags\n+    expect(html).toContain('\\\\\"children\\\\\":\\\\\"foo\\\\\"')\n+\n+    // Verify Math.random() was executed (check for a decimal number in the streamed content)\n+    expect(html).toMatch(/\\\\\"children\\\\\":0\\.\\d+/)\n+\n+    // With PPR, content is streamed, but the important thing is that\n+    // the page rendered without a 500 error\n+  })\n+})"
        },
        {
            "sha": "dac4e8aecf44a3d300f83e147b62c69ffcbf3726",
            "filename": "test/e2e/app-dir/cache-components-bot-ua/next.config.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6797a087e54184b4cbe1b0ce18d3fe64d89e40eb/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-bot-ua%2Fnext.config.js?ref=6797a087e54184b4cbe1b0ce18d3fe64d89e40eb",
            "patch": "@@ -0,0 +1,8 @@\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  experimental: {\n+    cacheComponents: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 96,
        "deletions": 3
    }
}