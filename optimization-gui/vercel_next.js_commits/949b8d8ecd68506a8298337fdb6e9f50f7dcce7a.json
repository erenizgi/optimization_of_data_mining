{
    "author": "kdy1",
    "message": "refactor(turbopack): Simplify `minify()` (#76139)\n\n### What?\n\nSimplify `minify()` of turbopack. `swc::Compiler` is not required for the minification, considering that we are not using the minification API of it.\n\n### Why?\n\nIt has some tiny overheads, and it disturbs future refactoring for source maps.",
    "sha": "949b8d8ecd68506a8298337fdb6e9f50f7dcce7a",
    "files": [
        {
            "sha": "3a2f4318237fe3fc5ee79c2ed5954fc5628c0844",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 39,
            "deletions": 42,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/949b8d8ecd68506a8298337fdb6e9f50f7dcce7a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/949b8d8ecd68506a8298337fdb6e9f50f7dcce7a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=949b8d8ecd68506a8298337fdb6e9f50f7dcce7a",
            "patch": "@@ -2,7 +2,7 @@ use std::{io::Write, sync::Arc};\n \n use anyhow::{bail, Context, Result};\n use swc_core::{\n-    base::{try_with_handler, Compiler},\n+    base::try_with_handler,\n     common::{\n         comments::{Comments, SingleThreadedComments},\n         BytePos, FileName, FilePathMapping, LineCol, Mark, SourceMap as SwcSourceMap, GLOBALS,\n@@ -41,8 +41,7 @@ pub async fn minify(\n \n     let cm = Arc::new(SwcSourceMap::new(FilePathMapping::empty()));\n     let (src, mut src_map_buf) = {\n-        let compiler = Arc::new(Compiler::new(cm.clone()));\n-        let fm = compiler.cm.new_source_file(\n+        let fm = cm.new_source_file(\n             FileName::Custom(path.path.to_string()).into(),\n             code.source_code().to_str()?.into_owned(),\n         );\n@@ -71,48 +70,46 @@ pub async fn minify(\n                 let unresolved_mark = Mark::new();\n                 let top_level_mark = Mark::new();\n \n-                Ok(compiler.run_transform(handler, false, || {\n-                    let program = program.apply(paren_remover(Some(&comments)));\n-\n-                    let mut program = program.apply(swc_core::ecma::transforms::base::resolver(\n-                        unresolved_mark,\n-                        top_level_mark,\n-                        false,\n-                    ));\n-\n-                    program = swc_core::ecma::minifier::optimize(\n-                        program,\n-                        cm.clone(),\n-                        Some(&comments),\n-                        None,\n-                        &MinifyOptions {\n-                            compress: Some(CompressOptions {\n-                                // Only run 2 passes, this is a tradeoff between performance and\n-                                // compression size. Default is 3 passes.\n-                                passes: 2,\n-                                ..Default::default()\n-                            }),\n-                            mangle: if mangle {\n-                                Some(MangleOptions {\n-                                    reserved: vec![\"AbortSignal\".into()],\n-                                    ..Default::default()\n-                                })\n-                            } else {\n-                                None\n-                            },\n+                let program = program.apply(paren_remover(Some(&comments)));\n+\n+                let mut program = program.apply(swc_core::ecma::transforms::base::resolver(\n+                    unresolved_mark,\n+                    top_level_mark,\n+                    false,\n+                ));\n+\n+                program = swc_core::ecma::minifier::optimize(\n+                    program,\n+                    cm.clone(),\n+                    Some(&comments),\n+                    None,\n+                    &MinifyOptions {\n+                        compress: Some(CompressOptions {\n+                            // Only run 2 passes, this is a tradeoff between performance and\n+                            // compression size. Default is 3 passes.\n+                            passes: 2,\n                             ..Default::default()\n+                        }),\n+                        mangle: if mangle {\n+                            Some(MangleOptions {\n+                                reserved: vec![\"AbortSignal\".into()],\n+                                ..Default::default()\n+                            })\n+                        } else {\n+                            None\n                         },\n-                        &ExtraOptions {\n-                            top_level_mark,\n-                            unresolved_mark,\n-                            mangle_name_cache: None,\n-                        },\n-                    );\n+                        ..Default::default()\n+                    },\n+                    &ExtraOptions {\n+                        top_level_mark,\n+                        unresolved_mark,\n+                        mangle_name_cache: None,\n+                    },\n+                );\n \n-                    program.apply(ecma::transforms::base::fixer::fixer(Some(\n-                        &comments as &dyn Comments,\n-                    )))\n-                }))\n+                Ok(program.apply(ecma::transforms::base::fixer::fixer(Some(\n+                    &comments as &dyn Comments,\n+                ))))\n             })\n         })?;\n "
        }
    ],
    "stats": {
        "total": 81,
        "additions": 39,
        "deletions": 42
    }
}