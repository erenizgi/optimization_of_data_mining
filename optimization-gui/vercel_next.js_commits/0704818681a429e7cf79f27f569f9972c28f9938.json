{
    "author": "raunofreiberg",
    "message": "[dev-overlay] Ignore animations on page load (#76834)\n\nThe current animation strategy for our Dev Tools surface does not work. \n\n\n\nhttps://github.com/user-attachments/assets/a0ca5459-9d5a-4d90-af00-b071d43581e0\n\nOn page load, several animations can be observed:\n- Width growth from `0` → `auto`\n- Issue count translates and fades, along with the plural `s` suffix\n- A subtle scale bounce effect plays\n\nAll these animations are state transitions, and thus we should ignore\nthem completely on page load or on high-frequency updates where\nanimating is undesirable, e.g. sometimes `issueCount` will receive\nupdates faster than the animation can run.\n\nThis PR implements checks to guard the animations from being executed on\npage load, _and only_ during state transitions.\n\nTo review, it is worth checking out the\n[/animation-test](https://github.com/vercel/next.js/blob/a6e6fe635b712020d4ea2d027040d838eb5941c6/test/development/app-dir/hydration-error-count/app/animation-test/page.tsx)\nfixture I've set up in this PR.\n\nAfter these changes, the experience is as follows—no animations on page\nload, but only on subsequent low-frequency updates (count change, or\ncollapse of the surface):\n\n\n\nhttps://github.com/user-attachments/assets/7b2d5e0d-64ec-4165-b5e2-85489bd00a2c\n\n\n\n_Note: I am not using Storybook for a page load reference, the apps\nunder `test/development/app-dir/*` are more reliable._",
    "sha": "0704818681a429e7cf79f27f569f9972c28f9938",
    "files": [
        {
            "sha": "b7678699839ea21bb63a45bc3a622891fda5ad5d",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/dev-tools-indicator.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0704818681a429e7cf79f27f569f9972c28f9938/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0704818681a429e7cf79f27f569f9972c28f9938/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdev-tools-indicator.tsx?ref=0704818681a429e7cf79f27f569f9972c28f9938",
            "patch": "@@ -269,7 +269,7 @@ function DevToolsPopover({\n           // Reset the toast component's default positions.\n           bottom: 'initial',\n           left: 'initial',\n-          [vertical]: '10px',\n+          [vertical]: '20px',\n           [horizontal]: '20px',\n         } as CSSProperties\n       }"
        },
        {
            "sha": "2e351f33a466ac93580e1736334fde46fe8b432b",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/errors/dev-tools-indicator/next-logo.tsx",
            "status": "modified",
            "additions": 69,
            "deletions": 58,
            "changes": 127,
            "blob_url": "https://github.com/vercel/next.js/blob/0704818681a429e7cf79f27f569f9972c28f9938/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fnext-logo.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0704818681a429e7cf79f27f569f9972c28f9938/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fnext-logo.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fnext-logo.tsx?ref=0704818681a429e7cf79f27f569f9972c28f9938",
            "patch": "@@ -1,4 +1,4 @@\n-import { forwardRef, useEffect, useRef, useState } from 'react'\n+import { forwardRef, useEffect, useMemo, useRef, useState } from 'react'\n import { css } from '../../../../utils/css'\n import mergeRefs from '../../../utils/merge-refs'\n import { useMinimumLoadingTimeMultiple } from './use-minimum-loading-time-multiple'\n@@ -16,48 +16,6 @@ const SIZE = '2.25rem' // 36px in 16px base\n const SIZE_PX = 36\n const SHORT_DURATION_MS = 150\n \n-/**\n- * A hook that creates an animated state based on changes to a dependency.\n- * When the dependency changes and passes the shouldSkip check, it triggers\n- * an animation state that lasts for the specified duration.\n- *\n- * @param dep The dependency to watch for changes\n- * @param config Configuration object containing:\n- *               - shouldSkip: Function to determine if animation should be skipped\n- *               - animationDuration: Duration of the animation in milliseconds\n- * @returns Boolean indicating if animation is currently active\n- */\n-const useAnimated = <T,>(\n-  dep: T,\n-  config: { shouldSkip: (dep: T) => boolean; animationDuration: number }\n-) => {\n-  const { shouldSkip: _shouldSkip, animationDuration } = config\n-  const shouldSkipRef = useRef(_shouldSkip) // ensure stable reference in case it's not\n-\n-  const [animatedDep, setAnimatedDep] = useState(false)\n-  const isInitialRef = useRef(true)\n-\n-  useEffect(() => {\n-    if (isInitialRef.current) {\n-      isInitialRef.current = false\n-      return\n-    }\n-\n-    if (shouldSkipRef.current(dep)) {\n-      return\n-    }\n-\n-    setAnimatedDep(true)\n-    const timeoutId = setTimeout(() => {\n-      setAnimatedDep(false)\n-    }, animationDuration)\n-\n-    return () => clearTimeout(timeoutId)\n-  }, [dep, animationDuration])\n-\n-  return animatedDep\n-}\n-\n export const NextLogo = forwardRef(function NextLogo(\n   {\n     disabled,\n@@ -73,26 +31,32 @@ export const NextLogo = forwardRef(function NextLogo(\n ) {\n   const hasError = issueCount > 0\n   const [isErrorExpanded, setIsErrorExpanded] = useState(hasError)\n-  const newErrorDetected = useAnimated(issueCount, {\n-    shouldSkip: (count) => count === 0,\n-    animationDuration: SHORT_DURATION_MS,\n-  })\n   const [dismissed, setDismissed] = useState(false)\n+  const newErrorDetected = useUpdateAnimation(issueCount, SHORT_DURATION_MS)\n \n   const triggerRef = useRef<HTMLButtonElement | null>(null)\n   const ref = useRef<HTMLDivElement | null>(null)\n-  const width = useMeasureWidth(ref)\n+  const [measuredWidth, pristine] = useMeasureWidth(ref)\n \n   const isLoading = useMinimumLoadingTimeMultiple(\n     isDevBuilding || isDevRendering\n   )\n+  const isExpanded = isErrorExpanded || disabled\n+\n+  const style = useMemo(() => {\n+    let width: number | string = SIZE\n+    // Animates the badge, if expanded\n+    if (measuredWidth > SIZE_PX) width = measuredWidth\n+    // No animations on page load, assume the intrinsic width immediately\n+    if (pristine && hasError) width = 'auto'\n+    // Default state, collapsed\n+    return { width }\n+  }, [measuredWidth, pristine, hasError])\n \n   useEffect(() => {\n     setIsErrorExpanded(hasError)\n   }, [hasError])\n \n-  const isExpanded = isErrorExpanded || disabled\n-\n   return (\n     <div\n       data-next-badge-root\n@@ -332,7 +296,9 @@ export const NextLogo = forwardRef(function NextLogo(\n \n           [data-issues-count-plural] {\n             display: inline-block;\n-            animation: fadeIn 300ms var(--timing) forwards;\n+            &[data-animate='true'] {\n+              animation: fadeIn 300ms var(--timing) forwards;\n+            }\n           }\n \n           .path0 {\n@@ -426,9 +392,7 @@ export const NextLogo = forwardRef(function NextLogo(\n         data-error={hasError}\n         data-error-expanded={isExpanded}\n         data-animate={newErrorDetected}\n-        style={{\n-          width: hasError && width > SIZE_PX ? width : SIZE,\n-        }}\n+        style={style}\n       >\n         <div ref={ref}>\n           {/* Children */}\n@@ -466,7 +430,13 @@ export const NextLogo = forwardRef(function NextLogo(\n                 <div>\n                   Issue\n                   {issueCount > 1 && (\n-                    <span aria-hidden data-issues-count-plural>\n+                    <span\n+                      aria-hidden\n+                      data-issues-count-plural\n+                      // This only needs to animate once the count changes from 1 -> 2,\n+                      // otherwise it should stay static between re-renders.\n+                      data-animate={newErrorDetected && issueCount === 2}\n+                    >\n                       s\n                     </span>\n                   )}\n@@ -518,8 +488,11 @@ function AnimateCount({\n   )\n }\n \n-function useMeasureWidth(ref: React.RefObject<HTMLDivElement | null>) {\n+function useMeasureWidth(\n+  ref: React.RefObject<HTMLDivElement | null>\n+): [number, boolean] {\n   const [width, setWidth] = useState<number>(0)\n+  const [pristine, setPristine] = useState(true)\n \n   useEffect(() => {\n     const el = ref.current\n@@ -530,14 +503,52 @@ function useMeasureWidth(ref: React.RefObject<HTMLDivElement | null>) {\n \n     const observer = new ResizeObserver(() => {\n       const { width: w } = el.getBoundingClientRect()\n-      setWidth(w)\n+      setWidth((prevWidth) => {\n+        if (prevWidth !== 0) {\n+          setPristine(false)\n+        }\n+        return w\n+      })\n     })\n \n     observer.observe(el)\n     return () => observer.disconnect()\n   }, [ref])\n \n-  return width\n+  return [width, pristine]\n+}\n+\n+function useUpdateAnimation(issueCount: number, animationDurationMs = 0) {\n+  const lastUpdatedTimeStamp = useRef<number | null>(null)\n+  const [animate, setAnimate] = useState(false)\n+\n+  useEffect(() => {\n+    if (issueCount > 0) {\n+      const deltaMs = lastUpdatedTimeStamp.current\n+        ? Date.now() - lastUpdatedTimeStamp.current\n+        : -1\n+      lastUpdatedTimeStamp.current = Date.now()\n+\n+      // We don't animate if `issueCount` changes too quickly\n+      if (deltaMs <= animationDurationMs) {\n+        return\n+      }\n+\n+      setAnimate(true)\n+      // It is important to use a CSS transitioned state, not a CSS keyframed animation\n+      // because if the issue count increases faster than the animation duration, it\n+      // will abruptly stop and not transition smoothly back to its original state.\n+      const timeoutId = window.setTimeout(() => {\n+        setAnimate(false)\n+      }, animationDurationMs)\n+\n+      return () => {\n+        clearTimeout(timeoutId)\n+      }\n+    }\n+  }, [issueCount, animationDurationMs])\n+\n+  return animate\n }\n \n function NextMark({"
        },
        {
            "sha": "2264577bc290e52ce8fa728e11dd541599f725ec",
            "filename": "test/development/app-dir/hydration-error-count/app/animation-test/page.tsx",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/0704818681a429e7cf79f27f569f9972c28f9938/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fapp%2Fanimation-test%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0704818681a429e7cf79f27f569f9972c28f9938/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fapp%2Fanimation-test%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fapp%2Fanimation-test%2Fpage.tsx?ref=0704818681a429e7cf79f27f569f9972c28f9938",
            "patch": "@@ -0,0 +1,35 @@\n+'use client'\n+\n+import { useEffect } from 'react'\n+\n+/**\n+ * This page is to verify that the Dev Tools surface animates as expected and without jank:\n+ *\n+ * 1. When the page loads with \"1 Issue\" present,\n+ *    no animations should trigger (count change, width growth, etc.).\n+ *    The surface should assume its intrinsic position immediately,\n+ *    while still animating when collapsed from (×).\n+ *\n+ * 2. When multiple errors come in with little delay inbetween them,\n+ *    the count _should not_ animate when it changes because it will\n+ *    look janky when the `deltaMs` between changes is less than the `animationDurationMs`.\n+ *\n+ * 3. When another error comes in, and `deltaMs` is greater, the surface should\n+ *    subtly bounce and animate the count.\n+ */\n+\n+// Play with this between `1` and `2`\n+// to make sure the surface doesn't animate the plural form (s)\n+const ERROR_COUNT = 2\n+\n+export default function Page() {\n+  const clx = typeof window === 'undefined' ? 'server' : 'client'\n+\n+  useEffect(() => {\n+    setTimeout(() => {\n+      throw new Error('runtime error')\n+    }, 2000)\n+  }, [])\n+\n+  return <p className={clx}>{ERROR_COUNT >= 2 && <p>hey</p>}</p>\n+}"
        }
    ],
    "stats": {
        "total": 164,
        "additions": 105,
        "deletions": 59
    }
}