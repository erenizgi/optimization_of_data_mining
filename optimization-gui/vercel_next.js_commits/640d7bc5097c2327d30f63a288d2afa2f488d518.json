{
    "author": "mischnic",
    "message": "Turbopack: add manual worker count override (#84454)",
    "sha": "640d7bc5097c2327d30f63a288d2afa2f488d518",
    "files": [
        {
            "sha": "6c145aa2db38d6ad2106abe094505fe431487672",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/640d7bc5097c2327d30f63a288d2afa2f488d518/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/640d7bc5097c2327d30f63a288d2afa2f488d518/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=640d7bc5097c2327d30f63a288d2afa2f488d518",
            "patch": "@@ -254,6 +254,10 @@ inherits = \"release\"\n debug-assertions = true\n overflow-checks = true\n \n+[profile.release-with-debug]\n+inherits = \"release\"\n+debug = true\n+\n [workspace.dependencies]\n # Workspace crates\n next-api = { path = \"crates/next-api\" }"
        },
        {
            "sha": "49fada9a3ff82f679ea3c847b4de490948aaac79",
            "filename": "turbopack/crates/turbopack-cli/benches/small_apps.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/640d7bc5097c2327d30f63a288d2afa2f488d518/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/640d7bc5097c2327d30f63a288d2afa2f488d518/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs?ref=640d7bc5097c2327d30f63a288d2afa2f488d518",
            "patch": "@@ -74,6 +74,7 @@ fn bench_small_apps(c: &mut Criterion) {\n                                 log_detail: false,\n                                 full_stats: false,\n                                 target: None,\n+                                worker_threads: None,\n                             },\n                             no_sourcemap: false,\n                             no_minify: false,"
        },
        {
            "sha": "41e5289b9b66d377911bff83e396264b7c47b1de",
            "filename": "turbopack/crates/turbopack-cli/src/arguments.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/640d7bc5097c2327d30f63a288d2afa2f488d518/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/640d7bc5097c2327d30f63a288d2afa2f488d518/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Farguments.rs?ref=640d7bc5097c2327d30f63a288d2afa2f488d518",
            "patch": "@@ -25,6 +25,14 @@ impl Arguments {\n             Arguments::Dev(args) => args.common.dir.as_deref(),\n         }\n     }\n+\n+    /// The number of worker threads to use. see [CommonArguments]::worker_threads\n+    pub fn worker_threads(&self) -> Option<usize> {\n+        match self {\n+            Arguments::Build(args) => args.common.worker_threads,\n+            Arguments::Dev(args) => args.common.worker_threads,\n+        }\n+    }\n }\n \n #[derive(\n@@ -80,13 +88,17 @@ pub struct CommonArguments {\n     #[clap(long)]\n     pub full_stats: bool,\n \n+    /// Whether to build for the `browser` or `node`\n+    #[clap(long)]\n+    pub target: Option<Target>,\n+\n+    /// Number of worker threads to use for parallel processing\n+    #[clap(long)]\n+    pub worker_threads: Option<usize>,\n     // Enable experimental garbage collection with the provided memory limit in\n     // MB.\n     // #[clap(long)]\n     // pub memory_limit: Option<usize>,\n-    /// Whether to build for the `browser` or `node``\n-    #[clap(long)]\n-    pub target: Option<Target>,\n }\n \n #[derive(Debug, Args)]"
        },
        {
            "sha": "5be5135fe3d7a88b36681cedd4f14e5f0645cb48",
            "filename": "turbopack/crates/turbopack-cli/src/main.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/640d7bc5097c2327d30f63a288d2afa2f488d518/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/640d7bc5097c2327d30f63a288d2afa2f488d518/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs?ref=640d7bc5097c2327d30f63a288d2afa2f488d518",
            "patch": "@@ -42,15 +42,25 @@ fn main() {\n             });\n         });\n \n-    let worker_threads = available_parallelism().map(|n| n.get()).unwrap_or(1);\n+    let args = Arguments::parse();\n+\n+    let worker_threads = args\n+        .worker_threads()\n+        .map(|v| {\n+            if v == 0 {\n+                panic!(\"--worker-threads=0 is invalid, you must use at least one thread.\");\n+            } else {\n+                v\n+            }\n+        })\n+        .unwrap_or_else(|| available_parallelism().map(|n| n.get()).unwrap_or(1));\n \n     rt.worker_threads(worker_threads);\n     rt.max_blocking_threads(usize::MAX - worker_threads);\n \n     #[cfg(not(codspeed))]\n     rt.disable_lifo_slot();\n \n-    let args = Arguments::parse();\n     rt.build().unwrap().block_on(main_inner(args)).unwrap();\n }\n "
        }
    ],
    "stats": {
        "total": 37,
        "additions": 32,
        "deletions": 5
    }
}