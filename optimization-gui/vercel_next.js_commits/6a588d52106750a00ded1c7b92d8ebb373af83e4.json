{
    "author": "acdlite",
    "message": "[Link] Add prefetch=\"auto\" option (#78689)\n\nAdds a \"auto\" as a valid value for the `<Link>` component's prefetch\nprop. It acts as an alias for the default behavior, i.e. same as no\nprefetch prop at all.\n\n---\n\nA common source of confusion is the difference between `<Link>`, `<Link\nprefetch={null}>`, and `<Link prefetch={boolean}>`:\n\n- `prefetch={true}` → dynamically prefetch the whole page\n- `prefetch={false}` → disable prefetching entirely\n- no prop, `prefetch={null}`, `prefetch={undefined}` → default behavior\n\nIf you want to conditionally opt into dynamic prefetching, you have to\nwrite something like this:\n\n```\n<Link prefetch={shouldDynamicallyPrefetch ? true : null}>\n```\n\nAfter this PR, you can do this instead:\n\n```\n<Link prefetch={shouldDynamicallyPrefetch ? true : 'auto'}>\n```\n\nIt's still a bit confusing if you aren't aware of the subtleties of\ndynamic versus static prefetching, but at least the \"auto\" string gives\nslightly more of a hint that `true` is different from the default.\n\n(In retrospect, we probably should have made `true` an alias for the\ndefault, and chosen a separate value to opt into dynamic.)",
    "sha": "6a588d52106750a00ded1c7b92d8ebb373af83e4",
    "files": [
        {
            "sha": "53ce891df1e1cd135080bc24e62aff00cb21b5c6",
            "filename": "packages/next/src/client/app-dir/link.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -133,7 +133,7 @@ type InternalLinkProps = {\n    * Prefetching is only enabled in production.\n    *\n    * - In the **App Router**:\n-   *   - `null` (default): Prefetch behavior depends on static vs dynamic routes:\n+   *   - `\"auto\"`, `null`, `undefined` (default): Prefetch behavior depends on static vs dynamic routes:\n    *     - Static routes: fully prefetched\n    *     - Dynamic routes: partial prefetch to the nearest segment with a `loading.js`\n    *   - `true`: Always prefetch the full route and data.\n@@ -151,7 +151,7 @@ type InternalLinkProps = {\n    * </Link>\n    * ```\n    */\n-  prefetch?: boolean | null\n+  prefetch?: boolean | 'auto' | null\n \n   /**\n    * (unstable) Switch to a dynamic prefetch on hover. Effectively the same as\n@@ -366,7 +366,9 @@ export default function LinkComponent(\n    * - 'unstable_dynamicOnHover': this starts in \"auto\" mode, but switches to \"full\" when the link is hovered\n    */\n   const appPrefetchKind =\n-    prefetchProp === null ? PrefetchKind.AUTO : PrefetchKind.FULL\n+    prefetchProp === null || prefetchProp === 'auto'\n+      ? PrefetchKind.AUTO\n+      : PrefetchKind.FULL\n \n   if (process.env.NODE_ENV !== 'production') {\n     function createPropError(args: {"
        },
        {
            "sha": "51528bbc27e9eba19d49d513b9eec83e28740bb1",
            "filename": "packages/next/src/client/form-shared.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/packages%2Fnext%2Fsrc%2Fclient%2Fform-shared.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/packages%2Fnext%2Fsrc%2Fclient%2Fform-shared.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fform-shared.tsx?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -19,7 +19,7 @@ type InternalFormProps = {\n    * Prefetch can be disabled by passing `prefetch={false}`. Prefetching is only enabled in production.\n    *\n    * Options:\n-   * - `null` (default): For statically generated pages, this will prefetch the full React Server Component data. For dynamic pages, this will prefetch up to the nearest route segment with a [`loading.js`](https://nextjs.org/docs/app/api-reference/file-conventions/loading) file. If there is no loading file, it will not fetch the full tree to avoid fetching too much data.\n+   * - \"auto\", null, undefined (default): For statically generated pages, this will prefetch the full React Server Component data. For dynamic pages, this will prefetch up to the nearest route segment with a [`loading.js`](https://nextjs.org/docs/app/api-reference/file-conventions/loading) file. If there is no loading file, it will not fetch the full tree to avoid fetching too much data.\n    * - `false`: This will not prefetch any data.\n    *\n    * In pages dir, prefetching is not supported, and passing this prop will emit a warning."
        },
        {
            "sha": "5b58d5bcabed2faa1034ea9c7a953d25b7c4eefc",
            "filename": "packages/next/src/client/link.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Flink.tsx?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -73,7 +73,7 @@ type InternalLinkProps = {\n    * Prefetch can be disabled by passing `prefetch={false}`. Prefetching is only enabled in production.\n    *\n    * In App Router:\n-   * - `null` (default): For statically generated pages, this will prefetch the full React Server Component data. For dynamic pages, this will prefetch up to the nearest route segment with a [`loading.js`](https://nextjs.org/docs/app/api-reference/file-conventions/loading) file. If there is no loading file, it will not fetch the full tree to avoid fetching too much data.\n+   * - \"auto\", null, undefined (default): For statically generated pages, this will prefetch the full React Server Component data. For dynamic pages, this will prefetch up to the nearest route segment with a [`loading.js`](https://nextjs.org/docs/app/api-reference/file-conventions/loading) file. If there is no loading file, it will not fetch the full tree to avoid fetching too much data.\n    * - `true`: This will prefetch the full React Server Component data for all route segments, regardless of whether they contain a segment with `loading.js`.\n    * - `false`: This will not prefetch any data, even on hover.\n    *\n@@ -82,7 +82,7 @@ type InternalLinkProps = {\n    * - `false`: Prefetching will not happen when entering the viewport, but will still happen on hover.\n    * @defaultValue `true` (pages router) or `null` (app router)\n    */\n-  prefetch?: boolean | null\n+  prefetch?: boolean | 'auto' | null\n   /**\n    * The active locale is automatically prepended. `locale` allows for providing a different locale.\n    * When `false` `href` has to include the locale as the default behavior is disabled."
        },
        {
            "sha": "d28ada742ee643dd43164ed28fe85983a6a1a255",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-auto/app/dynamic/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fdynamic%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fdynamic%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fdynamic%2Floading.tsx?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Loading() {\n+  return <div id=\"loading-boundary\">Loading...</div>\n+}"
        },
        {
            "sha": "7fe377c43113d1a6e16b9045fa8c5daf56a823cd",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-auto/app/dynamic/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fdynamic%2Fpage.tsx?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -0,0 +1,6 @@\n+import { connection } from 'next/server'\n+\n+export default async function Page() {\n+  await connection()\n+  return <div id=\"dynamic-content\">Dynamic content</div>\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-auto/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Flayout.tsx?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "c8dfd431a605adcad193f96ec650a63f992b0df2",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-auto/app/page.tsx",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fapp%2Fpage.tsx?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -0,0 +1,20 @@\n+import { LinkAccordion } from '../components/link-accordion'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page is used to test that prefetch=\"auto\" uses the default\n+        prefetching strategy (the same as if no prefetch prop is given).\n+      </p>\n+\n+      <LinkAccordion\n+        // @ts-expect-error: \"auto\" not yet part of public types\n+        prefetch=\"auto\"\n+        href=\"/dynamic\"\n+      >\n+        Dynamic page with loading boundary\n+      </LinkAccordion>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "4b253eab3adf36164d260dbafc6e89286719e164",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-auto/components/link-accordion.tsx",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fcomponents%2Flink-accordion.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fcomponents%2Flink-accordion.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fcomponents%2Flink-accordion.tsx?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -0,0 +1,23 @@\n+'use client'\n+\n+import Link from 'next/link'\n+import { useState } from 'react'\n+\n+export function LinkAccordion({ href, children }) {\n+  const [isVisible, setIsVisible] = useState(false)\n+  return (\n+    <>\n+      <input\n+        type=\"checkbox\"\n+        checked={isVisible}\n+        onChange={() => setIsVisible(!isVisible)}\n+        data-link-accordion={href}\n+      />\n+      {isVisible ? (\n+        <Link href={href}>{children}</Link>\n+      ) : (\n+        `${children} (link is hidden)`\n+      )}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "16e8384b655b41d459538177fb044f20d21e4696",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-auto/next.config.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fnext.config.js?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    ppr: true,\n+    dynamicIO: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "12b0c02cef438733742e3fb28a2b58dc103bac14",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-auto/prefetch-auto.test.ts",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fprefetch-auto.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6a588d52106750a00ded1c7b92d8ebb373af83e4/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fprefetch-auto.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-auto%2Fprefetch-auto.test.ts?ref=6a588d52106750a00ded1c7b92d8ebb373af83e4",
            "patch": "@@ -0,0 +1,59 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import type * as Playwright from 'playwright'\n+import { createRouterAct } from '../router-act'\n+\n+describe('<Link prefetch=\"auto\">', () => {\n+  const { next, isNextDev, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+  if (isNextDev || skipped) {\n+    it('disabled in development / deployment', () => {})\n+    return\n+  }\n+\n+  // NOTE: Since \"auto\" is just an alias for the default, I'm not bothering to\n+  // write tests for every default prefetching behavior; that's covered by a\n+  // bunch of other test suites. This is just a quick test to confirm that the\n+  // alias exists.\n+\n+  it('<Link prefetch=\"auto\"> works the same as if prefetch were undefined or null', async () => {\n+    // Test that the link only prefetches the static part of the target page\n+    let page: Playwright.Page\n+    const browser = await next.browser('/', {\n+      beforePageLoad(p: Playwright.Page) {\n+        page = p\n+      },\n+    })\n+    const act = createRouterAct(page)\n+\n+    // Reveal the link to trigger a prefetch\n+    await act(async () => {\n+      const linkToggle = await browser.elementByCss(\n+        'input[data-link-accordion=\"/dynamic\"]'\n+      )\n+      await linkToggle.click()\n+    }, [\n+      // Should prefetch the loading boundary\n+      {\n+        includes: 'Loading...',\n+      },\n+      // Should not prefetch the dynamic content\n+      {\n+        includes: 'Dynamic content',\n+        block: 'reject',\n+      },\n+    ])\n+\n+    // Navigate to the page\n+    await act(\n+      async () => {\n+        await browser.elementByCss('a[href=\"/dynamic\"]').click()\n+      },\n+      {\n+        // Now the dynamic content should be fetched\n+        includes: 'Dynamic content',\n+      }\n+    )\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 147,
        "additions": 141,
        "deletions": 6
    }
}