{
    "author": "kdy1",
    "message": "chore(ci): Make turbopack benchmark less flaky (#79980)\n\n### What?\n\nUse mimalloc in the benchmark.\n\n### Why?\n\nI know it's a bit ridiculous, but using mimalloc stabilizes the benchmark. At least, it was the case for SWC.",
    "sha": "48e53d7dbd9216f44c0965e6ed1f334cc9adb41a",
    "files": [
        {
            "sha": "c1752fb101e8aa4dd52d3f7e3532a288a9896950",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/48e53d7dbd9216f44c0965e6ed1f334cc9adb41a/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/48e53d7dbd9216f44c0965e6ed1f334cc9adb41a/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=48e53d7dbd9216f44c0965e6ed1f334cc9adb41a",
            "patch": "@@ -10157,6 +10157,7 @@ dependencies = [\n  \"turbo-tasks-build\",\n  \"turbo-tasks-fs\",\n  \"turbo-tasks-hash\",\n+ \"turbo-tasks-malloc\",\n  \"turbo-tasks-testing\",\n  \"turbopack-core\",\n  \"turbopack-resolve\","
        },
        {
            "sha": "c6f1a4c85cc8ec0112c28e22d552b0e1dea199cb",
            "filename": "turbopack/crates/turbopack-cli/benches/small_apps.rs",
            "status": "modified",
            "additions": 40,
            "deletions": 35,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/48e53d7dbd9216f44c0965e6ed1f334cc9adb41a/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/48e53d7dbd9216f44c0965e6ed1f334cc9adb41a/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fbenches%2Fsmall_apps.rs?ref=48e53d7dbd9216f44c0965e6ed1f334cc9adb41a",
            "patch": "@@ -1,11 +1,13 @@\n #![cfg_attr(not(codspeed), allow(unused))]\n \n+extern crate turbo_tasks_malloc;\n+\n use std::{\n     path::{Path, PathBuf},\n     process::Command,\n };\n \n-use criterion::{Criterion, criterion_group, criterion_main};\n+use criterion::{BenchmarkId, Criterion, criterion_group, criterion_main};\n use turbopack_cli::{\n     arguments::{BuildArguments, CommonArguments},\n     register,\n@@ -47,44 +49,47 @@ fn bench_small_apps(c: &mut Criterion) {\n     let mut g = c.benchmark_group(\"turbopack/build/apps\");\n \n     for app in apps {\n-        g.bench_function(app.to_string_lossy().to_string(), |b| {\n-            let apps_dir = apps_dir.clone();\n-            let app = app.clone();\n-\n-            b.iter(move || {\n-                let mut rt = tokio::runtime::Builder::new_multi_thread();\n-                rt.enable_all().on_thread_stop(|| {\n-                    TurboMalloc::thread_stop();\n-                });\n-                let rt = rt.build().unwrap();\n-\n+        g.bench_function(\n+            BenchmarkId::new(\"build\", app.file_name().unwrap().to_string_lossy()),\n+            |b| {\n                 let apps_dir = apps_dir.clone();\n                 let app = app.clone();\n \n-                let app_name = app.file_name().unwrap().to_string_lossy().to_string();\n-\n-                rt.block_on(async move {\n-                    //\n-                    turbopack_cli::build::build(&BuildArguments {\n-                        common: CommonArguments {\n-                            entries: Some(vec![format!(\"{app_name}/index.tsx\")]),\n-                            dir: Some(app.clone()),\n-                            root: Some(apps_dir),\n-                            log_level: None,\n-                            show_all: false,\n-                            log_detail: false,\n-                            full_stats: false,\n-                            target: None,\n-                        },\n-                        no_sourcemap: false,\n-                        no_minify: false,\n-                        force_memory_cleanup: true,\n+                b.iter(move || {\n+                    let mut rt = tokio::runtime::Builder::new_multi_thread();\n+                    rt.enable_all().on_thread_stop(|| {\n+                        TurboMalloc::thread_stop();\n+                    });\n+                    let rt = rt.build().unwrap();\n+\n+                    let apps_dir = apps_dir.clone();\n+                    let app = app.clone();\n+\n+                    let app_name = app.file_name().unwrap().to_string_lossy().to_string();\n+\n+                    rt.block_on(async move {\n+                        //\n+                        turbopack_cli::build::build(&BuildArguments {\n+                            common: CommonArguments {\n+                                entries: Some(vec![format!(\"{app_name}/index.tsx\")]),\n+                                dir: Some(app.clone()),\n+                                root: Some(apps_dir),\n+                                log_level: None,\n+                                show_all: false,\n+                                log_detail: false,\n+                                full_stats: false,\n+                                target: None,\n+                            },\n+                            no_sourcemap: false,\n+                            no_minify: false,\n+                            force_memory_cleanup: true,\n+                        })\n+                        .await\n                     })\n-                    .await\n-                })\n-                .unwrap();\n-            });\n-        });\n+                    .unwrap();\n+                });\n+            },\n+        );\n     }\n }\n "
        },
        {
            "sha": "2d3c638eca5ea7759cdaf3ea1006c20263dcc7c0",
            "filename": "turbopack/crates/turbopack-ecmascript/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/48e53d7dbd9216f44c0965e6ed1f334cc9adb41a/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/48e53d7dbd9216f44c0965e6ed1f334cc9adb41a/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml?ref=48e53d7dbd9216f44c0965e6ed1f334cc9adb41a",
            "patch": "@@ -77,6 +77,7 @@ par-core = { workspace = true, features = [\"rayon\"] }\n [dev-dependencies]\n criterion = { workspace = true, features = [\"async_tokio\"] }\n turbo-tasks-backend = { workspace = true }\n+turbo-tasks-malloc = { workspace = true }\n turbo-tasks-testing = { workspace = true }\n \n [build-dependencies]"
        },
        {
            "sha": "2bf28c7d42472f69d111eeedc108f7775cac8f81",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/48e53d7dbd9216f44c0965e6ed1f334cc9adb41a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/48e53d7dbd9216f44c0965e6ed1f334cc9adb41a/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Fmod.rs?ref=48e53d7dbd9216f44c0965e6ed1f334cc9adb41a",
            "patch": "@@ -1,3 +1,5 @@\n+extern crate turbo_tasks_malloc;\n+\n use criterion::{criterion_group, criterion_main};\n \n mod analyzer;"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 44,
        "deletions": 35
    }
}