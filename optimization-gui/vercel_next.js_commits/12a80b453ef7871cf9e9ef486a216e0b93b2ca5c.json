{
    "author": "styfle",
    "message": "fix(next/image): add `?dpl` query string for local images (without static import) (#86485)\n\nIn a previous PR https://github.com/vercel/next.js/pull/73184 the `?dpl`\nquery string was added to local images from static imports but not to\nimages without the static import.\n\nThis was a subtle change based on malte's PR review comment here:\nhttps://github.com/vercel/next.js/pull/73184#issuecomment-2499126751\n\nHowever, I can't think of reason why we should differentiate these two\nsince they are both related to the current deployment (as opposed to\nremote images which live outside the deployment).\n\nFurthermore, this string matching is causing microfrontends to fail to\nadd the `?dpl` because they have a path prefix and thus fail skew\nprotection.\n\nSo this PR fixes both problems by loosening the string matching to look\nfor src images that start with `/`.",
    "sha": "12a80b453ef7871cf9e9ef486a216e0b93b2ca5c",
    "files": [
        {
            "sha": "e821edca2428c23b83bdc6f5d3fcc735a18bfb80",
            "filename": "packages/next/src/shared/lib/get-img-props.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/12a80b453ef7871cf9e9ef486a216e0b93b2ca5c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/12a80b453ef7871cf9e9ef486a216e0b93b2ca5c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts?ref=12a80b453ef7871cf9e9ef486a216e0b93b2ca5c",
            "patch": "@@ -1,4 +1,5 @@\n import { warnOnce } from './utils/warn-once'\n+import { getDeploymentId } from './deployment-id'\n import { getImageBlurSvg } from './image-blur-svg'\n import { imageConfigDefault } from './image-config'\n import type {\n@@ -230,6 +231,11 @@ function generateImgAttrs({\n   loader,\n }: GenImgAttrsData): GenImgAttrsResult {\n   if (unoptimized) {\n+    const deploymentId = getDeploymentId()\n+    if (src.startsWith('/') && deploymentId) {\n+      const sep = src.includes('?') ? '&' : '?'\n+      src = `${src}${sep}dpl=${deploymentId}`\n+    }\n     return { src, srcSet: undefined, sizes: undefined }\n   }\n "
        },
        {
            "sha": "7731934c685de1101a3e965462acc4a5e32e917f",
            "filename": "packages/next/src/shared/lib/image-loader.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/12a80b453ef7871cf9e9ef486a216e0b93b2ca5c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/12a80b453ef7871cf9e9ef486a216e0b93b2ca5c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts?ref=12a80b453ef7871cf9e9ef486a216e0b93b2ca5c",
            "patch": "@@ -97,9 +97,7 @@ function defaultLoader({\n \n   let deploymentId = getDeploymentId()\n   return `${config.path}?url=${encodeURIComponent(src)}&w=${width}&q=${q}${\n-    src.startsWith('/_next/static/media/') && deploymentId\n-      ? `&dpl=${deploymentId}`\n-      : ''\n+    src.startsWith('/') && deploymentId ? `&dpl=${deploymentId}` : ''\n   }`\n }\n "
        },
        {
            "sha": "c9df4cb90dd411e6d38b6750b36391bdd421b098",
            "filename": "test/unit/next-image-get-img-props.test.ts",
            "status": "modified",
            "additions": 102,
            "deletions": 3,
            "changes": 105,
            "blob_url": "https://github.com/vercel/next.js/blob/12a80b453ef7871cf9e9ef486a216e0b93b2ca5c/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/12a80b453ef7871cf9e9ef486a216e0b93b2ca5c/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fnext-image-get-img-props.test.ts?ref=12a80b453ef7871cf9e9ef486a216e0b93b2ca5c",
            "patch": "@@ -640,7 +640,37 @@ describe('getImageProps()', () => {\n       delete process.env.NEXT_DEPLOYMENT_ID\n     }\n   })\n-  it('should not add query string for relative local image when NEXT_DEPLOYMENT_ID defined', async () => {\n+  it('should add query string for imported local image from microfrontend when NEXT_DEPLOYMENT_ID defined', async () => {\n+    try {\n+      process.env.NEXT_DEPLOYMENT_ID = 'dpl_123'\n+      const { props } = getImageProps({\n+        alt: 'a nice desc',\n+        src: '/microfrontend/_next/static/media/test.abc123.png', // simulating microfrontend path\n+        width: 100,\n+        height: 200,\n+      })\n+      expect(warningMessages).toStrictEqual([])\n+      expect(Object.entries(props)).toStrictEqual([\n+        ['alt', 'a nice desc'],\n+        ['loading', 'lazy'],\n+        ['width', 100],\n+        ['height', 200],\n+        ['decoding', 'async'],\n+        ['style', { color: 'transparent' }],\n+        [\n+          'srcSet',\n+          '/_next/image?url=%2Fmicrofrontend%2F_next%2Fstatic%2Fmedia%2Ftest.abc123.png&w=128&q=75&dpl=dpl_123 1x, /_next/image?url=%2Fmicrofrontend%2F_next%2Fstatic%2Fmedia%2Ftest.abc123.png&w=256&q=75&dpl=dpl_123 2x',\n+        ],\n+        [\n+          'src',\n+          '/_next/image?url=%2Fmicrofrontend%2F_next%2Fstatic%2Fmedia%2Ftest.abc123.png&w=256&q=75&dpl=dpl_123',\n+        ],\n+      ])\n+    } finally {\n+      delete process.env.NEXT_DEPLOYMENT_ID\n+    }\n+  })\n+  it('should add query string for relative local image when NEXT_DEPLOYMENT_ID defined', async () => {\n     try {\n       process.env.NEXT_DEPLOYMENT_ID = 'dpl_123'\n       const { props } = getImageProps({\n@@ -659,9 +689,9 @@ describe('getImageProps()', () => {\n         ['style', { color: 'transparent' }],\n         [\n           'srcSet',\n-          '/_next/image?url=%2Ftest.png&w=128&q=75 1x, /_next/image?url=%2Ftest.png&w=256&q=75 2x',\n+          '/_next/image?url=%2Ftest.png&w=128&q=75&dpl=dpl_123 1x, /_next/image?url=%2Ftest.png&w=256&q=75&dpl=dpl_123 2x',\n         ],\n-        ['src', '/_next/image?url=%2Ftest.png&w=256&q=75'],\n+        ['src', '/_next/image?url=%2Ftest.png&w=256&q=75&dpl=dpl_123'],\n       ])\n     } finally {\n       delete process.env.NEXT_DEPLOYMENT_ID\n@@ -697,4 +727,73 @@ describe('getImageProps()', () => {\n       delete process.env.NEXT_DEPLOYMENT_ID\n     }\n   })\n+  it('should add query string with question mark for unoptimized relative svg when NEXT_DEPLOYMENT_ID defined', async () => {\n+    try {\n+      process.env.NEXT_DEPLOYMENT_ID = 'dpl_123'\n+      const { props } = getImageProps({\n+        alt: 'a nice desc',\n+        src: '/test.svg',\n+        width: 100,\n+        height: 200,\n+      })\n+      expect(warningMessages).toStrictEqual([])\n+      expect(Object.entries(props)).toStrictEqual([\n+        ['alt', 'a nice desc'],\n+        ['loading', 'lazy'],\n+        ['width', 100],\n+        ['height', 200],\n+        ['decoding', 'async'],\n+        ['style', { color: 'transparent' }],\n+        ['src', '/test.svg?dpl=dpl_123'],\n+      ])\n+    } finally {\n+      delete process.env.NEXT_DEPLOYMENT_ID\n+    }\n+  })\n+  it('should add query string with ampersand for unoptimized relative svg when NEXT_DEPLOYMENT_ID defined', async () => {\n+    try {\n+      process.env.NEXT_DEPLOYMENT_ID = 'dpl_123'\n+      const { props } = getImageProps({\n+        alt: 'a nice desc',\n+        src: '/test.svg?v=1',\n+        width: 100,\n+        height: 200,\n+      })\n+      expect(warningMessages).toStrictEqual([])\n+      expect(Object.entries(props)).toStrictEqual([\n+        ['alt', 'a nice desc'],\n+        ['loading', 'lazy'],\n+        ['width', 100],\n+        ['height', 200],\n+        ['decoding', 'async'],\n+        ['style', { color: 'transparent' }],\n+        ['src', '/test.svg?v=1&dpl=dpl_123'],\n+      ])\n+    } finally {\n+      delete process.env.NEXT_DEPLOYMENT_ID\n+    }\n+  })\n+  it('should not add query string for unoptimized absolute remote svg when NEXT_DEPLOYMENT_ID defined', async () => {\n+    try {\n+      process.env.NEXT_DEPLOYMENT_ID = 'dpl_123'\n+      const { props } = getImageProps({\n+        alt: 'a nice desc',\n+        src: 'http://example.com/test.svg',\n+        width: 100,\n+        height: 200,\n+      })\n+      expect(warningMessages).toStrictEqual([])\n+      expect(Object.entries(props)).toStrictEqual([\n+        ['alt', 'a nice desc'],\n+        ['loading', 'lazy'],\n+        ['width', 100],\n+        ['height', 200],\n+        ['decoding', 'async'],\n+        ['style', { color: 'transparent' }],\n+        ['src', 'http://example.com/test.svg'],\n+      ])\n+    } finally {\n+      delete process.env.NEXT_DEPLOYMENT_ID\n+    }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 115,
        "additions": 109,
        "deletions": 6
    }
}