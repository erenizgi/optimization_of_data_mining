{
    "author": "xusd320",
    "message": "feat(turbopack): add resolve plugin condition variant of Always and Never (#88190)\n\nThis PR refactors the Resolution Plugin traits to add new `Always` or\n`Never` enum variants to `resolve condition`. This allow plugins (like\n[ExternalsPlugin](https://github.com/utooland/utoo/pull/2494) when no\nexternals are configured) to skip the expensive `matches()` task calls\nentirely. Testing on a medium project showed a reduction of ~1.4k\n`resolve_call` tasks. I think this can be shared to upstream for future\nimprovement of `resolve plugin`\n\nSee the metrics for improvements.\n<img width=\"1400\" height=\"600\" alt=\"image\"\nsrc=\"https://github.com/user-attachments/assets/06eae96e-070a-43c3-9f68-a3a27ee7dc0d\"\n/>\n\n---------\n\nCo-authored-by: Niklas Mischkulnig <4586894+mischnic@users.noreply.github.com>",
    "sha": "d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803",
    "files": [
        {
            "sha": "c9cd4cc0c2830de32477c13165190a75a002a269",
            "filename": "crates/next-core/src/next_server/resolve.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs?ref=d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803",
            "patch": "@@ -65,7 +65,7 @@ impl ExternalCjsModulesResolvePlugin {\n \n #[turbo_tasks::function]\n fn condition(root: FileSystemPath) -> Vc<AfterResolvePluginCondition> {\n-    AfterResolvePluginCondition::new(\n+    AfterResolvePluginCondition::new_with_glob(\n         root,\n         Glob::new(rcstr!(\"**/node_modules/**\"), GlobOptions::default()),\n     )"
        },
        {
            "sha": "3f1f2d89fa446a83ac215cbe310ae419397cecc8",
            "filename": "crates/next-core/src/next_shared/resolve.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fresolve.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fresolve.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fresolve.rs?ref=d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803",
            "patch": "@@ -224,7 +224,7 @@ impl NextExternalResolvePlugin {\n impl AfterResolvePlugin for NextExternalResolvePlugin {\n     #[turbo_tasks::function]\n     async fn after_resolve_condition(&self) -> Result<Vc<AfterResolvePluginCondition>> {\n-        Ok(AfterResolvePluginCondition::new(\n+        Ok(AfterResolvePluginCondition::new_with_glob(\n             self.project_path.root().owned().await?,\n             Glob::new(\n                 rcstr!(\"**/next/dist/**/*.{external,runtime.dev,runtime.prod}.js\"),\n@@ -282,7 +282,7 @@ impl NextNodeSharedRuntimeResolvePlugin {\n impl AfterResolvePlugin for NextNodeSharedRuntimeResolvePlugin {\n     #[turbo_tasks::function]\n     async fn after_resolve_condition(&self) -> Result<Vc<AfterResolvePluginCondition>> {\n-        Ok(AfterResolvePluginCondition::new(\n+        Ok(AfterResolvePluginCondition::new_with_glob(\n             self.root.root().owned().await?,\n             Glob::new(\n                 rcstr!(\"**/next/dist/**/*.shared-runtime.js\"),\n@@ -410,7 +410,7 @@ impl NextSharedRuntimeResolvePlugin {\n impl AfterResolvePlugin for NextSharedRuntimeResolvePlugin {\n     #[turbo_tasks::function]\n     async fn after_resolve_condition(&self) -> Result<Vc<AfterResolvePluginCondition>> {\n-        Ok(AfterResolvePluginCondition::new(\n+        Ok(AfterResolvePluginCondition::new_with_glob(\n             self.root.root().owned().await?,\n             Glob::new(\n                 rcstr!(\"**/next/dist/esm/**/*.shared-runtime.js\"),"
        },
        {
            "sha": "1b1e7f7774d5243bf6dae2525af2c349f845532c",
            "filename": "turbopack/crates/turbopack-core/src/resolve/plugin.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 16,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fplugin.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fplugin.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fplugin.rs?ref=d1f8a3bc3f6a63c7e253e3287d373cae7c4ee803",
            "patch": "@@ -10,41 +10,53 @@ use crate::{\n };\n \n /// A condition which determines if the hooks of a resolve plugin gets called.\n-#[turbo_tasks::value]\n-pub struct AfterResolvePluginCondition {\n-    root: FileSystemPath,\n-    glob: ResolvedVc<Glob>,\n+#[turbo_tasks::value(shared)]\n+pub enum AfterResolvePluginCondition {\n+    Glob {\n+        root: FileSystemPath,\n+        glob: ResolvedVc<Glob>,\n+    },\n+    Always,\n+    Never,\n }\n \n #[turbo_tasks::value_impl]\n impl AfterResolvePluginCondition {\n     #[turbo_tasks::function]\n-    pub fn new(root: FileSystemPath, glob: ResolvedVc<Glob>) -> Vc<Self> {\n-        AfterResolvePluginCondition { root, glob }.cell()\n+    pub fn new_with_glob(root: FileSystemPath, glob: ResolvedVc<Glob>) -> Vc<Self> {\n+        AfterResolvePluginCondition::Glob { root, glob }.cell()\n     }\n+}\n \n+#[turbo_tasks::value_impl]\n+impl AfterResolvePluginCondition {\n     #[turbo_tasks::function]\n     pub async fn matches(&self, fs_path: FileSystemPath) -> Result<Vc<bool>> {\n-        let root = self.root.clone();\n-        let glob = self.glob.await?;\n+        match self {\n+            AfterResolvePluginCondition::Glob { root, glob } => {\n+                let path = fs_path;\n \n-        let path = fs_path;\n+                if let Some(path) = root.get_path_to(&path)\n+                    && glob.await?.matches(path)\n+                {\n+                    return Ok(Vc::cell(true));\n+                }\n \n-        if let Some(path) = root.get_path_to(&path)\n-            && glob.matches(path)\n-        {\n-            return Ok(Vc::cell(true));\n+                Ok(Vc::cell(false))\n+            }\n+            AfterResolvePluginCondition::Always => Ok(Vc::cell(true)),\n+            AfterResolvePluginCondition::Never => Ok(Vc::cell(false)),\n         }\n-\n-        Ok(Vc::cell(false))\n     }\n }\n \n /// A condition which determines if the hooks of a resolve plugin gets called.\n-#[turbo_tasks::value]\n+#[turbo_tasks::value(shared)]\n pub enum BeforeResolvePluginCondition {\n     Request(ResolvedVc<Glob>),\n     Modules(FxHashSet<RcStr>),\n+    Always,\n+    Never,\n }\n \n #[turbo_tasks::value_impl]\n@@ -76,6 +88,8 @@ impl BeforeResolvePluginCondition {\n                     false\n                 }\n             }\n+            BeforeResolvePluginCondition::Always => true,\n+            BeforeResolvePluginCondition::Never => false,\n         }))\n     }\n }"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 34,
        "deletions": 20
    }
}