{
    "author": "bgw",
    "message": "chore(HMR clients): Clean up tryApplyUpdates, reduce differences between app/pages versions (#77219)\n\nVarious cleanup efforts in `tryApplyUpdates`:\n- Code across pages and app are more similar.\n- Inlined functions that were only called once.\n- Less code overall, less branches.\n- Better type signatures, less usage of `any`.",
    "sha": "026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d",
    "files": [
        {
            "sha": "e071b01a5acfccdf3570b4e16ea40687bb289850",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/hot-reloader-client.tsx",
            "status": "modified",
            "additions": 37,
            "deletions": 70,
            "changes": 107,
            "blob_url": "https://github.com/vercel/next.js/blob/026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx?ref=026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d",
            "patch": "@@ -81,23 +81,6 @@ export function waitForWebpackRuntimeHotUpdate() {\n   return pendingHotUpdateWebpack\n }\n \n-function handleSuccessfulHotUpdateWebpack(\n-  dispatcher: Dispatcher,\n-  sendMessage: (message: string) => void,\n-  updatedModules: ReadonlyArray<string>\n-) {\n-  resolvePendingHotUpdateWebpack()\n-  dispatcher.onBuildOk()\n-  reportHmrLatency(\n-    sendMessage,\n-    updatedModules,\n-    webpackStartMsSinceEpoch!,\n-    Date.now()\n-  )\n-\n-  dispatcher.onRefresh()\n-}\n-\n // There is a newer version of the code available.\n function handleAvailableHash(hash: string) {\n   // Update last known compilation hash.\n@@ -160,10 +143,8 @@ function performFullReload(err: any, sendMessage: any) {\n }\n \n // Attempt to update code on the fly, fall back to a hard reload.\n-function tryApplyUpdates(\n-  onBeforeUpdate: (hasUpdates: boolean) => void,\n-  onHotUpdateSuccess: (updatedModules: string[]) => void,\n-  sendMessage: any,\n+function tryApplyUpdatesWebpack(\n+  sendMessage: (message: string) => void,\n   dispatcher: Dispatcher\n ) {\n   if (!isUpdateAvailable() || !canApplyUpdates()) {\n@@ -173,8 +154,11 @@ function tryApplyUpdates(\n     return\n   }\n \n-  function handleApplyUpdates(err: any, updatedModules: string[] | null) {\n-    if (err || RuntimeErrorHandler.hadRuntimeError || !updatedModules) {\n+  function handleApplyUpdates(\n+    err: any,\n+    updatedModules: (string | number)[] | null\n+  ) {\n+    if (err || RuntimeErrorHandler.hadRuntimeError || updatedModules == null) {\n       if (err) {\n         console.warn(REACT_REFRESH_FULL_RELOAD)\n       } else if (RuntimeErrorHandler.hadRuntimeError) {\n@@ -184,50 +168,50 @@ function tryApplyUpdates(\n       return\n     }\n \n-    const hasUpdates = Boolean(updatedModules.length)\n-    if (typeof onHotUpdateSuccess === 'function') {\n-      // Maybe we want to do something.\n-      onHotUpdateSuccess(updatedModules)\n-    }\n+    dispatcher.onBuildOk()\n \n     if (isUpdateAvailable()) {\n       // While we were updating, there was a new update! Do it again.\n-      tryApplyUpdates(\n-        hasUpdates ? () => {} : onBeforeUpdate,\n-        hasUpdates ? () => dispatcher.onBuildOk() : onHotUpdateSuccess,\n-        sendMessage,\n-        dispatcher\n-      )\n-    } else {\n-      dispatcher.onBuildOk()\n-      if (process.env.__NEXT_TEST_MODE) {\n-        afterApplyUpdates(() => {\n-          if (self.__NEXT_HMR_CB) {\n-            self.__NEXT_HMR_CB()\n-            self.__NEXT_HMR_CB = null\n-          }\n-        })\n-      }\n+      tryApplyUpdatesWebpack(sendMessage, dispatcher)\n+      return\n+    }\n+\n+    dispatcher.onRefresh()\n+    resolvePendingHotUpdateWebpack()\n+    reportHmrLatency(\n+      sendMessage,\n+      updatedModules,\n+      webpackStartMsSinceEpoch!,\n+      Date.now()\n+    )\n+\n+    if (process.env.__NEXT_TEST_MODE) {\n+      afterApplyUpdates(() => {\n+        if (self.__NEXT_HMR_CB) {\n+          self.__NEXT_HMR_CB()\n+          self.__NEXT_HMR_CB = null\n+        }\n+      })\n     }\n   }\n \n   // https://webpack.js.org/api/hot-module-replacement/#check\n   module.hot\n     .check(/* autoApply */ false)\n-    .then((updatedModules: any[] | null) => {\n-      if (!updatedModules) {\n+    .then((updatedModules: (string | number)[] | null) => {\n+      if (updatedModules == null) {\n         return null\n       }\n \n-      if (typeof onBeforeUpdate === 'function') {\n-        const hasUpdates = Boolean(updatedModules.length)\n-        onBeforeUpdate(hasUpdates)\n-      }\n+      // We should always handle an update, even if updatedModules is empty (but\n+      // non-null) for any reason. That's what webpack would normally do:\n+      // https://github.com/webpack/webpack/blob/3aa6b6bc3a64/lib/hmr/HotModuleReplacement.runtime.js#L296-L298\n+      dispatcher.onBeforeRefresh()\n       // https://webpack.js.org/api/hot-module-replacement/#apply\n       return module.hot.apply()\n     })\n     .then(\n-      (updatedModules: any[] | null) => {\n+      (updatedModules: (string | number)[] | null) => {\n         handleApplyUpdates(null, updatedModules)\n       },\n       (err: any) => {\n@@ -236,7 +220,7 @@ function tryApplyUpdates(\n     )\n }\n \n-/** Handles messages from the sevrer for the App Router. */\n+/** Handles messages from the server for the App Router. */\n function processMessage(\n   obj: HMR_ACTION_TYPES,\n   sendMessage: (message: string) => void,\n@@ -288,24 +272,7 @@ function processMessage(\n       }\n       dispatcher.onBuildOk()\n     } else {\n-      tryApplyUpdates(\n-        function onBeforeHotUpdate(hasUpdates: boolean) {\n-          if (hasUpdates) {\n-            dispatcher.onBeforeRefresh()\n-          }\n-        },\n-        function onSuccessfulHotUpdate(webpackUpdatedModules: string[]) {\n-          // Only dismiss it when we're sure it's a hot update.\n-          // Otherwise it would flicker right before the reload.\n-          handleSuccessfulHotUpdateWebpack(\n-            dispatcher,\n-            sendMessage,\n-            webpackUpdatedModules\n-          )\n-        },\n-        sendMessage,\n-        dispatcher\n-      )\n+      tryApplyUpdatesWebpack(sendMessage, dispatcher)\n     }\n   }\n "
        },
        {
            "sha": "2b5d2e333963b74543bec54e6fb2bce7e3c29350",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/hot-reloader-client.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 64,
            "changes": 107,
            "blob_url": "https://github.com/vercel/next.js/blob/026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts?ref=026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d",
            "patch": "@@ -24,6 +24,8 @@\n  * SOFTWARE.\n  */\n \n+/// <reference types=\"webpack/module.d.ts\" />\n+\n // This file is a modified version of the Create React App HMR dev client that\n // can be found here:\n // https://github.com/facebook/create-react-app/blob/v3.4.1/packages/react-dev-utils/webpackHotDevClient.js\n@@ -55,10 +57,8 @@ import {\n } from '../shared'\n import { RuntimeErrorHandler } from '../../errors/runtime-error-handler'\n import reportHmrLatency from '../utils/report-hmr-latency'\n-import {\n-  extractModulesFromTurbopackMessage,\n-  TurbopackHmr,\n-} from '../utils/turbopack-hot-reloader-common'\n+import { TurbopackHmr } from '../utils/turbopack-hot-reloader-common'\n+\n // This alternative WebpackDevServer combines the functionality of:\n // https://github.com/webpack/webpack-dev-server/blob/webpack-1/client/index.js\n // https://github.com/webpack/webpack/blob/webpack-1/hot/dev-server.js\n@@ -149,7 +149,7 @@ function handleSuccess() {\n \n     // Attempt to apply hot updates or reload.\n     if (isHotUpdate) {\n-      tryApplyUpdates(onBeforeFastRefresh, onFastRefresh)\n+      tryApplyUpdatesWebpack()\n     }\n   }\n \n@@ -189,7 +189,7 @@ function handleWarnings(warnings: any) {\n \n   // Attempt to apply hot updates or reload.\n   if (isHotUpdate) {\n-    tryApplyUpdates(onBeforeFastRefresh, onFastRefresh)\n+    tryApplyUpdatesWebpack()\n   }\n }\n \n@@ -233,30 +233,6 @@ const turbopackHmr: TurbopackHmr | null = process.env.TURBOPACK\n   : null\n let isrManifest: Record<string, boolean> = {}\n \n-function onBeforeFastRefresh(updatedModules: string[]) {\n-  if (updatedModules.length > 0) {\n-    // Only trigger a pending state if we have updates to apply\n-    // (cf. onFastRefresh)\n-    onBeforeRefresh()\n-  }\n-}\n-\n-function onFastRefresh(updatedModules: ReadonlyArray<string> = []) {\n-  onBuildOk()\n-  if (updatedModules.length === 0) {\n-    return\n-  }\n-\n-  onRefresh()\n-\n-  reportHmrLatency(\n-    sendMessage,\n-    updatedModules,\n-    webpackStartMsSinceEpoch!,\n-    Date.now()\n-  )\n-}\n-\n // There is a newer version of the code available.\n function handleAvailableHash(hash: string) {\n   // Update last known compilation hash.\n@@ -282,7 +258,7 @@ export function handleStaticIndicator() {\n   }\n }\n \n-/** Handles messages from the sevrer for the Pages Router. */\n+/** Handles messages from the server for the Pages Router. */\n function processMessage(obj: HMR_ACTION_TYPES) {\n   if (!('action' in obj)) {\n     return\n@@ -325,6 +301,7 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n         return handleErrors(errors)\n       }\n \n+      // NOTE: Turbopack does not currently send warnings\n       const hasWarnings = Boolean(warnings && warnings.length)\n       if (hasWarnings) {\n         sendMessage(\n@@ -371,8 +348,7 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n       break\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE: {\n-      const updatedModules = extractModulesFromTurbopackMessage(obj.data)\n-      onBeforeFastRefresh([...updatedModules])\n+      onBeforeRefresh()\n       for (const listener of turbopackMessageListeners) {\n         listener({\n           type: HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE,\n@@ -424,10 +400,7 @@ function afterApplyUpdates(fn: () => void) {\n }\n \n // Attempt to update code on the fly, fall back to a hard reload.\n-function tryApplyUpdates(\n-  onBeforeHotUpdate: ((updatedModules: string[]) => unknown) | undefined,\n-  onHotUpdateSuccess: (updatedModules: string[]) => unknown\n-) {\n+function tryApplyUpdatesWebpack() {\n   if (!module.hot) {\n     // HotModuleReplacementPlugin is not in Webpack configuration.\n     console.error('HotModuleReplacementPlugin is not in Webpack configuration.')\n@@ -440,8 +413,11 @@ function tryApplyUpdates(\n     return\n   }\n \n-  function handleApplyUpdates(err: any, updatedModules: string[] | null) {\n-    if (err || RuntimeErrorHandler.hadRuntimeError || !updatedModules) {\n+  function handleApplyUpdates(\n+    err: any,\n+    updatedModules: (string | number)[] | null\n+  ) {\n+    if (err || RuntimeErrorHandler.hadRuntimeError || updatedModules == null) {\n       if (err) {\n         console.warn(REACT_REFRESH_FULL_RELOAD)\n       } else if (RuntimeErrorHandler.hadRuntimeError) {\n@@ -451,46 +427,49 @@ function tryApplyUpdates(\n       return\n     }\n \n-    if (typeof onHotUpdateSuccess === 'function') {\n-      // Maybe we want to do something.\n-      onHotUpdateSuccess(updatedModules)\n-    }\n+    onBuildOk()\n \n     if (isUpdateAvailable()) {\n       // While we were updating, there was a new update! Do it again.\n-      // However, this time, don't trigger a pending refresh state.\n-      tryApplyUpdates(\n-        updatedModules.length > 0 ? undefined : onBeforeHotUpdate,\n-        updatedModules.length > 0 ? onBuildOk : onHotUpdateSuccess\n-      )\n-    } else {\n-      onBuildOk()\n-      if (process.env.__NEXT_TEST_MODE) {\n-        afterApplyUpdates(() => {\n-          if (self.__NEXT_HMR_CB) {\n-            self.__NEXT_HMR_CB()\n-            self.__NEXT_HMR_CB = null\n-          }\n-        })\n-      }\n+      tryApplyUpdatesWebpack()\n+      return\n+    }\n+\n+    onRefresh()\n+    reportHmrLatency(\n+      sendMessage,\n+      updatedModules,\n+      webpackStartMsSinceEpoch!,\n+      Date.now()\n+    )\n+\n+    if (process.env.__NEXT_TEST_MODE) {\n+      afterApplyUpdates(() => {\n+        if (self.__NEXT_HMR_CB) {\n+          self.__NEXT_HMR_CB()\n+          self.__NEXT_HMR_CB = null\n+        }\n+      })\n     }\n   }\n \n   // https://webpack.js.org/api/hot-module-replacement/#check\n   module.hot\n     .check(/* autoApply */ false)\n-    .then((updatedModules: any) => {\n-      if (!updatedModules) {\n+    .then((updatedModules: (string | number)[] | null) => {\n+      if (updatedModules == null) {\n         return null\n       }\n \n-      if (typeof onBeforeHotUpdate === 'function') {\n-        onBeforeHotUpdate(updatedModules)\n-      }\n+      // We should always handle an update, even if updatedModules is empty (but\n+      // non-null) for any reason. That's what webpack would normally do:\n+      // https://github.com/webpack/webpack/blob/3aa6b6bc3a64/lib/hmr/HotModuleReplacement.runtime.js#L296-L298\n+      onBeforeRefresh()\n+      // https://webpack.js.org/api/hot-module-replacement/#apply\n       return module.hot.apply()\n     })\n     .then(\n-      (updatedModules: any) => {\n+      (updatedModules: (string | number)[] | null) => {\n         handleApplyUpdates(null, updatedModules)\n       },\n       (err: any) => {"
        },
        {
            "sha": "030e1311aa7d4016f20eca671b5f95fdd48cc35a",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/report-hmr-latency.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Freport-hmr-latency.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Freport-hmr-latency.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Freport-hmr-latency.ts?ref=026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d",
            "patch": "@@ -6,7 +6,7 @@ declare global {\n \n export default function reportHmrLatency(\n   sendMessage: (message: string) => void,\n-  updatedModules: ReadonlyArray<string>,\n+  updatedModules: ReadonlyArray<string | number>,\n   startMsSinceEpoch: number,\n   endMsSinceEpoch: number\n ) {"
        },
        {
            "sha": "1aef7fe7cda31158a6cbc1d181e58d09a54758dd",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/turbopack-hot-reloader-common.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts?ref=026445d0e2dfb6d7f0bdd66dab4ccab8dc270a0d",
            "patch": "@@ -48,7 +48,7 @@ export class TurbopackHmr {\n   }\n }\n \n-export function extractModulesFromTurbopackMessage(\n+function extractModulesFromTurbopackMessage(\n   data: TurbopackUpdate | TurbopackUpdate[]\n ): Set<string> {\n   const updatedModules: Set<string> = new Set()"
        }
    ],
    "stats": {
        "total": 218,
        "additions": 82,
        "deletions": 136
    }
}