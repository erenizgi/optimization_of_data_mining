{
    "author": "wbinnssmith",
    "message": "Built-in flight plugin for additional bundler (#76014)\n\nAdds support for a built-in Rspack Flight Client Entry Plugin implementation alongside the existing webpack version.\n\nPorted from https://github.com/vercel/next.js/tree/wbinnssmith/try-ci-test, originally by @hardfist.\n\n- Introduces a new `RspackFlightClientEntryPlugin` class that wraps Rspack's built-in Flight Client Entry Plugin\n- Conditionally uses either the Rspack or webpack implementation based on environment flags",
    "sha": "1405eaf4a5218e708759081993323b4cd05dd609",
    "files": [
        {
            "sha": "880e0e9b35b3df064979c3d673b2b38260993609",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=1405eaf4a5218e708759081993323b4cd05dd609",
            "patch": "@@ -47,7 +47,8 @@ import { WellKnownErrorsPlugin } from './webpack/plugins/wellknown-errors-plugin\n import { regexLikeCss } from './webpack/config/blocks/css'\n import { CopyFilePlugin } from './webpack/plugins/copy-file-plugin'\n import { ClientReferenceManifestPlugin } from './webpack/plugins/flight-manifest-plugin'\n-import { FlightClientEntryPlugin } from './webpack/plugins/flight-client-entry-plugin'\n+import { FlightClientEntryPlugin as NextFlightClientEntryPlugin } from './webpack/plugins/flight-client-entry-plugin'\n+import { RspackFlightClientEntryPlugin } from './webpack/plugins/rspack-flight-client-entry-plugin'\n import { NextTypesPlugin } from './webpack/plugins/next-types-plugin'\n import type {\n   Feature,\n@@ -344,6 +345,11 @@ export default async function getBaseWebpackConfig(\n \n   const isRspack = Boolean(process.env.NEXT_RSPACK)\n \n+  const FlightClientEntryPlugin =\n+    isRspack && process.env.BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN\n+      ? RspackFlightClientEntryPlugin\n+      : NextFlightClientEntryPlugin\n+\n   // If the current compilation is aimed at server-side code instead of client-side code.\n   const isNodeOrEdgeCompilation = isNodeServer || isEdgeServer\n "
        },
        {
            "sha": "2346e14593d0a961bd6200b835f2c2e68430e6c2",
            "filename": "packages/next/src/build/webpack/loaders/next-flight-client-entry-loader.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-client-entry-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-client-entry-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-client-entry-loader.ts?ref=1405eaf4a5218e708759081993323b4cd05dd609",
            "patch": "@@ -64,6 +64,13 @@ export default function transformSource(\n   buildInfo.rsc = {\n     type: RSC_MODULE_TYPES.client,\n   }\n+  if (process.env.BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN) {\n+    const rscModuleInformationJson = JSON.stringify(buildInfo.rsc)\n+    return (\n+      `/* __rspack_internal_rsc_module_information_do_not_use__ ${rscModuleInformationJson} */\\n` +\n+      code\n+    )\n+  }\n \n   return code\n }"
        },
        {
            "sha": "186c68d6ed5a34efca71936a060f80c881ad5ceb",
            "filename": "packages/next/src/build/webpack/loaders/next-flight-client-module-loader.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-client-module-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-client-module-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-client-module-loader.ts?ref=1405eaf4a5218e708759081993323b4cd05dd609",
            "patch": "@@ -15,6 +15,12 @@ const flightClientModuleLoader: webpack.LoaderDefinitionFunction =\n     // Assign the RSC meta information to buildInfo.\n     const buildInfo = getModuleBuildInfo(this._module)\n     buildInfo.rsc = getRSCModuleInformation(source, false)\n+    let prefix = ''\n+    if (process.env.BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN) {\n+      const rscModuleInformationJson = JSON.stringify(buildInfo.rsc)\n+      prefix = `/* __rspack_internal_rsc_module_information_do_not_use__ ${rscModuleInformationJson} */\\n`\n+      source = prefix + source\n+    }\n \n     // This is a server action entry module in the client layer. We need to\n     // create re-exports of \"virtual modules\" to expose the reference IDs to the\n@@ -23,11 +29,14 @@ const flightClientModuleLoader: webpack.LoaderDefinitionFunction =\n     // production mode. In development mode, we want to preserve the original\n     // modules (as transformed by SWC) to ensure that source mapping works.\n     if (buildInfo.rsc.actionIds && process.env.NODE_ENV === 'production') {\n-      return Object.entries(buildInfo.rsc.actionIds)\n-        .map(([id, name]) => {\n-          return `export { ${name} } from 'next-flight-server-reference-proxy-loader?id=${id}&name=${name}!'`\n-        })\n-        .join('\\n')\n+      return (\n+        prefix +\n+        Object.entries(buildInfo.rsc.actionIds)\n+          .map(([id, name]) => {\n+            return `export { ${name} } from 'next-flight-server-reference-proxy-loader?id=${id}&name=${name}!'`\n+          })\n+          .join('\\n')\n+      )\n     }\n \n     return this.callback(null, source, sourceMap)"
        },
        {
            "sha": "e402f884c7778d5b0d819dfdac2a61f4b4bf86dc",
            "filename": "packages/next/src/build/webpack/loaders/next-flight-loader/index.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 4,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Findex.ts?ref=1405eaf4a5218e708759081993323b4cd05dd609",
            "patch": "@@ -60,13 +60,18 @@ export default function transformSource(\n   if (typeof source !== 'string') {\n     throw new Error('Expected source to have been transformed to a string.')\n   }\n-\n   const module = this._module!\n \n   // Assign the RSC meta information to buildInfo.\n   // Exclude next internal files which are not marked as client files\n   const buildInfo = getModuleBuildInfo(module)\n   buildInfo.rsc = getRSCModuleInformation(source, true)\n+  let prefix = ''\n+  if (process.env.BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN) {\n+    const rscModuleInformationJson = JSON.stringify(buildInfo.rsc)\n+    prefix = `/* __rspack_internal_rsc_module_information_do_not_use__ ${rscModuleInformationJson} */\\n`\n+    source = prefix + source\n+  }\n \n   // Resource key is the unique identifier for the resource. When RSC renders\n   // a client module, that key is used to identify that module across all compiler\n@@ -112,7 +117,9 @@ export default function transformSource(\n         return\n       }\n \n-      let esmSource = `\\\n+      let esmSource =\n+        prefix +\n+        `\\\n import { registerClientReference } from \"react-server-dom-webpack/server.edge\";\n `\n       for (const ref of clientRefs) {\n@@ -139,12 +146,13 @@ ${JSON.stringify(ref)},\n \n       return this.callback(null, esmSource, sourceMap)\n     } else if (assumedSourceType === 'commonjs') {\n-      let cjsSource = `\\\n+      let cjsSource =\n+        prefix +\n+        `\\\n const { createProxy } = require(\"${MODULE_PROXY_PATH}\")\n \n module.exports = createProxy(${stringifiedResourceKey})\n `\n-\n       return this.callback(null, cjsSource, sourceMap)\n     }\n   }"
        },
        {
            "sha": "fde47f366b5c0649ac8934036bccfbf6dc1c3545",
            "filename": "packages/next/src/build/webpack/plugins/flight-client-entry-plugin.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 18,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts?ref=1405eaf4a5218e708759081993323b4cd05dd609",
            "patch": "@@ -941,38 +941,55 @@ export class FlightClientEntryPlugin {\n   }\n \n   addEntry(\n-    compilation: any,\n+    compilation: webpack.Compilation,\n     context: string,\n     dependency: webpack.Dependency,\n     options: webpack.EntryOptions\n   ): Promise<any> /* Promise<module> */ {\n     return new Promise((resolve, reject) => {\n-      const entry = compilation.entries.get(options.name)\n-      entry.includeDependencies.push(dependency)\n-      compilation.hooks.addEntry.call(entry, options)\n-      compilation.addModuleTree(\n-        {\n-          context,\n-          dependency,\n-          contextInfo: { issuerLayer: options.layer },\n-        },\n-        (err: Error | undefined, module: any) => {\n+      if ('rspack' in compilation.compiler) {\n+        compilation.addInclude(context, dependency, options, (err, module) => {\n           if (err) {\n-            compilation.hooks.failedEntry.call(dependency, options, err)\n             return reject(err)\n           }\n \n-          compilation.hooks.succeedEntry.call(dependency, options, module)\n-\n           compilation.moduleGraph\n-            .getExportsInfo(module)\n+            .getExportsInfo(module!)\n             .setUsedInUnknownWay(\n               this.isEdgeServer ? EDGE_RUNTIME_WEBPACK : DEFAULT_RUNTIME_WEBPACK\n             )\n-\n           return resolve(module)\n-        }\n-      )\n+        })\n+      } else {\n+        const entry = compilation.entries.get(options.name!)!\n+        entry.includeDependencies.push(dependency)\n+        compilation.hooks.addEntry.call(entry as any, options)\n+        compilation.addModuleTree(\n+          {\n+            context,\n+            dependency,\n+            contextInfo: { issuerLayer: options.layer },\n+          },\n+          (err: any, module: any) => {\n+            if (err) {\n+              compilation.hooks.failedEntry.call(dependency, options, err)\n+              return reject(err)\n+            }\n+\n+            compilation.hooks.succeedEntry.call(dependency, options, module)\n+\n+            compilation.moduleGraph\n+              .getExportsInfo(module)\n+              .setUsedInUnknownWay(\n+                this.isEdgeServer\n+                  ? EDGE_RUNTIME_WEBPACK\n+                  : DEFAULT_RUNTIME_WEBPACK\n+              )\n+\n+            return resolve(module)\n+          }\n+        )\n+      }\n     })\n   }\n "
        },
        {
            "sha": "7cb97406c9d9d44078a01c4d352b0c358ad5112c",
            "filename": "packages/next/src/build/webpack/plugins/flight-manifest-plugin.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts?ref=1405eaf4a5218e708759081993323b4cd05dd609",
            "patch": "@@ -324,8 +324,7 @@ export class ClientReferenceManifestPlugin {\n       const recordModule = (modId: ModuleId, mod: webpack.NormalModule) => {\n         let resource =\n           mod.type === 'css/mini-extract'\n-            ? // @ts-expect-error TODO: use `identifier()` instead.\n-              mod._identifier.slice(mod._identifier.lastIndexOf('!') + 1)\n+            ? mod.identifier().slice(mod.identifier().lastIndexOf('!') + 1)\n             : mod.resource\n \n         if (!resource) {\n@@ -525,7 +524,11 @@ export class ClientReferenceManifestPlugin {\n               } else {\n                 // If this is a concatenation, register each child to the parent ID.\n                 if (\n-                  connection.module?.constructor.name === 'ConcatenatedModule'\n+                  connection.module?.constructor.name ===\n+                    'ConcatenatedModule' ||\n+                  (Boolean(process.env.NEXT_RSPACK) &&\n+                    (connection.module as any)?.constructorName ===\n+                      'ConcatenatedModule')\n                 ) {\n                   const concatenatedMod = connection.module\n                   const concatenatedModId ="
        },
        {
            "sha": "af26d7fd159eaac7e0c44d7f15dab3c23e8f9f9a",
            "filename": "packages/next/src/build/webpack/plugins/rspack-flight-client-entry-plugin.ts",
            "status": "added",
            "additions": 157,
            "deletions": 0,
            "changes": 157,
            "blob_url": "https://github.com/vercel/next.js/blob/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Frspack-flight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1405eaf4a5218e708759081993323b4cd05dd609/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Frspack-flight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Frspack-flight-client-entry-plugin.ts?ref=1405eaf4a5218e708759081993323b4cd05dd609",
            "patch": "@@ -0,0 +1,157 @@\n+import type { Compiler } from '@rspack/core'\n+import {\n+  getInvalidator,\n+  getEntries,\n+  EntryTypes,\n+  getEntryKey,\n+} from '../../../server/dev/on-demand-entry-handler'\n+import { COMPILER_NAMES } from '../../../shared/lib/constants'\n+\n+import { getProxiedPluginState } from '../../build-context'\n+import { PAGE_TYPES } from '../../../lib/page-types'\n+import { getRspackCore } from '../../../shared/lib/get-rspack'\n+\n+type Actions = {\n+  [actionId: string]: {\n+    workers: {\n+      [name: string]: { moduleId: string | number; async: boolean }\n+    }\n+    // Record which layer the action is in (rsc or sc_action), in the specific entry.\n+    layer: {\n+      [name: string]: string\n+    }\n+  }\n+}\n+\n+export type ActionManifest = {\n+  // Assign a unique encryption key during production build.\n+  encryptionKey: string\n+  node: Actions\n+  edge: Actions\n+}\n+\n+export interface ModuleInfo {\n+  moduleId: string | number\n+  async: boolean\n+}\n+\n+const pluginState = getProxiedPluginState({\n+  // A map to track \"action\" -> \"list of bundles\".\n+  serverActions: {} as ActionManifest['node'],\n+  edgeServerActions: {} as ActionManifest['edge'],\n+\n+  serverActionModules: {} as {\n+    [workerName: string]: { server?: ModuleInfo; client?: ModuleInfo }\n+  },\n+\n+  edgeServerActionModules: {} as {\n+    [workerName: string]: { server?: ModuleInfo; client?: ModuleInfo }\n+  },\n+\n+  ssrModules: {} as { [ssrModuleId: string]: ModuleInfo },\n+  edgeSsrModules: {} as { [ssrModuleId: string]: ModuleInfo },\n+\n+  rscModules: {} as { [rscModuleId: string]: ModuleInfo },\n+  edgeRscModules: {} as { [rscModuleId: string]: ModuleInfo },\n+\n+  injectedClientEntries: {} as Record<string, string>,\n+})\n+\n+interface Options {\n+  dev: boolean\n+  appDir: string\n+  isEdgeServer: boolean\n+  encryptionKey: string\n+}\n+\n+export class RspackFlightClientEntryPlugin {\n+  plugin: any\n+  compiler?: Compiler\n+\n+  constructor(options: Options) {\n+    const { FlightClientEntryPlugin } = getRspackCore()\n+\n+    this.plugin = new FlightClientEntryPlugin({\n+      ...options,\n+      builtinAppLoader: !!process.env.BUILTIN_SWC_LOADER,\n+      shouldInvalidateCb: ({\n+        bundlePath,\n+        entryName,\n+        absolutePagePath,\n+        clientBrowserLoader,\n+      }: any) => {\n+        let shouldInvalidate = false\n+        const compiler = this.compiler!\n+\n+        const entries = getEntries(compiler.outputPath)\n+        const pageKey = getEntryKey(\n+          COMPILER_NAMES.client,\n+          PAGE_TYPES.APP,\n+          bundlePath\n+        )\n+\n+        if (!entries[pageKey]) {\n+          entries[pageKey] = {\n+            type: EntryTypes.CHILD_ENTRY,\n+            parentEntries: new Set([entryName]),\n+            absoluteEntryFilePath: absolutePagePath,\n+            bundlePath,\n+            request: clientBrowserLoader,\n+            dispose: false,\n+            lastActiveTime: Date.now(),\n+          }\n+          shouldInvalidate = true\n+        } else {\n+          const entryData = entries[pageKey]\n+          // New version of the client loader\n+          if (entryData.request !== clientBrowserLoader) {\n+            entryData.request = clientBrowserLoader\n+            shouldInvalidate = true\n+          }\n+          if (entryData.type === EntryTypes.CHILD_ENTRY) {\n+            entryData.parentEntries.add(entryName)\n+          }\n+          entryData.dispose = false\n+          entryData.lastActiveTime = Date.now()\n+        }\n+\n+        return shouldInvalidate\n+      },\n+      invalidateCb: () => {\n+        const compiler = this.compiler!\n+\n+        // Invalidate in development to trigger recompilation\n+        const invalidator = getInvalidator(compiler.outputPath)\n+        // Check if any of the entry injections need an invalidation\n+        if (invalidator) {\n+          invalidator.invalidate([COMPILER_NAMES.client])\n+        }\n+      },\n+      stateCb: (state: any) => {\n+        Object.assign(pluginState.serverActions, state.serverActions)\n+        Object.assign(pluginState.edgeServerActions, state.edgeServerActions)\n+        Object.assign(\n+          pluginState.serverActionModules,\n+          state.serverActionModules\n+        )\n+        Object.assign(\n+          pluginState.edgeServerActionModules,\n+          state.edgeServerActionModules\n+        )\n+        Object.assign(pluginState.ssrModules, state.ssrModules)\n+        Object.assign(pluginState.edgeSsrModules, state.edgeSsrModules)\n+        Object.assign(pluginState.rscModules, state.rscModules)\n+        Object.assign(pluginState.edgeRscModules, state.edgeRscModules)\n+        Object.assign(\n+          pluginState.injectedClientEntries,\n+          state.injectedClientEntries\n+        )\n+      },\n+    })\n+  }\n+\n+  apply(compiler: Compiler) {\n+    this.compiler = compiler\n+    this.plugin.apply(compiler)\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 269,
        "additions": 238,
        "deletions": 31
    }
}