{
    "author": "kdy1",
    "message": "refactor(turbopack): Make invalidator flag explicit (#80487)\n\n### What?\r\n\r\nRetry https://github.com/vercel/next.js/pull/80414.\r\n\r\nThis time, I added `invalidator` required only for turbo tasks function, and made it real assertion.\r\n\r\n### Why?\r\n\r\nWe need it.\r\n\r\n### How?\r\n\r\nCloses PACK-4826",
    "sha": "2aa74a8978ec056f9358c66a46a0329da096feae",
    "files": [
        {
            "sha": "5852f804e47da500c6bfe161914977a66608413b",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -423,7 +423,7 @@ impl ProjectContainer {\n \n #[turbo_tasks::value_impl]\n impl ProjectContainer {\n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     pub async fn project(&self) -> Result<Vc<Project>> {\n         let env_map: Vc<EnvMap>;\n         let next_config;"
        },
        {
            "sha": "d449786a0237dfc76a3ff380e56c40e04f29abd4",
            "filename": "crates/next-api/src/versioned_content_map.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/crates%2Fnext-api%2Fsrc%2Fversioned_content_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/crates%2Fnext-api%2Fsrc%2Fversioned_content_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fversioned_content_map.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -219,7 +219,7 @@ impl VersionedContentMap {\n         Ok(Vc::cell(None))\n     }\n \n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     pub async fn keys_in_path(&self, root: Vc<FileSystemPath>) -> Result<Vc<Vec<RcStr>>> {\n         let keys = {\n             let map = &self.map_path_to_op.get().0;\n@@ -234,7 +234,7 @@ impl VersionedContentMap {\n         Ok(Vc::cell(keys))\n     }\n \n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     fn raw_get(&self, path: ResolvedVc<FileSystemPath>) -> Vc<OptionMapEntry> {\n         let assets = {\n             let map = &self.map_path_to_op.get().0;"
        },
        {
            "sha": "a40a8760c8708e2ffe337805d9f99be8a8107709",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -551,7 +551,7 @@ impl Debug for DiskFileSystem {\n \n #[turbo_tasks::value_impl]\n impl FileSystem for DiskFileSystem {\n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn read(&self, fs_path: Vc<FileSystemPath>) -> Result<Vc<FileContent>> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -577,7 +577,7 @@ impl FileSystem for DiskFileSystem {\n         Ok(content.cell())\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn raw_read_dir(&self, fs_path: Vc<FileSystemPath>) -> Result<Vc<RawDirectoryContent>> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -632,7 +632,7 @@ impl FileSystem for DiskFileSystem {\n         Ok(RawDirectoryContent::new(entries))\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn read_link(&self, fs_path: Vc<FileSystemPath>) -> Result<Vc<LinkContent>> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -718,7 +718,7 @@ impl FileSystem for DiskFileSystem {\n         .cell())\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn write(&self, fs_path: Vc<FileSystemPath>, content: Vc<FileContent>) -> Result<()> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -843,7 +843,7 @@ impl FileSystem for DiskFileSystem {\n         Ok(())\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn write_link(&self, fs_path: Vc<FileSystemPath>, target: Vc<LinkContent>) -> Result<()> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -962,7 +962,7 @@ impl FileSystem for DiskFileSystem {\n         Ok(())\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn metadata(&self, fs_path: Vc<FileSystemPath>) -> Result<Vc<FileMeta>> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;"
        },
        {
            "sha": "fc599d59ec7324bee165a1bfcc8ca9975f39a7f0",
            "filename": "turbopack/crates/turbo-tasks-macros-tests/tests/function/fail_attribute_invalid_args.stderr",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args.stderr?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -1,4 +1,4 @@\n-error: unexpected token, expected one of: \"fs\", \"network\", \"operation\", \"local\"\n+error: unexpected token, expected one of: \"fs\", \"network\", \"operation\", \"local\", \"invalidator\"\n  --> tests/function/fail_attribute_invalid_args.rs:9:25\n   |\n 9 | #[turbo_tasks::function(invalid_argument)]"
        },
        {
            "sha": "63988dba8fb0752b8605eaa46b2e1402930e1390",
            "filename": "turbopack/crates/turbo-tasks-macros-tests/tests/function/fail_attribute_invalid_args_inherent_impl.stderr",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args_inherent_impl.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args_inherent_impl.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args_inherent_impl.stderr?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -1,4 +1,4 @@\n-error: unexpected token, expected one of: \"fs\", \"network\", \"operation\", \"local\"\n+error: unexpected token, expected one of: \"fs\", \"network\", \"operation\", \"local\", \"invalidator\"\n   --> tests/function/fail_attribute_invalid_args_inherent_impl.rs:14:29\n    |\n 14 |     #[turbo_tasks::function(invalid_argument)]"
        },
        {
            "sha": "237ea8977c634328397df5eb738651b95f889aa0",
            "filename": "turbopack/crates/turbo-tasks-macros/src/func.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -733,6 +733,9 @@ pub struct FunctionArguments {\n     /// task-local state. The function call itself will not be cached, but cells will be created on\n     /// the parent task.\n     pub local: Option<Span>,\n+    /// If true, the function will be allowed to call `get_invalidator` . If this is false, the\n+    /// `get_invalidator` function will panic on calls.\n+    pub invalidator: Option<Span>,\n }\n \n impl Parse for FunctionArguments {\n@@ -760,11 +763,14 @@ impl Parse for FunctionArguments {\n                 (\"local\", Meta::Path(_)) => {\n                     parsed_args.local = Some(meta.span());\n                 }\n+                (\"invalidator\", Meta::Path(_)) => {\n+                    parsed_args.invalidator = Some(meta.span());\n+                }\n                 (_, meta) => {\n                     return Err(syn::Error::new_spanned(\n                         meta,\n                         \"unexpected token, expected one of: \\\"fs\\\", \\\"network\\\", \\\"operation\\\", \\\n-                         \\\"local\\\"\",\n+                         \\\"local\\\", \\\"invalidator\\\"\",\n                     ));\n                 }\n             }\n@@ -1092,6 +1098,7 @@ pub struct NativeFn {\n     pub is_self_used: bool,\n     pub filter_trait_call_args: Option<FilterTraitCallArgsTokens>,\n     pub local: bool,\n+    pub invalidator: bool,\n }\n \n impl NativeFn {\n@@ -1107,6 +1114,7 @@ impl NativeFn {\n             is_self_used,\n             filter_trait_call_args,\n             local,\n+            invalidator,\n         } = self;\n \n         if *is_method {\n@@ -1133,6 +1141,7 @@ impl NativeFn {\n                             #function_path_string.to_owned(),\n                             turbo_tasks::macro_helpers::FunctionMeta {\n                                 local: #local,\n+                                invalidator: #invalidator,\n                             },\n                             #arg_filter,\n                             #function_path,\n@@ -1147,6 +1156,7 @@ impl NativeFn {\n                             #function_path_string.to_owned(),\n                             turbo_tasks::macro_helpers::FunctionMeta {\n                                 local: #local,\n+                                invalidator: #invalidator,\n                             },\n                             #arg_filter,\n                             #function_path,\n@@ -1162,6 +1172,7 @@ impl NativeFn {\n                         #function_path_string.to_owned(),\n                         turbo_tasks::macro_helpers::FunctionMeta {\n                             local: #local,\n+                            invalidator: #invalidator,\n                         },\n                         #function_path,\n                     )"
        },
        {
            "sha": "7a12b69b2a81a00f563491ea672a0fcb70f4dbb6",
            "filename": "turbopack/crates/turbo-tasks-macros/src/function_macro.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -42,6 +42,7 @@ pub fn function(args: TokenStream, input: TokenStream) -> TokenStream {\n         .inspect_err(|err| errors.push(err.to_compile_error()))\n         .unwrap_or_default();\n     let local = args.local.is_some();\n+    let invalidator = args.invalidator.is_some();\n     let is_self_used = args.operation.is_some() || is_self_used(&block);\n \n     let Some(turbo_fn) = TurboFn::new(&sig, DefinitionContext::NakedFn, args) else {\n@@ -65,6 +66,7 @@ pub fn function(args: TokenStream, input: TokenStream) -> TokenStream {\n         is_self_used,\n         filter_trait_call_args: None, // not a trait method\n         local,\n+        invalidator,\n     };\n     let native_function_ident = get_native_function_ident(ident);\n     let native_function_ty = native_fn.ty();"
        },
        {
            "sha": "6dc0adcdcdff1a00bc1658a36455497176de168b",
            "filename": "turbopack/crates/turbo-tasks-macros/src/value_impl_macro.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -95,6 +95,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     }\n                 };\n                 let local = func_args.local.is_some();\n+                let invalidator = func_args.invalidator.is_some();\n                 let is_self_used = func_args.operation.is_some() || is_self_used(block);\n \n                 let Some(turbo_fn) =\n@@ -117,6 +118,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     is_self_used,\n                     filter_trait_call_args: None, // not a trait method\n                     local,\n+                    invalidator,\n                 };\n \n                 let native_function_ident = get_inherent_impl_function_ident(ty_ident, ident);\n@@ -212,6 +214,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     }\n                 };\n                 let local = func_args.local.is_some();\n+                let invalidator = func_args.invalidator.is_some();\n                 let is_self_used = func_args.operation.is_some() || is_self_used(block);\n \n                 let Some(turbo_fn) =\n@@ -244,6 +247,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     is_self_used,\n                     filter_trait_call_args: turbo_fn.filter_trait_call_args(),\n                     local,\n+                    invalidator,\n                 };\n \n                 let native_function_ident ="
        },
        {
            "sha": "38970e9cc14128d2b7ddbb24d2ad9967918a99cb",
            "filename": "turbopack/crates/turbo-tasks-macros/src/value_trait_macro.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -193,6 +193,7 @@ pub fn value_trait(args: TokenStream, input: TokenStream) -> TokenStream {\n                 //   argument. (This could be fixed)\n                 // - This only makes sense when a default implementation is present.\n                 local: false,\n+                invalidator: func_args.invalidator.is_some(),\n             };\n \n             let native_function_ident = get_trait_default_impl_function_ident(trait_ident, ident);"
        },
        {
            "sha": "73a083ac600156a63b6b1d664c5cdf777440c499",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/detached.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fdetached.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fdetached.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fdetached.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -163,7 +163,7 @@ async fn spawns_detached_changing(\n }\n \n // spawns_detached should take a dependency on this function for each input\n-#[turbo_tasks::function]\n+#[turbo_tasks::function(invalidator)]\n async fn read_changing_input(changing_input: Vc<ChangingInput>) -> Vc<u32> {\n     // when changing_input.set is called, it will trigger an invalidator for this task\n     Vc::cell(*changing_input.await.unwrap().state.get())"
        },
        {
            "sha": "49027755fcfa9691a1803fc6e3a157fb197ab57a",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/dirty_in_progress.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fdirty_in_progress.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fdirty_in_progress.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fdirty_in_progress.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -71,7 +71,7 @@ impl ValueToString for Collectible {\n     }\n }\n \n-#[turbo_tasks::function(operation)]\n+#[turbo_tasks::function(operation, invalidator)]\n async fn inner_compute(input: ResolvedVc<ChangingInput>) -> Result<Vc<u32>> {\n     println!(\"start inner_compute\");\n     let value = *input.await?.state.get();"
        },
        {
            "sha": "8ebc61a705fa352f830563ea7fbcfdbc3d2aa54d",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/emptied_cells.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Femptied_cells.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Femptied_cells.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Femptied_cells.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -56,7 +56,7 @@ async fn compute(input: Vc<ChangingInput>) -> Result<Vc<u32>> {\n     Ok(Vc::cell(value))\n }\n \n-#[turbo_tasks::function]\n+#[turbo_tasks::function(invalidator)]\n async fn inner_compute(input: Vc<ChangingInput>) -> Result<Vc<u32>> {\n     println!(\"inner_compute()\");\n     let state_value = *input.await?.state.get();"
        },
        {
            "sha": "eb1c537c9714eb70ad03929473f862ec51275344",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/random_change.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frandom_change.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frandom_change.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frandom_change.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -48,15 +48,15 @@ fn make_state() -> Vc<ValueContainer> {\n     .cell()\n }\n \n-#[turbo_tasks::function]\n+#[turbo_tasks::function(invalidator)]\n async fn func2(input: Vc<ValueContainer>) -> Result<Vc<Value>> {\n     let state = input.await?;\n     let value = state.state.get();\n     println!(\"func2 {}\", *value);\n     Ok(func(input, -*value))\n }\n \n-#[turbo_tasks::function]\n+#[turbo_tasks::function(invalidator)]\n async fn func(input: Vc<ValueContainer>, nesting: i32) -> Result<Vc<Value>> {\n     let state = input.await?;\n     let value = state.state.get();"
        },
        {
            "sha": "921d9be73c4fa7fc52fd740bcd92f85f1ab58b0d",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/read_ref_cell.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fread_ref_cell.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fread_ref_cell.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fread_ref_cell.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -70,7 +70,7 @@ impl Counter {\n \n #[turbo_tasks::value_impl]\n impl Counter {\n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     async fn get_value(&self) -> Result<Vc<CounterValue>> {\n         let mut lock = self.value.lock().unwrap();\n         lock.1 = Some(get_invalidator());"
        },
        {
            "sha": "0972b72ec72b3855c991040160ea9d9fd09f3b83",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/recompute.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frecompute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frecompute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frecompute.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -70,7 +70,7 @@ struct Output {\n     random_value: u32,\n }\n \n-#[turbo_tasks::function]\n+#[turbo_tasks::function(invalidator)]\n async fn compute(input: Vc<ChangingInput>, input2: Vc<ChangingInput>) -> Result<Vc<Output>> {\n     let state_value = *input.await?.state.get();\n     let state_value2 = if state_value < 5 {\n@@ -88,7 +88,7 @@ async fn compute(input: Vc<ChangingInput>, input2: Vc<ChangingInput>) -> Result<\n     .cell())\n }\n \n-#[turbo_tasks::function]\n+#[turbo_tasks::function(invalidator)]\n async fn compute2(input: Vc<ChangingInput>) -> Result<Vc<u32>> {\n     let state_value = *input.await?.state.get();\n     Ok(Vc::cell(state_value))"
        },
        {
            "sha": "89e2bca2d9c0ad997a6ae4c631ed93d10a52b910",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/recompute_collectibles.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frecompute_collectibles.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frecompute_collectibles.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Frecompute_collectibles.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -76,7 +76,7 @@ impl ValueToString for Collectible {\n     }\n }\n \n-#[turbo_tasks::function(operation)]\n+#[turbo_tasks::function(operation, invalidator)]\n async fn inner_compute(\n     input: ResolvedVc<ChangingInput>,\n     input2: ResolvedVc<ChangingInput>,\n@@ -85,7 +85,7 @@ async fn inner_compute(\n     Ok(inner_compute2(*input, *input2.await?.state.get()))\n }\n \n-#[turbo_tasks::function]\n+#[turbo_tasks::function(invalidator)]\n async fn inner_compute2(input: Vc<ChangingInput>, innerness: u32) -> Result<Vc<u32>> {\n     println!(\"inner_compute2({innerness})\");\n     if innerness > 0 {"
        },
        {
            "sha": "a512e169ddddc8c48b193bdbce9cdcbdaf3e0be1",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/trait_ref_cell.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftrait_ref_cell.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftrait_ref_cell.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftrait_ref_cell.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -87,7 +87,7 @@ trait CounterTrait {\n \n #[turbo_tasks::value_impl]\n impl CounterTrait for Counter {\n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     async fn get_value(&self) -> Result<Vc<CounterValue>> {\n         let mut lock = self.value.lock().unwrap();\n         lock.1 = Some(get_invalidator());"
        },
        {
            "sha": "101f613dc96f29e7c16508a249714cd8847acfdb",
            "filename": "turbopack/crates/turbo-tasks/src/invalidation.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -9,7 +9,7 @@ use std::{\n use anyhow::Result;\n use indexmap::map::Entry;\n use serde::{Deserialize, Serialize, de::Visitor};\n-use tokio::runtime::Handle;\n+use tokio::{runtime::Handle, task_local};\n \n use crate::{\n     FxIndexMap, FxIndexSet, TaskId, TurboTasksApi,\n@@ -19,9 +19,24 @@ use crate::{\n     util::StaticOrArc,\n };\n \n+task_local! {\n+    static DISALLOW_INVALIDATOR: ();\n+}\n+\n+pub fn disallow_invalidator<R>(f: impl Future<Output = R>) -> impl Future<Output = R> {\n+    DISALLOW_INVALIDATOR.scope((), f)\n+}\n+\n /// Get an [`Invalidator`] that can be used to invalidate the current task\n /// based on external events.\n pub fn get_invalidator() -> Invalidator {\n+    if DISALLOW_INVALIDATOR.try_with(|_| {}).is_ok() {\n+        panic!(\n+            \"Invalidator can only be used in the turbo-tasks function that has \\\n+             #[turbo_tasks::function(invalidator)] attribute\"\n+        );\n+    }\n+\n     let handle = Handle::current();\n     Invalidator {\n         task: current_task(\"turbo_tasks::get_invalidator()\"),"
        },
        {
            "sha": "cc4f9cce9ee91382b15ee400fc353ad81ded1a62",
            "filename": "turbopack/crates/turbo-tasks/src/native_function.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -144,6 +144,10 @@ pub struct FunctionMeta {\n     /// task-local state. The function call itself will not be cached, but cells will be created on\n     /// the parent task.\n     pub local: bool,\n+\n+    /// If true, the function will be allowed to call `get_invalidator` . If this is false, the\n+    /// `get_invalidator` function will panic on calls.\n+    pub invalidator: bool,\n }\n \n /// A native (rust) turbo-tasks function. It's used internally by\n@@ -235,7 +239,13 @@ impl NativeFunction {\n     /// Executed the function\n     pub fn execute(&'static self, this: Option<RawVc>, arg: &dyn MagicAny) -> NativeTaskFuture {\n         match (self.implementation).functor(this, arg) {\n-            Ok(functor) => functor,\n+            Ok(functor) => {\n+                if !self.function_meta.invalidator {\n+                    return Box::pin(crate::invalidation::disallow_invalidator(functor));\n+                }\n+\n+                functor\n+            }\n             Err(err) => Box::pin(async { Err(err) }),\n         }\n     }"
        },
        {
            "sha": "93c9d6de1698127077a75cf91443b0e29bd38625",
            "filename": "turbopack/crates/turbopack-core/src/version.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fversion.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fversion.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fversion.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -272,7 +272,7 @@ pub struct VersionState {\n \n #[turbo_tasks::value_impl]\n impl VersionState {\n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     pub fn get(&self) -> Vc<Box<dyn Version>> {\n         TraitRef::cell(self.version.get().0.clone())\n     }"
        },
        {
            "sha": "ba17a54fa9c3ee8d09b8e998fd75c3970e7382dd",
            "filename": "turbopack/crates/turbopack-dev-server/src/source/asset_graph.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fasset_graph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fasset_graph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fsource%2Fasset_graph.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -88,7 +88,7 @@ impl AssetGraphContentSource {\n         })\n     }\n \n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     async fn all_assets_map(&self) -> Result<Vc<OutputAssetsMap>> {\n         Ok(Vc::cell(\n             expand("
        },
        {
            "sha": "d767474ba7c34217bea87da1de316d37db8be49b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2aa74a8978ec056f9358c66a46a0329da096feae/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=2aa74a8978ec056f9358c66a46a0329da096feae",
            "patch": "@@ -395,7 +395,7 @@ impl ModuleTypeResult {\n \n #[turbo_tasks::value_impl]\n impl EcmascriptParsable for EcmascriptModuleAsset {\n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     async fn failsafe_parse(self: Vc<Self>) -> Result<Vc<ParseResult>> {\n         let real_result = self.parse();\n         let this = self.await?;"
        }
    ],
    "stats": {
        "total": 99,
        "additions": 71,
        "deletions": 28
    }
}