{
    "author": "eps1lon",
    "message": "[strict-route-types] Ensure cache profiles and routes are type-checked even if .next is excluded (#87768)\n\nFlagged behind `experimental.strictRouteTypes`\r\n\r\nThis fixes issues where cache profiles where not included or routes not validated if `.next` was excluded to squeeze out every bit of TypeScript performance.\r\n\r\nIt also fixes a redundant type-check since we have separate dev and prod dist folders.  If you run `next dev` and (`next build` or `next typegen`), you'd type-check routes and links twice. Now `next-env.d.ts` only exists once where we decide which dist folder to type-check.\r\n\r\nGoing forward, new Next.js type-checking should be added to `next-env.d.ts`. That file is fully controlled by Next.js and churning it, does not churn users since it's not in version control.\r\n\r\n`next-env.d.ts` will be moved into `.next` in a follow-up. Ideally independent of the dist folder i.e.  independent of `next dev` vs `next build`.\r\n\r\nCloses https://linear.app/vercel/issue/NXT-124/\r\n\r\nhttps://github.com/vercel/next.js/pull/87319 but flagged.",
    "sha": "35a566b383635348f9aada4b385971ed2a32eebc",
    "files": [
        {
            "sha": "391cd6d32790f6edead6eebff0807a817d08426f",
            "filename": ".prettierignore",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/.prettierignore",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/.prettierignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.prettierignore?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -52,6 +52,8 @@ test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/ignored.js\n test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/sourcemapped.js\n test/e2e/app-dir/server-source-maps/fixtures/default/external-pkg/sourcemapped.js\n test/development/mcp-server/fixtures/default-template/app/build-error/page.tsx\n+# Tested against auto-generated content that isn't formatted\n+test/integration/typescript-app-type-declarations/next-env.strictRouteTypes.d.ts\n \n # turbopack crates, disable for some tests and precompiled dependencies.\n /turbopack/crates/*/js/src/compiled"
        },
        {
            "sha": "d674b370e7aa80f75a96a5794e49c24186edb322",
            "filename": "packages/next/src/build/type-check.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -23,6 +23,7 @@ function verifyTypeScriptSetup(\n   strictRouteTypes: boolean,\n   typeCheckPreflight: boolean,\n   tsconfigPath: string | undefined,\n+  typedRoutes: boolean,\n   disableStaticImages: boolean,\n   cacheDir: string | undefined,\n   enableWorkerThreads: boolean | undefined,\n@@ -54,6 +55,7 @@ function verifyTypeScriptSetup(\n       strictRouteTypes,\n       typeCheckPreflight,\n       tsconfigPath,\n+      typedRoutes,\n       disableStaticImages,\n       cacheDir,\n       hasAppDir,\n@@ -122,6 +124,7 @@ export async function startTypeChecking({\n           Boolean(config.experimental.strictRouteTypes),\n           !ignoreTypeScriptErrors,\n           config.typescript.tsconfigPath,\n+          Boolean(config.typedRoutes),\n           config.images.disableStaticImages,\n           cacheDir,\n           config.experimental.workerThreads,"
        },
        {
            "sha": "065a7ae9dfebd6dd6c83400bc0dc65261b26f516",
            "filename": "packages/next/src/cli/next-test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -143,6 +143,7 @@ async function runPlaywright(\n       strictRouteTypes: Boolean(nextConfig.experimental.strictRouteTypes),\n       typeCheckPreflight: false,\n       tsconfigPath: nextConfig.typescript.tsconfigPath,\n+      typedRoutes: Boolean(nextConfig.typedRoutes),\n       disableStaticImages: nextConfig.images.disableStaticImages,\n       hasAppDir: !!appDir,\n       hasPagesDir: !!pagesDir,"
        },
        {
            "sha": "185bfe03905aac86cd8fd45ddf924d75188aaec2",
            "filename": "packages/next/src/cli/next-typegen.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -62,6 +62,7 @@ const nextTypegen = async (\n     strictRouteTypes,\n     typeCheckPreflight: false,\n     tsconfigPath: nextConfig.typescript.tsconfigPath,\n+    typedRoutes: Boolean(nextConfig.typedRoutes),\n     disableStaticImages: nextConfig.images.disableStaticImages,\n     hasAppDir: !!appDir,\n     hasPagesDir: !!pagesDir,"
        },
        {
            "sha": "20727d2074b8c7a7fea459fa59d8fd562220f96d",
            "filename": "packages/next/src/lib/typescript/writeAppTypeDeclarations.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 6,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -8,12 +8,16 @@ export async function writeAppTypeDeclarations({\n   imageImportsEnabled,\n   hasPagesDir,\n   hasAppDir,\n+  strictRouteTypes,\n+  typedRoutes,\n }: {\n   baseDir: string\n   distDir: string\n   imageImportsEnabled: boolean\n   hasPagesDir: boolean\n   hasAppDir: boolean\n+  strictRouteTypes: boolean\n+  typedRoutes: boolean\n }): Promise<void> {\n   // Reference `next` types\n   const appTypeDeclarations = path.join(baseDir, 'next-env.d.ts')\n@@ -42,17 +46,17 @@ export async function writeAppTypeDeclarations({\n    *\n    * @see https://www.typescriptlang.org/docs/handbook/triple-slash-directives.html\n    */\n-  const directives: string[] = [\n+  const lines: string[] = [\n     // Include the core Next.js typings.\n     '/// <reference types=\"next\" />',\n   ]\n \n   if (imageImportsEnabled) {\n-    directives.push('/// <reference types=\"next/image-types/global\" />')\n+    lines.push('/// <reference types=\"next/image-types/global\" />')\n   }\n \n   if (hasAppDir && hasPagesDir) {\n-    directives.push(\n+    lines.push(\n       '/// <reference types=\"next/navigation-types/compat/navigation\" />'\n     )\n   }\n@@ -63,16 +67,38 @@ export async function writeAppTypeDeclarations({\n   )\n \n   // Use ESM import instead of triple-slash reference for better ESLint compatibility\n-  directives.push(`import \"./${routeTypesPath}\";`)\n+  lines.push(`import \"./${routeTypesPath}\";`)\n+\n+  if (strictRouteTypes) {\n+    const cacheLifePath = path.posix.join(\n+      distDir.replaceAll(path.win32.sep, path.posix.sep),\n+      'types/cache-life.d.ts'\n+    )\n+    lines.push(`import \"./${cacheLifePath}\";`)\n+\n+    const routeValidatorPath = path.posix.join(\n+      distDir.replaceAll(path.win32.sep, path.posix.sep),\n+      'types/validator.ts'\n+    )\n+    lines.push(`import \"./${routeValidatorPath}\";`)\n+\n+    if (typedRoutes === true) {\n+      const linkTypesPath = path.posix.join(\n+        distDir.replaceAll(path.win32.sep, path.posix.sep),\n+        'types/link.d.ts'\n+      )\n+      lines.push(`import \"./${linkTypesPath}\";`)\n+    }\n+  }\n \n   // Push the notice in.\n-  directives.push(\n+  lines.push(\n     '',\n     '// NOTE: This file should not be edited',\n     `// see https://nextjs.org/docs/${hasAppDir ? 'app' : 'pages'}/api-reference/config/typescript for more information.`\n   )\n \n-  const content = directives.join(eol) + eol\n+  const content = lines.join(eol) + eol\n \n   // Avoids an un-necessary write on read-only fs\n   if (currentContent === content) {"
        },
        {
            "sha": "14120970bcf8a674db017d566549d5f78daf8d8e",
            "filename": "packages/next/src/lib/typescript/writeConfigurationDefaults.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.test.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -87,8 +87,6 @@ describe('writeConfigurationDefaults()', () => {\n          ],\n          \"include\": [\n            \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n            \"**/*.ts\",\n            \"**/*.tsx\",\n@@ -109,7 +107,7 @@ describe('writeConfigurationDefaults()', () => {\n          \t- strict was set to false\n          \t- noEmit was set to true\n          \t- incremental was set to true\n-         \t- include was set to ['next-env.d.ts', '.next/types/**/*.ts', '.next/dev/types/**/*.ts', '**/*.mts', '**/*.ts', '**/*.tsx']\n+         \t- include was set to ['next-env.d.ts', '**/*.mts', '**/*.ts', '**/*.tsx']\n          \t- plugins was updated to add { name: 'next' }\n          \t- exclude was set to ['node_modules']\n "
        },
        {
            "sha": "4d8bd2968bb97cf2f2732f871895cdc59f2cd481",
            "filename": "packages/next/src/lib/typescript/writeConfigurationDefaults.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteConfigurationDefaults.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -284,7 +284,7 @@ export async function writeConfigurationDefaults(\n \n   if (!('include' in userTsConfig)) {\n     const defaultInclude =\n-      hasAppDir || strictRouteTypes\n+      hasAppDir && !strictRouteTypes\n         ? ['next-env.d.ts', ...nextTypes, '**/*.mts', '**/*.ts', '**/*.tsx']\n         : ['next-env.d.ts', '**/*.mts', '**/*.ts', '**/*.tsx']\n \n@@ -295,7 +295,7 @@ export async function writeConfigurationDefaults(\n         bold(defaultInclude.map((type) => `'${type}'`).join(', ')) +\n         ']'\n     )\n-  } else if (hasAppDir || strictRouteTypes) {\n+  } else if (hasAppDir && !strictRouteTypes) {\n     const missingFromResolved = []\n     for (const type of nextTypes) {\n       if (!userTsConfig.include.includes(type)) {"
        },
        {
            "sha": "c80f35c4522e2a23e225b02efa021fe5bc0c0a3f",
            "filename": "packages/next/src/lib/verify-typescript-setup.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -40,6 +40,7 @@ export async function verifyTypeScriptSetup({\n   strictRouteTypes,\n   tsconfigPath,\n   typeCheckPreflight,\n+  typedRoutes,\n   disableStaticImages,\n   hasAppDir,\n   hasPagesDir,\n@@ -54,6 +55,7 @@ export async function verifyTypeScriptSetup({\n   strictRouteTypes: boolean\n   tsconfigPath: string | undefined\n   typeCheckPreflight: boolean\n+  typedRoutes: boolean\n   disableStaticImages: boolean\n   hasAppDir: boolean\n   hasPagesDir: boolean\n@@ -149,6 +151,8 @@ export async function verifyTypeScriptSetup({\n       imageImportsEnabled: !disableStaticImages,\n       hasPagesDir,\n       hasAppDir,\n+      strictRouteTypes,\n+      typedRoutes,\n     })\n \n     let result"
        },
        {
            "sha": "26b8a460cffc29c5f5f918dd25b7ad558a7058f2",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -146,6 +146,7 @@ async function verifyTypeScript(opts: SetupOpts) {\n     strictRouteTypes: Boolean(opts.nextConfig.experimental.strictRouteTypes),\n     typeCheckPreflight: false,\n     tsconfigPath: opts.nextConfig.typescript.tsconfigPath,\n+    typedRoutes: Boolean(opts.nextConfig.typedRoutes),\n     disableStaticImages: opts.nextConfig.images.disableStaticImages,\n     hasAppDir: !!opts.appDir,\n     hasPagesDir: !!opts.pagesDir,"
        },
        {
            "sha": "984b484e6a729aed54088c073f2a1b5167b7097e",
            "filename": "test/e2e/tsconfig-module-preserve/index.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftsconfig-module-preserve%2Findex.test.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -61,8 +61,6 @@ describe('tsconfig module: preserve', () => {\n          },\n          \"include\": [\n            \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n            \"**/*.mts\",\n            \"**/*.ts\",\n            \"**/*.tsx\""
        },
        {
            "sha": "e4775377232dc2a4dfb187203195c392639e0ba8",
            "filename": "test/integration/tsconfig-verifier/test/index.test.ts",
            "status": "modified",
            "additions": 833,
            "deletions": 431,
            "changes": 1264,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fintegration%2Ftsconfig-verifier%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fintegration%2Ftsconfig-verifier%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftsconfig-verifier%2Ftest%2Findex.test.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -3,6 +3,10 @@\n import { createFile, existsSync, readFile, writeFile, remove } from 'fs-extra'\n import { nextBuild } from 'next-test-utils'\n import path from 'path'\n+\n+const strictRouteTypes =\n+  process.env.__NEXT_EXPERIMENTAL_STRICT_ROUTE_TYPES === 'true'\n+\n ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n   'tsconfig.json verifier',\n   () => {\n@@ -24,47 +28,89 @@ import path from 'path'\n       expect(existsSync(tsConfig)).toBe(false)\n       const { code } = await nextBuild(appDir)\n       expect(code).toBe(0)\n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"module\": \"esnext\",\n-           \"esModuleInterop\": true,\n-           \"moduleResolution\": \"node\",\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('Works with an empty tsconfig.json (docs)', async () => {\n@@ -81,47 +127,89 @@ import path from 'path'\n       expect(stderr + stdout).not.toContain('moduleResolution')\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"module\": \"esnext\",\n-           \"esModuleInterop\": true,\n-           \"moduleResolution\": \"node\",\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('Updates an existing tsconfig.json without losing comments', async () => {\n@@ -150,55 +238,105 @@ import path from 'path'\n \n       // Weird comma placement until this issue is resolved:\n       // https://github.com/kaelzhang/node-comment-json/issues/21\n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"// top-level comment\n-       {\n-         // in-object comment 1\n-         \"compilerOptions\": {\n-           // in-object comment\n-           \"esModuleInterop\": true, // this should be true\n-           \"module\": \"esnext\" // should not be umd\n-           // end-object comment\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"// top-level comment\n+         {\n+           // in-object comment 1\n+           \"compilerOptions\": {\n+             // in-object comment\n+             \"esModuleInterop\": true, // this should be true\n+             \"module\": \"esnext\" // should not be umd\n+             // end-object comment\n+             ,\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           }\n+           // in-object comment 2\n            ,\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"moduleResolution\": \"node\",\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         // end comment\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"// top-level comment\n+         {\n+           // in-object comment 1\n+           \"compilerOptions\": {\n+             // in-object comment\n+             \"esModuleInterop\": true, // this should be true\n+             \"module\": \"esnext\" // should not be umd\n+             // end-object comment\n+             ,\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           }\n+           // in-object comment 2\n+           ,\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n          }\n-         // in-object comment 2\n-         ,\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       // end comment\n-       \"\n-      `)\n+         // end comment\n+         \"\n+        `)\n+      }\n     })\n \n     it('allows you to set commonjs module mode', async () => {\n@@ -212,47 +350,89 @@ import path from 'path'\n       const { code } = await nextBuild(appDir)\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"esModuleInterop\": true,\n-           \"module\": \"commonjs\",\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"module\": \"commonjs\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"moduleResolution\": \"node\",\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"module\": \"commonjs\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('allows you to set es2020 module mode', async () => {\n@@ -266,47 +446,89 @@ import path from 'path'\n       const { code } = await nextBuild(appDir)\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"esModuleInterop\": true,\n-           \"module\": \"es2020\",\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"module\": \"es2020\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"moduleResolution\": \"node\",\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"module\": \"es2020\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('allows you to set node16 moduleResolution mode', async () => {\n@@ -324,47 +546,89 @@ import path from 'path'\n       expect(stderr + stdout).not.toContain('moduleResolution')\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"esModuleInterop\": true,\n-           \"moduleResolution\": \"node16\",\n-           \"module\": \"node16\",\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node16\",\n+             \"module\": \"node16\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node16\",\n+             \"module\": \"node16\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('allows you to set bundler moduleResolution mode', async () => {\n@@ -382,47 +646,89 @@ import path from 'path'\n       expect(stderr + stdout).not.toContain('moduleResolution')\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"esModuleInterop\": true,\n-           \"moduleResolution\": \"bundler\",\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"bundler\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"module\": \"esnext\",\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"bundler\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('allows you to set target mode', async () => {\n@@ -437,47 +743,89 @@ import path from 'path'\n       expect(stderr + stdout).not.toContain('target')\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"target\": \"es2022\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"target\": \"es2022\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"module\": \"esnext\",\n-           \"esModuleInterop\": true,\n-           \"moduleResolution\": \"node\",\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"target\": \"es2022\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('allows you to set node16 module mode', async () => {\n@@ -495,47 +843,89 @@ import path from 'path'\n       expect(stderr + stdout).not.toContain('moduleResolution')\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"esModuleInterop\": true,\n-           \"module\": \"node16\",\n-           \"moduleResolution\": \"node16\",\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"module\": \"node16\",\n+             \"moduleResolution\": \"node16\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"resolveJsonModule\": true,\n-           \"isolatedModules\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"esModuleInterop\": true,\n+             \"module\": \"node16\",\n+             \"moduleResolution\": \"node16\",\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"resolveJsonModule\": true,\n+             \"isolatedModules\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('allows you to set verbatimModuleSyntax true without adding isolatedModules', async () => {\n@@ -553,47 +943,89 @@ import path from 'path'\n       expect(stderr + stdout).not.toContain('isolatedModules')\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-       \"{\n-         \"compilerOptions\": {\n-           \"verbatimModuleSyntax\": true,\n-           \"target\": \"ES2017\",\n-           \"lib\": [\n-             \"dom\",\n-             \"dom.iterable\",\n-             \"esnext\"\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"verbatimModuleSyntax\": true,\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"allowJs\": true,\n-           \"skipLibCheck\": true,\n-           \"strict\": false,\n-           \"noEmit\": true,\n-           \"incremental\": true,\n-           \"module\": \"esnext\",\n-           \"esModuleInterop\": true,\n-           \"moduleResolution\": \"node\",\n-           \"resolveJsonModule\": true,\n-           \"jsx\": \"react-jsx\",\n-           \"plugins\": [\n-             {\n-               \"name\": \"next\"\n-             }\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n+         \"{\n+           \"compilerOptions\": {\n+             \"verbatimModuleSyntax\": true,\n+             \"target\": \"ES2017\",\n+             \"lib\": [\n+               \"dom\",\n+               \"dom.iterable\",\n+               \"esnext\"\n+             ],\n+             \"allowJs\": true,\n+             \"skipLibCheck\": true,\n+             \"strict\": false,\n+             \"noEmit\": true,\n+             \"incremental\": true,\n+             \"module\": \"esnext\",\n+             \"esModuleInterop\": true,\n+             \"moduleResolution\": \"node\",\n+             \"resolveJsonModule\": true,\n+             \"jsx\": \"react-jsx\",\n+             \"plugins\": [\n+               {\n+                 \"name\": \"next\"\n+               }\n+             ],\n+             \"strictNullChecks\": true\n+           },\n+           \"include\": [\n+             \"next-env.d.ts\",\n+             \".next/types/**/*.ts\",\n+             \".next/dev/types/**/*.ts\",\n+             \"**/*.mts\",\n+             \"**/*.ts\",\n+             \"**/*.tsx\"\n            ],\n-           \"strictNullChecks\": true\n-         },\n-         \"include\": [\n-           \"next-env.d.ts\",\n-           \".next/types/**/*.ts\",\n-           \".next/dev/types/**/*.ts\",\n-           \"**/*.mts\",\n-           \"**/*.ts\",\n-           \"**/*.tsx\"\n-         ],\n-         \"exclude\": [\n-           \"node_modules\"\n-         ]\n-       }\n-       \"\n-      `)\n+           \"exclude\": [\n+             \"node_modules\"\n+           ]\n+         }\n+         \"\n+        `)\n+      }\n     })\n \n     it('allows you to set verbatimModuleSyntax true via extends without adding isolatedModules', async () => {\n@@ -797,41 +1229,11 @@ import path from 'path'\n       expect(stderr + stdout).not.toContain('resolveJsonModule')\n       expect(code).toBe(0)\n \n-      expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot(`\n-              \"{\n-                \"compilerOptions\": {\n-                  \"module\": \"preserve\",\n-                  \"lib\": [\n-                    \"dom\",\n-                    \"dom.iterable\",\n-                    \"esnext\"\n-                  ],\n-                  \"allowJs\": true,\n-                  \"skipLibCheck\": true,\n-                  \"strict\": false,\n-                  \"noEmit\": true,\n-                  \"incremental\": true,\n-                  \"isolatedModules\": true,\n-                  \"jsx\": \"react-jsx\",\n-                  \"plugins\": [\n-                    {\n-                      \"name\": \"next\"\n-                    }\n-                  ],\n-                  \"strictNullChecks\": true\n-                },\n-                \"include\": [\n-                  \"next-env.d.ts\",\n-                  \".next/types/**/*.ts\",\n-                  \"**/*.ts\",\n-                  \"**/*.tsx\"\n-                ],\n-                \"exclude\": [\n-                  \"node_modules\"\n-                ]\n-              }\n-              \"\n-          `)\n+      if (strictRouteTypes) {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot()\n+      } else {\n+        expect(await readFile(tsConfig, 'utf8')).toMatchInlineSnapshot()\n+      }\n     })\n   }\n )"
        },
        {
            "sha": "1c2a6d8c33fc64c2cbeb7f2de284070220a87e72",
            "filename": "test/integration/typescript-app-type-declarations/next-env.strictRouteTypes.d.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.strictRouteTypes.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.strictRouteTypes.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.strictRouteTypes.d.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -0,0 +1,8 @@\n+/// <reference types=\"next\" />\n+/// <reference types=\"next/image-types/global\" />\n+import \"./.next/dev/types/routes.d.ts\";\n+import \"./.next/dev/types/cache-life.d.ts\";\n+import \"./.next/dev/types/validator.ts\";\n+\n+// NOTE: This file should not be edited\n+// see https://nextjs.org/docs/pages/api-reference/config/typescript for more information."
        },
        {
            "sha": "45fcd1d87505c18e6a1eb85fad785801351edd43",
            "filename": "test/integration/typescript-app-type-declarations/test/index.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -6,8 +6,34 @@ import { promises as fs } from 'fs'\n \n const appDir = join(__dirname, '..')\n const appTypeDeclarations = join(appDir, 'next-env.d.ts')\n+const appTypeDeclarationsStrictRouteTypes = join(\n+  appDir,\n+  'next-env.strictRouteTypes.d.ts'\n+)\n+\n+const strictRouteTypes =\n+  process.env.__NEXT_EXPERIMENTAL_STRICT_ROUTE_TYPES === 'true'\n \n describe('TypeScript App Type Declarations', () => {\n+  beforeAll(async () => {\n+    if (strictRouteTypes) {\n+      await fs.rename(appTypeDeclarations, appTypeDeclarations + '.bak')\n+      await fs.copyFile(\n+        appTypeDeclarationsStrictRouteTypes,\n+        appTypeDeclarations\n+      )\n+    }\n+  })\n+\n+  afterAll(async () => {\n+    if (strictRouteTypes) {\n+      await fs.rename(\n+        join(appDir, 'next-env.d.ts') + '.bak',\n+        join(appDir, 'next-env.d.ts')\n+      )\n+    }\n+  })\n+\n   it('should write a new next-env.d.ts if none exist', async () => {\n     const prevContent = await fs.readFile(appTypeDeclarations, 'utf8')\n     try {"
        },
        {
            "sha": "2bf428e885a4c0628b69afac83a96a0894eb1d95",
            "filename": "test/production/app-dir/next-types-plugin/sync-params-type-check/sync-params-type-check.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fproduction%2Fapp-dir%2Fnext-types-plugin%2Fsync-params-type-check%2Fsync-params-type-check.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/test%2Fproduction%2Fapp-dir%2Fnext-types-plugin%2Fsync-params-type-check%2Fsync-params-type-check.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fnext-types-plugin%2Fsync-params-type-check%2Fsync-params-type-check.test.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -1,5 +1,8 @@\n import { nextTestSetup } from 'e2e-utils'\n \n+const strictRouteTypes =\n+  process.env.__NEXT_EXPERIMENTAL_STRICT_ROUTE_TYPES === 'true'\n+\n // This next-types-plugin feature only works in webpack\n ;(process.env.IS_TURBOPACK_TEST ? describe.skip : describe)(\n   'app-dir - sync-params-type-check',\n@@ -28,7 +31,9 @@ import { nextTestSetup } from 'e2e-utils'\n       const { exitCode, cliOutput } = await next.build()\n       expect(exitCode).toBe(1)\n       expect(cliOutput).toMatch(\n-        /Type error: Type '{ params: Params; }' does not satisfy the constraint 'PageProps'/\n+        strictRouteTypes\n+          ? /Property 'slug' is missing in type 'Promise<{ slug: string; }>'/\n+          : /Type error: Type '{ params: Params; }' does not satisfy the constraint 'PageProps'/\n       )\n     })\n   }"
        },
        {
            "sha": "ddaa8dee47608fa32b0a2f98e913a67f87953478",
            "filename": "test/unit/write-app-declarations.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/35a566b383635348f9aada4b385971ed2a32eebc/test%2Funit%2Fwrite-app-declarations.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35a566b383635348f9aada4b385971ed2a32eebc/test%2Funit%2Fwrite-app-declarations.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fwrite-app-declarations.test.ts?ref=35a566b383635348f9aada4b385971ed2a32eebc",
            "patch": "@@ -38,6 +38,8 @@ describe('find config', () => {\n       imageImportsEnabled,\n       hasPagesDir: false,\n       hasAppDir: false,\n+      strictRouteTypes: false,\n+      typedRoutes: true,\n     })\n     expect(await fs.readFile(declarationFile, 'utf8')).toBe(content)\n   })\n@@ -66,6 +68,8 @@ describe('find config', () => {\n       imageImportsEnabled,\n       hasPagesDir: false,\n       hasAppDir: false,\n+      strictRouteTypes: false,\n+      typedRoutes: true,\n     })\n     expect(await fs.readFile(declarationFile, 'utf8')).toBe(content)\n   })\n@@ -92,6 +96,8 @@ describe('find config', () => {\n       imageImportsEnabled,\n       hasPagesDir: false,\n       hasAppDir: false,\n+      strictRouteTypes: false,\n+      typedRoutes: true,\n     })\n     expect(await fs.readFile(declarationFile, 'utf8')).toBe(content)\n   })\n@@ -103,6 +109,8 @@ describe('find config', () => {\n       imageImportsEnabled,\n       hasPagesDir: false,\n       hasAppDir: true,\n+      strictRouteTypes: false,\n+      typedRoutes: true,\n     })\n \n     await expect(fs.readFile(declarationFile, 'utf8')).resolves.not.toContain(\n@@ -115,6 +123,8 @@ describe('find config', () => {\n       imageImportsEnabled,\n       hasPagesDir: true,\n       hasAppDir: true,\n+      strictRouteTypes: false,\n+      typedRoutes: true,\n     })\n \n     await expect(fs.readFile(declarationFile, 'utf8')).resolves.toContain("
        }
    ],
    "stats": {
        "total": 1375,
        "additions": 930,
        "deletions": 445
    }
}