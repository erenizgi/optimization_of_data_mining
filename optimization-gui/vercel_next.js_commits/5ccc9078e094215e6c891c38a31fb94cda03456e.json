{
    "author": "acdlite",
    "message": "Add rendered search to router state (#84983)\n\nThe \"rendered search\" represents the search params that are observed on\nthe server, i.e. the ones passed as the `searchParams` prop to page\nsegments. They may differ from the search params in the browser's URL\nbar, if the server performed a rewrite. This case corresponds to the\nx-nextjs-rewritten-query header.\n\nIf a page segment is marked with `\"use client\"`, we can use this value\nto compute the search params on the client instead of having to fetch\nthem from the server. This part is implemented in #84883.",
    "sha": "5ccc9078e094215e6c891c38a31fb94cda03456e",
    "files": [
        {
            "sha": "226edc1ebececa6a6e20a92af5e76b3d69595774",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -284,6 +284,7 @@ export function hydrate(\n                 navigatedAt: initialTimestamp,\n                 initialFlightData: initialRSCPayload.f,\n                 initialCanonicalUrlParts: initialRSCPayload.c,\n+                initialRenderedSearch: initialRSCPayload.q,\n                 initialParallelRoutes: new Map(),\n                 location: window.location,\n               }),"
        },
        {
            "sha": "6874a6aaeed0acff62c0e3e3e35003128b4da352",
            "filename": "packages/next/src/client/components/app-router-instance.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-instance.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -9,6 +9,7 @@ import {\n   type NavigateAction,\n   ACTION_HMR_REFRESH,\n   PrefetchKind,\n+  type AppHistoryState,\n } from './router-reducer/router-reducer-types'\n import { reducer } from './router-reducer/router-reducer'\n import { startTransition } from 'react'\n@@ -27,7 +28,6 @@ import type {\n   PrefetchOptions,\n } from '../../shared/lib/app-router-context.shared-runtime'\n import { setLinkForCurrentNavigation, type LinkInstance } from './links'\n-import type { FlightRouterState } from '../../shared/lib/app-router-types'\n import type { ClientInstrumentationHooks } from '../app-index'\n import type { GlobalErrorComponent } from './builtin/global-error'\n \n@@ -305,7 +305,7 @@ export function dispatchNavigateAction(\n \n export function dispatchTraverseAction(\n   href: string,\n-  tree: FlightRouterState | undefined\n+  historyState: AppHistoryState | undefined\n ) {\n   const onRouterTransitionStart = getProfilingHookForOnNavigationStart()\n   if (onRouterTransitionStart !== null) {\n@@ -314,7 +314,7 @@ export function dispatchTraverseAction(\n   dispatchAppRouterAction({\n     type: ACTION_RESTORE,\n     url: new URL(href),\n-    tree,\n+    historyState,\n   })\n }\n "
        },
        {
            "sha": "7c09a8d2dfebef6fc5a830c3e6584ed494b8beac",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 16,
            "deletions": 10,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -10,12 +10,12 @@ import {\n   LayoutRouterContext,\n   GlobalLayoutRouterContext,\n } from '../../shared/lib/app-router-context.shared-runtime'\n-import type {\n-  CacheNode,\n-  FlightRouterState,\n-} from '../../shared/lib/app-router-types'\n+import type { CacheNode } from '../../shared/lib/app-router-types'\n import { ACTION_RESTORE } from './router-reducer/router-reducer-types'\n-import type { AppRouterState } from './router-reducer/router-reducer-types'\n+import type {\n+  AppHistoryState,\n+  AppRouterState,\n+} from './router-reducer/router-reducer-types'\n import { createHrefFromUrl } from './router-reducer/create-href-from-url'\n import {\n   SearchParamsContext,\n@@ -61,14 +61,20 @@ function HistoryUpdater({\n       window.next.__pendingUrl = undefined\n     }\n \n-    const { tree, pushRef, canonicalUrl } = appRouterState\n+    const { tree, pushRef, canonicalUrl, renderedSearch } = appRouterState\n+\n+    const appHistoryState: AppHistoryState = {\n+      tree,\n+      renderedSearch,\n+    }\n+\n     const historyState = {\n       ...(pushRef.preserveCustomHistoryState ? window.history.state : {}),\n       // Identifier is shortened intentionally.\n       // __NA is used to identify if the history entry can be handled by the app-router.\n       // __N is used to identify if the history entry can be handled by the old router.\n       __NA: true,\n-      __PRIVATE_NEXTJS_INTERNALS_TREE: tree,\n+      __PRIVATE_NEXTJS_INTERNALS_TREE: appHistoryState,\n     }\n     if (\n       pushRef.pendingPush &&\n@@ -217,7 +223,7 @@ function Router({\n       dispatchAppRouterAction({\n         type: ACTION_RESTORE,\n         url: new URL(window.location.href),\n-        tree: window.history.state.__PRIVATE_NEXTJS_INTERNALS_TREE,\n+        historyState: window.history.state.__PRIVATE_NEXTJS_INTERNALS_TREE,\n       })\n     }\n \n@@ -300,14 +306,14 @@ function Router({\n       url: string | URL | null | undefined\n     ) => {\n       const href = window.location.href\n-      const tree: FlightRouterState | undefined =\n+      const appHistoryState: AppHistoryState | undefined =\n         window.history.state?.__PRIVATE_NEXTJS_INTERNALS_TREE\n \n       startTransition(() => {\n         dispatchAppRouterAction({\n           type: ACTION_RESTORE,\n           url: new URL(url ?? href, href),\n-          tree,\n+          historyState: appHistoryState,\n         })\n       })\n     }"
        },
        {
            "sha": "e4faf0f6310e9ec36c7458536410730836b671e9",
            "filename": "packages/next/src/client/components/router-reducer/aliased-prefetch-navigations.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Faliased-prefetch-navigations.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -31,6 +31,7 @@ export function handleAliasedPrefetchEntry(\n   state: ReadonlyReducerState,\n   flightData: string | NormalizedFlightData[],\n   url: URL,\n+  renderedSearch: string,\n   mutable: Mutable\n ) {\n   let currentTree = state.tree\n@@ -140,6 +141,7 @@ export function handleAliasedPrefetchEntry(\n   }\n \n   mutable.patchedTree = currentTree\n+  mutable.renderedSearch = renderedSearch\n   mutable.cache = currentCache\n   mutable.canonicalUrl = href\n   mutable.hashFragment = url.hash"
        },
        {
            "sha": "b82d1bc573a1963f074c194613d7228e5e5bb02a",
            "filename": "packages/next/src/client/components/router-reducer/create-initial-router-state.test.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.test.tsx?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -38,6 +38,7 @@ describe('createInitialRouterState', () => {\n       navigatedAt,\n       initialFlightData: [[initialTree, ['', children, {}, null]]],\n       initialCanonicalUrlParts: initialCanonicalUrl.split('/'),\n+      initialRenderedSearch: '',\n       initialParallelRoutes,\n       location: new URL('/linking', 'https://localhost') as any,\n     })\n@@ -46,6 +47,7 @@ describe('createInitialRouterState', () => {\n       navigatedAt,\n       initialFlightData: [[initialTree, ['', children, {}, null]]],\n       initialCanonicalUrlParts: initialCanonicalUrl.split('/'),\n+      initialRenderedSearch: '',\n       initialParallelRoutes,\n       location: new URL('/linking', 'https://localhost') as any,\n     })\n@@ -102,6 +104,7 @@ describe('createInitialRouterState', () => {\n     const expected: ReturnType<typeof createInitialRouterState> = {\n       tree: initialTree,\n       canonicalUrl: initialCanonicalUrl,\n+      renderedSearch: '',\n       pushRef: {\n         pendingPush: false,\n         mpaNavigation: false,"
        },
        {
            "sha": "43f9f5ae8d48161bd0cd0db20c28ec08a1bc5293",
            "filename": "packages/next/src/client/components/router-reducer/create-initial-router-state.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fcreate-initial-router-state.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -6,12 +6,15 @@ import type {\n import { createHrefFromUrl } from './create-href-from-url'\n import { fillLazyItemsTillLeafWithHead } from './fill-lazy-items-till-leaf-with-head'\n import { extractPathFromFlightRouterState } from './compute-changed-path'\n+\n+import type { AppRouterState } from './router-reducer-types'\n import { addRefreshMarkerToActiveParallelSegments } from './refetch-inactive-parallel-segments'\n import { getFlightDataPartsFromPath } from '../../flight-data-helpers'\n \n export interface InitialRouterStateParameters {\n   navigatedAt: number\n   initialCanonicalUrlParts: string[]\n+  initialRenderedSearch: string\n   initialParallelRoutes: CacheNode['parallelRoutes']\n   initialFlightData: FlightDataPath[]\n   location: Location | null\n@@ -21,9 +24,10 @@ export function createInitialRouterState({\n   navigatedAt,\n   initialFlightData,\n   initialCanonicalUrlParts,\n+  initialRenderedSearch,\n   initialParallelRoutes,\n   location,\n-}: InitialRouterStateParameters) {\n+}: InitialRouterStateParameters): AppRouterState {\n   // When initialized on the server, the canonical URL is provided as an array of parts.\n   // This is to ensure that when the RSC payload streamed to the client, crawlers don't interpret it\n   // as a URL that should be crawled.\n@@ -91,6 +95,7 @@ export function createInitialRouterState({\n       segmentPaths: [],\n     },\n     canonicalUrl,\n+    renderedSearch: initialRenderedSearch,\n     nextUrl:\n       // the || operator is intentional, the pathname can be an empty string\n       (extractPathFromFlightRouterState(initialTree) || location?.pathname) ??"
        },
        {
            "sha": "715bd6be2e5db5518940df69fb92c916a64f104e",
            "filename": "packages/next/src/client/components/router-reducer/fetch-server-response.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 26,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -36,7 +36,11 @@ import {\n } from '../../flight-data-helpers'\n import { getAppBuildId } from '../../app-build-id'\n import { setCacheBustingSearchParam } from './set-cache-busting-search-param'\n-import { urlToUrlWithoutFlightMarker } from '../../route-params'\n+import {\n+  getRenderedSearch,\n+  urlToUrlWithoutFlightMarker,\n+} from '../../route-params'\n+import type { NormalizedSearch } from '../segment-cache'\n \n const createFromReadableStream =\n   createFromReadableStreamBrowser as (typeof import('react-server-dom-webpack/client.browser'))['createFromReadableStream']\n@@ -63,16 +67,23 @@ export interface FetchServerResponseOptions {\n   readonly isHmrRefresh?: boolean\n }\n \n-export type FetchServerResponseResult = {\n-  flightData: NormalizedFlightData[] | string\n-  canonicalUrl: URL | undefined\n+type SpaFetchServerResponseResult = {\n+  flightData: NormalizedFlightData[]\n+  canonicalUrl: URL\n+  renderedSearch: NormalizedSearch\n   couldBeIntercepted: boolean\n   prerendered: boolean\n   postponed: boolean\n   staleTime: number\n   debugInfo: Array<any> | null\n }\n \n+type MpaFetchServerResponseResult = string\n+\n+export type FetchServerResponseResult =\n+  | MpaFetchServerResponseResult\n+  | SpaFetchServerResponseResult\n+\n export type RequestHeaders = {\n   [RSC_HEADER]?: '1'\n   [NEXT_ROUTER_STATE_TREE_HEADER]?: string\n@@ -88,17 +99,7 @@ export type RequestHeaders = {\n }\n \n function doMpaNavigation(url: string): FetchServerResponseResult {\n-  return {\n-    flightData: urlToUrlWithoutFlightMarker(\n-      new URL(url, location.origin)\n-    ).toString(),\n-    canonicalUrl: undefined,\n-    couldBeIntercepted: false,\n-    prerendered: false,\n-    postponed: false,\n-    staleTime: -1,\n-    debugInfo: null,\n-  }\n+  return urlToUrlWithoutFlightMarker(new URL(url, location.origin)).toString()\n }\n \n let abortController = new AbortController()\n@@ -197,7 +198,7 @@ export async function fetchServerResponse(\n     )\n \n     const responseUrl = urlToUrlWithoutFlightMarker(new URL(res.url))\n-    const canonicalUrl = res.redirected ? responseUrl : undefined\n+    const canonicalUrl = res.redirected ? responseUrl : url\n \n     const contentType = res.headers.get('content-type') || ''\n     const interception = !!res.headers.get('vary')?.includes(NEXT_URL)\n@@ -266,9 +267,15 @@ export async function fetchServerResponse(\n       return doMpaNavigation(res.url)\n     }\n \n+    const normalizedFlightData = normalizeFlightData(flightResponse.f)\n+    if (typeof normalizedFlightData === 'string') {\n+      return doMpaNavigation(normalizedFlightData)\n+    }\n+\n     return {\n-      flightData: normalizeFlightData(flightResponse.f),\n+      flightData: normalizedFlightData,\n       canonicalUrl: canonicalUrl,\n+      renderedSearch: getRenderedSearch(res),\n       couldBeIntercepted: interception,\n       prerendered: flightResponse.S,\n       postponed,\n@@ -286,15 +293,7 @@ export async function fetchServerResponse(\n     // If fetch fails handle it like a mpa navigation\n     // TODO-APP: Add a test for the case where a CORS request fails, e.g. external url redirect coming from the response.\n     // See https://github.com/vercel/next.js/issues/43605#issuecomment-1451617521 for a reproduction.\n-    return {\n-      flightData: url.toString(),\n-      canonicalUrl: undefined,\n-      couldBeIntercepted: false,\n-      prerendered: false,\n-      postponed: false,\n-      staleTime: -1,\n-      debugInfo: null,\n-    }\n+    return url.toString()\n   }\n }\n "
        },
        {
            "sha": "b47f7b7a13ace1b8342f9c07be23a2bd709d1c86",
            "filename": "packages/next/src/client/components/router-reducer/handle-mutable.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fhandle-mutable.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fhandle-mutable.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fhandle-mutable.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -35,11 +35,8 @@ export function handleMutable(\n \n   return {\n     // Set href.\n-    canonicalUrl: isNotUndefined(mutable.canonicalUrl)\n-      ? mutable.canonicalUrl === state.canonicalUrl\n-        ? state.canonicalUrl\n-        : mutable.canonicalUrl\n-      : state.canonicalUrl,\n+    canonicalUrl: mutable.canonicalUrl ?? state.canonicalUrl,\n+    renderedSearch: mutable.renderedSearch ?? state.renderedSearch,\n     pushRef: {\n       pendingPush: isNotUndefined(mutable.pendingPush)\n         ? mutable.pendingPush"
        },
        {
            "sha": "d586f325e41d28128922acbd182b6f0952538fa5",
            "filename": "packages/next/src/client/components/router-reducer/ppr-navigations.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Fppr-navigations.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -790,13 +790,14 @@ export function listenForDynamicRequest(\n   responsePromise: Promise<FetchServerResponseResult>\n ) {\n   responsePromise.then(\n-    ({ flightData, debugInfo }: FetchServerResponseResult) => {\n-      if (typeof flightData === 'string') {\n+    (result: FetchServerResponseResult) => {\n+      if (typeof result === 'string') {\n         // Happens when navigating to page in `pages` from `app`. We shouldn't\n         // get here because should have already handled this during\n         // the prefetch.\n         return\n       }\n+      const { flightData, debugInfo } = result\n       for (const normalizedFlightData of flightData) {\n         const {\n           segmentPath,"
        },
        {
            "sha": "06949ae70614c2d7b8ddd23555427f0b14992781",
            "filename": "packages/next/src/client/components/router-reducer/reducers/hmr-refresh-reducer.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 12,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhmr-refresh-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhmr-refresh-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fhmr-refresh-reducer.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -1,4 +1,7 @@\n-import { fetchServerResponse } from '../fetch-server-response'\n+import {\n+  fetchServerResponse,\n+  type FetchServerResponseResult,\n+} from '../fetch-server-response'\n import { createHrefFromUrl } from '../create-href-from-url'\n import { applyRouterStatePatchToTree } from '../apply-router-state-patch-to-tree'\n import { isNavigatingToNewRootLayout } from '../is-navigating-to-new-root-layout'\n@@ -42,17 +45,19 @@ function hmrRefreshReducerImpl(\n   })\n \n   return cache.lazyData.then(\n-    ({ flightData, canonicalUrl: canonicalUrlOverride }) => {\n+    (result: FetchServerResponseResult) => {\n       // Handle case when navigating to page in `pages` from `app`\n-      if (typeof flightData === 'string') {\n+      if (typeof result === 'string') {\n         return handleExternalUrl(\n           state,\n           mutable,\n-          flightData,\n+          result,\n           state.pushRef.pendingPush\n         )\n       }\n \n+      const { flightData, canonicalUrl, renderedSearch } = result\n+\n       // Remove cache.lazyData as it has been resolved at this point.\n       cache.lazyData = null\n \n@@ -88,13 +93,6 @@ function hmrRefreshReducerImpl(\n           )\n         }\n \n-        const canonicalUrlOverrideHref = canonicalUrlOverride\n-          ? createHrefFromUrl(canonicalUrlOverride)\n-          : undefined\n-\n-        if (canonicalUrlOverride) {\n-          mutable.canonicalUrl = canonicalUrlOverrideHref\n-        }\n         const applied = applyFlightData(\n           navigatedAt,\n           currentCache,\n@@ -108,7 +106,8 @@ function hmrRefreshReducerImpl(\n         }\n \n         mutable.patchedTree = newTree\n-        mutable.canonicalUrl = href\n+        mutable.renderedSearch = renderedSearch\n+        mutable.canonicalUrl = createHrefFromUrl(canonicalUrl)\n \n         currentTree = newTree\n       }"
        },
        {
            "sha": "b7634ab3c1e968843ca462262fda5603d47c2d99",
            "filename": "packages/next/src/client/components/router-reducer/reducers/navigate-reducer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -108,6 +108,7 @@ function handleNavigationResult(\n       // Received a new result.\n       mutable.cache = result.data.cacheNode\n       mutable.patchedTree = result.data.flightRouterState\n+      mutable.renderedSearch = result.data.renderedSearch\n       mutable.canonicalUrl = result.data.canonicalUrl\n       mutable.scrollableSegments = result.data.scrollableSegments\n       mutable.shouldScroll = result.data.shouldScroll"
        },
        {
            "sha": "ec08ab5ac24e285f718077e3e4e5713de0c07076",
            "filename": "packages/next/src/client/components/router-reducer/reducers/refresh-reducer.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -1,4 +1,7 @@\n-import { fetchServerResponse } from '../fetch-server-response'\n+import {\n+  fetchServerResponse,\n+  type FetchServerResponseResult,\n+} from '../fetch-server-response'\n import { createHrefFromUrl } from '../create-href-from-url'\n import { applyRouterStatePatchToTree } from '../apply-router-state-patch-to-tree'\n import { isNavigatingToNewRootLayout } from '../is-navigating-to-new-root-layout'\n@@ -50,17 +53,19 @@ export function refreshReducer(\n \n   const navigatedAt = Date.now()\n   return cache.lazyData.then(\n-    async ({ flightData, canonicalUrl: canonicalUrlOverride }) => {\n+    async (result: FetchServerResponseResult) => {\n       // Handle case when navigating to page in `pages` from `app`\n-      if (typeof flightData === 'string') {\n+      if (typeof result === 'string') {\n         return handleExternalUrl(\n           state,\n           mutable,\n-          flightData,\n+          result,\n           state.pushRef.pendingPush\n         )\n       }\n \n+      const { flightData, canonicalUrl, renderedSearch } = result\n+\n       // Remove cache.lazyData as it has been resolved at this point.\n       cache.lazyData = null\n \n@@ -99,13 +104,7 @@ export function refreshReducer(\n           )\n         }\n \n-        const canonicalUrlOverrideHref = canonicalUrlOverride\n-          ? createHrefFromUrl(canonicalUrlOverride)\n-          : undefined\n-\n-        if (canonicalUrlOverride) {\n-          mutable.canonicalUrl = canonicalUrlOverrideHref\n-        }\n+        mutable.canonicalUrl = createHrefFromUrl(canonicalUrl)\n \n         // Handles case where prefetch only returns the router tree patch without rendered components.\n         if (cacheNodeSeedData !== null) {\n@@ -137,6 +136,7 @@ export function refreshReducer(\n \n         mutable.cache = cache\n         mutable.patchedTree = newTree\n+        mutable.renderedSearch = renderedSearch\n \n         currentTree = newTree\n       }"
        },
        {
            "sha": "f1c8d4db36ecfa788761cda1f7517c5bb8ade453",
            "filename": "packages/next/src/client/components/router-reducer/reducers/restore-reducer.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frestore-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frestore-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frestore-reducer.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -6,20 +6,29 @@ import type {\n } from '../router-reducer-types'\n import { extractPathFromFlightRouterState } from '../compute-changed-path'\n import { updateCacheNodeOnPopstateRestoration } from '../ppr-navigations'\n+import type { FlightRouterState } from '../../../../shared/lib/app-router-types'\n \n export function restoreReducer(\n   state: ReadonlyReducerState,\n   action: RestoreAction\n ): ReducerState {\n-  const { url, tree } = action\n+  const { url, historyState } = action\n   const href = createHrefFromUrl(url)\n   // This action is used to restore the router state from the history state.\n   // However, it's possible that the history state no longer contains the `FlightRouterState`.\n   // We will copy over the internal state on pushState/replaceState events, but if a history entry\n   // occurred before hydration, or if the user navigated to a hash using a regular anchor link,\n   // the history state will not contain the `FlightRouterState`.\n   // In this case, we'll continue to use the existing tree so the router doesn't get into an invalid state.\n-  const treeToRestore = tree || state.tree\n+  let treeToRestore: FlightRouterState | undefined\n+  let renderedSearch: string | undefined\n+  if (historyState) {\n+    treeToRestore = historyState.tree\n+    renderedSearch = historyState.renderedSearch\n+  } else {\n+    treeToRestore = state.tree\n+    renderedSearch = state.renderedSearch\n+  }\n \n   const oldCache = state.cache\n   const newCache = process.env.__NEXT_PPR\n@@ -33,6 +42,7 @@ export function restoreReducer(\n   return {\n     // Set canonical url\n     canonicalUrl: href,\n+    renderedSearch,\n     pushRef: {\n       pendingPush: false,\n       mpaNavigation: false,"
        },
        {
            "sha": "08e1157f8b2a39f2e0e9afef28c0524b0a4dfd51",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-patch-reducer.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 13,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-patch-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-patch-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-patch-reducer.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -17,25 +17,24 @@ export function serverPatchReducer(\n   state: ReadonlyReducerState,\n   action: ServerPatchAction\n ): ReducerState {\n-  const {\n-    serverResponse: { flightData, canonicalUrl: canonicalUrlOverride },\n-    navigatedAt,\n-  } = action\n+  const { serverResponse, navigatedAt } = action\n \n   const mutable: Mutable = {}\n \n   mutable.preserveCustomHistoryState = false\n \n   // Handle case when navigating to page in `pages` from `app`\n-  if (typeof flightData === 'string') {\n+  if (typeof serverResponse === 'string') {\n     return handleExternalUrl(\n       state,\n       mutable,\n-      flightData,\n+      serverResponse,\n       state.pushRef.pendingPush\n     )\n   }\n \n+  const { flightData, canonicalUrl, renderedSearch } = serverResponse\n+\n   let currentTree = state.tree\n   let currentCache = state.cache\n \n@@ -69,18 +68,13 @@ export function serverPatchReducer(\n       )\n     }\n \n-    const canonicalUrlOverrideHref = canonicalUrlOverride\n-      ? createHrefFromUrl(canonicalUrlOverride)\n-      : undefined\n-\n-    if (canonicalUrlOverrideHref) {\n-      mutable.canonicalUrl = canonicalUrlOverrideHref\n-    }\n+    mutable.canonicalUrl = createHrefFromUrl(canonicalUrl)\n \n     const cache: CacheNode = createEmptyCacheNode()\n     applyFlightData(navigatedAt, currentCache, cache, normalizedFlightData)\n \n     mutable.patchedTree = newTree\n+    mutable.renderedSearch = renderedSearch\n     mutable.cache = cache\n \n     currentCache = cache"
        },
        {
            "sha": "d7cca9bd1d04ae567ada7b80d78b11c8c76a850b",
            "filename": "packages/next/src/client/components/router-reducer/refetch-inactive-parallel-segments.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frefetch-inactive-parallel-segments.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frefetch-inactive-parallel-segments.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frefetch-inactive-parallel-segments.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -74,8 +74,9 @@ async function refreshInactiveParallelSegmentsImpl({\n         flightRouterState: [rootTree[0], rootTree[1], rootTree[2], 'refetch'],\n         nextUrl: includeNextUrl ? state.nextUrl : null,\n       }\n-    ).then(({ flightData }) => {\n-      if (typeof flightData !== 'string') {\n+    ).then((result) => {\n+      if (typeof result !== 'string') {\n+        const { flightData } = result\n         for (const flightDataPath of flightData) {\n           // we only pass the new cache as this function is called after clearing the router cache\n           // and filling in the new page data from the server. Meaning the existing cache is actually the cache that's\n@@ -88,7 +89,7 @@ async function refreshInactiveParallelSegmentsImpl({\n           )\n         }\n       } else {\n-        // When flightData is a string, it suggests that the server response should have triggered an MPA navigation\n+        // When result is a string, it suggests that the server response should have triggered an MPA navigation\n         // I'm not 100% sure of this decision, but it seems unlikely that we'd want to introduce a redirect side effect\n         // when refreshing on-screen data, so handling this has been ommitted.\n       }"
        },
        {
            "sha": "c122648246cfbc07655eb17f038a44493be6f1e5",
            "filename": "packages/next/src/client/components/router-reducer/router-reducer-types.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Frouter-reducer-types.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -25,6 +25,7 @@ export type RouterChangeByServerResponse = ({\n export interface Mutable {\n   mpaNavigation?: boolean\n   patchedTree?: FlightRouterState\n+  renderedSearch?: string\n   canonicalUrl?: string\n   scrollableSegments?: FlightSegmentPath[]\n   pendingPush?: boolean\n@@ -122,7 +123,12 @@ export interface NavigateAction {\n export interface RestoreAction {\n   type: typeof ACTION_RESTORE\n   url: URL\n-  tree: FlightRouterState | undefined\n+  historyState: AppHistoryState | undefined\n+}\n+\n+export type AppHistoryState = {\n+  tree: FlightRouterState\n+  renderedSearch: string\n }\n \n /**\n@@ -219,6 +225,7 @@ export type AppRouterState = {\n    * - This is the url you see in the browser.\n    */\n   canonicalUrl: string\n+  renderedSearch: string\n   /**\n    * The underlying \"url\" representing the UI state, which is used for intercepting routes.\n    */"
        },
        {
            "sha": "5059ba579ce32310dffff7e9210a16d84c29c5ea",
            "filename": "packages/next/src/client/components/segment-cache-impl/navigation.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 19,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -15,7 +15,7 @@ import {\n   listenForDynamicRequest,\n   type Task as PPRNavigationTask,\n } from '../router-reducer/ppr-navigations'\n-import { createHrefFromUrl as createCanonicalUrl } from '../router-reducer/create-href-from-url'\n+import { createHrefFromUrl } from '../router-reducer/create-href-from-url'\n import {\n   EntryStatus,\n   readRouteCacheEntry,\n@@ -48,6 +48,7 @@ type SuccessfulNavigationResult = {\n     flightRouterState: FlightRouterState\n     cacheNode: CacheNode\n     canonicalUrl: string\n+    renderedSearch: string\n     scrollableSegments: Array<FlightSegmentPath>\n     shouldScroll: boolean\n     hash: string\n@@ -123,6 +124,7 @@ export function navigate(\n     const prefetchHead = route.head\n     const isPrefetchHeadPartial = route.isHeadPartial\n     const newCanonicalUrl = route.canonicalUrl\n+    const renderedSearch = route.renderedSearch\n     return navigateUsingPrefetchedRouteTree(\n       now,\n       url,\n@@ -136,6 +138,7 @@ export function navigate(\n       prefetchHead,\n       isPrefetchHeadPartial,\n       newCanonicalUrl,\n+      renderedSearch,\n       shouldScroll,\n       url.hash\n     )\n@@ -164,6 +167,7 @@ export function navigate(\n       const prefetchHead = optimisticRoute.head\n       const isPrefetchHeadPartial = optimisticRoute.isHeadPartial\n       const newCanonicalUrl = optimisticRoute.canonicalUrl\n+      const newRenderedSearch = optimisticRoute.renderedSearch\n       return navigateUsingPrefetchedRouteTree(\n         now,\n         url,\n@@ -177,6 +181,7 @@ export function navigate(\n         prefetchHead,\n         isPrefetchHeadPartial,\n         newCanonicalUrl,\n+        newRenderedSearch,\n         shouldScroll,\n         url.hash\n       )\n@@ -218,6 +223,7 @@ function navigateUsingPrefetchedRouteTree(\n   prefetchHead: HeadData | null,\n   isPrefetchHeadPartial: boolean,\n   canonicalUrl: string,\n+  renderedSearch: string,\n   shouldScroll: boolean,\n   hash: string\n ): SuccessfulNavigationResult | NoOpNavigationResult | MPANavigationResult {\n@@ -259,6 +265,7 @@ function navigateUsingPrefetchedRouteTree(\n       task,\n       currentCacheNode,\n       canonicalUrl,\n+      renderedSearch,\n       scrollableSegments,\n       shouldScroll,\n       hash\n@@ -279,6 +286,7 @@ function navigationTaskToResult(\n   task: PPRNavigationTask,\n   currentCacheNode: CacheNode,\n   canonicalUrl: string,\n+  renderedSearch: string,\n   scrollableSegments: Array<FlightSegmentPath>,\n   shouldScroll: boolean,\n   hash: string\n@@ -299,6 +307,7 @@ function navigationTaskToResult(\n       flightRouterState,\n       cacheNode: newCacheNode !== null ? newCacheNode : currentCacheNode,\n       canonicalUrl,\n+      renderedSearch,\n       scrollableSegments,\n       shouldScroll,\n       hash,\n@@ -431,25 +440,26 @@ async function navigateDynamicallyWithNoPrefetch(\n     flightRouterState: currentFlightRouterState,\n     nextUrl,\n   })\n-  const {\n-    flightData,\n-    canonicalUrl: canonicalUrlOverride,\n-    debugInfo: debugInfoFromResponse,\n-  } = await promiseForDynamicServerResponse\n-\n-  if (debugInfoFromResponse !== null) {\n-    collectedDebugInfo.push(...debugInfoFromResponse)\n-  }\n-\n-  if (typeof flightData === 'string') {\n+  const result = await promiseForDynamicServerResponse\n+  if (typeof result === 'string') {\n     // This is an MPA navigation.\n-    const newUrl = flightData\n+    const newUrl = result\n     return {\n       tag: NavigationResultTag.MPA,\n       data: newUrl,\n     }\n   }\n \n+  const {\n+    flightData,\n+    canonicalUrl,\n+    renderedSearch,\n+    debugInfo: debugInfoFromResponse,\n+  } = result\n+  if (debugInfoFromResponse !== null) {\n+    collectedDebugInfo.push(...debugInfoFromResponse)\n+  }\n+\n   // Since the response format of dynamic requests and prefetches is slightly\n   // different, we'll need to massage the data a bit. Create FlightRouterState\n   // tree that simulates what we'd receive as the result of a prefetch.\n@@ -464,10 +474,6 @@ async function navigateDynamicallyWithNoPrefetch(\n   const prefetchHead = null\n   const isPrefetchHeadPartial = true\n \n-  const canonicalUrl = createCanonicalUrl(\n-    canonicalUrlOverride ? canonicalUrlOverride : url\n-  )\n-\n   // Now we proceed exactly as we would for normal navigation.\n   const scrollableSegments: Array<FlightSegmentPath> = []\n   const task = startPPRNavigation(\n@@ -501,7 +507,8 @@ async function navigateDynamicallyWithNoPrefetch(\n     return navigationTaskToResult(\n       task,\n       currentCacheNode,\n-      canonicalUrl,\n+      createHrefFromUrl(canonicalUrl),\n+      renderedSearch,\n       scrollableSegments,\n       shouldScroll,\n       hash\n@@ -512,7 +519,7 @@ async function navigateDynamicallyWithNoPrefetch(\n   return {\n     tag: NavigationResultTag.NoOp,\n     data: {\n-      canonicalUrl,\n+      canonicalUrl: createHrefFromUrl(canonicalUrl),\n       shouldScroll,\n     },\n   }"
        },
        {
            "sha": "2b2cfe8dde5880df5edc8132ac6a4e3f70e23807",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -1042,6 +1042,28 @@ function prepareInitialCanonicalUrl(url: RequestStore['url']) {\n   return (url.pathname + url.search).split('/')\n }\n \n+function querystringEncode(query: NextParsedUrlQuery): string {\n+  // Inlined implementation of querystring.encode, which is not available in\n+  // the Edge runtime.\n+  const pairs = []\n+  for (const key in query) {\n+    const value = query[key]\n+    if (value == null) continue\n+    if (Array.isArray(value)) {\n+      for (const v of value) {\n+        pairs.push(\n+          `${encodeURIComponent(key)}=${encodeURIComponent(String(v))}`\n+        )\n+      }\n+    } else {\n+      pairs.push(\n+        `${encodeURIComponent(key)}=${encodeURIComponent(String(value))}`\n+      )\n+    }\n+  }\n+  return pairs.join('&')\n+}\n+\n // This is the data necessary to render <AppRouter /> when no SSR errors are encountered\n async function getRSCPayload(\n   tree: LoaderTree,\n@@ -1157,6 +1179,7 @@ async function getRSCPayload(\n     }),\n     b: ctx.sharedContext.buildId,\n     c: prepareInitialCanonicalUrl(url),\n+    q: querystringEncode(query),\n     i: !!couldBeIntercepted,\n     f: [\n       [\n@@ -1282,6 +1305,7 @@ async function getErrorRSCPayload(\n   return {\n     b: ctx.sharedContext.buildId,\n     c: prepareInitialCanonicalUrl(url),\n+    q: querystringEncode(query),\n     m: undefined,\n     i: false,\n     f: [\n@@ -1345,6 +1369,7 @@ function App<T>({\n     navigatedAt: -1,\n     initialFlightData: response.f,\n     initialCanonicalUrlParts: response.c,\n+    initialRenderedSearch: response.q,\n     initialParallelRoutes: new Map(),\n     // location is not initialized in the SSR render\n     // it's set to window.location during hydration\n@@ -1412,6 +1437,7 @@ function ErrorApp<T>({\n     navigatedAt: -1,\n     initialFlightData: response.f,\n     initialCanonicalUrlParts: response.c,\n+    initialRenderedSearch: response.q,\n     initialParallelRoutes: new Map(),\n     // location is not initialized in the SSR render\n     // it's set to window.location during hydration"
        },
        {
            "sha": "58796f0f3c60bc965c6bfe510add6804f35c62d8",
            "filename": "packages/next/src/shared/lib/app-router-types.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5ccc9078e094215e6c891c38a31fb94cda03456e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-types.ts?ref=5ccc9078e094215e6c891c38a31fb94cda03456e",
            "patch": "@@ -262,6 +262,8 @@ export type InitialRSCPayload = {\n   b: string\n   /** initialCanonicalUrlParts */\n   c: string[]\n+  /** initialRenderedSearch */\n+  q: string\n   /** couldBeIntercepted */\n   i: boolean\n   /** initialFlightData */"
        }
    ],
    "stats": {
        "total": 277,
        "additions": 169,
        "deletions": 108
    }
}