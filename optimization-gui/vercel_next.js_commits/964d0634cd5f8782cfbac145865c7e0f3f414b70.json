{
    "author": "acdlite",
    "message": "Fix: createRouterAct \"reject\" config (#81720)\n\nFixes a problem with the internal `createRouterAct` testing helper where\nthe `block: \"reject\"` option would not error correctly, leading to\npotential false negatives. I think I accidentally broke this when I\nadded the ability to provide an array of expected responses.",
    "sha": "964d0634cd5f8782cfbac145865c7e0f3f414b70",
    "files": [
        {
            "sha": "779050902e54817a1d00acc93f53454ccb3126ef",
            "filename": "test/e2e/app-dir/segment-cache/router-act.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 10,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/964d0634cd5f8782cfbac145865c7e0f3f414b70/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/964d0634cd5f8782cfbac145865c7e0f3f414b70/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts?ref=964d0634cd5f8782cfbac145865c7e0f3f414b70",
            "patch": "@@ -72,6 +72,7 @@ export function createRouterAct(\n     }\n \n     let expectedResponses: Array<ExpectedResponseConfig> | null\n+    let forbiddenResponses: Array<ExpectedResponseConfig> | null = null\n     let shouldBlockAll = false\n     if (config === undefined || config === null) {\n       // Default. Expect at least one request, but don't assert on the response.\n@@ -101,6 +102,7 @@ export function createRouterAct(\n         expectedResponses = [config]\n       } else {\n         expectedResponses = []\n+        forbiddenResponses = [config]\n       }\n     } else {\n       expectedResponses = []\n@@ -113,6 +115,12 @@ export function createRouterAct(\n         }\n         if (item.block !== 'reject') {\n           expectedResponses.push(item)\n+        } else {\n+          if (forbiddenResponses === null) {\n+            forbiddenResponses = [item]\n+          } else {\n+            forbiddenResponses.push(item)\n+          }\n         }\n       }\n     }\n@@ -288,24 +296,28 @@ ${fulfilled.body}\n `\n               throw error\n             }\n-            if (expectedResponses !== null) {\n-              let alreadyMatchedByThisResponse: string | null = null\n-              for (const expectedResponse of expectedResponses) {\n-                const includes = expectedResponse.includes\n-                const block = expectedResponse.block\n+            if (forbiddenResponses !== null) {\n+              for (const forbiddenResponse of forbiddenResponses) {\n+                const includes = forbiddenResponse.includes\n                 if (fulfilled.body.includes(includes)) {\n-                  if (block === 'reject') {\n-                    error.message = `\n+                  error.message = `\n Received a response containing an unexpected substring:\n \n Rejected substring: ${includes}\n \n Response:\n ${fulfilled.body}\n `\n-                    throw error\n-                  }\n-\n+                  throw error\n+                }\n+              }\n+            }\n+            if (expectedResponses !== null) {\n+              let alreadyMatchedByThisResponse: string | null = null\n+              for (const expectedResponse of expectedResponses) {\n+                const includes = expectedResponse.includes\n+                const block = expectedResponse.block\n+                if (fulfilled.body.includes(includes)) {\n                   // Match. Don't check yet whether the responses are received\n                   // in the expected order. Instead collect all the matches and\n                   // check at the end so we can include a diff in the"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 22,
        "deletions": 10
    }
}