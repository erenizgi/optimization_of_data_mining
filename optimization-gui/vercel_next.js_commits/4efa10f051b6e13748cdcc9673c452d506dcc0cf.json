{
    "author": "huozhi",
    "message": "[type] dynamic skip generating unused types (#82755)",
    "sha": "4efa10f051b6e13748cdcc9673c452d506dcc0cf",
    "files": [
        {
            "sha": "382e62071d2a5c002bda69140387aa58c266a22c",
            "filename": "packages/next/src/server/lib/router-utils/typegen.ts",
            "status": "modified",
            "additions": 106,
            "deletions": 32,
            "changes": 138,
            "blob_url": "https://github.com/vercel/next.js/blob/4efa10f051b6e13748cdcc9673c452d506dcc0cf/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4efa10f051b6e13748cdcc9673c452d506dcc0cf/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts?ref=4efa10f051b6e13748cdcc9673c452d506dcc0cf",
            "patch": "@@ -22,10 +22,10 @@ function generateRouteTypes(routesManifest: RouteTypesManifest): string {\n     routesManifest.appRouteHandlerRoutes\n   ).sort()\n \n-  if (appRouteHandlerRoutes.length > 0) {\n+  const hasAppRouteHandlers = appRouteHandlerRoutes.length > 0\n+\n+  if (hasAppRouteHandlers) {\n     result += `type AppRouteHandlerRoutes = ${appRouteHandlerRoutes.map((route) => JSON.stringify(route)).join(' | ')}\\n`\n-  } else {\n-    result += 'type AppRouteHandlerRoutes = never\\n'\n   }\n \n   // Generate PageRoutes union type\n@@ -60,8 +60,19 @@ function generateRouteTypes(routesManifest: RouteTypesManifest): string {\n     result += 'type RewriteRoutes = never\\n'\n   }\n \n-  result +=\n-    'type Routes = AppRoutes | AppRouteHandlerRoutes | PageRoutes | LayoutRoutes | RedirectRoutes | RewriteRoutes\\n'\n+  // Only include AppRouteHandlerRoutes in Routes union if there are actual route handlers\n+  const routeUnionParts = [\n+    'AppRoutes',\n+    'PageRoutes',\n+    'LayoutRoutes',\n+    'RedirectRoutes',\n+    'RewriteRoutes',\n+  ]\n+  if (hasAppRouteHandlers) {\n+    routeUnionParts.push('AppRouteHandlerRoutes')\n+  }\n+\n+  result += `type Routes = ${routeUnionParts.join(' | ')}\\n`\n \n   return result\n }\n@@ -427,15 +438,14 @@ export function generateValidatorFile(\n     routesManifest.filePathToRoute\n   )\n \n-  return `// This file is generated automatically by Next.js\n-// Do not edit this file manually\n-// This file validates that all pages and layouts export the correct types\n+  const hasAppRouteHandlers =\n+    Object.keys(routesManifest.appRouteHandlerRoutes).length > 0\n \n-import type { AppRoutes, AppRouteHandlerRoutes, LayoutRoutes, ParamMap } from \"./routes.js\"\n-import type { ResolvingMetadata, ResolvingViewport } from \"next/dist/lib/metadata/types/metadata-interface.js\"\n-import type { NextRequest } from 'next/server.js'\n+  // Build type definitions based on what's actually used\n+  let typeDefinitions = ''\n \n-type AppPageConfig<Route extends AppRoutes = AppRoutes> = {\n+  if (appPageValidations) {\n+    typeDefinitions += `type AppPageConfig<Route extends AppRoutes = AppRoutes> = {\n   default: React.ComponentType<{ params: Promise<ParamMap[Route]> } & any> | ((props: { params: Promise<ParamMap[Route]> } & any) => React.ReactNode | Promise<React.ReactNode> | never | void | Promise<void>)\n   generateStaticParams?: (props: { params: ParamMap[Route] }) => Promise<any[]> | any[]\n   generateMetadata?: (\n@@ -450,7 +460,11 @@ type AppPageConfig<Route extends AppRoutes = AppRoutes> = {\n   viewport?: any\n }\n \n-type PagesPageConfig = {\n+`\n+  }\n+\n+  if (pagesRouterPageValidations) {\n+    typeDefinitions += `type PagesPageConfig = {\n   default: React.ComponentType<any> | ((props: any) => React.ReactNode | Promise<React.ReactNode> | never | void)\n   getStaticProps?: (context: any) => Promise<any> | any\n   getStaticPaths?: (context: any) => Promise<any> | any\n@@ -468,7 +482,11 @@ type PagesPageConfig = {\n   }\n }\n \n-type LayoutConfig<Route extends LayoutRoutes = LayoutRoutes> = {\n+`\n+  }\n+\n+  if (layoutValidations) {\n+    typeDefinitions += `type LayoutConfig<Route extends LayoutRoutes = LayoutRoutes> = {\n   default: React.ComponentType<LayoutProps<Route>> | ((props: LayoutProps<Route>) => React.ReactNode | Promise<React.ReactNode> | never | void | Promise<void>)\n   generateStaticParams?: (props: { params: ParamMap[Route] }) => Promise<any[]> | any[]\n   generateMetadata?: (\n@@ -483,7 +501,11 @@ type LayoutConfig<Route extends LayoutRoutes = LayoutRoutes> = {\n   viewport?: any\n }\n \n-type RouteHandlerConfig<Route extends AppRouteHandlerRoutes = AppRouteHandlerRoutes> = {\n+`\n+  }\n+\n+  if (appRouteHandlerValidations) {\n+    typeDefinitions += `type RouteHandlerConfig<Route extends AppRouteHandlerRoutes = AppRouteHandlerRoutes> = {\n   GET?: (request: NextRequest, context: { params: Promise<ParamMap[Route]> }) => Promise<Response> | Response | Promise<void> | void\n   POST?: (request: NextRequest, context: { params: Promise<ParamMap[Route]> }) => Promise<Response> | Response | Promise<void> | void\n   PUT?: (request: NextRequest, context: { params: Promise<ParamMap[Route]> }) => Promise<Response> | Response | Promise<void> | void\n@@ -493,7 +515,11 @@ type RouteHandlerConfig<Route extends AppRouteHandlerRoutes = AppRouteHandlerRou\n   OPTIONS?: (request: NextRequest, context: { params: Promise<ParamMap[Route]> }) => Promise<Response> | Response | Promise<void> | void\n }\n \n-type ApiRouteConfig = {\n+`\n+  }\n+\n+  if (pagesApiRouteValidations) {\n+    typeDefinitions += `type ApiRouteConfig = {\n   default: (req: any, res: any) => Promise<void> | void | Promise<Response> | Response\n   config?: {\n     api?: {\n@@ -506,6 +532,32 @@ type ApiRouteConfig = {\n   }\n }\n \n+`\n+  }\n+\n+  // Build import statement based on what's actually needed\n+  const routeImports = ['AppRoutes', 'LayoutRoutes', 'ParamMap']\n+  if (hasAppRouteHandlers) {\n+    routeImports.push('AppRouteHandlerRoutes')\n+  }\n+\n+  const routeImportStatement =\n+    routeImports.length > 0\n+      ? `import type { ${routeImports.join(', ')} } from \"./routes.js\"`\n+      : ''\n+\n+  const nextRequestImport = hasAppRouteHandlers\n+    ? \"import type { NextRequest } from 'next/server.js'\\n\"\n+    : ''\n+\n+  return `// This file is generated automatically by Next.js\n+// Do not edit this file manually\n+// This file validates that all pages and layouts export the correct types\n+\n+${routeImportStatement}\n+import type { ResolvingMetadata, ResolvingViewport } from \"next/dist/lib/metadata/types/metadata-interface.js\"\n+${nextRequestImport}\n+${typeDefinitions}\n ${appPageValidations}\n \n ${appRouteHandlerValidations}\n@@ -525,6 +577,42 @@ export function generateRouteTypesFile(\n   const paramTypes = generateParamTypes(routesManifest)\n   const layoutSlotMap = generateLayoutSlotMap(routesManifest)\n \n+  const hasAppRouteHandlers =\n+    Object.keys(routesManifest.appRouteHandlerRoutes).length > 0\n+\n+  // Build export statement based on what's actually generated\n+  const routeExports = [\n+    'AppRoutes',\n+    'PageRoutes',\n+    'LayoutRoutes',\n+    'RedirectRoutes',\n+    'RewriteRoutes',\n+    'ParamMap',\n+  ]\n+  if (hasAppRouteHandlers) {\n+    routeExports.push('AppRouteHandlerRoutes')\n+  }\n+\n+  const exportStatement = `export type { ${routeExports.join(', ')} }`\n+\n+  const routeContextInterface = hasAppRouteHandlers\n+    ? `\n+\n+  /**\n+   * Context for Next.js App Router route handlers\n+   * @example\n+   * \\`\\`\\`tsx\n+   * export async function GET(request: NextRequest, context: RouteContext<'/api/users/[id]'>) {\n+   *   const { id } = await context.params\n+   *   return Response.json({ id })\n+   * }\n+   * \\`\\`\\`\n+   */\n+  interface RouteContext<AppRouteHandlerRoute extends AppRouteHandlerRoutes> {\n+    params: Promise<ParamMap[AppRouteHandlerRoute]>\n+  }`\n+    : ''\n+\n   return `// This file is generated automatically by Next.js\n // Do not edit this file manually\n \n@@ -536,7 +624,7 @@ export type ParamsOf<Route extends Routes> = ParamMap[Route]\n \n ${layoutSlotMap}\n \n-export type { AppRoutes, AppRouteHandlerRoutes, PageRoutes, LayoutRoutes, RedirectRoutes, RewriteRoutes, ParamMap }\n+${exportStatement}\n \n declare global {\n   /**\n@@ -568,21 +656,7 @@ declare global {\n     children: React.ReactNode\n   } & {\n     [K in LayoutSlotMap[LayoutRoute]]: React.ReactNode\n-  }\n-\n-  /**\n-   * Context for Next.js App Router route handlers\n-   * @example\n-   * \\`\\`\\`tsx\n-   * export async function GET(request: NextRequest, context: RouteContext<'/api/users/[id]'>) {\n-   *   const { id } = await context.params\n-   *   return Response.json({ id })\n-   * }\n-   * \\`\\`\\`\n-   */\n-  interface RouteContext<AppRouteHandlerRoute extends AppRouteHandlerRoutes> {\n-    params: Promise<ParamMap[AppRouteHandlerRoute]>\n-  }\n+  }${routeContextInterface}\n }\n `\n }"
        },
        {
            "sha": "728a4daeed41abe6f84587482feac2e2bd56ae8c",
            "filename": "test/e2e/app-dir/typed-routes/typed-routes.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes%2Ftyped-routes.test.ts?ref=4efa10f051b6e13748cdcc9673c452d506dcc0cf",
            "patch": "@@ -7,7 +7,7 @@ type PageRoutes = \"/about\" | \"/users/[id]\"\n type LayoutRoutes = \"/\" | \"/dashboard\"\n type RedirectRoutes = \"/blog/[category]/[[...slug]]\" | \"/project/[slug]\"\n type RewriteRoutes = \"/api-legacy/[version]/[[...endpoint]]\" | \"/docs-old/[...path]\"\n-type Routes = AppRoutes | AppRouteHandlerRoutes | PageRoutes | LayoutRoutes | RedirectRoutes | RewriteRoutes\n+type Routes = AppRoutes | PageRoutes | LayoutRoutes | RedirectRoutes | RewriteRoutes | AppRouteHandlerRoutes\n `\n \n describe('typed-routes', () => {"
        },
        {
            "sha": "b66bc617d0e2ca5003446da59b5c802b3650ed93",
            "filename": "test/production/app-dir/types-gen-nounuselocal/.gitignore",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2F.gitignore",
            "raw_url": "https://github.com/vercel/next.js/raw/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2F.gitignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2F.gitignore?ref=4efa10f051b6e13748cdcc9673c452d506dcc0cf",
            "patch": "@@ -0,0 +1 @@\n+!tsconfig.json\n\\ No newline at end of file"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/production/app-dir/types-gen-nounuselocal/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fapp%2Flayout.tsx?ref=4efa10f051b6e13748cdcc9673c452d506dcc0cf",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/production/app-dir/types-gen-nounuselocal/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fapp%2Fpage.tsx?ref=4efa10f051b6e13748cdcc9673c452d506dcc0cf",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/app-dir/types-gen-nounuselocal/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Fnext.config.js?ref=4efa10f051b6e13748cdcc9673c452d506dcc0cf",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "c0139ea7b976f68e8929d2878b56212d9aeabb77",
            "filename": "test/production/app-dir/types-gen-nounuselocal/tsconfig.json",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Ftsconfig.json?ref=4efa10f051b6e13748cdcc9673c452d506dcc0cf",
            "patch": "@@ -0,0 +1,28 @@\n+{\n+  \"compilerOptions\": {\n+    \"target\": \"ES2017\",\n+    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n+    \"allowJs\": true,\n+    \"skipLibCheck\": true,\n+    \"strict\": true,\n+    \"noEmit\": true,\n+    \"esModuleInterop\": true,\n+    \"module\": \"esnext\",\n+    \"moduleResolution\": \"bundler\",\n+    \"resolveJsonModule\": true,\n+    \"isolatedModules\": true,\n+    \"jsx\": \"preserve\",\n+    \"incremental\": true,\n+    \"noUnusedLocals\": true,\n+    \"plugins\": [\n+      {\n+        \"name\": \"next\"\n+      }\n+    ],\n+    \"paths\": {\n+      \"@/*\": [\"./*\"]\n+    }\n+  },\n+  \"include\": [\"next-env.d.ts\", \"**/*.ts\", \"**/*.tsx\", \".next/types/**/*.ts\"],\n+  \"exclude\": [\"node_modules\", \"**/*.test.ts\", \"**/*.test.tsx\"]\n+}"
        },
        {
            "sha": "81402c1e62b0ee7fa70adaf53e76b4cde0f6276e",
            "filename": "test/production/app-dir/types-gen-nounuselocal/types-gen-nounuselocal.test.ts",
            "status": "added",
            "additions": 91,
            "deletions": 0,
            "changes": 91,
            "blob_url": "https://github.com/vercel/next.js/blob/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Ftypes-gen-nounuselocal.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4efa10f051b6e13748cdcc9673c452d506dcc0cf/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Ftypes-gen-nounuselocal.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Ftypes-gen-nounuselocal%2Ftypes-gen-nounuselocal.test.ts?ref=4efa10f051b6e13748cdcc9673c452d506dcc0cf",
            "patch": "@@ -0,0 +1,91 @@\n+import fsp from 'fs/promises'\n+import path from 'path'\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('types-gen-nounuselocal', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should build successfully', async () => {\n+    const $ = await next.render$('/')\n+    expect($('p').text()).toBe('hello world')\n+  })\n+\n+  it('should generate route types successfully', async () => {\n+    const routeTypes = await fsp.readFile(\n+      path.join(next.testDir, '.next', 'types', 'routes.d.ts'),\n+      'utf-8'\n+    )\n+\n+    expect(routeTypes).not.toContain('AppRouteHandlerRoutes')\n+    expect(routeTypes).not.toContain('PagesPageConfig')\n+    expect(routeTypes).not.toContain('ApiRouteConfig')\n+\n+    expect(routeTypes).toMatchInlineSnapshot(`\n+     \"// This file is generated automatically by Next.js\n+     // Do not edit this file manually\n+\n+     type AppRoutes = \"/\"\n+     type PageRoutes = never\n+     type LayoutRoutes = \"/\"\n+     type RedirectRoutes = never\n+     type RewriteRoutes = never\n+     type Routes = AppRoutes | PageRoutes | LayoutRoutes | RedirectRoutes | RewriteRoutes\n+\n+\n+     interface ParamMap {\n+       \"/\": {}\n+     }\n+\n+\n+     export type ParamsOf<Route extends Routes> = ParamMap[Route]\n+\n+     interface LayoutSlotMap {\n+       \"/\": never\n+     }\n+\n+\n+     export type { AppRoutes, PageRoutes, LayoutRoutes, RedirectRoutes, RewriteRoutes, ParamMap }\n+\n+     declare global {\n+       /**\n+        * Props for Next.js App Router page components\n+        * @example\n+        * \\`\\`\\`tsx\n+        * export default function Page(props: PageProps<'/blog/[slug]'>) {\n+        *   const { slug } = await props.params\n+        *   return <div>Blog post: {slug}</div>\n+        * }\n+        * \\`\\`\\`\n+        */\n+       interface PageProps<AppRoute extends AppRoutes> {\n+         params: Promise<ParamMap[AppRoute]>\n+         searchParams: Promise<Record<string, string | string[] | undefined>>\n+       }\n+\n+       /**\n+        * Props for Next.js App Router layout components\n+        * @example\n+        * \\`\\`\\`tsx\n+        * export default function Layout(props: LayoutProps<'/dashboard'>) {\n+        *   return <div>{props.children}</div>\n+        * }\n+        * \\`\\`\\`\n+        */\n+       type LayoutProps<LayoutRoute extends LayoutRoutes> = {\n+         params: Promise<ParamMap[LayoutRoute]>\n+         children: React.ReactNode\n+       } & {\n+         [K in LayoutSlotMap[LayoutRoute]]: React.ReactNode\n+       }\n+     }\n+     \"\n+    `)\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 277,
        "additions": 244,
        "deletions": 33
    }
}