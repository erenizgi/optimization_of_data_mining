{
    "author": "wbinnssmith",
    "message": "Use `compilation.{emitAsset,updateAsset}` api rather than mutating `assets` object (#75927)",
    "sha": "a90f0c91d6063d25be513779cb21fb8892ba4201",
    "files": [
        {
            "sha": "df6be066b74104381109c4a94d090de4984d3c5b",
            "filename": "packages/next/src/build/webpack/plugins/app-build-manifest-plugin.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fapp-build-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fapp-build-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fapp-build-manifest-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -31,12 +31,12 @@ export class AppBuildManifestPlugin {\n           name: PLUGIN_NAME,\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n         },\n-        (assets: any) => this.createAsset(assets, compilation)\n+        () => this.createAsset(compilation)\n       )\n     })\n   }\n \n-  private createAsset(assets: any, compilation: webpack.Compilation) {\n+  private createAsset(compilation: webpack.Compilation) {\n     const manifest: AppBuildManifest = {\n       pages: {},\n     }\n@@ -67,6 +67,9 @@ export class AppBuildManifestPlugin {\n \n     const json = JSON.stringify(manifest, null, 2)\n \n-    assets[APP_BUILD_MANIFEST] = new sources.RawSource(json)\n+    compilation.emitAsset(\n+      APP_BUILD_MANIFEST,\n+      new sources.RawSource(json) as unknown as webpack.sources.RawSource\n+    )\n   }\n }"
        },
        {
            "sha": "562388296b230389007ae5b11004b1931de6fa86",
            "filename": "packages/next/src/build/webpack/plugins/build-manifest-plugin.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 20,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fbuild-manifest-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -200,7 +200,7 @@ export default class BuildManifestPlugin {\n     this.rewrites.fallback = options.rewrites.fallback.map(processRoute)\n   }\n \n-  createAssets(compiler: any, compilation: any, assets: any) {\n+  createAssets(compiler: any, compilation: any) {\n     const compilationSpan = spans.get(compilation) || spans.get(compiler)\n     const createAssetsSpan = compilationSpan?.traceChild(\n       'NextJsBuildManifest-createassets'\n@@ -297,7 +297,10 @@ export default class BuildManifestPlugin {\n           this.buildId\n         )\n         assetMap.lowPriorityFiles.push(buildManifestPath, ssgManifestPath)\n-        assets[ssgManifestPath] = new sources.RawSource(srcEmptySsgManifest)\n+        compilation.emitAsset(\n+          ssgManifestPath,\n+          new sources.RawSource(srcEmptySsgManifest)\n+        )\n       }\n \n       assetMap.pages = Object.keys(assetMap.pages)\n@@ -314,29 +317,30 @@ export default class BuildManifestPlugin {\n         buildManifestName = `fallback-${BUILD_MANIFEST}`\n       }\n \n-      assets[buildManifestName] = new sources.RawSource(\n-        JSON.stringify(assetMap, null, 2)\n+      compilation.emitAsset(\n+        buildManifestName,\n+        new sources.RawSource(JSON.stringify(assetMap, null, 2))\n       )\n \n-      assets[`server/${MIDDLEWARE_BUILD_MANIFEST}.js`] = new sources.RawSource(\n-        `${createEdgeRuntimeManifest(assetMap)}`\n+      compilation.emitAsset(\n+        `server/${MIDDLEWARE_BUILD_MANIFEST}.js`,\n+        new sources.RawSource(`${createEdgeRuntimeManifest(assetMap)}`)\n       )\n \n       if (!this.isDevFallback) {\n-        const clientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n-\n-        assets[clientManifestPath] = new sources.RawSource(\n-          `self.__BUILD_MANIFEST = ${generateClientManifest(\n-            assetMap,\n-            this.rewrites,\n-            this.clientRouterFilters,\n-            compiler,\n-            compilation\n-          )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n+        compilation.emitAsset(\n+          `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`,\n+          new sources.RawSource(\n+            `self.__BUILD_MANIFEST = ${generateClientManifest(\n+              assetMap,\n+              this.rewrites,\n+              this.clientRouterFilters,\n+              compiler,\n+              compilation\n+            )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n+          )\n         )\n       }\n-\n-      return assets\n     })\n   }\n \n@@ -347,8 +351,8 @@ export default class BuildManifestPlugin {\n           name: 'NextJsBuildManifest',\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n         },\n-        (assets: any) => {\n-          this.createAssets(compiler, compilation, assets)\n+        () => {\n+          this.createAssets(compiler, compilation)\n         }\n       )\n     })"
        },
        {
            "sha": "798ba865c28b17d7792516e442b82236a62ed913",
            "filename": "packages/next/src/build/webpack/plugins/css-minimizer-plugin.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fcss-minimizer-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fcss-minimizer-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fcss-minimizer-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -79,24 +79,22 @@ export class CssMinimizerPlugin {\n                   assetSpan.setAttribute('file', file)\n \n                   return assetSpan.traceAsyncFn(async () => {\n-                    const asset = assets[file]\n-\n-                    const etag = cache.getLazyHashedEtag(asset)\n-\n+                    const assetSource = compilation.getAsset(file).source\n+                    const etag = cache.getLazyHashedEtag(assetSource)\n                     const cachedResult = await cache.getPromise(file, etag)\n \n                     assetSpan.setAttribute(\n                       'cache',\n                       cachedResult ? 'HIT' : 'MISS'\n                     )\n                     if (cachedResult) {\n-                      assets[file] = cachedResult\n+                      compilation.updateAsset(file, cachedResult)\n                       return\n                     }\n \n-                    const result = await this.optimizeAsset(file, asset)\n+                    const result = await this.optimizeAsset(file, assetSource)\n                     await cache.storePromise(file, etag, result)\n-                    assets[file] = result\n+                    compilation.updateAsset(file, result)\n                   })\n                 })\n             )"
        },
        {
            "sha": "fbdd6961015e645c107f3a35a49bf9668ee101fe",
            "filename": "packages/next/src/build/webpack/plugins/flight-client-entry-plugin.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -263,7 +263,7 @@ export class FlightClientEntryPlugin {\n           name: PLUGIN_NAME,\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_HASH,\n         },\n-        (assets) => this.createActionAssets(compilation, assets)\n+        () => this.createActionAssets(compilation)\n       )\n     })\n   }\n@@ -976,10 +976,7 @@ export class FlightClientEntryPlugin {\n     })\n   }\n \n-  async createActionAssets(\n-    compilation: webpack.Compilation,\n-    assets: webpack.Compilation['assets']\n-  ) {\n+  async createActionAssets(compilation: webpack.Compilation) {\n     const serverActions: ActionManifest['node'] = {}\n     const edgeServerActions: ActionManifest['edge'] = {}\n \n@@ -1052,12 +1049,16 @@ export class FlightClientEntryPlugin {\n       this.dev ? 2 : undefined\n     )\n \n-    assets[`${this.assetPrefix}${SERVER_REFERENCE_MANIFEST}.js`] =\n+    compilation.emitAsset(\n+      `${this.assetPrefix}${SERVER_REFERENCE_MANIFEST}.js`,\n       new sources.RawSource(\n         `self.__RSC_SERVER_MANIFEST=${JSON.stringify(edgeJson)}`\n       ) as unknown as webpack.sources.RawSource\n-    assets[`${this.assetPrefix}${SERVER_REFERENCE_MANIFEST}.json`] =\n+    )\n+    compilation.emitAsset(\n+      `${this.assetPrefix}${SERVER_REFERENCE_MANIFEST}.json`,\n       new sources.RawSource(json) as unknown as webpack.sources.RawSource\n+    )\n   }\n }\n "
        },
        {
            "sha": "8c10a68229173caa0a22a165107b54596de630fe",
            "filename": "packages/next/src/build/webpack/plugins/flight-manifest-plugin.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 14,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -231,16 +231,12 @@ export class ClientReferenceManifestPlugin {\n           // asset hash via extract mini css plugin.\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_HASH,\n         },\n-        (assets) => this.createAsset(assets, compilation, compiler.context)\n+        () => this.createAsset(compilation, compiler.context)\n       )\n     })\n   }\n \n-  createAsset(\n-    assets: webpack.Compilation['assets'],\n-    compilation: webpack.Compilation,\n-    context: string\n-  ) {\n+  createAsset(compilation: webpack.Compilation, context: string) {\n     const manifestsPerGroup = new Map<string, ClientReferenceManifest[]>()\n     const manifestEntryFiles: string[] = []\n \n@@ -305,7 +301,7 @@ export class ClientReferenceManifestPlugin {\n         .getFiles()\n         .filter((f) => !f.startsWith('static/css/pages/') && f.endsWith('.css'))\n         .map((file) => {\n-          const source = compilation.assets[file].source()\n+          const source = compilation.getAsset(file)!.source.source()\n           if (\n             this.experimentalInlineCss &&\n             // Inline CSS currently does not work properly with HMR, so we only\n@@ -599,13 +595,14 @@ export class ClientReferenceManifestPlugin {\n \n       const pagePath = pageName.replace(/%5F/g, '_')\n       const pageBundlePath = normalizePagePath(pagePath.slice('app'.length))\n-      assets[\n-        'server/app' + pageBundlePath + '_' + CLIENT_REFERENCE_MANIFEST + '.js'\n-      ] = new sources.RawSource(\n-        `globalThis.__RSC_MANIFEST=(globalThis.__RSC_MANIFEST||{});globalThis.__RSC_MANIFEST[${JSON.stringify(\n-          pagePath.slice('app'.length)\n-        )}]=${json}`\n-      ) as unknown as webpack.sources.RawSource\n+      compilation.emitAsset(\n+        'server/app' + pageBundlePath + '_' + CLIENT_REFERENCE_MANIFEST + '.js',\n+        new sources.RawSource(\n+          `globalThis.__RSC_MANIFEST=(globalThis.__RSC_MANIFEST||{});globalThis.__RSC_MANIFEST[${JSON.stringify(\n+            pagePath.slice('app'.length)\n+          )}]=${json}`\n+        ) as unknown as webpack.sources.RawSource\n+      )\n     }\n   }\n }"
        },
        {
            "sha": "a780cc1e966dc50f6cb1863537504acb94c76390",
            "filename": "packages/next/src/build/webpack/plugins/middleware-plugin.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 8,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -154,7 +154,7 @@ function getCreateAssets(params: {\n   opts: Options\n }) {\n   const { compilation, metadataByEntry, opts } = params\n-  return (assets: any) => {\n+  return () => {\n     const middlewareManifest: MiddlewareManifest = {\n       version: MANIFEST_VERSION,\n       middleware: {},\n@@ -171,11 +171,14 @@ function getCreateAssets(params: {\n     const interceptionRewrites = JSON.stringify(\n       opts.rewrites.beforeFiles.filter(isInterceptionRouteRewrite)\n     )\n-    assets[`${INTERCEPTION_ROUTE_REWRITE_MANIFEST}.js`] = new sources.RawSource(\n-      `self.__INTERCEPTION_ROUTE_REWRITE_MANIFEST=${JSON.stringify(\n-        interceptionRewrites\n-      )}`\n-    ) as unknown as webpack.sources.RawSource\n+    compilation.emitAsset(\n+      `${INTERCEPTION_ROUTE_REWRITE_MANIFEST}.js`,\n+      new sources.RawSource(\n+        `self.__INTERCEPTION_ROUTE_REWRITE_MANIFEST=${JSON.stringify(\n+          interceptionRewrites\n+        )}`\n+      ) as unknown as webpack.sources.RawSource\n+    )\n \n     for (const entrypoint of compilation.entrypoints.values()) {\n       if (!entrypoint.name) {\n@@ -242,8 +245,11 @@ function getCreateAssets(params: {\n       Object.keys(middlewareManifest.middleware)\n     )\n \n-    assets[MIDDLEWARE_MANIFEST] = new sources.RawSource(\n-      JSON.stringify(middlewareManifest, null, 2)\n+    compilation.emitAsset(\n+      MIDDLEWARE_MANIFEST,\n+      new sources.RawSource(\n+        JSON.stringify(middlewareManifest, null, 2)\n+      ) as unknown as webpack.sources.RawSource\n     )\n   }\n }"
        },
        {
            "sha": "2172e335375262904b2a3c452a155ca8b24adb21",
            "filename": "packages/next/src/build/webpack/plugins/next-font-manifest-plugin.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-font-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-font-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-font-manifest-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -67,7 +67,7 @@ export class NextFontManifestPlugin {\n           name: PLUGIN_NAME,\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n         },\n-        (assets: any) => {\n+        () => {\n           const nextFontManifest: NextFontManifest = {\n             pages: {},\n             app: {},\n@@ -156,12 +156,19 @@ export class NextFontManifestPlugin {\n \n           const manifest = JSON.stringify(nextFontManifest, null)\n           // Create manifest for edge\n-          assets[`server/${NEXT_FONT_MANIFEST}.js`] = new sources.RawSource(\n-            `self.__NEXT_FONT_MANIFEST=${JSON.stringify(manifest)}`\n+          compilation.emitAsset(\n+            `server/${NEXT_FONT_MANIFEST}.js`,\n+            new sources.RawSource(\n+              `self.__NEXT_FONT_MANIFEST=${JSON.stringify(manifest)}`\n+            ) as unknown as webpack.sources.RawSource\n           )\n+\n           // Create manifest for server\n-          assets[`server/${NEXT_FONT_MANIFEST}.json`] = new sources.RawSource(\n-            manifest\n+          compilation.emitAsset(\n+            `server/${NEXT_FONT_MANIFEST}.json`,\n+            new sources.RawSource(\n+              manifest\n+            ) as unknown as webpack.sources.RawSource\n           )\n         }\n       )"
        },
        {
            "sha": "b4efaa31167fc6b4c025fa7d0de4579a759a8b60",
            "filename": "packages/next/src/build/webpack/plugins/next-trace-entrypoints-plugin.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 16,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -174,11 +174,7 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n \n   // Here we output all traced assets and webpack chunks to a\n   // ${page}.js.nft.json file\n-  async createTraceAssets(\n-    compilation: webpack.Compilation,\n-    assets: any,\n-    span: Span\n-  ) {\n+  async createTraceAssets(compilation: webpack.Compilation, span: Span) {\n     const outputPath = compilation.outputOptions.path || ''\n \n     await span.traceChild('create-trace-assets').traceAsyncFn(async () => {\n@@ -292,11 +288,14 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n           })\n         )\n \n-        assets[traceOutputName] = new sources.RawSource(\n-          JSON.stringify({\n-            version: TRACE_OUTPUT_VERSION,\n-            files: finalFiles,\n-          })\n+        compilation.emitAsset(\n+          traceOutputName,\n+          new sources.RawSource(\n+            JSON.stringify({\n+              version: TRACE_OUTPUT_VERSION,\n+              files: finalFiles,\n+            })\n+          ) as unknown as webpack.sources.RawSource\n         )\n       }\n     })\n@@ -631,12 +630,8 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n             name: PLUGIN_NAME,\n             stage: webpack.Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE,\n           },\n-          (assets: any, callback: any) => {\n-            this.createTraceAssets(\n-              compilation,\n-              assets,\n-              traceEntrypointsPluginSpan\n-            )\n+          (_, callback: any) => {\n+            this.createTraceAssets(compilation, traceEntrypointsPluginSpan)\n               .then(() => callback())\n               .catch((err) => callback(err))\n           }"
        },
        {
            "sha": "baaa75f2a9601861670bc6a4d76c32d8163687fd",
            "filename": "packages/next/src/build/webpack/plugins/next-types-plugin/index.ts",
            "status": "modified",
            "additions": 56,
            "deletions": 32,
            "changes": 88,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -754,13 +754,13 @@ function createCustomCacheLifeDefinitions(cacheLife: {\n     /**\n      * Cache this \\`\"use cache\"\\` using a custom timespan.\n      * \\`\\`\\`\n-     *   stale: ... // seconds \n+     *   stale: ... // seconds\n      *   revalidate: ... // seconds\n      *   expire: ... // seconds\n      * \\`\\`\\`\n-     * \n+     *\n      * This is similar to Cache-Control: max-age=\\`stale\\`,s-max-age=\\`revalidate\\`,stale-while-revalidate=\\`expire-revalidate\\`\n-     * \n+     *\n      * If a value is left out, the lowest of other cacheLife() calls or the default, is used instead.\n      */\n     export function unstable_cacheLife(profile: {\n@@ -898,7 +898,10 @@ export class NextTypesPlugin {\n         ? '..'\n         : '../..'\n \n-    const handleModule = async (mod: webpack.NormalModule, assets: any) => {\n+    const handleModule = async (\n+      mod: webpack.NormalModule,\n+      compilation: webpack.Compilation\n+    ) => {\n       if (!mod.resource) return\n \n       const pageExtensionsRegex = new RegExp(\n@@ -970,23 +973,32 @@ export class NextTypesPlugin {\n         pluginState.collectedRootParams[rootLayoutPath] = foundParams\n \n         const slots = await collectNamedSlots(mod.resource)\n-        assets[assetPath] = new sources.RawSource(\n-          createTypeGuardFile(mod.resource, relativeImportPath, {\n-            type: 'layout',\n-            slots,\n-          })\n+        compilation.emitAsset(\n+          assetPath,\n+          new sources.RawSource(\n+            createTypeGuardFile(mod.resource, relativeImportPath, {\n+              type: 'layout',\n+              slots,\n+            })\n+          ) as unknown as webpack.sources.RawSource\n         )\n       } else if (IS_PAGE) {\n-        assets[assetPath] = new sources.RawSource(\n-          createTypeGuardFile(mod.resource, relativeImportPath, {\n-            type: 'page',\n-          })\n+        compilation.emitAsset(\n+          assetPath,\n+          new sources.RawSource(\n+            createTypeGuardFile(mod.resource, relativeImportPath, {\n+              type: 'page',\n+            })\n+          ) as unknown as webpack.sources.RawSource\n         )\n       } else if (IS_ROUTE) {\n-        assets[assetPath] = new sources.RawSource(\n-          createTypeGuardFile(mod.resource, relativeImportPath, {\n-            type: 'route',\n-          })\n+        compilation.emitAsset(\n+          assetPath,\n+          new sources.RawSource(\n+            createTypeGuardFile(mod.resource, relativeImportPath, {\n+              type: 'route',\n+            })\n+          ) as unknown as webpack.sources.RawSource\n         )\n       }\n     }\n@@ -997,7 +1009,7 @@ export class NextTypesPlugin {\n           name: PLUGIN_NAME,\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_HASH,\n         },\n-        async (assets, callback) => {\n+        async (_, callback) => {\n           const promises: Promise<any>[] = []\n \n           // Clear routes\n@@ -1030,15 +1042,15 @@ export class NextTypesPlugin {\n                   chunk\n                 ) as Iterable<webpack.NormalModule>\n               for (const mod of chunkModules) {\n-                promises.push(handleModule(mod, assets))\n+                promises.push(handleModule(mod, compilation))\n \n                 // If this is a concatenation, register each child to the parent ID.\n                 const anyModule = mod as unknown as {\n                   modules: webpack.NormalModule[]\n                 }\n                 if (anyModule.modules) {\n                   anyModule.modules.forEach((concatenatedMod) => {\n-                    promises.push(handleModule(concatenatedMod, assets))\n+                    promises.push(handleModule(concatenatedMod, compilation))\n                   })\n                 }\n               }\n@@ -1058,9 +1070,12 @@ export class NextTypesPlugin {\n               'types/server.d.ts'\n             )\n \n-            assets[serverTypesPath] = new sources.RawSource(\n-              createServerDefinitions(rootParams)\n-            ) as unknown as webpack.sources.RawSource\n+            compilation.emitAsset(\n+              serverTypesPath,\n+              new sources.RawSource(\n+                createServerDefinitions(rootParams)\n+              ) as unknown as webpack.sources.RawSource\n+            )\n           }\n \n           // Support `\"moduleResolution\": \"Node16\" | \"NodeNext\"` with `\"type\": \"module\"`\n@@ -1070,9 +1085,12 @@ export class NextTypesPlugin {\n             'types/package.json'\n           )\n \n-          assets[packageJsonAssetPath] = new sources.RawSource(\n-            '{\"type\": \"module\"}'\n-          ) as unknown as webpack.sources.RawSource\n+          compilation.emitAsset(\n+            packageJsonAssetPath,\n+            new sources.RawSource(\n+              '{\"type\": \"module\"}'\n+            ) as unknown as webpack.sources.RawSource\n+          )\n \n           if (this.typedRoutes) {\n             if (this.dev && !this.isEdgeServer) {\n@@ -1083,9 +1101,12 @@ export class NextTypesPlugin {\n \n             const linkAssetPath = path.join(assetDirRelative, 'types/link.d.ts')\n \n-            assets[linkAssetPath] = new sources.RawSource(\n-              createRouteDefinitions()\n-            ) as unknown as webpack.sources.RawSource\n+            compilation.emitAsset(\n+              linkAssetPath,\n+              new sources.RawSource(\n+                createRouteDefinitions()\n+              ) as unknown as webpack.sources.RawSource\n+            )\n           }\n \n           if (this.cacheLifeConfig) {\n@@ -1094,9 +1115,12 @@ export class NextTypesPlugin {\n               'types/cache-life.d.ts'\n             )\n \n-            assets[cacheLifeAssetPath] = new sources.RawSource(\n-              createCustomCacheLifeDefinitions(this.cacheLifeConfig)\n-            ) as unknown as webpack.sources.RawSource\n+            compilation.emitAsset(\n+              cacheLifeAssetPath,\n+              new sources.RawSource(\n+                createCustomCacheLifeDefinitions(this.cacheLifeConfig)\n+              ) as unknown as webpack.sources.RawSource\n+            )\n           }\n \n           callback()"
        },
        {
            "sha": "8fe8e3deebce32bbaba554f68eacd22cf0d966b3",
            "filename": "packages/next/src/build/webpack/plugins/pages-manifest-plugin.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 21,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fpages-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fpages-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fpages-manifest-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -43,7 +43,7 @@ export default class PagesManifestPlugin\n     this.appDirEnabled = appDirEnabled\n   }\n \n-  async createAssets(compilation: any, assets: any) {\n+  async createAssets(compilation: any) {\n     const entrypoints = compilation.entrypoints\n     const pages: PagesManifest = {}\n     const appPaths: PagesManifest = {}\n@@ -134,14 +134,17 @@ export default class PagesManifestPlugin\n     } else {\n       const pagesManifestPath =\n         (!this.dev && !this.isEdgeRuntime ? '../' : '') + PAGES_MANIFEST\n-      assets[pagesManifestPath] = new sources.RawSource(\n-        JSON.stringify(\n-          {\n-            ...edgeServerPages,\n-            ...nodeServerPages,\n-          },\n-          null,\n-          2\n+      compilation.emitAsset(\n+        pagesManifestPath,\n+        new sources.RawSource(\n+          JSON.stringify(\n+            {\n+              ...edgeServerPages,\n+              ...nodeServerPages,\n+            },\n+            null,\n+            2\n+          )\n         )\n       )\n     }\n@@ -158,17 +161,18 @@ export default class PagesManifestPlugin\n           ...nodeServerAppPaths,\n         })\n       } else {\n-        assets[\n-          (!this.dev && !this.isEdgeRuntime ? '../' : '') + APP_PATHS_MANIFEST\n-        ] = new sources.RawSource(\n-          JSON.stringify(\n-            {\n-              ...edgeServerAppPaths,\n-              ...nodeServerAppPaths,\n-            },\n-            null,\n-            2\n-          )\n+        compilation.emitAsset(\n+          (!this.dev && !this.isEdgeRuntime ? '../' : '') + APP_PATHS_MANIFEST,\n+          new sources.RawSource(\n+            JSON.stringify(\n+              {\n+                ...edgeServerAppPaths,\n+                ...nodeServerAppPaths,\n+              },\n+              null,\n+              2\n+            )\n+          ) as unknown as webpack.sources.RawSource\n         )\n       }\n     }\n@@ -181,7 +185,7 @@ export default class PagesManifestPlugin\n           name: 'NextJsPagesManifest',\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n         },\n-        (assets) => this.createAssets(compilation, assets)\n+        () => this.createAssets(compilation)\n       )\n     })\n   }"
        },
        {
            "sha": "dc4f23748a333ac6fd76c82ada9256cb83ccf8dc",
            "filename": "packages/next/src/build/webpack/plugins/react-loadable-plugin.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 17,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Freact-loadable-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Freact-loadable-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Freact-loadable-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -186,7 +186,7 @@ export class ReactLoadablePlugin {\n     this.dev = opts.dev\n   }\n \n-  createAssets(compiler: any, compilation: any, assets: any) {\n+  createAssets(compiler: any, compilation: any) {\n     const projectSrcDir = this.pagesOrAppDir\n       ? path.dirname(this.pagesOrAppDir)\n       : undefined\n@@ -199,33 +199,41 @@ export class ReactLoadablePlugin {\n       shouldCreateDynamicCssManifest\n     )\n \n-    assets[this.filename] = new sources.RawSource(\n-      JSON.stringify(reactLoadableManifest, null, 2)\n+    compilation.emitAsset(\n+      this.filename,\n+      new sources.RawSource(JSON.stringify(reactLoadableManifest, null, 2))\n     )\n+\n     if (this.runtimeAsset) {\n-      assets[this.runtimeAsset] = new sources.RawSource(\n-        `self.__REACT_LOADABLE_MANIFEST=${JSON.stringify(\n-          JSON.stringify(reactLoadableManifest)\n-        )}`\n+      compilation.emitAsset(\n+        this.runtimeAsset,\n+        new sources.RawSource(\n+          `self.__REACT_LOADABLE_MANIFEST=${JSON.stringify(\n+            JSON.stringify(reactLoadableManifest)\n+          )}`\n+        )\n       )\n     }\n \n     // This manifest prevents removing server rendered <link> tags after client\n     // navigation. This is only needed under Pages dir && Production && Webpack.\n     // x-ref: https://github.com/vercel/next.js/pull/72959\n     if (shouldCreateDynamicCssManifest) {\n-      assets[`${DYNAMIC_CSS_MANIFEST}.json`] = new sources.RawSource(\n-        JSON.stringify(dynamicCssManifest, null, 2)\n+      compilation.emitAsset(\n+        `${DYNAMIC_CSS_MANIFEST}.json`,\n+        new sources.RawSource(JSON.stringify(dynamicCssManifest, null, 2))\n       )\n+\n       // This is for edge runtime.\n-      assets[`server/${DYNAMIC_CSS_MANIFEST}.js`] = new sources.RawSource(\n-        `self.__DYNAMIC_CSS_MANIFEST=${JSON.stringify(\n-          JSON.stringify(dynamicCssManifest)\n-        )}`\n+      compilation.emitAsset(\n+        `server/${DYNAMIC_CSS_MANIFEST}.js`,\n+        new sources.RawSource(\n+          `self.__DYNAMIC_CSS_MANIFEST=${JSON.stringify(\n+            JSON.stringify(dynamicCssManifest)\n+          )}`\n+        )\n       )\n     }\n-\n-    return assets\n   }\n \n   apply(compiler: webpack.Compiler) {\n@@ -235,8 +243,8 @@ export class ReactLoadablePlugin {\n           name: 'ReactLoadableManifest',\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n         },\n-        (assets: any) => {\n-          this.createAssets(compiler, compilation, assets)\n+        () => {\n+          this.createAssets(compiler, compilation)\n         }\n       )\n     })"
        },
        {
            "sha": "43b9a4d20e6ebd049734a41000595e5c8b77dfea",
            "filename": "packages/next/src/build/webpack/plugins/subresource-integrity-plugin.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 13,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fsubresource-integrity-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a90f0c91d6063d25be513779cb21fb8892ba4201/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fsubresource-integrity-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fsubresource-integrity-plugin.ts?ref=a90f0c91d6063d25be513779cb21fb8892ba4201",
            "patch": "@@ -16,7 +16,7 @@ export class SubresourceIntegrityPlugin {\n           name: PLUGIN_NAME,\n           stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n         },\n-        (assets) => {\n+        () => {\n           // Collect all the assets.\n           let files = new Set<string>()\n           for (const asset of compilation.getAssets()) {\n@@ -27,13 +27,13 @@ export class SubresourceIntegrityPlugin {\n           const hashes: Record<string, string> = {}\n           for (const file of files.values()) {\n             // Get the buffer for the asset.\n-            const asset = assets[file]\n+            const asset = compilation.getAsset(file)\n             if (!asset) {\n               throw new Error(`could not get asset: ${file}`)\n             }\n \n             // Get the buffer for the asset.\n-            const buffer = asset.buffer()\n+            const buffer = asset.source.buffer()\n \n             // Create the hash for the content.\n             const hash = crypto\n@@ -47,16 +47,22 @@ export class SubresourceIntegrityPlugin {\n \n           const json = JSON.stringify(hashes, null, 2)\n           const file = 'server/' + SUBRESOURCE_INTEGRITY_MANIFEST\n-          assets[file + '.js'] = new sources.RawSource(\n-            `self.__SUBRESOURCE_INTEGRITY_MANIFEST=${JSON.stringify(json)}`\n-            // Work around webpack 4 type of RawSource being used\n-            // TODO: use webpack 5 type by default\n-          ) as unknown as webpack.sources.RawSource\n-          assets[file + '.json'] = new sources.RawSource(\n-            json\n-            // Work around webpack 4 type of RawSource being used\n-            // TODO: use webpack 5 type by default\n-          ) as unknown as webpack.sources.RawSource\n+          compilation.emitAsset(\n+            file + '.js',\n+            new sources.RawSource(\n+              `self.__SUBRESOURCE_INTEGRITY_MANIFEST=${JSON.stringify(json)}`\n+              // Work around webpack 4 type of RawSource being used\n+              // TODO: use webpack 5 type by default\n+            ) as unknown as webpack.sources.RawSource\n+          )\n+          compilation.emitAsset(\n+            file + '.json',\n+            new sources.RawSource(\n+              json\n+              // Work around webpack 4 type of RawSource being used\n+              // TODO: use webpack 5 type by default\n+            ) as unknown as webpack.sources.RawSource\n+          )\n         }\n       )\n     })"
        }
    ],
    "stats": {
        "total": 379,
        "additions": 216,
        "deletions": 163
    }
}