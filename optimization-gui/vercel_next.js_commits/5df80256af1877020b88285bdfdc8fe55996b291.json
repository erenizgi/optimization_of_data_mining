{
    "author": "unstubbable",
    "message": "Slightly improve error handling for unknown server actions (#77135)\n\nThis fixes the following error when retrieving a non-existent server\naction from the server reference manifest:\n`Cannot read properties of undefined (reading 'workers')`.\n\nWe're also removing the original error from the error message with this\nPR, as there shouldn't be an original error anymore. The result will\njust be `undefined`.",
    "sha": "5df80256af1877020b88285bdfdc8fe55996b291",
    "files": [
        {
            "sha": "9abef967a74356ffc8067959b613ad11d144a1b0",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5df80256af1877020b88285bdfdc8fe55996b291/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5df80256af1877020b88285bdfdc8fe55996b291/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=5df80256af1877020b88285bdfdc8fe55996b291",
            "patch": "@@ -661,5 +661,7 @@\n   \"660\": \"Rspack support is only available in Next.js canary.\",\n   \"661\": \"Build failed because of %s errors\",\n   \"662\": \"Invariant failed to find webpack runtime chunk\",\n-  \"663\": \"Invariant: client chunk changed but failed to detect hash %s\"\n+  \"663\": \"Invariant: client chunk changed but failed to detect hash %s\",\n+  \"664\": \"Missing 'next-action' header.\",\n+  \"665\": \"Failed to find Server Action \\\"%s\\\". This request might be from an older or newer deployment.\\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\"\n }"
        },
        {
            "sha": "ab5cf2dc93732c13da177f48257d612991b83983",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 17,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/5df80256af1877020b88285bdfdc8fe55996b291/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5df80256af1877020b88285bdfdc8fe55996b291/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=5df80256af1877020b88285bdfdc8fe55996b291",
            "patch": "@@ -48,6 +48,7 @@ import { RedirectStatusCode } from '../../client/components/redirect-status-code\n import { synchronizeMutableCookies } from '../async-storage/request-store'\n import type { TemporaryReferenceSet } from 'react-server-dom-webpack/server.edge'\n import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n \n function formDataFromSearchQueryString(query: string) {\n   const searchParams = new URLSearchParams(query)\n@@ -1058,26 +1059,18 @@ function getActionModIdOrError(\n   actionId: string | null,\n   serverModuleMap: ServerModuleMap\n ): string {\n-  try {\n-    // if we're missing the action ID header, we can't do any further processing\n-    if (!actionId) {\n-      throw new Error(\"Invariant: Missing 'next-action' header.\")\n-    }\n+  // if we're missing the action ID header, we can't do any further processing\n+  if (!actionId) {\n+    throw new InvariantError(\"Missing 'next-action' header.\")\n+  }\n \n-    const actionModId = serverModuleMap?.[actionId]?.id\n+  const actionModId = serverModuleMap[actionId]?.id\n \n-    if (!actionModId) {\n-      throw new Error(\n-        \"Invariant: Couldn't find action module ID from module map.\"\n-      )\n-    }\n-\n-    return actionModId\n-  } catch (err) {\n+  if (!actionModId) {\n     throw new Error(\n-      `Failed to find Server Action \"${actionId}\". This request might be from an older or newer deployment. ${\n-        err instanceof Error ? `Original error: ${err.message}` : ''\n-      }\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action`\n+      `Failed to find Server Action \"${actionId}\". This request might be from an older or newer deployment.\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action`\n     )\n   }\n+\n+  return actionModId\n }"
        },
        {
            "sha": "12ca7706da0d059900107a92da85d7c27f87880a",
            "filename": "packages/next/src/server/app-render/action-utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5df80256af1877020b88285bdfdc8fe55996b291/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5df80256af1877020b88285bdfdc8fe55996b291/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-utils.ts?ref=5df80256af1877020b88285bdfdc8fe55996b291",
            "patch": "@@ -20,7 +20,11 @@ export function createServerModuleMap({\n         const workers =\n           serverActionsManifest[\n             process.env.NEXT_RUNTIME === 'edge' ? 'edge' : 'node'\n-          ][id].workers\n+          ]?.[id]?.workers\n+\n+        if (!workers) {\n+          return undefined\n+        }\n \n         const workStore = workAsyncStorage.getStore()\n "
        },
        {
            "sha": "a529917f876666a151e516b1e02b37d9f0a4a42b",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5df80256af1877020b88285bdfdc8fe55996b291/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5df80256af1877020b88285bdfdc8fe55996b291/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=5df80256af1877020b88285bdfdc8fe55996b291",
            "patch": "@@ -11,6 +11,7 @@ import type { Page, Request, Response, Route } from 'playwright'\n import fs from 'fs-extra'\n import nodeFs from 'fs'\n import { join } from 'path'\n+import { outdent } from 'outdent'\n \n const GENERIC_RSC_ERROR =\n   'Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.'\n@@ -808,9 +809,10 @@ describe('app-dir action handling', () => {\n       })\n \n       await retry(async () =>\n-        expect(next.cliOutput).toMatch(\n-          /Failed to find Server Action \"abc123\". This request might be from an older or newer deployment./\n-        )\n+        expect(next.cliOutput).toInclude(outdent`\n+          Failed to find Server Action \"abc123\". This request might be from an older or newer deployment.\n+          Read more: https://nextjs.org/docs/messages/failed-to-find-server-action\n+        `)\n       )\n     })\n   }"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 23,
        "deletions": 22
    }
}