{
    "author": "ijjk",
    "message": "Reuse resolvedPathname from prepare (#81194)\n\nThis applies the fixed `resolvedPathname` from\nhttps://github.com/vercel/next.js/pull/81144 to the other route handlers\nthat were trying to build this value as well so we use single source of\ntruth.\n\nValidated against our deploy tests\nhttps://github.com/vercel/vercel/actions/runs/16038359282/job/45254959257?pr=13520\nand\nhttps://github.com/vercel/next.js/actions/runs/16038663582/job/45255920639",
    "sha": "4cf90059c3ca91e8b2a4f718c98972b48aa08c2e",
    "files": [
        {
            "sha": "c381f249d3f993fa23ac856242967872d257fa21",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 16,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/4cf90059c3ca91e8b2a4f718c98972b48aa08c2e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4cf90059c3ca91e8b2a4f718c98972b48aa08c2e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=4cf90059c3ca91e8b2a4f718c98972b48aa08c2e",
            "patch": "@@ -21,7 +21,6 @@ import {\n   fromNodeOutgoingHttpHeaders,\n   toNodeOutgoingHttpHeaders,\n } from '../../server/web/utils'\n-import { decodePathParams } from '../../server/lib/router-utils/decode-path-params'\n import { getCacheControlHeader } from '../../server/lib/cache-control'\n import { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from '../../lib/constants'\n import { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\n@@ -114,30 +113,16 @@ export async function handler(\n     buildId,\n     params,\n     nextConfig,\n-    parsedUrl,\n     isDraftMode,\n     prerenderManifest,\n     routerServerContext,\n     isOnDemandRevalidate,\n     revalidateOnlyGenerated,\n+    resolvedPathname,\n   } = prepareResult\n \n   const normalizedSrcPage = normalizeAppPath(srcPage)\n \n-  // TODO: rework this to not be necessary as a middleware\n-  // rewrite should not need to pass this context like this\n-  // maybe we rely on rewrite header instead\n-  let resolvedPathname = getRequestMeta(req, 'rewroteURL')\n-\n-  if (!resolvedPathname) {\n-    resolvedPathname = parsedUrl.pathname || '/'\n-  }\n-\n-  if (resolvedPathname === '/index') {\n-    resolvedPathname = '/'\n-  }\n-  resolvedPathname = decodePathParams(resolvedPathname)\n-\n   let isIsr = Boolean(\n     prerenderManifest.dynamicRoutes[normalizedSrcPage] ||\n       prerenderManifest.routes[resolvedPathname]"
        },
        {
            "sha": "da54c4ac4ec23d3360cff7b7a818d271cac1016e",
            "filename": "packages/next/src/build/templates/pages.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 35,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/4cf90059c3ca91e8b2a4f718c98972b48aa08c2e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4cf90059c3ca91e8b2a4f718c98972b48aa08c2e/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts?ref=4cf90059c3ca91e8b2a4f718c98972b48aa08c2e",
            "patch": "@@ -34,15 +34,12 @@ import { getRedirectStatus } from '../../lib/redirect-status'\n import { CACHE_ONE_YEAR } from '../../lib/constants'\n import { sendRenderResult } from '../../server/send-payload'\n import RenderResult from '../../server/render-result'\n-import { decodePathParams } from '../../server/lib/router-utils/decode-path-params'\n import { toResponseCacheEntry } from '../../server/response-cache/utils'\n import { NoFallbackError } from '../../shared/lib/no-fallback-error.external'\n import { RedirectStatusCode } from '../../client/components/redirect-status-code'\n import { isBot } from '../../shared/lib/router/utils/is-bot'\n import { addPathPrefix } from '../../shared/lib/router/utils/add-path-prefix'\n import { removeTrailingSlash } from '../../shared/lib/router/utils/remove-trailing-slash'\n-import { pathHasPrefix } from '../../shared/lib/router/utils/path-has-prefix'\n-import { normalizeLocalePath } from '../../shared/lib/i18n/normalize-locale-path'\n \n // Re-export the component (should be the default export).\n export default hoist(userland, 'default')\n@@ -149,6 +146,7 @@ export async function handler(\n     defaultLocale,\n     routerServerContext,\n     nextConfig,\n+    resolvedPathname,\n   } = prepareResult\n \n   const isExperimentalCompile =\n@@ -169,31 +167,6 @@ export async function handler(\n   const is404Page = srcPage === '/404'\n   const is500Page = srcPage === '/500'\n   const isErrorPage = srcPage === '/_error'\n-  const pathname = parsedUrl.pathname || '/'\n-\n-  // TODO: rework this to not be necessary as a middleware\n-  // rewrite should not need to pass this context like this\n-  // maybe we rely on rewrite header instead\n-  let resolvedPathname = getRequestMeta(req, 'rewroteURL')\n-\n-  if (resolvedPathname) {\n-    if (pathHasPrefix(resolvedPathname, '/_next/data/')) {\n-      resolvedPathname = normalizeDataPath(resolvedPathname)\n-    }\n-\n-    if (locale) {\n-      resolvedPathname = normalizeLocalePath(\n-        resolvedPathname,\n-        nextConfig.i18n?.locales || []\n-      ).pathname\n-    }\n-  } else {\n-    resolvedPathname = pathname\n-  }\n-\n-  if (resolvedPathname === '/index') {\n-    resolvedPathname = '/'\n-  }\n \n   if (!routeModule.isDev && !isDraftMode && hasStaticProps) {\n     cacheKey = `${locale ? `/${locale}` : ''}${\n@@ -206,19 +179,13 @@ export async function handler(\n       cacheKey = `${locale ? `/${locale}` : ''}${srcPage}${isAmp ? '.amp' : ''}`\n     }\n \n-    cacheKey = decodePathParams(cacheKey)\n-\n     // ensure /index and / is normalized to one key\n     cacheKey = cacheKey === '/index' ? '/' : cacheKey\n   }\n \n   if (hasStaticPaths && !isDraftMode) {\n     const decodedPathname = removeTrailingSlash(\n-      decodePathParams(\n-        locale\n-          ? addPathPrefix(resolvedPathname, `/${locale}`)\n-          : resolvedPathname\n-      )\n+      locale ? addPathPrefix(resolvedPathname, `/${locale}`) : resolvedPathname\n     )\n     const isPrerendered =\n       Boolean(prerenderManifest.routes[decodedPathname]) ||"
        },
        {
            "sha": "a868ac0e6c017387ef3f0b7c2e4fb364bb3a8b79",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4cf90059c3ca91e8b2a4f718c98972b48aa08c2e/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4cf90059c3ca91e8b2a4f718c98972b48aa08c2e/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=4cf90059c3ca91e8b2a4f718c98972b48aa08c2e",
            "patch": "@@ -52,13 +52,13 @@ import type { RouteKind } from '../route-kind'\n import type { BaseNextRequest } from '../base-http'\n import type { I18NConfig, NextConfigComplete } from '../config-shared'\n import ResponseCache, { type ResponseGenerator } from '../response-cache'\n+import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import {\n   RouterServerContextSymbol,\n   routerServerGlobal,\n   type RouterServerContext,\n } from '../lib/router-utils/router-server-context'\n import { decodePathParams } from '../lib/router-utils/decode-path-params'\n-import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n \n /**\n  * RouteModuleOptions is the options that are passed to the route module, other\n@@ -769,7 +769,9 @@ export abstract class RouteModule<\n     if (resolvedPathname === '/index') {\n       resolvedPathname = '/'\n     }\n-    resolvedPathname = decodePathParams(resolvedPathname)\n+    try {\n+      resolvedPathname = decodePathParams(resolvedPathname)\n+    } catch (_) {}\n \n     return {\n       query,"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 7,
        "deletions": 53
    }
}