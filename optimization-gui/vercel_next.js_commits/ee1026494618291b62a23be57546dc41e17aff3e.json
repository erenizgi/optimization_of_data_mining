{
    "author": "mischnic",
    "message": "Turbopack: add `EcmascriptExports::Unknown` (#81214)\n\nCloses PACK-4881\n\nPreviously, you'd get both a `Parsing ecmascript source code failed`\nerror and a `export Abc was not found in module` error if anything\nimported from the module with the parse error (because it had\n`EcmascriptExports::None` in that case).",
    "sha": "ee1026494618291b62a23be57546dc41e17aff3e",
    "files": [
        {
            "sha": "dbcbd5bdb448f46517f294d49ba44de5a1aa69ed",
            "filename": ".prettierignore",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/.prettierignore",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/.prettierignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.prettierignore?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -64,6 +64,7 @@ test/e2e/async-modules/amp-validator-wasm.js\n /turbopack/crates/next-transform-strip-page-exports/tests\n /turbopack/crates/next-transform-dynamic/tests\n /turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/error/input/broken.js\n+/turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/input/invalid-export/broken.js\n /turbopack/crates/turbopack-tests/tests/snapshot/import-meta/cjs/input/mod.cjs\n /turbopack/crates/turbopack-tests/tests/snapshot/source_maps/*\n /turbopack/crates/turbopack-tests/tests/**/output*"
        },
        {
            "sha": "3051a44571b11a6d56de4f6b46549e9c0561e4a3",
            "filename": "turbopack/crates/turbopack-ecmascript/src/chunk/placeable.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fplaceable.rs?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -211,11 +211,19 @@ pub async fn is_marked_as_side_effect_free(\n \n #[turbo_tasks::value(shared)]\n pub enum EcmascriptExports {\n+    /// A module using ESM exports.\n     EsmExports(ResolvedVc<EsmExports>),\n+    /// A module using `__turbopack_export_namespace__`, used by custom module types.\n     DynamicNamespace,\n+    /// A module using CommonJS exports.\n     CommonJs,\n+    /// No exports at all, and falling back to CommonJS semantics.\n     EmptyCommonJs,\n+    /// A value that is made available as both the CommonJS `exports` and the ESM default export.\n     Value,\n+    /// Some error occurred while determining exports.\n+    Unknown,\n+    /// No exports, used by custom module types.\n     None,\n }\n "
        },
        {
            "sha": "a0b148a5c7e67a47cb8d69725eca0dba0a41be11",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -67,6 +67,7 @@ pub async fn is_export_missing(\n     let exports = module.get_exports().await?;\n     let exports = match &*exports {\n         EcmascriptExports::None => return Ok(Vc::cell(true)),\n+        EcmascriptExports::Unknown => return Ok(Vc::cell(false)),\n         EcmascriptExports::Value => return Ok(Vc::cell(false)),\n         EcmascriptExports::CommonJs => return Ok(Vc::cell(false)),\n         EcmascriptExports::EmptyCommonJs => return Ok(Vc::cell(export_name != \"default\")),\n@@ -96,7 +97,8 @@ pub async fn is_export_missing(\n         match &*exports {\n             EcmascriptExports::Value\n             | EcmascriptExports::CommonJs\n-            | EcmascriptExports::DynamicNamespace => {\n+            | EcmascriptExports::DynamicNamespace\n+            | EcmascriptExports::Unknown => {\n                 return Ok(Vc::cell(false));\n             }\n             EcmascriptExports::None\n@@ -444,6 +446,10 @@ pub async fn expand_star_exports(\n             EcmascriptExports::DynamicNamespace => {\n                 has_dynamic_exports = true;\n             }\n+            EcmascriptExports::Unknown => {\n+                // Propagate the Unknown export type to a certain extent.\n+                has_dynamic_exports = true;\n+            }\n         }\n     }\n "
        },
        {
            "sha": "8a7b3525b3eb3533c5b650cab2daf430344ffb14",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -243,7 +243,7 @@ impl AnalyzeEcmascriptModuleResultBuilder {\n             esm_references_rewritten: Default::default(),\n             esm_references_free_var: Default::default(),\n             code_gens: Default::default(),\n-            exports: EcmascriptExports::None,\n+            exports: EcmascriptExports::Unknown,\n             async_module: ResolvedVc::cell(None),\n             successful: false,\n             source_map: None,"
        },
        {
            "sha": "dd285ace015e8c0a5fcd8d9901f14b6c9faac9de",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/input/index.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Findex.js?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -0,0 +1,10 @@\n+it('should error when importing an invalid export', () => {\n+  // Either requiring should throw, or return undefined\n+  let ns\n+  try {\n+    ns = require('./invalid-export')\n+  } catch {\n+    return\n+  }\n+  expect(ns.default).toBe(undefined)\n+})"
        },
        {
            "sha": "875e8c79c0f9f21ff4bfd5dab79ba20da579f54f",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/input/invalid-export/broken.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Finvalid-export%2Fbroken.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Finvalid-export%2Fbroken.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Finvalid-export%2Fbroken.js?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -0,0 +1,2 @@\n+export const a = 42\n+export const b ="
        },
        {
            "sha": "257aec431afaddf1ab488caa09197bfee14c3efd",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/input/invalid-export/index.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Finvalid-export%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Finvalid-export%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Finput%2Finvalid-export%2Findex.js?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -0,0 +1,3 @@\n+import { Abc } from './broken'\n+\n+export default Abc"
        },
        {
            "sha": "6667aa3164f66ab0acf85eba002de85f2022928b",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/issues/Parsing ecmascript source code failed-2cef13.txt",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Fissues%2FParsing%20ecmascript%20source%20code%20failed-2cef13.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Fissues%2FParsing%20ecmascript%20source%20code%20failed-2cef13.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Fissues%2FParsing%20ecmascript%20source%20code%20failed-2cef13.txt?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -0,0 +1,13 @@\n+error - [analysis] /turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/input/invalid-export/broken.js:3:0  Parsing ecmascript source code failed\n+       1 | export const a = 42\n+       2 | export const b =\n+         + v\n+       3 + \n+         + ^\n+  \n+  Unexpected eof\n+  \n+  Import trace:\n+    ./turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/input/invalid-export/broken.js\n+    ./turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/input/invalid-export/index.js\n+    ./turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/input/index.js\n\\ No newline at end of file"
        },
        {
            "sha": "af13697f09f935e9c18c212c95296a9187fde3eb",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export-parse-error/options.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Foptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/ee1026494618291b62a23be57546dc41e17aff3e/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Foptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export-parse-error%2Foptions.json?ref=ee1026494618291b62a23be57546dc41e17aff3e",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"treeShakingMode\": \"reexports-only\"\n+}"
        }
    ],
    "stats": {
        "total": 50,
        "additions": 48,
        "deletions": 2
    }
}