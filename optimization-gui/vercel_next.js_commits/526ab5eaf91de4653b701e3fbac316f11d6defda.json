{
    "author": "wyattjoh",
    "message": "feat: add fallback root params support for prefetch segment data routes (#82282)\n\n### What?\n\nAdd support for generating prefetch segment data routes for pages with\nfallback root parameters.\n\n### Why?\n\nWhen routes have fallback root parameters but no segment paths, the\nprefetch system wasn't generating the necessary rewrite rules. This\ncaused client-side navigation to fail for these routes because the\n`/_tree` requests couldn't be properly rewritten to the prefetch RSC\nroute.\n\n### How?\n\n- Add `hasFallbackRootParams` flag and `prefetchSegmentDataRoutes` to\n`ManifestRoute` type\n- Generate inverse prefetch segment data routes for `/_tree` path when\nroutes have fallback root params\n- Set flag to simplify route regex matching for these routes\n\nRelated Pull Request: https://github.com/vercel/vercel/pull/13653",
    "sha": "526ab5eaf91de4653b701e3fbac316f11d6defda",
    "files": [
        {
            "sha": "688e1534579a27bebb2e98dbda7188ca733b08bd",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 2,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/526ab5eaf91de4653b701e3fbac316f11d6defda/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/526ab5eaf91de4653b701e3fbac316f11d6defda/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=526ab5eaf91de4653b701e3fbac316f11d6defda",
            "patch": "@@ -191,6 +191,7 @@ import { InvariantError } from '../shared/lib/invariant-error'\n import { HTML_LIMITED_BOT_UA_RE_STRING } from '../shared/lib/router/utils/is-bot'\n import type { UseCacheTrackerKey } from './webpack/plugins/telemetry-plugin/use-cache-tracker-utils'\n import {\n+  buildInversePrefetchSegmentDataRoute,\n   buildPrefetchSegmentDataRoute,\n   type PrefetchSegmentDataRoute,\n } from '../server/lib/router-utils/build-prefetch-segment-data-route'\n@@ -401,6 +402,18 @@ export type ManifestRoute = ManifestBuiltRoute & {\n   page: string\n   namedRegex?: string\n   routeKeys?: { [key: string]: string }\n+\n+  /**\n+   * If true, this indicates that the route has fallback root params. This is\n+   * used to simplify the route regex for matching.\n+   */\n+  hasFallbackRootParams?: boolean\n+\n+  /**\n+   * The prefetch segment data routes for this route. This is used to rewrite\n+   * the prefetch segment data routes (or the inverse) to the correct\n+   * destination.\n+   */\n   prefetchSegmentDataRoutes?: PrefetchSegmentDataRoute[]\n \n   /**\n@@ -3172,7 +3185,12 @@ export default async function build(\n                   }\n                 }\n \n-                if (!isAppRouteHandler && metadata?.segmentPaths) {\n+                if (\n+                  !isAppRouteHandler &&\n+                  (metadata?.segmentPaths ||\n+                    (route.fallbackRootParams &&\n+                      route.fallbackRootParams.length > 0))\n+                ) {\n                   // If PPR isn't enabled, then we might not find the dynamic\n                   // route by pathname. If that's the case, we need to find the\n                   // route by page.\n@@ -3185,7 +3203,7 @@ export default async function build(\n                     }\n                   }\n \n-                  if (metadata.segmentPaths) {\n+                  if (metadata?.segmentPaths) {\n                     const pageSegmentPath = metadata.segmentPaths.find((item) =>\n                       item.endsWith('__PAGE__')\n                     )\n@@ -3216,6 +3234,27 @@ export default async function build(\n                       builtSegmentDataRoute\n                     )\n                   }\n+                  // If the route has fallback root params, and we don't have\n+                  // any segment paths, we need to write the inverse prefetch\n+                  // segment data route so that it can first rewrite the /_tree\n+                  // request to the prefetch RSC route. We also need to set the\n+                  // `hasFallbackRootParams` flag so that we can simplify the\n+                  // route regex for matching.\n+                  else if (\n+                    route.fallbackRootParams &&\n+                    route.fallbackRootParams.length > 0\n+                  ) {\n+                    dynamicRoute.hasFallbackRootParams = true\n+                    dynamicRoute.prefetchSegmentDataRoutes = [\n+                      buildInversePrefetchSegmentDataRoute(\n+                        dynamicRoute.page,\n+                        // We use the special segment path of `/_tree` because it's\n+                        // the first one sent by the client router so it's the only\n+                        // one we need to rewrite to the regular prefetch RSC route.\n+                        '/_tree'\n+                      ),\n+                    ]\n+                  }\n                 }\n \n                 pageInfos.set(route.pathname, {"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 41,
        "deletions": 2
    }
}