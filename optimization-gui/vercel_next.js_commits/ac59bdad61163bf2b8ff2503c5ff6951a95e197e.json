{
    "author": "devjiwonchoi",
    "message": "[devtools] port runtime error handling to hook (#80567)\n\nThis will be used for sharing the error across the Error Overlay and the DevTools Panel.",
    "sha": "ac59bdad61163bf2b8ff2503c5ff6951a95e197e",
    "files": [
        {
            "sha": "c9674c3efe1cd29dccc4632bb2534e12fda00396",
            "filename": "packages/next/src/next-devtools/dev-overlay/container/errors.tsx",
            "status": "modified",
            "additions": 15,
            "deletions": 26,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/ac59bdad61163bf2b8ff2503c5ff6951a95e197e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Ferrors.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ac59bdad61163bf2b8ff2503c5ff6951a95e197e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Ferrors.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcontainer%2Ferrors.tsx?ref=ac59bdad61163bf2b8ff2503c5ff6951a95e197e",
            "patch": "@@ -1,11 +1,10 @@\n-import { useState, useMemo, useRef, Suspense } from 'react'\n+import { useMemo, useRef, Suspense } from 'react'\n import type { DebugInfo } from '../../shared/types'\n import { Overlay, OverlayBackdrop } from '../components/overlay'\n import { RuntimeError } from './runtime-error'\n import { getErrorSource } from '../../../shared/lib/error-source'\n import { HotlinkedText } from '../components/hot-linked-text'\n import { PseudoHtmlDiff } from './runtime-error/component-stack-pseudo-html'\n-import { extractNextErrorCode } from '../../../lib/error-telemetry-utils'\n import {\n   ErrorOverlayLayout,\n   type ErrorOverlayLayoutProps,\n@@ -18,6 +17,7 @@ import {\n import type { ReadyRuntimeError } from '../utils/get-error-by-type'\n import type { ErrorBaseProps } from '../components/errors/error-overlay/error-overlay'\n import type { HydrationErrorState } from '../../shared/hydration-error'\n+import { useActiveRuntimeError } from '../hooks/use-active-runtime-error'\n \n export interface ErrorsProps extends ErrorBaseProps {\n   getSquashedHydrationErrorDetails: (error: Error) => HydrationErrorState | null\n@@ -26,8 +26,6 @@ export interface ErrorsProps extends ErrorBaseProps {\n   onClose: () => void\n }\n \n-type ReadyErrorEvent = ReadyRuntimeError\n-\n function isNextjsLink(text: string): boolean {\n   return text.startsWith('https://nextjs.org')\n }\n@@ -55,7 +53,7 @@ function GenericErrorDescription({ error }: { error: Error }) {\n   )\n }\n \n-function getErrorTypeLabel(\n+export function getErrorTypeLabel(\n   error: Error,\n   type: ReadyRuntimeError['type']\n ): ErrorOverlayLayoutProps['errorType'] {\n@@ -73,7 +71,7 @@ const noErrorDetails = {\n   notes: null,\n   reactOutputComponentDiff: null,\n }\n-function useErrorDetails(\n+export function useErrorDetails(\n   error: Error | undefined,\n   getSquashedHydrationErrorDetails: (error: Error) => HydrationErrorState | null\n ): {\n@@ -122,20 +120,17 @@ export function Errors({\n }: ErrorsProps) {\n   const dialogResizerRef = useRef<HTMLDivElement | null>(null)\n \n-  const isLoading = useMemo<boolean>(() => {\n-    return runtimeErrors.length < 1\n-  }, [runtimeErrors.length])\n-\n-  const [activeIdx, setActiveIndex] = useState<number>(0)\n-\n-  const activeError = useMemo<ReadyErrorEvent | null>(\n-    () => runtimeErrors[activeIdx] ?? null,\n-    [activeIdx, runtimeErrors]\n-  )\n-  const errorDetails = useErrorDetails(\n-    activeError?.error,\n-    getSquashedHydrationErrorDetails\n-  )\n+  const {\n+    isLoading,\n+    errorCode,\n+    errorType,\n+    notes,\n+    hydrationWarning,\n+    activeIdx,\n+    errorDetails,\n+    activeError,\n+    setActiveIndex,\n+  } = useActiveRuntimeError({ runtimeErrors, getSquashedHydrationErrorDetails })\n \n   if (isLoading) {\n     // TODO: better loading state\n@@ -154,12 +149,6 @@ export function Errors({\n   const isServerError = ['server', 'edge-server'].includes(\n     getErrorSource(error) || ''\n   )\n-  const errorType = getErrorTypeLabel(error, activeError.type)\n-  // TOOD: May be better to always treat everything past the first blank line as notes\n-  // We're currently only special casing hydration error messages.\n-  const notes = errorDetails.notes\n-  const hydrationWarning = errorDetails.hydrationWarning\n-  const errorCode = extractNextErrorCode(error)\n \n   return (\n     <ErrorOverlayLayout"
        },
        {
            "sha": "57ae3ddf3a2a6819a9f2e9e95d36e5c7b33cb437",
            "filename": "packages/next/src/next-devtools/dev-overlay/hooks/use-active-runtime-error.ts",
            "status": "added",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/ac59bdad61163bf2b8ff2503c5ff6951a95e197e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fhooks%2Fuse-active-runtime-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ac59bdad61163bf2b8ff2503c5ff6951a95e197e/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fhooks%2Fuse-active-runtime-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fhooks%2Fuse-active-runtime-error.ts?ref=ac59bdad61163bf2b8ff2503c5ff6951a95e197e",
            "patch": "@@ -0,0 +1,65 @@\n+import type { ReadyRuntimeError } from '../utils/get-error-by-type'\n+import type { HydrationErrorState } from '../../shared/hydration-error'\n+\n+import { useMemo, useState } from 'react'\n+import { getErrorTypeLabel, useErrorDetails } from '../container/errors'\n+import { extractNextErrorCode } from '../../../lib/error-telemetry-utils'\n+\n+export function useActiveRuntimeError({\n+  runtimeErrors,\n+  getSquashedHydrationErrorDetails,\n+}: {\n+  runtimeErrors: ReadyRuntimeError[]\n+  getSquashedHydrationErrorDetails: (error: Error) => HydrationErrorState | null\n+}) {\n+  const [activeIdx, setActiveIndex] = useState<number>(0)\n+\n+  const isLoading = useMemo<boolean>(() => {\n+    return runtimeErrors.length === 0\n+  }, [runtimeErrors.length])\n+\n+  const activeError = useMemo<ReadyRuntimeError | null>(\n+    () => runtimeErrors[activeIdx] ?? null,\n+    [activeIdx, runtimeErrors]\n+  )\n+\n+  const errorDetails = useErrorDetails(\n+    activeError?.error,\n+    getSquashedHydrationErrorDetails\n+  )\n+\n+  if (isLoading || !activeError) {\n+    return {\n+      isLoading,\n+      activeIdx,\n+      setActiveIndex,\n+      activeError: null,\n+      errorDetails: null,\n+      errorCode: null,\n+      errorType: null,\n+      notes: null,\n+      hydrationWarning: null,\n+    }\n+  }\n+\n+  const error = activeError.error\n+  const errorCode = extractNextErrorCode(error)\n+  const errorType = getErrorTypeLabel(error, activeError.type)\n+\n+  // TODO(GH#78140): May be better to always treat everything past the first blank line as notes\n+  // We're currently only special casing hydration error messages.\n+  const notes = errorDetails.notes\n+  const hydrationWarning = errorDetails.hydrationWarning\n+\n+  return {\n+    isLoading,\n+    activeIdx,\n+    setActiveIndex,\n+    activeError,\n+    errorDetails,\n+    errorCode,\n+    errorType,\n+    notes,\n+    hydrationWarning,\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 80,
        "deletions": 26
    }
}