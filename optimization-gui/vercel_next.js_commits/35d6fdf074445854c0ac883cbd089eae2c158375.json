{
    "author": "lucasadrianof",
    "message": "fix(nodejs-middleware): await for body cloning to be properly finalized (#85418)\n\nFixes https://github.com/vercel/next.js/issues/85416.\n\nThis is a follow up to https://github.com/vercel/next.js/pull/77662,\nwhere the Node.js middleware was fixed to also support reading (and\nduplicating) the body's request before being passed to the server\naction.\n\nHowever, in that PR, an `await` was missed while calling the\n[.finalize()](https://github.com/vercel/next.js/blob/1b45163bce3dab30d7a79dff95238b84016b54c2/packages/next/src/server/body-streams.ts#L39)\nmethod, which returns a Promise. That missing `await` would sometimes\ncause a bug, where the server action would be invoked before the body\nwas completely cloned, causing the bug mentioned in the issue above.\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "35d6fdf074445854c0ac883cbd089eae2c158375",
    "files": [
        {
            "sha": "d8ce0ade95af322979d01a58d5153e6663e17f7a",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -1750,7 +1750,7 @@ export default class NextNodeServer extends BaseServer<\n         })\n       } finally {\n         if (hasRequestBody) {\n-          requestData.body.finalize()\n+          await requestData.body.finalize()\n         }\n       }\n     } else {"
        },
        {
            "sha": "03376e993ccbff085b444b192992ab7888c9769a",
            "filename": "test/e2e/app-dir/actions/app/body-finalize/actions.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Factions.js",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Factions.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Factions.js?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,13 @@\n+'use server'\n+\n+/**\n+ * @param {number[]} largeJson\n+ */\n+export async function submitLargePayload(largeJson) {\n+  return {\n+    success: true,\n+    count: largeJson.length,\n+    firstId: largeJson[0],\n+    lastId: largeJson[largeJson.length - 1],\n+  }\n+}"
        },
        {
            "sha": "f439e4aa9323fdc2a710016165b930c0669bf16e",
            "filename": "test/e2e/app-dir/actions/app/body-finalize/page.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Fpage.js?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,27 @@\n+'use client'\n+\n+import { useMemo, useState } from 'react'\n+import { submitLargePayload } from './actions'\n+\n+export default function Page() {\n+  const [result, setResult] = useState(null)\n+\n+  const largePayload = useMemo(\n+    () => new Array(10 * 1024).fill(null).map((_, idx) => idx),\n+    []\n+  )\n+\n+  const handleSubmit = async () => {\n+    const res = await submitLargePayload(largePayload)\n+    setResult(res)\n+  }\n+\n+  return (\n+    <div>\n+      <button onClick={handleSubmit} id=\"submit-large\">\n+        Submit Large Payload\n+      </button>\n+      {result && <div id=\"result\">{JSON.stringify(result)}</div>}\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "cf76082e19d49d4ee0fe0cad7157ce5c248df6b8",
            "filename": "test/e2e/app-dir/actions/components/DefaultLayout.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fe2e%2Fapp-dir%2Factions%2Fcomponents%2FDefaultLayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fe2e%2Fapp-dir%2Factions%2Fcomponents%2FDefaultLayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fcomponents%2FDefaultLayout.tsx?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,14 @@\n+import React from 'react'\n+\n+export default function DefaultLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <head />\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "b263770d9a2073fed1feecd5edd071d85ebd44e9",
            "filename": "test/e2e/app-dir/actions/middleware-node.js",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware-node.js",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware-node.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware-node.js?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -7,6 +7,15 @@ export async function middleware(req) {\n     return NextResponse.rewrite(req.nextUrl)\n   }\n \n+  if (req.method === 'POST' && req.nextUrl.pathname.includes('body-finalize')) {\n+    const body = await req.json()\n+\n+    console.log(\n+      'Middleware - Body length: %d bytes',\n+      new TextEncoder().encode(JSON.stringify(body)).length\n+    )\n+  }\n+\n   return NextResponse.next()\n }\n "
        },
        {
            "sha": "30b25ecb823602f3d2c6a725e7fdf549796a87d2",
            "filename": "test/production/app-dir/actions/app-action-body-finalize-output-standalone.test.ts",
            "status": "added",
            "additions": 87,
            "deletions": 0,
            "changes": 87,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fapp-action-body-finalize-output-standalone.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fapp-action-body-finalize-output-standalone.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Factions%2Fapp-action-body-finalize-output-standalone.test.ts?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,87 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import {\n+  findPort,\n+  getFullUrl,\n+  initNextServerScript,\n+  killApp,\n+  retry,\n+} from 'next-test-utils'\n+import webdriver from 'next-webdriver'\n+import path from 'node:path'\n+import fs from 'fs-extra'\n+import os from 'os'\n+\n+describe('app-dir action body finalize with nodejs middleware and output-standalone', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    skipStart: true,\n+  })\n+\n+  let server: any\n+  let appPort: number\n+  let tmpFolder: string\n+\n+  beforeAll(async () => {\n+    tmpFolder = path.join(os.tmpdir(), 'next-standalone-' + Date.now())\n+    await fs.mkdirp(tmpFolder)\n+\n+    await next.build()\n+    await next.patchFile(\n+      '.next/standalone/node_modules/next/dist/server/body-streams.js',\n+      (content) => {\n+        return content.replace(\n+          'async finalize () {',\n+          'async finalize () { \\nawait new Promise((resolve) => setTimeout(resolve, (Math.random() * 1000) + 1000));\\n'\n+        )\n+      }\n+    )\n+\n+    const distFolder = path.join(tmpFolder, 'test')\n+    await fs.move(path.join(next.testDir, '.next/standalone'), distFolder)\n+    await fs.move(\n+      path.join(next.testDir, '.next/static'),\n+      path.join(distFolder, '.next/static')\n+    )\n+\n+    const testServer = path.join(distFolder, 'server.js')\n+    appPort = await findPort()\n+    server = await initNextServerScript(\n+      testServer,\n+      /- Local:/,\n+      {\n+        ...process.env,\n+        PORT: appPort.toString(),\n+      },\n+      undefined,\n+      {\n+        cwd: distFolder,\n+      }\n+    )\n+  })\n+\n+  afterAll(async () => {\n+    if (server) await killApp(server)\n+    if (!process.env.NEXT_TEST_SKIP_CLEANUP) {\n+      await fs.remove(tmpFolder).catch(console.error)\n+    }\n+  })\n+\n+  it('should handle large payload through server action after nodejs middleware with delayed body finalize', async () => {\n+    const browser = await webdriver(getFullUrl(appPort, '/body-finalize'), '')\n+\n+    try {\n+      await browser.elementById('submit-large').click()\n+      await retry(async () => {\n+        const resultText = await browser.elementById('result').text()\n+        const result = JSON.parse(resultText)\n+\n+        expect(result.success).toBe(true)\n+        expect(result.count).toBe(10 * 1024)\n+        expect(result.firstId).toBe(0)\n+        expect(result.lastId).toBe(10 * 1024 - 1)\n+      })\n+    } finally {\n+      await browser.close()\n+    }\n+  })\n+})"
        },
        {
            "sha": "03376e993ccbff085b444b192992ab7888c9769a",
            "filename": "test/production/app-dir/actions/app/body-finalize/actions.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Factions.js",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Factions.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Factions.js?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,13 @@\n+'use server'\n+\n+/**\n+ * @param {number[]} largeJson\n+ */\n+export async function submitLargePayload(largeJson) {\n+  return {\n+    success: true,\n+    count: largeJson.length,\n+    firstId: largeJson[0],\n+    lastId: largeJson[largeJson.length - 1],\n+  }\n+}"
        },
        {
            "sha": "f439e4aa9323fdc2a710016165b930c0669bf16e",
            "filename": "test/production/app-dir/actions/app/body-finalize/page.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Fbody-finalize%2Fpage.js?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,27 @@\n+'use client'\n+\n+import { useMemo, useState } from 'react'\n+import { submitLargePayload } from './actions'\n+\n+export default function Page() {\n+  const [result, setResult] = useState(null)\n+\n+  const largePayload = useMemo(\n+    () => new Array(10 * 1024).fill(null).map((_, idx) => idx),\n+    []\n+  )\n+\n+  const handleSubmit = async () => {\n+    const res = await submitLargePayload(largePayload)\n+    setResult(res)\n+  }\n+\n+  return (\n+    <div>\n+      <button onClick={handleSubmit} id=\"submit-large\">\n+        Submit Large Payload\n+      </button>\n+      {result && <div id=\"result\">{JSON.stringify(result)}</div>}\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "6d7e1ed585862084bbcead3642e23690d53bd1fd",
            "filename": "test/production/app-dir/actions/app/layout.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Factions%2Fapp%2Flayout.js?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,8 @@\n+export default function RootLayout({ children }) {\n+  return (\n+    <html>\n+      <head />\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "b263770d9a2073fed1feecd5edd071d85ebd44e9",
            "filename": "test/production/app-dir/actions/middleware.js",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Factions%2Fmiddleware.js?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,27 @@\n+// Ensure that https://github.com/vercel/next.js/issues/56286 is fixed.\n+import { NextResponse } from 'next/server'\n+\n+export async function middleware(req) {\n+  if (req.nextUrl.pathname.includes('rewrite-to-static-first')) {\n+    req.nextUrl.pathname = '/static/first'\n+    return NextResponse.rewrite(req.nextUrl)\n+  }\n+\n+  if (req.method === 'POST' && req.nextUrl.pathname.includes('body-finalize')) {\n+    const body = await req.json()\n+\n+    console.log(\n+      'Middleware - Body length: %d bytes',\n+      new TextEncoder().encode(JSON.stringify(body)).length\n+    )\n+  }\n+\n+  return NextResponse.next()\n+}\n+\n+/**\n+ * @type {import('next/server').ProxyConfig}\n+ */\n+export const config = {\n+  runtime: 'nodejs',\n+}"
        },
        {
            "sha": "f199349c2cdb0323826259abd6192ae632fff10d",
            "filename": "test/production/app-dir/actions/next.config.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fapp-dir%2Factions%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Factions%2Fnext.config.js?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -0,0 +1,11 @@\n+/** @type {import('next').NextConfig} */\n+module.exports = {\n+  productionBrowserSourceMaps: true,\n+  logging: {\n+    fetches: {},\n+  },\n+  experimental: {\n+    serverActions: { bodySizeLimit: '2mb' },\n+  },\n+  output: 'standalone',\n+}"
        },
        {
            "sha": "8a9b2c86d231eb15179f605c7c47fce1a14730df",
            "filename": "test/production/next-server-nft/next-server-nft.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/35d6fdf074445854c0ac883cbd089eae2c158375/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts?ref=35d6fdf074445854c0ac883cbd089eae2c158375",
            "patch": "@@ -156,7 +156,6 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n          \"/node_modules/next/dist/compiled/react-is/cjs/react-is.development.js\",\n          \"/node_modules/next/dist/compiled/react-is/cjs/react-is.production.js\",\n          \"/node_modules/next/dist/compiled/react-is/index.js\",\n-         \"/node_modules/next/dist/compiled/safe-stable-stringify/index.js\",\n          \"/node_modules/next/dist/compiled/send/index.js\",\n          \"/node_modules/next/dist/compiled/source-map/source-map.js\",\n          \"/node_modules/next/dist/compiled/stacktrace-parser/stack-trace-parser.cjs.js\",\n@@ -270,7 +269,6 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n          \"/node_modules/next/dist/compiled/babel-code-frame/index.js\",\n          \"/node_modules/next/dist/compiled/babel/code-frame.js\",\n          \"/node_modules/next/dist/compiled/next-server/server.runtime.prod.js\",\n-         \"/node_modules/next/dist/compiled/safe-stable-stringify/index.js\",\n          \"/node_modules/next/dist/compiled/source-map/source-map.js\",\n          \"/node_modules/next/dist/compiled/stacktrace-parser/stack-trace-parser.cjs.js\",\n          \"/node_modules/next/dist/compiled/ws/index.js\","
        }
    ],
    "stats": {
        "total": 240,
        "additions": 237,
        "deletions": 3
    }
}