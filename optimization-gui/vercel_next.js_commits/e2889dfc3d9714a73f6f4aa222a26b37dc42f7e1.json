{
    "author": "mischnic",
    "message": "Turbopack: improve references benchmark (#84223)\n\nThis isn't ideal, but the setup is somewhat negligible\n```\nBenchmarking references/react-dom-client.development.js/full: Warming up for 1.0000 s\nBackend: 1.132083ms Setup: 1.93475ms, Analysis: 96.47525ms\nBackend: 1.328792ms Setup: 179.875µs, Analysis: 150.265291ms\nBackend: 1.352333ms Setup: 95.375µs, Analysis: 80.448791ms\nBackend: 967.916µs Setup: 77.083µs, Analysis: 78.769917ms\nBackend: 685.166µs Setup: 66.458µs, Analysis: 76.768042ms\nBackend: 718.834µs Setup: 70.292µs, Analysis: 75.807458ms\nBackend: 825.125µs Setup: 68.625µs, Analysis: 78.019792ms\nBackend: 903.209µs Setup: 68.709µs, Analysis: 78.0815ms\nBackend: 1.026958ms Setup: 79.959µs, Analysis: 103.203291ms\nBackend: 707.208µs Setup: 64.917µs, Analysis: 79.350292ms\nBackend: 1.018291ms Setup: 82µs, Analysis: 79.496292ms\nBackend: 832.375µs Setup: 64.875µs, Analysis: 75.658958ms\nBackend: 795.833µs Setup: 60.333µs, Analysis: 75.704792ms\nBackend: 948.417µs Setup: 68.416µs, Analysis: 75.474584ms\nBackend: 725.167µs Setup: 65.542µs, Analysis: 75.63275ms\n```\nand this certainly makes the benchmark more accurate, as it now always recomputes all tasks on every call.",
    "sha": "e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1",
    "files": [
        {
            "sha": "05cbc81bc836cc6d9844b8af99ff3084ad54f9bf",
            "filename": "turbopack/crates/turbopack-ecmascript/benches/references.rs",
            "status": "modified",
            "additions": 111,
            "deletions": 98,
            "changes": 209,
            "blob_url": "https://github.com/vercel/next.js/blob/e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fbenches%2Freferences.rs?ref=e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1",
            "patch": "@@ -1,11 +1,10 @@\n-use std::{path::PathBuf, sync::Arc, time::Duration};\n+use std::{path::PathBuf, time::Duration};\n \n-use criterion::{Bencher, BenchmarkId, Criterion, criterion_group, criterion_main};\n+use anyhow::Result;\n+use criterion::{BatchSize, Bencher, BenchmarkId, Criterion, criterion_group, criterion_main};\n use turbo_rcstr::rcstr;\n use turbo_tasks::{ResolvedVc, TurboTasks};\n-use turbo_tasks_backend::{\n-    BackendOptions, BackingStorage, TurboTasksBackend, noop_backing_storage,\n-};\n+use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n use turbo_tasks_fs::{DiskFileSystem, FileSystem};\n use turbopack_core::{\n     compile_time_info::CompileTimeInfo,\n@@ -14,126 +13,140 @@ use turbopack_core::{\n     ident::Layer,\n };\n use turbopack_ecmascript::{\n-    EcmascriptInputTransforms, EcmascriptModuleAsset, EcmascriptOptions, TreeShakingMode,\n-    references::analyze_ecmascript_module_internal,\n+    AnalyzeMode, EcmascriptInputTransforms, EcmascriptModuleAsset, EcmascriptOptions,\n+    TreeShakingMode, references::analyze_ecmascript_module,\n };\n use turbopack_test_utils::noop_asset_context::NoopAssetContext;\n \n #[global_allocator]\n static ALLOC: turbo_tasks_malloc::TurboMalloc = turbo_tasks_malloc::TurboMalloc;\n \n pub fn benchmark(c: &mut Criterion) {\n-    let rt = tokio::runtime::Builder::new_current_thread()\n-        .build()\n-        .unwrap();\n-\n-    let tt = TurboTasks::new(TurboTasksBackend::new(\n-        BackendOptions {\n-            dependency_tracking: false,\n-            storage_mode: None,\n-            ..Default::default()\n-        },\n-        noop_backing_storage(),\n-    ));\n-\n-    let cases = rt\n-        .block_on(tt.run_once(async {\n-            let root_dir = PathBuf::from(env!(\"CARGO_MANIFEST_DIR\")).join(\"tests/benches/\");\n-            let fs = DiskFileSystem::new(rcstr!(\"project\"), root_dir.to_str().unwrap().into());\n-\n-            let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n-                NodeJsEnvironment::default().resolved_cell(),\n-            ));\n-            let compile_time_info = CompileTimeInfo::new(environment).to_resolved().await?;\n-            let layer = Layer::new(rcstr!(\"test\"));\n-            let module_asset_context = NoopAssetContext {\n-                compile_time_info,\n-                layer,\n-            }\n-            .resolved_cell();\n-\n-            let mut cases = vec![];\n-            for (file, analyze_mode) in [\n-                (r#\"packages-bundle.js\"#, false),\n-                (r#\"packages-bundle.js\"#, true),\n-                (r#\"app-page-turbo.runtime.prod.js\"#, false),\n-                (r#\"app-page-turbo.runtime.prod.js\"#, true),\n-                (r#\"react-dom-client.development.js\"#, false),\n-                (r#\"react-dom-client.development.js\"#, true),\n-            ] {\n-                let module = EcmascriptModuleAsset::builder(\n-                    ResolvedVc::upcast(\n-                        FileSource::new(fs.root().await?.join(file).unwrap())\n-                            .to_resolved()\n-                            .await?,\n-                    ),\n-                    ResolvedVc::upcast(module_asset_context),\n-                    EcmascriptInputTransforms::empty().to_resolved().await?,\n-                    EcmascriptOptions {\n-                        tree_shaking_mode: Some(TreeShakingMode::ReexportsOnly),\n-                        analyze_mode: if analyze_mode {\n-                            turbopack_ecmascript::AnalyzeMode::Tracing\n-                        } else {\n-                            turbopack_ecmascript::AnalyzeMode::CodeGenerationAndTracing\n-                        },\n-                        ..Default::default()\n-                    }\n-                    .resolved_cell(),\n-                    compile_time_info,\n-                )\n-                .build()\n-                .to_resolved()\n-                .await?;\n-\n-                cases.push((\n-                    file.rsplit(\"/\").next().unwrap(),\n-                    if analyze_mode { \"tracing\" } else { \"full\" },\n-                    module,\n-                ));\n-            }\n-            anyhow::Ok(cases)\n-        }))\n-        .unwrap();\n+    let root_dir = String::leak(\n+        PathBuf::from(env!(\"CARGO_MANIFEST_DIR\"))\n+            .join(\"tests/benches/\")\n+            .to_str()\n+            .unwrap()\n+            .to_string(),\n+    );\n \n     let mut group = c.benchmark_group(\"references\");\n     group.warm_up_time(Duration::from_secs(1));\n     group.measurement_time(Duration::from_secs(10));\n \n-    for (file, param, module) in cases {\n+    for (file, trace_only) in [\n+        (r#\"packages-bundle.js\"#, false),\n+        (r#\"packages-bundle.js\"#, true),\n+        (r#\"app-page-turbo.runtime.prod.js\"#, false),\n+        (r#\"app-page-turbo.runtime.prod.js\"#, true),\n+        (r#\"react-dom-client.development.js\"#, false),\n+        (r#\"react-dom-client.development.js\"#, true),\n+        (r#\"jsonwebtoken.js\"#, false),\n+        (r#\"jsonwebtoken.js\"#, true),\n+    ] {\n         group.bench_with_input(\n-            BenchmarkId::new(file, param),\n+            BenchmarkId::new(file, if trace_only { \"tracing\" } else { \"full\" }),\n             &BenchInput {\n-                module,\n-                storage: tt.clone(),\n+                root_dir,\n+                file,\n+                analyze_mode: if trace_only {\n+                    AnalyzeMode::Tracing\n+                } else {\n+                    AnalyzeMode::CodeGenerationAndTracing\n+                },\n             },\n             bench_full,\n         );\n     }\n }\n \n-struct BenchInput<B>\n-where\n-    B: BackingStorage,\n-{\n-    storage: Arc<TurboTasks<TurboTasksBackend<B>>>,\n-    module: ResolvedVc<EcmascriptModuleAsset>,\n+async fn setup(\n+    root_dir: &str,\n+    file: &str,\n+    analyze_mode: AnalyzeMode,\n+) -> Result<ResolvedVc<EcmascriptModuleAsset>> {\n+    let fs = DiskFileSystem::new(rcstr!(\"project\"), root_dir.into());\n+\n+    let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n+        NodeJsEnvironment::default().resolved_cell(),\n+    ));\n+    let compile_time_info = CompileTimeInfo::new(environment).to_resolved().await?;\n+    let layer = Layer::new(rcstr!(\"test\"));\n+    let module_asset_context = NoopAssetContext {\n+        compile_time_info,\n+        layer,\n+    }\n+    .resolved_cell();\n+    let module = EcmascriptModuleAsset::builder(\n+        ResolvedVc::upcast(\n+            FileSource::new(fs.root().await?.join(file).unwrap())\n+                .to_resolved()\n+                .await?,\n+        ),\n+        ResolvedVc::upcast(module_asset_context),\n+        EcmascriptInputTransforms::empty().to_resolved().await?,\n+        EcmascriptOptions {\n+            tree_shaking_mode: Some(TreeShakingMode::ReexportsOnly),\n+            analyze_mode,\n+            ..Default::default()\n+        }\n+        .resolved_cell(),\n+        compile_time_info,\n+    )\n+    .build()\n+    .to_resolved()\n+    .await?;\n+    Ok(module)\n+}\n+\n+struct BenchInput {\n+    root_dir: &'static str,\n+    file: &'static str,\n+    analyze_mode: AnalyzeMode,\n }\n \n-fn bench_full<B>(b: &mut Bencher, input: &BenchInput<B>)\n-where\n-    B: BackingStorage,\n-{\n-    let rt = tokio::runtime::Builder::new_current_thread()\n+fn bench_full(b: &mut Bencher, input: &BenchInput) {\n+    let rt = tokio::runtime::Builder::new_multi_thread()\n+        .worker_threads(2)\n+        .enable_all()\n         .build()\n         .unwrap();\n \n-    b.to_async(rt).iter(async || {\n-        input\n-            .storage\n-            .run_once(analyze_ecmascript_module_internal(input.module, None))\n+    b.to_async(rt).iter_batched(\n+        || {\n+            let tt = TurboTasks::new(TurboTasksBackend::new(\n+                BackendOptions {\n+                    dependency_tracking: false,\n+                    storage_mode: None,\n+                    ..Default::default()\n+                },\n+                noop_backing_storage(),\n+            ));\n+            let BenchInput {\n+                root_dir,\n+                file,\n+                analyze_mode,\n+            } = *input;\n+            let module = tokio::task::block_in_place(|| {\n+                tokio::runtime::Handle::current()\n+                    .block_on(tt.run_once(async move {\n+                        let module = setup(root_dir, file, analyze_mode).await?;\n+                        Ok(module)\n+                    }))\n+                    .unwrap()\n+            });\n+            (tt, module)\n+        },\n+        |(tt, module)| async move {\n+            tt.run_once(async move {\n+                analyze_ecmascript_module(*module, None).await?;\n+                Ok(())\n+            })\n             .await\n             .unwrap()\n-    });\n+        },\n+        BatchSize::SmallInput,\n+    );\n }\n \n criterion_group!(references_benches, benchmark);"
        },
        {
            "sha": "05c3dc91d2ad6bc8ca55aaadd148ac5a34220421",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1",
            "patch": "@@ -483,7 +483,7 @@ where\n \n /// Analyse a provided [EcmascriptModuleAsset] and return a [AnalyzeEcmascriptModuleResult].\n #[turbo_tasks::function]\n-pub(crate) async fn analyze_ecmascript_module(\n+pub async fn analyze_ecmascript_module(\n     module: ResolvedVc<EcmascriptModuleAsset>,\n     part: Option<ModulePart>,\n ) -> Result<Vc<AnalyzeEcmascriptModuleResult>> {\n@@ -504,7 +504,7 @@ pub(crate) async fn analyze_ecmascript_module(\n     }\n }\n \n-pub async fn analyze_ecmascript_module_internal(\n+async fn analyze_ecmascript_module_internal(\n     module: ResolvedVc<EcmascriptModuleAsset>,\n     part: Option<ModulePart>,\n ) -> Result<Vc<AnalyzeEcmascriptModuleResult>> {"
        },
        {
            "sha": "dde9a6f0124621916177ade3cba60d0620aeac59",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/benches/jsonwebtoken.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fbenches%2Fjsonwebtoken.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fbenches%2Fjsonwebtoken.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fbenches%2Fjsonwebtoken.js?ref=e2889dfc3d9714a73f6f4aa222a26b37dc42f7e1"
        }
    ],
    "stats": {
        "total": 224,
        "additions": 124,
        "deletions": 100
    }
}