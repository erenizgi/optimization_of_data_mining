{
    "author": "ijjk",
    "message": "Add handling of origin in dev mode (#76880)\n\nThis ensures we don't allow cross-origin requests to be made to `/_next`\nresources in dev mode. This matches existing handling that\nwebpack-dev-middleware does as well.",
    "sha": "d928709b7494bc0e296bea9148dd803e9d9599b1",
    "files": [
        {
            "sha": "e5f0d059cd1d8c4cf569e600fc46cdfd75991470",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d928709b7494bc0e296bea9148dd803e9d9599b1/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d928709b7494bc0e296bea9148dd803e9d9599b1/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=d928709b7494bc0e296bea9148dd803e9d9599b1",
            "patch": "@@ -261,6 +261,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n     excludeDefaultMomentLocales: z.boolean().optional(),\n     experimental: z\n       .strictObject({\n+        allowedDevOrigins: z.array(z.string()).optional(),\n         nodeMiddleware: z.boolean().optional(),\n         after: z.boolean().optional(),\n         appDocumentPreloading: z.boolean().optional(),"
        },
        {
            "sha": "5e64d86b115463094826e3ef29b5f3ff48b4c078",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d928709b7494bc0e296bea9148dd803e9d9599b1/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d928709b7494bc0e296bea9148dd803e9d9599b1/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=d928709b7494bc0e296bea9148dd803e9d9599b1",
            "patch": "@@ -257,6 +257,7 @@ export interface LoggingConfig {\n }\n \n export interface ExperimentalConfig {\n+  allowedDevOrigins?: string[]\n   nodeMiddleware?: boolean\n   cacheHandlers?: {\n     default?: string\n@@ -1134,6 +1135,7 @@ export const defaultConfig: NextConfig = {\n   modularizeImports: undefined,\n   outputFileTracingRoot: process.env.NEXT_PRIVATE_OUTPUT_TRACE_ROOT || '',\n   experimental: {\n+    allowedDevOrigins: [],\n     nodeMiddleware: false,\n     cacheLife: {\n       default: {"
        },
        {
            "sha": "4566051db8ca220bf38aabb75874c9019ba4ea12",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/d928709b7494bc0e296bea9148dd803e9d9599b1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d928709b7494bc0e296bea9148dd803e9d9599b1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=d928709b7494bc0e296bea9148dd803e9d9599b1",
            "patch": "@@ -49,6 +49,7 @@ import { normalizedAssetPrefix } from '../../shared/lib/normalized-asset-prefix'\n import { NEXT_PATCH_SYMBOL } from './patch-fetch'\n import type { ServerInitResult } from './render-server'\n import { filterInternalHeaders } from './server-ipc/utils'\n+import { blockCrossSite } from './router-utils/block-cross-site'\n \n const debug = setupDebug('next:router-server:main')\n const isNextFont = (pathname: string | null) =>\n@@ -165,6 +166,14 @@ export async function initialize(opts: {\n   renderServer.instance =\n     require('./render-server') as typeof import('./render-server')\n \n+  const allowedOrigins = [\n+    'localhost',\n+    ...(config.experimental.allowedDevOrigins || []),\n+  ]\n+  if (opts.hostname) {\n+    allowedOrigins.push(opts.hostname)\n+  }\n+\n   const requestHandlerImpl: WorkerRequestHandler = async (req, res) => {\n     // internal headers should not be honored by the request handler\n     if (!process.env.NEXT_PRIVATE_TEST_HEADERS) {\n@@ -316,6 +325,9 @@ export async function initialize(opts: {\n \n       // handle hot-reloader first\n       if (developmentBundler) {\n+        if (blockCrossSite(req, res, allowedOrigins, `${opts.port}`)) {\n+          return\n+        }\n         const origUrl = req.url || '/'\n \n         if (config.basePath && pathHasPrefix(origUrl, config.basePath)) {\n@@ -679,6 +691,9 @@ export async function initialize(opts: {\n       })\n \n       if (opts.dev && developmentBundler && req.url) {\n+        if (blockCrossSite(req, socket, allowedOrigins, `${opts.port}`)) {\n+          return\n+        }\n         const { basePath, assetPrefix } = config\n \n         let hmrPrefix = basePath"
        },
        {
            "sha": "718afacd3c46d59a609ccdce8e1df3d642388bc7",
            "filename": "packages/next/src/server/lib/router-utils/block-cross-site.ts",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/d928709b7494bc0e296bea9148dd803e9d9599b1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d928709b7494bc0e296bea9148dd803e9d9599b1/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts?ref=d928709b7494bc0e296bea9148dd803e9d9599b1",
            "patch": "@@ -0,0 +1,59 @@\n+import type { Duplex } from 'stream'\n+import type { IncomingMessage, ServerResponse } from 'webpack-dev-server'\n+import { parseUrl } from '../../../lib/url'\n+import net from 'net'\n+\n+export const blockCrossSite = (\n+  req: IncomingMessage,\n+  res: ServerResponse | Duplex,\n+  allowedOrigins: string[],\n+  activePort: string\n+): boolean => {\n+  // only process _next URLs\n+  if (!req.url?.includes('/_next')) {\n+    return false\n+  }\n+  // block non-cors request from cross-site e.g. script tag on\n+  // different host\n+  if (\n+    req.headers['sec-fetch-mode'] === 'no-cors' &&\n+    req.headers['sec-fetch-site'] === 'cross-site'\n+  ) {\n+    if ('statusCode' in res) {\n+      res.statusCode = 403\n+    }\n+    res.end('Unauthorized')\n+    return true\n+  }\n+\n+  // ensure websocket requests from allowed origin\n+  const rawOrigin = req.headers['origin']\n+\n+  if (rawOrigin) {\n+    const parsedOrigin = parseUrl(rawOrigin)\n+\n+    if (parsedOrigin) {\n+      const originLowerCase = parsedOrigin.hostname.toLowerCase()\n+      const isMatchingPort = parsedOrigin.port === activePort\n+      const isIpRequest =\n+        net.isIPv4(originLowerCase) || net.isIPv6(originLowerCase)\n+\n+      if (\n+        // allow requests if direct IP and matching port and\n+        // allow if any of the allowed origins match\n+        !(isIpRequest && isMatchingPort) &&\n+        !allowedOrigins.some(\n+          (allowedOrigin) => allowedOrigin === originLowerCase\n+        )\n+      ) {\n+        if ('statusCode' in res) {\n+          res.statusCode = 403\n+        }\n+        res.end('Unauthorized')\n+        return true\n+      }\n+    }\n+  }\n+\n+  return false\n+}"
        },
        {
            "sha": "37a0773aa7375ac09b2805fd39419a14749e749e",
            "filename": "test/development/basic/misc.test.ts",
            "status": "modified",
            "additions": 103,
            "deletions": 1,
            "changes": 104,
            "blob_url": "https://github.com/vercel/next.js/blob/d928709b7494bc0e296bea9148dd803e9d9599b1/test%2Fdevelopment%2Fbasic%2Fmisc.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d928709b7494bc0e296bea9148dd803e9d9599b1/test%2Fdevelopment%2Fbasic%2Fmisc.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fmisc.test.ts?ref=d928709b7494bc0e296bea9148dd803e9d9599b1",
            "patch": "@@ -1,9 +1,10 @@\n import url from 'url'\n+import http from 'http'\n import { join } from 'path'\n import webdriver from 'next-webdriver'\n import { createNext, FileRef } from 'e2e-utils'\n import { NextInstance } from 'e2e-utils'\n-import { fetchViaHTTP, renderViaHTTP } from 'next-test-utils'\n+import { fetchViaHTTP, findPort, renderViaHTTP, retry } from 'next-test-utils'\n \n describe.each([[''], ['/docs']])(\n   'misc basic dev tests, basePath: %p',\n@@ -42,6 +43,107 @@ describe.each([[''], ['/docs']])(\n     })\n \n     describe('With Security Related Issues', () => {\n+      it('should not allow dev WebSocket from cross-site', async () => {\n+        let server = http.createServer((req, res) => {\n+          res.end(`\n+            <html>\n+              <head>\n+                <title>testing cross-site</title>\n+              </head>\n+              <body></body>\n+            </html>\n+          `)\n+        })\n+        try {\n+          const port = await findPort()\n+          await new Promise<void>((res) => {\n+            server.listen(port, () => res())\n+          })\n+          const websocketSnippet = `(() => {\n+            const statusEl = document.createElement('p')\n+            statusEl.id = 'status'\n+            document.querySelector('body').appendChild(statusEl)\n+\n+            const ws = new WebSocket(\"${next.url}/_next/webpack-hmr\")\n+            \n+            ws.addEventListener('error', (err) => {\n+              statusEl.innerText = 'error'\n+            })\n+            ws.addEventListener('open', () => {\n+              statusEl.innerText = 'connected'\n+            })\n+          })()`\n+\n+          // ensure direct port with mismatching port is blocked\n+          const browser = await webdriver(`http://127.0.0.1:${port}`, '/about')\n+          await browser.eval(websocketSnippet)\n+          await retry(async () => {\n+            expect(await browser.elementByCss('#status').text()).toBe('error')\n+          })\n+\n+          // ensure different host is blocked\n+          await browser.get(`https://example.vercel.sh/`)\n+          await browser.eval(websocketSnippet)\n+          await retry(async () => {\n+            expect(await browser.elementByCss('#status').text()).toBe('error')\n+          })\n+        } finally {\n+          server.close()\n+        }\n+      })\n+\n+      it('should not allow loading scripts from cross-site', async () => {\n+        let server = http.createServer((req, res) => {\n+          res.end(`\n+            <html>\n+              <head>\n+                <title>testing cross-site</title>\n+              </head>\n+              <body></body>\n+            </html>\n+          `)\n+        })\n+        try {\n+          const port = await findPort()\n+          await new Promise<void>((res) => {\n+            server.listen(port, () => res())\n+          })\n+          const scriptSnippet = `(() => {\n+            const statusEl = document.createElement('p')\n+            statusEl.id = 'status'\n+            document.querySelector('body').appendChild(statusEl)\n+\n+            const script = document.createElement('script')\n+            script.src = \"${next.url}/_next/static/chunks/pages/_app.js\"\n+            \n+            script.onerror = (err) => {\n+              statusEl.innerText = 'error'\n+            }\n+            script.onload = () => {\n+              statusEl.innerText = 'connected'\n+            }\n+            document.querySelector('body').appendChild(script)\n+          })()`\n+\n+          // ensure direct port with mismatching port is blocked\n+          const browser = await webdriver(`http://127.0.0.1:${port}`, '/about')\n+          await browser.eval(scriptSnippet)\n+          await retry(async () => {\n+            expect(await browser.elementByCss('#status').text()).toBe('error')\n+          })\n+\n+          // ensure different host is blocked\n+          await browser.get(`https://example.vercel.sh/`)\n+          await browser.eval(scriptSnippet)\n+\n+          await retry(async () => {\n+            expect(await browser.elementByCss('#status').text()).toBe('error')\n+          })\n+        } finally {\n+          server.close()\n+        }\n+      })\n+\n       it('should not allow accessing files outside .next/static and .next/server directory', async () => {\n         const pathsToCheck = [\n           basePath + '/_next/static/../BUILD_ID',"
        }
    ],
    "stats": {
        "total": 181,
        "additions": 180,
        "deletions": 1
    }
}