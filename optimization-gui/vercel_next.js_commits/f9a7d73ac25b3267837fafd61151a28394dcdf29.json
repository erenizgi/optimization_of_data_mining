{
    "author": "mischnic",
    "message": "Turbopack: scope hoist tree shaking modules as well (#80527)\n\nScope hoist the facade and the locals module (which are the only ones used in reexports-only tree shaking mode?) as well:\r\n\r\n![Bildschirmfoto 2025-06-14 um 14.13.36.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/sjZSbv6AFeuDg7Gb9rma/419a611c-f814-48d9-908c-980f2c6791bd.png)\r\n\r\nCloses PACK-2960\r\nBuilds on top of https://github.com/vercel/next.js/pull/79459",
    "sha": "f9a7d73ac25b3267837fafd61151a28394dcdf29",
    "files": [
        {
            "sha": "48360cdeb44241893a29b91c686a7a59777c62b9",
            "filename": "test/e2e/app-dir/dynamic-io-errors/utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a7d73ac25b3267837fafd61151a28394dcdf29/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a7d73ac25b3267837fafd61151a28394dcdf29/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Futils.ts?ref=f9a7d73ac25b3267837fafd61151a28394dcdf29",
            "patch": "@@ -35,13 +35,10 @@ export function getPrerenderOutput(\n       lines.push(\n         isMinified\n           ? line\n-              .replace(/at [\\w.]+ \\(.next[^)]+\\)/, replaceNextDistStackFrame)\n-              .replace(\n-                /at ([\\w.]+) \\(<anonymous>\\)/,\n-                replaceAnonymousStackFrame\n-              )\n+              .replace(/at \\S+ \\(.next[^)]+\\)/, replaceNextDistStackFrame)\n+              .replace(/at (\\S+) \\(<anonymous>\\)/, replaceAnonymousStackFrame)\n           : line.replace(\n-              /at ([\\w.]+) \\((webpack:\\/\\/)\\/src[^)]+\\)/,\n+              /at (\\S+) \\((webpack:\\/\\/)\\/src[^)]+\\)/,\n               `at $1 ($2<next-src>)`\n             )\n       )"
        },
        {
            "sha": "fa3eaa3988055b0ad246e353a88b9412f7ecaf96",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 23,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=f9a7d73ac25b3267837fafd61151a28394dcdf29",
            "patch": "@@ -746,28 +746,14 @@ impl MergeableModule for EcmascriptModuleAsset {\n         modules: Vc<MergeableModulesExposed>,\n         entry_points: Vc<MergeableModules>,\n     ) -> Result<Vc<Box<dyn ChunkableModule>>> {\n-        Ok(Vc::upcast(*MergedEcmascriptModule::new(\n-            modules\n-                .await?\n-                .iter()\n-                .map(|(m, exposed)| {\n-                    Ok((\n-                        ResolvedVc::try_sidecast::<Box<dyn EcmascriptAnalyzable>>(*m)\n-                            .context(\"expected EcmascriptAnalyzable\")?,\n-                        *exposed,\n-                    ))\n-                })\n-                .collect::<Result<Vec<_>>>()?,\n-            entry_points\n-                .await?\n-                .iter()\n-                .map(|m| {\n-                    ResolvedVc::try_sidecast::<Box<dyn EcmascriptAnalyzable>>(*m)\n-                        .context(\"expected EcmascriptAnalyzable\")\n-                })\n-                .collect::<Result<Vec<_>>>()?,\n-            self.options().to_resolved().await?,\n-        )))\n+        Ok(Vc::upcast(\n+            *MergedEcmascriptModule::new(\n+                modules,\n+                entry_points,\n+                self.options().to_resolved().await?,\n+            )\n+            .await?,\n+        ))\n     }\n }\n \n@@ -966,7 +952,7 @@ impl EcmascriptModuleContentOptions {\n \n             let part_code_gens = part_references\n                 .iter()\n-                .map(|r| r.code_generation(**chunking_context))\n+                .map(|r| r.code_generation(**chunking_context, scope_hoisting_context))\n                 .try_join()\n                 .await?;\n "
        },
        {
            "sha": "349e61b8283283ac33d638c3939b3b2a4d80d40c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/merged_module.rs",
            "status": "modified",
            "additions": 27,
            "deletions": 13,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmerged_module.rs?ref=f9a7d73ac25b3267837fafd61151a28394dcdf29",
            "patch": "@@ -1,10 +1,10 @@\n-use anyhow::Result;\n+use anyhow::{Context, Result};\n use turbo_tasks::{ResolvedVc, Vc};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{\n         AsyncModuleInfo, ChunkItem, ChunkType, ChunkableModule, ChunkingContext,\n-        MergeableModuleExposure,\n+        MergeableModuleExposure, MergeableModules, MergeableModulesExposed,\n     },\n     ident::AssetIdent,\n     module::Module,\n@@ -28,20 +28,34 @@ pub(crate) struct MergedEcmascriptModule {\n }\n \n impl MergedEcmascriptModule {\n-    pub fn new(\n-        modules: Vec<(\n-            ResolvedVc<Box<dyn EcmascriptAnalyzable>>,\n-            MergeableModuleExposure,\n-        )>,\n-        entry_points: Vec<ResolvedVc<Box<dyn EcmascriptAnalyzable>>>,\n+    pub async fn new(\n+        modules: Vc<MergeableModulesExposed>,\n+        entry_points: Vc<MergeableModules>,\n         options: ResolvedVc<EcmascriptOptions>,\n-    ) -> ResolvedVc<Self> {\n-        MergedEcmascriptModule {\n-            modules,\n-            entry_points,\n+    ) -> Result<ResolvedVc<Self>> {\n+        Ok(MergedEcmascriptModule {\n+            modules: modules\n+                .await?\n+                .iter()\n+                .map(|(m, exposed)| {\n+                    Ok((\n+                        ResolvedVc::try_sidecast::<Box<dyn EcmascriptAnalyzable>>(*m)\n+                            .context(\"expected EcmascriptAnalyzable\")?,\n+                        *exposed,\n+                    ))\n+                })\n+                .collect::<Result<Vec<_>>>()?,\n+            entry_points: entry_points\n+                .await?\n+                .iter()\n+                .map(|m| {\n+                    ResolvedVc::try_sidecast::<Box<dyn EcmascriptAnalyzable>>(*m)\n+                        .context(\"expected EcmascriptAnalyzable\")\n+                })\n+                .collect::<Result<Vec<_>>>()?,\n             options,\n         }\n-        .resolved_cell()\n+        .resolved_cell())\n     }\n }\n "
        },
        {
            "sha": "c8eed693255b8d26009974bf24ece14f50ff6efb",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/module.rs",
            "status": "modified",
            "additions": 27,
            "deletions": 2,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs?ref=f9a7d73ac25b3267837fafd61151a28394dcdf29",
            "patch": "@@ -6,7 +6,10 @@ use turbo_tasks::{ResolvedVc, Vc};\n use turbo_tasks_fs::{File, FileContent, glob::Glob};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n-    chunk::{AsyncModuleInfo, ChunkableModule, ChunkingContext, EvaluatableAsset},\n+    chunk::{\n+        AsyncModuleInfo, ChunkableModule, ChunkingContext, EvaluatableAsset, MergeableModule,\n+        MergeableModules, MergeableModulesExposed,\n+    },\n     ident::AssetIdent,\n     module::Module,\n     module_graph::ModuleGraph,\n@@ -17,7 +20,7 @@ use turbopack_core::{\n use super::chunk_item::EcmascriptModuleFacadeChunkItem;\n use crate::{\n     AnalyzeEcmascriptModuleResult, EcmascriptAnalyzable, EcmascriptModuleContent,\n-    EcmascriptModuleContentOptions, SpecifiedModuleType,\n+    EcmascriptModuleContentOptions, EcmascriptOptions, MergedEcmascriptModule, SpecifiedModuleType,\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n     code_gen::CodeGens,\n     parse::ParseResult,\n@@ -258,6 +261,9 @@ impl EcmascriptAnalyzable for EcmascriptModuleFacadeModule {\n             part_references,\n             code_generation: CodeGens::empty().to_resolved().await?,\n             async_module: ResolvedVc::cell(Some(self.async_module().to_resolved().await?)),\n+            // The facade module cannot generate source maps, because the inserted references\n+            // contain spans from the original module, but the facade module itself doesn't have the\n+            // original module's swc_common::SourceMap in `parsed`.\n             generate_source_map: false,\n             original_source_map: None,\n             exports: self.get_exports().to_resolved().await?,\n@@ -450,3 +456,22 @@ impl ChunkableModule for EcmascriptModuleFacadeModule {\n \n #[turbo_tasks::value_impl]\n impl EvaluatableAsset for EcmascriptModuleFacadeModule {}\n+\n+#[turbo_tasks::value_impl]\n+impl MergeableModule for EcmascriptModuleFacadeModule {\n+    #[turbo_tasks::function]\n+    async fn merge(\n+        self: Vc<Self>,\n+        modules: Vc<MergeableModulesExposed>,\n+        entry_points: Vc<MergeableModules>,\n+    ) -> Result<Vc<Box<dyn ChunkableModule>>> {\n+        Ok(Vc::upcast(\n+            *MergedEcmascriptModule::new(\n+                modules,\n+                entry_points,\n+                EcmascriptOptions::default().resolved_cell(),\n+            )\n+            .await?,\n+        ))\n+    }\n+}"
        },
        {
            "sha": "5913b238302c7f7c7c3fcd26e2a2f55ffe18d36e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/locals/module.rs",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs?ref=f9a7d73ac25b3267837fafd61151a28394dcdf29",
            "patch": "@@ -5,7 +5,10 @@ use turbo_tasks::{ResolvedVc, Vc};\n use turbo_tasks_fs::glob::Glob;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n-    chunk::{AsyncModuleInfo, ChunkableModule, ChunkingContext},\n+    chunk::{\n+        AsyncModuleInfo, ChunkableModule, ChunkingContext, MergeableModule, MergeableModules,\n+        MergeableModulesExposed,\n+    },\n     ident::AssetIdent,\n     module::Module,\n     module_graph::ModuleGraph,\n@@ -16,7 +19,7 @@ use turbopack_core::{\n use super::chunk_item::EcmascriptModuleLocalsChunkItem;\n use crate::{\n     AnalyzeEcmascriptModuleResult, EcmascriptAnalyzable, EcmascriptModuleAsset,\n-    EcmascriptModuleContent, EcmascriptModuleContentOptions,\n+    EcmascriptModuleContent, EcmascriptModuleContentOptions, MergedEcmascriptModule,\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n     references::{\n         async_module::OptionAsyncModule,\n@@ -205,3 +208,17 @@ impl ChunkableModule for EcmascriptModuleLocalsModule {\n         )\n     }\n }\n+\n+#[turbo_tasks::value_impl]\n+impl MergeableModule for EcmascriptModuleLocalsModule {\n+    #[turbo_tasks::function]\n+    async fn merge(\n+        &self,\n+        modules: Vc<MergeableModulesExposed>,\n+        entry_points: Vc<MergeableModules>,\n+    ) -> Result<Vc<Box<dyn ChunkableModule>>> {\n+        Ok(Vc::upcast(\n+            *MergedEcmascriptModule::new(modules, entry_points, self.module.await?.options).await?,\n+        ))\n+    }\n+}"
        },
        {
            "sha": "191ec8ec3b912560f8a60f398b7b71ceab7efeb5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/reference.rs",
            "status": "modified",
            "additions": 78,
            "deletions": 20,
            "changes": 98,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs?ref=f9a7d73ac25b3267837fafd61151a28394dcdf29",
            "patch": "@@ -1,6 +1,10 @@\n use anyhow::{Context, Result, bail};\n use serde::{Deserialize, Serialize};\n-use swc_core::{common::DUMMY_SP, quote};\n+use swc_core::{\n+    common::DUMMY_SP,\n+    ecma::ast::{Ident, Lit},\n+    quote,\n+};\n use turbo_rcstr::RcStr;\n use turbo_tasks::{NonLocalValue, ResolvedVc, ValueToString, Vc, trace::TraceRawVcs};\n use turbopack_core::{\n@@ -17,8 +21,11 @@ use super::{\n     facade::module::EcmascriptModuleFacadeModule, locals::module::EcmascriptModuleLocalsModule,\n };\n use crate::{\n-    ScopeHoistingContext, chunk::EcmascriptChunkPlaceable, code_gen::CodeGeneration,\n-    references::esm::base::ReferencedAsset, runtime_functions::TURBOPACK_IMPORT,\n+    ScopeHoistingContext,\n+    chunk::EcmascriptChunkPlaceable,\n+    code_gen::{CodeGeneration, CodeGenerationHoistedStmt},\n+    references::esm::base::{ReferencedAsset, ReferencedAssetIdent},\n+    runtime_functions::TURBOPACK_IMPORT,\n     utils::module_id_to_lit,\n };\n \n@@ -152,29 +159,80 @@ impl EcmascriptModulePartReference {\n     pub async fn code_generation(\n         self: Vc<Self>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n+        scope_hoisting_context: ScopeHoistingContext<'_>,\n     ) -> Result<CodeGeneration> {\n         let referenced_asset = ReferencedAsset::from_resolve_result(self.resolve_reference());\n         let referenced_asset = referenced_asset.await?;\n-        let ident = referenced_asset\n-            .get_ident(chunking_context, None, ScopeHoistingContext::None)\n-            .await?\n-            .context(\"part module reference should have an ident\")?\n-            .as_expr_individual(DUMMY_SP)\n-            .unwrap_left();\n+        let part = &self.await?.part;\n \n         let ReferencedAsset::Some(module) = *referenced_asset else {\n             bail!(\"part module reference should have an module reference\");\n         };\n-        let id = module.chunk_item_id(Vc::upcast(chunking_context)).await?;\n-\n-        Ok(CodeGeneration::hoisted_stmt(\n-            ident.sym.as_str().into(),\n-            quote!(\n-                \"var $name = $turbopack_import($id);\" as Stmt,\n-                name = ident,\n-                turbopack_import: Expr = TURBOPACK_IMPORT.into(),\n-                id: Expr = module_id_to_lit(&id),\n-            ),\n-        ))\n+\n+        let mut result = vec![];\n+\n+        let merged_index = scope_hoisting_context.get_module_index(module);\n+        if let Some(merged_index) = merged_index {\n+            // Insert a placeholder to inline the merged module at the right place\n+            // relative to the other references (so to keep reference order).\n+            result.push(CodeGenerationHoistedStmt::new(\n+                format!(\"hoisted {merged_index}\").into(),\n+                quote!(\n+                    \"__turbopack_merged_esm__($id);\" as Stmt,\n+                    id: Expr = Lit::Num(merged_index.into()).into(),\n+                ),\n+            ));\n+        }\n+\n+        if merged_index.is_some() && part == &ModulePart::Evaluation {\n+            // No need to import, the module was already executed and is available in the same scope\n+            // hoisting group (unless it's a namespace import)\n+        } else {\n+            let ident = referenced_asset\n+                .get_ident(\n+                    chunking_context,\n+                    match part {\n+                        ModulePart::Export(export)\n+                        | ModulePart::RenamedExport {\n+                            original_export: export,\n+                            ..\n+                        }\n+                        | ModulePart::RenamedNamespace { export } => Some(export.clone()),\n+                        ModulePart::Internal(_)\n+                        | ModulePart::Locals\n+                        | ModulePart::Exports\n+                        | ModulePart::Facade\n+                        | ModulePart::Evaluation => None,\n+                    },\n+                    scope_hoisting_context,\n+                )\n+                .await?\n+                .context(\"part module reference should have an ident\")?;\n+\n+            match ident {\n+                ReferencedAssetIdent::LocalBinding { .. } => {\n+                    // no need to import\n+                }\n+                ReferencedAssetIdent::Module { .. } => {\n+                    let (sym, ctxt) = ident.into_module_namespace_ident().unwrap();\n+                    let key = sym.as_str().into();\n+                    let name = Ident::new(sym.into(), DUMMY_SP, ctxt.unwrap_or_default());\n+\n+                    let id = module.chunk_item_id(Vc::upcast(chunking_context)).await?;\n+\n+                    result.push(CodeGenerationHoistedStmt::new(\n+                        key,\n+                        quote!(\n+                            \"var $name = $turbopack_import($id);\" as Stmt,\n+                            name = name,\n+                            turbopack_import: Expr = TURBOPACK_IMPORT.into(),\n+                            id: Expr = module_id_to_lit(&id),\n+                        ),\n+                    ));\n+                }\n+            }\n+        }\n+\n+        Ok(CodeGeneration::hoisted_stmts(result))\n     }\n }"
        },
        {
            "sha": "dd285ace015e8c0a5fcd8d9901f14b6c9faac9de",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/exports/invalid-export/input/index.js",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f9a7d73ac25b3267837fafd61151a28394dcdf29/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fexports%2Finvalid-export%2Finput%2Findex.js?ref=f9a7d73ac25b3267837fafd61151a28394dcdf29",
            "patch": "@@ -1,3 +1,10 @@\n it('should error when importing an invalid export', () => {\n-  expect(require('./invalid-export').default).toBe(undefined)\n+  // Either requiring should throw, or return undefined\n+  let ns\n+  try {\n+    ns = require('./invalid-export')\n+  } catch {\n+    return\n+  }\n+  expect(ns.default).toBe(undefined)\n })"
        }
    ],
    "stats": {
        "total": 238,
        "additions": 171,
        "deletions": 67
    }
}