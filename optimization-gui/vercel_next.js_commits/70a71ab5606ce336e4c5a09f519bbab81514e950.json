{
    "author": "ijjk",
    "message": "Fix bad decoding for x-matched-path header (#78677)\n\nThis is a follow-up to https://github.com/vercel/next.js/pull/78326\nwhich reverts the change that interferes with the added middleware\nrewrite test while also ensuring the encoding test from the\n`vercel/vercel` repo is still passing as expected. The issue with the\nencoding seems to be from the `x-matched-path` value being incorrectly\ndecoded when using non-utf8 characters so this fixes the encoding.\n\nFixes:\nhttps://github.com/vercel/next.js/actions/runs/14717733032/attempts/2\n\n<details>\n\n<summary>test runs with patch</summary>\n\n\n![CleanShot 2025-04-29 at 09 21\n44@2x](https://github.com/user-attachments/assets/de5d66c5-5eb2-4e87-877e-875a7c937f35)\n![CleanShot 2025-04-29 at 09 21\n51@2x](https://github.com/user-attachments/assets/f1743f6c-d06c-4999-869a-9afaf1b69ab5)\n\n</details>",
    "sha": "70a71ab5606ce336e4c5a09f519bbab81514e950",
    "files": [
        {
            "sha": "ade2968cff7d58a1dad530de38c8c523544cd1d8",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/70a71ab5606ce336e4c5a09f519bbab81514e950/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/70a71ab5606ce336e4c5a09f519bbab81514e950/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=70a71ab5606ce336e4c5a09f519bbab81514e950",
            "patch": "@@ -177,6 +177,7 @@ import {\n import { InvariantError } from '../shared/lib/invariant-error'\n import { decodeQueryPathParameter } from './lib/decode-query-path-parameter'\n import { getCacheHandlers } from './use-cache/handlers'\n+import { fixMojibake } from './lib/fix-mojibake'\n \n export type FindComponentsResult = {\n   components: LoadComponentsReturnType\n@@ -1096,7 +1097,7 @@ export default abstract class Server<\n           // x-matched-path is the source of truth, it tells what page\n           // should be rendered because we don't process rewrites in minimalMode\n           let { pathname: matchedPath } = new URL(\n-            req.headers[MATCHED_PATH_HEADER] as string,\n+            fixMojibake(req.headers[MATCHED_PATH_HEADER] as string),\n             'http://localhost'\n           )\n \n@@ -1249,9 +1250,14 @@ export default abstract class Server<\n           if (pageIsDynamic) {\n             let params: ParsedUrlQuery | false = {}\n \n-            // ensure we normalize the dynamic route params for encoding/\n-            // default values\n-            paramsResult = utils.normalizeDynamicRouteParams(queryParams, false)\n+            // If we don't already have valid params, try to parse them from\n+            // the query params.\n+            if (!paramsResult.hasValidParams) {\n+              paramsResult = utils.normalizeDynamicRouteParams(\n+                queryParams,\n+                false\n+              )\n+            }\n \n             // for prerendered ISR paths we attempt parsing the route\n             // params from the URL directly as route-matches may not"
        },
        {
            "sha": "824f8e578918168f99adb2d43be3607e2ed3fb2a",
            "filename": "packages/next/src/server/lib/fix-mojibake.test.ts",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/70a71ab5606ce336e4c5a09f519bbab81514e950/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ffix-mojibake.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/70a71ab5606ce336e4c5a09f519bbab81514e950/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ffix-mojibake.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ffix-mojibake.test.ts?ref=70a71ab5606ce336e4c5a09f519bbab81514e950",
            "patch": "@@ -0,0 +1,21 @@\n+import { fixMojibake } from './fix-mojibake'\n+\n+describe('Mojibake handling', () => {\n+  const validValues = [\n+    'hello-world',\n+    'hello world',\n+    encodeURIComponent('こんにちは'),\n+  ]\n+  it.each(validValues)(\n+    'should maintain value when encoding is correct $1',\n+    (testValue) => {\n+      expect(fixMojibake(testValue)).toBe(testValue)\n+    }\n+  )\n+\n+  it('should fix invalid encoding', () => {\n+    expect(fixMojibake('/blog/ã\\x81\\x93ã\\x82\\x93ã\\x81«ã\\x81¡ã\\x81¯')).toBe(\n+      '/blog/こんにちは'\n+    )\n+  })\n+})"
        },
        {
            "sha": "0bda8b851ac6d9b96859c4c519e4ad97e0beaa61",
            "filename": "packages/next/src/server/lib/fix-mojibake.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/70a71ab5606ce336e4c5a09f519bbab81514e950/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ffix-mojibake.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/70a71ab5606ce336e4c5a09f519bbab81514e950/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ffix-mojibake.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Ffix-mojibake.ts?ref=70a71ab5606ce336e4c5a09f519bbab81514e950",
            "patch": "@@ -0,0 +1,14 @@\n+// x-matched-path header can be decoded incorrectly\n+// and should only be utf8 characters so this fixes\n+// incorrectly encoded values\n+export function fixMojibake(input: string): string {\n+  // Convert each character's char code to a byte\n+  const bytes = new Uint8Array(input.length)\n+  for (let i = 0; i < input.length; i++) {\n+    bytes[i] = input.charCodeAt(i)\n+  }\n+\n+  // Decode the bytes as proper UTF-8\n+  const decoder = new TextDecoder('utf-8')\n+  return decoder.decode(bytes)\n+}"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 45,
        "deletions": 4
    }
}