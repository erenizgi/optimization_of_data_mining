{
    "author": "kristian240",
    "message": "feat: make typed routes output deterministic (#80432)\n\n### What?\n\nThis PR makes changes to the next plugin for typed routes. The issue\nhere is that the output of the plugin, specifically the part where\nstatic and dynamic routes are defined changes constantly. This PR makes\nthe output of the plugin deterministic.\n\n### Why?\n\nWe work in a monorepo with multiple Next.js projects. We encountered\nmultiple issues with git and git hooks. If you had a stale `.next`\noutput the routes type would also be stale and caused issues on commit\nwhen you want to sync your work with an upbranch causing either to\nrebuild the app you are not developing or completly removing the `.next`\nfolder. As a solution we choose to commit `.next/types/link.d.ts` (the\noutput file of the mentioned next.js plugin) and that solved the issue.\n\nNow we have a smaller issue regarding the un-deterministic file output\nwhich I want to solve with this MR.\n\n### How?\n\nBefore writing the routes in the file, the routes are sorted using\nnative `sort` method on the array instance. The actual sort order is not\nrelevant here, the fact that the output is in the same order everytime\nis the key.\n\n---------\n\nCo-authored-by: Steven <steven@ceriously.com>",
    "sha": "a9c3206cccc9e018da623d2fe0a89ff016c5feda",
    "files": [
        {
            "sha": "cb43d3305aacf5a512e224471f706f91fd280e1a",
            "filename": "packages/next/src/build/webpack/plugins/next-types-plugin/index.ts",
            "status": "modified",
            "additions": 38,
            "deletions": 21,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/a9c3206cccc9e018da623d2fe0a89ff016c5feda/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a9c3206cccc9e018da623d2fe0a89ff016c5feda/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-types-plugin%2Findex.ts?ref=a9c3206cccc9e018da623d2fe0a89ff016c5feda",
            "patch": "@@ -240,18 +240,21 @@ const pluginState = getProxiedPluginState({\n   collectedRootParams: {} as Record<string, string[]>,\n   routeTypes: {\n     edge: {\n-      static: '',\n-      dynamic: '',\n+      static: [],\n+      dynamic: [],\n     },\n     node: {\n-      static: '',\n-      dynamic: '',\n+      static: [],\n+      dynamic: [],\n     },\n     extra: {\n-      static: '',\n-      dynamic: '',\n+      static: [],\n+      dynamic: [],\n     },\n-  } as Record<'edge' | 'node' | 'extra', Record<'static' | 'dynamic', string>>,\n+  } as Record<\n+    'edge' | 'node' | 'extra',\n+    Record<'static' | 'dynamic', string[]>\n+  >,\n })\n \n function formatRouteToRouteType(route: string) {\n@@ -278,7 +281,7 @@ function formatRouteToRouteType(route: string) {\n \n   return {\n     isDynamic,\n-    routeType: `\\n    | \\`${route}\\``,\n+    routeType: route,\n   }\n }\n \n@@ -356,8 +359,9 @@ function addRedirectsRewritesRouteTypes(\n \n       for (const normalizedRoute of possibleNormalizedRoutes) {\n         const { isDynamic, routeType } = formatRouteToRouteType(normalizedRoute)\n-        pluginState.routeTypes.extra[isDynamic ? 'dynamic' : 'static'] +=\n+        pluginState.routeTypes.extra[isDynamic ? 'dynamic' : 'static'].push(\n           routeType\n+        )\n       }\n     }\n   }\n@@ -385,18 +389,31 @@ function addRedirectsRewritesRouteTypes(\n   }\n }\n \n+function serializeRouteTypes(routeTypes: string[]) {\n+  // route collection is not deterministic, this makes the output of the file deterministic\n+  return routeTypes\n+    .sort()\n+    .map((route) => `\\n    | \\`${route}\\``)\n+    .join('')\n+}\n+\n function createRouteDefinitions() {\n-  let staticRouteTypes = ''\n-  let dynamicRouteTypes = ''\n+  let staticRouteTypes = []\n+  let dynamicRouteTypes = []\n \n   for (const type of ['edge', 'node', 'extra'] as const) {\n-    staticRouteTypes += pluginState.routeTypes[type].static\n-    dynamicRouteTypes += pluginState.routeTypes[type].dynamic\n+    staticRouteTypes.push(...pluginState.routeTypes[type].static)\n+    dynamicRouteTypes.push(...pluginState.routeTypes[type].dynamic)\n   }\n \n+  const serializedStaticRouteTypes = serializeRouteTypes(staticRouteTypes)\n+  const serializedDynamicRouteTypes = serializeRouteTypes(dynamicRouteTypes)\n+\n   // If both StaticRoutes and DynamicRoutes are empty, fallback to type 'string & {}'.\n   const routeTypesFallback =\n-    !staticRouteTypes && !dynamicRouteTypes ? 'string & {}' : ''\n+    !serializedStaticRouteTypes && !serializedDynamicRouteTypes\n+      ? 'string & {}'\n+      : ''\n \n   return `// Type definitions for Next.js routes\n \n@@ -428,9 +445,9 @@ declare namespace __next_route_internal_types__ {\n   type OptionalCatchAllSlug<S extends string> =\n     S extends \\`\\${string}\\${SearchOrHash}\\` ? never : S\n \n-  type StaticRoutes = ${staticRouteTypes || 'never'}\n+  type StaticRoutes = ${serializedStaticRouteTypes || 'never'}\n   type DynamicRoutes<T extends string = string> = ${\n-    dynamicRouteTypes || 'never'\n+    serializedDynamicRouteTypes || 'never'\n   }\n \n   type RouteImpl<T> = ${\n@@ -887,7 +904,7 @@ export class NextTypesPlugin {\n \n     pluginState.routeTypes[this.isEdgeServer ? 'edge' : 'node'][\n       isDynamic ? 'dynamic' : 'static'\n-    ] += routeType\n+    ].push(routeType)\n   }\n \n   apply(compiler: webpack.Compiler) {\n@@ -1014,11 +1031,11 @@ export class NextTypesPlugin {\n \n           // Clear routes\n           if (this.isEdgeServer) {\n-            pluginState.routeTypes.edge.dynamic = ''\n-            pluginState.routeTypes.edge.static = ''\n+            pluginState.routeTypes.edge.dynamic = []\n+            pluginState.routeTypes.edge.static = []\n           } else {\n-            pluginState.routeTypes.node.dynamic = ''\n-            pluginState.routeTypes.node.static = ''\n+            pluginState.routeTypes.node.dynamic = []\n+            pluginState.routeTypes.node.static = []\n           }\n \n           compilation.chunkGroups.forEach((chunkGroup) => {"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 38,
        "deletions": 21
    }
}