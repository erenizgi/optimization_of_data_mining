{
    "author": "timneutkens",
    "message": "Turbopack: Support string without options for @next/mdx (#81713)\n\n## What?\n\nAdds support for `remarkPlugins: ['remark-gfm']` and `rehypePlugins:\n['rehype-slug']`.\n\nPreviously you had to nest an array like `remarkPlugins:\n[['remark-gfm']]` but that's a bug, that case is only for passing\noptions. Directly passing the string without options should be allowed.\nThis PR implements that.",
    "sha": "115eff7201191fcc1d2f10bbc4c69f5359897311",
    "files": [
        {
            "sha": "44e5eeb8312132226e13fedb95a2b96e13d16d06",
            "filename": "docs/01-app/02-guides/mdx.mdx",
            "status": "modified",
            "additions": 13,
            "deletions": 3,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/115eff7201191fcc1d2f10bbc4c69f5359897311/docs%2F01-app%2F02-guides%2Fmdx.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/115eff7201191fcc1d2f10bbc4c69f5359897311/docs%2F01-app%2F02-guides%2Fmdx.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F02-guides%2Fmdx.mdx?ref=115eff7201191fcc1d2f10bbc4c69f5359897311",
            "patch": "@@ -727,8 +727,18 @@ const nextConfig = {\n \n const withMDX = createMDX({\n   options: {\n-    remarkPlugins: [],\n-    rehypePlugins: [['rehype-katex', { strict: true, throwOnError: true }]],\n+    remarkPlugins: [\n+      // Without options\n+      'remark-gfm',\n+      // With options\n+      ['remark-toc', { heading: 'The Table' }],\n+    ],\n+    rehypePlugins: [\n+      // Without options\n+      'rehype-slug',\n+      // With options\n+      ['rehype-katex', { strict: true, throwOnError: true }],\n+    ],\n   },\n })\n \n@@ -737,7 +747,7 @@ export default withMDX(nextConfig)\n \n > **Good to know**:\n >\n-> remark and rehype plugins without serializable options cannot be used yet with [Turbopack](/docs/app/api-reference/turbopack), due to [inability to pass JavaScript functions to Rust](https://github.com/vercel/next.js/issues/71819#issuecomment-2461802968)\n+> remark and rehype plugins without serializable options cannot be used yet with [Turbopack](/docs/app/api-reference/turbopack), because JavaScript functions can't be passed to Rust.\n \n ## Remote MDX\n "
        },
        {
            "sha": "5460628456ebf873bef5a9683a1d62140d2b8b6f",
            "filename": "packages/next-mdx/index.d.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/115eff7201191fcc1d2f10bbc4c69f5359897311/packages%2Fnext-mdx%2Findex.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/115eff7201191fcc1d2f10bbc4c69f5359897311/packages%2Fnext-mdx%2Findex.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-mdx%2Findex.d.ts?ref=115eff7201191fcc1d2f10bbc4c69f5359897311",
            "patch": "@@ -21,7 +21,22 @@ declare namespace nextMDX {\n      *\n      * @see https://mdxjs.com/packages/mdx/#api\n      */\n-    options?: Options\n+    options?: Options & {\n+      remarkPlugins?:\n+        | (\n+            | string\n+            | [name: string, options: any]\n+            | NonNullable<Options['remarkPlugins']>[number]\n+          )[]\n+        | Options['remarkPlugins']\n+      rehypePlugins?:\n+        | (\n+            | string\n+            | [name: string, options: any]\n+            | NonNullable<Options['rehypePlugins']>[number]\n+          )[]\n+        | Options['rehypePlugins']\n+    }\n   }\n }\n "
        },
        {
            "sha": "1182c6ed5e7a7be2b73328a6ffe1e742a034d4e5",
            "filename": "packages/next-mdx/mdx-js-loader.js",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/115eff7201191fcc1d2f10bbc4c69f5359897311/packages%2Fnext-mdx%2Fmdx-js-loader.js",
            "raw_url": "https://github.com/vercel/next.js/raw/115eff7201191fcc1d2f10bbc4c69f5359897311/packages%2Fnext-mdx%2Fmdx-js-loader.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-mdx%2Fmdx-js-loader.js?ref=115eff7201191fcc1d2f10bbc4c69f5359897311",
            "patch": "@@ -5,15 +5,22 @@ function interopDefault(mod) {\n   return mod.default || mod\n }\n \n+async function importPluginForPath(pluginPath, projectRoot) {\n+  const path = require.resolve(pluginPath, { paths: [projectRoot] })\n+  return interopDefault(\n+    // \"use pathToFileUrl to make esm import()s work with absolute windows paths\":\n+    // on windows import(\"C:\\\\path\\\\to\\\\file\") is not valid, so we need to use file:// URLs\n+    // https://github.com/vercel/next.js/commit/fbf9e12de095e0237d4ba4aa6139d9757bd20be9\n+    await import(process.platform === 'win32' ? pathToFileURL(path) : path)\n+  )\n+}\n+\n async function importPlugin(plugin, projectRoot) {\n   if (Array.isArray(plugin) && typeof plugin[0] === 'string') {\n-    const path = require.resolve(plugin[0], { paths: [projectRoot] })\n-    plugin[0] = interopDefault(\n-      // \"use pathToFileUrl to make esm import()s work with absolute windows paths\":\n-      // on windows import(\"C:\\\\path\\\\to\\\\file\") is not valid, so we need to use file:// URLs\n-      // https://github.com/vercel/next.js/commit/fbf9e12de095e0237d4ba4aa6139d9757bd20be9\n-      await import(process.platform === 'win32' ? pathToFileURL(path) : path)\n-    )\n+    plugin[0] = await importPluginForPath(plugin[0], projectRoot)\n+  }\n+  if (typeof plugin === 'string') {\n+    plugin = await importPluginForPath(plugin, projectRoot)\n   }\n   return plugin\n }"
        },
        {
            "sha": "d56857b0b4fd6d2b5a9058653547dd7b5a1d8950",
            "filename": "test/e2e/app-dir/mdx/app/remark-plugin/page.mdx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/115eff7201191fcc1d2f10bbc4c69f5359897311/test%2Fe2e%2Fapp-dir%2Fmdx%2Fapp%2Fremark-plugin%2Fpage.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/115eff7201191fcc1d2f10bbc4c69f5359897311/test%2Fe2e%2Fapp-dir%2Fmdx%2Fapp%2Fremark-plugin%2Fpage.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmdx%2Fapp%2Fremark-plugin%2Fpage.mdx?ref=115eff7201191fcc1d2f10bbc4c69f5359897311",
            "patch": "@@ -0,0 +1,10 @@\n+# The Table\n+\n+# Remark plugin\n+\n+Testing emoji: :dog: :+1:\n+\n+## Todo List\n+\n+- [ ] Implement\n+- [x] Implemented"
        },
        {
            "sha": "f65ce80f065232cb2bd02b0a30054ae629af5254",
            "filename": "test/e2e/app-dir/mdx/mdx.test.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 2,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/115eff7201191fcc1d2f10bbc4c69f5359897311/test%2Fe2e%2Fapp-dir%2Fmdx%2Fmdx.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/115eff7201191fcc1d2f10bbc4c69f5359897311/test%2Fe2e%2Fapp-dir%2Fmdx%2Fmdx.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmdx%2Fmdx.test.ts?ref=115eff7201191fcc1d2f10bbc4c69f5359897311",
            "patch": "@@ -9,6 +9,9 @@ for (const type of ['with-mdx-rs', 'without-mdx-rs']) {\n         '@mdx-js/loader': '^2.2.1',\n         '@mdx-js/react': '^2.2.1',\n         'rehype-katex': '7.0.1',\n+        'rehype-slug': '6.0.0',\n+        'remark-gfm': '4.0.1',\n+        'remark-toc': '9.0.0',\n       },\n       env: {\n         WITH_MDX_RS: type === 'with-mdx-rs' ? 'true' : 'false',\n@@ -62,10 +65,22 @@ for (const type of ['with-mdx-rs', 'without-mdx-rs']) {\n       })\n \n       if (type === 'without-mdx-rs') {\n-        it('should run plugins', async () => {\n-          const html = await next.render('/rehype-plugin')\n+        it('should run rehype plugins', async () => {\n+          const $ = await next.render$('/rehype-plugin')\n+          const html = $('html').html()\n           expect(html.includes('<mi>C</mi>')).toBe(true)\n           expect(html.includes('<mi>L</mi>')).toBe(true)\n+          expect($('#rehype-plugin').text()).toBe('Rehype plugin')\n+        })\n+\n+        it('should run remark plugins', async () => {\n+          const $ = await next.render$('/remark-plugin')\n+          const html = $('html').html()\n+          expect(html.includes('The Table')).toBe(true)\n+          expect($('a[href=\"#todo-list\"]').text()).toBe('Todo List')\n+\n+          expect($('input[type=\"checkbox\"]').length).toBe(2)\n+          expect($('input[type=\"checkbox\"][checked]').length).toBe(1)\n         })\n       }\n     })"
        },
        {
            "sha": "5781c142152435910a38f75166f7c66bfc60e544",
            "filename": "test/e2e/app-dir/mdx/next.config.ts",
            "status": "renamed",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/115eff7201191fcc1d2f10bbc4c69f5359897311/test%2Fe2e%2Fapp-dir%2Fmdx%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/115eff7201191fcc1d2f10bbc4c69f5359897311/test%2Fe2e%2Fapp-dir%2Fmdx%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmdx%2Fnext.config.ts?ref=115eff7201191fcc1d2f10bbc4c69f5359897311",
            "patch": "@@ -2,8 +2,11 @@ import nextMDX from '@next/mdx'\n const withMDX = nextMDX({\n   extension: /\\.mdx?$/,\n   options: {\n-    remarkPlugins: [],\n-    rehypePlugins: [['rehype-katex', { strict: true, throwOnError: true }]],\n+    remarkPlugins: ['remark-gfm', ['remark-toc', { heading: 'The Table' }]],\n+    rehypePlugins: [\n+      'rehype-slug',\n+      ['rehype-katex', { strict: true, throwOnError: true }],\n+    ],\n   },\n })\n ",
            "previous_filename": "test/e2e/app-dir/mdx/next.config.mjs"
        }
    ],
    "stats": {
        "total": 90,
        "additions": 75,
        "deletions": 15
    }
}