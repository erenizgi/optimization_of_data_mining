{
    "author": "sokra",
    "message": "[Turbopack] add ChunkingType::Shared (#76228)\n\n### What?\n\nuse ChunkingType::Shared for server utils and components",
    "sha": "c8ac0bdd609561e61a6839c5ef6124ee41b56889",
    "files": [
        {
            "sha": "14c89d3d01f015793e6d56eea30cd6959a22f336",
            "filename": "crates/next-core/src/next_server_component/server_component_reference.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac0bdd609561e61a6839c5ef6124ee41b56889/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac0bdd609561e61a6839c5ef6124ee41b56889/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server_component%2Fserver_component_reference.rs?ref=c8ac0bdd609561e61a6839c5ef6124ee41b56889",
            "patch": "@@ -2,7 +2,9 @@ use anyhow::Result;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n use turbopack_core::{\n-    chunk::ChunkableModuleReference, module::Module, reference::ModuleReference,\n+    chunk::{ChunkableModuleReference, ChunkingType, ChunkingTypeOption},\n+    module::Module,\n+    reference::ModuleReference,\n     resolve::ModuleResolveResult,\n };\n \n@@ -42,4 +44,12 @@ impl ModuleReference for NextServerComponentModuleReference {\n }\n \n #[turbo_tasks::value_impl]\n-impl ChunkableModuleReference for NextServerComponentModuleReference {}\n+impl ChunkableModuleReference for NextServerComponentModuleReference {\n+    #[turbo_tasks::function]\n+    fn chunking_type(&self) -> Vc<ChunkingTypeOption> {\n+        Vc::cell(Some(ChunkingType::Shared {\n+            inherit_async: true,\n+            merge_tag: None,\n+        }))\n+    }\n+}"
        },
        {
            "sha": "1fee48cf48f03f5421894a31aa19ed93f08aaaaa",
            "filename": "crates/next-core/src/next_server_utility/server_utility_reference.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 2,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac0bdd609561e61a6839c5ef6124ee41b56889/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac0bdd609561e61a6839c5ef6124ee41b56889/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server_utility%2Fserver_utility_reference.rs?ref=c8ac0bdd609561e61a6839c5ef6124ee41b56889",
            "patch": "@@ -2,7 +2,9 @@ use anyhow::Result;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n use turbopack_core::{\n-    chunk::ChunkableModuleReference, module::Module, reference::ModuleReference,\n+    chunk::{ChunkableModuleReference, ChunkingType, ChunkingTypeOption},\n+    module::Module,\n+    reference::ModuleReference,\n     resolve::ModuleResolveResult,\n };\n \n@@ -42,4 +44,12 @@ impl ModuleReference for NextServerUtilityModuleReference {\n }\n \n #[turbo_tasks::value_impl]\n-impl ChunkableModuleReference for NextServerUtilityModuleReference {}\n+impl ChunkableModuleReference for NextServerUtilityModuleReference {\n+    #[turbo_tasks::function]\n+    fn chunking_type(&self) -> Vc<ChunkingTypeOption> {\n+        Vc::cell(Some(ChunkingType::Shared {\n+            inherit_async: true,\n+            merge_tag: Some(\"next-server-utility\".into()),\n+        }))\n+    }\n+}"
        },
        {
            "sha": "6f17f7740c8b24a147539145413a7b367a40266e",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunk_group.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunk_group.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunk_group.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunk_group.rs?ref=c8ac0bdd609561e61a6839c5ef6124ee41b56889",
            "patch": "@@ -242,7 +242,9 @@ pub async fn chunk_group_content(\n                 };\n \n                 Ok(match edge {\n-                    ChunkingType::Parallel | ChunkingType::ParallelInheritAsync => {\n+                    ChunkingType::Parallel\n+                    | ChunkingType::ParallelInheritAsync\n+                    | ChunkingType::Shared { .. } => {\n                         if is_available {\n                             GraphTraversalAction::Skip\n                         } else {"
        },
        {
            "sha": "7ce44a62fa590c7a0ea74939e6e166d0822a3e90",
            "filename": "turbopack/crates/turbopack-core/src/chunk/mod.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs?ref=c8ac0bdd609561e61a6839c5ef6124ee41b56889",
            "patch": "@@ -168,6 +168,7 @@ pub enum ChunkingType {\n     Parallel,\n     /// Module is placed in the same chunk group and is loaded in parallel. It\n     /// becomes an async module when the referenced module is async.\n+    // TODO make inherit_async a separate field\n     ParallelInheritAsync,\n     /// An async loader is placed into the referencing chunk and loads the\n     /// separate chunk group in which the module is placed.\n@@ -179,6 +180,13 @@ pub enum ChunkingType {\n         _ty: ChunkGroupType,\n         merge_tag: Option<RcStr>,\n     },\n+    /// Create a new chunk group in a separate context, merging references with the same tag into a\n+    /// single chunk group. It provides available modules to the current chunk group. It's assumed\n+    /// to be loaded before the current chunk group.\n+    Shared {\n+        inherit_async: bool,\n+        merge_tag: Option<RcStr>,\n+    },\n     // Module not placed in chunk group, but its references are still followed.\n     Traced,\n }"
        },
        {
            "sha": "47eb5138d624b5e46e9902a36e0dca189e107559",
            "filename": "turbopack/crates/turbopack-core/src/introspect/utils.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fintrospect%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fintrospect%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fintrospect%2Futils.rs?ref=c8ac0bdd609561e61a6839c5ef6124ee41b56889",
            "patch": "@@ -38,6 +38,11 @@ fn isolated_reference_ty() -> Vc<RcStr> {\n     Vc::cell(\"isolated reference\".into())\n }\n \n+#[turbo_tasks::function]\n+fn shared_reference_ty() -> Vc<RcStr> {\n+    Vc::cell(\"shared reference\".into())\n+}\n+\n #[turbo_tasks::function]\n fn traced_reference_ty() -> Vc<RcStr> {\n     Vc::cell(\"traced reference\".into())\n@@ -82,6 +87,7 @@ pub async fn children_from_module_references(\n                 }\n                 Some(ChunkingType::Async) => key = async_reference_ty(),\n                 Some(ChunkingType::Isolated { .. }) => key = isolated_reference_ty(),\n+                Some(ChunkingType::Shared { .. }) => key = shared_reference_ty(),\n                 Some(ChunkingType::Traced) => key = traced_reference_ty(),\n             }\n         }"
        },
        {
            "sha": "9eb1e3929ea8b408da2a4668d69b1a00353f1cd7",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/async_module_info.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fasync_module_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fasync_module_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fasync_module_info.rs?ref=c8ac0bdd609561e61a6839c5ef6124ee41b56889",
            "patch": "@@ -88,15 +88,23 @@ async fn compute_async_module_info_single(\n \n             // edges.push((parent_module, module, async_modules.contains(&module)));\n             match chunking_type {\n-                ChunkingType::ParallelInheritAsync => {\n+                ChunkingType::ParallelInheritAsync\n+                | ChunkingType::Shared {\n+                    inherit_async: true,\n+                    ..\n+                } => {\n                     if async_modules.contains(&module) {\n                         async_modules.insert(parent_module);\n                     }\n                 }\n                 ChunkingType::Parallel\n                 | ChunkingType::Async\n                 | ChunkingType::Isolated { .. }\n-                | ChunkingType::Traced => {\n+                | ChunkingType::Traced\n+                | ChunkingType::Shared {\n+                    inherit_async: false,\n+                    ..\n+                } => {\n                     // Nothing to propagate\n                 }\n             }"
        },
        {
            "sha": "f52d371c2a48783d20d644b90b24da09dca873eb",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/chunk_group_info.rs",
            "status": "modified",
            "additions": 49,
            "deletions": 5,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac0bdd609561e61a6839c5ef6124ee41b56889/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs?ref=c8ac0bdd609561e61a6839c5ef6124ee41b56889",
            "patch": "@@ -107,15 +107,25 @@ pub enum ChunkGroup {\n         merge_tag: RcStr,\n         entries: Vec<ResolvedVc<Box<dyn Module>>>,\n     },\n+    /// a module with an incoming non-merging shared edge\n+    Shared(ResolvedVc<Box<dyn Module>>),\n+    /// a module with an incoming merging shared edge\n+    SharedMerged {\n+        parent: usize,\n+        merge_tag: RcStr,\n+        entries: Vec<ResolvedVc<Box<dyn Module>>>,\n+    },\n }\n \n impl ChunkGroup {\n     pub fn entries(&self) -> impl Iterator<Item = ResolvedVc<Box<dyn Module>>> + '_ {\n         match self {\n-            ChunkGroup::Entry(e) | ChunkGroup::Async(e) | ChunkGroup::Isolated(e) => {\n-                Either::Left(std::iter::once(*e))\n-            }\n-            ChunkGroup::IsolatedMerged { entries, .. } => Either::Right(entries.iter().copied()),\n+            ChunkGroup::Entry(e)\n+            | ChunkGroup::Async(e)\n+            | ChunkGroup::Isolated(e)\n+            | ChunkGroup::Shared(e) => Either::Left(std::iter::once(*e)),\n+            ChunkGroup::IsolatedMerged { entries, .. }\n+            | ChunkGroup::SharedMerged { entries, .. } => Either::Right(entries.iter().copied()),\n         }\n     }\n }\n@@ -133,6 +143,13 @@ enum ChunkGroupKey {\n         parent: ChunkGroupId,\n         merge_tag: RcStr,\n     },\n+    /// a module with an incoming merging shared edge\n+    Shared(ResolvedVc<Box<dyn Module>>),\n+    /// a module with an incoming merging shared edge\n+    SharedMerged {\n+        parent: ChunkGroupId,\n+        merge_tag: RcStr,\n+    },\n }\n \n #[derive(Debug, Copy, Clone, PartialEq, Eq, Hash, Serialize, Deserialize)]\n@@ -253,6 +270,11 @@ pub async fn compute_chunk_group_info(graph: &ModuleGraph) -> Result<Vc<ChunkGro\n                         } => ChunkGroupInheritance::ChunkGroup(Either::Left(std::iter::once(\n                             ChunkGroupKey::Isolated(node.module),\n                         ))),\n+                        ChunkingType::Shared {\n+                            merge_tag: None, ..\n+                        } => ChunkGroupInheritance::ChunkGroup(Either::Left(std::iter::once(\n+                            ChunkGroupKey::Shared(node.module),\n+                        ))),\n                         ChunkingType::Isolated {\n                             merge_tag: Some(merge_tag),\n                             ..\n@@ -263,7 +285,23 @@ pub async fn compute_chunk_group_info(graph: &ModuleGraph) -> Result<Vc<ChunkGro\n                                     parent: ChunkGroupId(parent),\n                                     merge_tag: merge_tag.clone(),\n                                 });\n-                            ChunkGroupInheritance::ChunkGroup(Either::Right(chunk_groups))\n+                            ChunkGroupInheritance::ChunkGroup(Either::Right(Either::Left(\n+                                chunk_groups,\n+                            )))\n+                        }\n+                        ChunkingType::Shared {\n+                            merge_tag: Some(merge_tag),\n+                            ..\n+                        } => {\n+                            let parents = module_chunk_groups.get(&parent.module).unwrap();\n+                            let chunk_groups =\n+                                parents.iter().map(|parent| ChunkGroupKey::SharedMerged {\n+                                    parent: ChunkGroupId(parent),\n+                                    merge_tag: merge_tag.clone(),\n+                                });\n+                            ChunkGroupInheritance::ChunkGroup(Either::Right(Either::Right(\n+                                chunk_groups,\n+                            )))\n                         }\n                         ChunkingType::Traced => {\n                             // Traced modules are not placed in chunk groups\n@@ -422,6 +460,12 @@ pub async fn compute_chunk_group_info(graph: &ModuleGraph) -> Result<Vc<ChunkGro\n                             entries: isolated_merged_entries.into_iter().collect(),\n                         }\n                     }\n+                    ChunkGroupKey::Shared(module) => ChunkGroup::Shared(module),\n+                    ChunkGroupKey::SharedMerged { parent, merge_tag } => ChunkGroup::SharedMerged {\n+                        parent: parent.0 as usize,\n+                        merge_tag,\n+                        entries: isolated_merged_entries.into_iter().collect(),\n+                    },\n                 })\n                 .collect(),\n         }"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 100,
        "deletions": 12
    }
}