{
    "author": "wbinnssmith",
    "message": "Implement foundations for additional bundler option (#75981)\n\nThis implements core code from https://github.com/vercel/next.js/tree/wbinnssmith/try-ci-test for rspack. It does not include code for the built-in flight or app loader.\n    \nThese code paths are currently taken when `NEXT_RSPACK` is set when running Next.js. Ultimately, this will be set with a new Next.js plugin, which will also install the necessary dependencies.\n\n## How?\n- Adds new npm scripts for running tests with Rspack enabled\n- Adjusts build trace collection to handle Rspack's chunk output\n- Updates compiler configuration to support Rspack's devtool settings\n- Modifies CSS extraction plugin usage to work with Rspack's implementation\n- Adds OpenTelemetry tracing support for Rspack builds\n\ncc @hardfist",
    "sha": "a7d481850365df47a876b6359947338a8cdb662d",
    "files": [
        {
            "sha": "a9143324d805818df6a10c1b2ecb93bce3ffbe45",
            "filename": "package.json",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -16,16 +16,21 @@\n     \"test-types\": \"tsc\",\n     \"test-unit\": \"jest test/unit/ packages/next/ packages/font\",\n     \"test-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\",\n+    \"test-dev-rspack\": \"cross-env NEXT_TEST_MODE=dev NEXT_RSPACK=1 BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN=1 BUILTIN_APP_LOADER=1 BUILTIN_SWC_LOADER=1 pnpm testheadless\",\n     \"test-dev-turbo\": \"cross-env NEXT_TEST_MODE=dev TURBOPACK=1 TURBOPACK_DEV=1 pnpm testheadless\",\n     \"test-start\": \"cross-env NEXT_TEST_MODE=start pnpm testheadless\",\n+    \"test-start-rspack\": \"cross-env NEXT_TEST_MODE=start NEXT_RSPACK=1 BUILTIN_FLIGHT_CLIENT_ENTRY_PLUGIN=1 BUILTIN_APP_LOADER=1 BUILTIN_SWC_LOADER=1 pnpm testheadless\",\n     \"test-start-turbo\": \"cross-env NEXT_TEST_MODE=start TURBOPACK=1 TURBOPACK_BUILD=1 pnpm testheadless\",\n     \"test-deploy\": \"cross-env NEXT_TEST_MODE=deploy pnpm testheadless\",\n     \"testonly-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testonly\",\n+    \"testonly-dev-rspack\": \"cross-env NEXT_TEST_MODE=dev  NEXT_RSPACK=1 pnpm testonly\",\n     \"testonly-dev-turbo\": \"cross-env NEXT_TEST_MODE=dev TURBOPACK=1 TURBOPACK_DEV=1 pnpm testonly\",\n     \"testonly-start\": \"cross-env NEXT_TEST_MODE=start pnpm testonly\",\n+    \"testonly-start-rspack\": \"cross-env NEXT_TEST_MODE=start NEXT_RSPACK=1 pnpm testonly\",\n     \"testonly-start-turbo\": \"cross-env NEXT_TEST_MODE=start TURBOPACK=1 TURBOPACK_BUILD=1 pnpm testonly\",\n     \"testonly-deploy\": \"cross-env NEXT_TEST_MODE=deploy pnpm testonly\",\n     \"test\": \"pnpm testheadless\",\n+    \"test-rspack\": \"cross-env NEXT_RSPACK=1 pnpm testheadless\",\n     \"test-turbo\": \"cross-env TURBOPACK=1 TURBOPACK_DEV=1 TURBOPACK_BUILD=1 pnpm testheadless\",\n     \"testonly\": \"jest --runInBand\",\n     \"testheadless\": \"cross-env HEADLESS=true pnpm testonly\","
        },
        {
            "sha": "1d1a4f38bdb2c9cb877a865782fac2152fba3527",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -21,6 +21,11 @@ import type { NextInfoOptions } from '../cli/next-info.js'\n import type { NextDevOptions } from '../cli/next-dev.js'\n import type { NextBuildOptions } from '../cli/next-build.js'\n \n+if (process.env.NEXT_RSPACK) {\n+  // silent rspack's schema check\n+  process.env.RSPACK_CONFIG_VALIDATE = 'loose-silent'\n+}\n+\n if (\n   !semver.satisfies(\n     process.versions.node,"
        },
        {
            "sha": "9e8d19981ce62952a308a4e558403f378c2bac19",
            "filename": "packages/next/src/build/webpack/config/blocks/base.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fbase.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -34,6 +34,8 @@ export const base = curry(function base(\n   if (ctx.isDevelopment) {\n     if (process.env.__NEXT_TEST_MODE && !process.env.__NEXT_TEST_WITH_DEVTOOL) {\n       config.devtool = false\n+    } else if (process.env.NEXT_RSPACK) {\n+      config.devtool = 'source-map'\n     } else {\n       // `eval-source-map` provides full-fidelity source maps for the\n       // original source, including columns and original variable names.\n@@ -73,7 +75,7 @@ export const base = curry(function base(\n         shouldIgnorePath,\n       })\n     )\n-  } else if (config.devtool === 'eval-source-map') {\n+  } else if (config.devtool === 'eval-source-map' && !process.env.NEXT_RSPACK) {\n     // We're using a fork of `eval-source-map`\n     config.devtool = false\n     config.plugins.push("
        },
        {
            "sha": "a30b680c54d56f6426cef2b68286ad398ece2c08",
            "filename": "packages/next/src/build/webpack/config/blocks/css/index.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Findex.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -14,6 +14,7 @@ import {\n import { getPostCssPlugins } from './plugins'\n import { nonNullable } from '../../../../../lib/non-nullable'\n import { WEBPACK_LAYERS } from '../../../../../lib/constants'\n+import { getRspackCore } from '../../../../../shared/lib/get-rspack'\n \n // RegExps for all Style Sheet variants\n export const regexLikeCss = /\\.(css|scss|sass)$/\n@@ -147,6 +148,7 @@ export const css = curry(async function css(\n   ctx: ConfigurationContext,\n   config: webpack.Configuration\n ) {\n+  const isRspack = Boolean(process.env.NEXT_RSPACK)\n   const {\n     prependData: sassPrependData,\n     additionalData: sassAdditionalData,\n@@ -592,8 +594,10 @@ export const css = curry(async function css(\n   // Enable full mini-css-extract-plugin hmr for prod mode pages or app dir\n   if (ctx.isClient && (ctx.isProduction || ctx.hasAppDir)) {\n     // Extract CSS as CSS file(s) in the client-side production bundle.\n-    const MiniCssExtractPlugin =\n-      require('../../../plugins/mini-css-extract-plugin').default\n+    const MiniCssExtractPlugin = isRspack\n+      ? getRspackCore().CssExtractRspackPlugin\n+      : require('../../../plugins/mini-css-extract-plugin').default\n+\n     fns.push(\n       plugin(\n         // @ts-ignore webpack 5 compat"
        },
        {
            "sha": "8b298e49744d3fe100b0c1a1cf2dff9499924895",
            "filename": "packages/next/src/build/webpack/config/blocks/css/loaders/client.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fclient.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fclient.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fclient.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -1,4 +1,5 @@\n import type { webpack } from 'next/dist/compiled/webpack/webpack'\n+import { getRspackCore } from '../../../../../../shared/lib/get-rspack'\n \n export function getClientStyleLoader({\n   hasAppDir,\n@@ -11,6 +12,7 @@ export function getClientStyleLoader({\n   isDevelopment: boolean\n   assetPrefix: string\n }): webpack.RuleSetUseItem {\n+  const isRspack = Boolean(process.env.NEXT_RSPACK)\n   const shouldEnableApp = typeof isAppDir === 'boolean' ? isAppDir : hasAppDir\n \n   // Keep next-style-loader for development mode in `pages/`\n@@ -41,8 +43,10 @@ export function getClientStyleLoader({\n     }\n   }\n \n-  const MiniCssExtractPlugin =\n-    require('../../../../plugins/mini-css-extract-plugin').default\n+  const MiniCssExtractPlugin = isRspack\n+    ? getRspackCore().rspack.CssExtractRspackPlugin\n+    : require('../../../../plugins/mini-css-extract-plugin').default\n+\n   return {\n     loader: MiniCssExtractPlugin.loader,\n     options: {"
        },
        {
            "sha": "a9c49c76d7718202f649694b3a6c7ed1c919d06e",
            "filename": "packages/next/src/build/webpack/loaders/utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Futils.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -35,6 +35,8 @@ export function isCSSMod(mod: {\n     mod.loaders?.some(\n       ({ loader }) =>\n         loader.includes('next-style-loader/index.js') ||\n+        (process.env.NEXT_RSPACK &&\n+          loader.includes('rspack.CssExtractRspackPlugin.loader')) ||\n         loader.includes('mini-css-extract-plugin/loader.js') ||\n         loader.includes('@vanilla-extract/webpack-plugin/loader/')\n     )"
        },
        {
            "sha": "a69e7b394c9280fdd3f9846dbe7d61a6c2c04759",
            "filename": "packages/next/src/build/webpack/plugins/middleware-plugin.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fmiddleware-plugin.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -791,9 +791,13 @@ export default class MiddlewarePlugin {\n         compiler,\n         compilation,\n       })\n-      hooks.parser.for('javascript/auto').tap(NAME, codeAnalyzer)\n-      hooks.parser.for('javascript/dynamic').tap(NAME, codeAnalyzer)\n-      hooks.parser.for('javascript/esm').tap(NAME, codeAnalyzer)\n+\n+      // parser hooks aren't available in rspack\n+      if (!process.env.NEXT_RSPACK) {\n+        hooks.parser.for('javascript/auto').tap(NAME, codeAnalyzer)\n+        hooks.parser.for('javascript/dynamic').tap(NAME, codeAnalyzer)\n+        hooks.parser.for('javascript/esm').tap(NAME, codeAnalyzer)\n+      }\n \n       /**\n        * Extract all metadata for the entry points in a Map object."
        },
        {
            "sha": "eb130e00dab536969c3e15b6cfd5c539fef18bea",
            "filename": "packages/next/src/build/webpack/plugins/next-trace-entrypoints-plugin.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnext-trace-entrypoints-plugin.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -190,9 +190,9 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n       for (const entrypoint of compilation.entrypoints.values()) {\n         const entryFiles = new Set<string>()\n \n-        for (const chunk of entrypoint\n-          .getEntrypointChunk()\n-          .getAllReferencedChunks()) {\n+        for (const chunk of process.env.NEXT_RSPACK\n+          ? entrypoint.chunks\n+          : entrypoint.getEntrypointChunk().getAllReferencedChunks()) {\n           for (const file of chunk.files) {\n             if (isTraceable(file)) {\n               const filePath = nodePath.join(outputPath, file)\n@@ -580,6 +580,23 @@ export class TraceEntryPointsPlugin implements webpack.WebpackPluginInstance {\n \n   apply(compiler: webpack.Compiler) {\n     compiler.hooks.compilation.tap(PLUGIN_NAME, (compilation) => {\n+      compilation.hooks.processAssets.tapAsync(\n+        {\n+          name: PLUGIN_NAME,\n+          stage: webpack.Compilation.PROCESS_ASSETS_STAGE_SUMMARIZE,\n+        },\n+        (_assets: any, callback: any) => {\n+          this.createTraceAssets(compilation, traceEntrypointsPluginSpan)\n+            .then(() => callback())\n+            .catch((err) => callback(err))\n+        }\n+      )\n+\n+      // rspack doesn't support all API below so only create trace assets\n+      if (process.env.NEXT_RSPACK) {\n+        return\n+      }\n+\n       const readlink = async (path: string): Promise<string | null> => {\n         try {\n           return await new Promise((resolve, reject) => {"
        },
        {
            "sha": "aa96783c19bf5377a603a9461ec618167a0a7e73",
            "filename": "packages/next/src/build/webpack/plugins/nextjs-require-cache-hot-reloader.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnextjs-require-cache-hot-reloader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnextjs-require-cache-hot-reloader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fnextjs-require-cache-hot-reloader.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -37,7 +37,7 @@ export class NextJsRequireCacheHotReloader implements WebpackPluginInstance {\n       // we need to make sure to clear all server entries from cache\n       // since they can have a stale webpack-runtime cache\n       // which needs to always be in-sync\n-      const entries = [...compilation.entries.keys()].filter((entry) => {\n+      const entries = [...compilation.entrypoints.keys()].filter((entry) => {\n         const isAppPath = entry.toString().startsWith('app/')\n         return entry.toString().startsWith('pages/') || isAppPath\n       })"
        },
        {
            "sha": "5e0585c335456ac8525afeb789f44ad1d4d65123",
            "filename": "packages/next/src/build/webpack/utils.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Futils.ts?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -95,6 +95,12 @@ export function getModuleReferencesInOrder(\n   module: Module,\n   moduleGraph: ModuleGraph\n ): ModuleGraphConnection[] {\n+  if (\n+    'getOutgoingConnectionsInOrder' in moduleGraph &&\n+    typeof moduleGraph.getOutgoingConnectionsInOrder === 'function'\n+  ) {\n+    return moduleGraph.getOutgoingConnectionsInOrder(module)\n+  }\n   const connections = []\n   for (const connection of moduleGraph.getOutgoingConnections(module)) {\n     if (connection.dependency && connection.module) {"
        },
        {
            "sha": "c121ac5695b498973ce6c392c1144cedb231a121",
            "filename": "packages/next/src/bundles/webpack/packages/webpack.js",
            "status": "modified",
            "additions": 23,
            "deletions": 1,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbundles%2Fwebpack%2Fpackages%2Fwebpack.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fbundles%2Fwebpack%2Fpackages%2Fwebpack.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbundles%2Fwebpack%2Fpackages%2Fwebpack.js?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -3,7 +3,14 @@ exports.__esModule = true\n exports.default = undefined\n \n exports.init = function () {\n-  if (process.env.NEXT_PRIVATE_LOCAL_WEBPACK) {\n+  if (process.env.NEXT_RSPACK) {\n+    // eslint-disable-next-line\n+    Object.assign(exports, getRspackCore())\n+    Object.assign(exports, {\n+      // eslint-disable-next-line import/no-extraneous-dependencies\n+      StringXor: require('./bundle5')().StringXor,\n+    })\n+  } else if (process.env.NEXT_PRIVATE_LOCAL_WEBPACK) {\n     Object.assign(exports, {\n       // eslint-disable-next-line import/no-extraneous-dependencies\n       BasicEvaluatedExpression: require('webpack/lib/javascript/BasicEvaluatedExpression'),\n@@ -33,3 +40,18 @@ exports.init = function () {\n     Object.assign(exports, require('./bundle5')())\n   }\n }\n+\n+function getRspackCore() {\n+  try {\n+    // eslint-disable-next-line import/no-extraneous-dependencies\n+    return require('@rspack/core')\n+  } catch (e) {\n+    if (e instanceof Error && 'code' in e && e.code === 'MODULE_NOT_FOUND') {\n+      throw new Error(\n+        '@rspack/core is not available. Please make sure the appropriate Next.js plugin is installed.'\n+      )\n+    }\n+\n+    throw e\n+  }\n+}"
        },
        {
            "sha": "241abfa00d771d1d9eabe052edb4e8ab026e81a2",
            "filename": "packages/next/src/client/app-dir/link.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -245,6 +245,9 @@ function mountLinkInstance(\n   router: AppRouterInstance,\n   kind: PrefetchKind.AUTO | PrefetchKind.FULL\n ) {\n+  // element can be falsy which can break WeakMap and observing\n+  if (!element) return\n+\n   let prefetchUrl: URL | null = null\n   try {\n     prefetchUrl = createPrefetchURL(href)"
        },
        {
            "sha": "c121ac5695b498973ce6c392c1144cedb231a121",
            "filename": "packages/next/src/compiled/webpack/webpack.js",
            "status": "modified",
            "additions": 23,
            "deletions": 1,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fcompiled%2Fwebpack%2Fwebpack.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a7d481850365df47a876b6359947338a8cdb662d/packages%2Fnext%2Fsrc%2Fcompiled%2Fwebpack%2Fwebpack.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fwebpack%2Fwebpack.js?ref=a7d481850365df47a876b6359947338a8cdb662d",
            "patch": "@@ -3,7 +3,14 @@ exports.__esModule = true\n exports.default = undefined\n \n exports.init = function () {\n-  if (process.env.NEXT_PRIVATE_LOCAL_WEBPACK) {\n+  if (process.env.NEXT_RSPACK) {\n+    // eslint-disable-next-line\n+    Object.assign(exports, getRspackCore())\n+    Object.assign(exports, {\n+      // eslint-disable-next-line import/no-extraneous-dependencies\n+      StringXor: require('./bundle5')().StringXor,\n+    })\n+  } else if (process.env.NEXT_PRIVATE_LOCAL_WEBPACK) {\n     Object.assign(exports, {\n       // eslint-disable-next-line import/no-extraneous-dependencies\n       BasicEvaluatedExpression: require('webpack/lib/javascript/BasicEvaluatedExpression'),\n@@ -33,3 +40,18 @@ exports.init = function () {\n     Object.assign(exports, require('./bundle5')())\n   }\n }\n+\n+function getRspackCore() {\n+  try {\n+    // eslint-disable-next-line import/no-extraneous-dependencies\n+    return require('@rspack/core')\n+  } catch (e) {\n+    if (e instanceof Error && 'code' in e && e.code === 'MODULE_NOT_FOUND') {\n+      throw new Error(\n+        '@rspack/core is not available. Please make sure the appropriate Next.js plugin is installed.'\n+      )\n+    }\n+\n+    throw e\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 110,
        "deletions": 14
    }
}