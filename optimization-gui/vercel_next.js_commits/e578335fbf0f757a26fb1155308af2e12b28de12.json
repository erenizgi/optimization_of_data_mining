{
    "author": "huozhi",
    "message": "[devtool] fix overlay styles are missing (#83721)",
    "sha": "e578335fbf0f757a26fb1155308af2e12b28de12",
    "files": [
        {
            "sha": "a2c73cf3e1de0b7b6b76da982b11377c9c8e363d",
            "filename": "packages/next/src/build/webpack/loaders/devtool/devtool-style-inject.js",
            "status": "modified",
            "additions": 39,
            "deletions": 31,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/e578335fbf0f757a26fb1155308af2e12b28de12/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fdevtool%2Fdevtool-style-inject.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e578335fbf0f757a26fb1155308af2e12b28de12/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fdevtool%2Fdevtool-style-inject.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fdevtool%2Fdevtool-style-inject.js?ref=e578335fbf0f757a26fb1155308af2e12b28de12",
            "patch": "@@ -85,42 +85,50 @@ function startObservingForPortal() {\n \n   // Set up MutationObserver to watch for the portal element\n   const observer = new MutationObserver((mutations) => {\n-    if (mutations.length === 0 || mutations[0].addedNodes.length === 0) {\n+    if (mutations.length === 0) {\n       return\n     }\n \n-    // Check if mutation is script[data-nextjs-dev-overlay] tag, which is the\n-    // parent of the nextjs-portal element\n-    const mutationNode = mutations[0].addedNodes[0]\n-    let portalNode = null\n-    if (\n-      // app router: body > script[data-nextjs-dev-overlay] > nextjs-portal\n-      mutationNode.tagName === 'SCRIPT' &&\n-      mutationNode.getAttribute('data-nextjs-dev-overlay')\n-    ) {\n-      portalNode = mutationNode.firstChild\n-    } else if (\n-      // pages router: body > nextjs-portal\n-      mutationNode.tagName === 'NEXTJS-PORTAL'\n-    ) {\n-      portalNode = mutationNode\n-    }\n-    if (!portalNode) {\n-      return\n-    }\n-\n-    // Wait until shadow root is available\n-    const checkShadowRoot = () => {\n-      if (getShadowRoot()) {\n-        flushCachedElements()\n-        observer.disconnect()\n-        cache.isObserving = false\n-      } else {\n-        // Try again after a short delay\n-        setTimeout(checkShadowRoot, 20)\n+    // Check all mutations and all added nodes\n+    for (const mutation of mutations) {\n+      if (mutation.addedNodes.length === 0) continue\n+\n+      for (const addedNode of mutation.addedNodes) {\n+        if (addedNode.nodeType !== Node.ELEMENT_NODE) continue\n+\n+        const mutationNode = addedNode\n+\n+        let portalNode = null\n+        if (\n+          // app router: body > script[data-nextjs-dev-overlay] > nextjs-portal\n+          mutationNode.tagName === 'SCRIPT' &&\n+          mutationNode.getAttribute('data-nextjs-dev-overlay')\n+        ) {\n+          portalNode = mutationNode.firstChild\n+        } else if (\n+          // pages router: body > nextjs-portal\n+          mutationNode.tagName === 'NEXTJS-PORTAL'\n+        ) {\n+          portalNode = mutationNode\n+        }\n+\n+        if (portalNode) {\n+          // Wait until shadow root is available\n+          const checkShadowRoot = () => {\n+            if (getShadowRoot()) {\n+              flushCachedElements()\n+              observer.disconnect()\n+              cache.isObserving = false\n+            } else {\n+              // Try again after a short delay\n+              setTimeout(checkShadowRoot, 20)\n+            }\n+          }\n+          checkShadowRoot()\n+          return // Exit early once we find a portal\n+        }\n       }\n     }\n-    checkShadowRoot()\n   })\n \n   observer.observe(document.body, {"
        },
        {
            "sha": "57b70ee80752a8a6e50d4e6557cfba9eb400663a",
            "filename": "test/development/error-overlay/index.test.tsx",
            "status": "modified",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/e578335fbf0f757a26fb1155308af2e12b28de12/test%2Fdevelopment%2Ferror-overlay%2Findex.test.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e578335fbf0f757a26fb1155308af2e12b28de12/test%2Fdevelopment%2Ferror-overlay%2Findex.test.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ferror-overlay%2Findex.test.tsx?ref=e578335fbf0f757a26fb1155308af2e12b28de12",
            "patch": "@@ -95,4 +95,28 @@ describe('DevErrorOverlay', () => {\n       expect(request.status).toBe(200)\n     }\n   })\n+\n+  it('should load dev overlay styles successfully', async () => {\n+    const browser = await next.browser('/hydration-error')\n+\n+    await assertHasRedbox(browser)\n+    const redbox = browser.locateRedbox()\n+\n+    // check the data-nextjs-dialog-header=\"true\" DOM element styles under redbox is applied\n+    const dialogHeader = redbox.locator('[data-nextjs-dialog-header=\"true\"]')\n+    expect(await dialogHeader.isVisible()).toBe(true)\n+    // get computed styles\n+    const computedStyles = await dialogHeader.evaluate((element) => {\n+      return window.getComputedStyle(element)\n+    })\n+    const styles = {\n+      backgroundColor: computedStyles.backgroundColor,\n+      color: computedStyles.color,\n+    }\n+\n+    expect(styles).toEqual({\n+      backgroundColor: 'rgba(0, 0, 0, 0)',\n+      color: 'rgb(117, 117, 117)',\n+    })\n+  })\n })"
        },
        {
            "sha": "93928c3da70e2367557c82fc6aacfced7dd3266c",
            "filename": "test/development/error-overlay/pages/_app.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e578335fbf0f757a26fb1155308af2e12b28de12/test%2Fdevelopment%2Ferror-overlay%2Fpages%2F_app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e578335fbf0f757a26fb1155308af2e12b28de12/test%2Fdevelopment%2Ferror-overlay%2Fpages%2F_app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ferror-overlay%2Fpages%2F_app.tsx?ref=e578335fbf0f757a26fb1155308af2e12b28de12",
            "patch": "@@ -0,0 +1,5 @@\n+import type { AppProps } from 'next/app'\n+\n+export default function App({ Component, pageProps }: AppProps) {\n+  return <Component {...pageProps} />\n+}"
        },
        {
            "sha": "54e8bf3e2a29015a45e11cdc279e06b459890d8b",
            "filename": "test/development/error-overlay/pages/_document.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/e578335fbf0f757a26fb1155308af2e12b28de12/test%2Fdevelopment%2Ferror-overlay%2Fpages%2F_document.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e578335fbf0f757a26fb1155308af2e12b28de12/test%2Fdevelopment%2Ferror-overlay%2Fpages%2F_document.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ferror-overlay%2Fpages%2F_document.tsx?ref=e578335fbf0f757a26fb1155308af2e12b28de12",
            "patch": "@@ -0,0 +1,13 @@\n+import { Html, Head, Main, NextScript } from 'next/document'\n+\n+export default function Document() {\n+  return (\n+    <Html lang=\"en\">\n+      <Head />\n+      <body>\n+        <Main />\n+        <NextScript />\n+      </body>\n+    </Html>\n+  )\n+}"
        },
        {
            "sha": "b13c452751c2fa9cbfd28dbd668c8593388fcd0c",
            "filename": "test/development/error-overlay/pages/hydration-error.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e578335fbf0f757a26fb1155308af2e12b28de12/test%2Fdevelopment%2Ferror-overlay%2Fpages%2Fhydration-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e578335fbf0f757a26fb1155308af2e12b28de12/test%2Fdevelopment%2Ferror-overlay%2Fpages%2Fhydration-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ferror-overlay%2Fpages%2Fhydration-error.tsx?ref=e578335fbf0f757a26fb1155308af2e12b28de12",
            "patch": "@@ -0,0 +1,5 @@\n+export default function Home() {\n+  return (\n+    <div>{typeof window === 'undefined' ? <p>Server</p> : <p>Client</p>}</div>\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 86,
        "deletions": 31
    }
}