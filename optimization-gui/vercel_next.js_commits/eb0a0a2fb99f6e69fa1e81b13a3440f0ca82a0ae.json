{
    "author": "devjiwonchoi",
    "message": "Refactor transpile-config (#83117)",
    "sha": "eb0a0a2fb99f6e69fa1e81b13a3440f0ca82a0ae",
    "files": [
        {
            "sha": "f3a135d043b14ede8d777c64e33d14d1707b115f",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/eb0a0a2fb99f6e69fa1e81b13a3440f0ca82a0ae/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/eb0a0a2fb99f6e69fa1e81b13a3440f0ca82a0ae/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=eb0a0a2fb99f6e69fa1e81b13a3440f0ca82a0ae",
            "patch": "@@ -794,5 +794,6 @@\n   \"793\": \"No value found for segment key: \\\"%s\\\"\",\n   \"794\": \"Invalid <Link> with <a> child. Please remove <a>.\\nLearn more: https://nextjs.org/docs/messages/invalid-new-link-with-extra-anchor\",\n   \"795\": \"\\\\`%s\\\\` was called from a Server Component. Next.js should be preventing %s from being included in server components statically, but did not in this case.\",\n-  \"796\": \"Page \\\"%s\\\" cannot use \\\\`export const unstable_prefetch = ...\\\\` without enabling \\\\`experimental.cacheComponents\\\\` and \\\\`experimental.clientSegmentCache\\\\`.\"\n+  \"796\": \"Page \\\"%s\\\" cannot use \\\\`export const unstable_prefetch = ...\\\\` without enabling \\\\`experimental.cacheComponents\\\\` and \\\\`experimental.clientSegmentCache\\\\`.\",\n+  \"797\": \"Failed to transpile \\\"%s\\\".\"\n }"
        },
        {
            "sha": "2dd59ae9f22f1ea73c0d39c7a3c6ac67b5f8ce15",
            "filename": "packages/next/src/build/next-config-ts/transpile-config.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 8,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/eb0a0a2fb99f6e69fa1e81b13a3440f0ca82a0ae/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb0a0a2fb99f6e69fa1e81b13a3440f0ca82a0ae/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fnext-config-ts%2Ftranspile-config.ts?ref=eb0a0a2fb99f6e69fa1e81b13a3440f0ca82a0ae",
            "patch": "@@ -11,20 +11,30 @@ function resolveSWCOptions(\n   cwd: string,\n   compilerOptions: CompilerOptions\n ): SWCOptions {\n-  const resolvedBaseUrl = resolve(cwd, compilerOptions.baseUrl ?? '.')\n   return {\n     jsc: {\n-      target: 'es5',\n       parser: {\n         syntax: 'typescript',\n       },\n-      paths: compilerOptions.paths,\n-      baseUrl: resolvedBaseUrl,\n+      ...(compilerOptions.paths ? { paths: compilerOptions.paths } : {}),\n+      ...(compilerOptions.baseUrl\n+        ? // Needs to be an absolute path.\n+          { baseUrl: resolve(cwd, compilerOptions.baseUrl) }\n+        : compilerOptions.paths\n+          ? // If paths is given, baseUrl is required.\n+            { baseUrl: cwd }\n+          : {}),\n     },\n     module: {\n       type: 'commonjs',\n     },\n     isModule: 'unknown',\n+    env: {\n+      targets: {\n+        // Setting the Node.js version can reduce unnecessary code generation.\n+        node: process?.versions?.node ?? '20.19.0',\n+      },\n+    },\n   } satisfies SWCOptions\n }\n \n@@ -79,7 +89,7 @@ async function getTsConfig(cwd: string): Promise<CompilerOptions> {\n \n   if (!tsConfigPath) {\n     // It is ok to not return ts.getDefaultCompilerOptions() because\n-    // we are only lookfing for paths and baseUrl from tsConfig.\n+    // we are only looking for paths and baseUrl from tsConfig.\n     return {}\n   }\n \n@@ -102,14 +112,31 @@ export async function transpileConfig({\n   configFileName: string\n   cwd: string\n }) {\n-  let hasRequire = false\n   try {\n     // Ensure TypeScript is installed to use the API.\n     await verifyTypeScriptSetup(cwd, configFileName)\n-\n     const compilerOptions = await getTsConfig(cwd)\n-    const swcOptions = resolveSWCOptions(cwd, compilerOptions)\n \n+    return handleCJS({ cwd, nextConfigPath, compilerOptions })\n+  } catch (cause) {\n+    throw new Error(`Failed to transpile \"${configFileName}\".`, {\n+      cause,\n+    })\n+  }\n+}\n+\n+async function handleCJS({\n+  cwd,\n+  nextConfigPath,\n+  compilerOptions,\n+}: {\n+  cwd: string\n+  nextConfigPath: string\n+  compilerOptions: CompilerOptions\n+}) {\n+  const swcOptions = resolveSWCOptions(cwd, compilerOptions)\n+  let hasRequire = false\n+  try {\n     const nextConfigString = await readFile(nextConfigPath, 'utf8')\n     // lazy require swc since it loads React before even setting NODE_ENV\n     // resulting loading Development React on Production"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 37,
        "deletions": 9
    }
}