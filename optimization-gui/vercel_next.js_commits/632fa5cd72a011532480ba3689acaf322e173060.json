{
    "author": "ztanner",
    "message": "fix missing flight-router-state-tree header normalization (#84718)\n\nWhen we pass the flight-router-state-tree header to the server, we\nshould pass it through the normalizer to ensure we remove things that\nare client-specific (eg removing \"refresh\" markers and URLs, which are\nonly used on the client)",
    "sha": "632fa5cd72a011532480ba3689acaf322e173060",
    "files": [
        {
            "sha": "f7851be12b56e54c9357f524cdd1cd0cf0d89462",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/632fa5cd72a011532480ba3689acaf322e173060/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/632fa5cd72a011532480ba3689acaf322e173060/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=632fa5cd72a011532480ba3689acaf322e173060",
            "patch": "@@ -71,7 +71,10 @@ import type {\n   FlightRouterState,\n   NavigationFlightResponse,\n } from '../../../shared/lib/app-router-types'\n-import { normalizeFlightData } from '../../flight-data-helpers'\n+import {\n+  normalizeFlightData,\n+  prepareFlightRouterStateForRequest,\n+} from '../../flight-data-helpers'\n import { STATIC_STALETIME_MS } from '../router-reducer/prefetch-cache-utils'\n import { pingVisibleLinks } from '../links'\n import { PAGE_SEGMENT_KEY } from '../../../shared/lib/segment'\n@@ -1696,9 +1699,8 @@ export async function fetchSegmentPrefetchesUsingDynamicRequest(\n   const nextUrl = task.key.nextUrl\n   const headers: RequestHeaders = {\n     [RSC_HEADER]: '1',\n-    [NEXT_ROUTER_STATE_TREE_HEADER]: encodeURIComponent(\n-      JSON.stringify(dynamicRequestTree)\n-    ),\n+    [NEXT_ROUTER_STATE_TREE_HEADER]:\n+      prepareFlightRouterStateForRequest(dynamicRequestTree),\n   }\n   if (nextUrl !== null) {\n     headers[NEXT_URL] = nextUrl"
        }
    ],
    "stats": {
        "total": 10,
        "additions": 6,
        "deletions": 4
    }
}