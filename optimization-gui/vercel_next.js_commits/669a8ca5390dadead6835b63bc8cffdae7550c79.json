{
    "author": "hamidrezahanafi",
    "message": "Fix(turbopack): Resolve experimentalDecorators from extended tsconfig (#79755)\n\nCo-authored-by: Jude Gao <jude.gao@vercel.com>",
    "sha": "669a8ca5390dadead6835b63bc8cffdae7550c79",
    "files": [
        {
            "sha": "1ea07c41556433dbae2db77b930084e338b1ba07",
            "filename": "crates/next-core/src/transform_options.rs",
            "status": "modified",
            "additions": 53,
            "deletions": 42,
            "changes": 95,
            "blob_url": "https://github.com/vercel/next.js/blob/669a8ca5390dadead6835b63bc8cffdae7550c79/crates%2Fnext-core%2Fsrc%2Ftransform_options.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/669a8ca5390dadead6835b63bc8cffdae7550c79/crates%2Fnext-core%2Fsrc%2Ftransform_options.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Ftransform_options.rs?ref=669a8ca5390dadead6835b63bc8cffdae7550c79",
            "patch": "@@ -66,51 +66,62 @@ pub async fn get_decorators_transform_options(\n ) -> Result<Vc<DecoratorsOptions>> {\n     let tsconfig = get_typescript_options(project_path).await?;\n \n-    let decorators_transform_options = if let Some(tsconfig) = tsconfig {\n-        read_from_tsconfigs(&tsconfig, |json, _| {\n-            let decorators_kind = if json[\"compilerOptions\"][\"experimentalDecorators\"]\n-                .as_bool()\n-                .unwrap_or(false)\n-            {\n-                Some(DecoratorsKind::Legacy)\n-            } else {\n-                // ref: https://devblogs.microsoft.com/typescript/announcing-typescript-5-0-rc/#differences-with-experimental-legacy-decorators\n-                // `without the flag, decorators will now be valid syntax for all new code.\n-                // Outside of --experimentalDecorators, they will be type-checked and emitted\n-                // differently with ts 5.0, new ecma decorators will be enabled\n-                // if legacy decorators are not enabled\n-                Some(DecoratorsKind::Ecma)\n-            };\n-\n-            let emit_decorators_metadata = if let Some(decorators_kind) = &decorators_kind {\n-                match decorators_kind {\n-                    DecoratorsKind::Legacy => {\n-                        // ref: This new decorators proposal is not compatible with\n-                        // --emitDecoratorMetadata, and it does not allow decorating parameters.\n-                        // Future ECMAScript proposals may be able to help bridge that gap\n-                        json[\"compilerOptions\"][\"emitDecoratorMetadata\"]\n-                            .as_bool()\n-                            .unwrap_or(false)\n-                    }\n-                    DecoratorsKind::Ecma => false,\n-                }\n-            } else {\n-                false\n-            };\n-\n-            Some(DecoratorsOptions {\n-                decorators_kind,\n-                emit_decorators_metadata,\n-                use_define_for_class_fields: json[\"compilerOptions\"][\"useDefineForClassFields\"]\n-                    .as_bool()\n-                    .unwrap_or(false),\n-                ..Default::default()\n-            })\n+    let experimental_decorators = if let Some(ref tsconfig) = tsconfig {\n+        read_from_tsconfigs(tsconfig, |json, _| {\n+            json[\"compilerOptions\"][\"experimentalDecorators\"].as_bool()\n         })\n         .await?\n-        .unwrap_or_default()\n+        .unwrap_or(false)\n+    } else {\n+        false\n+    };\n+\n+    let decorators_kind = if experimental_decorators {\n+        Some(DecoratorsKind::Legacy)\n     } else {\n-        Default::default()\n+        // ref: https://devblogs.microsoft.com/typescript/announcing-typescript-5-0-rc/#differences-with-experimental-legacy-decorators\n+        // `without the flag, decorators will now be valid syntax for all new code.\n+        // Outside of --experimentalDecorators, they will be type-checked and emitted\n+        // differently with ts 5.0, new ecma decorators will be enabled\n+        // if legacy decorators are not enabled\n+        Some(DecoratorsKind::Ecma)\n+    };\n+\n+    let emit_decorators_metadata = if let Some(ref tsconfig) = tsconfig {\n+        read_from_tsconfigs(tsconfig, |json, _| {\n+            json[\"compilerOptions\"][\"emitDecoratorMetadata\"].as_bool()\n+        })\n+        .await?\n+        .unwrap_or(false)\n+    } else {\n+        false\n+    };\n+\n+    let use_define_for_class_fields = if let Some(ref tsconfig) = tsconfig {\n+        read_from_tsconfigs(tsconfig, |json, _| {\n+            json[\"compilerOptions\"][\"useDefineForClassFields\"].as_bool()\n+        })\n+        .await?\n+        .unwrap_or(false)\n+    } else {\n+        false\n+    };\n+\n+    let decorators_transform_options = DecoratorsOptions {\n+        decorators_kind: decorators_kind.clone(),\n+        emit_decorators_metadata: if let Some(ref decorators_kind) = decorators_kind {\n+            match decorators_kind {\n+                DecoratorsKind::Legacy => emit_decorators_metadata,\n+                // ref: This new decorators proposal is not compatible with\n+                // --emitDecoratorMetadata, and it does not allow decorating parameters.\n+                // Future ECMAScript proposals may be able to help bridge that gap\n+                DecoratorsKind::Ecma => false,\n+            }\n+        } else {\n+            false\n+        },\n+        use_define_for_class_fields,\n+        ..Default::default()\n     };\n \n     Ok(decorators_transform_options.cell())"
        },
        {
            "sha": "80e5dba2ebad17e2003bf060b2d8094ec868e584",
            "filename": "test/development/basic/legacy-decorators.test.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 29,
            "changes": 100,
            "blob_url": "https://github.com/vercel/next.js/blob/669a8ca5390dadead6835b63bc8cffdae7550c79/test%2Fdevelopment%2Fbasic%2Flegacy-decorators.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/669a8ca5390dadead6835b63bc8cffdae7550c79/test%2Fdevelopment%2Fbasic%2Flegacy-decorators.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Flegacy-decorators.test.ts?ref=669a8ca5390dadead6835b63bc8cffdae7550c79",
            "patch": "@@ -5,39 +5,81 @@ import { NextInstance } from 'e2e-utils'\n import { check } from 'next-test-utils'\n \n describe('Legacy decorators SWC option', () => {\n-  let next: NextInstance\n+  describe('with extended tsconfig', () => {\n+    let next: NextInstance\n \n-  beforeAll(async () => {\n-    next = await createNext({\n-      files: {\n-        'jsconfig.json': new FileRef(\n-          join(__dirname, 'legacy-decorators/jsconfig.json')\n-        ),\n-        pages: new FileRef(join(__dirname, 'legacy-decorators/pages')),\n-      },\n-      dependencies: {\n-        mobx: '6.3.7',\n-        'mobx-react': '7.2.1',\n-      },\n+    beforeAll(async () => {\n+      next = await createNext({\n+        files: {\n+          'tsconfig.json': new FileRef(\n+            join(__dirname, 'legacy-decorators/tsconfig-extended.json')\n+          ),\n+          'tsconfig-base.json': new FileRef(\n+            join(__dirname, 'legacy-decorators/jsconfig.json')\n+          ),\n+          pages: new FileRef(join(__dirname, 'legacy-decorators/pages')),\n+        },\n+        dependencies: {\n+          mobx: '6.3.7',\n+          'mobx-react': '7.2.1',\n+        },\n+      })\n+    })\n+    afterAll(() => next.destroy())\n+\n+    it('should compile with legacy decorators enabled from extended config', async () => {\n+      let browser\n+      try {\n+        browser = await webdriver(next.url, '/')\n+        const text = await browser.elementByCss('#count').text()\n+        expect(text).toBe('Current number: 0')\n+        await browser.elementByCss('#increase').click()\n+        await check(\n+          () => browser.elementByCss('#count').text(),\n+          /Current number: 1/\n+        )\n+      } finally {\n+        if (browser) {\n+          await browser.close()\n+        }\n+      }\n     })\n   })\n-  afterAll(() => next.destroy())\n \n-  it('should compile with legacy decorators enabled', async () => {\n-    let browser\n-    try {\n-      browser = await webdriver(next.url, '/')\n-      const text = await browser.elementByCss('#count').text()\n-      expect(text).toBe('Current number: 0')\n-      await browser.elementByCss('#increase').click()\n-      await check(\n-        () => browser.elementByCss('#count').text(),\n-        /Current number: 1/\n-      )\n-    } finally {\n-      if (browser) {\n-        await browser.close()\n+  describe('with base config', () => {\n+    let next: NextInstance\n+    beforeAll(async () => {\n+      next = await createNext({\n+        files: {\n+          'jsconfig.json': new FileRef(\n+            join(__dirname, 'legacy-decorators/jsconfig.json')\n+          ),\n+          pages: new FileRef(join(__dirname, 'legacy-decorators/pages')),\n+        },\n+        dependencies: {\n+          mobx: '6.3.7',\n+          'mobx-react': '7.2.1',\n+        },\n+      })\n+    })\n+    afterAll(() => next.destroy())\n+\n+    it('should compile with legacy decorators enabled', async () => {\n+      let browser\n+      try {\n+        browser = await webdriver(next.url, '/')\n+        const text = await browser.elementByCss('#count').text()\n+        expect(text).toBe('Current number: 0')\n+        await browser.elementByCss('#increase').click()\n+        await check(\n+          () => browser.elementByCss('#count').text(),\n+          /Current number: 1/\n+        )\n+      } finally {\n+        if (browser) {\n+          await browser.close()\n+        }\n       }\n-    }\n+    })\n   })\n })"
        },
        {
            "sha": "48d19b001afa70c9af0aa2340c780f14353cc1fd",
            "filename": "test/development/basic/legacy-decorators/tsconfig-extended.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/669a8ca5390dadead6835b63bc8cffdae7550c79/test%2Fdevelopment%2Fbasic%2Flegacy-decorators%2Ftsconfig-extended.json",
            "raw_url": "https://github.com/vercel/next.js/raw/669a8ca5390dadead6835b63bc8cffdae7550c79/test%2Fdevelopment%2Fbasic%2Flegacy-decorators%2Ftsconfig-extended.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Flegacy-decorators%2Ftsconfig-extended.json?ref=669a8ca5390dadead6835b63bc8cffdae7550c79",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"extends\": \"./tsconfig-base.json\"\n+}"
        }
    ],
    "stats": {
        "total": 198,
        "additions": 127,
        "deletions": 71
    }
}