{
    "author": "mischnic",
    "message": "Turbopack: fix CSS module references, take 2 (#82448)\n\nReplaces and closes https://github.com/vercel/next.js/pull/78058\nCloses PACK-4324\n\nBefore, you got duplicate modules because\n`transition_to_client(postcss(webpack(source in rsc)) != postcss(webpack(transition_to_client(source in rsc))`\n\nNow, we have:\n```\nrsc layer\n--ESM import->\nCSSModuleAsset(in rsc, contains raw SCSS source)\n--CssReferenceSubType::Inner->\nCssAsset(first in client layer, then processed with Webpack loader)\n```\n\nThis aligns it with when you import CSS from a client component, in both cases the CSS module is first transitioned into the client layer, and then processed with Webpack",
    "sha": "0ec5511da47c98112e86290d2f1550ad261d91b2",
    "files": [
        {
            "sha": "524240ef923e76a444fecdf15de387c564060aef",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -314,8 +314,6 @@ jobs:\n         export TURBOPACK_BUILD=1\n         export NEXT_TEST_MODE=start\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n-        # TODO(PACK-4578): Remove\n-        export TURBOPACK_TEMP_DISABLE_DUPLICATE_MODULES_CHECK=1\n \n         node run-tests.js --timings -g ${{ matrix.group }} --type production\n       stepName: 'test-turbopack-production-react-${{ matrix.react }}-${{ matrix.group }}'"
        },
        {
            "sha": "35a6c95b65248bc38f3565104f60133c9c3a6845",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 27,
            "deletions": 34,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -34,7 +34,7 @@ use next_core::{\n     },\n     next_server_utility::{NEXT_SERVER_UTILITY_MERGE_TAG, NextServerUtilityTransition},\n     parse_segment_config_from_source,\n-    util::NextRuntime,\n+    util::{NextRuntime, module_styles_rule_condition, styles_rule_condition},\n };\n use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n@@ -99,37 +99,6 @@ pub struct AppProject {\n pub struct OptionAppProject(Option<ResolvedVc<AppProject>>);\n \n impl AppProject {}\n-\n-fn styles_rule_condition() -> RuleCondition {\n-    RuleCondition::any(vec![\n-        RuleCondition::all(vec![\n-            RuleCondition::ResourcePathEndsWith(\".css\".into()),\n-            RuleCondition::not(RuleCondition::ResourcePathEndsWith(\".module.css\".into())),\n-        ]),\n-        RuleCondition::all(vec![\n-            RuleCondition::ResourcePathEndsWith(\".scss\".into()),\n-            RuleCondition::not(RuleCondition::ResourcePathEndsWith(\".module.scss\".into())),\n-        ]),\n-        RuleCondition::all(vec![\n-            RuleCondition::ResourcePathEndsWith(\".sass\".into()),\n-            RuleCondition::not(RuleCondition::ResourcePathEndsWith(\".module.sass\".into())),\n-        ]),\n-        RuleCondition::all(vec![\n-            RuleCondition::ContentTypeStartsWith(\"text/css\".into()),\n-            RuleCondition::not(RuleCondition::ContentTypeStartsWith(\n-                \"text/css+module\".into(),\n-            )),\n-        ]),\n-    ])\n-}\n-fn module_styles_rule_condition() -> RuleCondition {\n-    RuleCondition::any(vec![\n-        RuleCondition::ResourcePathEndsWith(\".module.css\".into()),\n-        RuleCondition::ResourcePathEndsWith(\".module.scss\".into()),\n-        RuleCondition::ResourcePathEndsWith(\".module.sass\".into()),\n-        RuleCondition::ContentTypeStartsWith(\"text/css+module\".into()),\n-    ])\n-}\n impl AppProject {\n     pub fn client_transition_name() -> RcStr {\n         rcstr!(\"next-ecmascript-client-reference\")\n@@ -406,10 +375,10 @@ impl AppProject {\n             transition_rules: vec![\n                 // Mark as client reference (and exclude from RSC chunking) the edge from the\n                 // CSS Module to the actual CSS\n-                TransitionRule::new_internal(\n+                TransitionRule::new(\n                     RuleCondition::all(vec![\n                         RuleCondition::ReferenceType(ReferenceType::Css(\n-                            CssReferenceSubType::Internal,\n+                            CssReferenceSubType::Inner,\n                         )),\n                         module_styles_rule_condition(),\n                     ]),\n@@ -678,6 +647,18 @@ impl AppProject {\n         Ok(ModuleAssetContext::new(\n             TransitionOptions {\n                 named_transitions: transitions,\n+                transition_rules: vec![\n+                    // Change context, this is used to determine the list of CSS module classes.\n+                    TransitionRule::new(\n+                        RuleCondition::all(vec![\n+                            RuleCondition::ReferenceType(ReferenceType::Css(\n+                                CssReferenceSubType::Analyze,\n+                            )),\n+                            module_styles_rule_condition(),\n+                        ]),\n+                        ResolvedVc::upcast(self.client_transition().to_resolved().await?),\n+                    ),\n+                ],\n                 ..Default::default()\n             }\n             .cell(),\n@@ -738,6 +719,18 @@ impl AppProject {\n         Ok(ModuleAssetContext::new(\n             TransitionOptions {\n                 named_transitions: transitions,\n+                transition_rules: vec![\n+                    // Change context, this is used to determine the list of CSS module classes.\n+                    TransitionRule::new(\n+                        RuleCondition::all(vec![\n+                            RuleCondition::ReferenceType(ReferenceType::Css(\n+                                CssReferenceSubType::Analyze,\n+                            )),\n+                            module_styles_rule_condition(),\n+                        ]),\n+                        ResolvedVc::upcast(self.client_transition().to_resolved().await?),\n+                    ),\n+                ],\n                 ..Default::default()\n             }\n             .cell(),"
        },
        {
            "sha": "69e136b740f3876818acebac7178085bc7ec43f4",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -64,7 +64,10 @@ use crate::{\n         get_decorators_transform_options, get_jsx_transform_options,\n         get_typescript_transform_options,\n     },\n-    util::{OptionEnvMap, defines, foreign_code_context_condition, internal_assets_conditions},\n+    util::{\n+        OptionEnvMap, defines, foreign_code_context_condition, internal_assets_conditions,\n+        module_styles_rule_condition,\n+    },\n };\n \n #[turbo_tasks::function]\n@@ -316,6 +319,7 @@ pub async fn get_client_module_options_context(\n         },\n         css: CssOptionsContext {\n             source_maps,\n+            module_css_condition: Some(module_styles_rule_condition()),\n             ..Default::default()\n         },\n         environment: Some(env),"
        },
        {
            "sha": "e23dc51779baa21480307ca545797f5dd9ab802e",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -75,6 +75,7 @@ use crate::{\n     util::{\n         NextRuntime, OptionEnvMap, defines, foreign_code_context_condition,\n         get_transpiled_packages, internal_assets_conditions, load_next_js_templateon,\n+        module_styles_rule_condition,\n     },\n };\n \n@@ -583,6 +584,7 @@ pub async fn get_server_module_options_context(\n         environment: Some(environment),\n         css: CssOptionsContext {\n             source_maps,\n+            module_css_condition: Some(module_styles_rule_condition()),\n             ..Default::default()\n         },\n         tree_shaking_mode: tree_shaking_mode_for_user_code,"
        },
        {
            "sha": "b0d31f1332f577204c20d658faaa10122e210480",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 27,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -3,7 +3,7 @@ use next_custom_transforms::transforms::strip_page_exports::ExportFilter;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Vc};\n use turbopack::module_options::{ModuleRule, ModuleRuleEffect, RuleCondition};\n-use turbopack_core::reference_type::{ReferenceType, UrlReferenceSubType};\n+use turbopack_core::reference_type::{CssReferenceSubType, ReferenceType, UrlReferenceSubType};\n \n use crate::{\n     mode::NextMode,\n@@ -21,7 +21,7 @@ use crate::{\n         next_page_static_info::get_next_page_static_info_assert_rule,\n         next_pure::get_next_pure_rule, server_actions::ActionsTransform,\n     },\n-    util::NextRuntime,\n+    util::{NextRuntime, module_styles_rule_condition, styles_rule_condition},\n };\n \n /// Returns a list of module rules which apply server-side, Next.js-specific\n@@ -51,35 +51,18 @@ pub async fn get_next_server_transforms_rules(\n \n     if !matches!(context_ty, ServerContextType::AppRSC { .. }) {\n         rules.extend([\n-            // Ignore the internal ModuleCssAsset -> CssModuleAsset references\n-            // The CSS Module module itself is still needed for class names\n-            ModuleRule::new_internal(\n-                RuleCondition::any(vec![\n-                    RuleCondition::ResourcePathEndsWith(\".module.css\".into()),\n-                    RuleCondition::ContentTypeStartsWith(\"text/css+module\".into()),\n-                ]),\n-                vec![ModuleRuleEffect::Ignore],\n-            ),\n-        ]);\n-        rules.extend([\n-            // Ignore all non-module CSS references\n+            // Ignore the inner ModuleCssAsset -> CssModuleAsset references\n+            // The CSS Module module itself (and the Analyze reference) is still needed to generate\n+            // the class names object.\n             ModuleRule::new(\n-                RuleCondition::any(vec![\n-                    RuleCondition::all(vec![\n-                        RuleCondition::ResourcePathEndsWith(\".css\".into()),\n-                        RuleCondition::not(RuleCondition::ResourcePathEndsWith(\n-                            \".module.css\".into(),\n-                        )),\n-                    ]),\n-                    RuleCondition::all(vec![\n-                        RuleCondition::ContentTypeStartsWith(\"text/css\".into()),\n-                        RuleCondition::not(RuleCondition::ContentTypeStartsWith(\n-                            \"text/css+module\".into(),\n-                        )),\n-                    ]),\n+                RuleCondition::all(vec![\n+                    RuleCondition::ReferenceType(ReferenceType::Css(CssReferenceSubType::Inner)),\n+                    module_styles_rule_condition(),\n                 ]),\n                 vec![ModuleRuleEffect::Ignore],\n             ),\n+            // Ignore all non-module CSS references\n+            ModuleRule::new(styles_rule_condition(), vec![ModuleRuleEffect::Ignore]),\n         ]);\n     }\n "
        },
        {
            "sha": "2c34865cf97fb76ba733440a037896a2dabcfd06",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -16,6 +16,7 @@ use turbo_tasks_fs::{\n     self, File, FileContent, FileSystem, FileSystemPath, json::parse_json_rope_with_source_context,\n     rope::Rope,\n };\n+use turbopack::module_options::RuleCondition;\n use turbopack_core::{\n     asset::AssetContent,\n     compile_time_info::{CompileTimeDefineValue, CompileTimeDefines, DefinableNameSegment},\n@@ -793,3 +794,48 @@ pub async fn load_next_js_templateon<T: DeserializeOwned>(\n \n     Ok(result)\n }\n+\n+pub fn styles_rule_condition() -> RuleCondition {\n+    RuleCondition::any(vec![\n+        RuleCondition::all(vec![\n+            RuleCondition::ResourcePathEndsWith(\".css\".into()),\n+            RuleCondition::not(RuleCondition::ResourcePathEndsWith(\".module.css\".into())),\n+        ]),\n+        RuleCondition::all(vec![\n+            RuleCondition::ResourcePathEndsWith(\".sass\".into()),\n+            RuleCondition::not(RuleCondition::ResourcePathEndsWith(\".module.sass\".into())),\n+        ]),\n+        RuleCondition::all(vec![\n+            RuleCondition::ResourcePathEndsWith(\".scss\".into()),\n+            RuleCondition::not(RuleCondition::ResourcePathEndsWith(\".module.scss\".into())),\n+        ]),\n+        RuleCondition::all(vec![\n+            RuleCondition::ContentTypeStartsWith(\"text/css\".into()),\n+            RuleCondition::not(RuleCondition::ContentTypeStartsWith(\n+                \"text/css+module\".into(),\n+            )),\n+        ]),\n+        RuleCondition::all(vec![\n+            RuleCondition::ContentTypeStartsWith(\"text/sass\".into()),\n+            RuleCondition::not(RuleCondition::ContentTypeStartsWith(\n+                \"text/sass+module\".into(),\n+            )),\n+        ]),\n+        RuleCondition::all(vec![\n+            RuleCondition::ContentTypeStartsWith(\"text/scss\".into()),\n+            RuleCondition::not(RuleCondition::ContentTypeStartsWith(\n+                \"text/scss+module\".into(),\n+            )),\n+        ]),\n+    ])\n+}\n+pub fn module_styles_rule_condition() -> RuleCondition {\n+    RuleCondition::any(vec![\n+        RuleCondition::ResourcePathEndsWith(\".module.css\".into()),\n+        RuleCondition::ResourcePathEndsWith(\".module.scss\".into()),\n+        RuleCondition::ResourcePathEndsWith(\".module.sass\".into()),\n+        RuleCondition::ContentTypeStartsWith(\"text/css+module\".into()),\n+        RuleCondition::ContentTypeStartsWith(\"text/sass+module\".into()),\n+        RuleCondition::ContentTypeStartsWith(\"text/scss+module\".into()),\n+    ])\n+}"
        },
        {
            "sha": "8b81cd6c5084bc0ade35d6fbdaf8fc4be3c4e0e8",
            "filename": "turbopack/crates/turbo-tasks/src/raw_vc.rs",
            "status": "modified",
            "additions": 29,
            "deletions": 2,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fraw_vc.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -1,4 +1,9 @@\n-use std::{fmt::Display, future::Future, pin::Pin, task::Poll};\n+use std::{\n+    fmt::{Debug, Display},\n+    future::Future,\n+    pin::Pin,\n+    task::Poll,\n+};\n \n use anyhow::Result;\n use auto_hash_map::AutoSet;\n@@ -54,7 +59,7 @@ impl Display for CellId {\n /// otherwise be treated as an internal implementation detail of `turbo-tasks`.\n ///\n /// [monomorphization]: https://doc.rust-lang.org/book/ch10-01-syntax.html#performance-of-code-using-generics\n-#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]\n+#[derive(Clone, Copy, PartialEq, Eq, Hash, Serialize, Deserialize)]\n pub enum RawVc {\n     /// The synchronous return value of a task (after argument resolution). This is the\n     /// representation used by [`OperationVc`][crate::OperationVc].\n@@ -74,6 +79,28 @@ pub enum RawVc {\n     LocalOutput(ExecutionId, LocalTaskId, TaskPersistence),\n }\n \n+impl Debug for RawVc {\n+    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n+        match self {\n+            RawVc::TaskOutput(task_id) => f\n+                .debug_tuple(\"RawVc::TaskOutput\")\n+                .field(&**task_id)\n+                .finish(),\n+            RawVc::TaskCell(task_id, cell_id) => f\n+                .debug_tuple(\"RawVc::TaskCell\")\n+                .field(&**task_id)\n+                .field(&cell_id.to_string())\n+                .finish(),\n+            RawVc::LocalOutput(execution_id, local_task_id, task_persistence) => f\n+                .debug_tuple(\"RawVc::LocalOutput\")\n+                .field(&**execution_id)\n+                .field(&**local_task_id)\n+                .field(task_persistence)\n+                .finish(),\n+        }\n+    }\n+}\n+\n impl RawVc {\n     pub fn is_resolved(&self) -> bool {\n         match self {"
        },
        {
            "sha": "cf209472713e0eb9985589f3ce2bdb09ffa4c04c",
            "filename": "turbopack/crates/turbo-tasks/src/vc/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fmod.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -357,7 +357,7 @@ where\n     T: ?Sized,\n {\n     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n-        f.debug_struct(\"Vc\").field(\"node\", &self.node).finish()\n+        f.debug_tuple(\"Vc\").field(&self.node).finish()\n     }\n }\n "
        },
        {
            "sha": "57fb5eff9829ac9fe9f4add916d061ec1aed7429",
            "filename": "turbopack/crates/turbo-tasks/src/vc/resolved.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fresolved.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fresolved.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fresolved.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -295,9 +295,7 @@ where\n     T: ?Sized,\n {\n     fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n-        f.debug_struct(\"ResolvedVc\")\n-            .field(\"node\", &self.node.node)\n-            .finish()\n+        f.debug_tuple(\"ResolvedVc\").field(&self.node.node).finish()\n     }\n }\n "
        },
        {
            "sha": "fbfef63f0c50e3fde5f6f24ab4970a2b4b49fd66",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -348,8 +348,6 @@ impl SingleModuleGraph {\n         #[cfg(debug_assertions)]\n         {\n             use once_cell::sync::Lazy;\n-\n-            // TODO(PACK-4578): This is temporary while the last issues are being addressed.\n             static CHECK_FOR_DUPLICATE_MODULES: Lazy<bool> = Lazy::new(|| {\n                 match std::env::var_os(\"TURBOPACK_TEMP_DISABLE_DUPLICATE_MODULES_CHECK\") {\n                     Some(v) => v != \"1\" && v != \"true\","
        },
        {
            "sha": "c619bc3f84938ab601ca8f25ad2d012e3d64e7e8",
            "filename": "turbopack/crates/turbopack-core/src/reference_type.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -221,7 +221,7 @@ pub enum CssReferenceSubType {\n     /// class name\n     Compose,\n     /// Reference from ModuleCssAsset to the CssModuleAsset\n-    Internal,\n+    Inner,\n     /// Used for generating the list of classes in a ModuleCssAsset\n     Analyze,\n     Custom(u8),\n@@ -417,11 +417,6 @@ impl ReferenceType {\n     /// combination with [`ModuleRuleCondition::Internal`] to determine if a\n     /// rule should be applied to an internal asset/reference.\n     pub fn is_internal(&self) -> bool {\n-        matches!(\n-            self,\n-            ReferenceType::Internal(_)\n-                | ReferenceType::Css(CssReferenceSubType::Internal)\n-                | ReferenceType::Runtime\n-        )\n+        matches!(self, ReferenceType::Internal(_) | ReferenceType::Runtime)\n     }\n }"
        },
        {
            "sha": "70bbb22bf7dc43e36ebcd5e6e2352a03a6a78e11",
            "filename": "turbopack/crates/turbopack-css/src/module_asset.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -88,7 +88,7 @@ impl Module for ModuleCssAsset {\n             .copied()\n             .chain(\n                 match *self\n-                    .inner(ReferenceType::Css(CssReferenceSubType::Internal))\n+                    .inner(ReferenceType::Css(CssReferenceSubType::Inner))\n                     .try_into_module()\n                     .await?\n                 {"
        },
        {
            "sha": "c9866a2f23ed0263576c3770691a26379ed25400",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 56,
            "deletions": 22,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -137,6 +137,7 @@ impl ModuleOptions {\n                 CssOptionsContext {\n                     enable_raw_css,\n                     source_maps: css_source_maps,\n+                    ref module_css_condition,\n                     ..\n                 },\n             ref enable_postcss_transform,\n@@ -149,6 +150,28 @@ impl ModuleOptions {\n             ..\n         } = *module_options_context.await?;\n \n+        let module_css_condition = module_css_condition.clone().unwrap_or_else(|| {\n+            RuleCondition::any(vec![\n+                RuleCondition::ResourcePathEndsWith(\".module.css\".to_string()),\n+                RuleCondition::ContentTypeStartsWith(\"text/css+module\".to_string()),\n+            ])\n+        });\n+\n+        // For React Client References, the CSS Module \"facade\" module lives in the parent (server)\n+        // module context, but the facade's references should be transitioned to the client (and\n+        // only then be processed with Webpack/PostCSS).\n+        //\n+        // Note that this is not an exhaustive condition for PostCSS/Webpack, but excludes certain\n+        // cases, so it should be added conjunctively together with the `module_css_condition` rule.\n+        //\n+        // If module css, then only when (Inner or Analyze or Compose)\n+        // <=> (not (module css)) or (Inner or Analyzer or Compose)\n+        let module_css_external_transform_conditions = vec![\n+            RuleCondition::ReferenceType(ReferenceType::Css(CssReferenceSubType::Inner)),\n+            RuleCondition::ReferenceType(ReferenceType::Css(CssReferenceSubType::Analyze)),\n+            RuleCondition::ReferenceType(ReferenceType::Css(CssReferenceSubType::Compose)),\n+        ];\n+\n         let mut ts_preprocess = vec![];\n         let mut ecma_preprocess = vec![];\n         let mut postprocess = vec![];\n@@ -458,10 +481,7 @@ impl ModuleOptions {\n                     })],\n                 ),\n                 ModuleRule::new(\n-                    RuleCondition::any(vec![\n-                        RuleCondition::ResourcePathEndsWith(\".module.css\".to_string()),\n-                        RuleCondition::ContentTypeStartsWith(\"text/css+module\".to_string()),\n-                    ]),\n+                    module_css_condition.clone(),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Module,\n                         environment,\n@@ -486,8 +506,21 @@ impl ModuleOptions {\n \n                 rules.push(ModuleRule::new(\n                     RuleCondition::Any(vec![\n-                        RuleCondition::ResourcePathEndsWith(\".css\".to_string()),\n-                        RuleCondition::ContentTypeStartsWith(\"text/css\".to_string()),\n+                        RuleCondition::All(vec![\n+                            RuleCondition::Any(vec![\n+                                RuleCondition::ResourcePathEndsWith(\".css\".to_string()),\n+                                RuleCondition::ContentTypeStartsWith(\"text/css\".to_string()),\n+                            ]),\n+                            RuleCondition::not(module_css_condition.clone()),\n+                        ]),\n+                        RuleCondition::All(\n+                            [\n+                                vec![module_css_condition.clone()],\n+                                // see comment on module_css_external_transform_conditions\n+                                module_css_external_transform_conditions.clone(),\n+                            ]\n+                            .concat(),\n+                        ),\n                     ]),\n                     vec![ModuleRuleEffect::SourceTransforms(ResolvedVc::cell(vec![\n                         ResolvedVc::upcast(\n@@ -523,10 +556,7 @@ impl ModuleOptions {\n                 ),\n                 ModuleRule::new(\n                     RuleCondition::all(vec![\n-                        RuleCondition::Any(vec![\n-                            RuleCondition::ResourcePathEndsWith(\".module.css\".to_string()),\n-                            RuleCondition::ContentTypeStartsWith(\"text/css+module\".to_string()),\n-                        ]),\n+                        module_css_condition.clone(),\n                         // Only create a module CSS asset if not `@import`ed from CSS already.\n                         // NOTE: `composes` references should not be treated as `@import`s and\n                         // should also create a module CSS asset.\n@@ -538,10 +568,7 @@ impl ModuleOptions {\n                 ),\n                 ModuleRule::new(\n                     RuleCondition::all(vec![\n-                        RuleCondition::Any(vec![\n-                            RuleCondition::ResourcePathEndsWith(\".module.css\".to_string()),\n-                            RuleCondition::ContentTypeStartsWith(\"text/css+module\".to_string()),\n-                        ]),\n+                        module_css_condition.clone(),\n                         // Create a normal CSS asset if `@import`ed from CSS already.\n                         RuleCondition::ReferenceType(ReferenceType::Css(\n                             CssReferenceSubType::AtImport(None),\n@@ -553,10 +580,12 @@ impl ModuleOptions {\n                     })],\n                 ),\n                 // Ecmascript CSS Modules referencing the actual CSS module to include it\n-                ModuleRule::new_internal(\n-                    RuleCondition::Any(vec![\n-                        RuleCondition::ResourcePathEndsWith(\".module.css\".to_string()),\n-                        RuleCondition::ContentTypeStartsWith(\"text/css+module\".to_string()),\n+                ModuleRule::new(\n+                    RuleCondition::all(vec![\n+                        RuleCondition::ReferenceType(ReferenceType::Css(\n+                            CssReferenceSubType::Inner,\n+                        )),\n+                        module_css_condition.clone(),\n                     ]),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Module,\n@@ -569,10 +598,7 @@ impl ModuleOptions {\n                         RuleCondition::ReferenceType(ReferenceType::Css(\n                             CssReferenceSubType::Analyze,\n                         )),\n-                        RuleCondition::Any(vec![\n-                            RuleCondition::ResourcePathEndsWith(\".module.css\".to_string()),\n-                            RuleCondition::ContentTypeStartsWith(\"text/css+module\".to_string()),\n-                        ]),\n+                        module_css_condition.clone(),\n                     ]),\n                     vec![ModuleRuleEffect::ModuleType(ModuleType::Css {\n                         ty: CssModuleAssetType::Module,\n@@ -677,6 +703,14 @@ impl ModuleOptions {\n                             RuleCondition::ResourceBasePathGlob(Glob::new(key.clone()).await?)\n                         },\n                         RuleCondition::not(RuleCondition::ResourceIsVirtualSource),\n+                        // see comment on module_css_external_transform_conditions\n+                        RuleCondition::Any(\n+                            [\n+                                vec![RuleCondition::not(module_css_condition.clone())],\n+                                module_css_external_transform_conditions.clone(),\n+                            ]\n+                            .concat(),\n+                        ),\n                     ]),\n                     vec![ModuleRuleEffect::SourceTransforms(ResolvedVc::cell(vec![\n                         ResolvedVc::upcast("
        },
        {
            "sha": "6bb445fcb57edcb35b0536286049e4498009aa00",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -17,6 +17,7 @@ use turbopack_node::{\n };\n \n use super::ModuleRule;\n+use crate::module_options::RuleCondition;\n \n #[derive(Clone, PartialEq, Eq, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue)]\n pub struct LoaderRuleItem {\n@@ -214,6 +215,11 @@ pub struct CssOptionsContext {\n     /// Specifies how Source Maps are handled.\n     pub source_maps: SourceMapsType,\n \n+    /// Override the conditions for module CSS (doesn't have any effect if `enable_raw_css` is\n+    /// true). By default (for `None`), it uses\n+    /// `Any(ResourcePathEndsWith(\".module.css\"), ContentTypeStartsWith(\"text/css+module\"))`\n+    pub module_css_condition: Option<RuleCondition>,\n+\n     pub placeholder_for_future_extensions: (),\n }\n "
        }
    ],
    "stats": {
        "total": 288,
        "additions": 186,
        "deletions": 102
    }
}