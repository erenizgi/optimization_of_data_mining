{
    "author": "devjiwonchoi",
    "message": "[release-legacy] fix: set `stable` dist tag for backport releases instead of `latest` (#79596)\n\n### Why?\n\nIf the current version is less than the latest, it means this is a\nbackport release. Since NPM sets the `latest` tag by default during\npublishing, when users install `next@latest`, they might get the\nbackported version instead of the actual \"latest\" version. Therefore, we\nexplicitly set the tag as `stable` for backports.",
    "sha": "2bb5ed2103498d3ccc3ac3b085ae39b1e18f8478",
    "files": [
        {
            "sha": "3c9d673cf3affec92c4a1defa2a8b85edcebd17a",
            "filename": "scripts/publish-release.js",
            "status": "modified",
            "additions": 30,
            "deletions": 5,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/2bb5ed2103498d3ccc3ac3b085ae39b1e18f8478/scripts%2Fpublish-release.js",
            "raw_url": "https://github.com/vercel/next.js/raw/2bb5ed2103498d3ccc3ac3b085ae39b1e18f8478/scripts%2Fpublish-release.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fpublish-release.js?ref=2bb5ed2103498d3ccc3ac3b085ae39b1e18f8478",
            "patch": "@@ -3,6 +3,7 @@\n \n const path = require('path')\n const execa = require('execa')\n+const semver = require('semver')\n const { Sema } = require('async-sema')\n const { execSync } = require('child_process')\n const fs = require('fs')\n@@ -32,6 +33,34 @@ const cwd = process.cwd()\n     }\n     throw err\n   }\n+\n+  let tag = isCanary ? 'canary' : isReleaseCandidate ? 'rc' : 'latest'\n+\n+  try {\n+    if (!isCanary && !isReleaseCandidate) {\n+      const version = JSON.parse(\n+        await fs.promises.readFile(path.join(cwd, 'lerna.json'), 'utf-8')\n+      ).version\n+\n+      const res = await fetch(\n+        `https://registry.npmjs.org/-/package/next/dist-tags`\n+      )\n+      const tags = await res.json()\n+\n+      if (semver.lt(version, tags.latest)) {\n+        // If the current version is less than the latest, it means this\n+        // is a backport release. Since NPM sets the 'latest' tag by default\n+        // during publishing, when users install `next@latest`, they might\n+        // get the backported version instead of the actual \"latest\" version.\n+        // Therefore, we explicitly set the tag as 'stable' for backports.\n+        tag = 'stable'\n+      }\n+    }\n+  } catch (error) {\n+    console.log('Failed to fetch Next.js dist tags from the NPM registry.')\n+    throw error\n+  }\n+\n   console.log(\n     `Publishing ${isCanary ? 'canary' : isReleaseCandidate ? 'rc' : 'stable'}`\n   )\n@@ -57,11 +86,7 @@ const cwd = process.cwd()\n           '--access',\n           'public',\n           '--ignore-scripts',\n-          ...(isCanary\n-            ? ['--tag', 'canary']\n-            : isReleaseCandidate\n-              ? ['--tag', 'rc']\n-              : []),\n+          ['--tag', tag],\n         ],\n         { stdio: 'pipe' }\n       )"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 30,
        "deletions": 5
    }
}