{
    "author": "mischnic",
    "message": "test: Refactor edge-runtime-dynamic-code test (#83390)\n\nThis test is about `eval`\nBut it also used a non-static middleware `matchers` config, which is going to break once we are more strict about this and throw a build error.",
    "sha": "7861621f588865544276d4ba7444ee7148419f6b",
    "files": [
        {
            "sha": "60fdfbe824117baa2ee15116d745b60247d94bac",
            "filename": "test/integration/edge-runtime-dynamic-code/lib/utils.js",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/7861621f588865544276d4ba7444ee7148419f6b/test%2Fintegration%2Fedge-runtime-dynamic-code%2Flib%2Futils.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7861621f588865544276d4ba7444ee7148419f6b/test%2Fintegration%2Fedge-runtime-dynamic-code%2Flib%2Futils.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fedge-runtime-dynamic-code%2Flib%2Futils.js?ref=7861621f588865544276d4ba7444ee7148419f6b",
            "patch": "@@ -1,11 +1,3 @@\n-export const useCases = {\n-  eval: 'using-eval',\n-  noEval: 'not-using-eval',\n-  wasmCompile: 'using-webassembly-compile',\n-  wasmInstanciate: 'using-webassembly-instantiate',\n-  wasmBufferInstanciate: 'using-webassembly-instantiate-with-buffer',\n-}\n-\n export async function usingEval() {\n   // eslint-disable-next-line no-eval\n   return { value: eval('100') }"
        },
        {
            "sha": "0cfbcc842221b3927270a561a03439d38a6e1ecf",
            "filename": "test/integration/edge-runtime-dynamic-code/middleware.js",
            "status": "modified",
            "additions": 15,
            "deletions": 7,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/7861621f588865544276d4ba7444ee7148419f6b/test%2Fintegration%2Fedge-runtime-dynamic-code%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7861621f588865544276d4ba7444ee7148419f6b/test%2Fintegration%2Fedge-runtime-dynamic-code%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fedge-runtime-dynamic-code%2Fmiddleware.js?ref=7861621f588865544276d4ba7444ee7148419f6b",
            "patch": "@@ -1,37 +1,39 @@\n import { NextResponse } from 'next/server'\n-import { useCases, notUsingEval, usingEval } from './lib/utils'\n+import { notUsingEval, usingEval } from './lib/utils'\n import {\n   usingWebAssemblyCompile,\n   usingWebAssemblyInstantiate,\n   usingWebAssemblyInstantiateWithBuffer,\n } from './lib/wasm'\n \n export async function middleware(request) {\n-  if (request.nextUrl.pathname === `/${useCases.eval}`) {\n+  if (request.nextUrl.pathname === '/using-eval') {\n     return new Response(null, {\n       headers: { data: JSON.stringify(await usingEval()) },\n     })\n   }\n \n-  if (request.nextUrl.pathname === `/${useCases.noEval}`) {\n+  if (request.nextUrl.pathname === '/not-using-eval') {\n     return new Response(null, {\n       headers: { data: JSON.stringify(await notUsingEval()) },\n     })\n   }\n \n-  if (request.nextUrl.pathname === `/${useCases.wasmCompile}`) {\n+  if (request.nextUrl.pathname === '/using-webassembly-compile') {\n     return new Response(null, {\n       headers: { data: JSON.stringify(await usingWebAssemblyCompile(9)) },\n     })\n   }\n \n-  if (request.nextUrl.pathname === `/${useCases.wasmInstanciate}`) {\n+  if (request.nextUrl.pathname === '/using-webassembly-instantiate') {\n     return new Response(null, {\n       headers: { data: JSON.stringify(await usingWebAssemblyInstantiate(9)) },\n     })\n   }\n \n-  if (request.nextUrl.pathname === `/${useCases.wasmBufferInstanciate}`) {\n+  if (\n+    request.nextUrl.pathname === '/using-webassembly-instantiate-with-buffer'\n+  ) {\n     return new Response(null, {\n       headers: {\n         data: JSON.stringify(await usingWebAssemblyInstantiateWithBuffer(9)),\n@@ -43,5 +45,11 @@ export async function middleware(request) {\n }\n \n export const config = {\n-  matcher: Object.values(useCases).map((route) => `/${route}`),\n+  matcher: [\n+    '/using-eval',\n+    '/not-using-eval',\n+    '/using-webassembly-compile',\n+    '/using-webassembly-instantiate',\n+    '/using-webassembly-instantiate-with-buffer',\n+  ],\n }"
        },
        {
            "sha": "858db0a21f2d1966177440a813d07c3cc8b7561b",
            "filename": "test/integration/edge-runtime-dynamic-code/pages/api/route.js",
            "status": "modified",
            "additions": 22,
            "deletions": 14,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/7861621f588865544276d4ba7444ee7148419f6b/test%2Fintegration%2Fedge-runtime-dynamic-code%2Fpages%2Fapi%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7861621f588865544276d4ba7444ee7148419f6b/test%2Fintegration%2Fedge-runtime-dynamic-code%2Fpages%2Fapi%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fedge-runtime-dynamic-code%2Fpages%2Fapi%2Froute.js?ref=7861621f588865544276d4ba7444ee7148419f6b",
            "patch": "@@ -1,4 +1,4 @@\n-import { useCases, notUsingEval, usingEval } from '../../lib/utils'\n+import { notUsingEval, usingEval } from '../../lib/utils'\n import {\n   usingWebAssemblyCompile,\n   usingWebAssemblyInstantiate,\n@@ -8,19 +8,27 @@ import {\n export default async function handler(request) {\n   const useCase = request.nextUrl.searchParams.get('case')\n \n-  return Response.json(\n-    useCase === useCases.eval\n-      ? await usingEval()\n-      : useCase === useCases.noEval\n-        ? await notUsingEval()\n-        : useCase === useCases.wasmCompile\n-          ? await usingWebAssemblyCompile(9)\n-          : useCase === useCases.wasmInstanciate\n-            ? await usingWebAssemblyInstantiate(9)\n-            : useCase === useCases.wasmBufferInstanciate\n-              ? await usingWebAssemblyInstantiateWithBuffer(9)\n-              : { ok: true }\n-  )\n+  if (useCase === 'using-eval') {\n+    return Response.json(await usingEval())\n+  }\n+\n+  if (useCase === 'not-using-eval') {\n+    return Response.json(await notUsingEval())\n+  }\n+\n+  if (useCase === 'using-webassembly-compile') {\n+    return Response.json(await usingWebAssemblyCompile(9))\n+  }\n+\n+  if (useCase === 'using-webassembly-instantiate') {\n+    return Response.json(await usingWebAssemblyInstantiate(9))\n+  }\n+\n+  if (useCase === 'using-webassembly-instantiate-with-buffer') {\n+    return Response.json(await usingWebAssemblyInstantiateWithBuffer(9))\n+  }\n+\n+  return Response.json({ ok: true })\n }\n \n export const config = { runtime: 'edge' }"
        },
        {
            "sha": "05548e81eb2b9e88b3711575a2bdf2457e543cdf",
            "filename": "test/integration/edge-runtime-dynamic-code/test/index.test.js",
            "status": "modified",
            "additions": 22,
            "deletions": 26,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/7861621f588865544276d4ba7444ee7148419f6b/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7861621f588865544276d4ba7444ee7148419f6b/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fedge-runtime-dynamic-code%2Ftest%2Findex.test.js?ref=7861621f588865544276d4ba7444ee7148419f6b",
            "patch": "@@ -42,7 +42,7 @@ describe('Page using eval in development mode', () => {\n   beforeEach(() => (output = ''))\n   afterAll(() => killApp(context.app))\n \n-  it('does issue dynamic code evaluation warnings', async () => {\n+  it('does not issue dynamic code evaluation warnings', async () => {\n     const html = await renderViaHTTP(context.appPort, '/')\n     expect(html).toMatch(/>.*?100.*?and.*?100.*?<\\//)\n     await waitFor(500)\n@@ -108,10 +108,10 @@ describe.each([\n               isTurbopack\n                 ? '' +\n                     // TODO(veil): Turbopack duplicates project path\n-                    '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/utils.js:11:17)' +\n+                    '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/utils.js:3:17)' +\n                     '\\n    at middleware (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/middleware.js:12:54)' +\n-                    '\\n   9 | export async function usingEval() {'\n-                : '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/lib/utils.js:11:19)' +\n+                    '\\n  1 | export async function usingEval() {'\n+                : '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/lib/utils.js:3:19)' +\n                     '\\n    at middleware (../../test/integration/edge-runtime-dynamic-code/middleware.js:12:54)' +\n                     // Next.js internal frame. Feel free to adjust.\n                     // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n@@ -122,27 +122,27 @@ describe.each([\n               isTurbopack\n                 ? '' +\n                     // TODO(veil): Turbopack duplicates project path\n-                    '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/utils.js:11:17)' +\n-                    '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:13:24)' +\n-                    '\\n   9 | export async function usingEval() {'\n-                : '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/lib/utils.js:11:19)' +\n-                    '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:13:24)' +\n-                    '\\n   9 | export async function usingEval() {'\n+                    '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/utils.js:3:17)' +\n+                    '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:12:41)' +\n+                    '\\n  1 | export async function usingEval() {'\n+                : '\\n    at usingEval (../../test/integration/edge-runtime-dynamic-code/lib/utils.js:3:19)' +\n+                    '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:12:41)' +\n+                    '\\n  1 | export async function usingEval() {'\n             )\n           }\n \n           // Turbopack produces incorrect mappings in the sourcemap.\n           if (isTurbopack) {\n             expect(output).toContain(\n               '' +\n-                \"\\n> 11 |   return { value: eval('100') }\" +\n-                '\\n     |                 ^'\n+                \"\\n> 3 |   return { value: eval('100') }\" +\n+                '\\n    |                 ^'\n             )\n           } else {\n             expect(output).toContain(\n               '' +\n-                \"\\n> 11 |   return { value: eval('100') }\" +\n-                '\\n     |                   ^'\n+                \"\\n> 3 |   return { value: eval('100') }\" +\n+                '\\n    |                   ^'\n             )\n           }\n         })\n@@ -189,14 +189,12 @@ describe.each([\n                 ? '' +\n                     // TODO(veil): Turbopack duplicates project path\n                     '\\n    at usingWebAssemblyCompile (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/wasm.js:22:18)' +\n-                    '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:17:42)' +\n+                    '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:20:55)' +\n                     '\\n  20 |'\n                 : '' +\n                     '\\n    at usingWebAssemblyCompile (../../test/integration/edge-runtime-dynamic-code/lib/wasm.js:22:24)' +\n-                    '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:17:42)' +\n-                    // Next.js internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-                    '\\n    at'\n+                    '\\n    at handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:20:55)' +\n+                    '\\n  20 |'\n             )\n \n             // Turbopack produces incorrect mappings in the sourcemap.\n@@ -230,11 +228,11 @@ describe.each([\n               isTurbopack\n                 ? '' +\n                     '\\n    at async usingWebAssemblyInstantiateWithBuffer (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/wasm.js:28:24)' +\n-                    '\\n    at async middleware (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/middleware.js:37:30)' +\n+                    '\\n    at async middleware (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/middleware.js:39:30)' +\n                     '\\n  26 |\\n'\n                 : '' +\n                     '\\n    at async usingWebAssemblyInstantiateWithBuffer (../../test/integration/edge-runtime-dynamic-code/lib/wasm.js:28:24)' +\n-                    '\\n    at async middleware (../../test/integration/edge-runtime-dynamic-code/middleware.js:37:30)' +\n+                    '\\n    at async middleware (../../test/integration/edge-runtime-dynamic-code/middleware.js:39:30)' +\n                     // Next.js internal frame. Feel free to adjust.\n                     // TODO(veil): https://linear.app/vercel/issue/NDX-464\n                     '\\n    at '\n@@ -250,14 +248,12 @@ describe.each([\n                 ? '' +\n                     // TODO(veil): Turbopack duplicates project path\n                     '\\n    at async usingWebAssemblyInstantiateWithBuffer (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/lib/wasm.js:28:24)' +\n-                    '\\n    at async handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:21:17)' +\n+                    '\\n    at async handler (../../test/integration/edge-runtime-dynamic-code/test/integration/edge-runtime-dynamic-code/pages/api/route.js:28:26)' +\n                     '\\n  26 |'\n                 : '' +\n                     '\\n    at async usingWebAssemblyInstantiateWithBuffer (../../test/integration/edge-runtime-dynamic-code/lib/wasm.js:28:24)' +\n-                    '\\n    at async handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:21:17)' +\n-                    // Next.js internal frame. Feel free to adjust.\n-                    // Not ignore-listed because we're not in an isolated app and Next.js is symlinked so it's not in node_modules\n-                    '\\n    at'\n+                    '\\n    at async handler (../../test/integration/edge-runtime-dynamic-code/pages/api/route.js:28:26)' +\n+                    '\\n  26 |'\n             )\n             // TODO(veil): Inconsistent cursor position\n             expect(stripAnsi(output)).toContain("
        }
    ],
    "stats": {
        "total": 114,
        "additions": 59,
        "deletions": 55
    }
}