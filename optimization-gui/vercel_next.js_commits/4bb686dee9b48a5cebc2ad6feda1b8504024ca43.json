{
    "author": "gaojude",
    "message": "Fix: respond 405 status code on OPTIONS request to SSG page (#76767)\n\n### What?\n\nThe behavior of `OPTIONS` requests differs depending on whether the page\nis an SSG page or not:\n\n- For **SSG pages**, we return a `405 Method Not Allowed` status code\n([#34346](https://github.com/vercel/next.js/pull/34346)).\n- Otherwise, when an `OPTIONS` request reaches `doRender`, it returns a\n`400 Bad Request`\n([#65295](https://github.com/vercel/next.js/pull/65295)).\n\nHowever, in the first case, handling the error page triggers a\n`doRender` call, which inadvertently resets the status code to `400`. We\nwant to ensure it remains `405`.\n\nTo fix this, I propose **skipping the error page rendering for `OPTIONS`\nrequests on SSG pages** and directly returning `\"Method Not Allowed\"`.\nThis also addresses several related issues (see \"Why\").\n\n### Why?\n\nWhen an `OPTIONS` request is made to an SSG page:\n\n1. **Rendering an error page is wasteful.** A `405` response doesnâ€™t\nneed a UI, so skipping the rendering improves efficiency.\n2. **The status code is reset incorrectly.** As described in [\"What\"],\nthe logic in\n[`base-server.ts#L2682`](https://github.com/vercel/next.js/blob/canary/packages/next/src/server/base-server.ts#L2682)\nchanges the status code to `400` when rendering an error page.\n3. **It triggers a fatal error** (`Error: invariant: cache entry\nrequired but not generated`) for projects deployed on Vercel (see:\n[NEXT-4000](https://github.com/vercel/next.js/issues/4000)).\n\n### How?\n\nInstead of rendering an error page, we return a **hardcoded HTML\nresponse** with a `\"Method Not Allowed\"` body.\n\nCloses [NEXT-4000](https://github.com/vercel/next.js/issues/4000).",
    "sha": "4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
    "files": [
        {
            "sha": "1cbe3f3ee99bcbf2fce7caa5ff8c6fd65219581d",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "patch": "@@ -2247,7 +2247,7 @@ export default abstract class Server<\n     ) {\n       res.statusCode = 405\n       res.setHeader('Allow', ['GET', 'HEAD'])\n-      await this.renderError(null, req, res, pathname)\n+      res.body('Method Not Allowed').send()\n       return null\n     }\n "
        },
        {
            "sha": "f053252c2712f93f623c4317a2da79ce6bbd489c",
            "filename": "test/production/options-request/app/app-page/dynamic/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-page%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-page%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-page%2Fdynamic%2Fpage.tsx?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "patch": "@@ -0,0 +1,5 @@\n+export default function Page() {\n+  return <div>foo page</div>\n+}\n+\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "1191a1be9e7e55904d0dbaa7742ad76fb2a33421",
            "filename": "test/production/options-request/app/app-page/static/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-page%2Fstatic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-page%2Fstatic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-page%2Fstatic%2Fpage.tsx?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "previous_filename": "test/e2e/app-dir/options-request/app/app-page/page.tsx"
        },
        {
            "sha": "39ce780b24b86c583411d467bf31565776d863ec",
            "filename": "test/production/options-request/app/app-route/route.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-route%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-route%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fapp%2Fapp-route%2Froute.ts?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "previous_filename": "test/e2e/app-dir/options-request/app/app-route/route.ts"
        },
        {
            "sha": "e7077399c03ce1479a655dc647c0545b64531628",
            "filename": "test/production/options-request/app/layout.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fapp%2Flayout.tsx?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "previous_filename": "test/e2e/app-dir/options-request/app/layout.tsx"
        },
        {
            "sha": "650f6554bbf288ae0aaf21380183f22add075ebb",
            "filename": "test/production/options-request/app/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fapp%2Fpage.tsx?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "previous_filename": "test/e2e/app-dir/options-request/app/page.tsx"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/options-request/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fnext.config.js?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "previous_filename": "test/e2e/app-dir/options-request/next.config.js"
        },
        {
            "sha": "c488ce8c665dd5e4aefbc2913802011a5263d790",
            "filename": "test/production/options-request/options-request.test.ts",
            "status": "renamed",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Foptions-request.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Foptions-request.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Foptions-request.test.ts?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "patch": "@@ -5,8 +5,8 @@ describe('options-request', () => {\n     files: __dirname,\n   })\n \n-  it.each(['/app-page', '/pages-page'])(\n-    'should return a 400 status code when invoking %s with an OPTIONS request',\n+  it.each(['/app-page/dynamic', '/pages-page/dynamic'])(\n+    'should return a 400 status code when invoking %s with an OPTIONS request (dynamic rendering)',\n     async (path) => {\n       const res = await next.fetch(path, { method: 'OPTIONS' })\n       expect(res.status).toBe(400)\n@@ -15,6 +15,15 @@ describe('options-request', () => {\n     }\n   )\n \n+  it.each(['/app-page/static', '/pages-page/static'])(\n+    'should return a 405 status code when invoking %s with an OPTIONS request (static rendering)',\n+    async (path) => {\n+      const res = await next.fetch(path, { method: 'OPTIONS' })\n+      expect(res.status).toBe(405)\n+      expect(await res.text()).toBe('Method Not Allowed')\n+    }\n+  )\n+\n   // In app router, OPTIONS is auto-implemented if not provided\n   it('should respond with a 204 No Content when invoking an app route handler with an OPTIONS request', async () => {\n     const res = await next.fetch('/app-route', { method: 'OPTIONS' })",
            "previous_filename": "test/e2e/app-dir/options-request/options-request.test.ts"
        },
        {
            "sha": "731ed5508860a0b2aa751f26e9fdbb9f08a9f061",
            "filename": "test/production/options-request/pages/api/pages-api-handler.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fpages%2Fapi%2Fpages-api-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fpages%2Fapi%2Fpages-api-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fpages%2Fapi%2Fpages-api-handler.ts?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "previous_filename": "test/e2e/app-dir/options-request/pages/api/pages-api-handler.ts"
        },
        {
            "sha": "8e01a849c9b64129552528091785d9b757121255",
            "filename": "test/production/options-request/pages/pages-page/dynamic.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fpages%2Fpages-page%2Fdynamic.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fpages%2Fpages-page%2Fdynamic.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fpages%2Fpages-page%2Fdynamic.tsx?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "patch": "@@ -0,0 +1,11 @@\n+export default function Page() {\n+  return <div>bar</div>\n+}\n+\n+export async function getServerSideProps() {\n+  return {\n+    props: {\n+      data: {},\n+    },\n+  }\n+}"
        },
        {
            "sha": "9fa180e51323e094cfb22c0fe42e04feff6d5179",
            "filename": "test/production/options-request/pages/pages-page/static.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fpages%2Fpages-page%2Fstatic.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4bb686dee9b48a5cebc2ad6feda1b8504024ca43/test%2Fproduction%2Foptions-request%2Fpages%2Fpages-page%2Fstatic.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Foptions-request%2Fpages%2Fpages-page%2Fstatic.tsx?ref=4bb686dee9b48a5cebc2ad6feda1b8504024ca43",
            "previous_filename": "test/e2e/app-dir/options-request/pages/pages-page.tsx"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 28,
        "deletions": 3
    }
}