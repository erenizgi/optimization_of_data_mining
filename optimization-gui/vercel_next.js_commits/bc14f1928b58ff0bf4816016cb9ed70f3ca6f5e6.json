{
    "author": "F7b5",
    "message": "fix: Update URL resolution logic to handle search parameters on root path /?foo=bar (#78262)\n\n## What?\n\nThis PR fixes and implements test for an URL resolution issue that\nstripped the searchparam when `metadataBase` was defined and a search\nparam was set on the root path. This created a behavior where :\n\n```\nexport const metadata: Metadata = {\n  title: \"Create Next App\",\n  description: \"Generated by create next app\",\n  metadataBase: new URL(\"https://www.example.com\"),\n  alternates: {\n    canonical: \"/?foo=bar\",\n  },\n};\n```\n\nwould result in \n\n`<link rel=\"canonical\" href=\"https://www.example.com\">` \n\ninstead of \n\n`<link rel=\"canonical\" href=\"https://www.example.com/?foo=bar\">`\n\n\n\n## Related issues\n\n- Fixes #65776\n- Fixes #74689\n\nCo-authored-by: Jiwon Choi <devjiwonchoi@gmail.com>",
    "sha": "bc14f1928b58ff0bf4816016cb9ed70f3ca6f5e6",
    "files": [
        {
            "sha": "f1fb13b32c094324b3007cd407c50ec4cc544c29",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-url.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/bc14f1928b58ff0bf4816016cb9ed70f3ca6f5e6/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bc14f1928b58ff0bf4816016cb9ed70f3ca6f5e6/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.test.ts?ref=bc14f1928b58ff0bf4816016cb9ed70f3ca6f5e6",
            "patch": "@@ -62,6 +62,12 @@ describe('resolveAbsoluteUrlWithPathname', () => {\n         'https://example.com/foo'\n       )\n     })\n+\n+    it('should resolve absolute internal url with query', () => {\n+      expect(resolver('https://example.com/?foo=bar')).toBe(\n+        'https://example.com/?foo=bar'\n+      )\n+    })\n   })\n \n   describe('trailingSlash is true', () => {\n@@ -102,13 +108,20 @@ describe('resolveAbsoluteUrlWithPathname', () => {\n       expect(resolver(new URL('https://example.com/foo?bar'))).toBe(\n         'https://example.com/foo?bar'\n       )\n+      expect(resolver('https://example.com/?foo=bar')).toBe(\n+        'https://example.com/?foo=bar'\n+      )\n     })\n \n     it('should not add trailing slash to relative url with query', () => {\n       expect(resolver('/foo?bar')).toBe('https://example.com/foo?bar')\n       expect(resolver(new URL('/foo?bar', metadataBase))).toBe(\n         'https://example.com/foo?bar'\n       )\n+      expect(resolver('/?foo=bar')).toBe('https://example.com/?foo=bar')\n+      expect(resolver(new URL('/?foo=bar', metadataBase))).toBe(\n+        'https://example.com/?foo=bar'\n+      )\n     })\n \n     it('should not add trailing slash to relative url that matches file pattern', () => {"
        },
        {
            "sha": "427a3ecd6648437fe2c1b37981928eb78ccb2c41",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-url.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/bc14f1928b58ff0bf4816016cb9ed70f3ca6f5e6/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bc14f1928b58ff0bf4816016cb9ed70f3ca6f5e6/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts?ref=bc14f1928b58ff0bf4816016cb9ed70f3ca6f5e6",
            "patch": "@@ -114,7 +114,10 @@ function resolveAbsoluteUrlWithPathname(\n   if (typeof result === 'string') {\n     resolvedUrl = result\n   } else {\n-    resolvedUrl = result.pathname === '/' ? result.origin : result.href\n+    resolvedUrl =\n+      result.pathname === '/' && result.searchParams.size === 0\n+        ? result.origin\n+        : result.href\n   }\n \n   // Add trailing slash if it's enabled for urls matches the condition"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 17,
        "deletions": 1
    }
}