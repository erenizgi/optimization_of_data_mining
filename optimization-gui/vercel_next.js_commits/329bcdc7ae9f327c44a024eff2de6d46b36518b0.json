{
    "author": "eps1lon",
    "message": "[devtools] Fix \"open in editor\" for locations in stackframes (#82013)",
    "sha": "329bcdc7ae9f327c44a024eff2de6d46b36518b0",
    "files": [
        {
            "sha": "5dbcb1d6c851f1baca16923ab4e8242f8e5da922",
            "filename": "packages/next/src/next-devtools/server/launch-editor.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 6,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/329bcdc7ae9f327c44a024eff2de6d46b36518b0/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Flaunch-editor.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/329bcdc7ae9f327c44a024eff2de6d46b36518b0/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Flaunch-editor.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Flaunch-editor.ts?ref=329bcdc7ae9f327c44a024eff2de6d46b36518b0",
            "patch": "@@ -27,6 +27,7 @@ import fs from 'fs'\n import fsp from 'fs/promises'\n import os from 'os'\n import path from 'path'\n+import { fileURLToPath } from 'url'\n import shellQuote from 'next/dist/compiled/shell-quote'\n \n function isTerminalEditor(editor: string) {\n@@ -426,15 +427,33 @@ export function launchEditor(fileName: string, line1: number, column1: number) {\n   }\n }\n \n-// Open the file in editor if exists, otherwise return an error\n+/**\n+ * Open the file in editor if exists, otherwise return an error\n+ * @param file `file:` URL, or absolute path or relative path. Relative paths must\n+ *             relative to `nextRootDirectory`.\n+ */\n export async function openFileInEditor(\n-  filePath: string,\n+  file: string,\n   line1: number,\n-  column1: number\n-) {\n+  column1: number,\n+  nextRootDirectory: string\n+): Promise<{ found: boolean; error: unknown | null }> {\n+  let filePath: string\n+  if (file.startsWith('file://')) {\n+    try {\n+      filePath = fileURLToPath(file)\n+    } catch (error) {\n+      return { found: false, error }\n+    }\n+  } else if (path.isAbsolute(file)) {\n+    filePath = file\n+  } else {\n+    filePath = path.join(nextRootDirectory, file)\n+  }\n+\n   const result = {\n     found: false,\n-    error: null as Error | null,\n+    error: null as unknown | null,\n   }\n   const existed = await fsp.access(filePath, fs.constants.F_OK).then(\n     () => true,\n@@ -445,7 +464,7 @@ export async function openFileInEditor(\n       launchEditor(filePath, line1, column1)\n       result.found = true\n     } catch (err) {\n-      result.error = err as Error\n+      result.error = err\n     }\n   }\n   return result"
        },
        {
            "sha": "a2366fec0489e0b2709eb1bc26177d4fd823482c",
            "filename": "packages/next/src/server/dev/middleware-turbopack.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/329bcdc7ae9f327c44a024eff2de6d46b36518b0/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/329bcdc7ae9f327c44a024eff2de6d46b36518b0/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts?ref=329bcdc7ae9f327c44a024eff2de6d46b36518b0",
            "patch": "@@ -370,25 +370,28 @@ export function getOverlayMiddleware({\n       let openEditorResult\n       if (isAppRelativePath) {\n         const relativeFilePath = searchParams.get('file') || ''\n-        const absoluteFilePath = path.join(\n-          projectPath,\n+        const appPath = path.join(\n           'app',\n           isSrcDir ? 'src' : '',\n           relativeFilePath\n         )\n-        openEditorResult = await openFileInEditor(absoluteFilePath, 1, 1)\n+        openEditorResult = await openFileInEditor(appPath, 1, 1, projectPath)\n       } else {\n         const frame = createStackFrame(searchParams)\n         if (!frame) return middlewareResponse.badRequest(res)\n         openEditorResult = await openFileInEditor(\n           frame.file,\n           frame.line ?? 1,\n-          frame.column ?? 1\n+          frame.column ?? 1,\n+          projectPath\n         )\n       }\n \n       if (openEditorResult.error) {\n-        return middlewareResponse.internalServerError(res)\n+        return middlewareResponse.internalServerError(\n+          res,\n+          openEditorResult.error\n+        )\n       }\n       if (!openEditorResult.found) {\n         return middlewareResponse.notFound(res)"
        },
        {
            "sha": "a4532002f21857c097eccf49caf159c4b46805bf",
            "filename": "packages/next/src/server/dev/middleware-webpack.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/329bcdc7ae9f327c44a024eff2de6d46b36518b0/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/329bcdc7ae9f327c44a024eff2de6d46b36518b0/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts?ref=329bcdc7ae9f327c44a024eff2de6d46b36518b0",
            "patch": "@@ -600,23 +600,21 @@ export function getOverlayMiddleware(options: {\n       const isAppRelativePath = searchParams.get('isAppRelativePath') === '1'\n       if (isAppRelativePath) {\n         const relativeFilePath = searchParams.get('file') || ''\n-        const absoluteFilePath = path.join(\n-          rootDirectory,\n+        const appPath = path.join(\n           'app',\n           isSrcDir ? 'src' : '',\n           relativeFilePath\n         )\n-        openEditorResult = await openFileInEditor(absoluteFilePath, 1, 1)\n+        openEditorResult = await openFileInEditor(appPath, 1, 1, rootDirectory)\n       } else {\n+        // TODO: How do we differentiate layers and actual file paths with round brackets?\n         // frame files may start with their webpack layer, like (middleware)/middleware.js\n-        const filePath = path.resolve(\n-          rootDirectory,\n-          frame.file.replace(/^\\([^)]+\\)\\//, '')\n-        )\n+        const filePath = frame.file.replace(/^\\([^)]+\\)\\//, '')\n         openEditorResult = await openFileInEditor(\n           filePath,\n           frame.line1,\n-          frame.column1 ?? 1\n+          frame.column1 ?? 1,\n+          rootDirectory\n         )\n       }\n       if (openEditorResult.error) {"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 39,
        "deletions": 19
    }
}