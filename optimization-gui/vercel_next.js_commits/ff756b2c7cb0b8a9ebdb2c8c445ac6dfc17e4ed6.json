{
    "author": "bgw",
    "message": "Turbopack: Define built-in webpack conditions using an enum and typescript union (#82765)\n\n## Context\n\nWe have some publicly documented syntax for configuring webpack loaders here: https://nextjs.org/docs/app/api-reference/config/next-config-js/turbopack#configuring-webpack-loaders\n\nHowever, we also have some undocumented features. Specifically, we have two different \"condition\" concepts, both of which are shown here: https://github.com/vercel/next.js/blob/1766a1aba6a7c92a03c08073114652d61da1a388/packages/next/src/build/swc/index.ts#L836-L860\n\n1. The `conditions` field in the `turbopack` object of the config can be used to specify predicates (defined by file name glob, regex, or content of file) that can be referenced by rules.\n2. There are special built-in internal \"conditions\" that can be matched by passing an object to a `rule` that does not contain a `loader` field. These special conditions allow us to match on some things we couldn't otherwise declare conditions for.\n\nThis is about improving the current state of #2, which I'm calling here to \"webpack loader built-in conditions\".\n\nConfusingly, there are also very similar conditions used by the resolver context. I'm not changing those, but I've done a tiny bit of work in this PR to better clarify the difference with naming and types.\n\n## This PR\n\n- Instead of using an `RcStr`, for these conditions, use an enum. Theoretically that gives us less flexibility, but it makes it way easier to discover, document, and keep track of what built-in conditions we support. I feel that it's very important that we do this because this enum is effectively a public API, and I'd like to document some version of this API in a subsequent PR.\n- Use the exact union of supported fields in the zod schema and typescript definitions.\n- Represent the collection of conditions as a set instead of a vec. In reality, this doesn't have much impact because the set is small and always constructed in the same order, but the intent is clearer. Implemented `TaskInput` for `BTreeSet`.\n- Some minor consistency cleanup between `next_server` and `next_client`.\n- Get rid of some extra type conversions using the `rcstr!()` macro.",
    "sha": "ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
    "files": [
        {
            "sha": "31db7ce19f762ef7e38480dc1cea5ce60fbac682",
            "filename": "crates/next-core/src/mode.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fmode.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fmode.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fmode.rs?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -1,6 +1,9 @@\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::TaskInput;\n use turbopack_ecmascript_runtime::RuntimeType;\n \n+use crate::next_shared::webpack_rules::WebpackLoaderBuiltinCondition;\n+\n /// The mode in which Next.js is running.\n #[turbo_tasks::value(shared)]\n #[derive(Debug, Copy, Clone, TaskInput, Ord, PartialOrd, Hash)]\n@@ -20,12 +23,23 @@ impl NextMode {\n         }\n     }\n \n-    /// Returns the exports condition for the current mode.\n-    pub fn condition(&self) -> &'static str {\n+    /// Returns conditions that can be used in the Next.js config's turbopack \"rules\" section for\n+    /// defining webpack loader configuration.\n+    pub fn webpack_loader_conditions(&self) -> impl Iterator<Item = WebpackLoaderBuiltinCondition> {\n         match self {\n-            NextMode::Development => \"development\",\n-            NextMode::Build => \"production\",\n+            NextMode::Development => [WebpackLoaderBuiltinCondition::Development],\n+            NextMode::Build => [WebpackLoaderBuiltinCondition::Production],\n+        }\n+        .into_iter()\n+    }\n+\n+    /// Returns conditions used by `ResolveOptionsContext`.\n+    pub fn custom_resolve_conditions(&self) -> impl Iterator<Item = RcStr> {\n+        match self {\n+            NextMode::Development => [rcstr!(\"development\")],\n+            NextMode::Build => [rcstr!(\"production\")],\n         }\n+        .into_iter()\n     }\n \n     /// Returns true if the development React runtime should be used."
        },
        {
            "sha": "badd2d6e3137b8c0bd99536a7bfe565f7260af4a",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 21,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -1,4 +1,4 @@\n-use std::iter::once;\n+use std::collections::BTreeSet;\n \n use anyhow::Result;\n use serde::{Deserialize, Serialize};\n@@ -58,7 +58,7 @@ use crate::{\n             styled_jsx::get_styled_jsx_transform_rule,\n             swc_ecma_transform_plugins::get_swc_ecma_transform_plugin_rule,\n         },\n-        webpack_rules::webpack_loader_options,\n+        webpack_rules::{WebpackLoaderBuiltinCondition, webpack_loader_options},\n     },\n     transform_options::{\n         get_decorators_transform_options, get_jsx_transform_options,\n@@ -150,7 +150,7 @@ pub async fn get_client_resolve_options_context(\n         get_next_client_resolved_map(project_path.clone(), project_path.clone(), *mode.await?)\n             .to_resolved()\n             .await?;\n-    let custom_conditions = vec![mode.await?.condition().into()];\n+    let custom_conditions = mode.await?.custom_resolve_conditions().collect();\n     let resolve_options_context = ResolveOptionsContext {\n         enable_node_modules: Some(project_path.root().owned().await?),\n         custom_conditions,\n@@ -238,26 +238,21 @@ pub async fn get_client_module_options_context(\n     .to_resolved()\n     .await?;\n \n-    // A separate webpack rules will be applied to codes matching\n-    // foreign_code_context_condition. This allows to import codes from\n-    // node_modules that requires webpack loaders, which next-dev implicitly\n-    // does by default.\n-    let conditions = vec![rcstr!(\"browser\"), mode.await?.condition().into()];\n-    let foreign_enable_webpack_loaders = webpack_loader_options(\n-        project_path.clone(),\n-        next_config,\n-        true,\n-        conditions\n-            .iter()\n-            .cloned()\n-            .chain(once(rcstr!(\"foreign\")))\n-            .collect(),\n-    )\n-    .await?;\n+    let mut loader_conditions = BTreeSet::new();\n+    loader_conditions.insert(WebpackLoaderBuiltinCondition::Browser);\n+    loader_conditions.extend(mode.await?.webpack_loader_conditions());\n+\n+    // A separate webpack rules will be applied to codes matching foreign_code_context_condition.\n+    // This allows to import codes from node_modules that requires webpack loaders, which next-dev\n+    // implicitly does by default.\n+    let mut foreign_conditions = loader_conditions.clone();\n+    foreign_conditions.insert(WebpackLoaderBuiltinCondition::Foreign);\n+    let foreign_enable_webpack_loaders =\n+        webpack_loader_options(project_path.clone(), next_config, true, foreign_conditions).await?;\n \n-    // Now creates a webpack rules that applies to all codes.\n+    // Now creates a webpack rules that applies to all code.\n     let enable_webpack_loaders =\n-        webpack_loader_options(project_path.clone(), next_config, false, conditions).await?;\n+        webpack_loader_options(project_path.clone(), next_config, false, loader_conditions).await?;\n \n     let tree_shaking_mode_for_user_code = *next_config\n         .tree_shaking_mode_for_user_code(next_mode.is_development())"
        },
        {
            "sha": "0ad1d8e4ecbca6e7d35b79bda457201037259699",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -1,3 +1,5 @@\n+use std::{collections::BTreeSet, str::FromStr};\n+\n use anyhow::{Context, Result, bail};\n use rustc_hash::FxHashSet;\n use serde::{Deserialize, Deserializer, Serialize};\n@@ -27,8 +29,11 @@ use turbopack_ecmascript_plugins::transform::{\n use turbopack_node::transforms::webpack::{WebpackLoaderItem, WebpackLoaderItems};\n \n use crate::{\n-    mode::NextMode, next_import_map::mdx_import_source_file,\n-    next_shared::transforms::ModularizeImportPackageConfig,\n+    mode::NextMode,\n+    next_import_map::mdx_import_source_file,\n+    next_shared::{\n+        transforms::ModularizeImportPackageConfig, webpack_rules::WebpackLoaderBuiltinCondition,\n+    },\n };\n \n #[turbo_tasks::value]\n@@ -1277,7 +1282,7 @@ impl NextConfig {\n     #[turbo_tasks::function]\n     pub async fn webpack_rules(\n         &self,\n-        active_conditions: Vec<RcStr>,\n+        active_conditions: BTreeSet<WebpackLoaderBuiltinCondition>,\n         project_path: FileSystemPath,\n     ) -> Result<Vc<OptionWebpackRules>> {\n         let Some(turbo_rules) = self.turbopack.as_ref().and_then(|t| t.rules.as_ref()) else {\n@@ -1286,7 +1291,6 @@ impl NextConfig {\n         if turbo_rules.is_empty() {\n             return Ok(Vc::cell(None));\n         }\n-        let active_conditions = active_conditions.into_iter().collect::<FxHashSet<_>>();\n         let mut rules = FxIndexMap::default();\n         for (ext, rule) in turbo_rules.iter() {\n             fn transform_loaders(loaders: &[LoaderItem]) -> ResolvedVc<WebpackLoaderItems> {\n@@ -1310,13 +1314,17 @@ impl NextConfig {\n             }\n             fn find_rule<'a>(\n                 rule: &'a RuleConfigItem,\n-                active_conditions: &FxHashSet<RcStr>,\n+                active_conditions: &BTreeSet<WebpackLoaderBuiltinCondition>,\n             ) -> FindRuleResult<'a> {\n                 match rule {\n                     RuleConfigItem::Options(rule) => FindRuleResult::Found(rule),\n                     RuleConfigItem::Conditional(map) => {\n                         for (condition, rule) in map.iter() {\n-                            if condition == \"default\" || active_conditions.contains(condition) {\n+                            let condition = WebpackLoaderBuiltinCondition::from_str(condition);\n+                            if let Ok(condition) = condition\n+                                && (condition == WebpackLoaderBuiltinCondition::Default\n+                                    || active_conditions.contains(&condition))\n+                            {\n                                 match find_rule(rule, active_conditions) {\n                                     FindRuleResult::Found(rule) => {\n                                         return FindRuleResult::Found(rule);"
        },
        {
            "sha": "beeaa389c358d5673bb23f7c7a17f076c6d5ac6b",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -147,14 +147,8 @@ pub async fn get_edge_resolve_options_context(\n     )];\n \n     // https://github.com/vercel/next.js/blob/bf52c254973d99fed9d71507a2e818af80b8ade7/packages/next/src/build/webpack-config.ts#L96-L102\n-    let mut custom_conditions = vec![mode.await?.condition().into()];\n-    custom_conditions.extend(\n-        NextRuntime::Edge\n-            .conditions()\n-            .iter()\n-            .map(ToString::to_string)\n-            .map(RcStr::from),\n-    );\n+    let mut custom_conditions: Vec<_> = mode.await?.custom_resolve_conditions().collect();\n+    custom_conditions.extend(NextRuntime::Edge.custom_resolve_conditions());\n \n     if ty.should_use_react_server_condition() {\n         custom_conditions.push(rcstr!(\"react-server\"));"
        },
        {
            "sha": "2c0a307b0d5149af5f2071165dfc605ce8153e13",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 35,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -1,4 +1,4 @@\n-use std::iter::once;\n+use std::collections::BTreeSet;\n \n use anyhow::{Result, bail};\n use serde::{Deserialize, Serialize};\n@@ -66,7 +66,7 @@ use crate::{\n             styled_jsx::get_styled_jsx_transform_rule,\n             swc_ecma_transform_plugins::get_swc_ecma_transform_plugin_rule,\n         },\n-        webpack_rules::webpack_loader_options,\n+        webpack_rules::{WebpackLoaderBuiltinCondition, webpack_loader_options},\n     },\n     transform_options::{\n         get_decorators_transform_options, get_jsx_transform_options,\n@@ -211,14 +211,8 @@ pub async fn get_server_resolve_options_context(\n     .to_resolved()\n     .await?;\n \n-    let mut custom_conditions = vec![mode.await?.condition().to_string().into()];\n-    custom_conditions.extend(\n-        NextRuntime::NodeJs\n-            .conditions()\n-            .iter()\n-            .map(ToString::to_string)\n-            .map(RcStr::from),\n-    );\n+    let mut custom_conditions: Vec<_> = mode.await?.custom_resolve_conditions().collect();\n+    custom_conditions.extend(NextRuntime::NodeJs.custom_resolve_conditions());\n \n     if ty.should_use_react_server_condition() {\n         custom_conditions.push(rcstr!(\"react-server\"));\n@@ -489,34 +483,21 @@ pub async fn get_server_module_options_context(\n     let enable_postcss_transform = Some(postcss_transform_options.resolved_cell());\n     let enable_foreign_postcss_transform = Some(postcss_foreign_transform_options.resolved_cell());\n \n-    let mut conditions = vec![mode.await?.condition().into()];\n-    conditions.extend(\n-        next_runtime\n-            .conditions()\n-            .iter()\n-            .map(ToString::to_string)\n-            .map(RcStr::from),\n-    );\n+    let mut loader_conditions = BTreeSet::new();\n+    loader_conditions.extend(mode.await?.webpack_loader_conditions());\n+    loader_conditions.extend(next_runtime.webpack_loader_conditions());\n \n-    // A separate webpack rules will be applied to codes matching\n-    // foreign_code_context_condition. This allows to import codes from\n-    // node_modules that requires webpack loaders, which next-dev implicitly\n-    // does by default.\n-    let foreign_enable_webpack_loaders = webpack_loader_options(\n-        project_path.clone(),\n-        next_config,\n-        true,\n-        conditions\n-            .iter()\n-            .cloned()\n-            .chain(once(rcstr!(\"foreign\")))\n-            .collect(),\n-    )\n-    .await?;\n+    // A separate webpack rules will be applied to codes matching foreign_code_context_condition.\n+    // This allows to import codes from node_modules that requires webpack loaders, which next-dev\n+    // implicitly does by default.\n+    let mut foreign_conditions = loader_conditions.clone();\n+    foreign_conditions.insert(WebpackLoaderBuiltinCondition::Foreign);\n+    let foreign_enable_webpack_loaders =\n+        webpack_loader_options(project_path.clone(), next_config, true, foreign_conditions).await?;\n \n-    // Now creates a webpack rules that applies to all codes.\n+    // Now creates a webpack rules that applies to all code.\n     let enable_webpack_loaders =\n-        webpack_loader_options(project_path.clone(), next_config, false, conditions).await?;\n+        webpack_loader_options(project_path.clone(), next_config, false, loader_conditions).await?;\n \n     let tree_shaking_mode_for_user_code = *next_config\n         .tree_shaking_mode_for_user_code(next_mode.is_development())"
        },
        {
            "sha": "2646114074c18bbefa3d4edc7edb964265e23e10",
            "filename": "crates/next-core/src/next_shared/webpack_rules/mod.rs",
            "status": "modified",
            "additions": 89,
            "deletions": 4,
            "changes": 93,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fwebpack_rules%2Fmod.rs?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -1,6 +1,9 @@\n+use std::{collections::BTreeSet, str::FromStr};\n+\n use anyhow::Result;\n-use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ResolvedVc, Vc};\n+use serde::{Deserialize, Serialize};\n+use turbo_rcstr::rcstr;\n+use turbo_tasks::{NonLocalValue, ResolvedVc, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::module_options::WebpackLoadersOptions;\n use turbopack_core::resolve::{ExternalTraced, ExternalType, options::ImportMapping};\n@@ -11,14 +14,96 @@ use crate::next_config::NextConfig;\n pub(crate) mod babel;\n pub(crate) mod sass;\n \n+/// Built-in conditions provided by the Next.js Turbopack integration for configuring webpack\n+/// loaders. These can be used in the `next.config.js` `turbopack.rules` section.\n+///\n+/// These are different from than the user-configurable \"conditions\" field.\n+//\n+// Note: If you add a field here, make sure to also add it in:\n+// - The typescript definition in `packages/next/src/server/config-shared.ts`\n+// - The zod schema in `packages/next/src/server/config-schema.ts`\n+//\n+// Note: Sets of conditions could be stored more efficiently as a bitset, but it's probably not used\n+// in enough places for it to matter.\n+#[derive(\n+    Copy,\n+    Clone,\n+    Debug,\n+    PartialEq,\n+    Eq,\n+    PartialOrd,\n+    Ord,\n+    Hash,\n+    Serialize,\n+    Deserialize,\n+    TaskInput,\n+    TraceRawVcs,\n+    NonLocalValue,\n+)]\n+pub enum WebpackLoaderBuiltinCondition {\n+    /// Treated as always-present.\n+    Default,\n+    /// Client-side code.\n+    Browser,\n+    /// Code in `node_modules` that should typically not be modified by webpack loaders.\n+    Foreign,\n+\n+    // These are provided by NextMode:\n+    Development,\n+    Production,\n+\n+    // These are provided by NextRuntime:\n+    /// Server code on the Node.js runtime.\n+    Node,\n+    /// Server code on the edge runtime.\n+    EdgeLight,\n+}\n+\n+impl WebpackLoaderBuiltinCondition {\n+    fn as_str(self) -> &'static str {\n+        match self {\n+            Self::Default => \"default\",\n+            Self::Browser => \"browser\",\n+            Self::Foreign => \"foreign\",\n+            Self::Development => \"development\",\n+            Self::Production => \"production\",\n+            Self::Node => \"node\",\n+            Self::EdgeLight => \"edge-light\",\n+        }\n+    }\n+}\n+\n+impl FromStr for WebpackLoaderBuiltinCondition {\n+    type Err = ();\n+\n+    fn from_str(s: &str) -> Result<Self, Self::Err> {\n+        match s {\n+            \"default\" => Ok(Self::Default),\n+            \"browser\" => Ok(Self::Browser),\n+            \"foreign\" => Ok(Self::Foreign),\n+            \"development\" => Ok(Self::Development),\n+            \"production\" => Ok(Self::Production),\n+            \"node\" => Ok(Self::Node),\n+            \"edge-light\" => Ok(Self::EdgeLight),\n+            _ => Err(()),\n+        }\n+    }\n+}\n+\n+impl PartialEq<WebpackLoaderBuiltinCondition> for &str {\n+    fn eq(&self, other: &WebpackLoaderBuiltinCondition) -> bool {\n+        *self == other.as_str()\n+    }\n+}\n+\n pub async fn webpack_loader_options(\n     project_path: FileSystemPath,\n     next_config: Vc<NextConfig>,\n     foreign: bool,\n-    condition_strs: Vec<RcStr>,\n+    loader_conditions: BTreeSet<WebpackLoaderBuiltinCondition>,\n ) -> Result<Option<ResolvedVc<WebpackLoadersOptions>>> {\n     let rules = *next_config\n-        .webpack_rules(condition_strs, project_path.clone())\n+        .webpack_rules(loader_conditions, project_path.clone())\n         .await?;\n     let rules = *maybe_add_sass_loader(next_config.sass_config(), rules.map(|v| *v)).await?;\n     let rules = if foreign {"
        },
        {
            "sha": "9cde5fefadfd15ace2d903e76c0b2f44b1f07be4",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -40,6 +40,7 @@ use crate::{\n     next_config::{NextConfig, RouteHas},\n     next_import_map::get_next_package,\n     next_manifests::MiddlewareMatcher,\n+    next_shared::webpack_rules::WebpackLoaderBuiltinCondition,\n };\n \n const NEXT_TEMPLATE_PATH: &str = \"dist/esm/build/templates\";\n@@ -228,11 +229,23 @@ pub enum NextRuntime {\n }\n \n impl NextRuntime {\n-    pub fn conditions(&self) -> &'static [&'static str] {\n+    /// Returns conditions that can be used in the Next.js config's turbopack \"rules\" section for\n+    /// defining webpack loader configuration.\n+    pub fn webpack_loader_conditions(&self) -> impl Iterator<Item = WebpackLoaderBuiltinCondition> {\n         match self {\n-            NextRuntime::NodeJs => &[\"node\"],\n-            NextRuntime::Edge => &[\"edge-light\"],\n+            NextRuntime::NodeJs => [WebpackLoaderBuiltinCondition::Node],\n+            NextRuntime::Edge => [WebpackLoaderBuiltinCondition::EdgeLight],\n         }\n+        .into_iter()\n+    }\n+\n+    /// Returns conditions used by `ResolveOptionsContext`.\n+    pub fn custom_resolve_conditions(&self) -> impl Iterator<Item = RcStr> {\n+        match self {\n+            NextRuntime::NodeJs => [rcstr!(\"node\")],\n+            NextRuntime::Edge => [rcstr!(\"edge-light\")],\n+        }\n+        .into_iter()\n     }\n }\n "
        },
        {
            "sha": "d12f7da360d9f055bab46ad65302d57ee9fef6a0",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 5,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -879,7 +879,7 @@ function bindingToApi(\n     nextConfigSerializable.exportPathMap = {}\n     nextConfigSerializable.webpack = nextConfig.webpack && {}\n \n-    if (nextConfigSerializable.experimental?.turbo?.rules) {\n+    if (nextConfigSerializable.turbopack?.rules) {\n       ensureLoadersHaveSerializableOptions(\n         nextConfigSerializable.turbopack?.rules\n       )\n@@ -974,10 +974,9 @@ function bindingToApi(\n       if ('loaders' in rule) {\n         checkLoaderItems((rule as TurbopackRuleConfigItemOptions).loaders, glob)\n       } else {\n-        for (const key in rule) {\n-          const inner = rule[key]\n-          if (typeof inner === 'object' && inner) {\n-            checkConfigItem(inner, glob)\n+        for (const value of Object.values(rule)) {\n+          if (typeof value === 'object' && value) {\n+            checkConfigItem(value, glob)\n           }\n         }\n       }"
        },
        {
            "sha": "cf06b0512e77b4b2e76da5e40e66a878020ae4c0",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 14,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -14,6 +14,7 @@ import type {\n   TurbopackRuleConfigItemOptions,\n   TurbopackRuleConfigItemOrShortcut,\n   TurbopackRuleCondition,\n+  TurbopackLoaderBuiltinCondition,\n } from './config-shared'\n import type {\n   Header,\n@@ -102,7 +103,7 @@ const zHeader: zod.ZodType<Header> = z.object({\n   internal: z.boolean().optional(),\n })\n \n-const zTurboLoaderItem: zod.ZodType<TurbopackLoaderItem> = z.union([\n+const zTurbopackLoaderItem: zod.ZodType<TurbopackLoaderItem> = z.union([\n   z.string(),\n   z.object({\n     loader: z.string(),\n@@ -111,31 +112,42 @@ const zTurboLoaderItem: zod.ZodType<TurbopackLoaderItem> = z.union([\n   }),\n ])\n \n-const zTurboRuleConfigItemOptions: zod.ZodType<TurbopackRuleConfigItemOptions> =\n+const zTurbopackRuleConfigItemOptions: zod.ZodType<TurbopackRuleConfigItemOptions> =\n   z.object({\n-    loaders: z.array(zTurboLoaderItem),\n+    loaders: z.array(zTurbopackLoaderItem),\n     as: z.string().optional(),\n   })\n \n-const zTurboRuleConfigItem: zod.ZodType<TurbopackRuleConfigItem> = z.union([\n+const zTurbopackLoaderBuiltinCondition: zod.ZodType<TurbopackLoaderBuiltinCondition> =\n+  z.union([\n+    z.literal('default'),\n+    z.literal('browser'),\n+    z.literal('foreign'),\n+    z.literal('development'),\n+    z.literal('production'),\n+    z.literal('node'),\n+    z.literal('edge-light'),\n+  ])\n+\n+const zTurbopackRuleConfigItem: zod.ZodType<TurbopackRuleConfigItem> = z.union([\n   z.literal(false),\n   z.record(\n-    z.string(),\n-    z.lazy(() => zTurboRuleConfigItem)\n+    zTurbopackLoaderBuiltinCondition,\n+    z.lazy(() => zTurbopackRuleConfigItem)\n   ),\n-  zTurboRuleConfigItemOptions,\n+  zTurbopackRuleConfigItemOptions,\n ])\n-const zTurboRuleConfigItemOrShortcut: zod.ZodType<TurbopackRuleConfigItemOrShortcut> =\n-  z.union([z.array(zTurboLoaderItem), zTurboRuleConfigItem])\n+const zTurbopackRuleConfigItemOrShortcut: zod.ZodType<TurbopackRuleConfigItemOrShortcut> =\n+  z.union([z.array(zTurbopackLoaderItem), zTurbopackRuleConfigItem])\n \n-const zTurboCondition: zod.ZodType<TurbopackRuleCondition> = z.object({\n+const zTurbopackCondition: zod.ZodType<TurbopackRuleCondition> = z.object({\n   path: z.union([z.string(), z.instanceof(RegExp)]).optional(),\n   content: z.instanceof(RegExp).optional(),\n })\n \n const zTurbopackConfig: zod.ZodType<TurbopackOptions> = z.strictObject({\n-  rules: z.record(z.string(), zTurboRuleConfigItemOrShortcut).optional(),\n-  conditions: z.record(z.string(), zTurboCondition).optional(),\n+  rules: z.record(z.string(), zTurbopackRuleConfigItemOrShortcut).optional(),\n+  conditions: z.record(z.string(), zTurbopackCondition).optional(),\n   resolveAlias: z\n     .record(\n       z.string(),\n@@ -155,8 +167,8 @@ const zTurbopackConfig: zod.ZodType<TurbopackOptions> = z.strictObject({\n // properties are duplicated here as `ZodType`s do not export `extend()`.\n const zDeprecatedExperimentalTurboConfig: zod.ZodType<DeprecatedExperimentalTurboOptions> =\n   z.strictObject({\n-    loaders: z.record(z.string(), z.array(zTurboLoaderItem)).optional(),\n-    rules: z.record(z.string(), zTurboRuleConfigItemOrShortcut).optional(),\n+    loaders: z.record(z.string(), z.array(zTurbopackLoaderItem)).optional(),\n+    rules: z.record(z.string(), zTurbopackRuleConfigItemOrShortcut).optional(),\n     resolveAlias: z\n       .record(\n         z.string(),"
        },
        {
            "sha": "42baaa7f1d85d9c88bd7d732893a06f51d54cfbc",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -261,6 +261,15 @@ export type TurbopackLoaderItem =\n       options: Record<string, JSONValue>\n     }\n \n+export type TurbopackLoaderBuiltinCondition =\n+  | 'default'\n+  | 'browser'\n+  | 'foreign'\n+  | 'development'\n+  | 'production'\n+  | 'node'\n+  | 'edge-light'\n+\n export type TurbopackRuleCondition = {\n   path?: string | RegExp\n   content?: RegExp\n@@ -277,7 +286,7 @@ export type TurbopackRuleConfigItemOptions = {\n \n export type TurbopackRuleConfigItem =\n   | TurbopackRuleConfigItemOptions\n-  | { [condition: string]: TurbopackRuleConfigItem }\n+  | { [condition in TurbopackLoaderBuiltinCondition]?: TurbopackRuleConfigItem }\n   | false\n \n export interface TurbopackOptions {"
        },
        {
            "sha": "848d4b5e6edb81ac81b8cac767e957b0c41e3f2d",
            "filename": "turbopack/crates/turbo-tasks/src/task/task_input.rs",
            "status": "modified",
            "additions": 29,
            "deletions": 2,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ftask_input.rs?ref=ff756b2c7cb0b8a9ebdb2c8c445ac6dfc17e4ed6",
            "patch": "@@ -1,5 +1,10 @@\n use std::{\n-    collections::BTreeMap, fmt::Debug, future::Future, hash::Hash, sync::Arc, time::Duration,\n+    collections::{BTreeMap, BTreeSet},\n+    fmt::Debug,\n+    future::Future,\n+    hash::Hash,\n+    sync::Arc,\n+    time::Duration,\n };\n \n use anyhow::Result;\n@@ -278,14 +283,36 @@ where\n \n     fn is_resolved(&self) -> bool {\n         self.iter()\n-            .all(|(k, v)| TaskInput::is_resolved(k) || TaskInput::is_resolved(v))\n+            .all(|(k, v)| TaskInput::is_resolved(k) && TaskInput::is_resolved(v))\n     }\n \n     fn is_transient(&self) -> bool {\n         self.iter()\n             .any(|(k, v)| TaskInput::is_transient(k) || TaskInput::is_transient(v))\n     }\n }\n+\n+impl<T> TaskInput for BTreeSet<T>\n+where\n+    T: TaskInput + Ord,\n+{\n+    async fn resolve_input(&self) -> Result<Self> {\n+        let mut new_map = BTreeSet::new();\n+        for value in self {\n+            new_map.insert(TaskInput::resolve_input(value).await?);\n+        }\n+        Ok(new_map)\n+    }\n+\n+    fn is_resolved(&self) -> bool {\n+        self.iter().all(TaskInput::is_resolved)\n+    }\n+\n+    fn is_transient(&self) -> bool {\n+        self.iter().any(TaskInput::is_transient)\n+    }\n+}\n+\n macro_rules! tuple_impls {\n     ( $( $name:ident )+ ) => {\n         impl<$($name: TaskInput),+> TaskInput for ($($name,)+)"
        }
    ],
    "stats": {
        "total": 343,
        "additions": 240,
        "deletions": 103
    }
}