{
    "author": "bgw",
    "message": "chore(CI): Line-wrap afterBuild blocks in build_and_test.yml (#78718)\n\nAs part of #76251 I rewrote the `afterBuild` job from:\n\n```yaml\n- run: /bin/bash -c \"${{ inputs.afterBuild }}\"\n```\n\nto\n\n```yaml\n- run: ${{ inputs.afterBuild }}\n  # defaults.run.shell sets a stronger options (`-leo pipefail`)\n  # Set this back to github action's weaker defaults:\n  # https://docs.github.com/en/actions/writing-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsshell\n  #\n  # We must use a login shell: fnm installation may modify the `.profile`\n  shell: bash -le {0}\n```\n\nSo it should handle escaping and line wrapping without problems now. Because we run `bash` with `-e`, failed commands should abort the entire script, so `&&` shouldn't be needed everywhere.",
    "sha": "e87bb28ca697c56525f27a82242739a37c787f81",
    "files": [
        {
            "sha": "aef16adf3d274de0493c292271bac8fd54f04d27",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 167,
            "deletions": 24,
            "changes": 191,
            "blob_url": "https://github.com/vercel/next.js/blob/e87bb28ca697c56525f27a82242739a37c787f81/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/e87bb28ca697c56525f27a82242739a37c787f81/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=e87bb28ca697c56525f27a82242739a37c787f81",
            "patch": "@@ -100,7 +100,10 @@ jobs:\n     needs: ['build-next']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: pnpm lint-no-typescript && pnpm check-examples && pnpm validate-externals-doc\n+      afterBuild: |\n+        pnpm lint-no-typescript\n+        pnpm check-examples\n+        pnpm validate-externals-doc\n       stepName: 'lint'\n     secrets: inherit\n \n@@ -210,7 +213,12 @@ jobs:\n           - '--scenario=heavy-npm-deps-build-turbo-cache-enabled --page=homepage'\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: pnpm install && ./node_modules/.bin/devlow-bench ./scripts/devlow-bench.mjs --datadog=ubuntu-latest-16-core ${{ matrix.mode }} ${{ matrix.selector }}\n+      afterBuild: |\n+        pnpm install\n+        ./node_modules/.bin/devlow-bench ./scripts/devlow-bench.mjs \\\n+          --datadog=ubuntu-latest-16-core \\\n+          ${{ matrix.mode }} \\\n+          ${{ matrix.selector }}\n       stepName: 'devlow-bench-${{ matrix.mode }}-${{ matrix.selector }}'\n     secrets: inherit\n \n@@ -221,7 +229,9 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       stepName: 'test-devlow'\n-      afterBuild: pnpm install && pnpm run --filter=devlow-bench test\n+      afterBuild: |\n+        pnpm install\n+        pnpm run --filter=devlow-bench test\n     secrets: inherit\n \n   test-turbopack-dev:\n@@ -240,7 +250,19 @@ jobs:\n         react: ['', '18.3.1']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: RUST_BACKTRACE=0 NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/turbopack-dev-tests-manifest.json\" IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1  NEXT_E2E_TEST_TIMEOUT=240000 NEXT_TEST_MODE=dev NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\" node run-tests.js --test-pattern '^(test\\/(development|e2e))/.*\\.test\\.(js|jsx|ts|tsx)$' --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY}\n+      afterBuild: |\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/turbopack-dev-tests-manifest.json\"\n+        export IS_TURBOPACK_TEST=1\n+        export TURBOPACK_DEV=1\n+        export NEXT_E2E_TEST_TIMEOUT=240000\n+        export NEXT_TEST_MODE=dev\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+\n+        node run-tests.js \\\n+          --test-pattern '^(test\\/(development|e2e))/.*\\.test\\.(js|jsx|ts|tsx)$' \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          -c $TEST_CONCURRENCY\n       stepName: 'test-turbopack-dev-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -262,7 +284,17 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 18.18.2\n-      afterBuild: RUST_BACKTRACE=0 NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/turbopack-dev-tests-manifest.json\" IS_TURBOPACK_TEST=1 TURBOPACK_DEV=1 NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\" node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type integration\n+      afterBuild: |\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/turbopack-dev-tests-manifest.json\"\n+        export IS_TURBOPACK_TEST=1\n+        export TURBOPACK_DEV=1\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          -c $TEST_CONCURRENCY \\\n+          --type integration\n       stepName: 'test-turbopack-integration-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -287,7 +319,14 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 18.18.2\n-      afterBuild: RUST_BACKTRACE=0 NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/turbopack-build-tests-manifest.json\" IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 NEXT_TEST_MODE=start NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\" node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type production\n+      afterBuild: |\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/turbopack-build-tests-manifest.json\"\n+        export IS_TURBOPACK_TEST=1\n+        export TURBOPACK_BUILD=1\n+        export NEXT_TEST_MODE=start\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+\n+        node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type production\n       stepName: 'test-turbopack-production-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -303,7 +342,16 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 18.18.2\n-      afterBuild: RUST_BACKTRACE=0 NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/turbopack-build-tests-manifest.json\" IS_TURBOPACK_TEST=1 TURBOPACK_BUILD=1 node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type integration\n+      afterBuild: |\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"$(pwd)/test/turbopack-build-tests-manifest.json\"\n+        export IS_TURBOPACK_TEST=1\n+        export TURBOPACK_BUILD=1\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          -c ${TEST_CONCURRENCY} \\\n+          --type integration\n       stepName: 'test-turbopack-production-integration-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -314,7 +362,20 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: rustup target add wasm32-unknown-unknown && curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh && node ./scripts/normalize-version-bump.js && pnpm dlx turbo@${TURBO_VERSION} run build-wasm -- --target nodejs && git checkout . && mv crates/wasm/pkg crates/wasm/pkg-nodejs && node ./scripts/setup-wasm.mjs && NEXT_TEST_MODE=start TEST_WASM=true node run-tests.js test/production/pages-dir/production/test/index.test.ts test/e2e/streaming-ssr/index.test.ts\n+      afterBuild: |\n+        rustup target add wasm32-unknown-unknown\n+        curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh\n+        node ./scripts/normalize-version-bump.js\n+        pnpm dlx turbo@${TURBO_VERSION} run build-wasm -- --target nodejs\n+        git checkout .\n+        mv crates/wasm/pkg crates/wasm/pkg-nodejs\n+        node ./scripts/setup-wasm.mjs\n+\n+        export NEXT_TEST_MODE=start\n+        export TEST_WASM=true\n+        node run-tests.js \\\n+          test/production/pages-dir/production/test/index.test.ts \\\n+          test/e2e/streaming-ssr/index.test.ts\n       stepName: 'test-next-swc-wasm'\n     secrets: inherit\n \n@@ -330,7 +391,9 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: rustup target add wasm32-wasip1-threads && pnpm dlx turbo@${TURBO_VERSION} run build-native-wasi\n+      afterBuild: |\n+        rustup target add wasm32-wasip1-threads\n+        pnpm dlx turbo@${TURBO_VERSION} run build-native-wasi\n       stepName: 'test-next-swc-napi-wasi'\n     secrets: inherit\n \n@@ -384,7 +447,11 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: node scripts/test-new-tests.mjs --flake-detection --mode dev --group ${{ matrix.group }}\n+      afterBuild: |\n+        node scripts/test-new-tests.mjs \\\n+          --flake-detection \\\n+          --mode dev \\\n+          --group ${{ matrix.group }}\n       stepName: 'test-new-tests-dev-${{matrix.group}}'\n       timeout_minutes: 60 # Increase the default timeout as tests are intentionally run multiple times to detect flakes\n \n@@ -402,7 +469,11 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: node scripts/test-new-tests.mjs --flake-detection --mode start --group ${{ matrix.group }}\n+      afterBuild: |\n+        node scripts/test-new-tests.mjs \\\n+          --flake-detection \\\n+          --mode start \\\n+          --group ${{ matrix.group }}\n       stepName: 'test-new-tests-start-${{matrix.group}}'\n       timeout_minutes: 60 # Increase the default timeout as tests are intentionally run multiple times to detect flakes\n \n@@ -421,7 +492,12 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: NEXT_E2E_TEST_TIMEOUT=240000 node scripts/test-new-tests.mjs --mode deploy --group ${{ matrix.group }}\n+      afterBuild: |\n+        export NEXT_E2E_TEST_TIMEOUT=240000\n+\n+        node scripts/test-new-tests.mjs \\\n+          --mode deploy \\\n+          --group ${{ matrix.group }}\n       stepName: 'test-new-tests-deploy-${{matrix.group}}'\n \n     secrets: inherit\n@@ -442,7 +518,15 @@ jobs:\n         react: ['', '18.3.1']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: NEXT_TEST_MODE=dev NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\" node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type development\n+      afterBuild: |\n+        export NEXT_TEST_MODE=dev\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          -c ${TEST_CONCURRENCY} \\\n+          --type development\n       stepName: 'test-dev-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -460,7 +544,13 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: NEXT_TEST_MODE=dev node run-tests.js -c ${TEST_CONCURRENCY} test/e2e/app-dir/app/index.test.ts test/e2e/app-dir/app-edge/app-edge.test.ts\n+      afterBuild: |\n+        export NEXT_TEST_MODE=dev\n+\n+        node run-tests.js \\\n+          -c ${TEST_CONCURRENCY} \\\n+          test/e2e/app-dir/app/index.test.ts \\\n+          test/e2e/app-dir/app-edge/app-edge.test.ts\n       stepName: 'test-dev-windows'\n       runs_on_labels: '[\"windows\",\"self-hosted\",\"x64\"]'\n       buildNativeTarget: 'x86_64-pc-windows-msvc'\n@@ -481,7 +571,14 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 18.18.2\n-      afterBuild: node run-tests.js -c 4 test/production/pages-dir/production/test/index.test.ts test/integration/css-client-nav/test/index.test.js test/integration/rewrites-has-condition/test/index.test.js test/integration/create-next-app/index.test.ts test/integration/create-next-app/package-manager/pnpm.test.ts\n+      afterBuild: |\n+        node run-tests.js \\\n+          -c 4 \\\n+          test/production/pages-dir/production/test/index.test.ts \\\n+          test/integration/css-client-nav/test/index.test.js \\\n+          test/integration/rewrites-has-condition/test/index.test.js \\\n+          test/integration/create-next-app/index.test.ts \\\n+          test/integration/create-next-app/package-manager/pnpm.test.ts\n       stepName: 'test-integration-windows'\n       runs_on_labels: '[\"windows\",\"self-hosted\",\"x64\"]'\n       buildNativeTarget: 'x86_64-pc-windows-msvc'\n@@ -501,7 +598,13 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: NEXT_TEST_MODE=start node run-tests.js test/e2e/app-dir/app/index.test.ts test/e2e/app-dir/app-edge/app-edge.test.ts test/e2e/app-dir/metadata-edge/index.test.ts\n+      afterBuild: |\n+        export NEXT_TEST_MODE=start\n+\n+        node run-tests.js \\\n+          test/e2e/app-dir/app/index.test.ts \\\n+          test/e2e/app-dir/app-edge/app-edge.test.ts \\\n+          test/e2e/app-dir/metadata-edge/index.test.ts\n       stepName: 'test-prod-windows'\n       runs_on_labels: '[\"windows\",\"self-hosted\",\"x64\"]'\n       buildNativeTarget: 'x86_64-pc-windows-msvc'\n@@ -558,7 +661,14 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 18.18.2\n-      afterBuild: NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\" node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type integration\n+      afterBuild: |\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          -c ${TEST_CONCURRENCY} \\\n+          --type integration\n       stepName: 'test-integration-${{ matrix.group }}-react-${{ matrix.react }}'\n     secrets: inherit\n \n@@ -569,11 +679,19 @@ jobs:\n \n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: pnpm playwright install &&\n-        BROWSER_NAME=firefox node run-tests.js test/production/pages-dir/production/test/index.test.ts &&\n-        NEXT_TEST_MODE=start BROWSER_NAME=safari node run-tests.js -c 1 test/production/pages-dir/production/test/index.test.ts test/e2e/basepath/basepath.test.ts &&\n-        BROWSER_NAME=safari DEVICE_NAME='iPhone XR' node run-tests.js -c 1 test/production/prerender-prefetch/index.test.ts\n+      afterBuild: |\n+        pnpm playwright install\n+\n+        # these all run without concurrency (`-c 1`) because they're heavier\n+        BROWSER_NAME=firefox node run-tests.js -c 1 \\\n+          test/production/pages-dir/production/test/index.test.ts\n+\n+        NEXT_TEST_MODE=start BROWSER_NAME=safari node run-tests.js -c 1 \\\n+          test/production/pages-dir/production/test/index.test.ts \\\n+          test/e2e/basepath/basepath.test.ts\n \n+        BROWSER_NAME=safari DEVICE_NAME='iPhone XR' node run-tests.js -c 1 \\\n+          test/production/prerender-prefetch/index.test.ts\n       stepName: 'test-firefox-safari'\n     secrets: inherit\n \n@@ -587,7 +705,14 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: 18.18.2\n-      afterBuild: __NEXT_EXPERIMENTAL_PPR=true NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\" node run-tests.js --timings -c ${TEST_CONCURRENCY} --type integration\n+      afterBuild: |\n+        export __NEXT_EXPERIMENTAL_PPR=true\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -c ${TEST_CONCURRENCY} \\\n+          --type integration\n       stepName: 'test-ppr-integration'\n     secrets: inherit\n \n@@ -602,7 +727,16 @@ jobs:\n         group: [1/6, 2/6, 3/6, 4/6, 5/6, 6/6]\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: __NEXT_EXPERIMENTAL_PPR=true NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\" NEXT_TEST_MODE=dev node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type development\n+      afterBuild: |\n+        export __NEXT_EXPERIMENTAL_PPR=true\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n+        export NEXT_TEST_MODE=dev\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          -c ${TEST_CONCURRENCY} \\\n+          --type development\n       stepName: 'test-ppr-dev-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -617,7 +751,16 @@ jobs:\n         group: [1/7, 2/7, 3/7, 4/7, 5/7, 6/7, 7/7]\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: __NEXT_EXPERIMENTAL_PPR=true NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\" NEXT_TEST_MODE=start node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type production\n+      afterBuild: |\n+        export __NEXT_EXPERIMENTAL_PPR=true\n+        export NEXT_EXTERNAL_TESTS_FILTERS=\"test/ppr-tests-manifest.json\"\n+        export NEXT_TEST_MODE=start\n+\n+        node run-tests.js \\\n+          --timings \\\n+          -g ${{ matrix.group }} \\\n+          -c ${TEST_CONCURRENCY} \\\n+          --type production\n       stepName: 'test-ppr-prod-${{ matrix.group }}'\n     secrets: inherit\n "
        }
    ],
    "stats": {
        "total": 191,
        "additions": 167,
        "deletions": 24
    }
}