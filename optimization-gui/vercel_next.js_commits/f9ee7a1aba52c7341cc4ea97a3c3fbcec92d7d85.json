{
    "author": "gaojude",
    "message": "Feat: `get_errors` MCP endpoint (#84161)\n\nEnables AI agents to programmatically access the runtime/build errors\nfrom the current devtool overlay of a dev session. The errors are\npretty-printed by default with source-mapped stack frames. In\nparticular, it supports pulling error information from multiple browser\ntabs.",
    "sha": "f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
    "files": [
        {
            "sha": "e874786a2df2f2617c6394e4d3197c877ad62a43",
            "filename": ".eslintignore",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/.eslintignore",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/.eslintignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.eslintignore?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -43,6 +43,7 @@ bench/heavy-npm-deps/**\n packages/next-bundle-analyzer/index.d.ts\n examples/with-typescript-graphql/lib/gql/\n test/development/basic/hmr/components/parse-error.js\n+test/development/mcp-server/fixtures/default-template/app/build-error/page.tsx\n packages/next-swc/docs/assets/**/*\n test/lib/amp-validator-wasm.js\n test/production/pages-dir/production/fixture/amp-validator-wasm.js"
        },
        {
            "sha": "9f253552656ee7df9046d7cb237057728dc76f3b",
            "filename": ".prettierignore",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/.prettierignore",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/.prettierignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.prettierignore?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -55,6 +55,7 @@ test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/ignored.js\n test/e2e/app-dir/server-source-maps/fixtures/default/internal-pkg/sourcemapped.js\n test/e2e/app-dir/server-source-maps/fixtures/default/external-pkg/sourcemapped.js\n test/e2e/async-modules/amp-validator-wasm.js\n+test/development/mcp-server/fixtures/default-template/app/build-error/page.tsx\n \n # turbopack crates, disable for some tests and precompiled dependencies.\n /turbopack/crates/*/js/src/compiled"
        },
        {
            "sha": "b66d30cc21dc34f36b5ab1d1f6d4feb1910a6379",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -819,5 +819,8 @@\n   \"818\": \"`cacheLife()` can only be called inside a \\\"use cache\\\" function.\",\n   \"819\": \"`cacheTag()` can only be called inside a \\\"use cache\\\" function.\",\n   \"820\": \"`cacheLife()` can only be called during App Router rendering at the moment.\",\n-  \"821\": \"Unprocessable request\"\n+  \"821\": \"Unprocessable request\",\n+  \"822\": \"Stack frame resolver not initialized. This is a bug in Next.js.\",\n+  \"823\": \"Timeout waiting for error state from frontend. The browser may not be responding to HMR messages.\",\n+  \"824\": \"URL is required in MCP error state response. This is a bug in Next.js.\"\n }"
        },
        {
            "sha": "6513eb4701f130a48412eb82035546de55ecef8c",
            "filename": "packages/next/src/client/dev/hot-reloader/app/hot-reloader-app.tsx",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fapp%2Fhot-reloader-app.tsx?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -8,17 +8,24 @@ import {\n   REACT_REFRESH_FULL_RELOAD,\n   REACT_REFRESH_FULL_RELOAD_FROM_ERROR,\n } from '../shared'\n-import { dispatcher } from 'next/dist/compiled/next-devtools'\n+import {\n+  dispatcher,\n+  getSerializedOverlayState,\n+} from 'next/dist/compiled/next-devtools'\n import { ReplaySsrOnlyErrors } from '../../../../next-devtools/userspace/app/errors/replay-ssr-only-errors'\n import { AppDevOverlayErrorBoundary } from '../../../../next-devtools/userspace/app/app-dev-overlay-error-boundary'\n import { useErrorHandler } from '../../../../next-devtools/userspace/app/errors/use-error-handler'\n import { RuntimeErrorHandler } from '../../runtime-error-handler'\n import { useWebSocketPing } from './web-socket'\n-import { HMR_MESSAGE_SENT_TO_BROWSER } from '../../../../server/dev/hot-reloader-types'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  HMR_MESSAGE_SENT_TO_SERVER,\n+} from '../../../../server/dev/hot-reloader-types'\n import type {\n   HmrMessageSentToBrowser,\n   TurbopackMessageSentToBrowser,\n } from '../../../../server/dev/hot-reloader-types'\n+import type { McpErrorStateResponse } from '../../../../shared/lib/mcp-error-types'\n import { useUntrackedPathname } from '../../../components/navigation-untracked'\n import reportHmrLatency from '../../report-hmr-latency'\n import { TurbopackHmr } from '../turbopack-hot-reloader-common'\n@@ -469,6 +476,17 @@ export function processMessage(\n \n       return\n     }\n+    case HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_CURRENT_ERROR_STATE: {\n+      const errorState = getSerializedOverlayState()\n+      const response: McpErrorStateResponse = {\n+        event: HMR_MESSAGE_SENT_TO_SERVER.MCP_ERROR_STATE_RESPONSE,\n+        requestId: message.requestId,\n+        errorState,\n+        url: window.location.href,\n+      }\n+      sendMessage(JSON.stringify(response))\n+      return\n+    }\n     case HMR_MESSAGE_SENT_TO_BROWSER.MIDDLEWARE_CHANGES:\n     case HMR_MESSAGE_SENT_TO_BROWSER.CLIENT_CHANGES:\n     case HMR_MESSAGE_SENT_TO_BROWSER.SERVER_ONLY_CHANGES:"
        },
        {
            "sha": "8ffd72acc57d86053a27858712750cfbf94674bf",
            "filename": "packages/next/src/client/dev/hot-reloader/pages/hot-reloader-pages.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 2,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fdev%2Fhot-reloader%2Fpages%2Fhot-reloader-pages.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -32,12 +32,18 @@\n \n /// <reference types=\"webpack/module.d.ts\" />\n \n-import { dispatcher } from 'next/dist/compiled/next-devtools'\n+import {\n+  dispatcher,\n+  getSerializedOverlayState,\n+} from 'next/dist/compiled/next-devtools'\n import { register } from '../../../../next-devtools/userspace/pages/pages-dev-overlay-setup'\n import stripAnsi from 'next/dist/compiled/strip-ansi'\n import { addMessageListener, sendMessage } from './websocket'\n import formatWebpackMessages from '../../../../shared/lib/format-webpack-messages'\n-import { HMR_MESSAGE_SENT_TO_BROWSER } from '../../../../server/dev/hot-reloader-types'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  HMR_MESSAGE_SENT_TO_SERVER,\n+} from '../../../../server/dev/hot-reloader-types'\n import type {\n   AddedPageMessage,\n   DevPagesManifestUpdateMessage,\n@@ -393,6 +399,17 @@ function processMessage(message: HmrMessageSentToBrowser) {\n     case HMR_MESSAGE_SENT_TO_BROWSER.SERVER_ONLY_CHANGES:\n       // These action types are handled in src/client/page-bootstrap.ts\n       break\n+    case HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_CURRENT_ERROR_STATE: {\n+      const errorState = getSerializedOverlayState()\n+      const response = {\n+        event: HMR_MESSAGE_SENT_TO_SERVER.MCP_ERROR_STATE_RESPONSE,\n+        requestId: message.requestId,\n+        errorState,\n+        url: window.location.href,\n+      }\n+      sendMessage(JSON.stringify(response))\n+      break\n+    }\n     default:\n       message satisfies never\n   }"
        },
        {
            "sha": "9ec12bb408db8030b2bcdcd1a6d7c1911559832c",
            "filename": "packages/next/src/client/page-bootstrap.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fpage-bootstrap.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -121,6 +121,7 @@ export function pageBootstrap(assetPrefix: string) {\n         case HMR_MESSAGE_SENT_TO_BROWSER.ISR_MANIFEST:\n         case HMR_MESSAGE_SENT_TO_BROWSER.DEVTOOLS_CONFIG:\n         case HMR_MESSAGE_SENT_TO_BROWSER.REACT_DEBUG_CHUNK:\n+        case HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_CURRENT_ERROR_STATE:\n           // Most of these action types are handled in\n           // src/client/dev/hot-reloader/pages/hot-reloader-pages.ts and\n           // src/client/dev/hot-reloader/app/hot-reloader-app.tsx"
        },
        {
            "sha": "862477d2dae83720d1719e3536c864a938d6578d",
            "filename": "packages/next/src/next-devtools/dev-overlay.browser.tsx",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay.browser.tsx?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -27,6 +27,7 @@ import {\n   createContext,\n   startTransition,\n   useContext,\n+  useEffect,\n   useInsertionEffect,\n   useLayoutEffect,\n   type ActionDispatch,\n@@ -73,6 +74,35 @@ type Dispatch = ReturnType<typeof useErrorOverlayReducer>[1]\n let maybeDispatch: Dispatch | null = null\n const queue: Array<(dispatch: Dispatch) => void> = []\n \n+// Global state store for accessing current overlay state from outside React context\n+type OverlayStateWithRouter = OverlayState & { routerType: 'pages' | 'app' }\n+\n+let currentOverlayState: OverlayStateWithRouter | null = null\n+\n+export function getCurrentOverlayState(): OverlayStateWithRouter | null {\n+  return currentOverlayState\n+}\n+\n+export function getSerializedOverlayState(): OverlayStateWithRouter | null {\n+  // Serialize error objects properly since Error properties are non-enumerable\n+  // This is used when sending state via HMR/JSON.stringify\n+  if (!currentOverlayState) return null\n+\n+  return {\n+    ...currentOverlayState,\n+    errors: currentOverlayState.errors.map((errorEvent: any) => ({\n+      ...errorEvent,\n+      error: errorEvent.error\n+        ? {\n+            name: errorEvent.error.name,\n+            message: errorEvent.error.message,\n+            stack: errorEvent.error.stack,\n+          }\n+        : null,\n+    })),\n+  }\n+}\n+\n // Events might be dispatched before we get a `dispatch` from React (e.g. console.error during module eval).\n // We need to queue them until we have a `dispatch` function available.\n function createQueuable<Args extends any[]>(\n@@ -204,6 +234,10 @@ function DevOverlayRoot({\n     isRecoverableError\n   )\n \n+  useEffect(() => {\n+    currentOverlayState = { ...state, routerType }\n+  }, [state, routerType])\n+\n   useLayoutEffect(() => {\n     const portalNode = shadowRoot.host\n     if (state.theme === 'dark') {"
        },
        {
            "sha": "b5b0095fa95d9992a877d8788f3420bea723218f",
            "filename": "packages/next/src/server/dev/hot-middleware.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -289,4 +289,12 @@ export class WebpackHotMiddleware {\n       this.clientsByRequestId.delete(requestId)\n     }\n   }\n+\n+  hasClients = () => {\n+    return this.clients.size > 0\n+  }\n+\n+  getClientCount = () => {\n+    return this.clients.size\n+  }\n }"
        },
        {
            "sha": "476d96814b9591416a70c7a419a798ae28dd5aff",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 1,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -30,6 +30,7 @@ import { BLOCKED_PAGES } from '../../shared/lib/constants'\n import {\n   getOverlayMiddleware,\n   getSourceMapMiddleware,\n+  getOriginalStackFrames,\n } from './middleware-turbopack'\n import { PageNotFoundError } from '../../shared/lib/utils'\n import { debounce } from '../utils'\n@@ -112,6 +113,8 @@ import {\n   matchNextPageBundleRequest,\n } from './hot-reloader-shared-utils'\n import { getMcpMiddleware } from '../mcp/get-mcp-middleware'\n+import { handleErrorStateResponse } from '../mcp/tools/get-errors'\n+import { setStackFrameResolver } from '../mcp/tools/utils/format-errors'\n \n const wsServer = new ws.Server({ noServer: true })\n const isTestMode = !!(\n@@ -734,10 +737,27 @@ export async function createHotReloaderTurbopack(\n       },\n     }),\n     ...(nextConfig.experimental.mcpServer\n-      ? [getMcpMiddleware(projectPath)]\n+      ? [\n+          getMcpMiddleware(\n+            projectPath,\n+            (message) => hotReloader.send(message),\n+            () => clients.size\n+          ),\n+        ]\n       : []),\n   ]\n \n+  setStackFrameResolver(async (request) => {\n+    return getOriginalStackFrames({\n+      project,\n+      projectPath,\n+      isServer: request.isServer,\n+      isEdgeServer: request.isEdgeServer,\n+      isAppDirectory: request.isAppDirectory,\n+      frames: request.frames,\n+    })\n+  })\n+\n   let versionInfoCached: ReturnType<typeof getVersionInfo> | undefined\n   // This fetch, even though not awaited, is not kicked off eagerly because the first `fetch()` in\n   // Node.js adds roughly 20ms main-thread blocking to load the SSL certificate cache\n@@ -919,6 +939,15 @@ export async function createHotReloaderTurbopack(\n               break\n             }\n \n+            case 'mcp-error-state-response': {\n+              handleErrorStateResponse(\n+                parsedData.requestId,\n+                parsedData.errorState,\n+                parsedData.url\n+              )\n+              break\n+            }\n+\n             default:\n               // Might be a Turbopack message...\n               if (!parsedData.type) {"
        },
        {
            "sha": "165e2c0b05317f762dd5f069206bd8f7e6589e8d",
            "filename": "packages/next/src/server/dev/hot-reloader-types.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -30,11 +30,18 @@ export const enum HMR_MESSAGE_SENT_TO_BROWSER {\n   ISR_MANIFEST = 'isrManifest',\n   DEV_INDICATOR = 'devIndicator',\n   DEVTOOLS_CONFIG = 'devtoolsConfig',\n+  REQUEST_CURRENT_ERROR_STATE = 'requestCurrentErrorState',\n \n   // Binary messages:\n   REACT_DEBUG_CHUNK = 0,\n }\n \n+export const enum HMR_MESSAGE_SENT_TO_SERVER {\n+  // JSON messages:\n+  MCP_ERROR_STATE_RESPONSE = 'mcp-error-state-response',\n+  PING = 'ping',\n+}\n+\n export interface ServerErrorMessage {\n   type: HMR_MESSAGE_SENT_TO_BROWSER.SERVER_ERROR\n   errorJSON: string\n@@ -143,6 +150,11 @@ export interface ReactDebugChunkMessage {\n   chunk: Uint8Array | null\n }\n \n+export interface RequestCurrentErrorStateMessage {\n+  type: HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_CURRENT_ERROR_STATE\n+  requestId: string\n+}\n+\n export type HmrMessageSentToBrowser =\n   | TurbopackMessage\n   | TurbopackConnectedMessage\n@@ -161,6 +173,7 @@ export type HmrMessageSentToBrowser =\n   | AppIsrManifestMessage\n   | DevToolsConfigMessage\n   | ReactDebugChunkMessage\n+  | RequestCurrentErrorStateMessage\n \n export type BinaryHmrMessageSentToBrowser = Extract<\n   HmrMessageSentToBrowser,"
        },
        {
            "sha": "c4c8b03a7fc5c28ad0029e2a5a3c5bf27c4d7350",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -10,6 +10,7 @@ import { type webpack, StringXor } from 'next/dist/compiled/webpack/webpack'\n import {\n   getOverlayMiddleware,\n   getSourceMapMiddleware,\n+  getOriginalStackFrames,\n } from './middleware-webpack'\n import { WebpackHotMiddleware } from './hot-middleware'\n import { join, relative, isAbsolute, posix, dirname } from 'path'\n@@ -105,6 +106,7 @@ import {\n   matchNextPageBundleRequest,\n } from './hot-reloader-shared-utils'\n import { getMcpMiddleware } from '../mcp/get-mcp-middleware'\n+import { setStackFrameResolver } from '../mcp/tools/utils/format-errors'\n \n const MILLISECONDS_IN_NANOSECOND = BigInt(1_000_000)\n \n@@ -1622,9 +1624,28 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n         },\n       }),\n       ...(this.config.experimental.mcpServer\n-        ? [getMcpMiddleware(this.dir)]\n+        ? [\n+            getMcpMiddleware(\n+              this.dir,\n+              (message) => this.send(message),\n+              () => this.webpackHotMiddleware?.getClientCount() ?? 0\n+            ),\n+          ]\n         : []),\n     ]\n+\n+    setStackFrameResolver(async (request) => {\n+      return getOriginalStackFrames({\n+        isServer: request.isServer,\n+        isEdgeServer: request.isEdgeServer,\n+        isAppDirectory: request.isAppDirectory,\n+        frames: request.frames,\n+        clientStats: () => this.clientStats,\n+        serverStats: () => this.serverStats,\n+        edgeServerStats: () => this.edgeServerStats,\n+        rootDirectory: this.dir,\n+      })\n+    })\n   }\n \n   public invalidate("
        },
        {
            "sha": "4a3c13604bb43d0f11c9e8fe04f78b4458c05f01",
            "filename": "packages/next/src/server/dev/on-demand-entry-handler.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -36,13 +36,17 @@ import {\n   UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n } from '../../shared/lib/constants'\n import { PAGE_SEGMENT_KEY } from '../../shared/lib/segment'\n-import { HMR_MESSAGE_SENT_TO_BROWSER } from './hot-reloader-types'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  HMR_MESSAGE_SENT_TO_SERVER,\n+} from './hot-reloader-types'\n import { isAppPageRouteDefinition } from '../route-definitions/app-page-route-definition'\n import { scheduleOnNextTick } from '../../lib/scheduler'\n import { Batcher } from '../../lib/batcher'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { PAGE_TYPES } from '../../lib/page-types'\n import { getNextFlightSegmentPath } from '../../client/flight-data-helpers'\n+import { handleErrorStateResponse } from '../mcp/tools/get-errors'\n \n const debug = createDebug('next:on-demand-entry-handler')\n \n@@ -992,12 +996,21 @@ export function onDemandEntryHandler({\n             typeof data !== 'string' ? data.toString() : data\n           )\n \n-          if (parsedData.event === 'ping') {\n+          if (parsedData.event === HMR_MESSAGE_SENT_TO_SERVER.PING) {\n             if (parsedData.appDirRoute) {\n               handleAppDirPing(parsedData.tree)\n             } else {\n               handlePing(parsedData.page)\n             }\n+          } else if (\n+            parsedData.event ===\n+            HMR_MESSAGE_SENT_TO_SERVER.MCP_ERROR_STATE_RESPONSE\n+          ) {\n+            handleErrorStateResponse(\n+              parsedData.requestId,\n+              parsedData.errorState,\n+              parsedData.url\n+            )\n           }\n         } catch {}\n       })"
        },
        {
            "sha": "e31af660e424d14e5cb2927ebebeebbc455c04b3",
            "filename": "packages/next/src/server/mcp/get-mcp-middleware.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-mcp-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-mcp-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-mcp-middleware.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -2,8 +2,13 @@ import type { ServerResponse, IncomingMessage } from 'http'\n import { getOrCreateMcpServer } from './get-or-create-mcp-server'\n import { parseBody } from '../api-utils/node/parse-body'\n import { StreamableHTTPServerTransport } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/streamableHttp'\n+import type { HmrMessageSentToBrowser } from '../dev/hot-reloader-types'\n \n-export function getMcpMiddleware(projectPath: string) {\n+export function getMcpMiddleware(\n+  projectPath: string,\n+  sendHmrMessage: (message: HmrMessageSentToBrowser) => void,\n+  getActiveConnectionCount: () => number\n+) {\n   return async function (\n     req: IncomingMessage,\n     res: ServerResponse,\n@@ -13,7 +18,11 @@ export function getMcpMiddleware(projectPath: string) {\n     if (!pathname.startsWith('/_next/mcp')) {\n       return next()\n     }\n-    const mcpServer = getOrCreateMcpServer(projectPath)\n+    const mcpServer = getOrCreateMcpServer(\n+      projectPath,\n+      sendHmrMessage,\n+      getActiveConnectionCount\n+    )\n     const transport = new StreamableHTTPServerTransport({\n       sessionIdGenerator: undefined,\n     })"
        },
        {
            "sha": "bfcdd535c43e71f6942b733819e48176a552f4e7",
            "filename": "packages/next/src/server/mcp/get-or-create-mcp-server.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 41,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -1,8 +1,15 @@\n import { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n+import { registerGetProjectPathTool } from './tools/get-project-path'\n+import { registerGetErrorsTool } from './tools/get-errors'\n+import type { HmrMessageSentToBrowser } from '../dev/hot-reloader-types'\n \n let mcpServer: McpServer | undefined\n \n-export const getOrCreateMcpServer = (projectPath: string) => {\n+export const getOrCreateMcpServer = (\n+  projectPath: string,\n+  sendHmrMessage: (message: HmrMessageSentToBrowser) => void,\n+  getActiveConnectionCount: () => number\n+) => {\n   if (mcpServer) {\n     return mcpServer\n   }\n@@ -12,46 +19,8 @@ export const getOrCreateMcpServer = (projectPath: string) => {\n     version: '0.1.0',\n   })\n \n-  mcpServer.registerTool(\n-    'get_project_path',\n-    {\n-      description:\n-        'Returns the absolute path of the root directory for this Next.js project.',\n-      inputSchema: {},\n-    },\n-    async (_request) => {\n-      try {\n-        if (!projectPath) {\n-          return {\n-            content: [\n-              {\n-                type: 'text',\n-                text: 'Unable to determine the absolute path of the Next.js project.',\n-              },\n-            ],\n-          }\n-        }\n-\n-        return {\n-          content: [\n-            {\n-              type: 'text',\n-              text: projectPath,\n-            },\n-          ],\n-        }\n-      } catch (error) {\n-        return {\n-          content: [\n-            {\n-              type: 'text',\n-              text: `Error: ${error instanceof Error ? error.message : String(error)}`,\n-            },\n-          ],\n-        }\n-      }\n-    }\n-  )\n+  registerGetProjectPathTool(mcpServer, projectPath)\n+  registerGetErrorsTool(mcpServer, sendHmrMessage, getActiveConnectionCount)\n \n   return mcpServer\n }"
        },
        {
            "sha": "5aa6d9d27296d16c5d96d9493df0310385296763",
            "filename": "packages/next/src/server/mcp/tools/get-errors.ts",
            "status": "added",
            "additions": 173,
            "deletions": 0,
            "changes": 173,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-errors.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,173 @@\n+/**\n+ * MCP tool for retrieving browser error state.\n+ *\n+ * This tool demonstrates server-to-browser communication in Next.js dev mode.\n+ * It leverages the existing HMR infrastructure rather than creating new channels.\n+ *\n+ * Flow:\n+ *   MCP client → server generates request ID → HMR message to browser →\n+ *   browser queries error overlay state → HMR response back → server performs source mapping →\n+ *   formatted output.\n+ */\n+import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n+import type { OverlayState } from '../../../next-devtools/dev-overlay/shared'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  type HmrMessageSentToBrowser,\n+} from '../../dev/hot-reloader-types'\n+import { nanoid } from 'next/dist/compiled/nanoid'\n+import type { OverlayStateWithUrl } from '../../../shared/lib/mcp-error-types'\n+import { formatErrors } from './utils/format-errors'\n+\n+// These promises are created when the MCP endpoint is called but before the browser has responded\n+// with its error state. They are resolved when the browser has responded with its error state\n+// or when the timeout is reached.\n+const pendingRequests = new Map<\n+  string,\n+  {\n+    responses: OverlayStateWithUrl[]\n+    expectedCount: number\n+    resolve: (value: OverlayStateWithUrl[]) => void\n+    reject: (reason?: any) => void\n+    timeout: NodeJS.Timeout\n+  }\n+>()\n+\n+export function registerGetErrorsTool(\n+  server: McpServer,\n+  sendHmrMessage: (message: HmrMessageSentToBrowser) => void,\n+  getActiveConnectionCount: () => number\n+) {\n+  server.registerTool(\n+    'get_errors',\n+    {\n+      description:\n+        'Get the current error state of the app when rendered in the browser, including any build or runtime errors with source-mapped stack traces',\n+      inputSchema: {},\n+    },\n+    async (_request) => {\n+      try {\n+        const connectionCount = getActiveConnectionCount()\n+        if (connectionCount === 0) {\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: 'No browser sessions connected. Please open your application in a browser to retrieve error state.',\n+              },\n+            ],\n+          }\n+        }\n+\n+        const requestId = `mcp-error-state-${nanoid()}`\n+\n+        // The promise will be resolved when all active browser sessions have responded\n+        // with their respective error states. We will resolve the promise after 5 seconds\n+        // with whatever responses we have received so far.\n+        const responsePromise = new Promise<OverlayStateWithUrl[]>(\n+          (resolve, reject) => {\n+            const timeout = setTimeout(() => {\n+              const pending = pendingRequests.get(requestId)\n+              if (pending && pending.responses.length > 0) {\n+                resolve(pending.responses)\n+              } else {\n+                reject(\n+                  new Error(\n+                    'Timeout waiting for error state from frontend. The browser may not be responding to HMR messages.'\n+                  )\n+                )\n+              }\n+              pendingRequests.delete(requestId)\n+            }, 5000)\n+            pendingRequests.set(requestId, {\n+              responses: [],\n+              expectedCount: connectionCount,\n+              resolve,\n+              reject,\n+              timeout,\n+            })\n+          }\n+        )\n+\n+        // When browser receives this HMR message, it will send back a response with\n+        // its client-side error state, which will be handled by `handleErrorStateResponse`.\n+        sendHmrMessage({\n+          type: HMR_MESSAGE_SENT_TO_BROWSER.REQUEST_CURRENT_ERROR_STATE,\n+          requestId,\n+        })\n+\n+        const clientStates = await responsePromise\n+\n+        const errorsByUrl = new Map<string, OverlayState>()\n+        for (const state of clientStates) {\n+          if (state.errorState) {\n+            errorsByUrl.set(state.url, state.errorState)\n+          }\n+        }\n+\n+        const hasErrors = Array.from(errorsByUrl.values()).some(\n+          (state) => state.errors.length > 0 || !!state.buildError\n+        )\n+\n+        if (!hasErrors) {\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text:\n+                  clientStates.length === 0\n+                    ? 'No browser sessions responded.'\n+                    : `No errors detected in ${clientStates.length} browser session(s).`,\n+              },\n+            ],\n+          }\n+        }\n+\n+        const output = await formatErrors(errorsByUrl)\n+\n+        return {\n+          content: [\n+            {\n+              type: 'text',\n+              text: output,\n+            },\n+          ],\n+        }\n+      } catch (error) {\n+        return {\n+          content: [\n+            {\n+              type: 'text',\n+              text: `Error: ${error instanceof Error ? error.message : String(error)}`,\n+            },\n+          ],\n+        }\n+      }\n+    }\n+  )\n+}\n+\n+// Browser will first receive an HMR message from server to send back its error state.\n+// The actual state is sent back in a subsequent HMR message, which is handled by this function\n+// on the server.\n+export function handleErrorStateResponse(\n+  requestId: string,\n+  errorState: OverlayState | null,\n+  url: string | undefined\n+) {\n+  if (!url) {\n+    throw new Error(\n+      'URL is required in MCP error state response. This is a bug in Next.js.'\n+    )\n+  }\n+\n+  const pending = pendingRequests.get(requestId)\n+  if (pending) {\n+    pending.responses.push({ url, errorState })\n+    if (pending.responses.length >= pending.expectedCount) {\n+      clearTimeout(pending.timeout)\n+      pending.resolve(pending.responses)\n+      pendingRequests.delete(requestId)\n+    }\n+  }\n+}"
        },
        {
            "sha": "20672a575e3f7db0a7494b024f52c47bc50701cb",
            "filename": "packages/next/src/server/mcp/tools/get-project-path.ts",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-path.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-path.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-path.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,47 @@\n+import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n+\n+export function registerGetProjectPathTool(\n+  server: McpServer,\n+  projectPath: string\n+) {\n+  server.registerTool(\n+    'get_project_path',\n+    {\n+      description:\n+        'Returns the absolute path of the root directory for this Next.js project.',\n+      inputSchema: {},\n+    },\n+    async (_request) => {\n+      try {\n+        if (!projectPath) {\n+          return {\n+            content: [\n+              {\n+                type: 'text',\n+                text: 'Unable to determine the absolute path of the Next.js project.',\n+              },\n+            ],\n+          }\n+        }\n+\n+        return {\n+          content: [\n+            {\n+              type: 'text',\n+              text: projectPath,\n+            },\n+          ],\n+        }\n+      } catch (error) {\n+        return {\n+          content: [\n+            {\n+              type: 'text',\n+              text: `Error: ${error instanceof Error ? error.message : String(error)}`,\n+            },\n+          ],\n+        }\n+      }\n+    }\n+  )\n+}"
        },
        {
            "sha": "41e7e0649ca8ef9b1e77eca4095a2ba4f3a54c31",
            "filename": "packages/next/src/server/mcp/tools/utils/format-errors.ts",
            "status": "added",
            "additions": 171,
            "deletions": 0,
            "changes": 171,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fformat-errors.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fformat-errors.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Futils%2Fformat-errors.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,171 @@\n+import type { OverlayState } from '../../../../next-devtools/dev-overlay/shared'\n+import type { SupportedErrorEvent } from '../../../../next-devtools/dev-overlay/container/runtime-error/render-error'\n+import { getErrorSource } from '../../../../shared/lib/error-source'\n+import type {\n+  OriginalStackFramesRequest,\n+  OriginalStackFramesResponse,\n+} from '../../../../next-devtools/server/shared'\n+\n+type StackFrameForFormatting = {\n+  file: string | null\n+  methodName: string\n+  line1: number | null\n+  column1: number | null\n+}\n+\n+type StackFrameResolver = (\n+  request: OriginalStackFramesRequest\n+) => Promise<OriginalStackFramesResponse>\n+\n+// Dependency injection for stack frame resolver\n+let stackFrameResolver: StackFrameResolver | undefined\n+\n+export function setStackFrameResolver(fn: StackFrameResolver) {\n+  stackFrameResolver = fn\n+}\n+\n+async function resolveStackFrames(\n+  request: OriginalStackFramesRequest\n+): Promise<OriginalStackFramesResponse> {\n+  if (!stackFrameResolver) {\n+    throw new Error(\n+      'Stack frame resolver not initialized. This is a bug in Next.js.'\n+    )\n+  }\n+  return stackFrameResolver(request)\n+}\n+\n+const formatStackFrame = (frame: StackFrameForFormatting): string => {\n+  const file = frame.file || '<unknown>'\n+  const method = frame.methodName || '<anonymous>'\n+  const { line1: line, column1: column } = frame\n+  return line && column\n+    ? `  at ${method} (${file}:${line}:${column})`\n+    : line\n+      ? `  at ${method} (${file}:${line})`\n+      : `  at ${method} (${file})`\n+}\n+\n+const formatErrorFrames = async (\n+  frames: readonly StackFrameForFormatting[],\n+  context: {\n+    isServer: boolean\n+    isEdgeServer: boolean\n+    isAppDirectory: boolean\n+  }\n+): Promise<string> => {\n+  try {\n+    const resolvedFrames = await resolveStackFrames({\n+      frames: frames.map((frame) => ({\n+        file: frame.file || null,\n+        methodName: frame.methodName || '<anonymous>',\n+        arguments: [],\n+        line1: frame.line1 || null,\n+        column1: frame.column1 || null,\n+      })),\n+      isServer: context.isServer,\n+      isEdgeServer: context.isEdgeServer,\n+      isAppDirectory: context.isAppDirectory,\n+    })\n+\n+    return (\n+      resolvedFrames\n+        .filter(\n+          (resolvedFrame) =>\n+            !(\n+              resolvedFrame.status === 'fulfilled' &&\n+              resolvedFrame.value.originalStackFrame?.ignored\n+            )\n+        )\n+        .map((resolvedFrame, j) =>\n+          resolvedFrame.status === 'fulfilled' &&\n+          resolvedFrame.value.originalStackFrame\n+            ? formatStackFrame(resolvedFrame.value.originalStackFrame)\n+            : formatStackFrame(frames[j])\n+        )\n+        .join('\\n') + '\\n'\n+    )\n+  } catch {\n+    return frames.map(formatStackFrame).join('\\n') + '\\n'\n+  }\n+}\n+\n+async function formatRuntimeError(\n+  errors: readonly SupportedErrorEvent[],\n+  isAppDirectory: boolean\n+): Promise<string> {\n+  const formatError = async (\n+    error: SupportedErrorEvent,\n+    index: number\n+  ): Promise<string> => {\n+    const errorHeader = `\\n#### Error ${index + 1} (Type: ${error.type})\\n\\n`\n+    const errorName = error.error?.name || 'Error'\n+    const errorMsg = error.error?.message || 'Unknown error'\n+    const errorMessage = `**${errorName}**: ${errorMsg}\\n\\n`\n+\n+    if (!error.frames?.length) {\n+      const stack = error.error?.stack || ''\n+      return (\n+        errorHeader + errorMessage + (stack ? `\\`\\`\\`\\n${stack}\\n\\`\\`\\`\\n` : '')\n+      )\n+    }\n+\n+    const errorSource = getErrorSource(error.error)\n+    const frames = await formatErrorFrames(error.frames, {\n+      isServer: errorSource === 'server',\n+      isEdgeServer: errorSource === 'edge-server',\n+      isAppDirectory,\n+    })\n+\n+    return errorHeader + errorMessage + `\\`\\`\\`\\n${frames}\\`\\`\\`\\n`\n+  }\n+\n+  const formattedErrors = await Promise.all(errors.map(formatError))\n+  return '### Runtime Errors\\n' + formattedErrors.join('\\n---\\n')\n+}\n+\n+export async function formatErrors(\n+  errorsByUrl: Map<string, OverlayState>\n+): Promise<string> {\n+  let output = `# Found errors in ${errorsByUrl.size} browser session(s)\\n\\n`\n+\n+  for (const [url, overlayState] of errorsByUrl) {\n+    const totalErrorCount =\n+      overlayState.errors.length + (overlayState.buildError ? 1 : 0)\n+\n+    if (totalErrorCount === 0) continue\n+\n+    let displayUrl = url\n+    try {\n+      const urlObj = new URL(url)\n+      displayUrl = urlObj.pathname + urlObj.search + urlObj.hash\n+    } catch {\n+      // If URL parsing fails, use the original URL\n+    }\n+\n+    output += `## Session: ${displayUrl}\\n\\n`\n+    output += `**${totalErrorCount} error(s) found**\\n\\n`\n+\n+    // Build errors\n+    if (overlayState.buildError) {\n+      output += '### Build Error\\n\\n'\n+      output += '```\\n'\n+      output += overlayState.buildError\n+      output += '\\n```\\n\\n'\n+    }\n+\n+    // Runtime errors with source-mapped stack traces\n+    if (overlayState.errors.length > 0) {\n+      const runtimeErrors = await formatRuntimeError(\n+        overlayState.errors,\n+        overlayState.routerType === 'app'\n+      )\n+      output += runtimeErrors\n+      output += '\\n'\n+    }\n+\n+    output += '---\\n\\n'\n+  }\n+\n+  return output.trim()\n+}"
        },
        {
            "sha": "098dbcef56e4907c4863d4ac3b45f6f5c5979378",
            "filename": "packages/next/src/shared/lib/mcp-error-types.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmcp-error-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmcp-error-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmcp-error-types.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,13 @@\n+import type { OverlayState } from '../../next-devtools/dev-overlay/shared'\n+\n+export interface OverlayStateWithUrl {\n+  url: string\n+  errorState: OverlayState | null\n+}\n+\n+export interface McpErrorStateResponse {\n+  event: string\n+  requestId: string\n+  errorState: OverlayState | null\n+  url: string\n+}"
        },
        {
            "sha": "4b1914d938b2eb93328365020a0f0d51d12ccaf9",
            "filename": "test/development/mcp-server/fixtures/default-template/app/build-error/page.tsx",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fbuild-error%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fbuild-error%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fbuild-error%2Fpage.tsx?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,4 @@\n+export default function BuildErrorPage() {\n+  // Syntax error - missing closing brace\n+  return <div>Page\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "53ea84acc0dfb88c34e13a5fb24ea9d9d0de9eec",
            "filename": "test/development/mcp-server/fixtures/default-template/app/page.tsx",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fpage.tsx?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -1,3 +1,14 @@\n+import Link from 'next/link'\n+\n export default function Page() {\n-  return <h1>Test MCP Server Page</h1>\n+  return (\n+    <div>\n+      <h1>Home Page</h1>\n+      <nav>\n+        <Link href=\"/runtime-error\">Go to Runtime Error</Link>\n+        <br />\n+        <Link href=\"/build-error\">Go to Build Error</Link>\n+      </nav>\n+    </div>\n+  )\n }"
        },
        {
            "sha": "d9ad533b4f78f87c8ca3f84f8fd39fb422695143",
            "filename": "test/development/mcp-server/fixtures/default-template/app/runtime-error-2/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fruntime-error-2%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fruntime-error-2%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fruntime-error-2%2Fpage.tsx?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,3 @@\n+export default function RuntimeErrorPage() {\n+  throw new Error('Test runtime error 2')\n+}"
        },
        {
            "sha": "50558bc555cca41ce3aa39c9abb267b62612f6bf",
            "filename": "test/development/mcp-server/fixtures/default-template/app/runtime-error/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fruntime-error%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fruntime-error%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Ffixtures%2Fdefault-template%2Fapp%2Fruntime-error%2Fpage.tsx?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,3 @@\n+export default function RuntimeErrorPage() {\n+  throw new Error('Test runtime error')\n+}"
        },
        {
            "sha": "136584834b87b0cbd3ba04c052832bdc6f8f3e86",
            "filename": "test/development/mcp-server/mcp-server-get-errors.test.ts",
            "status": "added",
            "additions": 319,
            "deletions": 0,
            "changes": 319,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-errors.test.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,319 @@\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+import { retry, debugPrint, getFullUrl } from 'next-test-utils'\n+import stripAnsi from 'strip-ansi'\n+import { chromium, firefox, webkit } from 'playwright'\n+import type { Browser } from 'playwright'\n+\n+describe('mcp-server get_errors tool', () => {\n+  const { next } = nextTestSetup({\n+    files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n+  })\n+\n+  async function callGetErrors(id: string) {\n+    const response = await fetch(`${next.url}/_next/mcp`, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+        Accept: 'application/json, text/event-stream',\n+      },\n+      body: JSON.stringify({\n+        jsonrpc: '2.0',\n+        id,\n+        method: 'tools/call',\n+        params: { name: 'get_errors', arguments: {} },\n+      }),\n+    })\n+\n+    const text = await response.text()\n+    const match = text.match(/data: ({.*})/s)\n+    const result = JSON.parse(match![1])\n+    return result.result?.content?.[0]?.text\n+  }\n+\n+  it('should handle no browser sessions gracefully', async () => {\n+    const errors = await callGetErrors('test-no-session')\n+    expect(stripAnsi(errors)).toMatchInlineSnapshot(\n+      `\"No browser sessions connected. Please open your application in a browser to retrieve error state.\"`\n+    )\n+  })\n+\n+  it('should return no errors for clean page', async () => {\n+    await next.browser('/')\n+    const errors = await callGetErrors('test-1')\n+    expect(stripAnsi(errors)).toMatchInlineSnapshot(\n+      `\"No errors detected in 1 browser session(s).\"`\n+    )\n+  })\n+\n+  it('should capture runtime errors with source-mapped stack frames', async () => {\n+    const browser = await next.browser('/')\n+    await browser.elementByCss('a[href=\"/runtime-error\"]').click()\n+\n+    let errors: string = ''\n+    await retry(async () => {\n+      const sessionId = 'test-2-' + Date.now()\n+      errors = await callGetErrors(sessionId)\n+      expect(errors).toContain('Runtime Errors')\n+      expect(errors).toContain('Found errors in 1 browser session')\n+    })\n+\n+    const strippedErrors = stripAnsi(errors)\n+      // Replace dynamic port with placeholder\n+      .replace(/localhost:\\d+/g, 'localhost:PORT')\n+\n+    // Verify proper URL display in session header (now shows pathname only)\n+    expect(strippedErrors).toContain('Session: /runtime-error')\n+\n+    expect(strippedErrors).toMatchInlineSnapshot(`\n+      \"# Found errors in 1 browser session(s)\n+\n+      ## Session: /runtime-error\n+\n+      **1 error(s) found**\n+\n+      ### Runtime Errors\n+\n+      #### Error 1 (Type: runtime)\n+\n+      **Error**: Test runtime error\n+\n+      \\`\\`\\`\n+        at RuntimeErrorPage (app/runtime-error/page.tsx:2:9)\n+      \\`\\`\\`\n+\n+      ---\"\n+    `)\n+  })\n+\n+  it('should capture build errors when directly visiting error page', async () => {\n+    await next.browser('/build-error')\n+\n+    let errors: string = ''\n+    await retry(async () => {\n+      const sessionId = 'test-4-' + Date.now()\n+      errors = await callGetErrors(sessionId)\n+      expect(errors).toContain('Build Error')\n+      expect(errors).toContain('Found errors in 1 browser session')\n+    })\n+\n+    let strippedErrors = stripAnsi(errors)\n+      // Replace dynamic port with placeholder\n+      .replace(/localhost:\\d+/g, 'localhost:PORT')\n+\n+    // Verify proper URL display in session header (now shows pathname only)\n+    expect(strippedErrors).toContain('Session: /build-error')\n+\n+    const isTurbopack = process.env.IS_TURBOPACK_TEST === '1'\n+\n+    // Normalize paths in turbopack output to remove temp directory prefix\n+    if (isTurbopack) {\n+      strippedErrors = strippedErrors.replace(/\\.\\/test\\/tmp\\/[^/]+\\//g, './')\n+    }\n+\n+    if (isTurbopack) {\n+      // Turbopack output\n+      expect(strippedErrors).toMatchInlineSnapshot(`\n+       \"# Found errors in 1 browser session(s)\n+\n+       ## Session: /build-error\n+\n+       **2 error(s) found**\n+\n+       ### Build Error\n+\n+       \\`\\`\\`\n+       ./app/build-error/page.tsx:4:1\n+       Parsing ecmascript source code failed\n+         2 |   // Syntax error - missing closing brace\n+         3 |   return <div>Page\n+       > 4 | }\n+           | ^\n+\n+       Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+       \\`\\`\\`\n+\n+       ### Runtime Errors\n+\n+       #### Error 1 (Type: runtime)\n+\n+       **Error**: ./app/build-error/page.tsx:4:1\n+       Parsing ecmascript source code failed\n+         2 |   // Syntax error - missing closing brace\n+         3 |   return <div>Page\n+       > 4 | }\n+           | ^\n+\n+       Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+\n+\n+\n+       \\`\\`\\`\n+         at <unknown> (Error: ./app/build-error/page.tsx:4:1)\n+         at <unknown> (Error: (./app/build-error/page.tsx:4:1)\n+       \\`\\`\\`\n+\n+       ---\"\n+      `)\n+    } else {\n+      // Webpack output\n+      expect(strippedErrors).toMatchInlineSnapshot(`\n+       \"# Found errors in 1 browser session(s)\n+\n+       ## Session: /build-error\n+\n+       **1 error(s) found**\n+\n+       ### Build Error\n+\n+       \\`\\`\\`\n+       ./app/build-error/page.tsx\n+       Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+          ,-[4:1]\n+        1 | export default function BuildErrorPage() {\n+        2 |   // Syntax error - missing closing brace\n+        3 |   return <div>Page\n+        4 | }\n+          : ^\n+          \\`----\n+         x Expected '</', got '<eof>'\n+          ,-[4:1]\n+        1 | export default function BuildErrorPage() {\n+        2 |   // Syntax error - missing closing brace\n+        3 |   return <div>Page\n+        4 | }\n+          \\`----\n+\n+       Caused by:\n+           Syntax Error\n+       \\`\\`\\`\n+\n+       ---\"\n+      `)\n+    }\n+  })\n+\n+  it('should capture errors from multiple browser sessions', async () => {\n+    // Restart the server\n+    await next.stop()\n+    await next.start()\n+\n+    // Open two independent browser sessions concurrently\n+    const [s1, s2] = await Promise.all([\n+      launchStandaloneSession(next.url, '/runtime-error'),\n+      launchStandaloneSession(next.url, '/runtime-error-2'),\n+    ])\n+\n+    try {\n+      // Wait for server to be ready\n+      await new Promise((resolve) => setTimeout(resolve, 1000))\n+      let errors: string = ''\n+      await retry(async () => {\n+        const sessionId = 'test-multi-' + Date.now()\n+        errors = await callGetErrors(sessionId)\n+        // Check that we have at least the 2 sessions we created\n+        expect(errors).toMatch(/Found errors in \\d+ browser session/)\n+        // Ensure both our sessions are present\n+        expect(errors).toContain('/runtime-error')\n+        expect(errors).toContain('/runtime-error-2')\n+      })\n+\n+      const strippedErrors = stripAnsi(errors).replace(\n+        /localhost:\\d+/g,\n+        'localhost:PORT'\n+      )\n+\n+      // Extract each session's content to check them independently\n+      const session1Match = strippedErrors.match(\n+        /## Session: \\/runtime-error\\n[\\s\\S]*?(?=---)/\n+      )\n+      const session2Match = strippedErrors.match(\n+        /## Session: \\/runtime-error-2\\n[\\s\\S]*?(?=---)/\n+      )\n+\n+      expect(session1Match).toBeTruthy()\n+      expect(session2Match).toBeTruthy()\n+\n+      expect(session1Match?.[0]).toMatchInlineSnapshot(`\n+        \"## Session: /runtime-error\n+\n+        **1 error(s) found**\n+\n+        ### Runtime Errors\n+\n+        #### Error 1 (Type: runtime)\n+\n+        **Error**: Test runtime error\n+\n+        \\`\\`\\`\n+          at RuntimeErrorPage (app/runtime-error/page.tsx:2:9)\n+        \\`\\`\\`\n+\n+        \"\n+      `)\n+\n+      expect(session2Match?.[0]).toMatchInlineSnapshot(`\n+        \"## Session: /runtime-error-2\n+\n+        **1 error(s) found**\n+\n+        ### Runtime Errors\n+\n+        #### Error 1 (Type: runtime)\n+\n+        **Error**: Test runtime error 2\n+\n+        \\`\\`\\`\n+          at RuntimeErrorPage (app/runtime-error-2/page.tsx:2:9)\n+        \\`\\`\\`\n+\n+        \"\n+      `)\n+    } finally {\n+      await s1.close()\n+      await s2.close()\n+    }\n+  })\n+})\n+\n+/**\n+ * Minimal standalone browser session launcher for testing multiple concurrent browser tabs.\n+ * The standard test harness (next.browser) uses a singleton browser instance which doesn't\n+ * support concurrent tabs needed for testing errors across multiple browser sessions.\n+ */\n+async function launchStandaloneSession(\n+  appPortOrUrl: string | number,\n+  url: string\n+) {\n+  const headless = !!process.env.HEADLESS\n+  const browserName = (process.env.BROWSER_NAME || 'chrome').toLowerCase()\n+\n+  let browser: Browser\n+  if (browserName === 'safari') {\n+    browser = await webkit.launch({ headless })\n+  } else if (browserName === 'firefox') {\n+    browser = await firefox.launch({ headless })\n+  } else {\n+    browser = await chromium.launch({ headless })\n+  }\n+\n+  const context = await browser.newContext()\n+  const page = await context.newPage()\n+\n+  const fullUrl = getFullUrl(appPortOrUrl, url)\n+  debugPrint(`Loading standalone browser with ${fullUrl}`)\n+\n+  page.on('pageerror', (error) => debugPrint('Standalone page error', error))\n+\n+  await page.goto(fullUrl, { waitUntil: 'load' })\n+  debugPrint(`Loaded standalone browser with ${fullUrl}`)\n+\n+  return {\n+    page,\n+    close: async () => {\n+      await page.close().catch(() => {})\n+      await context.close().catch(() => {})\n+      await browser.close().catch(() => {})\n+    },\n+  }\n+}"
        },
        {
            "sha": "90a42c837ae6d288143c0e19e86db631010c6839",
            "filename": "test/development/mcp-server/mcp-server-get-project-path.test.ts",
            "status": "added",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-project-path.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-project-path.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-project-path.test.ts?ref=f9ee7a1aba52c7341cc4ea97a3c3fbcec92d7d85",
            "patch": "@@ -0,0 +1,49 @@\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+\n+describe('mcp-server get_project_path tool', () => {\n+  const { next } = nextTestSetup({\n+    files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n+  })\n+  it('should return correct project path via get_project_path tool', async () => {\n+    const mcpEndpoint = `${next.url}/_next/mcp`\n+\n+    // Call get_project_path tool\n+    const callToolResponse = await fetch(mcpEndpoint, {\n+      method: 'POST',\n+      headers: {\n+        'Content-Type': 'application/json',\n+        Accept: 'application/json, text/event-stream',\n+      },\n+      body: JSON.stringify({\n+        jsonrpc: '2.0',\n+        id: 'call-tool-1',\n+        method: 'tools/call',\n+        params: {\n+          name: 'get_project_path',\n+          arguments: {},\n+        },\n+      }),\n+    })\n+\n+    const callToolText = await callToolResponse.text()\n+    const callToolDataMatch = callToolText.match(/data: ({.*})/s)\n+    expect(callToolDataMatch).toBeTruthy()\n+\n+    const callToolResult = JSON.parse(callToolDataMatch![1])\n+    expect(callToolResult.jsonrpc).toBe('2.0')\n+    expect(callToolResult.id).toBe('call-tool-1')\n+\n+    const content = callToolResult.result?.content\n+    expect(content).toBeInstanceOf(Array)\n+    expect(content?.[0]?.type).toBe('text')\n+\n+    const actualProjectPath = content?.[0]?.text\n+\n+    // Verify it's an absolute path\n+    expect(path.isAbsolute(actualProjectPath)).toBe(true)\n+\n+    // Should match the test directory\n+    expect(actualProjectPath).toBe(next.testDir)\n+  })\n+})"
        },
        {
            "sha": "2d21a3c93f598cd74c11805f4a823b2f5cb66100",
            "filename": "test/development/mcp-server/mcp-server.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 135,
            "changes": 135,
            "blob_url": "https://github.com/vercel/next.js/blob/e8a1342e0ec2b576465ae33e1c7392c92703e7ec/test%2Fdevelopment%2Fmcp-server%2Fmcp-server.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e8a1342e0ec2b576465ae33e1c7392c92703e7ec/test%2Fdevelopment%2Fmcp-server%2Fmcp-server.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server.test.ts?ref=e8a1342e0ec2b576465ae33e1c7392c92703e7ec",
            "patch": "@@ -1,135 +0,0 @@\n-import { FileRef, nextTestSetup } from 'e2e-utils'\n-import path from 'path'\n-\n-describe('mcp-server', () => {\n-  const { next } = nextTestSetup({\n-    files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n-  })\n-\n-  async function initializeMCPSession(\n-    mcpEndpoint: string,\n-    id: string\n-  ): Promise<any> {\n-    const initResponse = await fetch(mcpEndpoint, {\n-      method: 'POST',\n-      headers: {\n-        'Content-Type': 'application/json',\n-        Accept: 'application/json, text/event-stream',\n-      },\n-      body: JSON.stringify({\n-        jsonrpc: '2.0',\n-        id,\n-        method: 'initialize',\n-        params: {\n-          protocolVersion: '1.0.0',\n-          capabilities: {},\n-          clientInfo: {\n-            name: 'test-client',\n-            version: '1.0.0',\n-          },\n-        },\n-      }),\n-    })\n-\n-    const initText = await initResponse.text()\n-    const dataMatch = initText.match(/data: ({.*})/s)\n-    if (!dataMatch) {\n-      throw new Error(`Unexpected response format: ${initText}`)\n-    }\n-\n-    const initResult = JSON.parse(dataMatch[1])\n-    if (initResult.error) {\n-      throw new Error(`MCP error: ${JSON.stringify(initResult.error)}`)\n-    }\n-\n-    return initResult\n-  }\n-\n-  it('should initialize MCP server and list available tools', async () => {\n-    const mcpEndpoint = `${next.url}/_next/mcp`\n-\n-    // Initialize MCP session\n-    const initResult = await initializeMCPSession(mcpEndpoint, 'init-1')\n-\n-    expect(initResult.jsonrpc).toBe('2.0')\n-    expect(initResult.id).toBe('init-1')\n-    expect(initResult.result?.serverInfo?.name).toBe('Next.js MCP Server')\n-\n-    // List available tools\n-    const listToolsResponse = await fetch(mcpEndpoint, {\n-      method: 'POST',\n-      headers: {\n-        'Content-Type': 'application/json',\n-        Accept: 'application/json, text/event-stream',\n-      },\n-      body: JSON.stringify({\n-        jsonrpc: '2.0',\n-        id: 'list-tools-1',\n-        method: 'tools/list',\n-        params: {},\n-      }),\n-    })\n-\n-    const listToolsText = await listToolsResponse.text()\n-    const listToolsDataMatch = listToolsText.match(/data: ({.*})/s)\n-    if (!listToolsDataMatch) {\n-      throw new Error(`Unexpected response format: ${listToolsText}`)\n-    }\n-    const listToolsResult = JSON.parse(listToolsDataMatch[1])\n-\n-    expect(listToolsResult.result?.tools).toBeInstanceOf(Array)\n-\n-    const projectDirTool = listToolsResult.result?.tools?.find(\n-      (tool: { name: string }) => tool.name === 'get_project_path'\n-    )\n-    expect(projectDirTool).toBeDefined()\n-    expect(projectDirTool?.description).toBe(\n-      'Returns the absolute path of the root directory for this Next.js project.'\n-    )\n-  })\n-\n-  it('should return exact absolute path for get_project_path tool', async () => {\n-    const mcpEndpoint = `${next.url}/_next/mcp`\n-\n-    // Initialize MCP session (required before calling tools)\n-    await initializeMCPSession(mcpEndpoint, 'init-2')\n-\n-    // Call get_project_path tool and verify response\n-    const callToolResponse = await fetch(mcpEndpoint, {\n-      method: 'POST',\n-      headers: {\n-        'Content-Type': 'application/json',\n-        Accept: 'application/json, text/event-stream',\n-      },\n-      body: JSON.stringify({\n-        jsonrpc: '2.0',\n-        id: 'call-tool-1',\n-        method: 'tools/call',\n-        params: {\n-          name: 'get_project_path',\n-          arguments: {},\n-        },\n-      }),\n-    })\n-\n-    const callToolText = await callToolResponse.text()\n-    const callToolDataMatch = callToolText.match(/data: ({.*})/s)\n-    if (!callToolDataMatch) {\n-      throw new Error(`Unexpected response format: ${callToolText}`)\n-    }\n-    const callToolResult = JSON.parse(callToolDataMatch[1])\n-\n-    expect(callToolResult.jsonrpc).toBe('2.0')\n-    expect(callToolResult.id).toBe('call-tool-1')\n-\n-    const content = callToolResult.result?.content\n-    expect(content).toBeInstanceOf(Array)\n-    expect(content?.[0]?.type).toBe('text')\n-\n-    // Get the actual project path from the response\n-    const actualProjectPath = content?.[0]?.text\n-\n-    // Project directory should match the test directory from the test harness\n-    expect(actualProjectPath).toBe(next.testDir)\n-  })\n-})"
        }
    ],
    "stats": {
        "total": 1171,
        "additions": 983,
        "deletions": 188
    }
}