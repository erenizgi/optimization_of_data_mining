{
    "author": "huozhi",
    "message": "[metadata] render streaming metadata on the top level (#77620)",
    "sha": "ee579bf166adbcba270d041e532be59fab999f34",
    "files": [
        {
            "sha": "0c601d2c0051b23a1ef9f28c08344d7cc8b77d61",
            "filename": "packages/next/src/client/components/router-reducer/reducers/find-head-in-cache.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 19,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -22,27 +22,16 @@ function findHeadInCacheImpl(\n \n   // First try the 'children' parallel route if it exists\n   // when starting from the \"root\", this corresponds with the main page component\n-  if (parallelRoutes.children) {\n-    const [segment, childParallelRoutes] = parallelRoutes.children\n-    const childSegmentMap = cache.parallelRoutes.get('children')\n-    if (childSegmentMap) {\n-      const cacheKey = createRouterCacheKey(segment)\n-      const cacheNode = childSegmentMap.get(cacheKey)\n-      if (cacheNode) {\n-        const item = findHeadInCacheImpl(\n-          cacheNode,\n-          childParallelRoutes,\n-          keyPrefix + '/' + cacheKey\n-        )\n-        if (item) return item\n-      }\n-    }\n-  }\n+  const parallelRoutesKeys = Object.keys(parallelRoutes).filter(\n+    (key) => key !== 'children'\n+  )\n \n-  // if we didn't find metadata in the page slot, check the other parallel routes\n-  for (const key in parallelRoutes) {\n-    if (key === 'children') continue // already checked above\n+  // if we are at the root, we need to check the children slot first\n+  if ('children' in parallelRoutes) {\n+    parallelRoutesKeys.unshift('children')\n+  }\n \n+  for (const key of parallelRoutesKeys) {\n     const [segment, childParallelRoutes] = parallelRoutes[key]\n     const childSegmentMap = cache.parallelRoutes.get(key)\n     if (!childSegmentMap) {"
        },
        {
            "sha": "1413bc4f110780d91a32bf26f912c51af4747f90",
            "filename": "packages/next/src/lib/metadata/metadata.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fmetadata.tsx?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -206,9 +206,11 @@ export function createMetadataComponents({\n     const promise = resolveFinalMetadata()\n     if (serveStreamingMetadata) {\n       return (\n-        <Suspense fallback={null}>\n-          <AsyncMetadata promise={promise} />\n-        </Suspense>\n+        <div hidden>\n+          <Suspense fallback={null}>\n+            <AsyncMetadata promise={promise} />\n+          </Suspense>\n+        </div>\n       )\n     }\n     const metadataState = await promise"
        },
        {
            "sha": "9e334353965edd68b07442329d75aec64e863b69",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 13,
            "deletions": 63,
            "changes": 76,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -245,6 +245,8 @@ interface ParseRequestHeadersOptions {\n }\n \n const flightDataPathHeadKey = 'h'\n+const getFlightViewportKey = (requestId: string) => requestId + 'v'\n+const getFlightMetadataKey = (requestId: string) => requestId + 'm'\n \n interface ParsedRequestHeaders {\n   /**\n@@ -336,30 +338,6 @@ function createNotFoundLoaderTree(loaderTree: LoaderTree): LoaderTree {\n   ]\n }\n \n-function createDivergedMetadataComponents(\n-  Metadata: React.ComponentType,\n-  serveStreamingMetadata: boolean\n-): {\n-  StaticMetadata: React.ComponentType<{}>\n-  StreamingMetadata: React.ComponentType<{}> | null\n-} {\n-  function EmptyMetadata() {\n-    return null\n-  }\n-  const StreamingMetadata: React.ComponentType | null = serveStreamingMetadata\n-    ? Metadata\n-    : null\n-\n-  const StaticMetadata: React.ComponentType<{}> = serveStreamingMetadata\n-    ? EmptyMetadata\n-    : Metadata\n-\n-  return {\n-    StaticMetadata,\n-    StreamingMetadata,\n-  }\n-}\n-\n /**\n  * Returns a function that parses the dynamic segment and return the associated value.\n  */\n@@ -527,14 +505,6 @@ async function generateDynamicRSCPayload(\n       serveStreamingMetadata,\n     })\n \n-    const { StreamingMetadata, StaticMetadata } =\n-      createDivergedMetadataComponents(() => {\n-        return (\n-          // Adding requestId as react key to make metadata remount for each render\n-          <MetadataTree key={requestId} />\n-        )\n-      }, serveStreamingMetadata)\n-\n     flightData = (\n       await walkTreeWithFlightRouterState({\n         ctx,\n@@ -551,9 +521,9 @@ async function generateDynamicRSCPayload(\n               isPossibleServerAction={ctx.isPossibleServerAction}\n             />\n             {/* Adding requestId as react key to make metadata remount for each render */}\n-            <ViewportTree key={requestId} />\n-            {StreamingMetadata ? <StreamingMetadata /> : null}\n-            <StaticMetadata />\n+            <ViewportTree key={getFlightViewportKey(requestId)} />\n+            {/* Not add requestId as react key to ensure segment prefetch could result consistently if nothing changed */}\n+            <MetadataTree key={getFlightMetadataKey(requestId)} />\n           </React.Fragment>\n         ),\n         injectedCSS: new Set(),\n@@ -857,14 +827,6 @@ async function getRSCPayload(\n \n   const preloadCallbacks: PreloadCallbacks = []\n \n-  const { StreamingMetadata, StaticMetadata } =\n-    createDivergedMetadataComponents(() => {\n-      return (\n-        // Not add requestId as react key to ensure segment prefetch could result consistently if nothing changed\n-        <MetadataTree />\n-      )\n-    }, serveStreamingMetadata)\n-\n   const seedData = await createComponentTree({\n     ctx,\n     loaderTree: tree,\n@@ -878,7 +840,6 @@ async function getRSCPayload(\n     missingSlots,\n     preloadCallbacks,\n     authInterrupts: ctx.renderOpts.experimental.authInterrupts,\n-    StreamingMetadata,\n     StreamingMetadataOutlet,\n   })\n \n@@ -896,8 +857,9 @@ async function getRSCPayload(\n         statusCode={ctx.res.statusCode}\n         isPossibleServerAction={ctx.isPossibleServerAction}\n       />\n-      <ViewportTree key={ctx.requestId} />\n-      <StaticMetadata />\n+      <ViewportTree key={getFlightViewportKey(ctx.requestId)} />\n+      {/* Not add requestId as react key to ensure segment prefetch could result consistently if nothing changed */}\n+      <MetadataTree />\n     </React.Fragment>\n   )\n \n@@ -984,16 +946,8 @@ async function getErrorRSCPayload(\n     serveStreamingMetadata: serveStreamingMetadata,\n   })\n \n-  const { StreamingMetadata, StaticMetadata } =\n-    createDivergedMetadataComponents(\n-      () => (\n-        <React.Fragment key={flightDataPathHeadKey}>\n-          {/* Adding requestId as react key to make metadata remount for each render */}\n-          <MetadataTree key={requestId} />\n-        </React.Fragment>\n-      ),\n-      serveStreamingMetadata\n-    )\n+  // {/* Adding requestId as react key to make metadata remount for each render */}\n+  const metadata = <MetadataTree key={getFlightMetadataKey(requestId)} />\n \n   const initialHead = (\n     <React.Fragment key={flightDataPathHeadKey}>\n@@ -1003,12 +957,11 @@ async function getErrorRSCPayload(\n         isPossibleServerAction={ctx.isPossibleServerAction}\n       />\n       {/* Adding requestId as react key to make metadata remount for each render */}\n-      <ViewportTree key={requestId} />\n+      <ViewportTree key={getFlightViewportKey(requestId)} />\n       {process.env.NODE_ENV === 'development' && (\n         <meta name=\"next-error\" content=\"not-found\" />\n       )}\n-      {StreamingMetadata ? <StreamingMetadata /> : null}\n-      <StaticMetadata />\n+      {metadata}\n     </React.Fragment>\n   )\n \n@@ -1028,10 +981,7 @@ async function getErrorRSCPayload(\n   const seedData: CacheNodeSeedData = [\n     initialTree[0],\n     <html id=\"__next_error__\">\n-      <head>\n-        {StreamingMetadata ? <StreamingMetadata /> : null}\n-        <StaticMetadata />\n-      </head>\n+      <head>{metadata}</head>\n       <body>\n         {process.env.NODE_ENV !== 'production' && err ? (\n           <template"
        },
        {
            "sha": "7a1cea2b90b906e965f856fc13fa55eb27d0e8c6",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -39,7 +39,6 @@ export function createComponentTree(props: {\n   missingSlots?: Set<string>\n   preloadCallbacks: PreloadCallbacks\n   authInterrupts: boolean\n-  StreamingMetadata: React.ComponentType | null\n   StreamingMetadataOutlet: React.ComponentType\n }): Promise<CacheNodeSeedData> {\n   return getTracer().trace(\n@@ -76,7 +75,6 @@ async function createComponentTreeInternal({\n   missingSlots,\n   preloadCallbacks,\n   authInterrupts,\n-  StreamingMetadata,\n   StreamingMetadataOutlet,\n }: {\n   loaderTree: LoaderTree\n@@ -91,7 +89,6 @@ async function createComponentTreeInternal({\n   missingSlots?: Set<string>\n   preloadCallbacks: PreloadCallbacks\n   authInterrupts: boolean\n-  StreamingMetadata: React.ComponentType | null\n   StreamingMetadataOutlet: React.ComponentType | null\n }): Promise<CacheNodeSeedData> {\n   const {\n@@ -390,7 +387,6 @@ async function createComponentTreeInternal({\n \n   // Resolve the segment param\n   const actualSegment = segmentParam ? segmentParam.treeSegment : segment\n-  const metadata = StreamingMetadata ? <StreamingMetadata /> : undefined\n \n   // Use the same condition to render metadataOutlet as metadata\n   const metadataOutlet = StreamingMetadataOutlet ? (\n@@ -513,7 +509,6 @@ async function createComponentTreeInternal({\n             missingSlots,\n             preloadCallbacks,\n             authInterrupts,\n-            StreamingMetadata: isChildrenRouteKey ? StreamingMetadata : null,\n             // `StreamingMetadataOutlet` is used to conditionally throw. In the case of parallel routes we will have more than one page\n             // but we only want to throw on the first one.\n             StreamingMetadataOutlet: isChildrenRouteKey\n@@ -699,12 +694,6 @@ async function createComponentTreeInternal({\n       actualSegment,\n       <React.Fragment key={cacheNodeKey}>\n         {pageElement}\n-        {/*\n-         * The order here matters since a parent might call findDOMNode().\n-         * findDOMNode() will return the first child if multiple children are rendered.\n-         * But React will hoist metadata into <head> which breaks scroll handling.\n-         */}\n-        {metadata}\n         {layerAssets}\n         <OutletBoundary>\n           <MetadataOutlet ready={getViewportReady} />"
        },
        {
            "sha": "d90beba53fcd543ba1a8440d7d18abcc56b028f7",
            "filename": "packages/next/src/server/app-render/walk-tree-with-flight-router-state.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwalk-tree-with-flight-router-state.tsx?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -202,7 +202,6 @@ export async function walkTreeWithFlightRouterState({\n         getMetadataReady,\n         preloadCallbacks,\n         authInterrupts: experimental.authInterrupts,\n-        StreamingMetadata: null,\n         StreamingMetadataOutlet,\n       }\n     )"
        },
        {
            "sha": "f24644af006a48ba2581bbb0dec87d9d2418799a",
            "filename": "test/e2e/esm-externals/app/client/page.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fapp%2Fclient%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fapp%2Fclient%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fesm-externals%2Fapp%2Fclient%2Fpage.js?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -6,8 +6,8 @@ import World3 from 'app-cjs-esm-package/entry'\n \n export default function Index() {\n   return (\n-    <div>\n+    <p>\n       Hello {World1}+{World2}+{World3}\n-    </div>\n+    </p>\n   )\n }"
        },
        {
            "sha": "cf273aaaa9179bb87282eef80140fef100056574",
            "filename": "test/e2e/esm-externals/app/server/page.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fapp%2Fserver%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fapp%2Fserver%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fesm-externals%2Fapp%2Fserver%2Fpage.js?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -4,8 +4,8 @@ import World3 from 'app-cjs-esm-package/entry'\n \n export default function Page() {\n   return (\n-    <div>\n+    <p>\n       Hello {World1}+{World2}+{World3}\n-    </div>\n+    </p>\n   )\n }"
        },
        {
            "sha": "9dc981eb3d989589beabb17fdfb724346d9bed6d",
            "filename": "test/e2e/esm-externals/esm-externals.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fesm-externals.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fesm-externals.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fesm-externals%2Fesm-externals.test.ts?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -28,15 +28,13 @@ describe('esm-externals', () => {\n \n     it('should return the correct SSR HTML', async () => {\n       const $ = await next.render$(url)\n-      const body = $('body > div > div').html()\n+      const body = $('body p').html()\n       expect(normalize(body)).toEqual(expectedHtml)\n     })\n \n     it('should render the correct page', async () => {\n       const browser = await next.browser(url)\n-      expect(await browser.elementByCss('body > div').text()).toEqual(\n-        expectedText\n-      )\n+      expect(await browser.elementByCss('body p').text()).toEqual(expectedText)\n     })\n   })\n \n@@ -54,13 +52,13 @@ describe('esm-externals', () => {\n \n     it('should return the correct SSR HTML', async () => {\n       const $ = await next.render$(url)\n-      const body = $('body > div').html()\n+      const body = $('body > p').html()\n       expect(normalize(body)).toEqual(expectedHtml)\n     })\n \n     it('should render the correct page', async () => {\n       const browser = await next.browser(url)\n-      expect(await browser.elementByCss('body > div').text()).toEqual(\n+      expect(await browser.elementByCss('body > p').text()).toEqual(\n         expectedText\n       )\n     })"
        },
        {
            "sha": "b1c438f8820c663405cadb3c6505c2e567ea15b5",
            "filename": "test/e2e/esm-externals/pages/ssg.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fpages%2Fssg.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fpages%2Fssg.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fesm-externals%2Fpages%2Fssg.js?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -13,8 +13,8 @@ export async function getStaticProps() {\n \n export default function Index({ worlds }) {\n   return (\n-    <div>\n+    <p>\n       Hello {World1}+{World2}+{World3}+{worlds}\n-    </div>\n+    </p>\n   )\n }"
        },
        {
            "sha": "a7a6350d6f504795b8d2f69084e85b8ba775ec0f",
            "filename": "test/e2e/esm-externals/pages/ssr.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fpages%2Fssr.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fpages%2Fssr.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fesm-externals%2Fpages%2Fssr.js?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -13,8 +13,8 @@ export function getServerSideProps() {\n \n export default function Index({ worlds }) {\n   return (\n-    <div>\n+    <p>\n       Hello {World1}+{World2}+{World3}+{worlds}\n-    </div>\n+    </p>\n   )\n }"
        },
        {
            "sha": "523919c09cc970c3c4c33356bdce7b53d9c61a26",
            "filename": "test/e2e/esm-externals/pages/static.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fpages%2Fstatic.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ee579bf166adbcba270d041e532be59fab999f34/test%2Fe2e%2Fesm-externals%2Fpages%2Fstatic.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fesm-externals%2Fpages%2Fstatic.js?ref=ee579bf166adbcba270d041e532be59fab999f34",
            "patch": "@@ -7,8 +7,8 @@ const worlds = 'World+World+World'\n \n export default function Index() {\n   return (\n-    <div>\n+    <p>\n       Hello {World1}+{World2}+{World3}+{worlds}\n-    </div>\n+    </p>\n   )\n }"
        }
    ],
    "stats": {
        "total": 153,
        "additions": 40,
        "deletions": 113
    }
}