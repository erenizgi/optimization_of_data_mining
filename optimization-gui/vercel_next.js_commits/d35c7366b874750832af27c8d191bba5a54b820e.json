{
    "author": "ztanner",
    "message": "fix: staleTimes.static should consistently enforce a 30s minimum (#85479)\n\nWhen the tree response sends back a static staleTime, we had handling to\nensure that it was at minimum 30s, because anything less would mean we'd\nbe discarding static cache entries more frequently than necessary.\nCurrently a value of 0 would result in a prefetch ping loop, because the\ncache value would be immediately invalidated.\n\nThis updates our config validation to warn about values lower than 30s\nand ensures the `getStaleTimeMs` function applies to the value read from\nenv, too.",
    "sha": "d35c7366b874750832af27c8d191bba5a54b820e",
    "files": [
        {
            "sha": "fd21877290c3bb949fe42d195a6ce2b54ad45877",
            "filename": "packages/next/src/client/components/router-reducer/reducers/navigate-reducer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts?ref=d35c7366b874750832af27c8d191bba5a54b820e",
            "patch": "@@ -15,15 +15,17 @@ import {\n   navigate as navigateUsingSegmentCache,\n   NavigationResultTag,\n   type NavigationResult,\n+  getStaleTimeMs,\n } from '../../segment-cache'\n \n // These values are set by `define-env-plugin` (based on `nextConfig.experimental.staleTimes`)\n // and default to 5 minutes (static) / 0 seconds (dynamic)\n export const DYNAMIC_STALETIME_MS =\n   Number(process.env.__NEXT_CLIENT_ROUTER_DYNAMIC_STALETIME) * 1000\n \n-export const STATIC_STALETIME_MS =\n-  Number(process.env.__NEXT_CLIENT_ROUTER_STATIC_STALETIME) * 1000\n+export const STATIC_STALETIME_MS = getStaleTimeMs(\n+  Number(process.env.__NEXT_CLIENT_ROUTER_STATIC_STALETIME)\n+)\n \n export function handleExternalUrl(\n   state: ReadonlyReducerState,"
        },
        {
            "sha": "8070d1999d9aedc035f2d6b0290b670e54a85ee5",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=d35c7366b874750832af27c8d191bba5a54b820e",
            "patch": "@@ -93,7 +93,7 @@ import {\n   DOC_PREFETCH_RANGE_HEADER_VALUE,\n   doesExportedHtmlMatchBuildId,\n } from '../../../shared/lib/segment-cache/output-export-prefetch-encoding'\n-import { FetchStrategy } from '../segment-cache'\n+import { FetchStrategy, getStaleTimeMs } from '../segment-cache'\n import { createPromiseWithResolvers } from '../../../shared/lib/promise-with-resolvers'\n \n // A note on async/await when working in the prefetch cache:\n@@ -267,14 +267,6 @@ const isOutputExportMode =\n   process.env.NODE_ENV === 'production' &&\n   process.env.__NEXT_CONFIG_OUTPUT === 'export'\n \n-/**\n- * Ensures a minimum stale time of 30s to avoid issues where the server sends a too\n- * short-lived stale time, which would prevent anything from being prefetched.\n- */\n-function getStaleTimeMs(staleTimeSeconds: number): number {\n-  return Math.max(staleTimeSeconds, 30) * 1000\n-}\n-\n // Route cache entries vary on multiple keys: the href and the Next-Url. Each of\n // these parts needs to be included in the internal cache key. Rather than\n // concatenate the keys into a single key, we use a multi-level map, where the"
        },
        {
            "sha": "ca556a8ad456340b88af232dfa1563a1515d4a6f",
            "filename": "packages/next/src/client/components/segment-cache.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache.ts?ref=d35c7366b874750832af27c8d191bba5a54b820e",
            "patch": "@@ -162,3 +162,11 @@ export type PrefetchTaskFetchStrategy =\n   | FetchStrategy.PPR\n   | FetchStrategy.PPRRuntime\n   | FetchStrategy.Full\n+\n+/**\n+ * Ensures a minimum stale time of 30s to avoid issues where the server sends a too\n+ * short-lived stale time, which would prevent anything from being prefetched.\n+ */\n+export function getStaleTimeMs(staleTimeSeconds: number): number {\n+  return Math.max(staleTimeSeconds, 30) * 1000\n+}"
        },
        {
            "sha": "d37661f51a57f02b2fb2122d7a8dcedbd6669a74",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=d35c7366b874750832af27c8d191bba5a54b820e",
            "patch": "@@ -172,7 +172,7 @@ export const experimentalSchema = {\n   staleTimes: z\n     .object({\n       dynamic: z.number().optional(),\n-      static: z.number().optional(),\n+      static: z.number().gte(30).optional(),\n     })\n     .optional(),\n   cacheLife: z"
        },
        {
            "sha": "3c6423d4c680e7a79639c69779ecd4f2d2695f5f",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d35c7366b874750832af27c8d191bba5a54b820e/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=d35c7366b874750832af27c8d191bba5a54b820e",
            "patch": "@@ -299,6 +299,7 @@ export interface ExperimentalConfig {\n    */\n   staleTimes?: {\n     dynamic?: number\n+    /** Must be greater than or equal to 30 seconds, to ensure prefetching is not completely wasteful */\n     static?: number\n   }\n   /**"
        }
    ],
    "stats": {
        "total": 27,
        "additions": 15,
        "deletions": 12
    }
}