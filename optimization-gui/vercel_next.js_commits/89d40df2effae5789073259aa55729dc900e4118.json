{
    "author": "timneutkens",
    "message": "Turbopack Build: Fix middleware rewrite test (#79697)\n\n## What?\n\nThe reason this test fails seems to be that the `browser.on('request'`\ngets registered too late and the requests are not tracked because of\nthat. Seems it can flake with webpack too. Switched to `beforePageLoad`\nto register it always. That switch makes the test consistently pass with\nTurbopack too.",
    "sha": "89d40df2effae5789073259aa55729dc900e4118",
    "files": [
        {
            "sha": "ab896c1cf6bd586bb897d4c495275af75c2035d0",
            "filename": "test/e2e/middleware-rewrites/test/index.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/89d40df2effae5789073259aa55729dc900e4118/test%2Fe2e%2Fmiddleware-rewrites%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/89d40df2effae5789073259aa55729dc900e4118/test%2Fe2e%2Fmiddleware-rewrites%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fmiddleware-rewrites%2Ftest%2Findex.test.ts?ref=89d40df2effae5789073259aa55729dc900e4118",
            "patch": "@@ -24,15 +24,19 @@ describe('Middleware Rewrite', () => {\n \n   function tests() {\n     it('should handle catch-all rewrite correctly', async () => {\n-      const browser = await next.browser('/', { waitHydration: false })\n+      let requests: string[] = []\n \n-      if (!(global as any).isNextDev) {\n-        let requests = []\n-\n-        browser.on('request', (req) => {\n-          requests.push(new URL(req.url()).pathname)\n-        })\n+      const browser = await next.browser('/', {\n+        waitHydration: false,\n+        beforePageLoad(page) {\n+          page.on('request', (request) => {\n+            const url = new URL(request.url())\n+            requests.push(url.pathname)\n+          })\n+        },\n+      })\n \n+      if (!(global as any).isNextDev) {\n         browser.elementByCss('#to-article-rewrite').moveTo()\n \n         await retry(async () => {"
        },
        {
            "sha": "5f705bb64b85820f7ffc1e6d4789ce9c8be57dfd",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/89d40df2effae5789073259aa55729dc900e4118/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/89d40df2effae5789073259aa55729dc900e4118/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=89d40df2effae5789073259aa55729dc900e4118",
            "patch": "@@ -7573,9 +7573,10 @@\n       \"Middleware Rewrite should rewrite to the external url for incoming data request externally rewritten\",\n       \"Middleware Rewrite should rewrite when not using localhost\",\n       \"Middleware Rewrite should rewrite without hard navigation\",\n-      \"Middleware Rewrite support colons in path\"\n+      \"Middleware Rewrite support colons in path\",\n+      \"Middleware Rewrite should handle catch-all rewrite correctly\"\n     ],\n-    \"failed\": [\"Middleware Rewrite should handle catch-all rewrite correctly\"],\n+    \"failed\": [],\n     \"pending\": [\n       \"Middleware Rewrite includes the locale in rewrites by default\"\n     ],"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 14,
        "deletions": 9
    }
}