{
    "author": "lubieowoce",
    "message": "test: attempt to de-flake graceful shutdown test (#78464)\n\nthe test has been flaking recently because (i guess) it takes a bit\nlonger for the app to start rejecting new requests than the test was\nexpecting. i wrapped the assertion in a `retry` so that the test is\nresillient to that.\n\ni've applied the same changes to a previously skipped test and\nun-skipped it -- i'm hoping it's gonna be okay now. also removed some\nunnecessary assertions about the app still being active at a given\npoint, we don't really care about that.",
    "sha": "952450fe4e7d50a6971baf1802404d174e7d1779",
    "files": [
        {
            "sha": "8a68ce127561eb01b09eb774b8f36f80083245cd",
            "filename": "test/production/graceful-shutdown/index.test.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 20,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/952450fe4e7d50a6971baf1802404d174e7d1779/test%2Fproduction%2Fgraceful-shutdown%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/952450fe4e7d50a6971baf1802404d174e7d1779/test%2Fproduction%2Fgraceful-shutdown%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fgraceful-shutdown%2Findex.test.ts?ref=952450fe4e7d50a6971baf1802404d174e7d1779",
            "patch": "@@ -8,6 +8,7 @@ import {\n   launchApp,\n   nextBuild,\n   nextStart,\n+  retry,\n   waitFor,\n } from 'next-test-utils'\n import fs from 'fs-extra'\n@@ -99,7 +100,7 @@ describe('Graceful Shutdown', () => {\n       appPort = await findPort()\n       app = await initNextServerScript(\n         serverFile,\n-        /- Local:/,\n+        /âœ“ Ready in \\d+m?s/,\n         {\n           ...process.env,\n           NEXT_EXIT_TIMEOUT_MS: '10',\n@@ -185,8 +186,7 @@ function runTests(dev = false) {\n     })\n \n     describe('should not accept new requests during shutdown cleanup', () => {\n-      // TODO: investigate this is constantly failing\n-      it.skip('when request is made before shutdown', async () => {\n+      it('should finish pending requests but refuse new ones', async () => {\n         const appKilledPromise = once(app, 'exit')\n \n         const resPromise = fetchViaHTTP(appPort, '/api/long-running')\n@@ -196,40 +196,34 @@ function runTests(dev = false) {\n         process.kill(app.pid, 'SIGTERM')\n         expect(app.exitCode).toBe(null)\n \n-        // Long running response should still be running after a bit\n-        await waitFor(LONG_RUNNING_MS / 2)\n-        expect(app.exitCode).toBe(null)\n-\n-        // Second request should be rejected\n-        await expect(\n-          fetchViaHTTP(appPort, '/api/long-running')\n-        ).rejects.toThrow()\n+        // The app should start rejecting new connections soon\n+        await waitForAppToStartRefusingConnections(\n+          () => fetchViaHTTP(appPort, '/api/fast'),\n+          1000\n+        )\n \n         // Original request responds as expected without being interrupted\n         await expect(resPromise).resolves.toBeDefined()\n         const res = await resPromise\n         expect(res.status).toBe(200)\n         expect(await res.json()).toStrictEqual({ hello: 'world' })\n \n-        // App is still running briefly after response returns\n-        expect(app.exitCode).toBe(null)\n-\n         // App finally shuts down\n         expect(await appKilledPromise).toEqual([0, null])\n         expect(app.exitCode).toBe(0)\n       })\n \n-      it('when there is no activity', async () => {\n+      it('should stop accepting new requests when shutting down', async () => {\n         const appKilledPromise = once(app, 'exit')\n \n         process.kill(app.pid, 'SIGTERM')\n         expect(app.exitCode).toBe(null)\n \n-        // yield event loop to allow server to start the shutdown process\n-        await waitFor(20)\n-        await expect(\n-          fetchViaHTTP(appPort, '/api/long-running')\n-        ).rejects.toThrow()\n+        // The app should start rejecting connections soon\n+        await waitForAppToStartRefusingConnections(\n+          () => fetchViaHTTP(appPort, '/api/fast'),\n+          1000\n+        )\n \n         // App finally shuts down\n         expect(await appKilledPromise).toEqual([0, null])\n@@ -238,3 +232,22 @@ function runTests(dev = false) {\n     })\n   }\n }\n+\n+async function waitForAppToStartRefusingConnections(\n+  sendRequest: () => Promise<import('node-fetch').Response>,\n+  maxDuration: number\n+) {\n+  // shutdown is async and can take a moment, so this is retried\n+  await retry(\n+    async () => {\n+      await expect(sendRequest).rejects.toEqual(\n+        expect.objectContaining({\n+          code: 'ECONNREFUSED',\n+        })\n+      )\n+    },\n+    maxDuration,\n+    100,\n+    'wait for app to start rejecting connections'\n+  )\n+}"
        },
        {
            "sha": "c0a56b66413f7353c99168e113d26180b5345714",
            "filename": "test/production/graceful-shutdown/src/pages/api/fast.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/952450fe4e7d50a6971baf1802404d174e7d1779/test%2Fproduction%2Fgraceful-shutdown%2Fsrc%2Fpages%2Fapi%2Ffast.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/952450fe4e7d50a6971baf1802404d174e7d1779/test%2Fproduction%2Fgraceful-shutdown%2Fsrc%2Fpages%2Fapi%2Ffast.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fgraceful-shutdown%2Fsrc%2Fpages%2Fapi%2Ffast.ts?ref=952450fe4e7d50a6971baf1802404d174e7d1779",
            "patch": "@@ -0,0 +1,5 @@\n+import { NextApiRequest, NextApiResponse } from 'next'\n+\n+export default async (_req: NextApiRequest, res: NextApiResponse) => {\n+  res.json({ hello: 'world' })\n+}"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 38,
        "deletions": 20
    }
}