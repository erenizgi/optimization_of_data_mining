{
    "author": "eps1lon",
    "message": "[dev-overlay] Remove indirection in app dev error boundary  (#79984)\n\nDoesn't need to be put in JSX children and can directly returned from render.\r\n\r\nAllows for cleaner code separation with the future dedicated dev overlay bundle.",
    "sha": "dcf28ec0aec1795a4891a7254602c27c8f076cd9",
    "files": [
        {
            "sha": "cd283fc724d96d829dad40fd2303e3f4a53a8211",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/app-dev-overlay.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 64,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/dcf28ec0aec1795a4891a7254602c27c8f076cd9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcf28ec0aec1795a4891a7254602c27c8f076cd9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fapp-dev-overlay.tsx?ref=dcf28ec0aec1795a4891a7254602c27c8f076cd9",
            "patch": "@@ -5,72 +5,10 @@ import {\n } from '../shared'\n import type { GlobalErrorComponent } from '../../global-error'\n \n-import { useCallback, useEffect } from 'react'\n+import { useCallback } from 'react'\n import { AppDevOverlayErrorBoundary } from './app-dev-overlay-error-boundary'\n import { FontStyles } from '../font/font-styles'\n import { DevOverlay } from '../ui/dev-overlay'\n-import { handleClientError } from '../../errors/use-error-handler'\n-import { isNextRouterError } from '../../is-next-router-error'\n-import { MISSING_ROOT_TAGS_ERROR } from '../../../../shared/lib/errors/constants'\n-\n-function readSsrError(): (Error & { digest?: string }) | null {\n-  if (typeof document === 'undefined') {\n-    return null\n-  }\n-\n-  const ssrErrorTemplateTag = document.querySelector(\n-    'template[data-next-error-message]'\n-  )\n-  if (ssrErrorTemplateTag) {\n-    const message: string = ssrErrorTemplateTag.getAttribute(\n-      'data-next-error-message'\n-    )!\n-    const stack = ssrErrorTemplateTag.getAttribute('data-next-error-stack')\n-    const digest = ssrErrorTemplateTag.getAttribute('data-next-error-digest')\n-    const error = new Error(message)\n-    if (digest) {\n-      ;(error as any).digest = digest\n-    }\n-    // Skip Next.js SSR'd internal errors that which will be handled by the error boundaries.\n-    if (isNextRouterError(error)) {\n-      return null\n-    }\n-    error.stack = stack || ''\n-    return error\n-  }\n-\n-  return null\n-}\n-\n-// Needs to be in the same error boundary as the shell.\n-// If it commits, we know we recovered from an SSR error.\n-// If it doesn't commit, we errored again and React will take care of error reporting.\n-function ReplaySsrOnlyErrors({\n-  onBlockingError,\n-}: {\n-  onBlockingError: () => void\n-}) {\n-  if (process.env.NODE_ENV !== 'production') {\n-    // Need to read during render. The attributes will be gone after commit.\n-    const ssrError = readSsrError()\n-    // eslint-disable-next-line react-hooks/rules-of-hooks\n-    useEffect(() => {\n-      if (ssrError !== null) {\n-        // TODO(veil): Include original Owner Stack (NDX-905)\n-        // TODO(veil): Mark as recoverable error\n-        // TODO(veil): console.error\n-        handleClientError(ssrError)\n-\n-        // If it's missing root tags, we can't recover, make it blocking.\n-        if (ssrError.digest === MISSING_ROOT_TAGS_ERROR) {\n-          onBlockingError()\n-        }\n-      }\n-    }, [ssrError, onBlockingError])\n-  }\n-\n-  return null\n-}\n \n function getSquashedHydrationErrorDetails() {\n   // We don't squash hydration errors in the App Router.\n@@ -98,7 +36,6 @@ export function AppDevOverlay({\n         globalError={globalError}\n         onError={openOverlay}\n       >\n-        <ReplaySsrOnlyErrors onBlockingError={openOverlay} />\n         {children}\n       </AppDevOverlayErrorBoundary>\n       <>"
        },
        {
            "sha": "ad2778cca1256e7eff0cc4b77cd1ba81dc81d293",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/hot-reloader-client.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/dcf28ec0aec1795a4891a7254602c27c8f076cd9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcf28ec0aec1795a4891a7254602c27c8f076cd9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx?ref=dcf28ec0aec1795a4891a7254602c27c8f076cd9",
            "patch": "@@ -11,6 +11,7 @@ import {\n   ACTION_BUILD_OK,\n   ACTION_DEBUG_INFO,\n   ACTION_DEV_INDICATOR,\n+  ACTION_ERROR_OVERLAY_OPEN,\n   ACTION_REFRESH,\n   ACTION_STATIC_INDICATOR,\n   ACTION_UNHANDLED_ERROR,\n@@ -21,6 +22,7 @@ import {\n   useErrorOverlayReducer,\n } from '../shared'\n import { AppDevOverlay } from './app-dev-overlay'\n+import { ReplaySsrOnlyErrors } from './replay-ssr-only-errors'\n import { useErrorHandler } from '../../errors/use-error-handler'\n import { RuntimeErrorHandler } from '../../errors/runtime-error-handler'\n import {\n@@ -58,6 +60,7 @@ export interface Dispatcher {\n   onDevIndicator(devIndicator: DevIndicatorServerState): void\n   onUnhandledError(error: Error): void\n   onUnhandledRejection(error: Error): void\n+  openErrorOverlay(): void\n }\n \n let mostRecentCompilationHash: any = null\n@@ -529,6 +532,9 @@ export default function HotReload({\n           reason: error,\n         })\n       },\n+      openErrorOverlay() {\n+        dispatch({ type: ACTION_ERROR_OVERLAY_OPEN })\n+      },\n     }\n   }, [dispatch])\n \n@@ -618,6 +624,7 @@ export default function HotReload({\n \n   return (\n     <AppDevOverlay state={state} dispatch={dispatch} globalError={globalError}>\n+      <ReplaySsrOnlyErrors onBlockingError={dispatcher.openErrorOverlay} />\n       {children}\n     </AppDevOverlay>\n   )"
        },
        {
            "sha": "bc7196e89b3b331808562bd8fa8a00bbbf1c978c",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/replay-ssr-only-errors.tsx",
            "status": "added",
            "additions": 65,
            "deletions": 0,
            "changes": 65,
            "blob_url": "https://github.com/vercel/next.js/blob/dcf28ec0aec1795a4891a7254602c27c8f076cd9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Freplay-ssr-only-errors.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcf28ec0aec1795a4891a7254602c27c8f076cd9/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Freplay-ssr-only-errors.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Freplay-ssr-only-errors.tsx?ref=dcf28ec0aec1795a4891a7254602c27c8f076cd9",
            "patch": "@@ -0,0 +1,65 @@\n+import { useEffect } from 'react'\n+import { handleClientError } from '../../errors/use-error-handler'\n+import { isNextRouterError } from '../../is-next-router-error'\n+import { MISSING_ROOT_TAGS_ERROR } from '../../../../shared/lib/errors/constants'\n+\n+function readSsrError(): (Error & { digest?: string }) | null {\n+  if (typeof document === 'undefined') {\n+    return null\n+  }\n+\n+  const ssrErrorTemplateTag = document.querySelector(\n+    'template[data-next-error-message]'\n+  )\n+  if (ssrErrorTemplateTag) {\n+    const message: string = ssrErrorTemplateTag.getAttribute(\n+      'data-next-error-message'\n+    )!\n+    const stack = ssrErrorTemplateTag.getAttribute('data-next-error-stack')\n+    const digest = ssrErrorTemplateTag.getAttribute('data-next-error-digest')\n+    const error = new Error(message)\n+    if (digest) {\n+      ;(error as any).digest = digest\n+    }\n+    // Skip Next.js SSR'd internal errors that which will be handled by the error boundaries.\n+    if (isNextRouterError(error)) {\n+      return null\n+    }\n+    error.stack = stack || ''\n+    return error\n+  }\n+\n+  return null\n+}\n+\n+/**\n+ * Needs to be in the same error boundary as the shell.\n+ * If it commits, we know we recovered from an SSR error.\n+ * If it doesn't commit, we errored again and React will take care of error reporting.\n+ */\n+export function ReplaySsrOnlyErrors({\n+  onBlockingError,\n+}: {\n+  onBlockingError: () => void\n+}) {\n+  if (process.env.NODE_ENV !== 'production') {\n+    // Need to read during render. The attributes will be gone after commit.\n+    const ssrError = readSsrError()\n+    // eslint-disable-next-line react-hooks/rules-of-hooks\n+    useEffect(() => {\n+      if (ssrError !== null) {\n+        // TODO(veil): Include original Owner Stack (NDX-905)\n+        // TODO(veil): Mark as recoverable error\n+        // TODO(veil): console.error\n+        handleClientError(ssrError)\n+\n+        // If it's missing root tags, we can't recover, make it blocking.\n+        if (ssrError.digest === MISSING_ROOT_TAGS_ERROR) {\n+          onBlockingError()\n+        }\n+      }\n+    }, [ssrError, onBlockingError])\n+  }\n+\n+  return null\n+}"
        }
    ],
    "stats": {
        "total": 137,
        "additions": 73,
        "deletions": 64
    }
}