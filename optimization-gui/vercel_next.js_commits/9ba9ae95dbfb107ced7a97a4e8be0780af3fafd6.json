{
    "author": "sokra",
    "message": "Turbopack: fix corrected time calcuation for trace server (#77080)\n\n### What?\n\nIt did show incorrect corrected time for large spans",
    "sha": "9ba9ae95dbfb107ced7a97a4e8be0780af3fafd6",
    "files": [
        {
            "sha": "47487dc58248fbb0f7476657ac2b7dce47c372b4",
            "filename": "turbopack/crates/turbopack-trace-server/src/self_time_tree.rs",
            "status": "modified",
            "additions": 44,
            "deletions": 6,
            "changes": 50,
            "blob_url": "https://github.com/vercel/next.js/blob/9ba9ae95dbfb107ced7a97a4e8be0780af3fafd6/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fself_time_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ba9ae95dbfb107ced7a97a4e8be0780af3fafd6/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fself_time_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fself_time_tree.rs?ref=9ba9ae95dbfb107ced7a97a4e8be0780af3fafd6",
            "patch": "@@ -1,7 +1,4 @@\n-use std::{\n-    cmp::{max, min},\n-    mem::take,\n-};\n+use std::mem::take;\n \n use crate::timestamp::Timestamp;\n \n@@ -189,12 +186,13 @@ impl<T> SelfTimeTree<T> {\n         }\n     }\n \n+    #[cfg(test)]\n     pub fn lookup_range_count(&self, start: Timestamp, end: Timestamp) -> Timestamp {\n         let mut total_count = Timestamp::ZERO;\n         for entry in &self.entries {\n             if entry.start < end && entry.end > start {\n-                let start = max(entry.start, start);\n-                let end = min(entry.end, end);\n+                let start = std::cmp::max(entry.start, start);\n+                let end = std::cmp::min(entry.end, end);\n                 let span = end - start;\n                 total_count += span;\n             }\n@@ -210,6 +208,46 @@ impl<T> SelfTimeTree<T> {\n         total_count\n     }\n \n+    pub fn lookup_range_corrected_time(&self, start: Timestamp, end: Timestamp) -> Timestamp {\n+        let mut factor_times_1000 = 0u64;\n+        #[derive(PartialEq, Eq, PartialOrd, Ord)]\n+        enum Change {\n+            Start,\n+            End,\n+        }\n+        let mut current_count = 0;\n+        let mut changes = Vec::new();\n+        self.for_each_in_range(start, end, |s, e, _| {\n+            if s <= start {\n+                current_count += 1;\n+            } else {\n+                changes.push((s, Change::Start));\n+            }\n+            if e < end {\n+                changes.push((e, Change::End));\n+            }\n+        });\n+        changes.sort_unstable();\n+        let mut current_ts = start;\n+        for (ts, change) in changes {\n+            if current_ts < ts {\n+                // Move time\n+                let time_diff = ts - current_ts;\n+                factor_times_1000 += *time_diff * 1000 / current_count;\n+                current_ts = ts;\n+            }\n+            match change {\n+                Change::Start => current_count += 1,\n+                Change::End => current_count -= 1,\n+            }\n+        }\n+        if current_ts < end {\n+            let time_diff = end - current_ts;\n+            factor_times_1000 += *time_diff * 1000 / current_count;\n+        }\n+        Timestamp::from_value(factor_times_1000 / 1000)\n+    }\n+\n     pub fn for_each_in_range(\n         &self,\n         start: Timestamp,"
        },
        {
            "sha": "009fba574e036f7f8c70e10ef79e865d4ceab7e0",
            "filename": "turbopack/crates/turbopack-trace-server/src/span_ref.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9ba9ae95dbfb107ced7a97a4e8be0780af3fafd6/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_ref.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9ba9ae95dbfb107ced7a97a4e8be0780af3fafd6/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_ref.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-server%2Fsrc%2Fspan_ref.rs?ref=9ba9ae95dbfb107ced7a97a4e8be0780af3fafd6",
            "patch": "@@ -280,11 +280,11 @@ impl<'a> SpanRef<'a> {\n                         let duration = *end - *start;\n                         if !duration.is_zero() {\n                             store.set_max_self_time_lookup(*end);\n-                            let concurrent_time = store\n-                                .self_time_tree\n-                                .as_ref()\n-                                .map_or(duration, |tree| tree.lookup_range_count(*start, *end));\n-                            return Some(duration * *duration / *concurrent_time);\n+                            let corrected_time =\n+                                store.self_time_tree.as_ref().map_or(duration, |tree| {\n+                                    tree.lookup_range_corrected_time(*start, *end)\n+                                });\n+                            return Some(corrected_time);\n                         }\n                     }\n                     None"
        }
    ],
    "stats": {
        "total": 60,
        "additions": 49,
        "deletions": 11
    }
}