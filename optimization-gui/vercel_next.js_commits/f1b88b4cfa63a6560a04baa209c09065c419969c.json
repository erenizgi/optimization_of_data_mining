{
    "author": "mischnic",
    "message": "Turbopack: content-hash PageLoaderAsset (#81450)\n\nCloses PACK-5035\n\n- [x] Content hash chunks such as `static/chunks/pages/404.js` with  `static/chunks/19a8e82e8f.js` instead\n- [x] Including the actual path in `_buildManifest.js`\n- [x] Update tests to check the path specified in the manifest",
    "sha": "f1b88b4cfa63a6560a04baa209c09065c419969c",
    "files": [
        {
            "sha": "1bfaa84b22ea5a8029dbfff6f9c0f41f5b2948aa",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -866,11 +866,22 @@ impl PageEndpoint {\n         let project = this.pages_project.project();\n         let node_root = project.client_root().owned().await?;\n         let client_relative_path = self.client_relative_path();\n+        // In development mode, don't include a content hash and put the chunk at e.g.\n+        // `static/chunks/pages/page2.js`, so that the dev runtime can request it at a known path.\n+        // https://github.com/vercel/next.js/blob/84873e00874e096e6c4951dcf070e8219ed414e5/packages/next/src/client/route-loader.ts#L256-L271\n+        let use_fixed_path = this\n+            .pages_project\n+            .project()\n+            .next_mode()\n+            .await?\n+            .is_development();\n         let page_loader = PageLoaderAsset::new(\n             node_root,\n             this.pathname.clone(),\n             client_relative_path,\n             client_chunks,\n+            project.client_chunking_context(),\n+            use_fixed_path,\n         );\n         Ok(Vc::upcast(page_loader))\n     }\n@@ -1306,6 +1317,30 @@ impl PageEndpoint {\n         ))\n     }\n \n+    #[turbo_tasks::function]\n+    async fn client_build_manifest(\n+        self: Vc<Self>,\n+        page_loader: ResolvedVc<Box<dyn OutputAsset>>,\n+    ) -> Result<Vc<Box<dyn OutputAsset>>> {\n+        let this = self.await?;\n+        let node_root = this.pages_project.project().node_root().await?;\n+        let client_relative_path = this.pages_project.project().client_relative_path().await?;\n+        let page_loader_path = client_relative_path\n+            .get_relative_path_to(&*page_loader.path().await?)\n+            .context(\"failed to resolve client-relative path to page loader\")?;\n+        let client_build_manifest = fxindexmap!(this.pathname.clone() => vec![page_loader_path]);\n+        let manifest_path_prefix = get_asset_prefix_from_pathname(&this.pathname);\n+        Ok(Vc::upcast(VirtualOutputAsset::new_with_references(\n+            node_root.join(&format!(\n+                \"server/pages{manifest_path_prefix}/client-build-manifest.json\",\n+            ))?,\n+            AssetContent::file(\n+                File::from(serde_json::to_string_pretty(&client_build_manifest)?).into(),\n+            ),\n+            Vc::cell(vec![page_loader]),\n+        )))\n+    }\n+\n     #[turbo_tasks::function]\n     async fn output(self: Vc<Self>) -> Result<Vc<PageEndpointOutput>> {\n         let this = self.await?;\n@@ -1319,8 +1354,13 @@ impl PageEndpoint {\n                 client_assets.extend(client_chunks.await?.iter().map(|asset| **asset));\n                 let build_manifest = self.build_manifest(client_chunks).to_resolved().await?;\n                 let page_loader = self.page_loader(client_chunks);\n+                let client_build_manifest = self\n+                    .client_build_manifest(page_loader)\n+                    .to_resolved()\n+                    .await?;\n                 client_assets.push(page_loader);\n                 server_assets.push(build_manifest);\n+                server_assets.push(client_build_manifest);\n                 self.ssr_chunk()\n             }\n             PageEndpointType::Data => self.ssr_data_chunk(),"
        },
        {
            "sha": "9ac6eb421ff3f033874025050e98c34bf2a1ee74",
            "filename": "crates/next-core/src/page_loader.rs",
            "status": "modified",
            "additions": 34,
            "deletions": 13,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fpage_loader.rs?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -8,8 +8,9 @@ use turbo_tasks_fs::{\n };\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n-    chunk::{ChunkData, ChunksData},\n+    chunk::{ChunkData, ChunkingContext, ChunksData},\n     context::AssetContext,\n+    ident::AssetIdent,\n     module::Module,\n     output::{OutputAsset, OutputAssets},\n     proxied_asset::ProxiedAsset,\n@@ -73,6 +74,8 @@ pub struct PageLoaderAsset {\n     pub pathname: RcStr,\n     pub rebase_prefix_path: ResolvedVc<FileSystemPathOption>,\n     pub page_chunks: ResolvedVc<OutputAssets>,\n+    pub chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n+    pub use_fixed_path: bool,\n }\n \n #[turbo_tasks::value_impl]\n@@ -83,12 +86,16 @@ impl PageLoaderAsset {\n         pathname: RcStr,\n         rebase_prefix_path: ResolvedVc<FileSystemPathOption>,\n         page_chunks: ResolvedVc<OutputAssets>,\n+        chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n+        use_fixed_path: bool,\n     ) -> Vc<Self> {\n         Self {\n             server_root,\n             pathname,\n             rebase_prefix_path,\n             page_chunks,\n+            chunking_context,\n+            use_fixed_path,\n         }\n         .cell()\n     }\n@@ -134,21 +141,35 @@ impl PageLoaderAsset {\n     }\n }\n \n+impl PageLoaderAsset {\n+    async fn ident_for_path(&self) -> Result<Vc<AssetIdent>> {\n+        let rebase_prefix_path = self.rebase_prefix_path.await?;\n+        let root = rebase_prefix_path.as_ref().unwrap_or(&self.server_root);\n+        Ok(AssetIdent::from_path(root.join(&format!(\n+            \"static/chunks/pages{}\",\n+            get_asset_path_from_pathname(&self.pathname, \".js\")\n+        ))?)\n+        .with_modifier(rcstr!(\"page loader asset\")))\n+    }\n+}\n+\n #[turbo_tasks::value_impl]\n impl OutputAsset for PageLoaderAsset {\n     #[turbo_tasks::function]\n-    async fn path(&self) -> Result<Vc<FileSystemPath>> {\n-        let root = self\n-            .rebase_prefix_path\n-            .owned()\n-            .await?\n-            .map_or(self.server_root.clone(), |path| path);\n-        Ok(root\n-            .join(&format!(\n-                \"static/chunks/pages{}\",\n-                get_asset_path_from_pathname(&self.pathname, \".js\")\n-            ))?\n-            .cell())\n+    async fn path(self: Vc<Self>) -> Result<Vc<FileSystemPath>> {\n+        let this = self.await?;\n+        let ident = this.ident_for_path().await?;\n+        if this.use_fixed_path {\n+            // In development mode, don't include a content hash and put the chunk at e.g.\n+            // `static/chunks/pages/page2.js`, so that the dev runtime can request it at a known\n+            // path.\n+            // https://github.com/vercel/next.js/blob/84873e00874e096e6c4951dcf070e8219ed414e5/packages/next/src/client/route-loader.ts#L256-L271\n+            Ok(ident.path())\n+        } else {\n+            Ok(this\n+                .chunking_context\n+                .chunk_path(Some(Vc::upcast(self)), ident, rcstr!(\".js\")))\n+        }\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "5fbe78c1d3a0dd7f6142d7616b90aa9c77487e5c",
            "filename": "packages/next/src/build/handle-entrypoints.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-entrypoints.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-entrypoints.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-entrypoints.ts?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -69,6 +69,7 @@ export async function handleRouteType({\n     case 'page': {\n       const serverKey = getEntryKey('pages', 'server', page)\n \n+      await manifestLoader.loadClientBuildManifest(page)\n       await manifestLoader.loadBuildManifest(page)\n       await manifestLoader.loadPagesManifest(page)\n "
        },
        {
            "sha": "3ab1fc5fb2498f76f2e75f1910bac54a753075b4",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -180,6 +180,7 @@ export async function turbopackBuild(): Promise<{\n       manifestLoader.loadPagesManifest('_app'),\n       manifestLoader.loadFontManifest('_app'),\n       manifestLoader.loadPagesManifest('_document'),\n+      manifestLoader.loadClientBuildManifest('_error'),\n       manifestLoader.loadBuildManifest('_error'),\n       manifestLoader.loadPagesManifest('_error'),\n       manifestLoader.loadFontManifest('_error'),"
        },
        {
            "sha": "b1d5a1583571e6be5a2f2050f057a6cb06a1eaf9",
            "filename": "packages/next/src/server/dev/turbopack-utils.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fturbopack-utils.ts?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -226,6 +226,7 @@ export async function handleRouteType({\n \n         const type = writtenEndpoint?.type\n \n+        await manifestLoader.loadClientBuildManifest(page)\n         await manifestLoader.loadBuildManifest(page)\n         await manifestLoader.loadPagesManifest(page)\n         if (type === 'edge') {\n@@ -942,6 +943,7 @@ export async function handlePagesErrorRoute({\n     )\n     processIssues(currentEntryIssues, key, writtenEndpoint, false, logErrors)\n   }\n+  await manifestLoader.loadClientBuildManifest('_error')\n   await manifestLoader.loadBuildManifest('_error')\n   await manifestLoader.loadPagesManifest('_error')\n   await manifestLoader.loadFontManifest('_error')"
        },
        {
            "sha": "d966b3d6fa4de4aa53ef86af43034dde00044ec3",
            "filename": "packages/next/src/shared/lib/constants.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -47,6 +47,7 @@ export const DEV_CLIENT_PAGES_MANIFEST = '_devPagesManifest.json'\n export const MIDDLEWARE_MANIFEST = 'middleware-manifest.json'\n export const TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST =\n   '_clientMiddlewareManifest.json'\n+export const TURBOPACK_CLIENT_BUILD_MANIFEST = 'client-build-manifest.json'\n export const DEV_CLIENT_MIDDLEWARE_MANIFEST = '_devMiddlewareManifest.json'\n export const REACT_LOADABLE_MANIFEST = 'react-loadable-manifest.json'\n export const SERVER_DIRECTORY = 'server'"
        },
        {
            "sha": "dee5792aa7206708e9cc1b44a9c37f1c406e3d73",
            "filename": "packages/next/src/shared/lib/turbopack/manifest-loader.ts",
            "status": "modified",
            "additions": 42,
            "deletions": 18,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -26,6 +26,7 @@ import {\n   NEXT_FONT_MANIFEST,\n   PAGES_MANIFEST,\n   SERVER_REFERENCE_MANIFEST,\n+  TURBOPACK_CLIENT_BUILD_MANIFEST,\n   TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST,\n   WEBPACK_STATS,\n } from '../constants'\n@@ -74,6 +75,7 @@ type ManifestName =\n   | `${typeof SERVER_REFERENCE_MANIFEST}.json`\n   | `${typeof NEXT_FONT_MANIFEST}.json`\n   | typeof REACT_LOADABLE_MANIFEST\n+  | typeof TURBOPACK_CLIENT_BUILD_MANIFEST\n \n const getManifestPath = (\n   page: string,\n@@ -135,6 +137,7 @@ export class TurbopackManifestLoader {\n   private appBuildManifests: Map<EntryKey, AppBuildManifest> = new Map()\n   private appPathsManifests: Map<EntryKey, PagesManifest> = new Map()\n   private buildManifests: Map<EntryKey, BuildManifest> = new Map()\n+  private clientBuildManifests: Map<EntryKey, ClientBuildManifest> = new Map()\n   private fontManifests: Map<EntryKey, NextFontManifest> = new Map()\n   private middlewareManifests: Map<EntryKey, TurbopackMiddlewareManifest> =\n     new Map()\n@@ -164,6 +167,7 @@ export class TurbopackManifestLoader {\n     this.appBuildManifests.delete(key)\n     this.appPathsManifests.delete(key)\n     this.buildManifests.delete(key)\n+    this.clientBuildManifests.delete(key)\n     this.fontManifests.delete(key)\n     this.middlewareManifests.delete(key)\n     this.pagesManifests.delete(key)\n@@ -326,6 +330,21 @@ export class TurbopackManifestLoader {\n     )\n   }\n \n+  async loadClientBuildManifest(\n+    pageName: string,\n+    type: 'app' | 'pages' = 'pages'\n+  ): Promise<void> {\n+    this.clientBuildManifests.set(\n+      getEntryKey(type, 'server', pageName),\n+      await readPartialManifest(\n+        this.distDir,\n+        TURBOPACK_CLIENT_BUILD_MANIFEST,\n+        pageName,\n+        type\n+      )\n+    )\n+  }\n+\n   async loadWebpackStats(\n     pageName: string,\n     type: 'app' | 'pages' = 'pages'\n@@ -422,6 +441,21 @@ export class TurbopackManifestLoader {\n     return manifest\n   }\n \n+  private mergeClientBuildManifests(\n+    rewrites: CustomRoutes['rewrites'],\n+    manifests: Iterable<ClientBuildManifest>,\n+    sortedPageKeys: string[]\n+  ): ClientBuildManifest {\n+    const manifest = {\n+      __rewrites: normalizeRewritesForBuildManifest(rewrites) as any,\n+      sortedPages: sortedPageKeys,\n+    }\n+    for (const m of manifests) {\n+      Object.assign(manifest, m)\n+    }\n+    return sortObjectByKey(manifest)\n+  }\n+\n   private async writeBuildManifest(\n     entrypoints: Entrypoints,\n     devRewrites: SetupOpts['fsChecker']['rewrites'] | undefined,\n@@ -479,25 +513,15 @@ export class TurbopackManifestLoader {\n     }\n \n     const sortedPageKeys = getSortedRoutes(pagesKeys)\n-    const clientBuildManifest: ClientBuildManifest = {\n-      __rewrites: normalizeRewritesForBuildManifest(rewrites) as any,\n-      ...Object.fromEntries(\n-        sortedPageKeys.map((pathname) => {\n-          let filePath\n-          if (pathname === '/') {\n-            filePath = '/index.js'\n-          } else if (pathname.endsWith('/index')) {\n-            filePath = `${pathname}/index.js`\n-          } else {\n-            filePath = `${pathname}.js`\n-          }\n-          return [pathname, [`static/chunks/pages${filePath}`]]\n-        })\n-      ),\n-      sortedPages: sortedPageKeys,\n-    }\n+    const clientBuildManifest = this.mergeClientBuildManifests(\n+      rewrites,\n+      this.clientBuildManifests.values(),\n+      sortedPageKeys\n+    )\n     const clientBuildManifestJs = `self.__BUILD_MANIFEST = ${JSON.stringify(\n-      clientBuildManifest\n+      clientBuildManifest,\n+      null,\n+      2\n     )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n     await writeFileAtomic(\n       join(this.distDir, 'static', this.buildId, '_buildManifest.js'),"
        },
        {
            "sha": "c1df55a8a34e42960dc89d767e733b7104744955",
            "filename": "test/e2e/basepath/basepath.test.ts",
            "status": "modified",
            "additions": 76,
            "deletions": 59,
            "changes": 135,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbasepath%2Fbasepath.test.ts?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -7,6 +7,7 @@ import {\n   assertNoRedbox,\n   check,\n   fetchViaHTTP,\n+  getClientBuildManifestLoaderChunkUrlPath,\n   renderViaHTTP,\n   waitFor,\n } from 'next-test-utils'\n@@ -124,75 +125,91 @@ describe('basePath', () => {\n         )\n         expect(routesManifest.basePath).toBe(basePath)\n       })\n-    }\n \n-    it('should prefetch pages correctly when manually called', async () => {\n-      const browser = await webdriver(next.url, `${basePath}/other-page`)\n-      await browser.eval('window.next.router.prefetch(\"/gssp\")')\n+      it('should prefetch pages correctly when manually called', async () => {\n+        const browser = await webdriver(next.url, `${basePath}/other-page`)\n+        await browser.eval('window.next.router.prefetch(\"/gssp\")')\n \n-      await check(\n-        async () => {\n-          const links = await browser.elementsByCss('link[rel=prefetch]')\n+        let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+          next.testDir,\n+          '/gssp'\n+        )\n \n-          for (const link of links) {\n-            const href = await link.getAttribute('href')\n-            if (href.includes('gssp')) {\n-              return true\n+        await check(\n+          async () => {\n+            const links = await browser.elementsByCss('link[rel=prefetch]')\n+\n+            for (const link of links) {\n+              const href = await link.getAttribute('href')\n+              if (href.includes(chunk)) {\n+                return true\n+              }\n             }\n-          }\n \n-          const scripts = await browser.elementsByCss('script')\n+            const scripts = await browser.elementsByCss('script')\n \n-          for (const script of scripts) {\n-            const src = await script.getAttribute('src')\n-            if (src.includes('gssp')) {\n-              return true\n+            for (const script of scripts) {\n+              const src = await script.getAttribute('src')\n+              if (src.includes(chunk)) {\n+                return true\n+              }\n             }\n-          }\n-          return false\n-        },\n-        {\n-          test(result) {\n-            return result === true\n+            return false\n           },\n-        }\n-      )\n-    })\n-\n-    it('should prefetch pages correctly in viewport with <Link>', async () => {\n-      const browser = await webdriver(next.url, `${basePath}/hello`)\n-      await browser.eval('window.next.router.prefetch(\"/gssp\")')\n-\n-      await check(async () => {\n-        const hrefs = await browser.eval(`Object.keys(window.next.router.sdc)`)\n-        hrefs.sort()\n-\n-        assert.deepEqual(\n-          hrefs.map((href) =>\n-            new URL(href).pathname.replace(/\\/_next\\/data\\/[^/]+/, '')\n-          ),\n-          [\n-            `${basePath}/gsp.json`,\n-            `${basePath}/index.json`,\n-            // `${basePath}/index/index.json`,\n-          ]\n+          {\n+            test(result) {\n+              return result === true\n+            },\n+          }\n         )\n+      })\n \n-        const prefetches = await browser.eval(\n-          `[].slice.call(document.querySelectorAll(\"link[rel=prefetch]\")).map((e) => new URL(e.href).pathname)`\n-        )\n-        expect(prefetches).toContainEqual(\n-          expect.stringMatching(/\\/gsp-?([^./]+)?\\.js/)\n-        )\n-        expect(prefetches).toContainEqual(\n-          expect.stringMatching(/\\/gssp-?([^./]+)?\\.js/)\n-        )\n-        expect(prefetches).toContainEqual(\n-          expect.stringMatching(/\\/other-page-?([^./]+)?\\.js/)\n-        )\n-        return 'yes'\n-      }, 'yes')\n-    })\n+      it('should prefetch pages correctly in viewport with <Link>', async () => {\n+        const browser = await webdriver(next.url, `${basePath}/hello`)\n+        await browser.eval('window.next.router.prefetch(\"/gssp\")')\n+\n+        await check(async () => {\n+          const hrefs = await browser.eval(\n+            `Object.keys(window.next.router.sdc)`\n+          )\n+          hrefs.sort()\n+\n+          assert.deepEqual(\n+            hrefs.map((href) =>\n+              new URL(href).pathname.replace(/\\/_next\\/data\\/[^/]+/, '')\n+            ),\n+            [\n+              `${basePath}/gsp.json`,\n+              `${basePath}/index.json`,\n+              // `${basePath}/index/index.json`,\n+            ]\n+          )\n+\n+          let chunkGsp = getClientBuildManifestLoaderChunkUrlPath(\n+            next.testDir,\n+            '/gsp'\n+          )\n+          let chunkGssp = getClientBuildManifestLoaderChunkUrlPath(\n+            next.testDir,\n+            '/gssp'\n+          )\n+          let chunkOtherPage = getClientBuildManifestLoaderChunkUrlPath(\n+            next.testDir,\n+            '/other-page'\n+          )\n+\n+          const prefetches = await browser.eval(\n+            `[].slice.call(document.querySelectorAll(\"link[rel=prefetch]\")).map((e) => new URL(e.href).pathname)`\n+          )\n+          expect(prefetches).toContainEqual(expect.stringContaining(chunkGsp))\n+          expect(prefetches).toContainEqual(expect.stringContaining(chunkGssp))\n+          expect(prefetches).toContainEqual(\n+            expect.stringContaining(chunkOtherPage)\n+          )\n+          return 'yes'\n+        }, 'yes')\n+      })\n+    }\n   }\n \n   it('should serve public file with basePath correctly', async () => {"
        },
        {
            "sha": "8652af7a202368ea5f2b2bd9a0298283d34961e5",
            "filename": "test/integration/client-404/test/index.test.js",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Fclient-404%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Fclient-404%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fclient-404%2Ftest%2Findex.test.js?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -9,6 +9,7 @@ import {\n   nextBuild,\n   nextStart,\n   retry,\n+  getClientBuildManifestLoaderChunkUrlPath,\n } from 'next-test-utils'\n import webdriver from 'next-webdriver'\n import { check } from 'next-test-utils'\n@@ -45,9 +46,10 @@ const clientNavigation = (context, isProd = false) => {\n \n     if (isProd) {\n       it('should hard navigate to URL on failing to load missing bundle', async () => {\n+        let chunk = getClientBuildManifestLoaderChunkUrlPath(appDir, '/missing')\n         const browser = await webdriver(context.appPort, '/to-missing-link', {\n           beforePageLoad(page) {\n-            page.route('**/pages/missing**', (route) => {\n+            page.route('**/' + chunk, (route) => {\n               route.abort('internetdisconnected')\n             })\n           },"
        },
        {
            "sha": "571e9be6cbb45c960b3cfade191797c8c7c59375",
            "filename": "test/integration/error-load-fail/test/index.test.js",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Ferror-load-fail%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Ferror-load-fail%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ferror-load-fail%2Ftest%2Findex.test.js?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -2,7 +2,14 @@\n \n import { join } from 'path'\n import webdriver from 'next-webdriver'\n-import { nextBuild, nextStart, findPort, killApp, check } from 'next-test-utils'\n+import {\n+  nextBuild,\n+  nextStart,\n+  findPort,\n+  killApp,\n+  check,\n+  getClientBuildManifestLoaderChunkUrlPath,\n+} from 'next-test-utils'\n \n const appDir = join(__dirname, '..')\n let app\n@@ -18,10 +25,12 @@ describe('Failing to load _error', () => {\n         const appPort = await findPort()\n         app = await nextStart(appDir, appPort)\n \n+        let chunk = getClientBuildManifestLoaderChunkUrlPath(appDir, '/_error')\n+\n         const browser = await webdriver(appPort, '/', {\n           beforePageLoad(page) {\n             // Make _error route fail to load\n-            page.route('**/_error*.js', (route) => {\n+            page.route('**/' + chunk, (route) => {\n               route.abort('blockedbyclient')\n             })\n           },"
        },
        {
            "sha": "5a085cdabfca6e7bda276023aa6cfcceca92e3e7",
            "filename": "test/integration/link-ref-pages/test/index.test.js",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Flink-ref-pages%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Flink-ref-pages%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Flink-ref-pages%2Ftest%2Findex.test.js?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -10,6 +10,7 @@ import {\n   nextStart,\n   nextBuild,\n   waitFor,\n+  getClientBuildManifestLoaderChunkUrlPath,\n } from 'next-test-utils'\n \n let app\n@@ -42,16 +43,17 @@ const noError = async (pathname) => {\n const didPrefetch = async (pathname) => {\n   const browser = await webdriver(appPort, pathname)\n \n+  let chunk = getClientBuildManifestLoaderChunkUrlPath(appDir, '/')\n+\n   await retry(async () => {\n     const links = await browser.elementsByCss('link[rel=prefetch]')\n \n     const hrefs = await Promise.all(\n       links.map((link) => link.getAttribute('href'))\n     )\n \n-    // expect one of the href contain string \"index\"\n     expect(hrefs).toEqual(\n-      expect.arrayContaining([expect.stringContaining('index')])\n+      expect.arrayContaining([expect.stringContaining(chunk)])\n     )\n   })\n "
        },
        {
            "sha": "be5de56d59357d50e239a437a525fdee30a7efd5",
            "filename": "test/integration/middleware-prefetch/tests/index.test.js",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Fmiddleware-prefetch%2Ftests%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Fmiddleware-prefetch%2Ftests%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fmiddleware-prefetch%2Ftests%2Findex.test.js?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -3,7 +3,14 @@\n import { join } from 'path'\n import fs from 'fs-extra'\n import webdriver from 'next-webdriver'\n-import { check, findPort, killApp, nextBuild, nextStart } from 'next-test-utils'\n+import {\n+  check,\n+  findPort,\n+  killApp,\n+  nextBuild,\n+  nextStart,\n+  getClientBuildManifestLoaderChunkUrlPath,\n+} from 'next-test-utils'\n \n jest.setTimeout(1000 * 60 * 2)\n \n@@ -60,9 +67,11 @@ describe('Middleware Production Prefetch', () => {\n           const attrs = await Promise.all(\n             scripts.map((script) => script.getAttribute('src'))\n           )\n-          // Check if the filename follows the format `static/chunks/pages/[pagename]-[hash].js`\n-          // and specifically targets files containing '/ssg-page-' in their path.\n-          return attrs.find((src) => src.includes('/ssg-page')) ? 'yes' : 'nope'\n+          let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+            context.appDir,\n+            '/ssg-page'\n+          )\n+          return attrs.find((src) => src.includes(chunk)) ? 'yes' : 'nope'\n         }, 'yes')\n       })\n "
        },
        {
            "sha": "7b0b98ada23dd3e4f9af29e4c23a17e50cfe9c07",
            "filename": "test/integration/preload-viewport/test/index.test.js",
            "status": "modified",
            "additions": 71,
            "deletions": 16,
            "changes": 87,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Fpreload-viewport%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Fpreload-viewport%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fpreload-viewport%2Ftest%2Findex.test.js?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -8,6 +8,7 @@ import {\n   nextBuild,\n   nextStart,\n   waitFor,\n+  getClientBuildManifestLoaderChunkUrlPath,\n } from 'next-test-utils'\n import http from 'http'\n import httpProxy from 'http-proxy'\n@@ -108,8 +109,12 @@ describe('Prefetching Links in viewport', () => {\n             const hrefs = await Promise.all(\n               links.map((link) => link.getAttribute('href'))\n             )\n+            let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+              appDir,\n+              '/first'\n+            )\n             expect(hrefs).toEqual(\n-              expect.arrayContaining([expect.stringContaining('first')])\n+              expect.arrayContaining([expect.stringContaining(chunk)])\n             )\n           })\n         } finally {\n@@ -126,8 +131,10 @@ describe('Prefetching Links in viewport', () => {\n               'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/105.0.0.0 Safari/537.36'\n             )}`\n           )\n-          const links = await browser.elementsByCss('link[rel=prefetch]')\n-          expect(links).toHaveLength(1)\n+          await retry(async () => {\n+            const links = await browser.elementsByCss('link[rel=prefetch]')\n+            expect(links).toHaveLength(1)\n+          })\n         } finally {\n           if (browser) await browser.close()\n         }\n@@ -161,8 +168,12 @@ describe('Prefetching Links in viewport', () => {\n               links.map((link) => link.getAttribute('href'))\n             )\n \n+            let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+              appDir,\n+              '/ssg/dynamic/[slug]'\n+            )\n             expect(hrefs).toEqual(\n-              expect.arrayContaining([expect.stringContaining('%5Bslug%5D')])\n+              expect.arrayContaining([expect.stringContaining(chunk)])\n             )\n           })\n           const hrefs = await browser.eval(\n@@ -187,10 +198,19 @@ describe('Prefetching Links in viewport', () => {\n           let foundFirst = false\n           let foundAnother = false\n \n+          let chunkFirst = getClientBuildManifestLoaderChunkUrlPath(\n+            appDir,\n+            '/first'\n+          )\n+          let chunkAnother = getClientBuildManifestLoaderChunkUrlPath(\n+            appDir,\n+            '/another'\n+          )\n+\n           for (const link of links) {\n             const href = await link.getAttribute('href')\n-            if (href.includes('another')) foundAnother = true\n-            if (href.includes('first')) foundFirst = true\n+            if (href.includes(chunkAnother)) foundAnother = true\n+            if (href.includes(chunkFirst)) foundFirst = true\n           }\n           expect(foundFirst).toBe(true)\n           expect(foundAnother).toBe(true)\n@@ -211,8 +231,12 @@ describe('Prefetching Links in viewport', () => {\n             const hrefs = await Promise.all(\n               links.map((link) => link.getAttribute('href'))\n             )\n+            let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+              appDir,\n+              '/another'\n+            )\n             expect(hrefs).toEqual(\n-              expect.arrayContaining([expect.stringContaining('another')])\n+              expect.arrayContaining([expect.stringContaining(chunk)])\n             )\n           })\n         } finally {\n@@ -232,8 +256,12 @@ describe('Prefetching Links in viewport', () => {\n             const hrefs = await Promise.all(\n               links.map((link) => link.getAttribute('href'))\n             )\n+            let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+              appDir,\n+              '/another'\n+            )\n             expect(hrefs).toEqual(\n-              expect.arrayContaining([expect.stringContaining('another')])\n+              expect.arrayContaining([expect.stringContaining(chunk)])\n             )\n           })\n \n@@ -246,8 +274,12 @@ describe('Prefetching Links in viewport', () => {\n             const srcProps = await Promise.all(\n               scripts.map((script) => script.getAttribute('src'))\n             )\n+            let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+              appDir,\n+              '/another'\n+            )\n             expect(srcProps).toEqual(\n-              expect.arrayContaining([expect.stringContaining('another')])\n+              expect.arrayContaining([expect.stringContaining(chunk)])\n             )\n           })\n         } finally {\n@@ -260,14 +292,20 @@ describe('Prefetching Links in viewport', () => {\n         try {\n           browser = await webdriver(appPort, '/prefetch-disabled')\n \n+          let chunkAnother = getClientBuildManifestLoaderChunkUrlPath(\n+            appDir,\n+            '/another'\n+          )\n           await retry(async () => {\n             const links = await browser.elementsByCss('link[rel=prefetch]')\n \n             const hrefs = await Promise.all(\n               links.map((link) => link.getAttribute('href'))\n             )\n             expect(hrefs).toEqual(\n-              expect.not.arrayContaining([expect.stringContaining('another')])\n+              expect.not.arrayContaining([\n+                expect.stringContaining(chunkAnother),\n+              ])\n             )\n           })\n \n@@ -279,7 +317,7 @@ describe('Prefetching Links in viewport', () => {\n             let scriptFound = false\n             for (const aScript of scripts) {\n               const href = await aScript.getAttribute('src')\n-              if (href.includes('another')) {\n+              if (href.includes(chunkAnother)) {\n                 scriptFound = true\n                 break\n               }\n@@ -301,6 +339,10 @@ describe('Prefetching Links in viewport', () => {\n         try {\n           browser = await webdriver(appPort, '/prefetch-disabled-ssg')\n \n+          let chunkBasic = getClientBuildManifestLoaderChunkUrlPath(\n+            appDir,\n+            '/ssg/basic'\n+          )\n           async function hasSsgScript() {\n             const scripts = await browser.elementsByCss(\n               // Mouse hover is a high-priority fetch\n@@ -309,7 +351,7 @@ describe('Prefetching Links in viewport', () => {\n             let scriptFound = false\n             for (const aScript of scripts) {\n               const href = await aScript.getAttribute('src')\n-              if (href.includes('basic')) {\n+              if (href.includes(chunkBasic)) {\n                 scriptFound = true\n                 break\n               }\n@@ -350,8 +392,12 @@ describe('Prefetching Links in viewport', () => {\n             const srcProps = await Promise.all(\n               scripts.map((script) => script.getAttribute('src'))\n             )\n+            let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+              appDir,\n+              '/another'\n+            )\n             expect(srcProps).toEqual(\n-              expect.arrayContaining([expect.stringContaining('another')])\n+              expect.arrayContaining([expect.stringContaining(chunk)])\n             )\n           })\n         } finally {\n@@ -383,8 +429,12 @@ describe('Prefetching Links in viewport', () => {\n           const hrefs = await Promise.all(\n             links.map((link) => link.getAttribute('href'))\n           )\n+          let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+            appDir,\n+            '/another'\n+          )\n           expect(hrefs).toEqual(\n-            expect.not.arrayContaining([expect.stringContaining('another')])\n+            expect.not.arrayContaining([expect.stringContaining(chunk)])\n           )\n         })\n       })\n@@ -437,8 +487,12 @@ describe('Prefetching Links in viewport', () => {\n         // Ensure no duplicates\n         expect(hrefs).toEqual([...new Set(hrefs)])\n \n+        let chunk = getClientBuildManifestLoaderChunkUrlPath(\n+          appDir,\n+          '/dynamic/[hello]'\n+        )\n         // Verify encoding\n-        expect(hrefs.some((e) => e.includes(`%5Bhello%5D`))).toBe(true)\n+        expect(hrefs.some((e) => e.includes(chunk))).toBe(true)\n       })\n \n       it('should not re-prefetch for an already prefetched page', async () => {\n@@ -451,8 +505,9 @@ describe('Prefetching Links in viewport', () => {\n           const hrefs = await Promise.all(\n             links.map((link) => link.getAttribute('href'))\n           )\n+          let chunk = getClientBuildManifestLoaderChunkUrlPath(appDir, '/first')\n           expect(hrefs).toEqual(\n-            expect.arrayContaining([expect.stringContaining('first')])\n+            expect.arrayContaining([expect.stringContaining(chunk)])\n           )\n         })\n "
        },
        {
            "sha": "867bdd3076bf1c7ad787c1aee7766a6e96caa6cf",
            "filename": "test/integration/production-browser-sourcemaps/test/index.test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -33,11 +33,9 @@ describe('Production browser sourcemaps', () => {\n         })\n \n         it('includes sourcemaps for all browser files', async () => {\n-          const staticDir = join(appDir, '.next', 'static')\n+          const staticDir = join(appDir, '.next', 'static', 'chunks')\n           const browserFiles = await recursiveReadDir(staticDir)\n-          const jsFiles = browserFiles.filter(\n-            (file) => file.endsWith('.js') && file.includes('/pages/')\n-          )\n+          const jsFiles = browserFiles.filter((file) => file.endsWith('.js'))\n           expect(jsFiles).not.toBeEmpty()\n \n           for (const file of jsFiles) {"
        },
        {
            "sha": "6c5ae829f69636342ce75be5a08dbde008a44d92",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f1b88b4cfa63a6560a04baa209c09065c419969c/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=f1b88b4cfa63a6560a04baa209c09065c419969c",
            "patch": "@@ -1283,6 +1283,35 @@ export function readNextBuildServerPageFile(appDir: string, page: string) {\n   return readFileSync(path.join(appDir, '.next', 'server', pageFile), 'utf8')\n }\n \n+export function getClientBuildManifest(dir: string) {\n+  let buildId = readFileSync(path.join(dir, '.next/BUILD_ID'), 'utf8')\n+  let code = readFileSync(\n+    path.join(dir, '.next/static', buildId, '_buildManifest.js'),\n+    'utf8'\n+  )\n+  // eslint-disable-next-line no-eval\n+  let manifest = (0, eval)(`var self = global;${code};self.__BUILD_MANIFEST`)\n+  return manifest\n+}\n+\n+export function getClientBuildManifestLoaderChunkUrlPath(\n+  dir: string,\n+  page: string\n+) {\n+  let manifest = getClientBuildManifest(dir)\n+  let chunk: string[] | undefined = manifest[page]\n+  if (chunk == null) {\n+    throw new Error(`Couldn't find page \"${page}\" in _buildManifest.js`)\n+  }\n+  if (chunk.length !== 1) {\n+    throw new Error(\n+      `Expected a single chunk, but found ${chunk.length} for \"${page}\" in _buildManifest.js`\n+    )\n+  }\n+  // Remove leading './' so that this can be used in a `url.contains(chunk)` check.\n+  return encodeURI(chunk[0].replace(/^\\.\\//, ''))\n+}\n+\n function runSuite(\n   suiteName: string,\n   context: { env: 'prod' | 'dev'; appDir: string } & Partial<{"
        }
    ],
    "stats": {
        "total": 449,
        "additions": 330,
        "deletions": 119
    }
}