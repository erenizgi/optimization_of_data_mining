{
    "author": "huozhi",
    "message": "[errors] revamp graceful degrade error boundary (#82474)",
    "sha": "dcece129286274b6c4bc510cfdb2ff2c84bdf9b5",
    "files": [
        {
            "sha": "b8f243b9e239044004f9c5762c304b4db3cff2b6",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=dcece129286274b6c4bc510cfdb2ff2c84bdf9b5",
            "patch": "@@ -21,7 +21,6 @@ import type { InitialRSCPayload } from '../server/app-render/types'\n import { createInitialRouterState } from './components/router-reducer/create-initial-router-state'\n import { MissingSlotContext } from '../shared/lib/app-router-context.shared-runtime'\n import { setAppBuildId } from './app-build-id'\n-import { isBot } from '../shared/lib/router/utils/is-bot'\n \n /// <reference types=\"react-dom/experimental\" />\n \n@@ -169,7 +168,6 @@ function ServerRoot({\n \n   const router = (\n     <AppRouter\n-      gracefullyDegrade={isBot(window.navigator.userAgent)}\n       actionQueue={actionQueue}\n       globalErrorState={initialRSCPayload.G}\n       assetPrefix={initialRSCPayload.p}"
        },
        {
            "sha": "6468e9eebe62c1021e611860b661e76c6172e229",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 17,
            "deletions": 35,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=dcece129286274b6c4bc510cfdb2ff2c84bdf9b5",
            "patch": "@@ -22,8 +22,6 @@ import {\n   PathParamsContext,\n } from '../../shared/lib/hooks-client-context.shared-runtime'\n import { dispatchAppRouterAction, useActionQueue } from './use-action-queue'\n-import { ErrorBoundary } from './error-boundary'\n-import DefaultGlobalError from './builtin/global-error'\n import { isBot } from '../../shared/lib/router/utils/is-bot'\n import { addBasePath } from '../add-base-path'\n import { AppRouterAnnouncer } from './app-router-announcer'\n@@ -44,7 +42,8 @@ import {\n import { getRedirectTypeFromError, getURLFromRedirectError } from './redirect'\n import { isRedirectError, RedirectType } from './redirect-error'\n import { pingVisibleLinks } from './links'\n-import GracefulDegradeBoundary from './errors/graceful-degrade-boundary'\n+import RootErrorBoundary from './errors/root-error-boundary'\n+import DefaultGlobalError from './builtin/global-error'\n \n const globalMutable: {\n   pendingMpaPath?: string\n@@ -196,12 +195,10 @@ function Router({\n   actionQueue,\n   assetPrefix,\n   globalError,\n-  gracefullyDegrade,\n }: {\n   actionQueue: AppRouterActionQueue\n   assetPrefix: string\n   globalError: GlobalErrorState\n-  gracefullyDegrade: boolean\n }) {\n   const state = useActionQueue(actionQueue)\n   const { canonicalUrl } = state\n@@ -517,20 +514,14 @@ function Router({\n       </HotReloader>\n     )\n   } else {\n-    // If gracefully degrading is applied in production,\n-    // leave the app as it is rather than caught by GlobalError boundary.\n-    if (gracefullyDegrade) {\n-      content = <GracefulDegradeBoundary>{content}</GracefulDegradeBoundary>\n-    } else {\n-      content = (\n-        <ErrorBoundary\n-          errorComponent={globalError[0]}\n-          errorStyles={globalError[1]}\n-        >\n-          {content}\n-        </ErrorBoundary>\n-      )\n-    }\n+    content = (\n+      <RootErrorBoundary\n+        errorComponent={globalError[0]}\n+        errorStyles={globalError[1]}\n+      >\n+        {content}\n+      </RootErrorBoundary>\n+    )\n   }\n \n   return (\n@@ -565,12 +556,10 @@ export default function AppRouter({\n   actionQueue,\n   globalErrorState,\n   assetPrefix,\n-  gracefullyDegrade,\n }: {\n   actionQueue: AppRouterActionQueue\n   globalErrorState: GlobalErrorState\n   assetPrefix: string\n-  gracefullyDegrade: boolean\n }) {\n   useNavFailureHandler()\n \n@@ -579,23 +568,16 @@ export default function AppRouter({\n       actionQueue={actionQueue}\n       assetPrefix={assetPrefix}\n       globalError={globalErrorState}\n-      gracefullyDegrade={gracefullyDegrade}\n     />\n   )\n \n-  if (gracefullyDegrade) {\n-    return router\n-  } else {\n-    return (\n-      <ErrorBoundary\n-        // At the very top level, use the default GlobalError component as the final fallback.\n-        // When the app router itself fails, which means the framework itself fails, we show the default error.\n-        errorComponent={DefaultGlobalError}\n-      >\n-        {router}\n-      </ErrorBoundary>\n-    )\n-  }\n+  // At the very top level, use the default GlobalError component as the final fallback.\n+  // When the app router itself fails, which means the framework itself fails, we show the default error.\n+  return (\n+    <RootErrorBoundary errorComponent={DefaultGlobalError}>\n+      {router}\n+    </RootErrorBoundary>\n+  )\n }\n \n const runtimeStyles = new Set<string>()"
        },
        {
            "sha": "f14b7ea8183f68aef1a6cb224d7eb8f2f273a184",
            "filename": "packages/next/src/client/components/error-boundary.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferror-boundary.tsx?ref=dcece129286274b6c4bc510cfdb2ff2c84bdf9b5",
            "patch": "@@ -5,6 +5,10 @@ import { useUntrackedPathname } from './navigation-untracked'\n import { isNextRouterError } from './is-next-router-error'\n import { handleHardNavError } from './nav-failure-handler'\n import { HandleISRError } from './handle-isr-error'\n+import { isBot } from '../../shared/lib/router/utils/is-bot'\n+\n+const isBotUserAgent =\n+  typeof window !== 'undefined' && isBot(window.navigator.userAgent)\n \n export type ErrorComponent = React.ComponentType<{\n   error: Error\n@@ -93,7 +97,9 @@ export class ErrorBoundaryHandler extends React.Component<\n \n   // Explicit type is needed to avoid the generated `.d.ts` having a wide return type that could be specific to the `@types/react` version.\n   render(): React.ReactNode {\n-    if (this.state.error) {\n+    //When it's bot request, segment level error boundary will keep rendering the children,\n+    // the final error will be caught by the root error boundary and determine wether need to apply graceful degrade.\n+    if (this.state.error && !isBotUserAgent) {\n       return (\n         <>\n           <HandleISRError error={this.state.error} />"
        },
        {
            "sha": "685311c7ddeaf381ca7268c8d0b888c38f3798d1",
            "filename": "packages/next/src/client/components/errors/root-error-boundary.tsx",
            "status": "added",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Froot-error-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Froot-error-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Ferrors%2Froot-error-boundary.tsx?ref=dcece129286274b6c4bc510cfdb2ff2c84bdf9b5",
            "patch": "@@ -0,0 +1,32 @@\n+'use client'\n+\n+import React, { type JSX } from 'react'\n+import GracefulDegradeBoundary from './graceful-degrade-boundary'\n+import { ErrorBoundary, type ErrorBoundaryProps } from '../error-boundary'\n+import { isBot } from '../../../shared/lib/router/utils/is-bot'\n+\n+const isBotUserAgent =\n+  typeof window !== 'undefined' && isBot(window.navigator.userAgent)\n+\n+export default function RootErrorBoundary({\n+  children,\n+  errorComponent,\n+  errorStyles,\n+  errorScripts,\n+}: ErrorBoundaryProps & { children: React.ReactNode }): JSX.Element {\n+  if (isBotUserAgent) {\n+    // Preserve existing DOM/HTML for bots to avoid replacing content with an error UI\n+    // and to keep the original SSR output intact.\n+    return <GracefulDegradeBoundary>{children}</GracefulDegradeBoundary>\n+  }\n+\n+  return (\n+    <ErrorBoundary\n+      errorComponent={errorComponent}\n+      errorStyles={errorStyles}\n+      errorScripts={errorScripts}\n+    >\n+      {children}\n+    </ErrorBoundary>\n+  )\n+}"
        },
        {
            "sha": "a9b53f0f064fdcd74a6412b4ecbfa6d1932e8a6a",
            "filename": "packages/next/src/client/components/layout-router.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 12,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx?ref=dcece129286274b6c4bc510cfdb2ff2c84bdf9b5",
            "patch": "@@ -488,10 +488,6 @@ function LoadingBoundary({\n   return <>{children}</>\n }\n \n-function RenderChildren({ children }: { children: React.ReactNode }) {\n-  return <>{children}</>\n-}\n-\n /**\n  * OuterLayoutRouter handles the current segment as well as <Offscreen> rendering of other segments.\n  * It can be rendered next to each other with a different `parallelRouterKey`, allowing for Parallel routes.\n@@ -507,7 +503,6 @@ export default function OuterLayoutRouter({\n   notFound,\n   forbidden,\n   unauthorized,\n-  gracefullyDegrade,\n   segmentViewBoundaries,\n }: {\n   parallelRouterKey: string\n@@ -520,7 +515,6 @@ export default function OuterLayoutRouter({\n   notFound: React.ReactNode | undefined\n   forbidden: React.ReactNode | undefined\n   unauthorized: React.ReactNode | undefined\n-  gracefullyDegrade?: boolean\n   segmentViewBoundaries?: React.ReactNode\n }) {\n   const context = useContext(LayoutRouterContext)\n@@ -612,10 +606,6 @@ export default function OuterLayoutRouter({\n       - Passed to the router during rendering to ensure it can be immediately rendered when suspending on a Flight fetch.\n   */\n \n-    const ErrorBoundaryComponent = gracefullyDegrade\n-      ? RenderChildren\n-      : ErrorBoundary\n-\n     let segmentBoundaryTriggerNode: React.ReactNode = null\n     let segmentViewStateNode: React.ReactNode = null\n     if (\n@@ -651,7 +641,7 @@ export default function OuterLayoutRouter({\n         key={stateKey}\n         value={\n           <ScrollAndFocusHandler segmentPath={segmentPath}>\n-            <ErrorBoundaryComponent\n+            <ErrorBoundary\n               errorComponent={error}\n               errorStyles={errorStyles}\n               errorScripts={errorScripts}\n@@ -673,7 +663,7 @@ export default function OuterLayoutRouter({\n                   </RedirectBoundary>\n                 </HTTPAccessFallbackBoundary>\n               </LoadingBoundary>\n-            </ErrorBoundaryComponent>\n+            </ErrorBoundary>\n             {segmentViewStateNode}\n           </ScrollAndFocusHandler>\n         }"
        },
        {
            "sha": "de97bbaae0a51a1c68875b4c06d6699fbd2b4474",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 21,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=dcece129286274b6c4bc510cfdb2ff2c84bdf9b5",
            "patch": "@@ -1309,14 +1309,12 @@ function App<T>({\n   preinitScripts,\n   clientReferenceManifest,\n   ServerInsertedHTMLProvider,\n-  gracefullyDegrade,\n   nonce,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n   preinitScripts: () => void\n   clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedHTMLProvider: React.ComponentType<{ children: JSX.Element }>\n-  gracefullyDegrade: boolean\n   nonce?: string\n }): JSX.Element {\n   preinitScripts()\n@@ -1360,7 +1358,6 @@ function App<T>({\n           actionQueue={actionQueue}\n           globalErrorState={response.G}\n           assetPrefix={response.p}\n-          gracefullyDegrade={gracefullyDegrade}\n         />\n       </ServerInsertedHTMLProvider>\n     </HeadManagerContext.Provider>\n@@ -1375,14 +1372,12 @@ function ErrorApp<T>({\n   preinitScripts,\n   clientReferenceManifest,\n   ServerInsertedHTMLProvider,\n-  gracefullyDegrade,\n   nonce,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n   preinitScripts: () => void\n   clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedHTMLProvider: React.ComponentType<{ children: JSX.Element }>\n-  gracefullyDegrade: boolean\n   nonce?: string\n }): JSX.Element {\n   preinitScripts()\n@@ -1417,7 +1412,6 @@ function ErrorApp<T>({\n         actionQueue={actionQueue}\n         globalErrorState={response.G}\n         assetPrefix={response.p}\n-        gracefullyDegrade={gracefullyDegrade}\n       />\n     </ServerInsertedHTMLProvider>\n   )\n@@ -2070,7 +2064,6 @@ async function renderToStream(\n \n   const {\n     basePath,\n-    botType,\n     buildManifest,\n     clientReferenceManifest,\n     ComponentMod,\n@@ -2289,7 +2282,6 @@ async function renderToStream(\n             clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             nonce={nonce}\n-            gracefullyDegrade={!!botType}\n           />,\n           postponed,\n           { onError: htmlRendererErrorHandler, nonce }\n@@ -2327,7 +2319,6 @@ async function renderToStream(\n         preinitScripts={preinitScripts}\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-        gracefullyDegrade={!!botType}\n         nonce={nonce}\n       />,\n       {\n@@ -2486,7 +2477,6 @@ async function renderToStream(\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               preinitScripts={errorPreinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n-              gracefullyDegrade={!!botType}\n               nonce={nonce}\n             />\n           ),\n@@ -2585,7 +2575,7 @@ async function spawnDynamicValidationInDev(\n     workStore,\n   } = ctx\n \n-  const { allowEmptyStaticShell = false, botType } = renderOpts\n+  const { allowEmptyStaticShell = false } = renderOpts\n \n   // These values are placeholder values for this validating render\n   // that are provided during the actual prerenderToStream.\n@@ -2830,7 +2820,6 @@ async function spawnDynamicValidationInDev(\n         preinitScripts={preinitScripts}\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-        gracefullyDegrade={!!botType}\n         nonce={nonce}\n       />,\n       {\n@@ -3059,7 +3048,6 @@ async function spawnDynamicValidationInDev(\n               preinitScripts={preinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-              gracefullyDegrade={!!botType}\n               nonce={nonce}\n             />,\n             {\n@@ -3208,7 +3196,6 @@ async function prerenderToStream(\n   const {\n     allowEmptyStaticShell = false,\n     basePath,\n-    botType,\n     buildManifest,\n     clientReferenceManifest,\n     ComponentMod,\n@@ -3573,7 +3560,6 @@ async function prerenderToStream(\n             preinitScripts={preinitScripts}\n             clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-            gracefullyDegrade={!!botType}\n             nonce={nonce}\n           />,\n           {\n@@ -3807,7 +3793,6 @@ async function prerenderToStream(\n                 preinitScripts={preinitScripts}\n                 clientReferenceManifest={clientReferenceManifest}\n                 ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-                gracefullyDegrade={!!botType}\n                 nonce={nonce}\n               />,\n               {\n@@ -3965,7 +3950,6 @@ async function prerenderToStream(\n               preinitScripts={() => {}}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-              gracefullyDegrade={!!botType}\n               nonce={nonce}\n             />,\n             JSON.parse(JSON.stringify(postponed)),\n@@ -4071,7 +4055,6 @@ async function prerenderToStream(\n           preinitScripts={preinitScripts}\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-          gracefullyDegrade={!!botType}\n           nonce={nonce}\n         />,\n         {\n@@ -4203,7 +4186,6 @@ async function prerenderToStream(\n               preinitScripts={() => {}}\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-              gracefullyDegrade={!!botType}\n               nonce={nonce}\n             />,\n             JSON.parse(JSON.stringify(postponed)),\n@@ -4287,7 +4269,6 @@ async function prerenderToStream(\n           preinitScripts={preinitScripts}\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n-          gracefullyDegrade={!!botType}\n           nonce={nonce}\n         />,\n         {\n@@ -4461,7 +4442,6 @@ async function prerenderToStream(\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               preinitScripts={errorPreinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n-              gracefullyDegrade={!!botType}\n               nonce={nonce}\n             />\n           ),"
        },
        {
            "sha": "554b9c38866f93f7fe5db29ebf66810519d52c7a",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dcece129286274b6c4bc510cfdb2ff2c84bdf9b5/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=dcece129286274b6c4bc510cfdb2ff2c84bdf9b5",
            "patch": "@@ -201,8 +201,6 @@ async function createComponentTreeInternal(\n     () => getLayoutOrPageModule(tree)\n   )\n \n-  const gracefullyDegrade = !!ctx.renderOpts.botType\n-\n   /**\n    * Checks if the current segment is a root layout.\n    */\n@@ -647,9 +645,6 @@ async function createComponentTreeInternal(\n             forbidden={forbiddenComponent}\n             unauthorized={unauthorizedComponent}\n             {...(isSegmentViewEnabled && { segmentViewBoundaries })}\n-            // Since gracefullyDegrade only applies to bots, only\n-            // pass it when we're in a bot context to avoid extra bytes.\n-            {...(gracefullyDegrade && { gracefullyDegrade })}\n           />,\n           childCacheNodeSeedData,\n         ]"
        }
    ],
    "stats": {
        "total": 135,
        "additions": 59,
        "deletions": 76
    }
}