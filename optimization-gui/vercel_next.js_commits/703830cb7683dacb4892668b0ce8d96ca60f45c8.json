{
    "author": "lubieowoce",
    "message": "allow root params access in private caches (#82125)\n\nAccessing root params in a private cache should work, but I missed it in\nthe `next/root-params` PR.\n```tsx\nimport { lang } from 'next/root-params'\n\nasync function foo() {\n  'use cache: private'\n  await lang() // this is okay\n}\n```\nWith this PR, we'll now allow this (and `unstable_rootParams()`)",
    "sha": "703830cb7683dacb4892668b0ce8d96ca60f45c8",
    "files": [
        {
            "sha": "878f440af2e304e4f9f3af09bf4aa3de242a81ba",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/703830cb7683dacb4892668b0ce8d96ca60f45c8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/703830cb7683dacb4892668b0ce8d96ca60f45c8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=703830cb7683dacb4892668b0ce8d96ca60f45c8",
            "patch": "@@ -246,6 +246,13 @@ export interface PrivateUseCacheStore extends CommonUseCacheStore {\n    * access the request cookies.\n    */\n   readonly cookies: ReadonlyRequestCookies\n+\n+  /**\n+   * Private caches don't currently need to track root params in the cache key\n+   * because they're not persisted anywhere, so we can allow root params access\n+   * (unlike public caches)\n+   */\n+  readonly rootParams: Params\n }\n \n export type UseCacheStore = PublicUseCacheStore | PrivateUseCacheStore"
        },
        {
            "sha": "e3fb74a4f72ab8021a853b3c0b8f95a29d0fb894",
            "filename": "packages/next/src/server/request/root-params.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/703830cb7683dacb4892668b0ce8d96ca60f45c8/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/703830cb7683dacb4892668b0ce8d96ca60f45c8/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts?ref=703830cb7683dacb4892668b0ce8d96ca60f45c8",
            "patch": "@@ -41,7 +41,6 @@ export async function unstable_rootParams(): Promise<Params> {\n \n   switch (workUnitStore.type) {\n     case 'cache':\n-    case 'private-cache':\n     case 'unstable-cache': {\n       throw new Error(\n         `Route ${workStore.route} used \\`unstable_rootParams()\\` inside \\`\"use cache\"\\` or \\`unstable_cache\\`. Support for this API inside cache scopes is planned for a future version of Next.js.`\n@@ -56,6 +55,7 @@ export async function unstable_rootParams(): Promise<Params> {\n         workStore,\n         workUnitStore\n       )\n+    case 'private-cache':\n     case 'request':\n       return Promise.resolve(workUnitStore.rootParams)\n     default:\n@@ -228,7 +228,6 @@ export function getRootParam(paramName: string): Promise<ParamValue> {\n \n   switch (workUnitStore.type) {\n     case 'unstable-cache':\n-    case 'private-cache':\n     case 'cache': {\n       throw new Error(\n         `Route ${workStore.route} used ${apiName} inside \\`\"use cache\"\\` or \\`unstable_cache\\`. Support for this API inside cache scopes is planned for a future version of Next.js.`\n@@ -245,6 +244,7 @@ export function getRootParam(paramName: string): Promise<ParamValue> {\n         apiName\n       )\n     }\n+    case 'private-cache':\n     case 'request': {\n       break\n     }"
        },
        {
            "sha": "8c28b6de2f4e1121a4c01b15c9e17be99eca60ab",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/703830cb7683dacb4892668b0ce8d96ca60f45c8/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/703830cb7683dacb4892668b0ce8d96ca60f45c8/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=703830cb7683dacb4892668b0ce8d96ca60f45c8",
            "patch": "@@ -187,14 +187,15 @@ function createUseCacheStore(\n       explicitExpire: undefined,\n       explicitStale: undefined,\n       tags: null,\n-      hmrRefreshHash:\n-        outerWorkUnitStore && getHmrRefreshHash(workStore, outerWorkUnitStore),\n-      isHmrRefresh: outerWorkUnitStore?.isHmrRefresh ?? false,\n-      serverComponentsHmrCache: outerWorkUnitStore?.serverComponentsHmrCache,\n+      hmrRefreshHash: getHmrRefreshHash(workStore, outerWorkUnitStore),\n+      isHmrRefresh: outerWorkUnitStore.isHmrRefresh ?? false,\n+      serverComponentsHmrCache: outerWorkUnitStore.serverComponentsHmrCache,\n       forceRevalidate: shouldForceRevalidate(workStore, outerWorkUnitStore),\n-      draftMode:\n-        outerWorkUnitStore &&\n-        getDraftModeProviderForCacheScope(workStore, outerWorkUnitStore),\n+      draftMode: getDraftModeProviderForCacheScope(\n+        workStore,\n+        outerWorkUnitStore\n+      ),\n+      rootParams: outerWorkUnitStore.rootParams,\n       cookies: outerWorkUnitStore.cookies,\n     }\n   } else {"
        },
        {
            "sha": "3a3c2e2a67e27c3591e3fd809b697e28e4cfec89",
            "filename": "test/e2e/app-dir/app-root-params-getters/fixtures/use-cache-private/app/[lang]/[locale]/layout.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/703830cb7683dacb4892668b0ce8d96ca60f45c8/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/703830cb7683dacb4892668b0ce8d96ca60f45c8/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Flayout.tsx?ref=703830cb7683dacb4892668b0ce8d96ca60f45c8",
            "patch": "@@ -0,0 +1,16 @@\n+import { ReactNode } from 'react'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}\n+\n+export function generateStaticParams() {\n+  // the param values are not accessed in tests,\n+  // we just need a value here to avoid errors in PPR/cacheComponents\n+  // where we need to provide at least one set of values for root params\n+  return [{ lang: 'foo', locale: 'bar' }]\n+}"
        },
        {
            "sha": "c8107df922c871f9cfb5cef3f0a0ce09a2036b80",
            "filename": "test/e2e/app-dir/app-root-params-getters/fixtures/use-cache-private/app/[lang]/[locale]/use-cache-private/page.tsx",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/703830cb7683dacb4892668b0ce8d96ca60f45c8/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache-private%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/703830cb7683dacb4892668b0ce8d96ca60f45c8/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache-private%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fapp%2F%5Blang%5D%2F%5Blocale%5D%2Fuse-cache-private%2Fpage.tsx?ref=703830cb7683dacb4892668b0ce8d96ca60f45c8",
            "patch": "@@ -0,0 +1,34 @@\n+import { lang, locale } from 'next/root-params'\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+export default async function Page() {\n+  return (\n+    <Suspense fallback=\"Loading...\">\n+      <Runtime />\n+    </Suspense>\n+  )\n+}\n+\n+async function Runtime() {\n+  await connection()\n+\n+  const rootParams = await getCachedParams()\n+  const data = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/random'\n+  ).then((res) => res.text())\n+\n+  return (\n+    <p>\n+      <span id=\"param\">\n+        {rootParams.lang} {rootParams.locale}\n+      </span>{' '}\n+      <span id=\"random\">{data}</span>\n+    </p>\n+  )\n+}\n+\n+async function getCachedParams() {\n+  'use cache: private'\n+  return { lang: await lang(), locale: await locale() }\n+}"
        },
        {
            "sha": "f9ec19251f03ac8d74823c1e4d1195214e9fd1bf",
            "filename": "test/e2e/app-dir/app-root-params-getters/fixtures/use-cache-private/next.config.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/703830cb7683dacb4892668b0ce8d96ca60f45c8/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/703830cb7683dacb4892668b0ce8d96ca60f45c8/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Ffixtures%2Fuse-cache-private%2Fnext.config.ts?ref=703830cb7683dacb4892668b0ce8d96ca60f45c8",
            "patch": "@@ -0,0 +1,10 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  experimental: {\n+    useCache: true,\n+    rootParams: true,\n+  },\n+}\n+\n+export default nextConfig"
        },
        {
            "sha": "3628ce9d135b3529da4f2c2c83c5b6da229c4dcc",
            "filename": "test/e2e/app-dir/app-root-params-getters/use-cache.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 14,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/703830cb7683dacb4892668b0ce8d96ca60f45c8/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/703830cb7683dacb4892668b0ce8d96ca60f45c8/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params-getters%2Fuse-cache.test.ts?ref=703830cb7683dacb4892668b0ce8d96ca60f45c8",
            "patch": "@@ -5,7 +5,6 @@ import { createSandbox } from 'development-sandbox'\n describe('app-root-param-getters - cache - at runtime', () => {\n   const { next, isNextDev, skipped } = nextTestSetup({\n     files: join(__dirname, 'fixtures', 'use-cache-runtime'),\n-    skipStart: true,\n     // this test asserts on build failure logs, which aren't currently observable in `next.cliOutput`.\n     skipDeployment: true,\n   })\n@@ -39,19 +38,6 @@ describe('app-root-param-getters - cache - at runtime', () => {\n       )\n     })\n   } else {\n-    beforeAll(async () => {\n-      try {\n-        await next.start()\n-      } catch (err) {\n-        // if (isPPREnabled) {\n-        //   throw err\n-        // } else {\n-        //   // in PPR/cacheComponents, we expect the build to fail,\n-        //   // so we swallow the error and let the tests assert on the logs\n-        // }\n-      }\n-    })\n-\n     it('should error when using root params within a \"use cache\" - start', async () => {\n       await next.render$('/en/us/use-cache')\n       expect(next.cliOutput).toInclude(\n@@ -68,6 +54,30 @@ describe('app-root-param-getters - cache - at runtime', () => {\n   }\n })\n \n+describe('app-root-param-getters - private cache', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: join(__dirname, 'fixtures', 'use-cache-private'),\n+  })\n+\n+  if (isNextDev) {\n+    it('should allow using root params within a \"use cache: private\" - dev', async () => {\n+      await using sandbox = await createSandbox(\n+        next,\n+        undefined,\n+        '/en/us/use-cache-private'\n+      )\n+      const { session, browser } = sandbox\n+      await session.assertNoRedbox()\n+      expect(await browser.elementById('param').text()).toBe('en us')\n+    })\n+  } else {\n+    it('should allow using root params within a \"use cache: private\" - start', async () => {\n+      const browser = await next.browser('/en/us/use-cache-private')\n+      expect(await browser.elementById('param').text()).toBe('en us')\n+    })\n+  }\n+})\n+\n describe('app-root-param-getters - cache - at build', () => {\n   const { next, isNextDev } = nextTestSetup({\n     files: join(__dirname, 'fixtures', 'use-cache-build'),"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 101,
        "deletions": 23
    }
}