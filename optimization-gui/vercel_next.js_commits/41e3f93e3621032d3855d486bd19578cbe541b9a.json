{
    "author": "timneutkens",
    "message": "Add experimental option to use no-cache instead of no-store in dev (#88182)\n\n## What?\n\nAdds `experimental.devCacheControlNoCache` to test `no-cache` vs\n`no-store` for development.\n\nNote: This is for testing only right now. If it's an improvement we'll\nchange the default.",
    "sha": "41e3f93e3621032d3855d486bd19578cbe541b9a",
    "files": [
        {
            "sha": "3600f5b7336d0e634dc05bdbba0f965beba0ebd0",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -999,7 +999,12 @@ export async function handler(\n \n       // In dev, we should not cache pages for any reason.\n       if (routeModule.isDev) {\n-        res.setHeader('Cache-Control', 'no-store, must-revalidate')\n+        res.setHeader(\n+          'Cache-Control',\n+          nextConfig.experimental.devCacheControlNoCache\n+            ? 'no-cache, must-revalidate'\n+            : 'no-store, must-revalidate'\n+        )\n       }\n \n       if (!cacheEntry) {"
        },
        {
            "sha": "28bc5cd18455c910bba4343153c8061c656530a5",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -1782,7 +1782,12 @@ export default abstract class Server<\n \n       // In dev, we should not cache pages for any reason.\n       if (dev) {\n-        res.setHeader('Cache-Control', 'no-store, must-revalidate')\n+        res.setHeader(\n+          'Cache-Control',\n+          this.nextConfig.experimental.devCacheControlNoCache\n+            ? 'no-cache, must-revalidate'\n+            : 'no-store, must-revalidate'\n+        )\n         cacheControl = undefined\n       }\n "
        },
        {
            "sha": "4a3f925f47c0f200917ea55e48b1f20d9a400857",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -352,6 +352,7 @@ export const experimentalSchema = {\n   lockDistDir: z.boolean().optional(),\n   hideLogsAfterAbort: z.boolean().optional(),\n   runtimeServerDeploymentId: z.boolean().optional(),\n+  devCacheControlNoCache: z.boolean().optional(),\n }\n \n export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>"
        },
        {
            "sha": "11a921895a9db1f1ece959f52d30d2d2f586d92a",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -873,6 +873,18 @@ export interface ExperimentalConfig {\n    * @default false\n    */\n   runtimeServerDeploymentId?: boolean\n+\n+  /**\n+   * Use 'no-cache' instead of 'no-store' in the Cache-Control header for development.\n+   * This allows conditional requests to the server, which can help with development\n+   * workflows that benefit from caching validation.\n+   *\n+   * When enabled, the Cache-Control header changes from 'no-store, must-revalidate'\n+   * to 'no-cache, must-revalidate'.\n+   *\n+   * @default false\n+   */\n+  devCacheControlNoCache?: boolean\n }\n \n export type ExportPathMap = {\n@@ -1599,6 +1611,7 @@ export const defaultConfig = Object.freeze({\n     turbopackFileSystemCacheForDev: true,\n     turbopackFileSystemCacheForBuild: false,\n     turbopackInferModuleSideEffects: !isStableBuild(),\n+    devCacheControlNoCache: false,\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,\n@@ -1695,6 +1708,7 @@ export interface NextConfigRuntime {\n     | 'testProxy'\n     | 'runtimeServerDeploymentId'\n     | 'maxPostponedStateSize'\n+    | 'devCacheControlNoCache'\n   > & {\n     // Pick on @internal fields generates invalid .d.ts files\n     /** @internal */\n@@ -1752,6 +1766,7 @@ export function getNextConfigRuntime(\n         testProxy: ex.testProxy,\n         runtimeServerDeploymentId: ex.runtimeServerDeploymentId,\n         maxPostponedStateSize: ex.maxPostponedStateSize,\n+        devCacheControlNoCache: ex.devCacheControlNoCache,\n \n         trustHostHeader: ex.trustHostHeader,\n         isExperimentalCompile: ex.isExperimentalCompile,"
        },
        {
            "sha": "6c606c34ea4a452f67fc6b22b4988287fb35baf5",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -497,7 +497,12 @@ export async function initialize(opts: {\n           matchedOutput.type === 'nextStaticFolder'\n         ) {\n           if (opts.dev && !isNextFont(parsedUrl.pathname)) {\n-            res.setHeader('Cache-Control', 'no-store, must-revalidate')\n+            res.setHeader(\n+              'Cache-Control',\n+              config.experimental.devCacheControlNoCache\n+                ? 'no-cache, must-revalidate'\n+                : 'no-store, must-revalidate'\n+            )\n           } else {\n             res.setHeader(\n               'Cache-Control',"
        },
        {
            "sha": "93dbb5515b02cde4bc2e84f3ed483772fb88fdee",
            "filename": "packages/next/src/server/route-modules/pages/pages-handler.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -684,7 +684,12 @@ export const getHandler = ({\n \n         // In dev, we should not cache pages for any reason.\n         if (routeModule.isDev) {\n-          res.setHeader('Cache-Control', 'no-store, must-revalidate')\n+          res.setHeader(\n+            'Cache-Control',\n+            nextConfig.experimental.devCacheControlNoCache\n+              ? 'no-cache, must-revalidate'\n+              : 'no-store, must-revalidate'\n+          )\n         }\n \n         // Draft mode should never be cached"
        },
        {
            "sha": "cabb5263b5216af10ce6883a79c4707bb7722581",
            "filename": "test/development/dev-cache-control-no-cache-disabled/app/app-route/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fapp%2Fapp-route%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fapp%2Fapp-route%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fapp%2Fapp-route%2Fpage.js?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,3 @@\n+export default function AppRoute() {\n+  return <div>App Route</div>\n+}"
        },
        {
            "sha": "4ee00a218505ac95ed8f4b2cb12779643277286d",
            "filename": "test/development/dev-cache-control-no-cache-disabled/app/layout.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fapp%2Flayout.js?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,7 @@\n+export default function RootLayout({ children }) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "5f1cf1f12fa784817bc9ac33eec666b3d021b522",
            "filename": "test/development/dev-cache-control-no-cache-disabled/dev-cache-control-no-cache-disabled.test.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fdev-cache-control-no-cache-disabled.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fdev-cache-control-no-cache-disabled.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fdev-cache-control-no-cache-disabled.test.ts?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,17 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('experimental.devCacheControlNoCache disabled (default)', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should use no-store for pages router by default', async () => {\n+    const res = await next.fetch('/pages-route')\n+    expect(res.headers.get('Cache-Control')).toBe('no-store, must-revalidate')\n+  })\n+\n+  it('should use no-store for app router by default', async () => {\n+    const res = await next.fetch('/app-route')\n+    expect(res.headers.get('Cache-Control')).toBe('no-store, must-revalidate')\n+  })\n+})"
        },
        {
            "sha": "5a877d2dbfabadf8c5ac71e20d1b1a466eb34320",
            "filename": "test/development/dev-cache-control-no-cache-disabled/next.config.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fnext.config.js?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,2 @@\n+/** @type {import('next').NextConfig} */\n+module.exports = {}"
        },
        {
            "sha": "80120c33615c5233ce87e663d276acf88132a16c",
            "filename": "test/development/dev-cache-control-no-cache-disabled/pages/pages-route.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fpages%2Fpages-route.js",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fpages%2Fpages-route.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache-disabled%2Fpages%2Fpages-route.js?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,3 @@\n+export default function PagesRoute() {\n+  return <div>Pages Route</div>\n+}"
        },
        {
            "sha": "cabb5263b5216af10ce6883a79c4707bb7722581",
            "filename": "test/development/dev-cache-control-no-cache/app/app-route/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fapp%2Fapp-route%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fapp%2Fapp-route%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fapp%2Fapp-route%2Fpage.js?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,3 @@\n+export default function AppRoute() {\n+  return <div>App Route</div>\n+}"
        },
        {
            "sha": "4ee00a218505ac95ed8f4b2cb12779643277286d",
            "filename": "test/development/dev-cache-control-no-cache/app/layout.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fapp%2Flayout.js?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,7 @@\n+export default function RootLayout({ children }) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "edbe93714b89392f59a1ddf99b83768a073b1639",
            "filename": "test/development/dev-cache-control-no-cache/dev-cache-control-no-cache.test.ts",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fdev-cache-control-no-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fdev-cache-control-no-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fdev-cache-control-no-cache.test.ts?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,19 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('experimental.devCacheControlNoCache', () => {\n+  describe('when enabled', () => {\n+    const { next } = nextTestSetup({\n+      files: __dirname,\n+    })\n+\n+    it('should use no-cache instead of no-store for pages router', async () => {\n+      const res = await next.fetch('/pages-route')\n+      expect(res.headers.get('Cache-Control')).toBe('no-cache, must-revalidate')\n+    })\n+\n+    it('should use no-cache instead of no-store for app router', async () => {\n+      const res = await next.fetch('/app-route')\n+      expect(res.headers.get('Cache-Control')).toBe('no-cache, must-revalidate')\n+    })\n+  })\n+})"
        },
        {
            "sha": "0f939a1f9b510e82f53f0c24c802109d502b9a89",
            "filename": "test/development/dev-cache-control-no-cache/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fnext.config.js?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,6 @@\n+/** @type {import('next').NextConfig} */\n+module.exports = {\n+  experimental: {\n+    devCacheControlNoCache: true,\n+  },\n+}"
        },
        {
            "sha": "80120c33615c5233ce87e663d276acf88132a16c",
            "filename": "test/development/dev-cache-control-no-cache/pages/pages-route.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fpages%2Fpages-route.js",
            "raw_url": "https://github.com/vercel/next.js/raw/41e3f93e3621032d3855d486bd19578cbe541b9a/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fpages%2Fpages-route.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fdev-cache-control-no-cache%2Fpages%2Fpages-route.js?ref=41e3f93e3621032d3855d486bd19578cbe541b9a",
            "patch": "@@ -0,0 +1,3 @@\n+export default function PagesRoute() {\n+  return <div>Pages Route</div>\n+}"
        }
    ],
    "stats": {
        "total": 114,
        "additions": 110,
        "deletions": 4
    }
}