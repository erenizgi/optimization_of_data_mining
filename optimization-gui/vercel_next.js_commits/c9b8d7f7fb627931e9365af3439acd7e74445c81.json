{
    "author": "sokra",
    "message": "Turbopack: parallel drop data before shutdown (#82335)\n\n### What?\n\nDrop the turbo tasks data on shutdown in parallel to reduce memory usage before database compaction starts.",
    "sha": "c9b8d7f7fb627931e9365af3439acd7e74445c81",
    "files": [
        {
            "sha": "510f3c2299936e36afd5e7e6310fd7d25b2d5ee2",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=c9b8d7f7fb627931e9365af3439acd7e74445c81",
            "patch": "@@ -64,7 +64,8 @@ use crate::{\n         InProgressCellState, InProgressState, InProgressStateInner, OutputValue, RootType,\n     },\n     utils::{\n-        bi_map::BiMap, chunked_vec::ChunkedVec, ptr_eq_arc::PtrEqArc, sharded::Sharded, swap_retain,\n+        bi_map::BiMap, chunked_vec::ChunkedVec, dash_map_drop_contents::drop_contents,\n+        ptr_eq_arc::PtrEqArc, sharded::Sharded, swap_retain,\n     },\n };\n \n@@ -1216,6 +1217,9 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             self.is_idle.store(false, Ordering::Release);\n             self.verify_aggregation_graph(turbo_tasks, false);\n         }\n+        self.task_cache.drop_contents();\n+        drop_contents(&self.transient_tasks);\n+        self.storage.drop_contents();\n         if let Err(err) = self.backing_storage.shutdown() {\n             println!(\"Shutting down failed: {err}\");\n         }"
        },
        {
            "sha": "60da5545b8579bfc893fb4e077c55554e15b8c40",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/storage.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs?ref=c9b8d7f7fb627931e9365af3439acd7e74445c81",
            "patch": "@@ -16,7 +16,10 @@ use crate::{\n         CachedDataItemValue, CachedDataItemValueRef, CachedDataItemValueRefMut, OutputValue,\n     },\n     data_storage::{AutoMapStorage, OptionStorage},\n-    utils::dash_map_multi::{RefMut, get_multiple_mut},\n+    utils::{\n+        dash_map_drop_contents::drop_contents,\n+        dash_map_multi::{RefMut, get_multiple_mut},\n+    },\n };\n \n #[derive(Debug, Clone, Copy, PartialEq, Eq, Hash)]\n@@ -806,6 +809,11 @@ impl Storage {\n             },\n         )\n     }\n+\n+    pub fn drop_contents(&self) {\n+        drop_contents(&self.map);\n+        drop_contents(&self.modified);\n+    }\n }\n \n pub struct StorageWriteGuard<'a> {"
        },
        {
            "sha": "bf912a248613d5ab54db06020ca894ad98d5bf5d",
            "filename": "turbopack/crates/turbo-tasks-backend/src/utils/bi_map.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fbi_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fbi_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fbi_map.rs?ref=c9b8d7f7fb627931e9365af3439acd7e74445c81",
            "patch": "@@ -3,6 +3,8 @@ use std::{borrow::Borrow, hash::Hash};\n use dashmap::mapref::entry::Entry;\n use turbo_tasks::FxDashMap;\n \n+use crate::utils::dash_map_drop_contents::drop_contents;\n+\n /// A bidirectional [`FxDashMap`] that allows lookup by key or value.\n ///\n /// As keys and values are stored twice, they should be small types, such as\n@@ -53,3 +55,14 @@ where\n         }\n     }\n }\n+\n+impl<K, V> BiMap<K, V>\n+where\n+    K: Eq + Hash + Send + Sync,\n+    V: Eq + Hash + Send + Sync,\n+{\n+    pub fn drop_contents(&self) {\n+        drop_contents(&self.forward);\n+        drop_contents(&self.reverse);\n+    }\n+}"
        },
        {
            "sha": "480f9b20cb423b45fcf67e33ea9243c532db86e3",
            "filename": "turbopack/crates/turbo-tasks-backend/src/utils/dash_map_drop_contents.rs",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdash_map_drop_contents.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdash_map_drop_contents.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdash_map_drop_contents.rs?ref=c9b8d7f7fb627931e9365af3439acd7e74445c81",
            "patch": "@@ -0,0 +1,17 @@\n+use std::{\n+    hash::{BuildHasher, Hash},\n+    mem::take,\n+};\n+\n+use dashmap::DashMap;\n+use turbo_tasks::parallel;\n+\n+pub fn drop_contents<K: Hash + Eq + Send + Sync, V: Send + Sync, H: BuildHasher + Clone>(\n+    map: &DashMap<K, V, H>,\n+) {\n+    let shards = map.shards();\n+    parallel::for_each(shards, |shard| {\n+        let table = take(&mut *shard.write());\n+        drop(table);\n+    });\n+}"
        },
        {
            "sha": "784ec44fe564a44154993151c9645f588316f376",
            "filename": "turbopack/crates/turbo-tasks-backend/src/utils/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c9b8d7f7fb627931e9365af3439acd7e74445c81/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs?ref=c9b8d7f7fb627931e9365af3439acd7e74445c81",
            "patch": "@@ -1,5 +1,6 @@\n pub mod bi_map;\n pub mod chunked_vec;\n+pub mod dash_map_drop_contents;\n pub mod dash_map_multi;\n pub mod ptr_eq_arc;\n pub mod sharded;"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 45,
        "deletions": 2
    }
}