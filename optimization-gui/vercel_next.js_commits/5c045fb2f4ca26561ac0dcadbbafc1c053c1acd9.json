{
    "author": "unstubbable",
    "message": "[ci] Improve change detection logic in `run-for-change` script (#85619)\n\nThis PR extracts the existing git change detection logic from the `get-changed-tests` script into a separate module. This allows reusing the same logic in the `run-for-change` script, ensuring consistent behavior across the two scripts to determine changed files. Specifically, this ensures that in stacked PRs, the docs-only change detection (and the test-only change detection in the upstack PR) works correctly by diffing against the appropriate base branch.",
    "sha": "5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9",
    "files": [
        {
            "sha": "a77229e87eec59854f7bcb2bb8edda29cac422cd",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9",
            "patch": "@@ -57,7 +57,7 @@ jobs:\n           elif [ '${{ github.event_name }}' == 'workflow_dispatch' ]\n           then\n             echo \"value=force-preview\" >> $GITHUB_OUTPUT\n-          elif [[ $(node scripts/run-for-change.js --not --type docs --exec echo 'false') != 'false' ]];\n+          elif [[ $(node scripts/run-for-change.mjs --not --type docs --exec echo 'false') != 'false' ]];\n           then\n             echo \"value=skipped\" >> $GITHUB_OUTPUT\n           else"
        },
        {
            "sha": "e8f12ef28d127d9b66223f5c4acac2e6714dfc61",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9",
            "patch": "@@ -33,7 +33,7 @@ jobs:\n         id: docs-change\n         run: |\n           echo \"DOCS_ONLY<<EOF\" >> $GITHUB_OUTPUT;\n-          echo \"$(node scripts/run-for-change.js --not --type docs --exec echo 'false')\" >> $GITHUB_OUTPUT;\n+          echo \"$(node scripts/run-for-change.mjs --not --type docs --exec echo 'false')\" >> $GITHUB_OUTPUT;\n           echo 'EOF' >> $GITHUB_OUTPUT\n \n       - name: check for release"
        },
        {
            "sha": "3425495177121ee784b2f415c60126b002d04db1",
            "filename": ".github/workflows/pull_request_stats.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/.github%2Fworkflows%2Fpull_request_stats.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/.github%2Fworkflows%2Fpull_request_stats.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fpull_request_stats.yml?ref=5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9",
            "patch": "@@ -46,7 +46,7 @@ jobs:\n           fetch-depth: 25\n \n       - name: Check non-docs only change\n-        run: echo \"DOCS_CHANGE<<EOF\" >> $GITHUB_OUTPUT; echo \"$(node scripts/run-for-change.js --not --type docs --exec echo 'nope')\" >> $GITHUB_OUTPUT; echo 'EOF' >> $GITHUB_OUTPUT\n+        run: echo \"DOCS_CHANGE<<EOF\" >> $GITHUB_OUTPUT; echo \"$(node scripts/run-for-change.mjs --not --type docs --exec echo 'nope')\" >> $GITHUB_OUTPUT; echo 'EOF' >> $GITHUB_OUTPUT\n         id: docs-change\n \n       - uses: actions/download-artifact@v4"
        },
        {
            "sha": "6cbaf68041775cef7c0fcf457190e09e457b2e13",
            "filename": "scripts/deploy-examples.sh",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/scripts%2Fdeploy-examples.sh",
            "raw_url": "https://github.com/vercel/next.js/raw/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/scripts%2Fdeploy-examples.sh",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fdeploy-examples.sh?ref=5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9",
            "patch": "@@ -1,7 +1,7 @@\n #!/usr/bin/env bash\n set -euo pipefail\n \n-#CHANGED_EXAMPLES=$(node scripts/run-for-change.js --type deploy-examples --listChangedDirectories)\n+#CHANGED_EXAMPLES=$(node scripts/run-for-change.mjs --type deploy-examples --listChangedDirectories)\n ##### TODO: fix the script above so it can work for stable releases which reach back multiple commits\n CHANGED_EXAMPLES=\"examples/image-component\" # always deploy as a workaround\n "
        },
        {
            "sha": "b0db759d7e70b95d55f1e9a6052bcabc03c6f208",
            "filename": "scripts/get-changed-tests.mjs",
            "status": "modified",
            "additions": 3,
            "deletions": 61,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/scripts%2Fget-changed-tests.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/scripts%2Fget-changed-tests.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fget-changed-tests.mjs?ref=5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9",
            "patch": "@@ -2,83 +2,25 @@\n import fs from 'fs/promises'\n import execa from 'execa'\n import path from 'path'\n+import { getDiffRevision, getGitInfo } from './git-info.mjs'\n \n /**\n  * Detects changed tests files by comparing the current branch with `origin/canary`\n  * Returns tests separated by test mode (dev/prod), as well as the corresponding commit hash\n  * that the current branch is pointing to\n  */\n export default async function getChangedTests() {\n-  let eventData = {}\n-\n   /** @type import('execa').Options */\n   const EXECA_OPTS = { shell: true }\n-  /** @type import('execa').Options */\n-  const EXECA_OPTS_STDIO = { ...EXECA_OPTS, stdio: 'inherit' }\n-\n-  try {\n-    eventData =\n-      JSON.parse(\n-        await fs.readFile(process.env.GITHUB_EVENT_PATH || '', 'utf8')\n-      )['pull_request'] || {}\n-  } catch (_) {}\n-\n-  const branchName =\n-    eventData?.head?.ref ||\n-    process.env.GITHUB_REF_NAME ||\n-    (await execa('git rev-parse --abbrev-ref HEAD', EXECA_OPTS)).stdout\n \n-  const remoteUrl =\n-    eventData?.head?.repo?.full_name ||\n-    process.env.GITHUB_REPOSITORY ||\n-    (await execa('git remote get-url origin', EXECA_OPTS)).stdout\n-\n-  const commitSha =\n-    eventData?.head?.sha ||\n-    process.env.GITHUB_SHA ||\n-    (await execa('git rev-parse HEAD', EXECA_OPTS)).stdout\n-\n-  const isCanary =\n-    branchName.trim() === 'canary' && remoteUrl.includes('vercel/next.js')\n+  const { branchName, remoteUrl, commitSha, isCanary } = await getGitInfo()\n \n   if (isCanary) {\n     console.log(`Skipping flake detection for canary`)\n     return { devTests: [], prodTests: [] }\n   }\n \n-  let diffRevision\n-  if (\n-    process.env.GITHUB_ACTIONS === 'true' &&\n-    process.env.GITHUB_EVENT_NAME === 'pull_request'\n-  ) {\n-    // GH Actions for `pull_request` run on the merge commit so HEAD~1:\n-    // 1. includes all changes in the PR\n-    //    e.g. in\n-    //    A-B-C-main - F\n-    //     \\          /\n-    //      D-E-branch\n-    //    GH actions for `branch` runs on F, so a diff for HEAD~1 includes the diff of D and E combined\n-    // 2. Includes all changes of the commit for pushes\n-    diffRevision = 'HEAD~1'\n-  } else {\n-    try {\n-      await execa(\n-        'git remote set-branches --add origin canary',\n-        EXECA_OPTS_STDIO\n-      )\n-      await execa('git fetch origin canary --depth=20', EXECA_OPTS_STDIO)\n-    } catch (err) {\n-      console.error(await execa('git remote -v', EXECA_OPTS_STDIO))\n-      console.error(`Failed to fetch origin/canary`, err)\n-    }\n-    // TODO: We should diff against the merge base with origin/canary not directly against origin/canary.\n-    // A --- B ---- origin/canary\n-    //  \\\n-    //   \\-- C ---- HEAD\n-    // `git diff origin/canary` includes B and C\n-    // But we should only include C.\n-    diffRevision = 'origin/canary'\n-  }\n+  const diffRevision = await getDiffRevision()\n \n   const changesResult = await execa(\n     `git diff ${diffRevision} --name-only`,"
        },
        {
            "sha": "f9f49ff810fd5aa04c0a75b9630a8cddef7312bb",
            "filename": "scripts/git-info.mjs",
            "status": "added",
            "additions": 79,
            "deletions": 0,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/scripts%2Fgit-info.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/scripts%2Fgit-info.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fgit-info.mjs?ref=5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9",
            "patch": "@@ -0,0 +1,79 @@\n+// @ts-check\n+import fs from 'fs/promises'\n+import { promisify } from 'util'\n+import { exec as execOrig } from 'child_process'\n+\n+const exec = promisify(execOrig)\n+\n+/**\n+ * Gets git repository information from the environment\n+ * @returns {Promise<{branchName: string, remoteUrl: string, commitSha: string, isCanary: boolean}>}\n+ */\n+export async function getGitInfo() {\n+  let eventData = {}\n+\n+  try {\n+    eventData =\n+      JSON.parse(\n+        await fs.readFile(process.env.GITHUB_EVENT_PATH || '', 'utf8')\n+      )['pull_request'] || {}\n+  } catch (_) {}\n+\n+  const branchName =\n+    eventData?.head?.ref ||\n+    process.env.GITHUB_REF_NAME ||\n+    (await exec('git rev-parse --abbrev-ref HEAD')).stdout.trim()\n+\n+  const remoteUrl =\n+    eventData?.head?.repo?.full_name ||\n+    process.env.GITHUB_REPOSITORY ||\n+    (await exec('git remote get-url origin')).stdout.trim()\n+\n+  const commitSha =\n+    eventData?.head?.sha ||\n+    process.env.GITHUB_SHA ||\n+    (await exec('git rev-parse HEAD')).stdout.trim()\n+\n+  const isCanary =\n+    branchName === 'canary' && remoteUrl.includes('vercel/next.js')\n+\n+  return { branchName, remoteUrl, commitSha, isCanary }\n+}\n+\n+/**\n+ * Determines the appropriate git diff revision based on the environment\n+ * @returns {Promise<string>} The git revision to diff against\n+ */\n+export async function getDiffRevision() {\n+  if (\n+    process.env.GITHUB_ACTIONS === 'true' &&\n+    process.env.GITHUB_EVENT_NAME === 'pull_request'\n+  ) {\n+    // GH Actions for `pull_request` run on the merge commit so HEAD~1:\n+    // 1. includes all changes in the PR\n+    //    e.g. in\n+    //    A-B-C-main - F\n+    //     \\          /\n+    //      D-E-branch\n+    //    GH actions for `branch` runs on F, so a diff for HEAD~1 includes the diff of D and E combined\n+    // 2. Includes all changes of the commit for pushes\n+    return 'HEAD~1'\n+  } else {\n+    try {\n+      await exec('git remote set-branches --add origin canary')\n+      await exec('git fetch origin canary --depth=20')\n+    } catch (err) {\n+      const remoteInfo = await exec('git remote -v')\n+      console.error(remoteInfo.stdout)\n+      console.error(remoteInfo.stderr)\n+      console.error(`Failed to fetch origin/canary`, err)\n+    }\n+    // TODO: We should diff against the merge base with origin/canary not directly against origin/canary.\n+    // A --- B ---- origin/canary\n+    //  \\\n+    //   \\-- C ---- HEAD\n+    // `git diff origin/canary` includes B and C\n+    // But we should only include C.\n+    return 'origin/canary'\n+  }\n+}"
        },
        {
            "sha": "56232c6b622f59ff95a05fd372663a1de835025b",
            "filename": "scripts/run-for-change.mjs",
            "status": "renamed",
            "additions": 18,
            "deletions": 43,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/scripts%2Frun-for-change.mjs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9/scripts%2Frun-for-change.mjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Frun-for-change.mjs?ref=5c045fb2f4ca26561ac0dcadbbafc1c053c1acd9",
            "patch": "@@ -1,5 +1,7 @@\n-const { promisify } = require('util')\n-const { exec: execOrig, spawn } = require('child_process')\n+// @ts-check\n+import { promisify } from 'util'\n+import { exec as execOrig, spawn } from 'child_process'\n+import { getDiffRevision, getGitInfo } from './git-info.mjs'\n \n const exec = promisify(execOrig)\n \n@@ -55,43 +57,16 @@ const CHANGE_ITEM_GROUPS = {\n }\n \n async function main() {\n-  let eventData = {}\n-\n-  try {\n-    eventData = require(process.env.GITHUB_EVENT_PATH)['pull_request'] || {}\n-  } catch (_) {}\n-\n-  const branchName =\n-    eventData?.head?.ref ||\n-    process.env.GITHUB_REF_NAME ||\n-    (await exec('git rev-parse --abbrev-ref HEAD')).stdout\n-\n-  const remoteUrl =\n-    eventData?.head?.repo?.full_name ||\n-    process.env.GITHUB_REPOSITORY ||\n-    (await exec('git remote get-url origin')).stdout\n-\n-  const isCanary =\n-    branchName.trim() === 'canary' && remoteUrl.includes('vercel/next.js')\n-\n-  try {\n-    await exec('git remote set-branches --add origin canary')\n-    await exec('git fetch origin canary --depth=20')\n-  } catch (err) {\n-    console.error(await exec('git remote -v'))\n-    console.error(`Failed to fetch origin/canary`, err)\n-  }\n-  // if we are on the canary branch only diff current commit\n-  const toDiff = isCanary\n-    ? `${process.env.GITHUB_SHA || 'canary'}~`\n-    : 'origin/canary...'\n-\n-  const changesResult = await exec(`git diff ${toDiff} --name-only`).catch(\n-    (err) => {\n-      console.error(err)\n-      return { stdout: '' }\n-    }\n-  )\n+  const { branchName, remoteUrl, isCanary } = await getGitInfo()\n+  const diffRevision = await getDiffRevision()\n+\n+  const changesResult = await exec(\n+    `git diff ${diffRevision} --name-only`\n+  ).catch((err) => {\n+    console.error(err)\n+    return { stdout: '' }\n+  })\n+\n   console.error({ branchName, remoteUrl, isCanary, changesResult })\n   const changedFilesOutput = changesResult.stdout\n \n@@ -102,7 +77,7 @@ async function main() {\n \n   if (!type) {\n     throw new Error(\n-      `Missing \"--type\" flag, e.g. \"node run-for-change.js --type docs\"`\n+      `Missing \"--type\" flag, e.g. \"node run-for-change.mjs --type docs\"`\n     )\n   }\n   const execArgIndex = process.argv.indexOf('--exec')\n@@ -131,7 +106,7 @@ async function main() {\n     )\n   }\n   let changedFilesCount = 0\n-  let changedDirectories = []\n+  let changedDirectories = new Set()\n \n   // always run for canary if flag is enabled\n   if (alwaysCanary && branchName === 'canary') {\n@@ -151,7 +126,7 @@ async function main() {\n       const matchesItem = changeItems.some((item) => {\n         const found = file.startsWith(item)\n         if (found) {\n-          changedDirectories.push(item)\n+          changedDirectories.add(item)\n         }\n         return found\n       })\n@@ -176,7 +151,7 @@ async function main() {\n \n   if (hasMatchingChange) {\n     if (listChangedDirectories) {\n-      console.log(changedDirectories.join('\\n'))\n+      console.log(Array.from(changedDirectories).join('\\n'))\n       return\n     }\n     const cmd = spawn(execArgs[0], execArgs.slice(1))",
            "previous_filename": "scripts/run-for-change.js"
        }
    ],
    "stats": {
        "total": 212,
        "additions": 104,
        "deletions": 108
    }
}