{
    "author": "mischnic",
    "message": "Use JSONC for default server-external-packages (#86252)\n\nSo that we can then use comments to track a reason why we have added packages to this list.",
    "sha": "10e0828fb9a8d6dc586105b28691e94f7390c923",
    "files": [
        {
            "sha": "41e0c4077e151b9fa93f9383fe7f655f135a46c8",
            "filename": "crates/next-core/src/next_font/google/font_fallback.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Ffont_fallback.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Ffont_fallback.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Ffont_fallback.rs?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -17,7 +17,7 @@ use crate::{\n         issue::NextFontIssue,\n         util::{FontFamilyType, get_scoped_font_family},\n     },\n-    util::load_next_js_templateon,\n+    util::load_next_js_json_file,\n };\n \n /// An entry in the Google fonts metrics map\n@@ -45,7 +45,7 @@ struct Fallback {\n // This JSON file is large, so we cache it in turbotasks\n #[turbo_tasks::function]\n async fn load_font_metrics(project_root: FileSystemPath) -> Result<Vc<FontMetricsMap>> {\n-    let data: FontMetricsMap = load_next_js_templateon(\n+    let data: FontMetricsMap = load_next_js_json_file(\n         project_root,\n         rcstr!(\"dist/server/capsize-font-metrics.json\"),\n     )"
        },
        {
            "sha": "d966412f0c3a64100fe44e6dd8a438f2a439e67c",
            "filename": "crates/next-core/src/next_font/google/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -52,7 +52,7 @@ use super::{\n };\n use crate::{\n     embed_js::next_js_file_path, mode::NextMode, next_app::metadata::split_extension,\n-    next_font::issue::NextFontIssue, util::load_next_js_templateon,\n+    next_font::issue::NextFontIssue, util::load_next_js_json_file,\n };\n \n pub mod font_fallback;\n@@ -466,7 +466,7 @@ impl ImportMappingReplacement for NextFontGoogleFontFileReplacer {\n \n #[turbo_tasks::function]\n async fn load_font_data(project_root: FileSystemPath) -> Result<Vc<FontData>> {\n-    let data: FontData = load_next_js_templateon(\n+    let data: FontData = load_next_js_json_file(\n         project_root,\n         rcstr!(\"dist/compiled/@next/font/dist/google/font-data.json\"),\n     )"
        },
        {
            "sha": "e9cfc065c211e41e1ddd22c3afb936413b62ba39",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -73,7 +73,7 @@ use crate::{\n     },\n     util::{\n         NextRuntime, OptionEnvMap, defines, foreign_code_context_condition,\n-        get_transpiled_packages, internal_assets_conditions, load_next_js_templateon,\n+        get_transpiled_packages, internal_assets_conditions, load_next_js_jsonc_file,\n         module_styles_rule_condition,\n     },\n };\n@@ -162,9 +162,9 @@ pub async fn get_server_resolve_options_context(\n             .await?;\n \n     // Always load these predefined packages as external.\n-    let mut external_packages: Vec<RcStr> = load_next_js_templateon(\n+    let mut external_packages: Vec<RcStr> = load_next_js_jsonc_file(\n         project_path.clone(),\n-        rcstr!(\"dist/lib/server-external-packages.json\"),\n+        rcstr!(\"dist/lib/server-external-packages.jsonc\"),\n     )\n     .await?;\n "
        },
        {
            "sha": "06c17d4b98dcbfd2211192854003e6ef2faa5d63",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 33,
            "deletions": 14,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -1,13 +1,12 @@\n use std::{fmt::Display, str::FromStr};\n \n-use anyhow::{Result, bail};\n+use anyhow::{Result, anyhow, bail};\n use next_taskless::expand_next_js_template;\n use serde::{Deserialize, Serialize, de::DeserializeOwned};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{FxIndexMap, NonLocalValue, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::{\n-    self, File, FileContent, FileSystem, FileSystemPath, json::parse_json_rope_with_source_context,\n-    rope::Rope,\n+    self, File, FileContent, FileJsonContent, FileSystem, FileSystemPath, rope::Rope,\n };\n use turbopack::module_options::RuleCondition;\n use turbopack_core::{\n@@ -118,7 +117,7 @@ pub async fn get_transpiled_packages(\n ) -> Result<Vc<Vec<RcStr>>> {\n     let mut transpile_packages: Vec<RcStr> = next_config.transpile_packages().owned().await?;\n \n-    let default_transpiled_packages: Vec<RcStr> = load_next_js_templateon(\n+    let default_transpiled_packages: Vec<RcStr> = load_next_js_json_file(\n         project_path,\n         rcstr!(\"dist/lib/default-transpiled-packages.json\"),\n     )\n@@ -288,24 +287,44 @@ async fn virtual_next_js_template_path(\n         .join(&format!(\"{NEXT_TEMPLATE_PATH}/{file}\"))\n }\n \n-pub async fn load_next_js_templateon<T: DeserializeOwned>(\n+pub async fn load_next_js_json_file<T: DeserializeOwned>(\n     project_path: FileSystemPath,\n-    path: RcStr,\n+    sub_path: RcStr,\n ) -> Result<T> {\n-    let file_path = get_next_package(project_path.clone()).await?.join(&path)?;\n+    let file_path = get_next_package(project_path.clone())\n+        .await?\n+        .join(&sub_path)?;\n \n     let content = &*file_path.read().await?;\n \n-    let FileContent::Content(file) = content else {\n-        bail!(\n-            \"Expected file content at {}\",\n+    match content.parse_json_ref() {\n+        FileJsonContent::Unparsable(e) => Err(anyhow!(\"File is not valid JSON: {}\", e)),\n+        FileJsonContent::NotFound => Err(anyhow!(\n+            \"File not found: {:?}\",\n             file_path.value_to_string().await?\n-        );\n-    };\n+        )),\n+        FileJsonContent::Content(value) => Ok(serde_json::from_value(value)?),\n+    }\n+}\n+\n+pub async fn load_next_js_jsonc_file<T: DeserializeOwned>(\n+    project_path: FileSystemPath,\n+    sub_path: RcStr,\n+) -> Result<T> {\n+    let file_path = get_next_package(project_path.clone())\n+        .await?\n+        .join(&sub_path)?;\n \n-    let result: T = parse_json_rope_with_source_context(file.content())?;\n+    let content = &*file_path.read().await?;\n \n-    Ok(result)\n+    match content.parse_json_with_comments_ref() {\n+        FileJsonContent::Unparsable(e) => Err(anyhow!(\"File is not valid JSON: {}\", e)),\n+        FileJsonContent::NotFound => Err(anyhow!(\n+            \"File not found: {:?}\",\n+            file_path.value_to_string().await?\n+        )),\n+        FileJsonContent::Content(value) => Ok(serde_json::from_value(value)?),\n+    }\n }\n \n pub fn styles_rule_condition() -> RuleCondition {"
        },
        {
            "sha": "121bb2eaab5d19a4b4e6d9a28252d6836fb9529a",
            "filename": "docs/01-app/03-api-reference/05-config/01-next-config-js/serverExternalPackages.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FserverExternalPackages.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FserverExternalPackages.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F05-config%2F01-next-config-js%2FserverExternalPackages.mdx?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -16,7 +16,7 @@ const nextConfig = {\n module.exports = nextConfig\n ```\n \n-Next.js includes a [short list of popular packages](https://github.com/vercel/next.js/blob/canary/packages/next/src/lib/server-external-packages.json) that currently are working on compatibility and automatically opt-ed out:\n+Next.js includes a [short list of popular packages](https://github.com/vercel/next.js/blob/canary/packages/next/src/lib/server-external-packages.jsonc) that currently are working on compatibility and automatically opt-ed out:\n \n - `@appsignal/nodejs`\n - `@aws-sdk/client-s3`"
        },
        {
            "sha": "639b360797ff43fcc23dd3f93aa65ab8a87d7b30",
            "filename": "docs/02-pages/04-api-reference/04-config/01-next-config-js/serverExternalPackages.mdx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FserverExternalPackages.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FserverExternalPackages.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F02-pages%2F04-api-reference%2F04-config%2F01-next-config-js%2FserverExternalPackages.mdx?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -16,7 +16,7 @@ const nextConfig = {\n module.exports = nextConfig\n ```\n \n-Next.js includes a [short list of popular packages](https://github.com/vercel/next.js/blob/canary/packages/next/src/lib/server-external-packages.json) that currently are working on compatibility and automatically opt-ed out:\n+Next.js includes a [short list of popular packages](https://github.com/vercel/next.js/blob/canary/packages/next/src/lib/server-external-packages.jsonc) that currently are working on compatibility and automatically opt-ed out:\n \n - `@appsignal/nodejs`\n - `@aws-sdk/client-s3`"
        },
        {
            "sha": "0e0628856a615556b0e80237f0150af479025b65",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -4,6 +4,7 @@ import { yellow, bold } from '../lib/picocolors'\n import crypto from 'crypto'\n import { webpack } from 'next/dist/compiled/webpack/webpack'\n import path from 'path'\n+import fs from 'fs'\n \n import { getDefineEnv } from './define-env'\n import { escapeStringRegexp } from '../shared/lib/escape-regexp'\n@@ -95,14 +96,19 @@ import type { NextBuildContext } from './build-context'\n import type { RootParamsLoaderOpts } from './webpack/loaders/next-root-params-loader'\n import type { InvalidImportLoaderOpts } from './webpack/loaders/next-invalid-import-error-loader'\n import { defaultOverrides } from '../server/require-hook'\n+import JSON5 from 'next/dist/compiled/json5'\n \n type ExcludesFalse = <T>(x: T | false) => x is T\n type ClientEntries = {\n   [key: string]: string | string[]\n }\n \n-const EXTERNAL_PACKAGES =\n-  require('../lib/server-external-packages.json') as string[]\n+const EXTERNAL_PACKAGES = JSON5.parse(\n+  fs.readFileSync(\n+    path.join(__dirname, '../lib/server-external-packages.jsonc'),\n+    'utf8'\n+  )\n+) as string[]\n \n const DEFAULT_TRANSPILED_PACKAGES =\n   require('../lib/default-transpiled-packages.json') as string[]"
        },
        {
            "sha": "23746a7ee57b24ae1efc1f12cb1f8ca97d29ecb8",
            "filename": "packages/next/src/lib/server-external-packages.jsonc",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/packages%2Fnext%2Fsrc%2Flib%2Fserver-external-packages.jsonc",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/packages%2Fnext%2Fsrc%2Flib%2Fserver-external-packages.jsonc",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fserver-external-packages.jsonc?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -71,5 +71,5 @@\n   \"vscode-oniguruma\",\n   \"webpack\",\n   \"websocket\",\n-  \"zeromq\"\n+  \"zeromq\",\n ]",
            "previous_filename": "packages/next/src/lib/server-external-packages.json"
        },
        {
            "sha": "50322b8c060bac4526189a517b9711d33485cdba",
            "filename": "packages/next/taskfile-swc.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/packages%2Fnext%2Ftaskfile-swc.js",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/packages%2Fnext%2Ftaskfile-swc.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile-swc.js?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -20,6 +20,7 @@ module.exports = function (task) {\n       if (\n         file.base.endsWith('.d.ts') ||\n         file.base.endsWith('.json') ||\n+        file.base.endsWith('.jsonc') ||\n         file.base.endsWith('.woff2')\n       )\n         return"
        },
        {
            "sha": "10f92cdc5f990571ec21b7af8aa9c4c1b58b14cf",
            "filename": "packages/next/taskfile.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/packages%2Fnext%2Ftaskfile.js",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/packages%2Fnext%2Ftaskfile.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile.js?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -2415,14 +2415,14 @@ export async function cli(task, opts) {\n \n export async function lib(task, opts) {\n   await task\n-    .source('src/lib/**/!(*.test).+(js|ts|tsx|json)')\n+    .source('src/lib/**/!(*.test).+(js|ts|tsx|json|jsonc)')\n     .swc('server', { dev: opts.dev })\n     .target('dist/lib')\n }\n \n export async function lib_esm(task, opts) {\n   await task\n-    .source('src/lib/**/!(*.test).+(js|ts|tsx|json)')\n+    .source('src/lib/**/!(*.test).+(js|ts|tsx|json|jsonc)')\n     .swc('server', { dev: opts.dev, esm: true })\n     .target('dist/esm/lib')\n }"
        },
        {
            "sha": "e1a64b34c81bf756eb21e8d12bebbcf17f3785a7",
            "filename": "scripts/validate-externals-doc.js",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/10e0828fb9a8d6dc586105b28691e94f7390c923/scripts%2Fvalidate-externals-doc.js",
            "raw_url": "https://github.com/vercel/next.js/raw/10e0828fb9a8d6dc586105b28691e94f7390c923/scripts%2Fvalidate-externals-doc.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fvalidate-externals-doc.js?ref=10e0828fb9a8d6dc586105b28691e94f7390c923",
            "patch": "@@ -1,7 +1,16 @@\n const fs = require('fs')\n const path = require('path')\n+const JSON5 = require('next/dist/compiled/json5')\n \n-const serverExternals = require('../packages/next/src/lib/server-external-packages.json')\n+const serverExternals = JSON5.parse(\n+  fs.readFileSync(\n+    path.join(\n+      __dirname,\n+      '../packages/next/src/lib/server-external-packages.jsonc'\n+    ),\n+    'utf8'\n+  )\n+)\n \n function validate(docPath) {\n   const docContent = fs.readFileSync("
        }
    ],
    "stats": {
        "total": 93,
        "additions": 64,
        "deletions": 29
    }
}