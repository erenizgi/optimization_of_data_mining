{
    "author": "Cy-Tek",
    "message": "fix(turbopack) Fix handling of intercept route segments (#82694)\n\n## Fix handling of intercept route segments in HMR\n\n### What?\n- Made the routes in `resolve-routes.ts` get lazily initialized, and\nonly recalculated in development mode to preserve\n   performance\n- Added a test case for HMR with intercept routes\n\n### Why?\nThis change ensures that intercept route segments (and any other changed\nelements of routes), will be recalculated correctly during the\ndevelopment proecess.\n\nFixes #PACK-5246",
    "sha": "8f7f2fed8595a6430f377811dce6e12088b11429",
    "files": [
        {
            "sha": "57a541de966cc6b39038ac7320e9f1a1c64ac595",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 23,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -71,37 +71,40 @@ export function getResolveRoutes(\n   } & Partial<Header> &\n     Partial<Redirect>\n \n-  const routes: Route[] = [\n-    // _next/data with middleware handling\n-    { match: () => ({}), name: 'middleware_next_data' },\n+  let routes: Route[] | null = null\n+  const calculateRoutes = () => {\n+    return [\n+      // _next/data with middleware handling\n+      { match: () => ({}), name: 'middleware_next_data' },\n \n-    ...(opts.minimalMode ? [] : fsChecker.headers),\n-    ...(opts.minimalMode ? [] : fsChecker.redirects),\n+      ...(opts.minimalMode ? [] : fsChecker.headers),\n+      ...(opts.minimalMode ? [] : fsChecker.redirects),\n \n-    // check middleware (using matchers)\n-    { match: () => ({}), name: 'middleware' },\n+      // check middleware (using matchers)\n+      { match: () => ({}), name: 'middleware' },\n \n-    ...(opts.minimalMode ? [] : fsChecker.rewrites.beforeFiles),\n+      ...(opts.minimalMode ? [] : fsChecker.rewrites.beforeFiles),\n \n-    // check middleware (using matchers)\n-    { match: () => ({}), name: 'before_files_end' },\n+      // check middleware (using matchers)\n+      { match: () => ({}), name: 'before_files_end' },\n \n-    // we check exact matches on fs before continuing to\n-    // after files rewrites\n-    { match: () => ({}), name: 'check_fs' },\n+      // we check exact matches on fs before continuing to\n+      // after files rewrites\n+      { match: () => ({}), name: 'check_fs' },\n \n-    ...(opts.minimalMode ? [] : fsChecker.rewrites.afterFiles),\n+      ...(opts.minimalMode ? [] : fsChecker.rewrites.afterFiles),\n \n-    // we always do the check: true handling before continuing to\n-    // fallback rewrites\n-    {\n-      check: true,\n-      match: () => ({}),\n-      name: 'after files check: true',\n-    },\n+      // we always do the check: true handling before continuing to\n+      // fallback rewrites\n+      {\n+        check: true,\n+        match: () => ({}),\n+        name: 'after files check: true',\n+      },\n \n-    ...(opts.minimalMode ? [] : fsChecker.rewrites.fallback),\n-  ]\n+      ...(opts.minimalMode ? [] : fsChecker.rewrites.fallback),\n+    ]\n+  }\n \n   async function resolveRoutes({\n     req,\n@@ -131,6 +134,13 @@ export function getResolveRoutes(\n     const urlParts = (req.url || '').split('?', 1)\n     const urlNoQuery = urlParts[0]\n \n+    // Refresh the routes every time in development mode, but only initialize them\n+    // once in production. We don't need to recompute these every time unless the routes\n+    // are changing like in development, and the performance can be costly.\n+    if (!routes || opts.dev) {\n+      routes = calculateRoutes()\n+    }\n+\n     // this normalizes repeated slashes in the path e.g. hello//world ->\n     // hello/world or backslashes to forward slashes, this does not\n     // handle trailing slash as that is handled the same as a next.config.js"
        },
        {
            "sha": "7acbaf21c8e5b404c1113ee0423dd97c0848e0eb",
            "filename": "test/development/app-dir/hmr-intercept-routes/app/intercept/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Fintercept%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Fintercept%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Fintercept%2Fpage.js?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -0,0 +1,3 @@\n+export default function InterceptPage() {\n+  return <h1>I'm the intercept page</h1>\n+}"
        },
        {
            "sha": "4ee00a218505ac95ed8f4b2cb12779643277286d",
            "filename": "test/development/app-dir/hmr-intercept-routes/app/layout.js",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Flayout.js?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -0,0 +1,7 @@\n+export default function RootLayout({ children }) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "0be92e42bba945d4d44a379ffe87f4f26dec353a",
            "filename": "test/development/app-dir/hmr-intercept-routes/app/page.js",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fapp%2Fpage.js?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -0,0 +1,12 @@\n+import Link from 'next/link'\n+\n+export default function Home() {\n+  return (\n+    <div>\n+      <h1>Main Page</h1>\n+      <Link id=\"to-intercept\" href=\"/intercept\">\n+        Goto Intercept\n+      </Link>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "05c4814caee9a90acfd6875d43535a09610ec08c",
            "filename": "test/development/app-dir/hmr-intercept-routes/fixtures/@intercept/(.)intercept/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2F%40intercept%2F(.)intercept%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2F%40intercept%2F(.)intercept%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2F%40intercept%2F(.)intercept%2Fpage.js?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Intercept() {\n+  return <h1 id=\"intercept\">I'm the intercept</h1>\n+}"
        },
        {
            "sha": "32e3fe7be4f5e32ba1eacc86637ed7d886e27956",
            "filename": "test/development/app-dir/hmr-intercept-routes/fixtures/@intercept/default.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2F%40intercept%2Fdefault.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2F%40intercept%2Fdefault.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2F%40intercept%2Fdefault.js?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Default() {\n+  return <h1 id=\"default-intercept\">I'm the default intercept</h1>\n+}"
        },
        {
            "sha": "e7b27011d215d9ce7c8ffebdf09b6d3e2421255e",
            "filename": "test/development/app-dir/hmr-intercept-routes/fixtures/layout.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Ffixtures%2Flayout.js?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -0,0 +1,10 @@\n+export default function RootLayout({ children, intercept }) {\n+  return (\n+    <html lang=\"en\">\n+      <body>\n+        {children}\n+        {intercept}\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "c6ffe4ae22be3c62eb26f2ed0522acfcb44747e5",
            "filename": "test/development/app-dir/hmr-intercept-routes/hmr-intercept-routes.test.ts",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fhmr-intercept-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fhmr-intercept-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-intercept-routes%2Fhmr-intercept-routes.test.ts?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -0,0 +1,55 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+// This only works for Turbopack HMR builds\n+;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n+  'hmr-intercept-routes',\n+  () => {\n+    const { next } = nextTestSetup({\n+      files: __dirname,\n+    })\n+\n+    it('should update intercept routes via HMR', async () => {\n+      const browser = await next.browser('/')\n+      expect(await browser.elementByCss('h1').text()).toBe('Main Page')\n+\n+      const parallelDefaultContent = await next.readFile(\n+        'fixtures/@intercept/default.js'\n+      )\n+\n+      const parallelInterceptContent = await next.readFile(\n+        'fixtures/@intercept/(.)intercept/page.js'\n+      )\n+\n+      // Write the fixture files to the associated output location\n+      await next.patchFile('app/@intercept/default.js', parallelDefaultContent)\n+      await next.patchFile(\n+        'app/@intercept/(.)intercept/page.js',\n+        parallelInterceptContent\n+      )\n+\n+      // Read the original code of the root layout page\n+      const rootLayoutContent = await next.readFile('app/layout.js')\n+      const fixtureLayoutContent = await next.readFile('fixtures/layout.js')\n+\n+      // Update the root layout file with the fixture layout which includes the new parallel routes\n+      await next.patchFile('app/layout.js', fixtureLayoutContent)\n+\n+      // Check to make sure that the main page now has the correct layout changes\n+      await browser.waitForElementByCss('#default-intercept')\n+      expect(await browser.elementById('default-intercept').text()).toBe(\n+        \"I'm the default intercept\"\n+      )\n+\n+      // Go to the intercept route and check that the intercept worked correctly\n+      await browser.elementById('to-intercept').click()\n+      await browser.waitForElementByCss('#intercept')\n+      expect(await browser.elementById('intercept').text()).toBe(\n+        \"I'm the intercept\"\n+      )\n+\n+      // Reset the file statuses\n+      await next.patchFile('app/layout.js', rootLayoutContent)\n+      await next.deleteFile('app/@intercept')\n+    })\n+  }\n+)"
        },
        {
            "sha": "d0ca6580bfd0e967cd47be559e22cbb4feb995c4",
            "filename": "test/turbopack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fturbopack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8f7f2fed8595a6430f377811dce6e12088b11429/test%2Fturbopack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-dev-tests-manifest.json?ref=8f7f2fed8595a6430f377811dce6e12088b11429",
            "patch": "@@ -2539,6 +2539,13 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n+  \"test/development/app-dir/hmr-intercept-routes/hmr-intercept-routes.test.ts\": {\n+    \"passed\": [\"hmr-intercept-routes should update intercept routes via HMR\"],\n+    \"failed\": [],\n+    \"pending\": [],\n+    \"flakey\": [],\n+    \"runtimeError\": false\n+  },\n   \"test/development/app-dir/hmr-move-file/hmr-move-file.test.ts\": {\n     \"passed\": [\n       \"HMR Move File should work when moving a component to another directory\""
        }
    ],
    "stats": {
        "total": 156,
        "additions": 133,
        "deletions": 23
    }
}