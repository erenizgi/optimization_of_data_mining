{
    "author": "huozhi",
    "message": "Skip emitting pages router entries when only app router present (#82444)",
    "sha": "8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
    "files": [
        {
            "sha": "e136ee5364c14b55bde1c68112cbbb29101d88da",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -171,6 +171,7 @@ impl AppProject {\n             self.app_dir.clone(),\n             conf.page_extensions(),\n             conf.is_global_not_found_enabled(),\n+            self.project.next_mode(),\n         )\n     }\n "
        },
        {
            "sha": "bcb4857c2695e8c107d4f30e311921b46282677d",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 102,
            "deletions": 38,
            "changes": 140,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -106,9 +106,16 @@ impl PagesProject {\n             document: _,\n             error: _,\n             error_500: _,\n+            has_user_pages: _,\n+            should_create_pages_entries,\n         } = &*pages_structure.await?;\n         let mut routes = FxIndexMap::default();\n \n+        // If pages entries shouldn't be created (build mode with no pages), return empty routes\n+        if !should_create_pages_entries {\n+            return Ok(Vc::cell(routes));\n+        }\n+\n         async fn add_page_to_routes(\n             routes: &mut FxIndexMap<RcStr, Route>,\n             page: Vc<PagesStructureItem>,\n@@ -272,6 +279,7 @@ impl PagesProject {\n             self.project.project_path().owned().await?,\n             next_router_root,\n             self.project.next_config().page_extensions(),\n+            self.project.next_mode(),\n         ))\n     }\n \n@@ -1256,18 +1264,23 @@ impl PageEndpoint {\n         entry_chunk: Vc<Box<dyn OutputAsset>>,\n     ) -> Result<Vc<Box<dyn OutputAsset>>> {\n         let node_root = self.pages_project.project().node_root().await?;\n-        let chunk_path = entry_chunk.path().await?;\n-\n-        let asset_path = node_root\n-            .join(\"server\")?\n-            .get_path_to(&chunk_path)\n-            .context(\"ssr chunk entry path must be inside the node root\")?;\n \n-        let pages_manifest = PagesManifest {\n-            pages: [(self.pathname.clone(), asset_path.into())]\n+        // Check if we should include pages in the manifest\n+        let pages_structure = self.pages_structure.await?;\n+        let pages = if pages_structure.should_create_pages_entries {\n+            let chunk_path = entry_chunk.path().await?;\n+            let asset_path = node_root\n+                .join(\"server\")?\n+                .get_path_to(&chunk_path)\n+                .context(\"ssr chunk entry path must be inside the node root\")?;\n+            [(self.pathname.clone(), asset_path.into())]\n                 .into_iter()\n-                .collect(),\n+                .collect()\n+        } else {\n+            FxIndexMap::default() // Empty pages when no user pages should be created\n         };\n+\n+        let pages_manifest = PagesManifest { pages };\n         let manifest_path_prefix = get_asset_prefix_from_pathname(&self.pathname);\n         let asset = Vc::upcast(VirtualOutputAsset::new(\n             node_root.join(&format!(\n@@ -1314,8 +1327,17 @@ impl PageEndpoint {\n             .client_relative_path()\n             .owned()\n             .await?;\n+\n+        // Check if we should include pages in the manifest\n+        let pages_structure = self.pages_structure.await?;\n+        let pages = if pages_structure.should_create_pages_entries {\n+            fxindexmap!(self.pathname.clone() => client_chunks)\n+        } else {\n+            fxindexmap![] // Empty pages when no user pages should be created\n+        };\n+\n         let build_manifest = BuildManifest {\n-            pages: fxindexmap!(self.pathname.clone() => client_chunks),\n+            pages,\n             ..Default::default()\n         };\n         let manifest_path_prefix = get_asset_prefix_from_pathname(&self.pathname);\n@@ -1339,10 +1361,18 @@ impl PageEndpoint {\n         let this = self.await?;\n         let node_root = this.pages_project.project().node_root().await?;\n         let client_relative_path = this.pages_project.project().client_relative_path().await?;\n-        let page_loader_path = client_relative_path\n-            .get_relative_path_to(&*page_loader.path().await?)\n-            .context(\"failed to resolve client-relative path to page loader\")?;\n-        let client_build_manifest = fxindexmap!(this.pathname.clone() => vec![page_loader_path]);\n+\n+        // Check if we should include pages in the manifest\n+        let pages_structure = this.pages_structure.await?;\n+        let client_build_manifest = if pages_structure.should_create_pages_entries {\n+            let page_loader_path = client_relative_path\n+                .get_relative_path_to(&*page_loader.path().await?)\n+                .context(\"failed to resolve client-relative path to page loader\")?;\n+            fxindexmap!(this.pathname.clone() => vec![page_loader_path])\n+        } else {\n+            fxindexmap![] // Empty manifest when no user pages should be created\n+        };\n+\n         let manifest_path_prefix = get_asset_prefix_from_pathname(&this.pathname);\n         Ok(Vc::upcast(VirtualOutputAsset::new_with_references(\n             node_root.join(&format!(\n@@ -1372,6 +1402,7 @@ impl PageEndpoint {\n             PageEndpointType::Html => {\n                 let client_chunks = *self.client_chunks().await?.assets;\n                 client_assets.extend(client_chunks.await?.iter().map(|asset| **asset));\n+\n                 let build_manifest = self.build_manifest(client_chunks).to_resolved().await?;\n                 let page_loader = self.page_loader(client_chunks);\n                 let client_build_manifest = self\n@@ -1381,8 +1412,10 @@ impl PageEndpoint {\n                 client_assets.push(page_loader);\n                 server_assets.push(build_manifest);\n                 server_assets.push(client_build_manifest);\n+\n                 self.ssr_chunk(emit_manifests)\n             }\n+\n             PageEndpointType::Data => self.ssr_data_chunk(emit_manifests),\n             PageEndpointType::Api => self.api_chunk(emit_manifests),\n             PageEndpointType::SsrOnly => self.ssr_chunk(emit_manifests),\n@@ -1439,9 +1472,13 @@ impl PageEndpoint {\n                 dynamic_import_entries,\n                 server_asset_trace_file,\n             } => {\n-                server_assets.push(entry);\n-                if let Some(server_asset_trace_file) = &*server_asset_trace_file.await? {\n-                    server_assets.push(*server_asset_trace_file);\n+                // Only include the actual SSR entry chunk if pages should be created\n+                let pages_structure = this.pages_structure.await?;\n+                if pages_structure.should_create_pages_entries {\n+                    server_assets.push(entry);\n+                    if let Some(server_asset_trace_file) = &*server_asset_trace_file.await? {\n+                        server_assets.push(*server_asset_trace_file);\n+                    }\n                 }\n \n                 if emit_manifests != EmitManifests::None {\n@@ -1482,32 +1519,49 @@ impl PageEndpoint {\n                     };\n \n                     let files_value = files.await?;\n+\n                     if let Some(&file) = files_value.first() {\n                         let pages_manifest = self.pages_manifest(*file).to_resolved().await?;\n                         server_assets.push(pages_manifest);\n                     }\n-                    server_assets.extend(files_value.iter().copied());\n-                    file_paths_from_root\n-                        .extend(get_js_paths_from_root(&node_root, &files_value).await?);\n+\n+                    // Only include the actual edge files if pages should be created\n+                    let pages_structure = this.pages_structure.await?;\n+                    if pages_structure.should_create_pages_entries {\n+                        server_assets.extend(files_value.iter().copied());\n+                        file_paths_from_root\n+                            .extend(get_js_paths_from_root(&node_root, &files_value).await?);\n+                    }\n \n                     if emit_manifests == EmitManifests::Full {\n                         let loadable_manifest_output = self\n                             .react_loadable_manifest(*dynamic_import_entries, NextRuntime::Edge)\n                             .await?;\n-                        server_assets.extend(loadable_manifest_output.iter().copied());\n-                        file_paths_from_root.extend(\n-                            get_js_paths_from_root(&node_root, &loadable_manifest_output).await?,\n-                        );\n+                        if pages_structure.should_create_pages_entries {\n+                            server_assets.extend(loadable_manifest_output.iter().copied());\n+                            file_paths_from_root.extend(\n+                                get_js_paths_from_root(&node_root, &loadable_manifest_output)\n+                                    .await?,\n+                            );\n+                        }\n                     }\n \n-                    let all_output_assets = all_assets_from_entries(*files).await?;\n+                    let (wasm_paths_from_root, all_assets) =\n+                        if pages_structure.should_create_pages_entries {\n+                            let all_output_assets = all_assets_from_entries(*files).await?;\n \n-                    let mut wasm_paths_from_root = fxindexset![];\n-                    wasm_paths_from_root\n-                        .extend(get_wasm_paths_from_root(&node_root, &all_output_assets).await?);\n+                            let mut wasm_paths_from_root = fxindexset![];\n+                            wasm_paths_from_root.extend(\n+                                get_wasm_paths_from_root(&node_root, &all_output_assets).await?,\n+                            );\n \n-                    let all_assets =\n-                        get_asset_paths_from_root(&node_root, &all_output_assets).await?;\n+                            let all_assets =\n+                                get_asset_paths_from_root(&node_root, &all_output_assets).await?;\n+\n+                            (wasm_paths_from_root, all_assets)\n+                        } else {\n+                            (fxindexset![], vec![])\n+                        };\n \n                     let named_regex = get_named_middleware_regex(&this.pathname).into();\n                     let matchers = MiddlewareMatcher {\n@@ -1649,14 +1703,24 @@ impl Endpoint for PageEndpoint {\n \n             let node_root = node_root.clone();\n             let written_endpoint = match *output {\n-                PageEndpointOutput::NodeJs { entry_chunk, .. } => EndpointOutputPaths::NodeJs {\n-                    server_entry_path: node_root\n-                        .get_path_to(&*entry_chunk.path().await?)\n-                        .context(\"ssr chunk entry path must be inside the node root\")?\n-                        .to_string(),\n-                    server_paths,\n-                    client_paths,\n-                },\n+                PageEndpointOutput::NodeJs { entry_chunk, .. } => {\n+                    // Only set server_entry_path if pages should be created\n+                    let pages_structure = this.pages_structure.await?;\n+                    let server_entry_path = if pages_structure.should_create_pages_entries {\n+                        node_root\n+                            .get_path_to(&*entry_chunk.path().await?)\n+                            .context(\"ssr chunk entry path must be inside the node root\")?\n+                            .to_string()\n+                    } else {\n+                        String::new() // Empty path when no pages should be created\n+                    };\n+\n+                    EndpointOutputPaths::NodeJs {\n+                        server_entry_path,\n+                        server_paths,\n+                        client_paths,\n+                    }\n+                }\n                 PageEndpointOutput::Edge { .. } => EndpointOutputPaths::Edge {\n                     server_paths,\n                     client_paths,"
        },
        {
            "sha": "11c9c190bec9bea0e311f7b578708dba4e67036e",
            "filename": "crates/next-core/src/app_structure.rs",
            "status": "modified",
            "additions": 49,
            "deletions": 0,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -16,6 +16,7 @@ use turbopack_core::issue::{\n };\n \n use crate::{\n+    mode::NextMode,\n     next_app::{\n         AppPage, AppPath, PageSegment, PageType,\n         metadata::{\n@@ -753,12 +754,14 @@ pub fn get_entrypoints(\n     app_dir: FileSystemPath,\n     page_extensions: Vc<Vec<RcStr>>,\n     is_global_not_found_enabled: Vc<bool>,\n+    next_mode: Vc<NextMode>,\n ) -> Vc<Entrypoints> {\n     directory_tree_to_entrypoints(\n         app_dir.clone(),\n         get_directory_tree(app_dir.clone(), page_extensions),\n         get_global_metadata(app_dir, page_extensions),\n         is_global_not_found_enabled,\n+        next_mode,\n         Default::default(),\n         Default::default(),\n     )\n@@ -786,13 +789,15 @@ fn directory_tree_to_entrypoints(\n     directory_tree: Vc<DirectoryTree>,\n     global_metadata: Vc<GlobalMetadata>,\n     is_global_not_found_enabled: Vc<bool>,\n+    next_mode: Vc<NextMode>,\n     root_layouts: Vc<FileSystemPathVec>,\n     root_params: Vc<RootParamVecOption>,\n ) -> Vc<Entrypoints> {\n     directory_tree_to_entrypoints_internal(\n         app_dir,\n         global_metadata,\n         is_global_not_found_enabled,\n+        next_mode,\n         rcstr!(\"\"),\n         directory_tree,\n         AppPage::new(),\n@@ -1247,6 +1252,7 @@ async fn directory_tree_to_entrypoints_internal(\n     app_dir: FileSystemPath,\n     global_metadata: ResolvedVc<GlobalMetadata>,\n     is_global_not_found_enabled: Vc<bool>,\n+    next_mode: Vc<NextMode>,\n     directory_name: RcStr,\n     directory_tree: Vc<DirectoryTree>,\n     app_page: AppPage,\n@@ -1258,6 +1264,7 @@ async fn directory_tree_to_entrypoints_internal(\n         app_dir,\n         global_metadata,\n         is_global_not_found_enabled,\n+        next_mode,\n         directory_name,\n         directory_tree,\n         app_page,\n@@ -1272,6 +1279,7 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n     app_dir: FileSystemPath,\n     global_metadata: ResolvedVc<GlobalMetadata>,\n     is_global_not_found_enabled: Vc<bool>,\n+    next_mode: Vc<NextMode>,\n     directory_name: RcStr,\n     directory_tree: Vc<DirectoryTree>,\n     app_page: AppPage,\n@@ -1518,6 +1526,46 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n                 root_params,\n             );\n         }\n+\n+        // Create production global error page only in build mode\n+        // This aligns with webpack: default Pages entries (including /_error) are only added when\n+        // the build isn't app-only. If the build is app-only (no user pages/api), we should still\n+        // expose the app global error so runtime errors render, but we shouldn't emit it otherwise.\n+        if matches!(*next_mode.await?, NextMode::Build) {\n+            // Use built-in global-error.js to create a `_global-error/page` route.\n+            let global_error_tree = AppPageLoaderTree {\n+                page: app_page.clone(),\n+                segment: directory_name.clone(),\n+                parallel_routes: fxindexmap! {\n+                    rcstr!(\"children\") => AppPageLoaderTree {\n+                        page: app_page.clone(),\n+                        segment: rcstr!(\"__PAGE__\"),\n+                        parallel_routes: FxIndexMap::default(),\n+                        modules: AppDirModules {\n+                            page: Some(get_next_package(app_dir.clone())\n+                                .await?\n+                                .join(\"dist/client/components/builtin/app-error.js\")?),\n+                            ..Default::default()\n+                        },\n+                        global_metadata,\n+                    }\n+                },\n+                modules: AppDirModules::default(),\n+                global_metadata,\n+            }\n+            .resolved_cell();\n+\n+            let app_global_error_page = app_page\n+                .clone_push_str(\"_global-error\")?\n+                .complete(PageType::Page)?;\n+            add_app_page(\n+                app_dir.clone(),\n+                &mut result,\n+                app_global_error_page,\n+                global_error_tree,\n+                root_params,\n+            );\n+        }\n     }\n \n     let app_page = &app_page;\n@@ -1542,6 +1590,7 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n                     app_dir.clone(),\n                     *global_metadata,\n                     is_global_not_found_enabled,\n+                    next_mode,\n                     subdir_name.clone(),\n                     *subdirectory,\n                     child_app_page.clone(),"
        },
        {
            "sha": "67595db51e7adeb35dfff8aa0436d066ddf864c4",
            "filename": "crates/next-core/src/pages_structure.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -76,6 +76,8 @@ pub struct PagesStructure {\n     pub error_500: Option<ResolvedVc<PagesStructureItem>>,\n     pub api: Option<ResolvedVc<PagesDirectoryStructure>>,\n     pub pages: Option<ResolvedVc<PagesDirectoryStructure>>,\n+    pub has_user_pages: bool,\n+    pub should_create_pages_entries: bool,\n }\n \n #[turbo_tasks::value]\n@@ -102,6 +104,7 @@ pub async fn find_pages_structure(\n     project_root: FileSystemPath,\n     next_router_root: FileSystemPath,\n     page_extensions: Vc<Vec<RcStr>>,\n+    next_mode: Vc<crate::mode::NextMode>,\n ) -> Result<Vc<PagesStructure>> {\n     let pages_root = project_root.join(\"pages\")?.realpath().owned().await?;\n     let pages_root = if *pages_root.get_type().await? == FileSystemEntryType::Directory {\n@@ -123,6 +126,7 @@ pub async fn find_pages_structure(\n         Vc::cell(pages_root),\n         next_router_root,\n         page_extensions,\n+        next_mode,\n     ))\n }\n \n@@ -133,6 +137,7 @@ async fn get_pages_structure_for_root_directory(\n     project_path: Vc<FileSystemPathOption>,\n     next_router_path: FileSystemPath,\n     page_extensions: Vc<Vec<RcStr>>,\n+    next_mode: Vc<crate::mode::NextMode>,\n ) -> Result<Vc<PagesStructure>> {\n     let page_extensions_raw = &*page_extensions.await?;\n \n@@ -259,6 +264,14 @@ async fn get_pages_structure_for_root_directory(\n         project_root.join(\"pages\")?\n     };\n \n+    // Check if there are any actual user pages (not just _app, _document, _error)\n+    // error_500_item can be auto-generated for app router, so only count it if there are other user\n+    // pages\n+    let has_user_pages = pages_directory.is_some() || api_directory.is_some();\n+\n+    // Only skip user pages routes during build mode when there are no user pages\n+    let should_create_pages_entries = has_user_pages || next_mode.await?.is_development();\n+\n     let app_item = {\n         let app_router_path = next_router_path.join(\"_app\")?;\n         PagesStructureItem::new(\n@@ -311,6 +324,8 @@ async fn get_pages_structure_for_root_directory(\n         error_500: error_500_item.to_resolved().await?,\n         api: api_directory,\n         pages: pages_directory,\n+        has_user_pages,\n+        should_create_pages_entries,\n     }\n     .cell())\n }"
        },
        {
            "sha": "029c84011847cc5f4a2fd162468ca979e2edb5ea",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 18,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -27,7 +27,7 @@ import { isEdgeRuntime } from '../lib/is-edge-runtime'\n import {\n   APP_CLIENT_INTERNALS,\n   RSC_MODULE_TYPES,\n-  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+  UNDERSCORE_NOT_FOUND_ROUTE,\n } from '../shared/lib/constants'\n import {\n   CLIENT_STATIC_FILES_RUNTIME_AMP,\n@@ -46,6 +46,7 @@ import {\n   isInstrumentationHookFile,\n   isInstrumentationHookFilename,\n   reduceAppConfig,\n+  isAppBuiltinPage,\n } from './utils'\n import {\n   getAppPageStaticInfo,\n@@ -80,6 +81,11 @@ import type { createValidFileMatcher } from '../server/lib/find-page-file'\n import { isReservedPage } from './utils'\n import { isParallelRouteSegment } from '../shared/lib/segment'\n import { ensureLeadingSlash } from '../shared/lib/page-path/ensure-leading-slash'\n+import {\n+  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE,\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n+} from '../shared/lib/entry-constants'\n \n /**\n  * Collect app pages, layouts, and default files from the app directory\n@@ -225,10 +231,15 @@ export function extractSlotsFromAppRoutes(mappedAppPages: {\n }): SlotInfo[] {\n   const slots: SlotInfo[] = []\n \n-  for (const [route] of Object.entries(mappedAppPages)) {\n-    if (route === '/_not-found/page') continue\n+  for (const [page] of Object.entries(mappedAppPages)) {\n+    if (\n+      page === UNDERSCORE_NOT_FOUND_ROUTE_ENTRY ||\n+      page === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY\n+    ) {\n+      continue\n+    }\n \n-    const segments = route.split('/')\n+    const segments = page.split('/')\n     for (let i = segments.length - 1; i >= 0; i--) {\n       const segment = segments[i]\n       if (isParallelRouteSegment(segment)) {\n@@ -327,8 +338,13 @@ export function processAppRoutes(\n   const appRoutes: RouteInfo[] = []\n   const appRouteHandlers: RouteInfo[] = []\n \n-  for (const [route, filePath] of Object.entries(mappedAppPages)) {\n-    if (route === '/_not-found/page') continue\n+  for (const [page, filePath] of Object.entries(mappedAppPages)) {\n+    if (\n+      page === UNDERSCORE_NOT_FOUND_ROUTE_ENTRY ||\n+      page === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY\n+    ) {\n+      continue\n+    }\n \n     const relativeFilePath = createRelativeFilePath(\n       baseDir,\n@@ -339,12 +355,12 @@ export function processAppRoutes(\n \n     if (validFileMatcher.isAppRouterRoute(filePath)) {\n       appRouteHandlers.push({\n-        route: normalizeAppPath(normalizePathSep(route)),\n+        route: normalizeAppPath(normalizePathSep(page)),\n         filePath: relativeFilePath,\n       })\n     } else {\n       appRoutes.push({\n-        route: normalizeAppPath(normalizePathSep(route)),\n+        route: normalizeAppPath(normalizePathSep(page)),\n         filePath: relativeFilePath,\n       })\n     }\n@@ -439,10 +455,15 @@ export async function getStaticInfoIncludingLayouts({\n     return pageStaticInfo\n   }\n \n+  // Skip inheritance for global-error pages - always use default config\n+  if (page === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY) {\n+    return pageStaticInfo\n+  }\n+\n   const segments = [pageStaticInfo]\n \n-  // inherit from layout files only if it's a page route\n-  if (isAppPageRoute(page)) {\n+  // inherit from layout files only if it's a page route and not a builtin page\n+  if (isAppPageRoute(page) && !isAppBuiltinPage(pageFilePath)) {\n     const layoutFiles = []\n     const potentialLayoutFiles = pageExtensions.map((ext) => 'layout.' + ext)\n     let dir = dirname(pageFilePath)\n@@ -539,13 +560,15 @@ export async function createPagesMapping({\n   pagesType,\n   pagesDir,\n   appDir,\n+  appDirOnly,\n }: {\n   isDev: boolean\n   pageExtensions: PageExtensions\n   pagePaths: string[]\n   pagesType: PAGE_TYPES\n   pagesDir: string | undefined\n   appDir: string | undefined\n+  appDirOnly: boolean\n }): Promise<MappedPages> {\n   const isAppRoute = pagesType === 'app'\n   const pages: MappedPages = {}\n@@ -558,9 +581,12 @@ export async function createPagesMapping({\n     let pageKey = getPageFromPath(pagePath, pageExtensions)\n     if (isAppRoute) {\n       pageKey = pageKey.replace(/%5F/g, '_')\n-      if (pageKey === '/not-found') {\n+      if (pageKey === UNDERSCORE_NOT_FOUND_ROUTE) {\n         pageKey = UNDERSCORE_NOT_FOUND_ROUTE_ENTRY\n       }\n+      if (pageKey === UNDERSCORE_GLOBAL_ERROR_ROUTE) {\n+        pageKey = UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY\n+      }\n     }\n \n     const normalizedPath = normalizePathSep(\n@@ -605,9 +631,9 @@ export async function createPagesMapping({\n       return pages\n     }\n     case PAGE_TYPES.APP: {\n-      const hasAppPages = Object.keys(pages).some((page) =>\n-        page.endsWith('/page')\n-      )\n+      const hasAppPages = Object.keys(pages).length > 0\n+      // Whether to emit App router 500.html entry, which only presents in production and only app router presents\n+      const hasAppGlobalError = !isDev && appDirOnly\n       return {\n         // If there's any app pages existed, add a default /_not-found route as 404.\n         // If there's any custom /_not-found page, it will override the default one.\n@@ -616,6 +642,11 @@ export async function createPagesMapping({\n             'next/dist/client/components/builtin/global-not-found'\n           ),\n         }),\n+        ...(hasAppGlobalError && {\n+          [UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY]: require.resolve(\n+            'next/dist/client/components/builtin/app-error'\n+          ),\n+        }),\n         ...pages,\n       }\n     }\n@@ -632,10 +663,13 @@ export async function createPagesMapping({\n       const root = isDev && pagesDir ? PAGES_DIR_ALIAS : 'next/dist/pages'\n \n       return {\n-        '/_app': `${root}/_app`,\n-        '/_error': `${root}/_error`,\n-        '/_document': `${root}/_document`,\n-        ...pages,\n+        // Don't add default pages entries if this is an app-router-only build\n+        ...((isDev || !appDirOnly) && {\n+          '/_app': `${root}/_app`,\n+          '/_error': `${root}/_error`,\n+          '/_document': `${root}/_document`,\n+          ...pages,\n+        }),\n       }\n     }\n     default: {"
        },
        {
            "sha": "c54a5f980406fad855db433f5112723f7f475f89",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 120,
            "deletions": 31,
            "changes": 151,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -76,11 +76,14 @@ import {\n   MIDDLEWARE_REACT_LOADABLE_MANIFEST,\n   SERVER_REFERENCE_MANIFEST,\n   FUNCTIONS_CONFIG_MANIFEST,\n-  UNDERSCORE_NOT_FOUND_ROUTE,\n-  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n   DYNAMIC_CSS_MANIFEST,\n   TURBOPACK_CLIENT_MIDDLEWARE_MANIFEST,\n } from '../shared/lib/constants'\n+import {\n+  UNDERSCORE_NOT_FOUND_ROUTE,\n+  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n+} from '../shared/lib/entry-constants'\n import { isDynamicRoute } from '../shared/lib/router/utils'\n import type { __ApiPreviewProps } from '../server/api-utils'\n import loadConfig from '../server/config'\n@@ -135,7 +138,7 @@ import {\n   printTreeView,\n   copyTracedFiles,\n   isReservedPage,\n-  isAppBuiltinNotFoundPage,\n+  isAppBuiltinPage,\n   collectRoutesUsingEdgeRuntime,\n   collectMeta,\n } from './utils'\n@@ -839,7 +842,8 @@ async function writeFullyStaticExport(\n   dir: string,\n   enabledDirectories: NextEnabledDirectories,\n   configOutDir: string,\n-  nextBuildSpan: Span\n+  nextBuildSpan: Span,\n+  appDirOnly: boolean\n ): Promise<void> {\n   const exportApp = (require('../export') as typeof import('../export'))\n     .default as typeof import('../export').default\n@@ -853,6 +857,7 @@ async function writeFullyStaticExport(\n       silent: true,\n       outdir: path.join(dir, configOutDir),\n       numWorkers: getNumberOfWorkers(config),\n+      appDirOnly,\n     },\n     nextBuildSpan\n   )\n@@ -999,6 +1004,11 @@ export default async function build(\n \n       const publicDir = path.join(dir, 'public')\n       const { pagesDir, appDir } = findPagesDir(dir)\n+\n+      if (!appDirOnly && !pagesDir) {\n+        appDirOnly = true\n+      }\n+\n       NextBuildContext.pagesDir = pagesDir\n       NextBuildContext.appDir = appDir\n \n@@ -1175,6 +1185,7 @@ export default async function build(\n             pagePaths: pagesPaths,\n             pagesDir,\n             appDir,\n+            appDirOnly,\n           })\n         )\n       NextBuildContext.mappedPages = mappedPages\n@@ -1216,6 +1227,7 @@ export default async function build(\n               pageExtensions: config.pageExtensions,\n               pagesDir,\n               appDir,\n+              appDirOnly,\n             })\n           )\n \n@@ -1229,6 +1241,7 @@ export default async function build(\n               pageExtensions: config.pageExtensions,\n               pagesDir,\n               appDir,\n+              appDirOnly,\n             })\n           )\n \n@@ -1242,6 +1255,7 @@ export default async function build(\n         pagesType: PAGE_TYPES.ROOT,\n         pagesDir: pagesDir,\n         appDir,\n+        appDirOnly,\n       })\n       NextBuildContext.mappedRootPaths = mappedRootPaths\n \n@@ -1320,6 +1334,7 @@ export default async function build(\n                     pageExtensions: config.pageExtensions,\n                     pagesDir,\n                     appDir,\n+                    appDirOnly,\n                   })\n                 )\n               slotsFromDefaults =\n@@ -1385,8 +1400,15 @@ export default async function build(\n       const conflictingPublicFiles: string[] = []\n       const hasPages404 = mappedPages['/404']?.startsWith(PAGES_DIR_ALIAS)\n       const hasApp404 = !!mappedAppPages?.[UNDERSCORE_NOT_FOUND_ROUTE_ENTRY]\n+      const hasAppGlobalError =\n+        !!mappedAppPages?.[UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY]\n       const hasCustomErrorPage =\n-        mappedPages['/_error'].startsWith(PAGES_DIR_ALIAS)\n+        mappedPages['/_error']?.startsWith(PAGES_DIR_ALIAS)\n+\n+      // Check if there are any user pages (non-reserved pages) in the pages router\n+      const hasUserPagesRoutes = Object.keys(mappedPages).some(\n+        (route) => !isReservedPage(route)\n+      )\n \n       if (hasPublicDir) {\n         const hasPublicUnderScoreNextDir = existsSync(\n@@ -1847,7 +1869,7 @@ export default async function build(\n             namedExports: [],\n             isNextImageImported: true,\n             hasSsrAmpPages: !!pagesDir,\n-            hasNonStaticErrorPage: true,\n+            hasNonStaticErrorPage: hasUserPagesRoutes,\n           }\n         }\n \n@@ -1896,22 +1918,24 @@ export default async function build(\n \n         const appPageToCheck = '/_app'\n \n-        const customAppGetInitialPropsPromise = worker.hasCustomGetInitialProps(\n-          {\n-            page: appPageToCheck,\n-            distDir,\n-            runtimeEnvConfig,\n-            checkingApp: true,\n-            sriEnabled,\n-          }\n-        )\n+        const customAppGetInitialPropsPromise = hasUserPagesRoutes\n+          ? worker.hasCustomGetInitialProps({\n+              page: appPageToCheck,\n+              distDir,\n+              runtimeEnvConfig,\n+              checkingApp: true,\n+              sriEnabled,\n+            })\n+          : Promise.resolve(false)\n \n-        const namedExportsPromise = worker.getDefinedNamedExports({\n-          page: appPageToCheck,\n-          distDir,\n-          runtimeEnvConfig,\n-          sriEnabled,\n-        })\n+        const namedExportsPromise = hasUserPagesRoutes\n+          ? worker.getDefinedNamedExports({\n+              page: appPageToCheck,\n+              distDir,\n+              runtimeEnvConfig,\n+              sriEnabled,\n+            })\n+          : Promise.resolve([])\n \n         // eslint-disable-next-line @typescript-eslint/no-shadow\n         let isNextImageImported: boolean | undefined\n@@ -2026,10 +2050,8 @@ export default async function build(\n                   }\n                 }\n \n-                const pageFilePath = isAppBuiltinNotFoundPage(pagePath)\n-                  ? require.resolve(\n-                      'next/dist/client/components/builtin/not-found'\n-                    )\n+                const pageFilePath = isAppBuiltinPage(pagePath)\n+                  ? pagePath\n                   : path.join(\n                       (pageType === 'pages' ? pagesDir : appDir) || '',\n                       pagePath\n@@ -2739,13 +2761,18 @@ export default async function build(\n         }\n       })\n \n-      const hasPages500 = usedStaticStatusPages.includes('/500')\n+      const hasPages500 = !appDirOnly && usedStaticStatusPages.includes('/500')\n       const useDefaultStatic500 =\n         !hasPages500 && !hasNonStaticErrorPage && !customAppGetInitialProps\n \n       const combinedPages = [...staticPages, ...ssgPages]\n       const isApp404Static = staticPaths.has(UNDERSCORE_NOT_FOUND_ROUTE_ENTRY)\n       const hasStaticApp404 = hasApp404 && isApp404Static\n+      const isAppGlobalErrorStatic = staticPaths.has(\n+        UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY\n+      )\n+      const hasStaticAppGlobalError =\n+        hasAppGlobalError && isAppGlobalErrorStatic\n \n       await updateBuildDiagnostics({\n         buildStage: 'static-generation',\n@@ -2833,13 +2860,13 @@ export default async function build(\n                 })\n               })\n \n-              if (useStaticPages404) {\n+              if (useStaticPages404 && !appDirOnly) {\n                 defaultMap['/404'] = {\n                   page: hasPages404 ? '/404' : '/_error',\n                 }\n               }\n \n-              if (useDefaultStatic500) {\n+              if (useDefaultStatic500 && !appDirOnly) {\n                 defaultMap['/500'] = {\n                   page: '/_error',\n                 }\n@@ -2926,6 +2953,7 @@ export default async function build(\n               outdir,\n               statusMessage: 'Generating static pages',\n               numWorkers: getNumberOfWorkers(exportConfig),\n+              appDirOnly,\n             },\n             nextBuildSpan\n           )\n@@ -3551,6 +3579,13 @@ export default async function build(\n                   .replace(/\\\\/g, '/')\n \n                 if (existsSync(orig)) {\n+                  // if 404.html folder doesn't exist, create it\n+                  await fs.mkdir(\n+                    path.dirname(\n+                      path.join(distDir, 'server', updatedRelativeDest)\n+                    ),\n+                    { recursive: true }\n+                  )\n                   await fs.copyFile(\n                     orig,\n                     path.join(distDir, 'server', updatedRelativeDest)\n@@ -3570,20 +3605,73 @@ export default async function build(\n               })\n           }\n \n+          async function moveExportedAppGlobalErrorTo500() {\n+            return staticGenerationSpan\n+              .traceChild('move-exported-app-global-error-')\n+              .traceAsyncFn(async () => {\n+                // If static 500.html exists in pages router, don't move it\n+                if (\n+                  existsSync(path.join(distDir, 'server', 'pages', '500.html'))\n+                ) {\n+                  return\n+                }\n+\n+                // Only handle 500.html generation for static export\n+                const orig = path.join(\n+                  distDir,\n+                  'server',\n+                  'app',\n+                  '_global-error.html'\n+                )\n+                if (existsSync(orig)) {\n+                  const error500Html = path.join(\n+                    distDir,\n+                    'server',\n+                    'pages',\n+                    '500.html'\n+                  )\n+\n+                  // if 500.html folder doesn't exist, create it\n+                  await fs.mkdir(path.dirname(error500Html), {\n+                    recursive: true,\n+                  })\n+                  await fs.copyFile(orig, error500Html)\n+\n+                  pagesManifest['/500'] = path\n+                    .join('pages', '500.html')\n+                    .replace(/\\\\/g, '/')\n+                }\n+              })\n+          }\n+\n           // If there's /not-found inside app, we prefer it over the pages 404\n           if (hasStaticApp404) {\n             await moveExportedAppNotFoundTo404()\n           } else {\n             // Only move /404 to /404 when there is no custom 404 as in that case we don't know about the 404 page\n-            if (!hasPages404 && !hasApp404 && useStaticPages404) {\n+            if (\n+              !hasPages404 &&\n+              !hasApp404 &&\n+              useStaticPages404 &&\n+              !appDirOnly\n+            ) {\n               await moveExportedPage('/_error', '/404', '/404', false, 'html')\n             }\n           }\n \n-          if (useDefaultStatic500) {\n+          if (useDefaultStatic500 && !appDirOnly) {\n             await moveExportedPage('/_error', '/500', '/500', false, 'html')\n           }\n \n+          // If there's app router and no pages router, use app router built-in 500.html\n+          if (\n+            hasStaticAppGlobalError &&\n+            mappedAppPages &&\n+            Object.keys(mappedAppPages).length > 0\n+          ) {\n+            await moveExportedAppGlobalErrorTo500()\n+          }\n+\n           for (const page of combinedPages) {\n             const isSsg = ssgPages.has(page)\n             const isStaticSsgFallback = ssgStaticFallbackPages.has(page)\n@@ -3937,7 +4025,8 @@ export default async function build(\n           dir,\n           enabledDirectories,\n           configOutDir,\n-          nextBuildSpan\n+          nextBuildSpan,\n+          appDirOnly\n         )\n       }\n "
        },
        {
            "sha": "e23366858974fd9577acc6798ee03712c13da4f9",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 8,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -179,14 +179,19 @@ export async function turbopackBuild(): Promise<{\n     await Promise.all(promises)\n \n     await Promise.all([\n-      manifestLoader.loadBuildManifest('_app'),\n-      manifestLoader.loadPagesManifest('_app'),\n-      manifestLoader.loadFontManifest('_app'),\n-      manifestLoader.loadPagesManifest('_document'),\n-      manifestLoader.loadClientBuildManifest('_error'),\n-      manifestLoader.loadBuildManifest('_error'),\n-      manifestLoader.loadPagesManifest('_error'),\n-      manifestLoader.loadFontManifest('_error'),\n+      // Only load pages router manifests if not app-only\n+      ...(!appDirOnly\n+        ? [\n+            manifestLoader.loadBuildManifest('_app'),\n+            manifestLoader.loadPagesManifest('_app'),\n+            manifestLoader.loadFontManifest('_app'),\n+            manifestLoader.loadPagesManifest('_document'),\n+            manifestLoader.loadClientBuildManifest('_error'),\n+            manifestLoader.loadBuildManifest('_error'),\n+            manifestLoader.loadPagesManifest('_error'),\n+            manifestLoader.loadFontManifest('_error'),\n+          ]\n+        : []),\n       entrypoints.instrumentation &&\n         manifestLoader.loadMiddlewareManifest(\n           'instrumentation',"
        },
        {
            "sha": "7a69728dd74b33cdd659c53996251b8e0833f718",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 5,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -49,6 +49,8 @@ import {\n } from '../lib/constants'\n import {\n   MODERN_BROWSERSLIST_TARGET,\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE,\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n   UNDERSCORE_NOT_FOUND_ROUTE,\n } from '../shared/lib/constants'\n import prettyBytes from '../lib/pretty-bytes'\n@@ -318,8 +320,13 @@ const filterAndSortList = (\n ) => {\n   let pages: string[]\n   if (routeType === 'app') {\n-    // filter out static app route of /favicon.ico\n-    pages = list.filter((e) => e !== '/favicon.ico')\n+    // filter out static app route of /favicon.ico and /_global-error\n+    pages = list.filter((e) => {\n+      if (e === '/favicon.ico') return false\n+      // Hide static /_global-error from build output\n+      if (e === '/_global-error') return false\n+      return true\n+    })\n   } else {\n     // filter built-in pages\n     pages = list\n@@ -1067,6 +1074,23 @@ export async function isPageStatic({\n   buildId: string\n   sriEnabled: boolean\n }): Promise<PageIsStaticResult> {\n+  // Skip page data collection for synthetic _global-error routes\n+  if (page === UNDERSCORE_GLOBAL_ERROR_ROUTE) {\n+    return {\n+      isStatic: true,\n+      isRoutePPREnabled: false,\n+      isHybridAmp: false,\n+      isAmpOnly: false,\n+      prerenderFallbackMode: undefined,\n+      prerenderedRoutes: undefined,\n+      rootParamKeys: undefined,\n+      hasStaticProps: false,\n+      hasServerProps: false,\n+      isNextImageImported: false,\n+      appConfig: {},\n+    }\n+  }\n+\n   await createIncrementalCache({\n     cacheHandler,\n     cacheHandlers,\n@@ -1159,7 +1183,10 @@ export async function isPageStatic({\n           })\n         }\n \n-        appConfig = reduceAppConfig(segments)\n+        appConfig =\n+          originalAppPath === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY\n+            ? {}\n+            : reduceAppConfig(segments)\n \n         if (appConfig.dynamic === 'force-static' && pathIsEdgeRuntime) {\n           Log.warn(\n@@ -1755,8 +1782,8 @@ export function isReservedPage(page: string) {\n   return RESERVED_PAGE.test(page)\n }\n \n-export function isAppBuiltinNotFoundPage(page: string) {\n-  return /next[\\\\/]dist[\\\\/]client[\\\\/]components[\\\\/]builtin[\\\\/](not-found|global-not-found)/.test(\n+export function isAppBuiltinPage(page: string) {\n+  return /next[\\\\/]dist[\\\\/](esm[\\\\/])?client[\\\\/]components[\\\\/]builtin[\\\\/]/.test(\n     page\n   )\n }"
        },
        {
            "sha": "06a7204bf4a53f6172eff819a03755aaa26ce0f8",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 5,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -1,9 +1,13 @@\n import type webpack from 'next/dist/compiled/webpack/webpack'\n import {\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE,\n   UNDERSCORE_NOT_FOUND_ROUTE,\n-  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n   type ValueOf,\n } from '../../../../shared/lib/constants'\n+import {\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n+  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+} from '../../../../shared/lib/entry-constants'\n import type { ModuleTuple, CollectedMetadata } from '../metadata/types'\n \n import path from 'path'\n@@ -21,7 +25,7 @@ import { isAppRouteRoute } from '../../../../lib/is-app-route-route'\n import type { NextConfig } from '../../../../server/config-shared'\n import { AppPathnameNormalizer } from '../../../../server/normalizers/built/app/app-pathname-normalizer'\n import type { MiddlewareConfig } from '../../../analysis/get-page-static-info'\n-import { isAppBuiltinNotFoundPage } from '../../../utils'\n+import { isAppBuiltinPage } from '../../../utils'\n import { loadEntrypoint } from '../../../load-entrypoint'\n import {\n   isGroupSegment,\n@@ -85,6 +89,7 @@ const defaultNotFoundPath = 'next/dist/client/components/builtin/not-found.js'\n const defaultLayoutPath = 'next/dist/client/components/builtin/layout.js'\n const defaultGlobalNotFoundPath =\n   'next/dist/client/components/builtin/global-not-found.js'\n+const appErrorPath = 'next/dist/client/components/builtin/app-error.js'\n \n type DirResolver = (pathToResolve: string) => string\n type PathResolver = (\n@@ -153,7 +158,8 @@ async function createTreeCodeFromPath(\n }> {\n   const splittedPath = pagePath.split(/[\\\\/]/, 1)\n   const isNotFoundRoute = page === UNDERSCORE_NOT_FOUND_ROUTE_ENTRY\n-  const isDefaultNotFound = isAppBuiltinNotFoundPage(pagePath)\n+  const isAppErrorRoute = page === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY\n+  const isDefaultNotFound = isAppBuiltinPage(pagePath)\n \n   const appDirPrefix = isDefaultNotFound ? APP_DIR_ALIAS : splittedPath[0]\n   const pages: string[] = []\n@@ -439,7 +445,7 @@ async function createTreeCodeFromPath(\n             const varName = `notFound${nestedCollectedDeclarations.length}`\n             nestedCollectedDeclarations.push([varName, notFoundPath])\n             subtreeCode = `{\n-              children: [${JSON.stringify(UNDERSCORE_NOT_FOUND_ROUTE)}, {\n+              children: [${JSON.stringify(UNDERSCORE_NOT_FOUND_ROUTE.slice(1))}, {\n                 children: ['${PAGE_SEGMENT_KEY}', {}, {\n                   page: [\n                     ${varName},\n@@ -452,6 +458,22 @@ async function createTreeCodeFromPath(\n         }\n       }\n \n+      // If it's app-error route, set app-error as children page\n+      if (isAppErrorRoute) {\n+        const varName = `appError${nestedCollectedDeclarations.length}`\n+        nestedCollectedDeclarations.push([varName, appErrorPath])\n+        subtreeCode = `{\n+          children: [${JSON.stringify(UNDERSCORE_GLOBAL_ERROR_ROUTE.slice(1))}, {\n+            children: ['${PAGE_SEGMENT_KEY}', {}, {\n+              page: [\n+                ${varName},\n+                ${JSON.stringify(appErrorPath)}\n+              ]\n+            }]\n+          }, {}]\n+        }`\n+      }\n+\n       // For 404 route\n       // if global-not-found is in definedFilePaths, remove root layout for /_not-found\n       // TODO: remove this once global-not-found is stable.\n@@ -461,6 +483,12 @@ async function createTreeCodeFromPath(\n         )\n       }\n \n+      if (isAppErrorRoute) {\n+        definedFilePaths = definedFilePaths.filter(\n+          ([type]) => type !== 'layout'\n+        )\n+      }\n+\n       const modulesCode = `{\n         ${definedFilePaths\n           .map(([file, filePath]) => {\n@@ -780,7 +808,9 @@ const nextAppLoader: AppLoader = async function nextAppLoader() {\n     !!treeCodeResult.globalNotFound &&\n     isGlobalNotFoundEnabled\n \n-  if (!treeCodeResult.rootLayout && !isGlobalNotFoundPath) {\n+  const isAppErrorRoute = page === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY\n+\n+  if (!treeCodeResult.rootLayout && !isGlobalNotFoundPath && !isAppErrorRoute) {\n     if (!isDev) {\n       // If we're building and missing a root layout, exit the build\n       Log.error("
        },
        {
            "sha": "971280fbf2b624f1f7a96c87bc9642cfc09d3e2c",
            "filename": "packages/next/src/build/webpack/loaders/next-edge-ssr-loader/index.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 12,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-edge-ssr-loader%2Findex.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -121,18 +121,24 @@ const edgeSSRLoader: webpack.LoaderDefinitionFunction<EdgeSSRLoaderQuery> =\n       this.context || this.rootContext,\n       absolutePagePath\n     )\n-    const appPath = this.utils.contextify(\n-      this.context || this.rootContext,\n-      swapDistFolderWithEsmDistFolder(absoluteAppPath)\n-    )\n-    const errorPath = this.utils.contextify(\n-      this.context || this.rootContext,\n-      swapDistFolderWithEsmDistFolder(absoluteErrorPath)\n-    )\n-    const documentPath = this.utils.contextify(\n-      this.context || this.rootContext,\n-      swapDistFolderWithEsmDistFolder(absoluteDocumentPath)\n-    )\n+    const appPath = absoluteAppPath\n+      ? this.utils.contextify(\n+          this.context || this.rootContext,\n+          swapDistFolderWithEsmDistFolder(absoluteAppPath)\n+        )\n+      : ''\n+    const errorPath = absoluteErrorPath\n+      ? this.utils.contextify(\n+          this.context || this.rootContext,\n+          swapDistFolderWithEsmDistFolder(absoluteErrorPath)\n+        )\n+      : ''\n+    const documentPath = absoluteDocumentPath\n+      ? this.utils.contextify(\n+          this.context || this.rootContext,\n+          swapDistFolderWithEsmDistFolder(absoluteDocumentPath)\n+        )\n+      : ''\n     const userland500Path = absolute500Path\n       ? this.utils.contextify(\n           this.context || this.rootContext,"
        },
        {
            "sha": "b01dce4bcd7d90bf4549bd14e11d3efdfd7be505",
            "filename": "packages/next/src/build/webpack/plugins/flight-client-entry-plugin.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 7,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -24,8 +24,11 @@ import {\n   DEFAULT_RUNTIME_WEBPACK,\n   EDGE_RUNTIME_WEBPACK,\n   SERVER_REFERENCE_MANIFEST,\n-  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n } from '../../../shared/lib/constants'\n+import {\n+  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n+} from '../../../shared/lib/entry-constants'\n import {\n   isClientComponentEntryModule,\n   isCSSMod,\n@@ -50,6 +53,7 @@ import {\n import type { MetadataRouteLoaderOptions } from '../loaders/next-metadata-route-loader'\n import type { FlightActionEntryLoaderActions } from '../loaders/next-flight-action-entry-loader'\n import getWebpackBundler from '../../../shared/lib/get-webpack-bundler'\n+import { isAppBuiltinPage } from '../../utils'\n \n interface Options {\n   dev: boolean\n@@ -325,10 +329,11 @@ export class FlightClientEntryPlugin {\n       const clientEntriesToInject = []\n       const mergedCSSimports: CssImports = {}\n \n-      for (const connection of getModuleReferencesInOrder(\n+      const moduleReferences = getModuleReferencesInOrder(\n         entryModule,\n         compilation.moduleGraph\n-      )) {\n+      )\n+      for (const connection of moduleReferences) {\n         // Entry can be any user defined entry files such as layout, page, error, loading, etc.\n         let entryRequest = (\n           connection.dependency as unknown as webpack.NormalModule\n@@ -355,13 +360,16 @@ export class FlightClientEntryPlugin {\n         )\n \n         const isAbsoluteRequest = path.isAbsolute(entryRequest)\n+        const isAppRouterBuiltinPage = isAppBuiltinPage(entryRequest)\n \n         // Next.js internals are put into a separate entry.\n         if (!isAbsoluteRequest) {\n           Object.keys(clientComponentImports).forEach(\n             (value) => (internalClientComponentEntryImports[value] = new Set())\n           )\n-          continue\n+          if (!isAppRouterBuiltinPage) {\n+            continue\n+          }\n         }\n \n         // TODO-APP: Enable these lines. This ensures no entrypoint is created for layout/page when there are no client components.\n@@ -370,9 +378,10 @@ export class FlightClientEntryPlugin {\n         //   continue\n         // }\n \n-        const relativeRequest = isAbsoluteRequest\n-          ? path.relative(compilation.options.context!, entryRequest)\n-          : entryRequest\n+        const relativeRequest =\n+          isAbsoluteRequest && !isAppRouterBuiltinPage\n+            ? path.relative(compilation.options.context!, entryRequest)\n+            : entryRequest\n \n         // Replace file suffix as `.js` will be added.\n         // bundlePath will have app/ prefix but not src/.\n@@ -439,6 +448,17 @@ export class FlightClientEntryPlugin {\n             absolutePagePath: entryRequest,\n           })\n         }\n+\n+        if (name === `app${UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY}`) {\n+          clientEntriesToInject.push({\n+            compiler,\n+            compilation,\n+            entryName: name,\n+            clientComponentImports,\n+            bundlePath: `app${UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY}`,\n+            absolutePagePath: entryRequest,\n+          })\n+        }\n       }\n \n       // Make sure CSS imports are deduplicated before injecting the client entry"
        },
        {
            "sha": "461e6409f686c65e7c8e54a53415fcede835cdf7",
            "filename": "packages/next/src/cli/next-typegen.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -89,6 +89,7 @@ const nextTypegen = async (\n       pageExtensions: nextConfig.pageExtensions,\n       pagesDir,\n       appDir,\n+      appDirOnly: !!appDir && !pagesDir,\n     })\n \n   const validFileMatcher = createValidFileMatcher("
        },
        {
            "sha": "abfe989fc8f80d7f889cdd03d0820b6fe30694e3",
            "filename": "packages/next/src/client/components/builtin/app-error.tsx",
            "status": "added",
            "additions": 80,
            "deletions": 0,
            "changes": 80,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbuiltin%2Fapp-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbuiltin%2Fapp-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbuiltin%2Fapp-error.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,80 @@\n+import React from 'react'\n+\n+const styles: Record<string, React.CSSProperties> = {\n+  error: {\n+    // https://github.com/sindresorhus/modern-normalize/blob/main/modern-normalize.css#L38-L52\n+    fontFamily:\n+      'system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"',\n+    height: '100vh',\n+    textAlign: 'center',\n+    display: 'flex',\n+    flexDirection: 'column',\n+    alignItems: 'center',\n+    justifyContent: 'center',\n+  },\n+  desc: {\n+    lineHeight: '48px',\n+  },\n+  h1: {\n+    display: 'inline-block',\n+    margin: '0 20px 0 0',\n+    paddingRight: 23,\n+    fontSize: 24,\n+    fontWeight: 500,\n+    verticalAlign: 'top',\n+  },\n+  h2: {\n+    fontSize: 14,\n+    fontWeight: 400,\n+    lineHeight: '28px',\n+  },\n+  wrap: {\n+    display: 'inline-block',\n+  },\n+} as const\n+\n+/* CSS minified from\n+body { margin: 0; color: #000; background: #fff; }\n+.next-error-h1 {\n+  border-right: 1px solid rgba(0, 0, 0, .3);\n+}\n+@media (prefers-color-scheme: dark) {\n+  body { color: #fff; background: #000; }\n+  .next-error-h1 {\n+    border-right: 1px solid rgba(255, 255, 255, .3);\n+  }\n+}\n+*/\n+const themeCss = `body{color:#000;background:#fff;margin:0}.next-error-h1{border-right:1px solid rgba(0,0,0,.3)}\n+@media (prefers-color-scheme:dark){body{color:#fff;background:#000}.next-error-h1{border-right:1px solid rgba(255,255,255,.3)}}`\n+\n+function AppError() {\n+  const errorMessage = 'Internal Server Error.'\n+  const title = `500: ${errorMessage}`\n+  return (\n+    <html id=\"__next_error__\">\n+      <head>\n+        <title>{title}</title>\n+      </head>\n+      <body>\n+        <div style={styles.error}>\n+          <div style={styles.desc}>\n+            <style\n+              dangerouslySetInnerHTML={{\n+                __html: themeCss,\n+              }}\n+            />\n+            <h1 className=\"next-error-h1\" style={styles.h1}>\n+              500\n+            </h1>\n+            <div style={styles.wrap}>\n+              <h2 style={styles.h2}>{errorMessage}</h2>\n+            </div>\n+          </div>\n+        </div>\n+      </body>\n+    </html>\n+  )\n+}\n+\n+export default AppError"
        },
        {
            "sha": "f921bb9824723cecec1b805e1c38c6b9fa6fc9c9",
            "filename": "packages/next/src/client/components/handle-isr-error.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhandle-isr-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhandle-isr-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhandle-isr-error.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -12,7 +12,9 @@ export function HandleISRError({ error }: { error: any }) {\n   if (workAsyncStorage) {\n     const store = workAsyncStorage.getStore()\n     if (store?.isRevalidate || store?.isStaticGeneration) {\n-      console.error(error)\n+      if (error) {\n+        console.error(error)\n+      }\n       throw error\n     }\n   }"
        },
        {
            "sha": "6f53cb3bc72ce19fad892b0c51a9b978d9016172",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 89,
            "deletions": 35,
            "changes": 124,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -444,8 +444,15 @@ async function exportAppImpl(\n       return exportMap\n     })\n \n+  // During static export, remove export 404/500 of pages router\n+  // when only app router presents\n+  if (!options.buildExport && options.appDirOnly) {\n+    delete exportPathMap['/404']\n+    delete exportPathMap['/500']\n+  }\n+\n   // only add missing 404 page when `buildExport` is false\n-  if (!options.buildExport) {\n+  if (!options.buildExport && !options.appDirOnly) {\n     // only add missing /404 if not specified in `exportPathMap`\n     if (!exportPathMap['/404']) {\n       exportPathMap['/404'] = { page: '/_error' }\n@@ -455,7 +462,7 @@ async function exportAppImpl(\n      * exports 404.html for backwards compat\n      * E.g. GitHub Pages, GitLab Pages, Cloudflare Pages, Netlify\n      */\n-    if (!exportPathMap['/404.html']) {\n+    if (!exportPathMap['/404.html'] && exportPathMap['/404']) {\n       // alias /404.html to /404 to be compatible with custom 404 / _error page\n       exportPathMap['/404.html'] = exportPathMap['/404']\n     }\n@@ -492,7 +499,9 @@ async function exportAppImpl(\n   }\n \n   if (allExportPaths.length === 0) {\n-    return null\n+    if (!prerenderManifest) {\n+      return null\n+    }\n   }\n \n   if (fallbackEnabledPages.size > 0) {\n@@ -640,44 +649,53 @@ async function exportAppImpl(\n     initialPhaseExportPaths = allExportPaths\n   }\n \n-  const progress = createProgress(\n-    initialPhaseExportPaths.length + finalPhaseExportPaths.length,\n-    options.statusMessage || 'Exporting'\n-  )\n+  const totalExportPaths =\n+    initialPhaseExportPaths.length + finalPhaseExportPaths.length\n+  let worker: StaticWorker | null = null\n+  let results: ExportPagesResult = []\n \n-  const worker = createStaticWorker(nextConfig, {\n-    debuggerPortOffset: getNextBuildDebuggerPortOffset({ kind: 'export-page' }),\n-    progress,\n-  })\n+  if (totalExportPaths > 0) {\n+    const progress = createProgress(\n+      totalExportPaths,\n+      options.statusMessage || 'Exporting'\n+    )\n \n-  const results = await exportPagesInBatches(worker, initialPhaseExportPaths)\n+    worker = createStaticWorker(nextConfig, {\n+      debuggerPortOffset: getNextBuildDebuggerPortOffset({\n+        kind: 'export-page',\n+      }),\n+      progress,\n+    })\n \n-  if (finalPhaseExportPaths.length > 0) {\n-    const renderResumeDataCachesByPage: Record<string, string> = {}\n+    results = await exportPagesInBatches(worker, initialPhaseExportPaths)\n \n-    for (const { page, result } of results) {\n-      if (!result) {\n-        continue\n-      }\n+    if (finalPhaseExportPaths.length > 0) {\n+      const renderResumeDataCachesByPage: Record<string, string> = {}\n \n-      if ('renderResumeDataCache' in result && result.renderResumeDataCache) {\n-        // The last RDC for each page is used. We only need one. It should have\n-        // all the entries that the fallback shell also needs. We don't need to\n-        // merge them per page.\n-        renderResumeDataCachesByPage[page] = result.renderResumeDataCache\n-        // Remove the RDC string from the result so that it can be garbage\n-        // collected, when there are more results for the same page.\n-        result.renderResumeDataCache = undefined\n+      for (const { page, result } of results) {\n+        if (!result) {\n+          continue\n+        }\n+\n+        if ('renderResumeDataCache' in result && result.renderResumeDataCache) {\n+          // The last RDC for each page is used. We only need one. It should have\n+          // all the entries that the fallback shell also needs. We don't need to\n+          // merge them per page.\n+          renderResumeDataCachesByPage[page] = result.renderResumeDataCache\n+          // Remove the RDC string from the result so that it can be garbage\n+          // collected, when there are more results for the same page.\n+          result.renderResumeDataCache = undefined\n+        }\n       }\n-    }\n \n-    const finalPhaseResults = await exportPagesInBatches(\n-      worker,\n-      finalPhaseExportPaths,\n-      renderResumeDataCachesByPage\n-    )\n+      const finalPhaseResults = await exportPagesInBatches(\n+        worker,\n+        finalPhaseExportPaths,\n+        renderResumeDataCachesByPage\n+      )\n \n-    results.push(...finalPhaseResults)\n+      results.push(...finalPhaseResults)\n+    }\n   }\n \n   let hadValidationError = false\n@@ -763,8 +781,41 @@ async function exportAppImpl(\n   if (!options.buildExport && prerenderManifest) {\n     await Promise.all(\n       Object.keys(prerenderManifest.routes).map(async (unnormalizedRoute) => {\n-        // Skip handling /_not-found route, it will copy the 404.html file later\n+        // Special handling: map app /_not-found to 404.html (and 404/index.html when trailingSlash)\n         if (unnormalizedRoute === '/_not-found') {\n+          const { srcRoute } = prerenderManifest!.routes[unnormalizedRoute]\n+          const appPageName = mapAppRouteToPage.get(srcRoute || '')\n+          const pageName = appPageName || srcRoute || unnormalizedRoute\n+          const isAppPath = Boolean(appPageName)\n+          const route = normalizePagePath(unnormalizedRoute)\n+\n+          const pagePath = getPagePath(pageName, distDir, undefined, isAppPath)\n+          const distPagesDir = join(\n+            pagePath,\n+            pageName\n+              .slice(1)\n+              .split('/')\n+              .map(() => '..')\n+              .join('/')\n+          )\n+\n+          const orig = join(distPagesDir, route)\n+          const htmlSrc = `${orig}.html`\n+\n+          // write 404.html at root\n+          const htmlDest404 = join(outDir, '404.html')\n+          await fs.mkdir(dirname(htmlDest404), { recursive: true })\n+          await fs.copyFile(htmlSrc, htmlDest404)\n+\n+          // When trailingSlash, also write 404/index.html\n+          if (subFolders) {\n+            const htmlDest404Index = join(outDir, '404', 'index.html')\n+            await fs.mkdir(dirname(htmlDest404Index), { recursive: true })\n+            await fs.copyFile(htmlSrc, htmlDest404Index)\n+          }\n+        }\n+        // Skip 500.html in static export\n+        if (unnormalizedRoute === '/_global-error') {\n           return\n         }\n         const { srcRoute } = prerenderManifest!.routes[unnormalizedRoute]\n@@ -840,6 +891,7 @@ async function exportAppImpl(\n         }\n \n         const segmentsDir = `${orig}${RSC_SEGMENTS_DIR_SUFFIX}`\n+\n         if (isAppPath && existsSync(segmentsDir)) {\n           // Output a data file for each of this page's segments\n           //\n@@ -903,7 +955,9 @@ async function exportAppImpl(\n     await telemetry.flush()\n   }\n \n-  await worker.end()\n+  if (worker) {\n+    await worker.end()\n+  }\n \n   return collector\n }"
        },
        {
            "sha": "6373101956ab4611ed3b3b7341081f7cd0299e47",
            "filename": "packages/next/src/export/routes/app-page.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Froutes%2Fapp-page.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -30,6 +30,10 @@ import type { RequestLifecycleOpts } from '../../server/base-server'\n import type { AppSharedContext } from '../../server/app-render/app-render'\n import type { MultiFileWriter } from '../../lib/multi-file-writer'\n import { stringifyResumeDataCache } from '../../server/resume-data-cache/resume-data-cache'\n+import {\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n+  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+} from '../../shared/lib/entry-constants'\n \n /**\n  * Renders & exports a page associated with the /app directory\n@@ -59,12 +63,17 @@ export async function exportAppPage(\n   }\n \n   let isDefaultNotFound = false\n+  let isDefaultGlobalError = false\n   // If the page is `/_not-found`, then we should update the page to be `/404`.\n-  // UNDERSCORE_NOT_FOUND_ROUTE value used here, however we don't want to import it here as it causes constants to be inlined which we don't want here.\n-  if (page === '/_not-found/page') {\n+  if (page === UNDERSCORE_NOT_FOUND_ROUTE_ENTRY) {\n     isDefaultNotFound = true\n     pathname = '/404'\n   }\n+  // If the page is `/_global-error`, then we should update the page to be `/500`.\n+  if (page === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY) {\n+    isDefaultGlobalError = true\n+    pathname = '/500'\n+  }\n \n   try {\n     const result = await lazyRenderAppPage(\n@@ -197,6 +206,9 @@ export async function exportAppPage(\n     if (isDefaultNotFound) {\n       // Override the default /_not-found page status code to 404\n       status = 404\n+    } else if (isDefaultGlobalError) {\n+      // Override the default /_global-error page status code to 500\n+      status = 500\n     } else if (isNonSuccessfulStatusCode && !isParallelRoute) {\n       // If it's parallel route the status from mock response is 404\n       status = res.statusCode"
        },
        {
            "sha": "795202731dd480f2ece1dd912f6c0705acec19bd",
            "filename": "packages/next/src/export/types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -112,6 +112,7 @@ export interface ExportAppOptions {\n   nextConfig?: NextConfigComplete\n   hasOutdirFromCli?: boolean\n   numWorkers: number\n+  appDirOnly: boolean\n }\n \n export type ExportPageMetadata = {"
        },
        {
            "sha": "a13ecbe0955c90682f478a733b02ab2f4294f54f",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -2749,9 +2749,10 @@ export default abstract class Server<\n \n       const is404 = res.statusCode === 404\n       let using404Page = false\n+      const hasAppDir = this.enabledDirectories.app\n \n       if (is404) {\n-        if (this.enabledDirectories.app) {\n+        if (hasAppDir) {\n           // Use the not-found entry in app directory\n           result = await this.findPageComponents({\n             locale: getRequestMeta(ctx.req, 'locale'),\n@@ -2789,6 +2790,21 @@ export default abstract class Server<\n         // skip ensuring /500 in dev mode as it isn't used and the\n         // dev overlay is used instead\n         if (statusPage !== '/500' || !this.renderOpts.dev) {\n+          if (!result && hasAppDir) {\n+            // Otherwise if app router present, load app router built-in 500 page\n+            result = await this.findPageComponents({\n+              locale: getRequestMeta(ctx.req, 'locale'),\n+              page: statusPage,\n+              query,\n+              params: {},\n+              isAppPath: true,\n+              // Ensuring can't be done here because you never \"match\" a 500\n+              // route.\n+              shouldEnsure: true,\n+              url: ctx.req.url,\n+            })\n+          }\n+          // If the above App Router result is empty, fallback to pages router 500 page\n           result = await this.findPageComponents({\n             locale: getRequestMeta(ctx.req, 'locale'),\n             page: statusPage,"
        },
        {
            "sha": "4a1699172a7efc98e40ac6b4dec59955a93d85e5",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -650,6 +650,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n             ),\n             pagesDir: this.pagesDir,\n             appDir: this.appDir,\n+            appDirOnly: Boolean(this.appDir && !this.pagesDir),\n           })\n         )\n "
        },
        {
            "sha": "31d4a3fc031678bf50a38cf04f4af507d5d7f520",
            "filename": "packages/next/src/server/lib/router-utils/route-types-utils.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -16,6 +16,10 @@ import {\n   extractInterceptionRouteInformation,\n   isInterceptionRouteAppPath,\n } from '../../../shared/lib/router/utils/interception-routes'\n+import {\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE,\n+  UNDERSCORE_NOT_FOUND_ROUTE,\n+} from '../../../shared/lib/entry-constants'\n \n interface RouteInfo {\n   path: string\n@@ -235,11 +239,15 @@ export async function createRouteTypesManifest({\n     }\n   }\n \n-  // Process layout routes\n+  // Process layout routes (exclude internal app error/not-found layouts)\n   for (const { route, filePath } of layoutRoutes) {\n+    if (\n+      route === UNDERSCORE_GLOBAL_ERROR_ROUTE ||\n+      route === UNDERSCORE_NOT_FOUND_ROUTE\n+    )\n+      continue\n     // Use the resolved route (for interception routes, this gives us the canonical route)\n     const resolvedRoute = resolveInterceptingRoute(route)\n-\n     if (!manifest.layoutRoutes[resolvedRoute]) {\n       manifest.layoutRoutes[resolvedRoute] = {\n         path: getRelativePath(filePath),\n@@ -256,8 +264,13 @@ export async function createRouteTypesManifest({\n     }\n   }\n \n-  // Process app routes\n+  // Process app routes (exclude internal app routes)\n   for (const { route, filePath } of appRoutes) {\n+    if (\n+      route === UNDERSCORE_GLOBAL_ERROR_ROUTE ||\n+      route === UNDERSCORE_NOT_FOUND_ROUTE\n+    )\n+      continue\n     // Don't include metadata routes or pages\n     if (\n       !filePath.endsWith('page.ts') &&"
        },
        {
            "sha": "67e692bc23d30cc208c180664e2b3605d57bcddc",
            "filename": "packages/next/src/server/require.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fserver%2Frequire.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fserver%2Frequire.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequire.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -78,6 +78,13 @@ export function getMaybePagePath(\n     return null\n   }\n \n+  // Handle absolute paths (e.g., built-in components)\n+  if (path.isAbsolute(pagePath)) {\n+    // Use the absolute path as-is\n+    pagePathCache?.set(cacheKey, pagePath)\n+    return pagePath\n+  }\n+\n   pagePath = path.join(serverBuildPath, pagePath)\n \n   pagePathCache?.set(cacheKey, pagePath)"
        },
        {
            "sha": "6151c8bcf7520f07c1f83bb54cc389b00800ac0d",
            "filename": "packages/next/src/shared/lib/constants.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 2,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fconstants.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -59,8 +59,14 @@ export const COMPILER_INDEXES: {\n   [COMPILER_NAMES.edgeServer]: 2,\n } as const\n \n-export const UNDERSCORE_NOT_FOUND_ROUTE = '/_not-found'\n-export const UNDERSCORE_NOT_FOUND_ROUTE_ENTRY = `${UNDERSCORE_NOT_FOUND_ROUTE}/page`\n+// Re-export entry constants for backward compatibility\n+export {\n+  UNDERSCORE_NOT_FOUND_ROUTE,\n+  UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE,\n+  UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n+} from './entry-constants'\n+\n export const PHASE_EXPORT = 'phase-export'\n export const PHASE_PRODUCTION_BUILD = 'phase-production-build'\n export const PHASE_PRODUCTION_SERVER = 'phase-production-server'"
        },
        {
            "sha": "76b592c650927f23d6de23fa91225302677a5689",
            "filename": "packages/next/src/shared/lib/entry-constants.ts",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fentry-constants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fentry-constants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fentry-constants.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,4 @@\n+export const UNDERSCORE_NOT_FOUND_ROUTE = '/_not-found'\n+export const UNDERSCORE_NOT_FOUND_ROUTE_ENTRY = `${UNDERSCORE_NOT_FOUND_ROUTE}/page`\n+export const UNDERSCORE_GLOBAL_ERROR_ROUTE = '/_global-error'\n+export const UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY = `${UNDERSCORE_GLOBAL_ERROR_ROUTE}/page`"
        },
        {
            "sha": "61f65c04e709849c4a1e35ef1d49cce9c08fb3c1",
            "filename": "test/e2e/app-dir/actions-unrecognized/actions-unrecognized.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions-unrecognized%2Factions-unrecognized.test.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -159,7 +159,18 @@ describe('unrecognized server actions', () => {\n             // FIXME: Currently, an unrecognized id in an MPA action results in a 500.\n             // This is not ideal, and ignores all nested `error.js` files, only showing the topmost one.\n             expect(response.status()).toBe(500)\n-            expect(response.headers()['content-type']).toStartWith('text/html')\n+            if (isNextDev) {\n+              expect(response.headers()['content-type']).toStartWith(\n+                'text/html'\n+              )\n+            } else {\n+              const responseText = await response.text()\n+              expect(responseText).toBe('Internal Server Error')\n+              expect(response.headers()['content-type']).toStartWith(\n+                'text/plain'\n+              )\n+            }\n+\n             // In dev, the 500 page doesn't have any SSR'd html, so it won't show anything without JS.\n             if (!isNextDev) {\n               expect(await browser.elementByCss('body').text()).toContain("
        },
        {
            "sha": "07e67d4cad7d6b8dc8af591466cb67d6f04d55e2",
            "filename": "test/e2e/app-dir/cache-components-dynamic-imports/cache-components-dynamic-imports.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-dynamic-imports%2Fcache-components-dynamic-imports.test.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -39,6 +39,7 @@ describe('async imports in cacheComponents', () => {\n \n       expect(prerenderedRoutes).toMatchInlineSnapshot(`\n        [\n+         \"/_global-error\",\n          \"/_not-found\",\n          \"/inside-render/client/async-module\",\n          \"/inside-render/client/sync-module\","
        },
        {
            "sha": "23f0220aa78c999653280c09aa575fecc5019368",
            "filename": "test/e2e/app-dir/metadata-static-generation/metadata-static-generation.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-static-generation%2Fmetadata-static-generation.test.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -24,6 +24,7 @@ const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n         const staticRoutes = prerenderManifest.routes\n         expect(Object.keys(staticRoutes).sort()).toEqual([\n           '/',\n+          '/_global-error',\n           '/_not-found',\n           '/suspenseful/static',\n         ])"
        },
        {
            "sha": "08eef67c16598d1474eb8b6461e84cde4bcd0d7e",
            "filename": "test/e2e/app-dir/metadata-streaming-static-generation/metadata-streaming-static-generation.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming-static-generation%2Fmetadata-streaming-static-generation.test.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -22,6 +22,7 @@ const isPPREnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n         const staticRoutes = prerenderManifest.routes\n         expect(Object.keys(staticRoutes).sort()).toEqual([\n           '/',\n+          '/_global-error',\n           '/_not-found',\n           '/slow/static',\n           '/suspenseful/static',"
        },
        {
            "sha": "ea0b46c43e5943f1a3dc74d3972cd0a6880617ec",
            "filename": "test/e2e/i18n-ignore-rewrite-source-locale/next.config.js",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fnext.config.js?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,25 @@\n+module.exports = {\n+  basePath: '/basepath',\n+  i18n: {\n+    locales: ['en', 'sv', 'nl'],\n+    defaultLocale: 'en',\n+  },\n+  async rewrites() {\n+    return {\n+      beforeFiles: [\n+        {\n+          source: '/:locale/rewrite-files/:path*',\n+          destination: '/:path*',\n+          locale: false,\n+        },\n+        {\n+          source: '/:locale/rewrite-api/:path*',\n+          destination: '/api/:path*',\n+          locale: false,\n+        },\n+      ],\n+      afterFiles: [],\n+      fallback: [],\n+    }\n+  },\n+}"
        },
        {
            "sha": "6313533c8569d53323d7838ee365abe9cc4e7583",
            "filename": "test/e2e/i18n-ignore-rewrite-source-locale/pages/api/hello.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fpages%2Fapi%2Fhello.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fpages%2Fapi%2Fhello.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fpages%2Fapi%2Fhello.js?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,3 @@\n+export default function handler(req, res) {\n+  res.send('hello from api')\n+}"
        },
        {
            "sha": "811b379a89ba45201ead2c89c38fa8423dca898c",
            "filename": "test/e2e/i18n-ignore-rewrite-source-locale/public/file.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fpublic%2Ffile.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fpublic%2Ffile.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Fpublic%2Ffile.txt?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1 @@\n+hello from file.txt\n\\ No newline at end of file"
        },
        {
            "sha": "944ff7b34b2dfa55a71ae4e9456e26adb3b4b30e",
            "filename": "test/e2e/i18n-ignore-rewrite-source-locale/rewrites-with-basepath.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 41,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Frewrites-with-basepath.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Frewrites-with-basepath.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fi18n-ignore-rewrite-source-locale%2Frewrites-with-basepath.test.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -1,52 +1,19 @@\n-import { createNext } from 'e2e-utils'\n-import { NextInstance } from 'e2e-utils'\n+import { nextTestSetup } from 'e2e-utils'\n import { fetchViaHTTP, renderViaHTTP } from 'next-test-utils'\n import path from 'path'\n import fs from 'fs-extra'\n \n const locales = ['', '/en', '/sv', '/nl']\n \n describe('i18n-ignore-rewrite-source-locale with basepath', () => {\n-  let next: NextInstance\n-\n-  beforeAll(async () => {\n-    next = await createNext({\n-      files: {\n-        'pages/api/hello.js': `\n-        export default function handler(req, res) {\n-          res.send('hello from api')\n-        }`,\n-        'public/file.txt': 'hello from file.txt',\n-      },\n-      dependencies: {},\n-      nextConfig: {\n-        basePath: '/basepath',\n-        i18n: {\n-          locales: ['en', 'sv', 'nl'],\n-          defaultLocale: 'en',\n-        },\n-        async rewrites() {\n-          return {\n-            beforeFiles: [\n-              {\n-                source: '/:locale/rewrite-files/:path*',\n-                destination: '/:path*',\n-                locale: false,\n-              },\n-              {\n-                source: '/:locale/rewrite-api/:path*',\n-                destination: '/api/:path*',\n-                locale: false,\n-              },\n-            ],\n-            afterFiles: [],\n-            fallback: [],\n-          }\n-        },\n-      },\n-    })\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n   })\n-  afterAll(() => next.destroy())\n+\n+  if (skipped) {\n+    return\n+  }\n \n   test.each(locales)(\n     'get public file by skipping locale in rewrite, locale: %s',"
        },
        {
            "sha": "df6a21aca783e6a61437782de61ae12fe3d7d998",
            "filename": "test/integration/app-dir-export/test/utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fintegration%2Fapp-dir-export%2Ftest%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fintegration%2Fapp-dir-export%2Ftest%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Futils.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -42,6 +42,8 @@ export const expectedWhenTrailingSlashTrue = [\n     ? ['_next/static/test-build-id/_clientMiddlewareManifest.json']\n     : []),\n   '_next/static/test-build-id/_ssgManifest.js',\n+  '_not-found/index.html',\n+  '_not-found/index.txt',\n   'another/first/index.html',\n   'another/first/index.txt',\n   'another/index.html',\n@@ -72,6 +74,8 @@ const expectedWhenTrailingSlashFalse = [\n     ? ['_next/static/test-build-id/_clientMiddlewareManifest.json']\n     : []),\n   '_next/static/test-build-id/_ssgManifest.js',\n+  '_not-found.html',\n+  '_not-found.txt',\n   'another.html',\n   'another.txt',\n   'another/first.html',"
        },
        {
            "sha": "8eaacf2d22ff5b0b2d1c12d568f669c1409d6cd4",
            "filename": "test/integration/next-dynamic-css/tsconfig.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fintegration%2Fnext-dynamic-css%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fintegration%2Fnext-dynamic-css%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-dynamic-css%2Ftsconfig.json?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -21,5 +21,5 @@\n     \"strictNullChecks\": true\n   },\n   \"include\": [\"next-env.d.ts\", \".next/types/**/*.ts\", \"**/*.ts\", \"**/*.tsx\"],\n-  \"exclude\": [\"node_modules\"]\n+  \"exclude\": [\"node_modules\", \"**/*.test.ts\", \"**/*.test.tsx\"]\n }"
        },
        {
            "sha": "47585f2573ec20f1cadab61a0b7dfe365b59310b",
            "filename": "test/production/500-page/app-router-only/app-router-only.test.ts",
            "status": "added",
            "additions": 64,
            "deletions": 0,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp-router-only.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp-router-only.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp-router-only.test.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,64 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import fsp from 'fs/promises'\n+import path from 'path'\n+\n+describe('500-page app-router-only', () => {\n+  const { next, isNextStart, isTurbopack, isNextDeploy } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  if (isNextDeploy) {\n+    it('should render app router 500 page when route error', async () => {\n+      const $ = await next.render$('/route-error')\n+      expect($('html').attr('id')).toBe('__next_error__')\n+      expect($('body').text()).toContain('Internal Server Error.')\n+      expect($('body').text()).toContain('500')\n+    })\n+  }\n+\n+  if (isNextStart) {\n+    it('should use app router to generate 500.html when no pages _error.tsx exists', async () => {\n+      const html = await fsp.readFile(\n+        path.join(next.testDir, '.next', 'server', 'pages', '500.html'),\n+        'utf8'\n+      )\n+      // Not use pages router to generate 500.html\n+      expect(html).toContain('__next_error__')\n+      expect(html).toContain('Internal Server Error.')\n+      // global-error is not used in app router 500.html\n+      expect(html).not.toContain('app-router-global-error')\n+    })\n+\n+    it('pages manifest should only contain 404 and 500', async () => {\n+      const pagesManifest = await fsp.readFile(\n+        path.join(next.testDir, '.next', 'server', 'pages-manifest.json'),\n+        'utf8'\n+      )\n+      const pagesManifestJson = JSON.parse(pagesManifest)\n+      expect(pagesManifestJson).toMatchInlineSnapshot(`\n+        {\n+          \"/404\": \"pages/404.html\",\n+          \"/500\": \"pages/500.html\",\n+        }\n+      `)\n+    })\n+\n+    it('should not contain pages router routes default assets', async () => {\n+      // do not contain _app, _document, _error routes folder or files in .next/server/pages\n+      const pagesDir = path.join(next.testDir, '.next', 'server', 'pages')\n+      const files = await fsp.readdir(pagesDir)\n+      expect(files).not.toContain('500')\n+      if (isTurbopack) {\n+        // In turbopack, _app, _document, _error are still generated with manifest, but no javascript files.\n+        // The manifest are under the folder, they're still needed for static generation.\n+        expect(files).not.toContain('_app.js')\n+        expect(files).not.toContain('_document.js')\n+        expect(files).not.toContain('_error.js')\n+      } else {\n+        expect(files).not.toContain('_app')\n+        expect(files).not.toContain('_document')\n+        expect(files).not.toContain('_error')\n+      }\n+    })\n+  }\n+})"
        },
        {
            "sha": "b88e7a1eb65ba727e83dfd7db9a4ea766f1a9f23",
            "filename": "test/production/500-page/app-router-only/app/actions.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Factions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Factions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Factions.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,5 @@\n+'use server'\n+\n+export async function throwErrorAction() {\n+  throw new Error('action error')\n+}"
        },
        {
            "sha": "fbe141379d43c24535dd35f90b9636d0c45c84c9",
            "filename": "test/production/500-page/app-router-only/app/global-error.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Fglobal-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Fglobal-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Fglobal-error.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,11 @@\n+'use client'\n+\n+export default function GlobalError() {\n+  return (\n+    <html>\n+      <body>\n+        <h1>app-router-global-error</h1>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/production/500-page/app-router-only/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Flayout.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "e8f9c7cf0138cc5f365f9adc2368a7797a881702",
            "filename": "test/production/500-page/app-router-only/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Fpage.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>app page</p>\n+}"
        },
        {
            "sha": "493d9915b7f3995613bf455bce372bf26590dbbf",
            "filename": "test/production/500-page/app-router-only/app/route-error/route.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Froute-error%2Froute.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Froute-error%2Froute.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fapp-router-only%2Fapp%2Froute-error%2Froute.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,6 @@\n+import { connection } from 'next/server'\n+\n+export async function GET() {\n+  await connection()\n+  throw new Error('route error')\n+}"
        },
        {
            "sha": "4d40f79d02e1d604c6208b8276a53ca33ef8400b",
            "filename": "test/production/500-page/app-router-only/middleware.ts",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fapp-router-only%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fapp-router-only%2Fmiddleware.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,8 @@\n+import { NextRequest, NextResponse } from 'next/server'\n+\n+export async function middleware(request: NextRequest) {\n+  if (request.nextUrl.pathname === '/middleware-error') {\n+    throw new Error('middleware error')\n+  }\n+  return NextResponse.next()\n+}"
        },
        {
            "sha": "2189c62dce3f29c7ac53cff712719a4dd27fa1b1",
            "filename": "test/production/500-page/mixed-router-no-custom-pages-error/app/app-page/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Fapp-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Fapp-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Fapp-page%2Fpage.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,3 @@\n+export default function AppPage() {\n+  return <p>app page</p>\n+}"
        },
        {
            "sha": "2af2fef8abcf322789d5a1febe869f159512ec95",
            "filename": "test/production/500-page/mixed-router-no-custom-pages-error/app/global-error.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Fglobal-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Fglobal-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Fglobal-error.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,11 @@\n+'use client'\n+\n+export default function GlobalError() {\n+  return (\n+    <html>\n+      <body>\n+        <p>app-router-global-error</p>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/production/500-page/mixed-router-no-custom-pages-error/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fapp%2Flayout.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "781e6edf5cba916ad3e7fc5dd1ba1b2ceba960c4",
            "filename": "test/production/500-page/mixed-router-no-custom-pages-error/mixed-router-no-error.test.ts",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fmixed-router-no-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fmixed-router-no-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fmixed-router-no-error.test.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,47 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import fsp from 'fs/promises'\n+import path from 'path'\n+\n+describe('500-page - mixed-router-no-custom-pages-error', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should not use app router global-error for 500.html when no pages _error.tsx exists', async () => {\n+    const $ = await next.render$('/pages-error')\n+    const text = $('#__next').text()\n+    expect(text).toContain('500')\n+    expect(text).toContain('Internal Server Error')\n+  })\n+\n+  it('pages manifest should only contain 404 and 500', async () => {\n+    const pagesManifest = await fsp.readFile(\n+      path.join(next.testDir, '.next', 'server', 'pages-manifest.json'),\n+      'utf8'\n+    )\n+    const pagesManifestJson = JSON.parse(pagesManifest)\n+    expect(pagesManifestJson).toMatchInlineSnapshot(`\n+     {\n+       \"/404\": \"pages/404.html\",\n+       \"/_app\": \"pages/_app.js\",\n+       \"/_document\": \"pages/_document.js\",\n+       \"/_error\": \"pages/_error.js\",\n+       \"/pages-error\": \"pages/pages-error.js\",\n+     }\n+    `)\n+  })\n+\n+  it('should generate 500.html with pages builtin _error', async () => {\n+    const html = await fsp.readFile(\n+      path.join(next.testDir, '.next', 'server', 'pages', '500.html'),\n+      'utf8'\n+    )\n+    expect(html).toContain('500')\n+    expect(html).toContain('Internal Server Error')\n+  })\n+})"
        },
        {
            "sha": "34eff25b21460720a51504f85dca51bb5dacd4ba",
            "filename": "test/production/500-page/mixed-router-no-custom-pages-error/pages/pages-error.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fpages%2Fpages-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fpages%2Fpages-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-no-custom-pages-error%2Fpages%2Fpages-error.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,10 @@\n+export default function PagesPage() {\n+  throw new Error('pages page error')\n+  return <p>pages page</p>\n+}\n+\n+export async function getServerSideProps() {\n+  return {\n+    props: {},\n+  }\n+}"
        },
        {
            "sha": "2189c62dce3f29c7ac53cff712719a4dd27fa1b1",
            "filename": "test/production/500-page/mixed-router-with-custom-pages-error/app/app-page/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Fapp-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Fapp-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Fapp-page%2Fpage.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,3 @@\n+export default function AppPage() {\n+  return <p>app page</p>\n+}"
        },
        {
            "sha": "970cf3b3eb98215cb956adac82461d8b83e0b19e",
            "filename": "test/production/500-page/mixed-router-with-custom-pages-error/app/global-error.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Fglobal-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Fglobal-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Fglobal-error.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,17 @@\n+'use client'\n+\n+export default function GlobalError({\n+  error,\n+  reset,\n+}: {\n+  error: Error & { digest?: string }\n+  reset: () => void\n+}) {\n+  return (\n+    <html>\n+      <body>\n+        <p>app-router-global-error</p>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/production/500-page/mixed-router-with-custom-pages-error/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fapp%2Flayout.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "da357861f5fd106f3a56bb60c3db525b26b90a46",
            "filename": "test/production/500-page/mixed-router-with-custom-pages-error/mixed-router-with-error.test.ts",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fmixed-router-with-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fmixed-router-with-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fmixed-router-with-error.test.ts?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,27 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import fsp from 'fs/promises'\n+import path from 'path'\n+\n+describe('500-page - mixed-router-with-custom-pages-error', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should not override 500.html with app router global-error when pages _error.tsx exists', async () => {\n+    const $ = await next.render$('/pages-error')\n+    expect($('#__next').text()).toBe('pages-custom-error')\n+  })\n+\n+  it('should generate 500.html with pages builtin _error', async () => {\n+    const html = await fsp.readFile(\n+      path.join(next.testDir, '.next', 'server', 'pages', '500.html'),\n+      'utf8'\n+    )\n+    expect(html).toContain('pages-custom-error')\n+  })\n+})"
        },
        {
            "sha": "468f27881d9a2af635e4b7a4275a5689d77d6924",
            "filename": "test/production/500-page/mixed-router-with-custom-pages-error/pages/_error.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fpages%2F_error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fpages%2F_error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fpages%2F_error.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Error() {\n+  return <p>pages-custom-error</p>\n+}"
        },
        {
            "sha": "34eff25b21460720a51504f85dca51bb5dacd4ba",
            "filename": "test/production/500-page/mixed-router-with-custom-pages-error/pages/pages-error.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fpages%2Fpages-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fpages%2Fpages-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2F500-page%2Fmixed-router-with-custom-pages-error%2Fpages%2Fpages-error.tsx?ref=8f6cd5e8093a74b4ead0ee3ededb2ed63262df2e",
            "patch": "@@ -0,0 +1,10 @@\n+export default function PagesPage() {\n+  throw new Error('pages page error')\n+  return <p>pages page</p>\n+}\n+\n+export async function getServerSideProps() {\n+  return {\n+    props: {},\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 1234,
        "additions": 1023,
        "deletions": 211
    }
}