{
    "author": "devjiwonchoi",
    "message": "test: split error recovery HMR test into multiple files (#79066)\n\nSplit long-running error recovery hmr test to parallelize and reduce CI\ntime.\n\nPort of https://github.com/vercel/next.js/pull/73617, confirmed and\nsynced changes https://github.com/vercel/next.js/pull/78198,\nhttps://github.com/vercel/next.js/pull/77892,\nhttps://github.com/vercel/next.js/pull/76299,\nhttps://github.com/vercel/next.js/pull/76290, and\nhttps://github.com/vercel/next.js/pull/75882.\n\nx-ref:\nhttps://github.com/vercel/next.js/commits/canary/test/development/basic/hmr/error-recovery.test.ts",
    "sha": "7ac4eae058ba76adbca53a92424c6796a322676d",
    "files": [
        {
            "sha": "337634c2cbe5e5dac102a6124535e8f34267962b",
            "filename": "test/development/basic/hmr/error-recovery-no-base-path-no-asset-prefix.test.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-no-base-path-no-asset-prefix.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-no-base-path-no-asset-prefix.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-no-base-path-no-asset-prefix.test.ts?ref=7ac4eae058ba76adbca53a92424c6796a322676d",
            "patch": "@@ -0,0 +1,7 @@\n+import { runErrorRecoveryHmrTest } from './run-error-recovery-hmr-test.util'\n+\n+const nextConfig = { basePath: '', assetPrefix: '' }\n+\n+describe(`HMR - Error Recovery, nextConfig: ${JSON.stringify(nextConfig)}`, () => {\n+  runErrorRecoveryHmrTest(nextConfig)\n+})"
        },
        {
            "sha": "f0ba03b132f47d23542c5a627c600256d3a42506",
            "filename": "test/development/basic/hmr/error-recovery-no-base-path-yes-asset-prefix.test.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-no-base-path-yes-asset-prefix.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-no-base-path-yes-asset-prefix.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-no-base-path-yes-asset-prefix.test.ts?ref=7ac4eae058ba76adbca53a92424c6796a322676d",
            "patch": "@@ -0,0 +1,7 @@\n+import { runErrorRecoveryHmrTest } from './run-error-recovery-hmr-test.util'\n+\n+const nextConfig = { basePath: '', assetPrefix: '/asset-prefix' }\n+\n+describe(`HMR - Error Recovery, nextConfig: ${JSON.stringify(nextConfig)}`, () => {\n+  runErrorRecoveryHmrTest(nextConfig)\n+})"
        },
        {
            "sha": "2a566068e84bf65dc5e46d8bbc7e18b06ce7d397",
            "filename": "test/development/basic/hmr/error-recovery-yes-base-path-no-asset-prefix.test.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-yes-base-path-no-asset-prefix.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-yes-base-path-no-asset-prefix.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-yes-base-path-no-asset-prefix.test.ts?ref=7ac4eae058ba76adbca53a92424c6796a322676d",
            "patch": "@@ -0,0 +1,7 @@\n+import { runErrorRecoveryHmrTest } from './run-error-recovery-hmr-test.util'\n+\n+const nextConfig = { basePath: '/docs', assetPrefix: '' }\n+\n+describe(`HMR - Error Recovery, nextConfig: ${JSON.stringify(nextConfig)}`, () => {\n+  runErrorRecoveryHmrTest(nextConfig)\n+})"
        },
        {
            "sha": "a5d6ea966b0abcfcc86b550100d931c1e8a28eea",
            "filename": "test/development/basic/hmr/error-recovery-yes-base-path-yes-asset-prefix.test.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-yes-base-path-yes-asset-prefix.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-yes-base-path-yes-asset-prefix.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery-yes-base-path-yes-asset-prefix.test.ts?ref=7ac4eae058ba76adbca53a92424c6796a322676d",
            "patch": "@@ -0,0 +1,7 @@\n+import { runErrorRecoveryHmrTest } from './run-error-recovery-hmr-test.util'\n+\n+const nextConfig = { basePath: '/docs', assetPrefix: '/asset-prefix' }\n+\n+describe(`HMR - Error Recovery, nextConfig: ${JSON.stringify(nextConfig)}`, () => {\n+  runErrorRecoveryHmrTest(nextConfig)\n+})"
        },
        {
            "sha": "60262d46a7f7507f150e0494a74a808c99e16616",
            "filename": "test/development/basic/hmr/error-recovery.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 842,
            "changes": 842,
            "blob_url": "https://github.com/vercel/next.js/blob/3f9f403a048f1f3b1419d92f70245d4e8c77ac27/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3f9f403a048f1f3b1419d92f70245d4e8c77ac27/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fhmr%2Ferror-recovery.test.ts?ref=3f9f403a048f1f3b1419d92f70245d4e8c77ac27",
            "patch": "@@ -1,842 +0,0 @@\n-import type { NextConfig } from 'next'\n-import { join } from 'path'\n-import {\n-  assertHasRedbox,\n-  assertNoRedbox,\n-  getBrowserBodyText,\n-  getRedboxHeader,\n-  getRedboxDescription,\n-  getRedboxSource,\n-  renderViaHTTP,\n-  retry,\n-  waitFor,\n-  trimEndMultiline,\n-} from 'next-test-utils'\n-import { nextTestSetup } from 'e2e-utils'\n-import { outdent } from 'outdent'\n-\n-describe.each([\n-  { basePath: '', assetPrefix: '' },\n-  { basePath: '', assetPrefix: '/asset-prefix' },\n-  { basePath: '/docs', assetPrefix: '' },\n-  { basePath: '/docs', assetPrefix: '/asset-prefix' },\n-])(\n-  'HMR - Error Recovery, nextConfig: %o',\n-  (nextConfig: Partial<NextConfig>) => {\n-    const { next } = nextTestSetup({\n-      files: __dirname,\n-      nextConfig,\n-      patchFileDelay: 500,\n-    })\n-    const { basePath } = nextConfig\n-\n-    it('should recover from 404 after a page has been added', async () => {\n-      const newPage = join('pages', 'hmr', 'new-page.js')\n-\n-      try {\n-        const browser = await next.browser(basePath + '/hmr/new-page')\n-\n-        expect(await browser.elementByCss('body').text()).toMatch(\n-          /This page could not be found/\n-        )\n-\n-        // Add the page\n-        await next.patchFile(\n-          newPage,\n-          'export default () => (<div id=\"new-page\">the-new-page</div>)'\n-        )\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(/the-new-page/)\n-        })\n-\n-        await next.deleteFile(newPage)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This page could not be found/\n-          )\n-        })\n-\n-        expect(next.cliOutput).toContain('Compiled /_error')\n-      } catch (err) {\n-        await next.deleteFile(newPage)\n-        throw err\n-      }\n-    })\n-\n-    it('should recover from 404 after a page has been added with dynamic segments', async () => {\n-      const newPage = join('pages', 'hmr', '[foo]', 'page.js')\n-\n-      try {\n-        const browser = await next.browser(basePath + '/hmr/foo/page')\n-\n-        expect(await browser.elementByCss('body').text()).toMatch(\n-          /This page could not be found/\n-        )\n-\n-        // Add the page\n-        await next.patchFile(\n-          newPage,\n-          'export default () => (<div id=\"new-page\">the-new-page</div>)'\n-        )\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(/the-new-page/)\n-        })\n-\n-        await next.deleteFile(newPage)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This page could not be found/\n-          )\n-        })\n-\n-        expect(next.cliOutput).toContain('Compiled /_error')\n-      } catch (err) {\n-        await next.deleteFile(newPage)\n-        throw err\n-      }\n-    })\n-    ;(process.env.IS_TURBOPACK_TEST ? it.skip : it)(\n-      // this test fails frequently with turbopack\n-      'should not continously poll a custom error page',\n-      async () => {\n-        const errorPage = join('pages', '_error.js')\n-\n-        await next.patchFile(\n-          errorPage,\n-          outdent`\n-          function Error({ statusCode, message, count }) {\n-            return (\n-              <div>\n-                Error Message: {message}\n-              </div>\n-            )\n-          }\n-\n-          Error.getInitialProps = async ({ res, err }) => {\n-            const statusCode = res ? res.statusCode : err ? err.statusCode : 404\n-            console.log('getInitialProps called');\n-            return {\n-              statusCode,\n-              message: err ? err.message : 'Oops...',\n-            }\n-          }\n-\n-          export default Error\n-        `\n-        )\n-\n-        try {\n-          // navigate to a 404 page\n-          await next.browser(basePath + '/does-not-exist')\n-\n-          await retry(() => {\n-            // eslint-disable-next-line jest/no-standalone-expect\n-            expect(next.cliOutput).toMatch(/getInitialProps called/)\n-          })\n-\n-          const outputIndex = next.cliOutput.length\n-\n-          // wait a few seconds to ensure polling didn't happen\n-          await waitFor(3000)\n-\n-          const logOccurrences =\n-            next.cliOutput.slice(outputIndex).split('getInitialProps called')\n-              .length - 1\n-          // eslint-disable-next-line jest/no-standalone-expect\n-          expect(logOccurrences).toBe(0)\n-        } finally {\n-          await next.deleteFile(errorPage)\n-        }\n-      }\n-    )\n-\n-    it('should detect syntax errors and recover', async () => {\n-      const browser = await next.browser(basePath + '/hmr/about2')\n-      const aboutPage = join('pages', 'hmr', 'about2.js')\n-      const aboutContent = await next.readFile(aboutPage)\n-      await retry(async () => {\n-        expect(await getBrowserBodyText(browser)).toMatch(\n-          /This is the about page/\n-        )\n-      })\n-\n-      await next.patchFile(aboutPage, aboutContent.replace('</div>', 'div'))\n-\n-      await assertHasRedbox(browser)\n-      const source = next.normalizeTestDirContent(\n-        await getRedboxSource(browser)\n-      )\n-\n-      if (basePath === '' && process.env.IS_TURBOPACK_TEST) {\n-        expect(source).toMatchInlineSnapshot(`\n-         \"./pages/hmr/about2.js (7:1)\n-         Parsing ecmascript source code failed\n-           5 |     div\n-           6 |   )\n-         > 7 | }\n-             | ^\n-           8 |\n-\n-         Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\"\n-        `)\n-      } else if (basePath === '' && process.env.NEXT_RSPACK) {\n-        expect(trimEndMultiline(source)).toMatchInlineSnapshot(`\n-         \"./pages/hmr/about2.js\n-           × Module build failed:\n-           ├─▶   ×\n-           │     │   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n-           │     │    ,-[TEST_DIR/pages/hmr/about2.js:7:1]\n-           │     │  4 |       <p>This is the about page.</p>\n-           │     │  5 |     div\n-           │     │  6 |   )\n-           │     │  7 | }\n-           │     │    : ^\n-           │     │    \\`----\n-           │     │\n-           │     │   x Unexpected eof\n-           │     │    ,-[TEST_DIR/pages/hmr/about2.js:7:3]\n-           │     │  5 |     div\n-           │     │  6 |   )\n-           │     │  7 | }\n-           │     │    \\`----\n-           │     │\n-           │\n-           ╰─▶ Syntax Error\n-\n-         Import trace for requested module:\n-         ./pages/hmr/about2.js\"\n-        `)\n-      } else if (basePath === '') {\n-        expect(source).toMatchInlineSnapshot(`\n-          \"./pages/hmr/about2.js\n-          Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n-             ,-[7:1]\n-           4 |       <p>This is the about page.</p>\n-           5 |     div\n-           6 |   )\n-           7 | }\n-             : ^\n-             \\`----\n-            x Unexpected eof\n-             ,-[7:3]\n-           5 |     div\n-           6 |   )\n-           7 | }\n-             \\`----\n-\n-          Caused by:\n-              Syntax Error\n-\n-          Import trace for requested module:\n-          ./pages/hmr/about2.js\"\n-        `)\n-      } else if (basePath === '/docs' && process.env.IS_TURBOPACK_TEST) {\n-        expect(source).toMatchInlineSnapshot(`\n-            \"./pages/hmr/about2.js (7:1)\n-            Parsing ecmascript source code failed\n-              5 |     div\n-              6 |   )\n-            > 7 | }\n-                | ^\n-              8 |\n-\n-            Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\"\n-          `)\n-      } else if (basePath === '/docs' && process.env.NEXT_RSPACK) {\n-        expect(trimEndMultiline(source)).toMatchInlineSnapshot(`\n-         \"./pages/hmr/about2.js\n-           × Module build failed:\n-           ├─▶   ×\n-           │     │   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n-           │     │    ,-[TEST_DIR/pages/hmr/about2.js:7:1]\n-           │     │  4 |       <p>This is the about page.</p>\n-           │     │  5 |     div\n-           │     │  6 |   )\n-           │     │  7 | }\n-           │     │    : ^\n-           │     │    \\`----\n-           │     │\n-           │     │   x Unexpected eof\n-           │     │    ,-[TEST_DIR/pages/hmr/about2.js:7:3]\n-           │     │  5 |     div\n-           │     │  6 |   )\n-           │     │  7 | }\n-           │     │    \\`----\n-           │     │\n-           │\n-           ╰─▶ Syntax Error\n-\n-         Import trace for requested module:\n-         ./pages/hmr/about2.js\"\n-        `)\n-      } else if (basePath === '/docs') {\n-        expect(source).toMatchInlineSnapshot(`\n-          \"./pages/hmr/about2.js\n-          Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n-             ,-[7:1]\n-           4 |       <p>This is the about page.</p>\n-           5 |     div\n-           6 |   )\n-           7 | }\n-             : ^\n-             \\`----\n-            x Unexpected eof\n-             ,-[7:3]\n-           5 |     div\n-           6 |   )\n-           7 | }\n-             \\`----\n-\n-          Caused by:\n-              Syntax Error\n-\n-          Import trace for requested module:\n-          ./pages/hmr/about2.js\"\n-        `)\n-      }\n-\n-      await next.patchFile(aboutPage, aboutContent)\n-\n-      await retry(async () => {\n-        expect(await getBrowserBodyText(browser)).toMatch(\n-          /This is the about page/\n-        )\n-      })\n-    })\n-\n-    if (!process.env.IS_TURBOPACK_TEST) {\n-      // Turbopack doesn't have this restriction\n-      it('should show the error on all pages', async () => {\n-        const aboutPage = join('pages', 'hmr', 'about2.js')\n-        const aboutContent = await next.readFile(aboutPage)\n-        const browser = await next.browser(basePath + '/hmr/contact')\n-        try {\n-          await renderViaHTTP(next.url, basePath + '/hmr/about2')\n-\n-          await next.patchFile(aboutPage, aboutContent.replace('</div>', 'div'))\n-\n-          // Ensure dev server has time to break:\n-          await new Promise((resolve) => setTimeout(resolve, 2000))\n-\n-          await assertHasRedbox(browser)\n-          expect(await getRedboxSource(browser)).toMatch(/Unexpected eof/)\n-\n-          await next.patchFile(aboutPage, aboutContent)\n-\n-          await retry(async () => {\n-            expect(await getBrowserBodyText(browser)).toMatch(\n-              /This is the contact page/\n-            )\n-          })\n-        } catch (err) {\n-          await next.patchFile(aboutPage, aboutContent)\n-          if (browser) {\n-            await retry(async () => {\n-              expect(await getBrowserBodyText(browser)).toMatch(\n-                /This is the contact page/\n-              )\n-            })\n-          }\n-\n-          throw err\n-        }\n-      })\n-    }\n-\n-    it('should detect runtime errors on the module scope', async () => {\n-      const browser = await next.browser(basePath + '/hmr/about3')\n-      const aboutPage = join('pages', 'hmr', 'about3.js')\n-      const aboutContent = await next.readFile(aboutPage)\n-      try {\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        await next.patchFile(\n-          aboutPage,\n-          aboutContent.replace('export', 'aa=20;\\nexport')\n-        )\n-\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxHeader(browser)).toMatch(/aa is not defined/)\n-\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-      } finally {\n-        await next.patchFile(aboutPage, aboutContent)\n-      }\n-    })\n-\n-    it('should recover from errors in the render function', async () => {\n-      const browser = await next.browser(basePath + '/hmr/about4')\n-      const aboutPage = join('pages', 'hmr', 'about4.js')\n-      const aboutContent = await next.readFile(aboutPage)\n-      try {\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        await next.patchFile(\n-          aboutPage,\n-          aboutContent.replace(\n-            'return',\n-            'throw new Error(\"an-expected-error\");\\nreturn'\n-          )\n-        )\n-\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxSource(browser)).toMatch(/an-expected-error/)\n-\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-      } catch (err) {\n-        await next.patchFile(aboutPage, aboutContent)\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        throw err\n-      }\n-    })\n-\n-    it('should recover after exporting an invalid page', async () => {\n-      const browser = await next.browser(basePath + '/hmr/about5')\n-      const aboutPage = join('pages', 'hmr', 'about5.js')\n-      const aboutContent = await next.readFile(aboutPage)\n-      try {\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        await next.patchFile(\n-          aboutPage,\n-          aboutContent.replace(\n-            'export default',\n-            'export default {};\\nexport const fn ='\n-          )\n-        )\n-\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n-          `\"The default export is not a React Component in page: \"/hmr/about5\"\"`\n-        )\n-\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-      } catch (err) {\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        throw err\n-      }\n-    })\n-\n-    it('should recover after a bad return from the render function', async () => {\n-      const browser = await next.browser(basePath + '/hmr/about6')\n-      const aboutPage = join('pages', 'hmr', 'about6.js')\n-      const aboutContent = await next.readFile(aboutPage)\n-      try {\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        await next.patchFile(\n-          aboutPage,\n-          aboutContent.replace(\n-            'export default',\n-            'export default () => /search/;\\nexport const fn ='\n-          )\n-        )\n-\n-        await assertHasRedbox(browser)\n-        // TODO: Replace this when webpack 5 is the default\n-        expect(await getRedboxHeader(browser)).toMatch(\n-          `Objects are not valid as a React child (found: [object RegExp]). If you meant to render a collection of children, use an array instead.`\n-        )\n-\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-      } catch (err) {\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        throw err\n-      }\n-    })\n-\n-    it('should recover after undefined exported as default', async () => {\n-      const browser = await next.browser(basePath + '/hmr/about7')\n-      const aboutPage = join('pages', 'hmr', 'about7.js')\n-\n-      const aboutContent = await next.readFile(aboutPage)\n-      try {\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        await next.patchFile(\n-          aboutPage,\n-          aboutContent.replace(\n-            'export default',\n-            'export default undefined;\\nexport const fn ='\n-          )\n-        )\n-\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n-          `\"The default export is not a React Component in page: \"/hmr/about7\"\"`\n-        )\n-\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-        await assertNoRedbox(browser)\n-      } catch (err) {\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        throw err\n-      }\n-    })\n-\n-    it('should recover after webpack parse error in an imported file', async () => {\n-      const browser = await next.browser(basePath + '/hmr/about8')\n-      const aboutPage = join('pages', 'hmr', 'about8.js')\n-\n-      const aboutContent = await next.readFile(aboutPage)\n-      try {\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        await next.patchFile(\n-          aboutPage,\n-          aboutContent.replace(\n-            'export default',\n-            'import \"../../components/parse-error.xyz\"\\nexport default'\n-          )\n-        )\n-\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxHeader(browser)).toMatch('Build Error')\n-\n-        if (process.env.IS_TURBOPACK_TEST) {\n-          expect(await getRedboxSource(browser)).toMatchInlineSnapshot(`\n-              \"./components/parse-error.xyz\n-              Unknown module type\n-              This module doesn't have an associated type. Use a known file extension, or register a loader for it.\n-\n-              Read more: https://nextjs.org/docs/app/api-reference/next-config-js/turbo#webpack-loaders\"\n-            `)\n-        } else if (process.env.NEXT_RSPACK) {\n-          expect(trimEndMultiline(await getRedboxSource(browser)))\n-            .toMatchInlineSnapshot(`\n-           \"./components/parse-error.xyz\n-             × Module parse failed:\n-             ╰─▶   × JavaScript parsing error: Expression expected\n-                    ╭─[3:0]\n-                  1 │ This\n-                  2 │ is\n-                  3 │ }}}\n-                    · ─\n-                  4 │ invalid\n-                  5 │ js\n-                    ╰────\n-\n-             help:\n-                   You may need an appropriate loader to handle this file type.\n-\n-           Import trace for requested module:\n-           ./components/parse-error.xyz\n-           ./pages/hmr/about8.js\"\n-          `)\n-        } else {\n-          expect(await getRedboxSource(browser)).toMatchInlineSnapshot(`\n-                      \"./components/parse-error.xyz\n-                      Module parse failed: Unexpected token (3:0)\n-                      You may need an appropriate loader to handle this file type, currently no loaders are configured to process this file. See https://webpack.js.org/concepts#loaders\n-                      | This\n-                      | is\n-                      > }}}\n-                      | invalid\n-                      | js\n-\n-                      Import trace for requested module:\n-                      ./components/parse-error.xyz\n-                      ./pages/hmr/about8.js\"\n-                  `)\n-        }\n-\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-        await assertNoRedbox(browser)\n-      } catch (err) {\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        throw err\n-      }\n-    })\n-\n-    it('should recover after loader parse error in an imported file', async () => {\n-      const browser = await next.browser(basePath + '/hmr/about9')\n-      const aboutPage = join('pages', 'hmr', 'about9.js')\n-\n-      const aboutContent = await next.readFile(aboutPage)\n-      try {\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-\n-        await next.patchFile(\n-          aboutPage,\n-          aboutContent.replace(\n-            'export default',\n-            'import \"../../components/parse-error.js\"\\nexport default'\n-          )\n-        )\n-\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxHeader(browser)).toMatch('Build Error')\n-        let redboxSource = await getRedboxSource(browser)\n-\n-        redboxSource = redboxSource.replace(`${next.testDir}`, '.')\n-        if (process.env.IS_TURBOPACK_TEST) {\n-          expect(next.normalizeTestDirContent(redboxSource))\n-            .toMatchInlineSnapshot(`\n-           \"./components/parse-error.js (3:1)\n-           Parsing ecmascript source code failed\n-             1 | This\n-             2 | is\n-           > 3 | }}}\n-               | ^\n-             4 | invalid\n-             5 | js\n-\n-           Expression expected\"\n-          `)\n-        } else if (process.env.NEXT_RSPACK) {\n-          expect(trimEndMultiline(next.normalizeTestDirContent(redboxSource)))\n-            .toMatchInlineSnapshot(`\n-           \"./components/parse-error.js\n-             × Module build failed:\n-             ├─▶   ×\n-             │     │   x Expression expected\n-             │     │    ,-[./components/parse-error.js:3:1]\n-             │     │  1 | This\n-             │     │  2 | is\n-             │     │  3 | }}}\n-             │     │    : ^\n-             │     │  4 | invalid\n-             │     │  5 | js\n-             │     │    \\`----\n-             │     │\n-             │\n-             ╰─▶ Syntax Error\n-\n-           Import trace for requested module:\n-           ./components/parse-error.js\n-           ./pages/hmr/about9.js\"\n-          `)\n-        } else {\n-          redboxSource = redboxSource.substring(\n-            0,\n-            redboxSource.indexOf('`----')\n-          )\n-\n-          expect(next.normalizeTestDirContent(redboxSource))\n-            .toMatchInlineSnapshot(`\n-            \"./components/parse-error.js\n-            Error:   x Expression expected\n-               ,-[3:1]\n-             1 | This\n-             2 | is\n-             3 | }}}\n-               : ^\n-             4 | invalid\n-             5 | js\n-               \"\n-          `)\n-        }\n-\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-        await assertNoRedbox(browser)\n-      } catch (err) {\n-        await next.patchFile(aboutPage, aboutContent)\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(\n-            /This is the about page/\n-          )\n-        })\n-      }\n-    })\n-\n-    it('should recover from errors in getInitialProps in client', async () => {\n-      const browser = await next.browser(basePath + '/hmr')\n-      const erroredPage = join('pages', 'hmr', 'error-in-gip.js')\n-      const errorContent = await next.readFile(erroredPage)\n-      try {\n-        await browser.elementByCss('#error-in-gip-link').click()\n-\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n-          `\"an-expected-error-in-gip\"`\n-        )\n-\n-        await next.patchFile(\n-          erroredPage,\n-          errorContent.replace('throw error', 'return {}')\n-        )\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(/Hello/)\n-        })\n-\n-        await next.patchFile(erroredPage, errorContent)\n-\n-        await retry(async () => {\n-          await browser.refresh()\n-          await waitFor(2000)\n-          const text = await getBrowserBodyText(browser)\n-          if (text.includes('Hello')) {\n-            throw new Error('waiting')\n-          }\n-          return expect(await getRedboxSource(browser)).toMatch(\n-            /an-expected-error-in-gip/\n-          )\n-        })\n-      } catch (err) {\n-        await next.patchFile(erroredPage, errorContent)\n-\n-        throw err\n-      }\n-    })\n-\n-    it('should recover after an error reported via SSR', async () => {\n-      const browser = await next.browser(basePath + '/hmr/error-in-gip')\n-      const erroredPage = join('pages', 'hmr', 'error-in-gip.js')\n-      const errorContent = await next.readFile(erroredPage)\n-      try {\n-        await assertHasRedbox(browser)\n-        expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n-          `\"an-expected-error-in-gip\"`\n-        )\n-\n-        const erroredPage = join('pages', 'hmr', 'error-in-gip.js')\n-\n-        await next.patchFile(\n-          erroredPage,\n-          errorContent.replace('throw error', 'return {}')\n-        )\n-\n-        await retry(async () => {\n-          expect(await getBrowserBodyText(browser)).toMatch(/Hello/)\n-        })\n-\n-        await next.patchFile(erroredPage, errorContent)\n-\n-        await retry(async () => {\n-          await browser.refresh()\n-          await waitFor(2000)\n-          const text = await getBrowserBodyText(browser)\n-          if (text.includes('Hello')) {\n-            throw new Error('waiting')\n-          }\n-          return expect(await getRedboxSource(browser)).toMatch(\n-            /an-expected-error-in-gip/\n-          )\n-        })\n-      } catch (err) {\n-        await next.patchFile(erroredPage, errorContent)\n-\n-        throw err\n-      }\n-    })\n-\n-    if (!process.env.IS_TURBOPACK_TEST) {\n-      it('should have client HMR events in trace file', async () => {\n-        const traceData = await next.readFile('.next/trace')\n-        expect(traceData).toContain('client-hmr-latency')\n-        expect(traceData).toContain('client-error')\n-        expect(traceData).toContain('client-success')\n-        expect(traceData).toContain('client-full-reload')\n-      })\n-    }\n-  }\n-)"
        },
        {
            "sha": "5498f9ba7315afacfd2c9a32eb26b44a0913548d",
            "filename": "test/development/basic/hmr/run-error-recovery-hmr-test.util.ts",
            "status": "added",
            "additions": 831,
            "deletions": 0,
            "changes": 831,
            "blob_url": "https://github.com/vercel/next.js/blob/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7ac4eae058ba76adbca53a92424c6796a322676d/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts?ref=7ac4eae058ba76adbca53a92424c6796a322676d",
            "patch": "@@ -0,0 +1,831 @@\n+import { join } from 'path'\n+import {\n+  assertHasRedbox,\n+  assertNoRedbox,\n+  getBrowserBodyText,\n+  getRedboxHeader,\n+  getRedboxDescription,\n+  getRedboxSource,\n+  renderViaHTTP,\n+  retry,\n+  waitFor,\n+  trimEndMultiline,\n+} from 'next-test-utils'\n+import { nextTestSetup } from 'e2e-utils'\n+import { outdent } from 'outdent'\n+\n+export function runErrorRecoveryHmrTest(nextConfig: {\n+  basePath: string\n+  assetPrefix: string\n+}) {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    nextConfig,\n+    patchFileDelay: 500,\n+  })\n+  const { basePath } = nextConfig\n+\n+  it('should recover from 404 after a page has been added', async () => {\n+    const newPage = join('pages', 'hmr', 'new-page.js')\n+\n+    try {\n+      const browser = await next.browser(basePath + '/hmr/new-page')\n+\n+      expect(await browser.elementByCss('body').text()).toMatch(\n+        /This page could not be found/\n+      )\n+\n+      // Add the page\n+      await next.patchFile(\n+        newPage,\n+        'export default () => (<div id=\"new-page\">the-new-page</div>)'\n+      )\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(/the-new-page/)\n+      })\n+\n+      await next.deleteFile(newPage)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This page could not be found/\n+        )\n+      })\n+\n+      expect(next.cliOutput).toContain('Compiled /_error')\n+    } catch (err) {\n+      await next.deleteFile(newPage)\n+      throw err\n+    }\n+  })\n+\n+  it('should recover from 404 after a page has been added with dynamic segments', async () => {\n+    const newPage = join('pages', 'hmr', '[foo]', 'page.js')\n+\n+    try {\n+      const browser = await next.browser(basePath + '/hmr/foo/page')\n+\n+      expect(await browser.elementByCss('body').text()).toMatch(\n+        /This page could not be found/\n+      )\n+\n+      // Add the page\n+      await next.patchFile(\n+        newPage,\n+        'export default () => (<div id=\"new-page\">the-new-page</div>)'\n+      )\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(/the-new-page/)\n+      })\n+\n+      await next.deleteFile(newPage)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This page could not be found/\n+        )\n+      })\n+\n+      expect(next.cliOutput).toContain('Compiled /_error')\n+    } catch (err) {\n+      await next.deleteFile(newPage)\n+      throw err\n+    }\n+  })\n+  ;(process.env.IS_TURBOPACK_TEST ? it.skip : it)(\n+    // this test fails frequently with turbopack\n+    'should not continously poll a custom error page',\n+    async () => {\n+      const errorPage = join('pages', '_error.js')\n+\n+      await next.patchFile(\n+        errorPage,\n+        outdent`\n+          function Error({ statusCode, message, count }) {\n+            return (\n+              <div>\n+                Error Message: {message}\n+              </div>\n+            )\n+          }\n+\n+          Error.getInitialProps = async ({ res, err }) => {\n+            const statusCode = res ? res.statusCode : err ? err.statusCode : 404\n+            console.log('getInitialProps called');\n+            return {\n+              statusCode,\n+              message: err ? err.message : 'Oops...',\n+            }\n+          }\n+\n+          export default Error\n+        `\n+      )\n+\n+      try {\n+        // navigate to a 404 page\n+        await next.browser(basePath + '/does-not-exist')\n+\n+        await retry(() => {\n+          // eslint-disable-next-line jest/no-standalone-expect\n+          expect(next.cliOutput).toMatch(/getInitialProps called/)\n+        })\n+\n+        const outputIndex = next.cliOutput.length\n+\n+        // wait a few seconds to ensure polling didn't happen\n+        await waitFor(3000)\n+\n+        const logOccurrences =\n+          next.cliOutput.slice(outputIndex).split('getInitialProps called')\n+            .length - 1\n+        // eslint-disable-next-line jest/no-standalone-expect\n+        expect(logOccurrences).toBe(0)\n+      } finally {\n+        await next.deleteFile(errorPage)\n+      }\n+    }\n+  )\n+\n+  it('should detect syntax errors and recover', async () => {\n+    const browser = await next.browser(basePath + '/hmr/about2')\n+    const aboutPage = join('pages', 'hmr', 'about2.js')\n+    const aboutContent = await next.readFile(aboutPage)\n+    await retry(async () => {\n+      expect(await getBrowserBodyText(browser)).toMatch(\n+        /This is the about page/\n+      )\n+    })\n+\n+    await next.patchFile(aboutPage, aboutContent.replace('</div>', 'div'))\n+\n+    await assertHasRedbox(browser)\n+    const source = next.normalizeTestDirContent(await getRedboxSource(browser))\n+\n+    if (basePath === '' && process.env.IS_TURBOPACK_TEST) {\n+      expect(source).toMatchInlineSnapshot(`\n+         \"./pages/hmr/about2.js (7:1)\n+         Parsing ecmascript source code failed\n+           5 |     div\n+           6 |   )\n+         > 7 | }\n+             | ^\n+           8 |\n+\n+         Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\"\n+        `)\n+    } else if (basePath === '' && process.env.NEXT_RSPACK) {\n+      expect(trimEndMultiline(source)).toMatchInlineSnapshot(`\n+         \"./pages/hmr/about2.js\n+           × Module build failed:\n+           ├─▶   ×\n+           │     │   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+           │     │    ,-[TEST_DIR/pages/hmr/about2.js:7:1]\n+           │     │  4 |       <p>This is the about page.</p>\n+           │     │  5 |     div\n+           │     │  6 |   )\n+           │     │  7 | }\n+           │     │    : ^\n+           │     │    \\`----\n+           │     │\n+           │     │   x Unexpected eof\n+           │     │    ,-[TEST_DIR/pages/hmr/about2.js:7:3]\n+           │     │  5 |     div\n+           │     │  6 |   )\n+           │     │  7 | }\n+           │     │    \\`----\n+           │     │\n+           │\n+           ╰─▶ Syntax Error\n+\n+         Import trace for requested module:\n+         ./pages/hmr/about2.js\"\n+        `)\n+    } else if (basePath === '') {\n+      expect(source).toMatchInlineSnapshot(`\n+          \"./pages/hmr/about2.js\n+          Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+             ,-[7:1]\n+           4 |       <p>This is the about page.</p>\n+           5 |     div\n+           6 |   )\n+           7 | }\n+             : ^\n+             \\`----\n+            x Unexpected eof\n+             ,-[7:3]\n+           5 |     div\n+           6 |   )\n+           7 | }\n+             \\`----\n+\n+          Caused by:\n+              Syntax Error\n+\n+          Import trace for requested module:\n+          ./pages/hmr/about2.js\"\n+        `)\n+    } else if (basePath === '/docs' && process.env.IS_TURBOPACK_TEST) {\n+      expect(source).toMatchInlineSnapshot(`\n+            \"./pages/hmr/about2.js (7:1)\n+            Parsing ecmascript source code failed\n+              5 |     div\n+              6 |   )\n+            > 7 | }\n+                | ^\n+              8 |\n+\n+            Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\"\n+          `)\n+    } else if (basePath === '/docs' && process.env.NEXT_RSPACK) {\n+      expect(trimEndMultiline(source)).toMatchInlineSnapshot(`\n+         \"./pages/hmr/about2.js\n+           × Module build failed:\n+           ├─▶   ×\n+           │     │   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+           │     │    ,-[TEST_DIR/pages/hmr/about2.js:7:1]\n+           │     │  4 |       <p>This is the about page.</p>\n+           │     │  5 |     div\n+           │     │  6 |   )\n+           │     │  7 | }\n+           │     │    : ^\n+           │     │    \\`----\n+           │     │\n+           │     │   x Unexpected eof\n+           │     │    ,-[TEST_DIR/pages/hmr/about2.js:7:3]\n+           │     │  5 |     div\n+           │     │  6 |   )\n+           │     │  7 | }\n+           │     │    \\`----\n+           │     │\n+           │\n+           ╰─▶ Syntax Error\n+\n+         Import trace for requested module:\n+         ./pages/hmr/about2.js\"\n+        `)\n+    } else if (basePath === '/docs') {\n+      expect(source).toMatchInlineSnapshot(`\n+          \"./pages/hmr/about2.js\n+          Error:   x Unexpected token. Did you mean \\`{'}'}\\` or \\`&rbrace;\\`?\n+             ,-[7:1]\n+           4 |       <p>This is the about page.</p>\n+           5 |     div\n+           6 |   )\n+           7 | }\n+             : ^\n+             \\`----\n+            x Unexpected eof\n+             ,-[7:3]\n+           5 |     div\n+           6 |   )\n+           7 | }\n+             \\`----\n+\n+          Caused by:\n+              Syntax Error\n+\n+          Import trace for requested module:\n+          ./pages/hmr/about2.js\"\n+        `)\n+    }\n+\n+    await next.patchFile(aboutPage, aboutContent)\n+\n+    await retry(async () => {\n+      expect(await getBrowserBodyText(browser)).toMatch(\n+        /This is the about page/\n+      )\n+    })\n+  })\n+\n+  if (!process.env.IS_TURBOPACK_TEST) {\n+    // Turbopack doesn't have this restriction\n+    it('should show the error on all pages', async () => {\n+      const aboutPage = join('pages', 'hmr', 'about2.js')\n+      const aboutContent = await next.readFile(aboutPage)\n+      const browser = await next.browser(basePath + '/hmr/contact')\n+      try {\n+        await renderViaHTTP(next.url, basePath + '/hmr/about2')\n+\n+        await next.patchFile(aboutPage, aboutContent.replace('</div>', 'div'))\n+\n+        // Ensure dev server has time to break:\n+        await new Promise((resolve) => setTimeout(resolve, 2000))\n+\n+        await assertHasRedbox(browser)\n+        expect(await getRedboxSource(browser)).toMatch(/Unexpected eof/)\n+\n+        await next.patchFile(aboutPage, aboutContent)\n+\n+        await retry(async () => {\n+          expect(await getBrowserBodyText(browser)).toMatch(\n+            /This is the contact page/\n+          )\n+        })\n+      } catch (err) {\n+        await next.patchFile(aboutPage, aboutContent)\n+        if (browser) {\n+          await retry(async () => {\n+            expect(await getBrowserBodyText(browser)).toMatch(\n+              /This is the contact page/\n+            )\n+          })\n+        }\n+\n+        throw err\n+      }\n+    })\n+  }\n+\n+  it('should detect runtime errors on the module scope', async () => {\n+    const browser = await next.browser(basePath + '/hmr/about3')\n+    const aboutPage = join('pages', 'hmr', 'about3.js')\n+    const aboutContent = await next.readFile(aboutPage)\n+    try {\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      await next.patchFile(\n+        aboutPage,\n+        aboutContent.replace('export', 'aa=20;\\nexport')\n+      )\n+\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxHeader(browser)).toMatch(/aa is not defined/)\n+\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+    } finally {\n+      await next.patchFile(aboutPage, aboutContent)\n+    }\n+  })\n+\n+  it('should recover from errors in the render function', async () => {\n+    const browser = await next.browser(basePath + '/hmr/about4')\n+    const aboutPage = join('pages', 'hmr', 'about4.js')\n+    const aboutContent = await next.readFile(aboutPage)\n+    try {\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      await next.patchFile(\n+        aboutPage,\n+        aboutContent.replace(\n+          'return',\n+          'throw new Error(\"an-expected-error\");\\nreturn'\n+        )\n+      )\n+\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxSource(browser)).toMatch(/an-expected-error/)\n+\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+    } catch (err) {\n+      await next.patchFile(aboutPage, aboutContent)\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      throw err\n+    }\n+  })\n+\n+  it('should recover after exporting an invalid page', async () => {\n+    const browser = await next.browser(basePath + '/hmr/about5')\n+    const aboutPage = join('pages', 'hmr', 'about5.js')\n+    const aboutContent = await next.readFile(aboutPage)\n+    try {\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      await next.patchFile(\n+        aboutPage,\n+        aboutContent.replace(\n+          'export default',\n+          'export default {};\\nexport const fn ='\n+        )\n+      )\n+\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n+        `\"The default export is not a React Component in page: \"/hmr/about5\"\"`\n+      )\n+\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+    } catch (err) {\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      throw err\n+    }\n+  })\n+\n+  it('should recover after a bad return from the render function', async () => {\n+    const browser = await next.browser(basePath + '/hmr/about6')\n+    const aboutPage = join('pages', 'hmr', 'about6.js')\n+    const aboutContent = await next.readFile(aboutPage)\n+    try {\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      await next.patchFile(\n+        aboutPage,\n+        aboutContent.replace(\n+          'export default',\n+          'export default () => /search/;\\nexport const fn ='\n+        )\n+      )\n+\n+      await assertHasRedbox(browser)\n+      // TODO: Replace this when webpack 5 is the default\n+      expect(await getRedboxHeader(browser)).toMatch(\n+        `Objects are not valid as a React child (found: [object RegExp]). If you meant to render a collection of children, use an array instead.`\n+      )\n+\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+    } catch (err) {\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      throw err\n+    }\n+  })\n+\n+  it('should recover after undefined exported as default', async () => {\n+    const browser = await next.browser(basePath + '/hmr/about7')\n+    const aboutPage = join('pages', 'hmr', 'about7.js')\n+\n+    const aboutContent = await next.readFile(aboutPage)\n+    try {\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      await next.patchFile(\n+        aboutPage,\n+        aboutContent.replace(\n+          'export default',\n+          'export default undefined;\\nexport const fn ='\n+        )\n+      )\n+\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n+        `\"The default export is not a React Component in page: \"/hmr/about7\"\"`\n+      )\n+\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+      await assertNoRedbox(browser)\n+    } catch (err) {\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      throw err\n+    }\n+  })\n+\n+  it('should recover after webpack parse error in an imported file', async () => {\n+    const browser = await next.browser(basePath + '/hmr/about8')\n+    const aboutPage = join('pages', 'hmr', 'about8.js')\n+\n+    const aboutContent = await next.readFile(aboutPage)\n+    try {\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      await next.patchFile(\n+        aboutPage,\n+        aboutContent.replace(\n+          'export default',\n+          'import \"../../components/parse-error.xyz\"\\nexport default'\n+        )\n+      )\n+\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxHeader(browser)).toMatch('Build Error')\n+\n+      if (process.env.IS_TURBOPACK_TEST) {\n+        expect(await getRedboxSource(browser)).toMatchInlineSnapshot(`\n+              \"./components/parse-error.xyz\n+              Unknown module type\n+              This module doesn't have an associated type. Use a known file extension, or register a loader for it.\n+\n+              Read more: https://nextjs.org/docs/app/api-reference/next-config-js/turbo#webpack-loaders\"\n+            `)\n+      } else if (process.env.NEXT_RSPACK) {\n+        expect(trimEndMultiline(await getRedboxSource(browser)))\n+          .toMatchInlineSnapshot(`\n+           \"./components/parse-error.xyz\n+             × Module parse failed:\n+             ╰─▶   × JavaScript parsing error: Expression expected\n+                    ╭─[3:0]\n+                  1 │ This\n+                  2 │ is\n+                  3 │ }}}\n+                    · ─\n+                  4 │ invalid\n+                  5 │ js\n+                    ╰────\n+\n+             help:\n+                   You may need an appropriate loader to handle this file type.\n+\n+           Import trace for requested module:\n+           ./components/parse-error.xyz\n+           ./pages/hmr/about8.js\"\n+          `)\n+      } else {\n+        expect(await getRedboxSource(browser)).toMatchInlineSnapshot(`\n+                      \"./components/parse-error.xyz\n+                      Module parse failed: Unexpected token (3:0)\n+                      You may need an appropriate loader to handle this file type, currently no loaders are configured to process this file. See https://webpack.js.org/concepts#loaders\n+                      | This\n+                      | is\n+                      > }}}\n+                      | invalid\n+                      | js\n+\n+                      Import trace for requested module:\n+                      ./components/parse-error.xyz\n+                      ./pages/hmr/about8.js\"\n+                  `)\n+      }\n+\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+      await assertNoRedbox(browser)\n+    } catch (err) {\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      throw err\n+    }\n+  })\n+\n+  it('should recover after loader parse error in an imported file', async () => {\n+    const browser = await next.browser(basePath + '/hmr/about9')\n+    const aboutPage = join('pages', 'hmr', 'about9.js')\n+\n+    const aboutContent = await next.readFile(aboutPage)\n+    try {\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+\n+      await next.patchFile(\n+        aboutPage,\n+        aboutContent.replace(\n+          'export default',\n+          'import \"../../components/parse-error.js\"\\nexport default'\n+        )\n+      )\n+\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxHeader(browser)).toMatch('Build Error')\n+      let redboxSource = await getRedboxSource(browser)\n+\n+      redboxSource = redboxSource.replace(`${next.testDir}`, '.')\n+      if (process.env.IS_TURBOPACK_TEST) {\n+        expect(next.normalizeTestDirContent(redboxSource))\n+          .toMatchInlineSnapshot(`\n+           \"./components/parse-error.js (3:1)\n+           Parsing ecmascript source code failed\n+             1 | This\n+             2 | is\n+           > 3 | }}}\n+               | ^\n+             4 | invalid\n+             5 | js\n+\n+           Expression expected\"\n+          `)\n+      } else if (process.env.NEXT_RSPACK) {\n+        expect(trimEndMultiline(next.normalizeTestDirContent(redboxSource)))\n+          .toMatchInlineSnapshot(`\n+           \"./components/parse-error.js\n+             × Module build failed:\n+             ├─▶   ×\n+             │     │   x Expression expected\n+             │     │    ,-[./components/parse-error.js:3:1]\n+             │     │  1 | This\n+             │     │  2 | is\n+             │     │  3 | }}}\n+             │     │    : ^\n+             │     │  4 | invalid\n+             │     │  5 | js\n+             │     │    \\`----\n+             │     │\n+             │\n+             ╰─▶ Syntax Error\n+\n+           Import trace for requested module:\n+           ./components/parse-error.js\n+           ./pages/hmr/about9.js\"\n+          `)\n+      } else {\n+        redboxSource = redboxSource.substring(0, redboxSource.indexOf('`----'))\n+\n+        expect(next.normalizeTestDirContent(redboxSource))\n+          .toMatchInlineSnapshot(`\n+            \"./components/parse-error.js\n+            Error:   x Expression expected\n+               ,-[3:1]\n+             1 | This\n+             2 | is\n+             3 | }}}\n+               : ^\n+             4 | invalid\n+             5 | js\n+               \"\n+          `)\n+      }\n+\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+      await assertNoRedbox(browser)\n+    } catch (err) {\n+      await next.patchFile(aboutPage, aboutContent)\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(\n+          /This is the about page/\n+        )\n+      })\n+    }\n+  })\n+\n+  it('should recover from errors in getInitialProps in client', async () => {\n+    const browser = await next.browser(basePath + '/hmr')\n+    const erroredPage = join('pages', 'hmr', 'error-in-gip.js')\n+    const errorContent = await next.readFile(erroredPage)\n+    try {\n+      await browser.elementByCss('#error-in-gip-link').click()\n+\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n+        `\"an-expected-error-in-gip\"`\n+      )\n+\n+      await next.patchFile(\n+        erroredPage,\n+        errorContent.replace('throw error', 'return {}')\n+      )\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(/Hello/)\n+      })\n+\n+      await next.patchFile(erroredPage, errorContent)\n+\n+      await retry(async () => {\n+        await browser.refresh()\n+        await waitFor(2000)\n+        const text = await getBrowserBodyText(browser)\n+        if (text.includes('Hello')) {\n+          throw new Error('waiting')\n+        }\n+        return expect(await getRedboxSource(browser)).toMatch(\n+          /an-expected-error-in-gip/\n+        )\n+      })\n+    } catch (err) {\n+      await next.patchFile(erroredPage, errorContent)\n+\n+      throw err\n+    }\n+  })\n+\n+  it('should recover after an error reported via SSR', async () => {\n+    const browser = await next.browser(basePath + '/hmr/error-in-gip')\n+    const erroredPage = join('pages', 'hmr', 'error-in-gip.js')\n+    const errorContent = await next.readFile(erroredPage)\n+    try {\n+      await assertHasRedbox(browser)\n+      expect(await getRedboxDescription(browser)).toMatchInlineSnapshot(\n+        `\"an-expected-error-in-gip\"`\n+      )\n+\n+      const erroredPage = join('pages', 'hmr', 'error-in-gip.js')\n+\n+      await next.patchFile(\n+        erroredPage,\n+        errorContent.replace('throw error', 'return {}')\n+      )\n+\n+      await retry(async () => {\n+        expect(await getBrowserBodyText(browser)).toMatch(/Hello/)\n+      })\n+\n+      await next.patchFile(erroredPage, errorContent)\n+\n+      await retry(async () => {\n+        await browser.refresh()\n+        await waitFor(2000)\n+        const text = await getBrowserBodyText(browser)\n+        if (text.includes('Hello')) {\n+          throw new Error('waiting')\n+        }\n+        return expect(await getRedboxSource(browser)).toMatch(\n+          /an-expected-error-in-gip/\n+        )\n+      })\n+    } catch (err) {\n+      await next.patchFile(erroredPage, errorContent)\n+\n+      throw err\n+    }\n+  })\n+\n+  if (!process.env.IS_TURBOPACK_TEST) {\n+    it('should have client HMR events in trace file', async () => {\n+      const traceData = await next.readFile('.next/trace')\n+      expect(traceData).toContain('client-hmr-latency')\n+      expect(traceData).toContain('client-error')\n+      expect(traceData).toContain('client-success')\n+      expect(traceData).toContain('client-full-reload')\n+    })\n+  }\n+}"
        }
    ],
    "stats": {
        "total": 1701,
        "additions": 859,
        "deletions": 842
    }
}