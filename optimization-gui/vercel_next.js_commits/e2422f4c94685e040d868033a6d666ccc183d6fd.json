{
    "author": "lukesandberg",
    "message": "[turbopack] Add FileSystemPath.has_extension and optimize module graph operations (#81205)\n\n## Optimize file extension checks and module graph traversal\n\n### What?\nThis PR introduces several optimizations:\n\n1. Added a new `has_extension()` method to `FileSystemPath` for more efficient extension checking\n2. Improved module graph traversal with a dedicated `has_entry_module()` method\n3. Reordered code in `AppProject` to avoid unnecessary clones\n4. Simplified CSS resource handling in client reference manifest generation\n\n### Why?\nThese changes improve performance by:\n- Replacing string comparisons with more efficient suffix matching for file extensions\n- Providing a direct way to check if a module is an entry point without iterating all entries\n- Avoiding unnecessary clones operations when possible",
    "sha": "e2422f4c94685e040d868033a6d666ccc183d6fd",
    "files": [
        {
            "sha": "781a406a9229a71277740a83b4e46c4c6cdf0698",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 8,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -861,14 +861,13 @@ impl AppProject {\n         client_shared_entries: Vc<EvaluatableAssets>,\n         has_layout_segments: bool,\n     ) -> Result<Vc<ModuleGraphs>> {\n-        let client_shared_entries = client_shared_entries\n-            .await?\n-            .into_iter()\n-            .map(|m| ResolvedVc::upcast(*m))\n-            .collect();\n-\n-        let should_trace = self.project.next_mode().await?.is_production();\n         if *self.project.per_page_module_graph().await? {\n+            let should_trace = self.project.next_mode().await?.is_production();\n+            let client_shared_entries = client_shared_entries\n+                .await?\n+                .into_iter()\n+                .map(|m| ResolvedVc::upcast(*m))\n+                .collect();\n             // Implements layout segment optimization to compute a graph \"chain\" for each layout\n             // segment\n             async move {\n@@ -1255,7 +1254,7 @@ impl AppEndpoint {\n             client_assets.insert(chunk);\n \n             let chunk_path = chunk.path().await?;\n-            if chunk_path.extension_ref() == Some(\"js\") {\n+            if chunk_path.has_extension(\".js\") {\n                 client_shared_chunks.push(chunk);\n             }\n         }"
        },
        {
            "sha": "21314f879921ffea27ddb216429196d5cc135798",
            "filename": "crates/next-api/src/module_graph.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -82,7 +82,7 @@ impl NextDynamicGraph {\n             }\n \n             let entries = if !self.is_single_page {\n-                if !graph.entry_modules().any(|m| m == entry) {\n+                if !graph.has_entry_module(entry) {\n                     // the graph doesn't contain the entry, e.g. for the additional module graph\n                     return Ok(Vc::cell(vec![]));\n                 }\n@@ -185,7 +185,7 @@ impl ServerActionsGraph {\n                 // The graph contains the whole app, traverse and collect all reachable imports.\n                 let graph = &*self.graph.await?;\n \n-                if !graph.entry_modules().any(|m| m == entry) {\n+                if !graph.has_entry_module(entry) {\n                     // the graph doesn't contain the entry, e.g. for the additional module graph\n                     return Ok(Vc::cell(Default::default()));\n                 }\n@@ -266,7 +266,7 @@ impl ClientReferencesGraph {\n     }\n \n     #[turbo_tasks::function]\n-    pub async fn get_client_references_for_endpoint(\n+    async fn get_client_references_for_endpoint(\n         &self,\n         entry: ResolvedVc<Box<dyn Module>>,\n     ) -> Result<Vc<ClientReferenceGraphResult>> {\n@@ -276,7 +276,7 @@ impl ClientReferencesGraph {\n             let graph = &*self.graph.await?;\n \n             let entries = if !self.is_single_page {\n-                if !graph.entry_modules().any(|m| m == entry) {\n+                if !graph.has_entry_module(entry) {\n                     // the graph doesn't contain the entry, e.g. for the additional module graph\n                     return Ok(ClientReferenceGraphResult::default().cell());\n                 }\n@@ -467,9 +467,7 @@ async fn validate_pages_css_imports(\n     let module_name_map = module_name_map.await?;\n \n     let entries = if !is_single_page {\n-        // TODO: Optimize this code by checking if the node is an entry using `get_module` and then\n-        // checking if the node is an entry in the graph by looking for the reverse edges.\n-        if !graph.entry_modules().any(|m| m == entry) {\n+        if !graph.has_entry_module(entry) {\n             // the graph doesn't contain the entry, e.g. for the additional module graph\n             return Ok(());\n         }"
        },
        {
            "sha": "9d2913b33b014ccc63f1648aa8a553401f4c00f1",
            "filename": "crates/next-api/src/nft_json.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnft_json.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -218,7 +218,7 @@ impl Asset for NftJsonAsset {\n             }\n \n             let referenced_chunk_path = referenced_chunk.path().await?;\n-            if referenced_chunk_path.extension_ref() == Some(\"map\") {\n+            if referenced_chunk_path.has_extension(\".map\") {\n                 continue;\n             }\n "
        },
        {
            "sha": "0c51ad501f11b1729a4d0b1ab8eea216314ad890",
            "filename": "crates/next-core/src/app_page_loader_tree.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -268,11 +268,10 @@ impl AppPageLoaderTreeBuilder {\n             writeln!(self.loader_tree_code, \"{s}  width: {identifier}.width,\")?;\n             writeln!(self.loader_tree_code, \"{s}  height: {identifier}.height,\")?;\n         } else {\n-            let ext = path.extension();\n             // For SVGs, skip sizes and use \"any\" to let it scale automatically based on viewport,\n             // For the images doesn't provide the size properly, use \"any\" as well.\n             // If the size is presented, use the actual size for the image.\n-            let sizes = if ext == \"svg\" {\n+            let sizes = if path.has_extension(\".svg\") {\n                 \"any\".to_string()\n             } else {\n                 format!(\"${{{identifier}.width}}x${{{identifier}.height}}\")"
        },
        {
            "sha": "11b9e47b82083a79d5387424e0b5cb37ff370d3c",
            "filename": "crates/next-core/src/next_app/app_client_references_chunks.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_references_chunks.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_references_chunks.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_references_chunks.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -32,7 +32,7 @@ pub struct ClientReferencesChunks {\n \n /// Computes all client references chunks.\n ///\n-/// This returns a map from client reference type to the chunks that reference\n+/// This returns a map from client reference type to the chunks that the reference\n /// type needs to load.\n #[turbo_tasks::function]\n pub async fn get_app_client_references_chunks("
        },
        {
            "sha": "c8c251862ccecf95022ea8674b12dc40ebaec953",
            "filename": "crates/next-core/src/next_client_reference/visit_client_reference.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 15,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -218,26 +218,22 @@ impl Visit<FindServerEntriesNode> for FindServerEntries {\n     }\n \n     fn edges(&mut self, node: &FindServerEntriesNode) -> Self::EdgesFuture {\n-        let node = node.clone();\n         let include_traced = self.include_traced;\n+        let parent_module = match node {\n+            // This should never occur since we always skip visiting these\n+            // nodes' edges.\n+            FindServerEntriesNode::ClientReference => {\n+                unreachable!(\"ClientReference node should not be visited\")\n+            }\n+            FindServerEntriesNode::Internal(module, _) => **module,\n+            FindServerEntriesNode::ServerUtilEntry(module, _) => Vc::upcast(**module),\n+            FindServerEntriesNode::ServerComponentEntry(module, _) => Vc::upcast(**module),\n+        };\n         async move {\n-            let parent_module = match node {\n-                // This should never occur since we always skip visiting these\n-                // nodes' edges.\n-                FindServerEntriesNode::ClientReference => {\n-                    unreachable!(\"ClientReference node should not be visited\")\n-                }\n-                FindServerEntriesNode::Internal(module, _) => module,\n-                FindServerEntriesNode::ServerUtilEntry(module, _) => ResolvedVc::upcast(module),\n-                FindServerEntriesNode::ServerComponentEntry(module, _) => {\n-                    ResolvedVc::upcast(module)\n-                }\n-            };\n-\n             // Pass include_traced to reuse the same cached `primary_chunkable_referenced_modules`\n             // task result, but the traced references will be filtered out again afterwards.\n             let referenced_modules =\n-                primary_chunkable_referenced_modules(*parent_module, include_traced).await?;\n+                primary_chunkable_referenced_modules(parent_module, include_traced).await?;\n \n             let referenced_modules = referenced_modules\n                 .iter()"
        },
        {
            "sha": "b9ec7671fa4e36d39f67307aea7aac77c0aa1071",
            "filename": "crates/next-core/src/next_manifests/client_reference_manifest.rs",
            "status": "modified",
            "additions": 27,
            "deletions": 35,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -331,60 +331,52 @@ impl ClientReferenceManifest {\n                     .value_to_string()\n                     .owned()\n                     .await?;\n-                let mut entry_css_files_with_chunk = Vec::new();\n                 let entry_js_files = entry_manifest\n                     .entry_js_files\n                     .entry(server_component_name.clone())\n                     .or_default();\n+                let entry_css_files = entry_manifest\n+                    .entry_css_files\n+                    .entry(server_component_name)\n+                    .or_default();\n \n                 let client_chunks = &client_chunks.await?;\n                 let client_chunks_with_path =\n                     cached_chunk_paths(&mut client_chunk_path_cache, client_chunks.iter().copied())\n                         .await?;\n+                // Inlining breaks HMR so it is always disabled in dev.\n+                let inlined_css = next_config.await?.experimental.inline_css.unwrap_or(false)\n+                    && mode.is_production();\n \n                 for (chunk, chunk_path) in client_chunks_with_path {\n                     if let Some(path) = client_relative_path.get_path_to(&chunk_path) {\n                         // The entry CSS files and entry JS files don't have prefix and suffix\n-                        // applied because it is added by Nex.js during rendering.\n+                        // applied because it is added by Next.js during rendering.\n                         let path = path.into();\n-                        if chunk_path.extension_ref() == Some(\"css\") {\n-                            entry_css_files_with_chunk.push((path, chunk));\n+                        if chunk_path.has_extension(\".css\") {\n+                            let content = if inlined_css {\n+                                Some(\n+                                    if let Some(content_file) =\n+                                        chunk.content().file_content().await?.as_content()\n+                                    {\n+                                        content_file.content().to_str()?.into()\n+                                    } else {\n+                                        RcStr::default()\n+                                    },\n+                                )\n+                            } else {\n+                                None\n+                            };\n+                            entry_css_files.insert(CssResource {\n+                                path,\n+                                inlined: inlined_css,\n+                                content,\n+                            });\n                         } else {\n                             entry_js_files.insert(path);\n                         }\n                     }\n                 }\n-\n-                let inlined = next_config.await?.experimental.inline_css.unwrap_or(false)\n-                    && mode.is_production();\n-                let entry_css_files_vec = entry_css_files_with_chunk\n-                    .into_iter()\n-                    .map(async |(path, chunk)| {\n-                        let content = if inlined {\n-                            if let Some(content_file) =\n-                                chunk.content().file_content().await?.as_content()\n-                            {\n-                                Some(content_file.content().to_str()?.into())\n-                            } else {\n-                                Some(\"\".into())\n-                            }\n-                        } else {\n-                            None\n-                        };\n-                        Ok(CssResource {\n-                            path,\n-                            inlined,\n-                            content,\n-                        })\n-                    })\n-                    .try_join()\n-                    .await?;\n-\n-                let entry_css_files = entry_manifest\n-                    .entry_css_files\n-                    .entry(server_component_name)\n-                    .or_default();\n-                entry_css_files.extend(entry_css_files_vec);\n             }\n \n             let client_reference_manifest_json = serde_json::to_string(&entry_manifest).unwrap();"
        },
        {
            "sha": "eeb116e7718ff086ecf4a7657470863b370028e7",
            "filename": "crates/next-core/src/next_server/resolve.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 28,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -169,35 +169,32 @@ impl AfterResolvePlugin for ExternalCjsModulesResolvePlugin {\n         ) -> Result<FileType> {\n             // node.js only supports these file extensions\n             // mjs is an esm module and we can't bundle that yet\n-            let ext = raw_fs_path.extension_ref();\n-            if matches!(ext, Some(\"cjs\" | \"node\" | \"json\")) {\n-                return Ok(FileType::CommonJs);\n-            }\n-            if matches!(ext, Some(\"mjs\")) {\n-                return Ok(FileType::EcmaScriptModule);\n-            }\n-            if matches!(ext, Some(\"js\")) {\n-                // for .js extension in cjs context, we need to check the actual module type via\n-                // package.json\n-                let FindContextFileResult::Found(package_json, _) =\n-                    &*find_context_file(fs_path.parent(), package_json()).await?\n-                else {\n-                    // can't find package.json\n-                    return Ok(FileType::CommonJs);\n-                };\n-                let FileJsonContent::Content(package) = &*package_json.read_json().await? else {\n-                    // can't parse package.json\n-                    return Ok(FileType::InvalidPackageJson);\n-                };\n-\n-                if let Some(\"module\") = package[\"type\"].as_str() {\n-                    return Ok(FileType::EcmaScriptModule);\n+            Ok(match raw_fs_path.extension_ref() {\n+                Some(\"cjs\" | \"node\" | \"json\") => FileType::CommonJs,\n+                Some(\"mjs\") => FileType::EcmaScriptModule,\n+                Some(\"js\") => {\n+                    // for .js extension in cjs context, we need to check the actual module type via\n+                    // package.json\n+                    let FindContextFileResult::Found(package_json, _) =\n+                        &*find_context_file(fs_path.parent(), package_json()).await?\n+                    else {\n+                        // can't find package.json\n+                        return Ok(FileType::CommonJs);\n+                    };\n+                    let FileJsonContent::Content(package) = &*package_json.read_json().await?\n+                    else {\n+                        // can't parse package.json\n+                        return Ok(FileType::InvalidPackageJson);\n+                    };\n+\n+                    if let Some(\"module\") = package[\"type\"].as_str() {\n+                        FileType::EcmaScriptModule\n+                    } else {\n+                        FileType::CommonJs\n+                    }\n                 }\n-\n-                return Ok(FileType::CommonJs);\n-            }\n-\n-            Ok(FileType::UnsupportedExtension)\n+                _ => FileType::UnsupportedExtension,\n+            })\n         }\n \n         let unable_to_externalize = |reason: Vec<StyledString>| {"
        },
        {
            "sha": "82c83c9f0008d1c1c7311d68a66688a7646da136",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -1110,6 +1110,16 @@ impl FileSystemPath {\n         file_name\n     }\n \n+    /// Returns true if this path has the given extension\n+    ///\n+    /// slightly faster than `self.extension_ref() == Some(extension)` as we can simply match a\n+    /// suffix\n+    pub fn has_extension(&self, extension: &str) -> bool {\n+        debug_assert!(!extension.contains('/') && extension.starts_with('.'));\n+        self.path.ends_with(extension)\n+    }\n+\n+    /// Returns the extension (without a leading `.`)\n     pub fn extension_ref(&self) -> Option<&str> {\n         let (_, extension) = self.split_extension();\n         extension"
        },
        {
            "sha": "713a27175221d944563e974dfb7846fcf3382e6c",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/e2422f4c94685e040d868033a6d666ccc183d6fd/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e2422f4c94685e040d868033a6d666ccc183d6fd/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=e2422f4c94685e040d868033a6d666ccc183d6fd",
            "patch": "@@ -399,7 +399,19 @@ impl SingleModuleGraph {\n         })\n     }\n \n-    /// Iterate over all nodes in the graph\n+    /// Returns true if the given module is in this graph and is an entry module\n+    pub fn has_entry_module(&self, module: ResolvedVc<Box<dyn Module>>) -> bool {\n+        if let Some(index) = self.modules.get(&module) {\n+            self.graph\n+                .edges_directed(*index, petgraph::Direction::Incoming)\n+                .next()\n+                .is_none()\n+        } else {\n+            false\n+        }\n+    }\n+\n+    /// Iterate over graph entry points\n     pub fn entry_modules(&self) -> impl Iterator<Item = ResolvedVc<Box<dyn Module>>> + '_ {\n         self.entries.iter().flat_map(|e| e.entries())\n     }"
        }
    ],
    "stats": {
        "total": 199,
        "additions": 101,
        "deletions": 98
    }
}