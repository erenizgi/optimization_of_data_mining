{
    "author": "styfle",
    "message": "feat(next/image): introduce `preload` prop and deprecated `priority` prop (#83351)\n\nThe Image component's existing `priority` prop is confusing since its\nnot obvious what it does.\n\nIn order to improve clarity, we are introducing a `preload` prop and\ndeprecating the `priority` prop.\n\nWe also updated the dev warning to no longer suggest using this prop for\nthe LCP and instead use `loading=\"eager\"`.",
    "sha": "07e9324016d9914bbcb314c7de65033a7221e07d",
    "files": [
        {
            "sha": "22c636cfbf9140677f150c554d78dd3bc7fd5343",
            "filename": "docs/01-app/03-api-reference/02-components/image.mdx",
            "status": "modified",
            "additions": 21,
            "deletions": 13,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -45,7 +45,7 @@ The following props are available:\n | [`loader`](#loader)                       | `loader={imageLoader}`                   | Function        | -          |\n | [`sizes`](#sizes)                         | `sizes=\"(max-width: 768px) 100vw, 33vw\"` | String          | -          |\n | [`quality`](#quality)                     | `quality={80}`                           | Integer (1-100) | -          |\n-| [`priority`](#priority)                   | `priority={true}`                        | Boolean         | -          |\n+| [`preload`](#preload)                     | `preload={true}`                         | Boolean         | -          |\n | [`placeholder`](#placeholder)             | `placeholder=\"blur\"`                     | String          | -          |\n | [`style`](#style)                         | `style={{objectFit: \"contain\"}}`         | Object          | -          |\n | [`onLoadingComplete`](#onloadingcomplete) | `onLoadingComplete={img => done())}`     | Function        | Deprecated |\n@@ -259,27 +259,35 @@ export default function ProfileImage() {\n \n > **Good to know**: If you’re using the `style` prop to set a custom width, be sure to also set `height: 'auto'` to preserve the image’s aspect ratio.\n \n-#### `priority`\n+#### `preload`\n \n A boolean that indicates if the image should be preloaded.\n \n ```jsx\n-// Default priority is false\n-<Image priority={false} />\n+// Default preload is false\n+<Image preload={false} />\n ```\n \n-- `true`: [Preloads](https://web.dev/preload-responsive-images/) the image. Disables lazy loading.\n-- `false`: Lazy loads the image.\n+- `true`: [Preloads](https://web.dev/preload-responsive-images/) the image by inserting a `<link>` in the `<head>`.\n+- `false`: Does not preload the image.\n \n **When to use it:**\n \n-- The image is above the fold.\n - The image is the [Largest Contentful Paint (LCP)](https://nextjs.org/learn/seo/web-performance/lcp) element.\n-- You want to improve the initial loading performance of your page.\n+- The image is above the fold, typically the hero image.\n+- You want to begin loading the image in the `<head>`, before its discovered later in the `<body>`.\n \n **When not to use it:**\n \n-- When the `loading` prop is used (will trigger warnings).\n+- When you have multiple images that could be considered the [Largest Contentful Paint (LCP)](https://nextjs.org/learn/seo/web-performance/lcp) element depending on the viewport.\n+- When the `loading` property is used.\n+- When the `fetchPriority` property is used.\n+\n+In most cases, you should use `loading=\"eager\"` or `fetchPriority=\"high\"` instead of `preload`.\n+\n+#### `priority`\n+\n+Starting with Next.js 16, the `priority` property has been deprecated in favor of the [`preload`](#preload) property in order to make the behavior clear.\n \n #### `loading`\n \n@@ -908,7 +916,7 @@ This `next/image` component uses browser native [lazy loading](https://caniuse.c\n \n - [Safari 15 - 16.3](https://bugs.webkit.org/show_bug.cgi?id=243601) display a gray border while loading. Safari 16.4 [fixed this issue](https://webkit.org/blog/13966/webkit-features-in-safari-16-4/#:~:text=Now%20in%20Safari%2016.4%2C%20a%20gray%20line%20no%20longer%20appears%20to%20mark%20the%20space%20where%20a%20lazy%2Dloaded%20image%20will%20appear%20once%20it%E2%80%99s%20been%20loaded.). Possible solutions:\n   - Use CSS `@supports (font: -apple-system-body) and (-webkit-appearance: none) { img[loading=\"lazy\"] { clip-path: inset(0.6px) } }`\n-  - Use [`priority`](#priority) if the image is above the fold\n+  - Use [`loading=\"eager\"`](#loading) if the image is above the fold\n - [Firefox 67+](https://bugzilla.mozilla.org/show_bug.cgi?id=1556156) displays a white background while loading. Possible solutions:\n   - Enable [AVIF `formats`](#formats)\n   - Use [`placeholder`](#placeholder)\n@@ -1155,7 +1163,7 @@ If you want to display a different image for light and dark mode, you can create\n import styles from './theme-image.module.css'\n import Image, { ImageProps } from 'next/image'\n \n-type Props = Omit<ImageProps, 'src' | 'priority' | 'loading'> & {\n+type Props = Omit<ImageProps, 'src' | 'preload' | 'loading'> & {\n   srcLight: string\n   srcDark: string\n }\n@@ -1188,7 +1196,7 @@ const ThemeImage = (props) => {\n }\n ```\n \n-> **Good to know**: The default behavior of `loading=\"lazy\"` ensures that only the correct image is loaded. You cannot use `priority` or `loading=\"eager\"` because that would cause both images to load. Instead, you can use [`fetchPriority=\"high\"`](https://developer.mozilla.org/docs/Web/API/HTMLImageElement/fetchPriority).\n+> **Good to know**: The default behavior of `loading=\"lazy\"` ensures that only the correct image is loaded. You cannot use `preload` or `loading=\"eager\"` because that would cause both images to load. Instead, you can use [`fetchPriority=\"high\"`](https://developer.mozilla.org/docs/Web/API/HTMLImageElement/fetchPriority).\n \n Try it out:\n \n@@ -1269,7 +1277,7 @@ export default function Home() {\n \n | Version    | Changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\n | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |\n-| `v16.0.0`  | `qualities` default configuration changed to `[75]`.                                                                                                                                                                                                                                                                                                                                                                                                                                       |\n+| `v16.0.0`  | `qualities` default configuration changed to `[75]`, `preload` prop added, `priority` prop deprecated.                                                                                                                                                                                                                                                                                                                                                                                     |\n | `v15.3.0`  | `remotePatterns` added support for array of `URL` objects.                                                                                                                                                                                                                                                                                                                                                                                                                                 |\n | `v15.0.0`  | `contentDispositionType` configuration default changed to `attachment`.                                                                                                                                                                                                                                                                                                                                                                                                                    |\n | `v14.2.23` | `qualities` configuration added.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |"
        },
        {
            "sha": "cc0dbb0a7d5721ae70ca7400797d096869d712b5",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -799,5 +799,7 @@\n   \"798\": \"expected a result to be returned\",\n   \"799\": \"expected a page response, got %s\",\n   \"800\": \"`experimental.rdcForNavigations` is enabled, but `experimental.ppr` is not.\",\n-  \"801\": \"> `pages` and `app` directories should be under the same folder\"\n+  \"801\": \"> `pages` and `app` directories should be under the same folder\",\n+  \"802\": \"Image with src \\\"%s\\\" has both \\\"preload\\\" and \\\"priority\\\" properties. Only \\\"preload\\\" should be used.\",\n+  \"803\": \"Image with src \\\"%s\\\" has both \\\"preload\\\" and \\\"loading='lazy'\\\" properties. Only one should be used.\"\n }"
        },
        {
            "sha": "37563b970af75b3ebc82f5d282b1d02a1ff95afc",
            "filename": "packages/next/src/client/image-component.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/packages%2Fnext%2Fsrc%2Fclient%2Fimage-component.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/packages%2Fnext%2Fsrc%2Fclient%2Fimage-component.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fimage-component.tsx?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -409,7 +409,7 @@ export const Image = forwardRef<HTMLImageElement | null, ImageProps>(\n             ref={forwardedRef}\n           />\n         }\n-        {imgMeta.priority ? (\n+        {imgMeta.preload ? (\n           <ImagePreload\n             isAppRouter={isAppRouter}\n             imgAttributes={imgAttributes}"
        },
        {
            "sha": "5fd6cf5825bedbe12d224e7eddf4e097afb1158a",
            "filename": "packages/next/src/shared/lib/get-img-props.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 9,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fget-img-props.ts?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -35,6 +35,11 @@ export type ImageProps = Omit<\n   fill?: boolean\n   loader?: ImageLoader\n   quality?: number | `${number}`\n+  preload?: boolean\n+  /**\n+   * @deprecated Use `preload` prop instead.\n+   * See https://nextjs.org/docs/app/api-reference/components/image#preload\n+   */\n   priority?: boolean\n   loading?: LoadingValue\n   placeholder?: PlaceholderValue\n@@ -139,7 +144,7 @@ function isStaticImport(src: string | StaticImport): src is StaticImport {\n \n const allImgs = new Map<\n   string,\n-  { src: string; priority: boolean; placeholder: PlaceholderValue }\n+  { src: string; loading: LoadingValue; placeholder: PlaceholderValue }\n >()\n let perfObserver: PerformanceObserver | undefined\n \n@@ -261,6 +266,7 @@ export function getImgProps(\n     sizes,\n     unoptimized = false,\n     priority = false,\n+    preload = false,\n     loading,\n     className,\n     quality,\n@@ -292,7 +298,7 @@ export function getImgProps(\n   props: ImgProps\n   meta: {\n     unoptimized: boolean\n-    priority: boolean\n+    preload: boolean\n     placeholder: NonNullable<ImageProps['placeholder']>\n     fill: boolean\n   }\n@@ -408,7 +414,9 @@ export function getImgProps(\n   src = typeof src === 'string' ? src : staticSrc\n \n   let isLazy =\n-    !priority && (loading === 'lazy' || typeof loading === 'undefined')\n+    !priority &&\n+    !preload &&\n+    (loading === 'lazy' || typeof loading === 'undefined')\n   if (!src || src.startsWith('data:') || src.startsWith('blob:')) {\n     // https://developer.mozilla.org/docs/Web/HTTP/Basics_of_HTTP/Data_URIs\n     unoptimized = true\n@@ -516,6 +524,16 @@ export function getImgProps(\n         `Image with src \"${src}\" has both \"priority\" and \"loading='lazy'\" properties. Only one should be used.`\n       )\n     }\n+    if (preload && loading === 'lazy') {\n+      throw new Error(\n+        `Image with src \"${src}\" has both \"preload\" and \"loading='lazy'\" properties. Only one should be used.`\n+      )\n+    }\n+    if (preload && priority) {\n+      throw new Error(\n+        `Image with src \"${src}\" has both \"preload\" and \"priority\" properties. Only \"preload\" should be used.`\n+      )\n+    }\n     if (\n       placeholder !== 'empty' &&\n       placeholder !== 'blur' &&\n@@ -626,15 +644,15 @@ export function getImgProps(\n           const lcpImage = allImgs.get(imgSrc)\n           if (\n             lcpImage &&\n-            !lcpImage.priority &&\n+            lcpImage.loading === 'lazy' &&\n             lcpImage.placeholder === 'empty' &&\n             !lcpImage.src.startsWith('data:') &&\n             !lcpImage.src.startsWith('blob:')\n           ) {\n             // https://web.dev/lcp/#measure-lcp-in-javascript\n             warnOnce(\n-              `Image with src \"${lcpImage.src}\" was detected as the Largest Contentful Paint (LCP). Please add the \"priority\" property if this image is above the fold.` +\n-                `\\nRead more: https://nextjs.org/docs/api-reference/next/image#priority`\n+              `Image with src \"${lcpImage.src}\" was detected as the Largest Contentful Paint (LCP). Please add the \\`loading=\"eager\"\\` property if this image is above the fold.` +\n+                `\\nRead more: https://nextjs.org/docs/app/api-reference/components/image#loading`\n             )\n           }\n         }\n@@ -722,6 +740,8 @@ export function getImgProps(\n     loader,\n   })\n \n+  const loadingFinal = isLazy ? 'lazy' : loading\n+\n   if (process.env.NODE_ENV !== 'production') {\n     if (typeof window !== 'undefined') {\n       let fullUrl: URL\n@@ -730,13 +750,13 @@ export function getImgProps(\n       } catch (e) {\n         fullUrl = new URL(imgAttributes.src, window.location.href)\n       }\n-      allImgs.set(fullUrl.href, { src, priority, placeholder })\n+      allImgs.set(fullUrl.href, { src, loading: loadingFinal, placeholder })\n     }\n   }\n \n   const props: ImgProps = {\n     ...rest,\n-    loading: isLazy ? 'lazy' : loading,\n+    loading: loadingFinal,\n     fetchPriority,\n     width: widthInt,\n     height: heightInt,\n@@ -747,6 +767,6 @@ export function getImgProps(\n     srcSet: imgAttributes.srcSet,\n     src: overrideSrc || imgAttributes.src,\n   }\n-  const meta = { unoptimized, priority, placeholder, fill }\n+  const meta = { unoptimized, preload: preload || priority, placeholder, fill }\n   return { props, meta }\n }"
        },
        {
            "sha": "8a72198f55849cdb94e072924941f4bd882b9365",
            "filename": "test/integration/next-image-new/app-dir/app/preload-missing-warning/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fpreload-missing-warning%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fpreload-missing-warning%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fpreload-missing-warning%2Fpage.js?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "previous_filename": "test/integration/next-image-new/app-dir/app/priority-missing-warning/page.js"
        },
        {
            "sha": "3fd9c4e04d7881dc9ee3ce425eaf55bbeea36274",
            "filename": "test/integration/next-image-new/app-dir/app/preload/page.js",
            "status": "added",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fpreload%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fpreload%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Fapp%2Fpreload%2Fpage.js?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -0,0 +1,82 @@\n+import React from 'react'\n+import Image from 'next/image'\n+\n+const Page = () => {\n+  return (\n+    <div>\n+      <p>Preload Page</p>\n+      <Image\n+        preload\n+        id=\"basic-image\"\n+        alt=\"basic-image\"\n+        src=\"/test.jpg\"\n+        width=\"400\"\n+        height=\"400\"\n+      ></Image>\n+      <Image\n+        preload\n+        id=\"basic-image-crossorigin\"\n+        alt=\"basic-image-crossorigin\"\n+        src=\"/test.webp\"\n+        width=\"400\"\n+        height=\"400\"\n+        crossOrigin=\"use-credentials\"\n+      ></Image>\n+      <Image\n+        preload\n+        id=\"basic-image-referrerpolicy\"\n+        alt=\"basic-image-referrerpolicy\"\n+        src=\"/test.png\"\n+        width=\"400\"\n+        height=\"400\"\n+        referrerPolicy=\"no-referrer\"\n+      ></Image>\n+      <Image\n+        loading=\"eager\"\n+        id=\"load-eager\"\n+        alt=\"load-eager\"\n+        src=\"/test.png\"\n+        width=\"200\"\n+        height=\"200\"\n+      ></Image>\n+      <Image\n+        preload\n+        id=\"responsive1\"\n+        alt=\"responsive1\"\n+        src=\"/wide.png\"\n+        width=\"1200\"\n+        height=\"700\"\n+        sizes=\"100vw\"\n+      />\n+      <Image\n+        preload\n+        id=\"responsive2\"\n+        alt=\"responsive2\"\n+        src=\"/wide.png\"\n+        width=\"1200\"\n+        height=\"700\"\n+        sizes=\"100vw\"\n+      />\n+      <Image\n+        id=\"pri-low\"\n+        alt=\"pri-low\"\n+        src=\"/test.webp\"\n+        width=\"100\"\n+        height=\"100\"\n+        fetchPriority=\"low\"\n+      />\n+      <p id=\"stubtext\">This is the preload page</p>\n+      <div style={{ height: '1000vh' }} />\n+      <Image\n+        preload\n+        id=\"belowthefold\"\n+        src=\"/test.tiff\"\n+        width=\"400\"\n+        height=\"400\"\n+        alt=\"\"\n+      />\n+    </div>\n+  )\n+}\n+\n+export default Page"
        },
        {
            "sha": "7caa585610a580643686cb35380d1aaf57d425bf",
            "filename": "test/integration/next-image-new/app-dir/test/index.test.ts",
            "status": "modified",
            "additions": 153,
            "deletions": 2,
            "changes": 155,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -255,6 +255,157 @@ function runTests(mode: 'dev' | 'server') {\n     }\n   })\n \n+  it('should work with preload prop', async () => {\n+    let browser\n+    try {\n+      browser = await webdriver(appPort, '/preload')\n+\n+      await check(async () => {\n+        const result = await browser.eval(\n+          `document.getElementById('basic-image').naturalWidth`\n+        )\n+\n+        if (result === 0) {\n+          throw new Error('Incorrectly loaded image')\n+        }\n+\n+        return 'result-correct'\n+      }, /result-correct/)\n+\n+      const links = await browser.elementsByCss('link[rel=preload][as=image]')\n+      const entries = []\n+      for (const link of links) {\n+        const fetchpriority = await link.getAttribute('fetchpriority')\n+        const imagesrcset = await link.getAttribute('imagesrcset')\n+        const imagesizes = await link.getAttribute('imagesizes')\n+        const crossorigin = await link.getAttribute('crossorigin')\n+        const referrerpolicy = await link.getAttribute('referrerPolicy')\n+        entries.push({\n+          fetchpriority,\n+          imagesrcset,\n+          imagesizes,\n+          crossorigin,\n+          referrerpolicy,\n+        })\n+      }\n+\n+      expect(\n+        entries.find(\n+          (item) =>\n+            item.imagesrcset ===\n+            '/_next/image?url=%2Ftest.webp&w=640&q=75 1x, /_next/image?url=%2Ftest.webp&w=828&q=75 2x'\n+        )\n+      ).toEqual({\n+        fetchpriority: '',\n+        imagesizes: '',\n+        imagesrcset:\n+          '/_next/image?url=%2Ftest.webp&w=640&q=75 1x, /_next/image?url=%2Ftest.webp&w=828&q=75 2x',\n+        crossorigin: 'use-credentials',\n+        referrerpolicy: '',\n+      })\n+\n+      expect(\n+        entries.find(\n+          (item) =>\n+            item.imagesrcset ===\n+            '/_next/image?url=%2Fwide.png&w=640&q=75 640w, /_next/image?url=%2Fwide.png&w=750&q=75 750w, /_next/image?url=%2Fwide.png&w=828&q=75 828w, /_next/image?url=%2Fwide.png&w=1080&q=75 1080w, /_next/image?url=%2Fwide.png&w=1200&q=75 1200w, /_next/image?url=%2Fwide.png&w=1920&q=75 1920w, /_next/image?url=%2Fwide.png&w=2048&q=75 2048w, /_next/image?url=%2Fwide.png&w=3840&q=75 3840w'\n+        )\n+      ).toEqual({\n+        fetchpriority: '',\n+        imagesizes: '100vw',\n+        imagesrcset:\n+          '/_next/image?url=%2Fwide.png&w=640&q=75 640w, /_next/image?url=%2Fwide.png&w=750&q=75 750w, /_next/image?url=%2Fwide.png&w=828&q=75 828w, /_next/image?url=%2Fwide.png&w=1080&q=75 1080w, /_next/image?url=%2Fwide.png&w=1200&q=75 1200w, /_next/image?url=%2Fwide.png&w=1920&q=75 1920w, /_next/image?url=%2Fwide.png&w=2048&q=75 2048w, /_next/image?url=%2Fwide.png&w=3840&q=75 3840w',\n+        crossorigin: '',\n+        referrerpolicy: '',\n+      })\n+\n+      expect(\n+        entries.find(\n+          (item) =>\n+            item.imagesrcset ===\n+            '/_next/image?url=%2Ftest.png&w=640&q=75 1x, /_next/image?url=%2Ftest.png&w=828&q=75 2x'\n+        )\n+      ).toEqual({\n+        fetchpriority: '',\n+        imagesizes: '',\n+        imagesrcset:\n+          '/_next/image?url=%2Ftest.png&w=640&q=75 1x, /_next/image?url=%2Ftest.png&w=828&q=75 2x',\n+        crossorigin: '',\n+        referrerpolicy: 'no-referrer',\n+      })\n+\n+      expect(\n+        entries.find(\n+          (item) =>\n+            item.imagesrcset ===\n+            '/_next/image?url=%2Ftest.tiff&w=640&q=75 1x, /_next/image?url=%2Ftest.tiff&w=828&q=75 2x'\n+        )\n+      ).toEqual({\n+        fetchpriority: '',\n+        imagesizes: '',\n+        imagesrcset:\n+          '/_next/image?url=%2Ftest.tiff&w=640&q=75 1x, /_next/image?url=%2Ftest.tiff&w=828&q=75 2x',\n+        crossorigin: '',\n+        referrerpolicy: '',\n+      })\n+\n+      // When preload={true}, we should _not_ set loading=\"lazy\"\n+      expect(\n+        await browser.elementById('basic-image').getAttribute('loading')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('load-eager').getAttribute('loading')\n+      ).toBe('eager')\n+      expect(\n+        await browser.elementById('responsive1').getAttribute('loading')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('responsive2').getAttribute('loading')\n+      ).toBe(null)\n+\n+      // When preload={true}, we should not set fetchpriority=\"high\"\n+      expect(\n+        await browser.elementById('basic-image').getAttribute('fetchpriority')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('load-eager').getAttribute('fetchpriority')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('responsive1').getAttribute('fetchpriority')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('responsive2').getAttribute('fetchpriority')\n+      ).toBe(null)\n+\n+      // Setting fetchPriority=\"low\" directly should pass-through to <img>\n+      expect(\n+        await browser.elementById('pri-low').getAttribute('fetchpriority')\n+      ).toBe('low')\n+      expect(await browser.elementById('pri-low').getAttribute('loading')).toBe(\n+        'lazy'\n+      )\n+\n+      expect(\n+        await browser.elementById('belowthefold').getAttribute('fetchpriority')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('belowthefold').getAttribute('loading')\n+      ).toBe(null)\n+\n+      const warnings = (await browser.log())\n+        .map((log) => log.message)\n+        .join('\\n')\n+      expect(warnings).not.toMatch(\n+        /was detected as the Largest Contentful Paint/gm\n+      )\n+      expect(warnings).not.toMatch(/React does not recognize the (.+) prop/gm)\n+    } finally {\n+      if (browser) {\n+        await browser.close()\n+      }\n+    }\n+  })\n+\n   it('should not pass through user-provided srcset (causing a flash)', async () => {\n     const html = await renderViaHTTP(appPort, '/drop-srcset')\n     const $html = cheerio.load(html)\n@@ -1077,8 +1228,8 @@ function runTests(mode: 'dev' | 'server') {\n       expect(warnings).not.toMatch(/cannot appear as a descendant/gm)\n     })\n \n-    it('should warn when priority prop is missing on LCP image', async () => {\n-      let browser = await webdriver(appPort, '/priority-missing-warning')\n+    it('should warn when preload prop is missing on LCP image', async () => {\n+      let browser = await webdriver(appPort, '/preload-missing-warning')\n       try {\n         // Wait for image to load:\n         await check(async () => {"
        },
        {
            "sha": "d76cb07f1ce60ce7d40493fd28a5843a7cbb6e65",
            "filename": "test/integration/next-image-new/default/pages/preload-missing-warning.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fdefault%2Fpages%2Fpreload-missing-warning.js",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fdefault%2Fpages%2Fpreload-missing-warning.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fdefault%2Fpages%2Fpreload-missing-warning.js?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "previous_filename": "test/integration/next-image-new/default/pages/priority-missing-warning.js"
        },
        {
            "sha": "3fd9c4e04d7881dc9ee3ce425eaf55bbeea36274",
            "filename": "test/integration/next-image-new/default/pages/preload.js",
            "status": "added",
            "additions": 82,
            "deletions": 0,
            "changes": 82,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fdefault%2Fpages%2Fpreload.js",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fdefault%2Fpages%2Fpreload.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fdefault%2Fpages%2Fpreload.js?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -0,0 +1,82 @@\n+import React from 'react'\n+import Image from 'next/image'\n+\n+const Page = () => {\n+  return (\n+    <div>\n+      <p>Preload Page</p>\n+      <Image\n+        preload\n+        id=\"basic-image\"\n+        alt=\"basic-image\"\n+        src=\"/test.jpg\"\n+        width=\"400\"\n+        height=\"400\"\n+      ></Image>\n+      <Image\n+        preload\n+        id=\"basic-image-crossorigin\"\n+        alt=\"basic-image-crossorigin\"\n+        src=\"/test.webp\"\n+        width=\"400\"\n+        height=\"400\"\n+        crossOrigin=\"use-credentials\"\n+      ></Image>\n+      <Image\n+        preload\n+        id=\"basic-image-referrerpolicy\"\n+        alt=\"basic-image-referrerpolicy\"\n+        src=\"/test.png\"\n+        width=\"400\"\n+        height=\"400\"\n+        referrerPolicy=\"no-referrer\"\n+      ></Image>\n+      <Image\n+        loading=\"eager\"\n+        id=\"load-eager\"\n+        alt=\"load-eager\"\n+        src=\"/test.png\"\n+        width=\"200\"\n+        height=\"200\"\n+      ></Image>\n+      <Image\n+        preload\n+        id=\"responsive1\"\n+        alt=\"responsive1\"\n+        src=\"/wide.png\"\n+        width=\"1200\"\n+        height=\"700\"\n+        sizes=\"100vw\"\n+      />\n+      <Image\n+        preload\n+        id=\"responsive2\"\n+        alt=\"responsive2\"\n+        src=\"/wide.png\"\n+        width=\"1200\"\n+        height=\"700\"\n+        sizes=\"100vw\"\n+      />\n+      <Image\n+        id=\"pri-low\"\n+        alt=\"pri-low\"\n+        src=\"/test.webp\"\n+        width=\"100\"\n+        height=\"100\"\n+        fetchPriority=\"low\"\n+      />\n+      <p id=\"stubtext\">This is the preload page</p>\n+      <div style={{ height: '1000vh' }} />\n+      <Image\n+        preload\n+        id=\"belowthefold\"\n+        src=\"/test.tiff\"\n+        width=\"400\"\n+        height=\"400\"\n+        alt=\"\"\n+      />\n+    </div>\n+  )\n+}\n+\n+export default Page"
        },
        {
            "sha": "bac1dc18a22126afe816abf6509cd32f3dea44df",
            "filename": "test/integration/next-image-new/default/test/index.test.ts",
            "status": "modified",
            "additions": 153,
            "deletions": 2,
            "changes": 155,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fdefault%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Fintegration%2Fnext-image-new%2Fdefault%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fdefault%2Ftest%2Findex.test.ts?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -257,6 +257,157 @@ function runTests(mode) {\n     }\n   })\n \n+  it('should work with preload prop', async () => {\n+    let browser\n+    try {\n+      browser = await webdriver(appPort, '/preload')\n+\n+      await check(async () => {\n+        const result = await browser.eval(\n+          `document.getElementById('basic-image').naturalWidth`\n+        )\n+\n+        if (result === 0) {\n+          throw new Error('Incorrectly loaded image')\n+        }\n+\n+        return 'result-correct'\n+      }, /result-correct/)\n+\n+      const links = await browser.elementsByCss('link[rel=preload][as=image]')\n+      const entries = []\n+      for (const link of links) {\n+        const fetchpriority = await link.getAttribute('fetchpriority')\n+        const imagesrcset = await link.getAttribute('imagesrcset')\n+        const imagesizes = await link.getAttribute('imagesizes')\n+        const crossorigin = await link.getAttribute('crossorigin')\n+        const referrerpolicy = await link.getAttribute('referrerPolicy')\n+        entries.push({\n+          fetchpriority,\n+          imagesrcset,\n+          imagesizes,\n+          crossorigin,\n+          referrerpolicy,\n+        })\n+      }\n+\n+      expect(\n+        entries.find(\n+          (item) =>\n+            item.imagesrcset ===\n+            '/_next/image?url=%2Ftest.webp&w=640&q=75 1x, /_next/image?url=%2Ftest.webp&w=828&q=75 2x'\n+        )\n+      ).toEqual({\n+        fetchpriority: '',\n+        imagesizes: '',\n+        imagesrcset:\n+          '/_next/image?url=%2Ftest.webp&w=640&q=75 1x, /_next/image?url=%2Ftest.webp&w=828&q=75 2x',\n+        crossorigin: 'use-credentials',\n+        referrerpolicy: '',\n+      })\n+\n+      expect(\n+        entries.find(\n+          (item) =>\n+            item.imagesrcset ===\n+            '/_next/image?url=%2Fwide.png&w=640&q=75 640w, /_next/image?url=%2Fwide.png&w=750&q=75 750w, /_next/image?url=%2Fwide.png&w=828&q=75 828w, /_next/image?url=%2Fwide.png&w=1080&q=75 1080w, /_next/image?url=%2Fwide.png&w=1200&q=75 1200w, /_next/image?url=%2Fwide.png&w=1920&q=75 1920w, /_next/image?url=%2Fwide.png&w=2048&q=75 2048w, /_next/image?url=%2Fwide.png&w=3840&q=75 3840w'\n+        )\n+      ).toEqual({\n+        fetchpriority: '',\n+        imagesizes: '100vw',\n+        imagesrcset:\n+          '/_next/image?url=%2Fwide.png&w=640&q=75 640w, /_next/image?url=%2Fwide.png&w=750&q=75 750w, /_next/image?url=%2Fwide.png&w=828&q=75 828w, /_next/image?url=%2Fwide.png&w=1080&q=75 1080w, /_next/image?url=%2Fwide.png&w=1200&q=75 1200w, /_next/image?url=%2Fwide.png&w=1920&q=75 1920w, /_next/image?url=%2Fwide.png&w=2048&q=75 2048w, /_next/image?url=%2Fwide.png&w=3840&q=75 3840w',\n+        crossorigin: '',\n+        referrerpolicy: '',\n+      })\n+\n+      expect(\n+        entries.find(\n+          (item) =>\n+            item.imagesrcset ===\n+            '/_next/image?url=%2Ftest.png&w=640&q=75 1x, /_next/image?url=%2Ftest.png&w=828&q=75 2x'\n+        )\n+      ).toEqual({\n+        fetchpriority: '',\n+        imagesizes: '',\n+        imagesrcset:\n+          '/_next/image?url=%2Ftest.png&w=640&q=75 1x, /_next/image?url=%2Ftest.png&w=828&q=75 2x',\n+        crossorigin: '',\n+        referrerpolicy: 'no-referrer',\n+      })\n+\n+      expect(\n+        entries.find(\n+          (item) =>\n+            item.imagesrcset ===\n+            '/_next/image?url=%2Ftest.tiff&w=640&q=75 1x, /_next/image?url=%2Ftest.tiff&w=828&q=75 2x'\n+        )\n+      ).toEqual({\n+        fetchpriority: '',\n+        imagesizes: '',\n+        imagesrcset:\n+          '/_next/image?url=%2Ftest.tiff&w=640&q=75 1x, /_next/image?url=%2Ftest.tiff&w=828&q=75 2x',\n+        crossorigin: '',\n+        referrerpolicy: '',\n+      })\n+\n+      // When preload={true}, we should _not_ set loading=\"lazy\"\n+      expect(\n+        await browser.elementById('basic-image').getAttribute('loading')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('load-eager').getAttribute('loading')\n+      ).toBe('eager')\n+      expect(\n+        await browser.elementById('responsive1').getAttribute('loading')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('responsive2').getAttribute('loading')\n+      ).toBe(null)\n+\n+      // When preload={true}, we not should set fetchpriority=\"high\"\n+      expect(\n+        await browser.elementById('basic-image').getAttribute('fetchpriority')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('load-eager').getAttribute('fetchpriority')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('responsive1').getAttribute('fetchpriority')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('responsive2').getAttribute('fetchpriority')\n+      ).toBe(null)\n+\n+      // Setting fetchPriority=\"low\" directly should pass-through to <img>\n+      expect(\n+        await browser.elementById('pri-low').getAttribute('fetchpriority')\n+      ).toBe('low')\n+      expect(await browser.elementById('pri-low').getAttribute('loading')).toBe(\n+        'lazy'\n+      )\n+\n+      expect(\n+        await browser.elementById('belowthefold').getAttribute('fetchpriority')\n+      ).toBe(null)\n+      expect(\n+        await browser.elementById('belowthefold').getAttribute('loading')\n+      ).toBe(null)\n+\n+      const warnings = (await browser.log())\n+        .map((log) => log.message)\n+        .join('\\n')\n+      expect(warnings).not.toMatch(\n+        /was detected as the Largest Contentful Paint/gm\n+      )\n+      expect(warnings).not.toMatch(/React does not recognize the (.+) prop/gm)\n+    } finally {\n+      if (browser) {\n+        await browser.close()\n+      }\n+    }\n+  })\n+\n   it('should not pass through user-provided srcset (causing a flash)', async () => {\n     const html = await renderViaHTTP(appPort, '/drop-srcset')\n     const $html = cheerio.load(html)\n@@ -1079,8 +1230,8 @@ function runTests(mode) {\n       expect(warnings).not.toMatch(/cannot appear as a descendant/gm)\n     })\n \n-    it('should warn when priority prop is missing on LCP image', async () => {\n-      let browser = await webdriver(appPort, '/priority-missing-warning')\n+    it('should warn when preload prop is missing on LCP image', async () => {\n+      let browser = await webdriver(appPort, '/preload-missing-warning')\n       try {\n         // Wait for image to load:\n         await check(async () => {"
        },
        {
            "sha": "9069e1b7280e152174c2051498e203e720544f7f",
            "filename": "test/unit/next-image-get-img-props.test.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/07e9324016d9914bbcb314c7de65033a7221e07d/test%2Funit%2Fnext-image-get-img-props.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fnext-image-get-img-props.test.ts?ref=07e9324016d9914bbcb314c7de65033a7221e07d",
            "patch": "@@ -61,6 +61,47 @@ describe('getImageProps()', () => {\n     expect(props.srcSet).toBeString()\n   })\n \n+  it('should handle preload', async () => {\n+    const { props } = getImageProps({\n+      alt: 'a nice desc',\n+      id: 'my-image',\n+      src: '/test.png',\n+      width: 100,\n+      height: 200,\n+      preload: true,\n+    })\n+    expect(warningMessages).toStrictEqual([])\n+    expect(Object.entries(props)).toStrictEqual([\n+      ['alt', 'a nice desc'],\n+      ['id', 'my-image'],\n+      ['width', 100],\n+      ['height', 200],\n+      ['decoding', 'async'],\n+      ['style', { color: 'transparent' }],\n+      [\n+        'srcSet',\n+        '/_next/image?url=%2Ftest.png&w=128&q=75 1x, /_next/image?url=%2Ftest.png&w=256&q=75 2x',\n+      ],\n+      ['src', '/_next/image?url=%2Ftest.png&w=256&q=75'],\n+    ])\n+  })\n+\n+  it('should error when both priority and preload are used', async () => {\n+    expect(() =>\n+      getImageProps({\n+        alt: 'a nice desc',\n+        id: 'my-image',\n+        src: '/test.png',\n+        width: 100,\n+        height: 200,\n+        preload: true,\n+        priority: true,\n+      })\n+    ).toThrow(\n+      'Image with src \"/test.png\" has both \"preload\" and \"priority\" properties. Only \"preload\" should be used.'\n+    )\n+  })\n+\n   it('should handle priority', async () => {\n     const { props } = getImageProps({\n       alt: 'a nice desc',"
        }
    ],
    "stats": {
        "total": 593,
        "additions": 565,
        "deletions": 28
    }
}