{
    "author": "bgw",
    "message": "Turbopack: Use more robust logic for absolute and percent-encoded URLs in source maps received from loaders (#84255)\n\nCo-authored-by: Sebastian Sebbie Silbermann <sebastian.silbermann@vercel.com>",
    "sha": "c1967707aba2bba32a04d806474e69b077e0592a",
    "files": [
        {
            "sha": "9122017c5a637c4adb87cf6119c69fd5733aae3d",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -9564,6 +9564,7 @@ dependencies = [\n  \"turbo-tasks-hash\",\n  \"turbo-tasks-testing\",\n  \"turbo-unix-path\",\n+ \"url\",\n  \"urlencoding\",\n ]\n "
        },
        {
            "sha": "967bb993341c2a7d7e38cbfbd0ffeb52fa0c2a1c",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 11,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox.test.ts?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -406,9 +406,22 @@ describe('ReactRefreshLogBox app', () => {\n     )\n \n     if (isTurbopack) {\n-      // TODO(veil): Turbopack is flaky. Possibly related to https://linear.app/vercel/issue/NDX-920/turbopack-errors-after-hmr-have-no-stacktraces-in-affected-chunks\n-      // Should use `await expect(browser).toDisplayRedbox()`\n-      await session.assertHasRedbox()\n+      // TODO(veil): Possibly https://linear.app/vercel/issue/NEXT-4411\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"Child.js (4:11) @ ClickCount.render\n+       > 4 |     throw new Error()\n+           |           ^\",\n+         \"stack\": [\n+           \"ClickCount.render Child.js (4:11)\",\n+           \"Home index.js (6:7)\",\n+           \"<FIXME-file-protocol>\",\n+         ],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -1032,7 +1045,6 @@ describe('ReactRefreshLogBox app', () => {\n     )\n \n     if (isTurbopack) {\n-      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"test\",\n@@ -1043,8 +1055,6 @@ describe('ReactRefreshLogBox app', () => {\n            |           ^\",\n          \"stack\": [\n            \"{default export} index.js (3:11)\",\n-           \"<FIXME-file-protocol>\",\n-           \"<FIXME-file-protocol>\",\n            \"Page app/page.js (2:1)\",\n          ],\n        }\n@@ -1135,7 +1145,6 @@ describe('ReactRefreshLogBox app', () => {\n     // Render error should \"win\" and show up in fullscreen\n     // TODO(veil): Why Owner Stack location different?\n     if (isTurbopack) {\n-      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Component error\",\n@@ -1146,8 +1155,6 @@ describe('ReactRefreshLogBox app', () => {\n            |                                            ^\",\n          \"stack\": [\n            \"Index index.js (2:44)\",\n-           \"<FIXME-file-protocol>\",\n-           \"<FIXME-file-protocol>\",\n            \"Page index.js (16:8)\",\n          ],\n        }\n@@ -1540,8 +1547,6 @@ describe('ReactRefreshLogBox app', () => {\n         await session.assertHasRedbox()\n       })\n \n-      // TODO(veil): Turbopack is flaky. Possibly related to https://linear.app/vercel/issue/NDX-920/turbopack-errors-after-hmr-have-no-stacktraces-in-affected-chunks\n-\n       if (isRspack) {\n         await expect({ browser, next }).toDisplayRedbox(`\n          {"
        },
        {
            "sha": "060f5277fb27b33542338d1e76c0a5d7f3b66239",
            "filename": "test/development/acceptance-app/error-recovery.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 9,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -520,7 +520,7 @@ describe('Error recovery app', () => {\n     )\n \n     if (isTurbopack) {\n-      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n+      // TODO(veil): Possibly https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"oops\",\n@@ -531,8 +531,6 @@ describe('Error recovery app', () => {\n            |         ^\",\n          \"stack\": [\n            \"Child child.js (3:9)\",\n-           \"<FIXME-file-protocol>\",\n-           \"<FIXME-file-protocol>\",\n            \"Index index.js (6:7)\",\n            \"<FIXME-file-protocol>\",\n          ],\n@@ -824,7 +822,7 @@ describe('Error recovery app', () => {\n \n     // We get an error because Foo didn't import React. Fair.\n     if (isTurbopack) {\n-      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n+      // TODO(veil): Possibly https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"React is not defined\",\n@@ -835,8 +833,6 @@ describe('Error recovery app', () => {\n            |   ^\",\n          \"stack\": [\n            \"Foo Foo.js (3:3)\",\n-           \"<FIXME-file-protocol>\",\n-           \"<FIXME-file-protocol>\",\n            \"FunctionDefault index.js (4:10)\",\n            \"<FIXME-file-protocol>\",\n          ],\n@@ -1086,7 +1082,6 @@ describe('Error recovery app', () => {\n     )\n     if (isTurbopack) {\n       // TODO(veil): Location of Page should be app/page.js\n-      // <FIXME-file-protocol>: https://linear.app/vercel/issue/NDX-920/\n       await expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"nooo\",\n@@ -1097,8 +1092,6 @@ describe('Error recovery app', () => {\n            |           ^\",\n          \"stack\": [\n            \"ClassDefault.render index.js (5:11)\",\n-           \"<FIXME-file-protocol>\",\n-           \"<FIXME-file-protocol>\",\n            \"Page index.js (10:16)\",\n          ],\n        }"
        },
        {
            "sha": "ee488ebd675f4cf68000952bd8856b96cd315b11",
            "filename": "test/development/acceptance/ReactRefreshLogBox.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 28,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox.test.ts?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -294,8 +294,6 @@ describe('ReactRefreshLogBox', () => {\n            |                                                   ^\",\n            \"stack\": [\n              \"FunctionDefault FunctionDefault.js (1:51)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          },\n          {\n@@ -307,8 +305,6 @@ describe('ReactRefreshLogBox', () => {\n            |                                                   ^\",\n            \"stack\": [\n              \"FunctionDefault FunctionDefault.js (1:51)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          },\n        ]\n@@ -352,8 +348,6 @@ describe('ReactRefreshLogBox', () => {\n              |                                                   ^\",\n            \"stack\": [\n              \"FunctionDefault FunctionDefault.js (1:51)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          }\n         `)\n@@ -570,7 +564,6 @@ describe('ReactRefreshLogBox', () => {\n       `\n     )\n \n-    // TODO(veil): Don't bail in Turbopack for sources outside of the project (https://linear.app/vercel/issue/NDX-944)\n     if (isReact18 && isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        [\n@@ -583,8 +576,6 @@ describe('ReactRefreshLogBox', () => {\n            |           ^\",\n            \"stack\": [\n              \"ClickCount.render Child.js (4:11)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          },\n          {\n@@ -596,8 +587,6 @@ describe('ReactRefreshLogBox', () => {\n            |           ^\",\n            \"stack\": [\n              \"ClickCount.render Child.js (4:11)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          },\n        ]\n@@ -630,23 +619,7 @@ describe('ReactRefreshLogBox', () => {\n        ]\n       `)\n     } else {\n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"Child.js (4:11) @ ClickCount.render\n-         > 4 |     throw new Error()\n-             |           ^\",\n-           \"stack\": [\n-             \"ClickCount.render Child.js (4:11)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n-           ],\n-         }\n-        `)\n-      } else if (isRspack) {\n+      if (isRspack) {\n         await expect(browser).toDisplayRedbox(`\n          {\n            \"description\": \"\","
        },
        {
            "sha": "94d2592f1b5675b0d8ed29fa17048b8b006e50ef",
            "filename": "test/development/acceptance/error-recovery.test.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 127,
            "changes": 142,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -244,8 +244,6 @@ describe('pages/ error recovery', () => {\n       `\n     )\n \n-    // TODO(veil): Don't bail in Turbopack for sources outside of the project (https://linear.app/vercel/issue/NDX-944)\n-    // Somehow we end up with two in React 18 + Turbopack/Rspack due to React's attempt to recover from this error.\n     if (isReact18 && isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        [\n@@ -258,8 +256,6 @@ describe('pages/ error recovery', () => {\n            |         ^\",\n            \"stack\": [\n              \"Child child.js (3:9)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          },\n          {\n@@ -271,8 +267,6 @@ describe('pages/ error recovery', () => {\n            |         ^\",\n            \"stack\": [\n              \"Child child.js (3:9)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          },\n        ]\n@@ -305,23 +299,7 @@ describe('pages/ error recovery', () => {\n        ]\n       `)\n     } else {\n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"oops\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"child.js (3:9) @ Child\n-         > 3 |   throw new Error('oops')\n-             |         ^\",\n-           \"stack\": [\n-             \"Child child.js (3:9)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n-           ],\n-         }\n-        `)\n-      } else if (isRspack) {\n+      if (isRspack) {\n         await expect(browser).toDisplayRedbox(`\n          {\n            \"description\": \"oops\",\n@@ -587,8 +565,6 @@ describe('pages/ error recovery', () => {\n       await expect(session.getRedboxSource()).resolves.toInclude('render() {')\n     })\n \n-    // TODO(veil): Don't bail in Turbopack for sources outside of the project (https://linear.app/vercel/issue/NDX-944)\n-    // Somehow we end up with two in React 18 due to React's attempt to recover from this error.\n     if (isReact18 && isTurbopack) {\n       await expect(browser).toDisplayRedbox(`\n        [\n@@ -601,8 +577,6 @@ describe('pages/ error recovery', () => {\n            |           ^\",\n            \"stack\": [\n              \"ClassDefault.render index.js (5:11)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          },\n          {\n@@ -614,60 +588,24 @@ describe('pages/ error recovery', () => {\n            |           ^\",\n            \"stack\": [\n              \"ClassDefault.render index.js (5:11)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n            ],\n          },\n        ]\n       `)\n     } else {\n-      if (isRspack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"nooo\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime Error\",\n-           \"source\": \"index.js (5:11) @ ClassDefault.render\n-         > 5 |     throw new Error('nooo');\n-             |           ^\",\n-           \"stack\": [\n-             \"ClassDefault.render index.js (5:11)\",\n-           ],\n-         }\n-        `)\n-      } else {\n-        if (isTurbopack) {\n-          await expect(browser).toDisplayRedbox(`\n-           {\n-             \"description\": \"nooo\",\n-             \"environmentLabel\": null,\n-             \"label\": \"Runtime Error\",\n-             \"source\": \"index.js (5:11) @ ClassDefault.render\n-           > 5 |     throw new Error('nooo');\n-               |           ^\",\n-             \"stack\": [\n-               \"ClassDefault.render index.js (5:11)\",\n-               \"<FIXME-file-protocol>\",\n-               \"<FIXME-file-protocol>\",\n-             ],\n-           }\n-          `)\n-        } else {\n-          await expect(browser).toDisplayRedbox(`\n-           {\n-             \"description\": \"nooo\",\n-             \"environmentLabel\": null,\n-             \"label\": \"Runtime Error\",\n-             \"source\": \"index.js (5:11) @ ClassDefault.render\n-           > 5 |     throw new Error('nooo');\n-               |           ^\",\n-             \"stack\": [\n-               \"ClassDefault.render index.js (5:11)\",\n-             ],\n-           }\n-          `)\n+      await expect(browser).toDisplayRedbox(`\n+        {\n+          \"description\": \"nooo\",\n+          \"environmentLabel\": null,\n+          \"label\": \"Runtime Error\",\n+          \"source\": \"index.js (5:11) @ ClassDefault.render\n+        > 5 |     throw new Error('nooo');\n+            |           ^\",\n+          \"stack\": [\n+            \"ClassDefault.render index.js (5:11)\",\n+          ],\n         }\n-      }\n+      `)\n     }\n   })\n \n@@ -714,41 +652,7 @@ describe('pages/ error recovery', () => {\n       `\n     )\n \n-    // TODO(veil): Don't bail in Turbopack for sources outside of the project (https://linear.app/vercel/issue/NDX-944)\n-    // We get an error because Foo didn't import React. Fair.\n-    // Somehow we end up with two in React 18 + Turbopack/Rspack due to React's attempt to recover from this error.\n-    if (isReact18 && isTurbopack) {\n-      await expect(browser).toDisplayRedbox(`\n-       [\n-         {\n-           \"description\": \"React is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime ReferenceError\",\n-           \"source\": \"Foo.js (3:3) @ Foo\n-       > 3 |   return React.createElement('h1', null, 'Foo');\n-           |   ^\",\n-           \"stack\": [\n-             \"Foo Foo.js (3:3)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n-           ],\n-         },\n-         {\n-           \"description\": \"React is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime ReferenceError\",\n-           \"source\": \"Foo.js (3:3) @ Foo\n-       > 3 |   return React.createElement('h1', null, 'Foo');\n-           |   ^\",\n-           \"stack\": [\n-             \"Foo Foo.js (3:3)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n-           ],\n-         },\n-       ]\n-      `)\n-    } else if (isReact18 && isRspack) {\n+    if (isReact18 && (isRspack || isTurbopack)) {\n       await expect(browser).toDisplayRedbox(`\n        [\n          {\n@@ -776,23 +680,7 @@ describe('pages/ error recovery', () => {\n        ]\n       `)\n     } else {\n-      if (isTurbopack) {\n-        await expect(browser).toDisplayRedbox(`\n-         {\n-           \"description\": \"React is not defined\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Runtime ReferenceError\",\n-           \"source\": \"Foo.js (3:3) @ Foo\n-         > 3 |   return React.createElement('h1', null, 'Foo');\n-             |   ^\",\n-           \"stack\": [\n-             \"Foo Foo.js (3:3)\",\n-             \"<FIXME-file-protocol>\",\n-             \"<FIXME-file-protocol>\",\n-           ],\n-         }\n-        `)\n-      } else if (isRspack) {\n+      if (isRspack) {\n         await expect(browser).toDisplayRedbox(`\n          {\n            \"description\": \"React is not defined\","
        },
        {
            "sha": "abb06ddc09bb6b84a183469fc338d26a529757b9",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 26,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -148,8 +148,7 @@ describe('app-dir - server source maps', () => {\n               '\\n    at runWithExternal (app/ssr-error-log-ignore-listed/page.js:17:32)' +\n               '\\n    at runWithInternalSourceMapped (app/ssr-error-log-ignore-listed/page.js:16:18)' +\n               // Realpath does not point into node_modules so we don't ignore it.\n-              // TODO(veil): Should be internal-pkg/sourcemapped.ts\n-              '\\n    at runInternalSourceMapped (sourcemapped.ts:5:10)' +\n+              '\\n    at runInternalSourceMapped (internal-pkg/sourcemapped.ts:5:10)' +\n               '\\n    at runWithInternal (app/ssr-error-log-ignore-listed/page.js:15:28)' +\n               // Realpath does not point into node_modules so we don't ignore it.\n               '\\n    at runInternal (internal-pkg/index.js:2:10)' +\n@@ -191,12 +190,11 @@ describe('app-dir - server source maps', () => {\n            \"stack\": [\n              \"logError app/ssr-error-log-ignore-listed/page.js (9:17)\",\n              \"runWithInternalIgnored app/ssr-error-log-ignore-listed/page.js (19:13)\",\n-             \"<FIXME-file-protocol>\",\n+             \"runInternalIgnored internal-pkg/ignored.ts (6:10)\",\n              \"runWithExternalSourceMapped app/ssr-error-log-ignore-listed/page.js (18:29)\",\n-             \"<FIXME-file-protocol>\",\n              \"runWithExternal app/ssr-error-log-ignore-listed/page.js (17:32)\",\n              \"runWithInternalSourceMapped app/ssr-error-log-ignore-listed/page.js (16:18)\",\n-             \"<FIXME-file-protocol>\",\n+             \"runInternalSourceMapped internal-pkg/sourcemapped.ts (5:10)\",\n              \"runWithInternal app/ssr-error-log-ignore-listed/page.js (15:28)\",\n              \"runInternal internal-pkg/index.js (2:10)\",\n              \"Page app/ssr-error-log-ignore-listed/page.js (14:14)\",\n@@ -266,8 +264,7 @@ describe('app-dir - server source maps', () => {\n               '\\n    at runWithExternal (app/rsc-error-log-ignore-listed/page.js:16:32)' +\n               '\\n    at runWithInternalSourceMapped (app/rsc-error-log-ignore-listed/page.js:15:18)' +\n               // Realpath does not point into node_modules so we don't ignore it.\n-              // TODO(veil): Should be internal-pkg/sourcemapped.ts\n-              '\\n    at runInternalSourceMapped (sourcemapped.ts:5:10)' +\n+              '\\n    at runInternalSourceMapped (internal-pkg/sourcemapped.ts:5:10)' +\n               '\\n    at runWithInternal (app/rsc-error-log-ignore-listed/page.js:14:28)' +\n               // Realpath does not point into node_modules so we don't ignore it.\n               '\\n    at runInternal (internal-pkg/index.js:2:10)' +\n@@ -398,9 +395,8 @@ describe('app-dir - server source maps', () => {\n           // Node.js is fine with invalid URLs in index maps apparently.\n           '' +\n             '\\nError: bad-sourcemap' +\n-            '\\n    at logError (custom://[badhost]/app/bad-sourcemap/page.js:6:17)' +\n-            '\\n    at Page (custom://[badhost]/app/bad-sourcemap/page.js:10:3)' +\n-            // TODO: Remove blank line\n+            '\\n    at logError (app/bad-sourcemap/custom:/[badhost]/app/bad-sourcemap/page.js:6:17)' +\n+            '\\n    at Page (app/bad-sourcemap/custom:/[badhost]/app/bad-sourcemap/page.js:10:3)' +\n             '\\n'\n         )\n       } else {\n@@ -704,7 +700,6 @@ describe('app-dir - server source maps', () => {\n       const browser = await next.browser('/ssr-anonymous-stack-frame-sandwich')\n \n       if (isTurbopack) {\n-        // TODO(veil): https://linear.app/vercel/issue/NEXT-4410/\n         await expect(browser).toDisplayCollapsedRedbox(`\n          [\n            {\n@@ -715,31 +710,22 @@ describe('app-dir - server source maps', () => {\n          > 6 |   runHiddenSetOfSetsExternal('ssr-anonymous-stack-frame-sandwich: external')\n              |                             ^\",\n              \"stack\": [\n-               \"<FIXME-file-protocol>\",\n-               \"<FIXME-file-protocol>\",\n-               \"Set.forEach <anonymous>\",\n-               \"<FIXME-file-protocol>\",\n-               \"Set.forEach <anonymous>\",\n-               \"<FIXME-file-protocol>\",\n-               \"<FIXME-file-protocol>\",\n                \"Page app/ssr-anonymous-stack-frame-sandwich/page.js (6:29)\",\n              ],\n            },\n            {\n              \"description\": \"ignore-listed frames\",\n              \"environmentLabel\": null,\n              \"label\": \"Console Error\",\n-             \"source\": \"app/ssr-anonymous-stack-frame-sandwich/page.js (7:29) @ Page\n-         >  7 |   runHiddenSetOfSetsInternal('ssr-anonymous-stack-frame-sandwich: internal')\n-              |                             ^\",\n+             \"source\": \"internal-pkg/sourcemapped.ts (9:13) @ runSetOfSets\",\n              \"stack\": [\n-               \"<FIXME-file-protocol>\",\n-               \"<FIXME-file-protocol>\",\n+               \"<unknown> internal-pkg/sourcemapped.ts (18:43)\",\n+               \"<unknown> internal-pkg/sourcemapped.ts (11:7)\",\n                \"Set.forEach <anonymous>\",\n-               \"<FIXME-file-protocol>\",\n+               \"<unknown> internal-pkg/sourcemapped.ts (10:9)\",\n                \"Set.forEach <anonymous>\",\n-               \"<FIXME-file-protocol>\",\n-               \"<FIXME-file-protocol>\",\n+               \"runSetOfSets internal-pkg/sourcemapped.ts (9:13)\",\n+               \"runHiddenSetOfSets internal-pkg/sourcemapped.ts (17:3)\",\n                \"Page app/ssr-anonymous-stack-frame-sandwich/page.js (7:29)\",\n              ],\n            },"
        },
        {
            "sha": "f159c187218c0b3543bd528c9e229b77d02ed903",
            "filename": "test/e2e/react-compiler/react-compiler.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 16,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fe2e%2Freact-compiler%2Freact-compiler.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/test%2Fe2e%2Freact-compiler%2Freact-compiler.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Freact-compiler%2Freact-compiler.test.ts?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -106,21 +106,7 @@ describe.each(['default', 'babelrc'] as const)(\n             // Just make sure this is the heuristic from the React Compiler not something else.\n             'Page[useEffect()]'\n       if (isNextDev) {\n-        if (isTurbopack) {\n-          // FIXME: https://linear.app/vercel/issue/NAR-351\n-          await expect(browser).toDisplayCollapsedRedbox(`\n-         {\n-           \"description\": \"test-top-frame\",\n-           \"environmentLabel\": null,\n-           \"label\": \"Console Error\",\n-           \"source\": null,\n-           \"stack\": [\n-             \"<FIXME-file-protocol>\",\n-           ],\n-         }\n-        `)\n-        } else {\n-          await expect(browser).toDisplayCollapsedRedbox(`\n+        await expect(browser).toDisplayCollapsedRedbox(`\n          {\n            \"description\": \"test-top-frame\",\n            \"environmentLabel\": null,\n@@ -133,7 +119,6 @@ describe.each(['default', 'babelrc'] as const)(\n            ],\n          }\n         `)\n-        }\n         // We care more about the sourcemapped frame in the Redbox.\n         // This assertion is only here to show that the negative assertion below is valid.\n         expect(normalizeCodeLocInfo(callFrame)).toEqual("
        },
        {
            "sha": "568282120b1967a15f17216e0195ead42d433c14",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 157,
            "deletions": 7,
            "changes": 164,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -1,11 +1,14 @@\n-#![allow(clippy::needless_return)] // tokio macro-generated code doesn't respect this\n-#![feature(btree_cursors)] // needed for the `InvalidatorMap` and watcher, reduces time complexity\n-#![feature(trivial_bounds)]\n-#![feature(min_specialization)]\n-#![feature(iter_advance_by)]\n-#![feature(io_error_more)]\n #![feature(arbitrary_self_types)]\n #![feature(arbitrary_self_types_pointers)]\n+#![feature(btree_cursors)] // needed for the `InvalidatorMap` and watcher, reduces time complexity\n+#![feature(io_error_more)]\n+#![feature(iter_advance_by)]\n+#![feature(min_specialization)]\n+// if `normalize_lexically` isn't eventually stabilized, we can copy the implementation from the\n+// stdlib into our source tree\n+#![feature(normalize_lexically)]\n+#![feature(trivial_bounds)]\n+#![allow(clippy::needless_return)] // tokio macro-generated code doesn't respect this\n #![allow(clippy::mutable_key_type)]\n \n pub mod attach;\n@@ -250,6 +253,7 @@ struct DiskFileSystemInner {\n impl DiskFileSystemInner {\n     /// Returns the root as Path\n     fn root_path(&self) -> &Path {\n+        // just in case there's a windows unc path prefix we remove it with `dunce`\n         simplified(Path::new(&*self.root))\n     }\n \n@@ -460,8 +464,54 @@ impl DiskFileSystem {\n         self.inner.watcher.stop_watching();\n     }\n \n+    /// Try to convert [`Path`] to [`FileSystemPath`]. Return `None` if the file path leaves the\n+    /// filesystem root. If no `relative_to` argument is given, it is assumed that the `sys_path` is\n+    /// relative to the [`DiskFileSystem`] root.\n+    ///\n+    /// Attempts to convert absolute paths to paths relative to the filesystem root, though we only\n+    /// attempt to do so lexically.\n+    ///\n+    /// Assumes `self` is the `DiskFileSystem` contained in `vc_self`. This API is a bit awkward\n+    /// because:\n+    /// - [`Path`]/[`PathBuf`] should not be stored in the persistent cache, so the function cannot\n+    ///   be a [`turbo_tasks::function`].\n+    /// - It's a little convenient for this function to be sync.\n+    pub fn try_from_sys_path(\n+        &self,\n+        vc_self: ResolvedVc<DiskFileSystem>,\n+        sys_path: &Path,\n+        relative_to: Option<&FileSystemPath>,\n+    ) -> Option<FileSystemPath> {\n+        let vc_self = ResolvedVc::upcast(vc_self);\n+\n+        let sys_path = simplified(sys_path);\n+        let relative_sys_path = if sys_path.is_absolute() {\n+            // `normalize_lexically` will return an error if the relative `sys_path` leaves the\n+            // DiskFileSystem root\n+            let normalized_sys_path = sys_path.normalize_lexically().ok()?;\n+            normalized_sys_path\n+                .strip_prefix(self.inner.root_path())\n+                .ok()?\n+                .to_owned()\n+        } else if let Some(relative_to) = relative_to {\n+            debug_assert_eq!(\n+                relative_to.fs, vc_self,\n+                \"`relative_to.fs` must match the current `ResolvedVc<DiskFileSystem>`\"\n+            );\n+            let mut joined_sys_path = PathBuf::from(unix_to_sys(&relative_to.path).into_owned());\n+            joined_sys_path.push(sys_path);\n+            joined_sys_path.normalize_lexically().ok()?\n+        } else {\n+            sys_path.normalize_lexically().ok()?\n+        };\n+\n+        Some(FileSystemPath {\n+            fs: vc_self,\n+            path: RcStr::from(sys_to_unix(relative_sys_path.to_str()?)),\n+        })\n+    }\n+\n     pub fn to_sys_path(&self, fs_path: FileSystemPath) -> Result<PathBuf> {\n-        // just in case there's a windows unc path prefix we remove it with `dunce`\n         let path = self.inner.root_path();\n         Ok(if fs_path.path.is_empty() {\n             path.to_path_buf()\n@@ -2465,6 +2515,7 @@ async fn realpath_with_links(path: FileSystemPath) -> Result<Vc<RealPathResult>>\n #[cfg(test)]\n mod tests {\n     use turbo_rcstr::rcstr;\n+    use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n \n     use super::*;\n \n@@ -2546,4 +2597,103 @@ mod tests {\n         .await\n         .unwrap()\n     }\n+\n+    #[tokio::test(flavor = \"multi_thread\", worker_threads = 2)]\n+    async fn test_try_from_sys_path() {\n+        let sys_root = if cfg!(windows) {\n+            Path::new(r\"C:\\fake\\root\")\n+        } else {\n+            Path::new(r\"/fake/root\")\n+        };\n+\n+        let tt = turbo_tasks::TurboTasks::new(TurboTasksBackend::new(\n+            BackendOptions::default(),\n+            noop_backing_storage(),\n+        ));\n+        tt.run_once(async {\n+            let fs_vc =\n+                DiskFileSystem::new(rcstr!(\"temp\"), RcStr::from(sys_root.to_str().unwrap()))\n+                    .to_resolved()\n+                    .await?;\n+            let fs = fs_vc.await?;\n+            let fs_root_path = fs_vc.root().await?;\n+\n+            assert_eq!(\n+                fs.try_from_sys_path(\n+                    fs_vc,\n+                    &Path::new(\"relative\").join(\"directory\"),\n+                    /* relative_to */ None,\n+                )\n+                .unwrap()\n+                .path,\n+                \"relative/directory\"\n+            );\n+\n+            assert_eq!(\n+                fs.try_from_sys_path(\n+                    fs_vc,\n+                    &sys_root\n+                        .join(\"absolute\")\n+                        .join(\"directory\")\n+                        .join(\"..\")\n+                        .join(\"normalized_path\"),\n+                    /* relative_to */ Some(&fs_root_path.join(\"ignored\").unwrap()),\n+                )\n+                .unwrap()\n+                .path,\n+                \"absolute/normalized_path\"\n+            );\n+\n+            assert_eq!(\n+                fs.try_from_sys_path(\n+                    fs_vc,\n+                    Path::new(\"child\"),\n+                    /* relative_to */ Some(&fs_root_path.join(\"parent\").unwrap()),\n+                )\n+                .unwrap()\n+                .path,\n+                \"parent/child\"\n+            );\n+\n+            assert_eq!(\n+                fs.try_from_sys_path(\n+                    fs_vc,\n+                    &Path::new(\"..\").join(\"parallel_dir\"),\n+                    /* relative_to */ Some(&fs_root_path.join(\"parent\").unwrap()),\n+                )\n+                .unwrap()\n+                .path,\n+                \"parallel_dir\"\n+            );\n+\n+            assert_eq!(\n+                fs.try_from_sys_path(\n+                    fs_vc,\n+                    &Path::new(\"relative\")\n+                        .join(\"..\")\n+                        .join(\"..\")\n+                        .join(\"leaves_root\"),\n+                    /* relative_to */ None,\n+                ),\n+                None\n+            );\n+\n+            assert_eq!(\n+                fs.try_from_sys_path(\n+                    fs_vc,\n+                    &sys_root\n+                        .join(\"absolute\")\n+                        .join(\"..\")\n+                        .join(\"..\")\n+                        .join(\"leaves_root\"),\n+                    /* relative_to */ None,\n+                ),\n+                None\n+            );\n+\n+            anyhow::Ok(())\n+        })\n+        .await\n+        .unwrap();\n+    }\n }"
        },
        {
            "sha": "26ab6b6023a7ae4e819952c8597809f3b1bc63ad",
            "filename": "turbopack/crates/turbo-tasks-fs/src/read_glob.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fread_glob.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fread_glob.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fread_glob.rs?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -234,7 +234,6 @@ pub mod tests {\n         collections::HashMap,\n         fs::{File, create_dir},\n         io::prelude::*,\n-        os::unix::fs::symlink,\n     };\n \n     use turbo_rcstr::{RcStr, rcstr};\n@@ -317,6 +316,8 @@ pub mod tests {\n     #[cfg(unix)]\n     #[tokio::test(flavor = \"multi_thread\", worker_threads = 2)]\n     async fn read_glob_symlinks() {\n+        use std::os::unix::fs::symlink;\n+\n         let scratch = tempfile::tempdir().unwrap();\n         {\n             // root.js"
        },
        {
            "sha": "583d532af37b9900b41f14feb97c286383c0a3d2",
            "filename": "turbopack/crates/turbopack-core/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -17,6 +17,7 @@ anyhow = { workspace = true }\n async-trait = { workspace = true }\n auto-hash-map = { workspace = true }\n browserslist-rs = { workspace = true }\n+bytes-str = { workspace = true }\n const_format = { workspace = true }\n data-encoding = { workspace = true }\n either = { workspace = true }\n@@ -42,8 +43,8 @@ turbo-tasks-env = { workspace = true }\n turbo-tasks-fs = { workspace = true }\n turbo-tasks-hash = { workspace = true }\n turbo-unix-path = { workspace = true }\n+url = { workspace = true }\n urlencoding = { workspace = true }\n-bytes-str = { workspace = true }\n \n \n [dev-dependencies]"
        },
        {
            "sha": "9329ad965ce5a017268c115a947f35c7bdead5d4",
            "filename": "turbopack/crates/turbopack-core/src/source_map/utils.rs",
            "status": "modified",
            "additions": 240,
            "deletions": 56,
            "changes": 296,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -1,14 +1,16 @@\n-use std::collections::HashSet;\n+use std::{borrow::Cow, collections::HashSet, iter};\n \n use anyhow::{Context, Result};\n use const_format::concatcp;\n use once_cell::sync::Lazy;\n use regex::Regex;\n use serde::{Deserialize, Serialize};\n+use serde_json::value::RawValue;\n use turbo_tasks::{ResolvedVc, ValueToString};\n use turbo_tasks_fs::{\n     DiskFileSystem, FileContent, FileSystemPath, rope::Rope, util::uri_from_file,\n };\n+use url::Url;\n \n use crate::SOURCE_URL_PROTOCOL;\n \n@@ -43,8 +45,9 @@ struct SourceMapSectionItemJson {\n     map: SourceMapJson,\n }\n \n-// TODO this could be made (much) more efficient by not even de- and serializing other fields\n-// (apart from `sources`) and just keep storing them as strings.\n+// Some of these values use `Box<RawValue>`: If we don't read these fields (or rarely read these\n+// fields) there's no point in decoding/encoding the data. Ideally they would be a `&RawValue`\n+// reference, but we deserialize using `from_reader`, which does not support that.\n #[derive(Serialize, Deserialize)]\n #[serde(rename_all = \"camelCase\")]\n struct SourceMapJson {\n@@ -57,91 +60,139 @@ struct SourceMapJson {\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n     sources: Option<Vec<Option<String>>>,\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n-    sources_content: Option<Vec<Option<String>>>,\n+    sources_content: Option<Vec<Option<Box<RawValue>>>>,\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n-    names: Option<Vec<String>>,\n+    names: Option<Box<RawValue>>,\n     // We just need to hold onto `mappings` for serialization/deserialization, so there's no point\n     // in decoding/encoding the string. Store it as a `RawValue`. Ideally this would be a reference\n     // to the RawValue, but we deserialize using `from_reader`, which does not support that.\n-    mappings: Box<serde_json::value::RawValue>,\n+    mappings: Box<RawValue>,\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n-    ignore_list: Option<Vec<u32>>,\n+    ignore_list: Option<Box<RawValue>>,\n \n     // A somewhat widespread non-standard extension\n-    debug_id: Option<String>,\n+    debug_id: Option<Box<RawValue>>,\n \n     #[serde(skip_serializing_if = \"Option::is_none\")]\n     sections: Option<Vec<SourceMapSectionItemJson>>,\n }\n \n-/// Replace the origin prefix in the `file` and `sources` with `turbopack:///` and read the the\n+/// Replace the origin prefix in the `file` and `sources` with `turbopack:///` and read the\n /// `sourceContent`s from disk.\n pub async fn resolve_source_map_sources(\n     map: Option<&Rope>,\n     origin: &FileSystemPath,\n ) -> Result<Option<Rope>> {\n-    let fs = &*format!(\"[{}]\", origin.fs().to_string().await?);\n-\n-    async fn resolve_source(\n-        original_source: &mut String,\n-        original_content: Option<&mut Option<String>>,\n-        fs: &str,\n-        origin: &FileSystemPath,\n-    ) -> Result<()> {\n-        if let Some(path) = origin.parent().try_join(original_source)? {\n-            let path_str = &path.path;\n-            let source = format!(\"{SOURCE_URL_PROTOCOL}///{fs}/{path_str}\");\n-            *original_source = source;\n-\n-            if let Some(original_content) = original_content\n-                && original_content.is_none()\n-            {\n-                if let FileContent::Content(file) = &*path.read().await? {\n-                    let text = file.content().to_str()?;\n-                    *original_content = Some(text.to_string())\n+    let fs_vc = origin.fs().to_resolved().await?;\n+    let fs_str = &*format!(\"[{}]\", fs_vc.to_string().await?);\n+\n+    let disk_fs = if let Some(fs_vc) = ResolvedVc::try_downcast_type::<DiskFileSystem>(fs_vc) {\n+        Some((fs_vc, fs_vc.await?))\n+    } else {\n+        None\n+    };\n+    let disk_fs = &disk_fs;\n+\n+    let resolve_source =\n+        async |source_url: &mut String, source_content: Option<&mut Option<Box<RawValue>>>| {\n+            // original_source should always be a URL (possibly a `file://` url). If it's a relative\n+            // URL, it should be relative to `origin` (the generated file that's being mapped).\n+            // https://developer.mozilla.org/en-US/docs/Learn_web_development/Howto/Web_mechanics/What_is_a_URL#absolute_urls_vs._relative_urls\n+            let maybe_file_url = if source_url.starts_with(\"//\") {\n+                // looks like a \"scheme-relative\" URL\n+                // Rewrite '//scheme/relative' -> 'file:///scheme/relative' (three slashes)\n+                Cow::Owned(format!(\"file:/{source_url}\"))\n+            } else if source_url.starts_with('/') {\n+                // looks like a \"domain-relative\" (aka \"server-relative\") URL\n+                // Rewrite '/domain/relative' -> 'file:///domain/relative' (three slashes)\n+                Cow::Owned(format!(\"file://{source_url}\"))\n+            } else {\n+                Cow::Borrowed(source_url)\n+            };\n+\n+            let fs_path = if let Ok(original_source_url_obj) = Url::parse(&maybe_file_url) {\n+                // We have an absolute URL, try to parse it as a `file://` URL\n+                if let Ok(sys_path) = original_source_url_obj.to_file_path() {\n+                    if let Some((disk_fs_vc, disk_fs)) = disk_fs {\n+                        disk_fs.try_from_sys_path(*disk_fs_vc, &sys_path, Some(origin))\n+                    } else {\n+                        None\n+                    }\n                 } else {\n-                    *original_content = Some(format!(\"unable to read source {fs}/{path_str}\"));\n+                    // this is an absolute URL with a non-`file://` scheme, just assume it's valid\n+                    // and don't modify anything\n+                    return Ok(());\n                 }\n+            } else {\n+                // assume it's a relative URL, and just remove any percent encoding from path\n+                // segments. Our internal path format is POSIX-like, without percent encoding.\n+                origin.parent().try_join(\n+                    &urlencoding::decode(source_url).unwrap_or(Cow::Borrowed(source_url)),\n+                )?\n+            };\n+\n+            if let Some(fs_path) = fs_path {\n+                // TODO: Encode `fs_str` and `fs_path_str` using `urlencoding`, so that these are\n+                // valid URLs. However, `project_trace_source_operation` (and `uri_from_file`) need\n+                // to handle percent encoding correctly first.\n+                let fs_path_str = &fs_path.path;\n+                *source_url = format!(\"{SOURCE_URL_PROTOCOL}///{fs_str}/{fs_path_str}\");\n+\n+                if let Some(source_content) = source_content\n+                    && source_content.is_none()\n+                {\n+                    if let FileContent::Content(file) = &*fs_path.read().await? {\n+                        let text = file.content().to_str()?;\n+                        *source_content = Some(unencoded_str_to_raw_value(&text));\n+                    } else {\n+                        *source_content = Some(unencoded_str_to_raw_value(&format!(\n+                            \"unable to read source {fs_str}/{fs_path_str}\"\n+                        )));\n+                    }\n+                }\n+            } else {\n+                // The URL was broken somehow, create a dummy `turbopack://` URL and content\n+                let origin_str = &origin.path;\n+                if let Some(source_content) = source_content\n+                    && source_content.is_none()\n+                {\n+                    *source_content = Some(unencoded_str_to_raw_value(&format!(\n+                        \"unable to access {source_url} in {fs_str}/{origin_str} (it's leaving the \\\n+                         filesystem root)\"\n+                    )));\n+                }\n+                static INVALID_REGEX: Lazy<Regex> =\n+                    Lazy::new(|| Regex::new(r#\"(?:^|/)(?:\\.\\.?(?:/|$))+\"#).unwrap());\n+                let source = INVALID_REGEX\n+                    .replace_all(source_url, |s: &regex::Captures<'_>| s[0].replace('.', \"_\"));\n+                *source_url = format!(\"{SOURCE_URL_PROTOCOL}///{fs_str}/{origin_str}/{source}\");\n             }\n-        } else {\n-            let origin_str = &origin.path;\n-            static INVALID_REGEX: Lazy<Regex> =\n-                Lazy::new(|| Regex::new(r#\"(?:^|/)(?:\\.\\.?(?:/|$))+\"#).unwrap());\n-            let source = INVALID_REGEX.replace_all(original_source, |s: &regex::Captures<'_>| {\n-                s[0].replace('.', \"_\")\n-            });\n-            *original_source = format!(\"{SOURCE_URL_PROTOCOL}///{fs}/{origin_str}/{source}\");\n-            if let Some(original_content) = original_content\n-                && original_content.is_none()\n-            {\n-                *original_content = Some(format!(\n-                    \"unable to access {original_source} in {fs}/{origin_str} (it's leaving the \\\n-                     filesystem root)\"\n-                ));\n-            }\n-        }\n-        anyhow::Ok(())\n-    }\n+            anyhow::Ok(())\n+        };\n \n-    async fn resolve_map(map: &mut SourceMapJson, fs: &str, origin: &FileSystemPath) -> Result<()> {\n+    let resolve_map = async |map: &mut SourceMapJson| {\n         if let Some(sources) = &mut map.sources {\n             let mut contents = if let Some(mut contents) = map.sources_content.take() {\n                 contents.resize(sources.len(), None);\n                 contents\n             } else {\n-                Vec::with_capacity(sources.len())\n+                iter::repeat_n(None, sources.len()).collect()\n             };\n \n             for (source, content) in sources.iter_mut().zip(contents.iter_mut()) {\n                 if let Some(source) = source {\n-                    resolve_source(source, Some(content), fs, origin).await?;\n+                    if let Some(source_root) = &map.source_root {\n+                        *source = format!(\"{source_root}{source}\");\n+                    }\n+                    resolve_source(source, Some(content)).await?;\n                 }\n             }\n \n+            map.source_root = None;\n             map.sources_content = Some(contents);\n         }\n-        Ok(())\n-    }\n+        anyhow::Ok(())\n+    };\n \n     let Some(map) = map else {\n         return Ok(None);\n@@ -153,18 +204,26 @@ pub async fn resolve_source_map_sources(\n     };\n \n     if let Some(file) = &mut map.file {\n-        resolve_source(file, None, fs, origin).await?;\n+        resolve_source(file, None).await?;\n     }\n \n-    resolve_map(&mut map, fs, origin).await?;\n+    resolve_map(&mut map).await?;\n     for section in map.sections.iter_mut().flatten() {\n-        resolve_map(&mut section.map, fs, origin).await?;\n+        resolve_map(&mut section.map).await?;\n     }\n \n     let map = Rope::from(serde_json::to_vec(&map)?);\n     Ok(Some(map))\n }\n \n+fn unencoded_str_to_raw_value(unencoded: &str) -> Box<RawValue> {\n+    RawValue::from_string(\n+        serde_json::to_string(unencoded)\n+            .expect(\"serialization of a utf-8 string should always succeed\"),\n+    )\n+    .expect(\"serde_json::to_string should produce valid JSON\")\n+}\n+\n /// Turns `turbopack:///[project]` references in sourcemap sources into absolute `file://` uris. This\n /// is useful for debugging environments.\n pub async fn fileify_source_map(\n@@ -208,3 +267,128 @@ pub async fn fileify_source_map(\n \n     Ok(Some(map))\n }\n+\n+#[cfg(test)]\n+mod tests {\n+    use std::path::Path;\n+\n+    use turbo_rcstr::{RcStr, rcstr};\n+    use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n+    use turbo_tasks_fs::FileSystem;\n+\n+    use super::*;\n+\n+    fn source_map_rope<'a>(\n+        source_root: Option<&str>,\n+        sources: impl IntoIterator<Item = &'a str>,\n+    ) -> Rope {\n+        Rope::from(\n+            serde_json::to_string_pretty(\n+                &serde_json::from_value::<SourceMapJson>(serde_json::json!({\n+                    \"version\": 3,\n+                    \"mappings\": \"\",\n+                    \"sourceRoot\": source_root,\n+                    \"sources\": sources.into_iter().map(Some).collect::<Vec<_>>(),\n+                }))\n+                .unwrap(),\n+            )\n+            .unwrap(),\n+        )\n+    }\n+\n+    #[tokio::test(flavor = \"multi_thread\", worker_threads = 2)]\n+    async fn test_resolve_source_map_sources() {\n+        let sys_root = if cfg!(windows) {\n+            Path::new(r\"C:\\fake\\root\")\n+        } else {\n+            Path::new(r\"/fake/root\")\n+        };\n+        let url_root = Url::from_directory_path(sys_root).unwrap();\n+\n+        let tt = turbo_tasks::TurboTasks::new(TurboTasksBackend::new(\n+            BackendOptions::default(),\n+            noop_backing_storage(),\n+        ));\n+        tt.run_once(async move {\n+            let fs_root_path =\n+                DiskFileSystem::new(rcstr!(\"mock\"), RcStr::from(sys_root.to_str().unwrap()))\n+                    .root()\n+                    .await?;\n+\n+            let resolved_source_map: SourceMapJson = serde_json::from_str(\n+                &resolve_source_map_sources(\n+                    Some(&source_map_rope(\n+                        /* source_root */ None,\n+                        [\n+                            \"page.js\",\n+                            \"./current-dir-page.js\",\n+                            \"../other%20route/page.js\",\n+                            // contains the file:// protocol/scheme\n+                            url_root.join(\"absolute%20file%20url.js\").unwrap().as_str(),\n+                            // A server-relative path starting with `/`, potentially includes a\n+                            // windows disk\n+                            &format!(\"{}/server%20relative%20path.js\", url_root.path()),\n+                            // A scheme-relative path\n+                            url_root\n+                                .join(\"scheme%20relative%20path.js\")\n+                                .unwrap()\n+                                .as_str()\n+                                .strip_prefix(\"file:\")\n+                                .unwrap(),\n+                            // non-file URLs are preserved\n+                            \"https://example.com/page%20path.js\",\n+                        ],\n+                    )),\n+                    // NOTE: the percent encoding here should NOT be decoded, as this is not part\n+                    // of a `file://` URL\n+                    &fs_root_path.join(\"app/source%20mapped/page.js\").unwrap(),\n+                )\n+                .await?\n+                .unwrap()\n+                .to_str()\n+                .unwrap(),\n+            )\n+            .unwrap();\n+\n+            let prefix = format!(\"{SOURCE_URL_PROTOCOL}///[mock]\");\n+            assert_eq!(\n+                resolved_source_map.sources,\n+                Some(vec![\n+                    Some(format!(\"{prefix}/app/source%20mapped/page.js\")),\n+                    Some(format!(\"{prefix}/app/source%20mapped/current-dir-page.js\")),\n+                    Some(format!(\"{prefix}/app/other route/page.js\")),\n+                    Some(format!(\"{prefix}/absolute file url.js\")),\n+                    Some(format!(\"{prefix}/server relative path.js\")),\n+                    Some(format!(\"{prefix}/scheme relative path.js\")),\n+                    Some(\"https://example.com/page%20path.js\".to_owned()),\n+                ])\n+            );\n+\n+            // try with a `source_root`\n+            let resolved_source_map: SourceMapJson = serde_json::from_str(\n+                &resolve_source_map_sources(\n+                    Some(&source_map_rope(\n+                        // NOTE: these should get literally concated, a slash should NOT get added.\n+                        Some(\"../source%20root%20\"),\n+                        [\"page.js\"],\n+                    )),\n+                    &fs_root_path.join(\"app/page.js\").unwrap(),\n+                )\n+                .await?\n+                .unwrap()\n+                .to_str()\n+                .unwrap(),\n+            )\n+            .unwrap();\n+\n+            assert_eq!(\n+                resolved_source_map.sources,\n+                Some(vec![Some(format!(\"{prefix}/source root page.js\")),])\n+            );\n+\n+            anyhow::Ok(())\n+        })\n+        .await\n+        .unwrap();\n+    }\n+}"
        },
        {
            "sha": "88ae598618c4279ea8eda3e7d09e2ab234eb081f",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/source_maps/input-source-map/output/780ce_turbopack-tests_tests_snapshot_source_maps_input-source-map_input_4f68fe02._.js.map",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finput-source-map%2Foutput%2F780ce_turbopack-tests_tests_snapshot_source_maps_input-source-map_input_4f68fe02._.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/c1967707aba2bba32a04d806474e69b077e0592a/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finput-source-map%2Foutput%2F780ce_turbopack-tests_tests_snapshot_source_maps_input-source-map_input_4f68fe02._.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fsource_maps%2Finput-source-map%2Foutput%2F780ce_turbopack-tests_tests_snapshot_source_maps_input-source-map_input_4f68fe02._.js.map?ref=c1967707aba2bba32a04d806474e69b077e0592a",
            "patch": "@@ -2,6 +2,6 @@\n   \"version\": 3,\n   \"sources\": [],\n   \"sections\": [\n-    {\"offset\": {\"line\": 4, \"column\": 0}, \"map\": {\"version\":3,\"file\":\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/input-source-map/input/sourcemapped.js\",\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/input-source-map/input/sourcemapped.ts\"],\"sourceRoot\":\"\",\"sourcesContent\":[\"// Compile with pnpm tsc turbopack/crates/turbopack-tests/tests/snapshot/source_maps/input-source-map-merged/input/sourcemapped.ts --sourceMap --inlineSources --target esnext\\n// tsc compile errors can be ignored\\ntype Fn<T> = () => T\\nexport function runExternalSourceMapped<T>(fn: Fn<T>): T {\\n  return fn()\\n}\\n\"],\"names\":[],\"mappings\":\";;;;AAGM,SAAU,uBAAuB,CAAI,EAAS;IAClD,OAAO,EAAE,EAAE,CAAA;AACb,CAAC\"}},\n+    {\"offset\": {\"line\": 4, \"column\": 0}, \"map\": {\"version\":3,\"file\":\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/input-source-map/input/sourcemapped.js\",\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/input-source-map/input/sourcemapped.ts\"],\"sourcesContent\":[\"// Compile with pnpm tsc turbopack/crates/turbopack-tests/tests/snapshot/source_maps/input-source-map-merged/input/sourcemapped.ts --sourceMap --inlineSources --target esnext\\n// tsc compile errors can be ignored\\ntype Fn<T> = () => T\\nexport function runExternalSourceMapped<T>(fn: Fn<T>): T {\\n  return fn()\\n}\\n\"],\"names\":[],\"mappings\":\";;;;AAGM,SAAU,uBAAuB,CAAI,EAAS;IAClD,OAAO,EAAE,EAAE,CAAA;AACb,CAAC\"}},\n     {\"offset\": {\"line\": 15, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/source_maps/input-source-map/input/index.js\"],\"sourcesContent\":[\"import { runExternalSourceMapped } from './sourcemapped.js'\\n\\nrunExternalSourceMapped()\\n\"],\"names\":[],\"mappings\":\";AAAA;;AAEA,IAAA,qPAAuB\"}}]\n }\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 733,
        "additions": 450,
        "deletions": 283
    }
}