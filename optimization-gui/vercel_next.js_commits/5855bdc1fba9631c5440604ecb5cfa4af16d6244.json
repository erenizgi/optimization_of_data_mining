{
    "author": "huozhi",
    "message": "[errors] fix edge server initial error is not sent via hmr (#78415)",
    "sha": "5855bdc1fba9631c5440604ecb5cfa4af16d6244",
    "files": [
        {
            "sha": "02a9f3414bcffbf14d0c1917b0d900c0d2ddf78c",
            "filename": "packages/next/src/server/dev/hot-middleware.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5855bdc1fba9631c5440604ecb5cfa4af16d6244/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5855bdc1fba9631c5440604ecb5cfa4af16d6244/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts?ref=5855bdc1fba9631c5440604ecb5cfa4af16d6244",
            "patch": "@@ -172,10 +172,10 @@ export class WebpackHotMiddleware {\n   }\n \n   onEdgeServerDone = (statsResult: webpack.Stats) => {\n+    if (this.closed) return\n     if (!isMiddlewareStats(statsResult)) {\n       this.onServerInvalid()\n       this.onServerDone(statsResult)\n-      return\n     }\n \n     if (statsResult.hasErrors()) {"
        },
        {
            "sha": "95970f7861dab7a2a2692bcec37295478cf2f0cc",
            "filename": "test/development/app-dir/ssr-in-rsc/ssr-in-rsc.test.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 30,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/5855bdc1fba9631c5440604ecb5cfa4af16d6244/test%2Fdevelopment%2Fapp-dir%2Fssr-in-rsc%2Fssr-in-rsc.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5855bdc1fba9631c5440604ecb5cfa4af16d6244/test%2Fdevelopment%2Fapp-dir%2Fssr-in-rsc%2Fssr-in-rsc.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fssr-in-rsc%2Fssr-in-rsc.test.ts?ref=5855bdc1fba9631c5440604ecb5cfa4af16d6244",
            "patch": "@@ -266,44 +266,48 @@ describe('react-dom/server in React Server environment', () => {\n     )\n \n     if (isTurbopack) {\n-      await assertHasRedbox(browser)\n-    } else {\n-      // FIXME: why no redbox when there is an error?\n-      await assertNoRedbox(browser)\n-      // error happens too early it seems to be caught by browser.log()\n-      // but the layout not being rendered indicates that it actually crashed\n-      expect(await browser.elementByCss('body').text()).toMatchInlineSnapshot(\n-        `\"\"`\n-      )\n-    }\n-    const redbox = {\n-      description: await getRedboxDescription(browser),\n-      source: await getRedboxSource(browser),\n-    }\n-    if (isTurbopack) {\n-      expect(redbox).toMatchInlineSnapshot(`\n+      expect(browser).toDisplayRedbox(`\n        {\n          \"description\": \"Ecmascript file had an error\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n          \"source\": \"./app/exports/app-code/react-dom-server-edge-implicit/page.js (3:1)\n        Ecmascript file had an error\n-         1 | import * as ReactDOMServerEdge from 'react-dom/server'\n-         2 | // Fine to drop once React is on ESM\n        > 3 | import ReactDOMServerEdgeDefault from 'react-dom/server'\n-           | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-         4 |\n-         5 | export const runtime = 'edge'\n-         6 |\n-\n-       You're importing a component that imports react-dom/server. To fix it, render or return the content directly as a Server Component instead for perf and security.\n-       Learn more: https://nextjs.org/docs/app/building-your-application/rendering\",\n+           | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\",\n+         \"stack\": [],\n        }\n       `)\n     } else {\n-      expect(redbox).toMatchInlineSnapshot(`\n-        {\n-          \"description\": null,\n-          \"source\": null,\n-        }\n+      // FIXME: the source map of source file path is not correct\n+      // Expected: `./app/exports/app-code/react-dom-server-edge-implicit/page.js`\n+      // Observed: `./node_modules/.pnpm/next@file+..+next-repo.../page.js?__next_edge_ssr_entry__\n+      expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"Error:   x You're importing a component that imports react-dom/server. To fix it, render or return the content directly as a Server Component instead for perf and security.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"<FIXME-nextjs-internal-source>\n+       Error:   x You're importing a component that imports react-dom/server. To fix it, render or return the content directly as a Server Component instead for perf and security.\n+         | Learn more: https://nextjs.org/docs/app/building-your-application/rendering\n+          ,-[1:1]\n+        1 | import * as ReactDOMServerEdge from 'react-dom/server'\n+          : ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+        2 | // Fine to drop once React is on ESM\n+        3 | import ReactDOMServerEdgeDefault from 'react-dom/server'\n+          \\`----\n+         x You're importing a component that imports react-dom/server. To fix it, render or return the content directly as a Server Component instead for perf and security.\n+         | Learn more: https://nextjs.org/docs/app/building-your-application/rendering\n+          ,-[3:1]\n+        1 | import * as ReactDOMServerEdge from 'react-dom/server'\n+        2 | // Fine to drop once React is on ESM\n+        3 | import ReactDOMServerEdgeDefault from 'react-dom/server'\n+          : ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n+        4 |\n+        5 | export const runtime = 'edge'\n+          \\`----\",\n+         \"stack\": [],\n+       }\n       `)\n     }\n   })"
        },
        {
            "sha": "4bae6482976232972abdaa77fcad8e96ff09143f",
            "filename": "test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 26,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/5855bdc1fba9631c5440604ecb5cfa4af16d6244/test%2Fe2e%2Fapp-dir%2Fuse-cache-segment-configs%2Fuse-cache-segment-configs.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5855bdc1fba9631c5440604ecb5cfa4af16d6244/test%2Fe2e%2Fapp-dir%2Fuse-cache-segment-configs%2Fuse-cache-segment-configs.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-segment-configs%2Fuse-cache-segment-configs.test.ts?ref=5855bdc1fba9631c5440604ecb5cfa4af16d6244",
            "patch": "@@ -1,10 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import {\n-  assertHasRedbox,\n-  assertNoRedbox,\n-  getRedboxDescription,\n-  getRedboxSource,\n-} from 'next-test-utils'\n+import { assertHasRedbox } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n describe('use-cache-segment-configs', () => {\n@@ -22,31 +17,40 @@ describe('use-cache-segment-configs', () => {\n     if (isNextDev) {\n       const browser = await next.browser('/runtime')\n \n-      if (isTurbopack) {\n-        await assertHasRedbox(browser)\n-\n-        const description = await getRedboxDescription(browser)\n-        expect(description).toMatchInlineSnapshot(\n-          `\"Ecmascript file had an error\"`\n-        )\n-        const source = await getRedboxSource(browser)\n+      await assertHasRedbox(browser)\n \n-        expect(source).toMatchInlineSnapshot(`\n-         \"./app/runtime/page.tsx (1:14)\n+      if (isTurbopack) {\n+        expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"Ecmascript file had an error\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./app/runtime/page.tsx (1:14)\n          Ecmascript file had an error\n          > 1 | export const runtime = 'edge'\n-             |              ^^^^^^^\n-           2 |\n-           3 | export default function Page() {\n-           4 |   return <div>This page uses \\`export const runtime\\`.</div>\n-\n-         Route segment config \"runtime\" is not compatible with \\`nextConfig.experimental.useCache\\`. Please remove it.\"\n+             |              ^^^^^^^\",\n+           \"stack\": [],\n+         }\n         `)\n       } else {\n-        // TODO(veil): Figure out why dev overlay is not shown with Webpack when\n-        // the runtime is 'edge'. It's possibly related to the import trace\n-        // being wrong (pointing at the Webpack loader resource).\n-        await assertNoRedbox(browser)\n+        // FIXME: Fix broken import trace for Webpack loader resource.\n+        expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"Error:   x Route segment config \"runtime\" is not compatible with \\`nextConfig.experimental.useCache\\`. Please remove it.\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"<FIXME-nextjs-internal-source>\n+         Error:   x Route segment config \"runtime\" is not compatible with \\`nextConfig.experimental.useCache\\`. Please remove it.\n+            ,-[1:1]\n+          1 | export const runtime = 'edge'\n+            :              ^^^^^^^\n+          2 |\n+          3 | export default function Page() {\n+          4 |   return <div>This page uses \\`export const runtime\\`.</div>\n+            \\`----\",\n+           \"stack\": [],\n+         }\n+        `)\n       }\n     } else {\n       const { cliOutput } = await next.build()"
        },
        {
            "sha": "3d7c8857bbb5256c5055d36e2506f3f05719a366",
            "filename": "test/lib/add-redbox-matchers.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/5855bdc1fba9631c5440604ecb5cfa4af16d6244/test%2Flib%2Fadd-redbox-matchers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5855bdc1fba9631c5440604ecb5cfa4af16d6244/test%2Flib%2Fadd-redbox-matchers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fadd-redbox-matchers.ts?ref=5855bdc1fba9631c5440604ecb5cfa4af16d6244",
            "patch": "@@ -134,6 +134,21 @@ async function createErrorSnapshot(\n         '<FIXME-project-root>'\n       )\n     }\n+\n+    // This is the processed path the nextjs file from node_modules,\n+    // likely not being processed properly and it's not deterministic among tests.\n+    // e.g. it could be a encoded url of loader path:\n+    // ../packages/next/dist/build/webpack/loaders/next-app-loader/index.js...\n+    const sourceLines = focusedSource.split('\\n')\n+    if (\n+      sourceLines[0].startsWith('./node_modules/.pnpm/next@file+') ||\n+      sourceLines[0].startsWith('./node_modules/.pnpm/file+')\n+    ) {\n+      focusedSource =\n+        `<FIXME-nextjs-internal-source>` +\n+        '\\n' +\n+        sourceLines.slice(1).join('\\n')\n+    }\n   }\n \n   const snapshot: ErrorSnapshot = {"
        }
    ],
    "stats": {
        "total": 137,
        "additions": 80,
        "deletions": 57
    }
}