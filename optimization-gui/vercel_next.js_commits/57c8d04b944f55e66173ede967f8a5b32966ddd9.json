{
    "author": "eps1lon",
    "message": "Create unique source URLs between Client and Server in Pages dir (#75878)\n\nThis ensures we don't accidentally return the sourcemap for the server code of a given file when a stackframe was created in the browser.\r\n\r\nThe Server vs Client case could be distinguished separately but not if we're dealing with externals in Edge and Node.js. We have to use the native `findSourceMap` for those case.\r\n\r\nThere's probably a valid factoring where we ask the correct compilation to avoid ambiguity but the bundler is really just a perf optimization. E.g. in `next start` and prerender of `next build` we don't have access to the bundler so native `findSourceMap` has to work.\r\n\r\nIt's not needed for Turbopack since source URLs are already unique it seems.\r\n\r\nThe actual test is in https://github.com/vercel/next.js/pull/75863 which wouldn't work without this change.",
    "sha": "57c8d04b944f55e66173ede967f8a5b32966ddd9",
    "files": [
        {
            "sha": "43e621612144c0c0c5f5ebbf76639b30ee85e998",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/57c8d04b944f55e66173ede967f8a5b32966ddd9/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/57c8d04b944f55e66173ede967f8a5b32966ddd9/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=57c8d04b944f55e66173ede967f8a5b32966ddd9",
            "patch": "@@ -869,7 +869,9 @@ export function finalizeEntrypoint({\n           ? WEBPACK_LAYERS.instrument\n           : isServerComponent\n             ? WEBPACK_LAYERS.reactServerComponents\n-            : undefined\n+            : name.startsWith('pages/')\n+              ? WEBPACK_LAYERS.pagesDirNode\n+              : undefined\n \n       return {\n         publicPath: isApi ? '' : undefined,\n@@ -884,7 +886,9 @@ export function finalizeEntrypoint({\n           ? WEBPACK_LAYERS.api\n           : isMiddlewareFilename(name) || isInstrumentation\n             ? WEBPACK_LAYERS.middleware\n-            : undefined,\n+            : name.startsWith('pages/')\n+              ? WEBPACK_LAYERS.pagesDirEdge\n+              : undefined,\n         library: { name: ['_ENTRIES', `middleware_[name]`], type: 'assign' },\n         runtime: EDGE_RUNTIME_WEBPACK,\n         asyncChunks: false,\n@@ -919,6 +923,7 @@ export function finalizeEntrypoint({\n             name.startsWith('pages/') && name !== 'pages/_app'\n               ? 'pages/_app'\n               : CLIENT_STATIC_FILES_RUNTIME_MAIN,\n+          layer: WEBPACK_LAYERS.pagesDirBrowser,\n           ...entry,\n         }\n       }\n@@ -930,7 +935,10 @@ export function finalizeEntrypoint({\n         }\n       }\n \n-      return entry\n+      return {\n+        layer: WEBPACK_LAYERS.pagesDirBrowser,\n+        ...entry,\n+      }\n     }\n     default: {\n       // Should never happen."
        },
        {
            "sha": "73647246f54783917f65b8c12144afd214c12769",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/57c8d04b944f55e66173ede967f8a5b32966ddd9/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/57c8d04b944f55e66173ede967f8a5b32966ddd9/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=57c8d04b944f55e66173ede967f8a5b32966ddd9",
            "patch": "@@ -1782,7 +1782,13 @@ export function isWebpackClientOnlyLayer(\n export function isWebpackDefaultLayer(\n   layer: WebpackLayerName | null | undefined\n ): boolean {\n-  return layer === null || layer === undefined\n+  return (\n+    layer === null ||\n+    layer === undefined ||\n+    layer === WEBPACK_LAYERS.pagesDirBrowser ||\n+    layer === WEBPACK_LAYERS.pagesDirEdge ||\n+    layer === WEBPACK_LAYERS.pagesDirNode\n+  )\n }\n \n export function isWebpackBundledLayer("
        },
        {
            "sha": "5d7707f7701397db8447d6ec8fa11c70aa61efcf",
            "filename": "packages/next/src/lib/constants.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/57c8d04b944f55e66173ede967f8a5b32966ddd9/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/57c8d04b944f55e66173ede967f8a5b32966ddd9/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts?ref=57c8d04b944f55e66173ede967f8a5b32966ddd9",
            "patch": "@@ -137,6 +137,18 @@ const WEBPACK_LAYERS_NAMES = {\n    * The browser client bundle layer for App directory.\n    */\n   appPagesBrowser: 'app-pages-browser',\n+  /**\n+   * The browser client bundle layer for Pages directory.\n+   */\n+  pagesDirBrowser: 'pages-dir-browser',\n+  /**\n+   * The Edge Lite bundle layer for Pages directory.\n+   */\n+  pagesDirEdge: 'pages-dir-edge',\n+  /**\n+   * The Node.js bundle layer for Pages directory.\n+   */\n+  pagesDirNode: 'pages-dir-node',\n } as const\n \n export type WebpackLayerName ="
        },
        {
            "sha": "9d2952604846de14fc26d7cfd180a39aaca13ec9",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/57c8d04b944f55e66173ede967f8a5b32966ddd9/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/57c8d04b944f55e66173ede967f8a5b32966ddd9/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=57c8d04b944f55e66173ede967f8a5b32966ddd9",
            "patch": "@@ -522,8 +522,8 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n                   stackTrace\n                 )?.[1]\n                 if (file) {\n-                  // `file` is filepath in `pages/` but it can be weird long webpack url in `app/`.\n-                  // If it's a webpack loader URL, it will start with '(app-pages)/./'\n+                  // `file` is filepath in `pages/` but it can be a webpack url.\n+                  // If it's a webpack loader URL, it will include the app-pages layer\n                   if (\n                     file.startsWith(`(${WEBPACK_LAYERS.appPagesBrowser})/./`)\n                   ) {\n@@ -539,6 +539,15 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n                     if (modules.length > 0) {\n                       fileMessage = ` when ${modules.join(', ')} changed`\n                     }\n+                  } else if (\n+                    // Handle known webpack layers\n+                    file.startsWith(`(${WEBPACK_LAYERS.pagesDirBrowser})/./`)\n+                  ) {\n+                    const cleanedFilePath = file.slice(\n+                      `(${WEBPACK_LAYERS.pagesDirBrowser})/`.length\n+                    )\n+\n+                    fileMessage = ` when ${cleanedFilePath} changed`\n                   } else {\n                     fileMessage = ` when ${file} changed`\n                   }"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 41,
        "deletions": 6
    }
}