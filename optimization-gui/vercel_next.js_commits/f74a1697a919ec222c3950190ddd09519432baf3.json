{
    "author": "acdlite",
    "message": "[Segment Cache] Support dynamic head prefetching (#81677)\n\nFixes an issue where opting into dynamic prefetching with\nprefetch={true} would not apply to head data (like the title), only the\npage data. Although the head was being sent by the server as part of the\nprefetch response, it wasn't being transferred correctly to the prefetch\ncache.\n\nThe net result is that you can now fully prefetch a page with a dynamic\ntitle without any additional network requests on navigation.",
    "sha": "f74a1697a919ec222c3950190ddd09519432baf3",
    "files": [
        {
            "sha": "16efe06352b5eca34184eaad157cf7053f1155fc",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 8,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/f74a1697a919ec222c3950190ddd09519432baf3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f74a1697a919ec222c3950190ddd09519432baf3/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=f74a1697a919ec222c3950190ddd09519432baf3",
            "patch": "@@ -1534,6 +1534,16 @@ function writeDynamicRenderResponseIntoCache(\n     // TODO: We should cache this, too, so that the MPA navigation is immediate.\n     return null\n   }\n+\n+  const staleTimeHeaderSeconds = response.headers.get(\n+    NEXT_ROUTER_STALE_TIME_HEADER\n+  )\n+  const staleTimeMs =\n+    staleTimeHeaderSeconds !== null\n+      ? parseInt(staleTimeHeaderSeconds, 10) * 1000\n+      : STATIC_STALETIME_MS\n+  const staleAt = now + staleTimeMs\n+\n   for (const flightData of flightDatas) {\n     const seedData = flightData.seedData\n     if (seedData !== null) {\n@@ -1555,24 +1565,36 @@ function writeDynamicRenderResponseIntoCache(\n           encodeSegment(segment)\n         )\n       }\n-      const staleTimeHeaderSeconds = response.headers.get(\n-        NEXT_ROUTER_STALE_TIME_HEADER\n-      )\n-      const staleTimeMs =\n-        staleTimeHeaderSeconds !== null\n-          ? parseInt(staleTimeHeaderSeconds, 10) * 1000\n-          : STATIC_STALETIME_MS\n+\n       writeSeedDataIntoCache(\n         now,\n         task,\n         route,\n-        now + staleTimeMs,\n+        staleAt,\n         seedData,\n         isResponsePartial,\n         segmentKey,\n         spawnedEntries\n       )\n     }\n+\n+    // During a dynamic request, the server sends back new head data for the\n+    // page. Overwrite the existing head with the new one. Note that we're\n+    // intentionally not taking into account whether the existing head is\n+    // already complete, even though the incoming head might not have finished\n+    // streaming in yet. This is to prioritize consistency of the head with\n+    // the segment data (though it's still not a guarantee, since some of the\n+    // segment data may be reused from a previous request).\n+    route.head = flightData.head\n+    route.isHeadPartial = flightData.isHeadPartial\n+    // TODO: Currently the stale time of the route tree represents the\n+    // stale time of both the route tree *and* all the segment data. So we\n+    // can't just overwrite this field; we have to use whichever value is\n+    // lower. In the future, though, the plan is to track segment lifetimes\n+    // separately from the route tree lifetime.\n+    if (staleAt < route.staleAt) {\n+      route.staleAt = staleAt\n+    }\n   }\n   // Any entry that's still pending was intentionally not rendered by the\n   // server, because it was inside the loading boundary. Mark them as rejected"
        },
        {
            "sha": "1c3c2e2ac774418b00d4f43ca7c55806d7ed184e",
            "filename": "test/e2e/app-dir/segment-cache/incremental-opt-in/app/page.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/f74a1697a919ec222c3950190ddd09519432baf3/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f74a1697a919ec222c3950190ddd09519432baf3/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fapp%2Fpage.tsx?ref=f74a1697a919ec222c3950190ddd09519432baf3",
            "patch": "@@ -43,6 +43,14 @@ export default function Page() {\n             </li>\n           </ul>\n         </li>\n+        <li>\n+          <LinkAccordion\n+            prefetch={true}\n+            href=\"/ppr-disabled-dynamic-head?foo=yay\"\n+          >\n+            Page with PPR disabled and a dynamic head, prefetch=true\n+          </LinkAccordion>\n+        </li>\n       </ul>\n     </>\n   )"
        },
        {
            "sha": "3d3488f4b41d5e4e430af5cc5a0ddcc26da3e953",
            "filename": "test/e2e/app-dir/segment-cache/incremental-opt-in/app/ppr-disabled-dynamic-head/page.tsx",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/f74a1697a919ec222c3950190ddd09519432baf3/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fapp%2Fppr-disabled-dynamic-head%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f74a1697a919ec222c3950190ddd09519432baf3/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fapp%2Fppr-disabled-dynamic-head%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fapp%2Fppr-disabled-dynamic-head%2Fpage.tsx?ref=f74a1697a919ec222c3950190ddd09519432baf3",
            "patch": "@@ -0,0 +1,27 @@\n+import { Suspense } from 'react'\n+import { connection } from 'next/server'\n+import { Metadata } from 'next'\n+\n+export async function generateMetadata({\n+  searchParams,\n+}: {\n+  searchParams: Promise<{ foo: string }>\n+}): Promise<Metadata> {\n+  const { foo } = await searchParams\n+  return {\n+    title: 'Dynamic Title: ' + (foo ?? '(empty)'),\n+  }\n+}\n+\n+async function Content() {\n+  await connection()\n+  return <div id=\"page-content\">Page content</div>\n+}\n+\n+export default function PPRDisabledDynamicHead() {\n+  return (\n+    <Suspense fallback=\"Loading...\">\n+      <Content />\n+    </Suspense>\n+  )\n+}"
        },
        {
            "sha": "a7cad8ea2599b15c6e53a3318701edbcecfc95b3",
            "filename": "test/e2e/app-dir/segment-cache/incremental-opt-in/segment-cache-incremental-opt-in.test.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/f74a1697a919ec222c3950190ddd09519432baf3/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f74a1697a919ec222c3950190ddd09519432baf3/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fincremental-opt-in%2Fsegment-cache-incremental-opt-in.test.ts?ref=f74a1697a919ec222c3950190ddd09519432baf3",
            "patch": "@@ -475,4 +475,41 @@ describe('segment cache (incremental opt in)', () => {\n       )\n     }\n   )\n+\n+  it('fully prefetch a page with a dynamic title', async () => {\n+    let act\n+    const browser = await next.browser('/', {\n+      beforePageLoad(p) {\n+        act = createRouterAct(p)\n+      },\n+    })\n+\n+    await act(\n+      async () => {\n+        const checkbox = await browser.elementByCss(\n+          'input[data-link-accordion=\"/ppr-disabled-dynamic-head?foo=yay\"]'\n+        )\n+        await checkbox.click()\n+      },\n+      // Because the link is prefetched with prefetch=true, we should be able to\n+      // prefetch the title, even though it's dynamic.\n+      {\n+        includes: 'Dynamic Title: yay',\n+      }\n+    )\n+\n+    // When we navigate to the page, it should not make any additional\n+    // network requests, because both the segment data and the head were\n+    // fully prefetched.\n+    await act(async () => {\n+      const link = await browser.elementByCss(\n+        'a[href=\"/ppr-disabled-dynamic-head?foo=yay\"]'\n+      )\n+      await link.click()\n+      const pageContent = await browser.elementById('page-content')\n+      expect(await pageContent.text()).toBe('Page content')\n+      const title = await browser.eval(() => document.title)\n+      expect(title).toBe('Dynamic Title: yay')\n+    }, 'no-requests')\n+  })\n })"
        }
    ],
    "stats": {
        "total": 110,
        "additions": 102,
        "deletions": 8
    }
}