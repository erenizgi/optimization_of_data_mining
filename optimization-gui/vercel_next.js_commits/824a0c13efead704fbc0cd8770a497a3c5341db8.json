{
    "author": "huozhi",
    "message": "[next-server] preserve rsc query for rsc redirects (#77963)",
    "sha": "824a0c13efead704fbc0cd8770a497a3c5341db8",
    "files": [
        {
            "sha": "be6c7f188461812ffc606b3d7b14212d91cbe083",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/824a0c13efead704fbc0cd8770a497a3c5341db8/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/824a0c13efead704fbc0cd8770a497a3c5341db8/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts?ref=824a0c13efead704fbc0cd8770a497a3c5341db8",
            "patch": "@@ -11,7 +11,6 @@ import {\n   INTERCEPTION_ROUTE_MARKERS,\n   isInterceptionRouteAppPath,\n } from './interception-routes'\n-import { NEXT_RSC_UNION_QUERY } from '../../../../client/components/app-router-headers'\n import { getCookieParser } from '../../../../server/api-utils/get-cookie-parser'\n import type { Params } from '../../../../server/request/params'\n \n@@ -210,8 +209,6 @@ export function prepareDestination(args: {\n   query: NextParsedUrlQuery\n }) {\n   const query = Object.assign({}, args.query)\n-  delete query[NEXT_RSC_UNION_QUERY]\n-\n   const parsedDestination = parseDestination(args)\n \n   const { hostname: destHostname, query: destQuery } = parsedDestination"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/rsc-query-routing/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Flayout.tsx?ref=824a0c13efead704fbc0cd8770a497a3c5341db8",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "f84a197b7a0cd7317047f90365e429a6410a7771",
            "filename": "test/e2e/app-dir/rsc-query-routing/app/redirect/dest/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Fredirect%2Fdest%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Fredirect%2Fdest%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Fredirect%2Fdest%2Fpage.tsx?ref=824a0c13efead704fbc0cd8770a497a3c5341db8",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Page() {\n+  return (\n+    <div>\n+      <h1>Redirect Dest</h1>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "3e5c8cbb4ddc604eff8dd154e24b5914277181f8",
            "filename": "test/e2e/app-dir/rsc-query-routing/app/redirect/page.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Fredirect%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Fredirect%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Fredirect%2Fpage.tsx?ref=824a0c13efead704fbc0cd8770a497a3c5341db8",
            "patch": "@@ -0,0 +1,14 @@\n+import Link from 'next/link'\n+\n+export default function Home() {\n+  return (\n+    <div>\n+      {/* disable prefetch to align the dev/prod fetching behavior,\n+       it's easier for writing tests */}\n+      Go to{' '}\n+      <Link prefetch={false} href=\"/redirect/source\">\n+        Redirect Link\n+      </Link>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "1a5726720fde27835021f805dadde5378ba87455",
            "filename": "test/e2e/app-dir/rsc-query-routing/app/rewrite/dest/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Frewrite%2Fdest%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Frewrite%2Fdest%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Frewrite%2Fdest%2Fpage.tsx?ref=824a0c13efead704fbc0cd8770a497a3c5341db8",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Page() {\n+  return (\n+    <div>\n+      <h1>Rewrite Dest</h1>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "0a36a772849f2c4505769e61b960c7a33d42e789",
            "filename": "test/e2e/app-dir/rsc-query-routing/app/rewrite/page.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Frewrite%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Frewrite%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fapp%2Frewrite%2Fpage.tsx?ref=824a0c13efead704fbc0cd8770a497a3c5341db8",
            "patch": "@@ -0,0 +1,14 @@\n+import Link from 'next/link'\n+\n+export default function Home() {\n+  return (\n+    <div>\n+      {/* disable prefetch to align the dev/prod fetching behavior,\n+       it's easier for writing tests */}\n+      Go to{' '}\n+      <Link prefetch={false} href=\"/rewrite/source\">\n+        Rewrite Link\n+      </Link>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "3257a01f9d9aa04c1b11a0d95cf6d6d291b2846c",
            "filename": "test/e2e/app-dir/rsc-query-routing/next.config.js",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Fnext.config.js?ref=824a0c13efead704fbc0cd8770a497a3c5341db8",
            "patch": "@@ -0,0 +1,25 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  reactStrictMode: true,\n+  async redirects() {\n+    return [\n+      {\n+        source: '/redirect/source',\n+        destination: '/redirect/dest',\n+        permanent: true,\n+      },\n+    ]\n+  },\n+  async rewrites() {\n+    return [\n+      {\n+        source: '/rewrite/source',\n+        destination: '/rewrite/dest',\n+      },\n+    ]\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "d80e586728114dc8cfd6ee9d2f3b5b701fd0ceec",
            "filename": "test/e2e/app-dir/rsc-query-routing/rsc-query-routing.test.ts",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Frsc-query-routing.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/824a0c13efead704fbc0cd8770a497a3c5341db8/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Frsc-query-routing.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-query-routing%2Frsc-query-routing.test.ts?ref=824a0c13efead704fbc0cd8770a497a3c5341db8",
            "patch": "@@ -0,0 +1,56 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n+import { Request } from 'playwright'\n+\n+describe('rsc-query-routing', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should contain rsc query in rsc request when redirect the page', async () => {\n+    const browser = await next.browser('/redirect')\n+\n+    const rscRequestUrls: string[] = []\n+    browser.on('request', (req: Request) => {\n+      if (req.url().includes('?_rsc=')) {\n+        rscRequestUrls.push(req.url())\n+      }\n+    })\n+\n+    // Click redirect link\n+    const link = await browser.elementByCss('a')\n+    await link.click()\n+\n+    // Wait for the page load to be completed\n+    await retry(async () => {\n+      expect(await browser.elementByCss('h1').text()).toBe('Redirect Dest')\n+    })\n+\n+    // The redirect source and dest urls should both contain the rsc query\n+    expect(rscRequestUrls[0]).toContain('/redirect/source')\n+    expect(rscRequestUrls[1]).toContain('/redirect/dest')\n+  })\n+\n+  it('should contain rsc query in rsc request when rewrite the page', async () => {\n+    const browser = await next.browser('/rewrite')\n+\n+    const rscRequestUrls: string[] = []\n+    browser.on('request', (req: Request) => {\n+      if (req.url().includes('?_rsc=')) {\n+        rscRequestUrls.push(req.url())\n+      }\n+    })\n+\n+    // Click redirect link\n+    const link = await browser.elementByCss('a')\n+    await link.click()\n+\n+    // Wait for the page load to be completed\n+    await retry(async () => {\n+      expect(await browser.elementByCss('h1').text()).toBe('Rewrite Dest')\n+    })\n+\n+    // The rewrite source url should contain the rsc query\n+    expect(rscRequestUrls[0]).toContain('/rewrite/source')\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 134,
        "additions": 131,
        "deletions": 3
    }
}