{
    "author": "unstubbable",
    "message": "Resolve request ID confusion (#85809)\n\nSetting the cache status for a page in dev mode is a sequential\noperation that only requires the HTML request ID to identify WebSocket\nclients across different browser tabs/windows. This is different from\nconnecting the React debug channel (after which the cache status\nhandling was modeled), which requires both the HTML request ID as well\nas the request ID to correctly associate debug chunks for a given client\nwith the matching request, which might be for the HTML document, a\nclient-side navigation, or a server function call.\n\nWith this PR, we're removing the unused `requestId` parameter from the\n`setCacheStatus` function. We're also renaming the WebSocket client's\nrequest ID to `htmlRequestId`, as well as renaming the associated maps\nand variables accordingly.\n\nThis avoids confusion and better reflects the purpose of these IDs. One\nof those confusions was apparent in the `setReactDebugChannel` methods,\nwhich is now cleared up as well.",
    "sha": "937a3246f214f5c7f648d90ff4df6e86dc982790",
    "files": [
        {
            "sha": "9a8c32533ad6f14203d287590bb806eb2fb105f8",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -792,7 +792,7 @@ async function generateDynamicFlightRenderResultWithStagesInDev(\n     // Before we kick off the render, we set the cache status back to it's initial state\n     // in case a previous render bypassed the cache.\n     if (setCacheStatus) {\n-      setCacheStatus('ready', htmlRequestId, requestId)\n+      setCacheStatus('ready', htmlRequestId)\n     }\n \n     const result = await renderWithRestartOnCacheMissInDev(\n@@ -812,7 +812,7 @@ async function generateDynamicFlightRenderResultWithStagesInDev(\n \n     // Set cache status to bypass when specifically bypassing caches in dev\n     if (setCacheStatus) {\n-      setCacheStatus('bypass', htmlRequestId, requestId)\n+      setCacheStatus('bypass', htmlRequestId)\n     }\n \n     debugChannel = setReactDebugChannel && createDebugChannel()\n@@ -2613,7 +2613,7 @@ async function renderToStream(\n           // This lets the client know not to cache anything based on this render.\n           if (renderOpts.setCacheStatus) {\n             // we know this is available  when cacheComponents is enabled, but typeguard to be safe\n-            renderOpts.setCacheStatus('bypass', htmlRequestId, requestId)\n+            renderOpts.setCacheStatus('bypass', htmlRequestId)\n           }\n           payload._bypassCachesInDev = createElement(WarnForBypassCachesInDev, {\n             route: workStore.route,\n@@ -3060,7 +3060,6 @@ async function renderWithRestartOnCacheMissInDev(\n   const {\n     htmlRequestId,\n     renderOpts,\n-    requestId,\n     componentMod: {\n       routeModule: {\n         userland: { loaderTree },\n@@ -3203,7 +3202,7 @@ async function renderWithRestartOnCacheMissInDev(\n   }\n \n   if (process.env.NODE_ENV === 'development' && setCacheStatus) {\n-    setCacheStatus('filling', htmlRequestId, requestId)\n+    setCacheStatus('filling', htmlRequestId)\n   }\n \n   // Cache miss. We will use the initial render to fill caches, and discard its result.\n@@ -3276,7 +3275,7 @@ async function renderWithRestartOnCacheMissInDev(\n   )\n \n   if (process.env.NODE_ENV === 'development' && setCacheStatus) {\n-    setCacheStatus('filled', htmlRequestId, requestId)\n+    setCacheStatus('filled', htmlRequestId)\n   }\n \n   return {"
        },
        {
            "sha": "8eb6a5a75d775f22237c2a6849e42c3cc303abae",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -109,11 +109,7 @@ export interface RenderOptsPartial {\n   }\n   isOnDemandRevalidate?: boolean\n   isPossibleServerAction?: boolean\n-  setCacheStatus?: (\n-    status: ServerCacheStatus,\n-    htmlRequestId: string,\n-    requestId: string\n-  ) => void\n+  setCacheStatus?: (status: ServerCacheStatus, htmlRequestId: string) => void\n   setIsrStatus?: (key: string, value: boolean | undefined) => void\n   setReactDebugChannel?: (\n     debugChannel: { readable: ReadableStream<Uint8Array> },"
        },
        {
            "sha": "a0a052b8426a1d8bcbf9df0bc78006b4dc6dec12",
            "filename": "packages/next/src/server/dev/debug-channel.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 14,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdebug-channel.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdebug-channel.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fdebug-channel.ts?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -9,21 +9,16 @@ export interface ReactDebugChannelForBrowser {\n   // Might also get a writable stream as return channel in the future.\n }\n \n-const reactDebugChannelsByRequestId = new Map<\n+const reactDebugChannelsByHtmlRequestId = new Map<\n   string,\n   ReactDebugChannelForBrowser\n >()\n \n export function connectReactDebugChannel(\n   requestId: string,\n+  debugChannel: ReactDebugChannelForBrowser,\n   sendToClient: (message: HmrMessageSentToBrowser) => void\n ) {\n-  const debugChannel = reactDebugChannelsByRequestId.get(requestId)\n-\n-  if (!debugChannel) {\n-    return\n-  }\n-\n   const reader = debugChannel.readable\n     .pipeThrough(\n       // We're sending the chunks in batches to reduce overhead in the browser.\n@@ -37,8 +32,6 @@ export function connectReactDebugChannel(\n       requestId,\n       chunk: null,\n     })\n-\n-    reactDebugChannelsByRequestId.delete(requestId)\n   }\n \n   const onError = (err: unknown) => {\n@@ -63,13 +56,30 @@ export function connectReactDebugChannel(\n   reader.read().then(progress, onError)\n }\n \n-export function setReactDebugChannel(\n-  requestId: string,\n+export function connectReactDebugChannelForHtmlRequest(\n+  htmlRequestId: string,\n+  sendToClient: (message: HmrMessageSentToBrowser) => void\n+) {\n+  const debugChannel = reactDebugChannelsByHtmlRequestId.get(htmlRequestId)\n+\n+  if (!debugChannel) {\n+    return\n+  }\n+\n+  reactDebugChannelsByHtmlRequestId.delete(htmlRequestId)\n+\n+  connectReactDebugChannel(htmlRequestId, debugChannel, sendToClient)\n+}\n+\n+export function setReactDebugChannelForHtmlRequest(\n+  htmlRequestId: string,\n   debugChannel: ReactDebugChannelForBrowser\n ) {\n-  reactDebugChannelsByRequestId.set(requestId, debugChannel)\n+  // TODO: Clean up after a timeout, in case the client never connects, e.g.\n+  // when CURL'ing the page, or loading the page with JavaScript disabled etc.\n+  reactDebugChannelsByHtmlRequestId.set(htmlRequestId, debugChannel)\n }\n \n-export function deleteReactDebugChannel(requestId: string) {\n-  reactDebugChannelsByRequestId.delete(requestId)\n+export function deleteReactDebugChannelForHtmlRequest(htmlRequestId: string) {\n+  reactDebugChannelsByHtmlRequestId.delete(htmlRequestId)\n }"
        },
        {
            "sha": "3a7e0623262b27d6c78e4208dc1c61b6e1dbc3d4",
            "filename": "packages/next/src/server/dev/hot-middleware.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 25,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-middleware.ts?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -71,8 +71,8 @@ function getStatsForSyncEvent(\n }\n \n export class WebpackHotMiddleware {\n-  private clientsWithoutRequestId = new Set<ws>()\n-  private clientsByRequestId: Map<string, ws> = new Map()\n+  private clientsWithoutHtmlRequestId = new Set<ws>()\n+  private clientsByHtmlRequestId: Map<string, ws> = new Map()\n   private closed = false\n   private clientLatestStats: { ts: number; stats: webpack.Stats } | null = null\n   private middlewareLatestStats: { ts: number; stats: webpack.Stats } | null =\n@@ -163,20 +163,20 @@ export class WebpackHotMiddleware {\n    * and we still want to show the client overlay with the error while\n    * the error page should be rendered just fine.\n    */\n-  onHMR = (client: ws, requestId: string | null) => {\n+  onHMR = (client: ws, htmlRequestId: string | null) => {\n     if (this.closed) return\n \n-    if (requestId) {\n-      this.clientsByRequestId.set(requestId, client)\n+    if (htmlRequestId) {\n+      this.clientsByHtmlRequestId.set(htmlRequestId, client)\n     } else {\n-      this.clientsWithoutRequestId.add(client)\n+      this.clientsWithoutHtmlRequestId.add(client)\n     }\n \n     client.addEventListener('close', () => {\n-      if (requestId) {\n-        this.clientsByRequestId.delete(requestId)\n+      if (htmlRequestId) {\n+        this.clientsByHtmlRequestId.delete(htmlRequestId)\n       } else {\n-        this.clientsWithoutRequestId.delete(client)\n+        this.clientsWithoutHtmlRequestId.delete(client)\n       }\n     })\n \n@@ -228,8 +228,8 @@ export class WebpackHotMiddleware {\n     })\n   }\n \n-  getClient = (requestId: string): ws | undefined => {\n-    return this.clientsByRequestId.get(requestId)\n+  getClient = (htmlRequestId: string): ws | undefined => {\n+    return this.clientsByHtmlRequestId.get(htmlRequestId)\n   }\n \n   publishToClient = (client: ws, message: HmrMessageSentToBrowser) => {\n@@ -251,8 +251,8 @@ export class WebpackHotMiddleware {\n     }\n \n     for (const wsClient of [\n-      ...this.clientsWithoutRequestId,\n-      ...this.clientsByRequestId.values(),\n+      ...this.clientsWithoutHtmlRequestId,\n+      ...this.clientsByHtmlRequestId.values(),\n     ]) {\n       this.publishToClient(wsClient, message)\n     }\n@@ -270,12 +270,12 @@ export class WebpackHotMiddleware {\n     // inferring it from the presence of a request ID.\n \n     if (!this.config.cacheComponents) {\n-      for (const wsClient of this.clientsByRequestId.values()) {\n+      for (const wsClient of this.clientsByHtmlRequestId.values()) {\n         this.publishToClient(wsClient, message)\n       }\n     }\n \n-    for (const wsClient of this.clientsWithoutRequestId) {\n+    for (const wsClient of this.clientsWithoutHtmlRequestId) {\n       this.publishToClient(wsClient, message)\n     }\n   }\n@@ -290,30 +290,35 @@ export class WebpackHotMiddleware {\n     this.closed = true\n \n     for (const wsClient of [\n-      ...this.clientsWithoutRequestId,\n-      ...this.clientsByRequestId.values(),\n+      ...this.clientsWithoutHtmlRequestId,\n+      ...this.clientsByHtmlRequestId.values(),\n     ]) {\n       // it's okay to not cleanly close these websocket connections, this is dev\n       wsClient.terminate()\n     }\n \n-    this.clientsWithoutRequestId.clear()\n-    this.clientsByRequestId.clear()\n+    this.clientsWithoutHtmlRequestId.clear()\n+    this.clientsByHtmlRequestId.clear()\n   }\n \n-  deleteClient = (client: ws, requestId: string | null) => {\n-    if (requestId) {\n-      this.clientsByRequestId.delete(requestId)\n+  deleteClient = (client: ws, htmlRequestId: string | null) => {\n+    if (htmlRequestId) {\n+      this.clientsByHtmlRequestId.delete(htmlRequestId)\n     } else {\n-      this.clientsWithoutRequestId.delete(client)\n+      this.clientsWithoutHtmlRequestId.delete(client)\n     }\n   }\n \n   hasClients = () => {\n-    return this.clientsWithoutRequestId.size + this.clientsByRequestId.size > 0\n+    return (\n+      this.clientsWithoutHtmlRequestId.size + this.clientsByHtmlRequestId.size >\n+      0\n+    )\n   }\n \n   getClientCount = () => {\n-    return this.clientsWithoutRequestId.size + this.clientsByRequestId.size\n+    return (\n+      this.clientsWithoutHtmlRequestId.size + this.clientsByHtmlRequestId.size\n+    )\n   }\n }"
        },
        {
            "sha": "82b8b18e1385fc57aa7d6e04b718200dabc848e9",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 71,
            "deletions": 51,
            "changes": 122,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -109,8 +109,9 @@ import {\n } from '../../next-devtools/server/devtools-config-middleware'\n import {\n   connectReactDebugChannel,\n-  deleteReactDebugChannel,\n-  setReactDebugChannel,\n+  connectReactDebugChannelForHtmlRequest,\n+  deleteReactDebugChannelForHtmlRequest,\n+  setReactDebugChannelForHtmlRequest,\n } from './debug-channel'\n import {\n   getVersionInfo,\n@@ -439,9 +440,9 @@ export async function createHotReloaderTurbopack(\n   let hmrEventHappened = false\n   let hmrHash = 0\n \n-  const clientsWithoutRequestId = new Set<ws>()\n-  const clientsByRequestId = new Map<string, ws>()\n-  const cacheStatusesByRequestId = new Map<string, ServerCacheStatus>()\n+  const clientsWithoutHtmlRequestId = new Set<ws>()\n+  const clientsByHtmlRequestId = new Map<string, ws>()\n+  const cacheStatusesByHtmlRequestId = new Map<string, ServerCacheStatus>()\n   const clientStates = new WeakMap<ws, ClientState>()\n \n   function sendToClient(client: ws, message: HmrMessageSentToBrowser) {\n@@ -465,8 +466,8 @@ export async function createHotReloaderTurbopack(\n     }\n \n     for (const client of [\n-      ...clientsWithoutRequestId,\n-      ...clientsByRequestId.values(),\n+      ...clientsWithoutHtmlRequestId,\n+      ...clientsByHtmlRequestId.values(),\n     ]) {\n       const state = clientStates.get(client)\n       if (!state) {\n@@ -501,8 +502,8 @@ export async function createHotReloaderTurbopack(\n \n   const sendHmr: SendHmr = (id: string, message: HmrMessageSentToBrowser) => {\n     for (const client of [\n-      ...clientsWithoutRequestId,\n-      ...clientsByRequestId.values(),\n+      ...clientsWithoutHtmlRequestId,\n+      ...clientsByHtmlRequestId.values(),\n     ]) {\n       clientStates.get(client)?.messages.set(id, message)\n     }\n@@ -519,8 +520,8 @@ export async function createHotReloaderTurbopack(\n     payload.issues = []\n \n     for (const client of [\n-      ...clientsWithoutRequestId,\n-      ...clientsByRequestId.values(),\n+      ...clientsWithoutHtmlRequestId,\n+      ...clientsByHtmlRequestId.values(),\n     ]) {\n       clientStates.get(client)?.turbopackUpdates.push(payload)\n     }\n@@ -683,7 +684,10 @@ export async function createHotReloaderTurbopack(\n         dev: {\n           assetMapper,\n           changeSubscriptions,\n-          clients: [...clientsWithoutRequestId, ...clientsByRequestId.values()],\n+          clients: [\n+            ...clientsWithoutHtmlRequestId,\n+            ...clientsByHtmlRequestId.values(),\n+          ],\n           clientStates,\n           serverFields,\n \n@@ -779,7 +783,7 @@ export async function createHotReloaderTurbopack(\n             distDir,\n             sendHmrMessage: (message) => hotReloader.send(message),\n             getActiveConnectionCount: () =>\n-              clientsWithoutRequestId.size + clientsByRequestId.size,\n+              clientsWithoutHtmlRequestId.size + clientsByHtmlRequestId.size,\n             getDevServerUrl: () => process.env.__NEXT_PRIVATE_ORIGIN,\n           }),\n         ]\n@@ -877,7 +881,7 @@ export async function createHotReloaderTurbopack(\n         const clientIssues: EntryIssuesMap = new Map()\n         const subscriptions: Map<string, AsyncIterator<any>> = new Map()\n \n-        const requestId = req.url\n+        const htmlRequestId = req.url\n           ? new URL(req.url, 'http://n').searchParams.get('id')\n           : null\n \n@@ -886,24 +890,24 @@ export async function createHotReloaderTurbopack(\n         // Router clients are also considered legacy clients. TODO: Maybe mark\n         // clients as App Router / Pages Router clients explicitly, instead of\n         // inferring it from the presence of a request ID.\n-        if (requestId) {\n-          clientsByRequestId.set(requestId, client)\n+        if (htmlRequestId) {\n+          clientsByHtmlRequestId.set(htmlRequestId, client)\n           const enableCacheComponents = nextConfig.cacheComponents\n           if (enableCacheComponents) {\n             onUpgrade(client, { isLegacyClient: false })\n-            const cacheStatus = cacheStatusesByRequestId.get(requestId)\n+            const cacheStatus = cacheStatusesByHtmlRequestId.get(htmlRequestId)\n             if (cacheStatus !== undefined) {\n               sendToClient(client, {\n                 type: HMR_MESSAGE_SENT_TO_BROWSER.CACHE_INDICATOR,\n                 state: cacheStatus,\n               })\n-              cacheStatusesByRequestId.delete(requestId)\n+              cacheStatusesByHtmlRequestId.delete(htmlRequestId)\n             }\n           } else {\n             onUpgrade(client, { isLegacyClient: true })\n           }\n         } else {\n-          clientsWithoutRequestId.add(client)\n+          clientsWithoutHtmlRequestId.add(client)\n           onUpgrade(client, { isLegacyClient: true })\n         }\n \n@@ -921,11 +925,11 @@ export async function createHotReloaderTurbopack(\n           }\n           clientStates.delete(client)\n \n-          if (requestId) {\n-            clientsByRequestId.delete(requestId)\n-            deleteReactDebugChannel(requestId)\n+          if (htmlRequestId) {\n+            clientsByHtmlRequestId.delete(htmlRequestId)\n+            deleteReactDebugChannelForHtmlRequest(htmlRequestId)\n           } else {\n-            clientsWithoutRequestId.delete(client)\n+            clientsWithoutHtmlRequestId.delete(client)\n           }\n         })\n \n@@ -1094,8 +1098,11 @@ export async function createHotReloaderTurbopack(\n \n           sendToClient(client, syncMessage)\n \n-          if (requestId) {\n-            connectReactDebugChannel(requestId, sendToClient.bind(null, client))\n+          if (htmlRequestId) {\n+            connectReactDebugChannelForHtmlRequest(\n+              htmlRequestId,\n+              sendToClient.bind(null, client)\n+            )\n           }\n         })()\n       })\n@@ -1105,8 +1112,8 @@ export async function createHotReloaderTurbopack(\n       const payload = JSON.stringify(action)\n \n       for (const client of [\n-        ...clientsWithoutRequestId,\n-        ...clientsByRequestId.values(),\n+        ...clientsWithoutHtmlRequestId,\n+        ...clientsByHtmlRequestId.values(),\n       ]) {\n         client.send(payload)\n       }\n@@ -1122,23 +1129,19 @@ export async function createHotReloaderTurbopack(\n       // inferring it from the presence of a request ID.\n \n       if (!nextConfig.cacheComponents) {\n-        for (const client of clientsByRequestId.values()) {\n+        for (const client of clientsByHtmlRequestId.values()) {\n           client.send(payload)\n         }\n       }\n \n-      for (const client of clientsWithoutRequestId) {\n+      for (const client of clientsWithoutHtmlRequestId) {\n         client.send(payload)\n       }\n     },\n \n-    setCacheStatus(\n-      status: ServerCacheStatus,\n-      htmlRequestId: string,\n-      requestId: string\n-    ): void {\n+    setCacheStatus(status: ServerCacheStatus, htmlRequestId: string): void {\n       // Legacy clients don't have Cache Components.\n-      const client = clientsByRequestId.get(htmlRequestId)\n+      const client = clientsByHtmlRequestId.get(htmlRequestId)\n       if (client !== undefined) {\n         sendToClient(client, {\n           type: HMR_MESSAGE_SENT_TO_BROWSER.CACHE_INDICATOR,\n@@ -1147,20 +1150,37 @@ export async function createHotReloaderTurbopack(\n       } else {\n         // If the client is not connected, store the status so that we can send it\n         // when the client connects.\n-        cacheStatusesByRequestId.set(requestId, status)\n+        cacheStatusesByHtmlRequestId.set(htmlRequestId, status)\n       }\n     },\n \n     setReactDebugChannel(debugChannel, htmlRequestId, requestId) {\n-      // Store the debug channel, regardless of whether the client is connected.\n-      setReactDebugChannel(requestId, debugChannel)\n-\n-      // If the client is connected, we can connect the debug channel\n-      // immediately. Otherwise, we'll do that when the client connects.\n-      const client = clientsByRequestId.get(htmlRequestId)\n-\n-      if (client) {\n-        connectReactDebugChannel(requestId, sendToClient.bind(null, client))\n+      const client = clientsByHtmlRequestId.get(htmlRequestId)\n+\n+      if (htmlRequestId === requestId) {\n+        // The debug channel is for the HTML request.\n+        if (client) {\n+          // If the client is connected, we can connect the debug channel for\n+          // the HTML request immediately.\n+          connectReactDebugChannel(\n+            htmlRequestId,\n+            debugChannel,\n+            sendToClient.bind(null, client)\n+          )\n+        } else {\n+          // Otherwise, we'll do that when the client connects and just store\n+          // the debug channel.\n+          setReactDebugChannelForHtmlRequest(htmlRequestId, debugChannel)\n+        }\n+      } else if (client) {\n+        // The debug channel is for a subsequent request (e.g. client-side\n+        // navigation for server function call). If the client is not connected\n+        // anymore, we don't need to connect the debug channel.\n+        connectReactDebugChannel(\n+          requestId,\n+          debugChannel,\n+          sendToClient.bind(null, client)\n+        )\n       }\n     },\n \n@@ -1400,14 +1420,14 @@ export async function createHotReloaderTurbopack(\n       recordMcpTelemetry(opts.telemetry)\n \n       for (const wsClient of [\n-        ...clientsWithoutRequestId,\n-        ...clientsByRequestId.values(),\n+        ...clientsWithoutHtmlRequestId,\n+        ...clientsByHtmlRequestId.values(),\n       ]) {\n         // it's okay to not cleanly close these websocket connections, this is dev\n         wsClient.terminate()\n       }\n-      clientsWithoutRequestId.clear()\n-      clientsByRequestId.clear()\n+      clientsWithoutHtmlRequestId.clear()\n+      clientsByHtmlRequestId.clear()\n     },\n   }\n \n@@ -1467,8 +1487,8 @@ export async function createHotReloaderTurbopack(\n           addErrors(errors, currentEntryIssues)\n \n           for (const client of [\n-            ...clientsWithoutRequestId,\n-            ...clientsByRequestId.values(),\n+            ...clientsWithoutHtmlRequestId,\n+            ...clientsByHtmlRequestId.values(),\n           ]) {\n             const state = clientStates.get(client)\n             if (!state) {"
        },
        {
            "sha": "b36b80761062a31a0fc724aabddcf9b74b50af87",
            "filename": "packages/next/src/server/dev/hot-reloader-types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-types.ts?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -229,11 +229,7 @@ export interface NextJsHotReloaderInterface {\n    * and App Router clients that don't have Cache Components enabled.\n    */\n   sendToLegacyClients(action: HmrMessageSentToBrowser): void\n-  setCacheStatus(\n-    status: ServerCacheStatus,\n-    htmlRequestId: string,\n-    requestId: string\n-  ): void\n+  setCacheStatus(status: ServerCacheStatus, htmlRequestId: string): void\n   setReactDebugChannel(\n     debugChannel: ReactDebugChannelForBrowser,\n     htmlRequestId: string,"
        },
        {
            "sha": "47b36eebd997aed1f8f0f5e44f13c2ed51cfcc96",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 23,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -99,8 +99,9 @@ import {\n import { InvariantError } from '../../shared/lib/invariant-error'\n import {\n   connectReactDebugChannel,\n-  deleteReactDebugChannel,\n-  setReactDebugChannel,\n+  connectReactDebugChannelForHtmlRequest,\n+  deleteReactDebugChannelForHtmlRequest,\n+  setReactDebugChannelForHtmlRequest,\n   type ReactDebugChannelForBrowser,\n } from './debug-channel'\n import {\n@@ -444,15 +445,15 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     ) => void\n   ) {\n     wsServer.handleUpgrade(req, req.socket, head, (client) => {\n-      const requestId = req.url\n+      const htmlRequestId = req.url\n         ? new URL(req.url, 'http://n').searchParams.get('id')\n         : null\n \n       if (!this.webpackHotMiddleware) {\n         throw new InvariantError('Did not start HotReloaderWebpack.')\n       }\n \n-      this.webpackHotMiddleware.onHMR(client, requestId)\n+      this.webpackHotMiddleware.onHMR(client, htmlRequestId)\n       this.onDemandEntries?.onHMR(client, () => this.hmrServerError)\n \n       const enableCacheComponents = this.config.cacheComponents\n@@ -461,7 +462,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       // Router clients are also considered legacy clients. TODO: Maybe mark\n       // clients as App Router / Pages Router clients explicitly, instead of\n       // inferring it from the presence of a request ID.\n-      const isLegacyClient = !requestId || !enableCacheComponents\n+      const isLegacyClient = !htmlRequestId || !enableCacheComponents\n \n       callback(client, { isLegacyClient })\n \n@@ -639,28 +640,28 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n         }\n       })\n \n-      if (requestId) {\n-        connectReactDebugChannel(\n-          requestId,\n+      if (htmlRequestId) {\n+        connectReactDebugChannelForHtmlRequest(\n+          htmlRequestId,\n           this.sendToClient.bind(this, client)\n         )\n         if (enableCacheComponents) {\n-          const status = this.cacheStatusesByRequestId.get(requestId)\n+          const status = this.cacheStatusesByRequestId.get(htmlRequestId)\n           if (status) {\n             this.sendToClient(client, {\n               type: HMR_MESSAGE_SENT_TO_BROWSER.CACHE_INDICATOR,\n               state: status,\n             })\n-            this.cacheStatusesByRequestId.delete(requestId)\n+            this.cacheStatusesByRequestId.delete(htmlRequestId)\n           }\n         }\n       }\n \n       client.on('close', () => {\n-        this.webpackHotMiddleware?.deleteClient(client, requestId)\n+        this.webpackHotMiddleware?.deleteClient(client, htmlRequestId)\n \n-        if (requestId) {\n-          deleteReactDebugChannel(requestId)\n+        if (htmlRequestId) {\n+          deleteReactDebugChannelForHtmlRequest(htmlRequestId)\n         }\n       })\n     })\n@@ -1748,8 +1749,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n \n   public setCacheStatus(\n     status: ServerCacheStatus,\n-    htmlRequestId: string,\n-    requestId: string\n+    htmlRequestId: string\n   ): void {\n     const client = this.webpackHotMiddleware?.getClient(htmlRequestId)\n     if (client !== undefined) {\n@@ -1760,7 +1760,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     } else {\n       // If the client is not connected, store the status so that we can send it\n       // when the client connects.\n-      this.cacheStatusesByRequestId.set(requestId, status)\n+      this.cacheStatusesByRequestId.set(htmlRequestId, status)\n     }\n   }\n \n@@ -1769,15 +1769,32 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     htmlRequestId: string,\n     requestId: string\n   ): void {\n-    // Store the debug channel, regardless of whether the client is connected.\n-    setReactDebugChannel(requestId, debugChannel)\n-\n-    // If the client is connected, we can connect the debug channel immediately.\n-    // Otherwise, we'll do that when the client connects.\n     const client = this.webpackHotMiddleware?.getClient(htmlRequestId)\n \n-    if (client) {\n-      connectReactDebugChannel(requestId, this.sendToClient.bind(this, client))\n+    if (htmlRequestId === requestId) {\n+      // The debug channel is for the HTML request.\n+      if (client) {\n+        // If the client is connected, we can connect the debug channel for\n+        // the HTML request immediately.\n+        connectReactDebugChannel(\n+          htmlRequestId,\n+          debugChannel,\n+          this.sendToClient.bind(this, client)\n+        )\n+      } else {\n+        // Otherwise, we'll do that when the client connects and just store\n+        // the debug channel.\n+        setReactDebugChannelForHtmlRequest(htmlRequestId, debugChannel)\n+      }\n+    } else if (client) {\n+      // The debug channel is for a subsequent request (e.g. client-side\n+      // navigation for server function call). If the client is not connected\n+      // anymore, we don't need to connect the debug channel.\n+      connectReactDebugChannel(\n+        requestId,\n+        debugChannel,\n+        this.sendToClient.bind(this, client)\n+      )\n     }\n   }\n "
        },
        {
            "sha": "24a0ceccad3cc9dac2b6d7632bae6865678d2254",
            "filename": "packages/next/src/server/lib/dev-bundler-service.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -98,10 +98,9 @@ export class DevBundlerService {\n \n   public setCacheStatus(\n     status: ServerCacheStatus,\n-    htmlRequestId: string,\n-    requestId: string\n+    htmlRequestId: string\n   ): void {\n-    this.bundler.hotReloader.setCacheStatus(status, htmlRequestId, requestId)\n+    this.bundler.hotReloader.setCacheStatus(status, htmlRequestId)\n   }\n \n   public setIsrStatus(key: string, value: boolean | undefined) {"
        },
        {
            "sha": "5718d78e25e8a1e83c63da579a46b4f805a8c4bd",
            "filename": "packages/next/src/server/lib/router-utils/router-server-context.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/937a3246f214f5c7f648d90ff4df6e86dc982790/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Frouter-server-context.ts?ref=937a3246f214f5c7f648d90ff4df6e86dc982790",
            "patch": "@@ -44,11 +44,7 @@ export type RouterServerContext = Record<\n       htmlRequestId: string,\n       requestId: string\n     ) => void\n-    setCacheStatus?: (\n-      status: ServerCacheStatus,\n-      htmlRequestId: string,\n-      requestId: string\n-    ) => void\n+    setCacheStatus?: (status: ServerCacheStatus, htmlRequestId: string) => void\n   }\n >\n "
        }
    ],
    "stats": {
        "total": 312,
        "additions": 175,
        "deletions": 137
    }
}