{
    "author": "unstubbable",
    "message": "Improve reliability of owner stacks for async I/O errors (#81501)\n\nWhen running the following test isolated, and not as part of the full\ntest suite, the owner stacks for async I/O errors were missing the\ntop-most stack frame that's pointing at the `fetch` call.\n\n```\npnpm test-dev test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts -t \"should show a collapsed redbox with two errors\"\n```\n\nThe same could be reproduced with `pnpm next dev\ntest/e2e/app-dir/dynamic-io-errors/fixtures/default` at\nhttp://localhost:3000/dynamic-root, unless http://localhost:3000/static\nwas visited first.\n\nThe likely reason for that is that React's async I/O tracking was\nrecently optimized for performance reasons in facebook/react#33736 and\nfacebook/react#33737.\n\nWe can help React a bit with the tracking by explicitly awaiting our\n`makeHangingPromise` calls. With this fix, the case from above reliably\nworks in isolation.",
    "sha": "465c2218356371ef217ae3fa82f663efef4a3253",
    "files": [
        {
            "sha": "2b813379c54d8988f8a62a34493fd79e9b0768f1",
            "filename": "packages/next/src/server/lib/patch-fetch.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/465c2218356371ef217ae3fa82f663efef4a3253/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/465c2218356371ef217ae3fa82f663efef4a3253/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts?ref=465c2218356371ef217ae3fa82f663efef4a3253",
            "patch": "@@ -559,7 +559,7 @@ export function createPatchedFetcher(\n                 cacheSignal = null\n               }\n \n-              return makeHangingPromise<Response>(\n+              return await makeHangingPromise<Response>(\n                 workUnitStore.renderSignal,\n                 'fetch()'\n               )\n@@ -669,7 +669,7 @@ export function createPatchedFetcher(\n                     cacheSignal.endRead()\n                     cacheSignal = null\n                   }\n-                  return makeHangingPromise<Response>(\n+                  return await makeHangingPromise<Response>(\n                     workUnitStore.renderSignal,\n                     'fetch()'\n                   )\n@@ -1010,7 +1010,7 @@ export function createPatchedFetcher(\n                     cacheSignal.endRead()\n                     cacheSignal = null\n                   }\n-                  return makeHangingPromise<Response>(\n+                  return await makeHangingPromise<Response>(\n                     workUnitStore.renderSignal,\n                     'fetch()'\n                   )\n@@ -1044,7 +1044,7 @@ export function createPatchedFetcher(\n                 switch (workUnitStore.type) {\n                   case 'prerender':\n                   case 'prerender-client':\n-                    return makeHangingPromise<Response>(\n+                    return await makeHangingPromise<Response>(\n                       workUnitStore.renderSignal,\n                       'fetch()'\n                     )"
        },
        {
            "sha": "844e9b30ac8c5405fe066348574d8b485d961ced",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/465c2218356371ef217ae3fa82f663efef4a3253/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/465c2218356371ef217ae3fa82f663efef4a3253/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=465c2218356371ef217ae3fa82f663efef4a3253",
            "patch": "@@ -821,7 +821,7 @@ export function cache(\n             )\n \n             if (dynamicAccessAbortController.signal.aborted) {\n-              return makeHangingPromise(\n+              return await makeHangingPromise(\n                 workUnitStore.renderSignal,\n                 dynamicAccessAbortController.signal.reason.message\n               )\n@@ -886,7 +886,7 @@ export function cache(\n                 if (cacheSignal) {\n                   cacheSignal.endRead()\n                 }\n-                return makeHangingPromise(\n+                return await makeHangingPromise(\n                   workUnitStore.renderSignal,\n                   'dynamic \"use cache\"'\n                 )\n@@ -935,7 +935,7 @@ export function cache(\n                 // transformed with an async function, before being passed into\n                 // the \"use cache\" function, which escapes the instrumentation.\n                 if (workUnitStore.allowEmptyStaticShell) {\n-                  return makeHangingPromise(\n+                  return await makeHangingPromise(\n                     workUnitStore.renderSignal,\n                     'dynamic \"use cache\"'\n                   )\n@@ -1029,7 +1029,7 @@ export function cache(\n               if (cacheSignal) {\n                 cacheSignal.endRead()\n               }\n-              return makeHangingPromise(\n+              return await makeHangingPromise(\n                 workUnitStore.renderSignal,\n                 'dynamic \"use cache\"'\n               )\n@@ -1086,7 +1086,7 @@ export function cache(\n           )\n \n           if (result.type === 'prerender-dynamic') {\n-            return result.hangingPromise\n+            return await result.hangingPromise\n           }\n \n           const { stream: newStream, pendingCacheEntry } = result"
        },
        {
            "sha": "6461fc76cfcb6dfddac3305dfcc60c47dc49d9b4",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/465c2218356371ef217ae3fa82f663efef4a3253/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/465c2218356371ef217ae3fa82f663efef4a3253/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=465c2218356371ef217ae3fa82f663efef4a3253",
            "patch": "@@ -554,10 +554,11 @@ describe('Dynamic IO Errors', () => {\n                  \"description\": \"Route \"/dynamic-root\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n                  \"environmentLabel\": \"Server\",\n                  \"label\": \"Console Error\",\n-                 \"source\": \"app/dynamic-root/page.tsx (45:56) @ FetchingComponent\n-             > 45 |       {cached ? await fetchRandomCached(nonce) : await fetchRandom(nonce)}\n-                  |                                                        ^\",\n+                 \"source\": \"app/dynamic-root/page.tsx (59:26) @ fetchRandom\n+             > 59 |   const response = await fetch(\n+                  |                          ^\",\n                  \"stack\": [\n+                   \"fetchRandom app/dynamic-root/page.tsx (59:26)\",\n                    \"FetchingComponent app/dynamic-root/page.tsx (45:56)\",\n                    \"Page app/dynamic-root/page.tsx (22:9)\",\n                    \"LogSafely <anonymous>\",\n@@ -567,10 +568,11 @@ describe('Dynamic IO Errors', () => {\n                  \"description\": \"Route \"/dynamic-root\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n                  \"environmentLabel\": \"Server\",\n                  \"label\": \"Console Error\",\n-                 \"source\": \"app/dynamic-root/page.tsx (45:56) @ FetchingComponent\n-             > 45 |       {cached ? await fetchRandomCached(nonce) : await fetchRandom(nonce)}\n-                  |                                                        ^\",\n+                 \"source\": \"app/dynamic-root/page.tsx (59:26) @ fetchRandom\n+             > 59 |   const response = await fetch(\n+                  |                          ^\",\n                  \"stack\": [\n+                   \"fetchRandom app/dynamic-root/page.tsx (59:26)\",\n                    \"FetchingComponent app/dynamic-root/page.tsx (45:56)\",\n                    \"Page app/dynamic-root/page.tsx (27:7)\",\n                    \"LogSafely <anonymous>\","
        }
    ],
    "stats": {
        "total": 32,
        "additions": 17,
        "deletions": 15
    }
}