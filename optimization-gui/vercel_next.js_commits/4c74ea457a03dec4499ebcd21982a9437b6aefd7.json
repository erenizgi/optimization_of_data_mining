{
    "author": "timneutkens",
    "message": "Turbopack: Change eager import to lazy import for loader_tree (#83115)\n\n## What?\n\nSwitch to matching webpack behavior where module in the loader_tree are\ninitialized later.",
    "sha": "4c74ea457a03dec4499ebcd21982a9437b6aefd7",
    "files": [
        {
            "sha": "a48bc1d056fbba2e71ca8310e01b16a41a17a211",
            "filename": "crates/next-core/src/base_loader_tree.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/4c74ea457a03dec4499ebcd21982a9437b6aefd7/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4c74ea457a03dec4499ebcd21982a9437b6aefd7/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs?ref=4c74ea457a03dec4499ebcd21982a9437b6aefd7",
            "patch": "@@ -99,7 +99,7 @@ impl BaseLoaderTreeBuilder {\n         self.imports.push(\n             formatdoc!(\n                 r#\"\n-                import * as {} from \"MODULE_{}\";\n+                const {} = () => require(\"MODULE_{}\");\n                 \"#,\n                 identifier,\n                 i\n@@ -118,7 +118,7 @@ impl BaseLoaderTreeBuilder {\n         let module_path = module.ident().path().to_string().await?;\n \n         Ok(format!(\n-            \"[() => {identifier}, {path}]\",\n+            \"[{identifier}, {path}]\",\n             path = StringifyJs(&module_path),\n         ))\n     }"
        },
        {
            "sha": "1d795882c6e28ed58e7ebc85d33a2de209651227",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/4c74ea457a03dec4499ebcd21982a9437b6aefd7/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c74ea457a03dec4499ebcd21982a9437b6aefd7/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=4c74ea457a03dec4499ebcd21982a9437b6aefd7",
            "patch": "@@ -387,13 +387,6 @@ export default class NextNodeServer extends BaseServer<\n         // otherwise if the fetch is patched by user code, we will be patching it\n         // too late and there won't be any caching behaviors\n         ComponentMod.patchFetch()\n-\n-        const webpackRequire = ComponentMod.__next_app__.require\n-        if (webpackRequire?.m) {\n-          for (const id of Object.keys(webpackRequire.m)) {\n-            await webpackRequire(id)\n-          }\n-        }\n       } catch (_err) {\n         // Intentionally ignored because this is a preload step.\n       }"
        },
        {
            "sha": "01ee69a19bd0e9dfd650ea1d4520b65277f45d03",
            "filename": "test/development/acceptance-app/hydration-error.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/4c74ea457a03dec4499ebcd21982a9437b6aefd7/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c74ea457a03dec4499ebcd21982a9437b6aefd7/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts?ref=4c74ea457a03dec4499ebcd21982a9437b6aefd7",
            "patch": "@@ -228,7 +228,6 @@ describe('Error overlay for hydration errors in App router', () => {\n                              <SegmentTrieNode>\n                              <script>\n                              <script>\n-                             <script>\n                              <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n                                <Root params={Promise}>\n                                  <html"
        },
        {
            "sha": "8041f9c3864d2331f11c7a08643f4e7c26fa9cb1",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 9,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4c74ea457a03dec4499ebcd21982a9437b6aefd7/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c74ea457a03dec4499ebcd21982a9437b6aefd7/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=4c74ea457a03dec4499ebcd21982a9437b6aefd7",
            "patch": "@@ -2698,7 +2698,6 @@ describe('Cache Components Errors', () => {\n                  \"stack\": [\n                    \"{module evaluation} app/use-cache-private-in-unstable-cache/page.tsx (21:38)\",\n                    \"<FIXME-next-dist-dir>\",\n-                   \"<FIXME-next-dist-dir>\",\n                  ],\n                }\n               `)\n@@ -2754,7 +2753,6 @@ describe('Cache Components Errors', () => {\n                  \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n                      at a (<next-dist-dir>)\n-                     at b (<next-dist-dir>)\n                    19 | }\n                    20 |\n                  > 21 | const getCachedData = unstable_cache(async () => {\n@@ -2772,7 +2770,6 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n-                     at a (<next-dist-dir>)\n                    19 | }\n                    20 |\n                  > 21 | const getCachedData = unstable_cache(async () => {\n@@ -2841,7 +2838,6 @@ describe('Cache Components Errors', () => {\n                  \"stack\": [\n                    \"{module evaluation} app/use-cache-private-in-use-cache/page.tsx (15:1)\",\n                    \"<FIXME-next-dist-dir>\",\n-                   \"<FIXME-next-dist-dir>\",\n                  ],\n                }\n               `)\n@@ -2898,7 +2894,6 @@ describe('Cache Components Errors', () => {\n                  \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n                      at a (<next-dist-dir>)\n-                     at b (<next-dist-dir>)\n                    13 | }\n                    14 |\n                  > 15 | async function Private() {\n@@ -2908,8 +2903,7 @@ describe('Cache Components Errors', () => {\n                    18 |   return <p>Private</p>\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at c (<next-dist-dir>)\n-                     at d (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n                    13 | }\n                    14 |\n                  > 15 | async function Private() {\n@@ -2927,7 +2921,6 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at a (<next-dist-dir>)\n                    13 | }\n                    14 |\n                  > 15 | async function Private() {\n@@ -2937,7 +2930,6 @@ describe('Cache Components Errors', () => {\n                    18 |   return <p>Private</p>\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at b (<next-dist-dir>)\n                    13 | }\n                    14 |\n                  > 15 | async function Private() {"
        },
        {
            "sha": "85ec531e6ce61b1a9266a835dfeec5e1b63bae92",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4c74ea457a03dec4499ebcd21982a9437b6aefd7/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4c74ea457a03dec4499ebcd21982a9437b6aefd7/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=4c74ea457a03dec4499ebcd21982a9437b6aefd7",
            "patch": "@@ -484,7 +484,8 @@ describe('app-dir - server source maps', () => {\n              \"{module evaluation} app/module-evaluation/module.js (1:22)\",\n              \"{module evaluation} app/module-evaluation/page.js (1:1)\",\n              \"{module evaluation} app/module-evaluation/page.js (6:1)\",\n-             \"<FIXME-next-dist-dir>\",\n+             \"Array.map <anonymous>\",\n+             \"Function.all <anonymous>\",\n              \"Page <anonymous>\",\n            ],\n          }\n@@ -515,9 +516,8 @@ describe('app-dir - server source maps', () => {\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n           '' +\n             '\\nError: module-evaluation' +\n-            '\\n    at __TURBOPACK__module__evaluation__ (bundler:///app/module-evaluation/module.js:1:22)' +\n             // TODO(veil): Turbopack internals. Feel free to update. Tracked in https://linear.app/vercel/issue/NEXT-4362\n-            '\\n    at Object.<anonymous>'\n+            '\\n    at __TURBOPACK__module__evaluation__ (bundler:///app/module-evaluation/module.js:1:22)'\n         )\n         expect(normalizeCliOutput(next.cliOutput)).toContain(\n           '' +"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 6,
        "deletions": 22
    }
}