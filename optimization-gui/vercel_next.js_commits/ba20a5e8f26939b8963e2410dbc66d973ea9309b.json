{
    "author": "unstubbable",
    "message": "Fix false-positive build error for `cacheLife` & `cacheTag` (#85875)\n\nWhen functions exported from a module with a top-level `'use cache'`\ndirective are imported into client modules, the compiler should allow\n`cacheLife` and `cacheTag` usage within those functions.\n\nThis PR updates the `react_server_components` transform to properly\ntrack module directives (`'use client'`, `'use server'`, `'use cache'`)\nand skip client graph validation for modules with `'use cache'`,\nidentical to how modules with `'use server'` are already handled. Those\nmodules are transformed anyway for the client graph by the\n`server_actions` transform, which is applied after the\n`react_server_components` transform, in which their implementation is\nreplaced by server function references.\n\ncloses NAR-498",
    "sha": "ba20a5e8f26939b8963e2410dbc66d973ea9309b",
    "files": [
        {
            "sha": "767c668b23ddfec22acfd0d8de3bf4e8bab568ce",
            "filename": "crates/next-custom-transforms/src/transforms/react_server_components.rs",
            "status": "modified",
            "additions": 76,
            "deletions": 47,
            "changes": 123,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -66,7 +66,6 @@ struct ReactServerComponents<C: Comments> {\n     filepath: String,\n     app_dir: Option<PathBuf>,\n     comments: C,\n-    directive_import_collection: Option<(bool, bool, RcVec<ModuleImports>, RcVec<Atom>)>,\n }\n \n #[derive(Clone, Debug)]\n@@ -75,10 +74,17 @@ struct ModuleImports {\n     specifiers: Vec<(Atom, Span)>,\n }\n \n+#[allow(clippy::enum_variant_names)]\n+#[derive(Clone, Copy, Debug, PartialEq, Eq)]\n+enum ModuleDirective {\n+    UseClient,\n+    UseServer,\n+    UseCache,\n+}\n+\n enum RSCErrorKind {\n-    /// When `use client` and `use server` are in the same file.\n-    /// It's not possible to have both directives in the same file.\n-    RedundantDirectives(Span),\n+    UseClientWithUseServer(Span),\n+    UseClientWithUseCache(Span),\n     NextRscErrServerImport((String, Span)),\n     NextRscErrClientImport((String, Span)),\n     NextRscErrClientDirective(Span),\n@@ -127,25 +133,21 @@ impl<C: Comments> VisitMut for ReactServerComponents<C> {\n         );\n \n         module.visit_with(&mut validator);\n-        self.directive_import_collection = validator.directive_import_collection;\n \n-        let is_client_entry = self\n-            .directive_import_collection\n-            .as_ref()\n-            .expect(\"directive_import_collection must be set\")\n-            .0;\n+        let is_client_entry = validator.module_directive == Some(ModuleDirective::UseClient);\n+        let export_names = validator.export_names;\n \n         self.remove_top_level_directive(module);\n \n         let is_cjs = contains_cjs(module);\n \n         if self.is_react_server_layer {\n             if is_client_entry {\n-                self.to_module_ref(module, is_cjs);\n+                self.to_module_ref(module, is_cjs, &export_names);\n                 return;\n             }\n         } else if is_client_entry {\n-            self.prepend_comment_node(module, is_cjs);\n+            self.prepend_comment_node(module, is_cjs, &export_names);\n         }\n         module.visit_mut_children_with(self)\n     }\n@@ -171,7 +173,7 @@ impl<C: Comments> ReactServerComponents<C> {\n \n     // Convert the client module to the module reference code and add a special\n     // comment to the top of the file.\n-    fn to_module_ref(&self, module: &mut Module, is_cjs: bool) {\n+    fn to_module_ref(&self, module: &mut Module, is_cjs: bool, export_names: &[Atom]) {\n         // Clear all the statements and module declarations.\n         module.body.clear();\n \n@@ -229,16 +231,10 @@ impl<C: Comments> ReactServerComponents<C> {\n             .into_iter(),\n         );\n \n-        self.prepend_comment_node(module, is_cjs);\n+        self.prepend_comment_node(module, is_cjs, export_names);\n     }\n \n-    fn prepend_comment_node(&self, module: &Module, is_cjs: bool) {\n-        let export_names = &self\n-            .directive_import_collection\n-            .as_ref()\n-            .expect(\"directive_import_collection must be set\")\n-            .3;\n-\n+    fn prepend_comment_node(&self, module: &Module, is_cjs: bool, export_names: &[Atom]) {\n         // Prepend a special comment to the top of the file that contains\n         // module export names and the detected module type.\n         self.comments.add_leading(\n@@ -269,8 +265,14 @@ fn join_atoms(atoms: &[Atom]) -> String {\n /// errors.\n fn report_error(app_dir: &Option<PathBuf>, filepath: &str, error_kind: RSCErrorKind) {\n     let (msg, spans) = match error_kind {\n-        RSCErrorKind::RedundantDirectives(span) => (\n-            \"It's not possible to have both `use client` and `use server` directives in the \\\n+        RSCErrorKind::UseClientWithUseServer(span) => (\n+            \"It's not possible to have both \\\"use client\\\" and \\\"use server\\\" directives in the \\\n+             same file.\"\n+                .to_string(),\n+            vec![span],\n+        ),\n+        RSCErrorKind::UseClientWithUseCache(span) => (\n+            \"It's not possible to have both \\\"use client\\\" and \\\"use cache\\\" directives in the \\\n              same file.\"\n                 .to_string(),\n             vec![span],\n@@ -359,16 +361,17 @@ fn report_error(app_dir: &Option<PathBuf>, filepath: &str, error_kind: RSCErrorK\n     HANDLER.with(|handler| handler.struct_span_err(spans, msg.as_str()).emit())\n }\n \n-/// Collects top level directives and imports\n-fn collect_top_level_directives_and_imports(\n+/// Collects module directive, imports, and exports from top-level statements\n+fn collect_module_info(\n     app_dir: &Option<PathBuf>,\n     filepath: &str,\n     module: &Module,\n-) -> (bool, bool, Vec<ModuleImports>, Vec<Atom>) {\n+) -> (Option<ModuleDirective>, Vec<ModuleImports>, Vec<Atom>) {\n     let mut imports: Vec<ModuleImports> = vec![];\n     let mut finished_directives = false;\n     let mut is_client_entry = false;\n     let mut is_action_file = false;\n+    let mut is_cache_file = false;\n \n     let mut export_names = vec![];\n \n@@ -392,7 +395,15 @@ fn collect_top_level_directives_and_imports(\n                                             report_error(\n                                                 app_dir,\n                                                 filepath,\n-                                                RSCErrorKind::RedundantDirectives(expr_stmt.span),\n+                                                RSCErrorKind::UseClientWithUseServer(\n+                                                    expr_stmt.span,\n+                                                ),\n+                                            );\n+                                        } else if is_cache_file {\n+                                            report_error(\n+                                                app_dir,\n+                                                filepath,\n+                                                RSCErrorKind::UseClientWithUseCache(expr_stmt.span),\n                                             );\n                                         }\n                                     } else {\n@@ -409,7 +420,20 @@ fn collect_top_level_directives_and_imports(\n                                         report_error(\n                                             app_dir,\n                                             filepath,\n-                                            RSCErrorKind::RedundantDirectives(expr_stmt.span),\n+                                            RSCErrorKind::UseClientWithUseServer(expr_stmt.span),\n+                                        );\n+                                    }\n+                                } else if (&**value == \"use cache\"\n+                                    || value.starts_with(\"use cache: \"))\n+                                    && !finished_directives\n+                                {\n+                                    is_cache_file = true;\n+\n+                                    if is_client_entry {\n+                                        report_error(\n+                                            app_dir,\n+                                            filepath,\n+                                            RSCErrorKind::UseClientWithUseCache(expr_stmt.span),\n                                         );\n                                     }\n                                 }\n@@ -541,7 +565,17 @@ fn collect_top_level_directives_and_imports(\n         }\n     });\n \n-    (is_client_entry, is_action_file, imports, export_names)\n+    let directive = if is_client_entry {\n+        Some(ModuleDirective::UseClient)\n+    } else if is_action_file {\n+        Some(ModuleDirective::UseServer)\n+    } else if is_cache_file {\n+        Some(ModuleDirective::UseCache)\n+    } else {\n+        None\n+    };\n+\n+    (directive, imports, export_names)\n }\n \n /// A visitor to assert given module file is a valid React server component.\n@@ -556,13 +590,11 @@ struct ReactServerComponentValidator {\n     deprecated_apis_mapping: FxHashMap<&'static str, Vec<&'static str>>,\n     invalid_client_imports: Vec<Atom>,\n     invalid_client_lib_apis_mapping: FxHashMap<&'static str, Vec<&'static str>>,\n-    pub directive_import_collection: Option<(bool, bool, RcVec<ModuleImports>, RcVec<Atom>)>,\n+    pub module_directive: Option<ModuleDirective>,\n+    pub export_names: Vec<Atom>,\n     imports: ImportMap,\n }\n \n-// A type to workaround a clippy warning.\n-type RcVec<T> = Rc<Vec<T>>;\n-\n impl ReactServerComponentValidator {\n     pub fn new(\n         is_react_server_layer: bool,\n@@ -577,7 +609,8 @@ impl ReactServerComponentValidator {\n             use_cache_enabled,\n             filepath: filename,\n             app_dir,\n-            directive_import_collection: None,\n+            module_directive: None,\n+            export_names: vec![],\n             // react -> [apis]\n             // react-dom -> [apis]\n             // next/navigation -> [apis]\n@@ -1011,20 +1044,15 @@ impl Visit for ReactServerComponentValidator {\n     fn visit_module(&mut self, module: &Module) {\n         self.imports = ImportMap::analyze(module);\n \n-        let (is_client_entry, is_action_file, imports, export_names) =\n-            collect_top_level_directives_and_imports(&self.app_dir, &self.filepath, module);\n+        let (directive, imports, export_names) =\n+            collect_module_info(&self.app_dir, &self.filepath, module);\n         let imports = Rc::new(imports);\n-        let export_names = Rc::new(export_names);\n \n-        self.directive_import_collection = Some((\n-            is_client_entry,\n-            is_action_file,\n-            imports.clone(),\n-            export_names,\n-        ));\n+        self.module_directive = directive;\n+        self.export_names = export_names;\n \n         if self.is_react_server_layer {\n-            if is_client_entry {\n+            if directive == Some(ModuleDirective::UseClient) {\n                 return;\n             } else {\n                 // Only assert server graph if file's bundle target is \"server\", e.g.\n@@ -1035,11 +1063,13 @@ impl Visit for ReactServerComponentValidator {\n                 self.assert_server_graph(&imports, module);\n             }\n         } else {\n-            // Only assert client graph if the file is not an action file,\n+            // Only assert client graph if the file is not an action or cache file,\n             // and bundle target is \"client\" e.g.\n             // * client components pages\n             // * pages bundles on browser layer\n-            if !is_action_file {\n+            if directive != Some(ModuleDirective::UseServer)\n+                && directive != Some(ModuleDirective::UseCache)\n+            {\n                 self.assert_client_graph(&imports);\n                 self.assert_invalid_api(module, true);\n             }\n@@ -1115,6 +1145,5 @@ pub fn server_components<C: Comments>(\n             _ => filename.to_string(),\n         },\n         app_dir,\n-        directive_import_collection: None,\n     })\n }"
        },
        {
            "sha": "0b98634421f195ab0f61d63272d4cd1697c798b0",
            "filename": "crates/next-custom-transforms/tests/errors.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors.rs?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -158,6 +158,8 @@ fn react_server_actions_errors(input: PathBuf) {\n         syntax(),\n         &|tr| {\n             (\n+                // The transforms are intentionally declared in the same order as in\n+                // crates/next-custom-transforms/src/chain_transforms.rs\n                 resolver(Mark::new(), Mark::new(), false),\n                 server_components(\n                     FileName::Real(PathBuf::from(\"/app/item.js\")).into(),\n@@ -222,6 +224,8 @@ fn use_cache_not_allowed(input: PathBuf) {\n         syntax(),\n         &|tr| {\n             (\n+                // The transforms are intentionally declared in the same order as in\n+                // crates/next-custom-transforms/src/chain_transforms.rs\n                 resolver(Mark::new(), Mark::new(), false),\n                 server_components(\n                     FileName::Real(PathBuf::from(\"/app/item.js\")).into(),"
        },
        {
            "sha": "b3b0eee3c4b86531d6d6499e361d2247df12322c",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/12/output.stderr",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F12%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F12%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F12%2Foutput.stderr?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -1,4 +1,4 @@\n-  x It's not possible to have both `use client` and `use server` directives in the same file.\n+  x It's not possible to have both \"use client\" and \"use server\" directives in the same file.\n    ,-[input.js:2:1]\n  1 | 'use server'\n  2 | 'use client'"
        },
        {
            "sha": "3ad2e9c6f3d58a9d84dfce110e348708ad277d31",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/13/output.stderr",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F13%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F13%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F13%2Foutput.stderr?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -1,4 +1,4 @@\n-  x It's not possible to have both `use client` and `use server` directives in the same file.\n+  x It's not possible to have both \"use client\" and \"use server\" directives in the same file.\n    ,-[input.js:6:1]\n  5 | \n  6 | 'use server'"
        },
        {
            "sha": "8300ac5cddf0fa62b7e37f2a96dc316f2ff33b74",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/29/input.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Finput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,4 @@\n+'use cache'\n+'use client'\n+\n+export async function foo() {}"
        },
        {
            "sha": "8d62fb0b348294b7b14e2185ea0bebced218981b",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/29/output.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Foutput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,2 @@\n+/* __next_internal_client_entry_do_not_use__ foo auto */ const { createProxy } = require(\"private-next-rsc-mod-ref-proxy\");\n+module.exports = createProxy(\"/app/item.js\");"
        },
        {
            "sha": "d309ae6437829401044da039f4d6b3c51a485698",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/29/output.stderr",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F29%2Foutput.stderr?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,6 @@\n+  x It's not possible to have both \"use client\" and \"use cache\" directives in the same file.\n+   ,-[input.js:2:1]\n+ 1 | 'use cache'\n+ 2 | 'use client'\n+   : ^^^^^^^^^^^^\n+   `----"
        },
        {
            "sha": "35b30d0cf629d3eb7e2916d9ea00f4eef7ccb49d",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/30/input.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Finput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,4 @@\n+'use client'\n+'use cache'\n+\n+export async function foo() {}"
        },
        {
            "sha": "8d62fb0b348294b7b14e2185ea0bebced218981b",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/30/output.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Foutput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,2 @@\n+/* __next_internal_client_entry_do_not_use__ foo auto */ const { createProxy } = require(\"private-next-rsc-mod-ref-proxy\");\n+module.exports = createProxy(\"/app/item.js\");"
        },
        {
            "sha": "e30b9b26d9b96b86307907c07a0e6cc85dbf6d19",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/30/output.stderr",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F30%2Foutput.stderr?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,6 @@\n+  x It's not possible to have both \"use client\" and \"use cache\" directives in the same file.\n+   ,-[input.js:2:1]\n+ 1 | 'use client'\n+ 2 | 'use cache'\n+   : ^^^^^^^^^^^\n+   `----"
        },
        {
            "sha": "803981f278c64c85238e9e32e19dcd7a676b0160",
            "filename": "crates/next-custom-transforms/tests/fixture.rs",
            "status": "modified",
            "additions": 29,
            "deletions": 9,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture.rs?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -471,19 +471,39 @@ fn react_server_components_typescript(input: PathBuf) {\n fn react_server_components_fixture(input: PathBuf) {\n     use next_custom_transforms::transforms::react_server_components::{Config, Options};\n     let is_react_server_layer = input.iter().any(|s| s.to_str() == Some(\"server-graph\"));\n+    let filename = FileName::Real(PathBuf::from(\"/some-project/src/some-file.js\"));\n     let output = input.parent().unwrap().join(\"output.js\");\n     test_fixture(\n         syntax(),\n         &|tr| {\n-            server_components(\n-                FileName::Real(PathBuf::from(\"/some-project/src/some-file.js\")).into(),\n-                Config::WithOptions(Options {\n-                    is_react_server_layer,\n-                    cache_components_enabled: false,\n-                    use_cache_enabled: false,\n-                }),\n-                tr.comments.as_ref().clone(),\n-                None,\n+            (\n+                // The transforms are intentionally declared in the same order as in\n+                // crates/next-custom-transforms/src/chain_transforms.rs\n+                server_components(\n+                    filename.clone().into(),\n+                    Config::WithOptions(Options {\n+                        is_react_server_layer,\n+                        cache_components_enabled: false,\n+                        use_cache_enabled: false,\n+                    }),\n+                    tr.comments.as_ref().clone(),\n+                    None,\n+                ),\n+                server_actions(\n+                    &filename,\n+                    None,\n+                    server_actions::Config {\n+                        is_react_server_layer,\n+                        is_development: true,\n+                        use_cache_enabled: true,\n+                        hash_salt: \"\".into(),\n+                        cache_kinds: FxHashSet::default(),\n+                    },\n+                    tr.comments.as_ref().clone(),\n+                    tr.cm.clone(),\n+                    Default::default(),\n+                    ServerActionsMode::Webpack,\n+                ),\n             )\n         },\n         &input,"
        },
        {
            "sha": "4feff7fd19cc0141ccec97623e93a633d548f77f",
            "filename": "crates/next-custom-transforms/tests/fixture/react-server-components/client-graph/actions/input.js",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Factions%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Factions%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Factions%2Finput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -3,3 +3,7 @@\n // It should be allowed to import server APIs here.\n import 'server-only'\n import { cookies } from 'next/headers'\n+\n+export async function test() {\n+  await cookies()\n+}"
        },
        {
            "sha": "abae51f8fca2db7d82b528e38d534a19c30a87b3",
            "filename": "crates/next-custom-transforms/tests/fixture/react-server-components/client-graph/actions/output.js",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Factions%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Factions%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Factions%2Foutput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -1,4 +1,2 @@\n-'use server';\n-// It should be allowed to import server APIs here.\n-import 'server-only';\n-import { cookies } from 'next/headers';\n+/* __next_internal_action_entry_do_not_use__ {\"00a275d5b08d0553a04df65d28075d3cad57073dca\":\"test\"} */ import { createServerReference, callServer, findSourceMapURL } from \"private-next-rsc-action-client-wrapper\";\n+export var test = /*#__PURE__*/ createServerReference(\"00a275d5b08d0553a04df65d28075d3cad57073dca\", callServer, void 0, findSourceMapURL, \"test\");"
        },
        {
            "sha": "0e5173fa2c39e9c6697349ace457470b0947730b",
            "filename": "crates/next-custom-transforms/tests/fixture/react-server-components/client-graph/cache-life/input.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-life%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-life%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-life%2Finput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,8 @@\n+'use cache'\n+\n+import { cacheLife } from 'next/cache'\n+\n+export async function test() {\n+  cacheLife('days')\n+  return null\n+}"
        },
        {
            "sha": "0cd1b311b9dbf344fdf28ed7d9b2a00a7c6fda04",
            "filename": "crates/next-custom-transforms/tests/fixture/react-server-components/client-graph/cache-life/output.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-life%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-life%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-life%2Foutput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,2 @@\n+/* __next_internal_action_entry_do_not_use__ {\"80a275d5b08d0553a04df65d28075d3cad57073dca\":\"test\"} */ import { createServerReference, callServer, findSourceMapURL } from \"private-next-rsc-action-client-wrapper\";\n+export var test = /*#__PURE__*/ createServerReference(\"80a275d5b08d0553a04df65d28075d3cad57073dca\", callServer, void 0, findSourceMapURL, \"test\");"
        },
        {
            "sha": "443b731743ef397f6b5bd818f9fec39b6f36675b",
            "filename": "crates/next-custom-transforms/tests/fixture/react-server-components/client-graph/cache-tag/input.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-tag%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-tag%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-tag%2Finput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,8 @@\n+'use cache'\n+\n+import { cacheTag } from 'next/cache'\n+\n+export async function test() {\n+  cacheTag('test')\n+  return null\n+}"
        },
        {
            "sha": "0cd1b311b9dbf344fdf28ed7d9b2a00a7c6fda04",
            "filename": "crates/next-custom-transforms/tests/fixture/react-server-components/client-graph/cache-tag/output.js",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-tag%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-tag%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Freact-server-components%2Fclient-graph%2Fcache-tag%2Foutput.js?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -0,0 +1,2 @@\n+/* __next_internal_action_entry_do_not_use__ {\"80a275d5b08d0553a04df65d28075d3cad57073dca\":\"test\"} */ import { createServerReference, callServer, findSourceMapURL } from \"private-next-rsc-action-client-wrapper\";\n+export var test = /*#__PURE__*/ createServerReference(\"80a275d5b08d0553a04df65d28075d3cad57073dca\", callServer, void 0, findSourceMapURL, \"test\");"
        },
        {
            "sha": "2a435c80b8b9fc4aa64a26dd0392881ae5b2bac5",
            "filename": "test/e2e/app-dir/use-cache/app/(partially-static)/imported-from-client/cached.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/ba20a5e8f26939b8963e2410dbc66d973ea9309b/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fimported-from-client%2Fcached.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ba20a5e8f26939b8963e2410dbc66d973ea9309b/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fimported-from-client%2Fcached.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fimported-from-client%2Fcached.ts?ref=ba20a5e8f26939b8963e2410dbc66d973ea9309b",
            "patch": "@@ -1,16 +1,20 @@\n 'use cache'\n \n+import { cacheLife, cacheTag } from 'next/cache'\n+\n function getRandomValue() {\n   const v = Math.random()\n   console.log(v)\n   return v\n }\n \n export async function foo() {\n+  cacheLife('days')\n   return getRandomValue()\n }\n \n export const bar = async function () {\n+  cacheTag('bar')\n   return getRandomValue()\n }\n "
        }
    ],
    "stats": {
        "total": 227,
        "additions": 165,
        "deletions": 62
    }
}