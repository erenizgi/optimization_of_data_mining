{
    "author": "ScriptedAlchemy",
    "message": "test: fix failures caused by format discrepancies between rspack and other bundlers (#80314)\n\nThis pull request updates error recovery tests to improve compatibility\nwith the Rspack bundler by introducing an `isRspack` flag and modifying\ntest cases to handle Rspack-specific error formats. The changes ensure\nthat runtime and build errors are correctly detected and displayed when\nusing Rspack.\n\n### Rspack Compatibility Updates:\n\n* Introduced the `isRspack` flag to determine if Rspack is being used,\nbased on the `NEXT_RSPACK` environment variable. This flag replaces\ndirect checks of `process.env.NEXT_RSPACK` for better readability and\nmaintainability.\n(`test/development/acceptance-app/error-recovery.test.ts`\n[[1]](diffhunk://#diff-ed42d009889881804f76e500465e132e4aa1df75c8659119e1b5cff4d230b7cdR8-R9)\n`test/development/acceptance/error-recovery.test.ts`\n[[2]](diffhunk://#diff-18cc654bcba9dbffcf77a6157fec144f9d0b1a0b3c59d46b33f6a2b95f543a91R9)\n\n* Updated test cases in `error-recovery.test.ts` and\n`acceptance-app/error-recovery.test.ts` to handle Rspack-specific error\nmessages. This includes adapting error expectations for syntax errors,\nruntime errors, and build errors with the Rspack error format.\n(`test/development/acceptance-app/error-recovery.test.ts`\n[[1]](diffhunk://#diff-ed42d009889881804f76e500465e132e4aa1df75c8659119e1b5cff4d230b7cdR58-R79)\n[[2]](diffhunk://#diff-ed42d009889881804f76e500465e132e4aa1df75c8659119e1b5cff4d230b7cdR574-R588)\n[[3]](diffhunk://#diff-ed42d009889881804f76e500465e132e4aa1df75c8659119e1b5cff4d230b7cdR845-R872);\n`test/development/acceptance/error-recovery.test.ts`\n[[4]](diffhunk://#diff-18cc654bcba9dbffcf77a6157fec144f9d0b1a0b3c59d46b33f6a2b95f543a91L58-R74)\n[[5]](diffhunk://#diff-18cc654bcba9dbffcf77a6157fec144f9d0b1a0b3c59d46b33f6a2b95f543a91L372-R394)\n[[6]](diffhunk://#diff-18cc654bcba9dbffcf77a6157fec144f9d0b1a0b3c59d46b33f6a2b95f543a91L755-R766)\n\n* Replaced outdated error message formats in Rspack-related test cases\nwith updated and more precise error descriptions, including detailed\nstack traces and error causes.\n(`test/development/acceptance/error-recovery.test.ts`\n[[1]](diffhunk://#diff-18cc654bcba9dbffcf77a6157fec144f9d0b1a0b3c59d46b33f6a2b95f543a91L815-R835)\n[[2]](diffhunk://#diff-18cc654bcba9dbffcf77a6157fec144f9d0b1a0b3c59d46b33f6a2b95f543a91L883-R903)\n\nThese changes improve test coverage for Rspack and ensure robust error\nhandling across different bundlers.",
    "sha": "8f2e058c2435e78542f7160627180f0ff8c74cb5",
    "files": [
        {
            "sha": "a56086d7a47744b554ace365ac0a07abaf88802a",
            "filename": "test/development/acceptance-app/error-recovery.test.ts",
            "status": "modified",
            "additions": 81,
            "deletions": 13,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/8f2e058c2435e78542f7160627180f0ff8c74cb5/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f2e058c2435e78542f7160627180f0ff8c74cb5/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ferror-recovery.test.ts?ref=8f2e058c2435e78542f7160627180f0ff8c74cb5",
            "patch": "@@ -5,6 +5,8 @@ import { check } from 'next-test-utils'\n import path from 'path'\n import { outdent } from 'outdent'\n \n+const isRspack = !!process.env.NEXT_RSPACK\n+\n describe('Error recovery app', () => {\n   const { next, isTurbopack } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n@@ -53,6 +55,28 @@ describe('Error recovery app', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect({ browser, next }).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module build failed:\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+         × Module build failed:\n+         ╰─▶   × Error:   x Unexpected eof\n+               │    ,---- \n+               │  1 | export default () => <div/\n+               │    \\`----\n+               │ \n+               │ \n+               │ Caused by:\n+               │     Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./app/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {\n@@ -547,19 +571,35 @@ describe('Error recovery app', () => {\n     )\n \n     await browser.eval('window.triggerError()')\n-    await expect(browser).toDisplayCollapsedRedbox(`\n-     {\n-       \"description\": \"no 1\",\n-       \"environmentLabel\": null,\n-       \"label\": \"Runtime Error\",\n-       \"source\": \"index.js (7:11) @ eval\n-     >  7 |     throw Error('no ' + i)\n-          |           ^\",\n-       \"stack\": [\n-         \"eval index.js (7:11)\",\n-       ],\n-     }\n-    `)\n+    if (isRspack) {\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"no 1\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Runtime Error\",\n+           \"source\": \"index.js (7:11) @ eval\n+         > 7 |     throw Error('no ' + i)\n+             |           ^\",\n+           \"stack\": [\n+             \"eval index.js (7:11)\",\n+           ],\n+         }\n+        `)\n+    } else {\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"description\": \"no 1\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"index.js (7:11) @ eval\n+       >  7 |     throw Error('no ' + i)\n+            |           ^\",\n+         \"stack\": [\n+           \"eval index.js (7:11)\",\n+         ],\n+       }\n+      `)\n+    }\n \n     // Make a syntax error.\n     await session.patch(\n@@ -802,6 +842,34 @@ describe('Error recovery app', () => {\n          \"stack\": [],\n        }\n       `)\n+    } else if (isRspack) {\n+      await expect({ browser, next }).toDisplayRedbox(`\n+       {\n+         \"description\": \"  × Module build failed:\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js\n+         × Module build failed:\n+         ╰─▶   × Error:   x Expected '{', got 'return'\n+               │    ,-[5:1]\n+               │  2 |\n+               │  3 | class ClassDefault extends React.Component {\n+               │  4 |   render()\n+               │  5 |     return <h1>Default Export</h1>;\n+               │    :     ^^^^^^\n+               │  6 |   }\n+               │  7 | }\n+               │    \\`----\n+               │ \n+               │ \n+               │ Caused by:\n+               │     Syntax Error\n+       Import trace for requested module:\n+       ./index.js\n+       ./app/page.js\",\n+         \"stack\": [],\n+       }\n+      `)\n     } else {\n       await expect(browser).toDisplayRedbox(`\n        {"
        },
        {
            "sha": "ed839db5c05bb02c13b4d47a7fe9ea0a7f605611",
            "filename": "test/development/acceptance/error-recovery.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 9,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/8f2e058c2435e78542f7160627180f0ff8c74cb5/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f2e058c2435e78542f7160627180f0ff8c74cb5/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2Ferror-recovery.test.ts?ref=8f2e058c2435e78542f7160627180f0ff8c74cb5",
            "patch": "@@ -6,6 +6,7 @@ import { outdent } from 'outdent'\n import path from 'path'\n \n const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n+const isRspack = !!process.env.NEXT_RSPACK\n \n describe('pages/ error recovery', () => {\n   const { next, isTurbopack } = nextTestSetup({\n@@ -55,7 +56,7 @@ describe('pages/ error recovery', () => {\n          \"stack\": [],\n        }\n       `)\n-    } else if (process.env.NEXT_RSPACK) {\n+    } else if (isRspack) {\n       await expect({ browser, next }).toDisplayRedbox(`\n        {\n          \"description\": \"  × Module build failed:\",\n@@ -369,7 +370,7 @@ describe('pages/ error recovery', () => {\n          \"stack\": [],\n        }\n       `)\n-    } else if (process.env.NEXT_RSPACK) {\n+    } else if (isRspack) {\n       await expect({ browser, next }).toDisplayRedbox(`\n        {\n          \"description\": \"  × Module build failed:\",\n@@ -454,7 +455,7 @@ describe('pages/ error recovery', () => {\n          \"stack\": [],\n        }\n       `)\n-    } else if (process.env.NEXT_RSPACK) {\n+    } else if (isRspack) {\n       await expect({ browser, next }).toDisplayRedbox(`\n        {\n          \"description\": \"  × Module build failed:\",\n@@ -570,7 +571,7 @@ describe('pages/ error recovery', () => {\n        ]\n       `)\n     } else {\n-      if (process.env.NEXT_RSPACK) {\n+      if (isRspack) {\n         await expect(browser).toDisplayRedbox(`\n          {\n            \"description\": \"nooo\",\n@@ -752,17 +753,17 @@ describe('pages/ error recovery', () => {\n     )\n     await new Promise((resolve) => setTimeout(resolve, 1000))\n \n-    if (process.env.NEXT_RSPACK) {\n+    if (isRspack) {\n       await expect(browser).toDisplayRedbox(`\n             {\n               \"description\": \"no 1\",\n               \"environmentLabel\": null,\n               \"label\": \"Runtime Error\",\n-              \"source\": \"index.js (5:9) @ <unknown>\n+              \"source\": \"index.js (5:9) @ eval\n             > 5 |   throw Error('no ' + i)\n                 |         ^\",\n               \"stack\": [\n-                \"<unknown> index.js (5:9)\",\n+                \"eval index.js (5:9)\",\n               ],\n             }\n           `)\n@@ -812,7 +813,7 @@ describe('pages/ error recovery', () => {\n          \"stack\": [],\n        }\n       `)\n-    } else if (process.env.NEXT_RSPACK) {\n+    } else if (isRspack) {\n       await expect({ browser, next }).toDisplayRedbox(`\n        {\n          \"description\": \"  × Module build failed:\",\n@@ -880,7 +881,7 @@ describe('pages/ error recovery', () => {\n          \"stack\": [],\n        }\n       `)\n-    } else if (process.env.NEXT_RSPACK) {\n+    } else if (isRspack) {\n       await expect({ browser, next }).toDisplayRedbox(`\n        {\n          \"description\": \"  × Module build failed:\","
        }
    ],
    "stats": {
        "total": 113,
        "additions": 91,
        "deletions": 22
    }
}