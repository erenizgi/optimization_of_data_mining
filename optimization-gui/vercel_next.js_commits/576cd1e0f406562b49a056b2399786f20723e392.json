{
    "author": "ijjk",
    "message": "Add dev warning for cross-origin and stabilize allowedDevOrigins (#77044)\n\nAdding a warning when we block cross-origin requests in dev so users are\naware this is why easier and know how to allow the origin through as\ncustom setups can use different origins and it be valid.\n\nx-ref:\nhttps://github.com/vercel/next.js/pull/76880#issuecomment-2718487112\n\n---------\n\nCo-authored-by: Jiachi Liu <inbox@huozhi.im>\nCo-authored-by: Zack Tanner <1939140+ztanner@users.noreply.github.com>",
    "sha": "576cd1e0f406562b49a056b2399786f20723e392",
    "files": [
        {
            "sha": "01d9dd71d4dc92f6c66d83b2885e69a762a456b6",
            "filename": "docs/01-app/04-api-reference/05-config/01-next-config-js/allowedDevOrigins.mdx",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/576cd1e0f406562b49a056b2399786f20723e392/docs%2F01-app%2F04-api-reference%2F05-config%2F01-next-config-js%2FallowedDevOrigins.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/576cd1e0f406562b49a056b2399786f20723e392/docs%2F01-app%2F04-api-reference%2F05-config%2F01-next-config-js%2FallowedDevOrigins.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F04-api-reference%2F05-config%2F01-next-config-js%2FallowedDevOrigins.mdx?ref=576cd1e0f406562b49a056b2399786f20723e392",
            "patch": "@@ -0,0 +1,18 @@\n+---\n+title: allowedDevOrigins\n+description: Use `allowedDevOrigins` to configure additional origins that can request the dev server.\n+---\n+\n+{/* The content of this doc is shared between the app and pages router. You can use the `<PagesOnly>Content</PagesOnly>` component to add content that is specific to the Pages Router. Any shared content should not be wrapped in a component. */}\n+\n+To configure a Next.js application to allow requests from origins other than the hostname the server was initialized with (`localhost` by default) you can use the `allowedDevOrigins` config option.\n+\n+`allowedDevOrigins` allows you to set additional origins that can be used in development mode. For example, to use `local-origin.dev` instead of only `localhost`, open `next.config.js` and add the `allowedDevOrigins` config:\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  allowedDevOrigins: ['local-origin.dev'],\n+}\n+```\n+\n+Cross-origin requests are blocked by default to prevent unauthorized requesting of internal assets/endpoints which are available in development mode. This behavior is similar to other dev servers like `webpack-dev-middleware` to ensure the same protection."
        },
        {
            "sha": "065a34a7f16b3a294479ae8c2ba80c5d6c2077f4",
            "filename": "docs/02-pages/03-api-reference/04-config/01-next-config-js/allowedDevOrigins.mdx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/576cd1e0f406562b49a056b2399786f20723e392/docs%2F02-pages%2F03-api-reference%2F04-config%2F01-next-config-js%2FallowedDevOrigins.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/576cd1e0f406562b49a056b2399786f20723e392/docs%2F02-pages%2F03-api-reference%2F04-config%2F01-next-config-js%2FallowedDevOrigins.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F02-pages%2F03-api-reference%2F04-config%2F01-next-config-js%2FallowedDevOrigins.mdx?ref=576cd1e0f406562b49a056b2399786f20723e392",
            "patch": "@@ -0,0 +1,7 @@\n+---\n+title: allowedDevOrigins\n+description: Use `allowedDevOrigins` to configure additional origins that can request the dev server.\n+source: app/api-reference/config/next-config-js/allowedDevOrigins\n+---\n+\n+{/* DO NOT EDIT. The content of this doc is generated from the source above. To edit the content of this page, navigate to the source page in your editor. You can use the `<PagesOnly>Content</PagesOnly>` component to add content that is specific to the Pages Router. Any shared content should not be wrapped in a component. */}"
        },
        {
            "sha": "1c7a519c49d0632efc932953aca9a5556a9fd17e",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/576cd1e0f406562b49a056b2399786f20723e392/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/576cd1e0f406562b49a056b2399786f20723e392/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=576cd1e0f406562b49a056b2399786f20723e392",
            "patch": "@@ -128,6 +128,7 @@ const zTurboRuleConfigItemOrShortcut: zod.ZodType<TurboRuleConfigItemOrShortcut>\n \n export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n   z.strictObject({\n+    allowedDevOrigins: z.array(z.string()).optional(),\n     amp: z\n       .object({\n         canonicalBase: z.string().optional(),\n@@ -262,7 +263,6 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n     experimental: z\n       .strictObject({\n         generateOnlyEnv: z.boolean().optional(),\n-        allowedDevOrigins: z.array(z.string()).optional(),\n         nodeMiddleware: z.boolean().optional(),\n         after: z.boolean().optional(),\n         appDocumentPreloading: z.boolean().optional(),"
        },
        {
            "sha": "1528e9825223b5827f2e42f84b7db499d755fcfa",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/576cd1e0f406562b49a056b2399786f20723e392/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/576cd1e0f406562b49a056b2399786f20723e392/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=576cd1e0f406562b49a056b2399786f20723e392",
            "patch": "@@ -258,7 +258,6 @@ export interface LoggingConfig {\n \n export interface ExperimentalConfig {\n   generateOnlyEnv?: boolean\n-  allowedDevOrigins?: string[]\n   nodeMiddleware?: boolean\n   cacheHandlers?: {\n     default?: string\n@@ -674,6 +673,8 @@ export type ExportPathMap = {\n  * Read more: [Next.js Docs: `next.config.js`](https://nextjs.org/docs/app/api-reference/config/next-config-js)\n  */\n export interface NextConfig extends Record<string, any> {\n+  allowedDevOrigins?: string[]\n+\n   exportPathMap?: (\n     defaultMap: ExportPathMap,\n     ctx: {\n@@ -1135,9 +1136,9 @@ export const defaultConfig: NextConfig = {\n   output: !!process.env.NEXT_PRIVATE_STANDALONE ? 'standalone' : undefined,\n   modularizeImports: undefined,\n   outputFileTracingRoot: process.env.NEXT_PRIVATE_OUTPUT_TRACE_ROOT || '',\n+  allowedDevOrigins: [],\n   experimental: {\n     generateOnlyEnv: false,\n-    allowedDevOrigins: [],\n     nodeMiddleware: false,\n     cacheLife: {\n       default: {"
        },
        {
            "sha": "fd574f33c86fdf765b0c4afc730825d390ffdbac",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/576cd1e0f406562b49a056b2399786f20723e392/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/576cd1e0f406562b49a056b2399786f20723e392/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=576cd1e0f406562b49a056b2399786f20723e392",
            "patch": "@@ -166,10 +166,7 @@ export async function initialize(opts: {\n   renderServer.instance =\n     require('./render-server') as typeof import('./render-server')\n \n-  const allowedOrigins = [\n-    'localhost',\n-    ...(config.experimental.allowedDevOrigins || []),\n-  ]\n+  const allowedOrigins = ['localhost', ...(config.allowedDevOrigins || [])]\n   if (opts.hostname) {\n     allowedOrigins.push(opts.hostname)\n   }"
        },
        {
            "sha": "2431532c1c2ff58eb89afad702b9cc2f40682c3c",
            "filename": "packages/next/src/server/lib/router-utils/block-cross-site.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/576cd1e0f406562b49a056b2399786f20723e392/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/576cd1e0f406562b49a056b2399786f20723e392/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts?ref=576cd1e0f406562b49a056b2399786f20723e392",
            "patch": "@@ -2,6 +2,7 @@ import type { Duplex } from 'stream'\n import type { IncomingMessage, ServerResponse } from 'webpack-dev-server'\n import { parseUrl } from '../../../lib/url'\n import net from 'net'\n+import { warnOnce } from '../../../build/output/log'\n \n export const blockCrossSite = (\n   req: IncomingMessage,\n@@ -23,6 +24,9 @@ export const blockCrossSite = (\n       res.statusCode = 403\n     }\n     res.end('Unauthorized')\n+    warnOnce(\n+      `Blocked cross-origin request to /_next/*. To allow this, configure \"allowedDevOrigins\" in next.config\\nRead more: https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins`\n+    )\n     return true\n   }\n \n@@ -50,6 +54,9 @@ export const blockCrossSite = (\n           res.statusCode = 403\n         }\n         res.end('Unauthorized')\n+        warnOnce(\n+          `Blocked cross-origin request from ${originLowerCase}. To allow this, configure \"allowedDevOrigins\" in next.config\\nRead more: https://nextjs.org/docs/app/api-reference/config/next-config-js/allowedDevOrigins`\n+        )\n         return true\n       }\n     }"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 37,
        "deletions": 7
    }
}