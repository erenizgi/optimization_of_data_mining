{
    "author": "sokra",
    "message": "Turbopack: use turbo_tasks::run in next.js to avoid task memory leak (#83848)\n\n### What?\n\nReplace run_once calls with `run` to avoid task memory overhead.",
    "sha": "e5e29f49e37d7c57a09c59efe7ed27b194e4843c",
    "files": [
        {
            "sha": "81cc694d18807483cee0a5491390a8028fd1f4f3",
            "filename": "crates/napi/src/next_api/endpoint.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs?ref=e5e29f49e37d7c57a09c59efe7ed27b194e4843c",
            "patch": "@@ -131,7 +131,7 @@ pub async fn endpoint_write_to_disk(\n     let (written, issues, diags) = endpoint\n         .turbopack_ctx()\n         .turbo_tasks()\n-        .run_once(async move {\n+        .run(async move {\n             let written_entrypoint_with_issues_op =\n                 get_written_endpoint_with_issues_operation(endpoint_op);\n             let WrittenEndpointWithIssues {\n@@ -146,7 +146,7 @@ pub async fn endpoint_write_to_disk(\n \n             Ok((written.clone(), issues.clone(), diagnostics.clone()))\n         })\n-        .or_else(|e| ctx.throw_turbopack_internal_result(&e))\n+        .or_else(|e| ctx.throw_turbopack_internal_result(&e.into()))\n         .await?;\n     Ok(TurbopackResult {\n         result: NapiWrittenEndpoint::from(written.map(ReadRef::into_owned)),"
        },
        {
            "sha": "789807d01c841061998f6cc23e187e3a76cd7a93",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=e5e29f49e37d7c57a09c59efe7ed27b194e4843c",
            "patch": "@@ -885,7 +885,7 @@ pub async fn project_write_all_entrypoints_to_disk(\n     let tt_clone = tt.clone();\n \n     let (entrypoints, issues, diags) = tt\n-        .run_once(async move {\n+        .run(async move {\n             let entrypoints_with_issues_op =\n                 get_all_written_entrypoints_with_issues_operation(container, app_dir_only);\n \n@@ -913,7 +913,7 @@ pub async fn project_write_all_entrypoints_to_disk(\n \n             Ok((entrypoints.clone(), issues.clone(), diagnostics.clone()))\n         })\n-        .or_else(|e| ctx.throw_turbopack_internal_result(&e))\n+        .or_else(|e| ctx.throw_turbopack_internal_result(&e.into()))\n         .await?;\n \n     Ok(TurbopackResult {\n@@ -1579,7 +1579,7 @@ pub async fn project_trace_source(\n     let container = project.container;\n     let ctx = &project.turbopack_ctx;\n     ctx.turbo_tasks()\n-        .run_once(async move {\n+        .run(async move {\n             let traced_frame = project_trace_source_operation(\n                 container,\n                 frame,\n@@ -1593,7 +1593,7 @@ pub async fn project_trace_source(\n         // source files may have changed or been deleted), so these probably aren't internal errors?\n         // Ideally we should differentiate.\n         .await\n-        .map_err(|e| napi::Error::from_reason(PrettyPrintError(&e).to_string()))\n+        .map_err(|e| napi::Error::from_reason(PrettyPrintError(&e.into()).to_string()))\n }\n \n #[napi]\n@@ -1604,7 +1604,7 @@ pub async fn project_get_source_for_asset(\n     let container = project.container;\n     let ctx = &project.turbopack_ctx;\n     ctx.turbo_tasks()\n-        .run_once(async move {\n+        .run(async move {\n             let source_content = &*container\n                 .project()\n                 .project_path()\n@@ -1626,7 +1626,7 @@ pub async fn project_get_source_for_asset(\n         // source files may have changed or been deleted), so these probably aren't internal errors?\n         // Ideally we should differentiate.\n         .await\n-        .map_err(|e| napi::Error::from_reason(PrettyPrintError(&e).to_string()))\n+        .map_err(|e| napi::Error::from_reason(PrettyPrintError(&e.into()).to_string()))\n }\n \n #[napi]\n@@ -1637,7 +1637,7 @@ pub async fn project_get_source_map(\n     let container = project.container;\n     let ctx = &project.turbopack_ctx;\n     ctx.turbo_tasks()\n-        .run_once(async move {\n+        .run(async move {\n             let Some(map) = &*get_source_map_rope_operation(container, file_path)\n                 .read_strongly_consistent()\n                 .await?\n@@ -1650,7 +1650,7 @@ pub async fn project_get_source_map(\n         // source files may have changed or been deleted), so these probably aren't internal errors?\n         // Ideally we should differentiate.\n         .await\n-        .map_err(|e| napi::Error::from_reason(PrettyPrintError(&e).to_string()))\n+        .map_err(|e| napi::Error::from_reason(PrettyPrintError(&e.into()).to_string()))\n }\n \n #[napi]"
        },
        {
            "sha": "5f22a2a0597611fdbe6475877867ef6284b22356",
            "filename": "crates/next-build-test/src/lib.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/crates%2Fnext-build-test%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/crates%2Fnext-build-test%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-build-test%2Fsrc%2Flib.rs?ref=e5e29f49e37d7c57a09c59efe7ed27b194e4843c",
            "patch": "@@ -38,7 +38,7 @@ pub async fn main_inner(\n     }\n \n     let project = tt\n-        .run_once(async {\n+        .run(async {\n             let project = ProjectContainer::new(rcstr!(\"next-build-test\"), options.dev);\n             let project = project.to_resolved().await?;\n             project.initialize(options).await?;\n@@ -47,9 +47,7 @@ pub async fn main_inner(\n         .await?;\n \n     tracing::info!(\"collecting endpoints\");\n-    let entrypoints = tt\n-        .run_once(async move { project.entrypoints().await })\n-        .await?;\n+    let entrypoints = tt.run(async move { project.entrypoints().await }).await?;\n \n     let mut routes = if let Some(files) = files {\n         tracing::info!(\"building only the files:\");\n@@ -170,7 +168,7 @@ pub async fn render_routes(\n \n             let memory = TurboMalloc::memory_usage();\n \n-            tt.run_once({\n+            tt.run({\n                 let name = name.clone();\n                 async move {\n                     match route {\n@@ -259,7 +257,7 @@ async fn hmr(\n     tracing::info!(\"HMR...\");\n     let session = TransientInstance::new(());\n     let idents = tt\n-        .run_once(async move { project.hmr_identifiers().await })\n+        .run(async move { project.hmr_identifiers().await })\n         .await?;\n     let start = Instant::now();\n     for ident in idents {"
        },
        {
            "sha": "2fe35e1fdb1aa3740a28a6f7cfbfe5c93c183e96",
            "filename": "turbopack/crates/turbo-tasks-backend/benches/overhead.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Foverhead.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Foverhead.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Foverhead.rs?ref=e5e29f49e37d7c57a09c59efe7ed27b194e4843c",
            "patch": "@@ -191,7 +191,7 @@ fn run_turbo<Mode: TurboMode>(\n         ));\n \n         async move {\n-            tt.run_once(async move {\n+            tt.run(async move {\n                 // If cached run once outside the loop to ensure the tasks are cached.\n                 if Mode::is_cached() {\n                     for i in 0..iters {"
        },
        {
            "sha": "9b897962c401e8171b62dd65a88639842f821080",
            "filename": "turbopack/crates/turbo-tasks-backend/benches/scope_stress.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fscope_stress.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fscope_stress.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fscope_stress.rs?ref=e5e29f49e37d7c57a09c59efe7ed27b194e4843c",
            "patch": "@@ -47,11 +47,12 @@ pub fn scope_stress(c: &mut Criterion) {\n                             .map(|(a, b)| {\n                                 let tt = &tt;\n                                 async move {\n-                                    tt.run_once(async move {\n-                                        rectangle(a, b).strongly_consistent().await?;\n-                                        Ok(())\n-                                    })\n-                                    .await\n+                                    Ok(tt\n+                                        .run(async move {\n+                                            rectangle(a, b).strongly_consistent().await?;\n+                                            Ok(())\n+                                        })\n+                                        .await?)\n                                 }\n                             })\n                             .try_join()"
        },
        {
            "sha": "5f445f8843d4c92c5c2d75bd8c17cd7b2ce68df6",
            "filename": "turbopack/crates/turbo-tasks-backend/benches/stress.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fstress.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fstress.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fstress.rs?ref=e5e29f49e37d7c57a09c59efe7ed27b194e4843c",
            "patch": "@@ -37,7 +37,7 @@ pub fn fibonacci(c: &mut Criterion) {\n                     noop_backing_storage(),\n                 ));\n                 async move {\n-                    tt.run_once(async move {\n+                    tt.run(async move {\n                         // Number of tasks:\n                         // 1 root task\n                         // size >= 1 => + fib(0) = 1"
        },
        {
            "sha": "a54b8063dfc3ec591a0a8a740346b97ec9810a01",
            "filename": "turbopack/crates/turbo-tasks-backend/fuzz/src/graph.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e5e29f49e37d7c57a09c59efe7ed27b194e4843c/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ffuzz%2Fsrc%2Fgraph.rs?ref=e5e29f49e37d7c57a09c59efe7ed27b194e4843c",
            "patch": "@@ -145,7 +145,7 @@ fn actual_operation(spec: Arc<Vec<TaskSpec>>, iterations: usize) {\n         .block_on(async {\n             for i in 0..iterations {\n                 let spec = spec.clone();\n-                tt.run_once(async move {\n+                tt.run(async move {\n                     let it = create_state().resolve().await?;\n                     it.await?.set(i);\n                     let task = run_task(spec.clone(), it, 0);"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 23,
        "deletions": 24
    }
}