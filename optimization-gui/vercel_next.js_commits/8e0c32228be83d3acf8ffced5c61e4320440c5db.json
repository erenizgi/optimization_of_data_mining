{
    "author": "kdy1",
    "message": "test(turbopack): Make HMR benchmark less flaky (#80488)\n\n### What?\n\nRetry HMR benchmarks, but make it less flaky. \n\nThis PR\n\n- Removes flaky benchmarks (`hmr_initial_compilation`, `hmr_subscription`)\n- Moves flaky parts (`benchmark_initial_compilation`) out of the iteration loop by moving them to the setup phase.\n\n### Why?\n\nWe need a stable benchmark for dev performance.",
    "sha": "8e0c32228be83d3acf8ffced5c61e4320440c5db",
    "files": [
        {
            "sha": "faddb81b3ab930244e3f687f8ecf822758b9a1a3",
            "filename": ".github/workflows/turbopack-benchmark.yml",
            "status": "modified",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/8e0c32228be83d3acf8ffced5c61e4320440c5db/.github%2Fworkflows%2Fturbopack-benchmark.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/8e0c32228be83d3acf8ffced5c61e4320440c5db/.github%2Fworkflows%2Fturbopack-benchmark.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fturbopack-benchmark.yml?ref=8e0c32228be83d3acf8ffced5c61e4320440c5db",
            "patch": "@@ -26,6 +26,29 @@ env:\n   TURBO_TOKEN: ${{ secrets.HOSTED_TURBO_TOKEN }}\n \n jobs:\n+  benchmark-tiny:\n+    name: Benchmark Rust Crates (tiny)\n+    runs-on: ubuntu-latest\n+    steps:\n+      - uses: actions/checkout@v4\n+\n+      - name: Setup Rust toolchain\n+        uses: ./.github/actions/setup-rust\n+\n+      - name: Install cargo-codspeed\n+        uses: taiki-e/install-action@v2\n+        with:\n+          tool: cargo-codspeed@2.10.1\n+\n+      - name: Build app build benchmarks\n+        run: cargo codspeed build -p next-api\n+\n+      - name: Run the benchmarks\n+        uses: CodSpeedHQ/action@v3\n+        with:\n+          run: cargo codspeed run\n+          token: ${{ secrets.CODSPEED_TOKEN }}\n+\n   benchmark-small-apps:\n     name: Benchmark Rust Crates (small apps)\n     runs-on: ['self-hosted', 'linux', 'x64', 'metal']"
        },
        {
            "sha": "1096d1275802000e861c965e40b284db20fb85d6",
            "filename": "crates/next-api/benches/hmr.rs",
            "status": "modified",
            "additions": 38,
            "deletions": 90,
            "changes": 128,
            "blob_url": "https://github.com/vercel/next.js/blob/8e0c32228be83d3acf8ffced5c61e4320440c5db/crates%2Fnext-api%2Fbenches%2Fhmr.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8e0c32228be83d3acf8ffced5c61e4320440c5db/crates%2Fnext-api%2Fbenches%2Fhmr.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fbenches%2Fhmr.rs?ref=8e0c32228be83d3acf8ffced5c61e4320440c5db",
            "patch": "@@ -231,8 +231,6 @@ impl HmrBenchmark {\n \n     /// Benchmark HMR update detection and processing\n     pub async fn benchmark_hmr_update(&self, num_updates: usize) -> Result<Duration> {\n-        let start_time = Instant::now();\n-\n         // Get entrypoints to trigger initial compilation\n         let entrypoints = self.project_container.entrypoints();\n         let initial_result = entrypoints.await?;\n@@ -281,12 +279,7 @@ impl HmrBenchmark {\n             update_durations.push(update_start.elapsed());\n         }\n \n-        // // Log individual update times for analysis\n-        // for (i, duration) in update_durations.iter().enumerate() {\n-        //     println!(\"HMR update {} took: {:?}\", i + 1, duration);\n-        // }\n-\n-        Ok(start_time.elapsed())\n+        Ok(update_durations.iter().sum::<Duration>())\n     }\n \n     /// Benchmark HMR subscription and event handling\n@@ -425,98 +418,53 @@ fn setup_everything(module_count: usize) -> Arc<Setup> {\n     arc\n }\n \n-#[divan::bench]\n-fn hmr_initial_compilation(bencher: divan::Bencher) {\n-    let setup = setup_everything(100);\n-\n-    bencher.with_inputs(|| setup.clone()).bench_values(|setup| {\n-        setup.clone().rt.block_on(async move {\n-            setup.clone().tt.run_once(Box::pin(async move {\n-                setup\n-                    .benchmark\n-                    .benchmark_initial_compilation()\n-                    .await\n-                    .unwrap();\n-                Ok(())\n-            }));\n+fn bench_update(bencher: divan::Bencher, module_count: usize, num_updates: usize) {\n+    let s = setup_everything(module_count);\n+\n+    bencher\n+        .with_inputs(|| {\n+            let setup = s.clone();\n+\n+            setup.clone().rt.block_on(async move {\n+                setup.clone().tt.run_once(Box::pin(async move {\n+                    let _ = setup\n+                        .benchmark\n+                        .benchmark_initial_compilation()\n+                        .await\n+                        .unwrap();\n+                    Ok(())\n+                }));\n+            });\n+\n+            s.clone()\n         })\n-    });\n+        .bench_values(|setup| {\n+            setup.clone().rt.block_on(async move {\n+                setup.clone().tt.run_once(Box::pin(async move {\n+                    setup\n+                        .benchmark\n+                        .benchmark_hmr_update(num_updates)\n+                        .await\n+                        .unwrap();\n+                    Ok(())\n+                }));\n+            })\n+        });\n }\n \n-#[divan::bench(sample_size = 10)]\n+#[divan::bench(sample_size = 10000, max_time = 60)]\n fn hmr_updates_small_5(bencher: divan::Bencher) {\n-    let setup = setup_everything(100);\n-\n-    bencher.with_inputs(|| setup.clone()).bench_values(|setup| {\n-        setup.clone().rt.block_on(async move {\n-            setup.clone().tt.run_once(Box::pin(async move {\n-                let _ = setup\n-                    .benchmark\n-                    .benchmark_initial_compilation()\n-                    .await\n-                    .unwrap();\n-                setup.benchmark.benchmark_hmr_update(5).await.unwrap();\n-                Ok(())\n-            }));\n-        })\n-    });\n+    bench_update(bencher, 100, 5);\n }\n \n-#[divan::bench(sample_size = 10)]\n+#[divan::bench(sample_size = 10000, max_time = 60)]\n fn hmr_updates_medium_10(bencher: divan::Bencher) {\n-    let setup = setup_everything(200);\n-\n-    bencher.with_inputs(|| setup.clone()).bench_values(|setup| {\n-        setup.clone().rt.block_on(async move {\n-            setup.clone().tt.run_once(Box::pin(async move {\n-                let _ = setup\n-                    .benchmark\n-                    .benchmark_initial_compilation()\n-                    .await\n-                    .unwrap();\n-                setup.benchmark.benchmark_hmr_update(10).await.unwrap();\n-                Ok(())\n-            }));\n-        })\n-    });\n+    bench_update(bencher, 200, 10);\n }\n \n-#[divan::bench(sample_size = 10)]\n+#[divan::bench(sample_size = 10000, max_time = 60)]\n fn hmr_updates_large_20(bencher: divan::Bencher) {\n-    let setup = setup_everything(500);\n-\n-    bencher.with_inputs(|| setup.clone()).bench_values(|setup| {\n-        setup.clone().rt.block_on(async move {\n-            setup.clone().tt.run_once(Box::pin(async move {\n-                let _ = setup\n-                    .benchmark\n-                    .benchmark_initial_compilation()\n-                    .await\n-                    .unwrap();\n-                setup.benchmark.benchmark_hmr_update(20).await.unwrap();\n-                Ok(())\n-            }));\n-        })\n-    });\n-}\n-\n-#[divan::bench(sample_size = 10)]\n-fn hmr_subscription(bencher: divan::Bencher) {\n-    let setup = setup_everything(100);\n-\n-    bencher.with_inputs(|| setup.clone()).bench_values(|setup| {\n-        setup.clone().rt.block_on(async move {\n-            setup.clone().tt.run_once(Box::pin(async move {\n-                let _ = setup\n-                    .benchmark\n-                    .benchmark_initial_compilation()\n-                    .await\n-                    .unwrap();\n-                setup.benchmark.benchmark_hmr_subscription().await.unwrap();\n-                Ok(())\n-            }));\n-        })\n-    });\n+    bench_update(bencher, 500, 20);\n }\n \n fn main() {"
        }
    ],
    "stats": {
        "total": 151,
        "additions": 61,
        "deletions": 90
    }
}