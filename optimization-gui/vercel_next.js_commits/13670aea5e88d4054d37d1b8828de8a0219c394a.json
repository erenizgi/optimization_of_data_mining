{
    "author": "wbinnssmith",
    "message": "Turbopack panics: create discussions with pre-filled errors (#76850)\n\nThis:\n- Prompts users to report turbopack internal errors as new GitHub\ndiscussions instead of issues\n- Encodes the error message and debug information into the discussion\ntitle and body respectively\n- Since these encoded urls can be lengthy, it uses [Terminal\nHyperlinks](https://gist.github.com/egmontkob/eb114294efbcd5adb1944c9f3cb5feda)\nto present things concisely without excessive wrapping. If the terminal\ndoes not support this, only the error message is sent.\n- Removes specific panic handling in favor of the `subscribe` napi error\nhandler. This seems to be the vast majority of panics.\n\nTest Plan:\n\nIn a terminal with hyperlink support `FORCE_HYPERLINK=1 pnpm next dev\n--turbo examples/basic-css/`:\n```\n-----\nFATAL: An unexpected Turbopack error occurred. A panic log has been written to /var/folders/sk/zy7023wd30j0dxpmdv3nylm80000gn/T/next-panic-bf6bdb325db0f5ed5599cf332d8e364a.log.\n\nTo help make Turbopack better, report this error by clicking here.\n-----\n```\n\nWhere the link generated is [clicking\nhere.](https://github.com/vercel/next.js/discussions/new?category=error-report&title=Turbopack%20Error%3A%20Panic%20in%20AppProject%3A%3Anew%3A%20Some%28%22oh%20no%20new%20app%21%22%29&body=Error%20message%3A%0A%60%60%60%0APanic%20in%20AppProject%3A%3Anew%3A%20Some%28%22oh%20no%20new%20app%21%22%29%0A%0ADebug%20info%3A%0A-%20Execution%20of%20get_entrypoints_with_issues_operation%20failed%0A-%20Execution%20of%20EntrypointsOperation%3A%3Anew%20failed%0A-%20Execution%20of%20Project%3A%3Aentrypoints%20failed%0A-%20Execution%20of%20Project%3A%3Aapp_project%20failed%0A-%20Panic%20in%20AppProject%3A%3Anew%3A%20Some%28%22oh%20no%20new%20app%21%22%29%0A%60%60%60&labels=Turbopack,Turbopack%20Panic%20Backtrace)\n\nIn a terminal without hyperlink support `FORCE_HYPERLINK=0 pnpm next dev\n--turbo examples/basic-css/`:\n\n```\n-----\nFATAL: An unexpected Turbopack error occurred. A panic log has been written to /var/folders/sk/zy7023wd30j0dxpmdv3nylm80000gn/T/next-panic-3c5a833c682727cba1d51cc97ee0c16.log.\n\nTo help make Turbopack better, report this error by clicking here: https://github.com/vercel/next.js/discussions/new?category=error-report&title=Turbopack%20Error%3A%20Panic%20in%20AppProject%3A%3Anew%3A%20Some%28%22oh%20no%20new%20app%21%22%29&body=Error%20message%3A%0A%60%60%60%0ATurbopack%20Error%3A%20Panic%20in%20AppProject%3A%3Anew%3A%20Some%28%22oh%20no%20new%20app%21%22%29%0A%60%60%60&labels=Turbopack,Turbopack%20Panic%20Backtrace\n-----\n```\n\n---------\n\nCo-authored-by: Tobias Koppers <tobias.koppers@googlemail.com>",
    "sha": "13670aea5e88d4054d37d1b8828de8a0219c394a",
    "files": [
        {
            "sha": "86c209a17de6f3c291dc054eb6448b42d627110f",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/13670aea5e88d4054d37d1b8828de8a0219c394a/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/13670aea5e88d4054d37d1b8828de8a0219c394a/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=13670aea5e88d4054d37d1b8828de8a0219c394a",
            "patch": "@@ -4586,7 +4586,9 @@ dependencies = [\n  \"rustc-hash 2.1.0\",\n  \"serde\",\n  \"serde_json\",\n+ \"supports-hyperlinks\",\n  \"swc_core\",\n+ \"terminal_hyperlink\",\n  \"tokio\",\n  \"tracing\",\n  \"tracing-chrome\",\n@@ -6959,6 +6961,12 @@ version = \"2.5.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"81cdd64d312baedb58e21336b31bc043b77e01cc99033ce76ef539f78e965ebc\"\n \n+[[package]]\n+name = \"supports-hyperlinks\"\n+version = \"3.1.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"804f44ed3c63152de6a9f90acbea1a110441de43006ea51bcce8f436196a288b\"\n+\n [[package]]\n name = \"swc\"\n version = \"16.1.1\"\n@@ -8484,6 +8492,12 @@ dependencies = [\n  \"winapi-util\",\n ]\n \n+[[package]]\n+name = \"terminal_hyperlink\"\n+version = \"0.1.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"db7bfa7333cbbfca467f40042a640d3c86063d6e4085cef4a6effdbad7005d50\"\n+\n [[package]]\n name = \"terminal_size\"\n version = \"0.3.0\""
        },
        {
            "sha": "9ddf17e8f5b66bfb1ea378c2865b56a0a16918dc",
            "filename": "crates/napi/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/13670aea5e88d4054d37d1b8828de8a0219c394a/crates%2Fnapi%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/13670aea5e88d4054d37d1b8828de8a0219c394a/crates%2Fnapi%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2FCargo.toml?ref=13670aea5e88d4054d37d1b8828de8a0219c394a",
            "patch": "@@ -66,6 +66,8 @@ rand = { workspace = true }\n rustc-hash = { workspace = true }\n serde = \"1\"\n serde_json = \"1\"\n+supports-hyperlinks = \"3.1.0\"\n+terminal_hyperlink = \"0.1.0\"\n tracing = { workspace = true }\n tracing-subscriber = { workspace = true }\n tracing-chrome = \"0.5.0\""
        },
        {
            "sha": "c9314e5df52e7ea11e6b20c9775964d30eb0320d",
            "filename": "crates/napi/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 12,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/13670aea5e88d4054d37d1b8828de8a0219c394a/crates%2Fnapi%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/13670aea5e88d4054d37d1b8828de8a0219c394a/crates%2Fnapi%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Flib.rs?ref=13670aea5e88d4054d37d1b8828de8a0219c394a",
            "patch": "@@ -34,12 +34,8 @@ DEALINGS IN THE SOFTWARE.\n #[macro_use]\n extern crate napi_derive;\n \n-use std::{\n-    panic::set_hook,\n-    sync::{Arc, Once},\n-};\n+use std::sync::{Arc, Once};\n \n-use backtrace::Backtrace;\n use napi::bindgen_prelude::*;\n use rustc_hash::{FxHashMap, FxHashSet};\n use swc_core::{\n@@ -76,13 +72,6 @@ fn init() {\n     use tokio::runtime::Builder;\n     use turbo_tasks_malloc::TurboMalloc;\n \n-    set_hook(Box::new(|panic_info| {\n-        util::log_internal_error_and_inform(&format!(\n-            \"Panic: {}\\nBacktrace: {:?}\",\n-            panic_info,\n-            Backtrace::new()\n-        ));\n-    }));\n     let rt = Builder::new_multi_thread()\n         .enable_all()\n         .on_thread_stop(|| {"
        },
        {
            "sha": "62c2c6169f69c3cb6b680932e4bc19453095f2eb",
            "filename": "crates/napi/src/next_api/utils.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/13670aea5e88d4054d37d1b8828de8a0219c394a/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/13670aea5e88d4054d37d1b8828de8a0219c394a/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs?ref=13670aea5e88d4054d37d1b8828de8a0219c394a",
            "patch": "@@ -464,9 +464,8 @@ pub fn subscribe<T: 'static + Send + Sync, F: Future<Output = Result<T>> + Send,\n \n             let status = func.call(\n                 result.map_err(|e| {\n-                    let error = PrettyPrintError(&e).to_string();\n-                    log_internal_error_and_inform(&error);\n-                    napi::Error::from_reason(error)\n+                    log_internal_error_and_inform(&e);\n+                    napi::Error::from_reason(PrettyPrintError(&e).to_string())\n                 }),\n                 ThreadsafeFunctionCallMode::NonBlocking,\n             );"
        },
        {
            "sha": "2289baf2ea3662a72b167f1f0f77b3a223805726",
            "filename": "crates/napi/src/util.rs",
            "status": "modified",
            "additions": 35,
            "deletions": 4,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/13670aea5e88d4054d37d1b8828de8a0219c394a/crates%2Fnapi%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/13670aea5e88d4054d37d1b8828de8a0219c394a/crates%2Fnapi%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Futil.rs?ref=13670aea5e88d4054d37d1b8828de8a0219c394a",
            "patch": "@@ -40,8 +40,10 @@ use anyhow::anyhow;\n use napi::bindgen_prelude::{External, Status};\n use once_cell::sync::Lazy;\n use owo_colors::OwoColorize;\n+use terminal_hyperlink::Hyperlink;\n use tracing_chrome::{ChromeLayerBuilder, FlushGuard};\n use tracing_subscriber::{filter, prelude::*, util::SubscriberInitExt, Layer};\n+use turbopack_core::error::PrettyPrintError;\n \n static LOG_THROTTLE: Mutex<Option<Instant>> = Mutex::new(None);\n static LOG_DIVIDER: &str = \"---------------------------\";\n@@ -51,7 +53,7 @@ static PANIC_LOG: Lazy<PathBuf> = Lazy::new(|| {\n     path\n });\n \n-pub fn log_internal_error_and_inform(err_info: &str) {\n+pub fn log_internal_error_and_inform(internal_error: &anyhow::Error) {\n     if cfg!(debug_assertions)\n         || env::var(\"SWC_DEBUG\") == Ok(\"1\".to_string())\n         || env::var(\"CI\").is_ok_and(|v| !v.is_empty())\n@@ -61,7 +63,7 @@ pub fn log_internal_error_and_inform(err_info: &str) {\n         eprintln!(\n             \"{}: An unexpected Turbopack error occurred:\\n{}\",\n             \"FATAL\".red().bold(),\n-            err_info\n+            PrettyPrintError(internal_error)\n         );\n         return;\n     }\n@@ -122,8 +124,37 @@ pub fn log_internal_error_and_inform(err_info: &str) {\n         .open(PANIC_LOG.as_path())\n         .unwrap_or_else(|_| panic!(\"Failed to open {}\", PANIC_LOG.to_string_lossy()));\n \n-    writeln!(log_file, \"{}\\n{}\", LOG_DIVIDER, err_info).unwrap();\n-    eprintln!(\"{}: An unexpected Turbopack error occurred. Please report the content of {}, along with a description of what you were doing when the error occurred, to https://github.com/vercel/next.js/issues/new?template=1.bug_report.yml\", \"FATAL\".red().bold(), PANIC_LOG.to_string_lossy());\n+    let internal_error_str: String = PrettyPrintError(internal_error).to_string();\n+    writeln!(log_file, \"{}\\n{}\", LOG_DIVIDER, &internal_error_str).unwrap();\n+\n+    let title = format!(\n+        \"Turbopack Error: {}\",\n+        internal_error_str.lines().next().unwrap_or(\"Unknown\")\n+    );\n+    let version_str = format!(\"Turbopack version: `{}`\", env!(\"VERGEN_GIT_DESCRIBE\"));\n+    let new_discussion_url = if supports_hyperlinks::supports_hyperlinks() {\n+        \"clicking here.\".hyperlink(\n+            format!(\n+                \"https://github.com/vercel/next.js/discussions/new?category=turbopack-error-report&title={}&body={}&labels=Turbopack,Turbopack%20Panic%20Backtrace\",\n+                &urlencoding::encode(&title),\n+                &urlencoding::encode(&format!(\"{}\\n\\nError message:\\n```\\n{}\\n```\", &version_str, &internal_error_str))\n+            )\n+        )\n+    } else {\n+        format!(\n+            \"clicking here: https://github.com/vercel/next.js/discussions/new?category=turbopack-error-report&title={}&body={}&labels=Turbopack,Turbopack%20Panic%20Backtrace\",\n+            &urlencoding::encode(&title),\n+            &urlencoding::encode(&format!(\"{}\\n\\nError message:\\n```\\n{}\\n```\", &version_str, &title))\n+        )\n+    };\n+\n+    eprintln!(\n+        \"\\n-----\\n{}: An unexpected Turbopack error occurred. A panic log has been written to \\\n+         {}.\\n\\nTo help make Turbopack better, report this error by {}\\n-----\\n\",\n+        \"FATAL\".red().bold(),\n+        PANIC_LOG.to_string_lossy(),\n+        &new_discussion_url\n+    );\n }\n \n #[napi]"
        }
    ],
    "stats": {
        "total": 73,
        "additions": 54,
        "deletions": 19
    }
}