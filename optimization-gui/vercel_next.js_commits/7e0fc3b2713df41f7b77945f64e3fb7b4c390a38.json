{
    "author": "mischnic",
    "message": "Turbopack: refactor segment config parsing (#83297)\n\nCloses PACK-5382\n\nPreviously, Turbopack validated every single module for route segment config, leading to false positives (on non-page files) and worse build performance. There were also three separate implementations of this logic.\n\nNow, all of these cases are fatal errors, not just warnings.\n\n\n\nExamples for errors\n\n```\n./bench/basic-app/app/export/inherit/page.tsx:1:28\nNext.js can't recognize the exported `preferredRegion` field in route. It needs to be a static string or array of static strings.\n> 1 | export { default, runtime, preferredRegion } from '../basic/foo'\n    |                            ^^^^^^^^^^^^^^^\nThe exported configuration object in a source file needs to have a very specific format from which some properties can be statically parsed at compiled-time.\n\nhttps://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config\n```\n\nThis error message is slightly different now:\n\n```\n    browser log: ./test/integration/app-dir-export/app/another/[slug]/page.js:6:8\n    Next.js can't recognize the exported `generateStaticParams` field in route. App pages cannot use both \"use client\" and export function \"generateStaticParams()\".\n       4 |\n       5 |\n    >  6 | export function generateStaticParams() {\n         |        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    >  7 |   return [{ slug: 'first' }, { slug: 'second' }]\n         | ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\n    >  8 | }\n         | ^^\n       9 |\n      10 | export default async function Page(props) {\n      11 |   const params = await props.params\n\n    The exported configuration object in a source file needs to have a very specific format from which some properties can be statically parsed at compiled-time.\n\n    Import traces:\n      Client Component Browser:\n        ./test/integration/app-dir-export/app/another/[slug]/page.js [Client Component Browser]\n        ./test/integration/app-dir-export/app/another/[slug]/page.js [Server Component]\n\n      Client Component SSR:\n        ./test/integration/app-dir-export/app/another/[slug]/page.js [Client Component SSR]\n        ./test/integration/app-dir-export/app/another/[slug]/page.js [Server Component]\n\n    https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config\n```",
    "sha": "7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
    "files": [
        {
            "sha": "0bdda5f85b83e6fca9a4a469b9ea57396d988aa6",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -1,7 +1,6 @@\n use anyhow::{Context, Result, bail};\n use next_core::{\n     all_assets_from_entries,\n-    app_segment_config::NextSegmentConfig,\n     app_structure::{\n         AppPageLoaderTree, CollectedRootParams, Entrypoint as AppEntrypoint,\n         Entrypoints as AppEntrypoints, FileSystemPathVec, MetadataItem, collect_root_params,\n@@ -34,6 +33,7 @@ use next_core::{\n     },\n     next_server_utility::{NEXT_SERVER_UTILITY_MERGE_TAG, NextServerUtilityTransition},\n     parse_segment_config_from_source,\n+    segment_config::{NextSegmentConfig, ParseSegmentMode},\n     util::{NextRuntime, app_function_name, module_styles_rule_condition, styles_rule_condition},\n };\n use serde::{Deserialize, Serialize};\n@@ -1106,7 +1106,7 @@ impl AppEndpoint {\n \n             for layout in root_layouts.iter().rev() {\n                 let source = Vc::upcast(FileSource::new(layout.clone()));\n-                let layout_config = parse_segment_config_from_source(source);\n+                let layout_config = parse_segment_config_from_source(source, ParseSegmentMode::App);\n                 config.apply_parent_config(&*layout_config.await?);\n             }\n "
        },
        {
            "sha": "0c5590a394e3559efaf4abac7038a480bf2cba7f",
            "filename": "crates/next-api/src/middleware.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 11,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -7,7 +7,9 @@ use next_core::{\n     next_edge::entry::wrap_edge_entry,\n     next_manifests::{EdgeFunctionDefinition, MiddlewareMatcher, MiddlewaresManifestV2, Regions},\n     next_server::{ServerContextType, get_server_runtime_entries},\n-    util::{MiddlewareMatcherKind, NextRuntime, parse_config_from_source},\n+    parse_segment_config_from_source,\n+    segment_config::ParseSegmentMode,\n+    util::{MiddlewareMatcherKind, NextRuntime},\n };\n use tracing::Instrument;\n use turbo_rcstr::{RcStr, rcstr};\n@@ -86,10 +88,12 @@ impl MiddlewareEndpoint {\n             userland_module,\n         );\n \n-        let config =\n-            parse_config_from_source(*self.source, userland_module, NextRuntime::Edge).await?;\n+        let runtime = parse_segment_config_from_source(*self.source, ParseSegmentMode::Base)\n+            .await?\n+            .runtime\n+            .unwrap_or(NextRuntime::Edge);\n \n-        if matches!(config.runtime, NextRuntime::NodeJs) {\n+        if matches!(runtime, NextRuntime::NodeJs) {\n             return Ok(module);\n         }\n         Ok(wrap_edge_entry(\n@@ -175,11 +179,9 @@ impl MiddlewareEndpoint {\n     async fn output_assets(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n         let this = self.await?;\n \n-        let userland_module = self.userland_module();\n-\n         let config =\n-            parse_config_from_source(*self.await?.source, userland_module, NextRuntime::Edge)\n-                .await?;\n+            parse_segment_config_from_source(*self.await?.source, ParseSegmentMode::Base).await?;\n+        let runtime = config.runtime.unwrap_or(NextRuntime::Edge);\n \n         let next_config = this.project.next_config().await?;\n         let has_i18n = next_config.i18n.is_some();\n@@ -190,7 +192,7 @@ impl MiddlewareEndpoint {\n             .unwrap_or(false);\n         let base_path = next_config.base_path.as_ref();\n \n-        let matchers = if let Some(matchers) = config.matcher.as_ref() {\n+        let matchers = if let Some(matchers) = config.middleware_matcher.as_ref() {\n             matchers\n                 .iter()\n                 .map(|matcher| {\n@@ -247,7 +249,7 @@ impl MiddlewareEndpoint {\n             }]\n         };\n \n-        if matches!(config.runtime, NextRuntime::NodeJs) {\n+        if matches!(runtime, NextRuntime::NodeJs) {\n             let chunk = self.node_chunk().to_resolved().await?;\n             let mut output_assets = vec![chunk];\n             if this.project.next_mode().await?.is_production() {\n@@ -296,7 +298,7 @@ impl MiddlewareEndpoint {\n             let all_assets =\n                 get_asset_paths_from_root(&node_root_value, &all_output_assets).await?;\n \n-            let regions = if let Some(regions) = config.regions.as_ref() {\n+            let regions = if let Some(regions) = config.preferred_region.as_ref() {\n                 if regions.len() == 1 {\n                     regions\n                         .first()"
        },
        {
            "sha": "d8142686541958655cf46e22aada208c79f597f5",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 12,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -23,9 +23,9 @@ use next_core::{\n     pages_structure::{\n         PagesDirectoryStructure, PagesStructure, PagesStructureItem, find_pages_structure,\n     },\n-    util::{\n-        NextRuntime, get_asset_prefix_from_pathname, pages_function_name, parse_config_from_source,\n-    },\n+    parse_segment_config_from_source,\n+    segment_config::ParseSegmentMode,\n+    util::{NextRuntime, get_asset_prefix_from_pathname, pages_function_name},\n };\n use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n@@ -930,7 +930,9 @@ impl PageEndpoint {\n             .module();\n \n         let config =\n-            parse_config_from_source(self.source(), ssr_module, NextRuntime::default()).await?;\n+            parse_segment_config_from_source(self.source(), ParseSegmentMode::Base).await?;\n+\n+        let runtime = config.runtime.unwrap_or(NextRuntime::NodeJs);\n \n         Ok(\n             // `/_app` and `/_document` never get rendered directly so they don't need to be\n@@ -944,9 +946,9 @@ impl PageEndpoint {\n                     // /_app and /_document are always rendered for Node.js for this case. For edge\n                     // they're included in the page bundle.\n                     runtime: NextRuntime::NodeJs,\n-                    regions: config.regions.clone(),\n+                    regions: config.preferred_region.clone(),\n                 }\n-            } else if config.runtime == NextRuntime::Edge {\n+            } else if runtime == NextRuntime::Edge {\n                 let modules = create_page_ssr_entry_module(\n                     this.pathname.clone(),\n                     reference_type,\n@@ -955,7 +957,7 @@ impl PageEndpoint {\n                     self.source(),\n                     this.original_name.clone(),\n                     *this.pages_structure,\n-                    config.runtime,\n+                    runtime,\n                     this.pages_project.project().next_config(),\n                 )\n                 .await?;\n@@ -964,8 +966,8 @@ impl PageEndpoint {\n                     ssr_module: modules.ssr_module,\n                     app_module: modules.app_module,\n                     document_module: modules.document_module,\n-                    runtime: config.runtime,\n-                    regions: config.regions.clone(),\n+                    runtime,\n+                    regions: config.preferred_region.clone(),\n                 }\n             } else {\n                 let modules = create_page_ssr_entry_module(\n@@ -976,16 +978,16 @@ impl PageEndpoint {\n                     self.source(),\n                     this.original_name.clone(),\n                     *this.pages_structure,\n-                    config.runtime,\n+                    runtime,\n                     this.pages_project.project().next_config(),\n                 )\n                 .await?;\n                 InternalSsrChunkModule {\n                     ssr_module: modules.ssr_module,\n                     app_module: modules.app_module,\n                     document_module: modules.document_module,\n-                    runtime: config.runtime,\n-                    regions: config.regions.clone(),\n+                    runtime,\n+                    regions: config.preferred_region.clone(),\n                 }\n             }\n             .cell(),"
        },
        {
            "sha": "500a4e03dfbd87138a98acf2fe6158bf34180b33",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 11,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -21,7 +21,9 @@ use next_core::{\n         get_server_module_options_context, get_server_resolve_options_context,\n     },\n     next_telemetry::NextFeatureTelemetry,\n-    util::{NextRuntime, OptionEnvMap, parse_config_from_source},\n+    parse_segment_config_from_source,\n+    segment_config::ParseSegmentMode,\n+    util::{NextRuntime, OptionEnvMap},\n };\n use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n@@ -66,7 +68,6 @@ use turbopack_core::{\n         export_usage::{OptionExportUsageInfo, compute_export_usage_info},\n     },\n     output::{OutputAsset, OutputAssets},\n-    reference_type::{EntryReferenceSubType, ReferenceType},\n     resolve::{FindContextFileResult, find_context_file},\n     source_map::OptionStringifiedSourceMap,\n     version::{\n@@ -1412,16 +1413,12 @@ impl Project {\n         };\n         let source = Vc::upcast(FileSource::new(fs_path.clone()));\n \n-        let module = edge_module_context\n-            .process(\n-                source,\n-                ReferenceType::Entry(EntryReferenceSubType::Middleware),\n-            )\n-            .module();\n-\n-        let config = parse_config_from_source(source, module, NextRuntime::Edge).await?;\n+        let runtime = parse_segment_config_from_source(source, ParseSegmentMode::Base)\n+            .await?\n+            .runtime\n+            .unwrap_or(NextRuntime::Edge);\n \n-        if matches!(config.runtime, NextRuntime::NodeJs) {\n+        if matches!(runtime, NextRuntime::NodeJs) {\n             Ok(self.node_middleware_context())\n         } else {\n             Ok(edge_module_context)"
        },
        {
            "sha": "068f9e4e9210e1a19a35f03189acc382829aae91",
            "filename": "crates/next-core/src/app_segment_config.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 597,
            "changes": 597,
            "blob_url": "https://github.com/vercel/next.js/blob/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-core%2Fsrc%2Fapp_segment_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-core%2Fsrc%2Fapp_segment_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_segment_config.rs?ref=f2e3357b5b772da64da37a83b5be7c9195df07eb",
            "patch": "@@ -1,597 +0,0 @@\n-use std::{future::Future, ops::Deref};\n-\n-use anyhow::{Result, bail};\n-use serde::{Deserialize, Serialize};\n-use serde_json::Value;\n-use swc_core::{\n-    common::{GLOBALS, Span, Spanned, source_map::SmallPos},\n-    ecma::ast::{Decl, Expr, FnExpr, Ident, Program},\n-};\n-use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{\n-    NonLocalValue, ResolvedVc, TryJoinIterExt, ValueDefault, Vc, trace::TraceRawVcs,\n-    util::WrapFuture,\n-};\n-use turbo_tasks_fs::FileSystemPath;\n-use turbopack_core::{\n-    file_source::FileSource,\n-    ident::AssetIdent,\n-    issue::{\n-        Issue, IssueExt, IssueSeverity, IssueSource, IssueStage, OptionIssueSource,\n-        OptionStyledString, StyledString,\n-    },\n-    source::Source,\n-};\n-use turbopack_ecmascript::{\n-    EcmascriptInputTransforms, EcmascriptModuleAssetType,\n-    analyzer::{ConstantNumber, ConstantValue, JsValue, graph::EvalContext},\n-    parse::{ParseResult, parse},\n-};\n-\n-use crate::{app_structure::AppPageLoaderTree, util::NextRuntime};\n-\n-#[derive(\n-    Default, PartialEq, Eq, Clone, Copy, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n-)]\n-#[serde(rename_all = \"kebab-case\")]\n-pub enum NextSegmentDynamic {\n-    #[default]\n-    Auto,\n-    ForceDynamic,\n-    Error,\n-    ForceStatic,\n-}\n-\n-#[derive(\n-    Default, PartialEq, Eq, Clone, Copy, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n-)]\n-#[serde(rename_all = \"kebab-case\")]\n-pub enum NextSegmentFetchCache {\n-    #[default]\n-    Auto,\n-    DefaultCache,\n-    OnlyCache,\n-    ForceCache,\n-    DefaultNoStore,\n-    OnlyNoStore,\n-    ForceNoStore,\n-}\n-\n-#[derive(\n-    Default, PartialEq, Eq, Clone, Copy, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n-)]\n-pub enum NextRevalidate {\n-    #[default]\n-    Never,\n-    ForceCache,\n-    Frequency {\n-        seconds: u32,\n-    },\n-}\n-\n-#[turbo_tasks::value(into = \"shared\")]\n-#[derive(Debug, Default, Clone)]\n-pub struct NextSegmentConfig {\n-    pub dynamic: Option<NextSegmentDynamic>,\n-    pub dynamic_params: Option<bool>,\n-    pub revalidate: Option<NextRevalidate>,\n-    pub fetch_cache: Option<NextSegmentFetchCache>,\n-    pub runtime: Option<NextRuntime>,\n-    pub preferred_region: Option<Vec<RcStr>>,\n-    pub experimental_ppr: Option<bool>,\n-    /// Whether these metadata exports are defined in the source file.\n-    pub generate_image_metadata: bool,\n-    pub generate_sitemaps: bool,\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl ValueDefault for NextSegmentConfig {\n-    #[turbo_tasks::function]\n-    pub fn value_default() -> Vc<Self> {\n-        NextSegmentConfig::default().cell()\n-    }\n-}\n-\n-impl NextSegmentConfig {\n-    /// Applies the parent config to this config, setting any unset values to\n-    /// the parent's values.\n-    pub fn apply_parent_config(&mut self, parent: &Self) {\n-        let NextSegmentConfig {\n-            dynamic,\n-            dynamic_params,\n-            revalidate,\n-            fetch_cache,\n-            runtime,\n-            preferred_region,\n-            experimental_ppr,\n-            ..\n-        } = self;\n-        *dynamic = dynamic.or(parent.dynamic);\n-        *dynamic_params = dynamic_params.or(parent.dynamic_params);\n-        *revalidate = revalidate.or(parent.revalidate);\n-        *fetch_cache = fetch_cache.or(parent.fetch_cache);\n-        *runtime = runtime.or(parent.runtime);\n-        *preferred_region = preferred_region.take().or(parent.preferred_region.clone());\n-        *experimental_ppr = experimental_ppr.or(parent.experimental_ppr);\n-    }\n-\n-    /// Applies a config from a parallel route to this config, returning an\n-    /// error if there are conflicting values.\n-    pub fn apply_parallel_config(&mut self, parallel_config: &Self) -> Result<()> {\n-        fn merge_parallel<T: PartialEq + Clone>(\n-            a: &mut Option<T>,\n-            b: &Option<T>,\n-            name: &str,\n-        ) -> Result<()> {\n-            match (a.as_ref(), b) {\n-                (Some(a), Some(b)) => {\n-                    if *a != *b {\n-                        bail!(\n-                            \"Sibling segment configs have conflicting values for {}\",\n-                            name\n-                        )\n-                    }\n-                }\n-                (None, Some(b)) => {\n-                    *a = Some(b.clone());\n-                }\n-                _ => {}\n-            }\n-            Ok(())\n-        }\n-        let Self {\n-            dynamic,\n-            dynamic_params,\n-            revalidate,\n-            fetch_cache,\n-            runtime,\n-            preferred_region,\n-            experimental_ppr,\n-            ..\n-        } = self;\n-        merge_parallel(dynamic, &parallel_config.dynamic, \"dynamic\")?;\n-        merge_parallel(\n-            dynamic_params,\n-            &parallel_config.dynamic_params,\n-            \"dynamicParams\",\n-        )?;\n-        merge_parallel(revalidate, &parallel_config.revalidate, \"revalidate\")?;\n-        merge_parallel(fetch_cache, &parallel_config.fetch_cache, \"fetchCache\")?;\n-        merge_parallel(runtime, &parallel_config.runtime, \"runtime\")?;\n-        merge_parallel(\n-            preferred_region,\n-            &parallel_config.preferred_region,\n-            \"referredRegion\",\n-        )?;\n-        merge_parallel(\n-            experimental_ppr,\n-            &parallel_config.experimental_ppr,\n-            \"experimental_ppr\",\n-        )?;\n-        Ok(())\n-    }\n-}\n-\n-/// An issue that occurred while parsing the app segment config.\n-#[turbo_tasks::value(shared)]\n-pub struct NextSegmentConfigParsingIssue {\n-    ident: ResolvedVc<AssetIdent>,\n-    detail: ResolvedVc<StyledString>,\n-    source: IssueSource,\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl NextSegmentConfigParsingIssue {\n-    #[turbo_tasks::function]\n-    pub fn new(\n-        ident: ResolvedVc<AssetIdent>,\n-        detail: ResolvedVc<StyledString>,\n-        source: IssueSource,\n-    ) -> Vc<Self> {\n-        Self {\n-            ident,\n-            detail,\n-            source,\n-        }\n-        .cell()\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Issue for NextSegmentConfigParsingIssue {\n-    fn severity(&self) -> IssueSeverity {\n-        IssueSeverity::Warning\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn title(&self) -> Vc<StyledString> {\n-        StyledString::Text(rcstr!(\n-            \"Next.js can't recognize the exported `config` field in route\"\n-        ))\n-        .cell()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn stage(&self) -> Vc<IssueStage> {\n-        IssueStage::Parse.into()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn file_path(&self) -> Vc<FileSystemPath> {\n-        self.ident.path()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn description(&self) -> Vc<OptionStyledString> {\n-        Vc::cell(Some(\n-            StyledString::Text(rcstr!(\n-                \"The exported configuration object in a source file needs to have a very specific \\\n-                 format from which some properties can be statically parsed at compiled-time.\"\n-            ))\n-            .resolved_cell(),\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn detail(&self) -> Vc<OptionStyledString> {\n-        Vc::cell(Some(self.detail))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn documentation_link(&self) -> Vc<RcStr> {\n-        Vc::cell(rcstr!(\n-            \"https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config\"\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn source(&self) -> Vc<OptionIssueSource> {\n-        Vc::cell(Some(self.source))\n-    }\n-}\n-\n-#[turbo_tasks::function]\n-pub async fn parse_segment_config_from_source(\n-    source: ResolvedVc<Box<dyn Source>>,\n-) -> Result<Vc<NextSegmentConfig>> {\n-    let path = source.ident().path().await?;\n-\n-    // Don't try parsing if it's not a javascript file, otherwise it will emit an\n-    // issue causing the build to \"fail\".\n-    if path.path.ends_with(\".d.ts\")\n-        || !(path.path.ends_with(\".js\")\n-            || path.path.ends_with(\".jsx\")\n-            || path.path.ends_with(\".ts\")\n-            || path.path.ends_with(\".tsx\"))\n-    {\n-        return Ok(Default::default());\n-    }\n-\n-    let result = &*parse(\n-        *source,\n-        if path.path.ends_with(\".ts\") {\n-            EcmascriptModuleAssetType::Typescript {\n-                tsx: false,\n-                analyze_types: false,\n-            }\n-        } else if path.path.ends_with(\".tsx\") {\n-            EcmascriptModuleAssetType::Typescript {\n-                tsx: true,\n-                analyze_types: false,\n-            }\n-        } else {\n-            EcmascriptModuleAssetType::Ecmascript\n-        },\n-        EcmascriptInputTransforms::empty(),\n-    )\n-    .await?;\n-\n-    let ParseResult::Ok {\n-        program: Program::Module(module_ast),\n-        eval_context,\n-        globals,\n-        ..\n-    } = result\n-    else {\n-        return Ok(Default::default());\n-    };\n-\n-    let config = WrapFuture::new(\n-        async {\n-            let mut config = NextSegmentConfig::default();\n-\n-            for item in &module_ast.body {\n-                let Some(export_decl) = item\n-                    .as_module_decl()\n-                    .and_then(|mod_decl| mod_decl.as_export_decl())\n-                else {\n-                    continue;\n-                };\n-\n-                match &export_decl.decl {\n-                    Decl::Var(var_decl) => {\n-                        for decl in &var_decl.decls {\n-                            let Some(ident) = decl.name.as_ident().map(|ident| ident.deref())\n-                            else {\n-                                continue;\n-                            };\n-\n-                            if let Some(init) = decl.init.as_ref() {\n-                                parse_config_value(source, &mut config, ident, init, eval_context)\n-                                    .await?;\n-                            }\n-                        }\n-                    }\n-                    Decl::Fn(fn_decl) => {\n-                        let ident = &fn_decl.ident;\n-                        // create an empty expression of {}, we don't need init for function\n-                        let init = Expr::Fn(FnExpr {\n-                            ident: None,\n-                            function: fn_decl.function.clone(),\n-                        });\n-                        parse_config_value(source, &mut config, ident, &init, eval_context).await?;\n-                    }\n-                    _ => {}\n-                }\n-            }\n-            anyhow::Ok(config)\n-        },\n-        |f, ctx| GLOBALS.set(globals, || f.poll(ctx)),\n-    )\n-    .await?;\n-\n-    Ok(config.cell())\n-}\n-\n-async fn parse_config_value(\n-    source: ResolvedVc<Box<dyn Source>>,\n-    config: &mut NextSegmentConfig,\n-    ident: &Ident,\n-    init: &Expr,\n-    eval_context: &EvalContext,\n-) -> Result<()> {\n-    let span = init.span();\n-    async fn invalid_config(\n-        source: ResolvedVc<Box<dyn Source>>,\n-        span: Span,\n-        detail: &str,\n-        value: &JsValue,\n-    ) -> Result<()> {\n-        let (explainer, hints) = value.explain(2, 0);\n-        let detail =\n-            StyledString::Text(format!(\"{detail} Got {explainer}.{hints}\").into()).resolved_cell();\n-\n-        NextSegmentConfigParsingIssue::new(\n-            source.ident(),\n-            *detail,\n-            IssueSource::from_swc_offsets(source, span.lo.to_u32(), span.hi.to_u32()),\n-        )\n-        .to_resolved()\n-        .await?\n-        .emit();\n-        Ok(())\n-    }\n-\n-    match &*ident.sym {\n-        \"dynamic\" => {\n-            let value = eval_context.eval(init);\n-            let Some(val) = value.as_str() else {\n-                invalid_config(\n-                    source,\n-                    span,\n-                    \"`dynamic` needs to be a static string\",\n-                    &value,\n-                )\n-                .await?;\n-                return Ok(());\n-            };\n-\n-            config.dynamic = match serde_json::from_value(Value::String(val.to_string())) {\n-                Ok(dynamic) => Some(dynamic),\n-                Err(err) => {\n-                    invalid_config(\n-                        source,\n-                        span,\n-                        &format!(\"`dynamic` has an invalid value: {err}\"),\n-                        &value,\n-                    )\n-                    .await?;\n-                    return Ok(());\n-                }\n-            };\n-        }\n-        \"dynamicParams\" => {\n-            let value = eval_context.eval(init);\n-            let Some(val) = value.as_bool() else {\n-                invalid_config(\n-                    source,\n-                    span,\n-                    \"`dynamicParams` needs to be a static boolean\",\n-                    &value,\n-                )\n-                .await?;\n-                return Ok(());\n-            };\n-\n-            config.dynamic_params = Some(val);\n-        }\n-        \"revalidate\" => {\n-            let value = eval_context.eval(init);\n-            match value {\n-                JsValue::Constant(ConstantValue::Num(ConstantNumber(val))) if val >= 0.0 => {\n-                    config.revalidate = Some(NextRevalidate::Frequency {\n-                        seconds: val as u32,\n-                    });\n-                }\n-                JsValue::Constant(ConstantValue::False) => {\n-                    config.revalidate = Some(NextRevalidate::Never);\n-                }\n-                JsValue::Constant(ConstantValue::Str(str)) if str.as_str() == \"force-cache\" => {\n-                    config.revalidate = Some(NextRevalidate::ForceCache);\n-                }\n-                _ => {\n-                    //noop; revalidate validation occurs in runtime at\n-                    //https://github.com/vercel/next.js/blob/cd46c221d2b7f796f963d2b81eea1e405023db23/packages/next/src/server/lib/patch-fetch.ts#L20\n-                }\n-            }\n-        }\n-        \"fetchCache\" => {\n-            let value = eval_context.eval(init);\n-            let Some(val) = value.as_str() else {\n-                return invalid_config(\n-                    source,\n-                    span,\n-                    \"`fetchCache` needs to be a static string\",\n-                    &value,\n-                )\n-                .await;\n-            };\n-\n-            config.fetch_cache = match serde_json::from_value(Value::String(val.to_string())) {\n-                Ok(fetch_cache) => Some(fetch_cache),\n-                Err(err) => {\n-                    return invalid_config(\n-                        source,\n-                        span,\n-                        &format!(\"`fetchCache` has an invalid value: {err}\"),\n-                        &value,\n-                    )\n-                    .await;\n-                }\n-            };\n-        }\n-        \"runtime\" => {\n-            let value = eval_context.eval(init);\n-            let Some(val) = value.as_str() else {\n-                return invalid_config(\n-                    source,\n-                    span,\n-                    \"`runtime` needs to be a static string\",\n-                    &value,\n-                )\n-                .await;\n-            };\n-\n-            config.runtime = match serde_json::from_value(Value::String(val.to_string())) {\n-                Ok(runtime) => Some(runtime),\n-                Err(err) => {\n-                    return invalid_config(\n-                        source,\n-                        span,\n-                        &format!(\"`runtime` has an invalid value: {err}\"),\n-                        &value,\n-                    )\n-                    .await;\n-                }\n-            };\n-        }\n-        \"preferredRegion\" => {\n-            let value = eval_context.eval(init);\n-\n-            let preferred_region = match value {\n-                // Single value is turned into a single-element Vec.\n-                JsValue::Constant(ConstantValue::Str(str)) => vec![str.to_string().into()],\n-                // Array of strings is turned into a Vec. If one of the values in not a String it\n-                // will error.\n-                JsValue::Array { items, .. } => {\n-                    let mut regions = Vec::new();\n-                    for item in items {\n-                        if let JsValue::Constant(ConstantValue::Str(str)) = item {\n-                            regions.push(str.to_string().into());\n-                        } else {\n-                            return invalid_config(\n-                                source,\n-                                span,\n-                                \"Values of the `preferredRegion` array need to static strings\",\n-                                &item,\n-                            )\n-                            .await;\n-                        }\n-                    }\n-                    regions\n-                }\n-                _ => {\n-                    return invalid_config(\n-                        source,\n-                        span,\n-                        \"`preferredRegion` needs to be a static string or array of static strings\",\n-                        &value,\n-                    )\n-                    .await;\n-                }\n-            };\n-\n-            config.preferred_region = Some(preferred_region);\n-        }\n-        // Match exported generateImageMetadata function and generateSitemaps function, and pass\n-        // them to config.\n-        \"generateImageMetadata\" => {\n-            config.generate_image_metadata = true;\n-        }\n-        \"generateSitemaps\" => {\n-            config.generate_sitemaps = true;\n-        }\n-        \"experimental_ppr\" => {\n-            let value = eval_context.eval(init);\n-            let Some(val) = value.as_bool() else {\n-                return invalid_config(\n-                    source,\n-                    span,\n-                    \"`experimental_ppr` needs to be a static boolean\",\n-                    &value,\n-                )\n-                .await;\n-            };\n-\n-            config.experimental_ppr = Some(val);\n-        }\n-        _ => {}\n-    }\n-\n-    Ok(())\n-}\n-\n-#[turbo_tasks::function]\n-pub async fn parse_segment_config_from_loader_tree(\n-    loader_tree: Vc<AppPageLoaderTree>,\n-) -> Result<Vc<NextSegmentConfig>> {\n-    let loader_tree = &*loader_tree.await?;\n-\n-    Ok(parse_segment_config_from_loader_tree_internal(loader_tree)\n-        .await?\n-        .cell())\n-}\n-\n-pub async fn parse_segment_config_from_loader_tree_internal(\n-    loader_tree: &AppPageLoaderTree,\n-) -> Result<NextSegmentConfig> {\n-    let mut config = NextSegmentConfig::default();\n-\n-    let parallel_configs = loader_tree\n-        .parallel_routes\n-        .values()\n-        .map(|loader_tree| async move {\n-            Box::pin(parse_segment_config_from_loader_tree_internal(loader_tree)).await\n-        })\n-        .try_join()\n-        .await?;\n-\n-    for tree in parallel_configs {\n-        config.apply_parallel_config(&tree)?;\n-    }\n-\n-    let modules = &loader_tree.modules;\n-    for path in [\n-        modules.page.clone(),\n-        modules.default.clone(),\n-        modules.layout.clone(),\n-    ]\n-    .into_iter()\n-    .flatten()\n-    {\n-        let source = Vc::upcast(FileSource::new(path.clone()));\n-        config.apply_parent_config(&*parse_segment_config_from_source(source).await?);\n-    }\n-\n-    Ok(config)\n-}"
        },
        {
            "sha": "8613cd620b4988cae4d732f85f4e07d56628f6ce",
            "filename": "crates/next-core/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Flib.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -5,7 +5,6 @@\n #![feature(iter_intersperse)]\n \n mod app_page_loader_tree;\n-pub mod app_segment_config;\n pub mod app_structure;\n mod base_loader_tree;\n mod bootstrap;\n@@ -36,19 +35,18 @@ mod next_shared;\n pub mod next_telemetry;\n mod page_loader;\n pub mod pages_structure;\n+pub mod segment_config;\n pub mod tracing_presets;\n mod transform_options;\n pub mod url_node;\n pub mod util;\n \n-pub use app_segment_config::{\n-    parse_segment_config_from_loader_tree, parse_segment_config_from_source,\n-};\n pub use emit::{all_assets_from_entries, emit_all_assets, emit_assets};\n pub use next_edge::context::{\n     get_edge_chunking_context, get_edge_chunking_context_with_client_assets,\n     get_edge_compile_time_info, get_edge_resolve_options_context,\n };\n pub use next_import_map::get_next_package;\n pub use page_loader::{PageLoaderAsset, create_page_loader_entry_module};\n+pub use segment_config::{parse_segment_config_from_loader_tree, parse_segment_config_from_source};\n pub use util::{PathType, get_asset_path_from_pathname, pathname_for_path};"
        },
        {
            "sha": "20744e1ce07d8b897cec5b4042e29f2a08c8cd89",
            "filename": "crates/next-core/src/next_app/app_entry.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_entry.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -2,7 +2,7 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::ResolvedVc;\n use turbopack_core::module::Module;\n \n-use crate::app_segment_config::NextSegmentConfig;\n+use crate::segment_config::NextSegmentConfig;\n \n /// The entry module asset for a Next.js app route or page.\n #[turbo_tasks::value(shared)]"
        },
        {
            "sha": "0ef045e2f10ba1b5de509828dc8d241390d7964b",
            "filename": "crates/next-core/src/next_app/app_route_entry.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -11,11 +11,11 @@ use turbopack_core::{\n };\n \n use crate::{\n-    app_segment_config::NextSegmentConfig,\n     next_app::{AppEntry, AppPage, AppPath},\n     next_config::{NextConfig, OutputType},\n     next_edge::entry::wrap_edge_entry,\n     parse_segment_config_from_source,\n+    segment_config::{NextSegmentConfig, ParseSegmentMode},\n     util::{NextRuntime, app_function_name, load_next_js_template},\n };\n \n@@ -36,7 +36,7 @@ pub async fn get_app_route_entry(\n     original_segment_config: Option<Vc<NextSegmentConfig>>,\n     next_config: Vc<NextConfig>,\n ) -> Result<Vc<AppEntry>> {\n-    let segment_from_source = parse_segment_config_from_source(source);\n+    let segment_from_source = parse_segment_config_from_source(source, ParseSegmentMode::App);\n     let config = if let Some(original_segment_config) = original_segment_config {\n         let mut segment_config = segment_from_source.owned().await?;\n         segment_config.apply_parent_config(&*original_segment_config.await?);"
        },
        {
            "sha": "7da024ea2c0566902df405b4c305d9be5896bda5",
            "filename": "crates/next-core/src/next_app/metadata/route.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -27,6 +27,7 @@ use crate::{\n     },\n     next_config::NextConfig,\n     parse_segment_config_from_source,\n+    segment_config::ParseSegmentMode,\n };\n \n /// Computes the route source for a Next.js metadata file.\n@@ -68,7 +69,7 @@ pub async fn get_app_metadata_route_entry(\n     let original_path = metadata.clone().into_path();\n \n     let source = Vc::upcast(FileSource::new(original_path));\n-    let segment_config = parse_segment_config_from_source(source);\n+    let segment_config = parse_segment_config_from_source(source, ParseSegmentMode::App);\n     let is_dynamic_metadata = matches!(metadata, MetadataItem::Dynamic { .. });\n     let is_multi_dynamic: bool = if Some(segment_config).is_some() {\n         // is_multi_dynamic is true when config.generateSitemaps or"
        },
        {
            "sha": "5f16e5366ec239bcfa1d88e3fccd4006772b3d8a",
            "filename": "crates/next-core/src/next_client/transforms.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 8,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -15,9 +15,8 @@ use crate::{\n         get_server_actions_transform_rule, next_amp_attributes::get_next_amp_attr_rule,\n         next_cjs_optimizer::get_next_cjs_optimizer_rule,\n         next_disallow_re_export_all_in_page::get_next_disallow_export_all_in_page_rule,\n-        next_page_config::get_next_page_config_rule,\n-        next_page_static_info::get_next_page_static_info_assert_rule,\n-        next_pure::get_next_pure_rule, server_actions::ActionsTransform,\n+        next_page_config::get_next_page_config_rule, next_pure::get_next_pure_rule,\n+        server_actions::ActionsTransform,\n     },\n };\n \n@@ -103,11 +102,6 @@ pub async fn get_next_client_transforms_rules(\n         );\n \n         rules.push(get_next_image_rule().await?);\n-        rules.push(get_next_page_static_info_assert_rule(\n-            enable_mdx_rs,\n-            None,\n-            Some(context_ty),\n-        ));\n     }\n \n     Ok(rules)"
        },
        {
            "sha": "3b38103ae33569c0f9b78c03bb0df6bd63fc6773",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -18,7 +18,6 @@ use crate::{\n         next_disallow_re_export_all_in_page::get_next_disallow_export_all_in_page_rule,\n         next_edge_node_api_assert::next_edge_node_api_assert,\n         next_middleware_dynamic_assert::get_middleware_dynamic_assert_rule,\n-        next_page_static_info::get_next_page_static_info_assert_rule,\n         next_pure::get_next_pure_rule, server_actions::ActionsTransform,\n     },\n     util::{NextRuntime, module_styles_rule_condition, styles_rule_condition},\n@@ -66,14 +65,6 @@ pub async fn get_next_server_transforms_rules(\n         ]);\n     }\n \n-    if !foreign_code {\n-        rules.push(get_next_page_static_info_assert_rule(\n-            mdx_rs,\n-            Some(context_ty.clone()),\n-            None,\n-        ));\n-    }\n-\n     let use_cache_enabled = *next_config.enable_use_cache().await?;\n     let cache_kinds = next_config.cache_kinds().to_resolved().await?;\n     let mut is_app_dir = false;"
        },
        {
            "sha": "e92e52856cef2f8aec13af944a3ef97630c5960c",
            "filename": "crates/next-core/src/next_shared/transforms/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -11,7 +11,6 @@ pub(crate) mod next_lint;\n pub(crate) mod next_middleware_dynamic_assert;\n pub(crate) mod next_optimize_server_react;\n pub(crate) mod next_page_config;\n-pub(crate) mod next_page_static_info;\n pub(crate) mod next_pure;\n pub(crate) mod next_react_server_components;\n pub(crate) mod next_shake_exports;"
        },
        {
            "sha": "3217f8847b163ce27efc62a82ada7fcf5e704e90",
            "filename": "crates/next-core/src/next_shared/transforms/next_page_static_info.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 207,
            "changes": 207,
            "blob_url": "https://github.com/vercel/next.js/blob/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_static_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_static_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_page_static_info.rs?ref=f2e3357b5b772da64da37a83b5be7c9195df07eb",
            "patch": "@@ -1,207 +0,0 @@\n-use anyhow::Result;\n-use async_trait::async_trait;\n-use next_custom_transforms::transforms::page_static_info::{\n-    Const, collect_exported_const_visitor::GetMut, collect_exports, extract_exported_const_values,\n-};\n-use serde_json::Value;\n-use swc_core::{\n-    atoms::{Atom, atom},\n-    common::source_map::SmallPos,\n-    ecma::ast::Program,\n-};\n-use turbo_rcstr::rcstr;\n-use turbo_tasks::{ResolvedVc, Vc};\n-use turbo_tasks_fs::FileSystemPath;\n-use turbopack::module_options::{ModuleRule, ModuleRuleEffect};\n-use turbopack_core::issue::{\n-    Issue, IssueExt, IssueSeverity, IssueSource, IssueStage, OptionIssueSource, OptionStyledString,\n-    StyledString,\n-};\n-use turbopack_ecmascript::{CustomTransformer, EcmascriptInputTransform, TransformContext};\n-\n-use super::module_rule_match_js_no_url;\n-use crate::{next_client::ClientContextType, next_server::ServerContextType};\n-\n-/// Create a rule to run assertions for the page-static-info.\n-/// This assertion is partial implementation to the original\n-/// (analysis/get-page-static-info) Due to not able to bring all the evaluations\n-/// in the js implementation,\n-pub fn get_next_page_static_info_assert_rule(\n-    enable_mdx_rs: bool,\n-    server_context: Option<ServerContextType>,\n-    client_context: Option<ClientContextType>,\n-) -> ModuleRule {\n-    let transformer =\n-        EcmascriptInputTransform::Plugin(ResolvedVc::cell(Box::new(NextPageStaticInfo {\n-            server_context,\n-            client_context,\n-        }) as _));\n-    ModuleRule::new(\n-        module_rule_match_js_no_url(enable_mdx_rs),\n-        vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            preprocess: ResolvedVc::cell(vec![transformer]),\n-            main: ResolvedVc::cell(vec![]),\n-            postprocess: ResolvedVc::cell(vec![]),\n-        }],\n-    )\n-}\n-\n-#[derive(Debug)]\n-struct NextPageStaticInfo {\n-    server_context: Option<ServerContextType>,\n-    client_context: Option<ClientContextType>,\n-}\n-\n-#[derive(Default)]\n-struct PropertiesToExtract {\n-    config: Option<Const>,\n-}\n-impl GetMut<Atom, Option<Const>> for PropertiesToExtract {\n-    fn get_mut(&mut self, key: &Atom) -> Option<&mut Option<Const>> {\n-        if key == &atom!(\"config\") {\n-            Some(&mut self.config)\n-        } else {\n-            None\n-        }\n-    }\n-}\n-#[async_trait]\n-impl CustomTransformer for NextPageStaticInfo {\n-    #[tracing::instrument(level = tracing::Level::TRACE, name = \"next_page_static_info\", skip_all)]\n-    async fn transform(&self, program: &mut Program, ctx: &TransformContext<'_>) -> Result<()> {\n-        if let Some(collected_exports) = collect_exports(program)? {\n-            let mut properties_to_extract = PropertiesToExtract::default();\n-\n-            extract_exported_const_values(program, &mut properties_to_extract);\n-\n-            let is_server_layer_page = matches!(\n-                self.server_context,\n-                Some(ServerContextType::AppRSC { .. }) | Some(ServerContextType::AppSSR { .. })\n-            );\n-\n-            let is_app_page = is_server_layer_page\n-                || matches!(self.client_context, Some(ClientContextType::App { .. }));\n-\n-            if is_server_layer_page {\n-                for warning in collected_exports.warnings.iter() {\n-                    PageStaticInfoIssue {\n-                        source: IssueSource::from_swc_offsets(\n-                            ctx.source,\n-                            warning.span.lo.to_u32(),\n-                            warning.span.hi.to_u32(),\n-                        ),\n-                        messages: vec![\n-                            format!(\n-                                \"Next.js can't recognize the exported `{}` field in \\\"{}\\\" as {}.\",\n-                                warning.key, ctx.file_path_str, warning.message\n-                            ),\n-                            \"The default runtime will be used instead.\".to_string(),\n-                        ],\n-                        severity: IssueSeverity::Warning,\n-                    }\n-                    .resolved_cell()\n-                    .emit();\n-                }\n-            }\n-\n-            if is_app_page\n-                && let Some(Const::Value(Value::Object(config_obj), span)) =\n-                    properties_to_extract.config\n-            {\n-                let mut messages = vec![format!(\n-                    \"Page config in {} is deprecated. Replace `export const config=` with the \\\n-                     following:\",\n-                    ctx.file_path_str\n-                )];\n-\n-                if let Some(runtime) = config_obj.get(\"runtime\") {\n-                    messages.push(format!(\"- `export const runtime = {runtime}`\"));\n-                }\n-\n-                if let Some(regions) = config_obj.get(\"regions\") {\n-                    messages.push(format!(\"- `export const preferredRegion = {regions}`\"));\n-                }\n-\n-                messages.push(\"Visit https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config for more information.\".to_string());\n-\n-                PageStaticInfoIssue {\n-                    source: IssueSource::from_swc_offsets(\n-                        ctx.source,\n-                        span.lo.to_u32(),\n-                        span.hi.to_u32(),\n-                    ),\n-                    messages,\n-                    severity: IssueSeverity::Warning,\n-                }\n-                .resolved_cell()\n-                .emit();\n-            }\n-\n-            if collected_exports.directives.contains(&atom!(\"client\"))\n-                && let Some(span) = collected_exports.generate_static_params\n-                && is_app_page\n-            {\n-                PageStaticInfoIssue {\n-                    source: IssueSource::from_swc_offsets(\n-                        ctx.source,\n-                        span.lo.to_u32(),\n-                        span.hi.to_u32(),\n-                    ),\n-                    messages: vec![format!(r#\"Page \"{}\" cannot use both \"use client\" and export function \"generateStaticParams()\".\"#, ctx.file_path_str)],\n-                    severity: IssueSeverity::Error,\n-                }\n-                .resolved_cell()\n-                .emit();\n-            }\n-        }\n-\n-        Ok(())\n-    }\n-}\n-\n-#[turbo_tasks::value(shared)]\n-struct PageStaticInfoIssue {\n-    source: IssueSource,\n-    messages: Vec<String>,\n-    severity: IssueSeverity,\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Issue for PageStaticInfoIssue {\n-    fn severity(&self) -> IssueSeverity {\n-        self.severity\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn stage(&self) -> Vc<IssueStage> {\n-        IssueStage::Transform.into()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn title(&self) -> Vc<StyledString> {\n-        StyledString::Text(rcstr!(\"Invalid page configuration\")).cell()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn file_path(&self) -> Vc<FileSystemPath> {\n-        self.source.file_path()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn description(&self) -> Vc<OptionStyledString> {\n-        Vc::cell(Some(\n-            StyledString::Line(\n-                self.messages\n-                    .iter()\n-                    .map(|v| StyledString::Text(format!(\"{v}\\n\").into()))\n-                    .collect::<Vec<StyledString>>(),\n-            )\n-            .resolved_cell(),\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn source(&self) -> Vc<OptionIssueSource> {\n-        Vc::cell(Some(self.source))\n-    }\n-}"
        },
        {
            "sha": "c88876058f51edc68d224c45933727a4fa45d08f",
            "filename": "crates/next-core/src/segment_config.rs",
            "status": "added",
            "additions": 1277,
            "deletions": 0,
            "changes": 1277,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fsegment_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Fsegment_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fsegment_config.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -0,0 +1,1277 @@\n+use std::{borrow::Cow, future::Future};\n+\n+use anyhow::{Result, bail};\n+use serde::{Deserialize, Serialize};\n+use serde_json::Value;\n+use swc_core::{\n+    common::{DUMMY_SP, GLOBALS, Span, Spanned, source_map::SmallPos},\n+    ecma::{\n+        ast::{\n+            ClassExpr, Decl, ExportSpecifier, Expr, ExprStmt, FnExpr, Lit, ModuleDecl,\n+            ModuleExportName, ModuleItem, Program, Stmt, Str, TsSatisfiesExpr,\n+        },\n+        utils::IsDirective,\n+    },\n+};\n+use turbo_rcstr::{RcStr, rcstr};\n+use turbo_tasks::{\n+    NonLocalValue, ResolvedVc, TaskInput, TryJoinIterExt, ValueDefault, Vc, trace::TraceRawVcs,\n+    util::WrapFuture,\n+};\n+use turbo_tasks_fs::FileSystemPath;\n+use turbopack_core::{\n+    file_source::FileSource,\n+    ident::AssetIdent,\n+    issue::{\n+        Issue, IssueExt, IssueSeverity, IssueSource, IssueStage, OptionIssueSource,\n+        OptionStyledString, StyledString,\n+    },\n+    source::Source,\n+};\n+use turbopack_ecmascript::{\n+    EcmascriptInputTransforms, EcmascriptModuleAssetType,\n+    analyzer::{ConstantNumber, ConstantValue, JsValue, ObjectPart, graph::EvalContext},\n+    parse::{ParseResult, parse},\n+};\n+\n+use crate::{\n+    app_structure::AppPageLoaderTree,\n+    next_config::RouteHas,\n+    next_manifests::MiddlewareMatcher,\n+    util::{MiddlewareMatcherKind, NextRuntime},\n+};\n+\n+#[derive(\n+    Default, PartialEq, Eq, Clone, Copy, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n+)]\n+#[serde(rename_all = \"kebab-case\")]\n+pub enum NextSegmentDynamic {\n+    #[default]\n+    Auto,\n+    ForceDynamic,\n+    Error,\n+    ForceStatic,\n+}\n+\n+#[derive(\n+    Default, PartialEq, Eq, Clone, Copy, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n+)]\n+#[serde(rename_all = \"kebab-case\")]\n+pub enum NextSegmentFetchCache {\n+    #[default]\n+    Auto,\n+    DefaultCache,\n+    OnlyCache,\n+    ForceCache,\n+    DefaultNoStore,\n+    OnlyNoStore,\n+    ForceNoStore,\n+}\n+\n+#[derive(\n+    Default, PartialEq, Eq, Clone, Copy, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue,\n+)]\n+pub enum NextRevalidate {\n+    #[default]\n+    Never,\n+    ForceCache,\n+    Frequency {\n+        seconds: u32,\n+    },\n+}\n+\n+#[turbo_tasks::value(shared)]\n+#[derive(Debug, Default, Clone)]\n+pub struct NextSegmentConfig {\n+    pub dynamic: Option<NextSegmentDynamic>,\n+    pub dynamic_params: Option<bool>,\n+    pub revalidate: Option<NextRevalidate>,\n+    pub fetch_cache: Option<NextSegmentFetchCache>,\n+    pub runtime: Option<NextRuntime>,\n+    pub preferred_region: Option<Vec<RcStr>>,\n+    pub experimental_ppr: Option<bool>,\n+    pub middleware_matcher: Option<Vec<MiddlewareMatcherKind>>,\n+\n+    /// Whether these exports are defined in the source file.\n+    pub generate_image_metadata: bool,\n+    pub generate_sitemaps: bool,\n+    #[turbo_tasks(trace_ignore)]\n+    pub generate_static_params: Option<Span>,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl ValueDefault for NextSegmentConfig {\n+    #[turbo_tasks::function]\n+    pub fn value_default() -> Vc<Self> {\n+        NextSegmentConfig::default().cell()\n+    }\n+}\n+\n+impl NextSegmentConfig {\n+    /// Applies the parent config to this config, setting any unset values to\n+    /// the parent's values.\n+    pub fn apply_parent_config(&mut self, parent: &Self) {\n+        let NextSegmentConfig {\n+            dynamic,\n+            dynamic_params,\n+            revalidate,\n+            fetch_cache,\n+            runtime,\n+            preferred_region,\n+            experimental_ppr,\n+            ..\n+        } = self;\n+        *dynamic = dynamic.or(parent.dynamic);\n+        *dynamic_params = dynamic_params.or(parent.dynamic_params);\n+        *revalidate = revalidate.or(parent.revalidate);\n+        *fetch_cache = fetch_cache.or(parent.fetch_cache);\n+        *runtime = runtime.or(parent.runtime);\n+        *preferred_region = preferred_region.take().or(parent.preferred_region.clone());\n+        *experimental_ppr = experimental_ppr.or(parent.experimental_ppr);\n+    }\n+\n+    /// Applies a config from a parallel route to this config, returning an\n+    /// error if there are conflicting values.\n+    pub fn apply_parallel_config(&mut self, parallel_config: &Self) -> Result<()> {\n+        fn merge_parallel<T: PartialEq + Clone>(\n+            a: &mut Option<T>,\n+            b: &Option<T>,\n+            name: &str,\n+        ) -> Result<()> {\n+            match (a.as_ref(), b) {\n+                (Some(a), Some(b)) => {\n+                    if *a != *b {\n+                        bail!(\n+                            \"Sibling segment configs have conflicting values for {}\",\n+                            name\n+                        )\n+                    }\n+                }\n+                (None, Some(b)) => {\n+                    *a = Some(b.clone());\n+                }\n+                _ => {}\n+            }\n+            Ok(())\n+        }\n+        let Self {\n+            dynamic,\n+            dynamic_params,\n+            revalidate,\n+            fetch_cache,\n+            runtime,\n+            preferred_region,\n+            experimental_ppr,\n+            ..\n+        } = self;\n+        merge_parallel(dynamic, &parallel_config.dynamic, \"dynamic\")?;\n+        merge_parallel(\n+            dynamic_params,\n+            &parallel_config.dynamic_params,\n+            \"dynamicParams\",\n+        )?;\n+        merge_parallel(revalidate, &parallel_config.revalidate, \"revalidate\")?;\n+        merge_parallel(fetch_cache, &parallel_config.fetch_cache, \"fetchCache\")?;\n+        merge_parallel(runtime, &parallel_config.runtime, \"runtime\")?;\n+        merge_parallel(\n+            preferred_region,\n+            &parallel_config.preferred_region,\n+            \"preferredRegion\",\n+        )?;\n+        merge_parallel(\n+            experimental_ppr,\n+            &parallel_config.experimental_ppr,\n+            \"experimental_ppr\",\n+        )?;\n+        Ok(())\n+    }\n+}\n+\n+/// An issue that occurred while parsing the app segment config.\n+#[turbo_tasks::value(shared)]\n+pub struct NextSegmentConfigParsingIssue {\n+    ident: ResolvedVc<AssetIdent>,\n+    key: RcStr,\n+    error: RcStr,\n+    detail: Option<ResolvedVc<StyledString>>,\n+    source: IssueSource,\n+    severity: IssueSeverity,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl NextSegmentConfigParsingIssue {\n+    #[turbo_tasks::function]\n+    pub fn new(\n+        ident: ResolvedVc<AssetIdent>,\n+        key: RcStr,\n+        error: RcStr,\n+        detail: Option<ResolvedVc<StyledString>>,\n+        source: IssueSource,\n+        severity: IssueSeverity,\n+    ) -> Vc<Self> {\n+        Self {\n+            ident,\n+            key,\n+            error,\n+            detail,\n+            source,\n+            severity,\n+        }\n+        .cell()\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl Issue for NextSegmentConfigParsingIssue {\n+    fn severity(&self) -> IssueSeverity {\n+        self.severity\n+    }\n+\n+    #[turbo_tasks::function]\n+    async fn title(&self) -> Result<Vc<StyledString>> {\n+        Ok(StyledString::Line(vec![\n+            StyledString::Text(\n+                format!(\n+                    \"Next.js can't recognize the exported `{}` field in route. \",\n+                    self.key,\n+                )\n+                .into(),\n+            ),\n+            StyledString::Text(self.error.clone()),\n+        ])\n+        .cell())\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn stage(&self) -> Vc<IssueStage> {\n+        IssueStage::Parse.into()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn file_path(&self) -> Vc<FileSystemPath> {\n+        self.ident.path()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn description(&self) -> Vc<OptionStyledString> {\n+        Vc::cell(Some(\n+            StyledString::Text(rcstr!(\n+                \"The exported configuration object in a source file needs to have a very specific \\\n+                 format from which some properties can be statically parsed at compiled-time.\"\n+            ))\n+            .resolved_cell(),\n+        ))\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn detail(&self) -> Vc<OptionStyledString> {\n+        Vc::cell(self.detail)\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn documentation_link(&self) -> Vc<RcStr> {\n+        Vc::cell(rcstr!(\n+            \"https://nextjs.org/docs/app/api-reference/file-conventions/route-segment-config\"\n+        ))\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn source(&self) -> Vc<OptionIssueSource> {\n+        Vc::cell(Some(self.source))\n+    }\n+}\n+\n+#[derive(\n+    Debug,\n+    Clone,\n+    Copy,\n+    PartialEq,\n+    Eq,\n+    Hash,\n+    Serialize,\n+    Deserialize,\n+    TaskInput,\n+    NonLocalValue,\n+    TraceRawVcs,\n+)]\n+pub enum ParseSegmentMode {\n+    Base,\n+    // Disallows \"use client + generateStatic\" and ignores/warns about `export const config`\n+    App,\n+}\n+\n+#[turbo_tasks::function]\n+pub async fn parse_segment_config_from_source(\n+    source: ResolvedVc<Box<dyn Source>>,\n+    mode: ParseSegmentMode,\n+) -> Result<Vc<NextSegmentConfig>> {\n+    let path = source.ident().path().await?;\n+\n+    // Don't try parsing if it's not a javascript file, otherwise it will emit an\n+    // issue causing the build to \"fail\".\n+    if path.path.ends_with(\".d.ts\")\n+        || !(path.path.ends_with(\".js\")\n+            || path.path.ends_with(\".jsx\")\n+            || path.path.ends_with(\".ts\")\n+            || path.path.ends_with(\".tsx\"))\n+    {\n+        return Ok(Default::default());\n+    }\n+\n+    let result = &*parse(\n+        *source,\n+        if path.path.ends_with(\".ts\") {\n+            EcmascriptModuleAssetType::Typescript {\n+                tsx: false,\n+                analyze_types: false,\n+            }\n+        } else if path.path.ends_with(\".tsx\") {\n+            EcmascriptModuleAssetType::Typescript {\n+                tsx: true,\n+                analyze_types: false,\n+            }\n+        } else {\n+            EcmascriptModuleAssetType::Ecmascript\n+        },\n+        EcmascriptInputTransforms::empty(),\n+    )\n+    .await?;\n+\n+    let ParseResult::Ok {\n+        program: Program::Module(module_ast),\n+        eval_context,\n+        globals,\n+        ..\n+    } = result\n+    else {\n+        // The `parse` call has already emitted parse issues in case of `ParseResult::Unparsable`\n+        return Ok(Default::default());\n+    };\n+\n+    let config = WrapFuture::new(\n+        async {\n+            let mut config = NextSegmentConfig::default();\n+\n+            let mut parse = async |ident, init, span| {\n+                parse_config_value(source, mode, &mut config, eval_context, ident, init, span).await\n+            };\n+\n+            for item in &module_ast.body {\n+                match item {\n+                    ModuleItem::ModuleDecl(ModuleDecl::ExportDecl(decl)) => match &decl.decl {\n+                        Decl::Class(decl) => {\n+                            parse(\n+                                &decl.ident.sym,\n+                                Some(Cow::Owned(Expr::Class(ClassExpr {\n+                                    ident: None,\n+                                    class: decl.class.clone(),\n+                                }))),\n+                                decl.span(),\n+                            )\n+                            .await?\n+                        }\n+                        Decl::Fn(decl) => {\n+                            parse(\n+                                &decl.ident.sym,\n+                                Some(Cow::Owned(Expr::Fn(FnExpr {\n+                                    ident: None,\n+                                    function: decl.function.clone(),\n+                                }))),\n+                                decl.span(),\n+                            )\n+                            .await?\n+                        }\n+                        Decl::Var(decl) => {\n+                            for decl in &decl.decls {\n+                                let Some(ident) = decl.name.as_ident() else {\n+                                    continue;\n+                                };\n+\n+                                let key = &ident.id.sym;\n+\n+                                parse(\n+                                    key,\n+                                    Some(\n+                                        decl.init.as_deref().map(Cow::Borrowed).unwrap_or_else(\n+                                            || Cow::Owned(*Expr::undefined(DUMMY_SP)),\n+                                        ),\n+                                    ),\n+                                    // The config object can span hundreds of lines. Don't\n+                                    // highlight the whole thing\n+                                    if key == \"config\" {\n+                                        ident.id.span\n+                                    } else {\n+                                        decl.span()\n+                                    },\n+                                )\n+                                .await?;\n+                            }\n+                        }\n+                        _ => continue,\n+                    },\n+                    ModuleItem::ModuleDecl(ModuleDecl::ExportNamed(named)) => {\n+                        for specifier in &named.specifiers {\n+                            if let ExportSpecifier::Named(named) = specifier {\n+                                parse(\n+                                    match named.exported.as_ref().unwrap_or(&named.orig) {\n+                                        ModuleExportName::Ident(ident) => &ident.sym,\n+                                        ModuleExportName::Str(s) => &*s.value,\n+                                    },\n+                                    None,\n+                                    specifier.span(),\n+                                )\n+                                .await?;\n+                            }\n+                        }\n+                    }\n+                    _ => {\n+                        continue;\n+                    }\n+                }\n+            }\n+            anyhow::Ok(config)\n+        },\n+        |f, ctx| GLOBALS.set(globals, || f.poll(ctx)),\n+    )\n+    .await?;\n+\n+    if mode == ParseSegmentMode::App\n+        && let Some(span) = config.generate_static_params\n+        && module_ast\n+            .body\n+            .iter()\n+            .take_while(|i| match i {\n+                ModuleItem::Stmt(stmt) => stmt.directive_continue(),\n+                ModuleItem::ModuleDecl(_) => false,\n+            })\n+            .filter_map(|i| i.as_stmt())\n+            .any(|f| match f {\n+                Stmt::Expr(ExprStmt { expr, .. }) => match &**expr {\n+                    Expr::Lit(Lit::Str(Str { value, .. })) => value == \"use client\",\n+                    _ => false,\n+                },\n+                _ => false,\n+            })\n+    {\n+        invalid_config(\n+            source,\n+            \"generateStaticParams\",\n+            span,\n+            rcstr!(\n+                \"App pages cannot use both \\\"use client\\\" and export function \\\n+                 \\\"generateStaticParams()\\\".\"\n+            ),\n+            None,\n+            IssueSeverity::Error,\n+        )\n+        .await?;\n+    }\n+\n+    Ok(config.cell())\n+}\n+\n+async fn invalid_config(\n+    source: ResolvedVc<Box<dyn Source>>,\n+    key: &str,\n+    span: Span,\n+    error: RcStr,\n+    value: Option<&JsValue>,\n+    severity: IssueSeverity,\n+) -> Result<()> {\n+    let detail = if let Some(value) = value {\n+        let (explainer, hints) = value.explain(2, 0);\n+        Some(*StyledString::Text(format!(\"Got {explainer}.{hints}\").into()).resolved_cell())\n+    } else {\n+        None\n+    };\n+\n+    NextSegmentConfigParsingIssue::new(\n+        source.ident(),\n+        key.into(),\n+        error,\n+        detail,\n+        IssueSource::from_swc_offsets(source, span.lo.to_u32(), span.hi.to_u32()),\n+        severity,\n+    )\n+    .to_resolved()\n+    .await?\n+    .emit();\n+    Ok(())\n+}\n+\n+async fn parse_config_value(\n+    source: ResolvedVc<Box<dyn Source>>,\n+    mode: ParseSegmentMode,\n+    config: &mut NextSegmentConfig,\n+    eval_context: &EvalContext,\n+    key: &str,\n+    init: Option<Cow<'_, Expr>>,\n+    span: Span,\n+) -> Result<()> {\n+    let get_value = || {\n+        let init = init.as_deref();\n+        // Unwrap `export const config = { .. } satisfies MiddlewareConfig`, usually this is already\n+        // transpiled away, but we are looking at the original source here.\n+        let init = if let Some(Expr::TsSatisfies(TsSatisfiesExpr { expr, .. })) = init {\n+            Some(&**expr)\n+        } else {\n+            init\n+        };\n+        init.map(|init| eval_context.eval(init)).map(|v| {\n+            // Special case, as we don't call `link` here: assume that `undefined` is a free\n+            // variable.\n+            if let JsValue::FreeVar(name) = &v\n+                && name == \"undefined\"\n+            {\n+                JsValue::Constant(ConstantValue::Undefined)\n+            } else {\n+                v\n+            }\n+        })\n+    };\n+\n+    match key {\n+        \"config\" => {\n+            let Some(value) = get_value() else {\n+                return invalid_config(\n+                    source,\n+                    \"config\",\n+                    span,\n+                    rcstr!(\"It mustn't be reexported.\"),\n+                    None,\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+\n+            if mode == ParseSegmentMode::App {\n+                return invalid_config(\n+                    source,\n+                    \"config\",\n+                    span,\n+                    rcstr!(\n+                        \"Page config in `config` is deprecated and ignored, use individual \\\n+                         exports instead.\"\n+                    ),\n+                    Some(&value),\n+                    IssueSeverity::Warning,\n+                )\n+                .await;\n+            }\n+\n+            let JsValue::Object { parts, .. } = &value else {\n+                return invalid_config(\n+                    source,\n+                    \"config\",\n+                    span,\n+                    rcstr!(\"It needs to be a static object.\"),\n+                    Some(&value),\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+\n+            for part in parts {\n+                let ObjectPart::KeyValue(key, value) = part else {\n+                    return invalid_config(\n+                        source,\n+                        \"config\",\n+                        span,\n+                        rcstr!(\"It contains unsupported spread.\"),\n+                        Some(&value),\n+                        IssueSeverity::Error,\n+                    )\n+                    .await;\n+                };\n+\n+                let Some(key) = key.as_str() else {\n+                    return invalid_config(\n+                        source,\n+                        \"config\",\n+                        span,\n+                        rcstr!(\"It must only contain string keys.\"),\n+                        Some(value),\n+                        IssueSeverity::Error,\n+                    )\n+                    .await;\n+                };\n+\n+                if matches!(value, JsValue::Constant(ConstantValue::Undefined)) {\n+                    continue;\n+                }\n+                match key {\n+                    \"runtime\" => {\n+                        let Some(val) = value.as_str() else {\n+                            return invalid_config(\n+                                source,\n+                                \"config\",\n+                                span,\n+                                rcstr!(\"`runtime` needs to be a static string.\"),\n+                                Some(value),\n+                                IssueSeverity::Error,\n+                            )\n+                            .await;\n+                        };\n+\n+                        config.runtime =\n+                            match serde_json::from_value(Value::String(val.to_string())) {\n+                                Ok(runtime) => Some(runtime),\n+                                Err(err) => {\n+                                    return invalid_config(\n+                                        source,\n+                                        \"config\",\n+                                        span,\n+                                        format!(\"`runtime` has an invalid value: {err}.\").into(),\n+                                        Some(value),\n+                                        IssueSeverity::Error,\n+                                    )\n+                                    .await;\n+                                }\n+                            };\n+                    }\n+                    \"matcher\" => {\n+                        config.middleware_matcher =\n+                            parse_route_matcher_from_js_value(source, span, value).await?;\n+                    }\n+                    \"regions\" => {\n+                        config.preferred_region = parse_static_string_or_array_from_js_value(\n+                            source, span, \"config\", \"regions\", value,\n+                        )\n+                        .await?;\n+                    }\n+                    _ => {\n+                        // Ignore,\n+                    }\n+                }\n+            }\n+        }\n+        \"dynamic\" => {\n+            let Some(value) = get_value() else {\n+                return invalid_config(\n+                    source,\n+                    \"dynamic\",\n+                    span,\n+                    rcstr!(\"It mustn't be reexported.\"),\n+                    None,\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+            if matches!(value, JsValue::Constant(ConstantValue::Undefined)) {\n+                return Ok(());\n+            }\n+            let Some(val) = value.as_str() else {\n+                return invalid_config(\n+                    source,\n+                    \"dynamic\",\n+                    span,\n+                    rcstr!(\"It needs to be a static string.\"),\n+                    Some(&value),\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+\n+            config.dynamic = match serde_json::from_value(Value::String(val.to_string())) {\n+                Ok(dynamic) => Some(dynamic),\n+                Err(err) => {\n+                    return invalid_config(\n+                        source,\n+                        \"dynamic\",\n+                        span,\n+                        format!(\"It has an invalid value: {err}.\").into(),\n+                        Some(&value),\n+                        IssueSeverity::Error,\n+                    )\n+                    .await;\n+                }\n+            };\n+        }\n+        \"dynamicParams\" => {\n+            let Some(value) = get_value() else {\n+                return invalid_config(\n+                    source,\n+                    \"dynamicParams\",\n+                    span,\n+                    rcstr!(\"It mustn't be reexported.\"),\n+                    None,\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+            if matches!(value, JsValue::Constant(ConstantValue::Undefined)) {\n+                return Ok(());\n+            }\n+            let Some(val) = value.as_bool() else {\n+                return invalid_config(\n+                    source,\n+                    \"dynamicParams\",\n+                    span,\n+                    rcstr!(\"It needs to be a static boolean.\"),\n+                    Some(&value),\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+\n+            config.dynamic_params = Some(val);\n+        }\n+        \"revalidate\" => {\n+            let Some(value) = get_value() else {\n+                return invalid_config(\n+                    source,\n+                    \"revalidate\",\n+                    span,\n+                    rcstr!(\"It mustn't be reexported.\"),\n+                    None,\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+\n+            match value {\n+                JsValue::Constant(ConstantValue::Num(ConstantNumber(val))) if val >= 0.0 => {\n+                    config.revalidate = Some(NextRevalidate::Frequency {\n+                        seconds: val as u32,\n+                    });\n+                }\n+                JsValue::Constant(ConstantValue::False) => {\n+                    config.revalidate = Some(NextRevalidate::Never);\n+                }\n+                JsValue::Constant(ConstantValue::Str(str)) if str.as_str() == \"force-cache\" => {\n+                    config.revalidate = Some(NextRevalidate::ForceCache);\n+                }\n+                _ => {\n+                    //noop; revalidate validation occurs in runtime at\n+                    //https://github.com/vercel/next.js/blob/cd46c221d2b7f796f963d2b81eea1e405023db23/packages/next/src/server/lib/patch-fetch.ts#L20\n+                }\n+            }\n+        }\n+        \"fetchCache\" => {\n+            let Some(value) = get_value() else {\n+                return invalid_config(\n+                    source,\n+                    \"fetchCache\",\n+                    span,\n+                    rcstr!(\"It mustn't be reexported.\"),\n+                    None,\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+            if matches!(value, JsValue::Constant(ConstantValue::Undefined)) {\n+                return Ok(());\n+            }\n+            let Some(val) = value.as_str() else {\n+                return invalid_config(\n+                    source,\n+                    \"fetchCache\",\n+                    span,\n+                    rcstr!(\"It needs to be a static string.\"),\n+                    Some(&value),\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+\n+            config.fetch_cache = match serde_json::from_value(Value::String(val.to_string())) {\n+                Ok(fetch_cache) => Some(fetch_cache),\n+                Err(err) => {\n+                    return invalid_config(\n+                        source,\n+                        \"fetchCache\",\n+                        span,\n+                        format!(\"It has an invalid value: {err}.\").into(),\n+                        Some(&value),\n+                        IssueSeverity::Error,\n+                    )\n+                    .await;\n+                }\n+            };\n+        }\n+        \"runtime\" => {\n+            let Some(value) = get_value() else {\n+                return invalid_config(\n+                    source,\n+                    \"runtime\",\n+                    span,\n+                    rcstr!(\"It mustn't be reexported.\"),\n+                    None,\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+            if matches!(value, JsValue::Constant(ConstantValue::Undefined)) {\n+                return Ok(());\n+            }\n+            let Some(val) = value.as_str() else {\n+                return invalid_config(\n+                    source,\n+                    \"runtime\",\n+                    span,\n+                    rcstr!(\"It needs to be a static string.\"),\n+                    Some(&value),\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+\n+            config.runtime = match serde_json::from_value(Value::String(val.to_string())) {\n+                Ok(runtime) => Some(runtime),\n+                Err(err) => {\n+                    return invalid_config(\n+                        source,\n+                        \"runtime\",\n+                        span,\n+                        format!(\"It has an invalid value: {err}.\").into(),\n+                        Some(&value),\n+                        IssueSeverity::Error,\n+                    )\n+                    .await;\n+                }\n+            };\n+        }\n+        \"preferredRegion\" => {\n+            let Some(value) = get_value() else {\n+                return invalid_config(\n+                    source,\n+                    \"preferredRegion\",\n+                    span,\n+                    rcstr!(\"It mustn't be reexported.\"),\n+                    None,\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+            if matches!(value, JsValue::Constant(ConstantValue::Undefined)) {\n+                return Ok(());\n+            }\n+\n+            if let Some(preferred_region) = parse_static_string_or_array_from_js_value(\n+                source,\n+                span,\n+                \"preferredRegion\",\n+                \"preferredRegion\",\n+                &value,\n+            )\n+            .await?\n+            {\n+                config.preferred_region = Some(preferred_region);\n+            }\n+        }\n+        \"generateImageMetadata\" => {\n+            config.generate_image_metadata = true;\n+        }\n+        \"generateSitemaps\" => {\n+            config.generate_sitemaps = true;\n+        }\n+        \"generateStaticParams\" => {\n+            config.generate_static_params = Some(span);\n+        }\n+        \"experimental_ppr\" => {\n+            let Some(value) = get_value() else {\n+                return invalid_config(\n+                    source,\n+                    \"experimental_ppr\",\n+                    span,\n+                    rcstr!(\"It mustn't be reexported.\"),\n+                    None,\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+            if matches!(value, JsValue::Constant(ConstantValue::Undefined)) {\n+                return Ok(());\n+            }\n+            let Some(val) = value.as_bool() else {\n+                return invalid_config(\n+                    source,\n+                    \"experimental_ppr\",\n+                    span,\n+                    rcstr!(\"`experimental_ppr` needs to be a static boolean.\"),\n+                    Some(&value),\n+                    IssueSeverity::Error,\n+                )\n+                .await;\n+            };\n+\n+            config.experimental_ppr = Some(val);\n+        }\n+        _ => {}\n+    }\n+\n+    Ok(())\n+}\n+\n+async fn parse_static_string_or_array_from_js_value(\n+    source: ResolvedVc<Box<dyn Source>>,\n+    span: Span,\n+    key: &str,\n+    sub_key: &str,\n+    value: &JsValue,\n+) -> Result<Option<Vec<RcStr>>> {\n+    Ok(match value {\n+        // Single value is turned into a single-element Vec.\n+        JsValue::Constant(ConstantValue::Str(str)) => Some(vec![str.to_string().into()]),\n+        // Array of strings is turned into a Vec. If one of the values in not a String it\n+        // will error.\n+        JsValue::Array { items, .. } => {\n+            let mut result = Vec::new();\n+            for (i, item) in items.iter().enumerate() {\n+                if let Some(str) = item.as_str() {\n+                    result.push(str.to_string().into());\n+                } else {\n+                    invalid_config(\n+                        source,\n+                        key,\n+                        span,\n+                        format!(\n+                            \"Entry `{sub_key}[{i}]` needs to be a static string or array of \\\n+                             static strings.\"\n+                        )\n+                        .into(),\n+                        Some(item),\n+                        IssueSeverity::Error,\n+                    )\n+                    .await?;\n+                }\n+            }\n+            Some(result)\n+        }\n+        _ => {\n+            invalid_config(\n+                source,\n+                key,\n+                span,\n+                if sub_key != key {\n+                    format!(\"`{sub_key}` needs to be a static string or array of static strings.\")\n+                        .into()\n+                } else {\n+                    rcstr!(\"It needs to be a static string or array of static strings.\")\n+                },\n+                Some(value),\n+                IssueSeverity::Error,\n+            )\n+            .await?;\n+            return Ok(None);\n+        }\n+    })\n+}\n+\n+async fn parse_route_matcher_from_js_value(\n+    source: ResolvedVc<Box<dyn Source>>,\n+    span: Span,\n+    value: &JsValue,\n+) -> Result<Option<Vec<MiddlewareMatcherKind>>> {\n+    let parse_matcher_kind_matcher = async |value: &JsValue, sub_key: &str, matcher_idx: usize| {\n+        let mut route_has = vec![];\n+        if let JsValue::Array { items, .. } = value {\n+            for (i, item) in items.iter().enumerate() {\n+                if let JsValue::Object { parts, .. } = item {\n+                    let mut route_type = None;\n+                    let mut route_key = None;\n+                    let mut route_value = None;\n+\n+                    for matcher_part in parts {\n+                        if let ObjectPart::KeyValue(part_key, part_value) = matcher_part {\n+                            match part_key.as_str() {\n+                                Some(\"type\") => {\n+                                    if let Some(part_value) = part_value.as_str().filter(|v| {\n+                                        *v == \"header\"\n+                                            || *v == \"cookie\"\n+                                            || *v == \"query\"\n+                                            || *v == \"host\"\n+                                    }) {\n+                                        route_type = Some(part_value);\n+                                    } else {\n+                                        invalid_config(\n+                                            source,\n+                                            \"config\",\n+                                            span,\n+                                            format!(\n+                                                \"`matcher[{matcher_idx}].{sub_key}[{i}].type` \\\n+                                                 must be one of the strings: 'header', 'cookie', \\\n+                                                 'query', 'host'\"\n+                                            )\n+                                            .into(),\n+                                            Some(part_value),\n+                                            IssueSeverity::Error,\n+                                        )\n+                                        .await?;\n+                                    }\n+                                }\n+                                Some(\"key\") => {\n+                                    if let Some(part_value) = part_value.as_str() {\n+                                        route_key = Some(part_value);\n+                                    } else {\n+                                        invalid_config(\n+                                            source,\n+                                            \"config\",\n+                                            span,\n+                                            format!(\n+                                                \"`matcher[{matcher_idx}].{sub_key}[{i}].key` must \\\n+                                                 be a string\"\n+                                            )\n+                                            .into(),\n+                                            Some(part_value),\n+                                            IssueSeverity::Error,\n+                                        )\n+                                        .await?;\n+                                    }\n+                                }\n+                                Some(\"value\") => {\n+                                    if let Some(part_value) = part_value.as_str() {\n+                                        route_value = Some(part_value);\n+                                    } else {\n+                                        invalid_config(\n+                                            source,\n+                                            \"config\",\n+                                            span,\n+                                            format!(\n+                                                \"`matcher[{matcher_idx}].{sub_key}[{i}].value` \\\n+                                                 must be a string\"\n+                                            )\n+                                            .into(),\n+                                            Some(part_value),\n+                                            IssueSeverity::Error,\n+                                        )\n+                                        .await?;\n+                                    }\n+                                }\n+                                _ => {\n+                                    invalid_config(\n+                                        source,\n+                                        \"config\",\n+                                        span,\n+                                        format!(\n+                                            \"Unexpected property in \\\n+                                             `matcher[{matcher_idx}].{sub_key}[{i}]` object\"\n+                                        )\n+                                        .into(),\n+                                        Some(part_key),\n+                                        IssueSeverity::Error,\n+                                    )\n+                                    .await?;\n+                                }\n+                            }\n+                        }\n+                    }\n+                    let r = match route_type {\n+                        Some(\"header\") => route_key.map(|route_key| RouteHas::Header {\n+                            key: route_key.into(),\n+                            value: route_value.map(From::from),\n+                        }),\n+                        Some(\"cookie\") => route_key.map(|route_key| RouteHas::Cookie {\n+                            key: route_key.into(),\n+                            value: route_value.map(From::from),\n+                        }),\n+                        Some(\"query\") => route_key.map(|route_key| RouteHas::Query {\n+                            key: route_key.into(),\n+                            value: route_value.map(From::from),\n+                        }),\n+                        Some(\"host\") => route_value.map(|route_value| RouteHas::Host {\n+                            value: route_value.into(),\n+                        }),\n+                        _ => None,\n+                    };\n+\n+                    if let Some(r) = r {\n+                        route_has.push(r);\n+                    }\n+                }\n+            }\n+        }\n+\n+        anyhow::Ok(route_has)\n+    };\n+\n+    let mut matchers = vec![];\n+\n+    match value {\n+        JsValue::Constant(ConstantValue::Str(matcher)) => {\n+            matchers.push(MiddlewareMatcherKind::Str(matcher.to_string()));\n+        }\n+        JsValue::Array { items, .. } => {\n+            for (i, item) in items.iter().enumerate() {\n+                if let Some(matcher) = item.as_str() {\n+                    matchers.push(MiddlewareMatcherKind::Str(matcher.to_string()));\n+                } else if let JsValue::Object { parts, .. } = item {\n+                    let mut matcher = MiddlewareMatcher::default();\n+                    let mut had_source = false;\n+                    for matcher_part in parts {\n+                        if let ObjectPart::KeyValue(key, value) = matcher_part {\n+                            match key.as_str() {\n+                                Some(\"source\") => {\n+                                    if let Some(value) = value.as_str() {\n+                                        // TODO the actual validation would be:\n+                                        // - starts with /\n+                                        // - at most 4096 chars\n+                                        // - can be parsed with `path-to-regexp`\n+                                        had_source = true;\n+                                        matcher.original_source = value.into();\n+                                    } else {\n+                                        invalid_config(\n+                                            source,\n+                                            \"config\",\n+                                            span,\n+                                            format!(\n+                                                \"`source` in `matcher[{i}]` object must be a \\\n+                                                 string\"\n+                                            )\n+                                            .into(),\n+                                            Some(value),\n+                                            IssueSeverity::Error,\n+                                        )\n+                                        .await?;\n+                                    }\n+                                }\n+                                Some(\"locale\") => {\n+                                    if let Some(value) = value.as_bool()\n+                                        && !value\n+                                    {\n+                                        matcher.locale = false;\n+                                    } else if matches!(\n+                                        value,\n+                                        JsValue::Constant(ConstantValue::Undefined)\n+                                    ) {\n+                                        // ignore\n+                                    } else {\n+                                        invalid_config(\n+                                            source,\n+                                            \"config\",\n+                                            span,\n+                                            format!(\n+                                                \"`locale` in `matcher[{i}]` object must be false \\\n+                                                 or undefined\"\n+                                            )\n+                                            .into(),\n+                                            Some(value),\n+                                            IssueSeverity::Error,\n+                                        )\n+                                        .await?;\n+                                    }\n+                                }\n+                                Some(\"missing\") => {\n+                                    matcher.missing =\n+                                        Some(parse_matcher_kind_matcher(value, \"missing\", i).await?)\n+                                }\n+                                Some(\"has\") => {\n+                                    matcher.has =\n+                                        Some(parse_matcher_kind_matcher(value, \"has\", i).await?)\n+                                }\n+                                Some(\"regexp\") => {\n+                                    // ignored for now\n+                                }\n+                                _ => {\n+                                    invalid_config(\n+                                        source,\n+                                        \"config\",\n+                                        span,\n+                                        format!(\"Unexpected property in `matcher[{i}]` object\")\n+                                            .into(),\n+                                        Some(key),\n+                                        IssueSeverity::Error,\n+                                    )\n+                                    .await?;\n+                                }\n+                            }\n+                        }\n+                    }\n+                    if !had_source {\n+                        invalid_config(\n+                            source,\n+                            \"config\",\n+                            span,\n+                            format!(\"Missing `source` in `matcher[{i}]` object\").into(),\n+                            Some(value),\n+                            IssueSeverity::Error,\n+                        )\n+                        .await?;\n+                    }\n+\n+                    matchers.push(MiddlewareMatcherKind::Matcher(matcher));\n+                } else {\n+                    invalid_config(\n+                        source,\n+                        \"config\",\n+                        span,\n+                        format!(\n+                            \"Entry `matcher[{i}]` need to be static strings or static objects.\"\n+                        )\n+                        .into(),\n+                        Some(value),\n+                        IssueSeverity::Error,\n+                    )\n+                    .await?;\n+                }\n+            }\n+        }\n+        _ => {\n+            invalid_config(\n+                source,\n+                \"config\",\n+                span,\n+                rcstr!(\n+                    \"`matcher` needs to be a static string or array of static strings or array of \\\n+                     static objects.\"\n+                ),\n+                Some(value),\n+                IssueSeverity::Error,\n+            )\n+            .await?\n+        }\n+    }\n+\n+    Ok(if matchers.is_empty() {\n+        None\n+    } else {\n+        Some(matchers)\n+    })\n+}\n+\n+#[turbo_tasks::function]\n+pub async fn parse_segment_config_from_loader_tree(\n+    loader_tree: Vc<AppPageLoaderTree>,\n+) -> Result<Vc<NextSegmentConfig>> {\n+    let loader_tree = &*loader_tree.await?;\n+\n+    Ok(parse_segment_config_from_loader_tree_internal(loader_tree)\n+        .await?\n+        .cell())\n+}\n+\n+async fn parse_segment_config_from_loader_tree_internal(\n+    loader_tree: &AppPageLoaderTree,\n+) -> Result<NextSegmentConfig> {\n+    let mut config = NextSegmentConfig::default();\n+\n+    let parallel_configs = loader_tree\n+        .parallel_routes\n+        .values()\n+        .map(|loader_tree| async move {\n+            Box::pin(parse_segment_config_from_loader_tree_internal(loader_tree)).await\n+        })\n+        .try_join()\n+        .await?;\n+\n+    for tree in parallel_configs {\n+        config.apply_parallel_config(&tree)?;\n+    }\n+\n+    let modules = &loader_tree.modules;\n+    for path in [\n+        modules.page.clone(),\n+        modules.default.clone(),\n+        modules.layout.clone(),\n+    ]\n+    .into_iter()\n+    .flatten()\n+    {\n+        let source = Vc::upcast(FileSource::new(path.clone()));\n+        config.apply_parent_config(\n+            &*parse_segment_config_from_source(source, ParseSegmentMode::App).await?,\n+        );\n+    }\n+\n+    Ok(config)\n+}"
        },
        {
            "sha": "ffc26ac3cdb1325217110cca4112701555940794",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 512,
            "changes": 517,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -1,17 +1,10 @@\n-use std::{fmt::Display, future::Future, str::FromStr};\n+use std::{fmt::Display, str::FromStr};\n \n use anyhow::{Result, bail};\n use next_taskless::expand_next_js_template;\n use serde::{Deserialize, Serialize, de::DeserializeOwned};\n-use swc_core::{\n-    common::{GLOBALS, Spanned, source_map::SmallPos},\n-    ecma::ast::{Expr, Lit, Program},\n-};\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{\n-    FxIndexMap, NonLocalValue, ResolvedVc, TaskInput, ValueDefault, Vc, trace::TraceRawVcs,\n-    util::WrapFuture,\n-};\n+use turbo_tasks::{FxIndexMap, NonLocalValue, TaskInput, Vc, trace::TraceRawVcs};\n use turbo_tasks_fs::{\n     self, File, FileContent, FileSystem, FileSystemPath, json::parse_json_rope_with_source_context,\n     rope::Rope,\n@@ -21,26 +14,13 @@ use turbopack_core::{\n     asset::AssetContent,\n     compile_time_info::{CompileTimeDefineValue, CompileTimeDefines, DefinableNameSegment},\n     condition::ContextCondition,\n-    issue::{\n-        Issue, IssueExt, IssueSeverity, IssueSource, IssueStage, OptionIssueSource,\n-        OptionStyledString, StyledString,\n-    },\n-    module::Module,\n     source::Source,\n     virtual_source::VirtualSource,\n };\n-use turbopack_ecmascript::{\n-    EcmascriptParsable,\n-    analyzer::{ConstantValue, JsValue, ObjectPart},\n-    parse::ParseResult,\n-};\n \n use crate::{\n-    embed_js::next_js_fs,\n-    next_config::{NextConfig, RouteHas},\n-    next_import_map::get_next_package,\n-    next_manifests::MiddlewareMatcher,\n-    next_shared::webpack_rules::WebpackLoaderBuiltinCondition,\n+    embed_js::next_js_fs, next_config::NextConfig, next_import_map::get_next_package,\n+    next_manifests::MiddlewareMatcher, next_shared::webpack_rules::WebpackLoaderBuiltinCondition,\n };\n \n const NEXT_TEMPLATE_PATH: &str = \"dist/esm/build/templates\";\n@@ -249,499 +229,12 @@ impl NextRuntime {\n     }\n }\n \n-#[turbo_tasks::value]\n-#[derive(Debug, Clone)]\n+#[derive(PartialEq, Eq, Clone, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue)]\n pub enum MiddlewareMatcherKind {\n     Str(String),\n     Matcher(MiddlewareMatcher),\n }\n \n-#[turbo_tasks::value]\n-#[derive(Default, Clone)]\n-pub struct NextSourceConfig {\n-    pub runtime: NextRuntime,\n-\n-    /// Middleware router matchers\n-    pub matcher: Option<Vec<MiddlewareMatcherKind>>,\n-\n-    pub regions: Option<Vec<RcStr>>,\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl ValueDefault for NextSourceConfig {\n-    #[turbo_tasks::function]\n-    pub fn value_default() -> Vc<Self> {\n-        NextSourceConfig::default().cell()\n-    }\n-}\n-\n-/// An issue that occurred while parsing the page config.\n-#[turbo_tasks::value(shared)]\n-pub struct NextSourceConfigParsingIssue {\n-    source: IssueSource,\n-    detail: ResolvedVc<StyledString>,\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl NextSourceConfigParsingIssue {\n-    #[turbo_tasks::function]\n-    pub fn new(source: IssueSource, detail: ResolvedVc<StyledString>) -> Vc<Self> {\n-        Self { source, detail }.cell()\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Issue for NextSourceConfigParsingIssue {\n-    fn severity(&self) -> IssueSeverity {\n-        IssueSeverity::Warning\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn title(&self) -> Vc<StyledString> {\n-        StyledString::Text(rcstr!(\n-            \"Next.js can't recognize the exported `config` field in route\"\n-        ))\n-        .cell()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn stage(&self) -> Vc<IssueStage> {\n-        IssueStage::Parse.into()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn file_path(&self) -> Vc<FileSystemPath> {\n-        self.source.file_path()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn description(&self) -> Vc<OptionStyledString> {\n-        Vc::cell(Some(\n-            StyledString::Text(\n-                \"The exported configuration object in a source file need to have a very specific \\\n-                 format from which some properties can be statically parsed at compiled-time.\"\n-                    .into(),\n-            )\n-            .resolved_cell(),\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn detail(&self) -> Vc<OptionStyledString> {\n-        Vc::cell(Some(self.detail))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn source(&self) -> Vc<OptionIssueSource> {\n-        Vc::cell(Some(self.source))\n-    }\n-}\n-\n-async fn emit_invalid_config_warning(\n-    source: IssueSource,\n-    detail: &str,\n-    value: &JsValue,\n-) -> Result<()> {\n-    let (explainer, hints) = value.explain(2, 0);\n-    NextSourceConfigParsingIssue::new(\n-        source,\n-        StyledString::Text(format!(\"{detail} Got {explainer}.{hints}\").into()).cell(),\n-    )\n-    .to_resolved()\n-    .await?\n-    .emit();\n-    Ok(())\n-}\n-\n-async fn parse_route_matcher_from_js_value(\n-    source: IssueSource,\n-    value: &JsValue,\n-) -> Result<Option<Vec<MiddlewareMatcherKind>>> {\n-    let parse_matcher_kind_matcher = |value: &JsValue| {\n-        let mut route_has = vec![];\n-        if let JsValue::Array { items, .. } = value {\n-            for item in items {\n-                if let JsValue::Object { parts, .. } = item {\n-                    let mut route_type = None;\n-                    let mut route_key = None;\n-                    let mut route_value = None;\n-\n-                    for matcher_part in parts {\n-                        if let ObjectPart::KeyValue(part_key, part_value) = matcher_part {\n-                            match part_key.as_str() {\n-                                Some(\"type\") => {\n-                                    route_type = part_value.as_str().map(|v| v.to_string())\n-                                }\n-                                Some(\"key\") => {\n-                                    route_key = part_value.as_str().map(|v| v.to_string())\n-                                }\n-                                Some(\"value\") => {\n-                                    route_value = part_value.as_str().map(|v| v.to_string())\n-                                }\n-                                _ => {}\n-                            }\n-                        }\n-                    }\n-                    let r = match route_type.as_deref() {\n-                        Some(\"header\") => route_key.map(|route_key| RouteHas::Header {\n-                            key: route_key.into(),\n-                            value: route_value.map(From::from),\n-                        }),\n-                        Some(\"cookie\") => route_key.map(|route_key| RouteHas::Cookie {\n-                            key: route_key.into(),\n-                            value: route_value.map(From::from),\n-                        }),\n-                        Some(\"query\") => route_key.map(|route_key| RouteHas::Query {\n-                            key: route_key.into(),\n-                            value: route_value.map(From::from),\n-                        }),\n-                        Some(\"host\") => route_value.map(|route_value| RouteHas::Host {\n-                            value: route_value.into(),\n-                        }),\n-                        _ => None,\n-                    };\n-\n-                    if let Some(r) = r {\n-                        route_has.push(r);\n-                    }\n-                }\n-            }\n-        }\n-\n-        route_has\n-    };\n-\n-    let mut matchers = vec![];\n-\n-    match value {\n-        JsValue::Constant(matcher) => {\n-            if let Some(matcher) = matcher.as_str() {\n-                matchers.push(MiddlewareMatcherKind::Str(matcher.to_string()));\n-            } else {\n-                emit_invalid_config_warning(\n-                    source,\n-                    \"The matcher property must be a string or array of strings\",\n-                    value,\n-                )\n-                .await?;\n-            }\n-        }\n-        JsValue::Array { items, .. } => {\n-            for item in items {\n-                if let Some(matcher) = item.as_str() {\n-                    matchers.push(MiddlewareMatcherKind::Str(matcher.to_string()));\n-                } else if let JsValue::Object { parts, .. } = item {\n-                    let mut matcher = MiddlewareMatcher::default();\n-                    for matcher_part in parts {\n-                        if let ObjectPart::KeyValue(key, value) = matcher_part {\n-                            match key.as_str() {\n-                                Some(\"source\") => {\n-                                    if let Some(value) = value.as_str() {\n-                                        matcher.original_source = value.into();\n-                                    }\n-                                }\n-                                Some(\"locale\") => {\n-                                    matcher.locale = value.as_bool().unwrap_or_default();\n-                                }\n-                                Some(\"missing\") => {\n-                                    matcher.missing = Some(parse_matcher_kind_matcher(value))\n-                                }\n-                                Some(\"has\") => {\n-                                    matcher.has = Some(parse_matcher_kind_matcher(value))\n-                                }\n-                                _ => {\n-                                    //noop\n-                                }\n-                            }\n-                        }\n-                    }\n-\n-                    matchers.push(MiddlewareMatcherKind::Matcher(matcher));\n-                } else {\n-                    emit_invalid_config_warning(\n-                        source,\n-                        \"The matcher property must be a string or array of strings\",\n-                        value,\n-                    )\n-                    .await?;\n-                }\n-            }\n-        }\n-        _ => {\n-            emit_invalid_config_warning(\n-                source,\n-                \"The matcher property must be a string or array of strings\",\n-                value,\n-            )\n-            .await?\n-        }\n-    }\n-\n-    Ok(if matchers.is_empty() {\n-        None\n-    } else {\n-        Some(matchers)\n-    })\n-}\n-\n-#[turbo_tasks::function]\n-pub async fn parse_config_from_source(\n-    source: ResolvedVc<Box<dyn Source>>,\n-    module: ResolvedVc<Box<dyn Module>>,\n-    default_runtime: NextRuntime,\n-) -> Result<Vc<NextSourceConfig>> {\n-    if let Some(ecmascript_asset) = ResolvedVc::try_sidecast::<Box<dyn EcmascriptParsable>>(module)\n-        && let ParseResult::Ok {\n-            program: Program::Module(module_ast),\n-            globals,\n-            eval_context,\n-            ..\n-        } = &*ecmascript_asset.parse_original().await?\n-    {\n-        for item in &module_ast.body {\n-            if let Some(decl) = item\n-                .as_module_decl()\n-                .and_then(|mod_decl| mod_decl.as_export_decl())\n-                .and_then(|export_decl| export_decl.decl.as_var())\n-            {\n-                for decl in &decl.decls {\n-                    let decl_ident = decl.name.as_ident();\n-\n-                    // Check if there is exported config object `export const config = {...}`\n-                    // https://nextjs.org/docs/app/building-your-application/routing/middleware#matcher\n-                    if let Some(ident) = decl_ident\n-                        && ident.sym == \"config\"\n-                    {\n-                        if let Some(init) = decl.init.as_ref() {\n-                            return WrapFuture::new(\n-                                async {\n-                                    let value = eval_context.eval(init);\n-                                    Ok(parse_config_from_js_value(\n-                                        IssueSource::from_swc_offsets(\n-                                            source,\n-                                            init.span_lo().to_u32(),\n-                                            init.span_hi().to_u32(),\n-                                        ),\n-                                        &value,\n-                                        default_runtime,\n-                                    )\n-                                    .await?\n-                                    .cell())\n-                                },\n-                                |f, ctx| GLOBALS.set(globals, || f.poll(ctx)),\n-                            )\n-                            .await;\n-                        } else {\n-                            NextSourceConfigParsingIssue::new(\n-                                IssueSource::from_swc_offsets(\n-                                    source,\n-                                    ident.span_lo().to_u32(),\n-                                    ident.span_hi().to_u32(),\n-                                ),\n-                                StyledString::Text(rcstr!(\n-                                    \"The exported config object must contain an variable \\\n-                                     initializer.\"\n-                                ))\n-                                .cell(),\n-                            )\n-                            .to_resolved()\n-                            .await?\n-                            .emit();\n-                        }\n-                    }\n-                    // Or, check if there is segment runtime option\n-                    // https://nextjs.org/docs/app/building-your-application/rendering/edge-and-nodejs-runtimes#segment-runtime-Option\n-                    else if let Some(ident) = decl_ident\n-                        && ident.sym == \"runtime\"\n-                    {\n-                        let runtime_value_issue = NextSourceConfigParsingIssue::new(\n-                            IssueSource::from_swc_offsets(\n-                                source,\n-                                ident.span_lo().to_u32(),\n-                                ident.span_hi().to_u32(),\n-                            ),\n-                            StyledString::Text(rcstr!(\n-                                \"The runtime property must be either \\\"nodejs\\\" or \\\"edge\\\".\"\n-                            ))\n-                            .cell(),\n-                        )\n-                        .to_resolved()\n-                        .await?;\n-                        if let Some(init) = decl.init.as_ref() {\n-                            // skipping eval and directly read the expr's value, as we know it\n-                            // should be a const string\n-                            if let Expr::Lit(Lit::Str(str_value)) = &**init {\n-                                let mut config = NextSourceConfig::default();\n-\n-                                let runtime = &str_value.value;\n-                                match runtime.as_str() {\n-                                    \"edge\" | \"experimental-edge\" => {\n-                                        config.runtime = NextRuntime::Edge;\n-                                    }\n-                                    \"nodejs\" => {\n-                                        config.runtime = NextRuntime::NodeJs;\n-                                    }\n-                                    _ => {\n-                                        runtime_value_issue.emit();\n-                                    }\n-                                }\n-\n-                                return Ok(config.cell());\n-                            } else {\n-                                runtime_value_issue.emit();\n-                            }\n-                        } else {\n-                            NextSourceConfigParsingIssue::new(\n-                                IssueSource::from_swc_offsets(\n-                                    source,\n-                                    ident.span_lo().to_u32(),\n-                                    ident.span_hi().to_u32(),\n-                                ),\n-                                StyledString::Text(rcstr!(\n-                                    \"The exported segment runtime option must contain an variable \\\n-                                     initializer.\"\n-                                ))\n-                                .cell(),\n-                            )\n-                            .to_resolved()\n-                            .await?\n-                            .emit();\n-                        }\n-                    }\n-                }\n-            }\n-        }\n-    }\n-    let config = NextSourceConfig {\n-        runtime: default_runtime,\n-        ..Default::default()\n-    };\n-\n-    Ok(config.cell())\n-}\n-\n-async fn parse_config_from_js_value(\n-    source: IssueSource,\n-    value: &JsValue,\n-    default_runtime: NextRuntime,\n-) -> Result<NextSourceConfig> {\n-    let mut config = NextSourceConfig {\n-        runtime: default_runtime,\n-        ..Default::default()\n-    };\n-\n-    if let JsValue::Object { parts, .. } = value {\n-        for part in parts {\n-            match part {\n-                ObjectPart::Spread(_) => {\n-                    emit_invalid_config_warning(\n-                        source,\n-                        \"Spread properties are not supported in the config export.\",\n-                        value,\n-                    )\n-                    .await?\n-                }\n-                ObjectPart::KeyValue(key, value) => {\n-                    if let Some(key) = key.as_str() {\n-                        match key {\n-                            \"runtime\" => {\n-                                if let JsValue::Constant(runtime) = value {\n-                                    if let Some(runtime) = runtime.as_str() {\n-                                        match runtime {\n-                                            \"edge\" | \"experimental-edge\" => {\n-                                                config.runtime = NextRuntime::Edge;\n-                                            }\n-                                            \"nodejs\" => {\n-                                                config.runtime = NextRuntime::NodeJs;\n-                                            }\n-                                            _ => {\n-                                                emit_invalid_config_warning(\n-                                                    source,\n-                                                    \"The runtime property must be either \\\n-                                                     \\\"nodejs\\\" or \\\"edge\\\".\",\n-                                                    value,\n-                                                )\n-                                                .await?;\n-                                            }\n-                                        }\n-                                    }\n-                                } else {\n-                                    emit_invalid_config_warning(\n-                                        source,\n-                                        \"The runtime property must be a constant string.\",\n-                                        value,\n-                                    )\n-                                    .await?;\n-                                }\n-                            }\n-                            \"matcher\" => {\n-                                config.matcher =\n-                                    parse_route_matcher_from_js_value(source, value).await?;\n-                            }\n-                            \"regions\" => {\n-                                config.regions = match value {\n-                                    // Single value is turned into a single-element Vec.\n-                                    JsValue::Constant(ConstantValue::Str(str)) => {\n-                                        Some(vec![str.to_string().into()])\n-                                    }\n-                                    // Array of strings is turned into a Vec. If one of the values\n-                                    // in not a String it will\n-                                    // error.\n-                                    JsValue::Array { items, .. } => {\n-                                        let mut regions: Vec<RcStr> = Vec::new();\n-                                        for item in items {\n-                                            if let JsValue::Constant(ConstantValue::Str(str)) = item\n-                                            {\n-                                                regions.push(str.to_string().into());\n-                                            } else {\n-                                                emit_invalid_config_warning(\n-                                                    source,\n-                                                    \"Values of the `config.regions` array need to \\\n-                                                     static strings\",\n-                                                    item,\n-                                                )\n-                                                .await?;\n-                                            }\n-                                        }\n-                                        Some(regions)\n-                                    }\n-                                    _ => {\n-                                        emit_invalid_config_warning(\n-                                            source,\n-                                            \"`config.regions` needs to be a static string or \\\n-                                             array of static strings\",\n-                                            value,\n-                                        )\n-                                        .await?;\n-                                        None\n-                                    }\n-                                };\n-                            }\n-                            _ => {}\n-                        }\n-                    } else {\n-                        emit_invalid_config_warning(\n-                            source,\n-                            \"The exported config object must not contain non-constant strings.\",\n-                            key,\n-                        )\n-                        .await?;\n-                    }\n-                }\n-            }\n-        }\n-    } else {\n-        emit_invalid_config_warning(\n-            source,\n-            \"The exported config object must be a valid object literal.\",\n-            value,\n-        )\n-        .await?;\n-    }\n-\n-    Ok(config)\n-}\n-\n /// Loads a next.js template, replaces `replacements` and `injections` and makes\n /// sure there are none left over.\n pub async fn load_next_js_template("
        },
        {
            "sha": "bcf3c6ec702f00ce3c3b27385d984531e42f835e",
            "filename": "crates/next-custom-transforms/src/transforms/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fmod.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -12,7 +12,6 @@ pub mod next_ssg;\n pub mod optimize_barrel;\n pub mod optimize_server_react;\n pub mod page_config;\n-pub mod page_static_info;\n pub mod pure;\n pub mod react_server_components;\n pub mod server_actions;"
        },
        {
            "sha": "1798d121cda01ee6326e6e9b8f39ad8bf1159499",
            "filename": "crates/next-custom-transforms/src/transforms/page_static_info/collect_exported_const_visitor.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 238,
            "changes": 238,
            "blob_url": "https://github.com/vercel/next.js/blob/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exported_const_visitor.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exported_const_visitor.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exported_const_visitor.rs?ref=f2e3357b5b772da64da37a83b5be7c9195df07eb",
            "patch": "@@ -1,238 +0,0 @@\n-use serde_json::{Map, Number, Value};\n-use swc_core::{\n-    atoms::Atom,\n-    common::{Mark, Span, Spanned, SyntaxContext},\n-    ecma::{\n-        ast::{\n-            BindingIdent, Decl, ExportDecl, Expr, Lit, Module, ModuleDecl, ModuleItem, Pat,\n-            Program, Prop, PropName, PropOrSpread, VarDecl, VarDeclKind, VarDeclarator,\n-        },\n-        utils::{ExprCtx, ExprExt},\n-    },\n-};\n-\n-/// The values extracted for the corresponding AST node.\n-/// refer extract_exported_const_values for the supported value types.\n-/// Undefined / null is treated as None.\n-pub enum Const {\n-    Value(Value, Span),\n-    Unsupported(String, Span),\n-}\n-\n-pub(crate) struct CollectExportedConstVisitor<'a, M>\n-where\n-    M: GetMut<Atom, Option<Const>>,\n-{\n-    pub properties: &'a mut M,\n-    expr_ctx: ExprCtx,\n-}\n-\n-impl<'a, M> CollectExportedConstVisitor<'a, M>\n-where\n-    M: GetMut<Atom, Option<Const>>,\n-{\n-    pub fn new(properties: &'a mut M) -> Self {\n-        Self {\n-            properties,\n-            expr_ctx: ExprCtx {\n-                unresolved_ctxt: SyntaxContext::empty().apply_mark(Mark::new()),\n-                is_unresolved_ref_safe: false,\n-                in_strict: false,\n-                remaining_depth: 4,\n-            },\n-        }\n-    }\n-\n-    pub fn check_program(&mut self, program: &Program) {\n-        let Program::Module(Module { body, .. }) = program else {\n-            return;\n-        };\n-\n-        for module_item in body {\n-            if let ModuleItem::ModuleDecl(ModuleDecl::ExportDecl(ExportDecl {\n-                decl: Decl::Var(decl),\n-                ..\n-            })) = module_item\n-            {\n-                let VarDecl { kind, decls, .. } = &**decl;\n-                if kind == &VarDeclKind::Const {\n-                    for decl in decls {\n-                        if let VarDeclarator {\n-                            name: Pat::Ident(BindingIdent { id, .. }),\n-                            init: Some(init),\n-                            ..\n-                        } = decl\n-                        {\n-                            let id = &id.sym;\n-                            if let Some(prop) = self.properties.get_mut(id) {\n-                                *prop = extract_value(self.expr_ctx, init, id.to_string());\n-                            };\n-                        }\n-                    }\n-                }\n-            }\n-        }\n-    }\n-}\n-\n-pub trait GetMut<K, V> {\n-    fn get_mut(&mut self, key: &K) -> Option<&mut V>;\n-}\n-\n-/// Coerece the actual value of the given ast node.\n-fn extract_value(ctx: ExprCtx, init: &Expr, id: String) -> Option<Const> {\n-    match init {\n-        init if init.is_undefined(ctx) => Some(Const::Value(Value::Null, init.span())),\n-        Expr::Ident(ident) => Some(Const::Unsupported(\n-            format!(\"Unknown identifier \\\"{}\\\" at \\\"{}\\\".\", ident.sym, id),\n-            init.span(),\n-        )),\n-        Expr::Lit(lit) => match lit {\n-            Lit::Num(num) => Some(Const::Value(\n-                Value::Number(\n-                    Number::from_f64(num.value).expect(\"Should able to convert f64 to Number\"),\n-                ),\n-                init.span(),\n-            )),\n-            Lit::Null(_) => Some(Const::Value(Value::Null, init.span())),\n-            Lit::Str(s) => Some(Const::Value(\n-                Value::String(s.value.to_string()),\n-                init.span(),\n-            )),\n-            Lit::Bool(b) => Some(Const::Value(Value::Bool(b.value), init.span())),\n-            Lit::Regex(r) => Some(Const::Value(\n-                Value::String(format!(\"/{}/{}\", r.exp, r.flags)),\n-                init.span(),\n-            )),\n-            _ => Some(Const::Unsupported(\n-                \"Unsupported Literal\".to_string(),\n-                init.span(),\n-            )),\n-        },\n-        Expr::Array(arr) => {\n-            let mut a = vec![];\n-\n-            for elem in &arr.elems {\n-                match elem {\n-                    Some(elem) => {\n-                        if elem.spread.is_some() {\n-                            return Some(Const::Unsupported(\n-                                format!(\n-                                    \"Unsupported spread operator in the Array Expression at \\\n-                                     \\\"{id}\\\"\"\n-                                ),\n-                                init.span(),\n-                            ));\n-                        }\n-\n-                        match extract_value(ctx, &elem.expr, id.clone()) {\n-                            Some(Const::Value(value, _)) => a.push(value),\n-                            Some(Const::Unsupported(message, loc)) => {\n-                                return Some(Const::Unsupported(\n-                                    format!(\"Unsupported value in the Array Expression: {message}\"),\n-                                    loc,\n-                                ));\n-                            }\n-                            _ => {\n-                                return Some(Const::Unsupported(\n-                                    \"Unsupported value in the Array Expression\".to_string(),\n-                                    elem.expr.span(),\n-                                ));\n-                            }\n-                        }\n-                    }\n-                    None => {\n-                        a.push(Value::Null);\n-                    }\n-                }\n-            }\n-\n-            Some(Const::Value(Value::Array(a), arr.span()))\n-        }\n-        Expr::Object(obj) => {\n-            let mut o = Map::new();\n-\n-            for prop in &obj.props {\n-                let (key, value) = match prop {\n-                    PropOrSpread::Prop(box Prop::KeyValue(kv)) => (\n-                        match &kv.key {\n-                            PropName::Ident(i) => i.sym.as_ref(),\n-                            PropName::Str(s) => s.value.as_ref(),\n-                            _ => {\n-                                return Some(Const::Unsupported(\n-                                    format!(\n-                                        \"Unsupported key type in the Object Expression at \\\"{id}\\\"\"\n-                                    ),\n-                                    kv.key.span(),\n-                                ));\n-                            }\n-                        },\n-                        &kv.value,\n-                    ),\n-                    _ => {\n-                        return Some(Const::Unsupported(\n-                            format!(\n-                                \"Unsupported spread operator in the Object Expression at \\\"{id}\\\"\"\n-                            ),\n-                            prop.span(),\n-                        ));\n-                    }\n-                };\n-                let new_value = extract_value(ctx, value, format!(\"{id}.{key}\"));\n-                if let Some(Const::Unsupported(_, _)) = new_value {\n-                    return new_value;\n-                }\n-\n-                if let Some(Const::Value(value, _)) = new_value {\n-                    o.insert(key.to_string(), value);\n-                }\n-            }\n-\n-            Some(Const::Value(Value::Object(o), obj.span()))\n-        }\n-        Expr::Tpl(tpl) => {\n-            // [TODO] should we add support for `${'e'}d${'g'}'e'`?\n-            if !tpl.exprs.is_empty() {\n-                Some(Const::Unsupported(\n-                    format!(\"Unsupported template literal with expressions at \\\"{id}\\\".\"),\n-                    tpl.span(),\n-                ))\n-            } else {\n-                Some(\n-                    tpl.quasis\n-                        .first()\n-                        .map(|q| {\n-                            // When TemplateLiteral has 0 expressions, the length of quasis is\n-                            // always 1. Because when parsing\n-                            // TemplateLiteral, the parser yields the first quasi,\n-                            // then the first expression, then the next quasi, then the next\n-                            // expression, etc., until the last quasi.\n-                            // Thus if there is no expression, the parser ends at the first and also\n-                            // last quasis\n-                            //\n-                            // A \"cooked\" interpretation where backslashes have special meaning,\n-                            // while a \"raw\" interpretation where\n-                            // backslashes do not have special meaning https://exploringjs.com/impatient-js/ch_template-literals.html#template-strings-cooked-vs-raw\n-                            let cooked = q.cooked.as_ref();\n-                            let raw = q.raw.as_ref();\n-\n-                            Const::Value(\n-                                Value::String(\n-                                    cooked.map(|c| c.to_string()).unwrap_or(raw.to_string()),\n-                                ),\n-                                tpl.span(),\n-                            )\n-                        })\n-                        .unwrap_or(Const::Unsupported(\n-                            format!(\"Unsupported node type at \\\"{id}\\\"\"),\n-                            tpl.span(),\n-                        )),\n-                )\n-            }\n-        }\n-        _ => Some(Const::Unsupported(\n-            format!(\"Unsupported node type at \\\"{id}\\\"\"),\n-            init.span(),\n-        )),\n-    }\n-}"
        },
        {
            "sha": "bf0b10535b7448ac4f6a5e84b863fb53f291f7fe",
            "filename": "crates/next-custom-transforms/src/transforms/page_static_info/collect_exports_visitor.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 198,
            "changes": 198,
            "blob_url": "https://github.com/vercel/next.js/blob/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exports_visitor.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exports_visitor.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exports_visitor.rs?ref=f2e3357b5b772da64da37a83b5be7c9195df07eb",
            "patch": "@@ -1,198 +0,0 @@\n-use std::{iter::FromIterator, sync::LazyLock};\n-\n-use rustc_hash::FxHashSet;\n-use swc_core::{\n-    atoms::atom,\n-    common::Spanned,\n-    ecma::{\n-        ast::{\n-            Decl, ExportDecl, ExportNamedSpecifier, ExportSpecifier, Expr, ExprOrSpread, ExprStmt,\n-            Lit, ModuleExportName, ModuleItem, NamedExport, Pat, Stmt, Str, VarDeclarator,\n-        },\n-        visit::{Visit, VisitWith},\n-    },\n-};\n-\n-use super::{ExportInfo, ExportInfoWarning};\n-\n-static EXPORTS_SET: LazyLock<FxHashSet<&'static str>> = LazyLock::new(|| {\n-    FxHashSet::from_iter([\n-        \"getStaticProps\",\n-        \"getServerSideProps\",\n-        \"generateImageMetadata\",\n-        \"generateSitemaps\",\n-        \"generateStaticParams\",\n-    ])\n-});\n-\n-pub(crate) struct CollectExportsVisitor {\n-    pub export_info: Option<ExportInfo>,\n-}\n-\n-impl CollectExportsVisitor {\n-    pub fn new() -> Self {\n-        Self {\n-            export_info: Default::default(),\n-        }\n-    }\n-}\n-\n-impl Visit for CollectExportsVisitor {\n-    fn visit_module_items(&mut self, stmts: &[swc_core::ecma::ast::ModuleItem]) {\n-        let mut is_directive = true;\n-\n-        for stmt in stmts {\n-            if let ModuleItem::Stmt(Stmt::Expr(ExprStmt {\n-                expr: box Expr::Lit(Lit::Str(Str { value, .. })),\n-                ..\n-            })) = stmt\n-            {\n-                if is_directive {\n-                    if value == \"use server\" {\n-                        let export_info = self.export_info.get_or_insert(Default::default());\n-                        export_info.directives.insert(atom!(\"server\"));\n-                    }\n-                    if value == \"use client\" {\n-                        let export_info = self.export_info.get_or_insert(Default::default());\n-                        export_info.directives.insert(atom!(\"client\"));\n-                    }\n-                }\n-            } else {\n-                is_directive = false;\n-            }\n-\n-            stmt.visit_children_with(self);\n-        }\n-    }\n-\n-    fn visit_export_decl(&mut self, export_decl: &ExportDecl) {\n-        match &export_decl.decl {\n-            Decl::Var(box var_decl) => {\n-                if let Some(VarDeclarator {\n-                    name: Pat::Ident(name),\n-                    ..\n-                }) = var_decl.decls.first()\n-                {\n-                    if EXPORTS_SET.contains(&name.sym.as_str()) {\n-                        let export_info = self.export_info.get_or_insert(Default::default());\n-                        export_info.ssg = name.sym == \"getStaticProps\";\n-                        export_info.ssr = name.sym == \"getServerSideProps\";\n-                        export_info.generate_image_metadata =\n-                            Some(name.sym == \"generateImageMetadata\");\n-                        export_info.generate_sitemaps = Some(name.sym == \"generateSitemaps\");\n-                        export_info.generate_static_params =\n-                            (name.sym == \"generateStaticParams\").then_some(name.span());\n-                    }\n-                }\n-\n-                for decl in &var_decl.decls {\n-                    if let Pat::Ident(id) = &decl.name {\n-                        if id.sym == \"runtime\" {\n-                            let export_info = self.export_info.get_or_insert(Default::default());\n-                            export_info.runtime = decl.init.as_ref().and_then(|init| {\n-                                if let Expr::Lit(Lit::Str(Str { value, .. })) = &**init {\n-                                    Some(value.clone())\n-                                } else {\n-                                    None\n-                                }\n-                            })\n-                        } else if id.sym == \"preferredRegion\" {\n-                            if let Some(init) = &decl.init {\n-                                if let Expr::Array(arr) = &**init {\n-                                    for expr in arr.elems.iter().flatten() {\n-                                        if let ExprOrSpread {\n-                                            expr: box Expr::Lit(Lit::Str(Str { value, .. })),\n-                                            ..\n-                                        } = expr\n-                                        {\n-                                            let export_info =\n-                                                self.export_info.get_or_insert(Default::default());\n-                                            export_info.preferred_region.push(value.clone());\n-                                        }\n-                                    }\n-                                } else if let Expr::Lit(Lit::Str(Str { value, .. })) = &**init {\n-                                    let export_info =\n-                                        self.export_info.get_or_insert(Default::default());\n-                                    export_info.preferred_region.push(value.clone());\n-                                }\n-                            }\n-                        } else {\n-                            let export_info = self.export_info.get_or_insert(Default::default());\n-                            export_info.extra_properties.insert(id.sym.clone());\n-                        }\n-                    }\n-                }\n-            }\n-            Decl::Fn(fn_decl) => {\n-                let id = &fn_decl.ident;\n-\n-                let export_info = self.export_info.get_or_insert(Default::default());\n-                export_info.ssg = id.sym == \"getStaticProps\";\n-                export_info.ssr = id.sym == \"getServerSideProps\";\n-                export_info.generate_image_metadata = Some(id.sym == \"generateImageMetadata\");\n-                export_info.generate_sitemaps = Some(id.sym == \"generateSitemaps\");\n-                export_info.generate_static_params =\n-                    (id.sym == \"generateStaticParams\").then_some(id.span());\n-            }\n-            _ => {}\n-        }\n-\n-        export_decl.visit_children_with(self);\n-    }\n-\n-    fn visit_named_export(&mut self, named_export: &NamedExport) {\n-        for specifier in &named_export.specifiers {\n-            if let ExportSpecifier::Named(ExportNamedSpecifier {\n-                orig: ModuleExportName::Ident(value),\n-                ..\n-            }) = specifier\n-            {\n-                let export_info = self.export_info.get_or_insert(Default::default());\n-\n-                if !export_info.ssg && value.sym == \"getStaticProps\" {\n-                    export_info.ssg = true;\n-                }\n-\n-                if !export_info.ssr && value.sym == \"getServerSideProps\" {\n-                    export_info.ssr = true;\n-                }\n-\n-                if !export_info.generate_image_metadata.unwrap_or_default()\n-                    && value.sym == \"generateImageMetadata\"\n-                {\n-                    export_info.generate_image_metadata = Some(true);\n-                }\n-\n-                if !export_info.generate_sitemaps.unwrap_or_default()\n-                    && value.sym == \"generateSitemaps\"\n-                {\n-                    export_info.generate_sitemaps = Some(true);\n-                }\n-\n-                if export_info.generate_static_params.is_none()\n-                    && value.sym == \"generateStaticParams\"\n-                {\n-                    export_info.generate_static_params = Some(value.span());\n-                }\n-\n-                if export_info.runtime.is_none() && value.sym == \"runtime\" {\n-                    export_info.warnings.push(ExportInfoWarning::new(\n-                        value.sym.clone(),\n-                        \"it was not assigned to a string literal\",\n-                        value.span,\n-                    ));\n-                }\n-\n-                if export_info.preferred_region.is_empty() && value.sym == \"preferredRegion\" {\n-                    export_info.warnings.push(ExportInfoWarning::new(\n-                        value.sym.clone(),\n-                        \"it was not assigned to a string literal or an array of string literals\",\n-                        value.span,\n-                    ));\n-                }\n-            }\n-        }\n-\n-        named_export.visit_children_with(self);\n-    }\n-}"
        },
        {
            "sha": "7f063bea8dabd9ce1cb26b842abab9e6f44705f0",
            "filename": "crates/next-custom-transforms/src/transforms/page_static_info/mod.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 378,
            "changes": 378,
            "blob_url": "https://github.com/vercel/next.js/blob/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f2e3357b5b772da64da37a83b5be7c9195df07eb/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fmod.rs?ref=f2e3357b5b772da64da37a83b5be7c9195df07eb",
            "patch": "@@ -1,378 +0,0 @@\n-use anyhow::Result;\n-pub use collect_exported_const_visitor::Const;\n-use collect_exports_visitor::CollectExportsVisitor;\n-use once_cell::sync::Lazy;\n-use regex::Regex;\n-use rustc_hash::FxHashSet;\n-use serde::{Deserialize, Serialize};\n-use swc_core::{\n-    atoms::Atom,\n-    base::SwcComments,\n-    common::{Span, GLOBALS},\n-    ecma::{ast::Program, visit::VisitWith},\n-};\n-\n-use crate::transforms::page_static_info::collect_exported_const_visitor::GetMut;\n-\n-pub mod collect_exported_const_visitor;\n-pub mod collect_exports_visitor;\n-\n-#[derive(Debug, Default)]\n-pub struct MiddlewareConfig {}\n-\n-#[derive(Debug)]\n-pub enum Amp {\n-    Boolean(bool),\n-    Hybrid,\n-}\n-\n-#[derive(Debug, Default)]\n-pub struct PageStaticInfo {\n-    // [TODO] next-core have NextRuntime type, but the order of dependency won't allow to import\n-    // Since this value is being passed into JS context anyway, we can just use string for now.\n-    pub runtime: Option<Atom>, // 'nodejs' | 'experimental-edge' | 'edge'\n-    pub preferred_region: Vec<Atom>,\n-    pub ssg: Option<bool>,\n-    pub ssr: Option<bool>,\n-    pub rsc: Option<Atom>, // 'server' | 'client'\n-    pub generate_static_params: Option<bool>,\n-    pub middleware: Option<MiddlewareConfig>,\n-    pub amp: Option<Amp>,\n-}\n-\n-#[derive(Debug, Default, Serialize)]\n-#[serde(rename_all = \"camelCase\")]\n-pub struct ExportInfoWarning {\n-    pub key: Atom,\n-    pub message: &'static str,\n-    pub span: Span,\n-}\n-\n-impl ExportInfoWarning {\n-    pub fn new(key: Atom, message: &'static str, span: Span) -> Self {\n-        Self { key, message, span }\n-    }\n-}\n-\n-#[derive(Debug, Default, Serialize)]\n-#[serde(rename_all = \"camelCase\")]\n-pub struct ExportInfo {\n-    pub ssr: bool,\n-    pub ssg: bool,\n-    #[serde(skip_serializing_if = \"Option::is_none\")]\n-    pub runtime: Option<Atom>,\n-    #[serde(skip_serializing_if = \"Vec::is_empty\")]\n-    pub preferred_region: Vec<Atom>,\n-    pub generate_image_metadata: Option<bool>,\n-    pub generate_sitemaps: Option<bool>,\n-    pub generate_static_params: Option<Span>,\n-    pub extra_properties: FxHashSet<Atom>,\n-    pub directives: FxHashSet<Atom>,\n-    /// extra properties to bubble up warning messages from visitor,\n-    /// since this isn't a failure to abort the process.\n-    pub warnings: Vec<ExportInfoWarning>,\n-}\n-\n-/// Collects static page export information for the next.js from given source's\n-/// AST. This is being used for some places like detecting page\n-/// is a dynamic route or not, or building a PageStaticInfo object.\n-pub fn collect_exports(program: &Program) -> Result<Option<ExportInfo>> {\n-    let mut collect_export_visitor = CollectExportsVisitor::new();\n-    program.visit_with(&mut collect_export_visitor);\n-\n-    Ok(collect_export_visitor.export_info)\n-}\n-\n-static CLIENT_MODULE_LABEL: Lazy<Regex> = Lazy::new(|| {\n-    Regex::new(\" __next_internal_client_entry_do_not_use__ ([^ ]*) (cjs|auto) \").unwrap()\n-});\n-static ACTION_MODULE_LABEL: Lazy<Regex> =\n-    Lazy::new(|| Regex::new(r#\" __next_internal_action_entry_do_not_use__ (\\{[^}]+\\}) \"#).unwrap());\n-\n-#[derive(Debug, PartialEq, Clone, Serialize, Deserialize)]\n-#[serde(rename_all = \"camelCase\")]\n-pub struct RscModuleInfo {\n-    #[serde(rename = \"type\")]\n-    pub module_type: String,\n-    pub actions: Option<Vec<String>>,\n-    pub is_client_ref: bool,\n-    pub client_refs: Option<Vec<String>>,\n-    pub client_entry_type: Option<String>,\n-}\n-\n-impl RscModuleInfo {\n-    pub fn new(module_type: String) -> Self {\n-        Self {\n-            module_type,\n-            actions: None,\n-            is_client_ref: false,\n-            client_refs: None,\n-            client_entry_type: None,\n-        }\n-    }\n-}\n-\n-/// Parse comments from the given source code and collect the RSC module info.\n-/// This doesn't use visitor, only read comments to parse necessary information.\n-pub fn collect_rsc_module_info(\n-    comments: &SwcComments,\n-    is_react_server_layer: bool,\n-) -> RscModuleInfo {\n-    let mut captured = None;\n-\n-    for comment in comments.leading.iter() {\n-        let parsed = comment.iter().find_map(|c| {\n-            let actions_json = ACTION_MODULE_LABEL.captures(&c.text);\n-            let client_info_match = CLIENT_MODULE_LABEL.captures(&c.text);\n-\n-            if actions_json.is_none() && client_info_match.is_none() {\n-                return None;\n-            }\n-\n-            let actions = if let Some(actions_json) = actions_json {\n-                if let Ok(serde_json::Value::Object(map)) =\n-                    serde_json::from_str::<serde_json::Value>(&actions_json[1])\n-                {\n-                    Some(\n-                        map.iter()\n-                            // values for the action json should be a string\n-                            .map(|(_, v)| v.as_str().unwrap_or_default().to_string())\n-                            .collect::<Vec<_>>(),\n-                    )\n-                } else {\n-                    None\n-                }\n-            } else {\n-                None\n-            };\n-\n-            let is_client_ref = client_info_match.is_some();\n-            let client_info = client_info_match.map(|client_info_match| {\n-                (\n-                    client_info_match[1]\n-                        .split(',')\n-                        .map(|s| s.to_string())\n-                        .collect::<Vec<_>>(),\n-                    client_info_match[2].to_string(),\n-                )\n-            });\n-\n-            Some((actions, is_client_ref, client_info))\n-        });\n-\n-        if captured.is_none() {\n-            captured = parsed;\n-            break;\n-        }\n-    }\n-\n-    match captured {\n-        Some((actions, is_client_ref, client_info)) => {\n-            if !is_react_server_layer {\n-                let mut module_info = RscModuleInfo::new(\"client\".to_string());\n-                module_info.actions = actions;\n-                module_info.is_client_ref = is_client_ref;\n-                module_info\n-            } else {\n-                let mut module_info = RscModuleInfo::new(if client_info.is_some() {\n-                    \"client\".to_string()\n-                } else {\n-                    \"server\".to_string()\n-                });\n-                module_info.actions = actions;\n-                module_info.is_client_ref = is_client_ref;\n-                if let Some((client_refs, client_entry_type)) = client_info {\n-                    module_info.client_refs = Some(client_refs);\n-                    module_info.client_entry_type = Some(client_entry_type);\n-                }\n-\n-                module_info\n-            }\n-        }\n-        None => RscModuleInfo::new(if !is_react_server_layer {\n-            \"client\".to_string()\n-        } else {\n-            \"server\".to_string()\n-        }),\n-    }\n-}\n-\n-/// Extracts the value of an exported const variable named `exportedName`\n-/// (e.g. \"export const config = { runtime: 'edge' }\") from swc's AST.\n-/// The value must be one of\n-///   - string\n-///   - boolean\n-///   - number\n-///   - null\n-///   - undefined\n-///   - array containing values listed in this list\n-///   - object containing values listed in this list\n-///\n-/// Returns a map of the extracted values, or either contains corresponding\n-/// error.\n-pub fn extract_exported_const_values(\n-    source_ast: &Program,\n-    properties_to_extract: &mut impl GetMut<Atom, Option<Const>>,\n-) {\n-    GLOBALS.set(&Default::default(), || {\n-        let mut visitor =\n-            collect_exported_const_visitor::CollectExportedConstVisitor::new(properties_to_extract);\n-\n-        visitor.check_program(source_ast);\n-    })\n-}\n-\n-#[cfg(test)]\n-mod tests {\n-    use std::{path::PathBuf, sync::Arc};\n-\n-    use anyhow::Result;\n-    use swc_core::{\n-        base::{\n-            config::{IsModule, ParseOptions},\n-            try_with_handler, Compiler, HandlerOpts, SwcComments,\n-        },\n-        common::{errors::ColorConfig, FilePathMapping, SourceMap, GLOBALS},\n-        ecma::{\n-            ast::Program,\n-            parser::{EsSyntax, Syntax, TsSyntax},\n-        },\n-    };\n-\n-    use super::{collect_rsc_module_info, RscModuleInfo};\n-\n-    fn build_ast_from_source(contents: &str, file_path: &str) -> Result<(Program, SwcComments)> {\n-        GLOBALS.set(&Default::default(), || {\n-            let c = Compiler::new(Arc::new(SourceMap::new(FilePathMapping::empty())));\n-\n-            let options = ParseOptions {\n-                is_module: IsModule::Unknown,\n-                syntax: if file_path.ends_with(\".ts\") || file_path.ends_with(\".tsx\") {\n-                    Syntax::Typescript(TsSyntax {\n-                        tsx: true,\n-                        decorators: true,\n-                        ..Default::default()\n-                    })\n-                } else {\n-                    Syntax::Es(EsSyntax {\n-                        jsx: true,\n-                        decorators: true,\n-                        ..Default::default()\n-                    })\n-                },\n-                ..Default::default()\n-            };\n-\n-            let fm = c.cm.new_source_file(\n-                swc_core::common::FileName::Real(PathBuf::from(file_path.to_string())).into(),\n-                contents.to_string(),\n-            );\n-\n-            let comments = c.comments().clone();\n-\n-            try_with_handler(\n-                c.cm.clone(),\n-                HandlerOpts {\n-                    color: ColorConfig::Never,\n-                    skip_filename: false,\n-                },\n-                |handler| {\n-                    c.parse_js(\n-                        fm,\n-                        handler,\n-                        options.target,\n-                        options.syntax,\n-                        options.is_module,\n-                        Some(&comments),\n-                    )\n-                },\n-            )\n-            .map_err(|e| e.to_pretty_error())\n-            .map(|p| (p, comments))\n-        })\n-    }\n-\n-    #[test]\n-    fn should_parse_server_info() {\n-        let input = r#\"export default function Page() {\n-          return <p>app-edge-ssr</p>\n-        }\n-\n-        export const runtime = 'edge'\n-        export const maxDuration = 4\n-        \"#;\n-\n-        let (_, comments) = build_ast_from_source(input, \"some-file.js\")\n-            .expect(\"Should able to parse test fixture input\");\n-\n-        let module_info = collect_rsc_module_info(&comments, true);\n-        let expected = RscModuleInfo {\n-            module_type: \"server\".to_string(),\n-            actions: None,\n-            is_client_ref: false,\n-            client_refs: None,\n-            client_entry_type: None,\n-        };\n-\n-        assert_eq!(module_info, expected);\n-    }\n-\n-    #[test]\n-    fn should_parse_actions_json() {\n-        let input = r#\"\n-      /* __next_internal_action_entry_do_not_use__ {\"ab21efdafbe611287bc25c0462b1e0510d13e48b\":\"foo\"} */ import { createActionProxy } from \"private-next-rsc-action-proxy\";\n-      import { encryptActionBoundArgs, decryptActionBoundArgs } from \"private-next-rsc-action-encryption\";\n-      export function foo() {}\n-      import { ensureServerEntryExports } from \"private-next-rsc-action-validate\";\n-      ensureServerEntryExports([\n-          foo\n-      ]);\n-      createActionProxy(\"ab21efdafbe611287bc25c0462b1e0510d13e48b\", foo);\n-      \"#;\n-\n-        let (_, comments) = build_ast_from_source(input, \"some-file.js\")\n-            .expect(\"Should able to parse test fixture input\");\n-\n-        let module_info = collect_rsc_module_info(&comments, true);\n-        let expected = RscModuleInfo {\n-            module_type: \"server\".to_string(),\n-            actions: Some(vec![\"foo\".to_string()]),\n-            is_client_ref: false,\n-            client_refs: None,\n-            client_entry_type: None,\n-        };\n-\n-        assert_eq!(module_info, expected);\n-    }\n-\n-    #[test]\n-    fn should_parse_client_refs() {\n-        let input = r#\"\n-      // This is a comment.\n-      /* __next_internal_client_entry_do_not_use__ default,a,b,c,*,f auto */ const { createProxy  } = require(\"private-next-rsc-mod-ref-proxy\");\n-      module.exports = createProxy(\"/some-project/src/some-file.js\");\n-      \"#;\n-\n-        let (_, comments) = build_ast_from_source(input, \"some-file.js\")\n-            .expect(\"Should able to parse test fixture input\");\n-\n-        let module_info = collect_rsc_module_info(&comments, true);\n-\n-        let expected = RscModuleInfo {\n-            module_type: \"client\".to_string(),\n-            actions: None,\n-            is_client_ref: true,\n-            client_refs: Some(vec![\n-                \"default\".to_string(),\n-                \"a\".to_string(),\n-                \"b\".to_string(),\n-                \"c\".to_string(),\n-                \"*\".to_string(),\n-                \"f\".to_string(),\n-            ]),\n-            client_entry_type: Some(\"auto\".to_string()),\n-        };\n-\n-        assert_eq!(module_info, expected);\n-    }\n-}"
        },
        {
            "sha": "36c06a81b440cf77ebf272fd1c58dff82d95b8ff",
            "filename": "test/e2e/app-dir/app-edge/app-edge-invalid-reexport.test.ts",
            "status": "added",
            "additions": 53,
            "deletions": 0,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp-edge-invalid-reexport.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp-edge-invalid-reexport.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp-edge-invalid-reexport.test.ts?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -0,0 +1,53 @@\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+\n+describe('app-dir edge SSR invalid reexport', () => {\n+  const { next, isNextDev, skipped } = nextTestSetup({\n+    files: {\n+      'app/export': new FileRef(path.join(__dirname, 'app', 'export')),\n+      'app/export/inherit/page.tsx':\n+        \"export { default, runtime, preferredRegion } from '../basic/page'\",\n+    },\n+    skipStart: true,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should warn or error about the re-export of a pages runtime/preferredRegion config', async () => {\n+    try {\n+      await next.start()\n+    } catch (_) {\n+      // We expect the build to fail\n+    }\n+\n+    if (isNextDev) {\n+      const browser = await next.browser('/export/inherit')\n+      // Turbopack is stricter and disallows reexports completely\n+      // webpack merely warns in the CLI and still serves the page wuthout a redbox\n+      if (process.env.IS_TURBOPACK_TEST) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"Next.js can't recognize the exported \\`preferredRegion\\` field in route. It mustn't be reexported.\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./app/export/inherit/page.tsx (1:28)\n+         Next.js can't recognize the exported \\`preferredRegion\\` field in route. It mustn't be reexported.\n+         > 1 | export { default, runtime, preferredRegion } from '../basic/page'\n+             |                            ^^^^^^^^^^^^^^^\",\n+           \"stack\": [],\n+         }\n+        `)\n+      }\n+    }\n+\n+    expect(next.cliOutput).toInclude(\n+      `Next.js can't recognize the exported \\`runtime\\` field in`\n+    )\n+    expect(next.cliOutput).toInclude(\n+      `Next.js can't recognize the exported \\`preferredRegion\\` field in`\n+    )\n+  })\n+})"
        },
        {
            "sha": "d8a1f2776e2f4ef6a5d4a9306442e9a5e84d023d",
            "filename": "test/e2e/app-dir/app-edge/app-edge.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 23,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp-edge.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp-edge.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp-edge.test.ts?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -35,29 +35,6 @@ describe('app-dir edge SSR', () => {\n   })\n \n   if ((globalThis as any).isNextDev) {\n-    it('should warn about the re-export of a pages runtime/preferredRegion config', async () => {\n-      const logs = []\n-      next.on('stderr', (log) => {\n-        logs.push(log)\n-      })\n-      const appHtml = await next.render('/export/inherit')\n-      expect(appHtml).toContain('<p>Node!</p>')\n-      expect(\n-        logs.some((log) =>\n-          log.includes(\n-            `Next.js can't recognize the exported \\`runtime\\` field in`\n-          )\n-        )\n-      ).toBe(true)\n-      expect(\n-        logs.some((log) =>\n-          log.includes(\n-            `Next.js can't recognize the exported \\`preferredRegion\\` field in`\n-          )\n-        )\n-      ).toBe(true)\n-    })\n-\n     it('should resolve module without error in edge runtime', async () => {\n       const logs = []\n       next.on('stderr', (log) => {"
        },
        {
            "sha": "172653b53a939ac92eb8cf63d37f33f4ef58fe25",
            "filename": "test/e2e/app-dir/app-edge/app/export/inherit/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp%2Fexport%2Finherit%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp%2Fexport%2Finherit%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-edge%2Fapp%2Fexport%2Finherit%2Fpage.tsx?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -1 +1 @@\n-export { default, runtime, preferredRegion } from '../basic/page'\n+export { default } from '../basic/page'"
        },
        {
            "sha": "c053a5056307bd516ee7ac470cae505091357b85",
            "filename": "test/integration/app-dir-export/test/dynamic-missing-gsp-dev.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-dev.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-dev.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-dev.test.ts?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -25,8 +25,8 @@ describe('app dir - with output export - dynamic missing gsp dev', () => {\n       })\n \n       it('should error when client component has generateStaticParams', async () => {\n-        const expectedErrMsg = process.env.TURBOPACK_DEV\n-          ? 'Page \"test/integration/app-dir-export/app/another/[slug]/page.js\" cannot use both \"use client\" and export function \"generateStaticParams()\".'\n+        const expectedErrMsg = process.env.IS_TURBOPACK_TEST\n+          ? 'App pages cannot use both \"use client\" and export function \"generateStaticParams()\".'\n           : 'Page \"/another/[slug]/page\" cannot use both \"use client\" and export function \"generateStaticParams()\".'\n         await runTests({\n           isDev: true,"
        },
        {
            "sha": "654754b353ebf9714968c316100d11d6f480ccb9",
            "filename": "test/integration/app-dir-export/test/dynamic-missing-gsp-prod.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-prod.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-prod.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-prod.test.ts?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -10,17 +10,20 @@ describe('app dir - with output export - dynamic missing gsp prod', () => {\n           dynamicPage: 'undefined',\n           generateStaticParamsOpt: 'set noop',\n           expectedErrMsg:\n-            /Page \".*\\/another\\/\\[slug\\].*\" is missing \"generateStaticParams\\(\\)\" so it cannot be used with \"output: export\" config\\./,\n+            'Page \"/another/[slug]\" is missing \"generateStaticParams()\" so it cannot be used with \"output: export\" config.',\n         })\n       })\n \n       it('should error when client component has generateStaticParams', async () => {\n+        const expectedErrMsg = process.env.IS_TURBOPACK_TEST\n+          ? 'App pages cannot use both \"use client\" and export function \"generateStaticParams()\".'\n+          : 'Page \"/another/[slug]/page\" cannot use both \"use client\" and export function \"generateStaticParams()\".'\n+\n         await runTests({\n           isDev: false,\n           dynamicPage: 'undefined',\n           generateStaticParamsOpt: 'set client',\n-          expectedErrMsg:\n-            /Page \".*\\/another\\/\\[slug\\]\\/page.*\" cannot use both \"use client\" and export function \"generateStaticParams\\(\\)\"\\./,\n+          expectedErrMsg: expectedErrMsg,\n         })\n       })\n     }"
        },
        {
            "sha": "e267ebd9235961af24e8c2c8acde2ecf93ff60fc",
            "filename": "test/integration/invalid-middleware-matchers/test/index.test.js",
            "status": "modified",
            "additions": 76,
            "deletions": 55,
            "changes": 131,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fintegration%2Finvalid-middleware-matchers%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fintegration%2Finvalid-middleware-matchers%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Finvalid-middleware-matchers%2Ftest%2Findex.test.js?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -24,9 +24,7 @@ const writeMiddleware = async (matchers) => {\n   )\n }\n \n-let getStderr\n-\n-const runTests = () => {\n+const runTests = (getStderr, isDev) => {\n   it('should error when source length is exceeded', async () => {\n     await writeMiddleware([{ source: `/${Array(4096).join('a')}` }])\n     const stderr = await getStderr()\n@@ -85,36 +83,66 @@ const runTests = () => {\n     ])\n     const stderr = await getStderr()\n \n-    expect(stderr).toContain(\n-      'Expected string, received object at \"matcher[0]\", or source is required at \"matcher[0].source\"'\n-    )\n-    expect(stderr).toContain(\n-      'Expected string, received number at \"matcher[1].source\"'\n-    )\n-    expect(stderr).toContain('source must start with / at \"matcher[2]\"')\n-    expect(stderr).toContain(\n-      'Unrecognized key(s) in object: \\'destination\\' at \"matcher[3]\"'\n-    )\n-    expect(stderr).toContain('Expected string, received null at \"matcher[4]\"')\n-    expect(stderr).toContain(\n-      \"Expected 'header' | 'query' | 'cookie' | 'host' at \\\"matcher[6].has[1].type\\\"\"\n-    )\n+    // TODO the Javascript \"/middleware contains invalid middleware config\" error currently shadows the Turbopack one in development\n+    if (process.env.IS_TURBOPACK_TEST && !isDev) {\n+      expect(stderr).toContain('Turbopack build failed with 10 errors')\n+\n+      let matches = 0\n+      matches += stderr.includes('Missing `source` in `matcher[0]` object')\n+      matches += stderr.includes('Missing `source` in `matcher[1]` object')\n+      matches += stderr.includes('Unexpected property in `matcher[3]` object')\n+      matches += stderr.includes(\n+        'Entry `matcher[4]` need to be static strings or static objects.'\n+      )\n+      matches += stderr.includes(\n+        \"`matcher[5].has[0].type` must be one of the strings: 'header', 'cookie', 'query', 'host'\"\n+      )\n+      matches += stderr.includes(\n+        \"`matcher[6].has[0].type` must be one of the strings: 'header', 'cookie', 'query', 'host'\"\n+      )\n+      matches += stderr.includes('Unexpected property in `matcher[7]` object')\n+      matches += stderr.includes(\n+        '`locale` in `matcher[8]` object must be false or undefined'\n+      )\n+\n+      // TODO somehow stderr is doesn't contain everything. It does print 10 messages when running next standalone\n+      if (matches < 4) {\n+        throw new Error('Missing error messages for stderr:\\n' + stderr)\n+      }\n+    } else {\n+      expect(stderr).toContain(\n+        'Expected string, received object at \"matcher[0]\", or source is required at \"matcher[0].source\"'\n+      )\n+      expect(stderr).toContain(\n+        'Expected string, received number at \"matcher[1].source\"'\n+      )\n+      expect(stderr).toContain(\n+        'Unrecognized key(s) in object: \\'destination\\' at \"matcher[3]\"'\n+      )\n+      expect(stderr).toContain('Expected string, received null at \"matcher[4]\"')\n+      expect(stderr).toContain(\n+        \"Expected 'header' | 'query' | 'cookie' | 'host' at \\\"matcher[6].has[1].type\\\"\"\n+      )\n+\n+      expect(stderr).toContain(\n+        \"Expected 'header' | 'query' | 'cookie' | 'host' at \\\"matcher[5].has[0].type\\\"\"\n+      )\n+      expect(stderr).toContain(\n+        \"Expected 'header' | 'query' | 'cookie' | 'host' at \\\"matcher[6].has[0].type\\\"\"\n+      )\n+      expect(stderr).toContain(\n+        \"Expected 'header' | 'query' | 'cookie' | 'host' at \\\"matcher[6].has[1].type\\\"\"\n+      )\n+      expect(stderr).toContain(\n+        'Unrecognized key(s) in object: \\'basePath\\' at \"matcher[7]\"'\n+      )\n+      expect(stderr).toContain(\n+        'Expected string, received object at \"matcher[8]\", or Invalid literal value, expected false at \"matcher[8].locale\", or Expected undefined, received boolean at \"matcher[8].locale\"'\n+      )\n \n-    expect(stderr).toContain(\n-      \"Expected 'header' | 'query' | 'cookie' | 'host' at \\\"matcher[5].has[0].type\\\"\"\n-    )\n-    expect(stderr).toContain(\n-      \"Expected 'header' | 'query' | 'cookie' | 'host' at \\\"matcher[6].has[0].type\\\"\"\n-    )\n-    expect(stderr).toContain(\n-      \"Expected 'header' | 'query' | 'cookie' | 'host' at \\\"matcher[6].has[1].type\\\"\"\n-    )\n-    expect(stderr).toContain(\n-      'Unrecognized key(s) in object: \\'basePath\\' at \"matcher[7]\"'\n-    )\n-    expect(stderr).toContain(\n-      'Expected string, received object at \"matcher[8]\", or Invalid literal value, expected false at \"matcher[8].locale\", or Expected undefined, received boolean at \"matcher[8].locale\"'\n-    )\n+      // TODO currently not covered by Turbopack\n+      expect(stderr).toContain('source must start with / at \"matcher[2]\"')\n+    }\n   })\n }\n \n@@ -123,34 +151,27 @@ describe('Errors on invalid custom middleware matchers', () => {\n   ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n     'development mode',\n     () => {\n-      beforeAll(() => {\n-        getStderr = async () => {\n-          let stderr = ''\n-          const port = await findPort()\n-          await launchApp(appDir, port, {\n-            onStderr(msg) {\n-              stderr += msg\n-            },\n-          })\n-          await fetchViaHTTP(port, '/').catch(() => {})\n-          return stderr\n-        }\n-      })\n-\n-      runTests()\n+      runTests(async () => {\n+        let stderr = ''\n+        const port = await findPort()\n+        await launchApp(appDir, port, {\n+          onStderr(msg) {\n+            stderr += msg\n+          },\n+        })\n+        await fetchViaHTTP(port, '/').catch(() => {})\n+        return stderr\n+      }, true)\n     }\n   )\n   ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n     'production mode',\n     () => {\n-      beforeAll(() => {\n-        getStderr = async () => {\n-          const { stderr } = await nextBuild(appDir, [], { stderr: true })\n-          return stderr\n-        }\n-      })\n-\n-      runTests()\n+      runTests(async () => {\n+        const { stderr } = await nextBuild(appDir, [], { stderr: true })\n+        console.log(stderr)\n+        return stderr\n+      }, false)\n     }\n   )\n })"
        },
        {
            "sha": "d832cde3f86791ac02531613cea57c8d0e19634c",
            "filename": "test/production/exported-runtimes-value-validation/index.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 5,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fproduction%2Fexported-runtimes-value-validation%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/test%2Fproduction%2Fexported-runtimes-value-validation%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fexported-runtimes-value-validation%2Findex.test.ts?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -10,9 +10,13 @@ describe('Exported runtimes value validation', () => {\n     )\n     expect(result).toMatchObject({\n       code: 1,\n-      stderr: expect.stringContaining(\n-        `Invalid enum value. Expected 'edge' | 'experimental-edge' | 'nodejs', received 'something-odd'`\n-      ),\n+      stderr: process.env.IS_TURBOPACK_TEST\n+        ? expect.stringContaining(\n+            'runtime` has an invalid value: unknown variant `something-odd`, expected one of `nodejs`, `edge`, `experimental-edge`'\n+          )\n+        : expect.stringContaining(\n+            `Invalid enum value. Expected 'edge' | 'experimental-edge' | 'nodejs', received 'something-odd'`\n+          ),\n     })\n   })\n \n@@ -33,6 +37,11 @@ describe('Exported runtimes value validation', () => {\n           \"Next.js can't recognize the exported `config` field in route\"\n         )\n       )\n+      expect(result.stderr).toEqual(\n+        expect.stringContaining(\n+          ' Entry `matcher[1]` need to be static strings or static objects.'\n+        )\n+      )\n     } else {\n       expect(result.stderr).toEqual(\n         expect.stringContaining(\n@@ -143,8 +152,6 @@ describe('Exported runtimes value validation', () => {\n           \"Next.js can't recognize the exported `config` field in route\"\n         )\n       )\n-      // ensure only 1 occurrence of the log\n-      expect(result.stderr.match(/\\/array-spread-operator/g)?.length).toBe(1)\n       // TODO: Turbopack has this information in issue.detail but it's not logged to the user.\n       // expect(result.stderr).toEqual(\n       //   expect.stringContaining("
        },
        {
            "sha": "3f453f9e2511d14b801f009cf792b53b9a3ce7d9",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/graph.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -418,6 +418,15 @@ impl EvalContext {\n             Expr::Lit(e) => JsValue::Constant(e.clone().into()),\n             Expr::Ident(i) => self.eval_ident(i),\n \n+            Expr::Unary(UnaryExpr {\n+                op: op!(\"void\"),\n+                // Only treat literals as constant undefined, allowing arbitrary values inside here\n+                // would mean that they can have sideeffects, and `JsValue::Constant` can't model\n+                // that.\n+                arg: box Expr::Lit(_),\n+                ..\n+            }) => JsValue::Constant(ConstantValue::Undefined),\n+\n             Expr::Unary(UnaryExpr {\n                 op: op!(\"!\"), arg, ..\n             }) => {"
        },
        {
            "sha": "e563957eee30449a439b7ac236beccbbe79a0eec",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/peg/graph-explained.snapshot",
            "status": "modified",
            "additions": 30,
            "deletions": 90,
            "changes": 120,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fgraph-explained.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fgraph-explained.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fgraph-explained.snapshot?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -427,17 +427,13 @@ literalEscape = (...) => s[\"replace\"](/\\\\/g, \"\\\\\\\\\")[\"replace\"](/\"/g, \"\\\\\\\"\")[\"r\n \n location#105 = (\n   | arguments[1]\n-  | ((location !== ???*0*) ? location : peg$computeLocation(peg$savedPos, peg$currPos))\n+  | ((location !== undefined) ? location : peg$computeLocation(peg$savedPos, peg$currPos))\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n location#106 = (\n   | arguments[1]\n-  | ((location !== ???*0*) ? location : peg$computeLocation(peg$savedPos, peg$currPos))\n+  | ((location !== undefined) ? location : peg$computeLocation(peg$savedPos, peg$currPos))\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n location#123 = arguments[1]\n \n@@ -467,9 +463,7 @@ operator#1802 = arguments[1][1]\n \n operator#87 = arguments[0]\n \n-options = (arguments[1] | ((options !== ???*0*) ? options : {}))\n-- *0* unsupported expression\n-    This value might have side effects\n+options = (arguments[1] | ((options !== undefined) ? options : {}))\n \n order = arguments[1]\n \n@@ -1823,11 +1817,9 @@ s0#982 = (???*0* | peg$c57 | peg$FAILED | peg$c54 | peg$c129 | peg$currPos | s1)\n - *0* s0\n     pattern without value\n \n-s1#1019 = (???*0* | peg$currPos | ???*1* | peg$FAILED | peg$c149())\n+s1#1019 = (???*0* | peg$currPos | undefined | peg$FAILED | peg$c149())\n - *0* s1\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n s1#1031 = (???*0* | peg$c150 | peg$FAILED | peg$c152(s2))\n - *0* s1\n@@ -2136,11 +2128,9 @@ s1#854 = (???*0* | peg$c114 | peg$FAILED | [s1, s2])\n - *0* s1\n     pattern without value\n \n-s1#886 = (???*0* | peg$currPos | ???*1* | peg$FAILED | peg$c116(s2))\n+s1#886 = (???*0* | peg$currPos | undefined | peg$FAILED | peg$c116(s2))\n - *0* s1\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n s1#897 = (???*0* | peg$parseidentifier_start() | peg$c121(s1, s2))\n - *0* s1\n@@ -2150,17 +2140,13 @@ s1#909 = (???*0* | peg$c122 | peg$FAILED | peg$c124())\n - *0* s1\n     pattern without value\n \n-s1#930 = (???*0* | peg$currPos | ???*1* | peg$FAILED | peg$c131() | peg$c129 | peg$c132(s2))\n+s1#930 = (???*0* | peg$currPos | undefined | peg$FAILED | peg$c131() | peg$c129 | peg$c132(s2))\n - *0* s1\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s1#952 = (???*0* | peg$currPos | ???*1* | peg$FAILED | peg$c131() | peg$c129 | peg$c132(s2))\n+s1#952 = (???*0* | peg$currPos | undefined | peg$FAILED | peg$c131() | peg$c129 | peg$c132(s2))\n - *0* s1\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n s1#982 = (\n   | ???*0*\n@@ -2393,137 +2379,93 @@ s2#617 = (???*0* | [])\n - *0* s2\n     pattern without value\n \n-s2#644 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#644 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#654 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#654 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#664 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#664 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#674 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#674 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#684 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#684 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#694 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#694 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#704 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#704 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#714 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#714 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#724 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#724 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#734 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#734 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#744 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#744 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#754 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#754 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#764 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#764 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#774 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#774 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#784 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#784 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#794 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#794 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#804 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#804 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#814 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#814 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#824 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#824 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#834 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#834 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#844 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#844 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n-s2#854 = (???*0* | peg$currPos | ???*1* | peg$FAILED)\n+s2#854 = (???*0* | peg$currPos | undefined | peg$FAILED)\n - *0* s2\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n s2#886 = (???*0* | peg$parsereserved() | peg$parseidentifier_name())\n - *0* s2\n@@ -2958,11 +2900,9 @@ s4#567 = (???*0* | [])\n - *0* s4\n     pattern without value\n \n-s4#617 = (???*0* | peg$currPos | ???*1* | peg$FAILED | [s4, s5])\n+s4#617 = (???*0* | peg$currPos | undefined | peg$FAILED | [s4, s5])\n - *0* s4\n     pattern without value\n-- *1* unsupported expression\n-    This value might have side effects\n \n s5#1031 = (???*0* | peg$parsehex_digit())\n - *0* s5"
        },
        {
            "sha": "b76e972833d3648c2405e0d011b1982bd27a82ca",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/peg/resolved-effects.snapshot",
            "status": "modified",
            "additions": 6,
            "deletions": 14,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fresolved-effects.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fresolved-effects.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fresolved-effects.snapshot?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -555,21 +555,17 @@\n - *0* unreachable\n     This value might have side effects\n \n-0 -> 157 conditional = ((???*0* | ???*1*) !== ???*6*)\n+0 -> 157 conditional = ((???*0* | ???*1*) !== undefined)\n - *0* arguments[1]\n     function calls are not analysed yet\n-- *1* (???*2* ? ???*5* : {})\n+- *1* (???*2* ? ???*4* : {})\n     nested operation\n-- *2* (???*3* !== ???*4*)\n+- *2* (???*3* !== undefined)\n     nested operation\n - *3* options\n     circular variable reference\n-- *4* unsupported expression\n-    This value might have side effects\n-- *5* options\n+- *4* options\n     circular variable reference\n-- *6* unsupported expression\n-    This value might have side effects\n \n 0 -> 158 unreachable = ???*0*\n - *0* unreachable\n@@ -1153,11 +1149,9 @@\n - *0* unreachable\n     This value might have side effects\n \n-0 -> 342 conditional = (???*0* !== ???*1*)\n+0 -> 342 conditional = (???*0* !== undefined)\n - *0* max number of linking steps reached\n     This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n 342 -> 343 call = (...) => {\n     \"start\": {\"offset\": startPos, \"line\": startPosDetails[\"line\"], \"column\": startPosDetails[\"column\"]},\n@@ -1190,11 +1184,9 @@\n - *3* max number of linking steps reached\n     This value might have side effects\n \n-0 -> 348 conditional = (???*0* !== ???*1*)\n+0 -> 348 conditional = (???*0* !== undefined)\n - *0* max number of linking steps reached\n     This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n 348 -> 349 call = (...) => {\n     \"start\": {\"offset\": startPos, \"line\": startPosDetails[\"line\"], \"column\": startPosDetails[\"column\"]},"
        },
        {
            "sha": "df264d776003b0596f589e972d52af2ede424bbf",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/peg/resolved-explained.snapshot",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fresolved-explained.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fresolved-explained.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Fpeg%2Fresolved-explained.snapshot?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -694,16 +694,14 @@ operator#87 = ???*0*\n - *0* arguments[0]\n     function calls are not analysed yet\n \n-options = (???*0* | (???*1* ? ???*4* : {}))\n+options = (???*0* | (???*1* ? ???*3* : {}))\n - *0* arguments[1]\n     function calls are not analysed yet\n-- *1* (???*2* !== ???*3*)\n+- *1* (???*2* !== undefined)\n     nested operation\n - *2* options\n     circular variable reference\n-- *3* unsupported expression\n-    This value might have side effects\n-- *4* options\n+- *3* options\n     circular variable reference\n \n order = ???*0*"
        },
        {
            "sha": "e2b52b47483ed159329ba1743658f722f8ab268b",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/react-dom-production/graph-explained.snapshot",
            "status": "modified",
            "additions": 38,
            "deletions": 119,
            "changes": 157,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fgraph-explained.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fgraph-explained.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fgraph-explained.snapshot?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -158,9 +158,7 @@ $k = (...) => ((bj(a) ? 1 : 0) | 11 | 14 | 2)\n \n *anonymous function 28108* = (...) => (a[\"timeStamp\"] || FreeVar(Date)[\"now\"]())\n \n-*anonymous function 28404* = (...) => ((???*0* === a[\"relatedTarget\"]) ? ((a[\"fromElement\"] === a[\"srcElement\"]) ? a[\"toElement\"] : a[\"fromElement\"]) : a[\"relatedTarget\"])\n-- *0* unsupported expression\n-    This value might have side effects\n+*anonymous function 28404* = (...) => ((undefined === a[\"relatedTarget\"]) ? ((a[\"fromElement\"] === a[\"srcElement\"]) ? a[\"toElement\"] : a[\"fromElement\"]) : a[\"relatedTarget\"])\n \n *anonymous function 28530* = (...) => (a[\"movementX\"] | wd)\n \n@@ -568,9 +566,7 @@ Fd = rd(Ed)\n \n Fe = (...) => (undefined | te(b))\n \n-Ff = ((\"function\" === typeof(FreeVar(setTimeout))) ? FreeVar(setTimeout) : ???*0*)\n-- *0* unsupported expression\n-    This value might have side effects\n+Ff = ((\"function\" === typeof(FreeVar(setTimeout))) ? FreeVar(setTimeout) : undefined)\n \n Fg = (...) => undefined\n \n@@ -612,9 +608,7 @@ Ge = (...) => (((a === b) && ((0 !== a) || (???*0* === ???*1*))) || ((a !== a) &\n - *1* unsupported expression\n     This value might have side effects\n \n-Gf = ((\"function\" === typeof(FreeVar(clearTimeout))) ? FreeVar(clearTimeout) : ???*0*)\n-- *0* unsupported expression\n-    This value might have side effects\n+Gf = ((\"function\" === typeof(FreeVar(clearTimeout))) ? FreeVar(clearTimeout) : undefined)\n \n Gg = (...) => (!(1) | ???*0* | !(0))\n - *0* !(1)\n@@ -643,9 +637,7 @@ Hd = rd(Gd)\n \n He = ((\"function\" === typeof(FreeVar(Object)[\"is\"])) ? FreeVar(Object)[\"is\"] : Ge)\n \n-Hf = ((\"function\" === typeof(FreeVar(Promise))) ? FreeVar(Promise) : ???*0*)\n-- *0* unsupported expression\n-    This value might have side effects\n+Hf = ((\"function\" === typeof(FreeVar(Promise))) ? FreeVar(Promise) : undefined)\n \n Hg = (...) => undefined\n \n@@ -1367,18 +1359,12 @@ Ya = (...) => A(\n     {},\n     b,\n     {\n-        \"defaultChecked\": ???*0*,\n-        \"defaultValue\": ???*1*,\n-        \"value\": ???*2*,\n+        \"defaultChecked\": undefined,\n+        \"defaultValue\": undefined,\n+        \"value\": undefined,\n         \"checked\": ((null != c) ? c : a[\"_wrapperState\"][\"initialChecked\"])\n     }\n )\n-- *0* unsupported expression\n-    This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n-- *2* unsupported expression\n-    This value might have side effects\n \n Yb = (...) => (((b !== a) ? null : a) | ???*0* | ((c[\"stateNode\"][\"current\"] === c) ? a : b))\n - *0* a\n@@ -1451,9 +1437,7 @@ Ze = (...) => (Xe[a] | a | ???*0*)\n - *0* unsupported expression\n     This value might have side effects\n \n-Zf = (...) => ((null !== a) && (???*0* !== a))\n-- *0* unsupported expression\n-    This value might have side effects\n+Zf = (...) => ((null !== a) && (undefined !== a))\n \n Zg = (...) => ((3 === c[\"tag\"]) ? c[\"stateNode\"] : null)\n \n@@ -2280,11 +2264,9 @@ a#65 = (\n   | arguments[0]\n   | (\n      || a\n-     || ((\"undefined\" !== typeof(FreeVar(document))) ? FreeVar(document) : ???*0*)\n+     || ((\"undefined\" !== typeof(FreeVar(document))) ? FreeVar(document) : undefined)\n     )\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n a#665 = (arguments[0] | b[\"flags\"] | b[\"memoizedState\"])\n \n@@ -2350,9 +2332,7 @@ a#785 = arguments[0]\n \n a#8 = arguments[0]\n \n-a#801 = (arguments[0] | C | FreeVar(window)[\"event\"] | ((???*0* === a) ? 16 : jd(a[\"type\"])))\n-- *0* unsupported expression\n-    This value might have side effects\n+a#801 = (arguments[0] | C | FreeVar(window)[\"event\"] | ((undefined === a) ? 16 : jd(a[\"type\"])))\n \n a#802 = arguments[0]\n \n@@ -2973,13 +2953,9 @@ b#528 = arguments[1]\n \n b#53 = a[\"type\"]\n \n-b#530 = (arguments[1] | ((???*0* === b) ? null : b))\n-- *0* unsupported expression\n-    This value might have side effects\n+b#530 = (arguments[1] | ((undefined === b) ? null : b))\n \n-b#531 = (arguments[1] | ((???*0* === b) ? null : b))\n-- *0* unsupported expression\n-    This value might have side effects\n+b#531 = (arguments[1] | ((undefined === b) ? null : b))\n \n b#532 = arguments[1]\n \n@@ -3005,13 +2981,9 @@ b#551 = arguments[1]\n \n b#552 = arguments[1]\n \n-b#553 = (arguments[1] | ((???*0* === b) ? null : b))\n-- *0* unsupported expression\n-    This value might have side effects\n+b#553 = (arguments[1] | ((undefined === b) ? null : b))\n \n-b#554 = (arguments[1] | ((???*0* !== c) ? c(b) : b))\n-- *0* unsupported expression\n-    This value might have side effects\n+b#554 = (arguments[1] | ((undefined !== c) ? c(b) : b))\n \n b#555 = ci()\n \n@@ -3343,11 +3315,8 @@ ba = (\n   | undefined\n   | \"onCompositionEnd\"\n   | \"onCompositionUpdate\"\n-  | ???*0*\n   | new Ld(ba, a, null, c, e)\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n bb = (...) => (undefined | FreeVar(undefined))\n \n@@ -3384,11 +3353,9 @@ c#1004 = (\n \n c#101 = arguments[2]\n \n-c#1012 = ((???*0* && (???*1* !== FreeVar(arguments)[2])) ? FreeVar(arguments)[2] : null)\n+c#1012 = ((???*0* && (undefined !== FreeVar(arguments)[2])) ? FreeVar(arguments)[2] : null)\n - *0* unsupported expression\n     This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n c#1013 = (!(1) | !(0))\n \n@@ -3484,9 +3451,7 @@ c#25 = (\n \n c#251 = FreeVar(Object)[\"keys\"](a)\n \n-c#254 = (Je(a) | c[\"nextSibling\"] | c[\"parentNode\"] | ???*0* | Je(c))\n-- *0* unsupported expression\n-    This value might have side effects\n+c#254 = (Je(a) | c[\"nextSibling\"] | c[\"parentNode\"] | undefined | Je(c))\n \n c#261 = (\n   | (\"string\" === typeof(b[\"contentWindow\"][\"location\"][\"href\"]))\n@@ -3606,10 +3571,8 @@ c#412 = arguments[2]\n c#415 = (\n   | arguments[2]\n   | c(d, b)\n-  | (((null === c) || (???*0* === c)) ? b : A({}, b, c))\n+  | (((null === c) || (undefined === c)) ? b : A({}, b, c))\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n c#417 = arguments[2]\n \n@@ -3688,10 +3651,8 @@ c#52 = ???*0*\n \n c#528 = (\n   | arguments[2]\n-  | (((null !== c) && (???*0* !== c)) ? c[\"concat\"]([a]) : null)\n+  | (((null !== c) && (undefined !== c)) ? c[\"concat\"]([a]) : null)\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n c#530 = di()\n \n@@ -3717,10 +3678,8 @@ c#547 = (arguments[2] | ???*0*)\n \n c#550 = (\n   | arguments[2]\n-  | (((null !== c) && (???*0* !== c)) ? c[\"concat\"]([a]) : null)\n+  | (((null !== c) && (undefined !== c)) ? c[\"concat\"]([a]) : null)\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n c#553 = ci()\n \n@@ -4113,11 +4072,9 @@ d#264 = ???*0*\n \n d#266 = (\n   | a[\"selectionRange\"]\n-  | ((???*0* === d[\"end\"]) ? f : FreeVar(Math)[\"min\"](d[\"end\"], e))\n+  | ((undefined === d[\"end\"]) ? f : FreeVar(Math)[\"min\"](d[\"end\"], e))\n   | f\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n d#269 = (\n   | ((c[\"window\"] === c) ? c[\"document\"] : ((9 === c[\"nodeType\"]) ? c : c[\"ownerDocument\"]))\n@@ -4204,9 +4161,7 @@ d#419 = lh(a)\n \n d#420 = arguments[3]\n \n-d#421 = (!(1) | b[\"contextTypes\"] | ((null !== d) && (???*0* !== d)))\n-- *0* unsupported expression\n-    This value might have side effects\n+d#421 = (!(1) | b[\"contextTypes\"] | ((null !== d) && (undefined !== d)))\n \n d#422 = arguments[3]\n \n@@ -4274,9 +4229,7 @@ d#515 = (arguments[3] | c[\"next\"])\n \n d#517 = arguments[3]\n \n-d#518 = (arguments[3] | ((???*0* === d) ? null : d))\n-- *0* unsupported expression\n-    This value might have side effects\n+d#518 = (arguments[3] | ((undefined === d) ? null : d))\n \n d#530 = c[\"memoizedState\"]\n \n@@ -4349,12 +4302,10 @@ d#614 = (\n   | qj({\"mode\": \"visible\", \"children\": d[\"children\"]}, e, 0, null)\n   | (e[\"nextSibling\"] && e[\"nextSibling\"][\"dataset\"])\n   | h\n-  | Li(f, d, ???*0*)\n+  | Li(f, d, undefined)\n   | R\n   | Li(FreeVar(Error)(p(421)))\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n d#619 = a[\"alternate\"]\n \n@@ -4370,9 +4321,7 @@ d#631 = (b[\"type\"][\"_context\"] | b[\"memoizedState\"] | (0 !== ???*0*))\n - *0* unsupported expression\n     This value might have side effects\n \n-d#639 = (arguments[3] | Ya(a, d) | A({}, d, {\"value\": ???*0*}) | gb(a, d))\n-- *0* unsupported expression\n-    This value might have side effects\n+d#639 = (arguments[3] | Ya(a, d) | A({}, d, {\"value\": undefined}) | gb(a, d))\n \n d#64 = (\n   | \"\"\n@@ -4526,17 +4475,13 @@ d#952 = arguments[3]\n \n d#953 = arguments[3]\n \n-d#954 = ((???*0* && (???*1* !== FreeVar(arguments)[3])) ? FreeVar(arguments)[3] : null)\n+d#954 = ((???*0* && (undefined !== FreeVar(arguments)[3])) ? FreeVar(arguments)[3] : null)\n - *0* unsupported expression\n     This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n d#960 = (arguments[3] | L())\n \n-d#961 = (arguments[3] | ((???*0* === d) ? null : d))\n-- *0* unsupported expression\n-    This value might have side effects\n+d#961 = (arguments[3] | ((undefined === d) ? null : d))\n \n d#979 = (arguments[3] | *anonymous function 127055* | *anonymous function 127285*)\n \n@@ -4635,9 +4580,7 @@ e#266 = (c[\"textContent\"][\"length\"] | undefined | d | Ke(c, f))\n \n e#275 = (d[\"event\"] | undefined)\n \n-e#285 = (ed | gd | fd | ???*0* | !(0))\n-- *0* unsupported expression\n-    This value might have side effects\n+e#285 = (ed | gd | fd | undefined | !(0))\n \n e#286 = arguments[4]\n \n@@ -4769,9 +4712,7 @@ e#621 = (d[\"revealOrder\"] | null | c | b[\"child\"] | c[\"sibling\"] | a)\n \n e#631 = (b[\"memoizedProps\"][\"value\"] | b[\"memoizedState\"])\n \n-e#639 = (a[\"memoizedProps\"] | Ya(a, e) | A({}, e, {\"value\": ???*0*}) | gb(a, e))\n-- *0* unsupported expression\n-    This value might have side effects\n+e#639 = (a[\"memoizedProps\"] | Ya(a, e) | A({}, e, {\"value\": undefined}) | gb(a, e))\n \n e#646 = (a[\"child\"] | e[\"sibling\"])\n \n@@ -4784,13 +4725,11 @@ e#647 = (\n   | [\"children\", `${h}`]\n   | d\n   | Ya(a, d)\n-  | A({}, d, {\"value\": ???*1*})\n+  | A({}, d, {\"value\": undefined})\n   | gb(a, d)\n )\n - *0* updated with update expression\n     This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n e#673 = (d[\"anchorOffset\"] | undefined)\n \n@@ -4948,9 +4887,7 @@ f#212 = arguments[3]\n \n f#266 = (FreeVar(Math)[\"min\"](d[\"start\"], e) | undefined | e)\n \n-f#275 = (???*0* | undefined | k)\n-- *0* unsupported expression\n-    This value might have side effects\n+f#275 = (undefined | k)\n \n f#286 = (d | g)\n \n@@ -5012,9 +4949,7 @@ f#501 = (b[\"memoizedState\"] | a(f, g[\"action\"]))\n \n f#504 = !(He(d[\"memoizedState\"], e))\n \n-f#518 = (???*0* | g[\"destroy\"])\n-- *0* unsupported expression\n-    This value might have side effects\n+f#518 = (undefined | g[\"destroy\"])\n \n f#539 = (a[\"alternate\"] | undefined | b[\"lastRenderedReducer\"])\n \n@@ -5303,10 +5238,8 @@ g#721 = (\n   | undefined\n   | 0\n   | (g + 2)\n-  | (((???*0* !== k) && (null !== k) && k[\"hasOwnProperty\"](\"display\")) ? k[\"display\"] : null)\n+  | (((undefined !== k) && (null !== k) && k[\"hasOwnProperty\"](\"display\")) ? k[\"display\"] : null)\n )\n-- *0* unsupported expression\n-    This value might have side effects\n \n g#756 = (d[\"stateNode\"][\"containerInfo\"] | undefined)\n \n@@ -5364,15 +5297,11 @@ gb = (...) => A(\n     {},\n     b,\n     {\n-        \"value\": ???*0*,\n-        \"defaultValue\": ???*1*,\n+        \"value\": undefined,\n+        \"defaultValue\": undefined,\n         \"children\": `${a[\"_wrapperState\"][\"initialValue\"]}`\n     }\n )\n-- *0* unsupported expression\n-    This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n gc = ca[\"unstable_UserBlockingPriority\"]\n \n@@ -5486,11 +5415,7 @@ h#614 = (d[\"dgst\"] | undefined | (0 !== ???*0*))\n - *0* unsupported expression\n     This value might have side effects\n \n-h#639 = (e[l] | undefined | ((null != e) ? e[l] : ???*0*) | (h ? h[\"__html\"] : ???*1*))\n-- *0* unsupported expression\n-    This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n+h#639 = (e[l] | undefined | ((null != e) ? e[l] : undefined) | (h ? h[\"__html\"] : undefined))\n \n h#647 = (f[g] | undefined | e)\n \n@@ -5692,13 +5617,9 @@ k#601 = (\n \n k#609 = ({\"mode\": \"hidden\", \"children\": d[\"children\"]} | undefined)\n \n-k#639 = (d[l] | undefined | (k ? k[\"__html\"] : ???*0*))\n-- *0* unsupported expression\n-    This value might have side effects\n+k#639 = (d[l] | undefined | (k ? k[\"__html\"] : undefined))\n \n-k#647 = (h[f] | undefined | (k ? k[\"__html\"] : ???*0*))\n-- *0* unsupported expression\n-    This value might have side effects\n+k#647 = (h[f] | undefined | (k ? k[\"__html\"] : undefined))\n \n k#673 = (???*0* | undefined | (g + d) | g)\n - *0* unsupported expression\n@@ -5987,15 +5908,13 @@ mb = (???*0* | (mb || FreeVar(document)[\"createElement\"](\"div\")))\n \n mc = (...) => undefined\n \n-md = (null | e[\"slice\"](a, (???*0* ? ???*1* : ???*2*)) | ???*3*)\n+md = (null | e[\"slice\"](a, (???*0* ? ???*1* : undefined)) | ???*2*)\n - *0* unsupported expression\n     This value might have side effects\n - *1* unsupported expression\n     This value might have side effects\n - *2* unsupported expression\n     This value might have side effects\n-- *3* unsupported expression\n-    This value might have side effects\n \n me = (...) => ((\"input\" === b) ? !(!(le[a[\"type\"]])) : ((\"textarea\" === b) ? !(0) : !(1)))\n "
        },
        {
            "sha": "1afc187f6814be5149b8fe1c86875cf0b4dbde2c",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/react-dom-production/resolved-effects.snapshot",
            "status": "modified",
            "additions": 2445,
            "deletions": 3200,
            "changes": 5645,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-effects.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-effects.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-effects.snapshot?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38"
        },
        {
            "sha": "012b2ba99783cc1fa0e4ac337d25582b1801b364",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/react-dom-production/resolved-explained.snapshot",
            "status": "modified",
            "additions": 399,
            "deletions": 584,
            "changes": 983,
            "blob_url": "https://github.com/vercel/next.js/blob/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-explained.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/7e0fc3b2713df41f7b77945f64e3fb7b4c390a38/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-explained.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-explained.snapshot?ref=7e0fc3b2713df41f7b77945f64e3fb7b4c390a38",
            "patch": "@@ -148,9 +148,7 @@ $k = (...) => ((bj(a) ? 1 : 0) | 11 | 14 | 2)\n \n *anonymous function 28108* = (...) => (a[\"timeStamp\"] || FreeVar(Date)[\"now\"]())\n \n-*anonymous function 28404* = (...) => ((???*0* === a[\"relatedTarget\"]) ? ((a[\"fromElement\"] === a[\"srcElement\"]) ? a[\"toElement\"] : a[\"fromElement\"]) : a[\"relatedTarget\"])\n-- *0* unsupported expression\n-    This value might have side effects\n+*anonymous function 28404* = (...) => ((undefined === a[\"relatedTarget\"]) ? ((a[\"fromElement\"] === a[\"srcElement\"]) ? a[\"toElement\"] : a[\"fromElement\"]) : a[\"relatedTarget\"])\n \n *anonymous function 28530* = (...) => (a[\"movementX\"] | wd)\n \n@@ -359,14 +357,12 @@ Ad = {\n     \"getModifierState\": (...) => Pd,\n     \"button\": 0,\n     \"buttons\": 0,\n-    \"relatedTarget\": (...) => ((???*0* === a[\"relatedTarget\"]) ? ((a[\"fromElement\"] === a[\"srcElement\"]) ? a[\"toElement\"] : a[\"fromElement\"]) : a[\"relatedTarget\"]),\n+    \"relatedTarget\": (...) => ((undefined === a[\"relatedTarget\"]) ? ((a[\"fromElement\"] === a[\"srcElement\"]) ? a[\"toElement\"] : a[\"fromElement\"]) : a[\"relatedTarget\"]),\n     \"movementX\": (...) => (a[\"movementX\"] | wd),\n-    \"movementY\": (...) => (???*1* ? a[\"movementY\"] : xd)\n+    \"movementY\": (...) => (???*0* ? a[\"movementY\"] : xd)\n }\n - *0* unsupported expression\n     This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n Ae = (...) => undefined\n \n@@ -520,15 +516,13 @@ Cd = {\n     \"getModifierState\": (...) => Pd,\n     \"button\": 0,\n     \"buttons\": 0,\n-    \"relatedTarget\": (...) => ((???*0* === a[\"relatedTarget\"]) ? ((a[\"fromElement\"] === a[\"srcElement\"]) ? a[\"toElement\"] : a[\"fromElement\"]) : a[\"relatedTarget\"]),\n+    \"relatedTarget\": (...) => ((undefined === a[\"relatedTarget\"]) ? ((a[\"fromElement\"] === a[\"srcElement\"]) ? a[\"toElement\"] : a[\"fromElement\"]) : a[\"relatedTarget\"]),\n     \"movementX\": (...) => (a[\"movementX\"] | wd),\n-    \"movementY\": (...) => (???*1* ? a[\"movementY\"] : xd),\n+    \"movementY\": (...) => (???*0* ? a[\"movementY\"] : xd),\n     \"dataTransfer\": 0\n }\n - *0* unsupported expression\n     This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n Ce = (...) => undefined\n \n@@ -716,7 +710,7 @@ Fd = (...) => ???*0*\n \n Fe = (...) => (undefined | te(b))\n \n-Ff = (???*0* ? ???*3* : ???*4*)\n+Ff = (???*0* ? ???*3* : undefined)\n - *0* (\"function\" === ???*1*)\n     nested operation\n - *1* typeof(???*2*)\n@@ -727,8 +721,6 @@ Ff = (???*0* ? ???*3* : ???*4*)\n - *3* FreeVar(setTimeout)\n     unknown global\n     This value might have side effects\n-- *4* unsupported expression\n-    This value might have side effects\n \n Fg = (...) => undefined\n \n@@ -782,7 +774,7 @@ Ge = (...) => (((a === b) && ((0 !== a) || (???*0* === ???*1*))) || ((a !== a) &\n - *1* unsupported expression\n     This value might have side effects\n \n-Gf = (???*0* ? ???*3* : ???*4*)\n+Gf = (???*0* ? ???*3* : undefined)\n - *0* (\"function\" === ???*1*)\n     nested operation\n - *1* typeof(???*2*)\n@@ -793,8 +785,6 @@ Gf = (???*0* ? ???*3* : ???*4*)\n - *3* FreeVar(clearTimeout)\n     unknown global\n     This value might have side effects\n-- *4* unsupported expression\n-    This value might have side effects\n \n Gg = (...) => (!(1) | ???*0* | !(0))\n - *0* !(1)\n@@ -849,7 +839,7 @@ He = (???*0* ? ???*4* : (...) => ???*6*)\n - *8* unsupported expression\n     This value might have side effects\n \n-Hf = (???*0* ? ???*3* : ???*4*)\n+Hf = (???*0* ? ???*3* : undefined)\n - *0* (\"function\" === ???*1*)\n     nested operation\n - *1* typeof(???*2*)\n@@ -860,8 +850,6 @@ Hf = (???*0* ? ???*3* : ???*4*)\n - *3* FreeVar(Promise)\n     unknown global\n     This value might have side effects\n-- *4* unsupported expression\n-    This value might have side effects\n \n Hg = (...) => undefined\n \n@@ -985,37 +973,33 @@ Jf = (???*0* ? ???*3* : ???*4*)\n - *3* FreeVar(queueMicrotask)\n     unknown global\n     This value might have side effects\n-- *4* (???*5* ? (...) => ???*11* : ???*12*)\n+- *4* (???*5* ? (...) => ???*10* : ???*11*)\n     nested operation\n - *5* (\"undefined\" !== ???*6*)\n     nested operation\n - *6* typeof(???*7*)\n     nested operation\n-- *7* (???*8* ? ???*9* : ???*10*)\n+- *7* (???*8* ? ???*9* : undefined)\n     nested operation\n - *8* (\"function\" === ???)\n     nested operation\n - *9* FreeVar(Promise)\n     unknown global\n     This value might have side effects\n-- *10* unsupported expression\n-    This value might have side effects\n-- *11* Hf[\"resolve\"](null)[\"then\"](a)[\"catch\"](If)\n+- *10* Hf[\"resolve\"](null)[\"then\"](a)[\"catch\"](If)\n     nested operation\n-- *12* (???*13* ? ???*16* : ???*17*)\n+- *11* (???*12* ? ???*15* : undefined)\n     nested operation\n-- *13* (\"function\" === ???*14*)\n+- *12* (\"function\" === ???*13*)\n     nested operation\n-- *14* typeof(???*15*)\n+- *13* typeof(???*14*)\n     nested operation\n-- *15* FreeVar(setTimeout)\n+- *14* FreeVar(setTimeout)\n     unknown global\n     This value might have side effects\n-- *16* FreeVar(setTimeout)\n+- *15* FreeVar(setTimeout)\n     unknown global\n     This value might have side effects\n-- *17* unsupported expression\n-    This value might have side effects\n \n Jg = (...) => undefined\n \n@@ -2211,18 +2195,12 @@ Ya = (...) => A(\n     {},\n     b,\n     {\n-        \"defaultChecked\": ???*0*,\n-        \"defaultValue\": ???*1*,\n-        \"value\": ???*2*,\n+        \"defaultChecked\": undefined,\n+        \"defaultValue\": undefined,\n+        \"value\": undefined,\n         \"checked\": ((null != c) ? c : a[\"_wrapperState\"][\"initialChecked\"])\n     }\n )\n-- *0* unsupported expression\n-    This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n-- *2* unsupported expression\n-    This value might have side effects\n \n Yb = (...) => (((b !== a) ? null : a) | ???*0* | ((c[\"stateNode\"][\"current\"] === c) ? a : b))\n - *0* a\n@@ -2313,9 +2291,7 @@ Ze = (...) => (Xe[a] | a | ???*0*)\n - *0* unsupported expression\n     This value might have side effects\n \n-Zf = (...) => ((null !== a) && (???*0* !== a))\n-- *0* unsupported expression\n-    This value might have side effects\n+Zf = (...) => ((null !== a) && (undefined !== a))\n \n Zg = (...) => ((3 === c[\"tag\"]) ? c[\"stateNode\"] : null)\n \n@@ -3117,7 +3093,7 @@ a#232 = (???*0* | ???*1*)\n - *2* arguments[1]\n     function calls are not analysed yet\n \n-a#233 = (???*0* | null | ???*1* | ???*15*)\n+a#233 = (???*0* | null | ???*1* | ???*14*)\n - *0* arguments[0]\n     function calls are not analysed yet\n - *1* ???*2*((???*9* | 0 | ???*10*), ???*11*)\n@@ -3141,16 +3117,14 @@ a#233 = (???*0* | null | ???*1* | ???*15*)\n     pattern without value\n - *10* updated with update expression\n     This value might have side effects\n-- *11* (???*12* ? ???*13* : ???*14*)\n+- *11* (???*12* ? ???*13* : undefined)\n     nested operation\n - *12* unsupported expression\n     This value might have side effects\n - *13* unsupported expression\n     This value might have side effects\n - *14* unsupported expression\n     This value might have side effects\n-- *15* unsupported expression\n-    This value might have side effects\n \n a#235 = ???*0*\n - *0* arguments[0]\n@@ -3216,7 +3190,12 @@ a#253 = (???*0* | ???*1*)\n - *2* a\n     circular variable reference\n \n-a#254 = (???*0* | 0 | ???*1* | (???*2* + (???*3* | ???*6*)))\n+a#254 = (\n+  | ???*0*\n+  | 0\n+  | ???*1*\n+  | (???*2* + (???*3* | undefined[\"textContent\"][\"length\"]))\n+)\n - *0* arguments[0]\n     function calls are not analysed yet\n - *1* d\n@@ -3229,14 +3208,6 @@ a#254 = (???*0* | 0 | ???*1* | (???*2* + (???*3* | ???*6*)))\n     unknown object\n - *5* a\n     circular variable reference\n-- *6* ???*7*[\"length\"]\n-    unknown object\n-    This value might have side effects\n-- *7* ???*8*[\"textContent\"]\n-    unknown object\n-    This value might have side effects\n-- *8* unsupported expression\n-    This value might have side effects\n \n a#26 = (???*0* | ???*1* | ???*3*)\n - *0* arguments[0]\n@@ -3261,12 +3232,12 @@ a#261 = (\n   | undefined[\"contentWindow\"]\n   | null[\"contentWindow\"]\n   | ???*1*\n-  | (???*4* ? ???*7* : ???*8*)[\"activeElement\"][\"contentWindow\"]\n-  | (???*9* ? ???*12* : ???*13*)[\"body\"][\"contentWindow\"]\n-  | (???*14* ? ???*17* : ???*18*)[\"body\"][\"contentWindow\"]\n-  | (???*19* ? ???*22* : ???*23*)[\"activeElement\"][\"contentWindow\"]\n-  | (???*24* ? ???*27* : ???*28*)[\"body\"][\"contentWindow\"]\n-  | (???*29* ? ???*32* : ???*33*)[\"body\"][\"contentWindow\"]\n+  | (???*4* ? ???*7* : undefined)[\"activeElement\"][\"contentWindow\"]\n+  | (???*8* ? ???*11* : undefined)[\"body\"][\"contentWindow\"]\n+  | (???*12* ? ???*15* : undefined)[\"body\"][\"contentWindow\"]\n+  | (???*16* ? ???*19* : undefined)[\"activeElement\"][\"contentWindow\"]\n+  | (???*20* ? ???*23* : undefined)[\"body\"][\"contentWindow\"]\n+  | (???*24* ? ???*27* : undefined)[\"body\"][\"contentWindow\"]\n )\n - *0* FreeVar(window)\n     unknown global\n@@ -3286,68 +3257,56 @@ a#261 = (\n - *7* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *8* unsupported expression\n-    This value might have side effects\n-- *9* (\"undefined\" !== ???*10*)\n+- *8* (\"undefined\" !== ???*9*)\n     nested operation\n-- *10* typeof(???*11*)\n+- *9* typeof(???*10*)\n     nested operation\n-- *11* FreeVar(document)\n+- *10* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *12* FreeVar(document)\n+- *11* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *13* unsupported expression\n-    This value might have side effects\n-- *14* (\"undefined\" !== ???*15*)\n+- *12* (\"undefined\" !== ???*13*)\n     nested operation\n-- *15* typeof(???*16*)\n+- *13* typeof(???*14*)\n     nested operation\n-- *16* FreeVar(document)\n+- *14* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *17* FreeVar(document)\n+- *15* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *18* unsupported expression\n-    This value might have side effects\n-- *19* (\"undefined\" !== ???*20*)\n+- *16* (\"undefined\" !== ???*17*)\n     nested operation\n-- *20* typeof(???*21*)\n+- *17* typeof(???*18*)\n     nested operation\n-- *21* FreeVar(document)\n+- *18* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *22* FreeVar(document)\n+- *19* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *23* unsupported expression\n-    This value might have side effects\n-- *24* (\"undefined\" !== ???*25*)\n+- *20* (\"undefined\" !== ???*21*)\n     nested operation\n-- *25* typeof(???*26*)\n+- *21* typeof(???*22*)\n     nested operation\n-- *26* FreeVar(document)\n+- *22* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *27* FreeVar(document)\n+- *23* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *28* unsupported expression\n-    This value might have side effects\n-- *29* (\"undefined\" !== ???*30*)\n+- *24* (\"undefined\" !== ???*25*)\n     nested operation\n-- *30* typeof(???*31*)\n+- *25* typeof(???*26*)\n     nested operation\n-- *31* FreeVar(document)\n+- *26* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *32* FreeVar(document)\n+- *27* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *33* unsupported expression\n-    This value might have side effects\n \n a#265 = ???*0*\n - *0* arguments[0]\n@@ -4545,29 +4504,27 @@ a#554 = (\n         \"lanes\": 0,\n         \"dispatch\": null,\n         \"lastRenderedReducer\": ???*1*,\n-        \"lastRenderedState\": (???*2* | (???*3* ? ???*6* : ???*8*))\n+        \"lastRenderedState\": (???*2* | (???*3* ? ???*5* : ???*7*))\n     }\n-  | ???*9*\n+  | ???*8*\n )\n - *0* arguments[0]\n     function calls are not analysed yet\n - *1* a\n     circular variable reference\n - *2* arguments[1]\n     function calls are not analysed yet\n-- *3* (???*4* !== ???*5*)\n+- *3* (undefined !== ???*4*)\n     nested operation\n-- *4* unsupported expression\n-    This value might have side effects\n-- *5* arguments[2]\n+- *4* arguments[2]\n     function calls are not analysed yet\n-- *6* ???*7*(b)\n+- *5* ???*6*(b)\n     unknown callee\n-- *7* arguments[2]\n+- *6* arguments[2]\n     function calls are not analysed yet\n-- *8* b\n+- *7* b\n     circular variable reference\n-- *9* unsupported expression\n+- *8* unsupported expression\n     This value might have side effects\n \n a#555 = (???*0* | {\"current\": ???*1*})\n@@ -5096,7 +5053,7 @@ a#647 = ???*0*\n - *0* max number of linking steps reached\n     This value might have side effects\n \n-a#65 = (???*0* | ???*1* | (???*2* ? ???*5* : ???*6*))\n+a#65 = (???*0* | ???*1* | (???*2* ? ???*5* : undefined))\n - *0* arguments[0]\n     function calls are not analysed yet\n - *1* a\n@@ -5111,8 +5068,6 @@ a#65 = (???*0* | ???*1* | (???*2* ? ???*5* : ???*6*))\n - *5* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *6* unsupported expression\n-    This value might have side effects\n \n a#665 = (???*0* | ???*1*)\n - *0* arguments[0]\n@@ -5328,11 +5283,9 @@ a#801 = (\n - *18* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *19* (???*20* === ???*21*)\n+- *19* (undefined === ???*20*)\n     nested operation\n-- *20* unsupported expression\n-    This value might have side effects\n-- *21* a\n+- *20* a\n     circular variable reference\n \n a#802 = ???*0*\n@@ -6580,13 +6533,13 @@ b#261 = (\n   | undefined\n   | null\n   | ???*0*\n-  | (???*2* ? ???*5* : ???*6*)[\"activeElement\"]\n-  | (???*7* ? ???*10* : ???*11*)[\"body\"]\n-  | (???*12* ? ???*15* : ???*16*)[\"body\"]\n-  | ???*17*\n-  | (???*20* ? ???*23* : ???*24*)[\"activeElement\"]\n-  | (???*25* ? ???*28* : ???*29*)[\"body\"]\n-  | (???*30* ? ???*33* : ???*34*)[\"body\"]\n+  | (???*2* ? ???*5* : undefined)[\"activeElement\"]\n+  | (???*6* ? ???*9* : undefined)[\"body\"]\n+  | (???*10* ? ???*13* : undefined)[\"body\"]\n+  | ???*14*\n+  | (???*17* ? ???*20* : undefined)[\"activeElement\"]\n+  | (???*21* ? ???*24* : undefined)[\"body\"]\n+  | (???*25* ? ???*28* : undefined)[\"body\"]\n )\n - *0* ???*1*[\"activeElement\"]\n     unknown object\n@@ -6601,77 +6554,65 @@ b#261 = (\n - *5* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *6* unsupported expression\n-    This value might have side effects\n-- *7* (\"undefined\" !== ???*8*)\n+- *6* (\"undefined\" !== ???*7*)\n     nested operation\n-- *8* typeof(???*9*)\n+- *7* typeof(???*8*)\n     nested operation\n-- *9* FreeVar(document)\n+- *8* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *10* FreeVar(document)\n+- *9* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *11* unsupported expression\n-    This value might have side effects\n-- *12* (\"undefined\" !== ???*13*)\n+- *10* (\"undefined\" !== ???*11*)\n     nested operation\n-- *13* typeof(???*14*)\n+- *11* typeof(???*12*)\n     nested operation\n-- *14* FreeVar(document)\n+- *12* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *15* FreeVar(document)\n+- *13* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *16* unsupported expression\n-    This value might have side effects\n-- *17* ???*18*[\"activeElement\"]\n+- *14* ???*15*[\"activeElement\"]\n     unknown object\n     This value might have side effects\n-- *18* ???*19*[\"document\"]\n+- *15* ???*16*[\"document\"]\n     unknown object\n     This value might have side effects\n-- *19* FreeVar(window)\n+- *16* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *20* (\"undefined\" !== ???*21*)\n+- *17* (\"undefined\" !== ???*18*)\n     nested operation\n-- *21* typeof(???*22*)\n+- *18* typeof(???*19*)\n     nested operation\n-- *22* FreeVar(document)\n+- *19* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *23* FreeVar(document)\n+- *20* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *24* unsupported expression\n-    This value might have side effects\n-- *25* (\"undefined\" !== ???*26*)\n+- *21* (\"undefined\" !== ???*22*)\n     nested operation\n-- *26* typeof(???*27*)\n+- *22* typeof(???*23*)\n     nested operation\n-- *27* FreeVar(document)\n+- *23* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *28* FreeVar(document)\n+- *24* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *29* unsupported expression\n-    This value might have side effects\n-- *30* (\"undefined\" !== ???*31*)\n+- *25* (\"undefined\" !== ???*26*)\n     nested operation\n-- *31* typeof(???*32*)\n+- *26* typeof(???*27*)\n     nested operation\n-- *32* FreeVar(document)\n+- *27* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *33* FreeVar(document)\n+- *28* FreeVar(document)\n     unknown global\n     This value might have side effects\n-- *34* unsupported expression\n-    This value might have side effects\n \n b#265 = (???*0* | ???*1* | ???*3*())\n - *0* arguments[0]\n@@ -8190,28 +8131,24 @@ b#53 = (???*0* | \"\"[\"type\"])\n - *1* arguments[0]\n     function calls are not analysed yet\n \n-b#530 = (???*0* | (???*1* ? null : ???*4*))\n+b#530 = (???*0* | (???*1* ? null : ???*3*))\n - *0* arguments[1]\n     function calls are not analysed yet\n-- *1* (???*2* === ???*3*)\n+- *1* (undefined === ???*2*)\n     nested operation\n-- *2* unsupported expression\n-    This value might have side effects\n-- *3* b\n+- *2* b\n     circular variable reference\n-- *4* b\n+- *3* b\n     circular variable reference\n \n-b#531 = (???*0* | (???*1* ? null : ???*4*))\n+b#531 = (???*0* | (???*1* ? null : ???*3*))\n - *0* arguments[1]\n     function calls are not analysed yet\n-- *1* (???*2* === ???*3*)\n+- *1* (undefined === ???*2*)\n     nested operation\n-- *2* unsupported expression\n-    This value might have side effects\n-- *3* b\n+- *2* b\n     circular variable reference\n-- *4* b\n+- *3* b\n     circular variable reference\n \n b#532 = ???*0*\n@@ -8266,32 +8203,28 @@ b#552 = ???*0*\n - *0* arguments[1]\n     function calls are not analysed yet\n \n-b#553 = (???*0* | (???*1* ? null : ???*4*))\n+b#553 = (???*0* | (???*1* ? null : ???*3*))\n - *0* arguments[1]\n     function calls are not analysed yet\n-- *1* (???*2* === ???*3*)\n+- *1* (undefined === ???*2*)\n     nested operation\n-- *2* unsupported expression\n-    This value might have side effects\n-- *3* b\n+- *2* b\n     circular variable reference\n-- *4* b\n+- *3* b\n     circular variable reference\n \n-b#554 = (???*0* | (???*1* ? ???*4* : ???*6*))\n+b#554 = (???*0* | (???*1* ? ???*3* : ???*5*))\n - *0* arguments[1]\n     function calls are not analysed yet\n-- *1* (???*2* !== ???*3*)\n+- *1* (undefined !== ???*2*)\n     nested operation\n-- *2* unsupported expression\n-    This value might have side effects\n-- *3* arguments[2]\n+- *2* arguments[2]\n     function calls are not analysed yet\n-- *4* ???*5*(b)\n+- *3* ???*4*(b)\n     unknown callee\n-- *5* arguments[2]\n+- *4* arguments[2]\n     function calls are not analysed yet\n-- *6* b\n+- *5* b\n     circular variable reference\n \n b#555 = (\n@@ -9480,11 +9413,9 @@ b#961 = (\n - *34* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *35* (???*36* === ???*37*)\n+- *35* (undefined === ???*36*)\n     nested operation\n-- *36* unsupported expression\n-    This value might have side effects\n-- *37* a\n+- *36* a\n     circular variable reference\n \n b#963 = ???*0*\n@@ -9665,62 +9596,57 @@ b#997 = (\n - *20* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *21* (???*22* === ???*23*)\n+- *21* (undefined === ???*22*)\n     nested operation\n-- *22* unsupported expression\n-    This value might have side effects\n-- *23* a\n+- *22* a\n     circular variable reference\n \n ba = (\n   | \"onCompositionStart\"\n   | undefined\n   | \"onCompositionEnd\"\n   | \"onCompositionUpdate\"\n-  | ???*0*\n-  | new (...) => ???*1*(???*2*, ???*3*, null, ???*4*, ???*5*)\n+  | new (...) => ???*0*(???*1*, ???*2*, null, ???*3*, ???*4*)\n )\n - *0* unsupported expression\n     This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n-- *2* ba\n+- *1* ba\n     circular variable reference\n-- *3* arguments[0]\n+- *2* arguments[0]\n     function calls are not analysed yet\n-- *4* arguments[2]\n+- *3* arguments[2]\n     function calls are not analysed yet\n-- *5* (???*6* ? (???*11* | ???*13*) : (???*15* | ???*16* | ???*18*))\n+- *4* (???*5* ? (???*10* | ???*12*) : (???*14* | ???*15* | ???*17*))\n     nested operation\n-- *6* (3 === (???*7* | ???*9*))\n+- *5* (3 === (???*6* | ???*8*))\n     nested operation\n-- *7* ???*8*[\"nodeType\"]\n+- *6* ???*7*[\"nodeType\"]\n     unknown object\n-- *8* arguments[2]\n+- *7* arguments[2]\n     function calls are not analysed yet\n-- *9* ???*10*[\"nodeType\"]\n+- *8* ???*9*[\"nodeType\"]\n     unknown object\n     This value might have side effects\n-- *10* FreeVar(window)\n+- *9* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *11* ???*12*[\"parentNode\"]\n+- *10* ???*11*[\"parentNode\"]\n     unknown object\n-- *12* arguments[2]\n+- *11* arguments[2]\n     function calls are not analysed yet\n-- *13* ???*14*[\"parentNode\"]\n+- *12* ???*13*[\"parentNode\"]\n     unknown object\n     This value might have side effects\n-- *14* FreeVar(window)\n+- *13* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *15* arguments[2]\n+- *14* arguments[2]\n     function calls are not analysed yet\n-- *16* ???*17*[\"target\"]\n+- *15* ???*16*[\"target\"]\n     unknown object\n-- *17* a\n+- *16* a\n     circular variable reference\n-- *18* FreeVar(window)\n+- *17* FreeVar(window)\n     unknown global\n     This value might have side effects\n \n@@ -9823,23 +9749,21 @@ c#101 = ???*0*\n - *0* arguments[2]\n     function calls are not analysed yet\n \n-c#1012 = ((???*0* | ???*1*) ? ???*5* : null)\n+c#1012 = ((???*0* | ???*1*) ? ???*4* : null)\n - *0* unsupported expression\n     This value might have side effects\n-- *1* (???*2* !== ???*3*)\n+- *1* (undefined !== ???*2*)\n     nested operation\n-- *2* unsupported expression\n-    This value might have side effects\n-- *3* ???*4*[2]\n+- *2* ???*3*[2]\n     unknown object\n     This value might have side effects\n-- *4* FreeVar(arguments)\n+- *3* FreeVar(arguments)\n     unknown global\n     This value might have side effects\n-- *5* ???*6*[2]\n+- *4* ???*5*[2]\n     unknown object\n     This value might have side effects\n-- *6* FreeVar(arguments)\n+- *5* FreeVar(arguments)\n     unknown global\n     This value might have side effects\n \n@@ -10208,7 +10132,7 @@ c#251 = ???*0*\n - *3* arguments[0]\n     function calls are not analysed yet\n \n-c#254 = (???*0* | 0 | ???*1* | (???*2* + ???*3*) | ???*6* | ???*8* | ???*9*)\n+c#254 = (???*0* | 0 | ???*1* | (???*2* + ???*3*) | ???*6* | undefined | ???*8*)\n - *0* arguments[0]\n     function calls are not analysed yet\n - *1* d\n@@ -10225,9 +10149,7 @@ c#254 = (???*0* | 0 | ???*1* | (???*2* + ???*3*) | ???*6* | ???*8* | ???*9*)\n     unknown object\n - *7* a\n     circular variable reference\n-- *8* unsupported expression\n-    This value might have side effects\n-- *9* c\n+- *8* c\n     circular variable reference\n \n c#261 = ((\"string\" === ???*0*) | undefined | false)\n@@ -10297,8 +10219,8 @@ c#281 = ???*0*\n c#285 = (\n   | ???*0*\n   | (...) => undefined[\"bind\"](null, ???*1*, ???*2*, ???*3*)\n-  | ???*4*\n-  | true[\"bind\"](null, ???*9*, ???*10*, ???*11*)\n+  | undefined[\"bind\"](null, ???*4*, ???*5*, ???*6*)\n+  | true[\"bind\"](null, ???*7*, ???*8*, ???*9*)\n )\n - *0* arguments[2]\n     function calls are not analysed yet\n@@ -10308,22 +10230,17 @@ c#285 = (\n     circular variable reference\n - *3* arguments[0]\n     function calls are not analysed yet\n-- *4* ???*5*[\"bind\"](null, ???*6*, ???*7*, ???*8*)\n-    unknown callee object\n-    This value might have side effects\n-- *5* unsupported expression\n-    This value might have side effects\n-- *6* arguments[1]\n+- *4* arguments[1]\n     function calls are not analysed yet\n-- *7* c\n+- *5* c\n     circular variable reference\n-- *8* arguments[0]\n+- *6* arguments[0]\n     function calls are not analysed yet\n-- *9* arguments[1]\n+- *7* arguments[1]\n     function calls are not analysed yet\n-- *10* c\n+- *8* c\n     circular variable reference\n-- *11* arguments[0]\n+- *9* arguments[0]\n     function calls are not analysed yet\n \n c#286 = ???*0*\n@@ -11282,12 +11199,12 @@ c#537 = (\n           | ???*20*\n           | (???*22* ? 16 : (undefined | 1 | 4 | 16 | 536870912))\n         ),\n-        \"action\": ???*25*,\n+        \"action\": ???*24*,\n         \"hasEagerState\": false,\n         \"eagerState\": null,\n         \"next\": null\n     }\n-  | (???*26* ? ???*30* : null)\n+  | (???*25* ? ???*29* : null)\n )\n - *0* arguments[2]\n     function calls are not analysed yet\n@@ -11336,27 +11253,25 @@ c#537 = (\n - *21* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *22* (???*23* === ???*24*)\n+- *22* (undefined === ???*23*)\n     nested operation\n-- *23* unsupported expression\n-    This value might have side effects\n-- *24* a\n+- *23* a\n     circular variable reference\n-- *25* c\n+- *24* c\n     circular variable reference\n-- *26* (3 === ???*27*)\n+- *25* (3 === ???*26*)\n     nested operation\n-- *27* ???*28*[\"tag\"]\n+- *26* ???*27*[\"tag\"]\n     unknown object\n-- *28* ???*29*[\"alternate\"]\n+- *27* ???*28*[\"alternate\"]\n     unknown object\n-- *29* arguments[0]\n+- *28* arguments[0]\n     function calls are not analysed yet\n-- *30* ???*31*[\"stateNode\"]\n+- *29* ???*30*[\"stateNode\"]\n     unknown object\n-- *31* ???*32*[\"alternate\"]\n+- *30* ???*31*[\"alternate\"]\n     unknown object\n-- *32* arguments[0]\n+- *31* arguments[0]\n     function calls are not analysed yet\n \n c#539 = (???*0* | (???*1* ? ???*5* : null))\n@@ -11738,7 +11653,7 @@ c#634 = ???*0*\n - *1* arguments[1]\n     function calls are not analysed yet\n \n-c#639 = (???*0* | null | {} | ???*1* | ???*5* | undefined | (???*22* ? ???*23* : ???*25*))\n+c#639 = (???*0* | null | {} | ???*1* | ???*5* | undefined | (???*19* ? ???*20* : undefined))\n - *0* arguments[2]\n     function calls are not analysed yet\n - *1* ???*2*[(???*3* | null | undefined | [] | ???*4*)]\n@@ -11748,57 +11663,49 @@ c#639 = (???*0* | null | {} | ???*1* | ???*5* | undefined | (???*22* ? ???*23* :\n - *3* for-in variable currently not analyzed\n - *4* f\n     circular variable reference\n-- *5* ???*6*[(???*20* | null | undefined | [] | ???*21*)]\n+- *5* ???*6*[(???*17* | null | undefined | [] | ???*18*)]\n     unknown object\n     This value might have side effects\n - *6* Object.assign*7*(\n         {},\n         ???*8*,\n         {\n-            \"defaultChecked\": ???*9*,\n-            \"defaultValue\": ???*10*,\n-            \"value\": ???*11*,\n-            \"checked\": (???*12* ? ???*15* : ???*17*)\n+            \"defaultChecked\": undefined,\n+            \"defaultValue\": undefined,\n+            \"value\": undefined,\n+            \"checked\": (???*9* ? ???*12* : ???*14*)\n         }\n     )\n     only const object assign is supported\n     This value might have side effects\n - *7* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n - *8* d\n     circular variable reference\n-- *9* unsupported expression\n-    This value might have side effects\n-- *10* unsupported expression\n-    This value might have side effects\n-- *11* unsupported expression\n-    This value might have side effects\n-- *12* (null != ???*13*)\n+- *9* (null != ???*10*)\n     nested operation\n-- *13* ???*14*[\"checked\"]\n+- *10* ???*11*[\"checked\"]\n     unknown object\n-- *14* d\n+- *11* d\n     circular variable reference\n-- *15* ???*16*[\"checked\"]\n+- *12* ???*13*[\"checked\"]\n     unknown object\n-- *16* d\n+- *13* d\n     circular variable reference\n-- *17* ???*18*[\"initialChecked\"]\n+- *14* ???*15*[\"initialChecked\"]\n     unknown object\n-- *18* ???*19*[\"_wrapperState\"]\n+- *15* ???*16*[\"_wrapperState\"]\n     unknown object\n-- *19* arguments[0]\n+- *16* arguments[0]\n     function calls are not analysed yet\n-- *20* for-in variable currently not analyzed\n-- *21* f\n+- *17* for-in variable currently not analyzed\n+- *18* f\n     circular variable reference\n-- *22* k\n+- *19* k\n     circular variable reference\n-- *23* ???*24*[\"__html\"]\n+- *20* ???*21*[\"__html\"]\n     unknown object\n-- *24* k\n+- *21* k\n     circular variable reference\n-- *25* unsupported expression\n-    This value might have side effects\n \n c#64 = (???*0*() | \"\"[\"_valueTracker\"][\"getValue\"]())\n - *0* ???*1*[\"getValue\"]\n@@ -12802,7 +12709,10 @@ d#251 = (???*0* | 0 | ???*4*)\n \n d#254 = (\n   | ???*0*\n-  | ((???*1* | 0 | ???*2*) + (???*3* | 0[\"textContent\"][\"length\"] | ???*6*))\n+  | (\n+      + (???*1* | 0 | ???*2*)\n+      + (???*3* | 0[\"textContent\"][\"length\"] | undefined[\"textContent\"][\"length\"])\n+    )\n )\n - *0* d\n     pattern without value\n@@ -12816,14 +12726,6 @@ d#254 = (\n     unknown object\n - *5* arguments[0]\n     function calls are not analysed yet\n-- *6* ???*7*[\"length\"]\n-    unknown object\n-    This value might have side effects\n-- *7* ???*8*[\"textContent\"]\n-    unknown object\n-    This value might have side effects\n-- *8* unsupported expression\n-    This value might have side effects\n \n d#264 = ???*0*\n - *0* d\n@@ -13171,11 +13073,9 @@ d#419 = (\n - *22* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *23* (???*24* === ???*25*)\n+- *23* (undefined === ???*24*)\n     nested operation\n-- *24* unsupported expression\n-    This value might have side effects\n-- *25* a\n+- *24* a\n     circular variable reference\n \n d#420 = ???*0*\n@@ -13187,7 +13087,7 @@ d#421 = (\n   | ???*0*\n   | new ???*2*(???*3*, (???*4* | ???*6* | ???*7* | ???*8*))[\"contextTypes\"]\n   | (null !== ???*13*)\n-  | (???*14* !== ???*15*)\n+  | (undefined !== ???*14*)\n )\n - *0* ???*1*[\"contextTypes\"]\n     unknown object\n@@ -13218,9 +13118,7 @@ d#421 = (\n     function calls are not analysed yet\n - *13* d\n     circular variable reference\n-- *14* unsupported expression\n-    This value might have side effects\n-- *15* d\n+- *14* d\n     circular variable reference\n \n d#422 = ???*0*\n@@ -13634,16 +13532,14 @@ d#517 = ???*0*\n - *0* arguments[3]\n     function calls are not analysed yet\n \n-d#518 = (???*0* | (???*1* ? null : ???*4*))\n+d#518 = (???*0* | (???*1* ? null : ???*3*))\n - *0* arguments[3]\n     function calls are not analysed yet\n-- *1* (???*2* === ???*3*)\n+- *1* (undefined === ???*2*)\n     nested operation\n-- *2* unsupported expression\n-    This value might have side effects\n-- *3* d\n+- *2* d\n     circular variable reference\n-- *4* d\n+- *3* d\n     circular variable reference\n \n d#530 = ???*0*\n@@ -13715,11 +13611,9 @@ d#537 = (\n - *20* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *21* (???*22* === ???*23*)\n+- *21* (undefined === ???*22*)\n     nested operation\n-- *22* unsupported expression\n-    This value might have side effects\n-- *23* a\n+- *22* a\n     circular variable reference\n \n d#539 = (\n@@ -13781,11 +13675,9 @@ d#539 = (\n - *20* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *21* (???*22* === ???*23*)\n+- *21* (undefined === ???*22*)\n     nested operation\n-- *22* unsupported expression\n-    This value might have side effects\n-- *23* a\n+- *22* a\n     circular variable reference\n \n d#547 = (???*0* | undefined | ???*2*)\n@@ -14176,38 +14068,32 @@ d#639 = (???*0* | ???*1*)\n         {},\n         ???*3*,\n         {\n-            \"defaultChecked\": ???*4*,\n-            \"defaultValue\": ???*5*,\n-            \"value\": ???*6*,\n-            \"checked\": (???*7* ? ???*10* : ???*12*)\n+            \"defaultChecked\": undefined,\n+            \"defaultValue\": undefined,\n+            \"value\": undefined,\n+            \"checked\": (???*4* ? ???*7* : ???*9*)\n         }\n     )\n     only const object assign is supported\n     This value might have side effects\n - *2* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n - *3* d\n     circular variable reference\n-- *4* unsupported expression\n-    This value might have side effects\n-- *5* unsupported expression\n-    This value might have side effects\n-- *6* unsupported expression\n-    This value might have side effects\n-- *7* (null != ???*8*)\n+- *4* (null != ???*5*)\n     nested operation\n-- *8* ???*9*[\"checked\"]\n+- *5* ???*6*[\"checked\"]\n     unknown object\n-- *9* d\n+- *6* d\n     circular variable reference\n-- *10* ???*11*[\"checked\"]\n+- *7* ???*8*[\"checked\"]\n     unknown object\n-- *11* d\n+- *8* d\n     circular variable reference\n-- *12* ???*13*[\"initialChecked\"]\n+- *9* ???*10*[\"initialChecked\"]\n     unknown object\n-- *13* ???*14*[\"_wrapperState\"]\n+- *10* ???*11*[\"_wrapperState\"]\n     unknown object\n-- *14* arguments[0]\n+- *11* arguments[0]\n     function calls are not analysed yet\n \n d#64 = (\"\" | ((???*0* | ???*1*) ? ???*5* : ???*8*))\n@@ -14795,23 +14681,21 @@ d#953 = ???*0*\n - *0* arguments[3]\n     function calls are not analysed yet\n \n-d#954 = ((???*0* | ???*1*) ? ???*5* : null)\n+d#954 = ((???*0* | ???*1*) ? ???*4* : null)\n - *0* unsupported expression\n     This value might have side effects\n-- *1* (???*2* !== ???*3*)\n+- *1* (undefined !== ???*2*)\n     nested operation\n-- *2* unsupported expression\n-    This value might have side effects\n-- *3* ???*4*[3]\n+- *2* ???*3*[3]\n     unknown object\n     This value might have side effects\n-- *4* FreeVar(arguments)\n+- *3* FreeVar(arguments)\n     unknown global\n     This value might have side effects\n-- *5* ???*6*[3]\n+- *4* ???*5*[3]\n     unknown object\n     This value might have side effects\n-- *6* FreeVar(arguments)\n+- *5* FreeVar(arguments)\n     unknown global\n     This value might have side effects\n \n@@ -14841,16 +14725,14 @@ d#960 = (???*0* | (???*1* ? ???*3* : ???*4*))\n - *11* unsupported expression\n     This value might have side effects\n \n-d#961 = (???*0* | (???*1* ? null : ???*4*))\n+d#961 = (???*0* | (???*1* ? null : ???*3*))\n - *0* arguments[3]\n     function calls are not analysed yet\n-- *1* (???*2* === ???*3*)\n+- *1* (undefined === ???*2*)\n     nested operation\n-- *2* unsupported expression\n-    This value might have side effects\n-- *3* d\n+- *2* d\n     circular variable reference\n-- *4* d\n+- *3* d\n     circular variable reference\n \n d#979 = (???*0* | (...) => undefined)\n@@ -15424,9 +15306,7 @@ e#275 = (\n - *8* d\n     circular variable reference\n \n-e#285 = ((...) => undefined | ???*0* | true)\n-- *0* unsupported expression\n-    This value might have side effects\n+e#285 = ((...) => undefined | undefined | true)\n \n e#286 = ???*0*\n - *0* arguments[4]\n@@ -15711,11 +15591,9 @@ e#417 = (\n - *22* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *23* (???*24* === ???*25*)\n+- *23* (undefined === ???*24*)\n     nested operation\n-- *24* unsupported expression\n-    This value might have side effects\n-- *25* a\n+- *24* a\n     circular variable reference\n \n e#418 = (\n@@ -15782,11 +15660,9 @@ e#418 = (\n - *22* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *23* (???*24* === ???*25*)\n+- *23* (undefined === ???*24*)\n     nested operation\n-- *24* unsupported expression\n-    This value might have side effects\n-- *25* a\n+- *24* a\n     circular variable reference\n \n e#419 = {\n@@ -15882,11 +15758,9 @@ e#419 = {\n - *33* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *34* (???*35* === ???*36*)\n+- *34* (undefined === ???*35*)\n     nested operation\n-- *35* unsupported expression\n-    This value might have side effects\n-- *36* a\n+- *35* a\n     circular variable reference\n \n e#420 = ???*0*\n@@ -16237,12 +16111,12 @@ e#539 = (\n           | ???*19*\n           | (???*21* ? 16 : (undefined | 1 | 4 | 16 | 536870912))\n         ),\n-        \"action\": (???*24* | (???*25* ? ???*29* : null)),\n+        \"action\": (???*23* | (???*24* ? ???*28* : null)),\n         \"hasEagerState\": false,\n         \"eagerState\": null,\n         \"next\": null\n     }\n-  | (???*32* ? ???*34* : ???*35*)\n+  | (???*31* ? ???*33* : ???*34*)\n )\n - *0* unsupported expression\n     This value might have side effects\n@@ -16289,49 +16163,47 @@ e#539 = (\n - *20* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *21* (???*22* === ???*23*)\n+- *21* (undefined === ???*22*)\n     nested operation\n-- *22* unsupported expression\n-    This value might have side effects\n-- *23* a\n+- *22* a\n     circular variable reference\n-- *24* arguments[2]\n+- *23* arguments[2]\n     function calls are not analysed yet\n-- *25* (3 === ???*26*)\n+- *24* (3 === ???*25*)\n     nested operation\n-- *26* ???*27*[\"tag\"]\n+- *25* ???*26*[\"tag\"]\n     unknown object\n-- *27* ???*28*[\"alternate\"]\n+- *26* ???*27*[\"alternate\"]\n     unknown object\n-- *28* arguments[0]\n+- *27* arguments[0]\n     function calls are not analysed yet\n-- *29* ???*30*[\"stateNode\"]\n+- *28* ???*29*[\"stateNode\"]\n     unknown object\n-- *30* ???*31*[\"alternate\"]\n+- *29* ???*30*[\"alternate\"]\n     unknown object\n-- *31* arguments[0]\n+- *30* arguments[0]\n     function calls are not analysed yet\n-- *32* (0 !== ???*33*)\n+- *31* (0 !== ???*32*)\n     nested operation\n-- *33* unsupported expression\n+- *32* unsupported expression\n     This value might have side effects\n-- *34* module<scheduler, {}>[\"unstable_now\"]()\n+- *33* module<scheduler, {}>[\"unstable_now\"]()\n     nested operation\n-- *35* (???*36* ? (???*40* | ???*41*) : ???*42*)\n+- *34* (???*35* ? (???*39* | ???*40*) : ???*41*)\n     nested operation\n-- *36* (???*37* !== (???*38* | ???*39*))\n+- *35* (???*36* !== (???*37* | ???*38*))\n     nested operation\n-- *37* unsupported expression\n+- *36* unsupported expression\n     This value might have side effects\n-- *38* unsupported expression\n+- *37* unsupported expression\n     This value might have side effects\n-- *39* module<scheduler, {}>[\"unstable_now\"]()\n+- *38* module<scheduler, {}>[\"unstable_now\"]()\n     nested operation\n-- *40* unsupported expression\n+- *39* unsupported expression\n     This value might have side effects\n-- *41* module<scheduler, {}>[\"unstable_now\"]()\n+- *40* module<scheduler, {}>[\"unstable_now\"]()\n     nested operation\n-- *42* unsupported expression\n+- *41* unsupported expression\n     This value might have side effects\n \n e#559 = (\n@@ -16641,38 +16513,32 @@ e#639 = (???*0* | ???*2*)\n         {},\n         ???*4*,\n         {\n-            \"defaultChecked\": ???*5*,\n-            \"defaultValue\": ???*6*,\n-            \"value\": ???*7*,\n-            \"checked\": (???*8* ? ???*11* : ???*13*)\n+            \"defaultChecked\": undefined,\n+            \"defaultValue\": undefined,\n+            \"value\": undefined,\n+            \"checked\": (???*5* ? ???*8* : ???*10*)\n         }\n     )\n     only const object assign is supported\n     This value might have side effects\n - *3* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n - *4* e\n     circular variable reference\n-- *5* unsupported expression\n-    This value might have side effects\n-- *6* unsupported expression\n-    This value might have side effects\n-- *7* unsupported expression\n-    This value might have side effects\n-- *8* (null != ???*9*)\n+- *5* (null != ???*6*)\n     nested operation\n-- *9* ???*10*[\"checked\"]\n+- *6* ???*7*[\"checked\"]\n     unknown object\n-- *10* e\n+- *7* e\n     circular variable reference\n-- *11* ???*12*[\"checked\"]\n+- *8* ???*9*[\"checked\"]\n     unknown object\n-- *12* e\n+- *9* e\n     circular variable reference\n-- *13* ???*14*[\"initialChecked\"]\n+- *10* ???*11*[\"initialChecked\"]\n     unknown object\n-- *14* ???*15*[\"_wrapperState\"]\n+- *11* ???*12*[\"_wrapperState\"]\n     unknown object\n-- *15* arguments[0]\n+- *12* arguments[0]\n     function calls are not analysed yet\n \n e#646 = ???*0*\n@@ -17045,11 +16911,9 @@ e#960 = (\n - *39* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *40* (???*41* === ???*42*)\n+- *40* (undefined === ???*41*)\n     nested operation\n-- *41* unsupported expression\n-    This value might have side effects\n-- *42* a\n+- *41* a\n     circular variable reference\n \n e#961 = (???*0* | ???*2* | ???*3*)\n@@ -17334,55 +17198,52 @@ f#266 = ???*0*\n     This value might have side effects\n \n f#275 = (\n-  | ???*0*\n   | undefined\n-  | ???*1*\n-  | null[(0 | ???*8*)][(???*9* | undefined | ???*10* | 0)][\"instance\"]\n-  | undefined[(0 | ???*11*)][(???*12* | undefined | ???*13* | 0)][\"instance\"]\n-  | undefined[(???*14* | undefined | ???*15* | 0)][\"instance\"]\n+  | ???*0*\n+  | null[(0 | ???*7*)][(???*8* | undefined | ???*9* | 0)][\"instance\"]\n+  | undefined[(0 | ???*10*)][(???*11* | undefined | ???*12* | 0)][\"instance\"]\n+  | undefined[(???*13* | undefined | ???*14* | 0)][\"instance\"]\n   | undefined[\"instance\"]\n-  | ???*16*\n+  | ???*15*\n )\n-- *0* unsupported expression\n-    This value might have side effects\n-- *1* ???*2*[\"instance\"]\n+- *0* ???*1*[\"instance\"]\n     unknown object\n     This value might have side effects\n-- *2* ???*3*[(???*6* | undefined | ???*7* | 0)]\n+- *1* ???*2*[(???*5* | undefined | ???*6* | 0)]\n     unknown object\n     This value might have side effects\n-- *3* ???*4*[(0 | ???*5*)]\n+- *2* ???*3*[(0 | ???*4*)]\n     unknown object\n     This value might have side effects\n-- *4* arguments[0]\n+- *3* arguments[0]\n     function calls are not analysed yet\n-- *5* updated with update expression\n+- *4* updated with update expression\n     This value might have side effects\n-- *6* unsupported expression\n+- *5* unsupported expression\n+    This value might have side effects\n+- *6* updated with update expression\n     This value might have side effects\n - *7* updated with update expression\n     This value might have side effects\n-- *8* updated with update expression\n+- *8* unsupported expression\n     This value might have side effects\n-- *9* unsupported expression\n+- *9* updated with update expression\n     This value might have side effects\n - *10* updated with update expression\n     This value might have side effects\n-- *11* updated with update expression\n-    This value might have side effects\n-- *12* unsupported expression\n+- *11* unsupported expression\n     This value might have side effects\n-- *13* updated with update expression\n+- *12* updated with update expression\n     This value might have side effects\n-- *14* unsupported expression\n+- *13* unsupported expression\n     This value might have side effects\n-- *15* updated with update expression\n+- *14* updated with update expression\n     This value might have side effects\n-- *16* ???*17*[\"instance\"]\n+- *15* ???*16*[\"instance\"]\n     unknown object\n-- *17* ???*18*[\"listener\"]\n+- *16* ???*17*[\"listener\"]\n     unknown object\n-- *18* h\n+- *17* h\n     circular variable reference\n \n f#286 = (???*0* | ???*1* | ???*2* | ???*4* | undefined | ???*6*)\n@@ -17689,11 +17550,9 @@ f#417 = {\n - *33* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *34* (???*35* === ???*36*)\n+- *34* (undefined === ???*35*)\n     nested operation\n-- *35* unsupported expression\n-    This value might have side effects\n-- *36* a\n+- *35* a\n     circular variable reference\n \n f#418 = {\n@@ -17789,11 +17648,9 @@ f#418 = {\n - *33* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *34* (???*35* === ???*36*)\n+- *34* (undefined === ???*35*)\n     nested operation\n-- *35* unsupported expression\n-    This value might have side effects\n-- *36* a\n+- *35* a\n     circular variable reference\n \n f#420 = ???*0*\n@@ -17942,48 +17799,46 @@ f#504 = !(???*0*)\n     function calls are not analysed yet\n \n f#518 = (\n-  | ???*0*\n+  | undefined\n   | null[\"memoizedState\"][\"destroy\"]\n-  | ???*1*\n+  | ???*0*\n   | null[\"alternate\"][\"memoizedState\"][\"destroy\"]\n-  | ???*4*\n+  | ???*3*\n+  | (null !== ???*7*)[\"alternate\"][\"memoizedState\"][\"destroy\"]\n   | (null !== ???*8*)[\"alternate\"][\"memoizedState\"][\"destroy\"]\n-  | (null !== ???*9*)[\"alternate\"][\"memoizedState\"][\"destroy\"]\n   | undefined[\"memoizedState\"][\"destroy\"]\n-  | (???*11* ? ???*13* : null)[\"memoizedState\"][\"destroy\"]\n+  | (???*10* ? ???*12* : null)[\"memoizedState\"][\"destroy\"]\n   | undefined[\"destroy\"]\n )\n-- *0* unsupported expression\n-    This value might have side effects\n-- *1* ???*2*[\"destroy\"]\n+- *0* ???*1*[\"destroy\"]\n     unknown object\n     This value might have side effects\n-- *2* ???*3*[\"memoizedState\"]\n+- *1* ???*2*[\"memoizedState\"]\n     unknown object\n     This value might have side effects\n-- *3* unsupported expression\n+- *2* unsupported expression\n     This value might have side effects\n-- *4* ???*5*[\"destroy\"]\n+- *3* ???*4*[\"destroy\"]\n     unknown object\n-- *5* ???*6*[\"memoizedState\"]\n+- *4* ???*5*[\"memoizedState\"]\n     unknown object\n-- *6* ???*7*[\"alternate\"]\n+- *5* ???*6*[\"alternate\"]\n     unknown object\n-- *7* arguments[1]\n+- *6* arguments[1]\n     function calls are not analysed yet\n-- *8* O\n+- *7* O\n     circular variable reference\n-- *9* ???*10*[\"next\"]\n+- *8* ???*9*[\"next\"]\n     unknown object\n-- *10* O\n+- *9* O\n     circular variable reference\n-- *11* (null !== ???*12*)\n+- *10* (null !== ???*11*)\n     nested operation\n-- *12* a\n+- *11* a\n     circular variable reference\n-- *13* ???*14*[\"memoizedState\"]\n+- *12* ???*13*[\"memoizedState\"]\n     unknown object\n-- *14* a\n+- *13* a\n     circular variable reference\n \n f#539 = (???*0* | undefined)\n@@ -18546,11 +18401,9 @@ f#960 = (\n - *52* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *53* (???*54* === ???*55*)\n+- *53* (undefined === ???*54*)\n     nested operation\n-- *54* unsupported expression\n-    This value might have side effects\n-- *55* a\n+- *54* a\n     circular variable reference\n \n f#961 = (???*0* ? ???*2* : ???*3*)\n@@ -19203,11 +19056,9 @@ g#961 = (\n - *24* FreeVar(window)\n     unknown global\n     This value might have side effects\n-- *25* (???*26* === ???*27*)\n+- *25* (undefined === ???*26*)\n     nested operation\n-- *26* unsupported expression\n-    This value might have side effects\n-- *27* a\n+- *26* a\n     circular variable reference\n \n g#979 = (???*0* | ???*1* | undefined)\n@@ -19240,15 +19091,11 @@ gb = (...) => A(\n     {},\n     b,\n     {\n-        \"value\": ???*0*,\n-        \"defaultValue\": ???*1*,\n+        \"value\": undefined,\n+        \"defaultValue\": undefined,\n         \"children\": `${a[\"_wrapperState\"][\"initialValue\"]}`\n     }\n )\n-- *0* unsupported expression\n-    This value might have side effects\n-- *1* unsupported expression\n-    This value might have side effects\n \n gc = module<scheduler, {}>[\"unstable_UserBlockingPriority\"]\n \n@@ -19500,8 +19347,8 @@ h#639 = (\n   | ???*0*\n   | ???*5*\n   | undefined\n-  | (???*22* ? (???*39* | ???*44*) : ???*61*)\n-  | (???*62* ? ???*63* : ???*65*)\n+  | (???*19* ? (???*33* | ???*38*) : undefined)\n+  | (???*52* ? ???*53* : undefined)\n )\n - *0* ???*1*[(???*3* | null | undefined | [] | ???*4*)]\n     unknown object\n@@ -19512,154 +19359,132 @@ h#639 = (\n - *3* for-in variable currently not analyzed\n - *4* f\n     circular variable reference\n-- *5* ???*6*[(???*20* | null | undefined | [] | ???*21*)]\n+- *5* ???*6*[(???*17* | null | undefined | [] | ???*18*)]\n     unknown object\n     This value might have side effects\n - *6* Object.assign*7*(\n         {},\n         ???*8*,\n         {\n-            \"defaultChecked\": ???*9*,\n-            \"defaultValue\": ???*10*,\n-            \"value\": ???*11*,\n-            \"checked\": (???*12* ? ???*15* : ???*17*)\n+            \"defaultChecked\": undefined,\n+            \"defaultValue\": undefined,\n+            \"value\": undefined,\n+            \"checked\": (???*9* ? ???*12* : ???*14*)\n         }\n     )\n     only const object assign is supported\n     This value might have side effects\n - *7* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n - *8* e\n     circular variable reference\n-- *9* unsupported expression\n-    This value might have side effects\n-- *10* unsupported expression\n-    This value might have side effects\n-- *11* unsupported expression\n-    This value might have side effects\n-- *12* (null != ???*13*)\n+- *9* (null != ???*10*)\n     nested operation\n-- *13* ???*14*[\"checked\"]\n+- *10* ???*11*[\"checked\"]\n     unknown object\n-- *14* e\n+- *11* e\n     circular variable reference\n-- *15* ???*16*[\"checked\"]\n+- *12* ???*13*[\"checked\"]\n     unknown object\n-- *16* e\n+- *13* e\n     circular variable reference\n-- *17* ???*18*[\"initialChecked\"]\n+- *14* ???*15*[\"initialChecked\"]\n     unknown object\n-- *18* ???*19*[\"_wrapperState\"]\n+- *15* ???*16*[\"_wrapperState\"]\n     unknown object\n-- *19* arguments[0]\n+- *16* arguments[0]\n     function calls are not analysed yet\n-- *20* for-in variable currently not analyzed\n-- *21* f\n+- *17* for-in variable currently not analyzed\n+- *18* f\n     circular variable reference\n-- *22* (null != (???*23* | ???*25*))\n+- *19* (null != (???*20* | ???*22*))\n     nested operation\n-- *23* ???*24*[\"memoizedProps\"]\n+- *20* ???*21*[\"memoizedProps\"]\n     unknown object\n-- *24* arguments[0]\n+- *21* arguments[0]\n     function calls are not analysed yet\n-- *25* Object.assign*26*(\n+- *22* Object.assign*23*(\n         {},\n-        ???*27*,\n+        ???*24*,\n         {\n-            \"defaultChecked\": ???*28*,\n-            \"defaultValue\": ???*29*,\n-            \"value\": ???*30*,\n-            \"checked\": (???*31* ? ???*34* : ???*36*)\n+            \"defaultChecked\": undefined,\n+            \"defaultValue\": undefined,\n+            \"value\": undefined,\n+            \"checked\": (???*25* ? ???*28* : ???*30*)\n         }\n     )\n     only const object assign is supported\n     This value might have side effects\n-- *26* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n-- *27* e\n+- *23* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n+- *24* e\n     circular variable reference\n-- *28* unsupported expression\n-    This value might have side effects\n-- *29* unsupported expression\n-    This value might have side effects\n-- *30* unsupported expression\n-    This value might have side effects\n-- *31* (null != ???*32*)\n+- *25* (null != ???*26*)\n     nested operation\n-- *32* ???*33*[\"checked\"]\n+- *26* ???*27*[\"checked\"]\n     unknown object\n-- *33* e\n+- *27* e\n     circular variable reference\n-- *34* ???*35*[\"checked\"]\n+- *28* ???*29*[\"checked\"]\n     unknown object\n-- *35* e\n+- *29* e\n     circular variable reference\n-- *36* ???*37*[\"initialChecked\"]\n+- *30* ???*31*[\"initialChecked\"]\n     unknown object\n-- *37* ???*38*[\"_wrapperState\"]\n+- *31* ???*32*[\"_wrapperState\"]\n     unknown object\n-- *38* arguments[0]\n+- *32* arguments[0]\n     function calls are not analysed yet\n-- *39* ???*40*[(???*42* | null | undefined | [] | ???*43*)]\n+- *33* ???*34*[(???*36* | null | undefined | [] | ???*37*)]\n     unknown object\n-- *40* ???*41*[\"memoizedProps\"]\n+- *34* ???*35*[\"memoizedProps\"]\n     unknown object\n-- *41* arguments[0]\n+- *35* arguments[0]\n     function calls are not analysed yet\n-- *42* for-in variable currently not analyzed\n-- *43* f\n+- *36* for-in variable currently not analyzed\n+- *37* f\n     circular variable reference\n-- *44* ???*45*[(???*59* | null | undefined | [] | ???*60*)]\n+- *38* ???*39*[(???*50* | null | undefined | [] | ???*51*)]\n     unknown object\n     This value might have side effects\n-- *45* Object.assign*46*(\n+- *39* Object.assign*40*(\n         {},\n-        ???*47*,\n+        ???*41*,\n         {\n-            \"defaultChecked\": ???*48*,\n-            \"defaultValue\": ???*49*,\n-            \"value\": ???*50*,\n-            \"checked\": (???*51* ? ???*54* : ???*56*)\n+            \"defaultChecked\": undefined,\n+            \"defaultValue\": undefined,\n+            \"value\": undefined,\n+            \"checked\": (???*42* ? ???*45* : ???*47*)\n         }\n     )\n     only const object assign is supported\n     This value might have side effects\n-- *46* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n-- *47* e\n+- *40* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n+- *41* e\n     circular variable reference\n-- *48* unsupported expression\n-    This value might have side effects\n-- *49* unsupported expression\n-    This value might have side effects\n-- *50* unsupported expression\n-    This value might have side effects\n-- *51* (null != ???*52*)\n+- *42* (null != ???*43*)\n     nested operation\n-- *52* ???*53*[\"checked\"]\n+- *43* ???*44*[\"checked\"]\n     unknown object\n-- *53* e\n+- *44* e\n     circular variable reference\n-- *54* ???*55*[\"checked\"]\n+- *45* ???*46*[\"checked\"]\n     unknown object\n-- *55* e\n+- *46* e\n     circular variable reference\n-- *56* ???*57*[\"initialChecked\"]\n+- *47* ???*48*[\"initialChecked\"]\n     unknown object\n-- *57* ???*58*[\"_wrapperState\"]\n+- *48* ???*49*[\"_wrapperState\"]\n     unknown object\n-- *58* arguments[0]\n+- *49* arguments[0]\n     function calls are not analysed yet\n-- *59* for-in variable currently not analyzed\n-- *60* f\n+- *50* for-in variable currently not analyzed\n+- *51* f\n     circular variable reference\n-- *61* unsupported expression\n-    This value might have side effects\n-- *62* h\n+- *52* h\n     circular variable reference\n-- *63* ???*64*[\"__html\"]\n+- *53* ???*54*[\"__html\"]\n     unknown object\n-- *64* h\n+- *54* h\n     circular variable reference\n-- *65* unsupported expression\n-    This value might have side effects\n \n h#647 = ???*0*\n - *0* max number of linking steps reached\n@@ -20242,65 +20067,57 @@ k#609 = ???*0*\n - *0* max number of linking steps reached\n     This value might have side effects\n \n-k#639 = (???*0* | ???*4* | undefined | (???*21* ? ???*22* : ???*24*))\n+k#639 = (???*0* | ???*4* | undefined | (???*18* ? ???*19* : undefined))\n - *0* ???*1*[(???*2* | null | undefined | [] | ???*3*)]\n     unknown object\n - *1* arguments[3]\n     function calls are not analysed yet\n - *2* for-in variable currently not analyzed\n - *3* f\n     circular variable reference\n-- *4* ???*5*[(???*19* | null | undefined | [] | ???*20*)]\n+- *4* ???*5*[(???*16* | null | undefined | [] | ???*17*)]\n     unknown object\n     This value might have side effects\n - *5* Object.assign*6*(\n         {},\n         ???*7*,\n         {\n-            \"defaultChecked\": ???*8*,\n-            \"defaultValue\": ???*9*,\n-            \"value\": ???*10*,\n-            \"checked\": (???*11* ? ???*14* : ???*16*)\n+            \"defaultChecked\": undefined,\n+            \"defaultValue\": undefined,\n+            \"value\": undefined,\n+            \"checked\": (???*8* ? ???*11* : ???*13*)\n         }\n     )\n     only const object assign is supported\n     This value might have side effects\n - *6* Object.assign: Object.assign method: https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n - *7* d\n     circular variable reference\n-- *8* unsupported expression\n-    This value might have side effects\n-- *9* unsupported expression\n-    This value might have side effects\n-- *10* unsupported expression\n-    This value might have side effects\n-- *11* (null != ???*12*)\n+- *8* (null != ???*9*)\n     nested operation\n-- *12* ???*13*[\"checked\"]\n+- *9* ???*10*[\"checked\"]\n     unknown object\n-- *13* d\n+- *10* d\n     circular variable reference\n-- *14* ???*15*[\"checked\"]\n+- *11* ???*12*[\"checked\"]\n     unknown object\n-- *15* d\n+- *12* d\n     circular variable reference\n-- *16* ???*17*[\"initialChecked\"]\n+- *13* ???*14*[\"initialChecked\"]\n     unknown object\n-- *17* ???*18*[\"_wrapperState\"]\n+- *14* ???*15*[\"_wrapperState\"]\n     unknown object\n-- *18* arguments[0]\n+- *15* arguments[0]\n     function calls are not analysed yet\n-- *19* for-in variable currently not analyzed\n-- *20* f\n+- *16* for-in variable currently not analyzed\n+- *17* f\n     circular variable reference\n-- *21* k\n+- *18* k\n     circular variable reference\n-- *22* ???*23*[\"__html\"]\n+- *19* ???*20*[\"__html\"]\n     unknown object\n-- *23* k\n+- *20* k\n     circular variable reference\n-- *24* unsupported expression\n-    This value might have side effects\n \n k#647 = ???*0*\n - *0* max number of linking steps reached\n@@ -20886,7 +20703,7 @@ mb = (???*0* | ???*1* | ???*2*)\n \n mc = (...) => undefined\n \n-md = (null | ???*0* | ???*14*)\n+md = (null | ???*0* | ???*13*)\n - *0* ???*1*((???*8* | 0 | ???*9*), ???*10*)\n     unknown callee\n     This value might have side effects\n@@ -20908,16 +20725,14 @@ md = (null | ???*0* | ???*14*)\n     pattern without value\n - *9* updated with update expression\n     This value might have side effects\n-- *10* (???*11* ? ???*12* : ???*13*)\n+- *10* (???*11* ? ???*12* : undefined)\n     nested operation\n - *11* unsupported expression\n     This value might have side effects\n - *12* unsupported expression\n     This value might have side effects\n - *13* unsupported expression\n     This value might have side effects\n-- *14* unsupported expression\n-    This value might have side effects\n \n me = (...) => ((\"input\" === b) ? !(!(le[a[\"type\"]])) : ((\"textarea\" === b) ? !(0) : !(1)))\n "
        }
    ],
    "stats": {
        "total": 10702,
        "additions": 4408,
        "deletions": 6294
    }
}