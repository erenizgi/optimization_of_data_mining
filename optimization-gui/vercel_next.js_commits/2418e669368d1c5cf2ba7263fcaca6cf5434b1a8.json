{
    "author": "timneutkens",
    "message": "Development: Use process.hrtime for request time calculation (#84905)\n\n## What?\n\nInstead of using `Date.now()` to compare timing uses the more\nappropriate `process.hrtime.bigint()`",
    "sha": "2418e669368d1c5cf2ba7263fcaca6cf5434b1a8",
    "files": [
        {
            "sha": "5fed40d5d43da561575e4e2ce38bd9a5a5da48a5",
            "filename": "packages/next/src/build/duration-to-string.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/2418e669368d1c5cf2ba7263fcaca6cf5434b1a8/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2418e669368d1c5cf2ba7263fcaca6cf5434b1a8/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fduration-to-string.ts?ref=2418e669368d1c5cf2ba7263fcaca6cf5434b1a8",
            "patch": "@@ -17,6 +17,18 @@ export function hrtimeToSeconds(hrtime: [number, number]): number {\n   return hrtime[0] + hrtime[1] / 1e9\n }\n \n+function nanosecondsBigIntToSeconds(nanoseconds: bigint): number {\n+  return Number(nanoseconds) / 1000000000\n+}\n+\n+function hrtimeBigIntToSeconds(hrtime: bigint): number {\n+  return nanosecondsBigIntToSeconds(hrtime)\n+}\n+\n+export function hrtimeBigIntDurationToString(hrtime: bigint) {\n+  return durationToString(hrtimeBigIntToSeconds(hrtime))\n+}\n+\n export function hrtimeDurationToString(hrtime: [number, number]): string {\n   return durationToString(hrtimeToSeconds(hrtime))\n }"
        },
        {
            "sha": "f15cd9635f898d7030c2bdcef8acf62fecfae002",
            "filename": "packages/next/src/server/dev/log-requests.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 23,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/2418e669368d1c5cf2ba7263fcaca6cf5434b1a8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Flog-requests.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2418e669368d1c5cf2ba7263fcaca6cf5434b1a8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Flog-requests.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Flog-requests.ts?ref=2418e669368d1c5cf2ba7263fcaca6cf5434b1a8",
            "patch": "@@ -1,3 +1,4 @@\n+import { hrtimeBigIntDurationToString } from '../../build/duration-to-string'\n import {\n   blue,\n   bold,\n@@ -13,13 +14,6 @@ import type { NodeNextRequest, NodeNextResponse } from '../base-http/node'\n import type { LoggingConfig } from '../config-shared'\n import { getRequestMeta } from '../request-meta'\n \n-export interface RequestLoggingOptions {\n-  readonly request: NodeNextRequest\n-  readonly response: NodeNextResponse\n-  readonly loggingConfig: LoggingConfig | undefined\n-  readonly requestDurationInMs: number\n-}\n-\n /**\n  * Returns true if the incoming request should be ignored for logging.\n  */\n@@ -44,15 +38,20 @@ export function ignoreLoggingIncomingRequests(\n   return ignore.some((pattern) => pattern.test(request.url))\n }\n \n-export function logRequests(options: RequestLoggingOptions): void {\n-  const { request, response, loggingConfig, requestDurationInMs } = options\n-\n+export function logRequests(\n+  request: NodeNextRequest,\n+  response: NodeNextResponse,\n+  loggingConfig: LoggingConfig,\n+  requestStartTime: bigint,\n+  requestEndTime: bigint\n+): void {\n   if (!ignoreLoggingIncomingRequests(request, loggingConfig)) {\n-    logIncomingRequests({\n+    logIncomingRequests(\n       request,\n-      requestDurationInMs,\n-      statusCode: response.statusCode,\n-    })\n+      requestStartTime,\n+      requestEndTime,\n+      response.statusCode\n+    )\n   }\n \n   if (request.fetchMetrics) {\n@@ -62,14 +61,12 @@ export function logRequests(options: RequestLoggingOptions): void {\n   }\n }\n \n-interface IncomingRequestOptions {\n-  readonly request: NodeNextRequest\n-  readonly requestDurationInMs: number\n-  readonly statusCode: number\n-}\n-\n-function logIncomingRequests(options: IncomingRequestOptions): void {\n-  const { request, requestDurationInMs, statusCode } = options\n+function logIncomingRequests(\n+  request: NodeNextRequest,\n+  requestStartTime: bigint,\n+  requestEndTime: bigint,\n+  statusCode: number\n+): void {\n   const isRSC = getRequestMeta(request, 'isRSCRequest')\n   const url = isRSC ? stripNextRscUnionQuery(request.url) : request.url\n \n@@ -87,7 +84,7 @@ function logIncomingRequests(options: IncomingRequestOptions): void {\n   const coloredStatus = statusCodeColor(statusCode.toString())\n \n   return writeLine(\n-    `${request.method} ${url} ${coloredStatus} in ${requestDurationInMs}ms`\n+    `${request.method} ${url} ${coloredStatus} in ${hrtimeBigIntDurationToString(requestEndTime - requestStartTime)}`\n   )\n }\n "
        },
        {
            "sha": "a76cb99d12ece3e115228e9dc30517d6c8c3e494",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2418e669368d1c5cf2ba7263fcaca6cf5434b1a8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2418e669368d1c5cf2ba7263fcaca6cf5434b1a8/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=2418e669368d1c5cf2ba7263fcaca6cf5434b1a8",
            "patch": "@@ -466,7 +466,7 @@ export default class DevServer extends Server {\n       const loggingConfig = this.nextConfig.logging\n \n       if (loggingConfig !== false) {\n-        const start = Date.now()\n+        const requestStart = process.hrtime.bigint()\n         const isMiddlewareRequest = getRequestMeta(req, 'middlewareInvoke')\n \n         if (!isMiddlewareRequest) {\n@@ -480,12 +480,14 @@ export default class DevServer extends Server {\n               return\n             }\n \n-            logRequests({\n+            const requestEnd = process.hrtime.bigint()\n+            logRequests(\n               request,\n               response,\n               loggingConfig,\n-              requestDurationInMs: Date.now() - start,\n-            })\n+              requestStart,\n+              requestEnd\n+            )\n           })\n         }\n       }"
        }
    ],
    "stats": {
        "total": 65,
        "additions": 38,
        "deletions": 27
    }
}