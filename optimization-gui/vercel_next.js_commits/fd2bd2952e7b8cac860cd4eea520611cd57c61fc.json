{
    "author": "timneutkens",
    "message": "Move Ready in time before handler initialization (#88235)\n\n## Move \"Ready in X\" log before config loading and eliminate duplicate\n`loadConfig` calls\n\n### What?\n\nReorder the dev server startup flow so the \"Ready in X\" log appears\nbefore loading the user's `next.config.js`, and eliminate duplicate\n`loadConfig` calls in both dev and build paths.\n\n### Why?\n\nPreviously, the \"Ready in X\" time included the time spent loading and\nevaluating the user's `next.config.js` file. This made the framework\nappear slower than it actually is, especially for projects with complex\nconfig files or slow config evaluation.\n\nAdditionally, config was being loaded twice:\n- **Dev server**: Once in `getStartServerInfo()` just for logging, then\nagain in `getRequestHandlers()`\n- **Build**: Once for the main build, then again in\n`getStartServerInfo()` just for logging\n\n### How?\n\n**Before:**\n```\n1. getStartServerInfo() → loadConfig #1 (slow - blocks on next.config.js)\n2. logStartInfo() → logs version, URLs, experimental features\n3. \"Ready in X\" ← time includes config loading\n4. getRequestHandlers() → loadConfig #2\n```\n\n**After:**\n```\n1. logStartInfo() → logs version, URLs, envInfo (no config needed)\n2. \"Ready in X\" ← reflects actual framework startup time\n3. getRequestHandlers() → loadConfig (once)\n4. logExperimentalInfo() → logs experimental features\n```\n\n**Changes:**\n\n- Split `logStartInfo` into two functions:\n- `logStartInfo()` - basic info (version, URLs, env) - no config needed\n  - `logExperimentalInfo()` - experimental features and cacheComponents\n- Removed `getStartServerInfo()` which was loading config unnecessarily\n- Added `experimentalFeatures` and `cacheComponents` to\n`ServerInitResult` so they can be passed back after config loads\n- In build, added `reportExperimentalFeatures` callback to the existing\n`loadConfig` call instead of loading config twice\n\n---------\n\nCo-authored-by: Vercel <vercel[bot]@users.noreply.github.com>",
    "sha": "fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
    "files": [
        {
            "sha": "7660725c94ef1d73184da99d6fab0726e9c89c3e",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -49,8 +49,7 @@ if (\n   process.exit(1)\n }\n \n-// Start performance profiling after Node.js version is checked\n-performance.mark('next-start')\n+process.env.NEXT_PRIVATE_START_TIME = Date.now().toString()\n \n for (const dependency of ['react', 'react-dom']) {\n   try {"
        },
        {
            "sha": "61223ab7b992066e3c659d42f0f6e4cd670a3629",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 9,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -187,7 +187,12 @@ import {\n   updateBuildDiagnostics,\n   recordFetchMetrics,\n } from '../diagnostics/build-diagnostics'\n-import { getStartServerInfo, logStartInfo } from '../server/lib/app-info-log'\n+import {\n+  getEnvInfo,\n+  logExperimentalInfo,\n+  logStartInfo,\n+  type ConfiguredExperimentalFeature,\n+} from '../server/lib/app-info-log'\n import type { NextEnabledDirectories } from '../server/base-server'\n import { hasCustomExportOutput } from '../export/utils'\n import { traceMemoryUsage } from '../lib/memory/trace'\n@@ -931,6 +936,7 @@ export default async function build(\n       NextBuildContext.loadedEnvFiles = loadedEnvFiles\n \n       const turborepoAccessTraceResult = new TurborepoAccessTraceResult()\n+      let experimentalFeatures: ConfiguredExperimentalFeature[] = []\n       const config: NextConfigComplete = await nextBuildSpan\n         .traceChild('load-next-config')\n         .traceAsyncFn(() =>\n@@ -941,6 +947,11 @@ export default async function build(\n                 silent: false,\n                 reactProductionProfiling,\n                 debugPrerender,\n+                reportExperimentalFeatures(features) {\n+                  experimentalFeatures = features.toSorted(\n+                    ({ key: a }, { key: b }) => a.localeCompare(b)\n+                  )\n+                },\n               }),\n             turborepoAccessTraceResult\n           )\n@@ -1117,20 +1128,18 @@ export default async function build(\n       )\n \n       // Always log next version first then start rest jobs\n-      const { envInfo, experimentalFeatures, cacheComponents } =\n-        await getStartServerInfo({\n-          dir,\n-          dev: false,\n-          debugPrerender,\n-        })\n+      const envInfo = getEnvInfo(dir)\n \n       logStartInfo({\n         networkUrl: null,\n         appUrl: null,\n         envInfo,\n-        experimentalFeatures,\n         logBundler: true,\n-        cacheComponents,\n+      })\n+\n+      logExperimentalInfo({\n+        experimentalFeatures,\n+        cacheComponents: !!config.cacheComponents,\n       })\n \n       const typeCheckingOptions: Parameters<typeof startTypeChecking>[0] = {"
        },
        {
            "sha": "226d9b5d76adbca6dc7f4e23424c2d1eb0fdc057",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -305,6 +305,7 @@ const nextDev = async (\n         env: {\n           ...defaultEnv,\n           ...(isTurbopack ? { TURBOPACK: process.env.TURBOPACK } : undefined),\n+          NEXT_PRIVATE_START_TIME: process.env.NEXT_PRIVATE_START_TIME,\n           NEXT_PRIVATE_WORKER: '1',\n           NEXT_PRIVATE_TRACE_ID: traceId,\n           NODE_EXTRA_CA_CERTS: startServerOptions.selfSignedCertificate"
        },
        {
            "sha": "8fe3f6ad4c8ccd3f60ec9b879029bf290678a075",
            "filename": "packages/next/src/server/lib/app-info-log.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 57,
            "changes": 86,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -2,27 +2,26 @@ import { loadEnvConfig } from '@next/env'\n import * as inspector from 'inspector'\n import * as Log from '../../build/output/log'\n import { bold, purple, strikethrough } from '../../lib/picocolors'\n-import {\n-  PHASE_DEVELOPMENT_SERVER,\n-  PHASE_PRODUCTION_BUILD,\n-} from '../../shared/lib/constants'\n-import loadConfig, { type ConfiguredExperimentalFeature } from '../config'\n+import type { ConfiguredExperimentalFeature } from '../config'\n import { experimentalSchema } from '../config-schema'\n \n+// Re-export the type for consumers\n+export type { ConfiguredExperimentalFeature }\n+\n+/**\n+ * Logs basic startup info that doesn't require config.\n+ * Called before \"Ready in X\" to show immediate feedback.\n+ */\n export function logStartInfo({\n   networkUrl,\n   appUrl,\n   envInfo,\n-  experimentalFeatures,\n   logBundler,\n-  cacheComponents,\n }: {\n   networkUrl: string | null\n   appUrl: string | null\n   envInfo?: string[]\n-  experimentalFeatures?: ConfiguredExperimentalFeature[]\n   logBundler: boolean\n-  cacheComponents?: boolean\n }) {\n   let versionSuffix = ''\n   const parts = []\n@@ -37,10 +36,6 @@ export function logStartInfo({\n     }\n   }\n \n-  if (cacheComponents) {\n-    parts.push('Cache Components')\n-  }\n-\n   if (parts.length > 0) {\n     versionSuffix = ` (${parts.join(', ')})`\n   }\n@@ -66,6 +61,22 @@ export function logStartInfo({\n     Log.bootstrap(`- Debugger port: ${debugPort}`)\n   }\n   if (envInfo?.length) Log.bootstrap(`- Environments: ${envInfo.join(', ')}`)\n+}\n+\n+/**\n+ * Logs experimental features and config-dependent info.\n+ * Called after getRequestHandlers completes.\n+ */\n+export function logExperimentalInfo({\n+  experimentalFeatures,\n+  cacheComponents,\n+}: {\n+  experimentalFeatures?: ConfiguredExperimentalFeature[]\n+  cacheComponents?: boolean\n+}) {\n+  if (cacheComponents) {\n+    Log.bootstrap(`- Cache Components enabled`)\n+  }\n \n   if (experimentalFeatures?.length) {\n     Log.bootstrap(`- Experiments (use with caution):`)\n@@ -102,49 +113,10 @@ export function logStartInfo({\n   Log.info('')\n }\n \n-export async function getStartServerInfo({\n-  dir,\n-  dev,\n-  debugPrerender,\n-}: {\n-  dir: string\n-  dev: boolean\n-  debugPrerender?: boolean\n-}): Promise<{\n-  envInfo?: string[]\n-  experimentalFeatures?: ConfiguredExperimentalFeature[]\n-  cacheComponents?: boolean\n-}> {\n-  let experimentalFeatures: ConfiguredExperimentalFeature[] = []\n-  let cacheComponents = false\n-  const config = await loadConfig(\n-    dev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_BUILD,\n-    dir,\n-    {\n-      reportExperimentalFeatures(features) {\n-        experimentalFeatures = features.sort(({ key: a }, { key: b }) =>\n-          a.localeCompare(b)\n-        )\n-      },\n-      debugPrerender,\n-      silent: false,\n-    }\n-  )\n-\n-  cacheComponents = !!config.cacheComponents\n-\n-  // we need to reset env if we are going to create\n-  // the worker process with the esm loader so that the\n-  // initial env state is correct\n-  let envInfo: string[] = []\n+/**\n+ * Gets environment info for logging. Fast operation that doesn't require config.\n+ */\n+export function getEnvInfo(dir: string): string[] {\n   const { loadedEnvFiles } = loadEnvConfig(dir, true, console, false)\n-  if (loadedEnvFiles.length > 0) {\n-    envInfo = loadedEnvFiles.map((f) => f.path)\n-  }\n-\n-  return {\n-    envInfo,\n-    experimentalFeatures,\n-    cacheComponents,\n-  }\n+  return loadedEnvFiles.map((f) => f.path)\n }"
        },
        {
            "sha": "0d59b01817ebc49f2fee7ec2b810e17e2279c90c",
            "filename": "packages/next/src/server/lib/render-server.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frender-server.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -8,6 +8,7 @@ import type { ServerResponse } from 'http'\n import type { OnCacheEntryHandler } from '../request-meta'\n import { interopDefault } from '../../lib/interop-default'\n import { formatDynamicImportPath } from '../../lib/format-dynamic-import-path'\n+import type { ConfiguredExperimentalFeature } from '../config'\n \n export type ServerInitResult = {\n   requestHandler: RequestHandler\n@@ -17,6 +18,10 @@ export type ServerInitResult = {\n   closeUpgraded: () => void\n   // The distDir from config, used by the parent process for telemetry/trace\n   distDir: string\n+  // Experimental features from config, used for logging after server is ready\n+  experimentalFeatures: ConfiguredExperimentalFeature[]\n+  // Whether cache components is enabled\n+  cacheComponents: boolean\n }\n \n let initializations: Record<string, Promise<ServerInitResult> | undefined> = {}\n@@ -94,6 +99,8 @@ async function initializeImpl(opts: {\n   quiet?: boolean\n   onDevServerCleanup: ((listener: () => Promise<void>) => void) | undefined\n   distDir: string\n+  experimentalFeatures: ConfiguredExperimentalFeature[]\n+  cacheComponents: boolean\n }): Promise<ServerInitResult> {\n   const type = process.env.__NEXT_PRIVATE_RENDER_WORKER\n   if (type) {\n@@ -170,6 +177,8 @@ async function initializeImpl(opts: {\n       opts.bundlerService?.close()\n     },\n     distDir: opts.distDir,\n+    experimentalFeatures: opts.experimentalFeatures,\n+    cacheComponents: opts.cacheComponents,\n   }\n }\n "
        },
        {
            "sha": "31a322d3cb1809fdc7bb90181c1e64910d3ad1fd",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -9,7 +9,7 @@ import '../require-hook'\n \n import url from 'url'\n import path from 'path'\n-import loadConfig from '../config'\n+import loadConfig, { type ConfiguredExperimentalFeature } from '../config'\n import { serveStatic } from '../serve-static'\n import setupDebug from 'next/dist/compiled/debug'\n import * as Log from '../../build/output/log'\n@@ -98,10 +98,18 @@ export async function initialize(opts: {\n     process.env.NODE_ENV = opts.dev ? 'development' : 'production'\n   }\n \n+  let experimentalFeatures: ConfiguredExperimentalFeature[] = []\n   const config = await loadConfig(\n     opts.dev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_SERVER,\n     opts.dir,\n-    { silent: false }\n+    {\n+      silent: false,\n+      reportExperimentalFeatures(features) {\n+        experimentalFeatures = features.toSorted(({ key: a }, { key: b }) =>\n+          a.localeCompare(b)\n+        )\n+      },\n+    }\n   )\n \n   let compress: ReturnType<typeof setupCompression> | undefined\n@@ -728,6 +736,8 @@ export async function initialize(opts: {\n     quiet: opts.quiet,\n     onDevServerCleanup: opts.onDevServerCleanup,\n     distDir: config.distDir,\n+    experimentalFeatures,\n+    cacheComponents: config.cacheComponents,\n   }\n   renderServerOpts.serverFields.routerServerHandler = requestHandlerImpl\n \n@@ -900,5 +910,7 @@ export async function initialize(opts: {\n       development?.bundler?.hotReloader?.close()\n     },\n     distDir: config.distDir,\n+    experimentalFeatures,\n+    cacheComponents: config.cacheComponents,\n   }\n }"
        },
        {
            "sha": "00b18ff4298010f12441870a3350122ac42bf9ae",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 35,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -29,13 +29,13 @@ import {\n   CONFIG_FILES,\n   PHASE_DEVELOPMENT_SERVER,\n } from '../../shared/lib/constants'\n-import { getStartServerInfo, logStartInfo } from './app-info-log'\n+import { getEnvInfo, logExperimentalInfo, logStartInfo } from './app-info-log'\n import { validateTurboNextConfig } from '../../lib/turbopack-warning'\n import { type Span, trace, flushAllTraces } from '../../trace'\n import { isIPv6 } from './is-ipv6'\n import { AsyncCallbackSet } from './async-callback-set'\n import type { NextServer } from '../next'\n-import type { ConfiguredExperimentalFeature } from '../config'\n+import { durationToString } from '../../build/duration-to-string'\n \n const debug = setupDebug('next:start-server')\n let startServerSpan: Span | undefined\n@@ -358,28 +358,30 @@ export async function startServer(\n         process.env.__NEXT_EXPERIMENTAL_HTTPS = '1'\n       }\n \n-      // Only load env and config in dev to for logging purposes\n-      let envInfo: string[] | undefined\n-      let experimentalFeatures: ConfiguredExperimentalFeature[] | undefined\n-      let cacheComponents: boolean | undefined\n-      try {\n-        if (isDev) {\n-          const startServerInfo = await getStartServerInfo({ dir, dev: isDev })\n-          envInfo = startServerInfo.envInfo\n-          cacheComponents = startServerInfo.cacheComponents\n-          experimentalFeatures = startServerInfo.experimentalFeatures\n-        }\n-        logStartInfo({\n-          networkUrl,\n-          appUrl,\n-          envInfo,\n-          experimentalFeatures,\n-          cacheComponents,\n-          logBundler: isDev,\n-        })\n+      // Get env info first (fast, doesn't require config)\n+      const envInfo = isDev ? getEnvInfo(dir) : undefined\n+\n+      // Log basic startup info immediately (before loading config)\n+      logStartInfo({\n+        networkUrl,\n+        appUrl,\n+        envInfo,\n+        logBundler: isDev,\n+      })\n+\n+      // Calculate and log \"Ready in X\" before loading config\n+      // so it reflects actual framework startup time\n+      const startTime = parseInt(process.env.NEXT_PRIVATE_START_TIME || '0', 10)\n+      const endTime = Date.now()\n+      const startServerProcessDurationMs = endTime - startTime\n \n-        Log.event(`Starting...`)\n+      const formattedStartDuration = durationToString(\n+        startServerProcessDurationMs / 1000\n+      )\n+\n+      Log.event(`Ready in ${formattedStartDuration}`)\n \n+      try {\n         let cleanupStarted = false\n         let closeUpgraded: (() => void) | null = null\n         const cleanup = () => {\n@@ -446,6 +448,7 @@ export async function startServer(\n           process.on('SIGTERM', cleanup)\n         }\n \n+        // Now load config via getRequestHandlers (single loadConfig call)\n         const initResult = await getRequestHandlers({\n           dir,\n           port,\n@@ -464,21 +467,15 @@ export async function startServer(\n         nextServer = initResult.server\n         closeUpgraded = initResult.closeUpgraded\n \n-        const startServerProcessDuration =\n-          performance.mark('next-start-end') &&\n-          performance.measure(\n-            'next-start-duration',\n-            'next-start',\n-            'next-start-end'\n-          ).duration\n+        // Log experimental features after config is loaded\n+        if (isDev) {\n+          logExperimentalInfo({\n+            experimentalFeatures: initResult.experimentalFeatures,\n+            cacheComponents: initResult.cacheComponents,\n+          })\n+        }\n \n         handlersReady()\n-        const formatDurationText =\n-          startServerProcessDuration > 2000\n-            ? `${Math.round(startServerProcessDuration / 100) / 10}s`\n-            : `${Math.round(startServerProcessDuration)}ms`\n-\n-        Log.event(`Ready in ${formatDurationText}`)\n \n         if (process.env.TURBOPACK && isDev) {\n           await validateTurboNextConfig({"
        },
        {
            "sha": "ef2662dd1435059c94681842fcbc8da12bf23c8e",
            "filename": "test/development/app-dir/dev-output/dev-output.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 36,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fdevelopment%2Fapp-dir%2Fdev-output%2Fdev-output.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fdevelopment%2Fapp-dir%2Fdev-output%2Fdev-output.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdev-output%2Fdev-output.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-const { version: nextVersion } = require('next/package.json')\n+import { retry } from 'next-test-utils'\n \n const cacheComponentsEnabled = process.env.__NEXT_CACHE_COMPONENTS === 'true'\n \n@@ -9,42 +9,30 @@ describe('dev-output', () => {\n   })\n \n   it('shows Cache Components indicator when enabled', async () => {\n-    const preamble = getPreambleOutput(next.cliOutput)\n-\n-    if (cacheComponentsEnabled) {\n-      if (isTurbopack) {\n-        expect(preamble).toContain('Next.js')\n-        expect(preamble).toContain('Turbopack')\n-        expect(preamble).toContain('Cache Components')\n-      } else {\n-        expect(preamble).toContain('Next.js')\n-        expect(preamble).toContain('webpack')\n-        expect(preamble).toContain('Cache Components')\n-      }\n-    } else {\n-      // When cache components env is not set, should not show the indicator\n-      expect(preamble).toContain('Next.js')\n-      if (isTurbopack) {\n-        expect(preamble).toContain('Turbopack')\n+    await next.fetch('/')\n+    await retry(async () => {\n+      const output = next.cliOutput\n+\n+      if (cacheComponentsEnabled) {\n+        if (isTurbopack) {\n+          expect(output).toContain('Next.js')\n+          expect(output).toContain('Turbopack')\n+          expect(output).toContain('Cache Components')\n+        } else {\n+          expect(output).toContain('Next.js')\n+          expect(output).toContain('webpack')\n+          expect(output).toContain('Cache Components')\n+        }\n       } else {\n-        expect(preamble).toContain('webpack')\n+        // When cache components env is not set, should not show the indicator\n+        expect(output).toContain('Next.js')\n+        if (isTurbopack) {\n+          expect(output).toContain('Turbopack')\n+        } else {\n+          expect(output).toContain('webpack')\n+        }\n+        expect(output).not.toContain('Cache Components')\n       }\n-      expect(preamble).not.toContain('Cache Components')\n-    }\n+    })\n   })\n })\n-\n-function getPreambleOutput(cliOutput: string): string {\n-  const lines: string[] = []\n-\n-  for (const line of cliOutput.split('\\n')) {\n-    // Capture lines up to and including the \"Local:\" line\n-    lines.push(line.replace(nextVersion, 'x.y.z'))\n-\n-    if (line.includes('Local:')) {\n-      break\n-    }\n-  }\n-\n-  return lines.join('\\n').trim()\n-}"
        },
        {
            "sha": "97533ad4c8c60ac3619e06b1f9728a3fdc3b58f1",
            "filename": "test/development/app-dir/isolated-dev-build/isolated-dev-build.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -7,8 +7,10 @@ describe('isolated-dev-build', () => {\n   })\n \n   it('should create dev artifacts in .next/dev/ directory', async () => {\n-    expect(await next.hasFile('.next/dev')).toBe(true)\n-    expect(await next.hasFile('.next/server')).toBe(false)\n+    await retry(async () => {\n+      expect(await next.hasFile('.next/dev')).toBe(true)\n+      expect(await next.hasFile('.next/server')).toBe(false)\n+    })\n   })\n \n   it('should work with HMR', async () => {"
        },
        {
            "sha": "1bcf5da5b1d87e1edba6c45b098964b2686bbf8a",
            "filename": "test/development/app-dir/server-components-hmr-cache/server-components-hmr-cache.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fserver-components-hmr-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fserver-components-hmr-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fserver-components-hmr-cache%2Fserver-components-hmr-cache.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -57,7 +57,7 @@ describe('server-components-hmr-cache', () => {\n \n       it('should use cached fetch calls for fast refresh requests', async () => {\n         const browser = await next.browser(`/${runtime}`)\n-        const valueBeforePatch = getLoggedAfterValue()\n+        const valueBeforePatch = await retry(() => getLoggedAfterValue())\n         cliOutputLength = next.cliOutput.length\n \n         await next.patchFile(\n@@ -70,7 +70,7 @@ describe('server-components-hmr-cache', () => {\n               // TODO: remove custom duration in case we increase the default.\n             }, 5000)\n \n-            const valueAfterPatch = getLoggedAfterValue()\n+            const valueAfterPatch = await retry(() => getLoggedAfterValue())\n             expect(valueBeforePatch).toEqual(valueAfterPatch)\n           }\n         )\n@@ -148,6 +148,8 @@ describe('server-components-hmr-cache', () => {\n \n     describe('with experimental.serverComponentsHmrCache disabled', () => {\n       beforeAll(async () => {\n+        // Wait for server to be ready\n+        await next.fetch('/404')\n         await next.patchFile('next.config.js', (content) =>\n           content.replace(\n             '// serverComponentsHmrCache: false,',"
        },
        {
            "sha": "c5582e76399aab099a77894db2c3f09f6a8f986a",
            "filename": "test/development/start-no-build/start-no-build.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fdevelopment%2Fstart-no-build%2Fstart-no-build.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fdevelopment%2Fstart-no-build%2Fstart-no-build.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fstart-no-build%2Fstart-no-build.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -6,7 +6,7 @@ describe('next start without next build', () => {\n       files: __dirname,\n       skipStart: true,\n       startCommand: `pnpm next start`,\n-      serverReadyPattern: /✓ Starting.../,\n+      serverReadyPattern: /Local:/,\n     })\n \n     await next.start()"
        },
        {
            "sha": "07bc92b75850b50d6ab8894f58d1a3c02c9d7891",
            "filename": "test/e2e/app-dir/app-middleware/app-middleware.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp-middleware.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -10,9 +10,11 @@ describe('app-dir with middleware', () => {\n   })\n \n   it('should warn when deprecated middleware file is used', async () => {\n-    expect(next.cliOutput).toContain(\n-      'The \"middleware\" file convention is deprecated. Please use \"proxy\" instead.'\n-    )\n+    await retry(async () => {\n+      expect(next.cliOutput).toContain(\n+        'The \"middleware\" file convention is deprecated. Please use \"proxy\" instead.'\n+      )\n+    })\n   })\n \n   it('should filter correctly after middleware rewrite', async () => {"
        },
        {
            "sha": "4eb2978f96e20c9f83013d4f6b67a58cb235ff94",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-console-patch.test.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 8,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-console-patch.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-console-patch.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-console-patch.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -1,6 +1,6 @@\n import { isNextDev, nextTestSetup } from 'e2e-utils'\n import { getPrerenderOutput } from './utils'\n-import stripAnsi from 'strip-ansi'\n+import { retry } from 'next-test-utils'\n \n describe('Cache Components Errors', () => {\n   const { next, isTurbopack, isNextStart, skipped } = nextTestSetup({\n@@ -32,16 +32,19 @@ describe('Cache Components Errors', () => {\n     describe('Console Patching', () => {\n       if (isNextDev) {\n         it('does not warn about sync IO if console.log is patched to call new Date() internally', async () => {\n-          await next.browser('/')\n-          let output = stripAnsi(next.cliOutput)\n+          await next.fetch('/404')\n+\n+          // Wait for after 404 is rendered to the console.\n+          await retry(async () => {\n+            expect(next.cliOutput).toContain('GET /404 404')\n+          })\n \n-          // trim off Next.js's startup logs\n-          const compilationMarker = /Ready in.*(\\n.*Compiling.*)?/\n-          expect(output).toMatch(compilationMarker)\n-          const match = compilationMarker.exec(output)\n-          output = output.slice(match.index + match[0].length).trim()\n+          const from = next.cliOutput.length\n+\n+          await next.browser('/')\n \n           // trim off any logs after the HTTP request finished\n+          const output = next.cliOutput.slice(from)\n           expect(output).toContain('GET / 200')\n           const snapshot = output.slice(0, output.indexOf('GET / 200')).trim()\n "
        },
        {
            "sha": "bc80e04e1f19adcde7b0e3f3a6896cbcc28753d7",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-dev-cache-bypass.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-dev-cache-bypass.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-dev-cache-bypass.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-dev-cache-bypass.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -12,6 +12,8 @@ describe('Cache Components Errors', () => {\n   describe('Warning for Bypassing Caches in Dev', () => {\n     if (isNextDev) {\n       it('warns if you render with cache-control: no-cache in dev on initial page load', async () => {\n+        // Wait for pages to be loaded to ensure the logging for the test page is the only thing that can be logged.\n+        await next.fetch('/404')\n         const from = next.cliOutput.length\n \n         await next.fetch('/', {\n@@ -26,6 +28,8 @@ describe('Cache Components Errors', () => {\n       })\n \n       it('warns if you render with cache-control: no-cache in dev on client navigation', async () => {\n+        // Wait for pages to be loaded to ensure the logging for the test page is the only thing that can be logged.\n+        await next.fetch('/404')\n         const from = next.cliOutput.length\n \n         await next.fetch('/other', {\n@@ -40,6 +44,8 @@ describe('Cache Components Errors', () => {\n       })\n \n       it('does not warn if you render without cache-control: no-cache in dev on initial page load', async () => {\n+        // Wait for pages to be loaded to ensure the logging for the test page is the only thing that can be logged.\n+        await next.fetch('/404')\n         const from = next.cliOutput.length\n \n         await next.fetch('/')\n@@ -50,6 +56,8 @@ describe('Cache Components Errors', () => {\n       })\n \n       it('does not warn if you render without cache-control: no-cache in dev on client navigation', async () => {\n+        // Wait for pages to be loaded to ensure the logging for the test page is the only thing that can be logged.\n+        await next.fetch('/404')\n         const from = next.cliOutput.length\n \n         await next.fetch('/', {\n@@ -62,6 +70,8 @@ describe('Cache Components Errors', () => {\n       })\n     } else {\n       it('does not warn if you render with cache-control: no-cache in dev on initial page load', async () => {\n+        // Wait for pages to be loaded to ensure the logging for the test page is the only thing that can be logged.\n+        await next.fetch('/404')\n         const from = next.cliOutput.length\n \n         await next.fetch('/', {\n@@ -74,6 +84,8 @@ describe('Cache Components Errors', () => {\n       })\n \n       it('does not warn if you render with cache-control: no-cache in dev on client navigation', async () => {\n+        // Wait for pages to be loaded to ensure the logging for the test page is the only thing that can be logged.\n+        await next.fetch('/404')\n         const from = next.cliOutput.length\n \n         await next.fetch('/', {\n@@ -86,6 +98,8 @@ describe('Cache Components Errors', () => {\n       })\n \n       it('does not warn if you render without cache-control: no-cache in dev on initial page load in start', async () => {\n+        // Wait for pages to be loaded to ensure the logging for the test page is the only thing that can be logged.\n+        await next.fetch('/404')\n         const from = next.cliOutput.length\n \n         await next.fetch('/')\n@@ -96,6 +110,8 @@ describe('Cache Components Errors', () => {\n       })\n \n       it('does not warn if you render without cache-control: no-cache in dev on client navigation in start', async () => {\n+        // Wait for pages to be loaded to ensure the logging for the test page is the only thing that can be logged.\n+        await next.fetch('/404')\n         const from = next.cliOutput.length\n \n         await next.fetch('/', {"
        },
        {
            "sha": "ef5a04becc6da6b50e3b78e3b21e3eb68370089c",
            "filename": "test/e2e/app-dir/i18n-hybrid/i18n-hybrid.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fi18n-hybrid%2Fi18n-hybrid.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fi18n-hybrid%2Fi18n-hybrid.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fi18n-hybrid%2Fi18n-hybrid.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -3,6 +3,7 @@\n // @ts-ignore\n import { nextTestSetup } from 'e2e-utils'\n import cheerio from 'cheerio'\n+import { retry } from 'next-test-utils'\n \n const { i18n } = require('./next.config')\n \n@@ -53,9 +54,11 @@ describe('i18n-hybrid', () => {\n   })\n \n   it('should warn about i18n in app dir', async () => {\n-    expect(next.cliOutput).toContain(\n-      'i18n configuration in next.config.js is unsupported in App Router.'\n-    )\n+    await retry(async () => {\n+      expect(next.cliOutput).toContain(\n+        'i18n configuration in next.config.js is unsupported in App Router.'\n+      )\n+    })\n   })\n \n   it.each(urls.filter((url) => !url.expected))("
        },
        {
            "sha": "551fe0c75d53ccc03436c22cf664c1b9b8f08158",
            "filename": "test/e2e/app-dir/instrumentation-order/instrumentation-order.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -11,7 +11,9 @@ describe('instrumentation-order', () => {\n     await next.fetch('/')\n \n     await retry(async () => {\n-      const serverLog = next.cliOutput.split('Starting...')[1]\n+      // `next.cliOutput` includes both `next build` and `next start` in the production test run\n+      // Because of that we have to split the output by `Ready in` and get the second part only\n+      const serverLog = next.cliOutput.split('Ready in')[1]\n       const cliOutputLines = serverLog.split('\\n')\n \n       const ORDERED_LOGS = ["
        },
        {
            "sha": "11f3d0a4e9f833603728ea4b729ff574607b1e7c",
            "filename": "test/e2e/app-dir/log-file/log-file.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Flog-file%2Flog-file.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Flog-file%2Flog-file.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Flog-file%2Flog-file.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -67,7 +67,8 @@ describe('log-file', () => {\n     return normalizeLogContent(newContent)\n   }\n \n-  beforeEach(() => {\n+  beforeEach(async () => {\n+    await next.fetch('/404')\n     // Reset log tracking at the start of each test to only capture new logs\n     previousLogContent = readLogFile()\n   })"
        },
        {
            "sha": "4dee5095364b4d65f4b9f5296666fd98e212f6cb",
            "filename": "test/e2e/app-dir/multiple-lockfiles/multiple-lockfiles.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 11,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmultiple-lockfiles%2Fmultiple-lockfiles.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -1,5 +1,6 @@\n import { join } from 'path'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n \n describe('multiple-lockfiles', () => {\n   const { next, skipped, isTurbopack } = nextTestSetup({\n@@ -23,18 +24,20 @@ describe('multiple-lockfiles', () => {\n   }\n \n   it('should have multiple lockfiles warnings', async () => {\n-    expect(next.cliOutput).toMatch(\n-      /We detected multiple lockfiles and selected the directory of .+ as the root directory\\./\n-    )\n-\n-    if (isTurbopack) {\n-      expect(next.cliOutput).toMatch(\n-        /To silence this warning, set `turbopack\\.root` in your Next\\.js config, or consider removing one of the lockfiles if it's not needed\\./\n-      )\n-    } else {\n+    await retry(async () => {\n       expect(next.cliOutput).toMatch(\n-        /To silence this warning, set `outputFileTracingRoot` in your Next\\.js config, or consider removing one of the lockfiles if it's not needed\\./\n+        /We detected multiple lockfiles and selected the directory of .+ as the root directory\\./\n       )\n-    }\n+\n+      if (isTurbopack) {\n+        expect(next.cliOutput).toMatch(\n+          /To silence this warning, set `turbopack\\.root` in your Next\\.js config, or consider removing one of the lockfiles if it's not needed\\./\n+        )\n+      } else {\n+        expect(next.cliOutput).toMatch(\n+          /To silence this warning, set `outputFileTracingRoot` in your Next\\.js config, or consider removing one of the lockfiles if it's not needed\\./\n+        )\n+      }\n+    })\n   })\n })"
        },
        {
            "sha": "028a7e8f03ef35b03cd8083a93d5f4bdc835581f",
            "filename": "test/e2e/app-dir/proxy-with-middleware/proxy-with-middleware.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n \n describe('proxy-with-middleware', () => {\n   const { next, isNextDev, skipped } = nextTestSetup({\n@@ -17,7 +18,9 @@ describe('proxy-with-middleware', () => {\n \n     if (isNextDev) {\n       await next.start().catch(() => {})\n-      expect(next.cliOutput).toContain(message)\n+      await retry(async () => {\n+        expect(next.cliOutput).toContain(message)\n+      })\n     } else {\n       const { cliOutput } = await next.build()\n       expect(cliOutput).toContain(message)"
        },
        {
            "sha": "48933d99f084bcdfa180b5497a76f315dfb21019",
            "filename": "test/e2e/app-dir/typed-routes-validator/typed-routes-validator.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -18,6 +18,7 @@ describe('typed-routes-validator', () => {\n   it('should generate route validation correctly', async () => {\n     if (isNextDev) {\n       await next.start()\n+      await next.fetch('/')\n     } else {\n       await next.build()\n     }"
        },
        {
            "sha": "cee4e87d5670e52ce3343b1f7d411d5e5e67626c",
            "filename": "test/e2e/build-indicator/test/index.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fbuild-indicator%2Ftest%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -49,9 +49,11 @@ describe('Build Activity Indicator', () => {\n         expect(result.exitCode).toBe(1)\n       }\n \n-      expect(next.cliOutput).toContain(\n-        `Invalid \"devIndicator.position\" provided, expected one of top-left, top-right, bottom-left, bottom-right, received ttop-leff`\n-      )\n+      await retry(async () => {\n+        expect(next.cliOutput).toContain(\n+          `Invalid \"devIndicator.position\" provided, expected one of top-left, top-right, bottom-left, bottom-right, received ttop-leff`\n+        )\n+      })\n     })\n   })\n "
        },
        {
            "sha": "b7bee6077810c495755e0f9ec59cf9558ccf33c3",
            "filename": "test/e2e/deprecation-warnings/deprecation-warnings.test.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 17,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fdeprecation-warnings%2Fdeprecation-warnings.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fdeprecation-warnings%2Fdeprecation-warnings.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fdeprecation-warnings%2Fdeprecation-warnings.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n import path from 'path'\n \n describe('deprecation-warnings', () => {\n@@ -27,28 +28,32 @@ describe('deprecation-warnings', () => {\n     it('should emit deprecation warnings for explicitly configured deprecated options', async () => {\n       await next.start()\n \n-      const logs = next.cliOutput\n+      await retry(async () => {\n+        const logs = next.cliOutput\n \n-      // Should warn about experimental.instrumentationHook\n-      expect(logs).toContain('experimental.instrumentationHook')\n-      expect(logs).toContain('no longer needed')\n+        // Should warn about experimental.instrumentationHook\n+        expect(logs).toContain('experimental.instrumentationHook')\n+        expect(logs).toContain('no longer needed')\n \n-      // Should warn about middleware config options\n-      expect(logs).toContain('experimental.middlewarePrefetch')\n-      expect(logs).toContain('Please use `experimental.proxyPrefetch` instead')\n+        // Should warn about middleware config options\n+        expect(logs).toContain('experimental.middlewarePrefetch')\n+        expect(logs).toContain(\n+          'Please use `experimental.proxyPrefetch` instead'\n+        )\n \n-      expect(logs).toContain('experimental.middlewareClientMaxBodySize')\n-      expect(logs).toContain(\n-        'Please use `experimental.proxyClientMaxBodySize` instead'\n-      )\n+        expect(logs).toContain('experimental.middlewareClientMaxBodySize')\n+        expect(logs).toContain(\n+          'Please use `experimental.proxyClientMaxBodySize` instead'\n+        )\n \n-      expect(logs).toContain('experimental.externalMiddlewareRewritesResolve')\n-      expect(logs).toContain(\n-        'Please use `experimental.externalProxyRewritesResolve` instead'\n-      )\n+        expect(logs).toContain('experimental.externalMiddlewareRewritesResolve')\n+        expect(logs).toContain(\n+          'Please use `experimental.externalProxyRewritesResolve` instead'\n+        )\n \n-      expect(logs).toContain('skipMiddlewareUrlNormalize')\n-      expect(logs).toContain('Please use `skipProxyUrlNormalize` instead')\n+        expect(logs).toContain('skipMiddlewareUrlNormalize')\n+        expect(logs).toContain('Please use `skipProxyUrlNormalize` instead')\n+      })\n     })\n   })\n })"
        },
        {
            "sha": "a9ea6595fd97ae7b43fc151bb15e26fa12d1085a",
            "filename": "test/e2e/next-phase/index.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fnext-phase%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fnext-phase%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-phase%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -23,6 +23,9 @@ describe('next-phase', () => {\n   if (skipped) return\n \n   it('should render page with next phase correctly', async () => {\n+    await next.fetch('/')\n+    await next.fetch('/foo')\n+\n     const phases = {\n       dev: 'phase-development-server',\n       build: 'phase-production-build',\n@@ -34,9 +37,6 @@ describe('next-phase', () => {\n     expect(next.cliOutput).toContain(currentPhase)\n     expect(next.cliOutput).not.toContain(nonExistedPhase)\n \n-    await next.fetch('/')\n-    await next.fetch('/foo')\n-\n     if (isNextDev) {\n       expect(next.cliOutput).not.toContain(phases.start)\n     } else {"
        },
        {
            "sha": "c719afc546a289cf0758a88a8280c9acd3fec38a",
            "filename": "test/e2e/persistent-caching-migration/persistent-caching-migration.test.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fpersistent-caching-migration%2Fpersistent-caching-migration.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fe2e%2Fpersistent-caching-migration%2Fpersistent-caching-migration.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fpersistent-caching-migration%2Fpersistent-caching-migration.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n \n const CASES = [\n   [\n@@ -47,8 +48,10 @@ describe('persistent-caching-migration', () => {\n         })\n       } else {\n         it('error on old option in dev', async () => {\n-          await expect(next.start()).toReject()\n-          expect(next.cliOutput).toContain(error)\n+          await next.start()\n+          await retry(async () => {\n+            expect(next.cliOutput).toContain(error)\n+          })\n         })\n       }\n     })"
        },
        {
            "sha": "8ed5c550288a43face98cd56f808d5380c51f34e",
            "filename": "test/integration/config-experimental-warning/test/index.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fconfig-experimental-warning%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fconfig-experimental-warning%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fconfig-experimental-warning%2Ftest%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -27,6 +27,8 @@ async function collectStdoutFromDev(appDir) {\n       stdout += msg\n     },\n   })\n+\n+  await fetch(`http://localhost:${port}`)\n   return stdout\n }\n \n@@ -114,7 +116,7 @@ describe('Config Experimental Warning', () => {\n     configFile.write(`\n       module.exports = (phase) => ({\n         experimental: {\n-          workerThreads: false\n+          workerThreads: false,\n           // We enable this by default in CI\n           strictRouteTypes: false,\n         }\n@@ -253,7 +255,7 @@ describe('Config Experimental Warning', () => {\n           },\n         })\n \n-        await retry(() => {\n+        await retry(async () => {\n           const cliOutput = stripAnsi(stdout)\n           const cliOutputErr = stripAnsi(stderr)\n           expect(cliOutput).not.toContain(experimentalHeader)"
        },
        {
            "sha": "b7b2b390edbc9c63ac26401b221cc454d4a12462",
            "filename": "test/integration/config-output-export/test/index.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 9,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fconfig-output-export%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fconfig-output-export%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fconfig-output-export%2Ftest%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -8,6 +8,7 @@ import {\n   getRedboxHeader,\n   killApp,\n   launchApp,\n+  retry,\n } from 'next-test-utils'\n import webdriver from 'next-webdriver'\n import { join } from 'path'\n@@ -17,7 +18,7 @@ import type { Response } from 'node-fetch'\n const appDir = join(__dirname, '../')\n const nextConfig = new File(join(appDir, 'next.config.js'))\n let app\n-const runDev = async (config: any) => {\n+const runDev = async (config: any, shouldWaitForReady = true) => {\n   await nextConfig.write(`module.exports = ${JSON.stringify(config)}`)\n   const port = await findPort()\n   const obj = { port, stdout: '', stderr: '' }\n@@ -31,6 +32,9 @@ const runDev = async (config: any) => {\n       obj.stderr += msg || ''\n     },\n   })\n+  if (shouldWaitForReady) {\n+    await fetch(`http://localhost:${port}`)\n+  }\n   return obj\n }\n \n@@ -53,16 +57,22 @@ describe('config-output-export', () => {\n   })\n \n   it('should error with \"i18n\" config', async () => {\n-    const { stderr } = await runDev({\n-      output: 'export',\n-      i18n: {\n-        locales: ['en'],\n-        defaultLocale: 'en',\n+    const data = await runDev(\n+      {\n+        output: 'export',\n+        i18n: {\n+          locales: ['en'],\n+          defaultLocale: 'en',\n+        },\n       },\n-    })\n-    expect(stderr).toContain(\n-      'Specified \"i18n\" cannot be used with \"output: export\".'\n+      false\n     )\n+\n+    await retry(() => {\n+      expect(data.stderr).toContain(\n+        'Specified \"i18n\" cannot be used with \"output: export\".'\n+      )\n+    })\n   })\n \n   describe('when hasNextSupport = false', () => {"
        },
        {
            "sha": "da75fd915f4565b1f2a4d7aa9ceaf8248d91e27c",
            "filename": "test/integration/invalid-custom-routes/test/index.test.ts",
            "status": "modified",
            "additions": 64,
            "deletions": 59,
            "changes": 123,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Finvalid-custom-routes%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Finvalid-custom-routes%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Finvalid-custom-routes%2Ftest%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -2,7 +2,7 @@\n \n import fs from 'fs-extra'\n import { join } from 'path'\n-import { launchApp, findPort, nextBuild } from 'next-test-utils'\n+import { launchApp, findPort, nextBuild, retry } from 'next-test-utils'\n \n let appDir = join(__dirname, '..')\n const nextConfigPath = join(appDir, 'next.config.js')\n@@ -33,11 +33,13 @@ const runTests = () => {\n       ],\n       'headers'\n     )\n-    const stderr = await getStderr()\n+    await retry(async () => {\n+      const stderr = await getStderr()\n \n-    expect(stderr).toContain(\n-      '`headers` field cannot be empty for route {\"source\":\"/:path*\"'\n-    )\n+      expect(stderr).toContain(\n+        '`headers` field cannot be empty for route {\"source\":\"/:path*\"'\n+      )\n+    })\n   })\n \n   it('should error when source and destination length is exceeded', async () => {\n@@ -137,61 +139,64 @@ const runTests = () => {\n       ],\n       'redirects'\n     )\n-    const stderr = await getStderr()\n-\n-    expect(stderr).toContain(\n-      `\\`destination\\` is missing for route {\"source\":\"/hello\",\"permanent\":false}`\n-    )\n-\n-    expect(stderr).toContain(\n-      `\\`source\\` is not a string for route {\"source\":123,\"destination\":\"/another\",\"permanent\":false}`\n-    )\n-\n-    expect(stderr).toContain(\n-      `\\`statusCode\\` is not undefined or valid statusCode for route {\"source\":\"/hello\",\"destination\":\"/another\",\"statusCode\":\"301\"}`\n-    )\n-\n-    expect(stderr).toContain(\n-      `\\`statusCode\\` is not undefined or valid statusCode for route {\"source\":\"/hello\",\"destination\":\"/another\",\"statusCode\":404}`\n-    )\n-\n-    expect(stderr).toContain(\n-      `\\`permanent\\` is not set to \\`true\\` or \\`false\\` for route {\"source\":\"/hello\",\"destination\":\"/another\",\"permanent\":\"yes\"}`\n-    )\n-\n-    expect(stderr).toContain(\n-      `\\`destination\\` has unnamed params :0 for route {\"source\":\"/hello/world/(.*)\",\"destination\":\"/:0\",\"permanent\":true}`\n-    )\n-\n-    expect(stderr).toContain(\n-      `The route null is not a valid object with \\`source\\` and \\`destination\\``\n-    )\n-\n-    expect(stderr).toContain(\n-      `The route \"string\" is not a valid object with \\`source\\` and \\`destination\\``\n-    )\n-\n-    expect(stderr).toContain('Invalid `has` item:')\n-    expect(stderr).toContain(\n-      `invalid type \"cookiee\" for {\"type\":\"cookiee\",\"key\":\"loggedIn\"}`\n-    )\n-    expect(stderr).toContain(\n-      `invalid \\`has\\` item found for route {\"source\":\"/hello\",\"destination\":\"/another\",\"has\":[{\"type\":\"cookiee\",\"key\":\"loggedIn\"}],\"permanent\":false}`\n-    )\n-\n-    expect(stderr).toContain('Invalid `has` items:')\n-    expect(stderr).toContain(\n-      `invalid type \"headerr\", invalid key \"undefined\" for {\"type\":\"headerr\"}`\n-    )\n-    expect(stderr).toContain(\n-      `invalid type \"queryr\" for {\"type\":\"queryr\",\"key\":\"hello\"}`\n-    )\n-    expect(stderr).toContain(\n-      `invalid \\`has\\` items found for route {\"source\":\"/hello\",\"destination\":\"/another\",\"permanent\":false,\"has\":[{\"type\":\"headerr\"},{\"type\":\"queryr\",\"key\":\"hello\"}]}`\n-    )\n-    expect(stderr).toContain(`Valid \\`has\\` object shape is {`)\n \n-    expect(stderr).toContain('Invalid redirects found')\n+    await retry(async () => {\n+      const stderr = await getStderr()\n+\n+      expect(stderr).toContain(\n+        `\\`destination\\` is missing for route {\"source\":\"/hello\",\"permanent\":false}`\n+      )\n+\n+      expect(stderr).toContain(\n+        `\\`source\\` is not a string for route {\"source\":123,\"destination\":\"/another\",\"permanent\":false}`\n+      )\n+\n+      expect(stderr).toContain(\n+        `\\`statusCode\\` is not undefined or valid statusCode for route {\"source\":\"/hello\",\"destination\":\"/another\",\"statusCode\":\"301\"}`\n+      )\n+\n+      expect(stderr).toContain(\n+        `\\`statusCode\\` is not undefined or valid statusCode for route {\"source\":\"/hello\",\"destination\":\"/another\",\"statusCode\":404}`\n+      )\n+\n+      expect(stderr).toContain(\n+        `\\`permanent\\` is not set to \\`true\\` or \\`false\\` for route {\"source\":\"/hello\",\"destination\":\"/another\",\"permanent\":\"yes\"}`\n+      )\n+\n+      expect(stderr).toContain(\n+        `\\`destination\\` has unnamed params :0 for route {\"source\":\"/hello/world/(.*)\",\"destination\":\"/:0\",\"permanent\":true}`\n+      )\n+\n+      expect(stderr).toContain(\n+        `The route null is not a valid object with \\`source\\` and \\`destination\\``\n+      )\n+\n+      expect(stderr).toContain(\n+        `The route \"string\" is not a valid object with \\`source\\` and \\`destination\\``\n+      )\n+\n+      expect(stderr).toContain('Invalid `has` item:')\n+      expect(stderr).toContain(\n+        `invalid type \"cookiee\" for {\"type\":\"cookiee\",\"key\":\"loggedIn\"}`\n+      )\n+      expect(stderr).toContain(\n+        `invalid \\`has\\` item found for route {\"source\":\"/hello\",\"destination\":\"/another\",\"has\":[{\"type\":\"cookiee\",\"key\":\"loggedIn\"}],\"permanent\":false}`\n+      )\n+\n+      expect(stderr).toContain('Invalid `has` items:')\n+      expect(stderr).toContain(\n+        `invalid type \"headerr\", invalid key \"undefined\" for {\"type\":\"headerr\"}`\n+      )\n+      expect(stderr).toContain(\n+        `invalid type \"queryr\" for {\"type\":\"queryr\",\"key\":\"hello\"}`\n+      )\n+      expect(stderr).toContain(\n+        `invalid \\`has\\` items found for route {\"source\":\"/hello\",\"destination\":\"/another\",\"permanent\":false,\"has\":[{\"type\":\"headerr\"},{\"type\":\"queryr\",\"key\":\"hello\"}]}`\n+      )\n+      expect(stderr).toContain(`Valid \\`has\\` object shape is {`)\n+\n+      expect(stderr).toContain('Invalid redirects found')\n+    })\n   })\n \n   it('should error during next build for invalid rewrites', async () => {"
        },
        {
            "sha": "0e8491cfae922170bd2e22b23f7a8d7fadf4d797",
            "filename": "test/integration/next-image-legacy/typescript/test/index.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fnext-image-legacy%2Ftypescript%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fnext-image-legacy%2Ftypescript%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-legacy%2Ftypescript%2Ftest%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -65,6 +65,7 @@ describe('TypeScript Image Component', () => {\n           onStdout: handleOutput,\n           onStderr: handleOutput,\n         })\n+        await fetch(`http://localhost:${appPort}`)\n       })\n       afterAll(() => killApp(app))\n \n@@ -96,7 +97,9 @@ describe('TypeScript Image Component', () => {\n         nextConfig,\n         content.replace('// disableStaticImages', 'disableStaticImages')\n       )\n-      const app = await launchApp(appDir, await findPort())\n+      const port = await findPort()\n+      const app = await launchApp(appDir, port)\n+      await fetch(`http://localhost:${port}`)\n       await killApp(app)\n       await fs.writeFile(nextConfig, content)\n       const envTypes = await fs.readFile(join(appDir, 'next-env.d.ts'), 'utf8')"
        },
        {
            "sha": "74b62a26b41d1f7b847cc962c5761fe7dd08ed5e",
            "filename": "test/integration/next-image-new/typescript/test/index.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fnext-image-new%2Ftypescript%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fnext-image-new%2Ftypescript%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Ftypescript%2Ftest%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -65,6 +65,7 @@ describe('TypeScript Image Component', () => {\n           onStdout: handleOutput,\n           onStderr: handleOutput,\n         })\n+        await fetch(`http://localhost:${appPort}`)\n       })\n       afterAll(() => killApp(app))\n \n@@ -95,7 +96,9 @@ describe('TypeScript Image Component', () => {\n       nextConfig,\n       content.replace('// disableStaticImages', 'disableStaticImages')\n     )\n-    const app = await launchApp(appDir, await findPort())\n+    const port = await findPort()\n+    const app = await launchApp(appDir, port)\n+    await fetch(`http://localhost:${port}`)\n     await killApp(app)\n     await fs.writeFile(nextConfig, content)\n     const envTypes = await fs.readFile(join(appDir, 'next-env.d.ts'), 'utf8')"
        },
        {
            "sha": "d41f00b81bde9df4ef92fa58b459967b632efe35",
            "filename": "test/integration/typescript-app-type-declarations/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Ftest%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -42,6 +42,7 @@ describe('TypeScript App Type Declarations', () => {\n       let app\n       try {\n         app = await launchApp(appDir, appPort, {})\n+        await fetch(`http://localhost:${appPort}`)\n         const content = await fs.readFile(appTypeDeclarations, 'utf8')\n         expect(content).toEqual(prevContent)\n       } finally {\n@@ -60,6 +61,7 @@ describe('TypeScript App Type Declarations', () => {\n       let app\n       try {\n         app = await launchApp(appDir, appPort, {})\n+        await fetch(`http://localhost:${appPort}`)\n         const content = await fs.readFile(appTypeDeclarations, 'utf8')\n         expect(content).toEqual(prevContent)\n       } finally {"
        },
        {
            "sha": "5093301b946ee56018bc17fc61724e09b1b1dc3f",
            "filename": "test/integration/undefined-webpack-config/test/index.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fundefined-webpack-config%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fintegration%2Fundefined-webpack-config%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fundefined-webpack-config%2Ftest%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -1,7 +1,7 @@\n /* eslint-env jest */\n \n import { join } from 'path'\n-import { launchApp, findPort, nextBuild } from 'next-test-utils'\n+import { launchApp, findPort, nextBuild, retry } from 'next-test-utils'\n \n const appDir = join(__dirname, '../')\n const expectedErr =\n@@ -33,7 +33,9 @@ const expectedErr =\n         },\n       })\n \n-      expect(output).toMatch(expectedErr)\n+      await retry(async () => {\n+        expect(output).toMatch(expectedErr)\n+      })\n     })\n   }\n )"
        },
        {
            "sha": "7e0782ad6c8f45031471577c2b656e826a302892",
            "filename": "test/production/app-dir/build-output-prerender/build-output-prerender.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 8,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -26,7 +26,8 @@ describe('build-output-prerender', () => {\n             `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (webpack, Cache Components)\n+             \"▲ Next.js x.y.z (webpack)\n+             - Cache Components enabled\n              - Experiments (use with caution):\n                ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\"\n             `)\n@@ -48,7 +49,8 @@ describe('build-output-prerender', () => {\n         } else {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (Turbopack, Cache Components)\n+             \"▲ Next.js x.y.z (Turbopack)\n+             - Cache Components enabled\n              - Experiments (use with caution):\n                ✓ strictRouteTypes (enabled by \\`__NEXT_EXPERIMENTAL_STRICT_ROUTE_TYPES\\`)\"\n             `)\n@@ -58,7 +60,8 @@ describe('build-output-prerender', () => {\n             `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (webpack, Cache Components)\n+             \"▲ Next.js x.y.z (webpack)\n+             - Cache Components enabled\n              - Experiments (use with caution):\n                ✓ strictRouteTypes (enabled by \\`__NEXT_EXPERIMENTAL_STRICT_ROUTE_TYPES\\`)\"\n             `)\n@@ -122,7 +125,8 @@ describe('build-output-prerender', () => {\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-             ▲ Next.js x.y.z (webpack, Cache Components)\n+             ▲ Next.js x.y.z (webpack)\n+             - Cache Components enabled\n              - Experiments (use with caution):\n                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\n@@ -156,7 +160,8 @@ describe('build-output-prerender', () => {\n           if (isTurbopack) {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-             ▲ Next.js x.y.z (Turbopack, Cache Components)\n+             ▲ Next.js x.y.z (Turbopack)\n+             - Cache Components enabled\n              - Experiments (use with caution):\n                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n@@ -175,7 +180,8 @@ describe('build-output-prerender', () => {\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-             ▲ Next.js x.y.z (webpack, Cache Components)\n+             ▲ Next.js x.y.z (webpack)\n+             - Cache Components enabled\n              - Experiments (use with caution):\n                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n@@ -266,7 +272,8 @@ describe('build-output-prerender', () => {\n             `)\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-             \"▲ Next.js x.y.z (webpack, Cache Components)\n+             \"▲ Next.js x.y.z (webpack)\n+             - Cache Components enabled\n              - Experiments (use with caution):\n                ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)\"\n             `)\n@@ -331,7 +338,8 @@ describe('build-output-prerender', () => {\n           } else {\n             expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n              \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-             ▲ Next.js x.y.z (webpack, Cache Components)\n+             ▲ Next.js x.y.z (webpack)\n+             - Cache Components enabled\n              - Experiments (use with caution):\n                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n                ✓ reactDebugChannel (enabled by \\`__NEXT_EXPERIMENTAL_DEBUG_CHANNEL\\`)"
        },
        {
            "sha": "22abf1d1b3df11758b475537d68b8a17a9b00848",
            "filename": "test/production/graceful-shutdown/index.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fproduction%2Fgraceful-shutdown%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd2bd2952e7b8cac860cd4eea520611cd57c61fc/test%2Fproduction%2Fgraceful-shutdown%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fgraceful-shutdown%2Findex.test.ts?ref=fd2bd2952e7b8cac860cd4eea520611cd57c61fc",
            "patch": "@@ -100,7 +100,7 @@ describe('Graceful Shutdown', () => {\n       appPort = await findPort()\n       app = await initNextServerScript(\n         serverFile,\n-        /✓ Ready in \\d+m?s/,\n+        /✓ Ready in/,\n         {\n           ...process.env,\n           NEXT_EXIT_TIMEOUT_MS: '10',"
        }
    ],
    "stats": {
        "total": 634,
        "additions": 352,
        "deletions": 282
    }
}