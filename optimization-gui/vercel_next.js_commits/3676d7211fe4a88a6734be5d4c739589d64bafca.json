{
    "author": "sokra",
    "message": "Turbopack: add `experimental.turbopackClient/ServerSideNestedAsyncChunking` (#85827)\n\n### What?\n\nAllow to configure nested vs flat async chunking with a new config option.\n\n```\nexperimental: {\n  turbopackClientSideNestedAsyncChunking: false,\n  turbopackServerSideNestedAsyncChunking: true,\n}\n```",
    "sha": "3676d7211fe4a88a6734be5d4c739589d64bafca",
    "files": [
        {
            "sha": "92caa1d190df67769b4715b3bace70cccbdd75ad",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=3676d7211fe4a88a6734be5d4c739589d64bafca",
            "patch": "@@ -1119,6 +1119,9 @@ impl Project {\n             source_maps: self.next_config().client_source_maps(self.next_mode()),\n             no_mangling: self.no_mangling(),\n             scope_hoisting: self.next_config().turbo_scope_hoisting(self.next_mode()),\n+            nested_async_chunking: self\n+                .next_config()\n+                .turbo_nested_async_chunking(self.next_mode(), true),\n             debug_ids: self.next_config().turbopack_debug_ids(),\n             should_use_absolute_url_references: self.next_config().inline_css(),\n         }))\n@@ -1141,6 +1144,9 @@ impl Project {\n             turbo_source_maps: self.next_config().server_source_maps(),\n             no_mangling: self.no_mangling(),\n             scope_hoisting: self.next_config().turbo_scope_hoisting(self.next_mode()),\n+            nested_async_chunking: self\n+                .next_config()\n+                .turbo_nested_async_chunking(self.next_mode(), false),\n             debug_ids: self.next_config().turbopack_debug_ids(),\n             client_root: self.client_relative_path().owned().await?,\n             asset_prefix: self.next_config().computed_asset_prefix().owned().await?,\n@@ -1169,6 +1175,9 @@ impl Project {\n             turbo_source_maps: self.next_config().server_source_maps(),\n             no_mangling: self.no_mangling(),\n             scope_hoisting: self.next_config().turbo_scope_hoisting(self.next_mode()),\n+            nested_async_chunking: self\n+                .next_config()\n+                .turbo_nested_async_chunking(self.next_mode(), false),\n             client_root: self.client_relative_path().owned().await?,\n             asset_prefix: self.next_config().computed_asset_prefix().owned().await?,\n         };"
        },
        {
            "sha": "39c5f8bc09c58a25eea8881ba8b2d5c163d1c839",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=3676d7211fe4a88a6734be5d4c739589d64bafca",
            "patch": "@@ -426,6 +426,7 @@ pub struct ClientChunkingContextOptions {\n     pub source_maps: Vc<bool>,\n     pub no_mangling: Vc<bool>,\n     pub scope_hoisting: Vc<bool>,\n+    pub nested_async_chunking: Vc<bool>,\n     pub debug_ids: Vc<bool>,\n     pub should_use_absolute_url_references: Vc<bool>,\n }\n@@ -448,6 +449,7 @@ pub async fn get_client_chunking_context(\n         source_maps,\n         no_mangling,\n         scope_hoisting,\n+        nested_async_chunking,\n         debug_ids,\n         should_use_absolute_url_references,\n     } = options;\n@@ -484,7 +486,8 @@ pub async fn get_client_chunking_context(\n     .export_usage(*export_usage.await?)\n     .module_id_strategy(module_id_strategy.to_resolved().await?)\n     .debug_ids(*debug_ids.await?)\n-    .should_use_absolute_url_references(*should_use_absolute_url_references.await?);\n+    .should_use_absolute_url_references(*should_use_absolute_url_references.await?)\n+    .nested_async_availability(*nested_async_chunking.await?);\n \n     if next_mode.is_development() {\n         builder = builder\n@@ -510,7 +513,6 @@ pub async fn get_client_chunking_context(\n                 },\n             )\n             .use_content_hashing(ContentHashing::Direct { length: 16 })\n-            .nested_async_availability(true)\n             .module_merging(*scope_hoisting.await?);\n     }\n "
        },
        {
            "sha": "371bdc1ab2fae2eaf3fda48465e7e8879a232075",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=3676d7211fe4a88a6734be5d4c739589d64bafca",
            "patch": "@@ -886,6 +886,8 @@ pub struct ExperimentalConfig {\n     turbopack_source_maps: Option<bool>,\n     turbopack_tree_shaking: Option<bool>,\n     turbopack_scope_hoisting: Option<bool>,\n+    turbopack_client_side_nested_async_chunking: Option<bool>,\n+    turbopack_server_side_nested_async_chunking: Option<bool>,\n     turbopack_import_type_bytes: Option<bool>,\n     turbopack_use_system_tls_certs: Option<bool>,\n     /// Disable automatic configuration of the sass loader.\n@@ -1790,6 +1792,29 @@ impl NextConfig {\n         }))\n     }\n \n+    #[turbo_tasks::function]\n+    pub async fn turbo_nested_async_chunking(\n+        &self,\n+        mode: Vc<NextMode>,\n+        client_side: bool,\n+    ) -> Result<Vc<bool>> {\n+        let option = if client_side {\n+            self.experimental\n+                .turbopack_client_side_nested_async_chunking\n+        } else {\n+            self.experimental\n+                .turbopack_server_side_nested_async_chunking\n+        };\n+        Ok(Vc::cell(if let Some(value) = option {\n+            value\n+        } else {\n+            match *mode.await? {\n+                NextMode::Development => false,\n+                NextMode::Build => client_side,\n+            }\n+        }))\n+    }\n+\n     #[turbo_tasks::function]\n     pub async fn turbopack_import_type_bytes(&self) -> Vc<bool> {\n         Vc::cell("
        },
        {
            "sha": "c3e956782c984be54ae6e8ca0e12bbc781258560",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=3676d7211fe4a88a6734be5d4c739589d64bafca",
            "patch": "@@ -208,6 +208,7 @@ pub struct EdgeChunkingContextOptions {\n     pub turbo_source_maps: Vc<bool>,\n     pub no_mangling: Vc<bool>,\n     pub scope_hoisting: Vc<bool>,\n+    pub nested_async_chunking: Vc<bool>,\n     pub client_root: FileSystemPath,\n     pub asset_prefix: RcStr,\n }\n@@ -229,6 +230,7 @@ pub async fn get_edge_chunking_context_with_client_assets(\n         turbo_source_maps,\n         no_mangling,\n         scope_hoisting,\n+        nested_async_chunking,\n         client_root,\n         asset_prefix,\n     } = options;\n@@ -259,7 +261,8 @@ pub async fn get_edge_chunking_context_with_client_assets(\n         SourceMapsType::None\n     })\n     .module_id_strategy(module_id_strategy.to_resolved().await?)\n-    .export_usage(*export_usage.await?);\n+    .export_usage(*export_usage.await?)\n+    .nested_async_availability(*nested_async_chunking.await?);\n \n     if !next_mode.is_development() {\n         builder = builder\n@@ -300,6 +303,7 @@ pub async fn get_edge_chunking_context(\n         turbo_source_maps,\n         no_mangling,\n         scope_hoisting,\n+        nested_async_chunking,\n         client_root,\n         asset_prefix,\n     } = options;\n@@ -336,7 +340,8 @@ pub async fn get_edge_chunking_context(\n         SourceMapsType::None\n     })\n     .module_id_strategy(module_id_strategy.to_resolved().await?)\n-    .export_usage(*export_usage.await?);\n+    .export_usage(*export_usage.await?)\n+    .nested_async_availability(*nested_async_chunking.await?);\n \n     if !next_mode.is_development() {\n         builder = builder"
        },
        {
            "sha": "734e5bfebdfcbe1709c55eef03cc18de24818d70",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3676d7211fe4a88a6734be5d4c739589d64bafca/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=3676d7211fe4a88a6734be5d4c739589d64bafca",
            "patch": "@@ -1000,6 +1000,7 @@ pub struct ServerChunkingContextOptions {\n     pub turbo_source_maps: Vc<bool>,\n     pub no_mangling: Vc<bool>,\n     pub scope_hoisting: Vc<bool>,\n+    pub nested_async_chunking: Vc<bool>,\n     pub debug_ids: Vc<bool>,\n     pub client_root: FileSystemPath,\n     pub asset_prefix: RcStr,\n@@ -1022,6 +1023,7 @@ pub async fn get_server_chunking_context_with_client_assets(\n         turbo_source_maps,\n         no_mangling,\n         scope_hoisting,\n+        nested_async_chunking,\n         debug_ids,\n         client_root,\n         asset_prefix,\n@@ -1058,7 +1060,8 @@ pub async fn get_server_chunking_context_with_client_assets(\n     .module_id_strategy(module_id_strategy.to_resolved().await?)\n     .export_usage(*export_usage.await?)\n     .file_tracing(next_mode.is_production())\n-    .debug_ids(*debug_ids.await?);\n+    .debug_ids(*debug_ids.await?)\n+    .nested_async_availability(*nested_async_chunking.await?);\n \n     builder = builder.source_map_source_type(if next_mode.is_development() {\n         SourceMapSourceType::AbsoluteFileUri\n@@ -1106,6 +1109,7 @@ pub async fn get_server_chunking_context(\n         turbo_source_maps,\n         no_mangling,\n         scope_hoisting,\n+        nested_async_chunking,\n         debug_ids,\n         client_root,\n         asset_prefix,\n@@ -1142,7 +1146,8 @@ pub async fn get_server_chunking_context(\n     .module_id_strategy(module_id_strategy.to_resolved().await?)\n     .export_usage(*export_usage.await?)\n     .file_tracing(next_mode.is_production())\n-    .debug_ids(*debug_ids.await?);\n+    .debug_ids(*debug_ids.await?)\n+    .nested_async_availability(*nested_async_chunking.await?);\n \n     if next_mode.is_development() {\n         builder = builder.source_map_source_type(SourceMapSourceType::AbsoluteFileUri);"
        },
        {
            "sha": "071d641ba3759b704041c17d4d9e3fe9619efe93",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3676d7211fe4a88a6734be5d4c739589d64bafca/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3676d7211fe4a88a6734be5d4c739589d64bafca/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=3676d7211fe4a88a6734be5d4c739589d64bafca",
            "patch": "@@ -301,6 +301,8 @@ export const experimentalSchema = {\n   turbopackTreeShaking: z.boolean().optional(),\n   turbopackRemoveUnusedExports: z.boolean().optional(),\n   turbopackScopeHoisting: z.boolean().optional(),\n+  turbopackClientSideNestedAsyncChunking: z.boolean().optional(),\n+  turbopackServerSideNestedAsyncChunking: z.boolean().optional(),\n   turbopackImportTypeBytes: z.boolean().optional(),\n   turbopackUseSystemTlsCerts: z.boolean().optional(),\n   turbopackUseBuiltinBabel: z.boolean().optional(),"
        },
        {
            "sha": "1c0787efc54b50534932a76c6a86730dbf43b062",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/3676d7211fe4a88a6734be5d4c739589d64bafca/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3676d7211fe4a88a6734be5d4c739589d64bafca/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=3676d7211fe4a88a6734be5d4c739589d64bafca",
            "patch": "@@ -413,6 +413,18 @@ export interface ExperimentalConfig {\n    */\n   turbopackScopeHoisting?: boolean\n \n+  /**\n+   * Enable nested async chunking for client side assets. Defaults to true in build mode and false in dev mode.\n+   * This optimization computes all possible paths through dynamic imports in the applications to figure out the modules needed at dynamic imports for every path.\n+   */\n+  turbopackClientSideNestedAsyncChunking?: boolean\n+\n+  /**\n+   * Enable nested async chunking for server side assets. Defaults to false in dev and build mode.\n+   * This optimization computes all possible paths through dynamic imports in the applications to figure out the modules needed at dynamic imports for every path.\n+   */\n+  turbopackServerSideNestedAsyncChunking?: boolean\n+\n   /**\n    * Enable filesystem cache for the turbopack dev server.\n    */"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 66,
        "deletions": 6
    }
}