{
    "author": "mischnic",
    "message": "Turbopack: accept ChunkGroup in chunking context (#76242)\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that you follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the PR.\n- Read the Docs Contribution Guide to ensure your contribution follows the docs guidelines: https://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc https://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See https://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See: https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature request has been accepted for implementation before opening a PR. (A discussion must be opened, see https://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added (https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to understand the PR)\n- When linking to a Slack thread, you might want to share details of the conclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic behind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "801e06ff4591922e045e029a0f54095d99832cd0",
    "files": [
        {
            "sha": "6c48f161be8280255f2b1e957584224231189a8e",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 19,
            "deletions": 7,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -53,13 +53,15 @@ use turbopack::{\n use turbopack_core::{\n     asset::AssetContent,\n     chunk::{\n-        availability_info::AvailabilityInfo, ChunkGroupType, ChunkableModules, ChunkingContext,\n-        ChunkingContextExt, EvaluatableAsset, EvaluatableAssets,\n+        availability_info::AvailabilityInfo, ChunkGroupType, ChunkingContext, ChunkingContextExt,\n+        EvaluatableAsset, EvaluatableAssets,\n     },\n     file_source::FileSource,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::{GraphEntries, ModuleGraph, SingleModuleGraph, VisitedModules},\n+    module_graph::{\n+        chunk_group_info::ChunkGroup, GraphEntries, ModuleGraph, SingleModuleGraph, VisitedModules,\n+    },\n     output::{OutputAsset, OutputAssets},\n     raw_output::RawOutput,\n     reference_type::{CssReferenceSubType, ReferenceType},\n@@ -1668,14 +1670,18 @@ impl AppEndpoint {\n                         let server_utils = client_references\n                             .server_utils\n                             .iter()\n-                            .map(async |m| Ok(Vc::upcast(*m.await?.module)))\n+                            .map(async |m| Ok(ResolvedVc::upcast(m.await?.module)))\n                             .try_join()\n                             .await?;\n                         let chunk_group = chunking_context\n-                            .chunk_group_multiple(\n+                            .chunk_group(\n                                 AssetIdent::from_path(this.app_project.project().project_path())\n                                     .with_modifier(server_utils_modifier()),\n-                                ChunkableModules::interned(server_utils),\n+                                // TODO this should be ChunkGroup::Shared\n+                                ChunkGroup::Entry {\n+                                    entries: server_utils,\n+                                    ty: ChunkGroupType::Entry,\n+                                },\n                                 module_graph,\n                                 Value::new(current_availability_info),\n                             )\n@@ -1710,7 +1716,13 @@ impl AppEndpoint {\n                             let chunk_group = chunking_context\n                                 .chunk_group(\n                                     server_component.ident(),\n-                                    Vc::upcast(*server_component.await?.module),\n+                                    // TODO this should be ChunkGroup::Shared\n+                                    ChunkGroup::Entry {\n+                                        entries: vec![ResolvedVc::upcast(\n+                                            server_component.await?.module,\n+                                        )],\n+                                        ty: ChunkGroupType::Entry,\n+                                    },\n                                     module_graph,\n                                     Value::new(current_availability_info),\n                                 )"
        },
        {
            "sha": "98cac23cd50f662cab79e9698012875240848bc9",
            "filename": "crates/next-core/src/next_app/app_client_references_chunks.rs",
            "status": "modified",
            "additions": 116,
            "deletions": 97,
            "changes": 213,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_references_chunks.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_references_chunks.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_references_chunks.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -5,17 +5,19 @@ use turbo_tasks::{\n     FxIndexMap, ResolvedVc, TryFlatJoinIterExt, TryJoinIterExt, Value, ValueToString, Vc,\n };\n use turbopack_core::{\n-    chunk::{\n-        availability_info::AvailabilityInfo, ChunkableModules, ChunkingContext, ChunkingContextExt,\n-    },\n+    chunk::{availability_info::AvailabilityInfo, ChunkingContext},\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::OutputAssets,\n };\n \n use crate::{\n     next_client_reference::{\n-        visit_client_reference::ClientReferenceGraphResult, ClientReferenceType,\n+        ecmascript_client_reference::ecmascript_client_reference_module::{\n+            ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_CLIENT, ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_SSR,\n+        },\n+        visit_client_reference::ClientReferenceGraphResult,\n+        ClientReferenceType,\n     },\n     next_server_component::server_component_module::NextServerComponentModule,\n };\n@@ -57,91 +59,92 @@ pub async fn get_app_client_references_chunks(\n         let separate_chunk_group_per_client_reference = false;\n         let app_client_references = app_client_references.await?;\n         if separate_chunk_group_per_client_reference {\n-            let app_client_references_chunks: Vec<(_, (_, Option<_>))> = app_client_references\n-                .client_references\n-                .iter()\n-                .map(|client_reference| async move {\n-                    let client_reference_ty = client_reference.ty();\n-                    Ok((\n-                        client_reference_ty,\n-                        match client_reference_ty {\n-                            ClientReferenceType::EcmascriptClientReference(\n-                                ecmascript_client_reference,\n-                            ) => {\n-                                let ecmascript_client_reference_ref =\n-                                    ecmascript_client_reference.await?;\n+            todo!();\n+            // let app_client_references_chunks: Vec<(_, (_, Option<_>))> = app_client_references\n+            //     .client_references\n+            //     .iter()\n+            //     .map(|client_reference| async move {\n+            //         let client_reference_ty = client_reference.ty();\n+            //         Ok((\n+            //             client_reference_ty,\n+            //             match client_reference_ty {\n+            //                 ClientReferenceType::EcmascriptClientReference(\n+            //                     ecmascript_client_reference,\n+            //                 ) => {\n+            //                     let ecmascript_client_reference_ref =\n+            //                         ecmascript_client_reference.await?;\n \n-                                let client_chunk_group = client_chunking_context\n-                                    .root_chunk_group(\n-                                        *ResolvedVc::upcast(\n-                                            ecmascript_client_reference_ref.client_module,\n-                                        ),\n-                                        module_graph,\n-                                    )\n-                                    .await?;\n-\n-                                (\n-                                    (\n-                                        client_chunk_group.assets,\n-                                        client_chunk_group.availability_info,\n-                                    ),\n-                                    if let Some(ssr_chunking_context) = ssr_chunking_context {\n-                                        let ssr_chunk_group = ssr_chunking_context\n-                                            .root_chunk_group(\n-                                                *ResolvedVc::upcast(\n-                                                    ecmascript_client_reference_ref.ssr_module,\n-                                                ),\n-                                                module_graph,\n-                                            )\n-                                            .await?;\n-\n-                                        Some((\n-                                            ssr_chunk_group.assets,\n-                                            ssr_chunk_group.availability_info,\n-                                        ))\n-                                    } else {\n-                                        None\n-                                    },\n-                                )\n-                            }\n-                            ClientReferenceType::CssClientReference(css_client_reference) => {\n-                                let client_chunk_group = client_chunking_context\n-                                    .root_chunk_group(\n-                                        *ResolvedVc::upcast(css_client_reference),\n-                                        module_graph,\n-                                    )\n-                                    .await?;\n-\n-                                (\n-                                    (\n-                                        client_chunk_group.assets,\n-                                        client_chunk_group.availability_info,\n-                                    ),\n-                                    None,\n-                                )\n-                            }\n-                        },\n-                    ))\n-                })\n-                .try_join()\n-                .await?;\n+            //                     let client_chunk_group = client_chunking_context\n+            //                         .root_chunk_group(\n+            //                             module_graph,\n+            //                             *ResolvedVc::upcast(\n+            //                                 ecmascript_client_reference_ref.client_module,\n+            //                             ),\n+            //                         )\n+            //                         .await?;\n \n-            Ok(ClientReferencesChunks {\n-                client_component_client_chunks: app_client_references_chunks\n-                    .iter()\n-                    .map(|&(client_reference_ty, (client_chunks, _))| {\n-                        (client_reference_ty, client_chunks)\n-                    })\n-                    .collect(),\n-                client_component_ssr_chunks: app_client_references_chunks\n-                    .iter()\n-                    .flat_map(|&(client_reference_ty, (_, ssr_chunks))| {\n-                        ssr_chunks.map(|ssr_chunks| (client_reference_ty, ssr_chunks))\n-                    })\n-                    .collect(),\n-                layout_segment_client_chunks: FxIndexMap::default(),\n-            }\n-            .cell())\n+            //                     (\n+            //                         (\n+            //                             client_chunk_group.assets,\n+            //                             client_chunk_group.availability_info,\n+            //                         ),\n+            //                         if let Some(ssr_chunking_context) = ssr_chunking_context {\n+            //                             let ssr_chunk_group = ssr_chunking_context\n+            //                                 .root_chunk_group(\n+            //                                     *ResolvedVc::upcast(\n+            //                                         ecmascript_client_reference_ref.ssr_module,\n+            //                                     ),\n+            //                                     module_graph,\n+            //                                 )\n+            //                                 .await?;\n+\n+            //                             Some((\n+            //                                 ssr_chunk_group.assets,\n+            //                                 ssr_chunk_group.availability_info,\n+            //                             ))\n+            //                         } else {\n+            //                             None\n+            //                         },\n+            //                     )\n+            //                 }\n+            //                 ClientReferenceType::CssClientReference(css_client_reference) => {\n+            //                     let client_chunk_group = client_chunking_context\n+            //                         .root_chunk_group(\n+            //                             *ResolvedVc::upcast(css_client_reference),\n+            //                             module_graph,\n+            //                         )\n+            //                         .await?;\n+\n+            //                     (\n+            //                         (\n+            //                             client_chunk_group.assets,\n+            //                             client_chunk_group.availability_info,\n+            //                         ),\n+            //                         None,\n+            //                     )\n+            //                 }\n+            //             },\n+            //         ))\n+            //     })\n+            //     .try_join()\n+            //     .await?;\n+\n+            // Ok(ClientReferencesChunks {\n+            //     client_component_client_chunks: app_client_references_chunks\n+            //         .iter()\n+            //         .map(|&(client_reference_ty, (client_chunks, _))| {\n+            //             (client_reference_ty, client_chunks)\n+            //         })\n+            //         .collect(),\n+            //     client_component_ssr_chunks: app_client_references_chunks\n+            //         .iter()\n+            //         .flat_map(|&(client_reference_ty, (_, ssr_chunks))| {\n+            //             ssr_chunks.map(|ssr_chunks| (client_reference_ty, ssr_chunks))\n+            //         })\n+            //         .collect(),\n+            //     layout_segment_client_chunks: FxIndexMap::default(),\n+            // }\n+            // .cell())\n         } else {\n             let mut client_references_by_server_component: FxIndexMap<_, Vec<_>> =\n                 FxIndexMap::default();\n@@ -166,6 +169,8 @@ pub async fn get_app_client_references_chunks(\n                 list.extend(framework_reference_types);\n             }\n \n+            let chunk_group_info = module_graph.chunk_group_info();\n+\n             let mut current_client_availability_info = client_availability_info.into_value();\n             let mut current_client_chunks = OutputAssets::empty().to_resolved().await?;\n             let mut current_ssr_availability_info = AvailabilityInfo::Root;\n@@ -178,6 +183,12 @@ pub async fn get_app_client_references_chunks(\n             for (server_component, client_reference_types) in\n                 client_references_by_server_component.into_iter()\n             {\n+                let parent_chunk_group = *chunk_group_info\n+                    .get_index_of(ChunkGroup::Shared(ResolvedVc::upcast(\n+                        server_component.await?.module,\n+                    )))\n+                    .await?;\n+\n                 let base_ident = server_component.ident();\n \n                 let server_path = server_component.server_path();\n@@ -194,7 +205,7 @@ pub async fn get_app_client_references_chunks(\n                                 let ecmascript_client_reference_ref =\n                                     ecmascript_client_reference.await?;\n \n-                                Some(*ResolvedVc::upcast(\n+                                Some(ResolvedVc::upcast(\n                                     ecmascript_client_reference_ref.ssr_module,\n                                 ))\n                             }\n@@ -212,9 +223,13 @@ pub async fn get_app_client_references_chunks(\n                         )\n                         .entered();\n \n-                        ssr_chunking_context.chunk_group_multiple(\n+                        ssr_chunking_context.chunk_group(\n                             base_ident.with_modifier(ssr_modules_modifier()),\n-                            ChunkableModules::interned(ssr_modules),\n+                            ChunkGroup::IsolatedMerged {\n+                                parent: parent_chunk_group,\n+                                merge_tag: ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_SSR.clone(),\n+                                entries: ssr_modules,\n+                            },\n                             module_graph,\n                             Value::new(current_ssr_availability_info),\n                         )\n@@ -229,11 +244,11 @@ pub async fn get_app_client_references_chunks(\n                         Ok(match client_reference_ty {\n                             ClientReferenceType::EcmascriptClientReference(\n                                 ecmascript_client_reference,\n-                            ) => *ResolvedVc::upcast(\n-                                ecmascript_client_reference.await?.client_module,\n-                            ),\n+                            ) => {\n+                                ResolvedVc::upcast(ecmascript_client_reference.await?.client_module)\n+                            }\n                             ClientReferenceType::CssClientReference(css_client_reference) => {\n-                                *ResolvedVc::upcast(*css_client_reference)\n+                                ResolvedVc::upcast(*css_client_reference)\n                             }\n                         })\n                     })\n@@ -246,9 +261,13 @@ pub async fn get_app_client_references_chunks(\n                     )\n                     .entered();\n \n-                    Some(client_chunking_context.chunk_group_multiple(\n+                    Some(client_chunking_context.chunk_group(\n                         base_ident.with_modifier(client_modules_modifier()),\n-                        ChunkableModules::interned(client_modules),\n+                        ChunkGroup::IsolatedMerged {\n+                            parent: parent_chunk_group,\n+                            merge_tag: ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_CLIENT.clone(),\n+                            entries: client_modules,\n+                        },\n                         module_graph,\n                         Value::new(current_client_availability_info),\n                     ))"
        },
        {
            "sha": "52f162adbd815c73d03daabd9457df5d824ceac6",
            "filename": "crates/next-core/src/next_client_reference/ecmascript_client_reference/ecmascript_client_reference_module.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -2,6 +2,7 @@ use std::{io::Write, iter::once};\n \n use anyhow::{bail, Context, Result};\n use indoc::writedoc;\n+use once_cell::sync::Lazy;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Value, ValueToString, Vc};\n use turbo_tasks_fs::File;\n@@ -191,6 +192,10 @@ fn ecmascript_client_reference_ssr_ref_modifier() -> Vc<RcStr> {\n     Vc::cell(\"ecmascript client reference to ssr\".into())\n }\n \n+pub static ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_CLIENT: Lazy<RcStr> =\n+    Lazy::new(|| \"client\".into());\n+pub static ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_SSR: Lazy<RcStr> = Lazy::new(|| \"ssr\".into());\n+\n #[turbo_tasks::value_impl]\n impl Module for EcmascriptClientReferenceModule {\n     #[turbo_tasks::function]\n@@ -216,7 +221,7 @@ impl Module for EcmascriptClientReferenceModule {\n                 EcmascriptClientReference::new(\n                     *ResolvedVc::upcast(*client_module),\n                     ChunkGroupType::Evaluated,\n-                    Some(\"client\".into()),\n+                    Some(ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_CLIENT.clone()),\n                     ecmascript_client_reference_client_ref_modifier(),\n                 )\n                 .to_resolved()\n@@ -226,7 +231,7 @@ impl Module for EcmascriptClientReferenceModule {\n                 EcmascriptClientReference::new(\n                     *ResolvedVc::upcast(*ssr_module),\n                     ChunkGroupType::Entry,\n-                    Some(\"ssr\".into()),\n+                    Some(ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_SSR.clone()),\n                     ecmascript_client_reference_ssr_ref_modifier(),\n                 )\n                 .to_resolved()"
        },
        {
            "sha": "e337f5dca0ed802d4995e59ab90ad040b6e9d18e",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 24,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -9,14 +9,14 @@ use turbopack_core::{\n         availability_info::AvailabilityInfo,\n         chunk_group::{make_chunk_group, MakeChunkGroupResult},\n         module_id_strategies::{DevModuleIdStrategy, ModuleIdStrategy},\n-        Chunk, ChunkGroupResult, ChunkItem, ChunkableModule, ChunkableModules, ChunkingConfig,\n-        ChunkingConfigs, ChunkingContext, EntryChunkGroupResult, EvaluatableAssets, MinifyType,\n-        ModuleId, SourceMapsType,\n+        Chunk, ChunkGroupResult, ChunkItem, ChunkableModule, ChunkingConfig, ChunkingConfigs,\n+        ChunkingContext, EntryChunkGroupResult, EvaluatableAssets, MinifyType, ModuleId,\n+        SourceMapsType,\n     },\n     environment::Environment,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::{OutputAsset, OutputAssets},\n };\n use turbopack_ecmascript::{\n@@ -415,39 +415,23 @@ impl ChunkingContext for BrowserChunkingContext {\n     }\n \n     #[turbo_tasks::function]\n-    fn chunk_group(\n-        self: Vc<Self>,\n-        ident: Vc<AssetIdent>,\n-        module: ResolvedVc<Box<dyn ChunkableModule>>,\n-        module_graph: Vc<ModuleGraph>,\n-        availability_info: Value<AvailabilityInfo>,\n-    ) -> Vc<ChunkGroupResult> {\n-        self.chunk_group_multiple(\n-            ident,\n-            Vc::cell(vec![module]),\n-            module_graph,\n-            availability_info,\n-        )\n-    }\n-\n-    #[turbo_tasks::function]\n-    async fn chunk_group_multiple(\n+    async fn chunk_group(\n         self: ResolvedVc<Self>,\n         ident: Vc<AssetIdent>,\n-        modules: Vc<ChunkableModules>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Result<Vc<ChunkGroupResult>> {\n         let span = tracing::info_span!(\"chunking\", ident = ident.to_string().await?.to_string());\n         async move {\n             let this = self.await?;\n-            let modules = modules.await?;\n+            let modules = chunk_group.entries();\n             let input_availability_info = availability_info.into_value();\n             let MakeChunkGroupResult {\n                 chunks,\n                 availability_info,\n             } = make_chunk_group(\n-                modules.iter().copied().map(ResolvedVc::upcast),\n+                modules,\n                 module_graph,\n                 ResolvedVc::upcast(self),\n                 input_availability_info,"
        },
        {
            "sha": "b1c892c525c8d45b9f44b7477b3dd4411f341af5",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking_context.rs",
            "status": "modified",
            "additions": 31,
            "deletions": 25,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -8,11 +8,11 @@ use turbo_tasks_hash::DeterministicHash;\n \n use super::{availability_info::AvailabilityInfo, ChunkableModule, EvaluatableAssets};\n use crate::{\n-    chunk::{ChunkItem, ChunkType, ChunkableModules, ModuleId},\n+    chunk::{ChunkItem, ChunkType, ModuleId},\n     environment::Environment,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::{OutputAsset, OutputAssets},\n };\n \n@@ -184,15 +184,7 @@ pub trait ChunkingContext {\n     fn chunk_group(\n         self: Vc<Self>,\n         ident: Vc<AssetIdent>,\n-        module: Vc<Box<dyn ChunkableModule>>,\n-        module_graph: Vc<ModuleGraph>,\n-        availability_info: Value<AvailabilityInfo>,\n-    ) -> Vc<ChunkGroupResult>;\n-\n-    fn chunk_group_multiple(\n-        self: Vc<Self>,\n-        ident: Vc<AssetIdent>,\n-        modules: Vc<ChunkableModules>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Vc<ChunkGroupResult>;\n@@ -235,15 +227,17 @@ pub trait ChunkingContext {\n pub trait ChunkingContextExt {\n     fn root_chunk_group(\n         self: Vc<Self>,\n-        module: Vc<Box<dyn ChunkableModule>>,\n+        ident: Vc<AssetIdent>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n     ) -> Vc<ChunkGroupResult>\n     where\n         Self: Send;\n \n     fn root_chunk_group_assets(\n         self: Vc<Self>,\n-        module: Vc<Box<dyn ChunkableModule>>,\n+        ident: Vc<AssetIdent>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n     ) -> Vc<OutputAssets>\n     where\n@@ -295,7 +289,8 @@ pub trait ChunkingContextExt {\n \n     fn chunk_group_assets(\n         self: Vc<Self>,\n-        module: Vc<Box<dyn ChunkableModule>>,\n+        ident: Vc<AssetIdent>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Vc<OutputAssets>\n@@ -306,23 +301,25 @@ pub trait ChunkingContextExt {\n impl<T: ChunkingContext + Send + Upcast<Box<dyn ChunkingContext>>> ChunkingContextExt for T {\n     fn root_chunk_group(\n         self: Vc<Self>,\n-        module: Vc<Box<dyn ChunkableModule>>,\n+        ident: Vc<AssetIdent>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n     ) -> Vc<ChunkGroupResult> {\n         self.chunk_group(\n-            module.ident(),\n-            module,\n+            ident,\n+            chunk_group,\n             module_graph,\n             Value::new(AvailabilityInfo::Root),\n         )\n     }\n \n     fn root_chunk_group_assets(\n         self: Vc<Self>,\n-        module: Vc<Box<dyn ChunkableModule>>,\n+        ident: Vc<AssetIdent>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n     ) -> Vc<OutputAssets> {\n-        root_chunk_group_assets(Vc::upcast(self), module, module_graph)\n+        root_chunk_group_assets(Vc::upcast(self), ident, chunk_group, module_graph)\n     }\n \n     fn evaluated_chunk_group_assets(\n@@ -400,22 +397,30 @@ impl<T: ChunkingContext + Send + Upcast<Box<dyn ChunkingContext>>> ChunkingConte\n \n     fn chunk_group_assets(\n         self: Vc<Self>,\n-        module: Vc<Box<dyn ChunkableModule>>,\n+        ident: Vc<AssetIdent>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Vc<OutputAssets> {\n-        chunk_group_assets(Vc::upcast(self), module, module_graph, availability_info)\n+        chunk_group_assets(\n+            Vc::upcast(self),\n+            ident,\n+            chunk_group,\n+            module_graph,\n+            availability_info,\n+        )\n     }\n }\n \n #[turbo_tasks::function]\n async fn root_chunk_group_assets(\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n-    module: Vc<Box<dyn ChunkableModule>>,\n+    ident: Vc<AssetIdent>,\n+    chunk_group: ChunkGroup,\n     module_graph: Vc<ModuleGraph>,\n ) -> Result<Vc<OutputAssets>> {\n     Ok(*chunking_context\n-        .root_chunk_group(module, module_graph)\n+        .root_chunk_group(ident, chunk_group, module_graph)\n         .await?\n         .assets)\n }\n@@ -460,12 +465,13 @@ async fn entry_chunk_group_asset(\n #[turbo_tasks::function]\n async fn chunk_group_assets(\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n-    module: Vc<Box<dyn ChunkableModule>>,\n+    ident: Vc<AssetIdent>,\n+    chunk_group: ChunkGroup,\n     module_graph: Vc<ModuleGraph>,\n     availability_info: Value<AvailabilityInfo>,\n ) -> Result<Vc<OutputAssets>> {\n     Ok(*chunking_context\n-        .chunk_group(module.ident(), module, module_graph, availability_info)\n+        .chunk_group(ident, chunk_group, module_graph, availability_info)\n         .await?\n         .assets)\n }"
        },
        {
            "sha": "dd349ab24546e251b0b81a5ea778efc8982a7ce3",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/chunk_group_info.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -4,7 +4,7 @@ use std::{\n     ops::{Deref, DerefMut},\n };\n \n-use anyhow::Result;\n+use anyhow::{bail, Result};\n use either::Either;\n use indexmap::map::Entry;\n use petgraph::graph::{DiGraph, EdgeIndex, NodeIndex};\n@@ -88,11 +88,22 @@ impl Hash for RoaringBitmapWrapper {\n pub struct ChunkGroupInfo {\n     pub module_chunk_groups: FxHashMap<ResolvedVc<Box<dyn Module>>, RoaringBitmapWrapper>,\n     #[turbo_tasks(trace_ignore)]\n-    pub chunk_groups: Vec<ChunkGroup>,\n+    pub chunk_groups: FxIndexSet<ChunkGroup>,\n }\n \n-#[turbo_tasks::value(shared)]\n-#[derive(Debug, Clone, Hash)]\n+#[turbo_tasks::value_impl]\n+impl ChunkGroupInfo {\n+    #[turbo_tasks::function]\n+    pub fn get_index_of(&self, chunk_group: ChunkGroup) -> Result<Vc<usize>> {\n+        if let Some(idx) = self.chunk_groups.get_index_of(&chunk_group) {\n+            Ok(Vc::cell(idx))\n+        } else {\n+            bail!(\"Couldn't find chunk group index\");\n+        }\n+    }\n+}\n+\n+#[derive(Debug, Clone, Hash, TaskInput, PartialEq, Eq, Serialize, Deserialize)]\n pub enum ChunkGroup {\n     /// e.g. a page\n     Entry {"
        },
        {
            "sha": "f50c9e78b62f643eb5373dc969153049d13e98a0",
            "filename": "turbopack/crates/turbopack-dev-server/src/html.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fhtml.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fhtml.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fhtml.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -10,11 +10,11 @@ use turbo_tasks_hash::{encode_hex, Xxh3Hash64Hasher};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{\n-        availability_info::AvailabilityInfo, ChunkableModule, ChunkingContext, ChunkingContextExt,\n-        EvaluatableAssets,\n+        availability_info::AvailabilityInfo, ChunkGroupType, ChunkableModule, ChunkingContext,\n+        ChunkingContextExt, EvaluatableAssets,\n     },\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::{OutputAsset, OutputAssets},\n     version::{Version, VersionedContent},\n };\n@@ -162,7 +162,11 @@ impl DevHtmlAsset {\n                     )\n                 } else {\n                     chunking_context.root_chunk_group_assets(\n-                        *ResolvedVc::upcast(chunkable_module),\n+                        chunkable_module.ident(),\n+                        ChunkGroup::Entry {\n+                            entries: vec![ResolvedVc::upcast(chunkable_module)],\n+                            ty: ChunkGroupType::Evaluated,\n+                        },\n                         *module_graph,\n                     )\n                 };"
        },
        {
            "sha": "edc0856410a75c89036885cb676ed2086a4c7c6d",
            "filename": "turbopack/crates/turbopack-ecmascript/src/async_chunk/chunk_item.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fasync_chunk%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fasync_chunk%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fasync_chunk%2Fchunk_item.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -9,7 +9,7 @@ use turbopack_core::{\n     },\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::OutputAssets,\n };\n \n@@ -41,7 +41,8 @@ impl AsyncLoaderChunkItem {\n             }\n         }\n         Ok(self.chunking_context.chunk_group_assets(\n-            *ResolvedVc::upcast(module.inner),\n+            module.inner.ident(),\n+            ChunkGroup::Async(ResolvedVc::upcast(module.inner)),\n             *self.module_graph,\n             Value::new(module.availability_info),\n         ))"
        },
        {
            "sha": "a00400a8aeda2aacb14147ac88aad5e078646ba1",
            "filename": "turbopack/crates/turbopack-ecmascript/src/chunk_group_files_asset.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 261,
            "changes": 261,
            "blob_url": "https://github.com/vercel/next.js/blob/8624a4c1687e9b7bf71c48f0ecab9ff6e468d157/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk_group_files_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8624a4c1687e9b7bf71c48f0ecab9ff6e468d157/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk_group_files_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk_group_files_asset.rs?ref=8624a4c1687e9b7bf71c48f0ecab9ff6e468d157",
            "patch": "@@ -1,261 +0,0 @@\n-use anyhow::Result;\n-use turbo_rcstr::RcStr;\n-use turbo_tasks::{FxIndexSet, ResolvedVc, TryJoinIterExt, Value, ValueToString, Vc};\n-use turbo_tasks_fs::{File, FileSystemPath};\n-use turbopack_core::{\n-    asset::{Asset, AssetContent},\n-    chunk::{\n-        availability_info::AvailabilityInfo, ChunkItem, ChunkType, ChunkableModule,\n-        ChunkingContext, ChunkingContextExt, EvaluatableAsset, EvaluatableAssets,\n-    },\n-    ident::AssetIdent,\n-    introspect::{\n-        module::IntrospectableModule, utils::content_to_details, Introspectable,\n-        IntrospectableChildren,\n-    },\n-    module::Module,\n-    module_graph::ModuleGraph,\n-    output::{OutputAsset, OutputAssets},\n-    reference::{ModuleReference, ModuleReferences, SingleModuleReference},\n-};\n-\n-use crate::{\n-    chunk::{\n-        EcmascriptChunkItem, EcmascriptChunkItemContent, EcmascriptChunkPlaceable,\n-        EcmascriptChunkType, EcmascriptExports,\n-    },\n-    runtime_functions::TURBOPACK_EXPORT_VALUE,\n-    utils::StringifyJs,\n-};\n-\n-#[turbo_tasks::function]\n-fn modifier() -> Vc<RcStr> {\n-    Vc::cell(\"chunk group files\".into())\n-}\n-\n-/// An asset that exports a list of chunk URLs by putting the [asset] into a\n-/// ChunkGroup with the provided ChunkingContext.\n-#[turbo_tasks::value(shared)]\n-pub struct ChunkGroupFilesAsset {\n-    pub module: ResolvedVc<Box<dyn ChunkableModule>>,\n-    pub client_root: ResolvedVc<FileSystemPath>,\n-    pub chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n-    pub runtime_entries: Option<ResolvedVc<EvaluatableAssets>>,\n-}\n-\n-#[turbo_tasks::function]\n-fn module_description() -> Vc<RcStr> {\n-    Vc::cell(\"module\".into())\n-}\n-\n-#[turbo_tasks::function]\n-fn runtime_entry_description() -> Vc<RcStr> {\n-    Vc::cell(\"runtime entry\".into())\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Module for ChunkGroupFilesAsset {\n-    #[turbo_tasks::function]\n-    fn ident(&self) -> Vc<AssetIdent> {\n-        self.module.ident().with_modifier(modifier())\n-    }\n-\n-    #[turbo_tasks::function]\n-    async fn references(&self) -> Result<Vc<ModuleReferences>> {\n-        let mut references: Vec<ResolvedVc<Box<dyn ModuleReference>>> = vec![ResolvedVc::upcast(\n-            SingleModuleReference::new(*ResolvedVc::upcast(self.module), module_description())\n-                .to_resolved()\n-                .await?,\n-        )];\n-\n-        if let Some(runtime_entries) = self.runtime_entries {\n-            references.extend(\n-                runtime_entries\n-                    .await?\n-                    .iter()\n-                    .map(|&entry| async move {\n-                        Ok(ResolvedVc::upcast(\n-                            SingleModuleReference::new(\n-                                Vc::upcast(*entry),\n-                                runtime_entry_description(),\n-                            )\n-                            .to_resolved()\n-                            .await?,\n-                        ))\n-                    })\n-                    .try_join()\n-                    .await?,\n-            );\n-        }\n-\n-        Ok(Vc::cell(references))\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Asset for ChunkGroupFilesAsset {\n-    #[turbo_tasks::function]\n-    fn content(&self) -> Vc<AssetContent> {\n-        AssetContent::file(File::from(RcStr::from(\"// Chunking only content\")).into())\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl ChunkableModule for ChunkGroupFilesAsset {\n-    #[turbo_tasks::function]\n-    async fn as_chunk_item(\n-        self: ResolvedVc<Self>,\n-        module_graph: ResolvedVc<ModuleGraph>,\n-        chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n-    ) -> Result<Vc<Box<dyn turbopack_core::chunk::ChunkItem>>> {\n-        let this = self.await?;\n-        Ok(Vc::upcast(\n-            ChunkGroupFilesChunkItem {\n-                module_graph,\n-                chunking_context,\n-                client_root: this.client_root,\n-                inner: self,\n-            }\n-            .cell(),\n-        ))\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl EcmascriptChunkPlaceable for ChunkGroupFilesAsset {\n-    #[turbo_tasks::function]\n-    fn get_exports(&self) -> Vc<EcmascriptExports> {\n-        EcmascriptExports::Value.cell()\n-    }\n-}\n-\n-#[turbo_tasks::value]\n-struct ChunkGroupFilesChunkItem {\n-    chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n-    module_graph: ResolvedVc<ModuleGraph>,\n-    client_root: ResolvedVc<FileSystemPath>,\n-    inner: ResolvedVc<ChunkGroupFilesAsset>,\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl ChunkGroupFilesChunkItem {\n-    #[turbo_tasks::function]\n-    async fn chunks(&self) -> Result<Vc<OutputAssets>> {\n-        let inner = self.inner.await?;\n-        let chunks = if let Some(ecma) =\n-            ResolvedVc::try_sidecast::<Box<dyn EvaluatableAsset>>(inner.module)\n-        {\n-            inner.chunking_context.evaluated_chunk_group_assets(\n-                inner.module.ident(),\n-                inner\n-                    .runtime_entries\n-                    .as_deref()\n-                    .copied()\n-                    .unwrap_or_else(EvaluatableAssets::empty)\n-                    .with_entry(*ecma),\n-                *self.module_graph,\n-                Value::new(AvailabilityInfo::Root),\n-            )\n-        } else {\n-            inner\n-                .chunking_context\n-                .root_chunk_group_assets(*ResolvedVc::upcast(inner.module), *self.module_graph)\n-        };\n-        Ok(chunks)\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl EcmascriptChunkItem for ChunkGroupFilesChunkItem {\n-    #[turbo_tasks::function]\n-    async fn content(self: Vc<Self>) -> Result<Vc<EcmascriptChunkItemContent>> {\n-        let chunks = self.chunks();\n-        let this = self.await?;\n-        let module = this.inner.await?;\n-        let client_root = module.client_root.await?;\n-        let chunks_paths = chunks\n-            .await?\n-            .iter()\n-            .map(|chunk| chunk.path())\n-            .try_join()\n-            .await?;\n-        let chunks_paths: Vec<_> = chunks_paths\n-            .iter()\n-            .filter_map(|path| client_root.get_path_to(path))\n-            .collect();\n-        Ok(EcmascriptChunkItemContent {\n-            inner_code: format!(\n-                \"{TURBOPACK_EXPORT_VALUE}({:#});\\n\",\n-                StringifyJs(&chunks_paths)\n-            )\n-            .into(),\n-            ..Default::default()\n-        }\n-        .cell())\n-    }\n-}\n-\n-#[turbo_tasks::function]\n-fn chunk_group_chunk_reference_description() -> Vc<RcStr> {\n-    Vc::cell(\"chunk group chunk\".into())\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl ChunkItem for ChunkGroupFilesChunkItem {\n-    #[turbo_tasks::function]\n-    fn asset_ident(&self) -> Vc<AssetIdent> {\n-        self.inner.ident()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn references(self: Vc<Self>) -> Vc<OutputAssets> {\n-        self.chunks()\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn chunking_context(&self) -> Vc<Box<dyn ChunkingContext>> {\n-        *ResolvedVc::upcast(self.chunking_context)\n-    }\n-\n-    #[turbo_tasks::function]\n-    async fn ty(&self) -> Result<Vc<Box<dyn ChunkType>>> {\n-        Ok(Vc::upcast(\n-            Vc::<EcmascriptChunkType>::default().resolve().await?,\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn module(&self) -> Vc<Box<dyn Module>> {\n-        *ResolvedVc::upcast(self.inner)\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Introspectable for ChunkGroupFilesAsset {\n-    #[turbo_tasks::function]\n-    fn ty(&self) -> Vc<RcStr> {\n-        Vc::cell(\"chunk group files asset\".into())\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn details(self: Vc<Self>) -> Vc<RcStr> {\n-        content_to_details(self.content())\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn title(self: Vc<Self>) -> Vc<RcStr> {\n-        self.ident().to_string()\n-    }\n-\n-    #[turbo_tasks::function]\n-    async fn children(&self) -> Result<Vc<IntrospectableChildren>> {\n-        let mut children = FxIndexSet::default();\n-        children.insert((\n-            ResolvedVc::cell(\"inner asset\".into()),\n-            IntrospectableModule::new(*ResolvedVc::upcast(self.module))\n-                .to_resolved()\n-                .await?,\n-        ));\n-        Ok(Vc::cell(children))\n-    }\n-}"
        },
        {
            "sha": "db42d0d1a8e6228fb2399f8b22eec74fc82ffac0",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -12,7 +12,6 @@ pub mod analyzer;\n pub mod annotations;\n pub mod async_chunk;\n pub mod chunk;\n-pub mod chunk_group_files_asset;\n pub mod code_gen;\n mod errors;\n pub mod magic_identifier;"
        },
        {
            "sha": "4a249d982e950f0add972c005295654caaf72c81",
            "filename": "turbopack/crates/turbopack-ecmascript/src/manifest/chunk_asset.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fmanifest%2Fchunk_asset.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -8,7 +8,7 @@ use turbopack_core::{\n     },\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::OutputAssets,\n     reference::{ModuleReferences, SingleOutputAssetReference},\n };\n@@ -60,22 +60,24 @@ impl ManifestAsyncModule {\n     #[turbo_tasks::function]\n     pub(super) fn chunks(&self) -> Vc<OutputAssets> {\n         self.chunking_context.chunk_group_assets(\n-            *ResolvedVc::upcast(self.inner),\n+            self.inner.ident(),\n+            ChunkGroup::Async(ResolvedVc::upcast(self.inner)),\n             *self.module_graph,\n             Value::new(self.availability_info),\n         )\n     }\n \n     #[turbo_tasks::function]\n-    pub async fn manifest_chunks(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n+    pub async fn manifest_chunks(self: ResolvedVc<Self>) -> Result<Vc<OutputAssets>> {\n         let this = self.await?;\n         if let Some(chunk_items) = this.availability_info.available_modules() {\n             if *chunk_items.get(*this.inner).await? {\n                 return Ok(Vc::cell(vec![]));\n             }\n         }\n         Ok(this.chunking_context.chunk_group_assets(\n-            Vc::upcast(self),\n+            self.ident(),\n+            ChunkGroup::Async(ResolvedVc::upcast(self)),\n             *this.module_graph,\n             Value::new(this.availability_info),\n         ))"
        },
        {
            "sha": "4afbf3a6c88f64cbcbeda7ef6f7751fb41e974e4",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 24,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -11,14 +11,14 @@ use turbopack_core::{\n         availability_info::AvailabilityInfo,\n         chunk_group::{make_chunk_group, MakeChunkGroupResult},\n         module_id_strategies::{DevModuleIdStrategy, ModuleIdStrategy},\n-        Chunk, ChunkGroupResult, ChunkItem, ChunkableModule, ChunkableModules, ChunkingConfig,\n-        ChunkingConfigs, ChunkingContext, EntryChunkGroupResult, EvaluatableAssets, MinifyType,\n-        ModuleId, SourceMapsType,\n+        Chunk, ChunkGroupResult, ChunkItem, ChunkableModule, ChunkingConfig, ChunkingConfigs,\n+        ChunkingContext, EntryChunkGroupResult, EvaluatableAssets, MinifyType, ModuleId,\n+        SourceMapsType,\n     },\n     environment::Environment,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::{OutputAsset, OutputAssets},\n };\n use turbopack_ecmascript::{\n@@ -339,37 +339,21 @@ impl ChunkingContext for NodeJsChunkingContext {\n     }\n \n     #[turbo_tasks::function]\n-    fn chunk_group(\n-        self: Vc<Self>,\n-        ident: Vc<AssetIdent>,\n-        module: ResolvedVc<Box<dyn ChunkableModule>>,\n-        module_graph: Vc<ModuleGraph>,\n-        availability_info: Value<AvailabilityInfo>,\n-    ) -> Vc<ChunkGroupResult> {\n-        self.chunk_group_multiple(\n-            ident,\n-            Vc::cell(vec![module]),\n-            module_graph,\n-            availability_info,\n-        )\n-    }\n-\n-    #[turbo_tasks::function]\n-    async fn chunk_group_multiple(\n+    async fn chunk_group(\n         self: ResolvedVc<Self>,\n         ident: Vc<AssetIdent>,\n-        modules: Vc<ChunkableModules>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Result<Vc<ChunkGroupResult>> {\n         let span = tracing::info_span!(\"chunking\", module = ident.to_string().await?.to_string());\n         async move {\n-            let modules = modules.await?;\n+            let modules = chunk_group.entries();\n             let MakeChunkGroupResult {\n                 chunks,\n                 availability_info,\n             } = make_chunk_group(\n-                modules.iter().copied().map(ResolvedVc::upcast),\n+                modules,\n                 module_graph,\n                 ResolvedVc::upcast(self),\n                 availability_info.into_value(),"
        },
        {
            "sha": "6c26be74e2655b6b3de688f8239c6a22a8cf59df",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/801e06ff4591922e045e029a0f54095d99832cd0/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=801e06ff4591922e045e029a0f54095d99832cd0",
            "patch": "@@ -33,8 +33,8 @@ use turbopack_browser::BrowserChunkingContext;\n use turbopack_core::{\n     asset::Asset,\n     chunk::{\n-        availability_info::AvailabilityInfo, ChunkGroupType, ChunkableModule, ChunkingContext,\n-        ChunkingContextExt, EvaluatableAsset, EvaluatableAssetExt, EvaluatableAssets, MinifyType,\n+        availability_info::AvailabilityInfo, ChunkGroupType, ChunkingContext, ChunkingContextExt,\n+        EvaluatableAsset, EvaluatableAssetExt, EvaluatableAssets, MinifyType,\n     },\n     compile_time_defines,\n     compile_time_info::CompileTimeInfo,\n@@ -442,11 +442,6 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n                 ])\n             }\n         }\n-    } else if let Some(chunkable) =\n-        Vc::try_resolve_downcast::<Box<dyn ChunkableModule>>(entry_module).await?\n-    {\n-        let module_graph = ModuleGraph::from_module(Vc::upcast(chunkable), ChunkGroupType::Entry);\n-        chunking_context.root_chunk_group_assets(chunkable, module_graph)\n     } else {\n         // TODO convert into a serve-able asset\n         bail!(\"Entry module is not chunkable, so it can't be used to bootstrap the application\")"
        }
    ],
    "stats": {
        "total": 685,
        "additions": 223,
        "deletions": 462
    }
}