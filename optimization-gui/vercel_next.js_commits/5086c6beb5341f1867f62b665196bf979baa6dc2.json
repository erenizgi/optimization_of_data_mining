{
    "author": "mischnic",
    "message": "Turbopack: add app-dir alias for `next/*` subpackages (#78447)",
    "sha": "5086c6beb5341f1867f62b665196bf979baa6dc2",
    "files": [
        {
            "sha": "937dc1cd58cdc9b1038000507339367a7c92efa4",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 33,
            "deletions": 12,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/5086c6beb5341f1867f62b665196bf979baa6dc2/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5086c6beb5341f1867f62b665196bf979baa6dc2/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=5086c6beb5341f1867f62b665196bf979baa6dc2",
            "patch": "@@ -196,19 +196,23 @@ pub async fn get_next_client_import_map(\n                     &format!(\"next/dist/compiled/react-server-dom-turbopack{react_flavor}/*\"),\n                 ),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/head\",\n                 request_to_import_mapping(project_path, \"next/dist/client/components/noop-head\"),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/dynamic\",\n                 request_to_import_mapping(project_path, \"next/dist/shared/lib/app-dynamic\"),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/link\",\n                 request_to_import_mapping(project_path, \"next/dist/client/app-dir/link\"),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/form\",\n                 request_to_import_mapping(project_path, \"next/dist/client/app-dir/form\"),\n             );\n@@ -337,19 +341,23 @@ pub async fn get_next_server_import_map(\n         ServerContextType::AppSSR { .. }\n         | ServerContextType::AppRSC { .. }\n         | ServerContextType::AppRoute { .. } => {\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/head\",\n                 request_to_import_mapping(project_path, \"next/dist/client/components/noop-head\"),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/dynamic\",\n                 request_to_import_mapping(project_path, \"next/dist/shared/lib/app-dynamic\"),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/link\",\n                 request_to_import_mapping(project_path, \"next/dist/client/app-dir/link\"),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/form\",\n                 request_to_import_mapping(project_path, \"next/dist/client/app-dir/form\"),\n             );\n@@ -450,18 +458,21 @@ pub async fn get_next_edge_import_map(\n         ServerContextType::AppSSR { .. }\n         | ServerContextType::AppRSC { .. }\n         | ServerContextType::AppRoute { .. } => {\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/head\",\n                 request_to_import_mapping(project_path, \"next/dist/client/components/noop-head\"),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/dynamic\",\n                 request_to_import_mapping(project_path, \"next/dist/shared/lib/app-dynamic\"),\n             );\n-            import_map.insert_exact_alias(\n+            insert_exact_alias_or_js(\n+                &mut import_map,\n                 \"next/link\",\n                 request_to_import_mapping(project_path, \"next/dist/client/app-dir/link\"),\n-            )\n+            );\n         }\n     }\n \n@@ -1124,6 +1135,16 @@ async fn insert_instrumentation_client_alias(\n     Ok(())\n }\n \n+// To alias e.g. both `import \"next/link\"` and `import \"next/link.js\"`\n+fn insert_exact_alias_or_js(\n+    import_map: &mut ImportMap,\n+    pattern: &str,\n+    mapping: ResolvedVc<ImportMapping>,\n+) {\n+    import_map.insert_exact_alias(pattern, mapping);\n+    import_map.insert_exact_alias(format!(\"{pattern}.js\"), mapping);\n+}\n+\n /// Creates a direct import mapping to the result of resolving a request\n /// in a context.\n fn request_to_import_mapping("
        }
    ],
    "stats": {
        "total": 45,
        "additions": 33,
        "deletions": 12
    }
}