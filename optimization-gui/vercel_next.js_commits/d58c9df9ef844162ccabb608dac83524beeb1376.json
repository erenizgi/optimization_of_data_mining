{
    "author": "sokra",
    "message": "Turbopack: remove blocking thread limit to avoid deadlocks (#82961)\n\n### What?\n\nHaving a limit of blocking thread can lead to deadlocks the using block_in_place",
    "sha": "d58c9df9ef844162ccabb608dac83524beeb1376",
    "files": [
        {
            "sha": "f258be462d15c7e47fc8c3cb17a54dc83a91c2ef",
            "filename": "crates/napi/src/lib.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d58c9df9ef844162ccabb608dac83524beeb1376/crates%2Fnapi%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d58c9df9ef844162ccabb608dac83524beeb1376/crates%2Fnapi%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Flib.rs?ref=d58c9df9ef844162ccabb608dac83524beeb1376",
            "patch": "@@ -73,6 +73,7 @@ fn init() {\n     use std::{\n         cell::RefCell,\n         panic::{set_hook, take_hook},\n+        thread::available_parallelism,\n         time::{Duration, Instant},\n     };\n \n@@ -90,6 +91,8 @@ fn init() {\n         prev_hook(info);\n     }));\n \n+    let worker_threads = available_parallelism().map(|n| n.get()).unwrap_or(1);\n+\n     let rt = Builder::new_multi_thread()\n         .enable_all()\n         .on_thread_stop(|| {\n@@ -103,6 +106,10 @@ fn init() {\n                 }\n             });\n         })\n+        .worker_threads(worker_threads)\n+        // Avoid a limit on threads to avoid deadlocks due to usage of block_in_place\n+        .max_blocking_threads(usize::MAX - worker_threads)\n+        // Avoid the extra lifo slot to avoid stalling tasks when doing cpu-heavy work\n         .disable_lifo_slot()\n         .build()\n         .unwrap();"
        },
        {
            "sha": "51a738d70575e57eee9496d01a1d18cfa719448d",
            "filename": "turbopack/crates/turbopack-cli/src/main.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d58c9df9ef844162ccabb608dac83524beeb1376/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d58c9df9ef844162ccabb608dac83524beeb1376/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fmain.rs?ref=d58c9df9ef844162ccabb608dac83524beeb1376",
            "patch": "@@ -1,7 +1,7 @@\n #![feature(future_join)]\n #![feature(min_specialization)]\n \n-use std::{cell::RefCell, path::Path, time::Instant};\n+use std::{cell::RefCell, path::Path, thread::available_parallelism, time::Instant};\n \n use anyhow::{Context, Result};\n use clap::Parser;\n@@ -42,6 +42,11 @@ fn main() {\n             });\n         });\n \n+    let worker_threads = available_parallelism().map(|n| n.get()).unwrap_or(1);\n+\n+    rt.worker_threads(worker_threads);\n+    rt.max_blocking_threads(usize::MAX - worker_threads);\n+\n     #[cfg(not(codspeed))]\n     rt.disable_lifo_slot();\n "
        }
    ],
    "stats": {
        "total": 14,
        "additions": 13,
        "deletions": 1
    }
}