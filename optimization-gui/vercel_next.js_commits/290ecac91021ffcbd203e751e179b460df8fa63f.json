{
    "author": "wyattjoh",
    "message": "fix(build): add sourcePage context for PPR dynamic route lambda creation (#81781)\n\n### What?\n\nThis PR adds a `sourcePage` property to dynamic routes in the routes\nmanifest to provide the necessary context for lambda creation during the\nbuild process when PPR is enabled.\n\n### Why?\n\nThe build process was missing the required context to properly create\nlambdas for dynamic routes when PPR is enabled. Without the source page\ninformation, the build couldn't determine which page a dynamic route\noriginated from, preventing correct lambda generation.\n\n### How?\n\n- Added a new `DynamicManifestRoute` type that extends `ManifestRoute`\nwith an optional `sourcePage` property\n- Updated the `pageToRoute` function with overloads to pass the source\npage context\n- Modified the routes manifest generation to include the source page\nwhen creating dynamic routes for PPR-enabled pages\n- The `sourcePage` property is only populated for app pages when PPR is\nenabled (remains `undefined` for regular dynamic routes)\n\nThis ensures the build process has the necessary context to create the\nunderlying lambdas correctly.",
    "sha": "290ecac91021ffcbd203e751e179b460df8fa63f",
    "files": [
        {
            "sha": "d0371b4becf6eedc4ca6d7bf74c706d43924f195",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 5,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/290ecac91021ffcbd203e751e179b460df8fa63f/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/290ecac91021ffcbd203e751e179b460df8fa63f/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=290ecac91021ffcbd203e751e179b460df8fa63f",
            "patch": "@@ -412,6 +412,15 @@ export type ManifestRoute = ManifestBuiltRoute & {\n   skipInternalRouting?: boolean\n }\n \n+type DynamicManifestRoute = ManifestRoute & {\n+  /**\n+   * The source page that this route is based on. This is used to determine the\n+   * source page for the route and is only relevant for app pages where PPR is\n+   * enabled and the page differs from the source page.\n+   */\n+  sourcePage: string | undefined\n+}\n+\n type ManifestDataRoute = {\n   page: string\n   routeKeys?: { [key: string]: string }\n@@ -431,7 +440,7 @@ export type RoutesManifest = {\n   }\n   headers: Array<ManifestHeaderRoute>\n   staticRoutes: Array<ManifestRoute>\n-  dynamicRoutes: ReadonlyArray<ManifestRoute>\n+  dynamicRoutes: ReadonlyArray<DynamicManifestRoute>\n   dataRoutes: Array<ManifestDataRoute>\n   i18n?: {\n     domains?: ReadonlyArray<{\n@@ -479,11 +488,35 @@ export type RoutesManifest = {\n   }\n }\n \n-function pageToRoute(page: string): ManifestRoute {\n+/**\n+ * Converts a page to a manifest route.\n+ *\n+ * @param page The page to convert to a route.\n+ * @returns A route object.\n+ */\n+function pageToRoute(page: string): ManifestRoute\n+/**\n+ * Converts a page to a dynamic manifest route.\n+ *\n+ * @param page The page to convert to a route.\n+ * @param sourcePage The source page that this route is based on. This is used\n+ * to determine the source page for the route and is only relevant for app\n+ * pages when PPR is enabled on them.\n+ * @returns A route object.\n+ */\n+function pageToRoute(\n+  page: string,\n+  sourcePage: string | undefined\n+): DynamicManifestRoute\n+function pageToRoute(\n+  page: string,\n+  sourcePage?: string\n+): DynamicManifestRoute | ManifestRoute {\n   const routeRegex = getNamedRouteRegex(page, {\n     prefixRouteKeys: true,\n   })\n   return {\n+    sourcePage,\n     page,\n     regex: normalizeRouteRegex(routeRegex.re.source),\n     routeKeys: routeRegex.routeKeys,\n@@ -1329,7 +1362,7 @@ export default async function build(\n       const isAppPPREnabled = checkIsAppPPREnabled(config.experimental.ppr)\n \n       const routesManifestPath = path.join(distDir, ROUTES_MANIFEST)\n-      const dynamicRoutes: Array<ManifestRoute> = []\n+      const dynamicRoutes: Array<DynamicManifestRoute> = []\n \n       /**\n        * A map of all the pages to their sourcePage value. This is only used for\n@@ -1347,7 +1380,13 @@ export default async function build(\n \n           for (const route of sortedRoutes) {\n             if (isDynamicRoute(route)) {\n-              dynamicRoutes.push(pageToRoute(route))\n+              dynamicRoutes.push(\n+                pageToRoute(\n+                  route,\n+                  // This property is only relevant when PPR is enabled.\n+                  undefined\n+                )\n+              )\n             } else if (!isReservedPage(route)) {\n               staticRoutes.push(pageToRoute(route))\n             }\n@@ -3123,7 +3162,7 @@ export default async function build(\n                   // entry in the app routes manifest which enables routing for\n                   // this fallback shell.\n                   if (!dynamicRoute) {\n-                    dynamicRoute = pageToRoute(route.pathname)\n+                    dynamicRoute = pageToRoute(route.pathname, page)\n                     sourcePages.set(route.pathname, page)\n \n                     // This route is not for the internal router, but instead"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 44,
        "deletions": 5
    }
}