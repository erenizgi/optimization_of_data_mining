{
    "author": "huozhi",
    "message": "[metadata] refine metadata image error for webpack (#83139)",
    "sha": "91601608af4d1da55e4652e8304426d2882cece3",
    "files": [
        {
            "sha": "a453eef6f4a21fb4385a77ea2a81fa441b1bdbd5",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-image-loader.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 6,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/91601608af4d1da55e4652e8304426d2882cece3/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/91601608af4d1da55e4652e8304426d2882cece3/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-image-loader.ts?ref=91601608af4d1da55e4652e8304426d2882cece3",
            "patch": "@@ -126,14 +126,17 @@ async function nextMetadataImageLoader(\n     }`\n   }\n \n+  let imageError\n   const imageSize: { width?: number; height?: number } = await getImageSize(\n     content\n-  ).catch((err) => err)\n-\n-  if (imageSize instanceof Error) {\n-    const err = imageSize\n-    err.name = 'InvalidImageFormatError'\n-    throw err\n+  ).catch((error) => {\n+    const message = `Process image \"${path.posix.join(segment || '/', interpolatedName)}\" failed: ${error}`\n+    imageError = new Error(message)\n+    return {}\n+  })\n+\n+  if (imageError) {\n+    throw imageError\n   }\n \n   const imageData: Omit<MetadataImageModule, 'url'> = {"
        },
        {
            "sha": "99f8798b46539baaa0960c34c702bdd70af88798",
            "filename": "test/e2e/app-dir/metadata-invalid-image-file/app/favicon.ico",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Ffavicon.ico",
            "raw_url": "https://github.com/vercel/next.js/raw/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Ffavicon.ico",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Ffavicon.ico?ref=91601608af4d1da55e4652e8304426d2882cece3",
            "patch": "@@ -0,0 +1 @@\n+malformed image content\n\\ No newline at end of file"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/metadata-invalid-image-file/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Flayout.tsx?ref=91601608af4d1da55e4652e8304426d2882cece3",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/metadata-invalid-image-file/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fapp%2Fpage.tsx?ref=91601608af4d1da55e4652e8304426d2882cece3",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "8b09c88c5756ab709d17c0b86e5f67db2a40e21f",
            "filename": "test/e2e/app-dir/metadata-invalid-image-file/metadata-invalid-image-file.test.ts",
            "status": "added",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fmetadata-invalid-image-file.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fmetadata-invalid-image-file.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fmetadata-invalid-image-file.test.ts?ref=91601608af4d1da55e4652e8304426d2882cece3",
            "patch": "@@ -0,0 +1,43 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('metadata-invalid-image-file', () => {\n+  const { next, isTurbopack, isNextDev, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+    skipStart: true,\n+  })\n+\n+  if (skipped) return\n+\n+  it('should error on invalid metadata image file', async () => {\n+    // In dev, it needs to render the page first\n+    if (isNextDev) {\n+      await next.start()\n+      await next.fetch('/')\n+    } else {\n+      await next.build()\n+    }\n+\n+    if (isTurbopack) {\n+      // In turbopack the image decoding error is displayed in multiple lines\n+      expect(next.cliOutput).toContain('app/favicon.ico')\n+      expect(next.cliOutput).toContain('Processing image failed')\n+      expect(next.cliOutput).toContain('unable to decode image data')\n+    } else {\n+      expect(next.cliOutput).toContain(\n+        'Error: Process image \"/favicon.ico\" failed:'\n+      )\n+    }\n+\n+    if (!isNextDev) {\n+      // `next build` should fail\n+      if (isTurbopack) {\n+        expect(next.cliOutput).toContain('Build error occurred')\n+      } else {\n+        expect(next.cliOutput).toContain(\n+          'Build failed because of webpack errors'\n+        )\n+      }\n+    }\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/metadata-invalid-image-file/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/91601608af4d1da55e4652e8304426d2882cece3/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-invalid-image-file%2Fnext.config.js?ref=91601608af4d1da55e4652e8304426d2882cece3",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 76,
        "additions": 70,
        "deletions": 6
    }
}