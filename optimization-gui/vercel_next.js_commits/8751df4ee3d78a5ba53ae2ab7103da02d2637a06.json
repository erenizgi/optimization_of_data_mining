{
    "author": "unstubbable",
    "message": "[Segment Cache] Fix: Ensure server references can be prerendered (#79448)",
    "sha": "8751df4ee3d78a5ba53ae2ab7103da02d2637a06",
    "files": [
        {
            "sha": "fea1a4e6b846cf681936740c3ed7cee51bfa8c7e",
            "filename": ".changeset/spotty-hotels-train.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/.changeset%2Fspotty-hotels-train.md",
            "raw_url": "https://github.com/vercel/next.js/raw/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/.changeset%2Fspotty-hotels-train.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Fspotty-hotels-train.md?ref=8751df4ee3d78a5ba53ae2ab7103da02d2637a06",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+\"next\": patch\n+---\n+\n+[Segment Cache] Fix: Ensure server references can be prerendered"
        },
        {
            "sha": "1a308647d985a46de9b9c9d3851cdd6245043870",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=8751df4ee3d78a5ba53ae2ab7103da02d2637a06",
            "patch": "@@ -99,7 +99,10 @@ import { makeGetServerInsertedHTML } from './make-get-server-inserted-html'\n import { walkTreeWithFlightRouterState } from './walk-tree-with-flight-router-state'\n import { createComponentTree, getRootParams } from './create-component-tree'\n import { getAssetQueryString } from './get-asset-query-string'\n-import { setReferenceManifestsSingleton } from './encryption-utils'\n+import {\n+  getServerModuleMap,\n+  setReferenceManifestsSingleton,\n+} from './encryption-utils'\n import {\n   DynamicState,\n   type PostponedState,\n@@ -3872,7 +3875,7 @@ async function collectSegmentData(\n     moduleMap: isEdgeRuntime\n       ? clientReferenceManifest.edgeRscModuleMapping\n       : clientReferenceManifest.rscModuleMapping,\n-    serverModuleMap: null,\n+    serverModuleMap: getServerModuleMap(),\n   }\n \n   const staleTime = prerenderStore.stale"
        },
        {
            "sha": "5f84f969b4d76e52d082a78f22999c0cb56f6606",
            "filename": "packages/next/src/server/app-render/collect-segment-data.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx?ref=8751df4ee3d78a5ba53ae2ab7103da02d2637a06",
            "patch": "@@ -199,9 +199,7 @@ async function PrefetchTreeData({\n     buildId,\n     seedData,\n     fallbackRouteParams,\n-    fullPageDataBuffer,\n     clientModules,\n-    serverConsumerManifest,\n     ROOT_SEGMENT_KEY,\n     segmentTasks\n   )\n@@ -229,9 +227,7 @@ function collectSegmentDataImpl(\n   buildId: string,\n   seedData: CacheNodeSeedData | null,\n   fallbackRouteParams: FallbackRouteParams | null,\n-  fullPageDataBuffer: Buffer,\n   clientModules: ManifestNode,\n-  serverConsumerManifest: any,\n   key: string,\n   segmentTasks: Array<Promise<[string, Buffer]>>\n ): TreePrefetch {\n@@ -262,9 +258,7 @@ function collectSegmentDataImpl(\n       buildId,\n       childSeedData,\n       fallbackRouteParams,\n-      fullPageDataBuffer,\n       clientModules,\n-      serverConsumerManifest,\n       childKey,\n       segmentTasks\n     )"
        },
        {
            "sha": "a58efb42aa7bde50a70263b7327c52a8bfa97d3a",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/with-server-action/page.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Fpage.tsx?ref=8751df4ee3d78a5ba53ae2ab7103da02d2637a06",
            "patch": "@@ -0,0 +1,19 @@\n+import { LinkAccordion } from '../../components/link-accordion'\n+\n+export default function FullyStaticStart() {\n+  return (\n+    <>\n+      <p>\n+        This is a regression test case to ensure that prerendered segments that\n+        include server actions do not throw an error when navigating to them.\n+      </p>\n+      <ul>\n+        <li>\n+          <LinkAccordion href=\"/with-server-action/target-page\">\n+            Target\n+          </LinkAccordion>\n+        </li>\n+      </ul>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "44895ef8824a51e2b22e624f25fd24dc68526605",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/with-server-action/target-page/action.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Ftarget-page%2Faction.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Ftarget-page%2Faction.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Ftarget-page%2Faction.ts?ref=8751df4ee3d78a5ba53ae2ab7103da02d2637a06",
            "patch": "@@ -0,0 +1,5 @@\n+'use server'\n+\n+export async function action() {\n+  console.log('Action!')\n+}"
        },
        {
            "sha": "8feccaf9e2649dbec94839386b76b46f3d9ee74a",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/with-server-action/target-page/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Ftarget-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Ftarget-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Fwith-server-action%2Ftarget-page%2Fpage.tsx?ref=8751df4ee3d78a5ba53ae2ab7103da02d2637a06",
            "patch": "@@ -0,0 +1,9 @@\n+import { action } from './action'\n+\n+export default function Target() {\n+  return (\n+    <form id=\"target-page\" action={action}>\n+      Target\n+    </form>\n+  )\n+}"
        },
        {
            "sha": "0ff2013869c820342d2cea7a9f4742e6c2a4140b",
            "filename": "test/e2e/app-dir/segment-cache/basic/segment-cache-basic.test.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8751df4ee3d78a5ba53ae2ab7103da02d2637a06/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts?ref=8751df4ee3d78a5ba53ae2ab7103da02d2637a06",
            "patch": "@@ -306,4 +306,38 @@ describe('segment cache (basic tests)', () => {\n     }, 'no-requests')\n     expect(await readRandomNumberFromPage()).toBe(randomNumber3)\n   })\n+\n+  it('does not throw an error when navigating to a page with a server action', async () => {\n+    let act: ReturnType<typeof createRouterAct>\n+    const browser = await next.browser('/with-server-action', {\n+      beforePageLoad(page) {\n+        act = createRouterAct(page)\n+      },\n+    })\n+\n+    // Reveal the link to trigger a prefetch.\n+    const reveal = await browser.elementByCss('input[type=\"checkbox\"]')\n+    const link = await act(\n+      async () => {\n+        await reveal.click()\n+        return await browser.elementByCss(\n+          'a[href=\"/with-server-action/target-page\"]'\n+        )\n+      },\n+      { includes: 'Target' }\n+    )\n+\n+    await act(\n+      async () => {\n+        await link.click()\n+\n+        // The page should render immediately because it was prefetched, and it\n+        // should not throw an error.\n+        const form = await browser.elementById('target-page')\n+        expect(await form.innerHTML()).toBe('Target')\n+      },\n+      // No additional requests were required, because everything was prefetched\n+      'no-requests'\n+    )\n+  })\n })"
        }
    ],
    "stats": {
        "total": 85,
        "additions": 77,
        "deletions": 8
    }
}