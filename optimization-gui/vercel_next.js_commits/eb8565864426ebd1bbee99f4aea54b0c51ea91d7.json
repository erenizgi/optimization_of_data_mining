{
    "author": "acdlite",
    "message": "Add experimental.routerBFCache to NextConfig (#77951)\n\nSets up a flag that will depend on an experimental React feature\n(Activity). I based this on the existing code for the `viewTransition`\nflag.\n\nI haven't implemented anything behind this flag yet; this only wires up\nthe flag itself. I added a basic test that renders the Activity\ncomponent to verify that it's available when the flag is on.",
    "sha": "eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
    "files": [
        {
            "sha": "3d5665d6943cc98de47f68e472b2356e85289b40",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -726,6 +726,8 @@ pub struct ExperimentalConfig {\n     ppr: Option<ExperimentalPartialPrerendering>,\n     taint: Option<bool>,\n     react_owner_stack: Option<bool>,\n+    #[serde(rename = \"routerBFCache\")]\n+    router_bfcache: Option<bool>,\n     proxy_timeout: Option<f64>,\n     /// enables the minification of server code.\n     server_minification: Option<bool>,\n@@ -1420,6 +1422,11 @@ impl NextConfig {\n         Vc::cell(self.experimental.react_owner_stack.unwrap_or(false))\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn enable_router_bfcache(&self) -> Vc<bool> {\n+        Vc::cell(self.experimental.router_bfcache.unwrap_or(false))\n+    }\n+\n     #[turbo_tasks::function]\n     pub fn enable_view_transition(&self) -> Vc<bool> {\n         Vc::cell(self.experimental.view_transition.unwrap_or(false))"
        },
        {
            "sha": "235e03b2ac7a98a6b6f0e00bbed71732829d2e29",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -122,6 +122,7 @@ pub async fn get_next_client_import_map(\n                 || *next_config.enable_taint().await?\n                 || *next_config.enable_react_owner_stack().await?\n                 || *next_config.enable_view_transition().await?\n+                || *next_config.enable_router_bfcache().await?\n             {\n                 \"-experimental\"\n             } else {\n@@ -700,8 +701,9 @@ async fn rsc_aliases(\n     let ppr = *next_config.enable_ppr().await?;\n     let taint = *next_config.enable_taint().await?;\n     let react_owner_stack = *next_config.enable_react_owner_stack().await?;\n+    let router_bfcache = *next_config.enable_router_bfcache().await?;\n     let view_transition = *next_config.enable_view_transition().await?;\n-    let react_channel = if ppr || taint || react_owner_stack || view_transition {\n+    let react_channel = if ppr || taint || react_owner_stack || view_transition || router_bfcache {\n         \"-experimental\"\n     } else {\n         \"\""
        },
        {
            "sha": "c555accac42ce7f66f328f75f5952f1cbb140c90",
            "filename": "packages/next/src/build/webpack/plugins/define-env-plugin.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fdefine-env-plugin.ts?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -190,6 +190,9 @@ export function getDefineEnv({\n     'process.env.__NEXT_DYNAMIC_ON_HOVER': Boolean(\n       config.experimental.dynamicOnHover\n     ),\n+    'process.env.__NEXT_ROUTER_BF_CACHE': Boolean(\n+      config.experimental.routerBFCache\n+    ),\n     'process.env.__NEXT_OPTIMISTIC_CLIENT_CACHE':\n       config.experimental.optimisticClientCache ?? true,\n     'process.env.__NEXT_MIDDLEWARE_PREFETCH':"
        },
        {
            "sha": "26008128ecaa31d06a5e62cf3f5948821632dac5",
            "filename": "packages/next/src/lib/needs-experimental-react.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/packages%2Fnext%2Fsrc%2Flib%2Fneeds-experimental-react.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/packages%2Fnext%2Fsrc%2Flib%2Fneeds-experimental-react.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fneeds-experimental-react.ts?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -1,6 +1,7 @@\n import type { NextConfig } from '../server/config-shared'\n \n export function needsExperimentalReact(config: NextConfig) {\n-  const { ppr, taint, viewTransition } = config.experimental || {}\n-  return Boolean(ppr || taint || viewTransition)\n+  const { ppr, taint, viewTransition, routerBFCache } =\n+    config.experimental || {}\n+  return Boolean(ppr || taint || viewTransition || routerBFCache)\n }"
        },
        {
            "sha": "df29672da0216171f726449e8a311c1a3a6ae8f7",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -389,6 +389,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         taint: z.boolean().optional(),\n         prerenderEarlyExit: z.boolean().optional(),\n         proxyTimeout: z.number().gte(0).optional(),\n+        routerBFCache: z.boolean().optional(),\n         scrollRestoration: z.boolean().optional(),\n         sri: z\n           .object({"
        },
        {
            "sha": "2837e6e28dee13f994456f05017bc6dc6410bbed",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -504,6 +504,11 @@ export interface ExperimentalConfig {\n    */\n   taint?: boolean\n \n+  /**\n+   * Enables the Back/Forward Cache for the router.\n+   */\n+  routerBFCache?: boolean\n+\n   serverActions?: {\n     /**\n      * Allows adjusting body parser size limit for server actions.\n@@ -1296,6 +1301,7 @@ export const defaultConfig: NextConfig = {\n     optimizeServerReact: true,\n     useEarlyImport: false,\n     viewTransition: false,\n+    routerBFCache: false,\n     staleTimes: {\n       dynamic: 0,\n       static: 300,"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/back-forward-cache/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Flayout.tsx?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "3736ab466ec867d85a4bd9a8902ce99198a61bed",
            "filename": "test/e2e/app-dir/back-forward-cache/app/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fapp%2Fpage.tsx?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -0,0 +1,15 @@\n+'use client'\n+\n+// TODO: \"use client\" is required in this module because Activity is not\n+// exported from the server entrypoint of React\n+\n+// @ts-expect-error: Not yet part of the TypeScript types\n+import { unstable_Activity as Activity } from 'react'\n+\n+export default function Page() {\n+  return (\n+    <Activity mode=\"hidden\">\n+      <div id=\"activity-content\">Hello</div>\n+    </Activity>\n+  )\n+}"
        },
        {
            "sha": "0a5e12d0b81018bfbba82517c306a491a80dd4d2",
            "filename": "test/e2e/app-dir/back-forward-cache/back-forward-cache.test.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fback-forward-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fback-forward-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fback-forward-cache.test.ts?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -0,0 +1,17 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('back/forward cache', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('Activity component is renderable when the routerBFCache flag is on', async () => {\n+    // None of the back/forward behavior has been implemented yet; this just\n+    // tests that when the flag is enabled, we're able to successfully render\n+    // an Activity component.\n+    const browser = await next.browser('/')\n+    const activityContent = await browser.elementById('activity-content')\n+    expect(await activityContent.innerHTML()).toBe('Hello')\n+    expect(await activityContent.getComputedCss('display')).toBe('none')\n+  })\n+})"
        },
        {
            "sha": "c64f7aa983d31604732b76d1335216cfce7a96b9",
            "filename": "test/e2e/app-dir/back-forward-cache/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eb8565864426ebd1bbee99f4aea54b0c51ea91d7/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fback-forward-cache%2Fnext.config.js?ref=eb8565864426ebd1bbee99f4aea54b0c51ea91d7",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    routerBFCache: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 76,
        "deletions": 3
    }
}