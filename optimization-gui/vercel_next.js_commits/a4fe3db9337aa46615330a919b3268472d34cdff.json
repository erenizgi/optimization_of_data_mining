{
    "author": "bgub",
    "message": "fix: relative paths in dev in validator.ts (#83073)\n\nFixes #83063 \n\n- **Problem**: `next dev` produced overly deep relative imports in\n`validator.ts` that differed from `next typegen`/`next build`.\n- **Cause**: Dev pre-relativized page file paths and didnâ€™t pass\n`validatorFilePath`, causing incorrect relative path computation.\n- **Solution**:\n  - Pass `validatorFilePath` to `createRouteTypesManifest` in dev.\n- Stop pre-relativizing file paths; provide absolute `fileName` so the\nmanifest computes paths relative to the validator directory.\n- **Result**: `validator.ts` now uses correct, shallow relative imports,\nmatching `next typegen` and `next build`.\n- **Verification**: Reproduced with\n`test/e2e/app-dir/typed-routes-validator`; outputs from `pnpm next dev`\nand `pnpm next typegen` now match.\n\n### Example\nBefore (next dev):\n```typescript\n// Validate ../../../../../../app/page.tsx\n{\n  const handler = {} as typeof import(\"../../../../../../app/page.js\")\n  handler satisfies AppPageConfig<\"/\">\n}\n```\n\nAfter (next dev/typegen/build):\n```typescript\n// Validate ../../app/page.tsx\n{\n  const handler = {} as typeof import(\"../../app/page.js\")\n  handler satisfies AppPageConfig<\"/\">\n}\n```",
    "sha": "a4fe3db9337aa46615330a919b3268472d34cdff",
    "files": [
        {
            "sha": "bc0f866e66ba4b3526a2d17454401453d342bc01",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 20,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/a4fe3db9337aa46615330a919b3268472d34cdff/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a4fe3db9337aa46615330a919b3268472d34cdff/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=a4fe3db9337aa46615330a919b3268472d34cdff",
            "patch": "@@ -576,10 +576,7 @@ async function startWatcher(\n                   ''\n                 )\n               ),\n-              filePath: path.relative(\n-                path.dirname(validatorFilePath),\n-                fileName\n-              ),\n+              filePath: fileName,\n             })\n           }\n \n@@ -606,18 +603,12 @@ async function startWatcher(\n           if (validFileMatcher.isAppRouterRoute(fileName)) {\n             appRouteHandlers.push({\n               route: normalizePathSep(pageName),\n-              filePath: path.relative(\n-                path.dirname(validatorFilePath),\n-                fileName\n-              ),\n+              filePath: fileName,\n             })\n           } else {\n             appRoutes.push({\n               route: normalizePathSep(pageName),\n-              filePath: path.relative(\n-                path.dirname(validatorFilePath),\n-                fileName\n-              ),\n+              filePath: fileName,\n             })\n           }\n \n@@ -635,18 +626,12 @@ async function startWatcher(\n           if (pageName.startsWith('/api/')) {\n             pageApiRoutes.push({\n               route: normalizePathSep(pageName),\n-              filePath: path.relative(\n-                path.dirname(validatorFilePath),\n-                fileName\n-              ),\n+              filePath: fileName,\n             })\n           } else {\n             pageRoutes.push({\n               route: normalizePathSep(pageName),\n-              filePath: path.relative(\n-                path.dirname(validatorFilePath),\n-                fileName\n-              ),\n+              filePath: fileName,\n             })\n           }\n         }\n@@ -1062,6 +1047,9 @@ async function startWatcher(\n             slots,\n             redirects: opts.nextConfig.redirects,\n             rewrites: opts.nextConfig.rewrites,\n+            // Ensure relative paths in validator.ts are computed from validatorFilePath,\n+            // matching behavior of build and CLI typegen.\n+            validatorFilePath,\n             appRouteHandlers,\n             pageApiRoutes,\n           })"
        }
    ],
    "stats": {
        "total": 28,
        "additions": 8,
        "deletions": 20
    }
}