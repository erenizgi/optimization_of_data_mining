{
    "author": "fireairforce",
    "message": "feat(turbopack): externalType support global (#80542)\n\nThis pr introduces a new external type for turbopack(maybe not for\nnext.js), it can help to generate external like:\nhttps://webpack.js.org/configuration/externals/#externalstypeglobal.\n\n- Support a new externalType `global`\n- Update the codengen content for `external_module.rs`\n\n---------\n\nCo-authored-by: Benjamin Woodruff <benjamin.woodruff@vercel.com>",
    "sha": "57c304d74f2e0464a755776704b83ec6879a66f0",
    "files": [
        {
            "sha": "643ccc9a2ad103056c8b953f536378fae8cee3b3",
            "filename": "turbopack/crates/turbopack-core/src/resolve/mod.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs?ref=57c304d74f2e0464a755776704b83ec6879a66f0",
            "patch": "@@ -477,6 +477,7 @@ pub enum ExternalType {\n     Url,\n     CommonJs,\n     EcmaScriptModule,\n+    Global,\n }\n \n impl Display for ExternalType {\n@@ -485,6 +486,7 @@ impl Display for ExternalType {\n             ExternalType::CommonJs => write!(f, \"commonjs\"),\n             ExternalType::EcmaScriptModule => write!(f, \"esm\"),\n             ExternalType::Url => write!(f, \"url\"),\n+            ExternalType::Global => write!(f, \"global\"),\n         }\n     }\n }\n@@ -2791,6 +2793,7 @@ async fn resolve_import_map_result(\n                         ExternalType::EcmaScriptModule => {\n                             node_esm_resolve_options(alias_lookup_path.root())\n                         }\n+                        ExternalType::Global => options,\n                     },\n                 )\n                 .await?"
        },
        {
            "sha": "a0d723caf19de91d28e98b12d33045b029e8565c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/external_module.rs",
            "status": "modified",
            "additions": 29,
            "deletions": 13,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs?ref=57c304d74f2e0464a755776704b83ec6879a66f0",
            "patch": "@@ -44,6 +44,7 @@ pub enum CachedExternalType {\n     CommonJs,\n     EcmaScriptViaRequire,\n     EcmaScriptViaImport,\n+    Global,\n }\n \n impl Display for CachedExternalType {\n@@ -52,6 +53,7 @@ impl Display for CachedExternalType {\n             CachedExternalType::CommonJs => write!(f, \"cjs\"),\n             CachedExternalType::EcmaScriptViaRequire => write!(f, \"esm_require\"),\n             CachedExternalType::EcmaScriptViaImport => write!(f, \"esm_import\"),\n+            CachedExternalType::Global => write!(f, \"global\"),\n         }\n     }\n }\n@@ -82,19 +84,33 @@ impl CachedExternalModule {\n     pub fn content(&self) -> Result<Vc<EcmascriptModuleContent>> {\n         let mut code = RopeBuilder::default();\n \n-        if self.external_type == CachedExternalType::EcmaScriptViaImport {\n-            writeln!(\n-                code,\n-                \"const mod = await {TURBOPACK_EXTERNAL_IMPORT}({});\",\n-                StringifyJs(&self.request)\n-            )?;\n-        } else {\n-            writeln!(\n-                code,\n-                \"const mod = {TURBOPACK_EXTERNAL_REQUIRE}({}, () => require({}));\",\n-                StringifyJs(&self.request),\n-                StringifyJs(&self.request)\n-            )?;\n+        match self.external_type {\n+            CachedExternalType::EcmaScriptViaImport => {\n+                writeln!(\n+                    code,\n+                    \"const mod = await {TURBOPACK_EXTERNAL_IMPORT}({});\",\n+                    StringifyJs(&self.request)\n+                )?;\n+            }\n+            CachedExternalType::Global => {\n+                if self.request.is_empty() {\n+                    writeln!(code, \"const mod = {{}};\")?;\n+                } else {\n+                    writeln!(\n+                        code,\n+                        \"const mod = globalThis[{}];\",\n+                        StringifyJs(&self.request)\n+                    )?;\n+                }\n+            }\n+            CachedExternalType::EcmaScriptViaRequire | CachedExternalType::CommonJs => {\n+                writeln!(\n+                    code,\n+                    \"const mod = {TURBOPACK_EXTERNAL_REQUIRE}({}, () => require({}));\",\n+                    StringifyJs(&self.request),\n+                    StringifyJs(&self.request)\n+                )?;\n+            }\n         }\n \n         writeln!(code)?;"
        },
        {
            "sha": "738ac5e8a52e86d136497eab188aa83337f36b0e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=57c304d74f2e0464a755776704b83ec6879a66f0",
            "patch": "@@ -157,8 +157,8 @@ use crate::{\n         util::InlineSourceMap,\n     },\n     runtime_functions::{\n-        TUBROPACK_RUNTIME_FUNCTION_SHORTCUTS, TURBOPACK_EXPORT_NAMESPACE, TURBOPACK_EXPORT_VALUE,\n-        TURBOPACK_REQUIRE_REAL, TURBOPACK_REQUIRE_STUB,\n+        TURBOPACK_EXPORT_NAMESPACE, TURBOPACK_EXPORT_VALUE, TURBOPACK_REQUIRE_REAL,\n+        TURBOPACK_REQUIRE_STUB, TURBOPACK_RUNTIME_FUNCTION_SHORTCUTS,\n     },\n     tree_shake::{find_turbopack_part_id_in_asserts, part_of_module, split},\n     utils::{AstPathRange, module_value_to_well_known_object},\n@@ -1530,7 +1530,7 @@ async fn compile_time_info_for_module_type(\n         .entry(vec![DefineableNameSegment::Name(global)])\n         .or_insert(FreeVarReference::Ident(\"globalThis\".into()));\n \n-    free_var_references.extend(TUBROPACK_RUNTIME_FUNCTION_SHORTCUTS.into_iter().map(\n+    free_var_references.extend(TURBOPACK_RUNTIME_FUNCTION_SHORTCUTS.into_iter().map(\n         |(name, shortcut)| {\n             (\n                 vec![DefineableNameSegment::Name(name.into())],"
        },
        {
            "sha": "e28df14bbd5011b7d5efa13adc4c3507f98fcb35",
            "filename": "turbopack/crates/turbopack-ecmascript/src/runtime_functions.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fruntime_functions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fruntime_functions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fruntime_functions.rs?ref=57c304d74f2e0464a755776704b83ec6879a66f0",
            "patch": "@@ -81,7 +81,7 @@ pub const TURBOPACK_REQUIRE_REAL: &TurbopackRuntimeFunctionShortcut =\n \n /// Adding an entry to this list will automatically ensure that `__turbopack_XXX__` can be called\n /// from user code (by inserting a replacement into free_var_references)\n-pub const TUBROPACK_RUNTIME_FUNCTION_SHORTCUTS: [(&str, &TurbopackRuntimeFunctionShortcut); 21] = [\n+pub const TURBOPACK_RUNTIME_FUNCTION_SHORTCUTS: [(&str, &TurbopackRuntimeFunctionShortcut); 21] = [\n     (\"__turbopack_require__\", TURBOPACK_REQUIRE),\n     (\"__turbopack_module_context__\", TURBOPACK_MODULE_CONTEXT),\n     (\"__turbopack_import__\", TURBOPACK_IMPORT),"
        },
        {
            "sha": "39df94d1dce4c92a6267be1de6bc655489b4a478",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/57c304d74f2e0464a755776704b83ec6879a66f0/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=57c304d74f2e0464a755776704b83ec6879a66f0",
            "patch": "@@ -667,6 +667,7 @@ async fn externals_tracing_module_context(ty: ExternalType) -> Result<Vc<ModuleA\n             ExternalType::CommonJs => vec![\"require\".into()],\n             ExternalType::EcmaScriptModule => vec![\"import\".into()],\n             ExternalType::Url => vec![],\n+            ExternalType::Global => vec![],\n         },\n         ..Default::default()\n     };\n@@ -1012,6 +1013,7 @@ pub async fn replace_external(\n                 CachedExternalType::EcmaScriptViaRequire\n             }\n         }\n+        ExternalType::Global => CachedExternalType::Global,\n         ExternalType::Url => {\n             // we don't want to wrap url externals.\n             return Ok(None);"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 38,
        "deletions": 17
    }
}