{
    "author": "sokra",
    "message": "Turbopack: use batch insert to make dependencies outdated (#85625)\n\n### What?\n\nRefactor making dependencies outdated and use batch add",
    "sha": "72a32c34d6d457e21cb7765f0b82a943bda22165",
    "files": [
        {
            "sha": "e9eb5ab758de26ebf2abee8bdda0ba130035d0f8",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 56,
            "deletions": 53,
            "changes": 109,
            "blob_url": "https://github.com/vercel/next.js/blob/72a32c34d6d457e21cb7765f0b82a943bda22165/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/72a32c34d6d457e21cb7765f0b82a943bda22165/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=72a32c34d6d457e21cb7765f0b82a943bda22165",
            "patch": "@@ -1672,48 +1672,45 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n \n             if self.should_track_dependencies() {\n                 // Make all dependencies outdated\n-                enum Dep {\n-                    CurrentCell(CellRef),\n-                    CurrentOutput(TaskId),\n-                    OutdatedCell(CellRef),\n-                    OutdatedOutput(TaskId),\n+                let outdated_cell_dependencies_to_add =\n+                    iter_many!(task, CellDependency { target } => target)\n+                        .collect::<SmallVec<[_; 8]>>();\n+                let outdated_cell_dependencies_to_remove =\n+                    iter_many!(task, OutdatedCellDependency { target } => target)\n+                        .filter(|&target| {\n+                            !task.has_key(&CachedDataItemKey::CellDependency { target })\n+                        })\n+                        .collect::<SmallVec<[_; 8]>>();\n+                task.extend(\n+                    CachedDataItemType::OutdatedCellDependency,\n+                    outdated_cell_dependencies_to_add\n+                        .into_iter()\n+                        .map(|target| CachedDataItem::OutdatedCellDependency { target, value: () }),\n+                );\n+                for target in outdated_cell_dependencies_to_remove {\n+                    task.remove(&CachedDataItemKey::OutdatedCellDependency { target });\n                 }\n-                let dependencies = iter_many!(task, CellDependency { target } => Dep::CurrentCell(target))\n-                    .chain(iter_many!(task, OutputDependency { target } => Dep::CurrentOutput(target)))\n-                    .chain(iter_many!(task, OutdatedCellDependency { target } => Dep::OutdatedCell(target)))\n-                    .chain(iter_many!(task, OutdatedOutputDependency { target } => Dep::OutdatedOutput(target)))\n-                    .collect::<Vec<_>>();\n-                for dep in dependencies {\n-                    match dep {\n-                        Dep::CurrentCell(cell) => {\n-                            let _ = task.add(CachedDataItem::OutdatedCellDependency {\n-                                target: cell,\n-                                value: (),\n-                            });\n-                        }\n-                        Dep::CurrentOutput(output) => {\n-                            let _ = task.add(CachedDataItem::OutdatedOutputDependency {\n-                                target: output,\n-                                value: (),\n-                            });\n-                        }\n-                        Dep::OutdatedCell(cell) => {\n-                            if !task.has_key(&CachedDataItemKey::CellDependency { target: cell }) {\n-                                task.remove(&CachedDataItemKey::OutdatedCellDependency {\n-                                    target: cell,\n-                                });\n-                            }\n-                        }\n-                        Dep::OutdatedOutput(output) => {\n-                            if !task\n-                                .has_key(&CachedDataItemKey::OutputDependency { target: output })\n-                            {\n-                                task.remove(&CachedDataItemKey::OutdatedOutputDependency {\n-                                    target: output,\n-                                });\n-                            }\n-                        }\n-                    }\n+\n+                let outdated_output_dependencies_to_add =\n+                    iter_many!(task, OutputDependency { target } => target)\n+                        .collect::<SmallVec<[_; 8]>>();\n+                let outdated_output_dependencies_to_remove =\n+                    iter_many!(task, OutdatedOutputDependency { target } => target)\n+                        .filter(|&target| {\n+                            !task.has_key(&CachedDataItemKey::OutputDependency { target })\n+                        })\n+                        .collect::<SmallVec<[_; 8]>>();\n+                task.extend(\n+                    CachedDataItemType::OutdatedOutputDependency,\n+                    outdated_output_dependencies_to_add\n+                        .into_iter()\n+                        .map(|target| CachedDataItem::OutdatedOutputDependency {\n+                            target,\n+                            value: (),\n+                        }),\n+                );\n+                for target in outdated_output_dependencies_to_remove {\n+                    task.remove(&CachedDataItemKey::OutdatedOutputDependency { target });\n                 }\n             }\n         }\n@@ -1949,21 +1946,27 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n         let old_counters: FxHashMap<_, _> =\n             get_many!(task, CellTypeMaxIndex { cell_type } max_index => (cell_type, *max_index));\n         let mut counters_to_remove = old_counters.clone();\n-        for (&cell_type, &max_index) in cell_counters.iter() {\n-            if let Some(old_max_index) = counters_to_remove.remove(&cell_type) {\n-                if old_max_index != max_index {\n-                    task.insert(CachedDataItem::CellTypeMaxIndex {\n+\n+        task.extend(\n+            CachedDataItemType::CellTypeMaxIndex,\n+            cell_counters.iter().filter_map(|(&cell_type, &max_index)| {\n+                if let Some(old_max_index) = counters_to_remove.remove(&cell_type) {\n+                    if old_max_index != max_index {\n+                        Some(CachedDataItem::CellTypeMaxIndex {\n+                            cell_type,\n+                            value: max_index,\n+                        })\n+                    } else {\n+                        None\n+                    }\n+                } else {\n+                    Some(CachedDataItem::CellTypeMaxIndex {\n                         cell_type,\n                         value: max_index,\n-                    });\n+                    })\n                 }\n-            } else {\n-                task.add_new(CachedDataItem::CellTypeMaxIndex {\n-                    cell_type,\n-                    value: max_index,\n-                });\n-            }\n-        }\n+            }),\n+        );\n         for (cell_type, _) in counters_to_remove {\n             task.remove(&CachedDataItemKey::CellTypeMaxIndex { cell_type });\n         }"
        }
    ],
    "stats": {
        "total": 109,
        "additions": 56,
        "deletions": 53
    }
}