{
    "author": "ijjk",
    "message": "Fix fallback: true cache-control (#80865)\n\nThis ensures we don't treat cache hits for lazily generated `fallback:\ntrue` routes as the fallback itself which has a different cache-control\nheader than cache hits should.\n\nFixes: https://github.com/vercel/next.js/issues/80838",
    "sha": "925fd916efc2d239a6dbc07d8dd9eb0c898fcd45",
    "files": [
        {
            "sha": "8e6475863271e3c5b243ba8f54b1beee66df4a4d",
            "filename": "packages/next/src/build/templates/pages.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/925fd916efc2d239a6dbc07d8dd9eb0c898fcd45/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/925fd916efc2d239a6dbc07d8dd9eb0c898fcd45/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages.ts?ref=925fd916efc2d239a6dbc07d8dd9eb0c898fcd45",
            "patch": "@@ -162,7 +162,7 @@ export async function handler(\n   )\n   const isAmp = query.amp && config.amp\n   let cacheKey: null | string = null\n-  let isIsrFallback = Boolean(getRequestMeta(req, 'isIsrFallback'))\n+  let isIsrFallback = false\n   let isNextDataRequest =\n     prepareResult.isNextDataRequest && (hasStaticProps || hasServerProps)\n \n@@ -530,6 +530,7 @@ export async function handler(\n             // Remove the cache control from the response to prevent it from being\n             // used in the surrounding cache.\n             delete fallbackResponse.cacheControl\n+            fallbackResponse.isMiss = true\n             return fallbackResponse\n           }\n         }\n@@ -586,6 +587,13 @@ export async function handler(\n         prerenderManifest,\n       })\n \n+      // if we got a cache hit this wasn't an ISR fallback\n+      // but it wasn't generated during build so isn't in the\n+      // prerender-manifest\n+      if (isIsrFallback && !result?.isMiss) {\n+        isIsrFallback = false\n+      }\n+\n       // response is finished is no cache entry\n       if (!result) {\n         return\n@@ -629,7 +637,6 @@ export async function handler(\n               `Invalid revalidate configuration provided: ${result.cacheControl.revalidate} < 1`\n             )\n           }\n-\n           cacheControl = {\n             revalidate: result.cacheControl.revalidate,\n             expire: result.cacheControl?.expire ?? nextConfig.expireTime,"
        },
        {
            "sha": "4fda015d42c8c5e88ef3e189fd6edf2504c4f52c",
            "filename": "test/e2e/prerender.test.ts",
            "status": "modified",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/925fd916efc2d239a6dbc07d8dd9eb0c898fcd45/test%2Fe2e%2Fprerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/925fd916efc2d239a6dbc07d8dd9eb0c898fcd45/test%2Fe2e%2Fprerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender.test.ts?ref=925fd916efc2d239a6dbc07d8dd9eb0c898fcd45",
            "patch": "@@ -302,6 +302,13 @@ describe('Prerender', () => {\n     //   initialRevalidateSeconds: false,\n     //   srcRoute: null,\n     // },\n+    '/fallback-true/first': {\n+      allowHeader,\n+      dataRoute: `/_next/data/${next.buildId}/fallback-true/first.json`,\n+      initialExpireSeconds: 31536000,\n+      initialRevalidateSeconds: 2,\n+      srcRoute: '/fallback-true/[slug]',\n+    },\n     '/lang/de/about': {\n       allowHeader,\n       dataRoute: `/_next/data/${next.buildId}/lang/de/about.json`,\n@@ -676,6 +683,72 @@ describe('Prerender', () => {\n             : 's-maxage=2, stale-while-revalidate=31535998'\n         )\n       })\n+\n+      it('should use correct caching headers for a fallback-true page (prerendered)', async () => {\n+        const initialRes = await fetchViaHTTP(next.url, '/fallback-true/first')\n+        expect(initialRes.status).toBe(200)\n+        expect(initialRes.headers.get('cache-control')).toBe(\n+          isDeploy\n+            ? 'public, max-age=0, must-revalidate'\n+            : 's-maxage=2, stale-while-revalidate=31535998'\n+        )\n+        expect(await initialRes.text()).not.toContain('hi fallback')\n+\n+        const dataRes = await fetchViaHTTP(\n+          next.url,\n+          `/_next/data/${next.buildId}/fallback-true/first.json`\n+        )\n+        expect(dataRes.status).toBe(200)\n+        expect(dataRes.headers.get('cache-control')).toBe(\n+          isDeploy\n+            ? 'public, max-age=0, must-revalidate'\n+            : 's-maxage=2, stale-while-revalidate=31535998'\n+        )\n+\n+        await retry(async () => {\n+          const finalRes = await fetchViaHTTP(next.url, `/fallback-true/first`)\n+          expect(finalRes.status).toBe(200)\n+          expect(finalRes.headers.get('cache-control')).toBe(\n+            isDeploy\n+              ? 'public, max-age=0, must-revalidate'\n+              : 's-maxage=2, stale-while-revalidate=31535998'\n+          )\n+          expect(await finalRes.text()).not.toContain('hi fallback')\n+        })\n+      })\n+\n+      it('should use correct caching headers for a fallback-true page (lazy)', async () => {\n+        const initialRes = await fetchViaHTTP(next.url, '/fallback-true/second')\n+        expect(initialRes.status).toBe(200)\n+        expect(initialRes.headers.get('cache-control')).toBe(\n+          isDeploy\n+            ? 'public, max-age=0, must-revalidate'\n+            : 'private, no-cache, no-store, max-age=0, must-revalidate'\n+        )\n+        expect(await initialRes.text()).toContain('hi fallback')\n+\n+        const dataRes = await fetchViaHTTP(\n+          next.url,\n+          `/_next/data/${next.buildId}/fallback-true/second.json`\n+        )\n+        expect(dataRes.status).toBe(200)\n+        expect(dataRes.headers.get('cache-control')).toBe(\n+          isDeploy\n+            ? 'public, max-age=0, must-revalidate'\n+            : 's-maxage=2, stale-while-revalidate=31535998'\n+        )\n+\n+        await retry(async () => {\n+          const finalRes = await fetchViaHTTP(next.url, `/fallback-true/second`)\n+          expect(finalRes.status).toBe(200)\n+          expect(finalRes.headers.get('cache-control')).toBe(\n+            isDeploy\n+              ? 'public, max-age=0, must-revalidate'\n+              : 's-maxage=2, stale-while-revalidate=31535998'\n+          )\n+          expect(await finalRes.text()).not.toContain('hi fallback')\n+        })\n+      })\n     }\n \n     it('should navigate to a normal page and back', async () => {\n@@ -1545,6 +1618,16 @@ describe('Prerender', () => {\n             //   ),\n             //   page: '/index',\n             // },\n+            {\n+              dataRouteRegex: normalizeRegEx(\n+                `^\\\\/_next\\\\/data\\\\/${escapeRegex(next.buildId)}\\\\/fallback\\\\-true\\\\/([^\\\\/]+?)\\\\.json$`\n+              ),\n+              namedDataRouteRegex: `^/_next/data/${escapeRegex(next.buildId)}/fallback\\\\-true/(?<nxtPslug>[^/]+?)\\\\.json$`,\n+              page: '/fallback-true/[slug]',\n+              routeKeys: {\n+                nxtPslug: 'nxtPslug',\n+              },\n+            },\n             {\n               namedDataRouteRegex: `^/_next/data/${escapeRegex(\n                 next.buildId\n@@ -1740,6 +1823,17 @@ describe('Prerender', () => {\n               ),\n               allowHeader,\n             },\n+            '/fallback-true/[slug]': {\n+              allowHeader,\n+              dataRoute: `/_next/data/${next.buildId}/fallback-true/[slug].json`,\n+              dataRouteRegex: normalizeRegEx(\n+                `^\\\\/_next\\\\/data\\\\/${escapedBuildId}\\\\/fallback\\\\-true\\\\/([^\\\\/]+?)\\\\.json$`\n+              ),\n+              fallback: '/fallback-true/[slug].html',\n+              routeRegex: normalizeRegEx(\n+                '^\\\\/fallback\\\\-true\\\\/([^\\\\/]+?)(?:\\\\/)?$'\n+              ),\n+            },\n             '/lang/[lang]/about': {\n               dataRoute: `/_next/data/${next.buildId}/lang/[lang]/about.json`,\n               dataRouteRegex: normalizeRegEx("
        },
        {
            "sha": "c349980254f2d397489e11f3222f070daf397e1d",
            "filename": "test/e2e/prerender/pages/fallback-true/[slug].js",
            "status": "added",
            "additions": 40,
            "deletions": 0,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/925fd916efc2d239a6dbc07d8dd9eb0c898fcd45/test%2Fe2e%2Fprerender%2Fpages%2Ffallback-true%2F%5Bslug%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/925fd916efc2d239a6dbc07d8dd9eb0c898fcd45/test%2Fe2e%2Fprerender%2Fpages%2Ffallback-true%2F%5Bslug%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender%2Fpages%2Ffallback-true%2F%5Bslug%5D.js?ref=925fd916efc2d239a6dbc07d8dd9eb0c898fcd45",
            "patch": "@@ -0,0 +1,40 @@\n+import Link from 'next/link'\n+import { useRouter } from 'next/router'\n+\n+export async function getStaticPaths() {\n+  return {\n+    paths: ['/fallback-true/first'],\n+    fallback: true,\n+  }\n+}\n+\n+export async function getStaticProps({ params }) {\n+  return {\n+    props: {\n+      params,\n+      hello: 'world',\n+      post: params.slug,\n+      random: Math.random(),\n+      time: (await import('perf_hooks')).performance.now(),\n+    },\n+    revalidate: 2,\n+  }\n+}\n+\n+export default ({ post, time, params }) => {\n+  if (useRouter().isFallback) {\n+    return <p>hi fallback</p>\n+  }\n+\n+  return (\n+    <>\n+      <p>Post: {post}</p>\n+      <span>time: {time}</span>\n+      <div id=\"params\">{JSON.stringify(params)}</div>\n+      <div id=\"query\">{JSON.stringify(useRouter().query)}</div>\n+      <Link href=\"/\" id=\"home\">\n+        to home\n+      </Link>\n+    </>\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 145,
        "additions": 143,
        "deletions": 2
    }
}