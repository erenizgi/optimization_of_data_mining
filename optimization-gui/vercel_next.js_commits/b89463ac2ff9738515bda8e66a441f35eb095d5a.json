{
    "author": "unstubbable",
    "message": "Prerender with streaming metadata during revalidation (#80245)\n\nDuring the export phase of `next build` we're hard-coding\n`serveStreamingMetadata` to `true`, so we need to do the same during\nrevalidation.\n\nOtherwise we're checking the user agent to decide if we should serve\nstreaming metadata.\n\nThis fixes a hydration error that occurred when hydrating the resumed\nPPR shell. The error was not present for the initial resume of the\nprerendered shell, and only after the shell was revalidated once.",
    "sha": "b89463ac2ff9738515bda8e66a441f35eb095d5a",
    "files": [
        {
            "sha": "13e1f3c613b5493bfb8afa49921fcea78e2d6c86",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 10,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/b89463ac2ff9738515bda8e66a441f35eb095d5a/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b89463ac2ff9738515bda8e66a441f35eb095d5a/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=b89463ac2ff9738515bda8e66a441f35eb095d5a",
            "patch": "@@ -233,16 +233,6 @@ export async function handler(\n   const botType = getBotType(userAgent)\n   const isHtmlBot = isHtmlBotRequest(req)\n   const shouldWaitOnAllReady = isHtmlBot && isRoutePPREnabled\n-  let serveStreamingMetadata = shouldServeStreamingMetadata(\n-    userAgent,\n-    // @ts-expect-error update for readonly\n-    nextConfig.htmlLimitedBots\n-  )\n-\n-  if (isHtmlBot && isRoutePPREnabled) {\n-    isIsr = false\n-    serveStreamingMetadata = false\n-  }\n \n   // If this is a dynamic route with PPR enabled and the default route\n   // matches were set, then we should pass the fallback route params to\n@@ -314,6 +304,24 @@ export async function handler(\n   const isRevalidate =\n     isIsr && !supportsDynamicResponse && !postponed && !isDynamicRSCRequest\n \n+  let serveStreamingMetadata =\n+    // During the export phase of `next build` we're hard-coding\n+    // `serveStreamingMetadata` to `true`, so we need to do the same during\n+    // revalidation.\n+    isRevalidate ||\n+    // Otherwise we're checking the user agent to decide if we should\n+    // serve streaming metadata.\n+    shouldServeStreamingMetadata(\n+      userAgent,\n+      // @ts-expect-error update for readonly\n+      nextConfig.htmlLimitedBots\n+    )\n+\n+  if (isHtmlBot && isRoutePPREnabled) {\n+    isIsr = false\n+    serveStreamingMetadata = false\n+  }\n+\n   const method = req.method || 'GET'\n   const tracer = getTracer()\n   const activeSpan = tracer.getActiveScopeSpan()"
        },
        {
            "sha": "37cc128dd0ee9221566087ef4895ab1b13d8a25c",
            "filename": "test/e2e/app-dir/ppr-metadata-streaming/app/partially-static/page.tsx",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/b89463ac2ff9738515bda8e66a441f35eb095d5a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fapp%2Fpartially-static%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/b89463ac2ff9738515bda8e66a441f35eb095d5a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fapp%2Fpartially-static%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fapp%2Fpartially-static%2Fpage.tsx?ref=b89463ac2ff9738515bda8e66a441f35eb095d5a",
            "patch": "@@ -0,0 +1,28 @@\n+import { unstable_cacheLife as cacheLife } from 'next/cache'\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+async function Dynamic() {\n+  await connection()\n+\n+  return <p>Dynamic</p>\n+}\n+\n+async function getCachedDate() {\n+  'use cache'\n+\n+  cacheLife({ revalidate: 1, expire: 5 * 60 })\n+\n+  return new Date().toISOString()\n+}\n+\n+export default async function Page() {\n+  return (\n+    <div>\n+      <Suspense fallback={<p>Loading...</p>}>\n+        <Dynamic />\n+      </Suspense>\n+      <p id=\"date\">{await getCachedDate()}</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "bea0706290af6bfcb4d7dfbd29c8f6acfbc78477",
            "filename": "test/e2e/app-dir/ppr-metadata-streaming/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b89463ac2ff9738515bda8e66a441f35eb095d5a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b89463ac2ff9738515bda8e66a441f35eb095d5a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fnext.config.js?ref=b89463ac2ff9738515bda8e66a441f35eb095d5a",
            "patch": "@@ -4,6 +4,7 @@\n const nextConfig = {\n   experimental: {\n     ppr: true,\n+    useCache: true,\n   },\n }\n "
        },
        {
            "sha": "b1a328430e981f8aed91a9c47e8361aec978a295",
            "filename": "test/e2e/app-dir/ppr-metadata-streaming/ppr-metadata-streaming.test.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 6,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/b89463ac2ff9738515bda8e66a441f35eb095d5a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b89463ac2ff9738515bda8e66a441f35eb095d5a/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fppr-metadata-streaming%2Fppr-metadata-streaming.test.ts?ref=b89463ac2ff9738515bda8e66a441f35eb095d5a",
            "patch": "@@ -1,6 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n import cheerio from 'cheerio'\n-import { assertNoConsoleErrors } from 'next-test-utils'\n+import { assertNoConsoleErrors, retry } from 'next-test-utils'\n \n function countSubstring(str: string, substr: string): number {\n   return str.split(substr).length - 1\n@@ -19,7 +19,9 @@ describe('ppr-metadata-streaming', () => {\n       expect($(`${rootSelector} title`).text()).toBe('fully static')\n       expect(countSubstring($.html(), '<title>')).toBe(1)\n \n-      const browser = await next.browser('/fully-static')\n+      const browser = await next.browser('/fully-static', {\n+        pushErrorAsConsoleLog: true,\n+      })\n       expect(\n         await browser.waitForElementByCss(`${rootSelector} title`).text()\n       ).toBe('fully static')\n@@ -31,7 +33,9 @@ describe('ppr-metadata-streaming', () => {\n       expect($(`body title`).text()).toBe('dynamic page')\n       expect(countSubstring($.html(), '<title>')).toBe(1)\n \n-      const browser = await next.browser('/dynamic-page')\n+      const browser = await next.browser('/dynamic-page', {\n+        pushErrorAsConsoleLog: true,\n+      })\n       expect(await browser.waitForElementByCss('body title').text()).toBe(\n         'dynamic page'\n       )\n@@ -46,7 +50,9 @@ describe('ppr-metadata-streaming', () => {\n       expect($('body title').text()).toBe('fully dynamic')\n       expect(countSubstring($.html(), '<title>')).toBe(1)\n \n-      const browser = await next.browser('/fully-dynamic')\n+      const browser = await next.browser('/fully-dynamic', {\n+        pushErrorAsConsoleLog: true,\n+      })\n       expect(await browser.waitForElementByCss('body title').text()).toBe(\n         'fully dynamic'\n       )\n@@ -72,7 +78,9 @@ describe('ppr-metadata-streaming', () => {\n       expect($('body title').text()).toBe('dynamic-metadata - partial')\n       expect(countSubstring($.html(), '<title>')).toBe(1)\n \n-      const browser = await next.browser('/dynamic-metadata/partial')\n+      const browser = await next.browser('/dynamic-metadata/partial', {\n+        pushErrorAsConsoleLog: true,\n+      })\n       expect(await browser.waitForElementByCss('body title').text()).toBe(\n         'dynamic-metadata - partial'\n       )\n@@ -85,12 +93,31 @@ describe('ppr-metadata-streaming', () => {\n       expect($(`${rootSelector} title`).text()).toBe('dynamic-page - partial')\n       expect(countSubstring($.html(), '<title>')).toBe(1)\n \n-      const browser = await next.browser('/dynamic-page/partial')\n+      const browser = await next.browser('/dynamic-page/partial', {\n+        pushErrorAsConsoleLog: true,\n+      })\n       expect(\n         await browser.waitForElementByCss(`${rootSelector} title`).text()\n       ).toBe('dynamic-page - partial')\n       await assertNoConsoleErrors(browser)\n     })\n+\n+    it('should not yield hydration errors after revalidation', async () => {\n+      const browser = await next.browser('/partially-static', {\n+        pushErrorAsConsoleLog: true,\n+      })\n+\n+      const initialDate = await browser.elementById('date').text()\n+\n+      // Wait for the background revalidation to complete.\n+      await retry(async () => {\n+        await browser.refresh()\n+        expect(await browser.elementById('date').text()).not.toBe(initialDate)\n+      })\n+\n+      // There should be no hydration errors after the revalidation.\n+      await assertNoConsoleErrors(browser)\n+    })\n   })\n \n   // Skip the deployment tests for html limited bots"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 80,
        "deletions": 16
    }
}