{
    "author": "unstubbable",
    "message": "Simplify running test apps locally with `ppr` or `dynamicIO` enabled (#81668)\n\nWe want to respect the `__NEXT_EXPERIMENTAL_PPR` and `__NEXT_EXPERIMENTAL_CACHE_COMPONENTS` environment variables in the test apps, so that we can run them locally with these features enabled without needing to modify the config files.\r\n\r\nSo we're removing the requirement that `__NEXT_TEST_MODE` needs to be set at the same time. Usually you don't want to set this variable locally because it also changes other behavior in a few places.\r\n\r\nThis really has no downside, because it was already possible for users to set both variables and affect the flags, and now this can be done with a single variable. It allows us to keep the noise out of the test app's next config files.\r\n\r\nWe're also moving the assignments from the default config into `enforceExperimentalFeatures` to get the nice output when printing the experimental features in the CLI.",
    "sha": "d8fdb6ffa85269a9696ca905a5ee39d8ae737701",
    "files": [
        {
            "sha": "3f318b04fcb08f765bd6c052531682e988efb12b",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 31,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=d8fdb6ffa85269a9696ca905a5ee39d8ae737701",
            "patch": "@@ -1392,19 +1392,7 @@ export const defaultConfig = Object.freeze({\n     serverSourceMaps: false,\n     linkNoTouchStart: false,\n     caseSensitiveRoutes: false,\n-    clientSegmentCache:\n-      // TODO: Remove once we've made clientSegmentCache the default. We're\n-      // piggybacking on the PPR test flag, instead of introducing a separate\n-      // CI run.\n-      //\n-      // If we're testing, and the `__NEXT_EXPERIMENTAL_PPR` environment\n-      // variable has been set to `true`, enable the experimental\n-      // clientSegmentCache feature so long as it wasn't explicitly disabled in\n-      // the config.\n-      !!(\n-        process.env.__NEXT_TEST_MODE &&\n-        process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n-      ),\n+    clientSegmentCache: false,\n     dynamicOnHover: false,\n     appDocumentPreloading: undefined,\n     preloadEntriesOnStart: true,\n@@ -1449,15 +1437,7 @@ export const defaultConfig = Object.freeze({\n     clientTraceMetadata: undefined,\n     parallelServerCompiles: false,\n     parallelServerBuildTraces: false,\n-    ppr:\n-      // TODO: remove once we've made PPR default\n-      // If we're testing, and the `__NEXT_EXPERIMENTAL_PPR` environment variable\n-      // has been set to `true`, enable the experimental PPR feature so long as it\n-      // wasn't explicitly disabled in the config.\n-      !!(\n-        process.env.__NEXT_TEST_MODE &&\n-        process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n-      ),\n+    ppr: false,\n     authInterrupts: false,\n     webpackBuildWorker: undefined,\n     webpackMemoryOptimizations: false,\n@@ -1478,15 +1458,7 @@ export const defaultConfig = Object.freeze({\n     serverComponentsHmrCache: true,\n     staticGenerationMaxConcurrency: 8,\n     staticGenerationMinPagesPerWorker: 25,\n-    dynamicIO:\n-      // TODO: remove once we've made dynamicIO the default\n-      // If we're testing, and the `__NEXT_EXPERIMENTAL_CACHE_COMPONENTS` environment\n-      // variable has been set to `true`, enable the experimental dynamicIO feature so long as it\n-      // wasn't explicitly disabled in the config.\n-      !!(\n-        process.env.__NEXT_TEST_MODE &&\n-        process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true'\n-      ),\n+    dynamicIO: false,\n     inlineCss: false,\n     useCache: undefined,\n     slowModuleDetection: undefined,"
        },
        {
            "sha": "d0a4085f702575702d75d9f007d83489536c4459",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 101,
            "deletions": 33,
            "changes": 134,
            "blob_url": "https://github.com/vercel/next.js/blob/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=d8fdb6ffa85269a9696ca905a5ee39d8ae737701",
            "patch": "@@ -240,21 +240,6 @@ function assignDefaults(\n     {}\n   ) as NextConfig & { configFileName: string }\n \n-  // TODO: remove these once we've made PPR default\n-  // If this was defaulted to true, it implies that the configuration was\n-  // overridden for testing to be defaulted on.\n-  if (defaultConfig.experimental?.ppr) {\n-    Log.warn(\n-      `\\`experimental.ppr\\` has been defaulted to \\`true\\` because \\`__NEXT_EXPERIMENTAL_PPR\\` was set to \\`true\\` during testing.`\n-    )\n-  }\n-\n-  if (defaultConfig.experimental?.dynamicIO) {\n-    Log.warn(\n-      `\\`experimental.dynamicIO\\` has been defaulted to \\`true\\` because \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\` was set to \\`true\\` during testing.`\n-    )\n-  }\n-\n   const result = {\n     ...defaultConfig,\n     ...config,\n@@ -1416,6 +1401,7 @@ export default async function loadConfig(\n     }\n \n     enforceExperimentalFeatures(userConfig, {\n+      isDefaultConfig: false,\n       configuredExperimentalFeatures: reportExperimentalFeatures\n         ? configuredExperimentalFeatures\n         : undefined,\n@@ -1464,6 +1450,7 @@ export default async function loadConfig(\n   const clonedDefaultConfig = cloneObject(defaultConfig) as NextConfig\n \n   enforceExperimentalFeatures(clonedDefaultConfig, {\n+    isDefaultConfig: true,\n     configuredExperimentalFeatures: reportExperimentalFeatures\n       ? configuredExperimentalFeatures\n       : undefined,\n@@ -1497,29 +1484,18 @@ export type ConfiguredExperimentalFeature = {\n function enforceExperimentalFeatures(\n   config: NextConfig,\n   options: {\n+    isDefaultConfig: boolean\n     configuredExperimentalFeatures: ConfiguredExperimentalFeature[] | undefined\n     debugPrerender: boolean | undefined\n     phase: string\n   }\n ) {\n-  const { configuredExperimentalFeatures, debugPrerender, phase } = options\n-\n-  if (\n-    config.experimental &&\n-    config.experimental.enablePrerenderSourceMaps === undefined &&\n-    config.experimental.dynamicIO === true\n-  ) {\n-    config.experimental.enablePrerenderSourceMaps = true\n-\n-    if (configuredExperimentalFeatures) {\n-      addConfiguredExperimentalFeature(\n-        configuredExperimentalFeatures,\n-        'enablePrerenderSourceMaps',\n-        true,\n-        'enabled by `experimental.dynamicIO`'\n-      )\n-    }\n-  }\n+  const {\n+    configuredExperimentalFeatures,\n+    debugPrerender,\n+    isDefaultConfig,\n+    phase,\n+  } = options\n \n   config.experimental ??= {}\n \n@@ -1555,6 +1531,98 @@ function enforceExperimentalFeatures(\n       configuredExperimentalFeatures\n     )\n   }\n+\n+  // TODO: Remove this once we've made Cache Components the default.\n+  if (\n+    process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true' &&\n+    // We do respect an explicit value in the user config.\n+    (config.experimental.ppr === undefined ||\n+      (isDefaultConfig && !config.experimental.ppr))\n+  ) {\n+    config.experimental.ppr = true\n+\n+    if (configuredExperimentalFeatures) {\n+      addConfiguredExperimentalFeature(\n+        configuredExperimentalFeatures,\n+        'ppr',\n+        true,\n+        'enabled by `__NEXT_EXPERIMENTAL_CACHE_COMPONENTS`'\n+      )\n+    }\n+  }\n+\n+  // TODO: Remove this once we've made Cache Components the default.\n+  if (\n+    process.env.__NEXT_EXPERIMENTAL_PPR === 'true' &&\n+    // We do respect an explicit value in the user config.\n+    (config.experimental.ppr === undefined ||\n+      (isDefaultConfig && !config.experimental.ppr))\n+  ) {\n+    config.experimental.ppr = true\n+\n+    if (configuredExperimentalFeatures) {\n+      addConfiguredExperimentalFeature(\n+        configuredExperimentalFeatures,\n+        'ppr',\n+        true,\n+        'enabled by `__NEXT_EXPERIMENTAL_PPR`'\n+      )\n+    }\n+  }\n+\n+  // TODO: Remove this once we've made Client Segment Cache the default.\n+  if (\n+    process.env.__NEXT_EXPERIMENTAL_PPR === 'true' &&\n+    // We do respect an explicit value in the user config.\n+    (config.experimental.clientSegmentCache === undefined ||\n+      (isDefaultConfig && !config.experimental.clientSegmentCache))\n+  ) {\n+    config.experimental.clientSegmentCache = true\n+\n+    if (configuredExperimentalFeatures) {\n+      addConfiguredExperimentalFeature(\n+        configuredExperimentalFeatures,\n+        'clientSegmentCache',\n+        true,\n+        'enabled by `__NEXT_EXPERIMENTAL_PPR`'\n+      )\n+    }\n+  }\n+\n+  // TODO: Remove this once we've made Cache Components the default.\n+  if (\n+    process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true' &&\n+    // We do respect an explicit value in the user config.\n+    (config.experimental.dynamicIO === undefined ||\n+      (isDefaultConfig && !config.experimental.dynamicIO))\n+  ) {\n+    config.experimental.dynamicIO = true\n+\n+    if (configuredExperimentalFeatures) {\n+      addConfiguredExperimentalFeature(\n+        configuredExperimentalFeatures,\n+        'dynamicIO',\n+        true,\n+        'enabled by `__NEXT_EXPERIMENTAL_CACHE_COMPONENTS`'\n+      )\n+    }\n+  }\n+\n+  if (\n+    config.experimental.enablePrerenderSourceMaps === undefined &&\n+    config.experimental.dynamicIO === true\n+  ) {\n+    config.experimental.enablePrerenderSourceMaps = true\n+\n+    if (configuredExperimentalFeatures) {\n+      addConfiguredExperimentalFeature(\n+        configuredExperimentalFeatures,\n+        'enablePrerenderSourceMaps',\n+        true,\n+        'enabled by `experimental.dynamicIO`'\n+      )\n+    }\n+  }\n }\n \n function addConfiguredExperimentalFeature<"
        },
        {
            "sha": "764910abfc29b5749de108f8367dc093465af907",
            "filename": "test/cache-components-tests-manifest.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fcache-components-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fcache-components-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fcache-components-tests-manifest.json?ref=d8fdb6ffa85269a9696ca905a5ee39d8ae737701",
            "patch": "@@ -250,6 +250,7 @@\n       \"test/e2e/app-dir/segment-cache/basic/segment-cache-basic.test.ts\",\n       \"test/e2e/app-dir/segment-cache/client-only-opt-in/client-only-opt-in.test.ts\",\n       \"test/e2e/app-dir/segment-cache/conflicting-routes/conflicting-routes.test.ts\",\n+      \"test/e2e/app-dir/segment-cache/deployment-skew/deployment-skew.test.ts\",\n       \"test/e2e/app-dir/segment-cache/export/segment-cache-output-export.test.ts\",\n       \"test/e2e/app-dir/segment-cache/incremental-opt-in/segment-cache-incremental-opt-in.test.ts\",\n       \"test/e2e/app-dir/segment-cache/memory-pressure/segment-cache-memory-pressure.test.ts\",\n@@ -333,7 +334,6 @@\n       \"test/production/app-dir/actions-tree-shaking/reexport/reexport.test.ts\",\n       \"test/production/app-dir/actions-tree-shaking/use-effect-actions/use-effect-actions-edge.test.ts\",\n       \"test/production/app-dir/app-fetch-build-cache/app-fetch-build-cache.test.ts\",\n-      \"test/production/app-dir/build-output-prerender/build-output-prerender.test.ts\",\n       \"test/production/app-dir/build-output-tree-view/build-output-tree-view.test.ts\",\n       \"test/production/app-dir/build-output/index.test.ts\",\n       \"test/production/app-dir/client-components-tree-shaking/index.test.ts\","
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/node-extensions/fixtures/random/legacy/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 5,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fe2e%2Fapp-dir%2Fnode-extensions%2Ffixtures%2Frandom%2Flegacy%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fe2e%2Fapp-dir%2Fnode-extensions%2Ffixtures%2Frandom%2Flegacy%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnode-extensions%2Ffixtures%2Frandom%2Flegacy%2Fnext.config.js?ref=d8fdb6ffa85269a9696ca905a5ee39d8ae737701",
            "patch": "@@ -1,10 +1,6 @@\n /**\n  * @type {import('next').NextConfig}\n  */\n-const nextConfig = {\n-  experimental: {\n-    ppr: process.env.__NEXT_EXPERIMENTAL_PPR === 'true',\n-  },\n-}\n+const nextConfig = {}\n \n module.exports = nextConfig"
        },
        {
            "sha": "dd2e95b8393dba556c7d99cbf2ffb53e52cf25d6",
            "filename": "test/e2e/app-dir/use-cache-standalone-search-params/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fe2e%2Fapp-dir%2Fuse-cache-standalone-search-params%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fe2e%2Fapp-dir%2Fuse-cache-standalone-search-params%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-standalone-search-params%2Fnext.config.js?ref=d8fdb6ffa85269a9696ca905a5ee39d8ae737701",
            "patch": "@@ -5,7 +5,6 @@ const nextConfig = {\n   experimental: {\n     useCache: true,\n     prerenderEarlyExit: false,\n-    ppr: process.env.__NEXT_EXPERIMENTAL_PPR === 'true',\n   },\n }\n "
        },
        {
            "sha": "e871667c89a5db5548cdddf17afb1d5a09f28668",
            "filename": "test/e2e/app-dir/use-cache/next.config.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fnext.config.js?ref=d8fdb6ffa85269a9696ca905a5ee39d8ae737701",
            "patch": "@@ -3,7 +3,6 @@\n  */\n const nextConfig = {\n   experimental: {\n-    ppr: process.env.__NEXT_EXPERIMENTAL_PPR === 'true',\n     useCache: true,\n     cacheLife: {\n       frequent: {"
        },
        {
            "sha": "22a9a8a4c05e2818b6e3b89764a06f191cff2e0e",
            "filename": "test/production/app-dir/build-output-prerender/build-output-prerender.test.ts",
            "status": "modified",
            "additions": 261,
            "deletions": 68,
            "changes": 329,
            "blob_url": "https://github.com/vercel/next.js/blob/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d8fdb6ffa85269a9696ca905a5ee39d8ae737701/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts?ref=d8fdb6ffa85269a9696ca905a5ee39d8ae737701",
            "patch": "@@ -2,6 +2,11 @@ import { nextTestSetup } from 'e2e-utils'\n import path from 'path'\n const { version: nextVersion } = require('next/package.json')\n \n+const cacheComponentsEnabled =\n+  process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true'\n+\n+const pprEnabled = process.env.__NEXT_EXPERIMENTAL_PPR === 'true'\n+\n describe('build-output-prerender', () => {\n   describe('with a next config file', () => {\n     describe('without --debug-prerender', () => {\n@@ -12,21 +17,63 @@ describe('build-output-prerender', () => {\n \n       beforeAll(() => next.build())\n \n-      it('prints only the user-selected experimental flags', async () => {\n-        if (isTurbopack) {\n-          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-           \"▲ Next.js x.y.z (Turbopack)\n-              - Experiments (use with caution):\n-                ✓ dynamicIO\n-                ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n-          `)\n+      it('prints only the user-selected experimental flags (and the ones enabled via env variable)', async () => {\n+        if (cacheComponentsEnabled) {\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ dynamicIO\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ dynamicIO\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+            `)\n+          }\n+        } else if (pprEnabled) {\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ dynamicIO\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ dynamicIO\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+            `)\n+          }\n         } else {\n-          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-           \"▲ Next.js x.y.z\n-              - Experiments (use with caution):\n-                ✓ dynamicIO\n-                ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n-          `)\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ dynamicIO\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ dynamicIO\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+            `)\n+          }\n         }\n       })\n \n@@ -70,28 +117,86 @@ describe('build-output-prerender', () => {\n       beforeAll(() => next.build())\n \n       it('prints a warning and the customized experimental flags', async () => {\n-        if (isTurbopack) {\n-          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-           \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-              ▲ Next.js x.y.z (Turbopack)\n-              - Experiments (use with caution):\n-                ✓ dynamicIO\n-                ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n-                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n-                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n-                ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n-          `)\n+        if (cacheComponentsEnabled) {\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ dynamicIO\n+                  ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ dynamicIO\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          }\n+        } else if (pprEnabled) {\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ dynamicIO\n+                  ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ dynamicIO\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          }\n         } else {\n-          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-           \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-              ▲ Next.js x.y.z\n-              - Experiments (use with caution):\n-                ✓ dynamicIO\n-                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n-                ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n-                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n-                ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n-          `)\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ dynamicIO\n+                  ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ dynamicIO\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          }\n         }\n       })\n \n@@ -164,15 +269,53 @@ describe('build-output-prerender', () => {\n \n       beforeAll(() => next.build())\n \n-      it('prints no experimental flags', async () => {\n-        if (isTurbopack) {\n-          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n-            `\"▲ Next.js x.y.z (Turbopack)\"`\n-          )\n+      it('prints no experimental flags (unless enabled via env variable)', async () => {\n+        if (cacheComponentsEnabled) {\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ dynamicIO (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ dynamicIO (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+            `)\n+          }\n+        } else if (pprEnabled) {\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\"\n+            `)\n+          }\n         } else {\n-          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n-            `\"▲ Next.js x.y.z\"`\n-          )\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n+              `\"▲ Next.js x.y.z (Turbopack)\"`\n+            )\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n+              `\"▲ Next.js x.y.z\"`\n+            )\n+          }\n         }\n       })\n     })\n@@ -187,26 +330,82 @@ describe('build-output-prerender', () => {\n       beforeAll(() => next.build())\n \n       it('prints a warning and the customized experimental flags', async () => {\n-        if (isTurbopack) {\n-          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-           \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-              ▲ Next.js x.y.z (Turbopack)\n-              - Experiments (use with caution):\n-                ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n-                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n-                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n-                ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n-          `)\n+        if (cacheComponentsEnabled) {\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ dynamicIO (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ dynamicIO (enabled by \\`__NEXT_EXPERIMENTAL_CACHE_COMPONENTS\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          }\n+        } else if (pprEnabled) {\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ ppr (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ clientSegmentCache (enabled by \\`__NEXT_EXPERIMENTAL_PPR\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          }\n         } else {\n-          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-           \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-              ▲ Next.js x.y.z\n-              - Experiments (use with caution):\n-                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n-                ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n-                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n-                ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n-          `)\n+          if (isTurbopack) {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z (Turbopack)\n+                - Experiments (use with caution):\n+                  ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          } else {\n+            expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+             \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+                ▲ Next.js x.y.z\n+                - Experiments (use with caution):\n+                  ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                  ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                  ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                  ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+            `)\n+          }\n         }\n       })\n     })\n@@ -221,12 +420,6 @@ function getPreambleOutput(cliOutput: string): string {\n       break\n     }\n \n-    // Ignore the test-only warning that `experimental.ppr` has been defaulted\n-    // to `true` when `__NEXT_EXPERIMENTAL_PPR` is set to `true`.\n-    if (line.includes('__NEXT_EXPERIMENTAL_PPR')) {\n-      continue\n-    }\n-\n     lines.push(line.replace(nextVersion, 'x.y.z'))\n   }\n "
        }
    ],
    "stats": {
        "total": 507,
        "additions": 367,
        "deletions": 140
    }
}