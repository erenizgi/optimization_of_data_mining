{
    "author": "styfle",
    "message": "feat(next/image): support `new URL()` for `images.remotePatterns` (#77692)\n\nConfiguring `remotePatterns` can be a hassle because you have to define\neach of the parts. And if you forget a part, its a wildcard meaning it\nwill match anything. This is usually not desirable since most remote\nimages don't allow query strings.\n\nThis PR adds support for using an array of `URL` objects when defining\n`images.remotePatterns`.\n\n```js\nmodule.exports = {\n  images: {\n    remotePatterns: [\n      new URL('https://res.cloudinary.com/my-account/**'),\n      new URL('https://s3.my-account.*.amazonaws.com/**'),\n    ],\n  },\n}\n```\n\nNote that wildcards must be explicit and anything missing is assumed to\nno longer match.",
    "sha": "c9e238edf9e9c894cd3c241eceff02c7b72228ad",
    "files": [
        {
            "sha": "a5b1e9d60970c04428e9183238027d25cea5fa97",
            "filename": "docs/01-app/04-api-reference/02-components/image.mdx",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/docs%2F01-app%2F04-api-reference%2F02-components%2Fimage.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/docs%2F01-app%2F04-api-reference%2F02-components%2Fimage.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F04-api-reference%2F02-components%2Fimage.mdx?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -520,6 +520,16 @@ module.exports = {\n \n To protect your application from malicious users, configuration is required in order to use external images. This ensures that only external images from your account can be served from the Next.js Image Optimization API. These external images can be configured with the `remotePatterns` property in your `next.config.js` file, as shown below:\n \n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    remotePatterns: [new URL('https://example.com/account123/**')],\n+  },\n+}\n+```\n+\n+Versions of Next.js prior to 15.3.0 can configure `remotePatterns` using the object:\n+\n ```js filename=\"next.config.js\"\n module.exports = {\n   images: {\n@@ -1106,6 +1116,7 @@ This `next/image` component uses browser native [lazy loading](https://caniuse.c\n \n | Version    | Changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |\n | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |\n+| `v15.3.0`  | `remotePatterns` added support for array of `URL` objects.                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\n | `v15.0.0`  | `contentDispositionType` configuration default changed to `attachment`.                                                                                                                                                                                                                                                                                                                                                                                                                                       |\n | `v14.2.23` | `qualities` configuration added.                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |\n | `v14.2.15` | `decoding` prop added and `localPatterns` configuration added.                                                                                                                                                                                                                                                                                                                                                                                                                                                |"
        },
        {
            "sha": "019b39516ec416c8959fc5c2d0dd860d7f390d7e",
            "filename": "errors/next-image-unconfigured-host.mdx",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/errors%2Fnext-image-unconfigured-host.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/errors%2Fnext-image-unconfigured-host.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/errors%2Fnext-image-unconfigured-host.mdx?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -10,6 +10,21 @@ One of your pages that leverages the `next/image` component, passed a `src` valu\n \n Add the protocol, hostname, port, and pathname to the `images.remotePatterns` config in `next.config.js`:\n \n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    remotePatterns: [new URL('https://assets.example.com/account123/**')],\n+  },\n+}\n+```\n+\n+### Fixing older versions of Next.js\n+\n+<details>\n+  <summary>Using Next.js prior to 15.3.0?</summary>\n+  \n+Older versions of Next.js can configure `images.remotePatterns` using the object:\n+\n ```js filename=\"next.config.js\"\n module.exports = {\n   images: {\n@@ -26,7 +41,7 @@ module.exports = {\n }\n ```\n \n-### Fixing older versions of Next.js\n+</details>\n \n <details>\n   <summary>Using Next.js prior to 12.3.0?</summary>"
        },
        {
            "sha": "5b0f9f58fbf0c63c5ad37fc423dd657e2a758f1a",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -668,5 +668,6 @@\n   \"667\": \"receiveExpiredTags is deprecated, and not expected to be called.\",\n   \"668\": \"Internal Next.js error: Router action dispatched before initialization.\",\n   \"669\": \"Invariant: --turbopack is set but the build used Webpack\",\n-  \"670\": \"Invariant: --turbopack is not set but the build used Turbopack. Add --turbopack to \\\"next start\\\".\"\n+  \"670\": \"Invariant: --turbopack is not set but the build used Turbopack. Add --turbopack to \\\"next start\\\".\",\n+  \"671\": \"Specified images.remotePatterns must have protocol \\\"http\\\" or \\\"https\\\" received \\\"%s\\\".\"\n }"
        },
        {
            "sha": "3f2f5841825e5cf1092b8b4aaf7790cf6c6316a5",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -582,7 +582,7 @@ async function writeImagesManifest(\n   // By default, remotePatterns will allow no remote images ([])\n   images.remotePatterns = (config?.images?.remotePatterns || []).map((p) => ({\n     // Modifying the manifest should also modify matchRemotePattern()\n-    protocol: p.protocol,\n+    protocol: p.protocol?.replace(/:$/, '') as 'http' | 'https' | undefined,\n     hostname: makeRe(p.hostname).source,\n     port: p.port,\n     pathname: makeRe(p.pathname ?? '**', { dot: true }).source,"
        },
        {
            "sha": "e468a2a9603732ebb2897f376936167561f3d5d9",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -525,13 +525,16 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n           .optional(),\n         remotePatterns: z\n           .array(\n-            z.strictObject({\n-              hostname: z.string(),\n-              pathname: z.string().optional(),\n-              port: z.string().max(5).optional(),\n-              protocol: z.enum(['http', 'https']).optional(),\n-              search: z.string().optional(),\n-            })\n+            z.union([\n+              z.instanceof(URL),\n+              z.strictObject({\n+                hostname: z.string(),\n+                pathname: z.string().optional(),\n+                port: z.string().max(5).optional(),\n+                protocol: z.enum(['http', 'https']).optional(),\n+                search: z.string().optional(),\n+              }),\n+            ])\n           )\n           .max(50)\n           .optional(),"
        },
        {
            "sha": "bfa3b11bf7b3f0778ca365e2b704b5c347762bd1",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -364,6 +364,27 @@ function assignDefaults(\n         )\n       }\n \n+      // We must convert URL to RemotePattern since URL has a colon in the protocol\n+      // and also has additional properties we want to filter out. Also, new URL()\n+      // accepts any protocol so we need manual validation here.\n+      images.remotePatterns = images.remotePatterns.map(\n+        ({ protocol, hostname, port, pathname, search }) => {\n+          const proto = protocol?.replace(/:$/, '')\n+          if (!['http', 'https', undefined].includes(proto)) {\n+            throw new Error(\n+              `Specified images.remotePatterns must have protocol \"http\" or \"https\" received \"${proto}\".`\n+            )\n+          }\n+          return {\n+            protocol: proto as 'http' | 'https' | undefined,\n+            hostname,\n+            port,\n+            pathname,\n+            search,\n+          }\n+        }\n+      )\n+\n       // static images are automatically prefixed with assetPrefix\n       // so we need to ensure _next/image allows downloading from\n       // this resource"
        },
        {
            "sha": "e4766485fe3627971de6380e30de41f2705e9b56",
            "filename": "packages/next/src/shared/lib/image-config.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -113,7 +113,7 @@ export type ImageConfigComplete = {\n   contentDispositionType: 'inline' | 'attachment'\n \n   /** @see [Remote Patterns](https://nextjs.org/docs/api-reference/next/image#remotepatterns) */\n-  remotePatterns: RemotePattern[]\n+  remotePatterns: Array<URL | RemotePattern>\n \n   /** @see [Remote Patterns](https://nextjs.org/docs/api-reference/next/image#localPatterns) */\n   localPatterns: LocalPattern[] | undefined"
        },
        {
            "sha": "657d8224a012c32979fa01088ead1e5f84958643",
            "filename": "packages/next/src/shared/lib/match-remote-pattern.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmatch-remote-pattern.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmatch-remote-pattern.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fmatch-remote-pattern.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -2,10 +2,12 @@ import type { RemotePattern } from './image-config'\n import { makeRe } from 'next/dist/compiled/picomatch'\n \n // Modifying this function should also modify writeImagesManifest()\n-export function matchRemotePattern(pattern: RemotePattern, url: URL): boolean {\n+export function matchRemotePattern(\n+  pattern: RemotePattern | URL,\n+  url: URL\n+): boolean {\n   if (pattern.protocol !== undefined) {\n-    const actualProto = url.protocol.slice(0, -1)\n-    if (pattern.protocol !== actualProto) {\n+    if (pattern.protocol.replace(/:$/, '') !== url.protocol.replace(/:$/, '')) {\n       return false\n     }\n   }\n@@ -41,7 +43,7 @@ export function matchRemotePattern(pattern: RemotePattern, url: URL): boolean {\n \n export function hasRemoteMatch(\n   domains: string[],\n-  remotePatterns: RemotePattern[],\n+  remotePatterns: Array<RemotePattern | URL>,\n   url: URL\n ): boolean {\n   return ("
        },
        {
            "sha": "dd7057b8a3534342bc271a4d83d5e453179a2580",
            "filename": "test/e2e/app-dir/next-image/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/0959f7e52689fa4339ba3fbbacea542083f5760c/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0959f7e52689fa4339ba3fbbacea542083f5760c/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.js?ref=0959f7e52689fa4339ba3fbbacea542083f5760c",
            "patch": "@@ -1,5 +0,0 @@\n-module.exports = {\n-  images: {\n-    remotePatterns: [{ hostname: 'image-optimization-test.vercel.app' }],\n-  },\n-}"
        },
        {
            "sha": "c0e1ac45c73e5d25b5da3fe3fba9dd9bc265b8fe",
            "filename": "test/e2e/app-dir/next-image/next.config.ts",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-image%2Fnext.config.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -0,0 +1,9 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  images: {\n+    remotePatterns: [new URL('https://image-optimization-test.vercel.app/**')],\n+  },\n+}\n+\n+export default nextConfig"
        },
        {
            "sha": "03b42fcf8a71c426eafdff36c35cac6e16490d4d",
            "filename": "test/integration/image-optimizer/test/index.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Fintegration%2Fimage-optimizer%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Fintegration%2Fimage-optimizer%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Findex.test.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -567,6 +567,27 @@ describe('Image Optimizer', () => {\n       )\n     })\n \n+    it('should error when images.remotePatterns URL has invalid protocol', async () => {\n+      await nextConfig.replace(\n+        '{ /* replaceme */ }',\n+        `{ images: { remotePatterns: [new URL('file://example.com/**')] } }`\n+      )\n+      let stderr = ''\n+\n+      app = await launchApp(appDir, await findPort(), {\n+        onStderr(msg) {\n+          stderr += msg || ''\n+        },\n+      })\n+      await waitFor(1000)\n+      await killApp(app).catch(() => {})\n+      await nextConfig.restore()\n+\n+      expect(stderr).toContain(\n+        `Specified images.remotePatterns must have protocol \"http\" or \"https\" received \"file\"`\n+      )\n+    })\n+\n     it('should error when images.contentDispositionType is not valid', async () => {\n       await nextConfig.replace(\n         '{ /* replaceme */ }',"
        },
        {
            "sha": "348ea37d659dcac8f9e3690c765a1080295950eb",
            "filename": "test/integration/next-image-new/unicode/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Fintegration%2Fnext-image-new%2Funicode%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Fintegration%2Fnext-image-new%2Funicode%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Funicode%2Fnext.config.js?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -1,5 +1,5 @@\n module.exports = {\n   images: {\n-    remotePatterns: [{ hostname: 'image-optimization-test.vercel.app' }],\n+    remotePatterns: [new URL('https://image-optimization-test.vercel.app/**')],\n   },\n }"
        },
        {
            "sha": "518779839a31d93e70f76a5e1ef52dd5e687e91e",
            "filename": "test/integration/next-image-new/unicode/test/index.test.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 3,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -2,6 +2,7 @@\n \n import {\n   findPort,\n+  getImagesManifest,\n   killApp,\n   launchApp,\n   nextBuild,\n@@ -17,7 +18,7 @@ let appPort\n let app\n let browser\n \n-function runTests() {\n+function runTests(mode: 'server' | 'dev') {\n   it('should load static unicode image', async () => {\n     const src = await browser.elementById('static').getAttribute('src')\n     expect(src).toMatch(\n@@ -65,6 +66,45 @@ function runTests() {\n     const res = await fetch(fullSrc)\n     expect(res.status).toBe(200)\n   })\n+  if (mode === 'server') {\n+    it('should build correct images-manifest.json', async () => {\n+      const manifest = getImagesManifest(appDir)\n+      expect(manifest).toEqual({\n+        version: 1,\n+        images: {\n+          contentDispositionType: 'attachment',\n+          contentSecurityPolicy:\n+            \"script-src 'none'; frame-src 'none'; sandbox;\",\n+          dangerouslyAllowSVG: false,\n+          deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],\n+          disableStaticImages: false,\n+          domains: [],\n+          formats: ['image/webp'],\n+          imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],\n+          loader: 'default',\n+          loaderFile: '',\n+          remotePatterns: [\n+            {\n+              protocol: 'https',\n+              hostname:\n+                '^(?:^(?:image\\\\-optimization\\\\-test\\\\.vercel\\\\.app)$)$',\n+              port: '',\n+              pathname:\n+                '^(?:\\\\/(?!\\\\.{1,2}(?:\\\\/|$))(?:(?:(?!(?:^|\\\\/)\\\\.{1,2}(?:\\\\/|$)).)*?))$',\n+              search: '',\n+            },\n+          ],\n+          minimumCacheTTL: 60,\n+          path: '/_next/image',\n+          sizes: [\n+            640, 750, 828, 1080, 1200, 1920, 2048, 3840, 16, 32, 48, 64, 96,\n+            128, 256, 384,\n+          ],\n+          unoptimized: false,\n+        },\n+      })\n+    })\n+  }\n }\n \n describe('Image Component Unicode Image URL', () => {\n@@ -82,7 +122,7 @@ describe('Image Component Unicode Image URL', () => {\n           browser.close()\n         }\n       })\n-      runTests()\n+      runTests('dev')\n     }\n   )\n   ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n@@ -100,7 +140,7 @@ describe('Image Component Unicode Image URL', () => {\n           browser.close()\n         }\n       })\n-      runTests()\n+      runTests('server')\n     }\n   )\n })"
        },
        {
            "sha": "d0910990ce033bcfd481362f4b3996ba3c4d9140",
            "filename": "test/unit/image-optimizer/match-remote-pattern-with-url.test.ts",
            "status": "added",
            "additions": 318,
            "deletions": 0,
            "changes": 318,
            "blob_url": "https://github.com/vercel/next.js/blob/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Funit%2Fimage-optimizer%2Fmatch-remote-pattern-with-url.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c9e238edf9e9c894cd3c241eceff02c7b72228ad/test%2Funit%2Fimage-optimizer%2Fmatch-remote-pattern-with-url.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fimage-optimizer%2Fmatch-remote-pattern-with-url.test.ts?ref=c9e238edf9e9c894cd3c241eceff02c7b72228ad",
            "patch": "@@ -0,0 +1,318 @@\n+/* eslint-env jest */\n+import { matchRemotePattern as m } from 'next/dist/shared/lib/match-remote-pattern'\n+\n+describe('matchRemotePattern with URL', () => {\n+  it('should match literal protocol, hostname, no port, no search', () => {\n+    const p = new URL('https://example.com/**')\n+    expect(m(p, new URL('https://example.com'))).toBe(true)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to/file'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('http://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('ftp://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('http://example.com:81/path/to/file'))).toBe(false)\n+  })\n+\n+  it('should match literal protocol, hostname, port 42', () => {\n+    const p = new URL('https://example.com:42/**')\n+    expect(m(p, new URL('https://example.com:42'))).toBe(true)\n+    expect(m(p, new URL('https://example.com.uk:42'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com:42'))).toBe(false)\n+    expect(m(p, new URL('https://com:42'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path/to/file'))).toBe(true)\n+    expect(m(p, new URL('https://example.com:42/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('http://example.com:42/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('ftp://example.com:42/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('http://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('ftp://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81/path/to/file?q=1'))).toBe(false)\n+  })\n+\n+  it('should match literal protocol, hostname, port, pathname', () => {\n+    const p = new URL('https://example.com:42/path/to/file')\n+    expect(m(p, new URL('https://example.com:42'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk:42'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com:42'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path/to'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path/to/file'))).toBe(true)\n+    expect(m(p, new URL('https://example.com:42/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('http://example.com:42/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('ftp://example.com:42/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('http://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('ftp://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81/path/to/file?q=1'))).toBe(false)\n+  })\n+\n+  it('should match literal protocol, hostname, port, pathname, search', () => {\n+    const p = new URL(\n+      'https://example.com:42/path/to/file?q=1&a=two&s=!@$^&-_+/()[]{};:~'\n+    )\n+    expect(m(p, new URL('https://example.com:42'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk:42'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com:42'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path/to'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('http://example.com:42/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('ftp://example.com:42/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('http://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('ftp://example.com/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81/path/to/file'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:81/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path/to/file?q=1'))).toBe(false)\n+    expect(m(p, new URL('https://example.com:42/path/to/file?q=1&a=two'))).toBe(\n+      false\n+    )\n+    expect(\n+      m(p, new URL('https://example.com:42/path/to/file?q=1&a=two&s'))\n+    ).toBe(false)\n+    expect(\n+      m(p, new URL('https://example.com:42/path/to/file?q=1&a=two&s='))\n+    ).toBe(false)\n+    expect(\n+      m(p, new URL('https://example.com:42/path/to/file?q=1&a=two&s=!@'))\n+    ).toBe(false)\n+    expect(\n+      m(\n+        p,\n+        new URL(\n+          'https://example.com:42/path/to/file?q=1&a=two&s=!@$^&-_+/()[]{};:~'\n+        )\n+      )\n+    ).toBe(true)\n+    expect(\n+      m(\n+        p,\n+        new URL(\n+          'https://example.com:42/path/to/file?q=1&s=!@$^&-_+/()[]{};:~&a=two'\n+        )\n+      )\n+    ).toBe(false)\n+    expect(\n+      m(\n+        p,\n+        new URL(\n+          'https://example.com:42/path/to/file?a=two&q=1&s=!@$^&-_+/()[]{};:~'\n+        )\n+      )\n+    ).toBe(false)\n+  })\n+\n+  it('should match hostname pattern with single asterisk by itself', () => {\n+    const p = new URL('https://avatars.*.example.com')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.sfo1.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://avatars.iad1.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://more.avatars.iad1.example.com'))).toBe(false)\n+  })\n+\n+  it('should match hostname pattern with single asterisk at beginning', () => {\n+    const p = new URL('https://avatars.*1.example.com')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.sfo1.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://avatars.iad1.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://more.avatars.iad1.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.sfo2.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.iad2.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.1.example.com'))).toBe(true)\n+  })\n+\n+  it('should match hostname pattern with single asterisk in middle', () => {\n+    const p = new URL('https://avatars.*a*.example.com')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.sfo1.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.iad1.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://more.avatars.iad1.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.sfo2.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.iad2.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://avatars.a.example.com'))).toBe(true)\n+  })\n+\n+  it('should match hostname pattern with single asterisk at end', () => {\n+    const p = new URL('https://avatars.ia*.example.com')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.sfo1.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.iad1.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://more.avatars.iad1.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.sfo2.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.iad2.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://avatars.ia.example.com'))).toBe(true)\n+  })\n+\n+  it('should match hostname pattern with double asterisk', () => {\n+    const p = new URL('https://**.example.com')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://deep.sub.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://avatars.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://avatars.sfo1.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://avatars.iad1.example.com'))).toBe(true)\n+    expect(m(p, new URL('https://more.avatars.iad1.example.com'))).toBe(true)\n+  })\n+\n+  it('should match pathname pattern with single asterisk by itself', () => {\n+    const p = new URL('https://example.com/act123/*/pic.jpg')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/picsjpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr5/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr6/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/team/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act456/team/pic.jpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/.a/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/team/usr4/pic.jpg'))).toBe(\n+      false\n+    )\n+    expect(m(p, new URL('https://example.com/team/pic.jpg'))).toBe(false)\n+  })\n+\n+  it('should match pathname pattern with single asterisk at the beginning', () => {\n+    const p = new URL('https://example.com/act123/*4/pic.jpg')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/picsjpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr5/pic.jpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/team4/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act456/team5/pic.jpg'))).toBe(\n+      false\n+    )\n+    expect(m(p, new URL('https://example.com/team/pic.jpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/4/pic.jpg'))).toBe(true)\n+  })\n+\n+  it('should match pathname pattern with single asterisk in the middle', () => {\n+    const p = new URL('https://example.com/act123/*sr*/pic.jpg')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/picsjpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr5/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/.sr6/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/team4/pic.jpg'))).toBe(\n+      false\n+    )\n+    expect(m(p, new URL('https://example.com/act123/team5/pic.jpg'))).toBe(\n+      false\n+    )\n+    expect(m(p, new URL('https://example.com/team/pic.jpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/sr/pic.jpg'))).toBe(true)\n+  })\n+\n+  it('should match pathname pattern with single asterisk at the end', () => {\n+    const p = new URL('https://example.com/act123/usr*/pic.jpg')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/picsjpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr5/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/team4/pic.jpg'))).toBe(\n+      false\n+    )\n+    expect(m(p, new URL('https://example.com/act456/team5/pic.jpg'))).toBe(\n+      false\n+    )\n+    expect(m(p, new URL('https://example.com/team/pic.jpg'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com/act123/usr6/pic.jpg'))).toBe(\n+      false\n+    )\n+  })\n+\n+  it('should match pathname pattern with double asterisk', () => {\n+    const p = new URL('https://example.com/act123/**')\n+    expect(m(p, new URL('https://com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com'))).toBe(false)\n+    expect(m(p, new URL('https://example.com.uk'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/act123'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr4'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr4/picsjpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr4/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr5/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/usr6/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/team/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/.a/pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act123/team/.pic.jpg'))).toBe(true)\n+    expect(m(p, new URL('https://example.com/act456/team/pic.jpg'))).toBe(false)\n+    expect(m(p, new URL('https://example.com/team/pic.jpg'))).toBe(false)\n+    expect(m(p, new URL('https://sub.example.com/act123/team/pic.jpg'))).toBe(\n+      false\n+    )\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 484,
        "additions": 460,
        "deletions": 24
    }
}