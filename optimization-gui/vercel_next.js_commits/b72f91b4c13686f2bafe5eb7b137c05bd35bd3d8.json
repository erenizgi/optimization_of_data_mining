{
    "author": "devjiwonchoi",
    "message": "[ts-next-plugin] remove typescript vfs and related metadata plugin (#78237)\n\nPR https://github.com/vercel/next.js/pull/77213 introduced replacing the\ncustom language service and host with the `@typescript/vfs` package. It\ndid improve performance for large codebases, but it is still a problem\nwhen the plugin is initialized multiple times with multiple virtual\nlanguage services from multiple apps, resulting in **freezing the IDE**.\n\nWhy did we need the \"virtual language service\" in the first place? It\nwas to support features like providing completions and diagnostics for\nmetadata export without explicitly setting the type. To achieve this, we\nstored a copy of the file in the virtual language service with the\nadditional type:\n\n```diff\n- export const metadata = {}\n+ export const metadata: Metadata | null = {}\n```\n\nHowever, the trade-off loss is big compared to the win, and it can\neasily be replaced by importing the actual type â€” which is rational. We\nshould carefully reconsider the support details and revisit the\nimprovement. It could be a combination of semantic suggestion/warning to\nadd type and auto-importing.\n\nAs the first step, this PR removes the `@typescript/vfs` package and the\nmetadata plugin features that depend on it.",
    "sha": "b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8",
    "files": [
        {
            "sha": "cd91759875e6accfd8a5917ad50d84955a15a86b",
            "filename": "packages/next/package.json",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fpackage.json?ref=b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8",
            "patch": "@@ -218,7 +218,6 @@\n     \"@types/ua-parser-js\": \"0.7.36\",\n     \"@types/webpack-sources1\": \"npm:@types/webpack-sources@0.1.5\",\n     \"@types/ws\": \"8.2.0\",\n-    \"@typescript/vfs\": \"1.6.1\",\n     \"@vercel/ncc\": \"0.34.0\",\n     \"@vercel/nft\": \"0.27.1\",\n     \"@vercel/turbopack-ecmascript-runtime\": \"*\","
        },
        {
            "sha": "9f2bf75b16d0192b299ef5be6d1ddc9759ac162d",
            "filename": "packages/next/src/compiled/@typescript/vfs/LICENSE",
            "status": "removed",
            "additions": 0,
            "deletions": 17,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/ce6f60a0eb76b6fcf89cfbeda98d5b120807c287/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2FLICENSE",
            "raw_url": "https://github.com/vercel/next.js/raw/ce6f60a0eb76b6fcf89cfbeda98d5b120807c287/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2FLICENSE",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2FLICENSE?ref=ce6f60a0eb76b6fcf89cfbeda98d5b120807c287",
            "patch": "@@ -1,17 +0,0 @@\n-The MIT License (MIT)\n-Copyright (c) Microsoft Corporation\n-\n-Permission is hereby granted, free of charge, to any person obtaining a copy of this software and \n-associated documentation files (the \"Software\"), to deal in the Software without restriction, \n-including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, \n-and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, \n-subject to the following conditions:\n-\n-The above copyright notice and this permission notice shall be included in all copies or substantial \n-portions of the Software.\n-\n-THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT \n-NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. \n-IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, \n-WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE \n-SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE."
        },
        {
            "sha": "b1d8d243e2de7c5214229fd298d46d2353f18657",
            "filename": "packages/next/src/compiled/@typescript/vfs/index.js",
            "status": "removed",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ce6f60a0eb76b6fcf89cfbeda98d5b120807c287/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ce6f60a0eb76b6fcf89cfbeda98d5b120807c287/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Findex.js?ref=ce6f60a0eb76b6fcf89cfbeda98d5b120807c287",
            "patch": "@@ -1 +0,0 @@\n-(()=>{\"use strict\";var t={188:(t,r,i)=>{if(process.env.NODE_ENV===\"production\"){t.exports=i(994)}else{t.exports=i(121)}},121:(t,r,i)=>{Object.defineProperty(r,\"__esModule\",{value:true});function _extends(){_extends=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var i=arguments[r];for(var p in i){if(Object.prototype.hasOwnProperty.call(i,p)){t[p]=i[p]}}}return t};return _extends.apply(this,arguments)}var p=false;try{p=typeof localStorage!==\"undefined\"}catch(t){}var m=typeof process!==\"undefined\";var g=p&&localStorage.getItem(\"DEBUG\")||m&&process.env.DEBUG;var v=g?console.log:function(t){return\"\"};function createVirtualTypeScriptEnvironment(t,r,i,p,m){if(p===void 0){p={}}var g=_extends({},w(i),p);var v=createVirtualLanguageServiceHost(t,r,g,i,m),y=v.languageServiceHost,h=v.updateFile,F=v.deleteFile;var x=i.createLanguageService(y);var S=x.getCompilerOptionsDiagnostics();if(S.length){var E=createVirtualCompilerHost(t,p,i);throw new Error(i.formatDiagnostics(S,E.compilerHost))}return{name:\"vfs\",sys:t,languageService:x,getSourceFile:function getSourceFile(t){var r;return(r=x.getProgram())==null?void 0:r.getSourceFile(t)},createFile:function createFile(t,r){h(i.createSourceFile(t,r,g.target,false))},updateFile:function updateFile(t,r,p){var m=x.getProgram().getSourceFile(t);if(!m){throw new Error(\"Did not find a source file for \"+t)}var g=m.text;var v=p!=null?p:i.createTextSpan(0,g.length);var y=g.slice(0,v.start)+r+g.slice(v.start+v.length);var F=i.updateSourceFile(m,y,{span:v,newLength:r.length});h(F)},deleteFile:function deleteFile(t){var r=x.getProgram().getSourceFile(t);if(r){F(r)}}}}var y=function knownLibFilesForCompilerOptions(t,r){var i=t.target||r.ScriptTarget.ES5;var p=t.lib||[];var m=[\"lib.d.ts\",\"lib.core.d.ts\",\"lib.decorators.d.ts\",\"lib.decorators.legacy.d.ts\",\"lib.dom.asynciterable.d.ts\",\"lib.dom.d.ts\",\"lib.dom.iterable.d.ts\",\"lib.webworker.asynciterable.d.ts\",\"lib.webworker.d.ts\",\"lib.webworker.importscripts.d.ts\",\"lib.webworker.iterable.d.ts\",\"lib.scripthost.d.ts\",\"lib.es5.d.ts\",\"lib.es6.d.ts\",\"lib.es7.d.ts\",\"lib.core.es6.d.ts\",\"lib.core.es7.d.ts\",\"lib.es2015.collection.d.ts\",\"lib.es2015.core.d.ts\",\"lib.es2015.d.ts\",\"lib.es2015.generator.d.ts\",\"lib.es2015.iterable.d.ts\",\"lib.es2015.promise.d.ts\",\"lib.es2015.proxy.d.ts\",\"lib.es2015.reflect.d.ts\",\"lib.es2015.symbol.d.ts\",\"lib.es2015.symbol.wellknown.d.ts\",\"lib.es2016.array.include.d.ts\",\"lib.es2016.d.ts\",\"lib.es2016.full.d.ts\",\"lib.es2016.intl.d.ts\",\"lib.es2017.arraybuffer.d.ts\",\"lib.es2017.d.ts\",\"lib.es2017.date.d.ts\",\"lib.es2017.full.d.ts\",\"lib.es2017.intl.d.ts\",\"lib.es2017.object.d.ts\",\"lib.es2017.sharedmemory.d.ts\",\"lib.es2017.string.d.ts\",\"lib.es2017.typedarrays.d.ts\",\"lib.es2018.asyncgenerator.d.ts\",\"lib.es2018.asynciterable.d.ts\",\"lib.es2018.d.ts\",\"lib.es2018.full.d.ts\",\"lib.es2018.intl.d.ts\",\"lib.es2018.promise.d.ts\",\"lib.es2018.regexp.d.ts\",\"lib.es2019.array.d.ts\",\"lib.es2019.d.ts\",\"lib.es2019.full.d.ts\",\"lib.es2019.intl.d.ts\",\"lib.es2019.object.d.ts\",\"lib.es2019.string.d.ts\",\"lib.es2019.symbol.d.ts\",\"lib.es2020.bigint.d.ts\",\"lib.es2020.d.ts\",\"lib.es2020.date.d.ts\",\"lib.es2020.full.d.ts\",\"lib.es2020.intl.d.ts\",\"lib.es2020.number.d.ts\",\"lib.es2020.promise.d.ts\",\"lib.es2020.sharedmemory.d.ts\",\"lib.es2020.string.d.ts\",\"lib.es2020.symbol.wellknown.d.ts\",\"lib.es2021.d.ts\",\"lib.es2021.full.d.ts\",\"lib.es2021.intl.d.ts\",\"lib.es2021.promise.d.ts\",\"lib.es2021.string.d.ts\",\"lib.es2021.weakref.d.ts\",\"lib.es2022.array.d.ts\",\"lib.es2022.d.ts\",\"lib.es2022.error.d.ts\",\"lib.es2022.full.d.ts\",\"lib.es2022.intl.d.ts\",\"lib.es2022.object.d.ts\",\"lib.es2022.regexp.d.ts\",\"lib.es2022.sharedmemory.d.ts\",\"lib.es2022.string.d.ts\",\"lib.es2023.array.d.ts\",\"lib.es2023.collection.d.ts\",\"lib.es2023.d.ts\",\"lib.es2023.full.d.ts\",\"lib.es2023.intl.d.ts\",\"lib.es2024.arraybuffer.d.ts\",\"lib.es2024.collection.d.ts\",\"lib.es2024.d.ts\",\"lib.es2024.full.d.ts\",\"lib.es2024.object.d.ts\",\"lib.es2024.promise.d.ts\",\"lib.es2024.regexp.d.ts\",\"lib.es2024.sharedmemory.d.ts\",\"lib.es2024.string.d.ts\",\"lib.esnext.array.d.ts\",\"lib.esnext.asynciterable.d.ts\",\"lib.esnext.bigint.d.ts\",\"lib.esnext.collection.d.ts\",\"lib.esnext.d.ts\",\"lib.esnext.decorators.d.ts\",\"lib.esnext.disposable.d.ts\",\"lib.esnext.float16.d.ts\",\"lib.esnext.full.d.ts\",\"lib.esnext.intl.d.ts\",\"lib.esnext.iterator.d.ts\",\"lib.esnext.object.d.ts\",\"lib.esnext.promise.d.ts\",\"lib.esnext.regexp.d.ts\",\"lib.esnext.string.d.ts\",\"lib.esnext.symbol.d.ts\",\"lib.esnext.weakref.d.ts\"];var g=r.ScriptTarget[i];var v=m.filter((function(t){return t.startsWith(\"lib.\"+g.toLowerCase())}));var y=m.indexOf(v.pop());var h=function getMax(t){return t&&t.length?t.reduce((function(t,r){return r>t?r:t})):undefined};var F=p.map((function(t){var r=m.filter((function(r){return r.startsWith(\"lib.\"+t.toLowerCase())}));if(r.length===0)return 0;var i=m.indexOf(r.pop());return i}));var x=h(F)||0;var S=Math.max(y,x);return m.slice(0,S+1)};var h=function createDefaultMapFromNodeModules(t,r,p){var m=D();var g=C();var v=function getLib(t){var r=p||m.dirname(i.ab+\"typescript.js\");return g.readFileSync(m.join(r,t),\"utf8\")};var y=function isDtsFile(t){return/\\.d\\.([^\\.]+\\.)?[cm]?ts$/i.test(t)};var h=g.readdirSync(p||m.dirname(i.ab+\"typescript.js\"));var F=h.filter((function(t){return t.startsWith(\"lib.\")&&y(t)}));var x=new Map;F.forEach((function(t){x.set(\"/\"+t,v(t))}));return x};var F=function addAllFilesFromFolder(t,r){var i=D();var p=C();var m=function walk(t){var r=[];var m=p.readdirSync(t);m.forEach((function(m){m=i.join(t,m);var g=p.statSync(m);if(g&&g.isDirectory()){r=r.concat(walk(m))}else{r.push(m)}}));return r};var g=m(r);g.forEach((function(m){var g=\"/node_modules/@types\"+m.replace(r,\"\");var v=p.readFileSync(m,\"utf8\");var y=[\".ts\",\".tsx\"];if(y.includes(i.extname(g))){t.set(g,v)}}))};var x=function addFilesForTypesIntoFolder(t){return F(t,\"node_modules/@types\")};var S=function createDefaultMapFromCDN(t,r,i,p,m,g,v){var h=g||fetch;var F=new Map;var x=y(t,p);var S=\"https://playgroundcdn.typescriptlang.org/cdn/\"+r+\"/typescript/lib/\";function zip(t){return m?m.compressToUTF16(t):t}function unzip(t){return m?m.decompressFromUTF16(t):t}function uncached(){return Promise.all(x.map((function(t){return h(S+t).then((function(t){return t.text()}))}))).then((function(t){t.forEach((function(t,r){return F.set(\"/\"+x[r],t)}))}))[\"catch\"]((function(){}))}function cached(){var t=v||localStorage;var i=Object.keys(t);i.forEach((function(i){if(i.startsWith(\"ts-lib-\")&&!i.startsWith(\"ts-lib-\"+r)){t.removeItem(i)}}));return Promise.all(x.map((function(i){var p=\"ts-lib-\"+r+\"-\"+i;var m=t.getItem(p);if(!m){return h(S+i).then((function(t){return t.text()})).then((function(r){t.setItem(p,zip(r));return r}))[\"catch\"]((function(){}))}else{return Promise.resolve(unzip(m))}}))).then((function(t){t.forEach((function(t,r){if(t){var i=\"/\"+x[r];F.set(i,t)}}))}))}var w=i?cached:uncached;return w().then((function(){return F}))};function notImplemented(t){throw new Error(\"Method '\"+t+\"' is not implemented.\")}function audit(t,r){return function(){for(var i=arguments.length,p=new Array(i),m=0;m<i;m++){p[m]=arguments[m]}var g=r.apply(void 0,p);var y=typeof g===\"string\"?g.slice(0,80)+\"...\":g;v.apply(void 0,[\"> \"+t].concat(p));v(\"< \"+y);return g}}var w=function defaultCompilerOptions(t){return _extends({},t.getDefaultCompilerOptions(),{jsx:t.JsxEmit.React,strict:true,esModuleInterop:true,module:t.ModuleKind.ESNext,suppressOutputPathCheck:true,skipLibCheck:true,skipDefaultLibCheck:true,moduleResolution:t.ModuleResolutionKind.NodeJs})};var E=function libize(t){return t.replace(\"/\",\"/lib.\").toLowerCase()};function createSystem(t){return{args:[],createDirectory:function createDirectory(){return notImplemented(\"createDirectory\")},directoryExists:audit(\"directoryExists\",(function(r){return Array.from(t.keys()).some((function(t){return t.startsWith(r)}))})),exit:function exit(){return notImplemented(\"exit\")},fileExists:audit(\"fileExists\",(function(r){return t.has(r)||t.has(E(r))})),getCurrentDirectory:function getCurrentDirectory(){return\"/\"},getDirectories:function getDirectories(){return[]},getExecutingFilePath:function getExecutingFilePath(){return notImplemented(\"getExecutingFilePath\")},readDirectory:audit(\"readDirectory\",(function(r){return r===\"/\"?Array.from(t.keys()):[]})),readFile:audit(\"readFile\",(function(r){var i;return(i=t.get(r))!=null?i:t.get(E(r))})),resolvePath:function resolvePath(t){return t},newLine:\"\\n\",useCaseSensitiveFileNames:true,write:function write(){return notImplemented(\"write\")},writeFile:function writeFile(r,i){t.set(r,i)},deleteFile:function deleteFile(r){t[\"delete\"](r)}}}function createFSBackedSystem(t,r,p,m){var g=r+\"/vfs\";var v=D();var y=p.sys;var h=m!=null?m:v.dirname(i.ab+\"typescript.js\");return{name:\"fs-vfs\",root:g,args:[],createDirectory:function createDirectory(){return notImplemented(\"createDirectory\")},directoryExists:audit(\"directoryExists\",(function(r){return Array.from(t.keys()).some((function(t){return t.startsWith(r)}))||y.directoryExists(r)})),exit:y.exit,fileExists:audit(\"fileExists\",(function(r){if(t.has(r))return true;if(r.includes(\"tsconfig.json\")||r.includes(\"tsconfig.json\"))return false;if(r.startsWith(\"/lib\")){var i=h+\"/\"+r.replace(\"/\",\"\");return y.fileExists(i)}return y.fileExists(r)})),getCurrentDirectory:function getCurrentDirectory(){return g},getDirectories:y.getDirectories,getExecutingFilePath:function getExecutingFilePath(){return notImplemented(\"getExecutingFilePath\")},readDirectory:audit(\"readDirectory\",(function(){if((arguments.length<=0?undefined:arguments[0])===\"/\"){return Array.from(t.keys())}else{return y.readDirectory.apply(y,arguments)}})),readFile:audit(\"readFile\",(function(r){if(t.has(r))return t.get(r);if(r.startsWith(\"/lib\")){var i=h+\"/\"+r.replace(\"/\",\"\");var p=y.readFile(i);if(!p){var m=y.readDirectory(h);throw new Error(\"TSVFS: A request was made for \"+i+\" but there wasn't a file found in the file map. You likely have a mismatch in the compiler options for the CDN download vs the compiler program. Existing Libs: \"+m+\".\")}return p}return y.readFile(r)})),resolvePath:function resolvePath(r){if(t.has(r))return r;return y.resolvePath(r)},newLine:\"\\n\",useCaseSensitiveFileNames:true,write:function write(){return notImplemented(\"write\")},writeFile:function writeFile(r,i){t.set(r,i)},deleteFile:function deleteFile(r){t[\"delete\"](r)},realpath:y.realpath}}function createVirtualCompilerHost(t,r,i){var p=new Map;var m=function save(t){p.set(t.fileName,t);return t};var g={compilerHost:_extends({},t,{getCanonicalFileName:function getCanonicalFileName(t){return t},getDefaultLibFileName:function getDefaultLibFileName(){return\"/\"+i.getDefaultLibFileName(r)},getNewLine:function getNewLine(){return t.newLine},getSourceFile:function getSourceFile(g,v){var y;return p.get(g)||m(i.createSourceFile(g,t.readFile(g),(y=v!=null?v:r.target)!=null?y:w(i).target,false))},useCaseSensitiveFileNames:function useCaseSensitiveFileNames(){return t.useCaseSensitiveFileNames}}),updateFile:function updateFile(r){var i=p.has(r.fileName);t.writeFile(r.fileName,r.text);p.set(r.fileName,r);return i},deleteFile:function deleteFile(r){var i=p.has(r.fileName);p[\"delete\"](r.fileName);t.deleteFile(r.fileName);return i}};return g}function createVirtualLanguageServiceHost(t,r,i,p,m){var g=[].concat(r);var v=createVirtualCompilerHost(t,i,p),y=v.compilerHost,h=v.updateFile,F=v.deleteFile;var x=new Map;var S=0;var w=_extends({},y,{getProjectVersion:function getProjectVersion(){return S.toString()},getCompilationSettings:function getCompilationSettings(){return i},getCustomTransformers:function getCustomTransformers(){return m},getScriptFileNames:function getScriptFileNames(){return g.slice()},getScriptSnapshot:function getScriptSnapshot(r){var i=t.readFile(r);if(i&&typeof i===\"string\"){return p.ScriptSnapshot.fromString(i)}return},getScriptVersion:function getScriptVersion(t){return x.get(t)||\"0\"},writeFile:t.writeFile});var E={languageServiceHost:w,updateFile:function updateFile(t){S++;x.set(t.fileName,S.toString());if(!g.includes(t.fileName)){g.push(t.fileName)}h(t)},deleteFile:function deleteFile(t){S++;x.set(t.fileName,S.toString());var r=g.indexOf(t.fileName);if(r!==-1){g.splice(r,1)}F(t)}};return E}var D=function requirePath(){return require(String.fromCharCode(112,97,116,104))};var C=function requireFS(){return require(String.fromCharCode(102,115))};r.addAllFilesFromFolder=F;r.addFilesForTypesIntoFolder=x;r.createDefaultMapFromCDN=S;r.createDefaultMapFromNodeModules=h;r.createFSBackedSystem=createFSBackedSystem;r.createSystem=createSystem;r.createVirtualCompilerHost=createVirtualCompilerHost;r.createVirtualLanguageServiceHost=createVirtualLanguageServiceHost;r.createVirtualTypeScriptEnvironment=createVirtualTypeScriptEnvironment;r.knownLibFilesForCompilerOptions=y},994:(t,r,i)=>{function e(){return e=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var i=arguments[r];for(var p in i)Object.prototype.hasOwnProperty.call(i,p)&&(t[p]=i[p])}return t},e.apply(this,arguments)}Object.defineProperty(r,\"__esModule\",{value:!0});var p=!1;try{p=\"undefined\"!=typeof localStorage}catch(e){}var m=\"undefined\"!=typeof process,g=p&&localStorage.getItem(\"DEBUG\")||m&&process.env.DEBUG?console.log:function(t){return\"\"},s=function(t,r){var i,p=t.lib||[],m=[\"lib.d.ts\",\"lib.core.d.ts\",\"lib.decorators.d.ts\",\"lib.decorators.legacy.d.ts\",\"lib.dom.asynciterable.d.ts\",\"lib.dom.d.ts\",\"lib.dom.iterable.d.ts\",\"lib.webworker.asynciterable.d.ts\",\"lib.webworker.d.ts\",\"lib.webworker.importscripts.d.ts\",\"lib.webworker.iterable.d.ts\",\"lib.scripthost.d.ts\",\"lib.es5.d.ts\",\"lib.es6.d.ts\",\"lib.es7.d.ts\",\"lib.core.es6.d.ts\",\"lib.core.es7.d.ts\",\"lib.es2015.collection.d.ts\",\"lib.es2015.core.d.ts\",\"lib.es2015.d.ts\",\"lib.es2015.generator.d.ts\",\"lib.es2015.iterable.d.ts\",\"lib.es2015.promise.d.ts\",\"lib.es2015.proxy.d.ts\",\"lib.es2015.reflect.d.ts\",\"lib.es2015.symbol.d.ts\",\"lib.es2015.symbol.wellknown.d.ts\",\"lib.es2016.array.include.d.ts\",\"lib.es2016.d.ts\",\"lib.es2016.full.d.ts\",\"lib.es2016.intl.d.ts\",\"lib.es2017.arraybuffer.d.ts\",\"lib.es2017.d.ts\",\"lib.es2017.date.d.ts\",\"lib.es2017.full.d.ts\",\"lib.es2017.intl.d.ts\",\"lib.es2017.object.d.ts\",\"lib.es2017.sharedmemory.d.ts\",\"lib.es2017.string.d.ts\",\"lib.es2017.typedarrays.d.ts\",\"lib.es2018.asyncgenerator.d.ts\",\"lib.es2018.asynciterable.d.ts\",\"lib.es2018.d.ts\",\"lib.es2018.full.d.ts\",\"lib.es2018.intl.d.ts\",\"lib.es2018.promise.d.ts\",\"lib.es2018.regexp.d.ts\",\"lib.es2019.array.d.ts\",\"lib.es2019.d.ts\",\"lib.es2019.full.d.ts\",\"lib.es2019.intl.d.ts\",\"lib.es2019.object.d.ts\",\"lib.es2019.string.d.ts\",\"lib.es2019.symbol.d.ts\",\"lib.es2020.bigint.d.ts\",\"lib.es2020.d.ts\",\"lib.es2020.date.d.ts\",\"lib.es2020.full.d.ts\",\"lib.es2020.intl.d.ts\",\"lib.es2020.number.d.ts\",\"lib.es2020.promise.d.ts\",\"lib.es2020.sharedmemory.d.ts\",\"lib.es2020.string.d.ts\",\"lib.es2020.symbol.wellknown.d.ts\",\"lib.es2021.d.ts\",\"lib.es2021.full.d.ts\",\"lib.es2021.intl.d.ts\",\"lib.es2021.promise.d.ts\",\"lib.es2021.string.d.ts\",\"lib.es2021.weakref.d.ts\",\"lib.es2022.array.d.ts\",\"lib.es2022.d.ts\",\"lib.es2022.error.d.ts\",\"lib.es2022.full.d.ts\",\"lib.es2022.intl.d.ts\",\"lib.es2022.object.d.ts\",\"lib.es2022.regexp.d.ts\",\"lib.es2022.sharedmemory.d.ts\",\"lib.es2022.string.d.ts\",\"lib.es2023.array.d.ts\",\"lib.es2023.collection.d.ts\",\"lib.es2023.d.ts\",\"lib.es2023.full.d.ts\",\"lib.es2023.intl.d.ts\",\"lib.es2024.arraybuffer.d.ts\",\"lib.es2024.collection.d.ts\",\"lib.es2024.d.ts\",\"lib.es2024.full.d.ts\",\"lib.es2024.object.d.ts\",\"lib.es2024.promise.d.ts\",\"lib.es2024.regexp.d.ts\",\"lib.es2024.sharedmemory.d.ts\",\"lib.es2024.string.d.ts\",\"lib.esnext.array.d.ts\",\"lib.esnext.asynciterable.d.ts\",\"lib.esnext.bigint.d.ts\",\"lib.esnext.collection.d.ts\",\"lib.esnext.d.ts\",\"lib.esnext.decorators.d.ts\",\"lib.esnext.disposable.d.ts\",\"lib.esnext.float16.d.ts\",\"lib.esnext.full.d.ts\",\"lib.esnext.intl.d.ts\",\"lib.esnext.iterator.d.ts\",\"lib.esnext.object.d.ts\",\"lib.esnext.promise.d.ts\",\"lib.esnext.regexp.d.ts\",\"lib.esnext.string.d.ts\",\"lib.esnext.symbol.d.ts\",\"lib.esnext.weakref.d.ts\"],g=r.ScriptTarget[t.target||r.ScriptTarget.ES5],v=m.filter((function(t){return t.startsWith(\"lib.\"+g.toLowerCase())})),y=m.indexOf(v.pop()),h=p.map((function(t){var r=m.filter((function(r){return r.startsWith(\"lib.\"+t.toLowerCase())}));return 0===r.length?0:m.indexOf(r.pop())})),F=((i=h)&&i.length?i.reduce((function(t,r){return r>t?r:t})):void 0)||0,x=Math.max(y,F);return m.slice(0,x+1)},n=function(t,r){var i=f(),p=b();(function e(t){var r=[];return p.readdirSync(t).forEach((function(m){m=i.join(t,m);var g=p.statSync(m);g&&g.isDirectory()?r=r.concat(e(m)):r.push(m)})),r})(r).forEach((function(m){var g=\"/node_modules/@types\"+m.replace(r,\"\"),v=p.readFileSync(m,\"utf8\");[\".ts\",\".tsx\"].includes(i.extname(g))&&t.set(g,v)}))};function l(t){throw new Error(\"Method '\"+t+\"' is not implemented.\")}function o(t,r){return function(){for(var i=arguments.length,p=new Array(i),m=0;m<i;m++)p[m]=arguments[m];var v=r.apply(void 0,p),y=\"string\"==typeof v?v.slice(0,80)+\"...\":v;return g.apply(void 0,[\"> \"+t].concat(p)),g(\"< \"+y),v}}var a=function(t){return e({},t.getDefaultCompilerOptions(),{jsx:t.JsxEmit.React,strict:!0,esModuleInterop:!0,module:t.ModuleKind.ESNext,suppressOutputPathCheck:!0,skipLibCheck:!0,skipDefaultLibCheck:!0,moduleResolution:t.ModuleResolutionKind.NodeJs})},c=function(t){return t.replace(\"/\",\"/lib.\").toLowerCase()};function u(t,r,i){var p=new Map;return{compilerHost:e({},t,{getCanonicalFileName:function(t){return t},getDefaultLibFileName:function(){return\"/\"+i.getDefaultLibFileName(r)},getNewLine:function(){return t.newLine},getSourceFile:function(m,g){var v,y;return p.get(m)||(y=i.createSourceFile(m,t.readFile(m),null!=(v=null!=g?g:r.target)?v:a(i).target,!1),p.set(y.fileName,y),y)},useCaseSensitiveFileNames:function(){return t.useCaseSensitiveFileNames}}),updateFile:function(r){var i=p.has(r.fileName);return t.writeFile(r.fileName,r.text),p.set(r.fileName,r),i},deleteFile:function(r){var i=p.has(r.fileName);return p.delete(r.fileName),t.deleteFile(r.fileName),i}}}function d(t,r,i,p,m){var g=[].concat(r),v=u(t,i,p),y=v.compilerHost,h=v.updateFile,F=v.deleteFile,x=new Map,S=0;return{languageServiceHost:e({},y,{getProjectVersion:function(){return S.toString()},getCompilationSettings:function(){return i},getCustomTransformers:function(){return m},getScriptFileNames:function(){return g.slice()},getScriptSnapshot:function(r){var i=t.readFile(r);if(i&&\"string\"==typeof i)return p.ScriptSnapshot.fromString(i)},getScriptVersion:function(t){return x.get(t)||\"0\"},writeFile:t.writeFile}),updateFile:function(t){S++,x.set(t.fileName,S.toString()),g.includes(t.fileName)||g.push(t.fileName),h(t)},deleteFile:function(t){S++,x.set(t.fileName,S.toString());var r=g.indexOf(t.fileName);-1!==r&&g.splice(r,1),F(t)}}}var f=function(){return require(String.fromCharCode(112,97,116,104))},b=function(){return require(String.fromCharCode(102,115))};r.addAllFilesFromFolder=n,r.addFilesForTypesIntoFolder=function(t){return n(t,\"node_modules/@types\")},r.createDefaultMapFromCDN=function(t,r,i,p,m,g,v){var y=g||fetch,h=new Map,F=s(t,p),x=\"https://playgroundcdn.typescriptlang.org/cdn/\"+r+\"/typescript/lib/\";return(i?function(){var t=v||localStorage;return Object.keys(t).forEach((function(i){i.startsWith(\"ts-lib-\")&&!i.startsWith(\"ts-lib-\"+r)&&t.removeItem(i)})),Promise.all(F.map((function(i){var p,g=\"ts-lib-\"+r+\"-\"+i,v=t.getItem(g);return v?Promise.resolve((p=v,m?m.decompressFromUTF16(p):p)):y(x+i).then((function(t){return t.text()})).then((function(r){var i;return t.setItem(g,(i=r,m?m.compressToUTF16(i):i)),r})).catch((function(){}))}))).then((function(t){t.forEach((function(t,r){t&&h.set(\"/\"+F[r],t)}))}))}:function(){return Promise.all(F.map((function(t){return y(x+t).then((function(t){return t.text()}))}))).then((function(t){t.forEach((function(t,r){return h.set(\"/\"+F[r],t)}))})).catch((function(){}))})().then((function(){return h}))},r.createDefaultMapFromNodeModules=function(t,r,p){var m=f(),g=b(),v=g.readdirSync(p||m.dirname(i.ab+\"typescript.js\")).filter((function(t){return t.startsWith(\"lib.\")&&/\\.d\\.([^\\.]+\\.)?[cm]?ts$/i.test(t)})),y=new Map;return v.forEach((function(t){y.set(\"/\"+t,function(t){var r=p||m.dirname(i.ab+\"typescript.js\");return g.readFileSync(m.join(r,t),\"utf8\")}(t))})),y},r.createFSBackedSystem=function(t,r,p,m){var g=r+\"/vfs\",v=f(),y=p.sys,h=null!=m?m:v.dirname(i.ab+\"typescript.js\");return{name:\"fs-vfs\",root:g,args:[],createDirectory:function(){return l(\"createDirectory\")},directoryExists:o(\"directoryExists\",(function(r){return Array.from(t.keys()).some((function(t){return t.startsWith(r)}))||y.directoryExists(r)})),exit:y.exit,fileExists:o(\"fileExists\",(function(r){if(t.has(r))return!0;if(r.includes(\"tsconfig.json\")||r.includes(\"tsconfig.json\"))return!1;if(r.startsWith(\"/lib\")){var i=h+\"/\"+r.replace(\"/\",\"\");return y.fileExists(i)}return y.fileExists(r)})),getCurrentDirectory:function(){return g},getDirectories:y.getDirectories,getExecutingFilePath:function(){return l(\"getExecutingFilePath\")},readDirectory:o(\"readDirectory\",(function(){return\"/\"===(arguments.length<=0?void 0:arguments[0])?Array.from(t.keys()):y.readDirectory.apply(y,arguments)})),readFile:o(\"readFile\",(function(r){if(t.has(r))return t.get(r);if(r.startsWith(\"/lib\")){var i=h+\"/\"+r.replace(\"/\",\"\"),p=y.readFile(i);if(!p){var m=y.readDirectory(h);throw new Error(\"TSVFS: A request was made for \"+i+\" but there wasn't a file found in the file map. You likely have a mismatch in the compiler options for the CDN download vs the compiler program. Existing Libs: \"+m+\".\")}return p}return y.readFile(r)})),resolvePath:function(r){return t.has(r)?r:y.resolvePath(r)},newLine:\"\\n\",useCaseSensitiveFileNames:!0,write:function(){return l(\"write\")},writeFile:function(r,i){t.set(r,i)},deleteFile:function(r){t.delete(r)},realpath:y.realpath}},r.createSystem=function(t){return{args:[],createDirectory:function(){return l(\"createDirectory\")},directoryExists:o(\"directoryExists\",(function(r){return Array.from(t.keys()).some((function(t){return t.startsWith(r)}))})),exit:function(){return l(\"exit\")},fileExists:o(\"fileExists\",(function(r){return t.has(r)||t.has(c(r))})),getCurrentDirectory:function(){return\"/\"},getDirectories:function(){return[]},getExecutingFilePath:function(){return l(\"getExecutingFilePath\")},readDirectory:o(\"readDirectory\",(function(r){return\"/\"===r?Array.from(t.keys()):[]})),readFile:o(\"readFile\",(function(r){var i;return null!=(i=t.get(r))?i:t.get(c(r))})),resolvePath:function(t){return t},newLine:\"\\n\",useCaseSensitiveFileNames:!0,write:function(){return l(\"write\")},writeFile:function(r,i){t.set(r,i)},deleteFile:function(r){t.delete(r)}}},r.createVirtualCompilerHost=u,r.createVirtualLanguageServiceHost=d,r.createVirtualTypeScriptEnvironment=function(t,r,i,p,m){void 0===p&&(p={});var g=e({},a(i),p),v=d(t,r,g,i,m),y=v.updateFile,h=v.deleteFile,F=i.createLanguageService(v.languageServiceHost),x=F.getCompilerOptionsDiagnostics();if(x.length){var S=u(t,p,i);throw new Error(i.formatDiagnostics(x,S.compilerHost))}return{name:\"vfs\",sys:t,languageService:F,getSourceFile:function(t){var r;return null==(r=F.getProgram())?void 0:r.getSourceFile(t)},createFile:function(t,r){y(i.createSourceFile(t,r,g.target,!1))},updateFile:function(t,r,p){var m=F.getProgram().getSourceFile(t);if(!m)throw new Error(\"Did not find a source file for \"+t);var g=m.text,v=null!=p?p:i.createTextSpan(0,g.length),h=g.slice(0,v.start)+r+g.slice(v.start+v.length),x=i.updateSourceFile(m,h,{span:v,newLength:r.length});y(x)},deleteFile:function(t){var r=F.getProgram().getSourceFile(t);r&&h(r)}}},r.knownLibFilesForCompilerOptions=s}};var r={};function __nccwpck_require__(i){var p=r[i];if(p!==undefined){return p.exports}var m=r[i]={exports:{}};var g=true;try{t[i](m,m.exports,__nccwpck_require__);g=false}finally{if(g)delete r[i]}return m.exports}if(typeof __nccwpck_require__!==\"undefined\")__nccwpck_require__.ab=__dirname+\"/\";var i=__nccwpck_require__(188);module.exports=i})();\n\\ No newline at end of file"
        },
        {
            "sha": "8e5c933168498e826d394086eb12332248108d76",
            "filename": "packages/next/src/compiled/@typescript/vfs/package.json",
            "status": "removed",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ce6f60a0eb76b6fcf89cfbeda98d5b120807c287/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/ce6f60a0eb76b6fcf89cfbeda98d5b120807c287/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Fpackage.json?ref=ce6f60a0eb76b6fcf89cfbeda98d5b120807c287",
            "patch": "@@ -1 +0,0 @@\n-{\"name\":\"@typescript/vfs\",\"main\":\"index.js\",\"author\":\"TypeScript team\",\"license\":\"MIT\"}"
        },
        {
            "sha": "9373e1a75d4c3c9e6618fa3f5dcbf68202d1700a",
            "filename": "packages/next/src/compiled/@typescript/vfs/typescript.js",
            "status": "removed",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/ce6f60a0eb76b6fcf89cfbeda98d5b120807c287/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Ftypescript.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ce6f60a0eb76b6fcf89cfbeda98d5b120807c287/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Ftypescript.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Ftypescript.js?ref=ce6f60a0eb76b6fcf89cfbeda98d5b120807c287"
        },
        {
            "sha": "4618f3f51bcda7dde3b407ee87c6d1745a2efe57",
            "filename": "packages/next/src/server/typescript/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 40,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts?ref=b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8",
            "patch": "@@ -39,15 +39,15 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n     // The default user config is { \"name\": \"next\" }\n     const isPluginEnabled = info.config.enabled ?? true\n \n-    const isPluginInitialized = init({\n+    if (!isPluginEnabled) {\n+      return info.languageService\n+    }\n+\n+    init({\n       ts,\n       info,\n     })\n \n-    if (!isPluginEnabled || !isPluginInitialized) {\n-      return info.languageService\n-    }\n-\n     // Set up decorator object\n     const proxy: tsModule.LanguageService = Object.create(null)\n     for (let k of Object.keys(info.languageService)) {\n@@ -79,14 +79,6 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n       if (!entryInfo.client) {\n         // Remove specified entries from completion list\n         prior.entries = serverLayer.filterCompletionsAtPosition(prior.entries)\n-\n-        // Provide autocompletion for metadata fields\n-        prior = metadata.filterCompletionsAtPosition(\n-          fileName,\n-          position,\n-          options,\n-          prior\n-        )\n       }\n \n       // Add auto completions for export configs.\n@@ -130,17 +122,6 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n       )\n       if (entryCompletionEntryDetails) return entryCompletionEntryDetails\n \n-      const metadataCompletionEntryDetails = metadata.getCompletionEntryDetails(\n-        fileName,\n-        position,\n-        entryName,\n-        formatOptions,\n-        source,\n-        preferences,\n-        data\n-      )\n-      if (metadataCompletionEntryDetails) return metadataCompletionEntryDetails\n-\n       return info.languageService.getCompletionEntryDetails(\n         fileName,\n         position,\n@@ -173,9 +154,6 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n         ) {\n           return\n         }\n-\n-        const metadataInfo = metadata.getQuickInfoAtPosition(fileName, position)\n-        if (metadataInfo) return metadataInfo\n       }\n \n       const overridden = entryConfig.getQuickInfoAtPosition(fileName, position)\n@@ -248,10 +226,7 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n                   fileName,\n                   node\n                 )\n-              : metadata.getSemanticDiagnosticsForExportVariableStatement(\n-                  fileName,\n-                  node\n-                )\n+              : []\n             prior.push(...diagnostics, ...metadataDiagnostics)\n           }\n \n@@ -311,10 +286,7 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n                   fileName,\n                   node\n                 )\n-              : metadata.getSemanticDiagnosticsForExportVariableStatement(\n-                  fileName,\n-                  node\n-                )\n+              : []\n             prior.push(...metadataDiagnostics)\n           }\n \n@@ -368,11 +340,6 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n     proxy.getDefinitionAndBoundSpan = (fileName: string, position: number) => {\n       const entryInfo = getEntryInfo(fileName)\n       if (isAppEntryFile(fileName) && !entryInfo.client) {\n-        const metadataDefinition = metadata.getDefinitionAndBoundSpan(\n-          fileName,\n-          position\n-        )\n-        if (metadataDefinition) return metadataDefinition\n       }\n \n       return info.languageService.getDefinitionAndBoundSpan(fileName, position)"
        },
        {
            "sha": "eefc0db7c5cf1c1e19ee388dfccf195152232cbf",
            "filename": "packages/next/src/server/typescript/rules/metadata.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 320,
            "changes": 324,
            "blob_url": "https://github.com/vercel/next.js/blob/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fmetadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fmetadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fmetadata.ts?ref=b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8",
            "patch": "@@ -1,204 +1,9 @@\n import { NEXT_TS_ERRORS } from '../constant'\n-import {\n-  getSource,\n-  getSourceFromVirtualTsEnv,\n-  getTs,\n-  getTypeChecker,\n-  isPositionInsideNode,\n-  log,\n-  virtualTsEnv,\n-} from '../utils'\n+import { getSource, getTs, getTypeChecker } from '../utils'\n \n import type tsModule from 'typescript/lib/tsserverlibrary'\n \n-const TYPE_ANNOTATION = ': Metadata | null'\n-const TYPE_ANNOTATION_ASYNC = ': Promise<Metadata | null>'\n-const TYPE_IMPORT = `\\n\\nimport type { Metadata } from 'next'`\n-\n-// Find the `export const metadata = ...` node.\n-function getMetadataExport(fileName: string, position: number) {\n-  const source = getSource(fileName)\n-  let metadataExport: tsModule.VariableDeclaration | undefined\n-\n-  if (source) {\n-    const ts = getTs()\n-    ts.forEachChild(source, function visit(node) {\n-      if (metadataExport) return\n-\n-      // Covered by this node\n-      if (isPositionInsideNode(position, node)) {\n-        // Export variable\n-        if (\n-          ts.isVariableStatement(node) &&\n-          node.modifiers?.some((m) => m.kind === ts.SyntaxKind.ExportKeyword)\n-        ) {\n-          if (ts.isVariableDeclarationList(node.declarationList)) {\n-            for (const declaration of node.declarationList.declarations) {\n-              if (\n-                isPositionInsideNode(position, declaration) &&\n-                declaration.name.getText() === 'metadata'\n-              ) {\n-                // `export const metadata = ...`\n-                metadataExport = declaration\n-                return\n-              }\n-            }\n-          }\n-        }\n-      }\n-    })\n-  }\n-  return metadataExport\n-}\n-\n-function updateVirtualFileWithType(\n-  fileName: string,\n-  node: tsModule.VariableDeclaration | tsModule.FunctionDeclaration,\n-  isGenerateMetadata?: boolean\n-) {\n-  const source = getSource(fileName)\n-  if (!source) return\n-\n-  // We annotate with the type in a virtual language service\n-  const sourceText = source.getFullText()\n-  let nodeEnd: number\n-  let annotation: string\n-\n-  const ts = getTs()\n-  if (ts.isFunctionDeclaration(node)) {\n-    if (isGenerateMetadata) {\n-      nodeEnd = node.body!.getFullStart()\n-      const isAsync = node.modifiers?.some(\n-        (m) => m.kind === ts.SyntaxKind.AsyncKeyword\n-      )\n-      annotation = isAsync ? TYPE_ANNOTATION_ASYNC : TYPE_ANNOTATION\n-    } else {\n-      return\n-    }\n-  } else {\n-    nodeEnd = node.name.getFullStart() + node.name.getFullWidth()\n-    annotation = TYPE_ANNOTATION\n-  }\n-\n-  const newSource =\n-    sourceText.slice(0, nodeEnd) +\n-    annotation +\n-    sourceText.slice(nodeEnd) +\n-    TYPE_IMPORT\n-\n-  if (virtualTsEnv.getSourceFile(fileName)) {\n-    log('Updating file: ' + fileName)\n-    virtualTsEnv.updateFile(fileName, newSource)\n-  } else {\n-    log('Creating file: ' + fileName)\n-    virtualTsEnv.createFile(fileName, newSource)\n-  }\n-\n-  return [nodeEnd, annotation.length]\n-}\n-\n-function isTyped(\n-  node: tsModule.VariableDeclaration | tsModule.FunctionDeclaration\n-) {\n-  return node.type !== undefined\n-}\n-\n-function proxyDiagnostics(\n-  fileName: string,\n-  pos: number[],\n-  n: tsModule.VariableDeclaration | tsModule.FunctionDeclaration\n-) {\n-  // Get diagnostics\n-  const diagnostics =\n-    virtualTsEnv.languageService.getSemanticDiagnostics(fileName)\n-  const source = getSourceFromVirtualTsEnv(fileName)\n-\n-  // Filter and map the results\n-  return diagnostics\n-    .filter((d) => {\n-      if (d.start === undefined || d.length === undefined) return false\n-      if (d.start < n.getFullStart()) return false\n-      if (d.start + d.length >= n.getFullStart() + n.getFullWidth() + pos[1])\n-        return false\n-      return true\n-    })\n-    .map((d) => {\n-      return {\n-        file: source,\n-        category: d.category,\n-        code: d.code,\n-        messageText: d.messageText,\n-        start: d.start! < pos[0] ? d.start : d.start! - pos[1],\n-        length: d.length,\n-      }\n-    })\n-}\n-\n const metadata = {\n-  filterCompletionsAtPosition(\n-    fileName: string,\n-    position: number,\n-    _options: any,\n-    prior: tsModule.WithMetadata<tsModule.CompletionInfo>\n-  ) {\n-    const node = getMetadataExport(fileName, position)\n-    if (!node) return prior\n-    if (isTyped(node)) return prior\n-\n-    // We annotate with the type in a virtual language service\n-    const pos = updateVirtualFileWithType(fileName, node)\n-    if (pos === undefined) return prior\n-\n-    // Get completions\n-    const newPos = position <= pos[0] ? position : position + pos[1]\n-    const completions = virtualTsEnv.languageService.getCompletionsAtPosition(\n-      fileName,\n-      newPos,\n-      undefined\n-    )\n-\n-    if (completions) {\n-      const ts = getTs()\n-      completions.isIncomplete = true\n-      // https://github.com/microsoft/TypeScript/blob/4dc677b292354f4b9162452b2e00f4d7dd118221/src/services/types.ts#L1428-L1433\n-      if (completions.optionalReplacementSpan) {\n-        // Adjust the start position of the text span to original source.\n-        completions.optionalReplacementSpan.start -= newPos - position\n-      }\n-      completions.entries = completions.entries\n-        .filter((e) => {\n-          return [\n-            ts.ScriptElementKind.memberVariableElement,\n-            ts.ScriptElementKind.typeElement,\n-            ts.ScriptElementKind.string,\n-          ].includes(e.kind)\n-        })\n-        .map((e) => {\n-          const insertText =\n-            e.kind === ts.ScriptElementKind.memberVariableElement &&\n-            /^[a-zA-Z0-9_]+$/.test(e.name)\n-              ? e.name + ': '\n-              : e.name\n-\n-          return {\n-            name: e.name,\n-            insertText,\n-            kind: e.kind,\n-            kindModifiers: e.kindModifiers,\n-            sortText: '!' + e.name,\n-            labelDetails: {\n-              description: `Next.js metadata`,\n-            },\n-            data: e.data,\n-          }\n-        })\n-\n-      return completions\n-    }\n-\n-    return prior\n-  },\n-\n   getSemanticDiagnosticsForExportVariableStatementInClientEntry(\n     fileName: string,\n     node: tsModule.VariableStatement | tsModule.FunctionDeclaration\n@@ -240,38 +45,6 @@ const metadata = {\n     return []\n   },\n \n-  getSemanticDiagnosticsForExportVariableStatement(\n-    fileName: string,\n-    node: tsModule.VariableStatement | tsModule.FunctionDeclaration\n-  ) {\n-    const ts = getTs()\n-\n-    if (ts.isFunctionDeclaration(node)) {\n-      if (node.name?.getText() === 'generateMetadata') {\n-        if (isTyped(node)) return []\n-\n-        // We annotate with the type in a virtual language service\n-        const pos = updateVirtualFileWithType(fileName, node, true)\n-        if (!pos) return []\n-\n-        return proxyDiagnostics(fileName, pos, node)\n-      }\n-    } else {\n-      for (const declaration of node.declarationList.declarations) {\n-        if (declaration.name.getText() === 'metadata') {\n-          if (isTyped(declaration)) break\n-\n-          // We annotate with the type in a virtual language service\n-          const pos = updateVirtualFileWithType(fileName, declaration)\n-          if (!pos) break\n-\n-          return proxyDiagnostics(fileName, pos, declaration)\n-        }\n-      }\n-    }\n-    return []\n-  },\n-\n   getSemanticDiagnosticsForExportDeclarationInClientEntry(\n     fileName: string,\n     node: tsModule.ExportDeclaration\n@@ -318,28 +91,9 @@ const metadata = {\n               if (metadataSymbol && metadataSymbol.declarations) {\n                 const declaration = metadataSymbol.declarations[0]\n                 if (declaration && ts.isVariableDeclaration(declaration)) {\n-                  if (isTyped(declaration)) break\n-\n-                  const declarationFileName =\n-                    declaration.getSourceFile().fileName\n-                  const isSameFile = declarationFileName === fileName\n-\n-                  // We annotate with the type in a virtual language service\n-                  const pos = updateVirtualFileWithType(\n-                    declarationFileName,\n-                    declaration\n-                  )\n-                  if (!pos) break\n-\n-                  const diagnostics = proxyDiagnostics(\n-                    declarationFileName,\n-                    pos,\n-                    declaration\n-                  )\n-                  if (diagnostics.length) {\n-                    if (isSameFile) {\n-                      return diagnostics\n-                    } else {\n+                  if (declaration.type) {\n+                    const typeText = declaration.type.getText()\n+                    if (!typeText.includes('Metadata')) {\n                       return [\n                         {\n                           file: getSource(fileName),\n@@ -362,76 +116,6 @@ const metadata = {\n \n     return []\n   },\n-\n-  getCompletionEntryDetails(\n-    fileName: string,\n-    position: number,\n-    entryName: string,\n-    formatOptions: tsModule.FormatCodeOptions,\n-    source: string,\n-    preferences: tsModule.UserPreferences,\n-    data: tsModule.CompletionEntryData\n-  ) {\n-    const node = getMetadataExport(fileName, position)\n-    if (!node) return\n-    if (isTyped(node)) return\n-\n-    // We annotate with the type in a virtual language service\n-    const pos = updateVirtualFileWithType(fileName, node)\n-    if (pos === undefined) return\n-\n-    const newPos = position <= pos[0] ? position : position + pos[1]\n-\n-    const details = virtualTsEnv.languageService.getCompletionEntryDetails(\n-      fileName,\n-      newPos,\n-      entryName,\n-      formatOptions,\n-      source,\n-      preferences,\n-      data\n-    )\n-    return details\n-  },\n-\n-  getQuickInfoAtPosition(fileName: string, position: number) {\n-    const node = getMetadataExport(fileName, position)\n-    if (!node) return\n-    if (isTyped(node)) return\n-\n-    // We annotate with the type in a virtual language service\n-    const pos = updateVirtualFileWithType(fileName, node)\n-    if (pos === undefined) return\n-\n-    const newPos = position <= pos[0] ? position : position + pos[1]\n-    const insight = virtualTsEnv.languageService.getQuickInfoAtPosition(\n-      fileName,\n-      newPos\n-    )\n-    return insight\n-  },\n-\n-  getDefinitionAndBoundSpan(fileName: string, position: number) {\n-    const node = getMetadataExport(fileName, position)\n-    if (!node) return\n-    if (isTyped(node)) return\n-    if (!isPositionInsideNode(position, node)) return\n-    // We annotate with the type in a virtual language service\n-    const pos = updateVirtualFileWithType(fileName, node)\n-    if (pos === undefined) return\n-    const newPos = position <= pos[0] ? position : position + pos[1]\n-\n-    const definitionInfoAndBoundSpan =\n-      virtualTsEnv.languageService.getDefinitionAndBoundSpan(fileName, newPos)\n-\n-    if (definitionInfoAndBoundSpan) {\n-      // Adjust the start position of the text span\n-      if (definitionInfoAndBoundSpan.textSpan.start > pos[0]) {\n-        definitionInfoAndBoundSpan.textSpan.start -= pos[1]\n-      }\n-    }\n-    return definitionInfoAndBoundSpan\n-  },\n }\n \n export default metadata"
        },
        {
            "sha": "42bff2cf934a1ba0768516a4c98f23f1ad9ff63b",
            "filename": "packages/next/src/server/typescript/utils.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 43,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Futils.ts?ref=b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8",
            "patch": "@@ -1,19 +1,11 @@\n-import type { VirtualTypeScriptEnvironment } from 'next/dist/compiled/@typescript/vfs'\n-import {\n-  createFSBackedSystem,\n-  createDefaultMapFromNodeModules,\n-  createVirtualTypeScriptEnvironment,\n-} from 'next/dist/compiled/@typescript/vfs'\n-\n-import path, { join } from 'path'\n+import path from 'path'\n \n import type tsModule from 'typescript/lib/tsserverlibrary'\n type TypeScript = typeof import('typescript/lib/tsserverlibrary')\n \n let ts: TypeScript\n let info: tsModule.server.PluginCreateInfo\n let appDirRegExp: RegExp\n-export let virtualTsEnv: VirtualTypeScriptEnvironment\n \n export function log(message: string) {\n   info.project.projectService.logger.info('[next] ' + message)\n@@ -23,40 +15,15 @@ export function log(message: string) {\n export function init(opts: {\n   ts: TypeScript\n   info: tsModule.server.PluginCreateInfo\n-}): boolean {\n+}) {\n   const projectDir = opts.info.project.getCurrentDirectory()\n   ts = opts.ts\n   info = opts.info\n   appDirRegExp = new RegExp(\n     '^' + (projectDir + '(/src)?/app').replace(/[\\\\/]/g, '[\\\\/]')\n   )\n \n-  log('Initializing Next.js TypeScript plugin: ' + projectDir)\n-\n-  const compilerOptions = info.project.getCompilerOptions()\n-  const fsMap = createDefaultMapFromNodeModules(\n-    compilerOptions,\n-    ts,\n-    join(projectDir, 'node_modules/typescript/lib')\n-  )\n-  const system = createFSBackedSystem(fsMap, projectDir, ts)\n-\n-  virtualTsEnv = createVirtualTypeScriptEnvironment(\n-    system,\n-    [],\n-    ts,\n-    compilerOptions\n-  )\n-\n-  if (!virtualTsEnv) {\n-    log(\n-      'Failed to create virtual TypeScript environment. This is a bug in Next.js TypeScript plugin. Please report it by opening an issue at https://github.com/vercel/next.js/issues.'\n-    )\n-    return false\n-  }\n-\n-  log('Successfully initialized Next.js TypeScript plugin!')\n-  return true\n+  log('Initialized Next.js TypeScript plugin: ' + projectDir)\n }\n \n export function getTs() {\n@@ -75,13 +42,6 @@ export function getSource(fileName: string) {\n   return info.languageService.getProgram()?.getSourceFile(fileName)\n }\n \n-export function getSourceFromVirtualTsEnv(fileName: string) {\n-  if (virtualTsEnv.sys.fileExists(fileName)) {\n-    return virtualTsEnv.getSourceFile(fileName)\n-  }\n-  return getSource(fileName)\n-}\n-\n export function removeStringQuotes(str: string): string {\n   return str.replace(/^['\"`]|['\"`]$/g, '')\n }"
        },
        {
            "sha": "72433e03847da8d31a090e3cc022c1951e017864",
            "filename": "packages/next/taskfile.js",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Ftaskfile.js",
            "raw_url": "https://github.com/vercel/next.js/raw/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Ftaskfile.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile.js?ref=b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8",
            "patch": "@@ -2234,14 +2234,6 @@ export async function ncc_https_proxy_agent(task, opts) {\n     .target('src/compiled/https-proxy-agent')\n }\n \n-externals['@typescript/vfs'] = 'next/dist/compiled/@typescript/vfs'\n-export async function ncc_typescript_vfs(task, opts) {\n-  await task\n-    .source(relative(__dirname, require.resolve('@typescript/vfs')))\n-    .ncc({ packageName: '@typescript/vfs', externals })\n-    .target('src/compiled/@typescript/vfs')\n-}\n-\n export async function precompile(task, opts) {\n   await task.parallel(\n     ['browser_polyfills', 'copy_ncced', 'copy_styled_jsx_assets'],\n@@ -2389,7 +2381,6 @@ export async function ncc(task, opts) {\n         'ncc_opentelemetry_api',\n         'ncc_http_proxy_agent',\n         'ncc_https_proxy_agent',\n-        'ncc_typescript_vfs',\n         'ncc_mini_css_extract_plugin',\n       ],\n       opts"
        },
        {
            "sha": "d13e5e9ca1d613286bc8b8acab87e3ef135d1504",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8",
            "patch": "@@ -747,11 +747,6 @@ declare module 'next/dist/compiled/zod-validation-error' {\n   export = zve\n }\n \n-declare module 'next/dist/compiled/@typescript/vfs' {\n-  import m from '@typescript/vfs'\n-  export = m\n-}\n-\n declare module 'mini-css-extract-plugin'\n declare module 'next/dist/compiled/loader-utils3'\n "
        },
        {
            "sha": "d1b537a8409ae64b85ce4a2f20b91777f7b0d49a",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=b72f91b4c13686f2bafe5eb7b137c05bd35bd3d8",
            "patch": "@@ -1173,9 +1173,6 @@ importers:\n       '@types/ws':\n         specifier: 8.2.0\n         version: 8.2.0\n-      '@typescript/vfs':\n-        specifier: 1.6.1\n-        version: 1.6.1(typescript@5.8.2)\n       '@vercel/ncc':\n         specifier: 0.34.0\n         version: 0.34.0\n@@ -6567,11 +6564,6 @@ packages:\n     resolution: {integrity: sha512-RGLh5CRaUEf02viP5c1Vh1cMGffQscyHe7HPAzGpfmfflFg1wUz2rYxd+OZqwpeypYvZ8UxSxuIpF++fmOzEcg==}\n     engines: {node: ^18.18.0 || ^20.9.0 || >=21.1.0}\n \n-  '@typescript/vfs@1.6.1':\n-    resolution: {integrity: sha512-JwoxboBh7Oz1v38tPbkrZ62ZXNHAk9bJ7c9x0eI5zBfBnBYGhURdbnh7Z4smN/MV48Y5OCcZb58n972UtbazsA==}\n-    peerDependencies:\n-      typescript: '*'\n-\n   '@ungap/structured-clone@1.2.0':\n     resolution: {integrity: sha512-zuVdFrMJiuCDQUMCzQaD6KL28MjnqqN8XnAqiEq9PNm/hCPTSGfrXCOfwj1ow4LFb/tNymJPwsNbVePc1xFqrQ==}\n \n@@ -23266,13 +23258,6 @@ snapshots:\n       eslint-visitor-keys: 4.2.0\n     optional: true\n \n-  '@typescript/vfs@1.6.1(typescript@5.8.2)':\n-    dependencies:\n-      debug: 4.1.1\n-      typescript: 5.8.2\n-    transitivePeerDependencies:\n-      - supports-color\n-\n   '@ungap/structured-clone@1.2.0': {}\n \n   '@vercel/fetch-cached-dns@2.0.2(node-fetch@2.6.7(encoding@0.1.13))':"
        }
    ],
    "stats": {
        "total": 487,
        "additions": 14,
        "deletions": 473
    }
}