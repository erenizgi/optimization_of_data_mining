{
    "author": "sokra",
    "message": "Turbopack: more incremental all_server_paths (#82892)\n\n### What?\n\nSplit `all_server_paths` into an inner method to make it more incremental.\n\nUse more RcStrs to avoid cloning strings",
    "sha": "d89f14dda3f77ec1afc48e045190afc17fbb2ae5",
    "files": [
        {
            "sha": "b6cefa140a20e98a74e2c896132fa974a8c9e339",
            "filename": "crates/napi/src/next_api/endpoint.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fendpoint.rs?ref=d89f14dda3f77ec1afc48e045190afc17fbb2ae5",
            "patch": "@@ -34,7 +34,7 @@ pub struct NapiServerPath {\n impl From<ServerPath> for NapiServerPath {\n     fn from(server_path: ServerPath) -> Self {\n         Self {\n-            path: server_path.path,\n+            path: server_path.path.into_owned(),\n             content_hash: format!(\"{:x}\", server_path.content_hash),\n         }\n     }\n@@ -59,7 +59,7 @@ impl From<Option<EndpointOutputPaths>> for NapiWrittenEndpoint {\n                 client_paths,\n             }) => Self {\n                 r#type: \"nodejs\".to_string(),\n-                entry_path: Some(server_entry_path),\n+                entry_path: Some(server_entry_path.into_owned()),\n                 client_paths: client_paths.into_iter().map(From::from).collect(),\n                 server_paths: server_paths.into_iter().map(From::from).collect(),\n                 ..Default::default()"
        },
        {
            "sha": "dcf54e92ce25ac2fc48fa350900f513679288d10",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=d89f14dda3f77ec1afc48e045190afc17fbb2ae5",
            "patch": "@@ -1985,7 +1985,7 @@ impl Endpoint for AppEndpoint {\n                     server_entry_path: node_root\n                         .get_path_to(&*rsc_chunk.path().await?)\n                         .context(\"Node.js chunk entry path must be inside the node root\")?\n-                        .to_string(),\n+                        .into(),\n                     server_paths,\n                     client_paths,\n                 },"
        },
        {
            "sha": "559511af43dc4d2726a7ba05432c7bbbb12c2d18",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=d89f14dda3f77ec1afc48e045190afc17fbb2ae5",
            "patch": "@@ -1710,9 +1710,9 @@ impl Endpoint for PageEndpoint {\n                         node_root\n                             .get_path_to(&*entry_chunk.path().await?)\n                             .context(\"ssr chunk entry path must be inside the node root\")?\n-                            .to_string()\n+                            .into()\n                     } else {\n-                        String::new() // Empty path when no pages should be created\n+                        rcstr!(\"\") // Empty path when no pages should be created\n                     };\n \n                     EndpointOutputPaths::NodeJs {"
        },
        {
            "sha": "68fbee0c1035a8fc6ef80e4a9a416bb0557c53cc",
            "filename": "crates/next-api/src/paths.rs",
            "status": "modified",
            "additions": 41,
            "deletions": 36,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnext-api%2Fsrc%2Fpaths.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnext-api%2Fsrc%2Fpaths.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpaths.rs?ref=d89f14dda3f77ec1afc48e045190afc17fbb2ae5",
            "patch": "@@ -1,30 +1,49 @@\n use anyhow::Result;\n use next_core::{all_assets_from_entries, next_manifests::AssetBinding};\n-use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{\n-    NonLocalValue, ResolvedVc, TryFlatJoinIterExt, TryJoinIterExt, Vc, trace::TraceRawVcs,\n-};\n+use turbo_tasks::{ResolvedVc, TryFlatJoinIterExt, TryJoinIterExt, Vc};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n-    asset::{Asset, AssetContent},\n+    asset::Asset,\n     output::{OutputAsset, OutputAssets},\n };\n use turbopack_wasm::wasm_edge_var_name;\n \n /// A reference to a server file with content hash for change detection\n-#[derive(Debug, Clone, PartialEq, Eq, Hash, Serialize, Deserialize, TraceRawVcs, NonLocalValue)]\n+#[turbo_tasks::value]\n+#[derive(Debug, Clone)]\n pub struct ServerPath {\n     /// Relative to the root_path\n-    pub path: String,\n+    pub path: RcStr,\n     pub content_hash: u64,\n }\n \n /// A list of server paths\n #[turbo_tasks::value(transparent)]\n pub struct ServerPaths(Vec<ServerPath>);\n \n+#[turbo_tasks::value(transparent)]\n+pub struct OptionServerPath(Option<ServerPath>);\n+\n+#[turbo_tasks::function]\n+async fn server_path(\n+    asset: Vc<Box<dyn OutputAsset>>,\n+    node_root: FileSystemPath,\n+) -> Result<Vc<OptionServerPath>> {\n+    Ok(Vc::cell(\n+        if let Some(path) = node_root.get_path_to(&*asset.path().await?) {\n+            let content_hash = *asset.content().file_content().hash().await?;\n+            Some(ServerPath {\n+                path: RcStr::from(path),\n+                content_hash,\n+            })\n+        } else {\n+            None\n+        },\n+    ))\n+}\n+\n /// Return a list of all server paths with filename and hash for all output\n /// assets references from the `assets` list. Server paths are identified by\n /// being inside `node_root`.\n@@ -33,38 +52,24 @@ pub async fn all_server_paths(\n     assets: Vc<OutputAssets>,\n     node_root: FileSystemPath,\n ) -> Result<Vc<ServerPaths>> {\n-    let span = tracing::info_span!(\"all_server_paths\");\n+    let span = tracing::info_span!(\n+        \"all_server_paths\",\n+        assets_count = tracing::field::Empty,\n+        server_assets_count = tracing::field::Empty\n+    );\n+    let span_clone = span.clone();\n     async move {\n         let all_assets = all_assets_from_entries(assets).await?;\n-        let node_root = node_root.clone();\n-        Ok(Vc::cell(\n-            all_assets\n-                .iter()\n-                .map(|&asset| {\n-                    let node_root = node_root.clone();\n-\n-                    async move {\n-                        Ok(\n-                            if let Some(path) = node_root.get_path_to(&*asset.path().await?) {\n-                                let content_hash = match *asset.content().await? {\n-                                    AssetContent::File(file) => *file.hash().await?,\n-                                    AssetContent::Redirect { .. } => 0,\n-                                };\n-                                Some(ServerPath {\n-                                    path: path.to_string(),\n-                                    content_hash,\n-                                })\n-                            } else {\n-                                None\n-                            },\n-                        )\n-                    }\n-                })\n-                .try_flat_join()\n-                .await?,\n-        ))\n+        span.record(\"assets_count\", all_assets.len());\n+        let server_paths = all_assets\n+            .iter()\n+            .map(|&asset| server_path(*asset, node_root.clone()).owned())\n+            .try_flat_join()\n+            .await?;\n+        span.record(\"server_assets_count\", server_paths.len());\n+        Ok(Vc::cell(server_paths))\n     }\n-    .instrument(span)\n+    .instrument(span_clone)\n     .await\n }\n "
        },
        {
            "sha": "51aa326762b65fc539c57b6fb4e9adab710f16e9",
            "filename": "crates/next-api/src/route.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnext-api%2Fsrc%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d89f14dda3f77ec1afc48e045190afc17fbb2ae5/crates%2Fnext-api%2Fsrc%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Froute.rs?ref=d89f14dda3f77ec1afc48e045190afc17fbb2ae5",
            "patch": "@@ -147,7 +147,7 @@ pub struct EndpointOutput {\n pub enum EndpointOutputPaths {\n     NodeJs {\n         /// Relative to the root_path\n-        server_entry_path: String,\n+        server_entry_path: RcStr,\n         server_paths: Vec<ServerPath>,\n         client_paths: Vec<RcStr>,\n     },"
        }
    ],
    "stats": {
        "total": 89,
        "additions": 47,
        "deletions": 42
    }
}