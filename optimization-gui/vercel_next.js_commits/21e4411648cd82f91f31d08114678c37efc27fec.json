{
    "author": "ijjk",
    "message": "Fix dangling promise in unstable-cache (#79248)\n\nWhile investigating an issue with intermittent `unstable_cache` calls\nfailing to set noticed we have these dangling promises which cause\n\"racey\" behavior with setting to a cache in environments where the\nfunction stops after the request is finished.\n\nThese have been present since\nhttps://github.com/vercel/next.js/commit/b305c2d309b4d4923c3b11f7e258077729ab28fb\naltho since racey may or may not have been noticed.\n\nx-ref: [slack\nthread](https://vercel.slack.com/archives/C02K2HCH5V4/p1747322956802819?thread_ts=1746633220.634939&cid=C02K2HCH5V4)",
    "sha": "21e4411648cd82f91f31d08114678c37efc27fec",
    "files": [
        {
            "sha": "94a3f73c911759d6179f0fd59623533506e3dd54",
            "filename": ".changeset/loose-cows-pump.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/21e4411648cd82f91f31d08114678c37efc27fec/.changeset%2Floose-cows-pump.md",
            "raw_url": "https://github.com/vercel/next.js/raw/21e4411648cd82f91f31d08114678c37efc27fec/.changeset%2Floose-cows-pump.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Floose-cows-pump.md?ref=21e4411648cd82f91f31d08114678c37efc27fec",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+'next': patch\n+---\n+\n+Fix dangling promise in unstable_cache"
        },
        {
            "sha": "98e400d8be2d419a971a8a8d76af5f8a55ea0152",
            "filename": "packages/next/src/server/web/spec-extension/unstable-cache.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/21e4411648cd82f91f31d08114678c37efc27fec/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/21e4411648cd82f91f31d08114678c37efc27fec/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts?ref=21e4411648cd82f91f31d08114678c37efc27fec",
            "patch": "@@ -275,7 +275,14 @@ export function unstable_cache<T extends Callback>(\n         )\n \n         if (!workStore.isDraftMode) {\n-          cacheNewResult(\n+          if (!workStore.pendingRevalidates) {\n+            workStore.pendingRevalidates = {}\n+          }\n+\n+          // We need to push the cache result promise to pending\n+          // revalidates otherwise it won't be awaited and is just\n+          // dangling\n+          workStore.pendingRevalidates[invocationKey] = cacheNewResult(\n             result,\n             incrementalCache,\n             cacheKey,\n@@ -330,7 +337,11 @@ export function unstable_cache<T extends Callback>(\n           cb,\n           ...args\n         )\n-        cacheNewResult(\n+\n+        // we need to wait setting the new cache result here as\n+        // we don't have pending revalidates on workStore to\n+        // push to and we can't have a dangling promise\n+        await cacheNewResult(\n           result,\n           incrementalCache,\n           cacheKey,"
        }
    ],
    "stats": {
        "total": 20,
        "additions": 18,
        "deletions": 2
    }
}