{
    "author": "ijjk",
    "message": "Add metadata to server reference manifest (#82695)\n\nThis exposes additional metadata in the server reference manifest, it is\nnot directly used at this time though.",
    "sha": "19048b826e23fc126fa1e803e668b8116b388232",
    "files": [
        {
            "sha": "286181443ec762149d460bce0859d507ec2c661f",
            "filename": "crates/next-api/src/server_actions.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/19048b826e23fc126fa1e803e668b8116b388232/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/19048b826e23fc126fa1e803e668b8116b388232/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs?ref=19048b826e23fc126fa1e803e668b8116b388232",
            "patch": "@@ -174,16 +174,33 @@ async fn build_manifest(\n         NextRuntime::NodeJs => &mut manifest.node,\n     };\n \n-    for (hash_id, (layer, _name, _module)) in actions_value {\n+    // Collect all the action metadata including filenames\n+    let mut action_metadata: Vec<(String, (ActionLayer, String, String))> = Vec::new();\n+    for (hash_id, (layer, name, module)) in actions_value.iter() {\n+        // Get the module path and use the full path\n+        let module_path = module.ident().path().await?;\n+        let full_path = module_path.to_string();\n+\n+        action_metadata.push((hash_id.clone(), (*layer, name.clone(), full_path)));\n+    }\n+\n+    // Now create the manifest entries\n+    for (hash_id, (layer, name, filename)) in &action_metadata {\n         let entry = mapping.entry(hash_id.as_str()).or_default();\n         entry.workers.insert(\n             &key,\n             ActionManifestWorkerEntry {\n                 module_id: ActionManifestModuleId::String(loader_id.as_str()),\n                 is_async: *async_module_info.is_async(chunk_item.module()).await?,\n+                exported_name: name.as_str(),\n+                filename: filename.as_str(),\n             },\n         );\n         entry.layer.insert(&key, *layer);\n+\n+        // Hoist the filename and exported_name to the entry level\n+        entry.exported_name = name.as_str();\n+        entry.filename = filename.as_str();\n     }\n \n     Ok(ResolvedVc::upcast("
        },
        {
            "sha": "fe572caed62cd8d3acf9be8fe8549297d06dc32b",
            "filename": "crates/next-core/src/next_manifests/mod.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/19048b826e23fc126fa1e803e668b8116b388232/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/19048b826e23fc126fa1e803e668b8116b388232/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs?ref=19048b826e23fc126fa1e803e668b8116b388232",
            "patch": "@@ -311,6 +311,11 @@ pub struct ActionManifestEntry<'a> {\n     pub workers: FxIndexMap<&'a str, ActionManifestWorkerEntry<'a>>,\n \n     pub layer: FxIndexMap<&'a str, ActionLayer>,\n+\n+    #[serde(rename = \"exportedName\")]\n+    pub exported_name: &'a str,\n+\n+    pub filename: &'a str,\n }\n \n #[derive(Serialize, Debug)]\n@@ -319,6 +324,9 @@ pub struct ActionManifestWorkerEntry<'a> {\n     pub module_id: ActionManifestModuleId<'a>,\n     #[serde(rename = \"async\")]\n     pub is_async: bool,\n+    #[serde(rename = \"exportedName\")]\n+    pub exported_name: &'a str,\n+    pub filename: &'a str,\n }\n \n #[derive(Serialize, Debug)]"
        },
        {
            "sha": "6fa4898fdd272eb4ba87a8a05a7d2e74ec4c048c",
            "filename": "packages/next/src/build/webpack/loaders/next-flight-action-entry-loader.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/19048b826e23fc126fa1e803e668b8116b388232/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-action-entry-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/19048b826e23fc126fa1e803e668b8116b388232/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-action-entry-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-action-entry-loader.ts?ref=19048b826e23fc126fa1e803e668b8116b388232",
            "patch": "@@ -6,7 +6,7 @@ export type NextFlightActionEntryLoaderOptions = {\n \n export type FlightActionEntryLoaderActions = [\n   path: string,\n-  actions: { id: string; exportedName: string }[],\n+  actions: { id: string; exportedName?: string; filename?: string }[],\n ][]\n \n function nextFlightActionEntryLoader("
        },
        {
            "sha": "75f78e7fa87da6bdae46abdebf19a36d228a5621",
            "filename": "packages/next/src/build/webpack/plugins/flight-client-entry-plugin.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 5,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/19048b826e23fc126fa1e803e668b8116b388232/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/19048b826e23fc126fa1e803e668b8116b388232/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts?ref=19048b826e23fc126fa1e803e668b8116b388232",
            "patch": "@@ -62,8 +62,13 @@ const PLUGIN_NAME = 'FlightClientEntryPlugin'\n \n type Actions = {\n   [actionId: string]: {\n+    exportedName?: string\n+    filename?: string\n     workers: {\n-      [name: string]: { moduleId: string | number; async: boolean }\n+      [name: string]: {\n+        moduleId: string | number\n+        async: boolean\n+      }\n     }\n     // Record which layer the action is in (rsc or sc_action), in the specific entry.\n     layer: {\n@@ -72,7 +77,7 @@ type Actions = {\n   }\n }\n \n-type ActionIdNamePair = { id: string; exportedName: string }\n+type ActionIdNamePair = { id: string; exportedName?: string; filename?: string }\n \n export type ActionManifest = {\n   // Assign a unique encryption key during production build.\n@@ -92,11 +97,17 @@ const pluginState = getProxiedPluginState({\n   edgeServerActions: {} as ActionManifest['edge'],\n \n   serverActionModules: {} as {\n-    [workerName: string]: { server?: ModuleInfo; client?: ModuleInfo }\n+    [workerName: string]: {\n+      server?: ModuleInfo\n+      client?: ModuleInfo\n+    }\n   },\n \n   edgeServerActionModules: {} as {\n-    [workerName: string]: { server?: ModuleInfo; client?: ModuleInfo }\n+    [workerName: string]: {\n+      server?: ModuleInfo\n+      client?: ModuleInfo\n+    }\n   },\n \n   ssrModules: {} as { [ssrModuleId: string]: ModuleInfo },\n@@ -183,6 +194,7 @@ function deduplicateCSSImportsForEntry(mergedCSSimports: CssImports) {\n export class FlightClientEntryPlugin {\n   dev: boolean\n   appDir: string\n+  projectDir: string\n   encryptionKey: string\n   isEdgeServer: boolean\n   assetPrefix: string\n@@ -191,6 +203,7 @@ export class FlightClientEntryPlugin {\n   constructor(options: Options) {\n     this.dev = options.dev\n     this.appDir = options.appDir\n+    this.projectDir = path.join(options.appDir, '..')\n     this.isEdgeServer = options.isEdgeServer\n     this.assetPrefix = !this.dev && !this.isEdgeServer ? '../' : ''\n     this.encryptionKey = options.encryptionKey\n@@ -628,6 +641,7 @@ export class FlightClientEntryPlugin {\n             Object.entries(actionIds).map(([id, exportedName]) => ({\n               id,\n               exportedName,\n+              filename: path.posix.relative(this.projectDir, modResource),\n             }))\n           )\n         }\n@@ -728,6 +742,7 @@ export class FlightClientEntryPlugin {\n           Object.entries(actionIds).map(([id, exportedName]) => ({\n             id,\n             exportedName,\n+            filename: path.posix.relative(this.projectDir, modResource),\n           })),\n         ])\n       }\n@@ -949,11 +964,13 @@ export class FlightClientEntryPlugin {\n       : pluginState.serverActions\n \n     for (const [, actionsFromModule] of actionsArray) {\n-      for (const { id } of actionsFromModule) {\n+      for (const { id, exportedName, filename } of actionsFromModule) {\n         if (typeof currentCompilerServerActions[id] === 'undefined') {\n           currentCompilerServerActions[id] = {\n             workers: {},\n             layer: {},\n+            filename,\n+            exportedName,\n           }\n         }\n         currentCompilerServerActions[id].workers[bundlePath] = {\n@@ -1060,6 +1077,7 @@ export class FlightClientEntryPlugin {\n         if (!mapping[chunkGroup.name]) {\n           mapping[chunkGroup.name] = {}\n         }\n+\n         mapping[chunkGroup.name][fromClient ? 'client' : 'server'] = {\n           moduleId: modId,\n           async: compilation.moduleGraph.isAsync(mod),"
        },
        {
            "sha": "200372858b89f91b1746f7580f454b605fd80420",
            "filename": "packages/next/src/shared/lib/turbopack/manifest-loader.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/19048b826e23fc126fa1e803e668b8116b388232/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/19048b826e23fc126fa1e803e668b8116b388232/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Fmanifest-loader.ts?ref=19048b826e23fc126fa1e803e668b8116b388232",
            "patch": "@@ -203,6 +203,8 @@ export class TurbopackManifestLoader {\n           workers: {},\n           layer: {},\n         })\n+        action.filename = other[key].filename\n+        action.exportedName = other[key].exportedName\n         Object.assign(action.workers, other[key].workers)\n         Object.assign(action.layer, other[key].layer)\n       }"
        },
        {
            "sha": "ba12dd9a70ecb926c053965ea5e41af034fb7369",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/19048b826e23fc126fa1e803e668b8116b388232/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/19048b826e23fc126fa1e803e668b8116b388232/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=19048b826e23fc126fa1e803e668b8116b388232",
            "patch": "@@ -29,6 +29,49 @@ describe('app-dir action handling', () => {\n       },\n     })\n \n+  if (isNextStart) {\n+    it('should output exportName and filename info in manifest', async () => {\n+      const referenceManifest = await next.readJSON(\n+        '.next/server/server-reference-manifest.json'\n+      )\n+      let foundExportNames = []\n+\n+      for (const item in referenceManifest.node) {\n+        try {\n+          const itemInfo = referenceManifest.node[item]\n+\n+          foundExportNames.push(itemInfo.exportedName)\n+\n+          expect(itemInfo.filename).toBeString()\n+          // can be outside app dir but this test suite has them all in app\n+          expect(itemInfo.filename.startsWith('app/')).toBe(true)\n+          expect(itemInfo.exportedName).toBeString()\n+        } catch (err) {\n+          require('console').error(`Invalid action entry ${item}`, err)\n+          throw err\n+        }\n+      }\n+      for (const item in referenceManifest.edge) {\n+        try {\n+          const itemInfo = referenceManifest.edge[item]\n+\n+          foundExportNames.push(itemInfo.exportedName)\n+\n+          expect(itemInfo.filename).toBeString()\n+          expect(itemInfo.exportedName).toBeString()\n+        } catch (err) {\n+          require('console').error(`Invalid action entry ${item}`, err)\n+          throw err\n+        }\n+      }\n+\n+      expect(foundExportNames).toContain('setCookie')\n+      expect(foundExportNames).toContain('getCookie')\n+      expect(foundExportNames).toContain('getHeader')\n+      expect(foundExportNames).toContain('setCookieWithMaxAge')\n+    })\n+  }\n+\n   it('should handle action correctly with middleware rewrite', async () => {\n     const browser = await next.browser('/rewrite-to-static-first')\n     let actionRequestStatus: number | undefined"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 95,
        "deletions": 7
    }
}