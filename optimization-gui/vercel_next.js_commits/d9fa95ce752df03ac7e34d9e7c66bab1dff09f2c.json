{
    "author": "timneutkens",
    "message": "Handle pnpm-workspace.yaml while searching for monorepo root (#74818)\n\n## What?\n\nIn order for Next.js to know where the root of the project (i.e. monorepo) is we have a heuristic for searching for the root by looking upwards from the application's directory trying to find the package manager lockfiles. This works really well and in practice you rarely have to provide the root directory. In some cases, e.g. when you're creating a monorepo based on an existing repository you might forget to delete the previous repository lockfile. E.g. in #74731 that was the cause for the issue. While having that lockfile in the repo doesn't do anything it does affect the project root heuristic because that unused lockfile is matched on the filesystem and is higher up than the actual root (in the application directory).\n\nWhile looking at the reproduction in #74731 I realized we can consider `pnpm-workspace.yaml` first before matching the lockfiles. Still need to verify if we need a separate findup call for that or if it will recursively look up per item first.\n\nFixes #74731\n\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that you follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the PR.\n- Read the Docs Contribution Guide to ensure your contribution follows the docs guidelines: https://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc https://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See https://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See: https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature request has been accepted for implementation before opening a PR. (A discussion must be opened, see https://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added (https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to understand the PR)\n- When linking to a Slack thread, you might want to share details of the conclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic behind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "d9fa95ce752df03ac7e34d9e7c66bab1dff09f2c",
    "files": [
        {
            "sha": "719fa28b0892562564b8e3aecf78a1dfb3472917",
            "filename": "packages/next/src/lib/find-root.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 3,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d9fa95ce752df03ac7e34d9e7c66bab1dff09f2c/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d9fa95ce752df03ac7e34d9e7c66bab1dff09f2c/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts?ref=d9fa95ce752df03ac7e34d9e7c66bab1dff09f2c",
            "patch": "@@ -2,7 +2,21 @@ import { dirname } from 'path'\n import findUp from 'next/dist/compiled/find-up'\n import * as Log from '../build/output/log'\n \n-export function findRootLockFile(cwd: string) {\n+function findWorkRoot(cwd: string) {\n+  // Find-up evaluates the list of files at each level.\n+  // For pnpm-workspace.yaml we first want to look up before searching for lockfiles as those can be included in the application directory by accident.\n+  const pnpmWorkspaceFile = findUp.sync(\n+    'pnpm-workspace.yaml',\n+\n+    {\n+      cwd,\n+    }\n+  )\n+\n+  if (pnpmWorkspaceFile) {\n+    return pnpmWorkspaceFile\n+  }\n+\n   return findUp.sync(\n     [\n       'pnpm-lock.yaml',\n@@ -21,7 +35,7 @@ export function findRootDirAndLockFiles(cwd: string): {\n   lockFiles: string[]\n   rootDir: string\n } {\n-  const lockFile = findRootLockFile(cwd)\n+  const lockFile = findWorkRoot(cwd)\n   if (!lockFile)\n     return {\n       lockFiles: [],\n@@ -37,7 +51,7 @@ export function findRootDirAndLockFiles(cwd: string): {\n     // dirname('/')==='/' so if we happen to reach the FS root (as might happen in a container we need to quit to avoid looping forever\n     if (parentDir === currentDir) break\n \n-    const newLockFile = findRootLockFile(parentDir)\n+    const newLockFile = findWorkRoot(parentDir)\n \n     if (!newLockFile) break\n "
        },
        {
            "sha": "3f926f2ceccaca80321f795db394777d31bd5edd",
            "filename": "test/e2e/app-dir/pnpm-workspace-root/pnpm-workspace-root.test.ts",
            "status": "added",
            "additions": 68,
            "deletions": 0,
            "changes": 68,
            "blob_url": "https://github.com/vercel/next.js/blob/d9fa95ce752df03ac7e34d9e7c66bab1dff09f2c/test%2Fe2e%2Fapp-dir%2Fpnpm-workspace-root%2Fpnpm-workspace-root.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d9fa95ce752df03ac7e34d9e7c66bab1dff09f2c/test%2Fe2e%2Fapp-dir%2Fpnpm-workspace-root%2Fpnpm-workspace-root.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fpnpm-workspace-root%2Fpnpm-workspace-root.test.ts?ref=d9fa95ce752df03ac7e34d9e7c66bab1dff09f2c",
            "patch": "@@ -0,0 +1,68 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('pnpm-workspace-root', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: {\n+      'app/layout.tsx': `\n+        import { ReactNode } from 'react'\n+        export default function Root({ children }: { children: ReactNode }) {\n+          return (\n+            <html>\n+              <body>{children}</body>\n+            </html>\n+          )\n+        }\n+      `,\n+      'app/page.tsx': `\n+        import { message } from '../../shared/utils'\n+        export default function Page() {\n+          return <p>{message}</p>\n+        }\n+      `,\n+      // Write a package-lock.json (npm lockfile, ignored by pnpm) to the application directory\n+      // directory to create the scenario where multiple \"lockfiles\" exist.\n+      'package-lock.json': JSON.stringify({\n+        name: 'parent-workspace',\n+        version: '1.0.0',\n+        lockfileVersion: 3,\n+      }),\n+      // Write pnpm-workspace.yaml in the same parent directory.\n+      // This file should be prioritized over lockfiles when determining root.\n+      // Note: pnpm-workspace.yaml will be detected by pnpm, but since we also\n+      // include a proper package.json, it should work correctly.\n+      '../pnpm-workspace.yaml': 'packages:\\n  - \"test\"\\n',\n+      '../package.json': JSON.stringify({\n+        name: 'workspace-root',\n+        private: true,\n+      }),\n+      // Shared file outside of the test directory (in the workspace root)\n+      // This tests that files outside the Next.js app directory but inside\n+      // the pnpm workspace root can be imported correctly.\n+      '../shared/utils.ts': `\n+        export const message = 'hello world'\n+      `,\n+    },\n+    // So that parent files don't leave the isolated testDir\n+    subDir: 'test',\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should detect root directory from pnpm-workspace.yaml and allow imports from outside app dir', async () => {\n+    // The app should start successfully when pnpm-workspace.yaml is present\n+    // and correctly resolve imports from outside the Next.js app directory\n+    // (e.g., from ../shared/utils.ts which is in the workspace root)\n+    const browser = await next.browser('/')\n+    expect(await browser.elementByCss('p').text()).toBe('hello world')\n+  })\n+\n+  it('should not have multiple lockfiles warning when pnpm-workspace.yaml is present', async () => {\n+    // When pnpm-workspace.yaml is found, it should be used as the root indicator\n+    // and we shouldn't see the \"multiple lockfiles\" warning since pnpm-workspace.yaml\n+    // is prioritized and acts as the definitive workspace root marker\n+    expect(next.cliOutput).not.toMatch(/We detected multiple lockfiles/)\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 85,
        "deletions": 3
    }
}