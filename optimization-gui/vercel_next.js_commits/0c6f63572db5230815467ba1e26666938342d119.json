{
    "author": "artemszelenov",
    "message": "fix: remove initial-scale=1 from viewport when set to false (#76397)\n\nCo-authored-by: Jiachi Liu <inbox@huozhi.im>",
    "sha": "0c6f63572db5230815467ba1e26666938342d119",
    "files": [
        {
            "sha": "7e2e14639b697a88eb69ebebd9a1f8fb5937241b",
            "filename": "packages/next/src/lib/metadata/generate/basic.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/0c6f63572db5230815467ba1e26666938342d119/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Fbasic.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0c6f63572db5230815467ba1e26666938342d119/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Fbasic.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fgenerate%2Fbasic.tsx?ref=0c6f63572db5230815467ba1e26666938342d119",
            "patch": "@@ -5,7 +5,6 @@ import type {\n } from '../types/metadata-interface'\n import type { ViewportLayout } from '../types/extra-types'\n \n-import React from 'react'\n import { Meta, MetaFilter, MultiMeta } from './meta'\n import { ViewportMetaKeys } from '../constants'\n import { getOrigin } from './utils'\n@@ -20,9 +19,15 @@ function resolveViewportLayout(viewport: Viewport) {\n       const viewportKey = viewportKey_ as keyof ViewportLayout\n       if (viewportKey in viewport) {\n         let value = viewport[viewportKey]\n-        if (typeof value === 'boolean') value = value ? 'yes' : 'no'\n-        if (resolved) resolved += ', '\n-        resolved += `${ViewportMetaKeys[viewportKey]}=${value}`\n+        if (typeof value === 'boolean') {\n+          value = value ? 'yes' : 'no'\n+        } else if (!value && viewportKey === 'initialScale') {\n+          value = undefined\n+        }\n+        if (value) {\n+          if (resolved) resolved += ', '\n+          resolved += `${ViewportMetaKeys[viewportKey]}=${value}`\n+        }\n       }\n     }\n   }"
        },
        {
            "sha": "b876d999405297caab908fc907efd94c32152ab3",
            "filename": "packages/next/src/lib/metadata/resolve-metadata.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/0c6f63572db5230815467ba1e26666938342d119/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c6f63572db5230815467ba1e26666938342d119/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.test.ts?ref=0c6f63572db5230815467ba1e26666938342d119",
            "patch": "@@ -780,6 +780,14 @@ describe('accumulateViewport', () => {\n         interactiveWidget: 'overlays-content',\n       })\n     })\n+\n+    it('should skip viewport.initialScale if it is set undefined explicitly', async () => {\n+      const viewport = await accumulateViewport([{ initialScale: undefined }])\n+      expect(viewport).toMatchObject({\n+        width: 'device-width',\n+        initialScale: undefined,\n+      })\n+    })\n   })\n \n   describe('themeColor', () => {"
        },
        {
            "sha": "b8c56c7a3663d98dfad2536a643eb8b586c6db46",
            "filename": "packages/next/src/lib/metadata/resolve-metadata.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0c6f63572db5230815467ba1e26666938342d119/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c6f63572db5230815467ba1e26666938342d119/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolve-metadata.ts?ref=0c6f63572db5230815467ba1e26666938342d119",
            "patch": "@@ -327,10 +327,9 @@ function mergeViewport({\n         target.colorScheme = source.colorScheme || null\n         break\n       default:\n-        if (typeof source[key] !== 'undefined') {\n-          // @ts-ignore viewport properties\n-          target[key] = source[key]\n-        }\n+        // always override the target with the source\n+        // @ts-ignore viewport properties\n+        target[key] = source[key]\n         break\n     }\n   }"
        },
        {
            "sha": "5be0b573ec68fb16bdf8c552892e884f1760734e",
            "filename": "test/e2e/app-dir/metadata/app/viewport/skip-initial-scale/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/0c6f63572db5230815467ba1e26666938342d119/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fviewport%2Fskip-initial-scale%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/0c6f63572db5230815467ba1e26666938342d119/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fviewport%2Fskip-initial-scale%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fviewport%2Fskip-initial-scale%2Fpage.tsx?ref=0c6f63572db5230815467ba1e26666938342d119",
            "patch": "@@ -0,0 +1,9 @@\n+import type { Viewport } from 'next'\n+\n+export default function Page() {\n+  return <p>skip initial scale</p>\n+}\n+\n+export const viewport: Viewport = {\n+  initialScale: undefined,\n+}"
        },
        {
            "sha": "3436d681a60a1880971d1bd72750917bcd535a04",
            "filename": "test/e2e/app-dir/metadata/metadata.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/0c6f63572db5230815467ba1e26666938342d119/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c6f63572db5230815467ba1e26666938342d119/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts?ref=0c6f63572db5230815467ba1e26666938342d119",
            "patch": "@@ -775,6 +775,14 @@ describe('app dir - metadata', () => {\n         'theme-color': '#000',\n       })\n     })\n+\n+    it('should skip initial-scale from viewport if it is set to undefined', async () => {\n+      const browser = await next.browser('/viewport/skip-initial-scale')\n+      const matchMultiDom = createMultiDomMatcher(browser)\n+      await matchMultiDom('meta', 'name', 'content', {\n+        viewport: 'width=device-width',\n+      })\n+    })\n   })\n \n   describe('react cache', () => {"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 37,
        "deletions": 8
    }
}