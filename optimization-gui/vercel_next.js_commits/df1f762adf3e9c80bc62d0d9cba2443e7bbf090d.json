{
    "author": "sokra",
    "message": "Turbopack: Compact only at the end for short sessions (#82224)\n\n### What?\n\nChange the compaction behavior for \"short sessions\" (like next build). A longer \"short session\" might commit to the DB multiple times (every 60s currently), which previously resulted in compactions happening after multiple commits to the database. As compactions are expensive and memory hungry, we want to avoid them until the end of the session. At the end of the session we can run it in parallel to node.js SSG.",
    "sha": "df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
    "files": [
        {
            "sha": "c92bab4d2b062fa726e9db5e5c05d1d9944c7a06",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -253,6 +253,8 @@ pub struct NapiTurboEngineOptions {\n     pub dependency_tracking: Option<bool>,\n     /// Whether the project is running in a CI environment.\n     pub is_ci: Option<bool>,\n+    /// Whether the project is running in a short session.\n+    pub is_short_session: Option<bool>,\n }\n \n impl From<NapiWatchOptions> for WatchOptions {\n@@ -434,12 +436,14 @@ pub fn project_new(\n         let persistent_caching = turbo_engine_options.persistent_caching.unwrap_or_default();\n         let dependency_tracking = turbo_engine_options.dependency_tracking.unwrap_or(true);\n         let is_ci = turbo_engine_options.is_ci.unwrap_or(false);\n+        let is_short_session = turbo_engine_options.is_short_session.unwrap_or(false);\n         let turbo_tasks = create_turbo_tasks(\n             PathBuf::from(&options.dist_dir),\n             persistent_caching,\n             memory_limit,\n             dependency_tracking,\n             is_ci,\n+            is_short_session,\n         )?;\n         let turbopack_ctx = NextTurbopackContext::new(turbo_tasks.clone(), napi_callbacks);\n "
        },
        {
            "sha": "5731d98607817fa7ac423d855133360f85f7d90b",
            "filename": "crates/napi/src/next_api/turbopack_ctx.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -185,15 +185,20 @@ pub fn create_turbo_tasks(\n     _memory_limit: usize,\n     dependency_tracking: bool,\n     is_ci: bool,\n+    is_short_session: bool,\n ) -> Result<NextTurboTasks> {\n     Ok(if persistent_caching {\n         let version_info = GitVersionInfo {\n             describe: env!(\"VERGEN_GIT_DESCRIBE\"),\n             dirty: option_env!(\"CI\").is_none_or(|value| value.is_empty())\n                 && env!(\"VERGEN_GIT_DIRTY\") == \"true\",\n         };\n-        let (backing_storage, cache_state) =\n-            default_backing_storage(&output_path.join(\"cache/turbopack\"), &version_info, is_ci)?;\n+        let (backing_storage, cache_state) = default_backing_storage(\n+            &output_path.join(\"cache/turbopack\"),\n+            &version_info,\n+            is_ci,\n+            is_short_session,\n+        )?;\n         let tt = TurboTasks::new(TurboTasksBackend::new(\n             BackendOptions {\n                 storage_mode: Some(if std::env::var(\"TURBO_ENGINE_READ_ONLY\").is_ok() {"
        },
        {
            "sha": "66d96902d9145f72b99fc5bf4bb9f99838a115d7",
            "filename": "packages/next/src/build/swc/generated-native.d.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Fgenerated-native.d.ts?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -212,6 +212,8 @@ export interface NapiTurboEngineOptions {\n   dependencyTracking?: boolean\n   /** Whether the project is running in a CI environment. */\n   isCi?: boolean\n+  /** Whether the project is running in a short session. */\n+  isShortSession?: boolean\n }\n export declare function projectNew(\n   options: NapiProjectOptions,"
        },
        {
            "sha": "ea889939dd0d4703c41d70218cafb9eda31f8e32",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -91,6 +91,7 @@ export async function turbopackBuild(): Promise<{\n       memoryLimit: config.experimental?.turbopackMemoryLimit,\n       dependencyTracking: persistentCaching,\n       isCi: isCI,\n+      isShortSession: true,\n     }\n   )\n   try {"
        },
        {
            "sha": "031623b54c6bc196880b9e17b139f3c0ca1e92b6",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -254,6 +254,7 @@ export async function createHotReloaderTurbopack(\n     {\n       persistentCaching: isPersistentCachingEnabled(opts.nextConfig),\n       memoryLimit: opts.nextConfig.experimental?.turbopackMemoryLimit,\n+      isShortSession: false,\n     }\n   )\n   backgroundLogCompilationEvents(project, {"
        },
        {
            "sha": "82e972f268d6632c46826970df56a4fc616b7db4",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/turbo.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 7,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -30,14 +30,18 @@ const COMPACT_CONFIG: CompactConfig = CompactConfig {\n pub struct TurboKeyValueDatabase {\n     db: Arc<TurboPersistence>,\n     compact_join_handle: Mutex<Option<JoinHandle<Result<()>>>>,\n+    is_ci: bool,\n+    is_short_session: bool,\n }\n \n impl TurboKeyValueDatabase {\n-    pub fn new(versioned_path: PathBuf) -> Result<Self> {\n+    pub fn new(versioned_path: PathBuf, is_ci: bool, is_short_session: bool) -> Result<Self> {\n         let db = Arc::new(TurboPersistence::open(versioned_path)?);\n         let mut this = Self {\n             db: db.clone(),\n             compact_join_handle: Mutex::new(None),\n+            is_ci,\n+            is_short_session,\n         };\n         // start compaction in background if the database is not empty\n         if !db.is_empty() {\n@@ -98,8 +102,8 @@ impl KeyValueDatabase for TurboKeyValueDatabase {\n         Ok(WriteBatch::concurrent(TurboWriteBatch {\n             batch: self.db.write_batch()?,\n             db: &self.db,\n-            compact_join_handle: &self.compact_join_handle,\n-            initial_write: self.db.is_empty(),\n+            compact_join_handle: (!self.is_short_session && !self.db.is_empty())\n+                .then_some(&self.compact_join_handle),\n         }))\n     }\n \n@@ -110,6 +114,16 @@ impl KeyValueDatabase for TurboKeyValueDatabase {\n         if let Some(join_handle) = self.compact_join_handle.lock().take() {\n             join_handle.join().unwrap()?;\n         }\n+        // Compact the database on shutdown\n+        self.db.compact(&CompactConfig {\n+            max_merge_segment_count: if self.is_ci {\n+                // Fully compact in CI to reduce cache size\n+                usize::MAX\n+            } else {\n+                available_parallelism().map_or(4, |c| max(4, c.get()))\n+            },\n+            ..COMPACT_CONFIG\n+        })?;\n         // Shutdown the database\n         self.db.shutdown()\n     }\n@@ -118,8 +132,7 @@ impl KeyValueDatabase for TurboKeyValueDatabase {\n pub struct TurboWriteBatch<'a> {\n     batch: turbo_persistence::WriteBatch<WriteBuffer<'static>, 5>,\n     db: &'a Arc<TurboPersistence>,\n-    compact_join_handle: &'a Mutex<Option<JoinHandle<Result<()>>>>,\n-    initial_write: bool,\n+    compact_join_handle: Option<&'a Mutex<Option<JoinHandle<Result<()>>>>>,\n }\n \n impl<'a> BaseWriteBatch<'a> for TurboWriteBatch<'a> {\n@@ -140,7 +153,7 @@ impl<'a> BaseWriteBatch<'a> for TurboWriteBatch<'a> {\n         // Commit the write batch\n         self.db.commit_write_batch(self.batch)?;\n \n-        if !self.initial_write {\n+        if let Some(compact_join_handle) = self.compact_join_handle {\n             // Start a new compaction in the background\n             let db = self.db.clone();\n             let handle = spawn(move || {\n@@ -150,7 +163,7 @@ impl<'a> BaseWriteBatch<'a> for TurboWriteBatch<'a> {\n                     ..COMPACT_CONFIG\n                 })\n             });\n-            self.compact_join_handle.lock().replace(handle);\n+            compact_join_handle.lock().replace(handle);\n         }\n \n         Ok(())"
        },
        {
            "sha": "6d1ad48a488d0bf7519657f1e59d353a02711981",
            "filename": "turbopack/crates/turbo-tasks-backend/src/lib.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -83,12 +83,13 @@ pub fn turbo_backing_storage(\n     base_path: &Path,\n     version_info: &GitVersionInfo,\n     is_ci: bool,\n+    is_short_session: bool,\n ) -> Result<(TurboBackingStorage, StartupCacheState)> {\n     KeyValueDatabaseBackingStorage::open_versioned_on_disk(\n         base_path.to_owned(),\n         version_info,\n         is_ci,\n-        TurboKeyValueDatabase::new,\n+        |path| TurboKeyValueDatabase::new(path, is_ci, is_short_session),\n     )\n }\n \n@@ -111,13 +112,14 @@ pub fn default_backing_storage(\n     path: &Path,\n     version_info: &GitVersionInfo,\n     is_ci: bool,\n+    is_short_session: bool,\n ) -> Result<(DefaultBackingStorage, StartupCacheState)> {\n     #[cfg(feature = \"lmdb\")]\n     {\n         lmdb_backing_storage(path, version_info, is_ci)\n     }\n     #[cfg(not(feature = \"lmdb\"))]\n     {\n-        turbo_backing_storage(path, version_info, is_ci)\n+        turbo_backing_storage(path, version_info, is_ci, is_short_session)\n     }\n }"
        },
        {
            "sha": "42a9ac0c47b58b18110aa73e9a62fb3bee053da1",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/test_config.trs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -16,7 +16,8 @@\n           describe: \"test-unversioned\",\n           dirty: false,\n         },\n-        false\n+        false,\n+        true,\n       ).unwrap().0\n     )\n   )"
        },
        {
            "sha": "42a9ac0c47b58b18110aa73e9a62fb3bee053da1",
            "filename": "turbopack/crates/turbo-tasks-fetch/tests/test_config.trs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -16,7 +16,8 @@\n           describe: \"test-unversioned\",\n           dirty: false,\n         },\n-        false\n+        false,\n+        true,\n       ).unwrap().0\n     )\n   )"
        },
        {
            "sha": "4670a3905dddbed9afbc180dcc5dde1bf77de4e5",
            "filename": "turbopack/crates/turbopack/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/df1f762adf3e9c80bc62d0d9cba2443e7bbf090d/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs?ref=df1f762adf3e9c80bc62d0d9cba2443e7bbf090d",
            "patch": "@@ -292,6 +292,7 @@ fn node_file_trace_persistent(#[case] input: CaseInput) {\n                     dirty: false,\n                 },\n                 false,\n+                true,\n             )\n             .unwrap()\n             .0,"
        }
    ],
    "stats": {
        "total": 57,
        "additions": 44,
        "deletions": 13
    }
}