{
    "author": "lukesandberg",
    "message": "[Turbopack] Remove `ssr-data` module context (#83626)\n\nSSR data is a special module context for development usecases to help with HMR of pages router pages.  This allows us to transform pages to strip the Component export, then the dev server can tell the difference between server side and client side changes which informs what kind of refresh we need to do.\n\nInstead, create a new `ReferenceEntrySubType` and configure the `export stripping` transform to trigger using that.  This is a better approach since we only need to transform that module instead of putting a lot of dependencies in the new module-context and assert layer.\n\nThis should be a development time performance improvement for pages router\n\nFinally delete a number of the `_runtime_entries` functions for server contexts.  These were always empty and were a user of the `ServerContextType::PagesData` enum varient that was being deleted.  \n\nCloses PACK-4155",
    "sha": "1e01d06838247426089b2bfc9118bb45123b20a6",
    "files": [
        {
            "sha": "ccf596e23d0e9b4dcd2865c3d369500bdbab359a",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 34,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -12,8 +12,8 @@ use next_core::{\n         get_app_page_entry, get_app_route_entry, metadata::route::get_app_metadata_route_entry,\n     },\n     next_client::{\n-        ClientContextType, RuntimeEntries, get_client_module_options_context,\n-        get_client_resolve_options_context, get_client_runtime_entries,\n+        ClientContextType, get_client_module_options_context, get_client_resolve_options_context,\n+        get_client_runtime_entries,\n     },\n     next_client_reference::{\n         ClientReferenceGraphResult, NextCssClientReferenceTransition,\n@@ -29,7 +29,6 @@ use next_core::{\n     },\n     next_server::{\n         ServerContextType, get_server_module_options_context, get_server_resolve_options_context,\n-        get_server_runtime_entries,\n     },\n     next_server_utility::{NEXT_SERVER_UTILITY_MERGE_TAG, NextServerUtilityTransition},\n     parse_segment_config_from_source,\n@@ -778,26 +777,6 @@ impl AppProject {\n         ))\n     }\n \n-    #[turbo_tasks::function]\n-    async fn runtime_entries(self: Vc<Self>) -> Result<Vc<RuntimeEntries>> {\n-        Ok(get_server_runtime_entries(\n-            self.rsc_ty().owned().await?,\n-            self.project().next_mode(),\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn rsc_runtime_entries(self: Vc<Self>) -> Vc<EvaluatableAssets> {\n-        self.runtime_entries()\n-            .resolve_entries(Vc::upcast(self.rsc_module_context()))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn edge_rsc_runtime_entries(self: Vc<Self>) -> Vc<EvaluatableAssets> {\n-        self.runtime_entries()\n-            .resolve_entries(Vc::upcast(self.edge_rsc_module_context()))\n-    }\n-\n     #[turbo_tasks::function]\n     fn client_env(self: Vc<Self>) -> Vc<Box<dyn ProcessEnv>> {\n         Vc::upcast(CustomProcessEnv::new(\n@@ -1780,17 +1759,11 @@ impl AppEndpoint {\n                     )\n                     .await?;\n \n-                let edge_rsc_runtime_entries = this.app_project.edge_rsc_runtime_entries().await?;\n-                let evaluatable_assets = edge_rsc_runtime_entries\n-                    .iter()\n-                    .map(|m| ResolvedVc::upcast(*m))\n-                    .chain(std::iter::once(app_entry.rsc_entry));\n-\n                 assets.concatenate(\n                     chunking_context\n                         .evaluated_chunk_group_assets(\n                             app_entry.rsc_entry.ident(),\n-                            ChunkGroup::Entry(evaluatable_assets.collect()),\n+                            ChunkGroup::Entry(vec![app_entry.rsc_entry]),\n                             module_graph,\n                             availability_info,\n                         )\n@@ -1799,13 +1772,11 @@ impl AppEndpoint {\n                 )\n             }\n             NextRuntime::NodeJs => {\n-                let mut evaluatable_assets = this.app_project.rsc_runtime_entries().owned().await?;\n-\n                 let Some(rsc_entry) = ResolvedVc::try_downcast(app_entry.rsc_entry) else {\n                     bail!(\"rsc_entry must be evaluatable\");\n                 };\n \n-                evaluatable_assets.push(rsc_entry);\n+                let evaluatable_assets = Vc::cell(vec![rsc_entry]);\n \n                 async {\n                     let mut current_chunks = OutputAssets::empty();\n@@ -1909,7 +1880,7 @@ impl AppEndpoint {\n                                     \"app{original_name}.js\",\n                                     original_name = app_entry.original_name\n                                 ))?,\n-                                Vc::cell(evaluatable_assets),\n+                                evaluatable_assets,\n                                 module_graph,\n                                 current_chunks,\n                                 current_availability_info,"
        },
        {
            "sha": "09bee50b42bd6f2a5b78db90474b3501972bdade",
            "filename": "crates/next-api/src/instrumentation.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 29,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -3,7 +3,6 @@ use next_core::{\n     all_assets_from_entries,\n     next_edge::entry::wrap_edge_entry,\n     next_manifests::{InstrumentationDefinition, MiddlewaresManifestV2},\n-    next_server::{ServerContextType, get_server_runtime_entries},\n };\n use tracing::Instrument;\n use turbo_rcstr::{RcStr, rcstr};\n@@ -104,26 +103,10 @@ impl InstrumentationEndpoint {\n \n         let module_graph = this.project.module_graph(*module);\n \n-        let evaluatable_assets = get_server_runtime_entries(\n-            ServerContextType::Instrumentation {\n-                app_dir: this.app_dir.clone(),\n-                ecmascript_client_reference_transition_name: this\n-                    .ecmascript_client_reference_transition_name\n-                    .clone(),\n-            },\n-            this.project.next_mode(),\n-        )\n-        .resolve_entries(*this.asset_context)\n-        .await?\n-        .iter()\n-        .map(|m| ResolvedVc::upcast(*m))\n-        .chain(std::iter::once(module))\n-        .collect();\n-\n         let edge_chunking_context = this.project.edge_chunking_context(false);\n         let edge_files: Vc<OutputAssets> = edge_chunking_context.evaluated_chunk_group_assets(\n             module.ident(),\n-            ChunkGroup::Entry(evaluatable_assets),\n+            ChunkGroup::Entry(vec![module]),\n             module_graph,\n             AvailabilityInfo::Root,\n         );\n@@ -150,17 +133,7 @@ impl InstrumentationEndpoint {\n                     .node_root()\n                     .await?\n                     .join(\"server/instrumentation.js\")?,\n-                get_server_runtime_entries(\n-                    ServerContextType::Instrumentation {\n-                        app_dir: this.app_dir.clone(),\n-                        ecmascript_client_reference_transition_name: this\n-                            .ecmascript_client_reference_transition_name\n-                            .clone(),\n-                    },\n-                    this.project.next_mode(),\n-                )\n-                .resolve_entries(*this.asset_context)\n-                .with_entry(*module),\n+                Vc::cell(vec![module]),\n                 module_graph,\n                 OutputAssets::empty(),\n                 AvailabilityInfo::Root,"
        },
        {
            "sha": "0e38bcfc8bc286631b14abdfbe1711c297c8b2a0",
            "filename": "crates/next-api/src/middleware.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 29,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -6,7 +6,6 @@ use next_core::{\n     middleware::get_middleware_module,\n     next_edge::entry::wrap_edge_entry,\n     next_manifests::{EdgeFunctionDefinition, MiddlewareMatcher, MiddlewaresManifestV2, Regions},\n-    next_server::{ServerContextType, get_server_runtime_entries},\n     parse_segment_config_from_source,\n     segment_config::ParseSegmentMode,\n     util::{MiddlewareMatcherKind, NextRuntime},\n@@ -111,26 +110,10 @@ impl MiddlewareEndpoint {\n \n         let module_graph = this.project.module_graph(*module);\n \n-        let evaluatable_assets = get_server_runtime_entries(\n-            ServerContextType::Middleware {\n-                app_dir: this.app_dir.clone(),\n-                ecmascript_client_reference_transition_name: this\n-                    .ecmascript_client_reference_transition_name\n-                    .clone(),\n-            },\n-            this.project.next_mode(),\n-        )\n-        .resolve_entries(*this.asset_context)\n-        .await?\n-        .iter()\n-        .map(|m| ResolvedVc::upcast(*m))\n-        .chain(std::iter::once(module))\n-        .collect();\n-\n         let edge_chunking_context = this.project.edge_chunking_context(false);\n         let edge_files = edge_chunking_context.evaluated_chunk_group_assets(\n             module.ident(),\n-            ChunkGroup::Entry(evaluatable_assets),\n+            ChunkGroup::Entry(vec![module]),\n             module_graph,\n             AvailabilityInfo::Root,\n         );\n@@ -156,17 +139,7 @@ impl MiddlewareEndpoint {\n                     .node_root()\n                     .await?\n                     .join(\"server/middleware.js\")?,\n-                get_server_runtime_entries(\n-                    ServerContextType::Middleware {\n-                        app_dir: this.app_dir.clone(),\n-                        ecmascript_client_reference_transition_name: this\n-                            .ecmascript_client_reference_transition_name\n-                            .clone(),\n-                    },\n-                    this.project.next_mode(),\n-                )\n-                .resolve_entries(*this.asset_context)\n-                .with_entry(*module),\n+                Vc::cell(vec![module]),\n                 module_graph,\n                 OutputAssets::empty(),\n                 AvailabilityInfo::Root,"
        },
        {
            "sha": "e9769f20500b16d7116b86ade12d5b4b4a86f833",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 129,
            "changes": 150,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -6,8 +6,8 @@ use next_core::{\n     hmr_entry::HmrEntryModule,\n     mode::NextMode,\n     next_client::{\n-        ClientContextType, RuntimeEntries, get_client_module_options_context,\n-        get_client_resolve_options_context, get_client_runtime_entries,\n+        ClientContextType, get_client_module_options_context, get_client_resolve_options_context,\n+        get_client_runtime_entries,\n     },\n     next_dynamic::NextDynamicTransition,\n     next_edge::route_regex::get_named_middleware_regex,\n@@ -18,7 +18,6 @@ use next_core::{\n     next_pages::create_page_ssr_entry_module,\n     next_server::{\n         ServerContextType, get_server_module_options_context, get_server_resolve_options_context,\n-        get_server_runtime_entries,\n     },\n     pages_structure::{\n         PagesDirectoryStructure, PagesStructure, PagesStructureItem, find_pages_structure,\n@@ -403,17 +402,6 @@ impl PagesProject {\n         )\n     }\n \n-    #[turbo_tasks::function]\n-    pub(super) fn ssr_data_module_context(self: Vc<Self>) -> Vc<ModuleAssetContext> {\n-        ModuleAssetContext::new(\n-            self.server_transitions(),\n-            self.project().server_compile_time_info(),\n-            self.ssr_data_module_options_context(),\n-            self.ssr_resolve_options_context(),\n-            Layer::new(rcstr!(\"ssr-data\")),\n-        )\n-    }\n-\n     #[turbo_tasks::function]\n     pub(super) fn edge_ssr_module_context(self: Vc<Self>) -> Vc<ModuleAssetContext> {\n         ModuleAssetContext::new(\n@@ -436,17 +424,6 @@ impl PagesProject {\n         )\n     }\n \n-    #[turbo_tasks::function]\n-    pub(super) fn edge_ssr_data_module_context(self: Vc<Self>) -> Vc<ModuleAssetContext> {\n-        ModuleAssetContext::new(\n-            Default::default(),\n-            self.project().edge_compile_time_info(),\n-            self.edge_ssr_data_module_options_context(),\n-            self.edge_ssr_resolve_options_context(),\n-            Layer::new(rcstr!(\"edge-ssr-data\")),\n-        )\n-    }\n-\n     #[turbo_tasks::function]\n     async fn ssr_module_options_context(self: Vc<Self>) -> Result<Vc<ModuleOptionsContext>> {\n         Ok(get_server_module_options_context(\n@@ -515,42 +492,6 @@ impl PagesProject {\n         ))\n     }\n \n-    #[turbo_tasks::function]\n-    async fn ssr_data_module_options_context(self: Vc<Self>) -> Result<Vc<ModuleOptionsContext>> {\n-        Ok(get_server_module_options_context(\n-            self.project().project_path().owned().await?,\n-            self.project().execution_context(),\n-            ServerContextType::PagesData {\n-                pages_dir: self.pages_dir().owned().await?,\n-            },\n-            self.project().next_mode(),\n-            self.project().next_config(),\n-            NextRuntime::NodeJs,\n-            self.project().encryption_key(),\n-            self.project().server_compile_time_info().environment(),\n-            self.project().client_compile_time_info().environment(),\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    async fn edge_ssr_data_module_options_context(\n-        self: Vc<Self>,\n-    ) -> Result<Vc<ModuleOptionsContext>> {\n-        Ok(get_server_module_options_context(\n-            self.project().project_path().owned().await?,\n-            self.project().execution_context(),\n-            ServerContextType::PagesData {\n-                pages_dir: self.pages_dir().owned().await?,\n-            },\n-            self.project().next_mode(),\n-            self.project().next_config(),\n-            NextRuntime::Edge,\n-            self.project().encryption_key(),\n-            self.project().edge_compile_time_info().environment(),\n-            self.project().client_compile_time_info().environment(),\n-        ))\n-    }\n-\n     #[turbo_tasks::function]\n     async fn ssr_resolve_options_context(self: Vc<Self>) -> Result<Vc<ResolveOptionsContext>> {\n         Ok(get_server_resolve_options_context(\n@@ -599,50 +540,6 @@ impl PagesProject {\n         Ok(client_runtime_entries.resolve_entries(Vc::upcast(self.client_module_context())))\n     }\n \n-    #[turbo_tasks::function]\n-    async fn runtime_entries(self: Vc<Self>) -> Result<Vc<RuntimeEntries>> {\n-        Ok(get_server_runtime_entries(\n-            ServerContextType::Pages {\n-                pages_dir: self.pages_dir().owned().await?,\n-            },\n-            self.project().next_mode(),\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    async fn data_runtime_entries(self: Vc<Self>) -> Result<Vc<RuntimeEntries>> {\n-        Ok(get_server_runtime_entries(\n-            ServerContextType::PagesData {\n-                pages_dir: self.pages_dir().owned().await?,\n-            },\n-            self.project().next_mode(),\n-        ))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn ssr_runtime_entries(self: Vc<Self>) -> Vc<EvaluatableAssets> {\n-        let ssr_runtime_entries = self.runtime_entries();\n-        ssr_runtime_entries.resolve_entries(Vc::upcast(self.ssr_module_context()))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn ssr_data_runtime_entries(self: Vc<Self>) -> Vc<EvaluatableAssets> {\n-        let ssr_data_runtime_entries = self.data_runtime_entries();\n-        ssr_data_runtime_entries.resolve_entries(Vc::upcast(self.ssr_module_context()))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn edge_ssr_runtime_entries(self: Vc<Self>) -> Vc<EvaluatableAssets> {\n-        let ssr_runtime_entries = self.runtime_entries();\n-        ssr_runtime_entries.resolve_entries(Vc::upcast(self.edge_ssr_module_context()))\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn edge_ssr_data_runtime_entries(self: Vc<Self>) -> Vc<EvaluatableAssets> {\n-        let ssr_data_runtime_entries = self.data_runtime_entries();\n-        ssr_data_runtime_entries.resolve_entries(Vc::upcast(self.edge_ssr_module_context()))\n-    }\n-\n     #[turbo_tasks::function]\n     pub async fn client_main_module(self: Vc<Self>) -> Result<Vc<Box<dyn Module>>> {\n         let client_module_context = Vc::upcast(self.client_module_context());\n@@ -697,7 +594,10 @@ struct PageEndpoint {\n enum PageEndpointType {\n     Api,\n     Html,\n+    // A development only type that is used in pages router so we can differentiate between\n+    // components changing and server props changing.\n     Data,\n+    // for _document.js\n     SsrOnly,\n }\n \n@@ -746,8 +646,15 @@ impl PageEndpoint {\n \n     #[turbo_tasks::function]\n     async fn source(&self) -> Result<Vc<Box<dyn Source>>> {\n-        Ok(Vc::upcast(FileSource::new(\n+        Ok(Vc::upcast(FileSource::new_with_query(\n             self.page.file_path().owned().await?,\n+            // When creating a data endpoint we also create an Html endpoint for the same source\n+            // So add a query parameter to differentiate between the two.\n+            if self.ty == PageEndpointType::Data {\n+                rcstr!(\"?server-data\")\n+            } else {\n+                RcStr::default()\n+            },\n         )))\n     }\n \n@@ -918,10 +825,10 @@ impl PageEndpoint {\n                 this.pages_project.edge_ssr_module_context(),\n             ),\n             PageEndpointType::Data => (\n-                ReferenceType::Entry(EntryReferenceSubType::Page),\n+                ReferenceType::Entry(EntryReferenceSubType::PageData),\n                 this.pages_project.project().project_path().owned().await?,\n-                this.pages_project.ssr_data_module_context(),\n-                this.pages_project.edge_ssr_data_module_context(),\n+                this.pages_project.ssr_module_context(),\n+                this.pages_project.edge_ssr_module_context(),\n             ),\n             PageEndpointType::Api => (\n                 ReferenceType::Entry(EntryReferenceSubType::PagesApi),\n@@ -931,10 +838,6 @@ impl PageEndpoint {\n             ),\n         };\n \n-        let ssr_module = module_context\n-            .process(self.source(), reference_type.clone())\n-            .module();\n-\n         let config =\n             parse_segment_config_from_source(self.source(), ParseSegmentMode::Base).await?;\n \n@@ -945,6 +848,9 @@ impl PageEndpoint {\n             // wrapped in the route module, and don't need to be handled as edge runtime as the\n             // rendering for edge is part of the page bundle.\n             if this.pathname == \"/_app\" || this.pathname == \"/_document\" {\n+                let ssr_module = module_context\n+                    .process(self.source(), reference_type)\n+                    .module();\n                 InternalSsrChunkModule {\n                     ssr_module: ssr_module.to_resolved().await?,\n                     app_module: None,\n@@ -1008,8 +914,6 @@ impl PageEndpoint {\n         node_path: FileSystemPath,\n         node_chunking_context: Vc<NodeJsChunkingContext>,\n         edge_chunking_context: Vc<Box<dyn ChunkingContext>>,\n-        runtime_entries: Vc<EvaluatableAssets>,\n-        edge_runtime_entries: Vc<EvaluatableAssets>,\n     ) -> Result<Vc<SsrChunk>> {\n         async move {\n             let this = self.await?;\n@@ -1126,15 +1030,9 @@ impl PageEndpoint {\n                 .context(\"could not process page loader entry module\")?;\n             let is_edge = matches!(runtime, NextRuntime::Edge);\n             if is_edge {\n-                let edge_runtime_entries = edge_runtime_entries.await?;\n-                let evaluatable_assets = edge_runtime_entries\n-                    .iter()\n-                    .map(|m| ResolvedVc::upcast(*m))\n-                    .chain(std::iter::once(ResolvedVc::upcast(ssr_module_evaluatable)));\n-\n                 let edge_files = edge_chunking_context.evaluated_chunk_group_assets(\n                     ssr_module.ident(),\n-                    ChunkGroup::Entry(evaluatable_assets.collect()),\n+                    ChunkGroup::Entry(vec![ResolvedVc::upcast(ssr_module_evaluatable)]),\n                     ssr_module_graph,\n                     current_availability_info,\n                 );\n@@ -1155,7 +1053,7 @@ impl PageEndpoint {\n                 let ssr_entry_chunk = node_chunking_context\n                     .entry_chunk_group_asset(\n                         ssr_entry_chunk_path,\n-                        runtime_entries.with_entry(*ssr_module_evaluatable),\n+                        EvaluatableAssets::empty().with_entry(*ssr_module_evaluatable),\n                         ssr_module_graph,\n                         current_chunks,\n                         current_availability_info,\n@@ -1224,8 +1122,6 @@ impl PageEndpoint {\n                 .join(\"server\")?,\n             project.server_chunking_context(true),\n             project.edge_chunking_context(true),\n-            this.pages_project.ssr_runtime_entries(),\n-            this.pages_project.edge_ssr_runtime_entries(),\n         ))\n     }\n \n@@ -1242,8 +1138,6 @@ impl PageEndpoint {\n                 .join(\"server/data\")?,\n             this.pages_project.project().server_chunking_context(true),\n             this.pages_project.project().edge_chunking_context(true),\n-            this.pages_project.ssr_data_runtime_entries(),\n-            this.pages_project.edge_ssr_data_runtime_entries(),\n         ))\n     }\n \n@@ -1260,8 +1154,6 @@ impl PageEndpoint {\n                 .join(\"server\")?,\n             this.pages_project.project().server_chunking_context(false),\n             this.pages_project.project().edge_chunking_context(false),\n-            this.pages_project.ssr_runtime_entries(),\n-            this.pages_project.edge_ssr_runtime_entries(),\n         ))\n     }\n "
        },
        {
            "sha": "336f2295c7d8ea1a114684126d18adfd79d276f5",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -1838,18 +1838,16 @@ async fn any_output_changed(\n                     && (!server || !asset_path.path.ends_with(\".css\"))\n                     && asset_path.is_inside_ref(&path)\n                 {\n-                    anyhow::Ok(Some(content_changed(*ResolvedVc::upcast(m))))\n+                    anyhow::Ok(Some(\n+                        content_changed(*ResolvedVc::upcast(m))\n+                            .to_resolved()\n+                            .await?,\n+                    ))\n                 } else {\n                     Ok(None)\n                 }\n             }\n         })\n-        .map(|v| async move {\n-            Ok(match v.await? {\n-                Some(v) => Some(v.to_resolved().await?),\n-                None => None,\n-            })\n-        })\n         .try_flat_join()\n         .await?;\n "
        },
        {
            "sha": "4bc4940c0b1e37ee30b7b381c4ca563af96be871",
            "filename": "crates/next-core/src/next_client/transforms.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Ftransforms.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -54,14 +54,12 @@ pub async fn get_next_client_transforms_rules(\n     match &context_ty {\n         ClientContextType::Pages { pages_dir } => {\n             if !foreign_code {\n-                rules.push(\n-                    get_next_pages_transforms_rule(\n-                        pages_dir.clone(),\n-                        ExportFilter::StripDataExports,\n-                        enable_mdx_rs,\n-                    )\n-                    .await?,\n-                );\n+                rules.push(get_next_pages_transforms_rule(\n+                    pages_dir.clone(),\n+                    ExportFilter::StripDataExports,\n+                    enable_mdx_rs,\n+                    vec![],\n+                )?);\n                 rules.push(get_next_disallow_export_all_in_page_rule(\n                     enable_mdx_rs,\n                     pages_dir.clone(),"
        },
        {
            "sha": "cd780efb06015e2b87da251074e6c204a7d141e9",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -124,7 +124,6 @@ pub async fn get_edge_resolve_options_context(\n         ty,\n         ServerContextType::AppRSC { .. }\n             | ServerContextType::AppRoute { .. }\n-            | ServerContextType::PagesData { .. }\n             | ServerContextType::Middleware { .. }\n             | ServerContextType::Instrumentation { .. }\n     ) {"
        },
        {
            "sha": "c8b8a3b9127ed66c17db5490f2a6360852b4f197",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 10,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -345,9 +345,7 @@ pub async fn get_next_server_import_map(\n \n     import_map.insert_exact_alias(rcstr!(\"next/dist/server/require-hook\"), external);\n     match ty {\n-        ServerContextType::Pages { .. }\n-        | ServerContextType::PagesData { .. }\n-        | ServerContextType::PagesApi { .. } => {\n+        ServerContextType::Pages { .. } | ServerContextType::PagesApi { .. } => {\n             import_map.insert_exact_alias(rcstr!(\"react\"), external);\n             import_map.insert_wildcard_alias(rcstr!(\"react/\"), external);\n             import_map.insert_exact_alias(rcstr!(\"react-dom\"), external);\n@@ -494,7 +492,6 @@ pub async fn get_next_edge_import_map(\n \n     match &ty {\n         ServerContextType::Pages { .. }\n-        | ServerContextType::PagesData { .. }\n         | ServerContextType::PagesApi { .. }\n         | ServerContextType::Middleware { .. }\n         | ServerContextType::Instrumentation { .. } => {}\n@@ -547,7 +544,6 @@ pub async fn get_next_edge_import_map(\n         | ServerContextType::Middleware { .. }\n         | ServerContextType::Instrumentation { .. }\n         | ServerContextType::Pages { .. }\n-        | ServerContextType::PagesData { .. }\n         | ServerContextType::PagesApi { .. } => {\n             insert_unsupported_node_internal_aliases(&mut import_map).await?;\n         }\n@@ -705,7 +701,6 @@ async fn insert_next_server_special_aliases(\n \n     match &ty {\n         ServerContextType::Pages { .. } | ServerContextType::PagesApi { .. } => {}\n-        ServerContextType::PagesData { .. } => {}\n         // the logic closely follows the one in createRSCAliases in webpack-config.ts\n         ServerContextType::AppSSR { app_dir }\n         | ServerContextType::AppRSC { app_dir, .. }\n@@ -759,8 +754,7 @@ async fn insert_next_server_special_aliases(\n                 },\n             );\n         }\n-        ServerContextType::PagesData { .. }\n-        | ServerContextType::PagesApi { .. }\n+        ServerContextType::PagesApi { .. }\n         | ServerContextType::AppRSC { .. }\n         | ServerContextType::AppRoute { .. }\n         | ServerContextType::Middleware { .. }\n@@ -1243,11 +1237,12 @@ async fn insert_next_shared_aliases(\n \n #[turbo_tasks::function]\n pub async fn get_next_package(context_directory: FileSystemPath) -> Result<Vc<FileSystemPath>> {\n+    let root = context_directory.root().owned().await?;\n     let result = resolve(\n-        context_directory.clone(),\n+        context_directory,\n         ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined),\n         Request::parse(Pattern::Constant(rcstr!(\"next/package.json\"))),\n-        node_cjs_resolve_options(context_directory.root().owned().await?),\n+        node_cjs_resolve_options(root),\n     );\n     let source = result\n         .first_source()"
        },
        {
            "sha": "2ef14953eb4f9a2acd4ccb58604c94f3b281dd0c",
            "filename": "crates/next-core/src/next_pages/page_entry.rs",
            "status": "modified",
            "additions": 59,
            "deletions": 32,
            "changes": 91,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -51,7 +51,8 @@ pub async fn create_page_ssr_entry_module(\n         .await?;\n \n     let template_file = match (&reference_type, runtime) {\n-        (ReferenceType::Entry(EntryReferenceSubType::Page), _) => {\n+        (ReferenceType::Entry(EntryReferenceSubType::Page), _)\n+        | (ReferenceType::Entry(EntryReferenceSubType::PageData), _) => {\n             // Load the Page entry file.\n             \"pages.js\"\n         }\n@@ -77,10 +78,20 @@ pub async fn create_page_ssr_entry_module(\n         (\"VAR_USERLAND\", &inner),\n     ];\n \n-    if reference_type == ReferenceType::Entry(EntryReferenceSubType::Page) {\n+    let is_page = matches!(\n+        reference_type,\n+        ReferenceType::Entry(EntryReferenceSubType::Page)\n+            | ReferenceType::Entry(EntryReferenceSubType::PageData)\n+    );\n+    if is_page {\n         replacements.push((\"VAR_MODULE_DOCUMENT\", &inner_document));\n         replacements.push((\"VAR_MODULE_APP\", &inner_app));\n     }\n+    let source_ident = source.ident().await?;\n+    // for PagesData we apply a ?server-data query parameter to avoid conflicts with the Page\n+    // module.\n+    // We need to copy that to all the modules we create.\n+    let source_query = source_ident.query.clone();\n \n     // Load the file from the next.js codebase.\n     let mut source =\n@@ -89,7 +100,7 @@ pub async fn create_page_ssr_entry_module(\n     // When we're building the instrumentation page (only when the\n     // instrumentation file conflicts with a page also labeled\n     // /instrumentation) hoist the `register` method.\n-    if reference_type == ReferenceType::Entry(EntryReferenceSubType::Page)\n+    if is_page\n         && (definition_page == \"/instrumentation\" || definition_page == \"/src/instrumentation\")\n     {\n         let file = &*file_content_rope(source.content().file_content()).await?;\n@@ -104,8 +115,8 @@ pub async fn create_page_ssr_entry_module(\n \n         let file = File::from(result.build());\n \n-        source = Vc::upcast(VirtualSource::new(\n-            source.ident().path().owned().await?,\n+        source = Vc::upcast(VirtualSource::new_with_ident(\n+            source.ident(),\n             AssetContent::file(file.into()),\n         ));\n     }\n@@ -116,28 +127,30 @@ pub async fn create_page_ssr_entry_module(\n \n     let pages_structure_ref = pages_structure.await?;\n \n-    let (app_module, document_module) =\n-        if reference_type == ReferenceType::Entry(EntryReferenceSubType::Page) {\n-            let document_module = process_global_item(\n-                *pages_structure_ref.document,\n-                reference_type.clone(),\n-                ssr_module_context,\n-            )\n-            .to_resolved()\n-            .await?;\n-            let app_module = process_global_item(\n-                *pages_structure_ref.app,\n-                reference_type.clone(),\n-                ssr_module_context,\n-            )\n-            .to_resolved()\n-            .await?;\n-            inner_assets.insert(inner_document, document_module);\n-            inner_assets.insert(inner_app, app_module);\n-            (Some(app_module), Some(document_module))\n-        } else {\n-            (None, None)\n-        };\n+    let (app_module, document_module) = if is_page {\n+        // We process the document and app modules in the same context and reference type.\n+        let document_module = process_global_item(\n+            *pages_structure_ref.document,\n+            reference_type.clone(),\n+            source_query.clone(),\n+            ssr_module_context,\n+        )\n+        .to_resolved()\n+        .await?;\n+        let app_module = process_global_item(\n+            *pages_structure_ref.app,\n+            reference_type.clone(),\n+            source_query.clone(),\n+            ssr_module_context,\n+        )\n+        .to_resolved()\n+        .await?;\n+        inner_assets.insert(inner_document, document_module);\n+        inner_assets.insert(inner_app, app_module);\n+        (Some(app_module), Some(document_module))\n+    } else {\n+        (None, None)\n+    };\n \n     let mut ssr_module = ssr_module_context\n         .process(\n@@ -147,7 +160,7 @@ pub async fn create_page_ssr_entry_module(\n         .module();\n \n     if matches!(runtime, NextRuntime::Edge) {\n-        if reference_type == ReferenceType::Entry(EntryReferenceSubType::Page) {\n+        if is_page {\n             ssr_module = wrap_edge_page(\n                 ssr_module_context,\n                 project_root,\n@@ -157,6 +170,7 @@ pub async fn create_page_ssr_entry_module(\n                 reference_type,\n                 pages_structure,\n                 next_config,\n+                source_query.clone(),\n             );\n         } else {\n             ssr_module = wrap_edge_entry(\n@@ -180,9 +194,13 @@ pub async fn create_page_ssr_entry_module(\n async fn process_global_item(\n     item: Vc<PagesStructureItem>,\n     reference_type: ReferenceType,\n+    source_query: RcStr,\n     module_context: Vc<Box<dyn AssetContext>>,\n ) -> Result<Vc<Box<dyn Module>>> {\n-    let source = Vc::upcast(FileSource::new(item.file_path().owned().await?));\n+    let source = Vc::upcast(FileSource::new_with_query(\n+        item.file_path().owned().await?,\n+        source_query,\n+    ));\n     Ok(module_context.process(source, reference_type).module())\n }\n \n@@ -196,6 +214,7 @@ async fn wrap_edge_page(\n     reference_type: ReferenceType,\n     pages_structure: Vc<PagesStructure>,\n     next_config: Vc<NextConfig>,\n+    source_query: RcStr,\n ) -> Result<Vc<Box<dyn Module>>> {\n     const INNER: &str = \"INNER_PAGE_ENTRY\";\n \n@@ -254,26 +273,34 @@ async fn wrap_edge_page(\n         INNER_DOCUMENT.into() => process_global_item(\n             *pages_structure_ref.document,\n             reference_type.clone(),\n+            source_query.clone(),\n             asset_context,\n         ).to_resolved().await?,\n         INNER_APP.into() => process_global_item(\n             *pages_structure_ref.app,\n             reference_type.clone(),\n+            source_query.clone(),\n             asset_context,\n         ).to_resolved().await?,\n         INNER_ERROR.into() => process_global_item(\n             *pages_structure_ref.error,\n             reference_type.clone(),\n+            source_query.clone(),\n             asset_context,\n         ).to_resolved().await?,\n     };\n \n     if let Some(error_500) = pages_structure_ref.error_500 {\n         inner_assets.insert(\n             INNER_ERROR_500.into(),\n-            process_global_item(*error_500, reference_type.clone(), asset_context)\n-                .to_resolved()\n-                .await?,\n+            process_global_item(\n+                *error_500,\n+                reference_type.clone(),\n+                source_query.clone(),\n+                asset_context,\n+            )\n+            .to_resolved()\n+            .await?,\n         );\n     }\n "
        },
        {
            "sha": "792242dacde4ea653b5600205de49ab5586b069e",
            "filename": "crates/next-core/src/next_root_params/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_root_params%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_root_params%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_root_params%2Fmod.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -111,8 +111,7 @@ impl NextRootParamsMapper {\n                                 })?;\n                             Self::valid_import_map_result(collected_root_params)\n                         }\n-                        ServerContextType::PagesData { .. }\n-                        | ServerContextType::PagesApi { .. }\n+                        ServerContextType::PagesApi { .. }\n                         | ServerContextType::Instrumentation { .. }\n                         | ServerContextType::Middleware { .. } => {\n                             // There's no sensible way to use root params outside of the app"
        },
        {
            "sha": "406a1baee5a25278f1dbbc62d9a68c9515b78fa8",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 23,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -46,7 +46,6 @@ use crate::{\n     app_structure::CollectedRootParams,\n     mode::NextMode,\n     next_build::get_postcss_package_mapping,\n-    next_client::RuntimeEntries,\n     next_config::NextConfig,\n     next_font::local::NextFontLocalResolvePlugin,\n     next_import_map::{get_next_edge_and_server_fallback_import_map, get_next_server_import_map},\n@@ -88,9 +87,6 @@ pub enum ServerContextType {\n     PagesApi {\n         pages_dir: FileSystemPath,\n     },\n-    PagesData {\n-        pages_dir: FileSystemPath,\n-    },\n     AppSSR {\n         app_dir: FileSystemPath,\n     },\n@@ -252,8 +248,7 @@ pub async fn get_server_resolve_options_context(\n                 ResolvedVc::upcast(module_feature_report_resolve_plugin),\n             ]\n         }\n-        ServerContextType::PagesData { .. }\n-        | ServerContextType::PagesApi { .. }\n+        ServerContextType::PagesApi { .. }\n         | ServerContextType::AppRoute { .. }\n         | ServerContextType::Middleware { .. }\n         | ServerContextType::Instrumentation { .. } => {\n@@ -262,9 +257,7 @@ pub async fn get_server_resolve_options_context(\n     };\n \n     let after_resolve_plugins = match ty {\n-        ServerContextType::Pages { .. }\n-        | ServerContextType::PagesApi { .. }\n-        | ServerContextType::PagesData { .. } => {\n+        ServerContextType::Pages { .. } | ServerContextType::PagesApi { .. } => {\n             vec![\n                 ResolvedVc::upcast(next_node_shared_runtime_plugin),\n                 ResolvedVc::upcast(external_cjs_modules_plugin),\n@@ -300,8 +293,7 @@ pub async fn get_server_resolve_options_context(\n         ServerContextType::Pages { .. } | ServerContextType::PagesApi { .. } => {\n             //noop\n         }\n-        ServerContextType::PagesData { .. }\n-        | ServerContextType::AppRSC { .. }\n+        ServerContextType::AppRSC { .. }\n         | ServerContextType::AppRoute { .. }\n         | ServerContextType::Middleware { .. }\n         | ServerContextType::Instrumentation { .. } => {\n@@ -615,9 +607,7 @@ pub async fn get_server_module_options_context(\n     };\n \n     let module_options_context = match ty {\n-        ServerContextType::Pages { .. }\n-        | ServerContextType::PagesData { .. }\n-        | ServerContextType::PagesApi { .. } => {\n+        ServerContextType::Pages { .. } | ServerContextType::PagesApi { .. } => {\n             let mut custom_source_transform_rules: Vec<ModuleRule> =\n                 vec![styled_components_transform_rule, styled_jsx_transform_rule]\n                     .into_iter()\n@@ -1009,15 +999,6 @@ pub async fn get_server_module_options_context(\n     Ok(module_options_context)\n }\n \n-#[turbo_tasks::function]\n-pub fn get_server_runtime_entries(\n-    _ty: ServerContextType,\n-    _mode: Vc<NextMode>,\n-) -> Vc<RuntimeEntries> {\n-    let runtime_entries = vec![];\n-    Vc::cell(runtime_entries)\n-}\n-\n #[derive(Clone, Debug, PartialEq, Eq, Hash, TaskInput, TraceRawVcs, Serialize, Deserialize)]\n pub struct ServerChunkingContextOptions {\n     pub mode: Vc<NextMode>,"
        },
        {
            "sha": "df917f9d2b6330b5afe5b82fe4ad5235050848c4",
            "filename": "crates/next-core/src/next_server/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -6,5 +6,5 @@ pub use context::{\n     ServerChunkingContextOptions, ServerContextType, get_server_chunking_context,\n     get_server_chunking_context_with_client_assets, get_server_compile_time_info,\n     get_server_module_options_context, get_server_resolve_options_context,\n-    get_server_runtime_entries, get_tracing_compile_time_info,\n+    get_tracing_compile_time_info,\n };"
        },
        {
            "sha": "166dacc36a282ca8a3c5833586998dc27fd39cc1",
            "filename": "crates/next-core/src/next_server/transforms.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 18,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Ftransforms.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -3,7 +3,9 @@ use next_custom_transforms::transforms::strip_page_exports::ExportFilter;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Vc};\n use turbopack::module_options::{ModuleRule, ModuleRuleEffect, RuleCondition};\n-use turbopack_core::reference_type::{CssReferenceSubType, ReferenceType, UrlReferenceSubType};\n+use turbopack_core::reference_type::{\n+    CssReferenceSubType, EntryReferenceSubType, ReferenceType, UrlReferenceSubType,\n+};\n \n use crate::{\n     mode::NextMode,\n@@ -75,26 +77,18 @@ pub async fn get_next_server_transforms_rules(\n                     mdx_rs,\n                     pages_dir.clone(),\n                 ));\n-            }\n-            false\n-        }\n-        ServerContextType::PagesData { pages_dir } => {\n-            if !foreign_code {\n-                rules.push(\n-                    get_next_pages_transforms_rule(\n-                        pages_dir.clone(),\n-                        ExportFilter::StripDefaultExport,\n-                        mdx_rs,\n-                    )\n-                    .await?,\n-                );\n-                rules.push(get_next_disallow_export_all_in_page_rule(\n-                    mdx_rs,\n+                rules.push(get_next_pages_transforms_rule(\n                     pages_dir.clone(),\n-                ));\n+                    ExportFilter::StripDefaultExport,\n+                    mdx_rs,\n+                    vec![RuleCondition::ReferenceType(ReferenceType::Entry(\n+                        EntryReferenceSubType::PageData,\n+                    ))],\n+                )?);\n             }\n             false\n         }\n+\n         ServerContextType::AppSSR { .. } => {\n             // Yah, this is SSR, but this is still treated as a Client transform layer.\n             // need to apply to foreign code too\n@@ -232,7 +226,6 @@ pub async fn get_next_server_internal_transforms_rules(\n             rules.push(get_next_font_transform_rule(mdx_rs));\n         }\n         ServerContextType::PagesApi { .. } => {}\n-        ServerContextType::PagesData { .. } => {}\n         ServerContextType::AppSSR { .. } => {\n             rules.push(get_next_font_transform_rule(mdx_rs));\n         }"
        },
        {
            "sha": "da31772f4614c71681f0674d8a6fe51acf870d05",
            "filename": "crates/next-core/src/next_shared/transforms/mod.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 11,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fmod.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -71,7 +71,7 @@ pub async fn get_next_image_rule() -> Result<ModuleRule> {\n     ))\n }\n \n-fn match_js_extension(enable_mdx_rs: bool) -> Vec<RuleCondition> {\n+fn match_js_extension(enable_mdx_rs: bool) -> RuleCondition {\n     let mut conditions = vec![\n         RuleCondition::ResourcePathEndsWith(\".js\".to_string()),\n         RuleCondition::ResourcePathEndsWith(\".jsx\".to_string()),\n@@ -98,35 +98,28 @@ fn match_js_extension(enable_mdx_rs: bool) -> Vec<RuleCondition> {\n             .as_mut(),\n         );\n     }\n-    conditions\n+    RuleCondition::any(conditions)\n }\n \n /// Returns a module rule condition matches to any ecmascript (with mdx if\n /// enabled) except url reference type. This is a typical custom rule matching\n /// condition for custom ecma specific transforms.\n pub(crate) fn module_rule_match_js_no_url(enable_mdx_rs: bool) -> RuleCondition {\n-    let conditions = match_js_extension(enable_mdx_rs);\n-\n     RuleCondition::all(vec![\n         RuleCondition::not(RuleCondition::ReferenceType(ReferenceType::Url(\n             UrlReferenceSubType::Undefined,\n         ))),\n-        RuleCondition::any(conditions),\n+        match_js_extension(enable_mdx_rs),\n     ])\n }\n \n pub(crate) fn module_rule_match_pages_page_file(\n     enable_mdx_rs: bool,\n     pages_directory: FileSystemPath,\n ) -> RuleCondition {\n-    let conditions = match_js_extension(enable_mdx_rs);\n-\n     RuleCondition::all(vec![\n-        RuleCondition::not(RuleCondition::ReferenceType(ReferenceType::Url(\n-            UrlReferenceSubType::Undefined,\n-        ))),\n+        module_rule_match_js_no_url(enable_mdx_rs),\n         RuleCondition::ResourcePathInExactDirectory(pages_directory),\n-        RuleCondition::any(conditions),\n     ])\n }\n "
        },
        {
            "sha": "de50d1138330054f28a4fa53083d8f03ac624d91",
            "filename": "crates/next-core/src/next_shared/transforms/next_strip_page_exports.rs",
            "status": "modified",
            "additions": 19,
            "deletions": 16,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_strip_page_exports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_strip_page_exports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fnext_strip_page_exports.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -12,33 +12,36 @@ use turbopack_ecmascript::{CustomTransformer, EcmascriptInputTransform, Transfor\n use super::module_rule_match_js_no_url;\n \n /// Returns a rule which applies the Next.js page export stripping transform.\n-pub async fn get_next_pages_transforms_rule(\n+pub fn get_next_pages_transforms_rule(\n     pages_dir: FileSystemPath,\n     export_filter: ExportFilter,\n     enable_mdx_rs: bool,\n+    extra_conditions: Vec<RuleCondition>,\n ) -> Result<ModuleRule> {\n     // Apply the Next SSG transform to all pages.\n     let strip_transform =\n         EcmascriptInputTransform::Plugin(ResolvedVc::cell(Box::new(NextJsStripPageExports {\n             export_filter,\n         }) as _));\n-    Ok(ModuleRule::new(\n+    let conditions = RuleCondition::all(vec![\n         RuleCondition::all(vec![\n-            RuleCondition::all(vec![\n-                RuleCondition::ResourcePathInExactDirectory(pages_dir.clone()),\n-                RuleCondition::not(RuleCondition::ResourcePathInExactDirectory(\n-                    pages_dir.join(\"api\")?,\n-                )),\n-                RuleCondition::not(RuleCondition::any(vec![\n-                    // TODO(alexkirsz): Possibly ignore _app as well?\n-                    RuleCondition::ResourcePathEquals(pages_dir.join(\"_document.js\")?),\n-                    RuleCondition::ResourcePathEquals(pages_dir.join(\"_document.jsx\")?),\n-                    RuleCondition::ResourcePathEquals(pages_dir.join(\"_document.ts\")?),\n-                    RuleCondition::ResourcePathEquals(pages_dir.join(\"_document.tsx\")?),\n-                ])),\n-            ]),\n-            module_rule_match_js_no_url(enable_mdx_rs),\n+            RuleCondition::ResourcePathInExactDirectory(pages_dir.clone()),\n+            RuleCondition::not(RuleCondition::ResourcePathInExactDirectory(\n+                pages_dir.join(\"api\")?,\n+            )),\n+            RuleCondition::not(RuleCondition::any(vec![\n+                // TODO(alexkirsz): Possibly ignore _app as well?\n+                RuleCondition::ResourcePathEquals(pages_dir.join(\"_document.js\")?),\n+                RuleCondition::ResourcePathEquals(pages_dir.join(\"_document.jsx\")?),\n+                RuleCondition::ResourcePathEquals(pages_dir.join(\"_document.ts\")?),\n+                RuleCondition::ResourcePathEquals(pages_dir.join(\"_document.tsx\")?),\n+            ])),\n         ]),\n+        module_rule_match_js_no_url(enable_mdx_rs),\n+        RuleCondition::all(extra_conditions),\n+    ]);\n+    Ok(ModuleRule::new(\n+        conditions,\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n             preprocess: ResolvedVc::cell(vec![]),\n             main: ResolvedVc::cell(vec![]),"
        },
        {
            "sha": "26a9dfceb633aa04b5689cad79f16e2a91b842f5",
            "filename": "crates/next-core/src/pages_structure.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 15,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fpages_structure.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -271,17 +271,14 @@ async fn get_pages_structure_for_root_directory(\n \n     // Only skip user pages routes during build mode when there are no user pages\n     let should_create_pages_entries = has_user_pages || next_mode.await?.is_development();\n+    let next_package = get_next_package(project_root.clone()).await?;\n \n     let app_item = {\n         let app_router_path = next_router_path.join(\"_app\")?;\n         PagesStructureItem::new(\n             pages_path.join(\"_app\")?,\n             page_extensions,\n-            Some(\n-                get_next_package(project_root.clone())\n-                    .await?\n-                    .join(\"app.js\")?,\n-            ),\n+            Some(next_package.join(\"app.js\")?),\n             app_router_path.clone(),\n             app_router_path,\n         )\n@@ -292,11 +289,7 @@ async fn get_pages_structure_for_root_directory(\n         PagesStructureItem::new(\n             pages_path.join(\"_document\")?,\n             page_extensions,\n-            Some(\n-                get_next_package(project_root.clone())\n-                    .await?\n-                    .join(\"document.js\")?,\n-            ),\n+            Some(next_package.join(\"document.js\")?),\n             document_router_path.clone(),\n             document_router_path,\n         )\n@@ -307,11 +300,7 @@ async fn get_pages_structure_for_root_directory(\n         PagesStructureItem::new(\n             pages_path.join(\"_error\")?,\n             page_extensions,\n-            Some(\n-                get_next_package(project_root.clone())\n-                    .await?\n-                    .join(\"error.js\")?,\n-            ),\n+            Some(next_package.join(\"error.js\")?),\n             error_router_path.clone(),\n             error_router_path,\n         )"
        },
        {
            "sha": "c91a013ed0adb6fadb45c72a13a0fb04dd8feda7",
            "filename": "crates/next-taskless/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-taskless%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/crates%2Fnext-taskless%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-taskless%2Fsrc%2Flib.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -30,7 +30,7 @@ pub fn expand_next_js_template<'a>(\n     fn replace_all<E>(\n         re: &regex::Regex,\n         haystack: &str,\n-        mut replacement: impl FnMut(&regex::Captures) -> Result<String, E>,\n+        mut replacement: impl FnMut(&regex::Captures<'_>) -> Result<String, E>,\n     ) -> Result<String, E> {\n         let mut new = String::with_capacity(haystack.len());\n         let mut last_match = 0;"
        },
        {
            "sha": "1bd3b5379ef42caf6ab793ee5909cf7f440a87f5",
            "filename": "turbopack/crates/turbopack-core/src/reference_type.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference_type.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -37,6 +37,7 @@ impl InnerAssets {\n     Debug,\n     Default,\n     Clone,\n+    Copy,\n     Hash,\n     TaskInput,\n )]\n@@ -55,6 +56,7 @@ pub enum CommonJsReferenceSubType {\n     serde::Deserialize,\n     Debug,\n     Clone,\n+    Copy,\n     Hash,\n     TaskInput,\n )]\n@@ -212,6 +214,7 @@ impl ImportContext {\n     Debug,\n     Default,\n     Clone,\n+    Copy,\n     Hash,\n     TaskInput,\n )]\n@@ -239,6 +242,7 @@ pub enum CssReferenceSubType {\n     Debug,\n     Default,\n     Clone,\n+    Copy,\n     Hash,\n     TaskInput,\n )]\n@@ -259,6 +263,7 @@ pub enum UrlReferenceSubType {\n     serde::Deserialize,\n     Debug,\n     Clone,\n+    Copy,\n     Hash,\n     TaskInput,\n )]\n@@ -276,6 +281,7 @@ pub enum TypeScriptReferenceSubType {\n     serde::Deserialize,\n     Debug,\n     Clone,\n+    Copy,\n     Hash,\n     TaskInput,\n )]\n@@ -298,12 +304,16 @@ pub enum WorkerReferenceSubType {\n     serde::Deserialize,\n     Debug,\n     Clone,\n+    Copy,\n     Hash,\n     TaskInput,\n )]\n pub enum EntryReferenceSubType {\n     Web,\n     Page,\n+    // A development only type that is used in pages router to differentiate between server prop\n+    // changes and template changes.\n+    PageData,\n     PagesApi,\n     AppPage,\n     AppRoute,"
        },
        {
            "sha": "df25fc9b0d6bf7175da94a660c8da3472f2663ae",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -490,10 +490,10 @@ async fn process_default_internal(\n     reference_type: ReferenceType,\n     processed_rules: Vec<usize>,\n ) -> Result<Vc<ProcessResult>> {\n-    let ident = source.ident().resolve().await?;\n+    let ident = source.ident().to_resolved().await?;\n     let path_ref = ident.path().await?;\n     let options = ModuleOptions::new(\n-        ident.path().await?.parent(),\n+        path_ref.parent(),\n         module_asset_context.module_options_context(),\n         module_asset_context.resolve_options_context(),\n     );\n@@ -539,7 +539,7 @@ async fn process_default_internal(\n                     ModuleRuleEffect::SourceTransforms(transforms) => {\n                         current_source =\n                             transforms.transform(*current_source).to_resolved().await?;\n-                        if current_source.ident().resolve().await? != ident {\n+                        if current_source.ident().to_resolved().await? != ident {\n                             // The ident has been changed, so we need to apply new rules.\n                             if let Some(transition) = module_asset_context\n                                 .await?\n@@ -615,7 +615,7 @@ async fn process_default_internal(\n                             }),\n                             Some(module_type) => {\n                                 ModuleIssue {\n-                                    ident: ident.to_resolved().await?,\n+                                    ident,\n                                     title: StyledString::Text(rcstr!(\"Invalid module type\"))\n                                         .resolved_cell(),\n                                     description: StyledString::Text(rcstr!(\n@@ -631,7 +631,7 @@ async fn process_default_internal(\n                             }\n                             None => {\n                                 ModuleIssue {\n-                                    ident: ident.to_resolved().await?,\n+                                    ident,\n                                     title: StyledString::Text(rcstr!(\"Missing module type\"))\n                                         .resolved_cell(),\n                                     description: StyledString::Text(rcstr!("
        },
        {
            "sha": "a29806bc8f0015df3352b2c785e7b24b5d496a5d",
            "filename": "turbopack/crates/turbopack/src/module_options/module_rule.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/1e01d06838247426089b2bfc9118bb45123b20a6/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/1e01d06838247426089b2bfc9118bb45123b20a6/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_rule.rs?ref=1e01d06838247426089b2bfc9118bb45123b20a6",
            "patch": "@@ -21,7 +21,8 @@ pub struct ModuleRule {\n \n impl ModuleRule {\n     /// Creates a new module rule. Will not match internal references.\n-    pub fn new(condition: RuleCondition, effects: Vec<ModuleRuleEffect>) -> Self {\n+    pub fn new(mut condition: RuleCondition, effects: Vec<ModuleRuleEffect>) -> Self {\n+        condition.flatten();\n         ModuleRule {\n             condition,\n             effects,\n@@ -30,7 +31,8 @@ impl ModuleRule {\n     }\n \n     /// Creates a new module rule. Will only match internal references.\n-    pub fn new_internal(condition: RuleCondition, effects: Vec<ModuleRuleEffect>) -> Self {\n+    pub fn new_internal(mut condition: RuleCondition, effects: Vec<ModuleRuleEffect>) -> Self {\n+        condition.flatten();\n         ModuleRule {\n             condition,\n             effects,\n@@ -39,7 +41,8 @@ impl ModuleRule {\n     }\n \n     /// Creates a new module rule. Will match all references.\n-    pub fn new_all(condition: RuleCondition, effects: Vec<ModuleRuleEffect>) -> Self {\n+    pub fn new_all(mut condition: RuleCondition, effects: Vec<ModuleRuleEffect>) -> Self {\n+        condition.flatten();\n         ModuleRule {\n             condition,\n             effects,"
        }
    ],
    "stats": {
        "total": 545,
        "additions": 171,
        "deletions": 374
    }
}