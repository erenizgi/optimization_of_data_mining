{
    "author": "eps1lon",
    "message": "Current behavior for module evaluation sourcemapping (#73737)\n\nLooks pretty bad. Most of it is due to added functions by bundlers that aren't sourcemapped.",
    "sha": "a0a882e063b95302c6f14f7428005f8cb60175ad",
    "files": [
        {
            "sha": "e8068bed1c9aba39e346136ddbb96082f0b579fd",
            "filename": "test/e2e/app-dir/non-root-project-monorepo/non-root-project-monorepo.test.ts",
            "status": "modified",
            "additions": 55,
            "deletions": 61,
            "changes": 116,
            "blob_url": "https://github.com/vercel/next.js/blob/a0a882e063b95302c6f14f7428005f8cb60175ad/test%2Fe2e%2Fapp-dir%2Fnon-root-project-monorepo%2Fnon-root-project-monorepo.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a0a882e063b95302c6f14f7428005f8cb60175ad/test%2Fe2e%2Fapp-dir%2Fnon-root-project-monorepo%2Fnon-root-project-monorepo.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnon-root-project-monorepo%2Fnon-root-project-monorepo.test.ts?ref=a0a882e063b95302c6f14f7428005f8cb60175ad",
            "patch": "@@ -82,13 +82,6 @@ describe('non-root-project-monorepo', () => {\n \n   if (isNextDev) {\n     describe('source-maps', () => {\n-      function normalizeStackTrace(stack: string[] | null): string | null {\n-        if (stack === null) {\n-          return null\n-        }\n-        return stack.join('\\n')\n-      }\n-\n       it('should work on RSC', async () => {\n         const browser = await next.browser('/source-maps-rsc')\n         await assertHasRedbox(browser)\n@@ -102,17 +95,13 @@ describe('non-root-project-monorepo', () => {\n                |       ^\n              2 |\"\n           `)\n-          // TODO stacktrace-parser breaks in some cases with the rsc:// protocol\n-          expect(\n-            normalizeStackTrace(await getRedboxCallStack(browser)).replace(\n-              /\\/apps_web_\\w+._.js /,\n-              '/apps_web_XXXXXX._.js '\n-            )\n-          ).toMatchInlineSnapshot(`\n-           \"[project]/apps/web/app/separate-file.ts [app-rsc] (ecmascript) app/separate-file.ts (1:7)\n-           innerArrowFunction app/source-maps-rsc/page.tsx (13:28)\n-           innerFunction app/source-maps-rsc/page.tsx (10:3)\n-           Page app/source-maps-rsc/page.tsx (4:5)\"\n+          expect(await getRedboxCallStack(browser)).toMatchInlineSnapshot(`\n+           [\n+             \"[project]/apps/web/app/separate-file.ts [app-rsc] (ecmascript) app/separate-file.ts (1:7)\",\n+             \"innerArrowFunction app/source-maps-rsc/page.tsx (13:28)\",\n+             \"innerFunction app/source-maps-rsc/page.tsx (10:3)\",\n+             \"Page app/source-maps-rsc/page.tsx (4:5)\",\n+           ]\n           `)\n         } else {\n           // TODO the function name is incorrect\n@@ -123,16 +112,17 @@ describe('non-root-project-monorepo', () => {\n                |           ^\n              2 |\"\n           `)\n-          // TODO webpack runtime code shouldn't be included in stack trace\n+          // TODO(veil): webpack runtime code shouldn't be included in stack trace (see https://linear.app/vercel/issue/NDX-509)\n           // TODO(veil): https://linear.app/vercel/issue/NDX-677\n-          expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n-            .toMatchInlineSnapshot(`\n-           \"eval app/separate-file.ts (1:11)\n-           <FIXME-file-protocol>\n-           <FIXME-file-protocol>\n-           innerArrowFunction app/source-maps-rsc/page.tsx (14:3)\n-           innerFunction app/source-maps-rsc/page.tsx (10:3)\n-           Page app/source-maps-rsc/page.tsx (4:5)\"\n+          expect(await getRedboxCallStack(browser)).toMatchInlineSnapshot(`\n+           [\n+             \"eval app/separate-file.ts (1:11)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"innerArrowFunction app/source-maps-rsc/page.tsx (14:3)\",\n+             \"innerFunction app/source-maps-rsc/page.tsx (10:3)\",\n+             \"Page app/source-maps-rsc/page.tsx (4:5)\",\n+           ]\n           `)\n         }\n         await browser.close()\n@@ -151,12 +141,13 @@ describe('non-root-project-monorepo', () => {\n                |       ^\n              2 |\"\n           `)\n-          expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n-            .toMatchInlineSnapshot(`\n-           \"[project]/apps/web/app/separate-file.ts [app-client] (ecmascript) app/separate-file.ts (1:7)\n-           innerArrowFunction app/source-maps-ssr/page.tsx (15:28)\n-           innerFunction app/source-maps-ssr/page.tsx (12:3)\n-           Page app/source-maps-ssr/page.tsx (6:5)\"\n+          expect(await getRedboxCallStack(browser)).toMatchInlineSnapshot(`\n+           [\n+             \"[project]/apps/web/app/separate-file.ts [app-client] (ecmascript) app/separate-file.ts (1:7)\",\n+             \"innerArrowFunction app/source-maps-ssr/page.tsx (15:28)\",\n+             \"innerFunction app/source-maps-ssr/page.tsx (12:3)\",\n+             \"Page app/source-maps-ssr/page.tsx (6:5)\",\n+           ]\n           `)\n         } else {\n           // TODO the function name should be hidden\n@@ -167,17 +158,18 @@ describe('non-root-project-monorepo', () => {\n                 |       ^\n               2 |\"\n           `)\n-          // TODO webpack runtime code shouldn't be included in stack trace\n-          expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n-            .toMatchInlineSnapshot(`\n-           \"eval app/separate-file.ts (1:7)\n-           <FIXME-next-dist-dir>\n-           <FIXME-next-dist-dir>\n-           <FIXME-next-dist-dir>\n-           <FIXME-next-dist-dir>\n-           innerArrowFunction app/source-maps-ssr/page.tsx (16:3)\n-           innerFunction app/source-maps-ssr/page.tsx (12:3)\n-           Page app/source-maps-ssr/page.tsx (6:5)\"\n+          // TODO(veil): webpack runtime code shouldn't be included in stack trace (see https://linear.app/vercel/issue/NDX-509)\n+          expect(await getRedboxCallStack(browser)).toMatchInlineSnapshot(`\n+           [\n+             \"eval app/separate-file.ts (1:7)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"innerArrowFunction app/source-maps-ssr/page.tsx (16:3)\",\n+             \"innerFunction app/source-maps-ssr/page.tsx (12:3)\",\n+             \"Page app/source-maps-ssr/page.tsx (6:5)\",\n+           ]\n           `)\n         }\n         await browser.close()\n@@ -196,12 +188,13 @@ describe('non-root-project-monorepo', () => {\n                |       ^\n              2 |\"\n           `)\n-          expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n-            .toMatchInlineSnapshot(`\n-           \"[project]/apps/web/app/separate-file.ts [app-client] (ecmascript) app/separate-file.ts (1:7)\n-           innerArrowFunction app/source-maps-client/page.tsx (16:28)\n-           innerFunction app/source-maps-client/page.tsx (13:3)\n-           effectCallback app/source-maps-client/page.tsx (7:5)\"\n+          expect(await getRedboxCallStack(browser)).toMatchInlineSnapshot(`\n+           [\n+             \"[project]/apps/web/app/separate-file.ts [app-client] (ecmascript) app/separate-file.ts (1:7)\",\n+             \"innerArrowFunction app/source-maps-client/page.tsx (16:28)\",\n+             \"innerFunction app/source-maps-client/page.tsx (13:3)\",\n+             \"effectCallback app/source-maps-client/page.tsx (7:5)\",\n+           ]\n           `)\n         } else {\n           // TODO the function name should be hidden\n@@ -212,17 +205,18 @@ describe('non-root-project-monorepo', () => {\n                 |       ^\n               2 |\"\n           `)\n-          // TODO webpack runtime code shouldn't be included in stack trace\n-          expect(normalizeStackTrace(await getRedboxCallStack(browser)))\n-            .toMatchInlineSnapshot(`\n-           \"eval app/separate-file.ts (1:7)\n-           <FIXME-next-dist-dir>\n-           <FIXME-next-dist-dir>\n-           <FIXME-next-dist-dir>\n-           <FIXME-next-dist-dir>\n-           innerArrowFunction app/source-maps-client/page.tsx (17:3)\n-           innerFunction app/source-maps-client/page.tsx (13:3)\n-           effectCallback app/source-maps-client/page.tsx (7:5)\"\n+          // TODO(veil): webpack runtime code shouldn't be included in stack trace (see https://linear.app/vercel/issue/NDX-509)\n+          expect(await getRedboxCallStack(browser)).toMatchInlineSnapshot(`\n+           [\n+             \"eval app/separate-file.ts (1:7)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"innerArrowFunction app/source-maps-client/page.tsx (17:3)\",\n+             \"innerFunction app/source-maps-client/page.tsx (13:3)\",\n+             \"effectCallback app/source-maps-client/page.tsx (7:5)\",\n+           ]\n           `)\n         }\n         await browser.close()"
        },
        {
            "sha": "267c1c8ca2b78b958c01007248fe72d6bc865ed0",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/app/module-evaluation/module.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/a0a882e063b95302c6f14f7428005f8cb60175ad/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fmodule-evaluation%2Fmodule.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a0a882e063b95302c6f14f7428005f8cb60175ad/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fmodule-evaluation%2Fmodule.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fmodule-evaluation%2Fmodule.js?ref=a0a882e063b95302c6f14f7428005f8cb60175ad",
            "patch": "@@ -0,0 +1 @@\n+export const error = new Error('module-evaluation')"
        },
        {
            "sha": "ea6c73e214ae2deaf10b31caa19c223846da007c",
            "filename": "test/e2e/app-dir/server-source-maps/fixtures/default/app/module-evaluation/page.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a0a882e063b95302c6f14f7428005f8cb60175ad/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fmodule-evaluation%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a0a882e063b95302c6f14f7428005f8cb60175ad/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fmodule-evaluation%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Ffixtures%2Fdefault%2Fapp%2Fmodule-evaluation%2Fpage.js?ref=a0a882e063b95302c6f14f7428005f8cb60175ad",
            "patch": "@@ -0,0 +1,6 @@\n+import { error } from './module'\n+\n+export default function Page() {\n+  console.error(error)\n+  return null\n+}"
        },
        {
            "sha": "83c9ec3d27e965bdb520b533fef9e723c3a3ca66",
            "filename": "test/e2e/app-dir/server-source-maps/server-source-maps.test.ts",
            "status": "modified",
            "additions": 116,
            "deletions": 11,
            "changes": 127,
            "blob_url": "https://github.com/vercel/next.js/blob/a0a882e063b95302c6f14f7428005f8cb60175ad/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a0a882e063b95302c6f14f7428005f8cb60175ad/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fserver-source-maps%2Fserver-source-maps.test.ts?ref=a0a882e063b95302c6f14f7428005f8cb60175ad",
            "patch": "@@ -414,23 +414,128 @@ describe('app-dir - server source maps', () => {\n           ).length - 1\n         ).toEqual(3)\n       }\n+    } else {\n+      // Bundlers silently drop invalid sourcemaps.\n+      expect(\n+        normalizeCliOutput(next.cliOutput).split('Invalid source map.').length -\n+          1\n+      ).toEqual(0)\n+    }\n+  })\n+\n+  it('sourcemaps errors during module evaluation', async () => {\n+    const outputIndex = next.cliOutput.length\n+    const browser = await next.browser('/module-evaluation')\n+\n+    if (isNextDev) {\n+      await retry(() => {\n+        expect(next.cliOutput.slice(outputIndex)).toContain(\n+          'Error: module-evaluation'\n+        )\n+      })\n+      const cliOutput = stripAnsi(next.cliOutput.slice(outputIndex))\n+      if (isTurbopack) {\n+        expect(cliOutput).toContain(\n+          '' +\n+            '\\nError: module-evaluation' +\n+            // TODO(veil): Should map to no name like you'd get with native stacks without a bundler.\n+            '\\n    at [project]/app/module-evaluation/module.js [app-rsc] (ecmascript) (app/module-evaluation/module.js:1:21)' +\n+            // TODO(veil): Added frames from bundler should be sourcemapped (https://linear.app/vercel/issue/NDX-509/)\n+            '\\n    at [project]/app/module-evaluation/page.js [app-rsc] (ecmascript) (app/module-evaluation/page.js:1:0)' +\n+            '\\n    at [project]/app/module-evaluation/page.js [app-rsc] (ecmascript, Next.js Server Component) (.next'\n+        )\n+      } else {\n+        expect(cliOutput).toContain(\n+          '' +\n+            '\\nError: module-evaluation' +\n+            // TODO(veil): Should map to no name like you'd get with native stacks without a bundler.\n+            // TODO(veil): Location should be sourcemapped\n+            '\\n    at eval (app/module-evaluation/module.js:1:21)' +\n+            // TODO(veil): Added frames from bundler should be sourcemapped (https://linear.app/vercel/issue/NDX-509/)\n+            '\\n    at <unknown> (rsc)/.'\n+        )\n+      }\n+\n+      expect(cliOutput).toContain(\n+        '' +\n+          \"\\n> 1 | export const error = new Error('module-evaluation')\" +\n+          '\\n    |                     ^'\n+      )\n+\n+      if (isTurbopack) {\n+        // TODO(veil): Ignore-list Turbopack runtime\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"module-evaluation\",\n+           \"environmentLabel\": \"Prerender\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/module-evaluation/module.js (1:22) @ [project]/app/module-evaluation/module.js [app-rsc] (ecmascript)\n+         > 1 | export const error = new Error('module-evaluation')\n+             |                      ^\",\n+           \"stack\": [\n+             \"[project]/app/module-evaluation/module.js [app-rsc] (ecmascript) app/module-evaluation/module.js (1:22)\",\n+             \"[project]/app/module-evaluation/page.js [app-rsc] (ecmascript) app/module-evaluation/page.js (1:1)\",\n+             \"[project]/app/module-evaluation/page.js [app-rsc] (ecmascript, Next.js Server Component) app/module-evaluation/page.js (6:1)\",\n+             \"<FIXME-next-dist-dir>\",\n+             \"Page <anonymous>\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        // TODO(veil): Ignore-list Webpack runtime\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"module-evaluation\",\n+           \"environmentLabel\": \"Prerender\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/module-evaluation/module.js (1:22) @ eval\n+         > 1 | export const error = new Error('module-evaluation')\n+             |                      ^\",\n+           \"stack\": [\n+             \"eval app/module-evaluation/module.js (1:22)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"eval rsc:/Prerender/webpack-internal:///(rsc)/app/module-evaluation/page.js (5:65)\",\n+             \"<FIXME-file-protocol>\",\n+             \"<FIXME-file-protocol>\",\n+             \"Function.all <anonymous>\",\n+             \"Function.all <anonymous>\",\n+             \"Page <anonymous>\",\n+           ],\n+         }\n+        `)\n+      }\n     } else {\n       if (isTurbopack) {\n-        // Expect the invalid sourcemap warning only once per render.\n         expect(\n-          normalizeCliOutput(next.cliOutput).split('Invalid source map.')\n-            .length - 1\n-        ).toEqual(\n-          // >= 20\n-          // behavior in Node.js 20+ is intended\n-          process.versions.node.startsWith('18') ? 0 : 2\n+          normalizeCliOutput(next.cliOutput).replaceAll(\n+            /at \\d+ /g,\n+            'at <TurbopackModuleID> '\n+          )\n+        ).toContain(\n+          '' +\n+            '\\nError: module-evaluation' +\n+            '\\n    at <TurbopackModuleID> (turbopack:///[project]/app/module-evaluation/module.js:1:21)' +\n+            // TODO(veil): Why are there unsourcemapped module frames below?\n+            '\\n    at <TurbopackModuleID> (.next/'\n+        )\n+        expect(normalizeCliOutput(next.cliOutput)).toContain(\n+          '' +\n+            \"\\n> 1 | export const error = new Error('module-evaluation')\" +\n+            '\\n    |                     ^'\n         )\n       } else {\n-        // Webpack is silent about invalid sourcemaps for next build.\n         expect(\n-          normalizeCliOutput(next.cliOutput).split('Invalid source map.')\n-            .length - 1\n-        ).toEqual(0)\n+          normalizeCliOutput(next.cliOutput).replaceAll(\n+            /at \\d+ /g,\n+            'at <WebpackModuleID> '\n+          )\n+        ).toContain(\n+          '' +\n+            '\\nError: module-evaluation' +\n+            // TODO(veil): column numbers are flaky in Webpack\n+            '\\n    at <WebpackModuleID> (webpack:///app/module-evaluation/module.js:1:'\n+        )\n       }\n     }\n   })"
        }
    ],
    "stats": {
        "total": 250,
        "additions": 178,
        "deletions": 72
    }
}