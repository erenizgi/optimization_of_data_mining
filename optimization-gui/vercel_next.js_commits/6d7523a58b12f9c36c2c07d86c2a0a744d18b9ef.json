{
    "author": "eps1lon",
    "message": "[dev-overlay] Parse stacks in reducer not during dispatch (#79788)\n\nIn the reducer we'll later inject the implementation of `get*Stack`. The reducer will live in a different module than `stitched-errors` so we need to make sure `get*Stack` is a singleton. Dependency injection makes this easier to achieve.\r\n\r\n`getOwnerStack` will be injected in a follow-up",
    "sha": "6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef",
    "files": [
        {
            "sha": "3cefd134f4a861ff4e8c898b549a1f36d05913f5",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/hot-reloader-client.tsx",
            "status": "modified",
            "additions": 0,
            "deletions": 14,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx?ref=6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef",
            "patch": "@@ -20,7 +20,6 @@ import {\n   reportInvalidHmrMessage,\n   useErrorOverlayReducer,\n } from '../shared'\n-import { parseStack } from '../utils/parse-stack'\n import { AppDevOverlay } from './app-dev-overlay'\n import { useErrorHandler } from '../../errors/use-error-handler'\n import { RuntimeErrorHandler } from '../../errors/runtime-error-handler'\n@@ -30,7 +29,6 @@ import {\n   useWebsocket,\n   useWebsocketPing,\n } from '../utils/use-websocket'\n-import { parseComponentStack } from '../utils/parse-component-stack'\n import type { VersionInfo } from '../../../../server/dev/parse-version-info'\n import { HMR_ACTIONS_SENT_TO_BROWSER } from '../../../../server/dev/hot-reloader-types'\n import type {\n@@ -40,7 +38,6 @@ import type {\n import { REACT_REFRESH_FULL_RELOAD_FROM_ERROR } from '../shared'\n import type { DebugInfo } from '../types'\n import { useUntrackedPathname } from '../../navigation-untracked'\n-import { getComponentStack, getOwnerStack } from '../../errors/stitched-error'\n import { handleDevBuildIndicatorHmrEvents } from '../../../dev/dev-build-indicator/internal/handle-dev-build-indicator-hmr-events'\n import type { GlobalErrorComponent } from '../../global-error'\n import type { DevIndicatorServerState } from '../../../../server/dev/dev-indicator-server-state'\n@@ -514,26 +511,15 @@ export default function HotReload({\n         })\n       },\n       onUnhandledError(error) {\n-        // Component stack is added to the error in use-error-handler in case there was a hydration error\n-        const componentStack = getComponentStack(error)\n-        const ownerStack = getOwnerStack(error)\n-\n         dispatch({\n           type: ACTION_UNHANDLED_ERROR,\n           reason: error,\n-          frames: parseStack((error.stack || '') + (ownerStack || '')),\n-          componentStackFrames:\n-            typeof componentStack === 'string'\n-              ? parseComponentStack(componentStack)\n-              : undefined,\n         })\n       },\n       onUnhandledRejection(error) {\n-        const ownerStack = getOwnerStack(error)\n         dispatch({\n           type: ACTION_UNHANDLED_REJECTION,\n           reason: error,\n-          frames: parseStack((error.stack || '') + (ownerStack || '')),\n         })\n       },\n     }"
        },
        {
            "sha": "5658791e57d0e84f05e130634553e7a9784f8524",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/client.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fclient.ts?ref=6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef",
            "patch": "@@ -1,6 +1,4 @@\n import * as Bus from './bus'\n-import { parseStack } from '../utils/parse-stack'\n-import { parseComponentStack } from '../utils/parse-component-stack'\n import {\n   attachHydrationErrorState,\n   storeHydrationErrorStateFromConsoleArgs,\n@@ -17,7 +15,6 @@ import {\n   ACTION_VERSION_INFO,\n } from '../shared'\n import type { VersionInfo } from '../../../../server/dev/parse-version-info'\n-import { getComponentStack, getOwnerStack } from '../../errors/stitched-error'\n import type { DevIndicatorServerState } from '../../../../server/dev/dev-indicator-server-state'\n \n let isRegistered = false\n@@ -30,13 +27,6 @@ function handleError(error: unknown) {\n \n   attachHydrationErrorState(error)\n \n-  const componentStackTrace = getComponentStack(error)\n-  const ownerStack = getOwnerStack(error)\n-  const componentStackFrames =\n-    typeof componentStackTrace === 'string'\n-      ? parseComponentStack(componentStackTrace)\n-      : undefined\n-\n   // Skip ModuleBuildError and ModuleNotFoundError, as it will be sent through onBuildError callback.\n   // This is to avoid same error as different type showing up on client to cause flashing.\n   if (\n@@ -46,8 +36,6 @@ function handleError(error: unknown) {\n     Bus.emit({\n       type: ACTION_UNHANDLED_ERROR,\n       reason: error,\n-      frames: parseStack((error.stack || '') + (ownerStack || '')),\n-      componentStackFrames,\n     })\n   }\n }\n@@ -78,12 +66,9 @@ function onUnhandledRejection(ev: PromiseRejectionEvent) {\n     return\n   }\n \n-  const error = reason\n-  const ownerStack = getOwnerStack(error)\n   Bus.emit({\n     type: ACTION_UNHANDLED_REJECTION,\n     reason: reason,\n-    frames: parseStack((error.stack || '') + (ownerStack || '')),\n   })\n }\n "
        },
        {
            "sha": "8b6ad5bcf01f0c19b684fd48136f875ca998cc69",
            "filename": "packages/next/src/client/components/react-dev-overlay/shared.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 23,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fshared.ts?ref=6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef",
            "patch": "@@ -1,13 +1,13 @@\n import { useReducer } from 'react'\n \n-import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import type { VersionInfo } from '../../../server/dev/parse-version-info'\n import type { SupportedErrorEvent } from './ui/container/runtime-error/render-error'\n-import type { ComponentStackFrame } from './utils/parse-component-stack'\n+import { parseComponentStack } from './utils/parse-component-stack'\n import type { DebugInfo } from './types'\n import type { DevIndicatorServerState } from '../../../server/dev/dev-indicator-server-state'\n import type { HMR_ACTION_TYPES } from '../../../server/dev/hot-reloader-types'\n-import { getOwnerStack } from '../errors/stitched-error'\n+import { parseStack } from './utils/parse-stack'\n+import { getComponentStack, getOwnerStack } from '../errors/stitched-error'\n \n type FastRefreshState =\n   /** No refresh in progress. */\n@@ -71,13 +71,10 @@ interface FastRefreshAction {\n export interface UnhandledErrorAction {\n   type: typeof ACTION_UNHANDLED_ERROR\n   reason: Error\n-  frames: StackFrame[]\n-  componentStackFrames?: ComponentStackFrame[]\n }\n export interface UnhandledRejectionAction {\n   type: typeof ACTION_UNHANDLED_REJECTION\n   reason: Error\n-  frames: StackFrame[]\n }\n \n export interface DebugInfoAction {\n@@ -134,21 +131,35 @@ function getStackIgnoringStrictMode(stack: string | undefined) {\n }\n \n function pushErrorFilterDuplicates(\n-  errors: SupportedErrorEvent[],\n-  err: SupportedErrorEvent\n+  events: SupportedErrorEvent[],\n+  id: number,\n+  error: Error\n ): SupportedErrorEvent[] {\n-  const pendingErrors = errors.filter((e) => {\n+  const componentStack = getComponentStack(error)\n+  const componentStackFrames =\n+    componentStack === undefined\n+      ? undefined\n+      : parseComponentStack(componentStack)\n+  const ownerStack = getOwnerStack(error)\n+  const frames = parseStack((error.stack || '') + (ownerStack || ''))\n+  const pendingEvent: SupportedErrorEvent = {\n+    id,\n+    error,\n+    frames,\n+    componentStackFrames,\n+  }\n+  const pendingEvents = events.filter((event) => {\n     // Filter out duplicate errors\n     return (\n-      (e.event.reason.stack !== err.event.reason.stack &&\n+      (event.error.stack !== pendingEvent.error.stack &&\n         // TODO: Let ReactDevTools control deduping instead?\n-        getStackIgnoringStrictMode(e.event.reason.stack) !==\n-          getStackIgnoringStrictMode(err.event.reason.stack)) ||\n-      getOwnerStack(e.event.reason) !== getOwnerStack(err.event.reason)\n+        getStackIgnoringStrictMode(event.error.stack) !==\n+          getStackIgnoringStrictMode(pendingEvent.error.stack)) ||\n+      getOwnerStack(event.error) !== getOwnerStack(pendingEvent.error)\n     )\n   })\n-  pendingErrors.push(err)\n-  return pendingErrors\n+  pendingEvents.push(pendingEvent)\n+  return pendingEvents\n }\n \n const shouldDisableDevIndicator =\n@@ -230,10 +241,11 @@ export function useErrorOverlayReducer(routerType: 'pages' | 'app') {\n             return {\n               ...state,\n               nextId: state.nextId + 1,\n-              errors: pushErrorFilterDuplicates(state.errors, {\n-                id: state.nextId,\n-                event: action,\n-              }),\n+              errors: pushErrorFilterDuplicates(\n+                state.errors,\n+                state.nextId,\n+                action.reason\n+              ),\n             }\n           }\n           case 'pending': {\n@@ -242,10 +254,11 @@ export function useErrorOverlayReducer(routerType: 'pages' | 'app') {\n               nextId: state.nextId + 1,\n               refreshState: {\n                 ...state.refreshState,\n-                errors: pushErrorFilterDuplicates(state.refreshState.errors, {\n-                  id: state.nextId,\n-                  event: action,\n-                }),\n+                errors: pushErrorFilterDuplicates(\n+                  state.errors,\n+                  state.nextId,\n+                  action.reason\n+                ),\n               },\n             }\n           }"
        },
        {
            "sha": "dc8418f6102a8647edf52516d0b83566b58d3e48",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/container/runtime-error/render-error.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcontainer%2Fruntime-error%2Frender-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcontainer%2Fruntime-error%2Frender-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcontainer%2Fruntime-error%2Frender-error.tsx?ref=6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef",
            "patch": "@@ -1,18 +1,18 @@\n-import type {\n-  OverlayState,\n-  UnhandledErrorAction,\n-  UnhandledRejectionAction,\n-} from '../../../shared'\n+import type { OverlayState } from '../../../shared'\n \n import { useMemo, useState, useEffect } from 'react'\n import {\n   getErrorByType,\n   type ReadyRuntimeError,\n } from '../../../utils/get-error-by-type'\n+import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n+import type { ComponentStackFrame } from '../../../utils/parse-component-stack'\n \n export type SupportedErrorEvent = {\n   id: number\n-  event: UnhandledErrorAction | UnhandledRejectionAction\n+  error: Error\n+  frames: StackFrame[]\n+  componentStackFrames?: ComponentStackFrame[]\n }\n \n type Props = {"
        },
        {
            "sha": "dbdbfdc36be1e03b5c5fc2d5cf6ae2f1144a5e78",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/dev-overlay.stories.tsx",
            "status": "modified",
            "additions": 29,
            "deletions": 39,
            "changes": 68,
            "blob_url": "https://github.com/vercel/next.js/blob/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.stories.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.stories.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fdev-overlay.stories.tsx?ref=6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef",
            "patch": "@@ -10,7 +10,6 @@ import {\n   ACTION_ERROR_OVERLAY_CLOSE,\n   ACTION_ERROR_OVERLAY_OPEN,\n   ACTION_ERROR_OVERLAY_TOGGLE,\n-  ACTION_UNHANDLED_ERROR,\n } from '../shared'\n \n const meta: Meta<typeof DevOverlay> = {\n@@ -32,50 +31,41 @@ const initialState: OverlayState = {\n   errors: [\n     {\n       id: 1,\n-      event: {\n-        type: ACTION_UNHANDLED_ERROR,\n-        reason: Object.assign(new Error('First error message'), {\n-          __NEXT_ERROR_CODE: 'E001',\n-        }),\n-        componentStackFrames: [\n-          {\n-            file: 'app/page.tsx',\n-            component: 'Home',\n-            lineNumber: 10,\n-            column: 5,\n-            canOpenInEditor: true,\n-          },\n-        ],\n-        frames: [\n-          {\n-            file: 'app/page.tsx',\n-            methodName: 'Home',\n-            arguments: [],\n-            lineNumber: 10,\n-            column: 5,\n-          },\n-        ],\n-      },\n+      error: Object.assign(new Error('First error message'), {\n+        __NEXT_ERROR_CODE: 'E001',\n+      }),\n+      componentStackFrames: [\n+        {\n+          file: 'app/page.tsx',\n+          component: 'Home',\n+          lineNumber: 10,\n+          column: 5,\n+          canOpenInEditor: true,\n+        },\n+      ],\n+      frames: [\n+        {\n+          file: 'app/page.tsx',\n+          methodName: 'Home',\n+          arguments: [],\n+          lineNumber: 10,\n+          column: 5,\n+        },\n+      ],\n     },\n     {\n       id: 2,\n-      event: {\n-        type: ACTION_UNHANDLED_ERROR,\n-        reason: Object.assign(new Error('Second error message'), {\n-          __NEXT_ERROR_CODE: 'E002',\n-        }),\n-        frames: [],\n-      },\n+      error: Object.assign(new Error('Second error message'), {\n+        __NEXT_ERROR_CODE: 'E002',\n+      }),\n+      frames: [],\n     },\n     {\n       id: 3,\n-      event: {\n-        type: ACTION_UNHANDLED_ERROR,\n-        reason: Object.assign(new Error('Third error message'), {\n-          __NEXT_ERROR_CODE: 'E003',\n-        }),\n-        frames: [],\n-      },\n+      error: Object.assign(new Error('Third error message'), {\n+        __NEXT_ERROR_CODE: 'E003',\n+      }),\n+      frames: [],\n     },\n   ],\n   refreshState: { type: 'idle' },"
        },
        {
            "sha": "56812b08d55a2b0ac1be002e38d89b015af9fd5d",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/get-error-by-type.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 47,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fget-error-by-type.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fget-error-by-type.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fget-error-by-type.ts?ref=6d7523a58b12f9c36c2c07d86c2a0a744d18b9ef",
            "patch": "@@ -1,4 +1,3 @@\n-import { ACTION_UNHANDLED_ERROR, ACTION_UNHANDLED_REJECTION } from '../shared'\n import type { SupportedErrorEvent } from '../ui/container/runtime-error/render-error'\n import { getOriginalStackFrames } from './stack-frame'\n import type { OriginalStackFrame } from './stack-frame'\n@@ -37,58 +36,46 @@ export const useFrames = (error: ReadyRuntimeError): OriginalStackFrame[] => {\n }\n \n export async function getErrorByType(\n-  ev: SupportedErrorEvent,\n+  event: SupportedErrorEvent,\n   isAppDir: boolean\n ): Promise<ReadyRuntimeError> {\n-  const { id, event } = ev\n-  switch (event.type) {\n-    case ACTION_UNHANDLED_ERROR:\n-    case ACTION_UNHANDLED_REJECTION: {\n-      const baseError = {\n-        id,\n-        runtime: true,\n-        error: event.reason,\n-      } as const\n+  const baseError = {\n+    id: event.id,\n+    runtime: true,\n+    error: event.error,\n+  } as const\n \n-      if ('use' in React) {\n-        const readyRuntimeError: ReadyRuntimeError = {\n-          ...baseError,\n-          // createMemoizedPromise dedups calls to getOriginalStackFrames\n-          frames: createMemoizedPromise(async () => {\n-            return await getOriginalStackFrames(\n-              event.frames,\n-              getErrorSource(event.reason),\n-              isAppDir\n-            )\n-          }),\n-        }\n-        if (event.type === ACTION_UNHANDLED_ERROR) {\n-          readyRuntimeError.componentStackFrames = event.componentStackFrames\n-        }\n-        return readyRuntimeError\n-      } else {\n-        const readyRuntimeError: ReadyRuntimeError = {\n-          ...baseError,\n-          // createMemoizedPromise dedups calls to getOriginalStackFrames\n-          frames: await getOriginalStackFrames(\n-            event.frames,\n-            getErrorSource(event.reason),\n-            isAppDir\n-          ),\n-        }\n-        if (event.type === ACTION_UNHANDLED_ERROR) {\n-          readyRuntimeError.componentStackFrames = event.componentStackFrames\n-        }\n-        return readyRuntimeError\n-      }\n+  if ('use' in React) {\n+    const readyRuntimeError: ReadyRuntimeError = {\n+      ...baseError,\n+      // createMemoizedPromise dedups calls to getOriginalStackFrames\n+      frames: createMemoizedPromise(async () => {\n+        return await getOriginalStackFrames(\n+          event.frames,\n+          getErrorSource(event.error),\n+          isAppDir\n+        )\n+      }),\n+    }\n+    if (event.componentStackFrames !== undefined) {\n+      readyRuntimeError.componentStackFrames = event.componentStackFrames\n+    }\n+    return readyRuntimeError\n+  } else {\n+    const readyRuntimeError: ReadyRuntimeError = {\n+      ...baseError,\n+      // createMemoizedPromise dedups calls to getOriginalStackFrames\n+      frames: await getOriginalStackFrames(\n+        event.frames,\n+        getErrorSource(event.error),\n+        isAppDir\n+      ),\n     }\n-    default: {\n-      break\n+    if (event.componentStackFrames !== undefined) {\n+      readyRuntimeError.componentStackFrames = event.componentStackFrames\n     }\n+    return readyRuntimeError\n   }\n-  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n-  const _: never = event\n-  throw new Error('type system invariant violation')\n }\n \n function createMemoizedPromise<T>("
        }
    ],
    "stats": {
        "total": 249,
        "additions": 105,
        "deletions": 144
    }
}