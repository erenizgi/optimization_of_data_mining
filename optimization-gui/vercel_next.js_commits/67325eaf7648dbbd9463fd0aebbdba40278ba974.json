{
    "author": "wbinnssmith",
    "message": "Turbopack: log telemetry events when `TurbopackInternalError`s occur (#77660)\n\nNote: **This does not include any error content aside from that the\nerror is a `TurbopackInternalError`.**\n\nThis adds a function, `TurbopackInternalError.createAndRecordTelemetry`\nthat both creates the `TurbopackInternalError` instance and logs that it\noccurred to telemetry. This telemetry event only includes 1) that an\nerror occurred once and 2) the error code or error name of the error, in\nthis case `TurbopackInternalError`.\n\nTest Plan: Added a unit test, `TurbopackInternalError.test.ts`\n\nManual test plan:\n- Insert a panic into Turbopack source in `analyse_ecmascript_module`.\n- Run `NEXT_TELEMETRY_DEBUG=1 NODE_OPTIONS=\"--trace-deprecation\n--enable-source-maps\" pnpm next \"build\" \"--turbo\"\n\"test/e2e/app-dir/app/“`.\n- Verify telemetry debugging shows an event called `NEXT_ERROR_THROWN`\nwith `errorCode` of `TurbopackInternalError`.\n- Do the same with `NEXT_TELEMETRY_DEBUG=1\nNODE_OPTIONS=\"--trace-deprecation --enable-source-maps\" pnpm next \"dev\"\n\"--turbo\" \"test/e2e/app-dir/app/“`",
    "sha": "67325eaf7648dbbd9463fd0aebbdba40278ba974",
    "files": [
        {
            "sha": "2525baf78ae2df601a9a9d9ed781a050389b441c",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=67325eaf7648dbbd9463fd0aebbdba40278ba974",
            "patch": "@@ -669,5 +669,6 @@\n   \"668\": \"Internal Next.js error: Router action dispatched before initialization.\",\n   \"669\": \"Invariant: --turbopack is set but the build used Webpack\",\n   \"670\": \"Invariant: --turbopack is not set but the build used Turbopack. Add --turbopack to \\\"next start\\\".\",\n-  \"671\": \"Specified images.remotePatterns must have protocol \\\"http\\\" or \\\"https\\\" received \\\"%s\\\".\"\n+  \"671\": \"Specified images.remotePatterns must have protocol \\\"http\\\" or \\\"https\\\" received \\\"%s\\\".\",\n+  \"672\": \"Expected `telemetry` to be set in globals\"\n }"
        },
        {
            "sha": "24092de0f7636374559d8967de60f291a5989e60",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=67325eaf7648dbbd9463fd0aebbdba40278ba974",
            "patch": "@@ -509,7 +509,7 @@ function bindingToApi(\n     try {\n       return await fn()\n     } catch (nativeError: any) {\n-      throw new TurbopackInternalError(nativeError)\n+      throw TurbopackInternalError.createAndRecordTelemetry(nativeError)\n     }\n   }\n \n@@ -577,7 +577,7 @@ function bindingToApi(\n       } catch (e) {\n         if (e === cancel) return\n         if (e instanceof Error) {\n-          throw new TurbopackInternalError(e)\n+          throw TurbopackInternalError.createAndRecordTelemetry(e)\n         }\n         throw e\n       } finally {"
        },
        {
            "sha": "9c708be85880b123b176eb8089ab17a9deaa4dbd",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=67325eaf7648dbbd9463fd0aebbdba40278ba974",
            "patch": "@@ -50,6 +50,7 @@ import { NEXT_PATCH_SYMBOL } from './patch-fetch'\n import type { ServerInitResult } from './render-server'\n import { filterInternalHeaders } from './server-ipc/utils'\n import { blockCrossSite } from './router-utils/block-cross-site'\n+import { traceGlobals } from '../../trace/shared'\n \n const debug = setupDebug('next:router-server:main')\n const isNextFont = (pathname: string | null) =>\n@@ -122,6 +123,8 @@ export async function initialize(opts: {\n     const telemetry = new Telemetry({\n       distDir: path.join(opts.dir, config.distDir),\n     })\n+    traceGlobals.set('telemetry', telemetry)\n+\n     const { pagesDir, appDir } = findPagesDir(opts.dir)\n \n     const { setupDevBundler } ="
        },
        {
            "sha": "ecb50b5d09f6a15564421524452b1762b4d20d6c",
            "filename": "packages/next/src/shared/lib/turbopack/utils.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fturbopack%2Futils.ts?ref=67325eaf7648dbbd9463fd0aebbdba40278ba974",
            "patch": "@@ -3,6 +3,7 @@ import type {\n   StyledString,\n   TurbopackResult,\n } from '../../../build/swc/types'\n+\n import { bold, green, magenta, red } from '../../../lib/picocolors'\n import isInternal from '../is-internal'\n import {\n@@ -13,6 +14,8 @@ import type { EntryKey } from './entry-key'\n import * as Log from '../../../build/output/log'\n import type { NextConfigComplete } from '../../../server/config-shared'\n import loadJsConfig from '../../../build/load-jsconfig'\n+import { eventErrorThrown } from '../../../telemetry/events'\n+import { traceGlobals } from '../../../trace/shared'\n \n type IssueKey = `${Issue['severity']}-${Issue['filePath']}-${string}-${string}`\n export type IssuesMap = Map<IssueKey, Issue>\n@@ -30,6 +33,22 @@ export class ModuleBuildError extends Error {\n export class TurbopackInternalError extends Error {\n   name = 'TurbopackInternalError'\n \n+  // Manually set this as this isn't statically determinable\n+  __NEXT_ERROR_CODE = 'TurbopackInternalError'\n+\n+  static createAndRecordTelemetry(cause: Error) {\n+    const error = new TurbopackInternalError(cause)\n+\n+    const telemetry = traceGlobals.get('telemetry')\n+    if (telemetry) {\n+      telemetry.record(eventErrorThrown(error))\n+    } else {\n+      console.error('Expected `telemetry` to be set in globals')\n+    }\n+\n+    return error\n+  }\n+\n   constructor(cause: Error) {\n     super(cause.message)\n     this.stack = cause.stack"
        },
        {
            "sha": "98ad498d799412bd92dcc995384265f093ec4978",
            "filename": "packages/next/src/telemetry/events/build.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/67325eaf7648dbbd9463fd0aebbdba40278ba974/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts?ref=67325eaf7648dbbd9463fd0aebbdba40278ba974",
            "patch": "@@ -1,6 +1,7 @@\n import type { TelemetryPlugin } from '../../build/webpack/plugins/telemetry-plugin/telemetry-plugin'\n import type { SWC_TARGET_TRIPLE } from '../../build/webpack/plugins/telemetry-plugin/telemetry-plugin'\n import type { UseCacheTrackerKey } from '../../build/webpack/plugins/telemetry-plugin/use-cache-tracker-utils'\n+import { extractNextErrorCode } from '../../lib/error-telemetry-utils'\n \n const REGEXP_DIRECTORY_DUNDER =\n   /[\\\\/]__[^\\\\/]+(?<![\\\\/]__(?:tests|mocks))__[\\\\/]/i\n@@ -212,3 +213,21 @@ export function eventPackageUsedInGetServerSideProps(\n     },\n   }))\n }\n+\n+export const ERROR_THROWN_EVENT = 'NEXT_ERROR_THROWN'\n+type ErrorThrownEvent = {\n+  eventName: typeof ERROR_THROWN_EVENT\n+  payload: {\n+    errorCode: string | undefined\n+  }\n+}\n+\n+// Creates a Telemetry event for errors. For privacy, only includes the error code.\n+export function eventErrorThrown(error: Error): ErrorThrownEvent {\n+  return {\n+    eventName: ERROR_THROWN_EVENT,\n+    payload: {\n+      errorCode: extractNextErrorCode(error) || 'Unknown',\n+    },\n+  }\n+}"
        },
        {
            "sha": "b4b90906031722bf4d61aaac312665422ea1d668",
            "filename": "test/unit/TurbopackInternalError.test.ts",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/67325eaf7648dbbd9463fd0aebbdba40278ba974/test%2Funit%2FTurbopackInternalError.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/67325eaf7648dbbd9463fd0aebbdba40278ba974/test%2Funit%2FTurbopackInternalError.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2FTurbopackInternalError.test.ts?ref=67325eaf7648dbbd9463fd0aebbdba40278ba974",
            "patch": "@@ -0,0 +1,33 @@\n+import path from 'path'\n+import os from 'os'\n+import { TurbopackInternalError } from 'next/dist/shared/lib/turbopack/utils'\n+import { Telemetry } from 'next/dist/telemetry/storage'\n+import { setGlobal } from 'next/dist/trace'\n+import { traceGlobals } from 'next/dist/trace/shared'\n+\n+describe('TurbopackInternalError', () => {\n+  it('sends a telemetry event when TurbopackInternalError.createAndRecordTelemetry() is called', async () => {\n+    const oldTelemetry = traceGlobals.get('telemetry')\n+\n+    try {\n+      const distDir = path.join(os.tmpdir(), 'next-telemetry')\n+      const telemetry = new Telemetry({ distDir })\n+      setGlobal('telemetry', telemetry)\n+      const submitRecord = jest\n+        // @ts-ignore\n+        .spyOn(telemetry, 'submitRecord')\n+        // @ts-ignore\n+        .mockImplementation(() => Promise.resolve())\n+      TurbopackInternalError.createAndRecordTelemetry(new Error('test error'))\n+\n+      expect(submitRecord).toHaveBeenCalledWith({\n+        eventName: 'NEXT_ERROR_THROWN',\n+        payload: {\n+          errorCode: 'TurbopackInternalError',\n+        },\n+      })\n+    } finally {\n+      setGlobal('telemetry', oldTelemetry)\n+    }\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 81,
        "additions": 78,
        "deletions": 3
    }
}