{
    "author": "kdy1",
    "message": "feat(turbopack): Add simple tree shaker (#78286)\n\n### What?\r\n\r\nImplement a simple tree-shaking. Simple tree shaking is a tree-shaking implementation that only has two options for each export: used/unused. This information is shared among the whole application, so there's no fine-grained control for each export. \r\n\r\n### Why?\r\n\r\nBecause advanced tree shaking requires some more time to implement.",
    "sha": "c8bcde6bf83fb7382d680525fece246f0b0d13fb",
    "files": [
        {
            "sha": "fb7774e0d360f886d7276bd1b32725772ae7e64b",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -9619,6 +9619,7 @@ version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n  \"async-trait\",\n+ \"auto-hash-map\",\n  \"bitvec\",\n  \"bytes-str\",\n  \"codspeed-criterion-compat\","
        },
        {
            "sha": "65e9696e69b9685ab93199a6f223481de5e875f8",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -348,6 +348,9 @@ pub async fn get_client_module_options_context(\n         enable_postcss_transform,\n         side_effect_free_packages: next_config.optimize_package_imports().owned().await?,\n         keep_last_successful_parse: next_mode.is_development(),\n+        remove_unused_exports: *next_config\n+            .turbopack_remove_unused_exports(next_mode.is_development())\n+            .await?,\n         ..Default::default()\n     };\n "
        },
        {
            "sha": "925be095ee6f1fe677e850a07a2f2384ceec502d",
            "filename": "crates/next-core/src/next_client_reference/ecmascript_client_reference/ecmascript_client_reference_module.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -76,7 +76,7 @@ impl EcmascriptClientReferenceModule {\n         // Adapted from https://github.com/facebook/react/blob/c5b9375767e2c4102d7e5559d383523736f1c902/packages/react-server-dom-webpack/src/ReactFlightWebpackNodeLoader.js#L323-L354\n         if let EcmascriptExports::EsmExports(exports) = &*self.client_module.get_exports().await? {\n             is_esm = true;\n-            let exports = exports.expand_exports().await?;\n+            let exports = exports.expand_exports(None).await?;\n \n             if !exports.dynamic_exports.is_empty() {\n                 // TODO: throw? warn?"
        },
        {
            "sha": "70adbca2b46ae78710705930f648d43be212c8e9",
            "filename": "crates/next-core/src/next_client_reference/visit_client_reference.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -326,7 +326,7 @@ impl Visit<VisitClientReferenceNode> for VisitClientReference {\n \n             let referenced_modules = referenced_modules\n                 .iter()\n-                .flat_map(|(chunking_type, modules)| match chunking_type {\n+                .flat_map(|(chunking_type, _, modules)| match chunking_type {\n                     ChunkingType::Traced => None,\n                     _ => Some(modules.iter()),\n                 })"
        },
        {
            "sha": "cf076447ef033219f22ceff60483ecad8cab7232",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -797,6 +797,8 @@ pub struct ExperimentalConfig {\n     turbopack_tree_shaking: Option<bool>,\n     // Whether to enable the global-not-found convention\n     global_not_found: Option<bool>,\n+    /// Defaults to false in development mode, true in production mode.\n+    turbopack_remove_unused_exports: Option<bool>,\n }\n \n #[derive(\n@@ -1558,6 +1560,15 @@ impl NextConfig {\n         .cell()\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn turbopack_remove_unused_exports(&self, is_development: bool) -> Vc<bool> {\n+        Vc::cell(\n+            self.experimental\n+                .turbopack_remove_unused_exports\n+                .unwrap_or(!is_development),\n+        )\n+    }\n+\n     #[turbo_tasks::function]\n     pub async fn module_ids(&self, mode: Vc<NextMode>) -> Result<Vc<ModuleIds>> {\n         Ok(match *mode.await? {"
        },
        {
            "sha": "4b67c7f59c25c24b9f092a18952de4fea454e5a9",
            "filename": "crates/next-core/src/next_dynamic/dynamic_module.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_dynamic%2Fdynamic_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_dynamic%2Fdynamic_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_dynamic%2Fdynamic_module.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -11,6 +11,7 @@ use turbopack_core::{\n     module::Module,\n     module_graph::ModuleGraph,\n     reference::{ModuleReferences, SingleChunkableModuleReference},\n+    resolve::ExportUsage,\n };\n use turbopack_ecmascript::{\n     chunk::{\n@@ -56,6 +57,7 @@ impl Module for NextDynamicEntryModule {\n             SingleChunkableModuleReference::new(\n                 Vc::upcast(*self.module),\n                 dynamic_ref_description(),\n+                ExportUsage::all(),\n             )\n             .to_resolved()\n             .await?,\n@@ -98,6 +100,7 @@ impl EcmascriptChunkPlaceable for NextDynamicEntryModule {\n             SingleChunkableModuleReference::new(\n                 Vc::upcast(*self.module),\n                 dynamic_ref_description(),\n+                ExportUsage::all(),\n             )\n             .to_resolved()\n             .await?,"
        },
        {
            "sha": "867240bc83b63789f7fc2ab98361c9472f8cb511",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -565,6 +565,9 @@ pub async fn get_server_module_options_context(\n             None\n         },\n         keep_last_successful_parse: next_mode.is_development(),\n+        remove_unused_exports: *next_config\n+            .turbopack_remove_unused_exports(next_mode.is_development())\n+            .await?,\n         ..Default::default()\n     };\n "
        },
        {
            "sha": "58c8a9afcbf441f5389f38a82bc97e40861d6ced",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -461,6 +461,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         turbopackPersistentCaching: z.boolean().optional(),\n         turbopackSourceMaps: z.boolean().optional(),\n         turbopackTreeShaking: z.boolean().optional(),\n+        turbopackRemoveUnusedExports: z.boolean().optional(),\n         optimizePackageImports: z.array(z.string()).optional(),\n         optimizeServerReact: z.boolean().optional(),\n         clientTraceMetadata: z.array(z.string()).optional(),"
        },
        {
            "sha": "5fc1b8794fd4dd5ed656b0164e8668b322e7c252",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -432,6 +432,11 @@ export interface ExperimentalConfig {\n    */\n   turbopackTreeShaking?: boolean\n \n+  /**\n+   * Enable removing unused exports for turbopack dev server and build.\n+   */\n+  turbopackRemoveUnusedExports?: boolean\n+\n   /**\n    * For use with `@next/mdx`. Compile MDX files using the new Rust compiler.\n    * @see https://nextjs.org/docs/app/api-reference/next-config-js/mdxRs"
        },
        {
            "sha": "e4ea6dc0ad71dd7d8b5b8cf07563e962ac1fc926",
            "filename": "turbopack/crates/turbopack-core/src/chunk/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fmod.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -44,6 +44,7 @@ use crate::{\n     },\n     output::OutputAssets,\n     reference::ModuleReference,\n+    resolve::ExportUsage,\n };\n \n /// A module id, which can be a number or string\n@@ -281,6 +282,11 @@ pub trait ChunkableModuleReference: ModuleReference + ValueToString {\n             hoisted: false,\n         }))\n     }\n+\n+    #[turbo_tasks::function]\n+    fn export_usage(self: Vc<Self>) -> Vc<ExportUsage> {\n+        ExportUsage::all()\n+    }\n }\n \n #[derive(Default)]"
        },
        {
            "sha": "cf5675b97f49dc0dcc95af50b1ce8a23dd517d0a",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/async_module_info.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fasync_module_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fasync_module_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fasync_module_info.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -78,21 +78,21 @@ async fn compute_async_module_info_single(\n         &mut (),\n         |_, _, _| Ok(GraphTraversalAction::Continue),\n         |parent_info, module, _| {\n-            let Some((parent_module, chunking_type)) = parent_info else {\n+            let Some((parent_module, ref_data)) = parent_info else {\n                 // An entry module\n                 return;\n             };\n             let module = module.module();\n             let parent_module = parent_module.module;\n \n-            if chunking_type.is_inherit_async() && async_modules.contains(&module) {\n+            if ref_data.chunking_type.is_inherit_async() && async_modules.contains(&module) {\n                 async_modules.insert(parent_module);\n             }\n         },\n     )?;\n \n     graph.traverse_cycles(\n-        |ty| ty.is_inherit_async(),\n+        |ref_data| ref_data.chunking_type.is_inherit_async(),\n         |cycle| {\n             if cycle\n                 .iter()"
        },
        {
            "sha": "f2578fc3d8d1c756218e4b05468d239691277a4b",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/chunk_group_info.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fchunk_group_info.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -19,7 +19,7 @@ use turbo_tasks::{\n use crate::{\n     chunk::ChunkingType,\n     module::Module,\n-    module_graph::{GraphTraversalAction, ModuleGraph, SingleModuleGraphModuleNode},\n+    module_graph::{GraphTraversalAction, ModuleGraph, RefData, SingleModuleGraphModuleNode},\n };\n \n #[derive(\n@@ -462,7 +462,7 @@ pub async fn compute_chunk_group_info(graph: &ModuleGraph) -> Result<Vc<ChunkGro\n                     })\n                     .collect::<Result<Vec<_>>>()?,\n                 &mut module_chunk_groups,\n-                |parent_info: Option<(&'_ SingleModuleGraphModuleNode, &'_ ChunkingType)>,\n+                |parent_info: Option<(&'_ SingleModuleGraphModuleNode, &'_ RefData)>,\n                  node: &'_ SingleModuleGraphModuleNode,\n                  module_chunk_groups: &mut FxHashMap<\n                     ResolvedVc<Box<dyn Module>>,\n@@ -473,8 +473,8 @@ pub async fn compute_chunk_group_info(graph: &ModuleGraph) -> Result<Vc<ChunkGro\n                         Inherit(ResolvedVc<Box<dyn Module>>),\n                         ChunkGroup(It),\n                     }\n-                    let chunk_groups = if let Some((parent, chunking_type)) = parent_info {\n-                        match chunking_type {\n+                    let chunk_groups = if let Some((parent, ref_data)) = parent_info {\n+                        match &ref_data.chunking_type {\n                             ChunkingType::Parallel { .. } => {\n                                 ChunkGroupInheritance::Inherit(parent.module)\n                             }"
        },
        {
            "sha": "623baefe465b8f0bdd4be0cc1c3d81c5c3f5afa5",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 105,
            "deletions": 62,
            "changes": 167,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -6,7 +6,6 @@ use std::{\n use anyhow::{Context, Result, bail};\n use auto_hash_map::AutoSet;\n use petgraph::{\n-    Directed,\n     graph::{DiGraph, EdgeIndex, NodeIndex},\n     visit::{\n         Dfs, EdgeRef, IntoNeighbors, IntoNodeReferences, NodeIndexable, Reversed, VisitMap,\n@@ -20,6 +19,7 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::{\n     CollectiblesSource, FxIndexMap, NonLocalValue, ReadRef, ResolvedVc, TryJoinIterExt,\n     ValueToString, Vc,\n+    debug::ValueDebugFormat,\n     graph::{AdjacencyMap, GraphTraversal, Visit, VisitControlFlow},\n     trace::TraceRawVcs,\n };\n@@ -37,6 +37,7 @@ use crate::{\n         traced_di_graph::{TracedDiGraph, iter_neighbors_rev},\n     },\n     reference::primary_chunkable_referenced_modules,\n+    resolve::ExportUsage,\n };\n \n pub mod async_module_info;\n@@ -175,7 +176,7 @@ impl GraphEntries {\n #[turbo_tasks::value(cell = \"new\", eq = \"manual\", into = \"new\")]\n #[derive(Clone, Default)]\n pub struct SingleModuleGraph {\n-    graph: TracedDiGraph<SingleModuleGraphNode, ChunkingType>,\n+    graph: TracedDiGraph<SingleModuleGraphNode, RefData>,\n \n     /// The number of modules in the graph (excluding VisitedModule nodes)\n     pub number_of_modules: usize,\n@@ -193,6 +194,23 @@ pub struct SingleModuleGraph {\n     pub entries: GraphEntriesT,\n }\n \n+#[derive(\n+    Debug,\n+    Clone,\n+    Hash,\n+    TraceRawVcs,\n+    Serialize,\n+    Deserialize,\n+    Eq,\n+    PartialEq,\n+    ValueDebugFormat,\n+    NonLocalValue,\n+)]\n+pub struct RefData {\n+    pub chunking_type: ChunkingType,\n+    pub export: ExportUsage,\n+}\n+\n impl SingleModuleGraph {\n     /// Walks the graph starting from the given entries and collects all reachable nodes, skipping\n     /// nodes listed in `visited_modules`\n@@ -208,6 +226,7 @@ impl SingleModuleGraph {\n             .map(|e| async move {\n                 Ok(SingleModuleGraphBuilderEdge {\n                     to: SingleModuleGraphBuilderNode::new_module(e).await?,\n+                    export: ExportUsage::All,\n                 })\n             })\n             .try_join()\n@@ -228,24 +247,27 @@ impl SingleModuleGraph {\n         let node_count = visited_nodes.0.len();\n         drop(visited_nodes);\n \n-        let mut graph: petgraph::Graph<SingleModuleGraphNode, ChunkingType, Directed> =\n-            DiGraph::with_capacity(\n-                node_count,\n-                // From real world measurements each module has about 3-4 children\n-                // If it has more this would cause an additional allocation, but that's fine\n-                node_count * 4,\n-            );\n+        let mut graph: DiGraph<SingleModuleGraphNode, RefData> = DiGraph::with_capacity(\n+            node_count,\n+            // From real world measurements each module has about 3-4 children\n+            // If it has more this would cause an additional allocation, but that's fine\n+            node_count * 4,\n+        );\n \n         let mut number_of_modules = 0;\n         let mut modules: FxHashMap<ResolvedVc<Box<dyn Module>>, NodeIndex> =\n             FxHashMap::with_capacity_and_hasher(node_count, Default::default());\n         {\n             let _span = tracing::info_span!(\"build module graph\").entered();\n-            for (parent, current) in children_nodes_iter.into_breadth_first_edges() {\n-                let parent_edge = match parent {\n-                    Some(SingleModuleGraphBuilderNode::Module { module, .. }) => {\n-                        Some((*modules.get(&module).unwrap(), COMMON_CHUNKING_TYPE))\n-                    }\n+            for (parent, (current, export)) in children_nodes_iter.into_breadth_first_edges() {\n+                let parent_edge = match parent.map(|v| v.0) {\n+                    Some(SingleModuleGraphBuilderNode::Module { module, .. }) => Some((\n+                        *modules.get(&module).unwrap(),\n+                        RefData {\n+                            chunking_type: COMMON_CHUNKING_TYPE,\n+                            export,\n+                        },\n+                    )),\n                     Some(SingleModuleGraphBuilderNode::ChunkableReference { .. }) => {\n                         // Handled when visiting ChunkableReference below\n                         continue;\n@@ -268,8 +290,8 @@ impl SingleModuleGraph {\n                             idx\n                         };\n                         // Add the edge\n-                        if let Some((parent_idx, chunking_type)) = parent_edge {\n-                            graph.add_edge(parent_idx, current_idx, chunking_type);\n+                        if let Some((parent_idx, ref_data)) = parent_edge {\n+                            graph.add_edge(parent_idx, current_idx, ref_data);\n                         }\n                     }\n                     SingleModuleGraphBuilderNode::VisitedModule { module, idx } => {\n@@ -283,14 +305,14 @@ impl SingleModuleGraph {\n                             idx\n                         };\n                         // Add the edge\n-                        if let Some((parent_idx, chunking_type)) = parent_edge {\n-                            graph.add_edge(parent_idx, current_idx, chunking_type);\n+                        if let Some((parent_idx, data)) = parent_edge {\n+                            graph.add_edge(parent_idx, current_idx, data);\n                         }\n                     }\n                     SingleModuleGraphBuilderNode::ChunkableReference {\n                         source,\n                         target,\n-                        chunking_type,\n+                        ref_data,\n                         ..\n                     } => {\n                         // Find the current node, if it was already added\n@@ -312,7 +334,7 @@ impl SingleModuleGraph {\n                             modules.insert(target, idx);\n                             idx\n                         };\n-                        graph.add_edge(*modules.get(&source).unwrap(), target_idx, chunking_type);\n+                        graph.add_edge(*modules.get(&source).unwrap(), target_idx, ref_data);\n                     }\n                 }\n             }\n@@ -409,7 +431,7 @@ impl SingleModuleGraph {\n         &'a self,\n         entries: impl IntoIterator<Item = ResolvedVc<Box<dyn Module>>>,\n         mut visitor: impl FnMut(\n-            Option<(&'a SingleModuleGraphModuleNode, &'a ChunkingType)>,\n+            Option<(&'a SingleModuleGraphModuleNode, &'a RefData)>,\n             &'a SingleModuleGraphModuleNode,\n         ) -> GraphTraversalAction,\n     ) -> Result<()> {\n@@ -469,7 +491,7 @@ impl SingleModuleGraph {\n         &'a self,\n         mut visitor: impl FnMut(\n             (\n-                Option<(&'a SingleModuleGraphModuleNode, &'a ChunkingType)>,\n+                Option<(&'a SingleModuleGraphModuleNode, &'a RefData)>,\n                 &'a SingleModuleGraphModuleNode,\n             ),\n         ) -> GraphTraversalAction,\n@@ -537,12 +559,12 @@ impl SingleModuleGraph {\n         entries: impl IntoIterator<Item = ResolvedVc<Box<dyn Module>>>,\n         state: &mut S,\n         mut visit_preorder: impl FnMut(\n-            Option<(&'a SingleModuleGraphModuleNode, &'a ChunkingType)>,\n+            Option<(&'a SingleModuleGraphModuleNode, &'a RefData)>,\n             &'a SingleModuleGraphNode,\n             &mut S,\n         ) -> Result<GraphTraversalAction>,\n         mut visit_postorder: impl FnMut(\n-            Option<(&'a SingleModuleGraphModuleNode, &'a ChunkingType)>,\n+            Option<(&'a SingleModuleGraphModuleNode, &'a RefData)>,\n             &'a SingleModuleGraphNode,\n             &mut S,\n         ),\n@@ -608,7 +630,7 @@ impl SingleModuleGraph {\n \n     pub fn traverse_cycles<'l>(\n         &'l self,\n-        edge_filter: impl Fn(&'l ChunkingType) -> bool,\n+        edge_filter: impl Fn(&'l RefData) -> bool,\n         mut visit_cycle: impl FnMut(&[&'l SingleModuleGraphModuleNode]),\n     ) {\n         // see https://en.wikipedia.org/wiki/Tarjan%27s_strongly_connected_components_algorithm\n@@ -745,7 +767,7 @@ impl SingleModuleGraph {\n                         module_idx,\n                         |n| reversed_graph.neighbors(n).next().is_none(),\n                         // Edge weights\n-                        |e| match e.weight() {\n+                        |e| match e.weight().chunking_type {\n                             // Prefer following normal imports/requires when we can\n                             ChunkingType::Parallel { .. } => 0,\n                             _ => 1,\n@@ -870,7 +892,7 @@ impl ImportTracer for ModuleGraphImportTracer {\n                         module_idx,\n                         |n| reversed_graph.neighbors(n).next().is_none(),\n                         // Edge weights\n-                        |e| match e.weight() {\n+                        |e| match e.weight().chunking_type {\n                             // Prefer following normal imports/requires when we can\n                             ChunkingType::Parallel { .. } => 0,\n                             _ => 1,\n@@ -1007,7 +1029,7 @@ impl ModuleGraph {\n                         .graph\n                         .edge_weight(*edge_idx)\n                         .unwrap();\n-                    ty.is_inherit_async()\n+                    ty.chunking_type.is_inherit_async()\n                 })\n                 .map(|(_, child_idx)| {\n                     anyhow::Ok(\n@@ -1125,7 +1147,7 @@ impl ModuleGraph {\n         &self,\n         entries: impl IntoIterator<Item = ResolvedVc<Box<dyn Module>>>,\n         mut visitor: impl FnMut(\n-            Option<(&'_ SingleModuleGraphModuleNode, &'_ ChunkingType)>,\n+            Option<(&'_ SingleModuleGraphModuleNode, &'_ RefData)>,\n             &'_ SingleModuleGraphModuleNode,\n         ) -> Result<GraphTraversalAction>,\n     ) -> Result<()> {\n@@ -1180,7 +1202,7 @@ impl ModuleGraph {\n         &self,\n         entries: impl IntoIterator<Item = ResolvedVc<Box<dyn Module>>>,\n         mut visitor: impl FnMut(\n-            Option<(&'_ SingleModuleGraphModuleNode, &'_ ChunkingType)>,\n+            Option<(&'_ SingleModuleGraphModuleNode, &'_ RefData)>,\n             &'_ SingleModuleGraphModuleNode,\n         ) -> GraphTraversalAction,\n     ) -> Result<()> {\n@@ -1230,7 +1252,7 @@ impl ModuleGraph {\n     pub async fn traverse_all_edges_unordered(\n         &self,\n         mut visitor: impl FnMut(\n-            (&'_ SingleModuleGraphModuleNode, &'_ ChunkingType),\n+            (&'_ SingleModuleGraphModuleNode, &'_ RefData),\n             &'_ SingleModuleGraphModuleNode,\n         ) -> Result<()>,\n     ) -> Result<()> {\n@@ -1277,12 +1299,12 @@ impl ModuleGraph {\n         entries: impl IntoIterator<Item = ResolvedVc<Box<dyn Module>>>,\n         state: &mut S,\n         mut visit_preorder: impl FnMut(\n-            Option<(&'_ SingleModuleGraphModuleNode, &'_ ChunkingType)>,\n+            Option<(&'_ SingleModuleGraphModuleNode, &'_ RefData)>,\n             &'_ SingleModuleGraphModuleNode,\n             &mut S,\n         ) -> Result<GraphTraversalAction>,\n         mut visit_postorder: impl FnMut(\n-            Option<(&'_ SingleModuleGraphModuleNode, &'_ ChunkingType)>,\n+            Option<(&'_ SingleModuleGraphModuleNode, &'_ RefData)>,\n             &'_ SingleModuleGraphModuleNode,\n             &mut S,\n         ),\n@@ -1368,7 +1390,7 @@ impl ModuleGraph {\n     /// and call the visitor with the nodes in the cycle.\n     pub async fn traverse_cycles(\n         &self,\n-        edge_filter: impl Fn(&ChunkingType) -> bool,\n+        edge_filter: impl Fn(&RefData) -> bool,\n         mut visit_cycle: impl FnMut(&[&SingleModuleGraphModuleNode]),\n     ) -> Result<()> {\n         for graph in &self.graphs {\n@@ -1403,7 +1425,7 @@ impl ModuleGraph {\n         entries: impl IntoIterator<Item = (ResolvedVc<Box<dyn Module>>, P)>,\n         state: &mut S,\n         mut visit: impl FnMut(\n-            Option<(&'_ SingleModuleGraphModuleNode, &'_ ChunkingType)>,\n+            Option<(&'_ SingleModuleGraphModuleNode, &'_ RefData)>,\n             &'_ SingleModuleGraphModuleNode,\n             &mut S,\n         ) -> Result<GraphTraversalAction>,\n@@ -1556,7 +1578,7 @@ pub enum GraphTraversalAction {\n enum SingleModuleGraphBuilderNode {\n     /// This edge is represented as a node: source Module -> ChunkableReference ->  target Module\n     ChunkableReference {\n-        chunking_type: ChunkingType,\n+        ref_data: RefData,\n         source: ResolvedVc<Box<dyn Module>>,\n         target: ResolvedVc<Box<dyn Module>>,\n         // These two fields are only used for tracing. Derived from `source.ident()` and\n@@ -1588,10 +1610,10 @@ impl SingleModuleGraphBuilderNode {\n     async fn new_chunkable_ref(\n         source: ResolvedVc<Box<dyn Module>>,\n         target: ResolvedVc<Box<dyn Module>>,\n-        chunking_type: ChunkingType,\n+        ref_data: RefData,\n     ) -> Result<Self> {\n         Ok(Self::ChunkableReference {\n-            chunking_type,\n+            ref_data,\n             source,\n             source_ident: source.ident().to_string().await?,\n             target,\n@@ -1604,6 +1626,7 @@ impl SingleModuleGraphBuilderNode {\n }\n struct SingleModuleGraphBuilderEdge {\n     to: SingleModuleGraphBuilderNode,\n+    export: ExportUsage,\n }\n \n /// The chunking type that occurs most often, is handled more efficiently by not creating\n@@ -1618,32 +1641,42 @@ struct SingleModuleGraphBuilder<'a> {\n     /// Whether to walk ChunkingType::Traced references\n     include_traced: bool,\n }\n-impl Visit<SingleModuleGraphBuilderNode> for SingleModuleGraphBuilder<'_> {\n+impl Visit<(SingleModuleGraphBuilderNode, ExportUsage)> for SingleModuleGraphBuilder<'_> {\n     type Edge = SingleModuleGraphBuilderEdge;\n     type EdgesIntoIter = Vec<Self::Edge>;\n     type EdgesFuture = impl Future<Output = Result<Self::EdgesIntoIter>>;\n \n-    fn visit(&mut self, edge: Self::Edge) -> VisitControlFlow<SingleModuleGraphBuilderNode> {\n+    fn visit(\n+        &mut self,\n+        edge: Self::Edge,\n+    ) -> VisitControlFlow<(SingleModuleGraphBuilderNode, ExportUsage)> {\n         match edge.to {\n-            SingleModuleGraphBuilderNode::Module { .. } => VisitControlFlow::Continue(edge.to),\n-            SingleModuleGraphBuilderNode::ChunkableReference {\n-                ref chunking_type, ..\n-            } => match chunking_type {\n-                ChunkingType::Traced => VisitControlFlow::Skip(edge.to),\n-                _ => VisitControlFlow::Continue(edge.to),\n-            },\n+            SingleModuleGraphBuilderNode::Module { .. } => {\n+                VisitControlFlow::Continue((edge.to, edge.export))\n+            }\n+            SingleModuleGraphBuilderNode::ChunkableReference { ref ref_data, .. } => {\n+                match &ref_data.chunking_type {\n+                    ChunkingType::Traced => VisitControlFlow::Skip((edge.to, edge.export)),\n+                    _ => VisitControlFlow::Continue((edge.to, edge.export)),\n+                }\n+            }\n             // Module was already visited previously\n-            SingleModuleGraphBuilderNode::VisitedModule { .. } => VisitControlFlow::Skip(edge.to),\n+            SingleModuleGraphBuilderNode::VisitedModule { .. } => {\n+                VisitControlFlow::Skip((edge.to, edge.export))\n+            }\n         }\n     }\n \n-    fn edges(&mut self, node: &SingleModuleGraphBuilderNode) -> Self::EdgesFuture {\n+    fn edges(\n+        &mut self,\n+        (node, _): &(SingleModuleGraphBuilderNode, ExportUsage),\n+    ) -> Self::EdgesFuture {\n         // Destructure beforehand to not have to clone the whole node when entering the async block\n         let (module, chunkable_ref_target) = match node {\n             SingleModuleGraphBuilderNode::Module { module, .. } => (Some(*module), None),\n-            SingleModuleGraphBuilderNode::ChunkableReference { target, .. } => {\n-                (None, Some(*target))\n-            }\n+            SingleModuleGraphBuilderNode::ChunkableReference {\n+                target, ref_data, ..\n+            } => (None, Some((*target, ref_data.export.clone()))),\n             // These are always skipped in `visit()`\n             SingleModuleGraphBuilderNode::VisitedModule { .. } => unreachable!(),\n         };\n@@ -1661,24 +1694,33 @@ impl Visit<SingleModuleGraphBuilderNode> for SingleModuleGraphBuilder<'_> {\n                     };\n \n                     refs.iter()\n-                        .flat_map(|(ty, modules)| modules.iter().map(|m| (ty.clone(), *m)))\n-                        .map(async |(ty, target)| {\n+                        .flat_map(|(ty, export, modules)| {\n+                            modules.iter().map(|m| (ty.clone(), export.clone(), *m))\n+                        })\n+                        .map(async |(ty, export, target)| {\n                             let to = if ty == COMMON_CHUNKING_TYPE {\n                                 if let Some(idx) = visited_modules.get(&target) {\n                                     SingleModuleGraphBuilderNode::new_visited_module(target, *idx)\n                                 } else {\n                                     SingleModuleGraphBuilderNode::new_module(target).await?\n                                 }\n                             } else {\n-                                SingleModuleGraphBuilderNode::new_chunkable_ref(module, target, ty)\n-                                    .await?\n+                                SingleModuleGraphBuilderNode::new_chunkable_ref(\n+                                    module,\n+                                    target,\n+                                    RefData {\n+                                        chunking_type: ty,\n+                                        export: export.clone(),\n+                                    },\n+                                )\n+                                .await?\n                             };\n-                            Ok(SingleModuleGraphBuilderEdge { to })\n+                            Ok(SingleModuleGraphBuilderEdge { to, export })\n                         })\n                         .try_join()\n                         .await?\n                 }\n-                (None, Some(chunkable_ref_target)) => {\n+                (None, Some((chunkable_ref_target, export))) => {\n                     vec![SingleModuleGraphBuilderEdge {\n                         to: if let Some(idx) = visited_modules.get(&chunkable_ref_target) {\n                             SingleModuleGraphBuilderNode::new_visited_module(\n@@ -1688,33 +1730,34 @@ impl Visit<SingleModuleGraphBuilderNode> for SingleModuleGraphBuilder<'_> {\n                         } else {\n                             SingleModuleGraphBuilderNode::new_module(chunkable_ref_target).await?\n                         },\n+                        export,\n                     }]\n                 }\n                 _ => unreachable!(),\n             })\n         }\n     }\n \n-    fn span(&mut self, node: &SingleModuleGraphBuilderNode) -> tracing::Span {\n+    fn span(&mut self, (node, _): &(SingleModuleGraphBuilderNode, ExportUsage)) -> tracing::Span {\n         match node {\n             SingleModuleGraphBuilderNode::Module { ident, .. } => {\n                 tracing::info_span!(\"module\", name = display(ident))\n             }\n \n             SingleModuleGraphBuilderNode::ChunkableReference {\n-                chunking_type,\n+                ref_data,\n                 source_ident,\n                 target_ident,\n                 ..\n-            } => match chunking_type {\n+            } => match &ref_data.chunking_type {\n                 ChunkingType::Parallel {\n                     inherit_async: false,\n                     ..\n                 } => Span::current(),\n                 _ => {\n                     tracing::info_span!(\n                         \"chunkable reference\",\n-                        ty = debug(chunking_type),\n+                        ty = debug(&ref_data.chunking_type),\n                         source = display(source_ident),\n                         target = display(target_ident)\n                     )"
        },
        {
            "sha": "78f3fa73aae259674989ffe842d0c511dc78f815",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/module_batches.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmodule_batches.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmodule_batches.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmodule_batches.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -302,7 +302,7 @@ impl PreBatches {\n                             inherit_async: false,\n                             hoisted: false,\n                         },\n-                        |(_, ty)| ty,\n+                        |(_, ty)| &ty.chunking_type,\n                     );\n                     let module = node.module;\n                     if !ty.is_parallel() {\n@@ -367,7 +367,7 @@ pub async fn compute_module_batches(\n                     // Already a boundary module, can skip check\n                     return Ok(());\n                 };\n-                if ty.is_parallel() {\n+                if ty.chunking_type.is_parallel() {\n                     let parent_chunk_groups = chunk_group_info\n                         .module_chunk_groups\n                         .get(&parent.module)\n@@ -398,7 +398,7 @@ pub async fn compute_module_batches(\n         // cycles that include boundary modules\n         module_graph\n             .traverse_cycles(\n-                |ty| ty.is_parallel(),\n+                |ref_data| ref_data.chunking_type.is_parallel(),\n                 |cycle| {\n                     if cycle\n                         .iter()"
        },
        {
            "sha": "0d75b1171dafd073f8f1ea59097ab3a6532cd9a9",
            "filename": "turbopack/crates/turbopack-core/src/reference/mod.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 6,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Freference%2Fmod.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -12,7 +12,7 @@ use crate::{\n     module::{Module, Modules},\n     output::{OutputAsset, OutputAssets},\n     raw_module::RawModule,\n-    resolve::{ModuleResolveResult, RequestKey},\n+    resolve::{ExportUsage, ModuleResolveResult, RequestKey},\n };\n pub mod source_map;\n \n@@ -89,13 +89,22 @@ impl SingleModuleReference {\n pub struct SingleChunkableModuleReference {\n     asset: ResolvedVc<Box<dyn Module>>,\n     description: RcStr,\n+    export: ResolvedVc<ExportUsage>,\n }\n \n #[turbo_tasks::value_impl]\n impl SingleChunkableModuleReference {\n     #[turbo_tasks::function]\n-    pub fn new(asset: ResolvedVc<Box<dyn Module>>, description: RcStr) -> Vc<Self> {\n-        Self::cell(SingleChunkableModuleReference { asset, description })\n+    pub fn new(\n+        asset: ResolvedVc<Box<dyn Module>>,\n+        description: RcStr,\n+        export: ResolvedVc<ExportUsage>,\n+    ) -> Vc<Self> {\n+        Self::cell(SingleChunkableModuleReference {\n+            asset,\n+            description,\n+            export,\n+        })\n     }\n }\n \n@@ -108,6 +117,11 @@ impl ChunkableModuleReference for SingleChunkableModuleReference {\n             hoisted: false,\n         }))\n     }\n+\n+    #[turbo_tasks::function]\n+    fn export_usage(&self) -> Vc<ExportUsage> {\n+        *self.export\n+    }\n }\n \n #[turbo_tasks::value_impl]\n@@ -273,7 +287,7 @@ pub async fn primary_referenced_modules(module: Vc<Box<dyn Module>>) -> Result<V\n \n type ModulesVec = Vec<ResolvedVc<Box<dyn Module>>>;\n #[turbo_tasks::value(transparent)]\n-pub struct ModulesWithChunkingType(Vec<(ChunkingType, ModulesVec)>);\n+pub struct ModulesWithRefData(Vec<(ChunkingType, ExportUsage, ModulesVec)>);\n \n /// Aggregates all primary [Module]s referenced by an [Module] via [ChunkableModuleReference]s.\n /// This does not include transitively references [Module]s, only includes\n@@ -284,7 +298,7 @@ pub struct ModulesWithChunkingType(Vec<(ChunkingType, ModulesVec)>);\n pub async fn primary_chunkable_referenced_modules(\n     module: Vc<Box<dyn Module>>,\n     include_traced: bool,\n-) -> Result<Vc<ModulesWithChunkingType>> {\n+) -> Result<Vc<ModulesWithRefData>> {\n     let modules = module\n         .references()\n         .await?\n@@ -305,7 +319,9 @@ pub async fn primary_chunkable_referenced_modules(\n                     .primary_modules()\n                     .owned()\n                     .await?;\n-                return Ok(Some((chunking_type.clone(), resolved)));\n+                let export = (*reference.export_usage().await?).clone();\n+\n+                return Ok(Some((chunking_type.clone(), export, resolved)));\n             }\n             Ok(None)\n         })"
        },
        {
            "sha": "48e68a9a606803746defb6d3219f5ce27c2fc6c8",
            "filename": "turbopack/crates/turbopack-core/src/resolve/mod.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -103,6 +103,35 @@ impl ModuleResolveResultItem {\n     }\n }\n \n+#[turbo_tasks::value]\n+#[derive(Debug, Clone, Default, Hash)]\n+pub enum ExportUsage {\n+    Named(RcStr),\n+    /// This means the whole content of the module is used.\n+    #[default]\n+    All,\n+    /// Only side effects are used.\n+    Evaluation,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl ExportUsage {\n+    #[turbo_tasks::function]\n+    pub fn all() -> Vc<Self> {\n+        Self::All.cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    pub fn evaluation() -> Vc<Self> {\n+        Self::Evaluation.cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    pub fn named(name: RcStr) -> Vc<Self> {\n+        Self::Named(name).cell()\n+    }\n+}\n+\n #[turbo_tasks::value(shared)]\n #[derive(Clone)]\n pub struct ModuleResolveResult {\n@@ -1773,6 +1802,7 @@ async fn resolve_internal_inline(\n     };\n     async move {\n         let options_value: &ResolveOptions = &*options.await?;\n+\n         let request_value = request.await?;\n \n         // Apply import mappings if provided"
        },
        {
            "sha": "b32236138758237242510c6ebcd09c1035c5bd6b",
            "filename": "turbopack/crates/turbopack-ecmascript/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -15,6 +15,7 @@ workspace = true\n [dependencies]\n anyhow = { workspace = true }\n async-trait = { workspace = true }\n+auto-hash-map = { workspace = true }\n bytes-str = { workspace = true }\n data-encoding = { workspace = true }\n either = { workspace = true }"
        },
        {
            "sha": "e5bd446694e35c06d39839649d081589c00b94ff",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 4,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -22,6 +22,7 @@ mod path_visitor;\n pub mod references;\n pub mod runtime_functions;\n pub mod side_effect_optimization;\n+pub mod simple_tree_shake;\n pub(crate) mod special_cases;\n pub(crate) mod static_code;\n mod swc_comments;\n@@ -106,6 +107,7 @@ use crate::{\n         analyse_ecmascript_module, async_module::OptionAsyncModule, esm::base::EsmAssetReferences,\n     },\n     side_effect_optimization::reference::EcmascriptModulePartReference,\n+    simple_tree_shake::{ModuleExportUsageInfo, get_module_export_usages},\n     swc_comments::ImmutableComments,\n     transform::remove_shebang,\n };\n@@ -143,9 +145,9 @@ pub enum SpecifiedModuleType {\n     Default,\n     Serialize,\n     Deserialize,\n+    TaskInput,\n     TraceRawVcs,\n     NonLocalValue,\n-    TaskInput,\n )]\n #[serde(rename_all = \"kebab-case\")]\n pub enum TreeShakingMode {\n@@ -183,6 +185,8 @@ pub struct EcmascriptOptions {\n     /// parsing fails. This is useful to keep the module graph structure intact when syntax errors\n     /// are temporarily introduced.\n     pub keep_last_successful_parse: bool,\n+\n+    pub remove_unused_exports: bool,\n }\n \n #[turbo_tasks::value]\n@@ -449,7 +453,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n \n     #[turbo_tasks::function]\n     async fn module_content_options(\n-        self: Vc<Self>,\n+        self: ResolvedVc<Self>,\n         module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n@@ -461,9 +465,19 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n \n         let module_type_result = *self.determine_module_type().await?;\n         let generate_source_map = *chunking_context\n-            .reference_module_source_maps(Vc::upcast(self))\n+            .reference_module_source_maps(Vc::upcast(*self))\n             .await?;\n \n+        let export_usage_info = if self.options().await?.remove_unused_exports {\n+            Some(\n+                get_module_export_usages(*module_graph, Vc::upcast(*self))\n+                    .to_resolved()\n+                    .await?,\n+            )\n+        } else {\n+            None\n+        };\n+\n         Ok(EcmascriptModuleContentOptions {\n             parsed,\n             ident: self.ident().to_resolved().await?,\n@@ -479,6 +493,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleAsset {\n             original_source_map: analyze_ref.source_map,\n             exports: analyze_ref.exports,\n             async_module_info,\n+            export_usage_info,\n         }\n         .cell())\n     }\n@@ -832,6 +847,7 @@ pub struct EcmascriptModuleContentOptions {\n     original_source_map: Option<ResolvedVc<Box<dyn GenerateSourceMap>>>,\n     exports: ResolvedVc<EcmascriptExports>,\n     async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n+    export_usage_info: Option<ResolvedVc<ModuleExportUsageInfo>>,\n }\n \n impl EcmascriptModuleContentOptions {\n@@ -847,6 +863,7 @@ impl EcmascriptModuleContentOptions {\n             async_module,\n             exports,\n             async_module_info,\n+            export_usage_info,\n             ..\n         } = self;\n \n@@ -868,7 +885,7 @@ impl EcmascriptModuleContentOptions {\n                 if let EcmascriptExports::EsmExports(exports) = *exports.await? {\n                     Some(\n                         exports\n-                            .code_generation(**module_graph, **chunking_context, Some(**parsed))\n+                            .code_generation(**chunking_context, Some(**parsed), *export_usage_info)\n                             .await?,\n                     )\n                 } else {"
        },
        {
            "sha": "009417349f646276f7c2ee18c3cfddf543d77e75",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/base.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fbase.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -22,7 +22,8 @@ use turbopack_core::{\n     reference::ModuleReference,\n     reference_type::{EcmaScriptModulesReferenceSubType, ImportWithType},\n     resolve::{\n-        ExternalType, ModulePart, ModuleResolveResult, ModuleResolveResultItem, RequestKey,\n+        ExportUsage, ExternalType, ModulePart, ModuleResolveResult, ModuleResolveResultItem,\n+        RequestKey,\n         origin::{ResolveOrigin, ResolveOriginExt},\n         parse::Request,\n     },\n@@ -288,6 +289,15 @@ impl ChunkableModuleReference for EsmAssetReference {\n             },\n         ))\n     }\n+\n+    #[turbo_tasks::function]\n+    fn export_usage(&self) -> Vc<ExportUsage> {\n+        match &self.export_name {\n+            Some(ModulePart::Export(export_name)) => ExportUsage::named(export_name.clone()),\n+            Some(ModulePart::Evaluation) => ExportUsage::evaluation(),\n+            _ => ExportUsage::all(),\n+        }\n+    }\n }\n \n impl EsmAssetReference {"
        },
        {
            "sha": "499b2656513576fd59a46bd59b12f2f57a357e35",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 4,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -22,7 +22,6 @@ use turbopack_core::{\n     ident::AssetIdent,\n     issue::{IssueExt, IssueSeverity, StyledString, analyze::AnalyzeIssue},\n     module::Module,\n-    module_graph::ModuleGraph,\n     reference::ModuleReference,\n     resolve::ModulePart,\n };\n@@ -35,6 +34,7 @@ use crate::{\n     magic_identifier,\n     parse::ParseResult,\n     runtime_functions::{TURBOPACK_DYNAMIC, TURBOPACK_ESM},\n+    simple_tree_shake::ModuleExportUsageInfo,\n     tree_shake::asset::EcmascriptModulePartAsset,\n };\n \n@@ -490,9 +490,20 @@ pub struct ExpandedExports {\n #[turbo_tasks::value_impl]\n impl EsmExports {\n     #[turbo_tasks::function]\n-    pub async fn expand_exports(&self) -> Result<Vc<ExpandedExports>> {\n+    pub async fn expand_exports(\n+        &self,\n+        export_usage_info: Option<ResolvedVc<ModuleExportUsageInfo>>,\n+    ) -> Result<Vc<ExpandedExports>> {\n         let mut exports: BTreeMap<RcStr, EsmExport> = self.exports.clone();\n         let mut dynamic_exports = vec![];\n+        let usage_info = match export_usage_info {\n+            Some(usage_info) => Some(usage_info.await?),\n+            None => None,\n+        };\n+\n+        if let Some(usage_info) = &usage_info {\n+            exports.retain(|export, _| usage_info.is_export_used(export));\n+        }\n \n         for &esm_ref in self.star_exports.iter() {\n             // TODO(PACK-2176): we probably need to handle re-exporting from external\n@@ -506,6 +517,12 @@ impl EsmExports {\n             let export_info = expand_star_exports(**asset).await?;\n \n             for export in &export_info.star_exports {\n+                if let Some(usage_info) = &usage_info\n+                    && !usage_info.is_export_used(export)\n+                {\n+                    continue;\n+                }\n+\n                 if !exports.contains_key(export) {\n                     exports.insert(\n                         export.clone(),\n@@ -534,11 +551,11 @@ impl EsmExports {\n impl EsmExports {\n     pub async fn code_generation(\n         self: Vc<Self>,\n-        _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n         parsed: Option<Vc<ParseResult>>,\n+        export_usage_info: Option<ResolvedVc<ModuleExportUsageInfo>>,\n     ) -> Result<CodeGeneration> {\n-        let expanded = self.expand_exports().await?;\n+        let expanded = self.expand_exports(export_usage_info.map(|v| *v)).await?;\n         let parsed = if let Some(parsed) = parsed {\n             Some(parsed.await?)\n         } else {"
        },
        {
            "sha": "8d445dd44f4f50c813db4f82e36f06a69feac99c",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -2585,10 +2585,9 @@ async fn handle_free_var_reference(\n                         ),\n                         Default::default(),\n                         match state.tree_shaking_mode {\n-                            Some(TreeShakingMode::ModuleFragments)\n-                            | Some(TreeShakingMode::ReexportsOnly) => {\n-                                export.clone().map(ModulePart::export)\n-                            }\n+                            Some(\n+                                TreeShakingMode::ModuleFragments | TreeShakingMode::ReexportsOnly,\n+                            ) => export.clone().map(ModulePart::export),\n                             None => None,\n                         },\n                         state.import_externals,"
        },
        {
            "sha": "fb4ad7408c2d8c30a7ca99007a85e3a408b231a1",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/module.rs",
            "status": "modified",
            "additions": 76,
            "deletions": 26,
            "changes": 102,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -26,6 +26,7 @@ use crate::{\n         esm::{EsmExport, EsmExports, base::EsmAssetReferences},\n     },\n     side_effect_optimization::reference::EcmascriptModulePartReference,\n+    simple_tree_shake::get_module_export_usages,\n };\n \n /// A module derived from an original ecmascript module that only contains all\n@@ -35,13 +36,23 @@ use crate::{\n pub struct EcmascriptModuleFacadeModule {\n     pub module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     pub ty: ModulePart,\n+    pub remove_unused_exports: bool,\n }\n \n #[turbo_tasks::value_impl]\n impl EcmascriptModuleFacadeModule {\n     #[turbo_tasks::function]\n-    pub fn new(module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>, ty: ModulePart) -> Vc<Self> {\n-        EcmascriptModuleFacadeModule { module, ty }.cell()\n+    pub fn new(\n+        module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+        ty: ModulePart,\n+        remove_unused_exports: bool,\n+    ) -> Vc<Self> {\n+        EcmascriptModuleFacadeModule {\n+            module,\n+            ty,\n+            remove_unused_exports,\n+        }\n+        .cell()\n     }\n \n     #[turbo_tasks::function]\n@@ -84,9 +95,13 @@ impl EcmascriptModuleFacadeModule {\n                 (\n                     result.esm_evaluation_references,\n                     vec![\n-                        EcmascriptModulePartReference::new_part(*self.module, ModulePart::locals())\n-                            .to_resolved()\n-                            .await?,\n+                        EcmascriptModulePartReference::new_part(\n+                            *self.module,\n+                            ModulePart::locals(),\n+                            self.remove_unused_exports,\n+                        )\n+                        .to_resolved()\n+                        .await?,\n                     ],\n                 )\n             }\n@@ -103,35 +118,47 @@ impl EcmascriptModuleFacadeModule {\n                 (\n                     result.esm_reexport_references,\n                     vec![\n-                        EcmascriptModulePartReference::new_part(*self.module, ModulePart::locals())\n-                            .to_resolved()\n-                            .await?,\n+                        EcmascriptModulePartReference::new_part(\n+                            *self.module,\n+                            ModulePart::locals(),\n+                            self.remove_unused_exports,\n+                        )\n+                        .to_resolved()\n+                        .await?,\n                     ],\n                 )\n             }\n             ModulePart::Facade => (\n                 EsmAssetReferences::empty().to_resolved().await?,\n                 vec![\n-                    EcmascriptModulePartReference::new_part(*self.module, ModulePart::evaluation())\n-                        .to_resolved()\n-                        .await?,\n-                    EcmascriptModulePartReference::new_part(*self.module, ModulePart::exports())\n-                        .to_resolved()\n-                        .await?,\n+                    EcmascriptModulePartReference::new_part(\n+                        *self.module,\n+                        ModulePart::evaluation(),\n+                        self.remove_unused_exports,\n+                    )\n+                    .to_resolved()\n+                    .await?,\n+                    EcmascriptModulePartReference::new_part(\n+                        *self.module,\n+                        ModulePart::exports(),\n+                        self.remove_unused_exports,\n+                    )\n+                    .to_resolved()\n+                    .await?,\n                 ],\n             ),\n             ModulePart::RenamedNamespace { .. } => (\n                 EsmAssetReferences::empty().to_resolved().await?,\n                 vec![\n-                    EcmascriptModulePartReference::new(*self.module)\n+                    EcmascriptModulePartReference::new(*self.module, self.remove_unused_exports)\n                         .to_resolved()\n                         .await?,\n                 ],\n             ),\n             ModulePart::RenamedExport { .. } => (\n                 EsmAssetReferences::empty().to_resolved().await?,\n                 vec![\n-                    EcmascriptModulePartReference::new(*self.module)\n+                    EcmascriptModulePartReference::new(*self.module, self.remove_unused_exports)\n                         .to_resolved()\n                         .await?,\n                 ],\n@@ -203,13 +230,23 @@ impl EcmascriptAnalyzable for EcmascriptModuleFacadeModule {\n \n     #[turbo_tasks::function]\n     async fn module_content_options(\n-        self: Vc<Self>,\n+        self: ResolvedVc<Self>,\n         module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n         async_module_info: Option<ResolvedVc<AsyncModuleInfo>>,\n     ) -> Result<Vc<EcmascriptModuleContentOptions>> {\n         let (esm_references, part_references) = self.await?.specific_references().await?;\n \n+        let export_usage_info = if self.await?.remove_unused_exports {\n+            Some(\n+                get_module_export_usages(*module_graph, Vc::upcast(*self))\n+                    .to_resolved()\n+                    .await?,\n+            )\n+        } else {\n+            None\n+        };\n+\n         Ok(EcmascriptModuleContentOptions {\n             parsed: ParseResult::empty().to_resolved().await?,\n             ident: self.ident().to_resolved().await?,\n@@ -225,6 +262,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleFacadeModule {\n             original_source_map: None,\n             exports: self.get_exports().to_resolved().await?,\n             async_module_info,\n+            export_usage_info,\n         }\n         .cell())\n     }\n@@ -257,6 +295,7 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                                         EcmascriptModulePartReference::new_part(\n                                             *self.module,\n                                             ModulePart::locals(),\n+                                            self.remove_unused_exports,\n                                         )\n                                         .to_resolved()\n                                         .await?,\n@@ -304,6 +343,7 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                                 EcmascriptModulePartReference::new_part(\n                                     *self.module,\n                                     ModulePart::exports(),\n+                                    self.remove_unused_exports,\n                                 )\n                                 .to_resolved()\n                                 .await?,\n@@ -314,9 +354,13 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                     );\n                 }\n                 star_exports.push(ResolvedVc::upcast(\n-                    EcmascriptModulePartReference::new_part(*self.module, ModulePart::exports())\n-                        .to_resolved()\n-                        .await?,\n+                    EcmascriptModulePartReference::new_part(\n+                        *self.module,\n+                        ModulePart::exports(),\n+                        self.remove_unused_exports,\n+                    )\n+                    .to_resolved()\n+                    .await?,\n                 ));\n             }\n             ModulePart::RenamedExport {\n@@ -327,9 +371,12 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                     export.clone(),\n                     EsmExport::ImportedBinding(\n                         ResolvedVc::upcast(\n-                            EcmascriptModulePartReference::new(*self.module)\n-                                .to_resolved()\n-                                .await?,\n+                            EcmascriptModulePartReference::new(\n+                                *self.module,\n+                                self.remove_unused_exports,\n+                            )\n+                            .to_resolved()\n+                            .await?,\n                         ),\n                         original_export.clone(),\n                         false,\n@@ -340,9 +387,12 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                 exports.insert(\n                     export.clone(),\n                     EsmExport::ImportedNamespace(ResolvedVc::upcast(\n-                        EcmascriptModulePartReference::new(*self.module)\n-                            .to_resolved()\n-                            .await?,\n+                        EcmascriptModulePartReference::new(\n+                            *self.module,\n+                            self.remove_unused_exports,\n+                        )\n+                        .to_resolved()\n+                        .await?,\n                     )),\n                 );\n             }"
        },
        {
            "sha": "b8bcce0389284e0475ad7f969dc7ecf3ce834a34",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/locals/module.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Flocals%2Fmodule.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -22,6 +22,7 @@ use crate::{\n         async_module::OptionAsyncModule,\n         esm::{EsmExport, EsmExports},\n     },\n+    simple_tree_shake::get_module_export_usages,\n };\n \n /// A module derived from an original ecmascript module that only contains the\n@@ -108,6 +109,16 @@ impl EcmascriptAnalyzable for EcmascriptModuleLocalsModule {\n             .reference_module_source_maps(Vc::upcast(self))\n             .await?;\n \n+        let export_usage_info = if original_module.options().await?.remove_unused_exports {\n+            Some(\n+                get_module_export_usages(*module_graph, Vc::upcast(self))\n+                    .to_resolved()\n+                    .await?,\n+            )\n+        } else {\n+            None\n+        };\n+\n         Ok(EcmascriptModuleContentOptions {\n             parsed,\n             ident: self.ident().to_resolved().await?,\n@@ -123,6 +134,7 @@ impl EcmascriptAnalyzable for EcmascriptModuleLocalsModule {\n             original_source_map: analyze_result.source_map,\n             exports,\n             async_module_info,\n+            export_usage_info,\n         }\n         .cell())\n     }"
        },
        {
            "sha": "abd1732993cdbf478a2ab07921ca283ade65bd5e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/reference.rs",
            "status": "modified",
            "additions": 31,
            "deletions": 6,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -9,7 +9,7 @@ use turbopack_core::{\n     },\n     module::Module,\n     reference::ModuleReference,\n-    resolve::{ModulePart, ModuleResolveResult},\n+    resolve::{ExportUsage, ModulePart, ModuleResolveResult},\n };\n \n use super::{\n@@ -27,6 +27,7 @@ use crate::{\n pub struct EcmascriptModulePartReference {\n     pub module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n     pub part: Option<ModulePart>,\n+    pub remove_unused_exports: bool,\n }\n \n #[turbo_tasks::value_impl]\n@@ -35,17 +36,27 @@ impl EcmascriptModulePartReference {\n     pub fn new_part(\n         module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n         part: ModulePart,\n+        remove_unused_exports: bool,\n     ) -> Vc<Self> {\n         EcmascriptModulePartReference {\n             module,\n             part: Some(part),\n+            remove_unused_exports,\n         }\n         .cell()\n     }\n \n     #[turbo_tasks::function]\n-    pub fn new(module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>) -> Vc<Self> {\n-        EcmascriptModulePartReference { module, part: None }.cell()\n+    pub fn new(\n+        module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+        remove_unused_exports: bool,\n+    ) -> Vc<Self> {\n+        EcmascriptModulePartReference {\n+            module,\n+            part: None,\n+            remove_unused_exports,\n+        }\n+        .cell()\n     }\n }\n \n@@ -79,9 +90,13 @@ impl ModuleReference for EcmascriptModulePartReference {\n                 | ModulePart::Evaluation\n                 | ModulePart::Facade\n                 | ModulePart::RenamedExport { .. }\n-                | ModulePart::RenamedNamespace { .. } => Vc::upcast(\n-                    EcmascriptModuleFacadeModule::new(*self.module, part.clone()),\n-                ),\n+                | ModulePart::RenamedNamespace { .. } => {\n+                    Vc::upcast(EcmascriptModuleFacadeModule::new(\n+                        *self.module,\n+                        part.clone(),\n+                        self.remove_unused_exports,\n+                    ))\n+                }\n                 ModulePart::Export(..) | ModulePart::Internal(..) => {\n                     bail!(\n                         \"Unexpected ModulePart \\\"{}\\\" for EcmascriptModulePartReference\",\n@@ -94,6 +109,7 @@ impl ModuleReference for EcmascriptModulePartReference {\n         } else {\n             ResolvedVc::upcast(self.module)\n         };\n+\n         Ok(*ModuleResolveResult::module(module))\n     }\n }\n@@ -107,6 +123,15 @@ impl ChunkableModuleReference for EcmascriptModulePartReference {\n             hoisted: true,\n         }))\n     }\n+\n+    #[turbo_tasks::function]\n+    fn export_usage(&self) -> Vc<ExportUsage> {\n+        match &self.part {\n+            Some(ModulePart::Export(export)) => ExportUsage::named(export.clone()),\n+            Some(ModulePart::Evaluation) => ExportUsage::evaluation(),\n+            _ => ExportUsage::all(),\n+        }\n+    }\n }\n \n impl EcmascriptModulePartReference {"
        },
        {
            "sha": "01d5323b7da1eaf6002a3fdc63b53933bb6f57f7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/simple_tree_shake/mod.rs",
            "status": "added",
            "additions": 100,
            "deletions": 0,
            "changes": 100,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fsimple_tree_shake%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fsimple_tree_shake%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fsimple_tree_shake%2Fmod.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,100 @@\n+//! Intermediate tree shaking that uses global information but not good as the full tree shaking.\n+\n+use anyhow::{Context, Result};\n+use auto_hash_map::AutoSet;\n+use rustc_hash::FxHashMap;\n+use turbo_rcstr::RcStr;\n+use turbo_tasks::{ResolvedVc, Vc};\n+use turbopack_core::{module_graph::ModuleGraph, resolve::ExportUsage};\n+\n+use crate::chunk::EcmascriptChunkPlaceable;\n+\n+#[turbo_tasks::function]\n+pub async fn get_module_export_usages(\n+    graph: ResolvedVc<ModuleGraph>,\n+    module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+) -> Result<Vc<ModuleExportUsageInfo>> {\n+    let export_usage_info = compute_export_usage_info(graph)\n+        .resolve_strongly_consistent()\n+        .await?;\n+\n+    let export_usage_info = export_usage_info.await?;\n+\n+    let Some(exports) = export_usage_info.used_exports.get(&module) else {\n+        // We exclude template files from tree shaking because they are entrypoints to the module\n+        // graph.\n+        return Ok(ModuleExportUsageInfo::All.cell());\n+    };\n+\n+    Ok(exports.clone().cell())\n+}\n+\n+#[turbo_tasks::function(operation)]\n+async fn compute_export_usage_info(graph: ResolvedVc<ModuleGraph>) -> Result<Vc<ExportUsageInfo>> {\n+    let mut used_exports = FxHashMap::<_, ModuleExportUsageInfo>::default();\n+\n+    graph\n+        .await?\n+        .traverse_all_edges_unordered(|(_, ref_data), target| {\n+            if let Some(target_module) =\n+                ResolvedVc::try_downcast::<Box<dyn EcmascriptChunkPlaceable>>(target.module)\n+            {\n+                let e = used_exports.entry(target_module).or_default();\n+\n+                e.add(&ref_data.export);\n+            }\n+\n+            Ok(())\n+        })\n+        .await\n+        .context(\"failed to traverse module graph\")?;\n+\n+    Ok(ExportUsageInfo { used_exports }.cell())\n+}\n+\n+#[turbo_tasks::value]\n+#[derive(Default)]\n+pub struct ExportUsageInfo {\n+    used_exports: FxHashMap<ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>, ModuleExportUsageInfo>,\n+}\n+\n+#[turbo_tasks::value]\n+#[derive(Default, Clone)]\n+pub enum ModuleExportUsageInfo {\n+    All,\n+    #[default]\n+    Evaluation,\n+    Exports(AutoSet<RcStr>),\n+}\n+\n+impl ModuleExportUsageInfo {\n+    fn add(&mut self, usage: &ExportUsage) {\n+        match (&mut *self, usage) {\n+            (Self::All, _) => {}\n+            (_, ExportUsage::All) => {\n+                *self = Self::All;\n+            }\n+            (Self::Evaluation, ExportUsage::Named(name)) => {\n+                // Promote evaluation to something more specific\n+                *self = Self::Exports(AutoSet::from_iter([name.clone()]));\n+            }\n+\n+            (Self::Exports(l), ExportUsage::Named(r)) => {\n+                // Merge exports\n+                l.insert(r.clone());\n+            }\n+\n+            (_, ExportUsage::Evaluation) => {\n+                // Ignore evaluation\n+            }\n+        }\n+    }\n+\n+    pub fn is_export_used(&self, export: &RcStr) -> bool {\n+        match self {\n+            Self::All => true,\n+            Self::Evaluation => false,\n+            Self::Exports(exports) => exports.contains(export),\n+        }\n+    }\n+}"
        },
        {
            "sha": "546416094465026d3b5db06e557e5570a71f2139",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/asset.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -10,7 +10,7 @@ use turbopack_core::{\n     module::Module,\n     module_graph::ModuleGraph,\n     reference::{ModuleReference, ModuleReferences, SingleChunkableModuleReference},\n-    resolve::{ModulePart, origin::ResolveOrigin},\n+    resolve::{ExportUsage, ModulePart, origin::ResolveOrigin},\n };\n \n use super::{\n@@ -27,6 +27,7 @@ use crate::{\n         FollowExportsResult, analyse_ecmascript_module, esm::FoundExportType, follow_reexports,\n     },\n     side_effect_optimization::facade::module::EcmascriptModuleFacadeModule,\n+    simple_tree_shake::get_module_export_usages,\n     tree_shake::{Key, side_effect_module::SideEffectsModule},\n };\n \n@@ -96,6 +97,16 @@ impl EcmascriptAnalyzable for EcmascriptModulePartAsset {\n             .reference_module_source_maps(Vc::upcast(self))\n             .await?;\n \n+        let export_usage_info = if module.full_module.options().await?.remove_unused_exports {\n+            Some(\n+                get_module_export_usages(*module_graph, Vc::upcast(*module.full_module))\n+                    .to_resolved()\n+                    .await?,\n+            )\n+        } else {\n+            None\n+        };\n+\n         Ok(EcmascriptModuleContentOptions {\n             parsed,\n             ident: self.ident().to_resolved().await?,\n@@ -111,6 +122,7 @@ impl EcmascriptAnalyzable for EcmascriptModulePartAsset {\n             original_source_map: analyze_ref.source_map,\n             exports: analyze_ref.exports,\n             async_module_info,\n+            export_usage_info,\n         }\n         .cell())\n     }\n@@ -203,6 +215,7 @@ impl EcmascriptModulePartAsset {\n                             EcmascriptModuleFacadeModule::new(\n                                 **final_module,\n                                 ModulePart::renamed_export(new_export.clone(), export.clone()),\n+                                module.options().await?.remove_unused_exports,\n                             )\n                             .to_resolved()\n                             .await?,\n@@ -213,6 +226,7 @@ impl EcmascriptModulePartAsset {\n                         EcmascriptModuleFacadeModule::new(\n                             **final_module,\n                             ModulePart::renamed_namespace(export.clone()),\n+                            module.options().await?.remove_unused_exports,\n                         )\n                         .to_resolved()\n                         .await?,\n@@ -322,12 +336,19 @@ impl Module for EcmascriptModulePartAsset {\n     #[turbo_tasks::function]\n     async fn references(&self) -> Result<Vc<ModuleReferences>> {\n         let part_dep = |part: ModulePart| -> Vc<Box<dyn ModuleReference>> {\n+            let export = match &part {\n+                ModulePart::Export(export) => ExportUsage::named(export.clone()),\n+                ModulePart::Evaluation => ExportUsage::evaluation(),\n+                _ => ExportUsage::all(),\n+            };\n+\n             Vc::upcast(SingleChunkableModuleReference::new(\n                 Vc::upcast(EcmascriptModulePartAsset::new_with_resolved_part(\n                     *self.full_module,\n                     part,\n                 )),\n                 rcstr!(\"part reference\"),\n+                export,\n             ))\n         };\n "
        },
        {
            "sha": "7b3f8050a3ca10444a0da75b2d94639c5db1ab25",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/side_effect_module.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fside_effect_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fside_effect_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fside_effect_module.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -9,7 +9,7 @@ use turbopack_core::{\n     module::Module,\n     module_graph::ModuleGraph,\n     reference::{ModuleReferences, SingleChunkableModuleReference},\n-    resolve::ModulePart,\n+    resolve::{ExportUsage, ModulePart},\n };\n \n use crate::{\n@@ -85,6 +85,7 @@ impl Module for SideEffectsModule {\n                         SingleChunkableModuleReference::new(\n                             *ResolvedVc::upcast(*side_effect),\n                             rcstr!(\"side effect\"),\n+                            ExportUsage::evaluation(),\n                         )\n                         .to_resolved()\n                         .await?,\n@@ -98,6 +99,7 @@ impl Module for SideEffectsModule {\n             SingleChunkableModuleReference::new(\n                 *ResolvedVc::upcast(self.resolved_as),\n                 rcstr!(\"resolved as\"),\n+                ExportUsage::all(),\n             )\n             .to_resolved()\n             .await?,"
        },
        {
            "sha": "79649b3e80d7c1cc7aec150b99260ee467f51327",
            "filename": "turbopack/crates/turbopack-resolve/src/ecmascript.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fecmascript.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fecmascript.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fecmascript.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -46,13 +46,12 @@ pub fn apply_esm_specific_options(\n     options: Vc<ResolveOptions>,\n     reference_type: ReferenceType,\n ) -> Vc<ResolveOptions> {\n-    apply_esm_specific_options_internal(\n-        options,\n-        matches!(\n-            reference_type,\n-            ReferenceType::EcmaScriptModules(EcmaScriptModulesReferenceSubType::ImportWithType(_))\n-        ),\n-    )\n+    let clear_extensions = matches!(\n+        reference_type,\n+        ReferenceType::EcmaScriptModules(EcmaScriptModulesReferenceSubType::ImportWithType(_))\n+    );\n+\n+    apply_esm_specific_options_internal(options, clear_extensions)\n }\n \n #[turbo_tasks::function]"
        },
        {
            "sha": "8025a491168f21c785fd1856a852c8d5f808fc51",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -241,6 +241,8 @@ async fn run_inner_operation(\n #[serde(rename_all = \"camelCase\", deny_unknown_fields)]\n struct TestOptions {\n     tree_shaking_mode: Option<TreeShakingMode>,\n+    #[serde(default)]\n+    remove_unused_exports: bool,\n }\n \n #[turbo_tasks::value]\n@@ -376,10 +378,12 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n                 ContextCondition::InDirectory(\"node_modules\".into()),\n                 ModuleOptionsContext {\n                     tree_shaking_mode: options.tree_shaking_mode,\n+                    remove_unused_exports: options.remove_unused_exports,\n                     ..Default::default()\n                 }\n                 .resolved_cell(),\n             )],\n+            remove_unused_exports: options.remove_unused_exports,\n             ..Default::default()\n         }\n         .into(),"
        },
        {
            "sha": "f3c631c05ffe4d26ef7938fdc0aa8ead2317df8e",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -96,6 +96,8 @@ struct SnapshotOptions {\n     environment: SnapshotEnvironment,\n     #[serde(default)]\n     tree_shaking_mode: Option<TreeShakingMode>,\n+    #[serde(default)]\n+    remove_unused_exports: bool,\n }\n \n #[derive(Debug, Deserialize, Default)]\n@@ -122,6 +124,7 @@ impl Default for SnapshotOptions {\n             runtime_type: default_runtime_type(),\n             environment: Default::default(),\n             tree_shaking_mode: Default::default(),\n+            remove_unused_exports: false,\n         }\n     }\n }\n@@ -305,6 +308,7 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n             rules: vec![(\n                 ContextCondition::InDirectory(\"node_modules\".into()),\n                 ModuleOptionsContext {\n+                    remove_unused_exports: options.remove_unused_exports,\n                     css: CssOptionsContext {\n                         ..Default::default()\n                     },\n@@ -314,6 +318,7 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n             )],\n             module_rules: vec![module_rules],\n             tree_shaking_mode: options.tree_shaking_mode,\n+            remove_unused_exports: options.remove_unused_exports,\n             ..Default::default()\n         }\n         .into(),"
        },
        {
            "sha": "f05c34ab0757adc068df084f5fe1a0286f89ee58",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/index.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Findex.js?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,3 @@\n+import { getCat } from 'lib'\n+\n+console.log(`I like ${getCat()}`)"
        },
        {
            "sha": "2a43af570307c467e411cfdb03e7237d17916a3b",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/node_modules/lib/index.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Fnode_modules%2Flib%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Fnode_modules%2Flib%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Fnode_modules%2Flib%2Findex.js?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,16 @@\n+\n+let cat = \"cat\";\n+let dog = \"dog\";\n+\n+export function getChimera() {\n+  return cat + dog;\n+}\n+\n+export function getCat() {\n+  return cat;\n+}\n+\n+export function getDog() {\n+  return dog;\n+}\n+"
        },
        {
            "sha": "1bb023b4fd36954da5d4022d03392e5eb0e14b61",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/node_modules/lib/package.json",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Fnode_modules%2Flib%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Fnode_modules%2Flib%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Finput%2Fnode_modules%2Flib%2Fpackage.json?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,3 @@\n+{\n+  \"sideEffects\": false\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "d999101a4811c7a3ac2b5874bdbe48f10f31951d",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/options.json",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foptions.json",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foptions.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foptions.json?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,4 @@\n+{\n+  \"treeShakingMode\": \"reexports-only\",\n+  \"removeUnusedExports\": true\n+}"
        },
        {
            "sha": "77b8d0cd17e72e8ef0a97d5638f93adfc27ae9c8",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/output/4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,31 @@\n+(globalThis.TURBOPACK = globalThis.TURBOPACK || []).push([\"output/4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js\", {\n+\n+\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/index.js [test] (ecmascript)\": ((__turbopack_context__) => {\n+\"use strict\";\n+\n+__turbopack_context__.s({});\n+var __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$intermediate$2d$tree$2d$shake$2f$tree$2d$shake$2d$test$2d$1$2f$input$2f$node_modules$2f$lib$2f$index$2e$js__$5b$test$5d$__$28$ecmascript$29$__ = __turbopack_context__.i(\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/node_modules/lib/index.js [test] (ecmascript)\");\n+;\n+console.log(`I like ${(0, __TURBOPACK__imported__module__$5b$project$5d2f$turbopack$2f$crates$2f$turbopack$2d$tests$2f$tests$2f$snapshot$2f$intermediate$2d$tree$2d$shake$2f$tree$2d$shake$2d$test$2d$1$2f$input$2f$node_modules$2f$lib$2f$index$2e$js__$5b$test$5d$__$28$ecmascript$29$__[\"getCat\"])()}`);\n+}),\n+\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/node_modules/lib/index.js [test] (ecmascript)\": ((__turbopack_context__) => {\n+\"use strict\";\n+\n+__turbopack_context__.s({\n+    \"getCat\": (()=>getCat)\n+});\n+let cat = \"cat\";\n+let dog = \"dog\";\n+function getChimera() {\n+    return cat + dog;\n+}\n+function getCat() {\n+    return cat;\n+}\n+function getDog() {\n+    return dog;\n+}\n+}),\n+}]);\n+\n+//# sourceMappingURL=4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js.map\n\\ No newline at end of file"
        },
        {
            "sha": "cf9eeed53a5a65e56deac2f8851c27d0916e9b36",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/output/4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js.map",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js.map?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,7 @@\n+{\n+  \"version\": 3,\n+  \"sources\": [],\n+  \"sections\": [\n+    {\"offset\": {\"line\": 5, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/index.js\"],\"sourcesContent\":[\"import { getCat } from 'lib'\\n\\nconsole.log(`I like ${getCat()}`)\\n\"],\"names\":[],\"mappings\":\";AAAA;;AAEA,QAAQ,GAAG,CAAC,CAAC,OAAO,EAAE,CAAA,GAAA,gQAAA,CAAA,SAAM,AAAD,KAAK\"}},\n+    {\"offset\": {\"line\": 13, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/node_modules/lib/index.js\"],\"sourcesContent\":[\"\\nlet cat = \\\"cat\\\";\\nlet dog = \\\"dog\\\";\\n\\nexport function getChimera() {\\n  return cat + dog;\\n}\\n\\nexport function getCat() {\\n  return cat;\\n}\\n\\nexport function getDog() {\\n  return dog;\\n}\\n\\n\"],\"names\":[],\"mappings\":\";;;AACA,IAAI,MAAM;AACV,IAAI,MAAM;AAEH,SAAS;IACd,OAAO,MAAM;AACf;AAEO,SAAS;IACd,OAAO;AACT;AAEO,SAAS;IACd,OAAO;AACT\",\"ignoreList\":[0]}}]\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "ca1e41a205d240e3ef456876c02ed3a3054fc028",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/output/4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,6 @@\n+(globalThis.TURBOPACK = globalThis.TURBOPACK || []).push([\n+    \"output/4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js\",\n+    {},\n+    {\"otherChunks\":[\"output/4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_80df1e23._.js\"],\"runtimeModuleIds\":[\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/input/index.js [test] (ecmascript)\"]}\n+]);\n+// Dummy runtime\n\\ No newline at end of file"
        },
        {
            "sha": "c15d7ec00382d3604310ddb8b53cbdb90d9e1942",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/intermediate-tree-shake/tree-shake-test-1/output/4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js.map",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fintermediate-tree-shake%2Ftree-shake-test-1%2Foutput%2F4c35f_tests_snapshot_intermediate-tree-shake_tree-shake-test-1_input_index_1ae89033.js.map?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -0,0 +1,5 @@\n+{\n+  \"version\": 3,\n+  \"sources\": [],\n+  \"sections\": []\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "1ff9886247b31fc0e629ebf78e7ce484de0475cc",
            "filename": "turbopack/crates/turbopack-wasm/src/module_asset.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -15,7 +15,7 @@ use turbopack_core::{\n     output::OutputAssets,\n     reference::{ModuleReferences, SingleChunkableModuleReference},\n     reference_type::ReferenceType,\n-    resolve::{origin::ResolveOrigin, parse::Request},\n+    resolve::{ExportUsage, origin::ResolveOrigin, parse::Request},\n     source::Source,\n };\n use turbopack_ecmascript::{\n@@ -108,9 +108,13 @@ impl WebAssemblyModuleAsset {\n     #[turbo_tasks::function]\n     async fn references(self: Vc<Self>) -> Result<Vc<ModuleReferences>> {\n         Ok(Vc::cell(vec![ResolvedVc::upcast(\n-            SingleChunkableModuleReference::new(Vc::upcast(self.loader()), rcstr!(\"wasm loader\"))\n-                .to_resolved()\n-                .await?,\n+            SingleChunkableModuleReference::new(\n+                Vc::upcast(self.loader()),\n+                rcstr!(\"wasm loader\"),\n+                ExportUsage::all(),\n+            )\n+            .to_resolved()\n+            .await?,\n         )]))\n     }\n }"
        },
        {
            "sha": "431557a7e2a3e927ba18f36f2856e4a680b6ef34",
            "filename": "turbopack/crates/turbopack/src/global_module_ids.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fglobal_module_ids.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fglobal_module_ids.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fglobal_module_ids.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -9,7 +9,7 @@ use turbopack_core::{\n     chunk::{ChunkableModule, ChunkingType, module_id_strategies::GlobalModuleIdStrategy},\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{ModuleGraph, RefData},\n };\n use turbopack_ecmascript::async_chunk::module::AsyncLoaderModule;\n \n@@ -32,7 +32,14 @@ pub async fn get_global_module_id_strategy(\n         let mut async_idents = vec![];\n         module_graph\n             .traverse_all_edges_unordered(|parent, current| {\n-                if let (_, &ChunkingType::Async) = parent {\n+                if let (\n+                    _,\n+                    &RefData {\n+                        chunking_type: ChunkingType::Async,\n+                        ..\n+                    },\n+                ) = parent\n+                {\n                     let module =\n                         ResolvedVc::try_sidecast::<Box<dyn ChunkableModule>>(current.module)\n                             .context(\"expected chunkable module for async reference\")?;"
        },
        {
            "sha": "7ebf4cfe3910260fc4397503443df6992b25818f",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -154,8 +154,8 @@ async fn apply_module_type(\n                     }\n                 }\n \n-                let options = options.await?;\n-                match options.tree_shaking_mode {\n+                let options_value = options.await?;\n+                match options_value.tree_shaking_mode {\n                     Some(TreeShakingMode::ModuleFragments) => {\n                         Vc::upcast(EcmascriptModulePartAsset::select_part(\n                             *module,\n@@ -170,6 +170,7 @@ async fn apply_module_type(\n                                         Vc::upcast(EcmascriptModuleFacadeModule::new(\n                                             Vc::upcast(*module),\n                                             part,\n+                                            options.await?.remove_unused_exports,\n                                         ))\n                                     } else {\n                                         Vc::upcast(*module)\n@@ -187,18 +188,21 @@ async fn apply_module_type(\n                                                 EcmascriptModuleFacadeModule::new(\n                                                     Vc::upcast(*module),\n                                                     ModulePart::exports(),\n+                                                    options.await?.remove_unused_exports,\n                                                 )\n                                                 .resolve()\n                                                 .await?,\n                                             ),\n                                             part,\n                                             side_effect_free_packages,\n+                                            options.await?.remove_unused_exports,\n                                         )\n                                     } else {\n                                         apply_reexport_tree_shaking(\n                                             Vc::upcast(*module),\n                                             part,\n                                             side_effect_free_packages,\n+                                            options.await?.remove_unused_exports,\n                                         )\n                                     }\n                                 }\n@@ -212,6 +216,7 @@ async fn apply_module_type(\n                             Vc::upcast(EcmascriptModuleFacadeModule::new(\n                                 Vc::upcast(*module),\n                                 ModulePart::facade(),\n+                                options.await?.remove_unused_exports,\n                             ))\n                         } else {\n                             Vc::upcast(*module)\n@@ -275,6 +280,7 @@ async fn apply_reexport_tree_shaking(\n     module: Vc<Box<dyn EcmascriptChunkPlaceable>>,\n     part: ModulePart,\n     side_effect_free_packages: Vc<Glob>,\n+    remove_unused_exports: bool,\n ) -> Result<Vc<Box<dyn Module>>> {\n     if let ModulePart::Export(export) = &part {\n         let FollowExportsResult {\n@@ -289,12 +295,14 @@ async fn apply_reexport_tree_shaking(\n                 Vc::upcast(EcmascriptModuleFacadeModule::new(\n                     **final_module,\n                     ModulePart::renamed_export(new_export.clone(), export.clone()),\n+                    remove_unused_exports,\n                 ))\n             }\n         } else {\n             Vc::upcast(EcmascriptModuleFacadeModule::new(\n                 **final_module,\n                 ModulePart::renamed_namespace(export.clone()),\n+                remove_unused_exports,\n             ))\n         };\n         return Ok(module);"
        },
        {
            "sha": "8d6f8005ee65da926b65f4b9c41ea93837786004",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -144,6 +144,7 @@ impl ModuleOptions {\n             execution_context,\n             tree_shaking_mode,\n             keep_last_successful_parse,\n+            remove_unused_exports,\n             ..\n         } = *module_options_context.await?;\n \n@@ -174,6 +175,7 @@ impl ModuleOptions {\n             refresh,\n             extract_source_map: matches!(ecmascript_source_maps, SourceMapsType::Full),\n             keep_last_successful_parse,\n+            remove_unused_exports,\n             ..Default::default()\n         };\n         let ecmascript_options_vc = ecmascript_options.resolved_cell();"
        },
        {
            "sha": "95d352ddb736522fcf692c31a187172fe54f5ec3",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8bcde6bf83fb7382d680525fece246f0b0d13fb/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=c8bcde6bf83fb7382d680525fece246f0b0d13fb",
            "patch": "@@ -169,6 +169,11 @@ pub struct ModuleOptionsContext {\n     /// A list of rules to use a different module option context for certain\n     /// context paths. The first matching is used.\n     pub rules: Vec<(ContextCondition, ResolvedVc<ModuleOptionsContext>)>,\n+\n+    /// `matches!(tree_shaking_mode, Some(TreeShakingMode::Intermediate))` is not enough because we\n+    /// use different tree shaking modes for user code and foreign code while intermediate tree\n+    /// shaking is a global option.\n+    pub remove_unused_exports: bool,\n     pub placeholder_for_future_extensions: (),\n }\n "
        }
    ],
    "stats": {
        "total": 769,
        "additions": 627,
        "deletions": 142
    }
}