{
    "author": "unstubbable",
    "message": "Introduce `'use cache: private'` (#81816)",
    "sha": "9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
    "files": [
        {
            "sha": "627443e51c6924d406f018bda3e4eceedab76ced",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -56,7 +56,12 @@ impl CacheKinds {\n \n impl Default for CacheKinds {\n     fn default() -> Self {\n-        CacheKinds([\"default\", \"remote\"].iter().map(|&s| s.into()).collect())\n+        CacheKinds(\n+            [\"default\", \"remote\", \"private\"]\n+                .iter()\n+                .map(|&s| s.into())\n+                .collect(),\n+        )\n     }\n }\n "
        },
        {
            "sha": "2951e118f075d9ec35ec4dfa0ebb81ec5fd8460a",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 22,
            "deletions": 1,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -731,5 +731,26 @@\n   \"730\": \"Dynamic imports should not be instrumented in the edge runtime, because `cacheComponents` doesn't support it\",\n   \"731\": \"chainStreams requires at least one stream\",\n   \"732\": \"dynamic responses cannot be unchunked. This is a bug in Next.js\",\n-  \"733\": \"null responses cannot be unchunked\"\n+  \"733\": \"null responses cannot be unchunked\",\n+  \"734\": \"createPrerenderParamsForClientSegment should not be called in cache contexts.\",\n+  \"735\": \"%s must not be used within \\\"use cache\\\". It can only be nested inside of another %s.\",\n+  \"736\": \"createParamsFromClient should not be called in cache contexts.\",\n+  \"737\": \"Unexpected work unit store.\",\n+  \"738\": \"createServerParamsForRoute should not be called in cache contexts.\",\n+  \"739\": \"createSearchParamsFromClient should not be called in cache contexts.\",\n+  \"740\": \"createServerPathnameForMetadata should not be called in cache contexts.\",\n+  \"741\": \"%s must not be used within a client component. Next.js should be preventing %s from being allowed in client components statically, but did not in this case.\",\n+  \"742\": \"Route %s used \\\"headers\\\" inside \\\"use cache: private\\\". Accessing \\\"headers\\\" inside a private cache scope is not supported. If you need this data inside a cached function use \\\"headers\\\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+  \"743\": \"createServerParamsForServerSegment should not be called in cache contexts.\",\n+  \"744\": \"%s must not be used within \\\\`unstable_cache()\\\\`.\",\n+  \"745\": \"\\\\`%s\\\\` was called inside a cache scope. Next.js should be preventing %s from being included in server components statically, but did not in this case.\",\n+  \"746\": \"createPrerenderSearchParamsForClientPage should not be called in cache contexts.\",\n+  \"747\": \"createServerSearchParamsForServerPage should not be called in cache contexts.\",\n+  \"748\": \"cacheLifeProfiles should always be provided.\",\n+  \"749\": \"A private cache entry must not be retrieved from the cache handler.\",\n+  \"750\": \"A default cacheLife profile must always be provided.\",\n+  \"751\": \"%s cannot not be used outside of a request context.\",\n+  \"752\": \"Route %s used \\\"connection\\\" inside \\\"use cache\\\". The \\\\`connection()\\\\` function is used to indicate the subsequent code must only run when there is an actual request, but caches must be able to be produced before a request, so this function is not allowed in this scope. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+  \"753\": \"Route %s used \\\"connection\\\" inside \\\"use cache: private\\\". The \\\\`connection()\\\\` function is used to indicate the subsequent code must only run when there is an actual navigation request, but caches must be able to be produced before a navigation request, so this function is not allowed in this scope. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+  \"754\": \"%s cannot be used outside of a request context.\"\n }"
        },
        {
            "sha": "bad8c74ef67198f504d304c05d81c6f97615a521",
            "filename": "packages/next/src/build/swc/options.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -228,7 +228,7 @@ function getBaseSWCOptions({\n             isDevelopment: development,\n             useCacheEnabled,\n             hashSalt: serverReferenceHashSalt,\n-            cacheKinds: ['default', 'remote'].concat(\n+            cacheKinds: ['default', 'remote', 'private'].concat(\n               cacheHandlers ? Object.keys(cacheHandlers) : []\n             ),\n           }"
        },
        {
            "sha": "eadd2e66a275e04f42dd972a2d93b99034bfae38",
            "filename": "packages/next/src/client/components/bailout-to-client-rendering.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fbailout-to-client-rendering.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -18,6 +18,7 @@ export function bailoutToClientRendering(reason: string): void | never {\n         throw new BailoutToCSRError(reason)\n       case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n         break\n       default:"
        },
        {
            "sha": "982bcbd8d8df23318963e91c85bddb52b9a20a43",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -1242,6 +1242,7 @@ async function renderToHTMLOrFlightImpl(\n         case 'prerender':\n         case 'prerender-client':\n         case 'cache':\n+        case 'private-cache':\n           return true\n         case 'prerender-ppr':\n         case 'prerender-legacy':\n@@ -1656,7 +1657,10 @@ async function renderToHTMLOrFlightImpl(\n       metadata\n     )\n \n-    if (workStore.invalidDynamicUsageError) {\n+    // Invalid dynamic usages should only error the request in development.\n+    // In production, it's better to produce a result.\n+    // (the dynamic error will still be thrown inside the component tree, but it's catchable by error boundaries)\n+    if (workStore.invalidDynamicUsageError && workStore.dev) {\n       throw workStore.invalidDynamicUsageError\n     }\n \n@@ -2448,11 +2452,12 @@ async function spawnDynamicValidationInDev(\n \n   // We don't need to continue the prerender process if we already\n   // detected invalid dynamic usage in the initial prerender phase.\n-  if (workStore.invalidDynamicUsageError) {\n+  const { invalidDynamicUsageError } = workStore\n+  if (invalidDynamicUsageError) {\n     resolveValidation(\n       <LogSafely\n         fn={() => {\n-          console.error(workStore.invalidDynamicUsageError)\n+          console.error(invalidDynamicUsageError)\n         }}\n       />\n     )"
        },
        {
            "sha": "00072027cf60f255df63dea3c4a11e5cda7e0501",
            "filename": "packages/next/src/server/app-render/create-component-tree.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcreate-component-tree.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -297,13 +297,17 @@ async function createComponentTreeInternal({\n         case 'prerender':\n         case 'prerender-legacy':\n         case 'prerender-ppr':\n-        case 'cache':\n           if (workUnitStore.revalidate > defaultRevalidate) {\n             workUnitStore.revalidate = defaultRevalidate\n           }\n           break\n-        case 'prerender-client':\n         case 'request':\n+          // A request store doesn't have a revalidate property.\n+          break\n+        // createComponentTree is not called for these stores:\n+        case 'cache':\n+        case 'private-cache':\n+        case 'prerender-client':\n         case 'unstable-cache':\n           break\n         default:\n@@ -766,13 +770,6 @@ async function createComponentTreeInternal({\n         const UseCachePageComponent: React.ComponentType<UseCachePageComponentProps> =\n           PageComponent\n \n-        if (!experimental.cacheComponents) {\n-          // The \"use cache\" wrapper takes care of converting this into an\n-          // erroring search params promise when passing it to the original\n-          // function.\n-          searchParams = Promise.resolve({})\n-        }\n-\n         pageElement = (\n           <UseCachePageComponent\n             params={params}"
        },
        {
            "sha": "75239c24c9e9d1494d6162ba09f5aa9be3acd165",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -43,6 +43,7 @@ import {\n } from '../../lib/metadata/metadata-constants'\n import { scheduleOnNextTick } from '../../lib/scheduler'\n import { BailoutToCSRError } from '../../shared/lib/lazy-dynamic/bailout-to-csr'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n \n const hasPostpone = typeof React.unstable_postpone === 'function'\n \n@@ -131,6 +132,9 @@ export function markCurrentScopeAsDynamic(\n         // subtly different from reading a dynamic data source, which is\n         // forbidden inside a cache scope.\n         return\n+      case 'private-cache':\n+        // A private cache scope is already dynamic by definition.\n+        return\n       case 'prerender-legacy':\n       case 'prerender-ppr':\n       case 'request':\n@@ -222,6 +226,9 @@ export function trackDynamicDataInDynamicRender(workUnitStore: WorkUnitStore) {\n       // subtly different from reading a dynamic data source, which is\n       // forbidden inside a cache scope.\n       return\n+    case 'private-cache':\n+      // A private cache scope is already dynamic by definition.\n+      return\n     case 'prerender':\n     case 'prerender-legacy':\n     case 'prerender-ppr':\n@@ -537,6 +544,7 @@ export function createHangingInputAbortSignal(\n     case 'prerender-legacy':\n     case 'request':\n     case 'cache':\n+    case 'private-cache':\n     case 'unstable-cache':\n       return undefined\n     default:\n@@ -573,13 +581,13 @@ export function useDynamicRouteParams(expression: string) {\n     const workUnitStore = workUnitAsyncStorage.getStore()\n     if (workUnitStore) {\n       switch (workUnitStore.type) {\n+        case 'prerender':\n         case 'prerender-client':\n           // We are in a prerender with cacheComponents semantics. We are going to\n           // hang here and never resolve. This will cause the currently\n           // rendering component to effectively be a dynamic hole.\n           React.use(makeHangingPromise(workUnitStore.renderSignal, expression))\n           break\n-        case 'prerender':\n         case 'prerender-ppr':\n           return postponeWithTracking(\n             workStore.route,\n@@ -592,8 +600,12 @@ export function useDynamicRouteParams(expression: string) {\n             workStore,\n             workUnitStore\n           )\n-        case 'request':\n         case 'cache':\n+        case 'private-cache':\n+          throw new InvariantError(\n+            `\\`${expression}\\` was called inside a cache scope. Next.js should be preventing ${expression} from being included in server components statically, but did not in this case.`\n+          )\n+        case 'request':\n         case 'unstable-cache':\n           break\n         default:"
        },
        {
            "sha": "30321e057d56906dc5f3d8f326843d48247c638d",
            "filename": "packages/next/src/server/app-render/encryption.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fencryption.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -272,6 +272,7 @@ export async function decryptActionBoundArgs(\n           case 'prerender-legacy':\n           case 'request':\n           case 'cache':\n+          case 'private-cache':\n           case 'unstable-cache':\n           case undefined:\n             return controller.close()"
        },
        {
            "sha": "60ec89e947de7ee7ba8afacf5bb795b7c43193d1",
            "filename": "packages/next/src/server/app-render/use-flight-response.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fuse-flight-response.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -68,6 +68,7 @@ export function useFlightStream<T>(\n       case 'prerender-legacy':\n       case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n         break\n       default:"
        },
        {
            "sha": "2f64cb1b3160b1692bd7e640aa3f5f4cc754e43c",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 47,
            "deletions": 34,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -27,7 +27,7 @@ export interface CommonWorkUnitStore {\n }\n \n export interface RequestStore extends CommonWorkUnitStore {\n-  type: 'request'\n+  readonly type: 'request'\n \n   /**\n    * The URL of the request. This only specifies the pathname and the search\n@@ -82,15 +82,25 @@ export type PrerenderStoreModern =\n   | PrerenderStoreModernClient\n   | PrerenderStoreModernServer\n \n-interface PrerenderStoreModernClient extends PrerenderStoreModernCommon {\n-  type: 'prerender-client'\n+export interface PrerenderStoreModernClient extends PrerenderStoreModernCommon {\n+  readonly type: 'prerender-client'\n }\n \n-interface PrerenderStoreModernServer extends PrerenderStoreModernCommon {\n-  type: 'prerender'\n+export interface PrerenderStoreModernServer extends PrerenderStoreModernCommon {\n+  readonly type: 'prerender'\n }\n \n-interface PrerenderStoreModernCommon extends CommonWorkUnitStore {\n+export interface RevalidateStore {\n+  // Collected revalidate times and tags for this document during the prerender.\n+  revalidate: number // in seconds. 0 means dynamic. INFINITE_CACHE and higher means never revalidate.\n+  expire: number // server expiration time\n+  stale: number // client expiration time\n+  tags: null | string[]\n+}\n+\n+interface PrerenderStoreModernCommon\n+  extends CommonWorkUnitStore,\n+    RevalidateStore {\n   /**\n    * The render signal is aborted after React's `prerender` function is aborted\n    * (using a separate signal), which happens in two cases:\n@@ -136,12 +146,6 @@ interface PrerenderStoreModernCommon extends CommonWorkUnitStore {\n    */\n   readonly allowEmptyStaticShell: boolean\n \n-  // Collected revalidate times and tags for this document during the prerender.\n-  revalidate: number // in seconds. 0 means dynamic. INFINITE_CACHE and higher means never revalidate.\n-  expire: number // server expiration time\n-  stale: number // client expiration time\n-  tags: null | string[]\n-\n   /**\n    * A mutable resume data cache for this prerender.\n    */\n@@ -168,30 +172,24 @@ interface PrerenderStoreModernCommon extends CommonWorkUnitStore {\n   readonly captureOwnerStack: undefined | (() => string | null)\n }\n \n-export interface PrerenderStorePPR extends CommonWorkUnitStore {\n-  type: 'prerender-ppr'\n+export interface PrerenderStorePPR\n+  extends CommonWorkUnitStore,\n+    RevalidateStore {\n+  readonly type: 'prerender-ppr'\n   readonly rootParams: Params\n   readonly dynamicTracking: null | DynamicTrackingState\n-  // Collected revalidate times and tags for this document during the prerender.\n-  revalidate: number // in seconds. 0 means dynamic. INFINITE_CACHE and higher means never revalidate.\n-  expire: number // server expiration time\n-  stale: number // client expiration time\n-  tags: null | string[]\n \n   /**\n    * The resume data cache for this prerender.\n    */\n   prerenderResumeDataCache: PrerenderResumeDataCache\n }\n \n-export interface PrerenderStoreLegacy extends CommonWorkUnitStore {\n-  type: 'prerender-legacy'\n+export interface PrerenderStoreLegacy\n+  extends CommonWorkUnitStore,\n+    RevalidateStore {\n+  readonly type: 'prerender-legacy'\n   readonly rootParams: Params\n-  // Collected revalidate times and tags for this document during the prerender.\n-  revalidate: number // in seconds. 0 means dynamic. INFINITE_CACHE and higher means never revalidate.\n-  expire: number // server expiration time\n-  stale: number // client expiration time\n-  tags: null | string[]\n }\n \n export type PrerenderStore =\n@@ -213,24 +211,34 @@ export interface CommonCacheStore\n   readonly draftMode: DraftModeProvider | undefined\n }\n \n-export interface UseCacheStore extends CommonCacheStore {\n-  type: 'cache'\n-  // Collected revalidate times and tags for this cache entry during the cache render.\n-  revalidate: number // implicit revalidate time from inner caches / fetches\n-  expire: number // server expiration time\n-  stale: number // client expiration time\n+export interface CommonUseCacheStore extends CommonCacheStore, RevalidateStore {\n   explicitRevalidate: undefined | number // explicit revalidate time from cacheLife() calls\n   explicitExpire: undefined | number // server expiration time\n   explicitStale: undefined | number // client expiration time\n-  tags: null | string[]\n   readonly hmrRefreshHash: string | undefined\n   readonly isHmrRefresh: boolean\n   readonly serverComponentsHmrCache: ServerComponentsHmrCache | undefined\n   readonly forceRevalidate: boolean\n }\n \n+export interface PublicUseCacheStore extends CommonUseCacheStore {\n+  readonly type: 'cache'\n+}\n+\n+export interface PrivateUseCacheStore extends CommonUseCacheStore {\n+  readonly type: 'private-cache'\n+\n+  /**\n+   * As opposed to the public cache store, the private cache store is allowed to\n+   * access the request cookies.\n+   */\n+  readonly cookies: ReadonlyRequestCookies\n+}\n+\n+export type UseCacheStore = PublicUseCacheStore | PrivateUseCacheStore\n+\n export interface UnstableCacheStore extends CommonCacheStore {\n-  type: 'unstable-cache'\n+  readonly type: 'unstable-cache'\n }\n \n /**\n@@ -270,6 +278,7 @@ export function getPrerenderResumeDataCache(\n     case 'prerender-legacy':\n     case 'request':\n     case 'cache':\n+    case 'private-cache':\n     case 'unstable-cache':\n       return null\n     default:\n@@ -296,6 +305,7 @@ export function getRenderResumeDataCache(\n       // version of the cache as it can also be used for reading.\n       return workUnitStore.prerenderResumeDataCache\n     case 'cache':\n+    case 'private-cache':\n     case 'unstable-cache':\n     case 'prerender-legacy':\n       return null\n@@ -311,6 +321,7 @@ export function getHmrRefreshHash(\n   if (workStore.dev) {\n     switch (workUnitStore.type) {\n       case 'cache':\n+      case 'private-cache':\n       case 'prerender':\n         return workUnitStore.hmrRefreshHash\n       case 'request':\n@@ -338,6 +349,7 @@ export function getDraftModeProviderForCacheScope(\n   if (workStore.isDraftMode) {\n     switch (workUnitStore.type) {\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n       case 'request':\n         return workUnitStore.draftMode\n@@ -365,6 +377,7 @@ export function getCacheSignal(\n     case 'prerender-legacy':\n     case 'request':\n     case 'cache':\n+    case 'private-cache':\n     case 'unstable-cache':\n       return null\n     default:"
        },
        {
            "sha": "73eb1d264ca1344b4b85d906a20e3d17f6eaaf58",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -975,7 +975,13 @@ function assignDefaults(\n     const invalidHandlerItems: Array<{ key: string; reason: string }> = []\n \n     for (const key of handlerKeys) {\n-      if (!allowedHandlerNameRegex.test(key)) {\n+      if (key === 'private') {\n+        invalidHandlerItems.push({\n+          key,\n+          reason:\n+            'The cache handler for \"use cache: private\" cannot be customized.',\n+        })\n+      } else if (!allowedHandlerNameRegex.test(key)) {\n         invalidHandlerItems.push({\n           key,\n           reason: 'key must only use characters a-z and -',"
        },
        {
            "sha": "9324228b0d73b57c2391df02608edb437f8049c7",
            "filename": "packages/next/src/server/lib/patch-fetch.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -17,8 +17,8 @@ import type { FetchMetric } from '../base-http'\n import { createDedupeFetch } from './dedupe-fetch'\n import {\n   getCacheSignal,\n+  type RevalidateStore,\n   type WorkUnitAsyncStorage,\n-  type WorkUnitStore,\n } from '../app-render/work-unit-async-storage.external'\n import {\n   CachedRouteKind,\n@@ -365,7 +365,7 @@ export function createPatchedFetcher(\n           `fetch ${input.toString()}`\n         )\n \n-        let revalidateStore: Extract<WorkUnitStore, { tags: any }> | undefined\n+        let revalidateStore: RevalidateStore | undefined\n \n         if (workUnitStore) {\n           switch (workUnitStore.type) {\n@@ -375,6 +375,7 @@ export function createPatchedFetcher(\n             case 'prerender-ppr':\n             case 'prerender-legacy':\n             case 'cache':\n+            case 'private-cache':\n               revalidateStore = workUnitStore\n               break\n             case 'request':\n@@ -415,6 +416,7 @@ export function createPatchedFetcher(\n             case 'prerender-legacy':\n             case 'request':\n             case 'cache':\n+            case 'private-cache':\n               break\n             default:\n               workUnitStore satisfies never\n@@ -567,6 +569,7 @@ export function createPatchedFetcher(\n             case 'prerender-legacy':\n             case 'request':\n             case 'cache':\n+            case 'private-cache':\n             case 'unstable-cache':\n               break\n             default:\n@@ -677,6 +680,7 @@ export function createPatchedFetcher(\n                 case 'prerender-legacy':\n                 case 'request':\n                 case 'cache':\n+                case 'private-cache':\n                 case 'unstable-cache':\n                   break\n                 default:\n@@ -711,6 +715,7 @@ export function createPatchedFetcher(\n           switch (workUnitStore.type) {\n             case 'request':\n             case 'cache':\n+            case 'private-cache':\n               isHmrRefresh = workUnitStore.isHmrRefresh ?? false\n               serverComponentsHmrCache = workUnitStore.serverComponentsHmrCache\n               break\n@@ -847,6 +852,7 @@ export function createPatchedFetcher(\n                   case 'prerender-legacy':\n                   case 'request':\n                   case 'cache':\n+                  case 'private-cache':\n                   case 'unstable-cache':\n                   case undefined:\n                     return createCachedDynamicResponse(\n@@ -917,6 +923,7 @@ export function createPatchedFetcher(\n                 case 'prerender-legacy':\n                 case 'request':\n                 case 'cache':\n+                case 'private-cache':\n                 case 'unstable-cache':\n                   break\n                 default:\n@@ -1018,6 +1025,7 @@ export function createPatchedFetcher(\n                 case 'prerender-legacy':\n                 case 'request':\n                 case 'cache':\n+                case 'private-cache':\n                 case 'unstable-cache':\n                   break\n                 default:\n@@ -1050,6 +1058,7 @@ export function createPatchedFetcher(\n                     )\n                   case 'request':\n                   case 'cache':\n+                  case 'private-cache':\n                   case 'unstable-cache':\n                   case 'prerender-legacy':\n                   case 'prerender-ppr':"
        },
        {
            "sha": "31a0e165c4cbb9902c4adb5c155c8a78d525d8b5",
            "filename": "packages/next/src/server/node-environment-extensions/console-dev.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dev.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -147,6 +147,7 @@ function patchConsoleMethodDEV(methodName: InterceptableConsoleMethod): void {\n         case 'prerender-legacy':\n         case 'request':\n         case 'cache':\n+        case 'private-cache':\n         case 'unstable-cache':\n         case undefined:\n           originalMethod.apply(this, args)"
        },
        {
            "sha": "f45ada37b6767b7420ef5b6ef3e2d8993442bde7",
            "filename": "packages/next/src/server/node-environment-extensions/utils.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -92,6 +92,7 @@ export function io(expression: string, type: ApiType) {\n     case 'prerender-ppr':\n     case 'prerender-legacy':\n     case 'cache':\n+    case 'private-cache':\n     case 'unstable-cache':\n       break\n     default:"
        },
        {
            "sha": "37f8be43586079c6dd6f134d452089e446b45223",
            "filename": "packages/next/src/server/request/connection.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 3,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -43,10 +43,25 @@ export function connection(): Promise<void> {\n \n     if (workUnitStore) {\n       switch (workUnitStore.type) {\n-        case 'cache':\n-          throw new Error(\n-            `Route ${workStore.route} used \"connection\" inside \"use cache\". The \\`connection()\\` function is used to indicate the subsequent code must only run when there is an actual Request, but caches must be able to be produced before a Request so this function is not allowed in this scope. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n+        case 'cache': {\n+          const error = new Error(\n+            `Route ${workStore.route} used \"connection\" inside \"use cache\". The \\`connection()\\` function is used to indicate the subsequent code must only run when there is an actual request, but caches must be able to be produced before a request, so this function is not allowed in this scope. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n+          )\n+          Error.captureStackTrace(error, connection)\n+          workStore.invalidDynamicUsageError ??= error\n+          throw error\n+        }\n+        case 'private-cache': {\n+          // It might not be intuitive to throw for private caches as well, but\n+          // we don't consider dynamic prefetches as \"actual requests\" (in the\n+          // navigation sense), despite allowing them to read cookies.\n+          const error = new Error(\n+            `Route ${workStore.route} used \"connection\" inside \"use cache: private\". The \\`connection()\\` function is used to indicate the subsequent code must only run when there is an actual navigation request, but caches must be able to be produced before a navigation request, so this function is not allowed in this scope. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n           )\n+          Error.captureStackTrace(error, connection)\n+          workStore.invalidDynamicUsageError ??= error\n+          throw error\n+        }\n         case 'unstable-cache':\n           throw new Error(\n             `Route ${workStore.route} used \"connection\" inside a function cached with \"unstable_cache(...)\". The \\`connection()\\` function is used to indicate the subsequent code must only run when there is an actual Request, but caches must be able to be produced before a Request so this function is not allowed in this scope. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`"
        },
        {
            "sha": "826c143f672c937c604a078dc1005079387c622d",
            "filename": "packages/next/src/server/request/cookies.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -114,6 +114,8 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n             workStore,\n             workUnitStore\n           )\n+        case 'private-cache':\n+          return makeUntrackedExoticCookies(workUnitStore.cookies)\n         case 'request':\n           trackDynamicDataInDynamicRender(workUnitStore)\n \n@@ -146,7 +148,6 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n           } else {\n             return makeUntrackedExoticCookies(underlyingCookies)\n           }\n-          break\n         default:\n           workUnitStore satisfies never\n       }\n@@ -472,6 +473,7 @@ function syncIODev(route: string | undefined, expression: string) {\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n         break\n       default:"
        },
        {
            "sha": "52026725916106906b6ce26271c0a4480d2ed582",
            "filename": "packages/next/src/server/request/draft-mode.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -59,6 +59,7 @@ export function draftMode(): Promise<DraftMode> {\n       return createOrGetCachedDraftMode(workUnitStore.draftMode, workStore)\n \n     case 'cache':\n+    case 'private-cache':\n     case 'unstable-cache':\n       // Inside of `\"use cache\"` or `unstable_cache`, draft mode is available if\n       // the outmost work unit store is a request store, and if draft mode is\n@@ -259,6 +260,7 @@ function syncIODev(route: string | undefined, expression: string) {\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n         break\n       default:\n@@ -307,7 +309,8 @@ function trackDynamicDraftMode(expression: string, constructorOpt: Function) {\n \n     if (workUnitStore) {\n       switch (workUnitStore.type) {\n-        case 'cache': {\n+        case 'cache':\n+        case 'private-cache': {\n           const error = new Error(\n             `Route ${workStore.route} used \"${expression}\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n           )"
        },
        {
            "sha": "c7dafb6d21acc70ff720fd1c92b39fcb2f0e9242",
            "filename": "packages/next/src/server/request/headers.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -79,13 +79,22 @@ export function headers(): Promise<ReadonlyHeaders> {\n \n     if (workUnitStore) {\n       switch (workUnitStore.type) {\n-        case 'cache':\n+        case 'cache': {\n           const error = new Error(\n             `Route ${workStore.route} used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n           )\n           Error.captureStackTrace(error, headers)\n           workStore.invalidDynamicUsageError ??= error\n           throw error\n+        }\n+        case 'private-cache': {\n+          const error = new Error(\n+            `Route ${workStore.route} used \"headers\" inside \"use cache: private\". Accessing \"headers\" inside a private cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n+          )\n+          Error.captureStackTrace(error, headers)\n+          workStore.invalidDynamicUsageError ??= error\n+          throw error\n+        }\n         case 'unstable-cache':\n           throw new Error(\n             `Route ${workStore.route} used \"headers\" inside a function cached with \"unstable_cache(...)\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`\n@@ -427,6 +436,7 @@ function syncIODev(route: string | undefined, expression: string) {\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n         break\n       default:"
        },
        {
            "sha": "a1438553b469e81cca4962695a38018d2c897b6c",
            "filename": "packages/next/src/server/request/params.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 5,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -68,9 +68,13 @@ export function createParamsFromClient(\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n-      case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n+        throw new InvariantError(\n+          'createParamsFromClient should not be called in cache contexts.'\n+        )\n+      case 'request':\n         break\n       default:\n         workUnitStore satisfies never\n@@ -96,9 +100,13 @@ export function createServerParamsForRoute(\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n-      case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n+        throw new InvariantError(\n+          'createServerParamsForRoute should not be called in cache contexts.'\n+        )\n+      case 'request':\n         break\n       default:\n         workUnitStore satisfies never\n@@ -119,9 +127,13 @@ export function createServerParamsForServerSegment(\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n-      case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n+        throw new InvariantError(\n+          'createServerParamsForServerSegment should not be called in cache contexts.'\n+        )\n+      case 'request':\n         break\n       default:\n         workUnitStore satisfies never\n@@ -152,11 +164,15 @@ export function createPrerenderParamsForClientSegment(\n           }\n         }\n         break\n+      case 'cache':\n+      case 'private-cache':\n+      case 'unstable-cache':\n+        throw new InvariantError(\n+          'createPrerenderParamsForClientSegment should not be called in cache contexts.'\n+        )\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n       case 'request':\n-      case 'cache':\n-      case 'unstable-cache':\n         break\n       default:\n         workUnitStore satisfies never\n@@ -555,6 +571,7 @@ function syncIODev(\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n         break\n       default:"
        },
        {
            "sha": "617b53118fd6b3bc28e903cf0328cbf43a42832a",
            "filename": "packages/next/src/server/request/pathname.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -29,9 +29,13 @@ export function createServerPathnameForMetadata(\n           workUnitStore\n         )\n       }\n-      case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n+        throw new InvariantError(\n+          'createServerPathnameForMetadata should not be called in cache contexts.'\n+        )\n+      case 'request':\n         break\n       default:\n         workUnitStore satisfies never"
        },
        {
            "sha": "859392b66118ccab3320ea686ddbf82d1ebe93ff",
            "filename": "packages/next/src/server/request/root-params.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Froot-params.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -39,8 +39,9 @@ export async function unstable_rootParams(): Promise<Params> {\n   }\n \n   switch (workUnitStore.type) {\n-    case 'unstable-cache':\n-    case 'cache': {\n+    case 'cache':\n+    case 'private-cache':\n+    case 'unstable-cache': {\n       throw new Error(\n         `Route ${workStore.route} used \\`unstable_rootParams()\\` inside \\`\"use cache\"\\` or \\`unstable_cache\\`. Support for this API inside cache scopes is planned for a future version of Next.js.`\n       )"
        },
        {
            "sha": "33eec43be6fb54b8864313615e8b9659f2193e67",
            "filename": "packages/next/src/server/request/search-params.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -72,9 +72,13 @@ export function createSearchParamsFromClient(\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderSearchParams(workStore, workUnitStore)\n-      case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n+        throw new InvariantError(\n+          'createSearchParamsFromClient should not be called in cache contexts.'\n+        )\n+      case 'request':\n         break\n       default:\n         workUnitStore satisfies never\n@@ -99,9 +103,13 @@ export function createServerSearchParamsForServerPage(\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n         return createPrerenderSearchParams(workStore, workUnitStore)\n-      case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n+        throw new InvariantError(\n+          'createServerSearchParamsForServerPage should not be called in cache contexts.'\n+        )\n+      case 'request':\n         break\n       default:\n         workUnitStore satisfies never\n@@ -127,11 +135,15 @@ export function createPrerenderSearchParamsForClientPage(\n         // We're prerendering in a mode that aborts (cacheComponents) and should stall\n         // the promise to ensure the RSC side is considered dynamic\n         return makeHangingPromise(workUnitStore.renderSignal, '`searchParams`')\n+      case 'cache':\n+      case 'private-cache':\n+      case 'unstable-cache':\n+        throw new InvariantError(\n+          'createPrerenderSearchParamsForClientPage should not be called in cache contexts.'\n+        )\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n       case 'request':\n-      case 'cache':\n-      case 'unstable-cache':\n         break\n       default:\n         workUnitStore satisfies never\n@@ -794,6 +806,7 @@ function syncIODev(\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n         break\n       default:"
        },
        {
            "sha": "51c6f53d6344ffe692fedc913c0bf441ce01631a",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -1165,6 +1165,9 @@ function trackDynamic(\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'cache':\n+      case 'private-cache':\n+        // TODO: Should we allow reading cookies and search params from the\n+        // request for private caches in route handlers?\n         throw new Error(\n           `Route ${store.route} used \"${expression}\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"${expression}\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n         )"
        },
        {
            "sha": "d07fd792e3f6dd62788cf346b7318de225933edd",
            "filename": "packages/next/src/server/use-cache/cache-life.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fcache-life.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fcache-life.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fcache-life.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -105,6 +105,7 @@ export function cacheLife(profile: CacheLifeProfiles | CacheLife): void {\n         'cacheLife() can only be called inside a \"use cache\" function.'\n       )\n     case 'cache':\n+    case 'private-cache':\n       break\n     default:\n       workUnitStore satisfies never"
        },
        {
            "sha": "7932a2dc4eb13d4382b81d111edb45332916f02c",
            "filename": "packages/next/src/server/use-cache/cache-tag.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fcache-tag.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fcache-tag.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fcache-tag.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -22,6 +22,7 @@ export function cacheTag(...tags: string[]): void {\n         'cacheTag() can only be called inside a \"use cache\" function.'\n       )\n     case 'cache':\n+    case 'private-cache':\n       break\n     default:\n       workUnitStore satisfies never"
        },
        {
            "sha": "a5be3cd9cdbf9e9b55e367f0b7beea8140084f2f",
            "filename": "packages/next/src/server/use-cache/constants.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fconstants.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -1,2 +1,2 @@\n-// If the expire time is less than .\n-export const DYNAMIC_EXPIRE = 300\n+export const DYNAMIC_EXPIRE = 300 // 5 minutes\n+export const DYNAMIC_PREFETCH_DYNAMIC_STALE = 30 // 30 seconds"
        },
        {
            "sha": "bcc83ad48e6cc1177fba4b850006d78ca407a46e",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 430,
            "deletions": 168,
            "changes": 598,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -17,7 +17,10 @@ import { unstable_prerender as prerender } from 'react-server-dom-webpack/static\n import type { WorkStore } from '../app-render/work-async-storage.external'\n import { workAsyncStorage } from '../app-render/work-async-storage.external'\n import type {\n+  PrerenderStoreModernClient,\n+  PrivateUseCacheStore,\n   RequestStore,\n+  RevalidateStore,\n   UseCacheStore,\n   WorkUnitStore,\n } from '../app-render/work-unit-async-storage.external'\n@@ -43,10 +46,14 @@ import type { CacheSignal } from '../app-render/cache-signal'\n import { decryptActionBoundArgs } from '../app-render/encryption'\n import { InvariantError } from '../../shared/lib/invariant-error'\n import { getDigestForWellKnownError } from '../app-render/create-error-handler'\n-import { DYNAMIC_EXPIRE } from './constants'\n+import { DYNAMIC_EXPIRE, DYNAMIC_PREFETCH_DYNAMIC_STALE } from './constants'\n import { getCacheHandler } from './handlers'\n import { UseCacheTimeoutError } from './use-cache-errors'\n-import { createHangingInputAbortSignal } from '../app-render/dynamic-rendering'\n+import {\n+  createHangingInputAbortSignal,\n+  postponeWithTracking,\n+  throwToInterruptStaticGeneration,\n+} from '../app-render/dynamic-rendering'\n import {\n   makeErroringExoticSearchParamsForUseCache,\n   type SearchParams,\n@@ -56,6 +63,23 @@ import React from 'react'\n import { createLazyResult, isResolvedLazyResult } from '../lib/lazy-result'\n import { dynamicAccessAsyncStorage } from '../app-render/dynamic-access-async-storage.external'\n import { isReactLargeShellError } from '../app-render/react-large-shell-error'\n+import type { CacheLife } from './cache-life'\n+\n+interface PrivateCacheContext {\n+  readonly kind: 'private'\n+  // TODO: Add dynamic prefetching store when this exists.\n+  readonly outerWorkUnitStore: RequestStore | PrivateUseCacheStore\n+}\n+\n+interface PublicCacheContext {\n+  readonly kind: 'public'\n+  // TODO: We should probably forbid nesting \"use cache\" inside unstable_cache.\n+  readonly outerWorkUnitStore:\n+    | Exclude<WorkUnitStore, PrerenderStoreModernClient>\n+    | undefined\n+}\n+\n+type CacheContext = PrivateCacheContext | PublicCacheContext\n \n type CacheKeyParts =\n   | [buildId: string, id: string, args: unknown[]]\n@@ -90,11 +114,11 @@ const filterStackFrame =\n \n function generateCacheEntry(\n   workStore: WorkStore,\n-  outerWorkUnitStore: WorkUnitStore | undefined,\n+  cacheContext: CacheContext,\n   clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n   encodedArguments: FormData | string,\n   fn: (...args: unknown[]) => Promise<unknown>,\n-  timeoutError: UseCacheTimeoutError\n+  sharedErrorStack: string | undefined\n ) {\n   // We need to run this inside a clean AsyncLocalStorage snapshot so that the cache\n   // generation cannot read anything from the context we're currently executing which\n@@ -104,21 +128,21 @@ function generateCacheEntry(\n   return workStore.runInCleanSnapshot(\n     generateCacheEntryWithRestoredWorkStore,\n     workStore,\n-    outerWorkUnitStore,\n+    cacheContext,\n     clientReferenceManifest,\n     encodedArguments,\n     fn,\n-    timeoutError\n+    sharedErrorStack\n   )\n }\n \n function generateCacheEntryWithRestoredWorkStore(\n   workStore: WorkStore,\n-  outerWorkUnitStore: WorkUnitStore | undefined,\n+  cacheContext: CacheContext,\n   clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n   encodedArguments: FormData | string,\n   fn: (...args: unknown[]) => Promise<unknown>,\n-  timeoutError: UseCacheTimeoutError\n+  sharedErrorStack: string | undefined\n ) {\n   // Since we cleared the AsyncLocalStorage we need to restore the workStore.\n   // Note: We explicitly don't restore the RequestStore nor the PrerenderStore.\n@@ -131,138 +155,209 @@ function generateCacheEntryWithRestoredWorkStore(\n     workStore,\n     generateCacheEntryWithCacheContext,\n     workStore,\n-    outerWorkUnitStore,\n+    cacheContext,\n     clientReferenceManifest,\n     encodedArguments,\n     fn,\n-    timeoutError\n+    sharedErrorStack\n   )\n }\n \n-function generateCacheEntryWithCacheContext(\n+function createUseCacheStore(\n   workStore: WorkStore,\n-  outerWorkUnitStore: WorkUnitStore | undefined,\n-  clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n-  encodedArguments: FormData | string,\n-  fn: (...args: unknown[]) => Promise<unknown>,\n-  timeoutError: UseCacheTimeoutError\n-) {\n-  if (!workStore.cacheLifeProfiles) {\n-    throw new Error(\n-      'cacheLifeProfiles should always be provided. This is a bug in Next.js.'\n-    )\n+  cacheContext: CacheContext,\n+  defaultCacheLife: Required<CacheLife>\n+): UseCacheStore {\n+  if (cacheContext.kind === 'private') {\n+    const outerWorkUnitStore = cacheContext.outerWorkUnitStore\n+\n+    return {\n+      type: 'private-cache',\n+      phase: 'render',\n+      implicitTags: outerWorkUnitStore?.implicitTags,\n+      revalidate: defaultCacheLife.revalidate,\n+      expire: defaultCacheLife.expire,\n+      stale: defaultCacheLife.stale,\n+      explicitRevalidate: undefined,\n+      explicitExpire: undefined,\n+      explicitStale: undefined,\n+      tags: null,\n+      hmrRefreshHash:\n+        outerWorkUnitStore && getHmrRefreshHash(workStore, outerWorkUnitStore),\n+      isHmrRefresh: outerWorkUnitStore?.isHmrRefresh ?? false,\n+      serverComponentsHmrCache: outerWorkUnitStore?.serverComponentsHmrCache,\n+      forceRevalidate: shouldForceRevalidate(workStore, outerWorkUnitStore),\n+      draftMode:\n+        outerWorkUnitStore &&\n+        getDraftModeProviderForCacheScope(workStore, outerWorkUnitStore),\n+      cookies: outerWorkUnitStore.cookies,\n+    }\n+  } else {\n+    let useCacheOrRequestStore: RequestStore | UseCacheStore | undefined\n+    const outerWorkUnitStore = cacheContext.outerWorkUnitStore\n+\n+    if (outerWorkUnitStore) {\n+      switch (outerWorkUnitStore?.type) {\n+        case 'cache':\n+        case 'private-cache':\n+        case 'request':\n+          useCacheOrRequestStore = outerWorkUnitStore\n+          break\n+        case 'prerender':\n+        case 'prerender-ppr':\n+        case 'prerender-legacy':\n+        case 'unstable-cache':\n+          break\n+        default:\n+          outerWorkUnitStore satisfies never\n+      }\n+    }\n+\n+    return {\n+      type: 'cache',\n+      phase: 'render',\n+      implicitTags: outerWorkUnitStore?.implicitTags,\n+      revalidate: defaultCacheLife.revalidate,\n+      expire: defaultCacheLife.expire,\n+      stale: defaultCacheLife.stale,\n+      explicitRevalidate: undefined,\n+      explicitExpire: undefined,\n+      explicitStale: undefined,\n+      tags: null,\n+      hmrRefreshHash:\n+        outerWorkUnitStore && getHmrRefreshHash(workStore, outerWorkUnitStore),\n+      isHmrRefresh: useCacheOrRequestStore?.isHmrRefresh ?? false,\n+      serverComponentsHmrCache:\n+        useCacheOrRequestStore?.serverComponentsHmrCache,\n+      forceRevalidate: shouldForceRevalidate(workStore, outerWorkUnitStore),\n+      draftMode:\n+        outerWorkUnitStore &&\n+        getDraftModeProviderForCacheScope(workStore, outerWorkUnitStore),\n+    }\n   }\n-  const defaultCacheLife = workStore.cacheLifeProfiles['default']\n+}\n+\n+function assertDefaultCacheLife(\n+  defaultCacheLife: CacheLife | undefined\n+): asserts defaultCacheLife is Required<CacheLife> {\n   if (\n     !defaultCacheLife ||\n     defaultCacheLife.revalidate == null ||\n     defaultCacheLife.expire == null ||\n     defaultCacheLife.stale == null\n   ) {\n-    throw new Error(\n-      'A default cacheLife profile must always be provided. This is a bug in Next.js.'\n+    throw new InvariantError(\n+      'A default cacheLife profile must always be provided.'\n     )\n   }\n+}\n \n-  let useCacheOrRequestStore: RequestStore | UseCacheStore | undefined\n-\n-  if (outerWorkUnitStore) {\n-    switch (outerWorkUnitStore?.type) {\n-      case 'cache':\n-      case 'request':\n-        useCacheOrRequestStore = outerWorkUnitStore\n-        break\n-      case 'prerender':\n-      case 'prerender-client':\n-      case 'prerender-ppr':\n-      case 'prerender-legacy':\n-      case 'unstable-cache':\n-        break\n-      default:\n-        outerWorkUnitStore satisfies never\n-    }\n+function generateCacheEntryWithCacheContext(\n+  workStore: WorkStore,\n+  cacheContext: CacheContext,\n+  clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n+  encodedArguments: FormData | string,\n+  fn: (...args: unknown[]) => Promise<unknown>,\n+  sharedErrorStack: string | undefined\n+) {\n+  if (!workStore.cacheLifeProfiles) {\n+    throw new InvariantError('cacheLifeProfiles should always be provided.')\n   }\n+  const defaultCacheLife = workStore.cacheLifeProfiles['default']\n+  assertDefaultCacheLife(defaultCacheLife)\n \n   // Initialize the Store for this Cache entry.\n-  const cacheStore: UseCacheStore = {\n-    type: 'cache',\n-    phase: 'render',\n-    implicitTags: outerWorkUnitStore?.implicitTags,\n-    revalidate: defaultCacheLife.revalidate,\n-    expire: defaultCacheLife.expire,\n-    stale: defaultCacheLife.stale,\n-    explicitRevalidate: undefined,\n-    explicitExpire: undefined,\n-    explicitStale: undefined,\n-    tags: null,\n-    hmrRefreshHash:\n-      outerWorkUnitStore && getHmrRefreshHash(workStore, outerWorkUnitStore),\n-    isHmrRefresh: useCacheOrRequestStore?.isHmrRefresh ?? false,\n-    serverComponentsHmrCache: useCacheOrRequestStore?.serverComponentsHmrCache,\n-    forceRevalidate: shouldForceRevalidate(workStore, outerWorkUnitStore),\n-    draftMode:\n-      outerWorkUnitStore &&\n-      getDraftModeProviderForCacheScope(workStore, outerWorkUnitStore),\n-  }\n+  const cacheStore = createUseCacheStore(\n+    workStore,\n+    cacheContext,\n+    defaultCacheLife\n+  )\n \n   return workUnitAsyncStorage.run(cacheStore, () =>\n     dynamicAccessAsyncStorage.run(\n       { abortController: new AbortController() },\n       generateCacheEntryImpl,\n       workStore,\n-      outerWorkUnitStore,\n+      cacheContext,\n       cacheStore,\n       clientReferenceManifest,\n       encodedArguments,\n       fn,\n-      timeoutError\n+      sharedErrorStack\n     )\n   )\n }\n \n+function propagateCacheLifeAndTagsToRevalidateStore(\n+  revalidateStore: RevalidateStore,\n+  entry: CacheEntry\n+): void {\n+  const outerTags = (revalidateStore.tags ??= [])\n+\n+  for (const tag of entry.tags) {\n+    if (!outerTags.includes(tag)) {\n+      outerTags.push(tag)\n+    }\n+  }\n+\n+  if (revalidateStore.stale > entry.stale) {\n+    revalidateStore.stale = entry.stale\n+  }\n+\n+  if (revalidateStore.revalidate > entry.revalidate) {\n+    revalidateStore.revalidate = entry.revalidate\n+  }\n+\n+  if (revalidateStore.expire > entry.expire) {\n+    revalidateStore.expire = entry.expire\n+  }\n+}\n+\n function propagateCacheLifeAndTags(\n-  workUnitStore: WorkUnitStore | undefined,\n+  cacheContext: CacheContext,\n   entry: CacheEntry\n ): void {\n-  if (workUnitStore) {\n-    switch (workUnitStore.type) {\n+  if (cacheContext.kind === 'private') {\n+    switch (cacheContext.outerWorkUnitStore?.type) {\n+      // TODO: Also propagate cache life and tags to dynamic prefetching stores.\n+      case 'private-cache':\n+        propagateCacheLifeAndTagsToRevalidateStore(\n+          cacheContext.outerWorkUnitStore,\n+          entry\n+        )\n+        break\n+      case 'request':\n+      case undefined:\n+        break\n+      default:\n+        cacheContext.outerWorkUnitStore satisfies never\n+    }\n+  } else {\n+    switch (cacheContext.outerWorkUnitStore?.type) {\n       case 'cache':\n+      case 'private-cache':\n       case 'prerender':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n-        // Propagate tags and revalidate upwards\n-        const outerTags = workUnitStore.tags ?? (workUnitStore.tags = [])\n-        const entryTags = entry.tags\n-        for (let i = 0; i < entryTags.length; i++) {\n-          const tag = entryTags[i]\n-          if (!outerTags.includes(tag)) {\n-            outerTags.push(tag)\n-          }\n-        }\n-        if (workUnitStore.stale > entry.stale) {\n-          workUnitStore.stale = entry.stale\n-        }\n-        if (workUnitStore.revalidate > entry.revalidate) {\n-          workUnitStore.revalidate = entry.revalidate\n-        }\n-        if (workUnitStore.expire > entry.expire) {\n-          workUnitStore.expire = entry.expire\n-        }\n+        propagateCacheLifeAndTagsToRevalidateStore(\n+          cacheContext.outerWorkUnitStore,\n+          entry\n+        )\n         break\n-      case 'prerender-client':\n       case 'request':\n       case 'unstable-cache':\n+      case undefined:\n         break\n       default:\n-        workUnitStore satisfies never\n+        cacheContext.outerWorkUnitStore satisfies never\n     }\n   }\n }\n \n async function collectResult(\n   savedStream: ReadableStream,\n   workStore: WorkStore,\n-  outerWorkUnitStore: WorkUnitStore | undefined,\n+  cacheContext: CacheContext,\n   innerCacheStore: UseCacheStore,\n   startTime: number,\n   errors: Array<unknown> // This is a live array that gets pushed into.\n@@ -334,10 +429,12 @@ async function collectResult(\n   }\n \n   // Propagate tags/revalidate to the parent context.\n-  propagateCacheLifeAndTags(outerWorkUnitStore, entry)\n+  if (cacheContext) {\n+    propagateCacheLifeAndTags(cacheContext, entry)\n+  }\n \n-  const cacheSignal = outerWorkUnitStore\n-    ? getCacheSignal(outerWorkUnitStore)\n+  const cacheSignal = cacheContext.outerWorkUnitStore\n+    ? getCacheSignal(cacheContext.outerWorkUnitStore)\n     : null\n \n   if (cacheSignal) {\n@@ -360,14 +457,15 @@ type GenerateCacheEntryResult =\n \n async function generateCacheEntryImpl(\n   workStore: WorkStore,\n-  outerWorkUnitStore: WorkUnitStore | undefined,\n+  cacheContext: CacheContext,\n   innerCacheStore: UseCacheStore,\n   clientReferenceManifest: DeepReadonly<ClientReferenceManifestForRsc>,\n   encodedArguments: FormData | string,\n   fn: (...args: unknown[]) => Promise<unknown>,\n-  timeoutError: UseCacheTimeoutError\n+  sharedErrorStack: string | undefined\n ): Promise<GenerateCacheEntryResult> {\n   const temporaryReferences = createServerTemporaryReferenceSet()\n+  const outerWorkUnitStore = cacheContext.outerWorkUnitStore\n \n   const [, , args] =\n     typeof encodedArguments === 'string'\n@@ -403,11 +501,11 @@ async function generateCacheEntryImpl(\n                       }\n                     })\n                     break\n-                  case 'prerender-client':\n                   case 'prerender-ppr':\n                   case 'prerender-legacy':\n                   case 'request':\n                   case 'cache':\n+                  case 'private-cache':\n                   case 'unstable-cache':\n                     break\n                   default:\n@@ -461,15 +559,20 @@ async function generateCacheEntryImpl(\n   let stream: ReadableStream<Uint8Array>\n \n   switch (outerWorkUnitStore?.type) {\n+    // TODO: Dynamic prefetches should also use the prerender variant.\n     case 'prerender':\n       const timeoutAbortController = new AbortController()\n \n       // If we're prerendering, we give you 50 seconds to fill a cache entry.\n       // Otherwise we assume you stalled on hanging input and de-opt. This needs\n       // to be lower than just the general timeout of 60 seconds.\n       const timer = setTimeout(() => {\n-        workStore.invalidDynamicUsageError = timeoutError\n-        timeoutAbortController.abort(timeoutError)\n+        const error = new UseCacheTimeoutError()\n+        if (sharedErrorStack) {\n+          error.stack = error.name + ': ' + error.message + sharedErrorStack\n+        }\n+        workStore.invalidDynamicUsageError = error\n+        timeoutAbortController.abort(error)\n       }, 50000)\n \n       const dynamicAccessAbortSignal =\n@@ -512,7 +615,7 @@ async function generateCacheEntryImpl(\n         // revalidation times.\n         stream = new ReadableStream({\n           start(controller) {\n-            controller.error(timeoutError)\n+            controller.error(timeoutAbortController.signal.reason)\n           },\n         })\n       } else if (dynamicAccessAbortSignal?.aborted) {\n@@ -533,11 +636,11 @@ async function generateCacheEntryImpl(\n         stream = prelude\n       }\n       break\n-    case 'prerender-client':\n     case 'prerender-ppr':\n     case 'prerender-legacy':\n     case 'request':\n     case 'cache':\n+    case 'private-cache':\n     case 'unstable-cache':\n     case undefined:\n       stream = renderToReadableStream(\n@@ -560,7 +663,7 @@ async function generateCacheEntryImpl(\n   const pendingCacheEntry = collectResult(\n     savedStream,\n     workStore,\n-    outerWorkUnitStore,\n+    cacheContext,\n     innerCacheStore,\n     startTime,\n     errors\n@@ -656,20 +759,42 @@ function createTrackedReadableStream(\n   })\n }\n \n+function wrapAsInvalidDynamicUsageError(\n+  error: Error,\n+  sharedErrorStack: string | undefined,\n+  workStore: WorkStore\n+) {\n+  if (sharedErrorStack) {\n+    error.stack = error.name + ': ' + error.message + sharedErrorStack\n+  }\n+\n+  workStore.invalidDynamicUsageError ??= error\n+\n+  return error\n+}\n+\n export function cache(\n   kind: string,\n   id: string,\n   boundArgsLength: number,\n   originalFn: (...args: unknown[]) => Promise<unknown>\n ) {\n-  const cacheHandler = getCacheHandler(kind)\n-  if (cacheHandler === undefined) {\n+  const isPrivate = kind === 'private'\n+\n+  // Private caches are currently only stored in the Resume Data Cache (RDC),\n+  // and not in cache handlers.\n+  const cacheHandler = isPrivate ? undefined : getCacheHandler(kind)\n+\n+  if (!isPrivate && !cacheHandler) {\n     throw new Error('Unknown cache handler: ' + kind)\n   }\n \n-  // Capture the timeout error here to ensure a useful stack.\n-  const timeoutError = new UseCacheTimeoutError()\n-  Error.captureStackTrace(timeoutError, cache)\n+  // Capture a better error stack in this scope.\n+  const sharedError = new Error()\n+  Error.captureStackTrace(sharedError, cache)\n+  const sharedErrorStack = sharedError.stack?.slice(\n+    sharedError.stack.indexOf('\\n')\n+  )\n \n   const name = originalFn.name\n   const cachedFn = {\n@@ -685,6 +810,103 @@ export function cache(\n \n       const workUnitStore = workUnitAsyncStorage.getStore()\n \n+      let cacheContext: CacheContext\n+\n+      if (isPrivate) {\n+        const expression = '\"use cache: private\"'\n+\n+        switch (workUnitStore?.type) {\n+          // \"use cache: private\" is dynamic in prerendering contexts.\n+          case 'prerender':\n+            return makeHangingPromise(workUnitStore.renderSignal, expression)\n+          case 'prerender-ppr':\n+            return postponeWithTracking(\n+              workStore.route,\n+              expression,\n+              workUnitStore.dynamicTracking\n+            )\n+          case 'prerender-legacy':\n+            return throwToInterruptStaticGeneration(\n+              expression,\n+              workStore,\n+              workUnitStore\n+            )\n+          case 'prerender-client':\n+            throw new InvariantError(\n+              `${expression} must not be used within a client component. Next.js should be preventing ${expression} from being allowed in client components statically, but did not in this case.`\n+            )\n+          case 'unstable-cache': {\n+            throw wrapAsInvalidDynamicUsageError(\n+              new Error(\n+                // TODO: Add a link to an error documentation page when we have one.\n+                `${expression} must not be used within \\`unstable_cache()\\`.`\n+              ),\n+              sharedErrorStack,\n+              workStore\n+            )\n+          }\n+          case 'cache': {\n+            throw wrapAsInvalidDynamicUsageError(\n+              new Error(\n+                // TODO: Add a link to an error documentation page when we have one.\n+                `${expression} must not be used within \"use cache\". It can only be nested inside of another ${expression}.`\n+              ),\n+              sharedErrorStack,\n+              workStore\n+            )\n+          }\n+          case 'request':\n+          case 'private-cache':\n+            cacheContext = {\n+              kind: 'private',\n+              outerWorkUnitStore: workUnitStore,\n+            }\n+            break\n+          case undefined:\n+            throw wrapAsInvalidDynamicUsageError(\n+              new Error(\n+                // TODO: Add a link to an error documentation page when we have one.\n+                `${expression} cannot be used outside of a request context.`\n+              ),\n+              sharedErrorStack,\n+              workStore\n+            )\n+          default:\n+            workUnitStore satisfies never\n+            // This is dead code, but without throwing an error here, TypeScript\n+            // will assume that cacheContext is used before being assigned.\n+            throw new InvariantError(`Unexpected work unit store.`)\n+        }\n+      } else {\n+        switch (workUnitStore?.type) {\n+          case 'prerender-client':\n+            const expression = '\"use cache\"'\n+            throw new InvariantError(\n+              `${expression} must not be used within a client component. Next.js should be preventing ${expression} from being allowed in client components statically, but did not in this case.`\n+            )\n+          case 'prerender':\n+          case 'prerender-ppr':\n+          case 'prerender-legacy':\n+          case 'request':\n+          case 'cache':\n+          case 'private-cache':\n+          // TODO: We should probably forbid nesting \"use cache\" inside\n+          // unstable_cache. (fallthrough)\n+          case 'unstable-cache':\n+          case undefined:\n+            cacheContext = {\n+              kind: 'public',\n+              outerWorkUnitStore: workUnitStore,\n+            }\n+            break\n+          default:\n+            workUnitStore satisfies never\n+            // This is dead code, but without throwing an error here, TypeScript\n+            // will assume that cacheContext is used before being assigned.\n+            throw new InvariantError(`Unexpected work unit store.`)\n+        }\n+      }\n+\n       // Get the clientReferenceManifest while we're still in the outer Context.\n       // In case getClientReferenceManifestSingleton is implemented using AsyncLocalStorage.\n       const clientReferenceManifest = getClientReferenceManifestForRsc()\n@@ -722,8 +944,17 @@ export function cache(\n         isPageOrLayout = true\n \n         const [{ params: outerParams, searchParams: outerSearchParams }] = args\n-        // Overwrite the props to omit $$isPageComponent.\n-        args = [{ params: outerParams, searchParams: outerSearchParams }]\n+        const keepSearchParams = workStore.cacheComponentsEnabled || isPrivate\n+\n+        args = [\n+          {\n+            params: outerParams,\n+            searchParams: keepSearchParams\n+              ? outerSearchParams\n+              : Promise.resolve({}),\n+            // omit $$isPageComponent.\n+          },\n+        ]\n \n         fn = {\n           [name]: async ({\n@@ -733,16 +964,16 @@ export function cache(\n             originalFn.apply(null, [\n               {\n                 params: outerParams,\n-                searchParams: workStore.cacheComponentsEnabled\n+                searchParams: keepSearchParams\n                   ? innerSearchParams\n                   : // When cacheComponents is not enabled, we can not encode\n                     // searchParams as a hanging promise. To still avoid unused\n                     // search params from making a page dynamic, we define them\n-                    // in `createComponentTree` as a promise that resolves to an\n-                    // empty object. And here, we're creating an erroring\n-                    // searchParams prop, when invoking the original function.\n-                    // This ensures that used searchParams inside of cached\n-                    // functions would still yield an error.\n+                    // as a promise that resolves to an empty object above. And\n+                    // here, we're creating an erroring searchParams prop, when\n+                    // invoking the original function. This ensures that used\n+                    // searchParams inside of cached functions would still yield\n+                    // an error.\n                     makeErroringExoticSearchParamsForUseCache(workStore),\n               },\n             ]),\n@@ -791,6 +1022,14 @@ export function cache(\n \n       const temporaryReferences = createClientTemporaryReferenceSet()\n \n+      // For private caches, which are allowed to read cookies, we still don't\n+      // need to include the cookies in the cache key. This is because we don't\n+      // store the cache entries in a cache handler, but only in the Resume Data\n+      // Cache (RDC). Private caches are only used during dynamic requests and\n+      // dynamic prefetches. For dynamic requests, the RDC is immutable, so it\n+      // does not include any private caches. For dynamic prefetches, the RDC is\n+      // mutable, but only lives as long as the request, so the key does not\n+      // need to include cookies.\n       const cacheKeyParts: CacheKeyParts = hmrRefreshHash\n         ? [buildId, id, args, hmrRefreshHash]\n         : [buildId, id, args]\n@@ -829,11 +1068,11 @@ export function cache(\n             break\n           }\n         // fallthrough\n-        case 'prerender-client':\n         case 'prerender-ppr':\n         case 'prerender-legacy':\n         case 'request':\n         case 'cache':\n+        case 'private-cache':\n         case 'unstable-cache':\n         case undefined:\n           encodedCacheKeyParts = await encodeCacheKeyParts()\n@@ -868,39 +1107,45 @@ export function cache(\n         const cachedEntry = renderResumeDataCache.cache.get(serializedCacheKey)\n         if (cachedEntry !== undefined) {\n           const existingEntry = await cachedEntry\n-          propagateCacheLifeAndTags(workUnitStore, existingEntry)\n-          if (\n-            workUnitStore !== undefined &&\n-            existingEntry !== undefined &&\n-            (existingEntry.revalidate === 0 ||\n-              existingEntry.expire < DYNAMIC_EXPIRE)\n-          ) {\n-            switch (workUnitStore.type) {\n-              case 'prerender':\n-                // In a Dynamic I/O prerender, if the cache entry has\n-                // revalidate: 0 or if the expire time is under 5 minutes, then\n-                // we consider this cache entry dynamic as it's not worth\n-                // generating static pages for such data. It's better to leave a\n-                // PPR hole that can be filled in dynamically with a potentially\n-                // cached entry.\n-                if (cacheSignal) {\n-                  cacheSignal.endRead()\n-                }\n-                return makeHangingPromise(\n-                  workUnitStore.renderSignal,\n-                  'dynamic \"use cache\"'\n-                )\n-              case 'prerender-client':\n-              case 'prerender-ppr':\n-              case 'prerender-legacy':\n-              case 'request':\n-              case 'cache':\n-              case 'unstable-cache':\n-                break\n-              default:\n-                workUnitStore satisfies never\n+          propagateCacheLifeAndTags(cacheContext, existingEntry)\n+\n+          if (workUnitStore !== undefined && existingEntry !== undefined) {\n+            if (\n+              existingEntry.revalidate === 0 ||\n+              existingEntry.expire < DYNAMIC_EXPIRE\n+            ) {\n+              switch (workUnitStore.type) {\n+                case 'prerender':\n+                  // In a Dynamic I/O prerender, if the cache entry has\n+                  // revalidate: 0 or if the expire time is under 5 minutes, then\n+                  // we consider this cache entry dynamic as it's not worth\n+                  // generating static pages for such data. It's better to leave a\n+                  // PPR hole that can be filled in dynamically with a potentially\n+                  // cached entry.\n+                  if (cacheSignal) {\n+                    cacheSignal.endRead()\n+                  }\n+                  return makeHangingPromise(\n+                    workUnitStore.renderSignal,\n+                    'dynamic \"use cache\"'\n+                  )\n+                case 'prerender-ppr':\n+                case 'prerender-legacy':\n+                case 'request':\n+                case 'cache':\n+                case 'private-cache':\n+                case 'unstable-cache':\n+                  break\n+                default:\n+                  workUnitStore satisfies never\n+              }\n+            }\n+\n+            if (existingEntry.stale < DYNAMIC_PREFETCH_DYNAMIC_STALE) {\n+              // TODO: Return hanging promise for dynamic prefetches.\n             }\n           }\n+\n           const [streamA, streamB] = existingEntry.value.tee()\n           existingEntry.value = streamB\n \n@@ -941,11 +1186,11 @@ export function cache(\n                   )\n                 }\n                 break\n-              case 'prerender-client':\n               case 'prerender-ppr':\n               case 'prerender-legacy':\n               case 'request':\n               case 'cache':\n+              case 'private-cache':\n               case 'unstable-cache':\n                 break\n               default:\n@@ -969,12 +1214,15 @@ export function cache(\n           await lazyRefreshTags\n         }\n \n-        let entry = shouldForceRevalidate(workStore, workUnitStore)\n-          ? undefined\n-          : await cacheHandler.get(\n-              serializedCacheKey,\n-              workUnitStore?.implicitTags?.tags ?? []\n-            )\n+        let entry: CacheEntry | undefined\n+\n+        // We ignore existing cache entries when force revalidating.\n+        if (cacheHandler && !shouldForceRevalidate(workStore, workUnitStore)) {\n+          entry = await cacheHandler.get(\n+            serializedCacheKey,\n+            workUnitStore?.implicitTags?.tags ?? []\n+          )\n+        }\n \n         if (entry) {\n           const implicitTags = workUnitStore?.implicitTags?.tags ?? []\n@@ -1034,11 +1282,11 @@ export function cache(\n                 workUnitStore.renderSignal,\n                 'dynamic \"use cache\"'\n               )\n-            case 'prerender-client':\n             case 'prerender-ppr':\n             case 'prerender-legacy':\n             case 'request':\n             case 'cache':\n+            case 'private-cache':\n             case 'unstable-cache':\n               break\n             default:\n@@ -1079,11 +1327,11 @@ export function cache(\n \n           const result = await generateCacheEntry(\n             workStore,\n-            workUnitStore,\n+            cacheContext,\n             clientReferenceManifest,\n             encodedCacheKeyParts,\n             fn,\n-            timeoutError\n+            sharedErrorStack\n           )\n \n           if (result.type === 'prerender-dynamic') {\n@@ -1108,18 +1356,28 @@ export function cache(\n               savedCacheEntry = pendingCacheEntry\n             }\n \n-            const promise = cacheHandler.set(\n-              serializedCacheKey,\n-              savedCacheEntry\n-            )\n+            if (cacheHandler) {\n+              const promise = cacheHandler.set(\n+                serializedCacheKey,\n+                savedCacheEntry\n+              )\n \n-            workStore.pendingRevalidateWrites ??= []\n-            workStore.pendingRevalidateWrites.push(promise)\n+              workStore.pendingRevalidateWrites ??= []\n+              workStore.pendingRevalidateWrites.push(promise)\n+            }\n           }\n \n           stream = newStream\n         } else {\n-          propagateCacheLifeAndTags(workUnitStore, entry)\n+          // If we have an entry at this point, this can't be a private cache\n+          // entry.\n+          if (cacheContext.kind === 'private') {\n+            throw new InvariantError(\n+              `A private cache entry must not be retrieved from the cache handler.`\n+            )\n+          }\n+\n+          propagateCacheLifeAndTags(cacheContext, entry)\n \n           // We want to return this stream, even if it's stale.\n           stream = entry.value\n@@ -1152,11 +1410,11 @@ export function cache(\n             const result = await generateCacheEntry(\n               workStore,\n               // This is not running within the context of this unit.\n-              undefined,\n+              { kind: cacheContext.kind, outerWorkUnitStore: undefined },\n               clientReferenceManifest,\n               encodedCacheKeyParts,\n               fn,\n-              timeoutError\n+              sharedErrorStack\n             )\n \n             if (result.type === 'cached') {\n@@ -1174,13 +1432,15 @@ export function cache(\n                 savedCacheEntry = pendingCacheEntry\n               }\n \n-              const promise = cacheHandler.set(\n-                serializedCacheKey,\n-                savedCacheEntry\n-              )\n+              if (cacheHandler) {\n+                const promise = cacheHandler.set(\n+                  serializedCacheKey,\n+                  savedCacheEntry\n+                )\n \n-              workStore.pendingRevalidateWrites ??= []\n-              workStore.pendingRevalidateWrites.push(promise)\n+                workStore.pendingRevalidateWrites ??= []\n+                workStore.pendingRevalidateWrites.push(promise)\n+              }\n \n               await ignoredStream.cancel()\n             }\n@@ -1267,6 +1527,7 @@ function shouldForceRevalidate(\n       case 'request':\n         return workUnitStore.headers.get('cache-control') === 'no-cache'\n       case 'cache':\n+      case 'private-cache':\n         return workUnitStore.forceRevalidate\n       case 'prerender':\n       case 'prerender-client':\n@@ -1316,6 +1577,7 @@ function shouldDiscardCacheEntry(\n       case 'prerender-legacy':\n       case 'request':\n       case 'cache':\n+      case 'private-cache':\n       case 'unstable-cache':\n         break\n       default:"
        },
        {
            "sha": "0b00fef360a87e4d2e7e9a8595af7ecd3073121c",
            "filename": "packages/next/src/server/web/spec-extension/revalidate.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frevalidate.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -101,6 +101,7 @@ function revalidate(tags: string[], expression: string) {\n \n     switch (workUnitStore.type) {\n       case 'cache':\n+      case 'private-cache':\n         throw new Error(\n           `Route ${store.route} used \"${expression}\" inside a \"use cache\" which is unsupported. To ensure revalidation is performed consistently it must always happen outside of renders and cached functions. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n         )"
        },
        {
            "sha": "f579a0dd8582e167165841af9b80c645e961c12a",
            "filename": "packages/next/src/server/web/spec-extension/unstable-cache.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -161,6 +161,7 @@ export function unstable_cache<T extends Callback>(\n         if (workUnitStore) {\n           switch (workUnitStore.type) {\n             case 'cache':\n+            case 'private-cache':\n             case 'prerender':\n             case 'prerender-ppr':\n             case 'prerender-legacy':\n@@ -386,6 +387,7 @@ function getFetchUrlPrefix(\n     case 'prerender-ppr':\n     case 'prerender-legacy':\n     case 'cache':\n+    case 'private-cache':\n     case 'unstable-cache':\n       return workStore.route\n     default:"
        },
        {
            "sha": "1f87cfa05cbd3bc06e3c2db11d883d565487232d",
            "filename": "packages/next/src/server/web/spec-extension/unstable-no-store.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-no-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-no-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-no-store.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -40,6 +40,7 @@ export function unstable_noStore() {\n         case 'prerender-legacy':\n         case 'request':\n         case 'cache':\n+        case 'private-cache':\n         case 'unstable-cache':\n           break\n         default:"
        },
        {
            "sha": "0aa46e69d97847d92ee2c50f330976d4333bef1a",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 724,
            "deletions": 124,
            "changes": 848,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -2,6 +2,8 @@ import { isNextDev, nextTestSetup } from 'e2e-utils'\n import { assertNoErrorToast } from 'next-test-utils'\n import { getPrerenderOutput } from './utils'\n \n+const isRspack = process.env.NEXT_RSPACK !== undefined\n+\n describe('Cache Components Errors', () => {\n   const { next, isTurbopack, isNextStart, skipped } = nextTestSetup({\n     files: __dirname + '/fixtures/default',\n@@ -213,30 +215,30 @@ describe('Cache Components Errors', () => {\n             if (isDebugPrerender) {\n               expect(output).toMatchInlineSnapshot(`\n                \"Error: Route \"/dynamic-metadata-error-route\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-                   at InnerLayoutRouter (webpack://<next-src>)\n-                   at RedirectErrorBoundary (webpack://<next-src>)\n-                   at RedirectBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                   at LoadingBoundary (webpack://<next-src>)\n-                   at ErrorBoundary (webpack://<next-src>)\n-                   at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                   at ScrollAndFocusHandler (webpack://<next-src>)\n-                   at RenderFromTemplateContext (webpack://<next-src>)\n-                   at OuterLayoutRouter (webpack://<next-src>)\n+                   at InnerLayoutRouter (bundler:///<next-src>)\n+                   at RedirectErrorBoundary (bundler:///<next-src>)\n+                   at RedirectBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                   at LoadingBoundary (bundler:///<next-src>)\n+                   at ErrorBoundary (bundler:///<next-src>)\n+                   at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                   at ScrollAndFocusHandler (bundler:///<next-src>)\n+                   at RenderFromTemplateContext (bundler:///<next-src>)\n+                   at OuterLayoutRouter (bundler:///<next-src>)\n                    at main (<anonymous>)\n                    at body (<anonymous>)\n                    at html (<anonymous>)\n-                   at InnerLayoutRouter (webpack://<next-src>)\n-                   at RedirectErrorBoundary (webpack://<next-src>)\n-                   at RedirectBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                   at LoadingBoundary (webpack://<next-src>)\n-                   at ErrorBoundary (webpack://<next-src>)\n-                   at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                   at ScrollAndFocusHandler (webpack://<next-src>)\n-                   at RenderFromTemplateContext (webpack://<next-src>)\n-                   at OuterLayoutRouter (webpack://<next-src>)\n+                   at InnerLayoutRouter (bundler:///<next-src>)\n+                   at RedirectErrorBoundary (bundler:///<next-src>)\n+                   at RedirectBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackErrorBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                   at LoadingBoundary (bundler:///<next-src>)\n+                   at ErrorBoundary (bundler:///<next-src>)\n+                   at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                   at ScrollAndFocusHandler (bundler:///<next-src>)\n+                   at RenderFromTemplateContext (bundler:///<next-src>)\n+                   at OuterLayoutRouter (bundler:///<next-src>)\n                  333 |  */\n                  334 | function InnerLayoutRouter({\n                > 335 |   tree,\n@@ -632,7 +634,7 @@ describe('Cache Components Errors', () => {\n             if (isDebugPrerender) {\n               expect(output).toMatchInlineSnapshot(`\n                \"Error: Route \"/dynamic-root\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-                   at IndirectionTwo (turbopack:///[project]/app/dynamic-root/indirection.tsx:7:34)\n+                   at IndirectionTwo (bundler:///app/dynamic-root/indirection.tsx:7:34)\n                    at main (<anonymous>)\n                    at body (<anonymous>)\n                    at html (<anonymous>)\n@@ -657,7 +659,7 @@ describe('Cache Components Errors', () => {\n             } else {\n               expect(output).toMatchInlineSnapshot(`\n                \"Error: Route \"/dynamic-root\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-                   at c (turbopack:///[project]/app/dynamic-root/indirection.tsx:7:34)\n+                   at a (bundler:///app/dynamic-root/indirection.tsx:7:34)\n                    at main (<anonymous>)\n                    at body (<anonymous>)\n                    at html (<anonymous>)\n@@ -686,31 +688,31 @@ describe('Cache Components Errors', () => {\n             if (isDebugPrerender) {\n               expect(output).toMatchInlineSnapshot(`\n                \"Error: Route \"/dynamic-root\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-                   at IndirectionTwo (webpack:///app/dynamic-root/indirection.tsx:7:34)\n-                   at InnerLayoutRouter (webpack://<next-src>)\n-                   at RedirectErrorBoundary (webpack://<next-src>)\n-                   at RedirectBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                   at LoadingBoundary (webpack://<next-src>)\n-                   at ErrorBoundary (webpack://<next-src>)\n-                   at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                   at ScrollAndFocusHandler (webpack://<next-src>)\n-                   at RenderFromTemplateContext (webpack://<next-src>)\n-                   at OuterLayoutRouter (webpack://<next-src>)\n+                   at IndirectionTwo (bundler:///app/dynamic-root/indirection.tsx:7:34)\n+                   at InnerLayoutRouter (bundler:///<next-src>)\n+                   at RedirectErrorBoundary (bundler:///<next-src>)\n+                   at RedirectBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                   at LoadingBoundary (bundler:///<next-src>)\n+                   at ErrorBoundary (bundler:///<next-src>)\n+                   at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                   at ScrollAndFocusHandler (bundler:///<next-src>)\n+                   at RenderFromTemplateContext (bundler:///<next-src>)\n+                   at OuterLayoutRouter (bundler:///<next-src>)\n                    at main (<anonymous>)\n                    at body (<anonymous>)\n                    at html (<anonymous>)\n-                   at InnerLayoutRouter (webpack://<next-src>)\n-                   at RedirectErrorBoundary (webpack://<next-src>)\n-                   at RedirectBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                   at LoadingBoundary (webpack://<next-src>)\n-                   at ErrorBoundary (webpack://<next-src>)\n-                   at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                   at ScrollAndFocusHandler (webpack://<next-src>)\n-                   at RenderFromTemplateContext (webpack://<next-src>)\n-                   at OuterLayoutRouter (webpack://<next-src>)\n+                   at InnerLayoutRouter (bundler:///<next-src>)\n+                   at RedirectErrorBoundary (bundler:///<next-src>)\n+                   at RedirectBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackErrorBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                   at LoadingBoundary (bundler:///<next-src>)\n+                   at ErrorBoundary (bundler:///<next-src>)\n+                   at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                   at ScrollAndFocusHandler (bundler:///<next-src>)\n+                   at RenderFromTemplateContext (bundler:///<next-src>)\n+                   at OuterLayoutRouter (bundler:///<next-src>)\n                   5 | }\n                   6 |\n                >  7 | export function IndirectionTwo({ children }) {\n@@ -720,30 +722,30 @@ describe('Cache Components Errors', () => {\n                  10 |\n                To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/dynamic-root\" in your browser to investigate the error.\n                Error: Route \"/dynamic-root\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-                   at InnerLayoutRouter (webpack://<next-src>)\n-                   at RedirectErrorBoundary (webpack://<next-src>)\n-                   at RedirectBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                   at LoadingBoundary (webpack://<next-src>)\n-                   at ErrorBoundary (webpack://<next-src>)\n-                   at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                   at ScrollAndFocusHandler (webpack://<next-src>)\n-                   at RenderFromTemplateContext (webpack://<next-src>)\n-                   at OuterLayoutRouter (webpack://<next-src>)\n+                   at InnerLayoutRouter (bundler:///<next-src>)\n+                   at RedirectErrorBoundary (bundler:///<next-src>)\n+                   at RedirectBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                   at LoadingBoundary (bundler:///<next-src>)\n+                   at ErrorBoundary (bundler:///<next-src>)\n+                   at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                   at ScrollAndFocusHandler (bundler:///<next-src>)\n+                   at RenderFromTemplateContext (bundler:///<next-src>)\n+                   at OuterLayoutRouter (bundler:///<next-src>)\n                    at main (<anonymous>)\n                    at body (<anonymous>)\n                    at html (<anonymous>)\n-                   at InnerLayoutRouter (webpack://<next-src>)\n-                   at RedirectErrorBoundary (webpack://<next-src>)\n-                   at RedirectBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-                   at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                   at LoadingBoundary (webpack://<next-src>)\n-                   at ErrorBoundary (webpack://<next-src>)\n-                   at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                   at ScrollAndFocusHandler (webpack://<next-src>)\n-                   at RenderFromTemplateContext (webpack://<next-src>)\n-                   at OuterLayoutRouter (webpack://<next-src>)\n+                   at InnerLayoutRouter (bundler:///<next-src>)\n+                   at RedirectErrorBoundary (bundler:///<next-src>)\n+                   at RedirectBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackErrorBoundary (bundler:///<next-src>)\n+                   at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                   at LoadingBoundary (bundler:///<next-src>)\n+                   at ErrorBoundary (bundler:///<next-src>)\n+                   at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                   at ScrollAndFocusHandler (bundler:///<next-src>)\n+                   at RenderFromTemplateContext (bundler:///<next-src>)\n+                   at OuterLayoutRouter (bundler:///<next-src>)\n                  333 |  */\n                  334 | function InnerLayoutRouter({\n                > 335 |   tree,\n@@ -926,8 +928,8 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-random-without-fallback\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-                     at getRandomNumber (turbopack:///[project]/app/sync-random-without-fallback/page.tsx:32:15)\n-                     at RandomReadingComponent (turbopack:///[project]/app/sync-random-without-fallback/page.tsx:40:18)\n+                     at getRandomNumber (bundler:///app/sync-random-without-fallback/page.tsx:32:15)\n+                     at RandomReadingComponent (bundler:///app/sync-random-without-fallback/page.tsx:40:18)\n                    30 |\n                    31 | function getRandomNumber() {\n                  > 32 |   return Math.random()\n@@ -944,7 +946,7 @@ describe('Cache Components Errors', () => {\n               } else {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-random-without-fallback\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-                     at f (turbopack:///[project]/app/sync-random-without-fallback/page.tsx:32:15)\n+                     at a (bundler:///app/sync-random-without-fallback/page.tsx:32:15)\n                    30 |\n                    31 | function getRandomNumber() {\n                  > 32 |   return Math.random()\n@@ -963,8 +965,8 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-random-without-fallback\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-                     at getRandomNumber (webpack:///app/sync-random-without-fallback/page.tsx:32:15)\n-                     at RandomReadingComponent (webpack:///app/sync-random-without-fallback/page.tsx:40:18)\n+                     at getRandomNumber (bundler:///app/sync-random-without-fallback/page.tsx:32:15)\n+                     at RandomReadingComponent (bundler:///app/sync-random-without-fallback/page.tsx:40:18)\n                    30 |\n                    31 | function getRandomNumber() {\n                  > 32 |   return Math.random()\n@@ -1187,7 +1189,7 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at CookiesReadingComponent (turbopack:///[project]/app/sync-cookies/page.tsx:17:67)\n+                     at CookiesReadingComponent (bundler:///app/sync-cookies/page.tsx:17:67)\n                      at stringify (<anonymous>)\n                    15 |\n                    16 | async function CookiesReadingComponent() {\n@@ -1206,8 +1208,8 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at e (turbopack:///[project]/app/sync-cookies/page.tsx:17:67)\n-                     at a (<anonymous>)\n+                     at a (bundler:///app/sync-cookies/page.tsx:17:67)\n+                     at b (<anonymous>)\n                    15 |\n                    16 | async function CookiesReadingComponent() {\n                  > 17 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n@@ -1225,7 +1227,7 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at CookiesReadingComponent (webpack:///app/sync-cookies/page.tsx:17:67)\n+                     at CookiesReadingComponent (bundler:///app/sync-cookies/page.tsx:17:67)\n                      at stringify (<anonymous>)\n                    15 |\n                    16 | async function CookiesReadingComponent() {\n@@ -1412,7 +1414,7 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-headers\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at HeadersReadingComponent (turbopack:///[project]/app/sync-headers/page.tsx:17:70)\n+                     at HeadersReadingComponent (bundler:///app/sync-headers/page.tsx:17:70)\n                      at stringify (<anonymous>)\n                    15 |\n                    16 | async function HeadersReadingComponent() {\n@@ -1431,8 +1433,8 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-headers\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at e (turbopack:///[project]/app/sync-headers/page.tsx:17:70)\n-                     at a (<anonymous>)\n+                     at a (bundler:///app/sync-headers/page.tsx:17:70)\n+                     at b (<anonymous>)\n                    15 |\n                    16 | async function HeadersReadingComponent() {\n                  > 17 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n@@ -1450,7 +1452,7 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error occurred prerendering page \"/sync-headers\". Read more: https://nextjs.org/docs/messages/prerender-error\n                  TypeError: <module-function>().get is not a function\n-                     at HeadersReadingComponent (webpack:///app/sync-headers/page.tsx:17:70)\n+                     at HeadersReadingComponent (bundler:///app/sync-headers/page.tsx:17:70)\n                      at stringify (<anonymous>)\n                    15 |\n                    16 | async function HeadersReadingComponent() {\n@@ -1665,7 +1667,7 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-attribution/guarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-                     at SyncIO (turbopack:///[project]/app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx:5:16)\n+                     at SyncIO (bundler:///app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx:5:16)\n                    3 | export function SyncIO() {\n                    4 |   // This is a sync IO access that should not cause an error\n                  > 5 |   const data = new Date().toISOString()\n@@ -1682,7 +1684,7 @@ describe('Cache Components Errors', () => {\n               } else {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-attribution/guarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-                     at c (turbopack:///[project]/app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx:5:16)\n+                     at a (bundler:///app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx:5:16)\n                    3 | export function SyncIO() {\n                    4 |   // This is a sync IO access that should not cause an error\n                  > 5 |   const data = new Date().toISOString()\n@@ -1701,7 +1703,7 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-attribution/guarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-                     at SyncIO (webpack:///app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx:5:16)\n+                     at SyncIO (bundler:///app/sync-attribution/guarded-async-unguarded-clientsync/client.tsx:5:16)\n                    3 | export function SyncIO() {\n                    4 |   // This is a sync IO access that should not cause an error\n                  > 5 |   const data = new Date().toISOString()\n@@ -1831,40 +1833,40 @@ describe('Cache Components Errors', () => {\n                  \"Error: Route \"/sync-attribution/unguarded-async-guarded-clientsync\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                      at section (<anonymous>)\n                      at main (<anonymous>)\n-                     at InnerLayoutRouter (webpack://<next-src>)\n-                     at RedirectErrorBoundary (webpack://<next-src>)\n-                     at RedirectBoundary (webpack://<next-src>)\n-                     at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                     at LoadingBoundary (webpack://<next-src>)\n-                     at ErrorBoundary (webpack://<next-src>)\n-                     at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                     at ScrollAndFocusHandler (webpack://<next-src>)\n+                     at InnerLayoutRouter (bundler:///<next-src>)\n+                     at RedirectErrorBoundary (bundler:///<next-src>)\n+                     at RedirectBoundary (bundler:///<next-src>)\n+                     at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                     at LoadingBoundary (bundler:///<next-src>)\n+                     at ErrorBoundary (bundler:///<next-src>)\n+                     at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                     at ScrollAndFocusHandler (bundler:///<next-src>)\n                      at RenderFromTemplateContext (<anonymous>)\n-                     at OuterLayoutRouter (webpack://<next-src>)\n+                     at OuterLayoutRouter (bundler:///<next-src>)\n                      at main (<anonymous>)\n                      at body (<anonymous>)\n                      at html (<anonymous>)\n-                     at InnerLayoutRouter (webpack://<next-src>)\n-                     at RedirectErrorBoundary (webpack://<next-src>)\n-                     at RedirectBoundary (webpack://<next-src>)\n-                     at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                     at LoadingBoundary (webpack://<next-src>)\n-                     at ErrorBoundary (webpack://<next-src>)\n-                     at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                     at ScrollAndFocusHandler (webpack://<next-src>)\n+                     at InnerLayoutRouter (bundler:///<next-src>)\n+                     at RedirectErrorBoundary (bundler:///<next-src>)\n+                     at RedirectBoundary (bundler:///<next-src>)\n+                     at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                     at LoadingBoundary (bundler:///<next-src>)\n+                     at ErrorBoundary (bundler:///<next-src>)\n+                     at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                     at ScrollAndFocusHandler (bundler:///<next-src>)\n                      at RenderFromTemplateContext (<anonymous>)\n-                     at OuterLayoutRouter (webpack://<next-src>)\n-                     at InnerLayoutRouter (webpack://<next-src>)\n-                     at RedirectErrorBoundary (webpack://<next-src>)\n-                     at RedirectBoundary (webpack://<next-src>)\n-                     at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-                     at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-                     at LoadingBoundary (webpack://<next-src>)\n-                     at ErrorBoundary (webpack://<next-src>)\n-                     at InnerScrollAndFocusHandler (webpack://<next-src>)\n-                     at ScrollAndFocusHandler (webpack://<next-src>)\n+                     at OuterLayoutRouter (bundler:///<next-src>)\n+                     at InnerLayoutRouter (bundler:///<next-src>)\n+                     at RedirectErrorBoundary (bundler:///<next-src>)\n+                     at RedirectBoundary (bundler:///<next-src>)\n+                     at HTTPAccessFallbackErrorBoundary (bundler:///<next-src>)\n+                     at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                     at LoadingBoundary (bundler:///<next-src>)\n+                     at ErrorBoundary (bundler:///<next-src>)\n+                     at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                     at ScrollAndFocusHandler (bundler:///<next-src>)\n                      at RenderFromTemplateContext (<anonymous>)\n-                     at OuterLayoutRouter (webpack://<next-src>)\n+                     at OuterLayoutRouter (bundler:///<next-src>)\n                    333 |  */\n                    334 | function InnerLayoutRouter({\n                  > 335 |   tree,\n@@ -1974,7 +1976,7 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-attribution/unguarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-                     at SyncIO (turbopack:///[project]/app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx:5:16)\n+                     at SyncIO (bundler:///app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx:5:16)\n                    3 | export function SyncIO() {\n                    4 |   // This is a sync IO access that should not cause an error\n                  > 5 |   const data = new Date().toISOString()\n@@ -1991,7 +1993,7 @@ describe('Cache Components Errors', () => {\n               } else {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-attribution/unguarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-                     at c (turbopack:///[project]/app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx:5:16)\n+                     at a (bundler:///app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx:5:16)\n                    3 | export function SyncIO() {\n                    4 |   // This is a sync IO access that should not cause an error\n                  > 5 |   const data = new Date().toISOString()\n@@ -2010,7 +2012,7 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route \"/sync-attribution/unguarded-async-unguarded-clientsync\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-                     at SyncIO (webpack:///app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx:5:16)\n+                     at SyncIO (bundler:///app/sync-attribution/unguarded-async-unguarded-clientsync/client.tsx:5:16)\n                    3 | export function SyncIO() {\n                    4 |   // This is a sync IO access that should not cause an error\n                  > 5 |   const data = new Date().toISOString()\n@@ -2096,7 +2098,7 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at CookiesReadingComponent (turbopack:///[project]/app/use-cache-cookies/page.tsx:22:18)\n+                     at CookiesReadingComponent (bundler:///app/use-cache-cookies/page.tsx:22:18)\n                    20 |   // in userland.\n                    21 |   try {\n                  > 22 |     await cookies()\n@@ -2113,7 +2115,7 @@ describe('Cache Components Errors', () => {\n               } else {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at <unknown> (turbopack:///[project]/app/use-cache-cookies/page.tsx:22:11)\n+                     at <unknown> (bundler:///app/use-cache-cookies/page.tsx:22:11)\n                    20 |   // in userland.\n                    21 |   try {\n                  > 22 |     await cookies()\n@@ -2132,8 +2134,8 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at CookiesReadingComponent (webpack:///app/use-cache-cookies/page.tsx:22:18)\n-                     at <unknown> (webpack://<next-src>)\n+                     at CookiesReadingComponent (bundler:///app/use-cache-cookies/page.tsx:22:18)\n+                     at <unknown> (bundler:///<next-src>)\n                    20 |   // in userland.\n                    21 |   try {\n                  > 22 |     await cookies()\n@@ -2219,7 +2221,7 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at DraftModeEnablingComponent (turbopack:///[project]/app/use-cache-draft-mode/page.tsx:20:26)\n+                     at DraftModeEnablingComponent (bundler:///app/use-cache-draft-mode/page.tsx:20:26)\n                    18 |   // here to ensure that this error is shown even when it's caught in userland.\n                    19 |   try {\n                  > 20 |     ;(await draftMode()).enable()\n@@ -2236,7 +2238,7 @@ describe('Cache Components Errors', () => {\n               } else {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at <unknown> (turbopack:///[project]/app/use-cache-draft-mode/page.tsx:20:26)\n+                     at <unknown> (bundler:///app/use-cache-draft-mode/page.tsx:20:26)\n                    18 |   // here to ensure that this error is shown even when it's caught in userland.\n                    19 |   try {\n                  > 20 |     ;(await draftMode()).enable()\n@@ -2255,7 +2257,7 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at DraftModeEnablingComponent (webpack:///app/use-cache-draft-mode/page.tsx:20:26)\n+                     at DraftModeEnablingComponent (bundler:///app/use-cache-draft-mode/page.tsx:20:26)\n                    18 |   // here to ensure that this error is shown even when it's caught in userland.\n                    19 |   try {\n                  > 20 |     ;(await draftMode()).enable()\n@@ -2339,7 +2341,7 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at HeadersReadingComponent (turbopack:///[project]/app/use-cache-headers/page.tsx:21:18)\n+                     at HeadersReadingComponent (bundler:///app/use-cache-headers/page.tsx:21:18)\n                    19 |   // to ensure that this error is shown even when it's caught in userland.\n                    20 |   try {\n                  > 21 |     await headers()\n@@ -2356,7 +2358,7 @@ describe('Cache Components Errors', () => {\n               } else {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at <unknown> (turbopack:///[project]/app/use-cache-headers/page.tsx:21:11)\n+                     at <unknown> (bundler:///app/use-cache-headers/page.tsx:21:11)\n                    19 |   // to ensure that this error is shown even when it's caught in userland.\n                    20 |   try {\n                  > 21 |     await headers()\n@@ -2375,8 +2377,8 @@ describe('Cache Components Errors', () => {\n               if (isDebugPrerender) {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n-                     at HeadersReadingComponent (webpack:///app/use-cache-headers/page.tsx:21:18)\n-                     at <unknown> (webpack://<next-src>)\n+                     at HeadersReadingComponent (bundler:///app/use-cache-headers/page.tsx:21:18)\n+                     at <unknown> (bundler:///<next-src>)\n                    19 |   // to ensure that this error is shown even when it's caught in userland.\n                    20 |   try {\n                  > 21 |     await headers()\n@@ -2408,5 +2410,603 @@ describe('Cache Components Errors', () => {\n         }\n       })\n     })\n+\n+    describe('With `use cache: private`', () => {\n+      describe('in `unstable_cache`', () => {\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser(\n+              '/use-cache-private-in-unstable-cache'\n+            )\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"\"use cache: private\" must not be used within \\`unstable_cache()\\`.\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-in-unstable-cache/page.tsx (21:38) @ [project]/app/use-cache-private-in-unstable-cache/page.tsx [app-rsc] (ecmascript)\n+               > 21 | const getCachedData = unstable_cache(async () => {\n+                    |                                      ^\",\n+                 \"stack\": [\n+                   \"[project]/app/use-cache-private-in-unstable-cache/page.tsx [app-rsc] (ecmascript) app/use-cache-private-in-unstable-cache/page.tsx (21:38)\",\n+                   \"<FIXME-file-protocol>\",\n+                   \"<FIXME-file-protocol>\",\n+                   \"<FIXME-next-dist-dir>\",\n+                 ],\n+               }\n+              `)\n+            } else if (isRspack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"\"use cache: private\" must not be used within \\`unstable_cache()\\`.\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-in-unstable-cache/page.tsx (21:38) @ eval\n+               > 21 | const getCachedData = unstable_cache(async () => {\n+                    |                                      ^\",\n+                 \"stack\": [\n+                   \"eval app/use-cache-private-in-unstable-cache/page.tsx (21:38)\",\n+                   \"<FIXME-next-dist-dir>\",\n+                   \"<FIXME-next-dist-dir>\",\n+                 ],\n+               }\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"\"use cache: private\" must not be used within \\`unstable_cache()\\`.\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-in-unstable-cache/page.tsx (21:38) @ eval\n+               > 21 | const getCachedData = unstable_cache(async () => {\n+                    |                                      ^\",\n+                 \"stack\": [\n+                   \"eval app/use-cache-private-in-unstable-cache/page.tsx (21:38)\",\n+                   \"<FIXME-next-dist-dir>\",\n+                 ],\n+               }\n+              `)\n+            }\n+          })\n+        } else {\n+          it('should error the build', async () => {\n+            try {\n+              await prerender('/use-cache-private-in-unstable-cache')\n+            } catch {\n+              // we expect the build to fail\n+            }\n+\n+            const output = getPrerenderOutput(\n+              next.cliOutput.slice(cliOutputLength),\n+              { isMinified: !isDebugPrerender }\n+            )\n+\n+            if (isTurbopack) {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n+                     at 0 (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n+                     at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n+                   19 | }\n+                   20 |\n+                 > 21 | const getCachedData = unstable_cache(async () => {\n+                      |                                      ^\n+                   22 |   'use cache: private'\n+                   23 |\n+                   24 |   return fetch('https://next-data-api-endpoint.vercel.app/api/random').then(\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-unstable-cache\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-private-in-unstable-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-private-in-unstable-cache/page: /use-cache-private-in-unstable-cache\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n+                     at 0 (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n+                     at a (<next-dist-dir>)\n+                   19 | }\n+                   20 |\n+                 > 21 | const getCachedData = unstable_cache(async () => {\n+                      |                                      ^\n+                   22 |   'use cache: private'\n+                   23 |\n+                   24 |   return fetch('https://next-data-api-endpoint.vercel.app/api/random').then(\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-unstable-cache\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-private-in-unstable-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-private-in-unstable-cache/page: /use-cache-private-in-unstable-cache, exiting the build.\"\n+                `)\n+              }\n+            } else {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n+                     at 0 (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n+                   19 | }\n+                   20 |\n+                 > 21 | const getCachedData = unstable_cache(async () => {\n+                      |                                      ^\n+                   22 |   'use cache: private'\n+                   23 |\n+                   24 |   return fetch('https://next-data-api-endpoint.vercel.app/api/random').then(\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-unstable-cache\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-private-in-unstable-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-private-in-unstable-cache/page: /use-cache-private-in-unstable-cache\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n+                     at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-unstable-cache\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-private-in-unstable-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-private-in-unstable-cache/page: /use-cache-private-in-unstable-cache, exiting the build.\"\n+                `)\n+              }\n+            }\n+          })\n+        }\n+      })\n+\n+      describe('in `use cache`', () => {\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser(\n+              '/use-cache-private-in-use-cache'\n+            )\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"\"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-in-use-cache/page.tsx (15:1) @ [project]/app/use-cache-private-in-use-cache/page.tsx [app-rsc] (ecmascript)\n+               > 15 | async function Private() {\n+                    | ^\",\n+                 \"stack\": [\n+                   \"[project]/app/use-cache-private-in-use-cache/page.tsx [app-rsc] (ecmascript) app/use-cache-private-in-use-cache/page.tsx (15:1)\",\n+                   \"<FIXME-file-protocol>\",\n+                   \"<FIXME-file-protocol>\",\n+                   \"<FIXME-next-dist-dir>\",\n+                 ],\n+               }\n+              `)\n+            } else if (isRspack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"\"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-in-use-cache/page.tsx (15:1) @ eval\n+               > 15 | async function Private() {\n+                    | ^\",\n+                 \"stack\": [\n+                   \"eval app/use-cache-private-in-use-cache/page.tsx (15:1)\",\n+                   \"<FIXME-next-dist-dir>\",\n+                   \"<FIXME-next-dist-dir>\",\n+                 ],\n+               }\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"\"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-in-use-cache/page.tsx (15:1) @ eval\n+               > 15 | async function Private() {\n+                    | ^\",\n+                 \"stack\": [\n+                   \"eval app/use-cache-private-in-use-cache/page.tsx (15:1)\",\n+                   \"<FIXME-next-dist-dir>\",\n+                 ],\n+               }\n+              `)\n+            }\n+          })\n+        } else {\n+          it('should error the build', async () => {\n+            try {\n+              await prerender('/use-cache-private-in-use-cache')\n+            } catch {\n+              // we expect the build to fail\n+            }\n+\n+            const output = getPrerenderOutput(\n+              next.cliOutput.slice(cliOutputLength),\n+              { isMinified: !isDebugPrerender }\n+            )\n+\n+            // TODO: Ideally, the error should only be shown once.\n+            if (isTurbopack) {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                     at 0 (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n+                     at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n+                   13 | }\n+                   14 |\n+                 > 15 | async function Private() {\n+                      | ^\n+                   16 |   'use cache: private'\n+                   17 |\n+                   18 |   return <p>Private</p>\n+                 Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                     at 1 (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n+                     at c (<next-dist-dir>)\n+                     at d (<next-dist-dir>)\n+                   13 | }\n+                   14 |\n+                 > 15 | async function Private() {\n+                      | ^\n+                   16 |   'use cache: private'\n+                   17 |\n+                   18 |   return <p>Private</p>\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-use-cache\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-private-in-use-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-private-in-use-cache/page: /use-cache-private-in-use-cache\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                     at 0 (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n+                     at 1 (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:16)\n+                     at a (<next-dist-dir>)\n+                   13 | }\n+                   14 |\n+                 > 15 | async function Private() {\n+                      | ^\n+                   16 |   'use cache: private'\n+                   17 |\n+                   18 |   return <p>Private</p>\n+                 Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                     at 2 (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n+                     at 3 (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:16)\n+                     at b (<next-dist-dir>)\n+                   13 | }\n+                   14 |\n+                 > 15 | async function Private() {\n+                      | ^\n+                   16 |   'use cache: private'\n+                   17 |\n+                   18 |   return <p>Private</p>\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-use-cache\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-private-in-use-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-private-in-use-cache/page: /use-cache-private-in-use-cache, exiting the build.\"\n+                `)\n+              }\n+            } else {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                     at 0 (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n+                   13 | }\n+                   14 |\n+                 > 15 | async function Private() {\n+                      | ^\n+                   16 |   'use cache: private'\n+                   17 |\n+                   18 |   return <p>Private</p>\n+                 Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                     at 1 (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n+                   13 | }\n+                   14 |\n+                 > 15 | async function Private() {\n+                      | ^\n+                   16 |   'use cache: private'\n+                   17 |\n+                   18 |   return <p>Private</p>\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-use-cache\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-private-in-use-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-private-in-use-cache/page: /use-cache-private-in-use-cache\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                     at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n+                 Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n+                     at c (<next-dist-dir>)\n+                     at d (<next-dist-dir>)\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-in-use-cache\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-private-in-use-cache\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-private-in-use-cache/page: /use-cache-private-in-use-cache, exiting the build.\"\n+                `)\n+              }\n+            }\n+          })\n+        }\n+      })\n+\n+      describe('without Suspense', () => {\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser(\n+              '/use-cache-private-without-suspense'\n+            )\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayCollapsedRedbox(`\n+               {\n+                 \"description\": \"Route \"/use-cache-private-without-suspense\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+                 \"environmentLabel\": \"Server\",\n+                 \"label\": \"Console Error\",\n+                 \"source\": \"app/use-cache-private-without-suspense/page.tsx (10:7) @ Page\n+               > 10 |       <Private />\n+                    |       ^\",\n+                 \"stack\": [\n+                   \"Page app/use-cache-private-without-suspense/page.tsx (10:7)\",\n+                   \"LogSafely <anonymous>\",\n+                 ],\n+               }\n+              `)\n+            } else {\n+              await expect(browser).toDisplayCollapsedRedbox(`\n+               {\n+                 \"description\": \"Route \"/use-cache-private-without-suspense\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+                 \"environmentLabel\": \"Server\",\n+                 \"label\": \"Console Error\",\n+                 \"source\": \"app/use-cache-private-without-suspense/page.tsx (10:7) @ Page\n+               > 10 |       <Private />\n+                    |       ^\",\n+                 \"stack\": [\n+                   \"Page app/use-cache-private-without-suspense/page.tsx (10:7)\",\n+                   \"LogSafely <anonymous>\",\n+                 ],\n+               }\n+              `)\n+            }\n+          })\n+        } else {\n+          it('should error the build', async () => {\n+            try {\n+              await prerender('/use-cache-private-without-suspense')\n+            } catch {\n+              // we expect the build to fail\n+            }\n+\n+            const output = getPrerenderOutput(\n+              next.cliOutput.slice(cliOutputLength),\n+              { isMinified: !isDebugPrerender }\n+            )\n+\n+            if (isTurbopack) {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route \"/use-cache-private-without-suspense\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                     at main (<anonymous>)\n+                     at body (<anonymous>)\n+                     at html (<anonymous>)\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-without-suspense\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-private-without-suspense\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-private-without-suspense/page: /use-cache-private-without-suspense\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route \"/use-cache-private-without-suspense\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                     at main (<anonymous>)\n+                     at body (<anonymous>)\n+                     at html (<anonymous>)\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-without-suspense\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-private-without-suspense\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-private-without-suspense/page: /use-cache-private-without-suspense, exiting the build.\"\n+                `)\n+              }\n+            } else {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route \"/use-cache-private-without-suspense\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                     at InnerLayoutRouter (bundler:///<next-src>)\n+                     at RedirectErrorBoundary (bundler:///<next-src>)\n+                     at RedirectBoundary (bundler:///<next-src>)\n+                     at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                     at LoadingBoundary (bundler:///<next-src>)\n+                     at ErrorBoundary (bundler:///<next-src>)\n+                     at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                     at ScrollAndFocusHandler (bundler:///<next-src>)\n+                     at RenderFromTemplateContext (bundler:///<next-src>)\n+                     at OuterLayoutRouter (bundler:///<next-src>)\n+                     at main (<anonymous>)\n+                     at body (<anonymous>)\n+                     at html (<anonymous>)\n+                     at InnerLayoutRouter (bundler:///<next-src>)\n+                     at RedirectErrorBoundary (bundler:///<next-src>)\n+                     at RedirectBoundary (bundler:///<next-src>)\n+                     at HTTPAccessFallbackErrorBoundary (bundler:///<next-src>)\n+                     at HTTPAccessFallbackBoundary (bundler:///<next-src>)\n+                     at LoadingBoundary (bundler:///<next-src>)\n+                     at ErrorBoundary (bundler:///<next-src>)\n+                     at InnerScrollAndFocusHandler (bundler:///<next-src>)\n+                     at ScrollAndFocusHandler (bundler:///<next-src>)\n+                     at RenderFromTemplateContext (bundler:///<next-src>)\n+                     at OuterLayoutRouter (bundler:///<next-src>)\n+                   333 |  */\n+                   334 | function InnerLayoutRouter({\n+                 > 335 |   tree,\n+                       |   ^\n+                   336 |   segmentPath,\n+                   337 |   cacheNode,\n+                   338 |   url,\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-without-suspense\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-private-without-suspense\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-private-without-suspense/page: /use-cache-private-without-suspense\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route \"/use-cache-private-without-suspense\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                     at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n+                     at c (<next-dist-dir>)\n+                     at d (<next-dist-dir>)\n+                     at e (<next-dist-dir>)\n+                     at f (<next-dist-dir>)\n+                     at g (<next-dist-dir>)\n+                     at h (<next-dist-dir>)\n+                     at i (<next-dist-dir>)\n+                     at j (<next-dist-dir>)\n+                     at main (<anonymous>)\n+                     at body (<anonymous>)\n+                     at html (<anonymous>)\n+                     at k (<next-dist-dir>)\n+                     at l (<next-dist-dir>)\n+                     at m (<next-dist-dir>)\n+                     at n (<next-dist-dir>)\n+                     at o (<next-dist-dir>)\n+                     at p (<next-dist-dir>)\n+                     at q (<next-dist-dir>)\n+                     at r (<next-dist-dir>)\n+                     at s (<next-dist-dir>)\n+                     at t (<next-dist-dir>)\n+                     at u (<next-dist-dir>)\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-private-without-suspense\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-private-without-suspense\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-private-without-suspense/page: /use-cache-private-without-suspense, exiting the build.\"\n+                `)\n+              }\n+            }\n+          })\n+        }\n+      })\n+\n+      describe('with `connection()`', () => {\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser('/use-cache-private-connection')\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-private-connection used \"connection\" inside \"use cache: private\". The \\`connection()\\` function is used to indicate the subsequent code must only run when there is an actual navigation request, but caches must be able to be produced before a navigation request, so this function is not allowed in this scope. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-connection/page.tsx (25:21) @ Private\n+               > 25 |     await connection()\n+                    |                     ^\",\n+                 \"stack\": [\n+                   \"Private app/use-cache-private-connection/page.tsx (25:21)\",\n+                 ],\n+               }\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-private-connection used \"connection\" inside \"use cache: private\". The \\`connection()\\` function is used to indicate the subsequent code must only run when there is an actual navigation request, but caches must be able to be produced before a navigation request, so this function is not allowed in this scope. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-connection/page.tsx (25:21) @ Private\n+               > 25 |     await connection()\n+                    |                     ^\",\n+                 \"stack\": [\n+                   \"Private app/use-cache-private-connection/page.tsx (25:21)\",\n+                 ],\n+               }\n+              `)\n+            }\n+          })\n+        } else {\n+          // TODO: With prefetch sentinels this should yield a build error.\n+          it('should not fail the build and show no runtime error (caught in userland)', async () => {\n+            await prerender('/use-cache-private-connection')\n+            await next.start({ skipBuild: true })\n+\n+            const browser = await next.browser(\n+              '/use-cache-private-connection',\n+              { pushErrorAsConsoleLog: true }\n+            )\n+\n+            expect(await browser.elementById('private').text()).toBe('Private')\n+\n+            expect(await browser.log()).not.toContainEqual(\n+              expect.objectContaining({ source: 'error' })\n+            )\n+\n+            expect(next.cliOutput.slice(cliOutputLength)).not.toInclude('Error')\n+          })\n+        }\n+      })\n+\n+      describe('with `headers()`', () => {\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser('/use-cache-private-headers')\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-private-headers used \"headers\" inside \"use cache: private\". Accessing \"headers\" inside a private cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-headers/page.tsx (25:18) @ Private\n+               > 25 |     await headers()\n+                    |                  ^\",\n+                 \"stack\": [\n+                   \"Private app/use-cache-private-headers/page.tsx (25:18)\",\n+                 ],\n+               }\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-private-headers used \"headers\" inside \"use cache: private\". Accessing \"headers\" inside a private cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-private-headers/page.tsx (25:18) @ Private\n+               > 25 |     await headers()\n+                    |                  ^\",\n+                 \"stack\": [\n+                   \"Private app/use-cache-private-headers/page.tsx (25:18)\",\n+                 ],\n+               }\n+              `)\n+            }\n+          })\n+        } else {\n+          // TODO: With prefetch sentinels this should yield a build error.\n+          it('should not fail the build and show no runtime error (caught in userland)', async () => {\n+            await prerender('/use-cache-private-headers')\n+            await next.start({ skipBuild: true })\n+            cliOutputLength = next.cliOutput.length\n+\n+            const browser = await next.browser('/use-cache-private-headers', {\n+              pushErrorAsConsoleLog: true,\n+            })\n+\n+            expect(await browser.elementById('private').text()).toBe('Private')\n+\n+            expect(await browser.log()).not.toContainEqual(\n+              expect.objectContaining({ source: 'error' })\n+            )\n+\n+            expect(next.cliOutput.slice(cliOutputLength)).not.toInclude('Error')\n+          })\n+        }\n+      })\n+    })\n   })\n })"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-connection/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-connection%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-connection%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-connection%2Flayout.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "0d75a1be2a7c450f55f6b6b69bf9366eeffed19a",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-connection/page.tsx",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-connection%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-connection%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-connection%2Fpage.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,29 @@\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page uses `connection()` inside `'use cache: private'`, which\n+        triggers an error at runtime.\n+      </p>\n+      <Suspense fallback={<p>Loading...</p>}>\n+        <Private />\n+      </Suspense>\n+    </>\n+  )\n+}\n+\n+async function Private() {\n+  'use cache: private'\n+\n+  // Calling connection() in a cache context is not allowed. We're try/catching\n+  // here to ensure that, in dev mode, this error is shown even when it's caught\n+  // in userland.\n+  try {\n+    await connection()\n+  } catch {}\n+\n+  return <p id=\"private\">Private</p>\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-headers/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Flayout.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ea3db2a9b0f2b418c1d35202376b9a606618beed",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-headers/page.tsx",
            "status": "added",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-headers%2Fpage.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,29 @@\n+import { headers } from 'next/headers'\n+import { Suspense } from 'react'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page uses `headers()` inside `'use cache: private'`, which triggers\n+        an error at runtime.\n+      </p>\n+      <Suspense fallback={<p>Loading...</p>}>\n+        <Private />\n+      </Suspense>\n+    </>\n+  )\n+}\n+\n+async function Private() {\n+  'use cache: private'\n+\n+  // Reading headers in a cache context is not allowed. We're try/catching here\n+  // to ensure that, in dev mode, this error is shown even when it's caught in\n+  // userland.\n+  try {\n+    await headers()\n+  } catch {}\n+\n+  return <p id=\"private\">Private</p>\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-in-unstable-cache/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-unstable-cache%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-unstable-cache%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-unstable-cache%2Flayout.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "55b1c73948ae3907e505ce7fb38e688a4d7cd09a",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-in-unstable-cache/page.tsx",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-unstable-cache%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-unstable-cache%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-unstable-cache%2Fpage.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,27 @@\n+import { unstable_cache } from 'next/cache'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page nests `'use cache: private'` in `unstable_cache`, which\n+        triggers an error.\n+      </p>\n+      <ComponentWithCachedData />\n+    </>\n+  )\n+}\n+\n+async function ComponentWithCachedData() {\n+  const data = await getCachedData()\n+\n+  return <p>{data}</p>\n+}\n+\n+const getCachedData = unstable_cache(async () => {\n+  'use cache: private'\n+\n+  return fetch('https://next-data-api-endpoint.vercel.app/api/random').then(\n+    (res) => res.json()\n+  )\n+})"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-in-use-cache/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-use-cache%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-use-cache%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-use-cache%2Flayout.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "3fa6c2e087fdb175d6c40d29f6bf0f7aa16a3c02",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-in-use-cache/page.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-use-cache%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-use-cache%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-in-use-cache%2Fpage.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,19 @@\n+export default async function Page() {\n+  'use cache'\n+\n+  return (\n+    <>\n+      <p>\n+        This page nests `'use cache: private'` in `'use cache'`, which triggers\n+        an error.\n+      </p>\n+      <Private />\n+    </>\n+  )\n+}\n+\n+async function Private() {\n+  'use cache: private'\n+\n+  return <p>Private</p>\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-without-suspense/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-without-suspense%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-without-suspense%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-without-suspense%2Flayout.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "febb3b0d4c9aeb214449c272ec0d910ec10ca7d4",
            "filename": "test/e2e/app-dir/cache-components-errors/fixtures/default/app/use-cache-private-without-suspense/page.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-without-suspense%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-without-suspense%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-private-without-suspense%2Fpage.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,19 @@\n+export default function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page uses `'use cache: private'` without wrapping it in a Suspense\n+        boundary. In the context of prerenders, private caches are considered\n+        dynamic, so they need to be wrapped in a Suspense boundary. Otherwise,\n+        it triggers an error.\n+      </p>\n+      <Private />\n+    </>\n+  )\n+}\n+\n+async function Private() {\n+  'use cache: private'\n+\n+  return <p>Private</p>\n+}"
        },
        {
            "sha": null,
            "filename": "test/e2e/app-dir/cache-components-errors/update-snapshots.sh",
            "status": "modified",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fupdate-snapshots.sh",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fupdate-snapshots.sh",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fupdate-snapshots.sh?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee"
        },
        {
            "sha": "8f506b9911f8b84059a9997b2d27ba0fdeb85194",
            "filename": "test/e2e/app-dir/cache-components-errors/utils.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 7,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Futils.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -9,19 +9,23 @@ export function getPrerenderOutput(\n ): string {\n   const lines: string[] = []\n   let foundPrerenderingLine = false\n-  let i = 0\n+  let a = 0\n+  let n = 0\n \n   const replaceNextDistStackFrame = () =>\n-    `at ${abc[i++ % abc.length]} (<next-dist-dir>)`\n+    `at ${abc[a++ % abc.length]} (<next-dist-dir>)`\n \n   const replaceAnonymousStackFrame = (_m, name) => {\n     const deterministicName = hostElementsUsedInFixtures.includes(name)\n       ? name\n-      : abc[i++ % abc.length]\n+      : abc[a++ % abc.length]\n \n     return `at ${deterministicName} (<anonymous>)`\n   }\n \n+  const replaceMinifiedName = () => `at ${abc[a++ % abc.length]} (`\n+  const replaceNumericModuleId = () => `at ${n++} (`\n+\n   for (let line of cliOutput.split('\\n')) {\n     if (line.includes('Collecting page data')) {\n       foundPrerenderingLine = true\n@@ -37,24 +41,35 @@ export function getPrerenderOutput(\n       !ignoredLines.some((ignoredLine) => line.includes(ignoredLine))\n     ) {\n       if (isMinified) {\n-        line = line\n-          .replace(/at \\S+ \\(.next[^)]+\\)/, replaceNextDistStackFrame)\n-          .replace(/at (\\S+) \\(<anonymous>\\)/, replaceAnonymousStackFrame)\n+        line = line.replace(\n+          /at (\\S+) \\(<anonymous>\\)/,\n+          replaceAnonymousStackFrame\n+        )\n       } else {\n         line = line.replace(\n-          /at (\\S+) \\((webpack:\\/\\/)\\/src[^)]+\\)/,\n+          /at (\\S+) \\((webpack:\\/\\/\\/)src[^)]+\\)/,\n           `at $1 ($2<next-src>)`\n         )\n       }\n \n       line = line\n+        .replace(/at \\S+ \\(.next[^)]+\\)/, replaceNextDistStackFrame)\n+        .replace(\n+          // Single-letter lower-case names are likely minified.\n+          /at [a-z] \\((?!(<next-dist-dir>|<anonymous>))/,\n+          replaceMinifiedName\n+        )\n+        .replace(/at \\d+ \\(/, replaceNumericModuleId)\n         .replace(/digest: '\\d+'/, \"digest: '<error-digest>'\")\n         // Convert a module function sequence expression, e.g.:\n         // - (0 , __TURBOPACK__imported__module__1836__.cookies)(...)\n         // - (0 , c.cookies)(...)\n         // - (0 , cookies.U)(...)\n         // - (0 , e.U)(...)\n         .replace(/\\(0 , \\w+\\.(\\w+)\\)\\(\\.\\.\\.\\)/, '<module-function>()')\n+        // TODO(veil): Bundler protocols should not appear in stack frames.\n+        .replace('webpack:///', 'bundler:///')\n+        .replace('turbopack:///[project]/', 'bundler:///')\n \n       lines.push(line)\n     }"
        },
        {
            "sha": "1998ba3d352a4153ef03046c7411f88b7d616eaa",
            "filename": "test/e2e/app-dir/use-cache-private/app/cookies/page.tsx",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fcookies%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fcookies%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fcookies%2Fpage.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,31 @@\n+import { unstable_cacheLife } from 'next/cache'\n+import { cookies } from 'next/headers'\n+import { Suspense } from 'react'\n+\n+export default function Page() {\n+  return (\n+    <Suspense fallback={<p>Loading...</p>}>\n+      <Private />\n+    </Suspense>\n+  )\n+}\n+\n+async function Private() {\n+  'use cache: private'\n+\n+  unstable_cacheLife({ stale: 420 })\n+  const cookie = (await cookies()).get('test-cookie')\n+\n+  const { headers } = await fetch(\n+    'https://next-data-api-endpoint.vercel.app/api/echo-headers',\n+    { headers: { 'x-test-cookie': cookie?.value ?? '' } }\n+  ).then((res) => res.json() as Promise<{ headers: Record<string, string> }>)\n+\n+  const cookieHeader = headers['x-test-cookie']\n+\n+  return (\n+    <pre>\n+      test-cookie: <span id=\"test-cookie\">{cookieHeader}</span>\n+    </pre>\n+  )\n+}"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/use-cache-private/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Flayout.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "1cdbd1db59709e44ddfbf65fd33f01e84ff969bc",
            "filename": "test/e2e/app-dir/use-cache-private/app/page.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fpage.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,33 @@\n+import { Suspense } from 'react'\n+import { getSentinelValue } from './sentinel'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <PageSentinel />\n+      <Suspense fallback={<p>Loading...</p>}>\n+        <Private />\n+      </Suspense>\n+    </>\n+  )\n+}\n+\n+async function PageSentinel() {\n+  'use cache'\n+\n+  return (\n+    <p>\n+      page: <span id=\"page-sentinel\">{getSentinelValue()}</span>\n+    </p>\n+  )\n+}\n+\n+async function Private() {\n+  'use cache: private'\n+\n+  return (\n+    <p>\n+      private: <span id=\"private-sentinel\">{getSentinelValue()}</span>\n+    </p>\n+  )\n+}"
        },
        {
            "sha": "30ef4c17a7c85fe6d118b908ac96f240a61bc1d4",
            "filename": "test/e2e/app-dir/use-cache-private/app/search-params/loading.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsearch-params%2Floading.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsearch-params%2Floading.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsearch-params%2Floading.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Loading() {\n+  return <p>Loading...</p>\n+}"
        },
        {
            "sha": "d05e61f36504463c441cdd8a51238e720ee3d22a",
            "filename": "test/e2e/app-dir/use-cache-private/app/search-params/page.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsearch-params%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsearch-params%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsearch-params%2Fpage.tsx?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,15 @@\n+export default async function Page({\n+  searchParams,\n+}: {\n+  searchParams: Promise<{ [key: string]: string }>\n+}) {\n+  'use cache: private'\n+\n+  const { q } = await searchParams\n+\n+  return (\n+    <p>\n+      Query: <span id=\"search-param\">{q}</span>\n+    </p>\n+  )\n+}"
        },
        {
            "sha": "4571ba8f47bb8f0b9754bc789cfce6c305160536",
            "filename": "test/e2e/app-dir/use-cache-private/app/sentinel.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsentinel.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsentinel.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fapp%2Fsentinel.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,7 @@\n+const { PHASE_PRODUCTION_BUILD } = require('next/constants')\n+\n+export function getSentinelValue() {\n+  return process.env.NEXT_PHASE === PHASE_PRODUCTION_BUILD\n+    ? 'buildtime'\n+    : 'runtime'\n+}"
        },
        {
            "sha": "b236fa0c14150c1afe9b69ecaaf0176a12c249ac",
            "filename": "test/e2e/app-dir/use-cache-private/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fnext.config.js?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    useCache: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "4e8200900a918bc85310c2545006d5a73e4f4c32",
            "filename": "test/e2e/app-dir/use-cache-private/use-cache-private.test.ts",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fuse-cache-private.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/9dc2d46954772723d8f28d4c7be09d8bcd10fbee/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fuse-cache-private.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-private%2Fuse-cache-private.test.ts?ref=9dc2d46954772723d8f28d4c7be09d8bcd10fbee",
            "patch": "@@ -0,0 +1,42 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+const pprEnabled =\n+  process.env.__NEXT_EXPERIMENTAL_PPR === 'true' ||\n+  process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true'\n+\n+describe('use-cache-private', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('excludes private caches from prerenders', async () => {\n+    const browser = await next.browser('/')\n+\n+    expect(await browser.elementById('page-sentinel').text()).toBe(\n+      isNextDev || !pprEnabled ? 'runtime' : 'buildtime'\n+    )\n+\n+    expect(await browser.elementById('private-sentinel').text()).toBe('runtime')\n+  })\n+\n+  it('allows reading cookies in private caches', async () => {\n+    const browser = await next.browser('/cookies')\n+\n+    expect(await browser.elementById('test-cookie').text()).toBe('')\n+\n+    await browser.addCookie({ name: 'test-cookie', value: 'foo' })\n+    await browser.refresh()\n+\n+    expect(await browser.elementById('test-cookie').text()).toBe('foo')\n+  })\n+\n+  it('allows reading search params in private caches', async () => {\n+    const browser = await next.browser('/search-params?q=foo')\n+\n+    expect(await browser.elementById('search-param').text()).toBe('foo')\n+\n+    await browser.loadPage(new URL('/search-params?q=bar', next.url).href)\n+\n+    expect(await browser.elementById('search-param').text()).toBe('bar')\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 2087,
        "additions": 1714,
        "deletions": 373
    }
}