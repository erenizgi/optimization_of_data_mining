{
    "author": "ztanner",
    "message": "[cache components] persist cache bypass UI until it's disabled (#85190)\n\nPreviously we were only showing this during navigations when caches are\nbypassed. We want to make it clearer that you are in this state and dev\nmight not work as intended while caches are disabled.\n\nThis will show the cache bypass status on initial load and will reset\nthe next time a router action occurs that doesn't bypass cache.\n\n\nhttps://github.com/user-attachments/assets/f82a98c6-b5be-44d0-ba86-e4f7ca7010e4",
    "sha": "47ceda3c141e1afb6ed670fe1f817df7f92e7d45",
    "files": [
        {
            "sha": "b18c56aac6b8135566b9be1941ff709c853312f2",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-indicator/next-logo.tsx",
            "status": "modified",
            "additions": 68,
            "deletions": 16,
            "changes": 84,
            "blob_url": "https://github.com/vercel/next.js/blob/47ceda3c141e1afb6ed670fe1f817df7f92e7d45/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fnext-logo.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/47ceda3c141e1afb6ed670fe1f817df7f92e7d45/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fnext-logo.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fnext-logo.tsx?ref=47ceda3c141e1afb6ed670fe1f817df7f92e7d45",
            "patch": "@@ -45,17 +45,14 @@ export function NextLogo({\n   const isCacheFilling = state.cacheIndicator === 'filling'\n   const isCacheBypassing = state.cacheIndicator === 'bypass'\n \n-  // Determine if we should show any status\n+  // Determine if we should show any status (excluding cache bypass, which renders like error badge)\n   const shouldShowStatus =\n-    state.buildingIndicator ||\n-    state.renderingIndicator ||\n-    isCacheFilling ||\n-    (isCacheBypassing && state.renderingIndicator)\n+    state.buildingIndicator || state.renderingIndicator || isCacheFilling\n \n   // Delay showing for 400ms to catch fast operations,\n   // and keep visible for minimum time (longer for warnings)\n   const { rendered: showStatusIndicator } = useDelayedRender(shouldShowStatus, {\n-    enterDelay: isCacheBypassing && state.renderingIndicator ? 0 : 400, // Bypass warning shows immediately, others delayed\n+    enterDelay: 400,\n     exitDelay: 500,\n   })\n \n@@ -72,7 +69,10 @@ export function NextLogo({\n   const displayStatus = showStatusIndicator ? currentStatus : Status.None\n \n   const isExpanded =\n-    isErrorExpanded || showStatusIndicator || state.disableDevIndicator\n+    isErrorExpanded ||\n+    isCacheBypassing ||\n+    showStatusIndicator ||\n+    state.disableDevIndicator\n   const width = measuredWidth === 0 ? 'auto' : measuredWidth\n \n   return (\n@@ -175,12 +175,12 @@ export function NextLogo({\n               }\n             }\n \n-            &[data-status='cache-bypassing'] {\n-              background: rgba(251, 211, 141, 0.95); /* Warm amber background */\n-              --color-inner-border: rgba(245, 158, 11, 0.8);\n+            &[data-cache-bypassing='true']:not([data-error='true']) {\n+              background: rgba(217, 119, 6, 0.95);\n+              --color-inner-border: rgba(245, 158, 11, 0.9);\n \n-              [data-indicator-status] {\n-                color: rgba(92, 45, 10, 1); /* Dark brown text */\n+              [data-issues-open] {\n+                color: white;\n               }\n             }\n \n@@ -378,7 +378,8 @@ export function NextLogo({\n         data-next-badge\n         data-error={hasError}\n         data-error-expanded={isExpanded}\n-        data-status={hasError ? Status.None : currentStatus}\n+        data-status={hasError || isCacheBypassing ? Status.None : currentStatus}\n+        data-cache-bypassing={isCacheBypassing}\n         data-animate={newErrorDetected}\n         style={{ width }}\n       >\n@@ -397,7 +398,10 @@ export function NextLogo({\n               aria-label={`${isMenuOpen ? 'Close' : 'Open'} Next.js Dev Tools`}\n               data-nextjs-dev-tools-button\n               style={{\n-                display: showStatusIndicator && !hasError ? 'none' : 'flex',\n+                display:\n+                  showStatusIndicator && !hasError && !isCacheBypassing\n+                    ? 'none'\n+                    : 'flex',\n               }}\n               {...buttonProps}\n             >\n@@ -472,11 +476,22 @@ export function NextLogo({\n                   )}\n                 </div>\n               )}\n-              {/* Status indicator shown when no errors */}\n+              {/* Cache bypass badge shown when cache is being bypassed */}\n+              {isCacheBypassing && !hasError && !state.disableDevIndicator && (\n+                <CacheBypassBadge\n+                  onTriggerClick={onTriggerClick}\n+                  triggerRef={triggerRef}\n+                />\n+              )}\n+              {/* Status indicator shown when no errors and no cache bypass */}\n               {showStatusIndicator &&\n                 !hasError &&\n+                !isCacheBypassing &&\n                 !state.disableDevIndicator && (\n-                  <StatusIndicator status={displayStatus} />\n+                  <StatusIndicator\n+                    status={displayStatus}\n+                    onClick={onTriggerClick}\n+                  />\n                 )}\n             </>\n           )}\n@@ -507,6 +522,43 @@ function AnimateCount({\n   )\n }\n \n+function CacheBypassBadge({\n+  onTriggerClick,\n+  triggerRef,\n+}: {\n+  onTriggerClick: () => void\n+  triggerRef: React.RefObject<HTMLButtonElement | null>\n+}) {\n+  const [dismissed, setDismissed] = useState(false)\n+\n+  if (dismissed) {\n+    return null\n+  }\n+\n+  return (\n+    <div data-issues data-cache-bypass-badge>\n+      <button\n+        data-issues-open\n+        aria-label=\"Open Next.js Dev Tools\"\n+        onClick={onTriggerClick}\n+      >\n+        Cache disabled\n+      </button>\n+      <button\n+        data-issues-collapse\n+        aria-label=\"Collapse cache bypass badge\"\n+        onClick={() => {\n+          setDismissed(true)\n+          // Move focus to the trigger to prevent having it stuck on this element\n+          triggerRef.current?.focus()\n+        }}\n+      >\n+        <Cross data-cross />\n+      </button>\n+    </div>\n+  )\n+}\n+\n function NextMark() {\n   return (\n     <svg width=\"40\" height=\"40\" viewBox=\"0 0 40 40\" fill=\"none\">"
        },
        {
            "sha": "f100a6b06c4fae276a4ac04e6ab7ae00cc0c59da",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-indicator/status-indicator.tsx",
            "status": "modified",
            "additions": 31,
            "deletions": 15,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/47ceda3c141e1afb6ed670fe1f817df7f92e7d45/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fstatus-indicator.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/47ceda3c141e1afb6ed670fe1f817df7f92e7d45/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fstatus-indicator.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-indicator%2Fstatus-indicator.tsx?ref=47ceda3c141e1afb6ed670fe1f817df7f92e7d45",
            "patch": "@@ -15,18 +15,15 @@ export function getCurrentStatus(\n   cacheIndicator: CacheIndicatorState\n ): Status {\n   const isCacheFilling = cacheIndicator === 'filling'\n-  const isCacheBypassing = cacheIndicator === 'bypass'\n \n-  // Priority order: cache bypassing > prerendering > compiling > rendering\n-  if (isCacheBypassing && renderingIndicator) {\n-    return Status.CacheBypassing\n+  // Priority order: compiling > prerendering > rendering\n+  // Note: cache bypassing is now handled as a badge, not a status indicator\n+  if (buildingIndicator) {\n+    return Status.Compiling\n   }\n   if (isCacheFilling) {\n     return Status.Prerendering\n   }\n-  if (buildingIndicator) {\n-    return Status.Compiling\n-  }\n   if (renderingIndicator) {\n     return Status.Rendering\n   }\n@@ -35,9 +32,10 @@ export function getCurrentStatus(\n \n interface StatusIndicatorProps {\n   status: Status\n+  onClick?: () => void\n }\n \n-export function StatusIndicator({ status }: StatusIndicatorProps) {\n+export function StatusIndicator({ status, onClick }: StatusIndicatorProps) {\n   const statusText: Record<Status, string> = {\n     [Status.None]: '',\n     [Status.CacheBypassing]: 'Cache disabled',\n@@ -78,6 +76,15 @@ export function StatusIndicator({ status }: StatusIndicatorProps) {\n             font-size: var(--size-13);\n             font-weight: 500;\n             white-space: nowrap;\n+            border: none;\n+            background: transparent;\n+            cursor: pointer;\n+            outline: none;\n+          }\n+\n+          [data-indicator-status]:focus-visible {\n+            outline: 2px solid var(--color-blue-800, #3b82f6);\n+            outline-offset: 3px;\n           }\n \n           [data-status-dot] {\n@@ -149,7 +156,11 @@ export function StatusIndicator({ status }: StatusIndicatorProps) {\n           }\n         `}\n       </style>\n-      <div data-indicator-status>\n+      <button\n+        data-indicator-status\n+        onClick={onClick}\n+        aria-label=\"Open Next.js Dev Tools\"\n+      >\n         {statusDotColor[status] && (\n           <div\n             data-status-dot\n@@ -161,29 +172,34 @@ export function StatusIndicator({ status }: StatusIndicatorProps) {\n         <AnimateStatusText\n           key={status} // Key here triggers re-mount and animation\n           statusKey={status}\n+          showEllipsis={status !== Status.CacheBypassing}\n         >\n           {statusText[status]}\n         </AnimateStatusText>\n-      </div>\n+      </button>\n     </>\n   )\n }\n \n function AnimateStatusText({\n   children: text,\n+  showEllipsis = true,\n }: {\n   children: string\n   statusKey?: string // Keep for type compatibility but unused\n+  showEllipsis?: boolean\n }) {\n   return (\n     <div data-status-text-animation>\n       <div data-status-text-enter>\n         {text}\n-        <span data-status-ellipsis>\n-          <span>.</span>\n-          <span>.</span>\n-          <span>.</span>\n-        </span>\n+        {showEllipsis && (\n+          <span data-status-ellipsis>\n+            <span>.</span>\n+            <span>.</span>\n+            <span>.</span>\n+          </span>\n+        )}\n       </div>\n     </div>\n   )"
        },
        {
            "sha": "8d851d706627090e54d269acd4a4078d684ce058",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/47ceda3c141e1afb6ed670fe1f817df7f92e7d45/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/47ceda3c141e1afb6ed670fe1f817df7f92e7d45/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=47ceda3c141e1afb6ed670fe1f817df7f92e7d45",
            "patch": "@@ -2477,6 +2477,10 @@ async function renderToStream(\n         if (isBypassingCachesInDev(renderOpts, requestStore)) {\n           // Mark the RSC payload to indicate that caches were bypassed in dev.\n           // This lets the client know not to cache anything based on this render.\n+          if (renderOpts.setCacheStatus) {\n+            // we know this is available  when cacheComponents is enabled, but typeguard to be safe\n+            renderOpts.setCacheStatus('bypass', htmlRequestId, requestId)\n+          }\n           payload._bypassCachesInDev = createElement(WarnForBypassCachesInDev, {\n             route: workStore.route,\n           })"
        },
        {
            "sha": "06b0ba94b329aef4b4cfa4a122b1fcf2b79a56ae",
            "filename": "test/development/app-dir/cache-indicator/cache-indicator.test.ts",
            "status": "modified",
            "additions": 123,
            "deletions": 0,
            "changes": 123,
            "blob_url": "https://github.com/vercel/next.js/blob/47ceda3c141e1afb6ed670fe1f817df7f92e7d45/test%2Fdevelopment%2Fapp-dir%2Fcache-indicator%2Fcache-indicator.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/47ceda3c141e1afb6ed670fe1f817df7f92e7d45/test%2Fdevelopment%2Fapp-dir%2Fcache-indicator%2Fcache-indicator.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fcache-indicator%2Fcache-indicator.test.ts?ref=47ceda3c141e1afb6ed670fe1f817df7f92e7d45",
            "patch": "@@ -39,5 +39,128 @@ describe('cache-indicator', () => {\n       const status = await badge.getAttribute('data-status')\n       expect(status).toBe('none')\n     })\n+\n+    it('shows cache-bypassing badge when cache is disabled', async () => {\n+      const browser = await next.browser('/', {\n+        extraHTTPHeaders: { 'cache-control': 'no-cache' },\n+      })\n+\n+      // Wait for the badge to appear and show cache-bypassing status\n+      await retry(async () => {\n+        const badge = await browser.elementByCss('[data-next-badge]')\n+        const cacheBypassingAttr = await badge.getAttribute(\n+          'data-cache-bypassing'\n+        )\n+        expect(cacheBypassingAttr).toBe('true')\n+      })\n+\n+      // Verify the cache bypass badge is visible\n+      await retry(async () => {\n+        const hasCacheBypassBadge = await browser.hasElementByCss(\n+          '[data-cache-bypass-badge]'\n+        )\n+        expect(hasCacheBypassBadge).toBe(true)\n+      })\n+\n+      // Verify the badge shows \"Cache disabled\" text\n+      const badgeButton = await browser.elementByCss(\n+        '[data-cache-bypass-badge] [data-issues-open]'\n+      )\n+      const badgeText = await badgeButton.text()\n+      expect(badgeText).toBe('Cache disabled')\n+    })\n+\n+    it('persists cache-bypassing badge after navigation when cache is disabled', async () => {\n+      const browser = await next.browser('/', {\n+        extraHTTPHeaders: { 'cache-control': 'no-cache' },\n+      })\n+\n+      // Wait for initial cache-bypassing badge\n+      await retry(async () => {\n+        const hasCacheBypassBadge = await browser.hasElementByCss(\n+          '[data-cache-bypass-badge]'\n+        )\n+        expect(hasCacheBypassBadge).toBe(true)\n+      })\n+\n+      // Navigate to another page\n+      const link = await browser.waitForElementByCss('a[href=\"/navigation\"]')\n+      await link.click()\n+\n+      // Wait for navigation to complete\n+      await retry(async () => {\n+        const text = await browser.elementByCss('#navigation-page').text()\n+        expect(text).toContain('Hello navigation page!')\n+      })\n+\n+      // Verify cache-bypassing badge persists after navigation\n+      await retry(async () => {\n+        const hasCacheBypassBadge = await browser.hasElementByCss(\n+          '[data-cache-bypass-badge]'\n+        )\n+        expect(hasCacheBypassBadge).toBe(true)\n+      })\n+\n+      // Verify the badge still shows \"Cache disabled\" text\n+      const badgeButton = await browser.elementByCss(\n+        '[data-cache-bypass-badge] [data-issues-open]'\n+      )\n+      const badgeText = await badgeButton.text()\n+      expect(badgeText).toBe('Cache disabled')\n+    })\n+\n+    it('opens devtools menu when clicking cache-bypassing badge', async () => {\n+      const browser = await next.browser('/', {\n+        extraHTTPHeaders: { 'cache-control': 'no-cache' },\n+      })\n+\n+      // Wait for the cache-bypassing badge to appear\n+      await retry(async () => {\n+        const hasCacheBypassBadge = await browser.hasElementByCss(\n+          '[data-cache-bypass-badge]'\n+        )\n+        expect(hasCacheBypassBadge).toBe(true)\n+      })\n+\n+      // Click the cache bypass badge\n+      const badgeButton = await browser.elementByCss(\n+        '[data-cache-bypass-badge] [data-issues-open]'\n+      )\n+      await badgeButton.click()\n+\n+      // Verify devtools menu opens\n+      await retry(async () => {\n+        const hasMenu = await browser.hasElementByCss('#nextjs-dev-tools-menu')\n+        expect(hasMenu).toBe(true)\n+      })\n+    })\n+\n+    it('can dismiss cache-bypassing badge', async () => {\n+      const browser = await next.browser('/', {\n+        extraHTTPHeaders: { 'cache-control': 'no-cache' },\n+      })\n+\n+      // Wait for the cache-bypassing badge to appear\n+      await retry(async () => {\n+        const hasCacheBypassBadge = await browser.hasElementByCss(\n+          '[data-cache-bypass-badge]'\n+        )\n+        expect(hasCacheBypassBadge).toBe(true)\n+      })\n+\n+      // Click the collapse button\n+      const collapseButton = await browser.elementByCss(\n+        '[data-cache-bypass-badge] [data-issues-collapse]'\n+      )\n+      await collapseButton.click()\n+\n+      // Verify badge is dismissed\n+      await retry(async () => {\n+        const hasCacheBypassBadge = await browser.hasElementByCss(\n+          '[data-cache-bypass-badge]'\n+        )\n+        expect(hasCacheBypassBadge).toBe(false)\n+      })\n+    })\n   }\n })"
        }
    ],
    "stats": {
        "total": 257,
        "additions": 226,
        "deletions": 31
    }
}