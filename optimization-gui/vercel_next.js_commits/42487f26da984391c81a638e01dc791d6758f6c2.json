{
    "author": "lpalmes",
    "message": "fix: preload fonts in template.js (#79417)\n\nFonts imported in a template module do not preload or preconnect when\nused in a template.js file. This PR adds a small fix and a e2e test.\n\nCo-authored-by: Zack Tanner <1939140+ztanner@users.noreply.github.com>",
    "sha": "42487f26da984391c81a638e01dc791d6758f6c2",
    "files": [
        {
            "sha": "4e860e894eb4f9314b46a71c3aa82a277b8bc5bc",
            "filename": "packages/next/src/server/app-render/parse-loader-tree.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/42487f26da984391c81a638e01dc791d6758f6c2/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fparse-loader-tree.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42487f26da984391c81a638e01dc791d6758f6c2/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fparse-loader-tree.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fparse-loader-tree.ts?ref=42487f26da984391c81a638e01dc791d6758f6c2",
            "patch": "@@ -3,13 +3,13 @@ import type { LoaderTree } from '../lib/app-dir-module'\n \n export function parseLoaderTree(tree: LoaderTree) {\n   const [segment, parallelRoutes, modules] = tree\n-  const { layout } = modules\n+  const { layout, template } = modules\n   let { page } = modules\n   // a __DEFAULT__ segment means that this route didn't match any of the\n   // segments in the route, so we should use the default page\n   page = segment === DEFAULT_SEGMENT_KEY ? modules.defaultPage : page\n \n-  const layoutOrPagePath = layout?.[1] || page?.[1]\n+  const layoutOrPagePath = layout?.[1] || template?.[1] || page?.[1]\n \n   return {\n     page,"
        },
        {
            "sha": "c533eec648c9bfc8cfe51bd5f0cd2ee3f460c599",
            "filename": "test/e2e/app-dir/next-font/app/(preconnect)/preconnect-template/layout-font-rubik.woff2",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Flayout-font-rubik.woff2",
            "raw_url": "https://github.com/vercel/next.js/raw/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Flayout-font-rubik.woff2",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Flayout-font-rubik.woff2?ref=42487f26da984391c81a638e01dc791d6758f6c2"
        },
        {
            "sha": "c17431379f962fe20c05804b55df0aadc97b97d5",
            "filename": "test/e2e/app-dir/next-font/app/(preconnect)/preconnect-template/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Fpage.js?ref=42487f26da984391c81a638e01dc791d6758f6c2",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "860dcf673d2c1b8e599ddf59fe942620825e9edf",
            "filename": "test/e2e/app-dir/next-font/app/(preconnect)/preconnect-template/template.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Ftemplate.js",
            "raw_url": "https://github.com/vercel/next.js/raw/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Ftemplate.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preconnect)%2Fpreconnect-template%2Ftemplate.js?ref=42487f26da984391c81a638e01dc791d6758f6c2",
            "patch": "@@ -0,0 +1,15 @@\n+import localFont from 'next/font/local'\n+\n+const layoutFont = localFont({\n+  src: './layout-font-rubik.woff2',\n+  preload: false,\n+})\n+\n+export default function Layout({ children }) {\n+  return (\n+    <>\n+      <p className={layoutFont.className}>{JSON.stringify(layoutFont)}</p>\n+      {children}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "5766597fb51e63963ffd4eb4a7fcbbac76a3c481",
            "filename": "test/e2e/app-dir/next-font/app/(preload)/template-with-fonts/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Fpage.js?ref=42487f26da984391c81a638e01dc791d6758f6c2",
            "patch": "@@ -0,0 +1,3 @@\n+export default function HomePage() {\n+  return <p>Only template</p>\n+}"
        },
        {
            "sha": "f0b6b89456ac62f1204f33731dc478aeff246825",
            "filename": "test/e2e/app-dir/next-font/app/(preload)/template-with-fonts/template-font-nunito-sans.woff2",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Ftemplate-font-nunito-sans.woff2",
            "raw_url": "https://github.com/vercel/next.js/raw/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Ftemplate-font-nunito-sans.woff2",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Ftemplate-font-nunito-sans.woff2?ref=42487f26da984391c81a638e01dc791d6758f6c2"
        },
        {
            "sha": "a4c41148c2958e4aa0b5732272de0d749f08ae93",
            "filename": "test/e2e/app-dir/next-font/app/(preload)/template-with-fonts/template.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Ftemplate.js",
            "raw_url": "https://github.com/vercel/next.js/raw/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Ftemplate.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fapp%2F(preload)%2Ftemplate-with-fonts%2Ftemplate.js?ref=42487f26da984391c81a638e01dc791d6758f6c2",
            "patch": "@@ -0,0 +1,14 @@\n+import localFont from 'next/font/local'\n+\n+const templateFont = localFont({ src: './template-font-nunito-sans.woff2' })\n+\n+export default function Template({ children }) {\n+  return (\n+    <>\n+      <p id=\"template-with-fonts\" className={templateFont.className}>\n+        {JSON.stringify(templateFont)}\n+      </p>\n+      {children}\n+    </>\n+  )\n+}"
        },
        {
            "sha": "90906a3731a568c0603d0adb6dbbb49688b1aaa9",
            "filename": "test/e2e/app-dir/next-font/next-font.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 1,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fnext-font.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/42487f26da984391c81a638e01dc791d6758f6c2/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fnext-font.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fnext-font%2Fnext-font.test.ts?ref=42487f26da984391c81a638e01dc791d6758f6c2",
            "patch": "@@ -352,6 +352,31 @@ describe('app dir - next/font', () => {\n           }\n         })\n \n+        it('should preload correctly with template using fonts', async () => {\n+          const $ = await next.render$('/template-with-fonts')\n+\n+          // Preconnect\n+          expect($('link[rel=\"preconnect\"]').length).toBe(0)\n+\n+          const links = getAttrs($('link[as=\"font\"]'))\n+\n+          for (const link of links) {\n+            expect(link.as).toBe('font')\n+            expect(link.crossorigin).toBe('')\n+            if (process.env.IS_TURBOPACK_TEST) {\n+              expect(link.href).toMatch(\n+                /\\/_next\\/static\\/media\\/(.*)-s.p.(.*)\\.woff2/\n+              )\n+            } else {\n+              expect(link.href).toMatch(\n+                /\\/_next\\/static\\/media\\/(.*)-s.p.woff2/\n+              )\n+            }\n+            expect(link.rel).toBe('preload')\n+            expect(link.type).toBe('font/woff2')\n+          }\n+        })\n+\n         it('should preload correctly with page using fonts', async () => {\n           const $ = await next.render$('/page-with-fonts')\n \n@@ -379,7 +404,7 @@ describe('app dir - next/font', () => {\n       })\n \n       describe('preconnect', () => {\n-        it.each([['page'], ['layout'], ['component']])(\n+        it.each([['page'], ['layout'], ['component'], ['template']])(\n           'should add preconnect when preloading is disabled in %s',\n           async (type: string) => {\n             const $ = await next.render$(`/preconnect-${type}`)"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 63,
        "deletions": 3
    }
}