{
    "author": "Netail",
    "message": "fix: absolute assetPrefix url with path (#77256)\n\n### What?\n\nWhen an absolute url with path has been set as the assetPrefix, the path\nis not used when serving the bundles. Instead the bundles are served\ndirectly on the root. The rewrite did not seem to take a path into\naccount, only a host.\n\ne.g. when the assetPrefix is set to\n`https://example.vercel.sh/custom-asset-prefix`, it does not serve the\nbundles from `<host>/custom-asset-prefix/_next/*` instead only from\n`<host>/_next/*`\n\nRelated; https://github.com/vercel/next.js/discussions/77118\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "413fbd600dce9abc4de34dbfd87e865fa40d0cd8",
    "files": [
        {
            "sha": "a4026d7180988a473e030e73e855072b3d0e2fe8",
            "filename": "packages/next/src/lib/load-custom-routes.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 1,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.test.ts?ref=413fbd600dce9abc4de34dbfd87e865fa40d0cd8",
            "patch": "@@ -144,12 +144,25 @@ describe('loadCustomRoutes', () => {\n \n       it('does not insert assetPrefix rewrite for /_next/ paths when assetPrefix is absolute URL', async () => {\n         const customRoutes = await loadCustomRoutes({\n-          assetPrefix: 'https://example.com/custom-asset-prefix',\n+          assetPrefix: 'https://example.com',\n         })\n         expect(customRoutes.rewrites.beforeFiles).toEqual([])\n         expect(customRoutes.rewrites.afterFiles).toEqual([])\n       })\n \n+      it('automatically insert assetPrefix rewrite for /_next/ paths when assetPrefix is absolute URL with a path', async () => {\n+        const customRoutes = await loadCustomRoutes({\n+          assetPrefix: 'https://example.com/custom-asset-prefix',\n+        })\n+        expect(customRoutes.rewrites.beforeFiles).toEqual([\n+          {\n+            destination: '/_next/:path+',\n+            source: '/custom-asset-prefix/_next/:path+',\n+          },\n+        ])\n+        expect(customRoutes.rewrites.afterFiles).toEqual([])\n+      })\n+\n       it('does not add rewrite when assetPrefix === basePath', async () => {\n         const customRoutes = await loadCustomRoutes({\n           assetPrefix: '/base',"
        },
        {
            "sha": "45ba81a3fe90e7fba3c7a18d161b864db22cbd04",
            "filename": "packages/next/src/lib/load-custom-routes.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 12,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fload-custom-routes.ts?ref=413fbd600dce9abc4de34dbfd87e865fa40d0cd8",
            "patch": "@@ -596,19 +596,28 @@ async function loadRewrites(config: NextConfig) {\n   // If assetPrefix is set, add a rewrite for `/${assetPrefix}/_next/*`\n   // requests so that they are handled in any of dev, start, or deploy\n   // automatically without the user having to configure this.\n-  // If the assetPrefix is an absolute URL, we can't add an automatic rewrite.\n+  // If the assetPrefix is an absolute URL, we still consider the path for automatic rewrite.\n+  // but hostname routing must be handled by the user\n   let maybeAssetPrefixRewrite: Rewrite[] = []\n-  if (config.assetPrefix && !isFullStringUrl(config.assetPrefix)) {\n-    const assetPrefix = config.assetPrefix.startsWith('/')\n-      ? config.assetPrefix\n-      : `/${config.assetPrefix}`\n-    const basePath = config.basePath || ''\n-    // If these are the same, then this would result in an infinite rewrite.\n-    if (assetPrefix !== basePath) {\n-      maybeAssetPrefixRewrite.push({\n-        source: `${assetPrefix}/_next/:path+`,\n-        destination: `${basePath}/_next/:path+`,\n-      })\n+  if (config.assetPrefix) {\n+    let prefix = config.assetPrefix\n+    if (\n+      isFullStringUrl(config.assetPrefix) &&\n+      URL.canParse(config.assetPrefix)\n+    ) {\n+      prefix = new URL(config.assetPrefix).pathname\n+    }\n+\n+    if (prefix && prefix !== '/') {\n+      const assetPrefix = prefix.startsWith('/') ? prefix : `/${prefix}`\n+      const basePath = config.basePath || ''\n+      // If these are the same, then this would result in an infinite rewrite.\n+      if (assetPrefix !== basePath) {\n+        maybeAssetPrefixRewrite.push({\n+          source: `${assetPrefix}/_next/:path+`,\n+          destination: `${basePath}/_next/:path+`,\n+        })\n+      }\n     }\n   }\n "
        },
        {
            "sha": "05b841b280b3fc7b67968b972fc5e6a7c8df26f0",
            "filename": "test/e2e/app-dir/asset-prefix-absolute/app/layout.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fapp%2Flayout.js?ref=413fbd600dce9abc4de34dbfd87e865fa40d0cd8",
            "patch": "@@ -0,0 +1,10 @@\n+export default function Root({ children }) {\n+  return (\n+    <html>\n+      <head>\n+        <title>Hello</title>\n+      </head>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "951ed667114021fef6bf444a13f7404f7b39144e",
            "filename": "test/e2e/app-dir/asset-prefix-absolute/app/page.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fapp%2Fpage.js?ref=413fbd600dce9abc4de34dbfd87e865fa40d0cd8",
            "patch": "@@ -0,0 +1,3 @@\n+export default function HomePage() {\n+  return <p>Hello world</p>\n+}"
        },
        {
            "sha": "d068e3394916e3339affbcbc8092879d03a95d50",
            "filename": "test/e2e/app-dir/asset-prefix-absolute/asset-prefix-absolute.test.ts",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fasset-prefix-absolute.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fasset-prefix-absolute.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fasset-prefix-absolute.test.ts?ref=413fbd600dce9abc4de34dbfd87e865fa40d0cd8",
            "patch": "@@ -0,0 +1,33 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('app-dir absolute assetPrefix', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('bundles should return 200 on served assetPrefix', async () => {\n+    const $ = await next.render$('/')\n+\n+    let bundles = []\n+    for (const script of $('script').toArray()) {\n+      const { src } = script.attribs\n+      if (\n+        src?.includes(\n+          'https://example.vercel.sh/custom-asset-prefix/_next/static'\n+        )\n+      ) {\n+        bundles.push(src)\n+      }\n+    }\n+\n+    expect(bundles.length).toBeGreaterThan(0)\n+\n+    for (const src of bundles) {\n+      // Remove hostname to check if pathname is still used for serving the bundles\n+      const bundlePathWithoutHost = decodeURI(new URL(src).pathname)\n+      const { status } = await next.fetch(bundlePathWithoutHost)\n+\n+      expect(status).toBe(200)\n+    }\n+  })\n+})"
        },
        {
            "sha": "6425e40142f48acca28778bd246dbb9e9a99c288",
            "filename": "test/e2e/app-dir/asset-prefix-absolute/next.config.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/413fbd600dce9abc4de34dbfd87e865fa40d0cd8/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fasset-prefix-absolute%2Fnext.config.js?ref=413fbd600dce9abc4de34dbfd87e865fa40d0cd8",
            "patch": "@@ -0,0 +1,3 @@\n+module.exports = {\n+  assetPrefix: 'https://example.vercel.sh/custom-asset-prefix',\n+}"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 84,
        "deletions": 13
    }
}