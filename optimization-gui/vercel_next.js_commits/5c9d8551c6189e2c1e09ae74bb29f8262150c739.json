{
    "author": "fireairforce",
    "message": "fix(turbopack): external module shouldn't wrap by esm when type as global (#82374)\n\nWhen use externalType: `global` or `script` under utoopack(turbopack\nonly use esm or cjs external): like externalType is global , and the\nexternal package is react.\n\nThe generate external module code like:\n\n```ts\n263: ((__turbopack_context__) => {\n\"use strict\";\n\nconst mod = globalThis[\"react\"];\n\n__turbopack_context__.n(mod);\n}),\n```\n\nThe real function of runtime code `__turbopack_context__.n` is\n`exportNamespace`, its code as follows:\n\n```ts\nmodule.exports = module.namespaceObject = namespace\n```\n\nAnd when we import the module as following:\n\n```ts\nimport react from \"react\";\n\nconsole.log(react.version);\n```\n\nit will be bundled as:\n\n```ts\nvar __TURBOPACK__imported__module__263__ = __turbopack_context__.i(263);\n\nconsole.log(__TURBOPACK__imported__module__263__[\"default\"]);\n```\n\nThe `__turbopack_context__i` is esmImport, it will return the module\nwhen the module contains `namespaceObject` without `interopEsm`:\n\n```ts\nfunction esmImport() {\n  const module = getOrInstantiateModuleFromParent(id, this.m)\n\n  // any ES module has to have `module.namespaceObject` defined.\n  if (module.namespaceObject) return module.namespaceObject\n\n  return interopEsm();\n}\n```\n\nSo the following case if we use a react umd module(which doesn't have a\n`default export`) as our external package, code\n`console.log(__TURBOPACK__imported__module__263__[\"default\"]);` will\noutput `undefined`(which webpack can output the right version).\n\nI just change export wrapper the externalType: global and script\nhere(which now only consumed by utoopack), so the esmImport will execute\n`interopEsm` function here to make our code work fine.\n\nWe test the case under utoopack and here is our pr:\nhttps://github.com/umijs/mako/pull/2097/files.\n\n---------\n\nCo-authored-by: Niklas Mischkulnig <4586894+mischnic@users.noreply.github.com>",
    "sha": "5c9d8551c6189e2c1e09ae74bb29f8262150c739",
    "files": [
        {
            "sha": "86e58d539d754372f490ff8747f5b8f5dc2f1034",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/external_module.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5c9d8551c6189e2c1e09ae74bb29f8262150c739/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c9d8551c6189e2c1e09ae74bb29f8262150c739/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs?ref=5c9d8551c6189e2c1e09ae74bb29f8262150c739",
            "patch": "@@ -28,8 +28,8 @@ use crate::{\n     },\n     references::async_module::{AsyncModule, OptionAsyncModule},\n     runtime_functions::{\n-        TURBOPACK_EXPORT_NAMESPACE, TURBOPACK_EXTERNAL_IMPORT, TURBOPACK_EXTERNAL_REQUIRE,\n-        TURBOPACK_LOAD_BY_URL,\n+        TURBOPACK_EXPORT_NAMESPACE, TURBOPACK_EXPORT_VALUE, TURBOPACK_EXTERNAL_IMPORT,\n+        TURBOPACK_EXTERNAL_REQUIRE, TURBOPACK_LOAD_BY_URL,\n     },\n     utils::StringifyJs,\n };\n@@ -193,8 +193,12 @@ impl CachedExternalModule {\n \n         if self.external_type == CachedExternalType::CommonJs {\n             writeln!(code, \"module.exports = mod;\")?;\n-        } else {\n+        } else if self.external_type == CachedExternalType::EcmaScriptViaImport\n+            || self.external_type == CachedExternalType::EcmaScriptViaRequire\n+        {\n             writeln!(code, \"{TURBOPACK_EXPORT_NAMESPACE}(mod);\")?;\n+        } else {\n+            writeln!(code, \"{TURBOPACK_EXPORT_VALUE}(mod);\")?;\n         }\n \n         Ok(EcmascriptModuleContent {"
        },
        {
            "sha": "ce2bd3875a3fad6452b144b254e61a3f735966eb",
            "filename": "turbopack/crates/turbopack-tests/js/jest-entry.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/5c9d8551c6189e2c1e09ae74bb29f8262150c739/turbopack%2Fcrates%2Fturbopack-tests%2Fjs%2Fjest-entry.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c9d8551c6189e2c1e09ae74bb29f8262150c739/turbopack%2Fcrates%2Fturbopack-tests%2Fjs%2Fjest-entry.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Fjs%2Fjest-entry.ts?ref=5c9d8551c6189e2c1e09ae74bb29f8262150c739",
            "patch": "@@ -10,6 +10,10 @@ function setupGlobals() {\n   // @ts-ignore Property 'expect' does not exist on type 'typeof globalThis'\n   globalThis.expect = expectMod.expect\n \n+  // Set up global external values for testing\n+  // @ts-ignore Property 'testGlobalExternalValue' does not exist on type 'typeof globalThis'\n+  globalThis.testGlobalExternalValue = { bar: '11' }\n+\n   // From https://github.com/webpack/webpack/blob/9fcaa243573005d6fdece9a3f8d89a0e8b399613/test/TestCases.template.js#L422\n   globalThis.nsObj = function nsObj(obj) {\n     Object.defineProperty(obj, Symbol.toStringTag, {"
        },
        {
            "sha": "064d872a626fa8f7306ef103f13915134a8912a9",
            "filename": "turbopack/crates/turbopack-tests/tests/execution.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5c9d8551c6189e2c1e09ae74bb29f8262150c739/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c9d8551c6189e2c1e09ae74bb29f8262150c739/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution.rs?ref=5c9d8551c6189e2c1e09ae74bb29f8262150c739",
            "patch": "@@ -377,6 +377,11 @@ async fn run_test_operation(prepared_test: ResolvedVc<PreparedTest>) -> Result<V\n         ImportMapping::External(None, ExternalType::CommonJs, ExternalTraced::Untraced)\n             .resolved_cell(),\n     );\n+    import_map.insert_exact_alias(\n+        rcstr!(\"testGlobalExternalValue\"),\n+        ImportMapping::External(None, ExternalType::Global, ExternalTraced::Untraced)\n+            .resolved_cell(),\n+    );\n \n     let remove_unused_exports = options.remove_unused_exports.unwrap_or(true);\n "
        },
        {
            "sha": "e2bd5299d5e05cef344a27d3a419a656f530d797",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/global-external/input/index.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/5c9d8551c6189e2c1e09ae74bb29f8262150c739/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fglobal-external%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c9d8551c6189e2c1e09ae74bb29f8262150c739/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fglobal-external%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fglobal-external%2Finput%2Findex.js?ref=5c9d8551c6189e2c1e09ae74bb29f8262150c739",
            "patch": "@@ -0,0 +1,6 @@\n+import foo from 'testGlobalExternalValue'\n+\n+it('should access global external values', () => {\n+  expect(foo).toEqual({ bar: '11' })\n+  expect(foo.bar).toBe('11')\n+})"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 22,
        "deletions": 3
    }
}