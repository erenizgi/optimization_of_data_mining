{
    "author": "bgw",
    "message": "refactor(HMR clients): Encapsulate some of the turbopack state tracking into a shared TurbopackHmr class (#76994)\n\nThere are multiple bits of state that we must track in the Turbopack HMR client, so this groups them together into a single class.\n\nThe motivation here is that the next PR adds more state that we'd also like to encapsulate in the same place.",
    "sha": "afcea7b5a2f9c42a912111b5e5856693c5ec41e4",
    "files": [
        {
            "sha": "44c4b9e591cefeee5ac67905762b21c353b3a349",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/hot-reloader-client.tsx",
            "status": "modified",
            "additions": 26,
            "deletions": 20,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/afcea7b5a2f9c42a912111b5e5856693c5ec41e4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/afcea7b5a2f9c42a912111b5e5856693c5ec41e4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx?ref=afcea7b5a2f9c42a912111b5e5856693c5ec41e4",
            "patch": "@@ -42,7 +42,6 @@ import type {\n   HMR_ACTION_TYPES,\n   TurbopackMsgToBrowser,\n } from '../../../../server/dev/hot-reloader-types'\n-import { extractModulesFromTurbopackMessage } from '../../../../server/dev/extract-modules-from-turbopack-message'\n import { REACT_REFRESH_FULL_RELOAD_FROM_ERROR } from '../shared'\n import type { HydrationErrorState } from '../../errors/hydration-error-info'\n import type { DebugInfo } from '../types'\n@@ -53,6 +52,7 @@ import { handleDevBuildIndicatorHmrEvents } from '../../../dev/dev-build-indicat\n import type { GlobalErrorComponent } from '../../error-boundary'\n import type { DevIndicatorServerState } from '../../../../server/dev/dev-indicator-server-state'\n import reportHmrLatency from '../utils/report-hmr-latency'\n+import { TurbopackHmr } from '../utils/turbopack-hot-reloader-common'\n \n export interface Dispatcher {\n   onBuildOk(): void\n@@ -68,9 +68,10 @@ export interface Dispatcher {\n let mostRecentCompilationHash: any = null\n let __nextDevClientId = Math.round(Math.random() * 100 + Date.now())\n let reloading = false\n-let startLatency: number | null = null\n-let turbopackLastUpdateLatency: number | null = null\n-let turbopackUpdatedModules: Set<string> = new Set()\n+let webpackStartMsSinceEpoch: number | null = null\n+const turbopackHmr: TurbopackHmr | null = process.env.TURBOPACK\n+  ? new TurbopackHmr()\n+  : null\n \n let pendingHotUpdateWebpack = Promise.resolve()\n let resolvePendingHotUpdateWebpack: () => void = () => {}\n@@ -93,7 +94,12 @@ function handleSuccessfulHotUpdateWebpack(\n ) {\n   resolvePendingHotUpdateWebpack()\n   dispatcher.onBuildOk()\n-  reportHmrLatency(sendMessage, updatedModules, startLatency!, Date.now())\n+  reportHmrLatency(\n+    sendMessage,\n+    updatedModules,\n+    webpackStartMsSinceEpoch!,\n+    Date.now()\n+  )\n \n   dispatcher.onRefresh()\n }\n@@ -172,7 +178,7 @@ function tryApplyUpdates(\n   if (!isUpdateAvailable() || !canApplyUpdates()) {\n     resolvePendingHotUpdateWebpack()\n     dispatcher.onBuildOk()\n-    reportHmrLatency(sendMessage, [], startLatency!, Date.now())\n+    reportHmrLatency(sendMessage, [], webpackStartMsSinceEpoch!, Date.now())\n     return\n   }\n \n@@ -282,13 +288,16 @@ function processMessage(\n \n   function handleHotUpdate() {\n     if (process.env.TURBOPACK) {\n+      const hmrUpdate = turbopackHmr!.onBuilt()\n+      if (hmrUpdate != null) {\n+        reportHmrLatency(\n+          sendMessage,\n+          [...hmrUpdate.updatedModules],\n+          hmrUpdate.startMsSinceEpoch,\n+          hmrUpdate.endMsSinceEpoch\n+        )\n+      }\n       dispatcher.onBuildOk()\n-      reportHmrLatency(\n-        sendMessage,\n-        [...turbopackUpdatedModules],\n-        startLatency!,\n-        turbopackLastUpdateLatency ?? Date.now()\n-      )\n     } else {\n       tryApplyUpdates(\n         function onBeforeHotUpdate(hasUpdates: boolean) {\n@@ -331,10 +340,10 @@ function processMessage(\n       break\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.BUILDING: {\n-      startLatency = Date.now()\n-      turbopackLastUpdateLatency = null\n-      turbopackUpdatedModules.clear()\n-      if (!process.env.TURBOPACK) {\n+      if (process.env.TURBOPACK) {\n+        turbopackHmr!.onBuilding()\n+      } else {\n+        webpackStartMsSinceEpoch = Date.now()\n         setPendingHotUpdateWebpack()\n       }\n       console.log('[Fast Refresh] rebuilding')\n@@ -430,10 +439,7 @@ function processMessage(\n         console.warn(REACT_REFRESH_FULL_RELOAD_FROM_ERROR)\n         performFullReload(null, sendMessage)\n       }\n-      for (const module of extractModulesFromTurbopackMessage(obj.data)) {\n-        turbopackUpdatedModules.add(module)\n-      }\n-      turbopackLastUpdateLatency = Date.now()\n+      turbopackHmr!.onTurbopackMessage(obj)\n       break\n     }\n     // TODO-APP: make server component change more granular"
        },
        {
            "sha": "833d63cfda2832614975c7b0dfd1b0b116fad4ee",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/hot-reloader-client.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 21,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/afcea7b5a2f9c42a912111b5e5856693c5ec41e4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/afcea7b5a2f9c42a912111b5e5856693c5ec41e4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts?ref=afcea7b5a2f9c42a912111b5e5856693c5ec41e4",
            "patch": "@@ -46,14 +46,17 @@ import type {\n   HMR_ACTION_TYPES,\n   TurbopackMsgToBrowser,\n } from '../../../../server/dev/hot-reloader-types'\n-import { extractModulesFromTurbopackMessage } from '../../../../server/dev/extract-modules-from-turbopack-message'\n import {\n   REACT_REFRESH_FULL_RELOAD,\n   REACT_REFRESH_FULL_RELOAD_FROM_ERROR,\n   reportInvalidHmrMessage,\n } from '../shared'\n import { RuntimeErrorHandler } from '../../errors/runtime-error-handler'\n import reportHmrLatency from '../utils/report-hmr-latency'\n+import {\n+  extractModulesFromTurbopackMessage,\n+  TurbopackHmr,\n+} from '../utils/turbopack-hot-reloader-common'\n // This alternative WebpackDevServer combines the functionality of:\n // https://github.com/webpack/webpack-dev-server/blob/webpack-1/client/index.js\n // https://github.com/webpack/webpack/blob/webpack-1/hot/dev-server.js\n@@ -125,27 +128,31 @@ function clearOutdatedErrors() {\n // Successful compilation.\n function handleSuccess() {\n   clearOutdatedErrors()\n+  hasCompileErrors = false\n \n   if (process.env.TURBOPACK) {\n-    reportHmrLatency(\n-      sendMessage,\n-      [...turbopackUpdatedModules],\n-      startLatency!,\n-      turbopackLastUpdateLatency ?? Date.now()\n-    )\n+    const hmrUpdate = turbopackHmr!.onBuilt()\n+    if (hmrUpdate != null) {\n+      reportHmrLatency(\n+        sendMessage,\n+        [...hmrUpdate.updatedModules],\n+        hmrUpdate.startMsSinceEpoch,\n+        hmrUpdate.endMsSinceEpoch\n+      )\n+    }\n     onBuildOk()\n   } else {\n     const isHotUpdate =\n       !isFirstCompilation ||\n       (window.__NEXT_DATA__.page !== '/_error' && isUpdateAvailable())\n-    isFirstCompilation = false\n-    hasCompileErrors = false\n \n     // Attempt to apply hot updates or reload.\n     if (isHotUpdate) {\n       tryApplyUpdates(onBeforeFastRefresh, onFastRefresh)\n     }\n   }\n+\n+  isFirstCompilation = false\n }\n \n // Compilation with warnings (e.g. ESLint).\n@@ -219,9 +226,10 @@ function handleErrors(errors: any) {\n   }\n }\n \n-let startLatency: number | null = null\n-let turbopackLastUpdateLatency: number | null = null\n-let turbopackUpdatedModules: Set<string> = new Set()\n+let webpackStartMsSinceEpoch: number | null = null\n+const turbopackHmr: TurbopackHmr | null = process.env.TURBOPACK\n+  ? new TurbopackHmr()\n+  : null\n let isrManifest: Record<string, boolean> = {}\n \n function onBeforeFastRefresh(updatedModules: string[]) {\n@@ -243,8 +251,8 @@ function onFastRefresh(updatedModules: ReadonlyArray<string> = []) {\n   reportHmrLatency(\n     sendMessage,\n     updatedModules,\n-    startLatency!,\n-    turbopackLastUpdateLatency ?? Date.now()\n+    webpackStartMsSinceEpoch!,\n+    Date.now()\n   )\n }\n \n@@ -286,9 +294,11 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n       break\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.BUILDING: {\n-      startLatency = Date.now()\n-      turbopackLastUpdateLatency = null\n-      turbopackUpdatedModules.clear()\n+      if (process.env.TURBOPACK) {\n+        turbopackHmr!.onBuilding()\n+      } else {\n+        webpackStartMsSinceEpoch = Date.now()\n+      }\n       console.log('[Fast Refresh] rebuilding')\n       break\n     }\n@@ -373,10 +383,7 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n         performFullReload(null)\n       }\n       onRefresh()\n-      for (const module of updatedModules) {\n-        turbopackUpdatedModules.add(module)\n-      }\n-      turbopackLastUpdateLatency = Date.now()\n+      turbopackHmr!.onTurbopackMessage(obj)\n       break\n     }\n     default: {"
        },
        {
            "sha": "95b10b482c8af8a4ad759805ce34d1b46863171d",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/turbopack-hot-reloader-common.ts",
            "status": "added",
            "additions": 83,
            "deletions": 0,
            "changes": 83,
            "blob_url": "https://github.com/vercel/next.js/blob/afcea7b5a2f9c42a912111b5e5856693c5ec41e4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/afcea7b5a2f9c42a912111b5e5856693c5ec41e4/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts?ref=afcea7b5a2f9c42a912111b5e5856693c5ec41e4",
            "patch": "@@ -0,0 +1,83 @@\n+import type { TurbopackMessageAction } from '../../../../server/dev/hot-reloader-types'\n+import type { Update as TurbopackUpdate } from '../../../../build/swc/types'\n+\n+interface HmrUpdate {\n+  updatedModules: Set<string>\n+  startMsSinceEpoch: number\n+  endMsSinceEpoch: number\n+}\n+\n+export class TurbopackHmr {\n+  #updatedModules: Set<string>\n+  #startMsSinceEpoch: number | undefined\n+  #lastUpdateMsSinceEpoch: number | undefined\n+\n+  constructor() {\n+    this.#updatedModules = new Set()\n+  }\n+\n+  onBuilding() {\n+    this.#lastUpdateMsSinceEpoch = undefined\n+    this.#startMsSinceEpoch = Date.now()\n+  }\n+\n+  onTurbopackMessage(msg: TurbopackMessageAction) {\n+    this.#lastUpdateMsSinceEpoch = Date.now()\n+    const updatedModules = extractModulesFromTurbopackMessage(msg.data)\n+    for (const module of updatedModules) {\n+      this.#updatedModules.add(module)\n+    }\n+  }\n+\n+  onBuilt(): HmrUpdate | null {\n+    // it's possible for `this.#startMsSinceEpoch` to not be set if this was the initial\n+    // computation, just return null in this case.\n+    if (this.#startMsSinceEpoch == null) {\n+      return null\n+    }\n+    const result = {\n+      updatedModules: this.#updatedModules,\n+      startMsSinceEpoch: this.#startMsSinceEpoch!,\n+      // Turbopack has a debounce which causes every BUILT message to appear\n+      // 30ms late. We don't want to include this latency in our reporting, so\n+      // prefer to use the last TURBOPACK_MESSAGE time.\n+      endMsSinceEpoch: this.#lastUpdateMsSinceEpoch ?? Date.now(),\n+    }\n+    this.#updatedModules = new Set()\n+    return result\n+  }\n+}\n+\n+export function extractModulesFromTurbopackMessage(\n+  data: TurbopackUpdate | TurbopackUpdate[]\n+): Set<string> {\n+  const updatedModules: Set<string> = new Set()\n+\n+  const updates = Array.isArray(data) ? data : [data]\n+  for (const update of updates) {\n+    // TODO this won't capture changes to CSS since they don't result in a \"merged\" update\n+    if (\n+      update.type !== 'partial' ||\n+      update.instruction.type !== 'ChunkListUpdate' ||\n+      update.instruction.merged === undefined\n+    ) {\n+      continue\n+    }\n+\n+    for (const mergedUpdate of update.instruction.merged) {\n+      for (const name of Object.keys(mergedUpdate.entries)) {\n+        const res = /(.*)\\s+\\[.*/.exec(name)\n+        if (res === null) {\n+          console.error(\n+            '[Turbopack HMR] Expected module to match pattern: ' + name\n+          )\n+          continue\n+        }\n+\n+        updatedModules.add(res[1])\n+      }\n+    }\n+  }\n+\n+  return updatedModules\n+}"
        },
        {
            "sha": "c10b13aaad9cc8201d78ccbbb7f43e15b62ac70f",
            "filename": "packages/next/src/server/dev/extract-modules-from-turbopack-message.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 35,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/03ce7f57666c91a2aac29a2ee1465a90f26a2de5/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fextract-modules-from-turbopack-message.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/03ce7f57666c91a2aac29a2ee1465a90f26a2de5/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fextract-modules-from-turbopack-message.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fextract-modules-from-turbopack-message.ts?ref=03ce7f57666c91a2aac29a2ee1465a90f26a2de5",
            "patch": "@@ -1,35 +0,0 @@\n-import type { Update as TurbopackUpdate } from '../../build/swc/types'\n-\n-export function extractModulesFromTurbopackMessage(\n-  data: TurbopackUpdate | TurbopackUpdate[]\n-): Set<string> {\n-  const updatedModules: Set<string> = new Set()\n-\n-  const updates = Array.isArray(data) ? data : [data]\n-  for (const update of updates) {\n-    // TODO this won't capture changes to CSS since they don't result in a \"merged\" update\n-    if (\n-      update.type !== 'partial' ||\n-      update.instruction.type !== 'ChunkListUpdate' ||\n-      update.instruction.merged === undefined\n-    ) {\n-      continue\n-    }\n-\n-    for (const mergedUpdate of update.instruction.merged) {\n-      for (const name of Object.keys(mergedUpdate.entries)) {\n-        const res = /(.*)\\s+\\[.*/.exec(name)\n-        if (res === null) {\n-          console.error(\n-            '[Turbopack HMR] Expected module to match pattern: ' + name\n-          )\n-          continue\n-        }\n-\n-        updatedModules.add(res[1])\n-      }\n-    }\n-  }\n-\n-  return updatedModules\n-}"
        }
    ],
    "stats": {
        "total": 213,
        "additions": 137,
        "deletions": 76
    }
}