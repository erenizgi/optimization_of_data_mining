{
    "author": "lubieowoce",
    "message": "fix: only set request phase to \"action\" when actually running an action (#76993)\n\nWhen running a server action, we want `requestStore.phase` to be set to `'action'`, because it makes `cookies()` mutable. However we were doing this in a pretty coarse-grained manner -- it was set at the beginning of `handleAction`, but wasn't always properly cleaned up in case of early returns that don't render anything (e.g. `{ type: 'not-found' }`). This PR fixes that -- we only set the phase to `'action'` while the action is running, and immediately switch it to `'render'` when it settles.\r\n\r\nIncidentally, early 'not-found' returns from `handleAction` are currently bugged (see https://github.com/vercel/next.js/pull/77012 for more context + fix), so we were also accidentally allowing mutatating cookies while rendering a response to an unrecognized action, which should be a 404, but is currently a 200 + a page render. but that's such a niche edge case that it's not really relevant to real usage.",
    "sha": "056c57bd01df8fd4c55a375830d7130db74c6ccd",
    "files": [
        {
            "sha": "f359791174293df3869a56d1bb8e3d8fa1d142d6",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 20,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/056c57bd01df8fd4c55a375830d7130db74c6ccd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/056c57bd01df8fd4c55a375830d7130db74c6ccd/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=056c57bd01df8fd4c55a375830d7130db74c6ccd",
            "patch": "@@ -510,13 +510,9 @@ export async function handleAction({\n     // that in the work store to be up-to-date for subsequent rendering.\n     workStore.isDraftMode = requestStore.draftMode.isEnabled\n \n-    requestStore.phase = 'render'\n-\n     return generateFlight(...args)\n   }\n \n-  requestStore.phase = 'action'\n-\n   // When running actions the default is no-store, you can still `cache: 'force-cache'`\n   workStore.fetchCache = 'default-no-store'\n \n@@ -674,18 +670,22 @@ export async function handleAction({\n               // Only warn if it's a server action, otherwise skip for other post requests\n               warnBadServerActionRequest()\n \n-              const actionReturnedState = await workUnitAsyncStorage.run(\n-                requestStore,\n-                action\n-              )\n+              let actionReturnedState: unknown\n+              requestStore.phase = 'action'\n+              try {\n+                actionReturnedState = await workUnitAsyncStorage.run(\n+                  requestStore,\n+                  action\n+                )\n+              } finally {\n+                requestStore.phase = 'render'\n+              }\n \n               formState = await decodeFormState(\n                 actionReturnedState,\n                 formData,\n                 serverModuleMap\n               )\n-\n-              requestStore.phase = 'render'\n             }\n \n             // Skip the fetch path\n@@ -829,18 +829,22 @@ export async function handleAction({\n               // Only warn if it's a server action, otherwise skip for other post requests\n               warnBadServerActionRequest()\n \n-              const actionReturnedState = await workUnitAsyncStorage.run(\n-                requestStore,\n-                action\n-              )\n+              let actionReturnedState: unknown\n+              requestStore.phase = 'action'\n+              try {\n+                actionReturnedState = await workUnitAsyncStorage.run(\n+                  requestStore,\n+                  action\n+                )\n+              } finally {\n+                requestStore.phase = 'render'\n+              }\n \n               formState = await decodeFormState(\n                 actionReturnedState,\n                 formData,\n                 serverModuleMap\n               )\n-\n-              requestStore.phase = 'render'\n             }\n \n             // Skip the fetch path\n@@ -917,9 +921,15 @@ export async function handleAction({\n           actionId!\n         ]\n \n-      const returnVal = await workUnitAsyncStorage.run(requestStore, () =>\n-        actionHandler.apply(null, boundActionArguments)\n-      )\n+      let returnVal: unknown\n+      requestStore.phase = 'action'\n+      try {\n+        returnVal = await workUnitAsyncStorage.run(requestStore, () =>\n+          actionHandler.apply(null, boundActionArguments)\n+        )\n+      } finally {\n+        requestStore.phase = 'render'\n+      }\n \n       // For form actions, we need to continue rendering the page.\n       if (isFetchAction) {\n@@ -1017,7 +1027,6 @@ export async function handleAction({\n         // swallow error, it's gonna be handled on the client\n       }\n \n-      requestStore.phase = 'render'\n       return {\n         type: 'done',\n         result: await generateFlight(req, ctx, requestStore, {"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 29,
        "deletions": 20
    }
}