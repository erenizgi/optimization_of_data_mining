{
    "author": "timneutkens",
    "message": "Turbopack build: Fix urlencoding test (#77622)\n\n### What?\n- Added additional debug logging for `customRoutes`,\n`publicFolderItems`, and `nextStaticFolderItems` in the filesystem\nrouter utils\n- Improved the dynamic route interpolation test to check all script\nsources instead of just the first matching one\n- Fixed the Turbopack build test manifest to correctly mark the dynamic\nroute interpolation test as passing\n- Updated the `to_string()` implementation in `ServerFileSystem` to use\na hyphenated format so that it behaves the same between urlencoded and\nurldecoded.\n\n### Why?\n\nThis PR improves debugging capabilities for the filesystem router and\nfixes the dynamic route interpolation test to be more robust by checking\nall script sources rather than just the first one that matches certain\ncriteria. The test now properly verifies that both encoded and decoded\npaths work correctly.\n\n### How?\n- Added debug statements for additional route-related variables\n- Refactored the test to collect all script sources and verify each one\nworks with both encoded and decoded paths\n- Updated the Turbopack test manifest to reflect the fixed test\n- Changed the server filesystem string representation to use hyphens\ninstead of spaces",
    "sha": "8040cf8728ccae4dfb28386ac07349be4de06793",
    "files": [
        {
            "sha": "6c66d93a6cd93387e0f61587dcfdd6976f5fb462",
            "filename": "packages/next/src/server/lib/router-utils/filesystem.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ffilesystem.ts?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -385,6 +385,9 @@ export async function setupFsCheck(opts: {\n \n   debug('nextDataRoutes', nextDataRoutes)\n   debug('dynamicRoutes', dynamicRoutes)\n+  debug('customRoutes', customRoutes)\n+  debug('publicFolderItems', publicFolderItems)\n+  debug('nextStaticFolderItems', nextStaticFolderItems)\n   debug('pageFiles', pageFiles)\n   debug('appFiles', appFiles)\n "
        },
        {
            "sha": "64dcb0ac380416802692800fead3439814534b23",
            "filename": "packages/next/src/server/patch-error-inspect.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -192,8 +192,8 @@ function getSourcemappedFrameIfPossible(\n   let sourceMapPayload: ModernSourceMapPayload\n   if (sourceMapCacheEntry === undefined) {\n     let sourceURL = frame.file\n-    // e.g. \"/APP/.next/server/chunks/ssr/[root of the server]__2934a0._.js\"\n-    // will be keyed by Node.js as \"file:///APP/.next/server/chunks/ssr/[root%20of%20the%20server]__2934a0._.js\".\n+    // e.g. \"/APP/.next/server/chunks/ssr/[root-of-the-server]__2934a0._.js\"\n+    // will be keyed by Node.js as \"file:///APP/.next/server/chunks/ssr/[root-of-the-server]__2934a0._.js\".\n     // This is likely caused by `callsite.toString()` in `Error.prepareStackTrace converting file URLs to paths.\n     if (sourceURL.startsWith('/')) {\n       sourceURL = url.pathToFileURL(frame.file).toString()"
        },
        {
            "sha": "3d6cdcd9d0f27bcb0bcba9d1089691891a6f7d8e",
            "filename": "test/development/app-dir/server-navigation-error/server-navigation-error.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fdevelopment%2Fapp-dir%2Fserver-navigation-error%2Fserver-navigation-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fdevelopment%2Fapp-dir%2Fserver-navigation-error%2Fserver-navigation-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fserver-navigation-error%2Fserver-navigation-error.test.ts?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -9,19 +9,18 @@ describe('server-navigation-error', () => {\n     it('should error on navigation API redirect', async () => {\n       const browser = await next.browser('/pages/redirect')\n \n-      // TODO(veil): investigate the column number is off by 1 between turbo and webpack\n       if (isTurbopack) {\n         await expect(browser).toDisplayRedbox(`\n          {\n            \"count\": 1,\n            \"description\": \"Error: Next.js navigation API is not allowed to be used in Pages Router.\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"pages/pages/redirect.tsx (4:10) @ Page\n+           \"source\": \"pages/pages/redirect.tsx (4:11) @ Page\n          > 4 |   redirect('/')\n-             |          ^\",\n+             |           ^\",\n            \"stack\": [\n-             \"Page pages/pages/redirect.tsx (4:10)\",\n+             \"Page pages/pages/redirect.tsx (4:11)\",\n            ],\n          }\n         `)\n@@ -46,19 +45,18 @@ describe('server-navigation-error', () => {\n     it('should error on navigation API notFound', async () => {\n       const browser = await next.browser('/pages/not-found')\n \n-      // TODO(veil): investigate the column number is off by 1 between turbo and webpack\n       if (isTurbopack) {\n         await expect(browser).toDisplayRedbox(`\n          {\n            \"count\": 1,\n            \"description\": \"Error: Next.js navigation API is not allowed to be used in Pages Router.\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"pages/pages/not-found.tsx (4:10) @ Page\n+           \"source\": \"pages/pages/not-found.tsx (4:11) @ Page\n          > 4 |   notFound()\n-             |          ^\",\n+             |           ^\",\n            \"stack\": [\n-             \"Page pages/pages/not-found.tsx (4:10)\",\n+             \"Page pages/pages/not-found.tsx (4:11)\",\n            ],\n          }\n         `)"
        },
        {
            "sha": "e2850f6945cfd1fa3f222a2934fbd32c73c96f83",
            "filename": "test/e2e/dynamic-route-interpolation/index.test.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 14,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fe2e%2Fdynamic-route-interpolation%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fe2e%2Fdynamic-route-interpolation%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fdynamic-route-interpolation%2Findex.test.ts?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -51,25 +51,35 @@ describe('Dynamic Route Interpolation', () => {\n   if (isNextStart) {\n     it('should support both encoded and decoded nextjs reserved path convention characters in path', async () => {\n       const $ = await next.render$('/blog/123')\n-      let pagePathScriptSrc\n+      const scripts: string[] = []\n       for (const script of $('script').toArray()) {\n-        const { src } = script.attribs\n-        if (src.includes('slug') && src.includes('pages/blog')) {\n-          pagePathScriptSrc = src\n-          break\n+        if (script.attribs.src) {\n+          scripts.push(script.attribs.src)\n         }\n       }\n \n-      // e.g. /_next/static/chunks/pages/blog/%5Bslug%5D-3d2fedc300f04305.js\n-      const { status: encodedPathReqStatus } =\n-        await next.fetch(pagePathScriptSrc)\n-      // e.g. /_next/static/chunks/pages/blog/[slug]-3d2fedc300f04305.js\n-      const { status: decodedPathReqStatus } = await next.fetch(\n-        decodeURI(pagePathScriptSrc)\n-      )\n+      expect(scripts).not.toBeEmpty()\n \n-      expect(encodedPathReqStatus).toBe(200)\n-      expect(decodedPathReqStatus).toBe(200)\n+      for (const encodedPath of scripts) {\n+        // e.g. /_next/static/chunks/pages/blog/%5Bslug%5D-3d2fedc300f04305.js\n+        const { status: encodedPathReqStatus } = await next.fetch(encodedPath)\n+\n+        // e.g. /_next/static/chunks/pages/blog/[slug]-3d2fedc300f04305.js\n+        const decodedPath = decodeURI(encodedPath)\n+        const { status: decodedPathReqStatus } = await next.fetch(decodedPath)\n+\n+        expect({\n+          encodedPath,\n+          encodedStatus: encodedPathReqStatus,\n+          decodedPath,\n+          decodedStatus: decodedPathReqStatus,\n+        }).toMatchObject({\n+          encodedPath,\n+          decodedPath,\n+          encodedStatus: 200,\n+          decodedStatus: 200,\n+        })\n+      }\n     })\n   }\n })"
        },
        {
            "sha": "6ae752c32af718071d2372a2e519b6c7dba3093d",
            "filename": "test/integration/script-loader/test/index.test.js",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fintegration%2Fscript-loader%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fintegration%2Fscript-loader%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fscript-loader%2Ftest%2Findex.test.js?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -118,7 +118,7 @@ const runTests = (isDev) => {\n         // Turbopack generates different script names\n         expect(\n           $(\n-            `#${id} ~ script[src^=\"/_next/static/chunks/%5Broot%20of%20the%20server%5D__\"]`\n+            `#${id} ~ script[src^=\"/_next/static/chunks/%5Broot-of-the-server%5D__\"]`\n           ).length\n         ).toBeGreaterThan(0)\n       } else {\n@@ -148,7 +148,7 @@ const runTests = (isDev) => {\n         // Turbopack generates different script names\n         expect(\n           $(\n-            `#${id} ~ script[src^=\"/_next/static/chunks/%5Broot%20of%20the%20server%5D__\"]`\n+            `#${id} ~ script[src^=\"/_next/static/chunks/%5Broot-of-the-server%5D__\"]`\n           ).length\n         ).toBeGreaterThan(0)\n       } else {"
        },
        {
            "sha": "4efa6b4c2c15c25c75e362d17d790ae97e61a79d",
            "filename": "test/integration/server-side-dev-errors/test/index.test.js",
            "status": "modified",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -94,11 +94,11 @@ describe('server-side dev errors', () => {\n            \"description\": \"ReferenceError: missingVar is not defined\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"../../test/integration/server-side-dev-errors/pages/gsp.js (6:3) @ getStaticProps\n+           \"source\": \"pages/gsp.js (6:3) @ getStaticProps\n          > 6 |   missingVar;return {\n              |   ^\",\n            \"stack\": [\n-             \"getStaticProps ../../test/integration/server-side-dev-errors/pages/gsp.js (6:3)\",\n+             \"getStaticProps pages/gsp.js (6:3)\",\n            ],\n          }\n         `)\n@@ -173,11 +173,11 @@ describe('server-side dev errors', () => {\n            \"description\": \"ReferenceError: missingVar is not defined\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"../../test/integration/server-side-dev-errors/pages/gssp.js (6:3) @ getServerSideProps\n+           \"source\": \"pages/gssp.js (6:3) @ getServerSideProps\n          > 6 |   missingVar;return {\n              |   ^\",\n            \"stack\": [\n-             \"getServerSideProps ../../test/integration/server-side-dev-errors/pages/gssp.js (6:3)\",\n+             \"getServerSideProps pages/gssp.js (6:3)\",\n            ],\n          }\n         `)\n@@ -252,11 +252,11 @@ describe('server-side dev errors', () => {\n            \"description\": \"ReferenceError: missingVar is not defined\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"../../test/integration/server-side-dev-errors/pages/blog/[slug].js (6:3) @ getServerSideProps\n+           \"source\": \"pages/blog/[slug].js (6:3) @ getServerSideProps\n          > 6 |   missingVar;return {\n              |   ^\",\n            \"stack\": [\n-             \"getServerSideProps ../../test/integration/server-side-dev-errors/pages/blog/[slug].js (6:3)\",\n+             \"getServerSideProps pages/blog/[slug].js (6:3)\",\n            ],\n          }\n         `)\n@@ -330,11 +330,11 @@ describe('server-side dev errors', () => {\n            \"description\": \"ReferenceError: missingVar is not defined\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"../../test/integration/server-side-dev-errors/pages/api/hello.js (2:3) @ handler\n+           \"source\": \"pages/api/hello.js (2:3) @ handler\n          > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n              |   ^\",\n            \"stack\": [\n-             \"handler ../../test/integration/server-side-dev-errors/pages/api/hello.js (2:3)\",\n+             \"handler pages/api/hello.js (2:3)\",\n            ],\n          }\n         `)\n@@ -364,11 +364,11 @@ describe('server-side dev errors', () => {\n            \"description\": \"ReferenceError: missingVar is not defined\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"../../test/integration/server-side-dev-errors/pages/api/hello.js (2:3) @ handler\n+           \"source\": \"pages/api/hello.js (2:3) @ handler\n          > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n              |   ^\",\n            \"stack\": [\n-             \"handler ../../test/integration/server-side-dev-errors/pages/api/hello.js (2:3)\",\n+             \"handler pages/api/hello.js (2:3)\",\n            ],\n          }\n         `)\n@@ -442,11 +442,11 @@ describe('server-side dev errors', () => {\n            \"description\": \"ReferenceError: missingVar is not defined\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js (2:3) @ handler\n+           \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n          > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n              |   ^\",\n            \"stack\": [\n-             \"handler ../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js (2:3)\",\n+             \"handler pages/api/blog/[slug].js (2:3)\",\n            ],\n          }\n         `)\n@@ -476,11 +476,11 @@ describe('server-side dev errors', () => {\n            \"description\": \"ReferenceError: missingVar is not defined\",\n            \"environmentLabel\": null,\n            \"label\": \"Runtime Error\",\n-           \"source\": \"../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js (2:3) @ handler\n+           \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n          > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n              |   ^\",\n            \"stack\": [\n-             \"handler ../../test/integration/server-side-dev-errors/pages/api/blog/[slug].js (2:3)\",\n+             \"handler pages/api/blog/[slug].js (2:3)\",\n            ],\n          }\n         `)"
        },
        {
            "sha": "99faf55d6c28f8b4485feb23f205d22197fc3968",
            "filename": "test/production/escheck-output/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fproduction%2Fescheck-output%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fproduction%2Fescheck-output%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fescheck-output%2Findex.test.ts?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -7,13 +7,11 @@ describe('ES Check .next output', () => {\n \n   it('should emit ES2020 with default', async () => {\n     next = await createNext({\n-      files: {\n-        'pages/index.js': 'export default function Page() { return \"hi\" }',\n-      },\n+      files: __dirname,\n       dependencies: { 'es-check': '7.0.1' },\n       packageJson: {\n         scripts: {\n-          build: 'next build && es-check es2020 .next/static/**/*.js',\n+          build: 'next build && es-check es2020 \".next/static/**/*.js\"',\n         },\n       },\n       installCommand: 'pnpm i',"
        },
        {
            "sha": "c188e25101e4045ccfbafe6b34c983d4281f5fcc",
            "filename": "test/production/escheck-output/pages/index.js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fproduction%2Fescheck-output%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fproduction%2Fescheck-output%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fescheck-output%2Fpages%2Findex.js?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'hi'\n+}"
        },
        {
            "sha": "73b3a0a25029d1047a8b1640aac556d8082bf62a",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -5986,11 +5986,10 @@\n       \"Dynamic Route Interpolation should work with brackets\",\n       \"Dynamic Route Interpolation should work with brackets in API routes\",\n       \"Dynamic Route Interpolation should work with parameter itself\",\n-      \"Dynamic Route Interpolation should work with parameter itself in API routes\"\n-    ],\n-    \"failed\": [\n+      \"Dynamic Route Interpolation should work with parameter itself in API routes\",\n       \"Dynamic Route Interpolation should support both encoded and decoded nextjs reserved path convention characters in path\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        },
        {
            "sha": "6cdb988899aa5beb8c116a114b09aa67e7efa89f",
            "filename": "turbopack/crates/turbopack-core/src/server_fs.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8040cf8728ccae4dfb28386ac07349be4de06793/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fserver_fs.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8040cf8728ccae4dfb28386ac07349be4de06793/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fserver_fs.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fserver_fs.rs?ref=8040cf8728ccae4dfb28386ac07349be4de06793",
            "patch": "@@ -58,6 +58,6 @@ impl FileSystem for ServerFileSystem {\n impl ValueToString for ServerFileSystem {\n     #[turbo_tasks::function]\n     fn to_string(&self) -> Vc<RcStr> {\n-        Vc::cell(\"root of the server\".into())\n+        Vc::cell(\"root-of-the-server\".into())\n     }\n }"
        }
    ],
    "stats": {
        "total": 107,
        "additions": 59,
        "deletions": 48
    }
}