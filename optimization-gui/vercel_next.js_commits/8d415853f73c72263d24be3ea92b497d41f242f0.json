{
    "author": "styfle",
    "message": "[Breaking] feat(next/image)!: add support for `images.dangerouslyAllowLocalIP` and `images.maximumRedirects` (#84676)\n\nThis PR adds a two new options and sets a strict default value for each.\n\n- `images.dangerouslyAllowLocalIP`\n- `images.maximumRedirects`\n\n### dangerouslyAllowLocalIP\n\nIn rare cases when self-hosting Next.js on a private network, you may\nwant to allow optimizing images from local IP addresses on the same\nnetwork.\n\nHowever, this is not recommended for most users so the default is\n`false`.\n\n> [!NOTE]\n> BREAKING CHANGE: This change is breaking for those who self-hosting\nNext.js on a private network and want to allow optimizing images from\nlocal IP addresses on the same network. In those cases, you can still\nenable the config.\n\n### maximumRedirects\n\nSince are also testing redirects for local IPs, we can also reduce the\nmaximum number of redirects to 3 by default.\n\nUnlike normal websites which might redirect for features like auth, its\nunusual to have more than 3 redirects for an image.\n\nIn some rare cases, developers may need to increase this value or set to\n`0` to disable redirects.\n\n> [!NOTE]\n> BREAKING CHANGE: This change is breaking for those who need image\noptimization to follow more than 3 redirects.",
    "sha": "8d415853f73c72263d24be3ea92b497d41f242f0",
    "files": [
        {
            "sha": "aca5e269ecbc78e18faaec0dcdb4a1b161dfdffc",
            "filename": "crates/next-build-test/nextConfig.json",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/crates%2Fnext-build-test%2FnextConfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/crates%2Fnext-build-test%2FnextConfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-build-test%2FnextConfig.json?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -30,6 +30,8 @@\n     \"disableStaticImages\": false,\n     \"minimumCacheTTL\": 60,\n     \"formats\": [\"image/avif\", \"image/webp\"],\n+    \"maximumRedirects\": 3,\n+    \"dangerouslyAllowLocalIP\": false,\n     \"dangerouslyAllowSVG\": false,\n     \"contentSecurityPolicy\": \"script-src 'none'; frame-src 'none'; sandbox;\",\n     \"contentDispositionType\": \"inline\","
        },
        {
            "sha": "e25a531a76a3308d65f3c7f2f62d7dcf7f383577",
            "filename": "docs/01-app/03-api-reference/02-components/image.mdx",
            "status": "modified",
            "additions": 47,
            "deletions": 1,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F02-components%2Fimage.mdx?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -804,6 +804,52 @@ module.exports = {\n }\n ```\n \n+#### `maximumRedirects`\n+\n+The default image optimization loader will follow HTTP redirects when fetching remote images up to 3 times.\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    maximumRedirects: 3,\n+  },\n+}\n+```\n+\n+You can configure the number of redirects to follow when fetching remote images. Setting the value to `0` will disable following redirects.\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    maximumRedirects: 0,\n+  },\n+}\n+```\n+\n+#### `dangerouslyAllowLocalIP`\n+\n+In rare cases when self-hosting Next.js on a private network, you may want to allow optimizing images from local IP addresses on the same network. This is not recommended for most users because it could allow malicious users to access content on your internal network.\n+\n+By default, the value is false.\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    dangerouslyAllowLocalIP: false,\n+  },\n+}\n+```\n+\n+If you need to optimize remote images hosted elsewhere in your local network, you can set the value to true.\n+\n+```js filename=\"next.config.js\"\n+module.exports = {\n+  images: {\n+    dangerouslyAllowLocalIP: true,\n+  },\n+}\n+```\n+\n #### `dangerouslyAllowSVG`\n \n `dangerouslyAllowSVG` allows you to serve SVG images.\n@@ -1284,7 +1330,7 @@ export default function Home() {\n \n | Version    | Changes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |\n | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |\n-| `v16.0.0`  | `qualities` default configuration changed to `[75]`, `preload` prop added, `priority` prop deprecated.                                                                                                                                                                                                                                                                                                                                                                                     |\n+| `v16.0.0`  | `qualities` default configuration changed to `[75]`, `preload` prop added, `priority` prop deprecated, `dangerouslyAllowLocalIP` config added, `maximumRedirects` config added.                                                                                                                                                                                                                                                                                                            |\n | `v15.3.0`  | `remotePatterns` added support for array of `URL` objects.                                                                                                                                                                                                                                                                                                                                                                                                                                 |\n | `v15.0.0`  | `contentDispositionType` configuration default changed to `attachment`.                                                                                                                                                                                                                                                                                                                                                                                                                    |\n | `v14.2.23` | `qualities` configuration added.                                                                                                                                                                                                                                                                                                                                                                                                                                                           |"
        },
        {
            "sha": "4275b6cdac1309e0a793c4ae185ac10b10929bd6",
            "filename": "packages/next/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fpackage.json?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -270,6 +270,7 @@\n     \"ignore-loader\": \"0.1.2\",\n     \"image-size\": \"1.2.1\",\n     \"is-docker\": \"2.0.0\",\n+    \"is-local-address\": \"2.2.2\",\n     \"is-wsl\": \"2.2.0\",\n     \"jest-worker\": \"27.5.1\",\n     \"json5\": \"2.2.3\","
        },
        {
            "sha": "034f63037d60e4e68dbb4f49dd82e159730ad714",
            "filename": "packages/next/src/compiled/is-local-address/index.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fcompiled%2Fis-local-address%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fcompiled%2Fis-local-address%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fis-local-address%2Findex.js?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -0,0 +1 @@\n+(()=>{\"use strict\";var e={555:(e,f,a)=>{e.exports=e=>a(276)(e)||a(628)(e)},276:e=>{const f=[\"0(?:\\\\.\\\\d{1,3}){3}\",\"10(?:\\\\.\\\\d{1,3}){3}\",\"127(?:\\\\.\\\\d{1,3}){3}\",\"169\\\\.254\\\\.(?:[1-9]|1?\\\\d\\\\d|2[0-4]\\\\d|25[0-4])\\\\.\\\\d{1,3}\",\"172\\\\.(?:1[6-9]|2\\\\d|3[01])(?:\\\\.\\\\d{1,3}){2}\",\"192\\\\.(?:0\\\\.0(?:\\\\.\\\\d{1,3})|0\\\\.2(?:\\\\.\\\\d{1,3})|168(?:\\\\.\\\\d{1,3}){2})\",\"100\\\\.(?:6[4-9]|[7-9]\\\\d|1[01]\\\\d|12[0-7])(?:\\\\.\\\\d{1,3}){2}\",\"198\\\\.(?:1[89](?:\\\\.\\\\d{1,3}){2}|51\\\\.100(?:\\\\.\\\\d{1,3}))\",\"203\\\\.0\\\\.113(?:\\\\.\\\\d{1,3})\",\"22[4-9](?:\\\\.\\\\d{1,3}){3}|23[0-9](?:\\\\.\\\\d{1,3}){3}\",\"24[0-9](?:\\\\.\\\\d{1,3}){3}|25[0-5](?:\\\\.\\\\d{1,3}){3}\",\"localhost\"];const a=new RegExp(`^(${f.join(\"|\")})$`);e.exports=a.test.bind(a);e.exports.regex=a},628:e=>{const f=[/^::f{4}:0?([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})$/,/^64:ff9b::([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})\\.([0-9]{1,3})$/,/^100:(:[0-9a-fA-F]{0,4}){0,6}$/,/^2001:(:[0-9a-fA-F]{0,4}){0,6}$/,/^2001:1[0-9a-fA-F]:([0-9a-fA-F]{0,4}:){0,7}[0-9a-fA-F]{0,4}$/,/^2001:2[0-9a-fA-F]?:([0-9a-fA-F]{0,4}:){0,7}[0-9a-fA-F]{0,4}$/,/^2001:db8:([0-9a-fA-F]{0,4}:){0,7}[0-9a-fA-F]{0,4}$/,/^3fff:([0-9a-fA-F]{0,4}:){0,7}[0-9a-fA-F]{0,4}$/,/^f[b-d][0-9a-fA-F]{2}:([0-9a-fA-F]{0,4}:){0,7}[0-9a-fA-F]{0,4}$/i,/^fe[8-9a-bA-B][0-9a-fA-F]:/i,/^ff([0-9a-fA-F]{2,2}):/i,/^ff00:([0-9a-fA-F]{0,4}:){0,7}[0-9a-fA-F]{0,4}$/,/^::1?$/,/^fec0:([0-9a-fA-F]{0,4}:){0,7}[0-9a-fA-F]{0,4}$/i,/^2002:([0-9a-fA-F]{0,4}:){0,7}[0-9a-fA-F]{0,4}$/];const a=new RegExp(`^(${f.map((e=>e.source)).join(\"|\")})$`);e.exports=e=>{if(e.startsWith(\"[\")&&e.endsWith(\"]\")){e=e.slice(1,-1)}return a.test(e)};e.exports.regex=a}};var f={};function __nccwpck_require__(a){var r=f[a];if(r!==undefined){return r.exports}var d=f[a]={exports:{}};var t=true;try{e[a](d,d.exports,__nccwpck_require__);t=false}finally{if(t)delete f[a]}return d.exports}if(typeof __nccwpck_require__!==\"undefined\")__nccwpck_require__.ab=__dirname+\"/\";var a=__nccwpck_require__(555);module.exports=a})();\n\\ No newline at end of file"
        },
        {
            "sha": "61bbef852181e6438395042aca8ed693b7c2663c",
            "filename": "packages/next/src/compiled/is-local-address/package.json",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fcompiled%2Fis-local-address%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fcompiled%2Fis-local-address%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2Fis-local-address%2Fpackage.json?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -0,0 +1 @@\n+{\"name\":\"is-local-address\",\"main\":\"index.js\",\"author\":{\"email\":\"josefrancisco.verdu@gmail.com\",\"name\":\"Kiko Beats\",\"url\":\"https://kikobeats.com\"},\"license\":\"MIT\"}"
        },
        {
            "sha": "dc8cd30d0784af647308214fa88c8f91459eee9f",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -551,6 +551,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         contentSecurityPolicy: z.string().optional(),\n         contentDispositionType: z.enum(['inline', 'attachment']).optional(),\n         dangerouslyAllowSVG: z.boolean().optional(),\n+        dangerouslyAllowLocalIP: z.boolean().optional(),\n         deviceSizes: z\n           .array(z.number().int().gte(1).lte(10000))\n           .max(25)\n@@ -568,6 +569,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n           .optional(),\n         loader: z.enum(VALID_LOADERS).optional(),\n         loaderFile: z.string().optional(),\n+        maximumRedirects: z.number().int().min(0).max(20).optional(),\n         minimumCacheTTL: z.number().int().gte(0).optional(),\n         path: z.string().optional(),\n         qualities: z"
        },
        {
            "sha": "c99b4ddf98eadbd6414e7620b94cdb9228db1749",
            "filename": "packages/next/src/server/image-optimizer.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 1,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -6,6 +6,7 @@ import contentDisposition from 'next/dist/compiled/content-disposition'\n import imageSizeOf from 'next/dist/compiled/image-size'\n import { detector } from 'next/dist/compiled/image-detector/detector.js'\n import isAnimated from 'next/dist/compiled/is-animated'\n+import isLocalAddress from 'next/dist/compiled/is-local-address'\n import { join } from 'path'\n import nodeUrl, { type UrlWithParsedQuery } from 'url'\n \n@@ -30,6 +31,9 @@ import isError from '../lib/is-error'\n import { parseUrl } from '../lib/url'\n import type { CacheControl } from './lib/cache-control'\n import { InvariantError } from '../shared/lib/invariant-error'\n+import { lookup } from 'dns/promises'\n+import { isIP } from 'net'\n+import { ALL } from 'dns'\n \n type XCacheHeader = 'MISS' | 'HIT' | 'STALE'\n \n@@ -700,9 +704,40 @@ export async function optimizeImage({\n   return optimizedBuffer\n }\n \n-export async function fetchExternalImage(href: string): Promise<ImageUpstream> {\n+function isRedirect(statusCode: number) {\n+  return [301, 302, 303, 307, 308].includes(statusCode)\n+}\n+\n+export async function fetchExternalImage(\n+  href: string,\n+  dangerouslyAllowLocalIP: boolean,\n+  count = 3\n+): Promise<ImageUpstream> {\n+  if (!dangerouslyAllowLocalIP) {\n+    const { hostname } = new URL(href)\n+    let ips = [hostname]\n+    if (!isIP(hostname)) {\n+      const records = await lookup(hostname, {\n+        family: 0,\n+        all: true,\n+        hints: ALL,\n+      }).catch((_) => [{ address: hostname }])\n+      ips = records.map((record) => record.address)\n+    }\n+    const privateIps = ips.filter((ip) => isLocalAddress(ip))\n+    if (privateIps.length > 0) {\n+      Log.error(\n+        'upstream image',\n+        href,\n+        'resolved to private ip',\n+        JSON.stringify(privateIps)\n+      )\n+      throw new ImageError(400, '\"url\" parameter is not allowed')\n+    }\n+  }\n   const res = await fetch(href, {\n     signal: AbortSignal.timeout(7_000),\n+    redirect: 'manual',\n   }).catch((err) => err as Error)\n \n   if (res instanceof Error) {\n@@ -717,6 +752,23 @@ export async function fetchExternalImage(href: string): Promise<ImageUpstream> {\n     throw err\n   }\n \n+  const locationHeader = res.headers.get('Location')\n+  if (\n+    isRedirect(res.status) &&\n+    locationHeader &&\n+    URL.canParse(locationHeader, href)\n+  ) {\n+    if (count === 0) {\n+      Log.error('upstream image response had too many redirects', href)\n+      throw new ImageError(\n+        508,\n+        '\"url\" parameter is valid but upstream response is invalid'\n+      )\n+    }\n+    const redirect = new URL(locationHeader, href).href\n+    return fetchExternalImage(redirect, dangerouslyAllowLocalIP, count - 1)\n+  }\n+\n   if (!res.ok) {\n     Log.error('upstream image response failed for', href, res.status)\n     throw new ImageError("
        },
        {
            "sha": "879c81d7ac61341fb83a343fe4dd6a21e63d2eea",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -780,7 +780,11 @@ export default class NextNodeServer extends BaseServer<\n       const { isAbsolute, href } = paramsResult\n \n       const imageUpstream = isAbsolute\n-        ? await fetchExternalImage(href)\n+        ? await fetchExternalImage(\n+            href,\n+            this.nextConfig.images.dangerouslyAllowLocalIP,\n+            this.nextConfig.images.maximumRedirects\n+          )\n         : await fetchInternalImage(\n             href,\n             req.originalRequest,"
        },
        {
            "sha": "72d91d24328c1d11dd1317cff5483cdd4cca71a1",
            "filename": "packages/next/src/shared/lib/image-config.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-config.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -103,6 +103,12 @@ export type ImageConfigComplete = {\n   /** @see [Acceptable formats](https://nextjs.org/docs/api-reference/next/image#acceptable-formats) */\n   formats: ImageFormat[]\n \n+  /** @see [Maximum Redirects](https://nextjs.org/docs/api-reference/next/image#maximumredirects) */\n+  maximumRedirects: number\n+\n+  /** @see [Dangerously Allow Local IP](https://nextjs.org/docs/api-reference/next/image#dangerously-allow-local-ip) */\n+  dangerouslyAllowLocalIP: boolean\n+\n   /** @see [Dangerously Allow SVG](https://nextjs.org/docs/api-reference/next/image#dangerously-allow-svg) */\n   dangerouslyAllowSVG: boolean\n \n@@ -140,6 +146,8 @@ export const imageConfigDefault: ImageConfigComplete = {\n   disableStaticImages: false,\n   minimumCacheTTL: 14400, // 4 hours\n   formats: ['image/webp'],\n+  maximumRedirects: 3,\n+  dangerouslyAllowLocalIP: false,\n   dangerouslyAllowSVG: false,\n   contentSecurityPolicy: `script-src 'none'; frame-src 'none'; sandbox;`,\n   contentDispositionType: 'attachment',"
        },
        {
            "sha": "4fc2f0edf4ff09bcf3f40c6636915a55c23e2632",
            "filename": "packages/next/taskfile.js",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Ftaskfile.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Ftaskfile.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile.js?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -1275,6 +1275,14 @@ export async function ncc_is_animated(task, opts) {\n     .target('src/compiled/is-animated')\n }\n // eslint-disable-next-line camelcase\n+externals['is-local-address'] = 'next/dist/compiled/is-local-address'\n+export async function ncc_is_local_address(task, opts) {\n+  await task\n+    .source(relative(__dirname, require.resolve('is-local-address')))\n+    .ncc({ packageName: 'is-local-address', externals })\n+    .target('src/compiled/is-local-address')\n+}\n+// eslint-disable-next-line camelcase\n externals['is-docker'] = 'next/dist/compiled/is-docker'\n export async function ncc_is_docker(task, opts) {\n   await task\n@@ -2349,6 +2357,7 @@ export async function ncc(task, opts) {\n         'ncc_http_proxy',\n         'ncc_ignore_loader',\n         'ncc_is_animated',\n+        'ncc_is_local_address',\n         'ncc_is_docker',\n         'ncc_is_wsl',\n         'ncc_json5',"
        },
        {
            "sha": "e7f479b865b2d5c9a068e87bbdf44cce97877c54",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -856,6 +856,10 @@ declare module 'next/dist/compiled/is-animated' {\n   export default function isAnimated(buffer: Buffer): boolean\n }\n \n+declare module 'next/dist/compiled/is-local-address' {\n+  export default function isLocalAddress(ip: string): boolean\n+}\n+\n declare module 'next/dist/compiled/@opentelemetry/api' {\n   import * as m from '@opentelemetry/api'\n   export = m"
        },
        {
            "sha": "4bcc1eb08b460bc998b6d8b807da31748b4e80c3",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 14,
            "deletions": 108,
            "changes": 122,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -287,7 +287,7 @@ importers:\n         version: 5.2.1(eslint@9.12.0(jiti@2.5.1))\n       eslint-plugin-import:\n         specifier: 2.31.0\n-        version: 2.31.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-typescript@3.6.3)(eslint@9.12.0(jiti@2.5.1))\n+        version: 2.31.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1))\n       eslint-plugin-jest:\n         specifier: 27.6.3\n         version: 27.6.3(@typescript-eslint/eslint-plugin@8.36.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1))(jest@29.7.0(@types/node@20.17.6(patch_hash=rvl3vkomen3tospgr67bzubfyu))(babel-plugin-macros@3.1.0))(typescript@5.9.2)\n@@ -657,7 +657,7 @@ importers:\n         version: 9.12.0(jiti@2.5.1)\n       eslint-config-next:\n         specifier: canary\n-        version: 15.6.0-canary.36(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2)\n+        version: link:../../packages/eslint-config-next\n       tailwindcss:\n         specifier: 4.1.13\n         version: 4.1.13\n@@ -1420,6 +1420,9 @@ importers:\n       is-docker:\n         specifier: 2.0.0\n         version: 2.0.0\n+      is-local-address:\n+        specifier: 2.2.2\n+        version: 2.2.2\n       is-wsl:\n         specifier: 2.2.0\n         version: 2.2.0\n@@ -4363,9 +4366,6 @@ packages:\n   '@next/env@15.5.3':\n     resolution: {integrity: sha512-RSEDTRqyihYXygx/OJXwvVupfr9m04+0vH8vyy0HfZ7keRto6VX9BbEk0J2PUk0VGy6YhklJUSrgForov5F9pw==}\n \n-  '@next/eslint-plugin-next@15.6.0-canary.36':\n-    resolution: {integrity: sha512-RznXP7eSDugL3fVYdwIyCXi4I5A2EQ4YBg0tANoPGfo1Eyn1KOTGfzBB8MLogN7TjBbUusw+gzpQ/mBvFc4RhA==}\n-\n   '@next/swc-darwin-arm64@15.5.3':\n     resolution: {integrity: sha512-nzbHQo69+au9wJkGKTU9lP7PXv0d1J5ljFpvb+LnEomLtSbJkbZyEs6sbF3plQmiOB2l9OBtN2tNSvCH1nQ9Jg==}\n     engines: {node: '>= 10'}\n@@ -9174,15 +9174,6 @@ packages:\n     engines: {node: '>=6.0'}\n     hasBin: true\n \n-  eslint-config-next@15.6.0-canary.36:\n-    resolution: {integrity: sha512-v7uPmVVRtO3RFjaFsXoXdI60TWzPIZXAWO3HifrEC/y4Pr4y16LeWH45uxSc9H78V6D3iTOisSZeBdVr87MwoQ==}\n-    peerDependencies:\n-      eslint: ^7.23.0 || ^8.0.0 || ^9.0.0\n-      typescript: '>=3.3.1'\n-    peerDependenciesMeta:\n-      typescript:\n-        optional: true\n-\n   eslint-formatter-codeframe@7.32.1:\n     resolution: {integrity: sha512-DK/3Q3+zVKq/7PdSYiCxPrsDF8H/TRMK5n8Hziwr4IMkMy+XiKSwbpj25AdajS63I/B61Snetq4uVvX9fOLyAg==}\n     engines: {node: ^10.12.0 || >=12.0.0}\n@@ -11073,6 +11064,10 @@ packages:\n   is-lambda@1.0.1:\n     resolution: {integrity: sha512-z7CMFGNrENq5iFB9Bqo64Xk6Y9sg+epq1myIcdHaGnbMTYOxvzsEtdYqQUylB7LxfkvgrrjP32T6Ywciio9UIQ==}\n \n+  is-local-address@2.2.2:\n+    resolution: {integrity: sha512-0f589LeYFladIRZrCx1uVjkAlRF5CPGKDuJgbwVGceRN2Q691MFxH+epioG7krwIfnqcE+kw5MohzXYx2VX2ew==}\n+    engines: {node: '>= 10'}\n+\n   is-map@2.0.3:\n     resolution: {integrity: sha512-1Qed0/Hr2m+YqxnM09CjA2d/i6YZNfF6R2oRAOj36eUdS6qIV/huPJNSEpKbupewFs+ZsJlxsjjPbc0/afW6Lw==}\n     engines: {node: '>= 0.4'}\n@@ -14773,6 +14768,7 @@ packages:\n     engines: {node: '>=0.6.0', teleport: '>=0.2.0'}\n     deprecated: |-\n       You or someone you depend on is using Q, the JavaScript Promise library that gave JavaScript developers strong feelings about promises. They can almost certainly migrate to the native JavaScript promise now. Thank you literally everyone for joining me in this bet against the odds. Be excellent to each other.\n+\n       (For a CapTP with native promises, see @endo/eventual-send and @endo/captp)\n \n   qs@6.11.0:\n@@ -21093,10 +21089,6 @@ snapshots:\n \n   '@next/env@15.5.3': {}\n \n-  '@next/eslint-plugin-next@15.6.0-canary.36':\n-    dependencies:\n-      fast-glob: 3.3.1\n-\n   '@next/swc-darwin-arm64@15.5.3':\n     optional: true\n \n@@ -26754,26 +26746,6 @@ snapshots:\n     optionalDependencies:\n       source-map: 0.6.1\n \n-  eslint-config-next@15.6.0-canary.36(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2):\n-    dependencies:\n-      '@next/eslint-plugin-next': 15.6.0-canary.36\n-      '@rushstack/eslint-patch': 1.10.4\n-      '@typescript-eslint/eslint-plugin': 8.36.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2)\n-      '@typescript-eslint/parser': 8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2)\n-      eslint: 9.12.0(jiti@2.5.1)\n-      eslint-import-resolver-node: 0.3.9\n-      eslint-import-resolver-typescript: 3.6.3(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-plugin-import@2.31.0)(eslint@9.12.0(jiti@2.5.1))\n-      eslint-plugin-import: 2.31.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1))\n-      eslint-plugin-jsx-a11y: 6.10.0(eslint@9.12.0(jiti@2.5.1))\n-      eslint-plugin-react: 7.37.1(eslint@9.12.0(jiti@2.5.1))\n-      eslint-plugin-react-hooks: 5.0.0(eslint@9.12.0(jiti@2.5.1))\n-    optionalDependencies:\n-      typescript: 5.9.2\n-    transitivePeerDependencies:\n-      - eslint-import-resolver-webpack\n-      - eslint-plugin-import-x\n-      - supports-color\n-\n   eslint-formatter-codeframe@7.32.1:\n     dependencies:\n       '@babel/code-frame': 7.12.11\n@@ -26807,26 +26779,6 @@ snapshots:\n       - eslint-import-resolver-webpack\n       - supports-color\n \n-  eslint-import-resolver-typescript@3.6.3(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-plugin-import@2.31.0)(eslint@9.12.0(jiti@2.5.1)):\n-    dependencies:\n-      '@nolyfill/is-core-module': 1.0.39\n-      debug: 4.3.7\n-      enhanced-resolve: 5.17.1\n-      eslint: 9.12.0(jiti@2.5.1)\n-      eslint-module-utils: 2.12.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-import-resolver-typescript@3.6.3(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-plugin-import@2.31.0)(eslint@9.12.0(jiti@2.5.1)))(eslint@9.12.0(jiti@2.5.1))\n-      fast-glob: 3.3.2\n-      get-tsconfig: 4.8.1\n-      is-bun-module: 1.2.1\n-      is-glob: 4.0.3\n-    optionalDependencies:\n-      eslint-plugin-import: 2.31.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1))\n-      eslint-plugin-import-x: 4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2)\n-    transitivePeerDependencies:\n-      - '@typescript-eslint/parser'\n-      - eslint-import-resolver-node\n-      - eslint-import-resolver-webpack\n-      - supports-color\n-\n   eslint-mdx@3.1.5(eslint@9.12.0(jiti@2.5.1)):\n     dependencies:\n       acorn: 8.14.0\n@@ -26859,14 +26811,13 @@ snapshots:\n     transitivePeerDependencies:\n       - supports-color\n \n-  eslint-module-utils@2.12.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-import-resolver-typescript@3.6.3(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-plugin-import@2.31.0)(eslint@9.12.0(jiti@2.5.1)))(eslint@9.12.0(jiti@2.5.1)):\n+  eslint-module-utils@2.12.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint@9.12.0(jiti@2.5.1)):\n     dependencies:\n       debug: 3.2.7\n     optionalDependencies:\n       '@typescript-eslint/parser': 8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2)\n       eslint: 9.12.0(jiti@2.5.1)\n       eslint-import-resolver-node: 0.3.9\n-      eslint-import-resolver-typescript: 3.6.3(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-plugin-import@2.31.0)(eslint@9.12.0(jiti@2.5.1))\n     transitivePeerDependencies:\n       - supports-color\n \n@@ -26894,24 +26845,6 @@ snapshots:\n       - typescript\n     optional: true\n \n-  eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2):\n-    dependencies:\n-      '@typescript-eslint/utils': 8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2)\n-      debug: 4.4.0\n-      doctrine: 3.0.0\n-      eslint: 9.12.0(jiti@2.5.1)\n-      eslint-import-resolver-node: 0.3.9\n-      get-tsconfig: 4.10.0\n-      is-glob: 4.0.3\n-      minimatch: 9.0.5\n-      semver: 7.6.3\n-      stable-hash: 0.0.4\n-      tslib: 2.8.1\n-    transitivePeerDependencies:\n-      - supports-color\n-      - typescript\n-    optional: true\n-\n   eslint-plugin-import@2.31.0(@typescript-eslint/parser@7.16.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.6.3))(eslint-import-resolver-typescript@3.6.3)(eslint@9.12.0(jiti@2.5.1)):\n     dependencies:\n       '@rtsao/scc': 1.1.0\n@@ -26941,35 +26874,6 @@ snapshots:\n       - eslint-import-resolver-webpack\n       - supports-color\n \n-  eslint-plugin-import@2.31.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-typescript@3.6.3)(eslint@9.12.0(jiti@2.5.1)):\n-    dependencies:\n-      '@rtsao/scc': 1.1.0\n-      array-includes: 3.1.8\n-      array.prototype.findlastindex: 1.2.5\n-      array.prototype.flat: 1.3.2\n-      array.prototype.flatmap: 1.3.2\n-      debug: 3.2.7\n-      doctrine: 2.1.0\n-      eslint: 9.12.0(jiti@2.5.1)\n-      eslint-import-resolver-node: 0.3.9\n-      eslint-module-utils: 2.12.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-import-resolver-typescript@3.6.3(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-plugin-import@2.31.0)(eslint@9.12.0(jiti@2.5.1)))(eslint@9.12.0(jiti@2.5.1))\n-      hasown: 2.0.2\n-      is-core-module: 2.15.1\n-      is-glob: 4.0.3\n-      minimatch: 3.1.2\n-      object.fromentries: 2.0.8\n-      object.groupby: 1.0.3\n-      object.values: 1.2.0\n-      semver: 6.3.1\n-      string.prototype.trimend: 1.0.8\n-      tsconfig-paths: 3.15.0\n-    optionalDependencies:\n-      '@typescript-eslint/parser': 8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2)\n-    transitivePeerDependencies:\n-      - eslint-import-resolver-typescript\n-      - eslint-import-resolver-webpack\n-      - supports-color\n-\n   eslint-plugin-import@2.31.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint@9.12.0(jiti@2.5.1)):\n     dependencies:\n       '@rtsao/scc': 1.1.0\n@@ -26981,7 +26885,7 @@ snapshots:\n       doctrine: 2.1.0\n       eslint: 9.12.0(jiti@2.5.1)\n       eslint-import-resolver-node: 0.3.9\n-      eslint-module-utils: 2.12.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-import-resolver-typescript@3.6.3(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint-plugin-import-x@4.3.1(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-plugin-import@2.31.0)(eslint@9.12.0(jiti@2.5.1)))(eslint@9.12.0(jiti@2.5.1))\n+      eslint-module-utils: 2.12.0(@typescript-eslint/parser@8.36.0(eslint@9.12.0(jiti@2.5.1))(typescript@5.9.2))(eslint-import-resolver-node@0.3.9)(eslint@9.12.0(jiti@2.5.1))\n       hasown: 2.0.2\n       is-core-module: 2.15.1\n       is-glob: 4.0.3\n@@ -29475,6 +29379,8 @@ snapshots:\n \n   is-lambda@1.0.1: {}\n \n+  is-local-address@2.2.2: {}\n+\n   is-map@2.0.3: {}\n \n   is-module@1.0.0: {}"
        },
        {
            "sha": "e78fa6c67202d1d65b96c18c1cd5816b0f270858",
            "filename": "test/integration/image-optimizer/test/maximum-redirects-0.test.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fmaximum-redirects-0.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fmaximum-redirects-0.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fmaximum-redirects-0.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -0,0 +1,23 @@\n+import { join } from 'path'\n+import { setupTests } from './util'\n+\n+const appDir = join(__dirname, '../app')\n+\n+describe('with maximumRedirects 0', () => {\n+  setupTests({\n+    nextConfigImages: {\n+      dangerouslyAllowLocalIP: true,\n+      // Configure external domains so we can try out external redirects\n+      domains: [\n+        'localhost',\n+        '127.0.0.1',\n+        'example.com',\n+        'assets.vercel.com',\n+        'image-optimization-test.vercel.app',\n+      ],\n+      // Prevent redirects\n+      maximumRedirects: 0,\n+    },\n+    appDir,\n+  })\n+})"
        },
        {
            "sha": "2a774169d592d940add17f2abdc3293dfb3789a6",
            "filename": "test/integration/image-optimizer/test/maximum-redirects-1.test.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fmaximum-redirects-1.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fmaximum-redirects-1.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fmaximum-redirects-1.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -0,0 +1,23 @@\n+import { join } from 'path'\n+import { setupTests } from './util'\n+\n+const appDir = join(__dirname, '../app')\n+\n+describe('with maximumRedirects 1', () => {\n+  setupTests({\n+    nextConfigImages: {\n+      dangerouslyAllowLocalIP: true,\n+      // Configure external domains so we can try out external redirects\n+      domains: [\n+        'localhost',\n+        '127.0.0.1',\n+        'example.com',\n+        'assets.vercel.com',\n+        'image-optimization-test.vercel.app',\n+      ],\n+      // Only one redirect\n+      maximumRedirects: 1,\n+    },\n+    appDir,\n+  })\n+})"
        },
        {
            "sha": "ebe1ef4fc7ab5a041535319f1cd6630c4e3f646c",
            "filename": "test/integration/image-optimizer/test/minimum-cache-ttl.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fminimum-cache-ttl.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fminimum-cache-ttl.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fminimum-cache-ttl.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -6,6 +6,7 @@ const appDir = join(__dirname, '../app')\n describe('with minimumCacheTTL of 5 sec', () => {\n   setupTests({\n     nextConfigImages: {\n+      dangerouslyAllowLocalIP: true,\n       // Configure external domains so we can try out\n       // variations of the upstream Cache-Control header.\n       domains: ["
        },
        {
            "sha": "3682ea1d04689e601214e84ac667e7d7aacf0f56",
            "filename": "test/integration/image-optimizer/test/util.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 10,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -36,6 +36,7 @@ type RunTestsCtx = SetupTestsCtx & {\n   nextOutput?: string\n }\n \n+let infiniteRedirect = 0\n const largeSize = 1080 // defaults defined in server/config.ts\n const animatedWarnText =\n   'is an animated image so it will not be optimized. Consider adding the \"unoptimized\" property to the <Image>.'\n@@ -44,15 +45,32 @@ export async function serveSlowImage() {\n   const port = await findPort()\n   const server = http.createServer(async (req, res) => {\n     const parsedUrl = new URL(req.url, 'http://localhost')\n-    const delay = Number(parsedUrl.searchParams.get('delay')) || 500\n+    const delay = Number(parsedUrl.searchParams.get('delay')) || 0\n     const status = Number(parsedUrl.searchParams.get('status')) || 200\n+    const location = parsedUrl.searchParams.get('location')\n \n     console.log('delaying image for', delay)\n     await waitFor(delay)\n \n     res.statusCode = status\n \n-    if (status === 308) {\n+    if (infiniteRedirect > 0 && infiniteRedirect < 1000) {\n+      infiniteRedirect++\n+      res.statusCode = 308\n+      console.log('infinite redirect', location)\n+      res.setHeader('location', '/')\n+      res.end()\n+      return\n+    }\n+\n+    if (status === 301 && location) {\n+      console.log('redirecting to location', location)\n+      res.setHeader('location', location)\n+      res.end()\n+      return\n+    }\n+\n+    if (status === 399) {\n       res.end('invalid status')\n       return\n     }\n@@ -163,6 +181,8 @@ export function runTests(ctx: RunTestsCtx) {\n     domains = [],\n     formats = [],\n     minimumCacheTTL = 14400,\n+    maximumRedirects = 3,\n+    dangerouslyAllowLocalIP,\n   } = nextConfigImages || {}\n   const avifEnabled = formats[0] === 'image/avif'\n   let slowImageServer: Awaited<ReturnType<typeof serveSlowImage>>\n@@ -173,9 +193,9 @@ export function runTests(ctx: RunTestsCtx) {\n     slowImageServer.stop()\n   })\n \n-  if (domains.length > 0) {\n+  if (domains.length > 0 && dangerouslyAllowLocalIP) {\n     it('should normalize invalid status codes', async () => {\n-      const url = `http://localhost:${slowImageServer.port}/slow.png?delay=${1}&status=308`\n+      const url = `http://localhost:${slowImageServer.port}/slow.png?status=399`\n       const query = { url, w: ctx.w, q: ctx.q }\n       const opts: RequestInit = {\n         headers: { accept: 'image/webp' },\n@@ -194,6 +214,35 @@ export function runTests(ctx: RunTestsCtx) {\n     })\n   }\n \n+  if (domains.length > 0) {\n+    it('should follow redirect from http to https when maximumRedirects > 0', async () => {\n+      const url = `http://image-optimization-test.vercel.app/frog.png`\n+      const query = { url, w: ctx.w, q: ctx.q }\n+      const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n+      expect(res.status).toBe(maximumRedirects > 0 ? 200 : 508)\n+    })\n+\n+    it('should follow redirect when dangerouslyAllowLocalIP enabled', async () => {\n+      const url = `http://localhost:${slowImageServer.port}?status=301&location=%2Fslow.png`\n+      const query = { url, w: ctx.w, q: ctx.q }\n+      const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n+      let expectedStatus = dangerouslyAllowLocalIP ? 200 : 400\n+      if (maximumRedirects === 0) {\n+        expectedStatus = 508\n+      }\n+      expect(res.status).toBe(expectedStatus)\n+    })\n+\n+    it('should return 508 after redirecting too many times', async () => {\n+      infiniteRedirect = 1\n+      const url = `http://localhost:${slowImageServer.port}`\n+      const query = { url, w: ctx.w, q: ctx.q }\n+      const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n+      expect(res.status).toBe(508)\n+      infiniteRedirect = 0\n+    })\n+  }\n+\n   it('should return home page', async () => {\n     const res = await fetchViaHTTP(ctx.appPort, '/', null, {})\n     expect(await res.text()).toMatch(/Image Optimizer Home/m)\n@@ -887,7 +936,7 @@ export function runTests(ctx: RunTestsCtx) {\n     })\n   }\n \n-  if (domains.length > 0) {\n+  if (domains.length > 0 && dangerouslyAllowLocalIP) {\n     it('should resize absolute url from localhost', async () => {\n       const url = `http://localhost:${ctx.appPort}/test.png`\n       const query = { url, w: ctx.w, q: ctx.q }\n@@ -1043,7 +1092,7 @@ export function runTests(ctx: RunTestsCtx) {\n   }\n \n   it('should fail when url has file protocol', async () => {\n-    const url = `file://localhost:${ctx.appPort}/test.png`\n+    const url = `file://example.vercel.sh:${ctx.appPort}/test.png`\n     const query = { url, w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n@@ -1052,7 +1101,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should fail when url has ftp protocol', async () => {\n-    const url = `ftp://localhost:${ctx.appPort}/test.png`\n+    const url = `ftp://example.vercel.sh:${ctx.appPort}/test.png`\n     const query = { url, w: ctx.w, q: ctx.q }\n     const opts = { headers: { accept: 'image/webp' } }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, opts)\n@@ -1068,7 +1117,7 @@ export function runTests(ctx: RunTestsCtx) {\n   })\n \n   it('should fail when url is protocol relative', async () => {\n-    const query = { url: `//example.com`, w: ctx.w, q: ctx.q }\n+    const query = { url: `//example.vercel.sh`, w: ctx.w, q: ctx.q }\n     const res = await fetchViaHTTP(ctx.appPort, '/_next/image', query, {})\n     expect(res.status).toBe(400)\n     expect(await res.text()).toBe(\n@@ -1139,7 +1188,7 @@ export function runTests(ctx: RunTestsCtx) {\n     )\n   })\n \n-  if (domains.length > 0) {\n+  if (domains.length > 0 && dangerouslyAllowLocalIP) {\n     it('should fail when url fails to load an image', async () => {\n       const url = `http://localhost:${ctx.appPort}/not-an-image`\n       const query = { w: ctx.w, url, q: ctx.q }\n@@ -1489,7 +1538,7 @@ export function runTests(ctx: RunTestsCtx) {\n     expect(await res.text()).toBe(\"The requested resource isn't a valid image.\")\n   })\n \n-  if (domains.length > 0) {\n+  if (domains.length > 0 && dangerouslyAllowLocalIP) {\n     it('should handle concurrent requests', async () => {\n       await cleanImagesDir(ctx.imagesDir)\n       const delay = 500\n@@ -1614,6 +1663,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n       q: 100,\n       isDev,\n       nextConfigImages: {\n+        dangerouslyAllowLocalIP: true,\n         domains: [\n           'localhost',\n           '127.0.0.1',\n@@ -1710,6 +1760,7 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n       q: 100,\n       isDev,\n       nextConfigImages: {\n+        dangerouslyAllowLocalIP: true,\n         domains: [\n           'localhost',\n           '127.0.0.1',"
        },
        {
            "sha": "8cfc8a713b5527e9875e4fbc5a5d51d517b19529",
            "filename": "test/integration/next-image-new/app-dir-localpatterns/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir-localpatterns%2Ftest%2Findex.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -75,6 +75,7 @@ function runTests(mode: 'dev' | 'server') {\n           contentDispositionType: 'attachment',\n           contentSecurityPolicy:\n             \"script-src 'none'; frame-src 'none'; sandbox;\",\n+          dangerouslyAllowLocalIP: false,\n           dangerouslyAllowSVG: false,\n           deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],\n           disableStaticImages: false,\n@@ -96,6 +97,7 @@ function runTests(mode: 'dev' | 'server') {\n               search: '',\n             },\n           ],\n+          maximumRedirects: 3,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [75],"
        },
        {
            "sha": "8589d740bd9299c5e1f89b12e51314cee91c1b16",
            "filename": "test/integration/next-image-new/app-dir-qualities/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir-qualities%2Ftest%2Findex.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -92,6 +92,7 @@ function runTests(mode: 'dev' | 'server') {\n           contentDispositionType: 'attachment',\n           contentSecurityPolicy:\n             \"script-src 'none'; frame-src 'none'; sandbox;\",\n+          dangerouslyAllowLocalIP: false,\n           dangerouslyAllowSVG: false,\n           deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],\n           disableStaticImages: false,\n@@ -108,6 +109,7 @@ function runTests(mode: 'dev' | 'server') {\n               search: '',\n             },\n           ],\n+          maximumRedirects: 3,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [42, 69, 88],"
        },
        {
            "sha": "821982b6bb870c98f11ba66903600b8cac0a7a11",
            "filename": "test/integration/next-image-new/app-dir/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Fapp-dir%2Ftest%2Findex.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -1778,6 +1778,7 @@ function runTests(mode: 'dev' | 'server') {\n           contentDispositionType: 'attachment',\n           contentSecurityPolicy:\n             \"script-src 'none'; frame-src 'none'; sandbox;\",\n+          dangerouslyAllowLocalIP: false,\n           dangerouslyAllowSVG: false,\n           deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],\n           disableStaticImages: false,\n@@ -1794,6 +1795,7 @@ function runTests(mode: 'dev' | 'server') {\n               search: '',\n             },\n           ],\n+          maximumRedirects: 3,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [75],"
        },
        {
            "sha": "7d2beb43aa72408230b9675d060c7a4ecc84251f",
            "filename": "test/integration/next-image-new/unicode/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Funicode%2Ftest%2Findex.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -75,6 +75,7 @@ function runTests(mode: 'server' | 'dev') {\n           contentDispositionType: 'attachment',\n           contentSecurityPolicy:\n             \"script-src 'none'; frame-src 'none'; sandbox;\",\n+          dangerouslyAllowLocalIP: false,\n           dangerouslyAllowSVG: false,\n           deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],\n           disableStaticImages: false,\n@@ -101,6 +102,7 @@ function runTests(mode: 'server' | 'dev') {\n               search: '',\n             },\n           ],\n+          maximumRedirects: 3,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [75],"
        },
        {
            "sha": "4c78061c99668a218a7990bf367eb5591d4dcbde",
            "filename": "test/integration/next-image-new/unoptimized/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fnext-image-new%2Funoptimized%2Ftest%2Findex.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -100,6 +100,7 @@ function runTests(url: string, mode: 'dev' | 'server') {\n           contentDispositionType: 'attachment',\n           contentSecurityPolicy:\n             \"script-src 'none'; frame-src 'none'; sandbox;\",\n+          dangerouslyAllowLocalIP: false,\n           dangerouslyAllowSVG: false,\n           deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],\n           disableStaticImages: false,\n@@ -116,6 +117,7 @@ function runTests(url: string, mode: 'dev' | 'server') {\n               search: '',\n             },\n           ],\n+          maximumRedirects: 3,\n           minimumCacheTTL: 14400,\n           path: '/_next/image',\n           qualities: [75],"
        },
        {
            "sha": "ea49dc5a597322b860a5f0d9272241636a0a2891",
            "filename": "test/production/next-server-nft/next-server-nft.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d415853f73c72263d24be3ea92b497d41f242f0/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts?ref=8d415853f73c72263d24be3ea92b497d41f242f0",
            "patch": "@@ -138,6 +138,7 @@ const isReact18 = parseInt(process.env.NEXT_TEST_REACT_VERSION) === 18\n          \"/node_modules/next/dist/compiled/image-detector/detector.js\",\n          \"/node_modules/next/dist/compiled/image-size/index.js\",\n          \"/node_modules/next/dist/compiled/is-animated/index.js\",\n+         \"/node_modules/next/dist/compiled/is-local-address/index.js\",\n          \"/node_modules/next/dist/compiled/jsonwebtoken/index.js\",\n          \"/node_modules/next/dist/compiled/nanoid/index.cjs\",\n          \"/node_modules/next/dist/compiled/next-server/app-page-turbo-experimental.runtime.prod.js\","
        }
    ],
    "stats": {
        "total": 387,
        "additions": 266,
        "deletions": 121
    }
}