{
    "author": "mischnic",
    "message": "Turbopack: more module ident collisions (#78207)\n\nFixes two more module ident collisions\n\n1. `ContextTransition` is a massive footgun, because it reuses the transitions from the parent context. So it essentially always creates a new context (which is not actually what we want), e.g. here this created two different `app-edge-shared` contexts because `app-edge-rsc` and `app-edge-ssr` have different transitions.\nI hope this wasn't by design?\n\n```\nnext/dist/esm/server/app-render/after-task-async-storage.external.js [app-edge-rsc]\n->\nnext/dist/esm/server/app-render/after-task-async-storage-instance.js [app-edge-shared]\n\n\nnext/dist/esm/server/app-render/after-task-async-storage.external.js [app-edge-ssr]\n-> \nnext/dist/esm/server/app-render/after-task-async-storage-instance.js [app-edge-shared]\n```\n\n\n2. The client module proxy module was missing its layer in the identifier (the layer of the proxy module, i.e. `app-edge-rsc` or `app-rsc`). It's correct that there are two different modules.",
    "sha": "902b58c04bb943242c2866ce8eb46ba5f05ba091",
    "files": [
        {
            "sha": "b6d4736a0046bc3713849cab2e181f2c94995f91",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 27,
            "deletions": 7,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/902b58c04bb943242c2866ce8eb46ba5f05ba091/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/902b58c04bb943242c2866ce8eb46ba5f05ba091/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=902b58c04bb943242c2866ce8eb46ba5f05ba091",
            "patch": "@@ -47,7 +47,7 @@ use turbo_tasks_fs::{File, FileContent, FileSystemPath};\n use turbopack::{\n     module_options::{transition_rule::TransitionRule, ModuleOptionsContext, RuleCondition},\n     resolve_options_context::ResolveOptionsContext,\n-    transition::{ContextTransition, FullContextTransition, Transition, TransitionOptions},\n+    transition::{FullContextTransition, Transition, TransitionOptions},\n     ModuleAssetContext,\n };\n use turbopack_core::{\n@@ -663,13 +663,22 @@ impl AppProject {\n     }\n \n     #[turbo_tasks::function]\n-    fn shared_transition(self: Vc<Self>) -> Vc<ContextTransition> {\n-        ContextTransition::new(\n+    async fn shared_module_context(self: Vc<Self>) -> Result<Vc<ModuleAssetContext>> {\n+        Ok(ModuleAssetContext::new(\n+            TransitionOptions {\n+                ..Default::default()\n+            }\n+            .cell(),\n             self.project().server_compile_time_info(),\n             self.ssr_module_options_context(),\n             self.ssr_resolve_options_context(),\n             Vc::cell(\"app-shared\".into()),\n-        )\n+        ))\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn shared_transition(self: Vc<Self>) -> Vc<Box<dyn Transition>> {\n+        Vc::upcast(FullContextTransition::new(self.shared_module_context()))\n     }\n \n     #[turbo_tasks::function]\n@@ -714,13 +723,24 @@ impl AppProject {\n     }\n \n     #[turbo_tasks::function]\n-    fn edge_shared_transition(self: Vc<Self>) -> Vc<ContextTransition> {\n-        ContextTransition::new(\n+    async fn edge_shared_module_context(self: Vc<Self>) -> Result<Vc<ModuleAssetContext>> {\n+        Ok(ModuleAssetContext::new(\n+            TransitionOptions {\n+                ..Default::default()\n+            }\n+            .cell(),\n             self.project().edge_compile_time_info(),\n             self.edge_ssr_module_options_context(),\n             self.edge_ssr_resolve_options_context(),\n             Vc::cell(\"app-edge-shared\".into()),\n-        )\n+        ))\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn edge_shared_transition(self: Vc<Self>) -> Vc<Box<dyn Transition>> {\n+        Vc::upcast(FullContextTransition::new(\n+            self.edge_shared_module_context(),\n+        ))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "9e63591bb02630b135e343e3f300e134804fe0c6",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 34,
            "deletions": 19,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/902b58c04bb943242c2866ce8eb46ba5f05ba091/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/902b58c04bb943242c2866ce8eb46ba5f05ba091/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=902b58c04bb943242c2866ce8eb46ba5f05ba091",
            "patch": "@@ -39,7 +39,7 @@ use turbo_tasks_fs::{\n use turbopack::{\n     module_options::ModuleOptionsContext,\n     resolve_options_context::ResolveOptionsContext,\n-    transition::{ContextTransition, TransitionOptions},\n+    transition::{FullContextTransition, Transition, TransitionOptions},\n     ModuleAssetContext,\n };\n use turbopack_core::{\n@@ -290,7 +290,27 @@ impl PagesProject {\n     }\n \n     #[turbo_tasks::function]\n-    async fn transitions(self: Vc<Self>) -> Result<Vc<TransitionOptions>> {\n+    async fn client_transitions(self: Vc<Self>) -> Result<Vc<TransitionOptions>> {\n+        Ok(TransitionOptions {\n+            named_transitions: [\n+                (\n+                    \"next-dynamic\".into(),\n+                    ResolvedVc::upcast(NextDynamicTransition::new_marker().to_resolved().await?),\n+                ),\n+                (\n+                    \"next-dynamic-client\".into(),\n+                    ResolvedVc::upcast(NextDynamicTransition::new_marker().to_resolved().await?),\n+                ),\n+            ]\n+            .into_iter()\n+            .collect(),\n+            ..Default::default()\n+        }\n+        .cell())\n+    }\n+\n+    #[turbo_tasks::function]\n+    async fn server_transitions(self: Vc<Self>) -> Result<Vc<TransitionOptions>> {\n         Ok(TransitionOptions {\n             named_transitions: [\n                 (\n@@ -314,13 +334,8 @@ impl PagesProject {\n     }\n \n     #[turbo_tasks::function]\n-    fn client_transition(self: Vc<Self>) -> Vc<ContextTransition> {\n-        ContextTransition::new(\n-            self.project().client_compile_time_info(),\n-            self.client_module_options_context(),\n-            self.client_resolve_options_context(),\n-            client_layer(),\n-        )\n+    fn client_transition(self: Vc<Self>) -> Vc<Box<dyn Transition>> {\n+        Vc::upcast(FullContextTransition::new(self.client_module_context()))\n     }\n \n     #[turbo_tasks::function]\n@@ -353,20 +368,20 @@ impl PagesProject {\n     }\n \n     #[turbo_tasks::function]\n-    pub(super) fn client_module_context(self: Vc<Self>) -> Vc<Box<dyn AssetContext>> {\n-        Vc::upcast(ModuleAssetContext::new(\n-            self.transitions(),\n+    pub(super) fn client_module_context(self: Vc<Self>) -> Vc<ModuleAssetContext> {\n+        ModuleAssetContext::new(\n+            self.client_transitions(),\n             self.project().client_compile_time_info(),\n             self.client_module_options_context(),\n             self.client_resolve_options_context(),\n             client_layer(),\n-        ))\n+        )\n     }\n \n     #[turbo_tasks::function]\n     pub(super) fn ssr_module_context(self: Vc<Self>) -> Vc<ModuleAssetContext> {\n         ModuleAssetContext::new(\n-            self.transitions(),\n+            self.server_transitions(),\n             self.project().server_compile_time_info(),\n             self.ssr_module_options_context(),\n             self.ssr_resolve_options_context(),\n@@ -379,7 +394,7 @@ impl PagesProject {\n     #[turbo_tasks::function]\n     pub(super) fn api_module_context(self: Vc<Self>) -> Vc<ModuleAssetContext> {\n         ModuleAssetContext::new(\n-            self.transitions(),\n+            self.server_transitions(),\n             self.project().server_compile_time_info(),\n             self.api_module_options_context(),\n             self.ssr_resolve_options_context(),\n@@ -390,7 +405,7 @@ impl PagesProject {\n     #[turbo_tasks::function]\n     pub(super) fn ssr_data_module_context(self: Vc<Self>) -> Vc<ModuleAssetContext> {\n         ModuleAssetContext::new(\n-            self.transitions(),\n+            self.server_transitions(),\n             self.project().server_compile_time_info(),\n             self.ssr_data_module_options_context(),\n             self.ssr_resolve_options_context(),\n@@ -566,7 +581,7 @@ impl PagesProject {\n             self.project().next_config(),\n             self.project().execution_context(),\n         );\n-        Ok(client_runtime_entries.resolve_entries(self.client_module_context()))\n+        Ok(client_runtime_entries.resolve_entries(Vc::upcast(self.client_module_context())))\n     }\n \n     #[turbo_tasks::function]\n@@ -615,7 +630,7 @@ impl PagesProject {\n \n     #[turbo_tasks::function]\n     pub async fn client_main_module(self: Vc<Self>) -> Result<Vc<Box<dyn Module>>> {\n-        let client_module_context = self.client_module_context();\n+        let client_module_context = Vc::upcast(self.client_module_context());\n \n         let client_main_module = esm_resolve(\n             Vc::upcast(PlainResolveOrigin::new(\n@@ -722,7 +737,7 @@ impl PageEndpoint {\n     async fn client_module(self: Vc<Self>) -> Result<Vc<Box<dyn Module>>> {\n         let this = self.await?;\n         let page_loader = create_page_loader_entry_module(\n-            this.pages_project.client_module_context(),\n+            Vc::upcast(this.pages_project.client_module_context()),\n             self.source(),\n             *this.pathname,\n         );"
        },
        {
            "sha": "7ffe7792cf56026fd5c534e23874df6b4821cea8",
            "filename": "crates/next-core/src/next_client_reference/ecmascript_client_reference/ecmascript_client_reference_module.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/902b58c04bb943242c2866ce8eb46ba5f05ba091/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/902b58c04bb943242c2866ce8eb46ba5f05ba091/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs?ref=902b58c04bb943242c2866ce8eb46ba5f05ba091",
            "patch": "@@ -179,7 +179,7 @@ impl EcmascriptClientReferenceModule {\n \n #[turbo_tasks::function]\n fn client_reference_modifier() -> Vc<RcStr> {\n-    Vc::cell(\"client reference/proxy\".into())\n+    Vc::cell(\"client reference proxy\".into())\n }\n \n #[turbo_tasks::function]\n@@ -200,7 +200,9 @@ pub static ECMASCRIPT_CLIENT_REFERENCE_MERGE_TAG_SSR: Lazy<RcStr> = Lazy::new(||\n impl Module for EcmascriptClientReferenceModule {\n     #[turbo_tasks::function]\n     fn ident(&self) -> Vc<AssetIdent> {\n-        self.server_ident.with_modifier(client_reference_modifier())\n+        self.server_ident\n+            .with_modifier(client_reference_modifier())\n+            .with_layer(self.server_asset_context.layer())\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "a245218de7d5f304c4dc6878b726b1a1a5830c8a",
            "filename": "turbopack/crates/turbopack/src/transition/context_transition.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 66,
            "changes": 66,
            "blob_url": "https://github.com/vercel/next.js/blob/2a91953e663ed5f2c583ef6ac604a6c1a753391b/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Ftransition%2Fcontext_transition.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2a91953e663ed5f2c583ef6ac604a6c1a753391b/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Ftransition%2Fcontext_transition.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Ftransition%2Fcontext_transition.rs?ref=2a91953e663ed5f2c583ef6ac604a6c1a753391b",
            "patch": "@@ -1,66 +0,0 @@\n-use turbo_rcstr::RcStr;\n-use turbo_tasks::{ResolvedVc, Vc};\n-use turbopack_core::compile_time_info::CompileTimeInfo;\n-use turbopack_resolve::resolve_options_context::ResolveOptionsContext;\n-\n-use crate::{module_options::ModuleOptionsContext, transition::Transition};\n-\n-/// A transition that only affects the asset context.\n-#[turbo_tasks::value(shared)]\n-pub struct ContextTransition {\n-    compile_time_info: ResolvedVc<CompileTimeInfo>,\n-    module_options_context: ResolvedVc<ModuleOptionsContext>,\n-    resolve_options_context: ResolvedVc<ResolveOptionsContext>,\n-    layer: ResolvedVc<RcStr>,\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl ContextTransition {\n-    #[turbo_tasks::function]\n-    pub fn new(\n-        compile_time_info: ResolvedVc<CompileTimeInfo>,\n-        module_options_context: ResolvedVc<ModuleOptionsContext>,\n-        resolve_options_context: ResolvedVc<ResolveOptionsContext>,\n-        layer: ResolvedVc<RcStr>,\n-    ) -> Vc<ContextTransition> {\n-        ContextTransition {\n-            module_options_context,\n-            resolve_options_context,\n-            compile_time_info,\n-            layer,\n-        }\n-        .cell()\n-    }\n-}\n-\n-#[turbo_tasks::value_impl]\n-impl Transition for ContextTransition {\n-    #[turbo_tasks::function]\n-    fn process_compile_time_info(\n-        &self,\n-        _compile_time_info: Vc<CompileTimeInfo>,\n-    ) -> Vc<CompileTimeInfo> {\n-        *self.compile_time_info\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn process_layer(&self, _layer: Vc<RcStr>) -> Vc<RcStr> {\n-        *self.layer\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn process_module_options_context(\n-        &self,\n-        _context: Vc<ModuleOptionsContext>,\n-    ) -> Vc<ModuleOptionsContext> {\n-        *self.module_options_context\n-    }\n-\n-    #[turbo_tasks::function]\n-    fn process_resolve_options_context(\n-        &self,\n-        _context: Vc<ResolveOptionsContext>,\n-    ) -> Vc<ResolveOptionsContext> {\n-        *self.resolve_options_context\n-    }\n-}"
        },
        {
            "sha": "0d0f6b42f68dbff9faa6b540f3b3340d218c31a8",
            "filename": "turbopack/crates/turbopack/src/transition/mod.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/902b58c04bb943242c2866ce8eb46ba5f05ba091/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Ftransition%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/902b58c04bb943242c2866ce8eb46ba5f05ba091/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Ftransition%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Ftransition%2Fmod.rs?ref=902b58c04bb943242c2866ce8eb46ba5f05ba091",
            "patch": "@@ -1,8 +1,6 @@\n-pub(crate) mod context_transition;\n pub(crate) mod full_context_transition;\n \n use anyhow::Result;\n-pub use context_transition::ContextTransition;\n pub use full_context_transition::FullContextTransition;\n use rustc_hash::FxHashMap;\n use turbo_rcstr::RcStr;\n@@ -57,6 +55,14 @@ pub trait Transition {\n         resolve_options_context\n     }\n \n+    /// Apply modifications/wrapping to the transition options\n+    fn process_transition_options(\n+        self: Vc<Self>,\n+        transition_options: Vc<TransitionOptions>,\n+    ) -> Vc<TransitionOptions> {\n+        transition_options\n+    }\n+\n     /// Apply modifications/wrapping to the final asset\n     fn process_module(\n         self: Vc<Self>,\n@@ -79,8 +85,9 @@ pub trait Transition {\n         let resolve_options_context =\n             self.process_resolve_options_context(*module_asset_context.resolve_options_context);\n         let layer = self.process_layer(*module_asset_context.layer);\n+        let transition_options = self.process_transition_options(*module_asset_context.transitions);\n         let module_asset_context = ModuleAssetContext::new(\n-            *module_asset_context.transitions,\n+            transition_options,\n             compile_time_info,\n             module_options_context,\n             resolve_options_context,"
        }
    ],
    "stats": {
        "total": 172,
        "additions": 75,
        "deletions": 97
    }
}