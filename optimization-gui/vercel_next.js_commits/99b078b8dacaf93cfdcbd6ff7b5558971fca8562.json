{
    "author": "unstubbable",
    "message": "Emit build error when `'use cache'` directive is misspelled (#83756)\n\nHandles cases like:\n- `'use cache:remote'` (missing space after colon)\n- `'use cache : default'` (extra space before colon)\n- `'use cache private'` (missing colon)\n- `'use cache: '` (missing cache kind)\n\ncloses NAR-392",
    "sha": "99b078b8dacaf93cfdcbd6ff7b5558971fca8562",
    "files": [
        {
            "sha": "4a395935484e16748ddc9b379ceb9133290f2070",
            "filename": "crates/next-custom-transforms/src/transforms/server_actions.rs",
            "status": "modified",
            "additions": 47,
            "deletions": 13,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/99b078b8dacaf93cfdcbd6ff7b5558971fca8562/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/99b078b8dacaf93cfdcbd6ff7b5558971fca8562/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs?ref=99b078b8dacaf93cfdcbd6ff7b5558971fca8562",
            "patch": "@@ -2739,7 +2739,7 @@ impl DirectiveVisitor<'_> {\n                     });\n                 } else\n                 // `use cache` or `use cache: foo`\n-                if value == \"use cache\" || value.starts_with(\"use cache: \") {\n+                if let Some(rest) = value.strip_prefix(\"use cache\") {\n                     // Increment telemetry counter tracking usage of \"use cache\" directives\n \n                     if in_fn_body && !allow_inline {\n@@ -2759,25 +2759,59 @@ impl DirectiveVisitor<'_> {\n                             });\n                         }\n \n-                        if value == \"use cache\" {\n+                        if rest.is_empty() {\n                             self.directive = Some(Directive::UseCache {\n                                 cache_kind: rcstr!(\"default\"),\n                             });\n+\n                             self.increment_cache_usage_counter(\"default\");\n+\n+                            return true;\n+                        }\n+\n+                        if rest.starts_with(\": \") {\n+                            let cache_kind = RcStr::from(rest.split_at(\": \".len()).1);\n+\n+                            if !cache_kind.is_empty() {\n+                                if !self.config.cache_kinds.contains(&cache_kind) {\n+                                    emit_error(ServerActionsErrorKind::UnknownCacheKind {\n+                                        span: *span,\n+                                        cache_kind: cache_kind.clone(),\n+                                    });\n+                                }\n+\n+                                self.increment_cache_usage_counter(&cache_kind);\n+                                self.directive = Some(Directive::UseCache { cache_kind });\n+\n+                                return true;\n+                            }\n+                        }\n+\n+                        // Emit helpful errors for variants like \"use cache:<cache-kind>\",\n+                        // \"use cache : <cache-kind>\", and \"use cache <cache-kind>\" etc.\n+                        let expected_directive = if let Some(colon_pos) = rest.find(':') {\n+                            let kind = rest[colon_pos + 1..].trim();\n+\n+                            if kind.is_empty() {\n+                                \"use cache: <cache-kind>\".to_string()\n+                            } else {\n+                                format!(\"use cache: {kind}\")\n+                            }\n                         } else {\n-                            // Slice the value after \"use cache: \"\n-                            let cache_kind = RcStr::from(value.split_at(\"use cache: \".len()).1);\n-\n-                            if !self.config.cache_kinds.contains(&cache_kind) {\n-                                emit_error(ServerActionsErrorKind::UnknownCacheKind {\n-                                    span: *span,\n-                                    cache_kind: cache_kind.clone(),\n-                                });\n+                            let kind = rest.trim();\n+\n+                            if kind.is_empty() {\n+                                \"use cache\".to_string()\n+                            } else {\n+                                format!(\"use cache: {kind}\")\n                             }\n+                        };\n \n-                            self.increment_cache_usage_counter(&cache_kind);\n-                            self.directive = Some(Directive::UseCache { cache_kind });\n-                        }\n+                        emit_error(ServerActionsErrorKind::MisspelledDirective {\n+                            span: *span,\n+                            directive: value.to_string(),\n+                            expected_directive,\n+                        });\n \n                         return true;\n                     } else {"
        },
        {
            "sha": "fd113557371ebdb908dc54850719b9b475f16222",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/28/input.js",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/99b078b8dacaf93cfdcbd6ff7b5558971fca8562/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99b078b8dacaf93cfdcbd6ff7b5558971fca8562/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Finput.js?ref=99b078b8dacaf93cfdcbd6ff7b5558971fca8562",
            "patch": "@@ -0,0 +1,25 @@\n+'use cache:remote'\n+\n+export async function foo() {\n+  return 'data'\n+}\n+\n+export async function bar() {\n+  'use cache : default'\n+  return 'data'\n+}\n+\n+export async function baz() {\n+  'use cache private'\n+  return 'data'\n+}\n+\n+export async function qux() {\n+  'use cache '\n+  return 'data'\n+}\n+\n+export async function quux() {\n+  'use cache: '\n+  return 'data'\n+}"
        },
        {
            "sha": "ddb56ad5fb81173c82417442a0c6eec17e63346e",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/28/output.js",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/99b078b8dacaf93cfdcbd6ff7b5558971fca8562/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99b078b8dacaf93cfdcbd6ff7b5558971fca8562/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Foutput.js?ref=99b078b8dacaf93cfdcbd6ff7b5558971fca8562",
            "patch": "@@ -0,0 +1,15 @@\n+export async function foo() {\n+    return 'data';\n+}\n+export async function bar() {\n+    return 'data';\n+}\n+export async function baz() {\n+    return 'data';\n+}\n+export async function qux() {\n+    return 'data';\n+}\n+export async function quux() {\n+    return 'data';\n+}"
        },
        {
            "sha": "27851d4d4f4296aa29303a8eb8976532ebc3f630",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/28/output.stderr",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/99b078b8dacaf93cfdcbd6ff7b5558971fca8562/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/99b078b8dacaf93cfdcbd6ff7b5558971fca8562/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F28%2Foutput.stderr?ref=99b078b8dacaf93cfdcbd6ff7b5558971fca8562",
            "patch": "@@ -0,0 +1,38 @@\n+  x Did you mean \"use cache: remote\"? \"use cache:remote\" is not a supported directive name.\"\n+  | \n+   ,-[input.js:1:1]\n+ 1 | 'use cache:remote'\n+   : ^^^^^^^^^^^^^^^^^^\n+   `----\n+  x Did you mean \"use cache: default\"? \"use cache : default\" is not a supported directive name.\"\n+  | \n+   ,-[input.js:8:1]\n+ 7 | export async function bar() {\n+ 8 |   'use cache : default'\n+   :   ^^^^^^^^^^^^^^^^^^^^^\n+ 9 |   return 'data'\n+   `----\n+  x Did you mean \"use cache: private\"? \"use cache private\" is not a supported directive name.\"\n+  | \n+    ,-[input.js:13:1]\n+ 12 | export async function baz() {\n+ 13 |   'use cache private'\n+    :   ^^^^^^^^^^^^^^^^^^^\n+ 14 |   return 'data'\n+    `----\n+  x Did you mean \"use cache\"? \"use cache \" is not a supported directive name.\"\n+  | \n+    ,-[input.js:18:1]\n+ 17 | export async function qux() {\n+ 18 |   'use cache '\n+    :   ^^^^^^^^^^^^\n+ 19 |   return 'data'\n+    `----\n+  x Did you mean \"use cache: <cache-kind>\"? \"use cache: \" is not a supported directive name.\"\n+  | \n+    ,-[input.js:23:1]\n+ 22 | export async function quux() {\n+ 23 |   'use cache: '\n+    :   ^^^^^^^^^^^^^\n+ 24 |   return 'data'\n+    `----"
        }
    ],
    "stats": {
        "total": 138,
        "additions": 125,
        "deletions": 13
    }
}