{
    "author": "bgw",
    "message": "fix(turbopack): Suppress logging for short no-op turbopack HMRs (#76924)\n\nTurbopack tends to generate a lot of irrelevant `BUILDING` actions, as it reports *any* compilation, including fully no-op/cached compilations and those unrelated to HMR. Fixing this would require significant architectural changes.\r\n\r\nThis PR works around the problem by deferring any \"rebuilding\" message by 100ms. If we get a `BUILT` event within that threshold and nothing has changed, just suppress the message entirely.\r\n\r\nTested this with a noisy v0 repro that @henryjeff shared with me a few weeks ago (noise is caused by an API route that's polled):\r\n\r\n![Screenshot 2025-03-18 at 3.01.44â€¯PM.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/HAZVitxRNnZz8QMiPn4a/b26d6375-e4cf-47a3-ba91-a9d1542a4941.png)\r\n\r\nI also tested this with a pages router site (`pyra-docs` in `front`) to sanity check there.",
    "sha": "96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e",
    "files": [
        {
            "sha": "7abe7a7fb37b1ab4db3e6605d247b83aaacfc23a",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/hot-reloader-client.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx?ref=96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e",
            "patch": "@@ -266,7 +266,9 @@ function processMessage(\n           sendMessage,\n           [...hmrUpdate.updatedModules],\n           hmrUpdate.startMsSinceEpoch,\n-          hmrUpdate.endMsSinceEpoch\n+          hmrUpdate.endMsSinceEpoch,\n+          // suppress the `client-hmr-latency` event if the update was a no-op:\n+          hmrUpdate.hasUpdates\n         )\n       }\n       dispatcher.onBuildOk()\n@@ -300,8 +302,8 @@ function processMessage(\n       } else {\n         webpackStartMsSinceEpoch = Date.now()\n         setPendingHotUpdateWebpack()\n+        console.log('[Fast Refresh] rebuilding')\n       }\n-      console.log('[Fast Refresh] rebuilding')\n       break\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.BUILT:\n@@ -384,21 +386,22 @@ function processMessage(\n       break\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE: {\n+      turbopackHmr!.onTurbopackMessage(obj)\n       dispatcher.onBeforeRefresh()\n       processTurbopackMessage({\n         type: HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE,\n         data: obj.data,\n       })\n-      dispatcher.onRefresh()\n       if (RuntimeErrorHandler.hadRuntimeError) {\n         console.warn(REACT_REFRESH_FULL_RELOAD_FROM_ERROR)\n         performFullReload(null, sendMessage)\n       }\n-      turbopackHmr!.onTurbopackMessage(obj)\n+      dispatcher.onRefresh()\n       break\n     }\n     // TODO-APP: make server component change more granular\n     case HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES: {\n+      turbopackHmr?.onServerComponentChanges()\n       sendMessage(\n         JSON.stringify({\n           event: 'server-component-reload-page',\n@@ -432,6 +435,7 @@ function processMessage(\n       return\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE: {\n+      turbopackHmr?.onReloadPage()\n       sendMessage(\n         JSON.stringify({\n           event: 'client-reload-page',\n@@ -444,6 +448,7 @@ function processMessage(\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.ADDED_PAGE:\n     case HMR_ACTIONS_SENT_TO_BROWSER.REMOVED_PAGE: {\n+      turbopackHmr?.onPageAddRemove()\n       // TODO-APP: potentially only refresh if the currently viewed page was added/removed.\n       return router.hmrRefresh()\n     }"
        },
        {
            "sha": "dea69706e237e437a976d8d5a5dd5bdcedded708",
            "filename": "packages/next/src/client/components/react-dev-overlay/pages/hot-reloader-client.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fpages%2Fhot-reloader-client.ts?ref=96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e",
            "patch": "@@ -138,7 +138,8 @@ function handleSuccess() {\n         sendMessage,\n         [...hmrUpdate.updatedModules],\n         hmrUpdate.startMsSinceEpoch,\n-        hmrUpdate.endMsSinceEpoch\n+        hmrUpdate.endMsSinceEpoch,\n+        hmrUpdate.hasUpdates\n       )\n     }\n     onBuildOk()\n@@ -275,8 +276,8 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n         turbopackHmr!.onBuilding()\n       } else {\n         webpackStartMsSinceEpoch = Date.now()\n+        console.log('[Fast Refresh] rebuilding')\n       }\n-      console.log('[Fast Refresh] rebuilding')\n       break\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.BUILT:\n@@ -323,6 +324,7 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n       return handleSuccess()\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES: {\n+      turbopackHmr?.onServerComponentChanges()\n       if (hasCompileErrors || RuntimeErrorHandler.hadRuntimeError) {\n         window.location.reload()\n       }\n@@ -348,6 +350,7 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n       break\n     }\n     case HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE: {\n+      turbopackHmr!.onTurbopackMessage(obj)\n       onBeforeRefresh()\n       for (const listener of turbopackMessageListeners) {\n         listener({\n@@ -360,7 +363,6 @@ function processMessage(obj: HMR_ACTION_TYPES) {\n         performFullReload(null)\n       }\n       onRefresh()\n-      turbopackHmr!.onTurbopackMessage(obj)\n       break\n     }\n     default: {"
        },
        {
            "sha": "3ec613862569bbb5003f6d04ab13818740e7ce0b",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/report-hmr-latency.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Freport-hmr-latency.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Freport-hmr-latency.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Freport-hmr-latency.ts?ref=96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e",
            "patch": "@@ -4,14 +4,29 @@ declare global {\n   }\n }\n \n+/**\n+ * Logs information about a completed HMR to the console, the server (via a\n+ * `client-hmr-latency` event), and to `self.__NEXT_HMR_LATENCY_CB` (a debugging\n+ * hook).\n+ *\n+ * @param hasUpdate Set this to `false` to avoid reporting the HMR event via a\n+ *   `client-hmr-latency` event or to `self.__NEXT_HMR_LATENCY_CB`. Used by\n+ *   turbopack when we must report a message to the browser console (because we\n+ *   already logged a \"rebuilding\" message), but it's not a real HMR, so we\n+ *   don't want to impact our telemetry.\n+ */\n export default function reportHmrLatency(\n   sendMessage: (message: string) => void,\n   updatedModules: ReadonlyArray<string | number>,\n   startMsSinceEpoch: number,\n-  endMsSinceEpoch: number\n+  endMsSinceEpoch: number,\n+  hasUpdate: boolean = true\n ) {\n   const latencyMs = endMsSinceEpoch - startMsSinceEpoch\n   console.log(`[Fast Refresh] done in ${latencyMs}ms`)\n+  if (!hasUpdate) {\n+    return\n+  }\n   sendMessage(\n     JSON.stringify({\n       event: 'client-hmr-latency',"
        },
        {
            "sha": "f1e6c2e5ae7f9ca39b7fb8a1f24aa6790e71f139",
            "filename": "packages/next/src/client/components/react-dev-overlay/utils/turbopack-hot-reloader-common.ts",
            "status": "modified",
            "additions": 79,
            "deletions": 7,
            "changes": 86,
            "blob_url": "https://github.com/vercel/next.js/blob/96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Futils%2Fturbopack-hot-reloader-common.ts?ref=96776f8c0422064bb3a1eca07f1f21a2b4eb0f6e",
            "patch": "@@ -1,7 +1,18 @@\n import type { TurbopackMessageAction } from '../../../../server/dev/hot-reloader-types'\n import type { Update as TurbopackUpdate } from '../../../../build/swc/types'\n \n+declare global {\n+  interface Window {\n+    __NEXT_HMR_TURBOPACK_REPORT_NOISY_NOOP_EVENTS: boolean | undefined\n+  }\n+}\n+\n+// How long to wait before reporting the HMR start, used to suppress irrelevant\n+// `BUILDING` events. Does not impact reported latency.\n+const TURBOPACK_HMR_START_DELAY_MS = 100\n+\n interface HmrUpdate {\n+  hasUpdates: boolean\n   updatedModules: Set<string>\n   startMsSinceEpoch: number\n   endMsSinceEpoch: number\n@@ -11,36 +22,97 @@ export class TurbopackHmr {\n   #updatedModules: Set<string>\n   #startMsSinceEpoch: number | undefined\n   #lastUpdateMsSinceEpoch: number | undefined\n+  #deferredReportHmrStartId: ReturnType<typeof setTimeout> | undefined\n \n   constructor() {\n     this.#updatedModules = new Set()\n   }\n \n+  // HACK: Turbopack tends to generate a lot of irrelevant \"BUILDING\" actions,\n+  // as it reports *any* compilation, including fully no-op/cached compilations\n+  // and those unrelated to HMR. Fixing this would require significant\n+  // architectural changes.\n+  //\n+  // Work around this by deferring any \"rebuilding\" message by 100ms. If we get\n+  // a BUILT event within that threshold and nothing has changed, just suppress\n+  // the message entirely.\n+  #runDeferredReportHmrStart() {\n+    if (this.#deferredReportHmrStartId != null) {\n+      console.log('[Fast Refresh] rebuilding')\n+      this.#cancelDeferredReportHmrStart()\n+    }\n+  }\n+\n+  #cancelDeferredReportHmrStart() {\n+    clearTimeout(this.#deferredReportHmrStartId)\n+    this.#deferredReportHmrStartId = undefined\n+  }\n+\n   onBuilding() {\n     this.#lastUpdateMsSinceEpoch = undefined\n+    this.#cancelDeferredReportHmrStart()\n     this.#startMsSinceEpoch = Date.now()\n+\n+    // report the HMR start after a short delay\n+    this.#deferredReportHmrStartId = setTimeout(\n+      () => this.#runDeferredReportHmrStart(),\n+      // debugging feature: don't defer/suppress noisy no-op HMR update messages\n+      self.__NEXT_HMR_TURBOPACK_REPORT_NOISY_NOOP_EVENTS\n+        ? 0\n+        : TURBOPACK_HMR_START_DELAY_MS\n+    )\n   }\n \n-  onTurbopackMessage(msg: TurbopackMessageAction) {\n+  /** Helper for other `onEvent` methods. */\n+  #onUpdate() {\n+    this.#runDeferredReportHmrStart()\n     this.#lastUpdateMsSinceEpoch = Date.now()\n+  }\n+\n+  onTurbopackMessage(msg: TurbopackMessageAction) {\n+    this.#onUpdate()\n     const updatedModules = extractModulesFromTurbopackMessage(msg.data)\n     for (const module of updatedModules) {\n       this.#updatedModules.add(module)\n     }\n   }\n \n+  onServerComponentChanges() {\n+    this.#onUpdate()\n+  }\n+\n+  onReloadPage() {\n+    this.#onUpdate()\n+  }\n+\n+  onPageAddRemove() {\n+    this.#onUpdate()\n+  }\n+\n+  /**\n+   * @returns `null` if the caller should ignore the update entirely. Returns an\n+   *   object with `hasUpdates: false` if the caller should report the end of\n+   *   the HMR in the browser console, but the HMR was a no-op.\n+   */\n   onBuilt(): HmrUpdate | null {\n-    // it's possible for `this.#startMsSinceEpoch` to not be set if this was the initial\n-    // computation, just return null in this case.\n-    if (this.#startMsSinceEpoch == null) {\n+    // Check that we got *any* `TurbopackMessageAction`, even if\n+    // `updatedModules` is empty (not everything gets recorded there).\n+    //\n+    // There's also a case where `onBuilt` gets called before `onBuilding`,\n+    // which can happen during initial page load. Ignore that too!\n+    const hasUpdates =\n+      this.#lastUpdateMsSinceEpoch != null && this.#startMsSinceEpoch != null\n+    if (!hasUpdates && this.#deferredReportHmrStartId != null) {\n+      // suppress the update entirely\n+      this.#cancelDeferredReportHmrStart()\n       return null\n     }\n+    this.#runDeferredReportHmrStart()\n+\n     const result = {\n+      hasUpdates,\n       updatedModules: this.#updatedModules,\n       startMsSinceEpoch: this.#startMsSinceEpoch!,\n-      // Turbopack has a debounce which causes every BUILT message to appear\n-      // 30ms late. We don't want to include this latency in our reporting, so\n-      // prefer to use the last TURBOPACK_MESSAGE time.\n       endMsSinceEpoch: this.#lastUpdateMsSinceEpoch ?? Date.now(),\n     }\n     this.#updatedModules = new Set()"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 109,
        "deletions": 15
    }
}