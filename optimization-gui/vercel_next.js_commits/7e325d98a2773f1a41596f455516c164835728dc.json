{
    "author": "ijjk",
    "message": "Fix tags check for expired/stale (#84717)\n\nCorrects the expired/stale checks in the tags manifest and updates test\ncase to capture this.",
    "sha": "7e325d98a2773f1a41596f455516c164835728dc",
    "files": [
        {
            "sha": "f6ef586c00572a4479c7648b3b0b8d8342656d65",
            "filename": "packages/next/src/server/lib/incremental-cache/tags-manifest.external.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/7e325d98a2773f1a41596f455516c164835728dc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ftags-manifest.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e325d98a2773f1a41596f455516c164835728dc/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ftags-manifest.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fincremental-cache%2Ftags-manifest.external.ts?ref=7e325d98a2773f1a41596f455516c164835728dc",
            "patch": "@@ -12,9 +12,15 @@ export const tagsManifest = new Map<string, TagManifestEntry>()\n export const areTagsExpired = (tags: string[], timestamp: Timestamp) => {\n   for (const tag of tags) {\n     const entry = tagsManifest.get(tag)\n+    const expiredAt = entry?.expired\n \n-    if (entry) {\n-      if (entry.expired && entry.expired >= timestamp) {\n+    if (typeof expiredAt === 'number') {\n+      const now = Date.now()\n+      // For immediate expiration (expiredAt <= now) and tag was invalidated after entry was created\n+      // OR for future expiration that has now passed (expiredAt > timestamp && expiredAt <= now)\n+      const isImmediatelyExpired = expiredAt <= now && expiredAt > timestamp\n+\n+      if (isImmediatelyExpired) {\n         return true\n       }\n     }\n@@ -26,11 +32,10 @@ export const areTagsExpired = (tags: string[], timestamp: Timestamp) => {\n export const areTagsStale = (tags: string[], timestamp: Timestamp) => {\n   for (const tag of tags) {\n     const entry = tagsManifest.get(tag)\n+    const staleAt = entry?.stale ?? 0\n \n-    if (entry) {\n-      if (entry.stale && entry.stale >= timestamp) {\n-        return true\n-      }\n+    if (typeof staleAt === 'number' && staleAt > timestamp) {\n+      return true\n     }\n   }\n "
        },
        {
            "sha": "332ec665fb553e035cbc44e705bead03b81d5f9c",
            "filename": "test/e2e/app-dir/app-static/app-static.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 3,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/7e325d98a2773f1a41596f455516c164835728dc/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e325d98a2773f1a41596f455516c164835728dc/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts?ref=7e325d98a2773f1a41596f455516c164835728dc",
            "patch": "@@ -4916,7 +4916,7 @@ describe('app-dir static/dynamic handling', () => {\n     expect(await browser.elementByCss('#slug').text()).toBe('hello')\n   })\n \n-  describe('updateTag', () => {\n+  describe('updateTag/revalidateTag', () => {\n     it('should throw error when updateTag is called in route handler', async () => {\n       const res = await next.fetch('/api/update-tag-error')\n       const data = await res.json()\n@@ -4944,7 +4944,7 @@ describe('app-dir static/dynamic handling', () => {\n       })\n     })\n \n-    it('should use revalidateTag with max profile in server actions', async () => {\n+    it('revalidateTag work with max profile in server actions', async () => {\n       // First fetch to get initial data\n       const browser = await next.browser('/update-tag-test')\n       const initialData = JSON.parse(await browser.elementByCss('#data').text())\n@@ -4954,15 +4954,38 @@ describe('app-dir static/dynamic handling', () => {\n \n       // The behavior with 'max' profile would be stale-while-revalidate\n       // Initial request after revalidation might still show stale data\n+      let dataAfterRevalidate\n       await retry(async () => {\n         await browser.refresh()\n-        const dataAfterRevalidate = JSON.parse(\n+        dataAfterRevalidate = JSON.parse(\n           await browser.elementByCss('#data').text()\n         )\n \n         expect(dataAfterRevalidate).toBeDefined()\n         expect(dataAfterRevalidate).not.toBe(initialData)\n       })\n+\n+      if (isNextStart) {\n+        // give second so tag isn't still stale state\n+        await waitFor(1000)\n+\n+        const res1 = await next.fetch('/update-tag-test')\n+        const body1 = await res1.text()\n+        const cacheHeader1 = res1.headers.get('x-nextjs-cache')\n+\n+        expect(res1.status).toBe(200)\n+        expect(cacheHeader1).toBeDefined()\n+        expect(cacheHeader1).not.toBe('MISS')\n+\n+        const res2 = await next.fetch('/update-tag-test')\n+        const body2 = await res2.text()\n+        const cacheHeader2 = res2.headers.get('x-nextjs-cache')\n+\n+        expect(res2.status).toBe(200)\n+        expect(cacheHeader2).toBeDefined()\n+        expect(cacheHeader2).not.toBe('MISS')\n+        expect(body1).toBe(body2)\n+      }\n     })\n \n     // Runtime logs aren't queryable in deploy mode"
        },
        {
            "sha": "81bd39fe1960de53e9ed0c55d0190c3419f3508e",
            "filename": "test/e2e/app-dir/app-static/app/api/revalidate-tag-node/route.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7e325d98a2773f1a41596f455516c164835728dc/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fapi%2Frevalidate-tag-node%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7e325d98a2773f1a41596f455516c164835728dc/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fapi%2Frevalidate-tag-node%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fapi%2Frevalidate-tag-node%2Froute.ts?ref=7e325d98a2773f1a41596f455516c164835728dc",
            "patch": "@@ -5,6 +5,7 @@ export const revalidate = 0\n \n export async function GET(req) {\n   const tag = req.nextUrl.searchParams.get('tag')\n-  revalidateTag(tag, 'expireNow')\n+  const profile = req.nextUrl.searchParams.get('profile')\n+  revalidateTag(tag, profile || 'expireNow')\n   return NextResponse.json({ revalidated: true, now: Date.now() })\n }"
        }
    ],
    "stats": {
        "total": 49,
        "additions": 39,
        "deletions": 10
    }
}