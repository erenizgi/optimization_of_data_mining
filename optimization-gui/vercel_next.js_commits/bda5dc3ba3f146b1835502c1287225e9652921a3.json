{
    "author": "kevva",
    "message": "fix: replace original request body after middleware execution (#77662)\n\nIn https://github.com/vercel/next.js/pull/77553 we fixed reading the\nrequest body in middleware using the `nodejs` runtime. However, this\ncaused issues with subsequent reads like in server actions. In sandbox,\n[we\nrun](https://github.com/vercel/next.js/blob/1e62ce2c61048ddc0297f1a4f268894541975521/packages/next/src/server/web/sandbox/sandbox.ts#L146-L148)\n`.finalize()` after middleware is executed so we should do the same\nhere.\n\nFixes https://github.com/vercel/next.js/issues/77646\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "bda5dc3ba3f146b1835502c1287225e9652921a3",
    "files": [
        {
            "sha": "f94867c89a5f48a23a0d7c1a6cc16efd97c7e656",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 5,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -1687,11 +1687,26 @@ export default class NextNodeServer extends BaseServer<\n       const adapterFn: typeof import('./web/adapter').adapter =\n         middlewareModule.default || middlewareModule\n \n-      result = await adapterFn({\n-        handler: middlewareModule.middleware || middlewareModule,\n-        request: requestData,\n-        page: 'middleware',\n-      })\n+      const hasRequestBody =\n+        !['HEAD', 'GET'].includes(params.request.method) &&\n+        Boolean(requestData.body)\n+\n+      try {\n+        result = await adapterFn({\n+          handler: middlewareModule.middleware || middlewareModule,\n+          request: {\n+            ...requestData,\n+            body: hasRequestBody\n+              ? requestData.body.cloneBodyStream()\n+              : undefined,\n+          },\n+          page: 'middleware',\n+        })\n+      } finally {\n+        if (hasRequestBody) {\n+          requestData.body.finalize()\n+        }\n+      }\n     } else {\n       const { run } = require('./web/sandbox') as typeof import('./web/sandbox')\n "
        },
        {
            "sha": "e8888a25eb18a52262fe6c062469347672001257",
            "filename": "test/e2e/app-dir/actions/app-action-form-state-node-middleware.test.ts",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-form-state-node-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-form-state-node-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-form-state-node-middleware.test.ts?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -0,0 +1,3 @@\n+process.env.TEST_NODE_MIDDLEWARE = 'true'\n+\n+require('./app-action-form-state.test')"
        },
        {
            "sha": "afb51638a64c510dbf3243ecccd3cab5ffcf6635",
            "filename": "test/e2e/app-dir/actions/app-action-form-state.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-form-state.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-form-state.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-form-state.test.ts?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -1,10 +1,16 @@\n /* eslint-disable jest/no-standalone-expect */\n-import { nextTestSetup } from 'e2e-utils'\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n import { check } from 'next-test-utils'\n+import { join } from 'path'\n \n describe('app-dir action useActionState', () => {\n   const { next } = nextTestSetup({\n     files: __dirname,\n+    overrideFiles: process.env.TEST_NODE_MIDDLEWARE\n+      ? {\n+          'middleware.js': new FileRef(join(__dirname, 'middleware-node.js')),\n+        }\n+      : {},\n     dependencies: {\n       nanoid: '4.0.1',\n     },"
        },
        {
            "sha": "f9144de45fcadafd9e21eaa88a1181c684210f77",
            "filename": "test/e2e/app-dir/actions/app-action-node-middleware.test.ts",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-node-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-node-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-node-middleware.test.ts?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -0,0 +1,3 @@\n+process.env.TEST_NODE_MIDDLEWARE = 'true'\n+\n+require('./app-action.test')"
        },
        {
            "sha": "860c0f387157886238dba46788e778534db64e45",
            "filename": "test/e2e/app-dir/actions/app-action-size-limit-invalid-node-middleware.test.ts",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid-node-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid-node-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid-node-middleware.test.ts?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -0,0 +1,3 @@\n+process.env.TEST_NODE_MIDDLEWARE = 'true'\n+\n+require('./app-action-size-limit-invalid.test')"
        },
        {
            "sha": "8f43b2d2008cda7dfd5d206ca8429d878b553983",
            "filename": "test/e2e/app-dir/actions/app-action-size-limit-invalid.test.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 4,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action-size-limit-invalid.test.ts?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -1,15 +1,21 @@\n-import { NextInstance, nextTestSetup } from 'e2e-utils'\n+import { FileRef, NextInstance, nextTestSetup } from 'e2e-utils'\n import { retry } from 'next-test-utils'\n import { createRequestTracker } from 'e2e-utils/request-tracker'\n import stripAnsi from 'strip-ansi'\n import { accountForOverhead } from './account-for-overhead'\n+import { join } from 'path'\n \n const CONFIG_ERROR =\n   'Server Actions Size Limit must be a valid number or filesize format larger than 1MB'\n \n describe('app-dir action size limit invalid config', () => {\n   const { next, isNextStart, isNextDeploy, skipped } = nextTestSetup({\n     files: __dirname,\n+    overrideFiles: process.env.TEST_NODE_MIDDLEWARE\n+      ? {\n+          'middleware.js': new FileRef(join(__dirname, 'middleware-node.js')),\n+        }\n+      : {},\n     skipStart: true,\n     dependencies: {\n       nanoid: '4.0.1',\n@@ -43,7 +49,8 @@ describe('app-dir action size limit invalid config', () => {\n         `\n       module.exports = {\n         experimental: {\n-          serverActions: { bodySizeLimit: -3000 }\n+          serverActions: { bodySizeLimit: -3000 },\n+          nodeMiddleware: true\n         },\n       }\n       `\n@@ -61,7 +68,8 @@ describe('app-dir action size limit invalid config', () => {\n         `\n       module.exports = {\n         experimental: {\n-          serverActions: { bodySizeLimit: 'testmb' }\n+          serverActions: { bodySizeLimit: 'testmb' },\n+          nodeMiddleware: true\n         },\n       }\n       `\n@@ -79,7 +87,8 @@ describe('app-dir action size limit invalid config', () => {\n         `\n       module.exports = {\n         experimental: {\n-          serverActions: { bodySizeLimit: '-3000mb' }\n+          serverActions: { bodySizeLimit: '-3000mb' },\n+          nodeMiddleware: true\n         },\n       }\n       `"
        },
        {
            "sha": "8cc4de2bdfb6020c030db6ab6f0a9f4178dc0dc9",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -1,5 +1,5 @@\n /* eslint-disable jest/no-standalone-expect */\n-import { nextTestSetup } from 'e2e-utils'\n+import { FileRef, nextTestSetup } from 'e2e-utils'\n import {\n   assertHasRedbox,\n   retry,\n@@ -20,6 +20,11 @@ describe('app-dir action handling', () => {\n   const { next, isNextDev, isNextStart, isNextDeploy, isTurbopack } =\n     nextTestSetup({\n       files: __dirname,\n+      overrideFiles: process.env.TEST_NODE_MIDDLEWARE\n+        ? {\n+            'middleware.js': new FileRef(join(__dirname, 'middleware-node.js')),\n+          }\n+        : {},\n       dependencies: {\n         nanoid: '4.0.1',\n         'server-only': 'latest',"
        },
        {
            "sha": "e146afd9b04fbf823565dcf405514d04356e6c77",
            "filename": "test/e2e/app-dir/actions/middleware-node.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware-node.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware-node.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware-node.js?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -0,0 +1,18 @@\n+// Ensure that https://github.com/vercel/next.js/issues/56286 is fixed.\n+import { NextResponse } from 'next/server'\n+\n+export async function middleware(req) {\n+  if (req.nextUrl.pathname.includes('rewrite-to-static-first')) {\n+    req.nextUrl.pathname = '/static/first'\n+    return NextResponse.rewrite(req.nextUrl)\n+  }\n+\n+  return NextResponse.next()\n+}\n+\n+/**\n+ * @type {import('next/server').MiddlewareConfig}\n+ */\n+export const config = {\n+  runtime: 'nodejs',\n+}"
        },
        {
            "sha": "c79a0effb25ccf608e75cf66b3c7636cd43facb8",
            "filename": "test/e2e/app-dir/actions/middleware.js",
            "status": "modified",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fmiddleware.js?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -9,12 +9,3 @@ export async function middleware(req) {\n \n   return NextResponse.next()\n }\n-\n-/**\n- * @type {import('next/server').MiddlewareConfig}\n- */\n-export const config = {\n-  // Ensure that middleware doesn't interfere with the request body parsing for\n-  // this test fixture.\n-  matcher: ['/((?!decode-req-body).*)'],\n-}"
        },
        {
            "sha": "25c9ec9d464a704fce1ca4363762110be7ec8498",
            "filename": "test/e2e/app-dir/actions/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bda5dc3ba3f146b1835502c1287225e9652921a3/test%2Fe2e%2Fapp-dir%2Factions%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fnext.config.js?ref=bda5dc3ba3f146b1835502c1287225e9652921a3",
            "patch": "@@ -5,6 +5,7 @@ module.exports = {\n     fetches: {},\n   },\n   experimental: {\n+    nodeMiddleware: true,\n     serverActions: { bodySizeLimit: '2mb' },\n   },\n }"
        }
    ],
    "stats": {
        "total": 94,
        "additions": 74,
        "deletions": 20
    }
}