{
    "author": "timneutkens",
    "message": "Build: Log amount of workers during static generation (#85706)\n\n## What?\n\nAdded the amount of workers used to the relevant steps as `using X\nworkers`.\n\nExample:\n\n```\n ✓ Compiled successfully in 610.3ms\n ✓ Finished TypeScript in 954.4ms    \n ✓ Collecting page data using 15 workers in 207.5ms    \n ✓ Generating static pages using 15 workers (4/4) in 258.4ms\n ✓ Finalizing page optimization in 6.7ms    \n```",
    "sha": "831534c163dc5602d68812022b17936b8d2dd00b",
    "files": [
        {
            "sha": "79381932e0f182a2784c74ff476898ab5b576a21",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 7,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/831534c163dc5602d68812022b17936b8d2dd00b/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/831534c163dc5602d68812022b17936b8d2dd00b/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=831534c163dc5602d68812022b17936b8d2dd00b",
            "patch": "@@ -836,17 +836,18 @@ export type StaticWorker = typeof import('./worker') & Worker\n export function createStaticWorker(\n   config: NextConfigComplete,\n   options: {\n+    numberOfWorkers: number\n     debuggerPortOffset: number\n     progress?: {\n       run: () => void\n       clear: () => void\n     }\n   }\n ): StaticWorker {\n-  const { debuggerPortOffset, progress } = options\n+  const { numberOfWorkers, debuggerPortOffset, progress } = options\n   return new Worker(staticWorkerPath, {\n     logger: Log,\n-    numWorkers: getNumberOfWorkers(config),\n+    numWorkers: numberOfWorkers,\n     onActivity: () => {\n       progress?.run()\n     },\n@@ -1917,8 +1918,11 @@ export default async function build(\n         traceMemoryUsage('Finished type checking', nextBuildSpan)\n       }\n \n+      const numberOfWorkers = getNumberOfWorkers(config)\n       const collectingPageDataStart = process.hrtime()\n-      const postCompileSpinner = createSpinner('Collecting page data')\n+      const postCompileSpinner = createSpinner(\n+        `Collecting page data using ${numberOfWorkers} worker${numberOfWorkers > 1 ? 's' : ''}`\n+      )\n \n       const buildManifestPath = path.join(distDir, BUILD_MANIFEST)\n \n@@ -1960,7 +1964,10 @@ export default async function build(\n \n       process.env.NEXT_PHASE = PHASE_PRODUCTION_BUILD\n \n-      const worker = createStaticWorker(config, { debuggerPortOffset: -1 })\n+      const worker = createStaticWorker(config, {\n+        numberOfWorkers,\n+        debuggerPortOffset: -1,\n+      })\n \n       const analysisBegin = process.hrtime()\n       const staticCheckSpan = nextBuildSpan.traceChild('static-check')\n@@ -2482,7 +2489,7 @@ export default async function build(\n       if (postCompileSpinner) {\n         const collectingPageDataEnd = process.hrtime(collectingPageDataStart)\n         postCompileSpinner.setText(\n-          `Collecting page data in ${hrtimeDurationToString(collectingPageDataEnd)}`\n+          `Collecting page data using ${numberOfWorkers} worker${numberOfWorkers > 1 ? 's' : ''} in ${hrtimeDurationToString(collectingPageDataEnd)}`\n         )\n         postCompileSpinner.stopAndPersist()\n       }\n@@ -3065,8 +3072,8 @@ export default async function build(\n               debugPrerender,\n               pages: combinedPages,\n               outdir,\n-              statusMessage: 'Generating static pages',\n-              numWorkers: getNumberOfWorkers(exportConfig),\n+              statusMessage: `Generating static pages using ${numberOfWorkers} worker${numberOfWorkers > 1 ? 's' : ''}`,\n+              numWorkers: numberOfWorkers,\n               appDirOnly,\n             },\n             nextBuildSpan"
        },
        {
            "sha": "c6c7e85b391ce4b7d011af78c8b6c125430f9bd1",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/831534c163dc5602d68812022b17936b8d2dd00b/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/831534c163dc5602d68812022b17936b8d2dd00b/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=831534c163dc5602d68812022b17936b8d2dd00b",
            "patch": "@@ -641,13 +641,15 @@ async function exportAppImpl(\n   if (totalExportPaths > 0) {\n     const progress = createProgress(\n       totalExportPaths,\n-      options.statusMessage || 'Exporting'\n+      options.statusMessage ??\n+        `Exporting using ${options.numWorkers} worker${options.numWorkers > 1 ? 's' : ''}`\n     )\n \n     worker = createStaticWorker(nextConfig, {\n       debuggerPortOffset: getNextBuildDebuggerPortOffset({\n         kind: 'export-page',\n       }),\n+      numberOfWorkers: options.numWorkers,\n       progress,\n     })\n "
        },
        {
            "sha": "8ac86f4a075c8ab82af600b32ae359d92bf58e4e",
            "filename": "test/integration/polyfills/test/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/831534c163dc5602d68812022b17936b8d2dd00b/test%2Fintegration%2Fpolyfills%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/831534c163dc5602d68812022b17936b8d2dd00b/test%2Fintegration%2Fpolyfills%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fpolyfills%2Ftest%2Findex.test.ts?ref=831534c163dc5602d68812022b17936b8d2dd00b",
            "patch": "@@ -49,8 +49,8 @@ describe('Polyfills', () => {\n       })\n \n       it('should contain generated page count in output', async () => {\n-        expect(output).toContain('Generating static pages (0/5)')\n-        expect(output).toContain('Generating static pages (5/5)')\n+        expect(output).toMatch(/Generating static pages.*\\(0\\/5\\)/g)\n+        expect(output).toMatch(/Generating static pages.*\\(5\\/5\\)/g)\n         // we should only have 1 segment and the initial message logged out\n         expect(output.match(/Generating static pages/g).length).toBe(5)\n       })"
        },
        {
            "sha": "24d641c692b45fdb08fecec122f571abc3267cde",
            "filename": "test/production/pages-dir/production/test/index.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/831534c163dc5602d68812022b17936b8d2dd00b/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/831534c163dc5602d68812022b17936b8d2dd00b/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fpages-dir%2Fproduction%2Ftest%2Findex.test.ts?ref=831534c163dc5602d68812022b17936b8d2dd00b",
            "patch": "@@ -112,9 +112,14 @@ describe('Production Usage', () => {\n \n   it('should contain generated page count in output', async () => {\n     const pageCount = 34\n-    expect(next.cliOutput).toContain(`Generating static pages (0/${pageCount})`)\n-    expect(next.cliOutput).toContain(\n-      `Generating static pages (${pageCount}/${pageCount})`\n+    expect(next.cliOutput).toMatch(\n+      new RegExp(`Generating static pages.*\\\\(0\\\\/${pageCount}\\\\)`, 'g')\n+    )\n+    expect(next.cliOutput).toMatch(\n+      new RegExp(\n+        `Generating static pages.*\\\\(${pageCount}\\\\/${pageCount}\\\\)`,\n+        'g'\n+      )\n     )\n     // we should only have 4 segments and the initial message logged out\n     expect(next.cliOutput.match(/Generating static pages/g).length).toBe(5)"
        }
    ],
    "stats": {
        "total": 40,
        "additions": 27,
        "deletions": 13
    }
}