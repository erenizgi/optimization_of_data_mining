{
    "author": "unstubbable",
    "message": "[test] Add failing test for `useActionState` with `'use cache'` (#86292)\n\nAdds a test case demonstrating that `useActionState` doesn't work correctly when the `'use cache'` function is exported separately, due to wrong function arity information in the server reference information byte. This is currently a limitation of the Next.js compiler, which will be addressed in a future PR.\r\n\r\nAlso cleans up `console.log` from the existing `useActionState` test.",
    "sha": "dbfb6c49b1b3401c77a0686125f884e1f2ad8b18",
    "files": [
        {
            "sha": "d56cefb2f11e29f2aeda0f5f43512c00291ce667",
            "filename": "test/e2e/app-dir/use-cache/app/(partially-static)/use-action-state-separate-export/cached.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fcached.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fcached.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fcached.ts?ref=dbfb6c49b1b3401c77a0686125f884e1f2ad8b18",
            "patch": "@@ -0,0 +1,7 @@\n+'use cache'\n+\n+const getRandomValue = async () => {\n+  return Math.random()\n+}\n+\n+export { getRandomValue }"
        },
        {
            "sha": "6cc3181d52832a8e4aa6594fa8936f9e157479b7",
            "filename": "test/e2e/app-dir/use-cache/app/(partially-static)/use-action-state-separate-export/form.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fform.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fform.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fform.tsx?ref=dbfb6c49b1b3401c77a0686125f884e1f2ad8b18",
            "patch": "@@ -0,0 +1,15 @@\n+'use client'\n+\n+import { useActionState } from 'react'\n+import { getRandomValue } from './cached'\n+\n+export function Form() {\n+  const [result, formAction, isPending] = useActionState(getRandomValue, -1)\n+\n+  return (\n+    <form action={formAction}>\n+      <button id=\"submit-button\">Submit</button>\n+      <p>{isPending ? 'loading...' : result}</p>\n+    </form>\n+  )\n+}"
        },
        {
            "sha": "f88d511fb444581712fcb4805f528f2097e35ad9",
            "filename": "test/e2e/app-dir/use-cache/app/(partially-static)/use-action-state-separate-export/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state-separate-export%2Fpage.tsx?ref=dbfb6c49b1b3401c77a0686125f884e1f2ad8b18",
            "patch": "@@ -0,0 +1,5 @@\n+import { Form } from './form'\n+\n+export default function Page() {\n+  return <Form />\n+}"
        },
        {
            "sha": "be871502eb57f48f55d66211cd160359bbdefe81",
            "filename": "test/e2e/app-dir/use-cache/app/(partially-static)/use-action-state/cached.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 3,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state%2Fcached.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state%2Fcached.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fuse-action-state%2Fcached.ts?ref=dbfb6c49b1b3401c77a0686125f884e1f2ad8b18",
            "patch": "@@ -1,7 +1,5 @@\n 'use cache'\n \n export async function getRandomValue() {\n-  const v = Math.random()\n-  console.log(v)\n-  return v\n+  return Math.random()\n }"
        },
        {
            "sha": "9110bd3749d80e5171d9416245cae58f0bd51252",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/dbfb6c49b1b3401c77a0686125f884e1f2ad8b18/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=dbfb6c49b1b3401c77a0686125f884e1f2ad8b18",
            "patch": "@@ -499,6 +499,7 @@ describe('use-cache', () => {\n           '/static-class-method',\n           withCacheComponents && '/unhandled-promise-regression',\n           '/use-action-state',\n+          '/use-action-state-separate-export',\n           '/with-server-action',\n         ].filter(Boolean)\n       )\n@@ -709,6 +710,34 @@ describe('use-cache', () => {\n     })\n   })\n \n+  // TODO: This test doesn't work currently because the compiler doesn't\n+  // properly compute the server reference information byte that includes the\n+  // function arity. Without this information, the client can't optimize the\n+  // arguments it sends to the server, so the (unused) previous state is also\n+  // sent as an argument, leading to cache misses.\n+  it.failing(\n+    'works with useActionState if previousState parameter is not used in \"use cache\" function (separate export)',\n+    async () => {\n+      const browser = await next.browser('/use-action-state-separate-export')\n+\n+      let value = await browser.elementByCss('p').text()\n+      expect(value).toBe('-1')\n+\n+      await browser.elementByCss('button').click()\n+\n+      await retry(async () => {\n+        value = await browser.elementByCss('p').text()\n+        expect(value).toMatch(/\\d\\.\\d+/)\n+      })\n+\n+      await browser.elementByCss('button').click()\n+\n+      await retry(async () => {\n+        expect(await browser.elementByCss('p').text()).toBe(value)\n+      })\n+    }\n+  )\n+\n   it('works with \"use cache\" in method props', async () => {\n     const browser = await next.browser('/method-props')\n "
        }
    ],
    "stats": {
        "total": 60,
        "additions": 57,
        "deletions": 3
    }
}