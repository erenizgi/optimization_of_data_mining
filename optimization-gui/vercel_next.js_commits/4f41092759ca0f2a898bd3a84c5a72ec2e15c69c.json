{
    "author": "sokra",
    "message": "Turbopack: move block offsets from header to footer (#82047)\n\n### What?\n\nmove block offset map to the end of the file to enable streaming write of the SST file.",
    "sha": "4f41092759ca0f2a898bd3a84c5a72ec2e15c69c",
    "files": [
        {
            "sha": "7f1a50bc59efaf4d8e1c46a30e2aabc55f2dd7a6",
            "filename": "turbopack/crates/turbo-persistence/README.md",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/4f41092759ca0f2a898bd3a84c5a72ec2e15c69c/turbopack%2Fcrates%2Fturbo-persistence%2FREADME.md",
            "raw_url": "https://github.com/vercel/next.js/raw/4f41092759ca0f2a898bd3a84c5a72ec2e15c69c/turbopack%2Fcrates%2Fturbo-persistence%2FREADME.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2FREADME.md?ref=4f41092759ca0f2a898bd3a84c5a72ec2e15c69c",
            "patch": "@@ -60,11 +60,11 @@ The SST file contains only data without any header.\n \n - serialized key Compression Dictionary\n - serialized value Compression Dictionary\n-- foreach block\n-  - 4 bytes end of block offset relative to start of all blocks\n - foreach block\n   - 4 bytes uncompressed block length\n   - compressed data\n+- foreach block\n+  - 4 bytes end of block offset relative to start of all blocks\n \n #### Index Block\n "
        },
        {
            "sha": "59b199a6248bffd63267b155ac6e32ed931f8112",
            "filename": "turbopack/crates/turbo-persistence/src/static_sorted_file.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/4f41092759ca0f2a898bd3a84c5a72ec2e15c69c/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4f41092759ca0f2a898bd3a84c5a72ec2e15c69c/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file.rs?ref=4f41092759ca0f2a898bd3a84c5a72ec2e15c69c",
            "patch": "@@ -74,15 +74,15 @@ pub struct StaticSortedFileMetaData {\n }\n \n impl StaticSortedFileMetaData {\n-    pub fn block_offsets_start(&self) -> usize {\n-        let k: usize = self.key_compression_dictionary_length.into();\n-        let v: usize = self.value_compression_dictionary_length.into();\n-        k + v\n+    pub fn block_offsets_start(&self, sst_len: usize) -> usize {\n+        let bc: usize = self.block_count.into();\n+        sst_len - (bc * size_of::<u32>())\n     }\n \n     pub fn blocks_start(&self) -> usize {\n-        let bc: usize = self.block_count.into();\n-        self.block_offsets_start() + bc * size_of::<u32>()\n+        let k: usize = self.key_compression_dictionary_length.into();\n+        let v: usize = self.value_compression_dictionary_length.into();\n+        k + v\n     }\n \n     pub fn key_compression_dictionary_range(&self) -> Range<usize> {\n@@ -347,11 +347,11 @@ impl StaticSortedFile {\n                 self.meta.sequence_number,\n                 block_index,\n                 self.meta.block_count,\n-                self.meta.block_offsets_start(),\n+                self.meta.block_offsets_start(self.mmap.len()),\n                 self.meta.blocks_start()\n             );\n         }\n-        let offset = self.meta.block_offsets_start() + block_index as usize * 4;\n+        let offset = self.meta.block_offsets_start(self.mmap.len()) + block_index as usize * 4;\n         #[cfg(feature = \"strict_checks\")]\n         if offset + 4 > self.mmap.len() {\n             bail!(\n@@ -361,7 +361,7 @@ impl StaticSortedFile {\n                 block_index,\n                 offset,\n                 self.mmap.len(),\n-                self.meta.block_offsets_start(),\n+                self.meta.block_offsets_start(self.mmap.len()),\n                 self.meta.blocks_start()\n             );\n         }\n@@ -382,7 +382,7 @@ impl StaticSortedFile {\n                 block_start,\n                 block_end,\n                 self.mmap.len(),\n-                self.meta.block_offsets_start(),\n+                self.meta.block_offsets_start(self.mmap.len()),\n                 self.meta.blocks_start()\n             );\n         }"
        },
        {
            "sha": "19e6bf287be227277941c87e3b13d25cf0c05bfd",
            "filename": "turbopack/crates/turbo-persistence/src/static_sorted_file_builder.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 5,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/4f41092759ca0f2a898bd3a84c5a72ec2e15c69c/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4f41092759ca0f2a898bd3a84c5a72ec2e15c69c/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs?ref=4f41092759ca0f2a898bd3a84c5a72ec2e15c69c",
            "patch": "@@ -409,20 +409,24 @@ impl<'a> StaticSortedFileBuilder<'a> {\n         file.write_all(&self.value_compression_dictionary)?;\n \n         // Write the blocks\n+        let block_count = self.blocks.len().try_into().unwrap();\n+        let mut block_offsets = Vec::with_capacity(self.blocks.len());\n         let mut offset = 0;\n-        for (_, block) in &self.blocks {\n+        for (uncompressed_size, block) in self.blocks {\n             // Block length (including the uncompressed length field)\n             let len = block.len() + 4;\n             offset += len;\n-            file.write_u32::<BE>(offset.try_into().unwrap())?;\n-        }\n-        let block_count = self.blocks.len().try_into().unwrap();\n-        for (uncompressed_size, block) in self.blocks {\n+            block_offsets.push(offset.try_into().unwrap());\n             // Uncompressed size\n             file.write_u32::<BE>(uncompressed_size)?;\n             // Compressed block\n             file.write_all(&block)?;\n         }\n+        // Write the block offsets\n+        for offset in block_offsets {\n+            file.write_u32::<BE>(offset)?;\n+        }\n+\n         let meta = StaticSortedFileBuilderMeta {\n             min_hash: self.min_hash,\n             max_hash: self.max_hash,"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 21,
        "deletions": 17
    }
}