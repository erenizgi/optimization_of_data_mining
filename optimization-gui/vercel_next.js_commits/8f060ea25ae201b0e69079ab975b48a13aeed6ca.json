{
    "author": "huozhi",
    "message": "[test] improve segment explorer tests snapshot (#81616)\n\nFormat line format: `<segment> [<files,>]`\r\n\r\nThis will help visualize the rendered segment explorer panel easier by checking the snapshot. e.g.\r\n\r\n```\r\napp/ [layout.tsx]\r\nparallel-routes/ [layout.tsx, page.tsx]\r\n@bar/ [layout.tsx, page.tsx]\r\n@foo/ [layout.tsx, page.tsx]\r\n```",
    "sha": "8f060ea25ae201b0e69079ab975b48a13aeed6ca",
    "files": [
        {
            "sha": "af5f8be3714d409d65d37219686a9e3948780544",
            "filename": "test/development/app-dir/segment-explorer-globals/segment-explorer-globals.test.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 26,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/8f060ea25ae201b0e69079ab975b48a13aeed6ca/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer-globals%2Fsegment-explorer-globals.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f060ea25ae201b0e69079ab975b48a13aeed6ca/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer-globals%2Fsegment-explorer-globals.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer-globals%2Fsegment-explorer-globals.test.ts?ref=8f060ea25ae201b0e69079ab975b48a13aeed6ca",
            "patch": "@@ -1,22 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { openDevToolsIndicatorPopover } from 'next-test-utils'\n-import { Playwright } from 'next-webdriver'\n-\n-async function getSegmentExplorerContent(browser: Playwright) {\n-  // open the devtool button\n-  await openDevToolsIndicatorPopover(browser)\n-\n-  // open the segment explorer\n-  await browser.elementByCss('[data-segment-explorer]').click()\n-\n-  //  wait for the segment explorer to be visible\n-  await browser.waitForElementByCss('[data-nextjs-devtool-segment-explorer]')\n-\n-  const content = await browser.elementByCss(\n-    '[data-nextjs-devtool-segment-explorer]'\n-  )\n-  return content.text()\n-}\n+import { getSegmentExplorerContent } from 'next-test-utils'\n \n describe('segment-explorer - globals', () => {\n   const { next } = nextTestSetup({\n@@ -25,17 +8,15 @@ describe('segment-explorer - globals', () => {\n \n   it('should show global-error segment', async () => {\n     const browser = await next.browser('/runtime-error')\n-    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     global-error.tsx\"\n-    `)\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(\n+      `\"app/ [global-error.tsx]\"`\n+    )\n   })\n \n   it('should display parallel routes default page when present', async () => {\n     const browser = await next.browser('/404-not-found')\n-    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     global-not-found.tsx\"\n-    `)\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(\n+      `\"app/ [global-not-found.tsx]\"`\n+    )\n   })\n })"
        },
        {
            "sha": "f5fa02f7eadccbc0965fc08a780bd357e9eec685",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 46,
            "deletions": 120,
            "changes": 166,
            "blob_url": "https://github.com/vercel/next.js/blob/8f060ea25ae201b0e69079ab975b48a13aeed6ca/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f060ea25ae201b0e69079ab975b48a13aeed6ca/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=8f060ea25ae201b0e69079ab975b48a13aeed6ca",
            "patch": "@@ -1,22 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { openDevToolsIndicatorPopover, retry } from 'next-test-utils'\n-import { Playwright } from 'next-webdriver'\n-\n-async function getSegmentExplorerContent(browser: Playwright) {\n-  // open the devtool button\n-  await openDevToolsIndicatorPopover(browser)\n-\n-  // open the segment explorer\n-  await browser.elementByCss('[data-segment-explorer]').click()\n-\n-  //  wait for the segment explorer to be visible\n-  await browser.waitForElementByCss('[data-nextjs-devtool-segment-explorer]')\n-\n-  const content = await browser.elementByCss(\n-    '[data-nextjs-devtool-segment-explorer]'\n-  )\n-  return content.text()\n-}\n+import { getSegmentExplorerContent, retry } from 'next-test-utils'\n \n describe('segment-explorer', () => {\n   const { next } = nextTestSetup({\n@@ -26,61 +9,39 @@ describe('segment-explorer', () => {\n   it('should render the segment explorer for parallel routes', async () => {\n     const browser = await next.browser('/parallel-routes')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     parallel-routes/\n-     layout.tsx\n-     page.tsx\n-     @bar/\n-     layout.tsx\n-     page.tsx\n-     @foo/\n-     layout.tsx\n-     page.tsx\"\n+     \"app/ [layout.tsx]\n+     parallel-routes/ [layout.tsx, page.tsx]\n+     @bar/ [layout.tsx, page.tsx]\n+     @foo/ [layout.tsx, page.tsx]\"\n     `)\n   })\n \n   it('should render the segment explorer for parallel routes in edge runtime', async () => {\n     const browser = await next.browser('/parallel-routes-edge')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     parallel-routes-edge/\n-     layout.tsx\n-     page.tsx\n-     @bar/\n-     layout.tsx\n-     page.tsx\n-     @foo/\n-     layout.tsx\n-     page.tsx\"\n+     \"app/ [layout.tsx]\n+     parallel-routes-edge/ [layout.tsx, page.tsx]\n+     @bar/ [layout.tsx, page.tsx]\n+     @foo/ [layout.tsx, page.tsx]\"\n     `)\n   })\n \n   it('should render the segment explorer for nested routes', async () => {\n     const browser = await next.browser('/blog/~/grid')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     (v2)/\n-     layout.tsx\n-     blog / (team)/\n-     layout.tsx\n-     template.tsx\n-     ~ / (overview)/\n-     layout.tsx\n-     grid/\n-     page.tsx\"\n+     \"app/ [layout.tsx]\n+     (v2)/ [layout.tsx]\n+     blog / (team)/ [layout.tsx, template.tsx]\n+     ~ / (overview)/ [layout.tsx]\n+     grid/ [page.tsx]\"\n     `)\n   })\n \n   it('should cleanup on soft navigation', async () => {\n     const browser = await next.browser('/soft-navigation/a')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     soft-navigation / a/\n-     page.tsx\"\n+     \"app/ [layout.tsx]\n+     soft-navigation / a/ [page.tsx]\"\n     `)\n \n     await browser.elementByCss('[href=\"/soft-navigation/b\"]').click()\n@@ -89,75 +50,55 @@ describe('segment-explorer', () => {\n     })\n \n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     soft-navigation / b/\n-     page.tsx\"\n+     \"app/ [layout.tsx]\n+     soft-navigation / b/ [page.tsx]\"\n     `)\n   })\n \n   it('should handle show file segments in order', async () => {\n     const browser = await next.browser('/file-segments')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     (all) / file-segments/\n-     layout.tsx\n-     template.tsx\n-     page.tsx\"\n+     \"app/ [layout.tsx]\n+     (all) / file-segments/ [layout.tsx, template.tsx, page.tsx]\"\n     `)\n   })\n \n   it('should indicate segment explorer is not available for pages router', async () => {\n     const browser = await next.browser('/pages-router')\n-    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(\n-      `\"Route Info currently is only available for the App Router.\"`\n-    )\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\"\"`)\n   })\n \n   it('should handle special built-in not-found segments', async () => {\n     const browser = await next.browser('/404')\n-    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     not-found.js\"\n-    `)\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(\n+      `\"app/ [layout.tsx, not-found.js]\"`\n+    )\n   })\n \n   it('should show global-error segment', async () => {\n     const browser = await next.browser('/runtime-error')\n-    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     global-error.js\"\n-    `)\n+    expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(\n+      `\"app/ [global-error.js]\"`\n+    )\n   })\n \n   it('should show navigation boundaries of the segment', async () => {\n     const browser = await next.browser('/boundary?name=not-found')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     boundary/\n-     layout.tsx\n-     not-found.tsx\"\n+     \"app/ [layout.tsx]\n+     boundary/ [layout.tsx, not-found.tsx]\"\n     `)\n \n     await browser.loadPage(`${next.url}/boundary?name=forbidden`)\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     boundary/\n-     layout.tsx\n-     forbidden.tsx\"\n+     \"app/ [layout.tsx]\n+     boundary/ [layout.tsx, forbidden.tsx]\"\n     `)\n \n     await browser.loadPage(`${next.url}/boundary?name=unauthorized`)\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     boundary/\n-     layout.tsx\n-     unauthorized.tsx\"\n+     \"app/ [layout.tsx]\n+     boundary/ [layout.tsx, unauthorized.tsx]\"\n     `)\n   })\n \n@@ -172,52 +113,37 @@ describe('segment-explorer', () => {\n     })\n \n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     search/\n-     layout.tsx\n-     loading.tsx\"\n+     \"app/ [layout.tsx]\n+     search/ [layout.tsx, loading.tsx]\"\n     `)\n   })\n \n   it('should show the custom error boundary when present', async () => {\n     const browser = await next.browser('/runtime-error/boundary')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     runtime-error / boundary/\n-     error.tsx\"\n+     \"app/ [layout.tsx]\n+     runtime-error / boundary/ [error.tsx]\"\n     `)\n   })\n \n   it('should display parallel routes default page when present', async () => {\n     const browser = await next.browser('/parallel-default/subroute')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     parallel-default/\n-     layout.tsx\n-     default.tsx\n-     @bar/\n-     layout.tsx\n-     subroute/\n-     page.tsx\n-     @foo/\n-     default.tsx\"\n+     \"app/ [layout.tsx]\n+     parallel-default/ [layout.tsx, default.tsx]\n+     @bar/ [layout.tsx]\n+     subroute/ [page.tsx]\n+     @foo/ [default.tsx]\"\n     `)\n   })\n \n   it('should display boundary selector when a segment has only boundary files', async () => {\n     const browser = await next.browser('/no-layout/framework/blog')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     no-layout/\n-     framework/\n-     layout.tsx\n-     blog/\n-     layout.tsx\n-     page.tsx\"\n+     \"app/ [layout.tsx]\n+     no-layout/ []\n+     framework/ [layout.tsx]\n+     blog/ [layout.tsx, page.tsx]\"\n     `)\n   })\n })"
        },
        {
            "sha": "aa0e964739d2c5c8bf3a31bd758ff848adfc4c79",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/8f060ea25ae201b0e69079ab975b48a13aeed6ca/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8f060ea25ae201b0e69079ab975b48a13aeed6ca/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=8f060ea25ae201b0e69079ab975b48a13aeed6ca",
            "patch": "@@ -962,6 +962,36 @@ export async function openDevToolsIndicatorPopover(\n   }\n }\n \n+export async function getSegmentExplorerContent(browser: Playwright) {\n+  // open the devtool button\n+  await openDevToolsIndicatorPopover(browser)\n+\n+  // open the segment explorer\n+  await browser.elementByCss('[data-segment-explorer]').click()\n+\n+  //  wait for the segment explorer to be visible\n+  await browser.waitForElementByCss('[data-nextjs-devtool-segment-explorer]')\n+\n+  const rows = await browser.elementsByCss('.segment-explorer-item')\n+  let result: string[] = []\n+  for (const row of rows) {\n+    // query filename of row: segment-explorer-filename\n+    const segment = (\n+      (await (await row.$('.segment-explorer-filename--path'))?.innerText()) ||\n+      ''\n+    ).trim()\n+    const files = (\n+      (await (await row.$('.segment-explorer-files'))?.innerText()) || ''\n+    )\n+      .split(/\\n+/)\n+      .map((file) => file.trim())\n+\n+    // line format: segment [files]\n+    result.push(`${segment} [${files.join(', ')}]`)\n+  }\n+  return result.join('\\n')\n+}\n+\n export async function hasDevToolsPanel(browser: Playwright) {\n   const result = await browser.eval(() => {\n     const portal = document.querySelector('nextjs-portal')"
        }
    ],
    "stats": {
        "total": 229,
        "additions": 83,
        "deletions": 146
    }
}