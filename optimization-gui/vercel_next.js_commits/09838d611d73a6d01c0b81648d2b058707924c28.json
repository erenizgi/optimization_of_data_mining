{
    "author": "timneutkens",
    "message": "Turbopack: Allow distdir in project directory, outside of the application (#80683)\n\n## What?\n\nAllow putting `distDir` anywhere in the monorepo (inside the project\nroot), not just inside the app's directory.",
    "sha": "09838d611d73a6d01c0b81648d2b058707924c28",
    "files": [
        {
            "sha": "3631f7f562c1329aa66ece71728f9d87d644bd52",
            "filename": "crates/next-api/src/nft_json.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 9,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/09838d611d73a6d01c0b81648d2b058707924c28/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09838d611d73a6d01c0b81648d2b058707924c28/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnft_json.rs?ref=09838d611d73a6d01c0b81648d2b058707924c28",
            "patch": "@@ -47,13 +47,6 @@ impl NftJsonAsset {\n         }\n         .cell()\n     }\n-\n-    #[turbo_tasks::function]\n-    async fn dist_dir(&self) -> Result<Vc<RcStr>> {\n-        Ok(Vc::cell(\n-            format!(\"/{}/\", self.project.dist_dir().await?).into(),\n-        ))\n-    }\n }\n \n #[turbo_tasks::value_impl]\n@@ -114,11 +107,13 @@ impl Asset for NftJsonAsset {\n         let client_root = this.project.client_fs().root();\n         let client_root_ref = client_root.await?;\n \n+        // Example: [output]/apps/my-website/.next/server/app -- without the `.nft.json`\n         let ident_folder = self.path().parent().await?;\n+        // Example: [project]/apps/my-website/.next/server/app -- without the `.nft.json`\n         let ident_folder_in_project_fs = this\n             .project\n-            .project_path()\n-            .join(ident_folder.path.clone())\n+            .project_root_path() // Example: [project]\n+            .join(ident_folder.path.clone()) // apps/my-website/.next/server/app\n             .await?;\n \n         let chunk = this.chunk;"
        },
        {
            "sha": "61eb565e4e85036c8b270b92a4c6e7dd785acf6d",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/09838d611d73a6d01c0b81648d2b058707924c28/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09838d611d73a6d01c0b81648d2b058707924c28/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=09838d611d73a6d01c0b81648d2b058707924c28",
            "patch": "@@ -33,7 +33,10 @@ use turbo_tasks::{\n     trace::TraceRawVcs,\n };\n use turbo_tasks_env::{EnvMap, ProcessEnv};\n-use turbo_tasks_fs::{DiskFileSystem, FileSystem, FileSystemPath, VirtualFileSystem, invalidation};\n+use turbo_tasks_fs::{\n+    DiskFileSystem, FileSystem, FileSystemPath, VirtualFileSystem, get_relative_path_to,\n+    invalidation,\n+};\n use turbopack::{\n     ModuleAssetContext, evaluate_context::node_build_environment,\n     global_module_ids::get_global_module_id_strategy, transition::TransitionOptions,\n@@ -662,7 +665,7 @@ impl Project {\n \n     #[turbo_tasks::function]\n     pub fn output_fs(&self) -> Vc<DiskFileSystem> {\n-        DiskFileSystem::new(rcstr!(\"output\"), self.project_path.clone(), vec![])\n+        DiskFileSystem::new(rcstr!(\"output\"), self.root_path.clone(), vec![])\n     }\n \n     #[turbo_tasks::function]\n@@ -673,7 +676,13 @@ impl Project {\n     #[turbo_tasks::function]\n     pub async fn node_root(self: Vc<Self>) -> Result<Vc<FileSystemPath>> {\n         let this = self.await?;\n-        Ok(self.output_fs().root().join(this.dist_dir.clone()))\n+        let relative_from_root_to_project_path =\n+            get_relative_path_to(&this.root_path, &this.project_path);\n+        Ok(self\n+            .output_fs()\n+            .root()\n+            .join(relative_from_root_to_project_path.into())\n+            .join(this.dist_dir.clone()))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "08eaa94fdc8896acfd343a0dbb61c713eec93a55",
            "filename": "test/e2e/app-dir/upward-distdir/apps/next-nx-test/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fapp%2Flayout.tsx?ref=09838d611d73a6d01c0b81648d2b058707924c28",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/upward-distdir/apps/next-nx-test/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fapp%2Fpage.tsx?ref=09838d611d73a6d01c0b81648d2b058707924c28",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "ba3d13d1ae5f1bc3dfb07c5ce5ba1c9beb563c53",
            "filename": "test/e2e/app-dir/upward-distdir/apps/next-nx-test/next.config.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fapps%2Fnext-nx-test%2Fnext.config.js?ref=09838d611d73a6d01c0b81648d2b058707924c28",
            "patch": "@@ -0,0 +1,8 @@\n+const path = require('path')\n+\n+module.exports = {\n+  distDir: '../.next',\n+  turbopack: {\n+    root: path.join(__dirname, '../..'),\n+  },\n+}"
        },
        {
            "sha": "6271df63b12edf6fd932caefcac590e1908bd3c2",
            "filename": "test/e2e/app-dir/upward-distdir/upward-distdir.test.ts",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fupward-distdir.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fupward-distdir.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fupward-distdir%2Fupward-distdir.test.ts?ref=09838d611d73a6d01c0b81648d2b058707924c28",
            "patch": "@@ -0,0 +1,18 @@\n+import { nextTestSetup, isNextDev } from 'e2e-utils'\n+\n+describe('upward-distdir', () => {\n+  const { next } = nextTestSetup({\n+    skipDeployment: true,\n+    files: __dirname,\n+    installCommand: 'pnpm install',\n+    buildCommand: 'pnpm next build apps/next-nx-test',\n+    startCommand: isNextDev\n+      ? 'pnpm next dev apps/next-nx-test'\n+      : 'pnpm next start apps/next-nx-test',\n+  })\n+\n+  it('should work', async () => {\n+    const $ = await next.render$('/')\n+    expect($('p').text()).toBe('hello world')\n+  })\n+})"
        },
        {
            "sha": "432e11773f5ef7ba71b3bd1d3fd19c543160aaef",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/09838d611d73a6d01c0b81648d2b058707924c28/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=09838d611d73a6d01c0b81648d2b058707924c28",
            "patch": "@@ -3909,13 +3909,13 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/app-dir/nx-handling/nx-handling.test.ts\": {\n-    \"passed\": [],\n-    \"failed\": [\n+    \"passed\": [\n       \"nx-handling should work for pages API\",\n       \"nx-handling should work for pages page\",\n       \"nx-handling should work with app page\",\n       \"nx-handling should work with app route\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 58,
        "deletions": 14
    }
}