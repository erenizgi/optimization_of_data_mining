{
    "author": "eps1lon",
    "message": "[test] Avoid flaky assertions due to dynamic metadata (#81373)",
    "sha": "259f9a62203a2af128d429e34742fbe847c5d7a4",
    "files": [
        {
            "sha": "66a3364b9b3a4c089de9cb6d9ec75b6df326fcb6",
            "filename": "test/e2e/app-dir/metadata/app/cache-deduping/page.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/259f9a62203a2af128d429e34742fbe847c5d7a4/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fcache-deduping%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/259f9a62203a2af128d429e34742fbe847c5d7a4/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fcache-deduping%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fapp%2Fcache-deduping%2Fpage.tsx?ref=259f9a62203a2af128d429e34742fbe847c5d7a4",
            "patch": "@@ -1,6 +1,6 @@\n import React, { cache } from 'react'\n \n-const getRandomMemoized = cache(() => Math.random())\n+const getRandomMemoized = cache(() => Math.random().toString())\n \n async function getRandomMemoizedByFetch() {\n   const res = await fetch(\n@@ -26,7 +26,7 @@ export async function generateMetadata(props, parent) {\n \n   return {\n     title: {\n-      default: JSON.stringify({ val, val2 }),\n+      default: JSON.stringify({ page: 'cache-deduping', val, val2 }),\n     },\n   }\n }"
        },
        {
            "sha": "c56acc9cdb6b5a5e7f565c8423454da427e1194c",
            "filename": "test/e2e/app-dir/metadata/metadata.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 14,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/259f9a62203a2af128d429e34742fbe847c5d7a4/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/259f9a62203a2af128d429e34742fbe847c5d7a4/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata%2Fmetadata.test.ts?ref=259f9a62203a2af128d429e34742fbe847c5d7a4",
            "patch": "@@ -7,6 +7,7 @@ import {\n   createMultiDomMatcher,\n   checkMetaNameContentPair,\n   checkLink,\n+  retry,\n } from 'next-test-utils'\n import fs from 'fs/promises'\n import path from 'path'\n@@ -227,16 +228,17 @@ describe('app dir - metadata', () => {\n       const browser = await next.browser('/')\n       await browser.waitForElementByCss('p#index')\n       await browser.eval(`next.router.push('/alternates')`)\n-      // wait for /alternates page is loaded\n-      await browser.waitForElementByCss('p#alternates')\n \n       const matchDom = createDomMatcher(browser)\n-      await matchDom('link', 'rel=\"canonical\"', {\n-        href: 'https://example.com/alternates',\n-      })\n-      await matchDom('link', 'title=\"js title\"', {\n-        type: 'application/rss+xml',\n-        href: 'https://example.com/blog/js.rss',\n+      // Dynamic metadata streams in async\n+      await retry(async () => {\n+        await matchDom('link', 'rel=\"canonical\"', {\n+          href: 'https://example.com/alternates',\n+        })\n+        await matchDom('link', 'title=\"js title\"', {\n+          type: 'application/rss+xml',\n+          href: 'https://example.com/blog/js.rss',\n+        })\n       })\n     })\n \n@@ -283,18 +285,24 @@ describe('app dir - metadata', () => {\n         .click()\n         .waitForElementByCss('#basic')\n \n-      await checkMetaNameContentPair(\n-        browser,\n-        'referrer',\n-        'origin-when-cross-origin'\n-      )\n+      await retry(async () => {\n+        await checkMetaNameContentPair(\n+          browser,\n+          'referrer',\n+          'origin-when-cross-origin'\n+        )\n+      })\n+\n       await browser.back().waitForElementByCss('#index')\n       expect(await getTitle(browser)).toBe('index page')\n       await browser\n         .elementByCss('#to-title')\n         .click()\n         .waitForElementByCss('#title')\n-      expect(await getTitle(browser)).toBe('this is the page title')\n+\n+      await retry(async () => {\n+        expect(await getTitle(browser)).toBe('this is the page title')\n+      })\n     })\n \n     it('should support generateMetadata dynamic props', async () => {\n@@ -809,6 +817,12 @@ describe('app dir - metadata', () => {\n         .waitForElementByCss('#value')\n       const value = await browser.elementByCss('#value').text()\n       const value2 = await browser.elementByCss('#value2').text()\n+      // Dynamic metadata streams in async\n+      await retry(async () => {\n+        expect(await browser.eval(`document.title`)).toContain(\n+          '\"page\":\"cache-deduping\"'\n+        )\n+      })\n       // Value in the title should match what's shown on the page component\n       const title = await browser.eval(`document.title`)\n       const obj = JSON.parse(title)"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 30,
        "deletions": 16
    }
}