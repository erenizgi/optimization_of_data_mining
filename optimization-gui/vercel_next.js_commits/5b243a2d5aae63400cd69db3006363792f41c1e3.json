{
    "author": "delbaoliveira",
    "message": "Docs: Improve `\"use cache\"` and `cacheLife` API references (#78024)\n\nDecoupling from: https://github.com/vercel/next.js/pull/73437\n\n\n- Add \"How `use cache` works\" section\n  - Clarify cache keys inputs\n  - Describe what happens during build, runtime, and revalidation\n- Correct the default values for the `cacheLife` profiles\n- Add the default time for `expireTime`\n- Add note about `staleTimes` and `expireTime` affecting the default\ncache profile",
    "sha": "5b243a2d5aae63400cd69db3006363792f41c1e3",
    "files": [
        {
            "sha": "25cf971562f78ae6135d355ec3785920da55db4d",
            "filename": "docs/01-app/05-api-reference/01-directives/use-cache.mdx",
            "status": "modified",
            "additions": 69,
            "deletions": 39,
            "changes": 108,
            "blob_url": "https://github.com/vercel/next.js/blob/5b243a2d5aae63400cd69db3006363792f41c1e3/docs%2F01-app%2F05-api-reference%2F01-directives%2Fuse-cache.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/5b243a2d5aae63400cd69db3006363792f41c1e3/docs%2F01-app%2F05-api-reference%2F01-directives%2Fuse-cache.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F05-api-reference%2F01-directives%2Fuse-cache.mdx?ref=5b243a2d5aae63400cd69db3006363792f41c1e3",
            "patch": "@@ -14,11 +14,11 @@ related:\n     - app/api-reference/functions/revalidateTag\n ---\n \n-The `use cache` directive designates a component and/or a function to be cached. It can be used at the top of a file to indicate that all exports in the file are cacheable, or inline at the top of a function or component to inform Next.js the return value should be cached and reused for subsequent requests. This is an experimental Next.js feature, and not a native React feature like [`use client`](/docs/app/api-reference/directives/use-client) or [`use server`](/docs/app/api-reference/directives/use-server).\n+The `use cache` directive allows you to mark a route, React component, or a function as cacheable. It can be used at the top of a file to indicate that all exports in the file should be cached, or inline at the top of function or component to cache the return value.\n \n ## Usage\n \n-Enable support for the `use cache` directive with the [`useCache`](/docs/app/api-reference/config/next-config-js/useCache) flag in your `next.config.ts` file:\n+`use cache` is currently an experimental feature. To enable it, add the [`useCache`](/docs/app/api-reference/config/next-config-js/useCache) option to your `next.config.ts` file:\n \n ```ts filename=\"next.config.ts\" switcher\n import type { NextConfig } from 'next'\n@@ -43,9 +43,9 @@ const nextConfig = {\n module.exports = nextConfig\n ```\n \n-Additionally, `use cache` directives are also enabled when the [`dynamicIO`](/docs/app/api-reference/config/next-config-js/dynamicIO) flag is set.\n+> **Good to know:** `use cache` can also be enabled with the [`dynamicIO`](/docs/app/api-reference/config/next-config-js/dynamicIO) option.\n \n-Then, you can use the `use cache` directive at the file, component, or function level:\n+Then, add `use cache` at the file, component, or function level:\n \n ```tsx\n // File level\n@@ -69,20 +69,68 @@ export async function getData() {\n }\n ```\n \n-## Good to know\n+## How `use cache` works\n \n-- `use cache` is an experimental Next.js feature, and not a native React feature like [`use client`](/docs/app/api-reference/directives/use-client) or [`use server`](/docs/app/api-reference/directives/use-server).\n-- Any [serializable](https://react.dev/reference/rsc/use-server#serializable-parameters-and-return-values) arguments (or props) passed to the cached function, as well as any serializable values it reads from the parent scope, will be converted to a format like JSON and automatically become a part of the cache key.\n-- Any non-serializable arguments, props, or closed-over values will turn into opaque references inside the cached function, and can be only passed through and not inspected nor modified. These non-serializable values will be filled in at the request time and won't become a part of the cache key.\n-  - For example, a cached function can take in JSX as a `children` prop and return `<div>{children}</div>`, but it won't be able to introspect the actual `children` object.\n-- The return value of the cacheable function must also be serializable. This ensures that the cached data can be stored and retrieved correctly.\n-- Functions that use the `use cache` directive must not have any side-effects, such as modifying state, directly manipulating the DOM, or setting timers to execute code at intervals.\n-- If used alongside [Partial Prerendering](/docs/app/building-your-application/rendering/partial-prerendering), segments that have `use cache` will be prerendered as part of the static HTML shell.\n-- Unlike [`unstable_cache`](/docs/app/api-reference/functions/unstable_cache) which only supports JSON data, `use cache` can cache any serializable data React can render, including the render output of components.\n+### Cache keys\n+\n+A cache entry's key is generated using a serialized version of its inputs, which includes:\n+\n+- Build ID (generated for each build)\n+- Function ID (a secure identifier unique to the function)\n+- The [serializable](https://react.dev/reference/rsc/use-server#serializable-parameters-and-return-values) function arguments (or props).\n+\n+The arguments passed to the cached function, as well as any values it reads from the parent scope automatically become a part of the key. This means, the same cache entry will be reused as long as its inputs are the same.\n+\n+## Non-serializable arguments\n+\n+Any non-serializable arguments, props, or closed-over values will turn into references inside the cached function, and can be only passed through and not inspected nor modified. These non-serializable values will be filled in at the request time and won't become a part of the cache key.\n+\n+For example, a cached function can take in JSX as a `children` prop and return `<div>{children}</div>`, but it won't be able to introspect the actual `children` object. This allows you to nest uncached content inside a cached component.\n+\n+```tsx filename=\"app/ui/cached-component.tsx\" switcher\n+function CachedComponent({ children }: { children: ReactNode }) {\n+  'use cache'\n+  return <div>{children}</div>\n+}\n+```\n+\n+```jsx filename=\"app/ui/cached-component.js\" switcher\n+function CachedComponent({ children }) {\n+  'use cache'\n+  return <div>{children}</div>\n+}\n+```\n+\n+## Return values\n+\n+The return value of the cacheable function must be serializable. This ensures that the cached data can be stored and retrieved correctly.\n+\n+## `use cache` at build time\n+\n+When used at the top of a [layout](/docs/app/api-reference/file-conventions/layout) or [page](/docs/app/api-reference/file-conventions/page), the route segment will be prerendered, allowing it to later be [revalidated](#during-revalidation).\n+\n+This means `use cache` cannot be used with [request-time APIs](/docs/app/building-your-application/rendering/server-components#dynamic-apis) like `cookies` or `headers`.\n+\n+## `use cache` at runtime\n+\n+On the **server**, the cache entries of individual components or functions will be cached in-memory.\n+\n+Then, on the **client**, any content returned from the server cache will be stored in the browser's memory for the duration of the session or until [revalidated](#during-revalidation).\n+\n+## During revalidation\n+\n+By default, `use cache` has server-side revalidation period of **15 minutes**. While this period may be useful for content that doesn't require frequent updates, you can use the `cacheLife` and `cacheTag` APIs to configure when the individual cache entries should be revalidated.\n+\n+- [`cacheLife`](/docs/app/api-reference/functions/cacheLife): Configure the cache entry lifetime.\n+- [`cacheTag`](/docs/app/api-reference/functions/cacheTag): Create tags for on-demand revalidation.\n+\n+Both of these APIs integrate across the client and server caching layers, meaning you can configure your caching semantics in one place and have them apply everywhere.\n+\n+See the [`cacheLife`](/docs/app/api-reference/functions/cacheLife) and [`cacheTag`](/docs/app/api-reference/functions/cacheTag) API docs for more information.\n \n ## Examples\n \n-### Caching entire routes with `use cache`\n+### Caching an entire route with `use cache`\n \n To prerender an entire route, add `use cache` to the top of **both** the `layout` and `page` files. Each of these segments are treated as separate entry points in your application, and will be cached independently.\n \n@@ -138,13 +186,14 @@ export default function Page() {\n }\n ```\n \n-> This is recommended for applications that previously used the [`export const dynamic = \"force-static\"`](/docs/app/api-reference/file-conventions/route-segment-config#dynamic) option, and will ensure the entire route is prerendered.\n-\n-### Caching component output with `use cache`\n+> **Good to know**:\n+>\n+> - If `use cache` is added only to the `layout` or the `page`, only that route segment and any components imported into it will be cached.\n+> - If any of the nested children in the route use [Dynamic APIs](/docs/app/building-your-application/rendering/server-components#dynamic-apis), then the route will opt out of prerendering.\n \n-You can use `use cache` at the component level to cache any fetches or computations performed within that component. When you reuse the component throughout your application it can share the same cache entry as long as the props maintain the same structure.\n+### Caching a component's output with `use cache`\n \n-The props are serialized and form part of the cache key, and the cache entry will be reused as long as the serialized props produce the same value in each instance.\n+You can use `use cache` at the component level to cache any fetches or computations performed within that component. The cache entry will be reused as long as the serialized props produce the same value in each instance.\n \n ```tsx filename=\"app/components/bookings.tsx\" highlight={2} switcher\n export async function Bookings({ type = 'haircut' }: BookingsProps) {\n@@ -174,7 +223,7 @@ export async function Bookings({ type = 'haircut' }) {\n \n ### Caching function output with `use cache`\n \n-Since you can add `use cache` to any asynchronous function, you aren't limited to caching components or routes only. You might want to cache a network request or database query or compute something that is very slow. By adding `use cache` to a function containing this type of work it becomes cacheable, and when reused, will share the same cache entry.\n+Since you can add `use cache` to any asynchronous function, you aren't limited to caching components or routes only. You might want to cache a network request, a database query, or a slow computation.\n \n ```tsx filename=\"app/actions.ts\" highlight={2} switcher\n export async function getData() {\n@@ -194,25 +243,6 @@ export async function getData() {\n }\n ```\n \n-### Revalidating\n-\n-By default, Next.js sets a **[revalidation period](/docs/app/building-your-application/data-fetching/fetching#revalidating-cached-data) of 15 minutes** when you use the `use cache` directive. Next.js sets a near-infinite expiration duration, meaning it's suitable for content that doesn't need frequent updates.\n-\n-While this revalidation period may be useful for content you don't expect to change often, you can use the `cacheLife` and `cacheTag` APIs to configure the cache behavior:\n-\n-- [`cacheLife`](/docs/app/api-reference/functions/cacheLife): For time-based revalidation periods.\n-- [`cacheTag`](/docs/app/api-reference/functions/cacheTag): For tagging cached data.\n-\n-Both of these APIs integrate across the client and server caching layers, meaning you can configure your caching semantics in one place and have them apply everywhere.\n-\n-See the [`cacheLife`](/docs/app/api-reference/functions/cacheLife) and [`cacheTag`](/docs/app/api-reference/functions/cacheTag) docs for more information.\n-\n-### Invalidating\n-\n-To invalidate the cached data, you can use the [`revalidateTag`](/docs/app/api-reference/functions/revalidateTag) function.\n-\n-See the [`revalidateTag`](/docs/app/api-reference/functions/revalidateTag) docs for more information.\n-\n ### Interleaving\n \n If you need to pass non-serializable arguments to a cacheable function, you can pass them as `children`. This means the `children` reference can change without affecting the cache entry."
        },
        {
            "sha": "ea5464301576620303dc4847fbdfd488ca3ead5a",
            "filename": "docs/01-app/05-api-reference/04-functions/cacheLife.mdx",
            "status": "modified",
            "additions": 12,
            "deletions": 10,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/5b243a2d5aae63400cd69db3006363792f41c1e3/docs%2F01-app%2F05-api-reference%2F04-functions%2FcacheLife.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/5b243a2d5aae63400cd69db3006363792f41c1e3/docs%2F01-app%2F05-api-reference%2F04-functions%2FcacheLife.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F05-api-reference%2F04-functions%2FcacheLife.mdx?ref=5b243a2d5aae63400cd69db3006363792f41c1e3",
            "patch": "@@ -66,22 +66,24 @@ export default async function Page() {\n \n ### Default cache profiles\n \n-Next.js provides a set of named cache profiles modeled on various timescales. If you don't specify a cache profile in the `cacheLife` function alongside the `use cache` directive, Next.js will automatically apply the “default” cache profile.\n+Next.js provides a set of named cache profiles modeled on various timescales. If you don't specify a cache profile in the `cacheLife` function alongside the `use cache` directive, Next.js will automatically apply the `default` cache profile.\n \n However, we recommend always adding a cache profile when using the `use cache` directive to explicitly define caching behavior.\n \n-| **Profile** | **Stale** | **Revalidate** | **Expire**     | **Description**                                                          |\n-| ----------- | --------- | -------------- | -------------- | ------------------------------------------------------------------------ |\n-| `default`   | undefined | 15 minutes     | INFINITE_CACHE | Default profile, suitable for content that doesn't need frequent updates |\n-| `seconds`   | undefined | 1 second       | 1 minute       | For rapidly changing content requiring near real-time updates            |\n-| `minutes`   | 5 minutes | 1 minute       | 1 hour         | For content that updates frequently within an hour                       |\n-| `hours`     | 5 minutes | 1 hour         | 1 day          | For content that updates daily but can be slightly stale                 |\n-| `days`      | 5 minutes | 1 day          | 1 week         | For content that updates weekly but can be a day old                     |\n-| `weeks`     | 5 minutes | 1 week         | 1 month        | For content that updates monthly but can be a week old                   |\n-| `max`       | 5 minutes | 1 month        | INFINITE_CACHE | For very stable content that rarely needs updating                       |\n+| **Profile** | `stale`   | `revalidate` | `expire` | **Description**                                                          |\n+| ----------- | --------- | ------------ | -------- | ------------------------------------------------------------------------ |\n+| `default`   | 5 minutes | 15 minutes   | 1 year   | Default profile, suitable for content that doesn't need frequent updates |\n+| `seconds`   | 0         | 1 second     | 1 second | For rapidly changing content requiring near real-time updates            |\n+| `minutes`   | 5 minutes | 1 minute     | 1 hour   | For content that updates frequently within an hour                       |\n+| `hours`     | 5 minutes | 1 hour       | 1 day    | For content that updates daily but can be slightly stale                 |\n+| `days`      | 5 minutes | 1 day        | 1 week   | For content that updates weekly but can be a day old                     |\n+| `weeks`     | 5 minutes | 1 week       | 30 days  | For content that updates monthly but can be a week old                   |\n+| `max`       | 5 minutes | 30 days      | 1 year   | For very stable content that rarely needs updating                       |\n \n The string values used to reference cache profiles don't carry inherent meaning; instead they serve as semantic labels. This allows you to better understand and manage your cached content within your codebase.\n \n+> **Good to know:** Updating the [`staleTimes`](/docs/app/api-reference/config/next-config-js/staleTimes) and [`expireTime`](/docs/app/api-reference/config/next-config-js/expireTime) config options also updates the `stale` and `expire` properties of the `default` cache profile.\n+\n ### Custom cache profiles\n \n You can configure custom cache profiles by adding them to the [`cacheLife`](/docs/app/api-reference/config/next-config-js/cacheLife) option in your `next.config.ts` file."
        }
    ],
    "stats": {
        "total": 130,
        "additions": 81,
        "deletions": 49
    }
}