{
    "author": "lukesandberg",
    "message": "[turbopack] Defend against json cyles in our execution tests (#81079)\n\nHandle circular references in Jest test results \n\nOtherwise failing tests may crash the IPC mechanism. e.g. a test failure induced this\n\n```\n──── STDERR:             turbopack-tests::execution test_tests__execution__turbopack__basic__esm_this\nInput: /Users/lukesandberg/projects/next.js/turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/esm-this\nnew file turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/esm-this/issues/Error evaluating Node.js code-4c12f2.txt detected:\n--- expected\n+++ actual\n@@ -0,0 +1,6 @@\n+error - [transform] [project]/turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/esm-this/input/index.js  Error evaluating Node.js code\n+  TypeError: Converting circular structure to JSON\n+      --> starting at object with constructor 'Object'\n+      --- property 'foo' closes the circle\n+      [at <anonymous>]\n+      at run (turbopack:///[turbopack-node]/ipc/evaluate.ts:96:52) [WORKSPACE_ROOT/turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/esm-this/output/[turbopack-node]__b000890d._.js:414:66]\n\\ No newline at end of file\n```\n\nWith this change we can see the actual test failure\n\n```\nthread 'test_tests__execution__turbopack__basic__esm_this' panicked at turbopack/crates/turbopack-tests/tests/execution.rs:106:9:\nFailed with error(s) in the following test(s):\n\n\"`this` in esm should be undefined\":\nError: expect(received).toBe(expected) // Object.is equality\n\nExpected: undefined\nReceived: {\"foo\": [Circular]}\n    at Object.eval (file:///Users/lukesandberg/projects/next.js/turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/esm-this/output/b1abf_turbopack-tests_tests_execution_turbopack_basic_esm-this_input_index_021e2195.js:18:19)\n    at Promise.then.completed (/Users/lukesandberg/projects/next.js/node_modules/.pnpm/jest-circus@29.5.0/node_modules/jest-circus/build/utils.js:293:28)\n\n```",
    "sha": "12ee9b2545bfcad779ae746ed83d44e0afeffeae",
    "files": [
        {
            "sha": "e4dbe871c88523d6bd7501c7a6eae84f494a6d1b",
            "filename": "turbopack/crates/turbopack-tests/js/jest-entry.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 1,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/12ee9b2545bfcad779ae746ed83d44e0afeffeae/turbopack%2Fcrates%2Fturbopack-tests%2Fjs%2Fjest-entry.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/12ee9b2545bfcad779ae746ed83d44e0afeffeae/turbopack%2Fcrates%2Fturbopack-tests%2Fjs%2Fjest-entry.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Fjs%2Fjest-entry.ts?ref=12ee9b2545bfcad779ae746ed83d44e0afeffeae",
            "patch": "@@ -35,7 +35,23 @@ export default async function run() {\n \n   await import('TESTS')\n \n-  const jestResult = await jest.run()\n+  let jestResult = await jest.run()\n+  // Jest test results can contain references to arbitrary objects.\n+  // Defensively remove circular references to avoid breaking our serialization protocol.\n+  const seen = new Set()\n+  jestResult = JSON.parse(\n+    JSON.stringify(jestResult, (k, v) => {\n+      if (v != null && typeof v === 'object') {\n+        if (!seen.has(v)) {\n+          seen.add(v)\n+          return v\n+        } else {\n+          return 'CIRCULAR_REFERENCE_REMOVED'\n+        }\n+      }\n+      return v\n+    })\n+  )\n \n   // Wait a full tick for unhandledRejection handlers to run -- a microtask is not sufficient.\n   await new Promise((resolve) => setTimeout(resolve, 0))"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 17,
        "deletions": 1
    }
}