{
    "author": "unstubbable",
    "message": "[dynamicIO] Fix dev warmup (#77829)\n\nWhen `dynamicIO` is enabled, we're triggering a warmup request in dev mode. This ensures that replayed logs are associated with the correct environment (`Prerender` vs. `Server`), by seeding the caches before the actual render.\r\n\r\nThis PR fixes two issues with the dev warmup:\r\n- Ensures that cache keys are identical between the warmup, the subsequent dynamic render, and the dynamic validation, by providing the HMR refresh hash (part of the cache key) for all dev render phases.\r\n- Ensures that stale cache entries are discarded during the warmup, by providing the implicit tags also during the warmup (and the dynamic validation).",
    "sha": "ce5206fa1353d11225df986a0d14afb7b6b91c84",
    "files": [
        {
            "sha": "5e2956557a14d7db150ede86c83145aae3908323",
            "filename": "packages/next/src/client/components/app-router-headers.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-headers.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-headers.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router-headers.ts?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -12,6 +12,7 @@ export const NEXT_ROUTER_PREFETCH_HEADER = 'Next-Router-Prefetch' as const\n export const NEXT_ROUTER_SEGMENT_PREFETCH_HEADER =\n   'Next-Router-Segment-Prefetch' as const\n export const NEXT_HMR_REFRESH_HEADER = 'Next-HMR-Refresh' as const\n+export const NEXT_HMR_REFRESH_HASH_COOKIE = '__next_hmr_refresh_hash__' as const\n export const NEXT_URL = 'Next-Url' as const\n export const RSC_CONTENT_TYPE_HEADER = 'text/x-component' as const\n "
        },
        {
            "sha": "ad4095d09fc29d630ae00b360d2ed016aaaf0608",
            "filename": "packages/next/src/client/components/react-dev-overlay/app/hot-reloader-client.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fapp%2Fhot-reloader-client.tsx?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -46,6 +46,7 @@ import type { GlobalErrorComponent } from '../../error-boundary'\n import type { DevIndicatorServerState } from '../../../../server/dev/dev-indicator-server-state'\n import reportHmrLatency from '../utils/report-hmr-latency'\n import { TurbopackHmr } from '../utils/turbopack-hot-reloader-common'\n+import { NEXT_HMR_REFRESH_HASH_COOKIE } from '../../app-router-headers'\n \n export interface Dispatcher {\n   onBuildOk(): void\n@@ -412,7 +413,7 @@ function processMessage(\n \n       // Store the latest hash in a session cookie so that it's sent back to the\n       // server with any subsequent requests.\n-      document.cookie = `__next_hmr_refresh_hash__=${obj.hash}`\n+      document.cookie = `${NEXT_HMR_REFRESH_HASH_COOKIE}=${obj.hash}`\n \n       if (RuntimeErrorHandler.hadRuntimeError) {\n         if (reloading) return"
        },
        {
            "sha": "495f932c066cb05b2b8c646f5d05579e8ab4b652",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 89,
            "deletions": 50,
            "changes": 139,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -53,6 +53,7 @@ import {\n   NEXT_URL,\n   RSC_HEADER,\n   NEXT_ROUTER_SEGMENT_PREFETCH_HEADER,\n+  NEXT_HMR_REFRESH_HASH_COOKIE,\n } from '../../client/components/app-router-headers'\n import {\n   createTrackedMetadataContext,\n@@ -226,6 +227,12 @@ export type AppRenderContext = {\n   isNotFoundPath: boolean\n   nonce: string | undefined\n   res: BaseNextResponse\n+  /**\n+   * For now, the implicit tags are common for the whole route. If we ever start\n+   * rendering/revalidating segments independently, they need to move to the\n+   * work unit store.\n+   */\n+  implicitTags: ImplicitTags\n }\n \n interface ParseRequestHeadersOptions {\n@@ -679,16 +686,24 @@ async function warmupDevRender(\n   req: BaseNextRequest,\n   ctx: AppRenderContext\n ): Promise<RenderResult> {\n-  const renderOpts = ctx.renderOpts\n+  const {\n+    clientReferenceManifest,\n+    componentMod,\n+    getDynamicParamFromSegment,\n+    implicitTags,\n+    renderOpts,\n+    workStore,\n+  } = ctx\n+\n   if (!renderOpts.dev) {\n     throw new InvariantError(\n       'generateDynamicFlightRenderResult should never be called in `next start` mode.'\n     )\n   }\n \n   const rootParams = getRootParams(\n-    ctx.componentMod.tree,\n-    ctx.getDynamicParamFromSegment\n+    componentMod.tree,\n+    getDynamicParamFromSegment\n   )\n \n   function onFlightDataRenderError(err: DigestedError) {\n@@ -715,7 +730,7 @@ async function warmupDevRender(\n     type: 'prerender',\n     phase: 'render',\n     rootParams,\n-    implicitTags: undefined,\n+    implicitTags,\n     renderSignal: renderController.signal,\n     controller: prerenderController,\n     cacheSignal,\n@@ -725,6 +740,7 @@ async function warmupDevRender(\n     stale: INFINITE_CACHE,\n     tags: [],\n     prerenderResumeDataCache,\n+    hmrRefreshHash: req.cookies[NEXT_HMR_REFRESH_HASH_COOKIE],\n   }\n \n   const rscPayload = await workUnitAsyncStorage.run(\n@@ -737,9 +753,9 @@ async function warmupDevRender(\n   // which contains the subset React.\n   workUnitAsyncStorage.run(\n     prerenderStore,\n-    ctx.componentMod.renderToReadableStream,\n+    componentMod.renderToReadableStream,\n     rscPayload,\n-    ctx.clientReferenceManifest.clientModules,\n+    clientReferenceManifest.clientModules,\n     {\n       onError,\n       signal: renderController.signal,\n@@ -757,7 +773,7 @@ async function warmupDevRender(\n   // that calls into renderToHTML... expects a result. We should refactor this to\n   // lift the warmup pathway outside of renderToHTML... but for now this suffices\n   return new FlightRenderResult('', {\n-    fetchMetrics: ctx.workStore.fetchMetrics,\n+    fetchMetrics: workStore.fetchMetrics,\n     devRenderResumeDataCache: createRenderResumeDataCache(\n       prerenderResumeDataCache\n     ),\n@@ -1341,6 +1357,12 @@ async function renderToHTMLOrFlightImpl(\n \n   const isActionRequest = getServerActionRequestMetadata(req).isServerAction\n \n+  const implicitTags = await getImplicitTags(\n+    workStore.page,\n+    url,\n+    fallbackRouteParams\n+  )\n+\n   const ctx: AppRenderContext = {\n     componentMod: ComponentMod,\n     url,\n@@ -1362,16 +1384,11 @@ async function renderToHTMLOrFlightImpl(\n     nonce,\n     res,\n     sharedContext,\n+    implicitTags,\n   }\n \n   getTracer().setRootSpanAttribute('next.route', pagePath)\n \n-  const implicitTags = await getImplicitTags(\n-    workStore.page,\n-    url,\n-    fallbackRouteParams\n-  )\n-\n   if (isStaticGeneration) {\n     // We're either building or revalidating. In either case we need to\n     // prerender our page rather than render it.\n@@ -1392,8 +1409,7 @@ async function renderToHTMLOrFlightImpl(\n       ctx,\n       metadata,\n       workStore,\n-      loaderTree,\n-      implicitTags\n+      loaderTree\n     )\n \n     // If we're debugging partial prerendering, print all the dynamic API accesses\n@@ -2215,12 +2231,16 @@ async function spawnDynamicValidationInDev(\n   route: string,\n   requestStore: RequestStore\n ): Promise<void> {\n-  const { componentMod: ComponentMod } = ctx\n+  const { componentMod: ComponentMod, implicitTags } = ctx\n   const rootParams = getRootParams(\n     ComponentMod.tree,\n     ctx.getDynamicParamFromSegment\n   )\n \n+  const hmrRefreshHash = requestStore.cookies.get(\n+    NEXT_HMR_REFRESH_HASH_COOKIE\n+  )?.value\n+\n   // Prerender controller represents the lifetime of the prerender.\n   // It will be aborted when a Task is complete or a synchronously aborting\n   // API is called. Notably during cache-filling renders this does not actually\n@@ -2238,7 +2258,7 @@ async function spawnDynamicValidationInDev(\n     type: 'prerender',\n     phase: 'render',\n     rootParams,\n-    implicitTags: undefined,\n+    implicitTags,\n     renderSignal: initialServerRenderController.signal,\n     controller: initialServerPrerenderController,\n     cacheSignal,\n@@ -2248,14 +2268,15 @@ async function spawnDynamicValidationInDev(\n     stale: INFINITE_CACHE,\n     tags: [],\n     prerenderResumeDataCache,\n+    hmrRefreshHash,\n   }\n \n   const initialClientController = new AbortController()\n   const initialClientPrerenderStore: PrerenderStore = {\n     type: 'prerender',\n     phase: 'render',\n     rootParams,\n-    implicitTags: undefined,\n+    implicitTags,\n     renderSignal: initialClientController.signal,\n     controller: initialClientController,\n     cacheSignal,\n@@ -2265,6 +2286,7 @@ async function spawnDynamicValidationInDev(\n     stale: INFINITE_CACHE,\n     tags: [],\n     prerenderResumeDataCache,\n+    hmrRefreshHash,\n   }\n \n   // We're not going to use the result of this render because the only time it could be used\n@@ -2401,7 +2423,7 @@ async function spawnDynamicValidationInDev(\n     type: 'prerender',\n     phase: 'render',\n     rootParams,\n-    implicitTags: undefined,\n+    implicitTags,\n     renderSignal: finalServerController.signal,\n     controller: finalServerController,\n     // During the final prerender we don't need to track cache access so we omit the signal\n@@ -2412,6 +2434,7 @@ async function spawnDynamicValidationInDev(\n     stale: INFINITE_CACHE,\n     tags: [],\n     prerenderResumeDataCache,\n+    hmrRefreshHash,\n   }\n \n   const finalClientController = new AbortController()\n@@ -2422,7 +2445,7 @@ async function spawnDynamicValidationInDev(\n     type: 'prerender',\n     phase: 'render',\n     rootParams,\n-    implicitTags: undefined,\n+    implicitTags,\n     renderSignal: finalClientController.signal,\n     controller: finalClientController,\n     // During the final prerender we don't need to track cache access so we omit the signal\n@@ -2433,6 +2456,7 @@ async function spawnDynamicValidationInDev(\n     stale: INFINITE_CACHE,\n     tags: [],\n     prerenderResumeDataCache,\n+    hmrRefreshHash,\n   }\n \n   const finalServerPayload = await workUnitAsyncStorage.run(\n@@ -2592,16 +2616,23 @@ async function prerenderToStream(\n   ctx: AppRenderContext,\n   metadata: AppPageRenderResultMetadata,\n   workStore: WorkStore,\n-  tree: LoaderTree,\n-  implicitTags: ImplicitTags\n+  tree: LoaderTree\n ): Promise<PrerenderToStreamResult> {\n   // When prerendering formState is always null. We still include it\n   // because some shared APIs expect a formState value and this is slightly\n   // more explicit than making it an optional function argument\n   const formState = null\n-  const rootParams = getRootParams(tree, ctx.getDynamicParamFromSegment)\n \n-  const renderOpts = ctx.renderOpts\n+  const {\n+    assetPrefix,\n+    getDynamicParamFromSegment,\n+    implicitTags,\n+    nonce,\n+    pagePath,\n+    renderOpts,\n+  } = ctx\n+\n+  const rootParams = getRootParams(tree, getDynamicParamFromSegment)\n   const ComponentMod = renderOpts.ComponentMod\n   // TODO: fix this typescript\n   const clientReferenceManifest = renderOpts.clientReferenceManifest!\n@@ -2610,7 +2641,7 @@ async function prerenderToStream(\n   const { ServerInsertedHTMLProvider, renderServerInsertedHTML } =\n     createServerInsertedHTML()\n   const { ServerInsertedMetadataProvider, getServerInsertedMetadata } =\n-    createServerInsertedMetadata(ctx.nonce)\n+    createServerInsertedMetadata(nonce)\n \n   const tracingMetadata = getTracedMetadata(\n     getTracer().getTracePropagationData(),\n@@ -2624,25 +2655,25 @@ async function prerenderToStream(\n           polyfill.endsWith('.js') && !polyfill.endsWith('.module.js')\n       )\n       .map((polyfill) => ({\n-        src: `${ctx.assetPrefix}/_next/${polyfill}${getAssetQueryString(\n+        src: `${assetPrefix}/_next/${polyfill}${getAssetQueryString(\n           ctx,\n           false\n         )}`,\n         integrity: renderOpts.subresourceIntegrityManifest?.[polyfill],\n         crossOrigin: renderOpts.crossOrigin,\n         noModule: true,\n-        nonce: ctx.nonce,\n+        nonce: nonce,\n       }))\n \n   const [preinitScripts, bootstrapScript] = getRequiredScripts(\n     renderOpts.buildManifest,\n     // Why is assetPrefix optional on renderOpts?\n     // @TODO make it default empty string on renderOpts and get rid of it from ctx\n-    ctx.assetPrefix,\n+    assetPrefix,\n     renderOpts.crossOrigin,\n     renderOpts.subresourceIntegrityManifest,\n     getAssetQueryString(ctx, true),\n-    ctx.nonce,\n+    nonce,\n     renderOpts.page\n   )\n \n@@ -2759,6 +2790,7 @@ async function prerenderToStream(\n           stale: INFINITE_CACHE,\n           tags: [...implicitTags.tags],\n           prerenderResumeDataCache,\n+          hmrRefreshHash: undefined,\n         })\n \n         // We're not going to use the result of this render because the only time it could be used\n@@ -2853,6 +2885,7 @@ async function prerenderToStream(\n             stale: INFINITE_CACHE,\n             tags: [...implicitTags.tags],\n             prerenderResumeDataCache,\n+            hmrRefreshHash: undefined,\n           }\n \n           const prerender = require('react-dom/static.edge')\n@@ -2870,7 +2903,7 @@ async function prerenderToStream(\n                   ServerInsertedMetadataProvider={\n                     ServerInsertedMetadataProvider\n                   }\n-                  nonce={ctx.nonce}\n+                  nonce={nonce}\n                 />,\n                 {\n                   signal: initialClientController.signal,\n@@ -2939,6 +2972,7 @@ async function prerenderToStream(\n           stale: INFINITE_CACHE,\n           tags: [...implicitTags.tags],\n           prerenderResumeDataCache,\n+          hmrRefreshHash: undefined,\n         })\n \n         const finalAttemptRSCPayload = await workUnitAsyncStorage.run(\n@@ -3008,6 +3042,7 @@ async function prerenderToStream(\n           stale: INFINITE_CACHE,\n           tags: [...implicitTags.tags],\n           prerenderResumeDataCache,\n+          hmrRefreshHash: undefined,\n         }\n \n         let clientIsDynamic = false\n@@ -3026,7 +3061,7 @@ async function prerenderToStream(\n                 clientReferenceManifest={clientReferenceManifest}\n                 ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n                 ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n-                nonce={ctx.nonce}\n+                nonce={nonce}\n               />,\n               {\n                 signal: finalClientController.signal,\n@@ -3151,13 +3186,13 @@ async function prerenderToStream(\n                 clientReferenceManifest={clientReferenceManifest}\n                 ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n                 ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n-                nonce={ctx.nonce}\n+                nonce={nonce}\n               />,\n               JSON.parse(JSON.stringify(postponed)),\n               {\n                 signal: createPostponedAbortSignal('static prerender resume'),\n                 onError: htmlRendererErrorHandler,\n-                nonce: ctx.nonce,\n+                nonce,\n               }\n             )\n \n@@ -3171,7 +3206,7 @@ async function prerenderToStream(\n             stream: await continueStaticPrerender(htmlStream, {\n               inlinedDataStream: createInlinedDataReadableStream(\n                 reactServerResult.consumeAsStream(),\n-                ctx.nonce,\n+                nonce,\n                 formState\n               ),\n               getServerInsertedHTML,\n@@ -3242,6 +3277,7 @@ async function prerenderToStream(\n           stale: INFINITE_CACHE,\n           tags: [...implicitTags.tags],\n           prerenderResumeDataCache,\n+          hmrRefreshHash: undefined,\n         })\n \n         const initialClientController = new AbortController()\n@@ -3259,6 +3295,7 @@ async function prerenderToStream(\n           stale: INFINITE_CACHE,\n           tags: [...implicitTags.tags],\n           prerenderResumeDataCache,\n+          hmrRefreshHash: undefined,\n         })\n \n         // We're not going to use the result of this render because the only time it could be used\n@@ -3340,7 +3377,7 @@ async function prerenderToStream(\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n-              nonce={ctx.nonce}\n+              nonce={nonce}\n             />,\n             {\n               signal: initialClientController.signal,\n@@ -3412,6 +3449,7 @@ async function prerenderToStream(\n           stale: INFINITE_CACHE,\n           tags: [...implicitTags.tags],\n           prerenderResumeDataCache,\n+          hmrRefreshHash: undefined,\n         })\n \n         let clientIsDynamic = false\n@@ -3436,6 +3474,7 @@ async function prerenderToStream(\n           stale: INFINITE_CACHE,\n           tags: [...implicitTags.tags],\n           prerenderResumeDataCache,\n+          hmrRefreshHash: undefined,\n         })\n \n         const finalServerPayload = await workUnitAsyncStorage.run(\n@@ -3493,7 +3532,7 @@ async function prerenderToStream(\n                   ServerInsertedMetadataProvider={\n                     ServerInsertedMetadataProvider\n                   }\n-                  nonce={ctx.nonce}\n+                  nonce={nonce}\n                 />,\n                 {\n                   signal: finalClientController.signal,\n@@ -3590,7 +3629,7 @@ async function prerenderToStream(\n           stream: await continueFizzStream(htmlStream!, {\n             inlinedDataStream: createInlinedDataReadableStream(\n               serverPrerenderStreamResult.asStream(),\n-              ctx.nonce,\n+              nonce,\n               formState\n             ),\n             isStaticGeneration: true,\n@@ -3672,7 +3711,7 @@ async function prerenderToStream(\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n           ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n-          nonce={ctx.nonce}\n+          nonce={nonce}\n         />,\n         {\n           onError: htmlRendererErrorHandler,\n@@ -3804,13 +3843,13 @@ async function prerenderToStream(\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n-              nonce={ctx.nonce}\n+              nonce={nonce}\n             />,\n             JSON.parse(JSON.stringify(postponed)),\n             {\n               signal: createPostponedAbortSignal('static prerender resume'),\n               onError: htmlRendererErrorHandler,\n-              nonce: ctx.nonce,\n+              nonce,\n             }\n           )\n \n@@ -3824,7 +3863,7 @@ async function prerenderToStream(\n           stream: await continueStaticPrerender(htmlStream, {\n             inlinedDataStream: createInlinedDataReadableStream(\n               reactServerResult.consumeAsStream(),\n-              ctx.nonce,\n+              nonce,\n               formState\n             ),\n             getServerInsertedHTML,\n@@ -3883,11 +3922,11 @@ async function prerenderToStream(\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n           ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n-          nonce={ctx.nonce}\n+          nonce={nonce}\n         />,\n         {\n           onError: htmlRendererErrorHandler,\n-          nonce: ctx.nonce,\n+          nonce,\n           bootstrapScripts: [bootstrapScript],\n         }\n       )\n@@ -3917,7 +3956,7 @@ async function prerenderToStream(\n         stream: await continueFizzStream(htmlStream, {\n           inlinedDataStream: createInlinedDataReadableStream(\n             reactServerResult.consumeAsStream(),\n-            ctx.nonce,\n+            nonce,\n             formState\n           ),\n           isStaticGeneration: true,\n@@ -3958,7 +3997,7 @@ async function prerenderToStream(\n     if (shouldBailoutToCSR) {\n       const stack = getStackWithoutErrorMessage(err)\n       error(\n-        `${err.reason} should be wrapped in a suspense boundary at page \"${ctx.pagePath}\". Read more: https://nextjs.org/docs/messages/missing-suspense-with-csr-bailout\\n${stack}`\n+        `${err.reason} should be wrapped in a suspense boundary at page \"${pagePath}\". Read more: https://nextjs.org/docs/messages/missing-suspense-with-csr-bailout\\n${stack}`\n       )\n \n       throw err\n@@ -3991,11 +4030,11 @@ async function prerenderToStream(\n \n     const [errorPreinitScripts, errorBootstrapScript] = getRequiredScripts(\n       renderOpts.buildManifest,\n-      ctx.assetPrefix,\n+      assetPrefix,\n       renderOpts.crossOrigin,\n       renderOpts.subresourceIntegrityManifest,\n       getAssetQueryString(ctx, false),\n-      ctx.nonce,\n+      nonce,\n       '/_not-found/page'\n     )\n \n@@ -4047,11 +4086,11 @@ async function prerenderToStream(\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             preinitScripts={errorPreinitScripts}\n             clientReferenceManifest={clientReferenceManifest}\n-            nonce={ctx.nonce}\n+            nonce={nonce}\n           />\n         ),\n         streamOptions: {\n-          nonce: ctx.nonce,\n+          nonce,\n           // Include hydration scripts in the HTML\n           bootstrapScripts: [errorBootstrapScript],\n           formState,\n@@ -4089,7 +4128,7 @@ async function prerenderToStream(\n         stream: await continueFizzStream(fizzStream, {\n           inlinedDataStream: createInlinedDataReadableStream(\n             flightStream,\n-            ctx.nonce,\n+            nonce,\n             formState\n           ),\n           isStaticGeneration: true,"
        },
        {
            "sha": "b89633c971a583a5afadb021e90bfe380430cbe3",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 5,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -16,13 +16,14 @@ import type {\n import type { Params } from '../request/params'\n import type { ImplicitTags } from '../lib/implicit-tags'\n import type { WorkStore } from './work-async-storage.external'\n+import { NEXT_HMR_REFRESH_HASH_COOKIE } from '../../client/components/app-router-headers'\n \n export type WorkUnitPhase = 'action' | 'render' | 'after'\n \n export interface CommonWorkUnitStore {\n   /** NOTE: Will be mutated as phases change */\n   phase: WorkUnitPhase\n-  readonly implicitTags: ImplicitTags | undefined\n+  readonly implicitTags: ImplicitTags\n }\n \n export interface RequestStore extends CommonWorkUnitStore {\n@@ -121,6 +122,13 @@ export interface PrerenderStoreModern extends CommonWorkUnitStore {\n   // not part of the primary render path and are just prerendering to produce\n   // validation results\n   validating?: boolean\n+\n+  /**\n+   * The HMR refresh hash is only provided in dev mode. It is needed for the dev\n+   * warmup render to ensure that the cache keys will be identical for the\n+   * subsequent dynamic render.\n+   */\n+  readonly hmrRefreshHash: string | undefined\n }\n \n export interface PrerenderStorePPR extends CommonWorkUnitStore {\n@@ -154,7 +162,16 @@ export type PrerenderStore =\n   | PrerenderStorePPR\n   | PrerenderStoreModern\n \n-export interface UseCacheStore extends CommonWorkUnitStore {\n+export interface CommonCacheStore\n+  extends Omit<CommonWorkUnitStore, 'implicitTags'> {\n+  /**\n+   * A cache work unit store might not always have an outer work unit store,\n+   * from which implicit tags could be inherited.\n+   */\n+  readonly implicitTags: ImplicitTags | undefined\n+}\n+\n+export interface UseCacheStore extends CommonCacheStore {\n   type: 'cache'\n   // Collected revalidate times and tags for this cache entry during the cache render.\n   revalidate: number // implicit revalidate time from inner caches / fetches\n@@ -173,7 +190,7 @@ export interface UseCacheStore extends CommonWorkUnitStore {\n   readonly draftMode: DraftModeProvider | undefined\n }\n \n-export interface UnstableCacheStore extends CommonWorkUnitStore {\n+export interface UnstableCacheStore extends CommonCacheStore {\n   type: 'unstable-cache'\n   // Draft mode is only available if the outer work unit store is a request\n   // store and draft mode is enabled.\n@@ -276,10 +293,10 @@ export function getHmrRefreshHash(\n     return undefined\n   }\n \n-  return workUnitStore.type === 'cache'\n+  return workUnitStore.type === 'cache' || workUnitStore.type === 'prerender'\n     ? workUnitStore.hmrRefreshHash\n     : workUnitStore.type === 'request'\n-      ? workUnitStore.cookies.get('__next_hmr_refresh_hash__')?.value\n+      ? workUnitStore.cookies.get(NEXT_HMR_REFRESH_HASH_COOKIE)?.value\n       : undefined\n }\n "
        },
        {
            "sha": "89558398a70056f1ff9f61dddae40ce94050a139",
            "filename": "packages/next/src/server/async-storage/request-store.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -68,7 +68,7 @@ type RequestContext = RequestResponsePair & {\n   renderOpts?: WrapperRenderOpts\n   isHmrRefresh?: boolean\n   serverComponentsHmrCache?: ServerComponentsHmrCache\n-  implicitTags: ImplicitTags | undefined\n+  implicitTags: ImplicitTags\n }\n \n type RequestResponsePair ="
        },
        {
            "sha": "1b691f7620ba9026c51ed8c2c25d69693ce291fd",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -393,6 +393,7 @@ export class AppRouteRouteModule extends RouteModule<\n               stale: INFINITE_CACHE,\n               tags: [...implicitTags.tags],\n               prerenderResumeDataCache: null,\n+              hmrRefreshHash: undefined,\n             })\n \n           let prospectiveResult\n@@ -478,6 +479,7 @@ export class AppRouteRouteModule extends RouteModule<\n             stale: INFINITE_CACHE,\n             tags: [...implicitTags.tags],\n             prerenderResumeDataCache: null,\n+            hmrRefreshHash: undefined,\n           })\n \n           let responseHandled = false"
        },
        {
            "sha": "79b18811a7c775958ce80acc9c339b74c7fecb57",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 3,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -33,6 +33,7 @@ import { MiddlewareSpan } from '../lib/trace/constants'\n import { CloseController } from './web-on-close'\n import { getEdgePreviewProps } from './get-edge-preview-props'\n import { getBuiltinRequestContext } from '../after/builtin-request-context'\n+import { getImplicitTags } from '../lib/implicit-tags'\n \n export class NextRequestHint extends NextRequest {\n   sourcePage: string\n@@ -251,18 +252,26 @@ export async function adapter(\n               cookiesFromResponse = cookies\n             }\n             const previewProps = getEdgePreviewProps()\n+            const page = '/' // Fake Work\n+            const fallbackRouteParams = null\n+\n+            const implicitTags = await getImplicitTags(\n+              page,\n+              request.nextUrl,\n+              fallbackRouteParams\n+            )\n \n             const requestStore = createRequestStoreForAPI(\n               request,\n               request.nextUrl,\n-              undefined,\n+              implicitTags,\n               onUpdateCookies,\n               previewProps\n             )\n \n             const workStore = createWorkStore({\n-              page: '/', // Fake Work\n-              fallbackRouteParams: null,\n+              page,\n+              fallbackRouteParams,\n               renderOpts: {\n                 cacheLifeProfiles:\n                   params.request.nextConfig?.experimental?.cacheLife,"
        },
        {
            "sha": "a57d115b0678ddc5384487800094deaf6d4945c2",
            "filename": "test/development/app-dir/dynamic-io-dev-warmup/app/revalidate/route.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-warmup%2Fapp%2Frevalidate%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-warmup%2Fapp%2Frevalidate%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-warmup%2Fapp%2Frevalidate%2Froute.ts?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -0,0 +1,7 @@\n+import { revalidatePath } from 'next/cache'\n+\n+export async function GET() {\n+  revalidatePath('/')\n+\n+  return Response.json({ revalidated: true })\n+}"
        },
        {
            "sha": "f881ef2fa536150f49b1d61f081d4f2edbf2f7ca",
            "filename": "test/development/app-dir/dynamic-io-dev-warmup/dynamic-io.dev-warmup.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 6,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/ce5206fa1353d11225df986a0d14afb7b6b91c84/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-warmup%2Fdynamic-io.dev-warmup.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ce5206fa1353d11225df986a0d14afb7b6b91c84/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-warmup%2Fdynamic-io.dev-warmup.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-warmup%2Fdynamic-io.dev-warmup.test.ts?ref=ce5206fa1353d11225df986a0d14afb7b6b91c84",
            "patch": "@@ -21,13 +21,21 @@ describe('dynamic-io-dev-warmup', () => {\n \n   it('logs with Prerender or Server environment depending based on whether the timing of when the log runs relative to this environment boundary', async () => {\n     let browser = await next.browser('/')\n-    // At the moment this second render is required for the logs to resolves in the expected environment\n-    // This doesn't reproduce locally but I suspect some kind of lazy initialization during dev that leads the initial render\n-    // to not resolve in a microtask on the first render.\n-    await browser.close()\n-    browser = await next.browser('/')\n+    let logs = await browser.log()\n+\n+    assertLog(logs, 'after layout cache read', 'Prerender')\n+    assertLog(logs, 'after page cache read', 'Prerender')\n+    assertLog(logs, 'after cached layout fetch', 'Prerender')\n+    assertLog(logs, 'after cached page fetch', 'Prerender')\n+    assertLog(logs, 'after uncached layout fetch', 'Server')\n+    assertLog(logs, 'after uncached page fetch', 'Server')\n \n-    const logs = await browser.log()\n+    // After a revalidation the subsequent warmup render must discard stale\n+    // cache entries.\n+    await next.fetch('/revalidate')\n+\n+    browser = await next.browser('/')\n+    logs = await browser.log()\n \n     assertLog(logs, 'after layout cache read', 'Prerender')\n     assertLog(logs, 'after page cache read', 'Prerender')"
        }
    ],
    "stats": {
        "total": 216,
        "additions": 150,
        "deletions": 66
    }
}