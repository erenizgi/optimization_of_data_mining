{
    "author": "ztanner",
    "message": "Turbopack: ensure default layout is provided in default not-found entrypoint (#76912)\n\nWhen Turbopack creates the default not-found entry, it does so without\nproviding a default root layout in case one is missing. This works ok in\nWebpack since the `default-layout` is correctly added in\n[next-app-loader](https://github.com/vercel/next.js/blob/4518bc91641a0fd938664b781e12ae7c145f3396/packages/next/src/build/webpack/loaders/next-app-loader/index.ts#L339-L342).\n\nLooking at the [original\nPR](https://github.com/vercel/next.js/pull/54199) that added\n`default-layout` it seems it was only really ever intended for the\nnot-found entrypoint since in all other cases, a missing root layout\nmeans we create one for you in dev and in build it'd be a hard error.\n\nThis also includes the other defaults that are correctly added in other\nentries to match Webpack behavior. Though I'm not sure the presence of\nthese makes a difference when rendering the not found page\n\nCloses NDX-858",
    "sha": "56a6c86480693627632558452a76a90bc8d7413f",
    "files": [
        {
            "sha": "dd2ed86854fc22a954e79767e14f728dd9514b96",
            "filename": "crates/next-core/src/app_structure.rs",
            "status": "modified",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/56a6c86480693627632558452a76a90bc8d7413f/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56a6c86480693627632558452a76a90bc8d7413f/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs?ref=56a6c86480693627632558452a76a90bc8d7413f",
            "patch": "@@ -1245,6 +1245,43 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n             );\n         }\n \n+        let mut modules = directory_tree.modules.clone();\n+\n+        // fill in the default modules for the not-found entrypoint\n+        if modules.layout.is_none() {\n+            modules.layout = Some(\n+                get_next_package(*app_dir)\n+                    .join(\"dist/client/components/default-layout.js\".into())\n+                    .to_resolved()\n+                    .await?,\n+            );\n+        }\n+\n+        if modules.not_found.is_none() {\n+            modules.not_found = Some(\n+                get_next_package(*app_dir)\n+                    .join(\"dist/client/components/not-found-error.js\".into())\n+                    .to_resolved()\n+                    .await?,\n+            );\n+        }\n+        if modules.forbidden.is_none() {\n+            modules.forbidden = Some(\n+                get_next_package(*app_dir)\n+                    .join(\"dist/client/components/forbidden-error.js\".into())\n+                    .to_resolved()\n+                    .await?,\n+            );\n+        }\n+        if modules.unauthorized.is_none() {\n+            modules.unauthorized = Some(\n+                get_next_package(*app_dir)\n+                    .join(\"dist/client/components/unauthorized-error.js\".into())\n+                    .to_resolved()\n+                    .await?,\n+            );\n+        }\n+\n         // Next.js has this logic in \"collect-app-paths\", where the root not-found page\n         // is considered as its own entry point.\n         let not_found_tree = AppPageLoaderTree {"
        },
        {
            "sha": "ecbf15b4b8d46f554ff669abd5ca699a0fb0151e",
            "filename": "test/e2e/app-dir/app-root-params/simple.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/56a6c86480693627632558452a76a90bc8d7413f/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fsimple.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/56a6c86480693627632558452a76a90bc8d7413f/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fsimple.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-root-params%2Fsimple.test.ts?ref=56a6c86480693627632558452a76a90bc8d7413f",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { assertNoRedbox } from 'next-test-utils'\n import { join } from 'path'\n \n describe('app-root-params - simple', () => {\n@@ -17,6 +18,14 @@ describe('app-root-params - simple', () => {\n     expect($('#root-params').text()).toBe('{\"lang\":\"en\",\"locale\":\"us\"}')\n   })\n \n+  it('should render the not found page without errors', async () => {\n+    const browser = await next.browser('/')\n+    expect(await browser.elementByCss('h2').text()).toBe(\n+      'This page could not be found.'\n+    )\n+    await assertNoRedbox(browser)\n+  })\n+\n   // `next-types-plugin` currently only runs in Webpack.\n   // We skip deployment mode since we don't care about the deploy, we just want to\n   // check the file generated at build time."
        }
    ],
    "stats": {
        "total": 46,
        "additions": 46,
        "deletions": 0
    }
}