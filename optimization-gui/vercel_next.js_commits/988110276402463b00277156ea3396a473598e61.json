{
    "author": "timneutkens",
    "message": "Development: Only load getStaticInfoIncludingLayouts when it's needed (#83555)\n\n## What?\n\nMakes sure `build/entries` is not loaded in development (has transitive\nrequires that take some time)",
    "sha": "988110276402463b00277156ea3396a473598e61",
    "files": [
        {
            "sha": "3f60ae73c85fdea3000e56bdcf038bfafc84e9d6",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 113,
            "changes": 116,
            "blob_url": "https://github.com/vercel/next.js/blob/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=988110276402463b00277156ea3396a473598e61",
            "patch": "@@ -12,9 +12,8 @@ import type {\n import type { LoadedEnvFiles } from '@next/env'\n import type { AppLoaderOptions } from './webpack/loaders/next-app-loader'\n \n-import { posix, join, dirname, extname, normalize } from 'path'\n+import { posix, join, normalize } from 'path'\n import { stringify } from 'querystring'\n-import fs from 'fs'\n import {\n   PAGES_DIR_ALIAS,\n   ROOT_DIR_ALIAS,\n@@ -45,13 +44,8 @@ import {\n   isMiddlewareFilename,\n   isInstrumentationHookFile,\n   isInstrumentationHookFilename,\n-  reduceAppConfig,\n-  isAppBuiltinPage,\n } from './utils'\n-import {\n-  getAppPageStaticInfo,\n-  getPageStaticInfo,\n-} from './analysis/get-page-static-info'\n+import { getPageStaticInfo } from './analysis/get-page-static-info'\n import { normalizePathSep } from '../shared/lib/page-path/normalize-path-sep'\n import { normalizePagePath } from '../shared/lib/page-path/normalize-page-path'\n import type { ServerRuntime } from '../types'\n@@ -75,7 +69,6 @@ import { normalizeCatchAllRoutes } from './normalize-catchall-routes'\n import type { PageExtensions } from './page-extensions-type'\n import type { MappedPages } from './build-context'\n import { PAGE_TYPES } from '../lib/page-types'\n-import { isAppPageRoute } from '../lib/is-app-page-route'\n import { recursiveReadDir } from '../lib/recursive-readdir'\n import type { createValidFileMatcher } from '../server/lib/find-page-file'\n import { isReservedPage } from './utils'\n@@ -86,6 +79,7 @@ import {\n   UNDERSCORE_GLOBAL_ERROR_ROUTE,\n   UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY,\n } from '../shared/lib/entry-constants'\n+import { getStaticInfoIncludingLayouts } from './get-static-info-including-layouts'\n \n /**\n  * Collect app pages, layouts, and default files from the app directory\n@@ -401,110 +395,6 @@ export function processLayoutRoutes(\n   return layoutRoutes\n }\n \n-export function sortByPageExts(pageExtensions: PageExtensions) {\n-  return (a: string, b: string) => {\n-    // prioritize entries according to pageExtensions order\n-    // for consistency as fs order can differ across systems\n-    // NOTE: this is reversed so preferred comes last and\n-    // overrides prior\n-    const aExt = extname(a)\n-    const bExt = extname(b)\n-\n-    const aNoExt = a.substring(0, a.length - aExt.length)\n-    const bNoExt = a.substring(0, b.length - bExt.length)\n-\n-    if (aNoExt !== bNoExt) return 0\n-\n-    // find extension index (skip '.' as pageExtensions doesn't have it)\n-    const aExtIndex = pageExtensions.indexOf(aExt.substring(1))\n-    const bExtIndex = pageExtensions.indexOf(bExt.substring(1))\n-\n-    return bExtIndex - aExtIndex\n-  }\n-}\n-\n-export async function getStaticInfoIncludingLayouts({\n-  isInsideAppDir,\n-  pageExtensions,\n-  pageFilePath,\n-  appDir,\n-  config: nextConfig,\n-  isDev,\n-  page,\n-}: {\n-  isInsideAppDir: boolean\n-  pageExtensions: PageExtensions\n-  pageFilePath: string\n-  appDir: string | undefined\n-  config: NextConfigComplete\n-  isDev: boolean | undefined\n-  page: string\n-}): Promise<PageStaticInfo> {\n-  // TODO: sync types for pages: PAGE_TYPES, ROUTER_TYPE, 'app' | 'pages', etc.\n-  const pageType = isInsideAppDir ? PAGE_TYPES.APP : PAGE_TYPES.PAGES\n-\n-  const pageStaticInfo = await getPageStaticInfo({\n-    nextConfig,\n-    pageFilePath,\n-    isDev,\n-    page,\n-    pageType,\n-  })\n-\n-  if (pageStaticInfo.type === PAGE_TYPES.PAGES || !appDir) {\n-    return pageStaticInfo\n-  }\n-\n-  // Skip inheritance for global-error pages - always use default config\n-  if (page === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY) {\n-    return pageStaticInfo\n-  }\n-\n-  const segments = [pageStaticInfo]\n-\n-  // inherit from layout files only if it's a page route and not a builtin page\n-  if (isAppPageRoute(page) && !isAppBuiltinPage(pageFilePath)) {\n-    const layoutFiles = []\n-    const potentialLayoutFiles = pageExtensions.map((ext) => 'layout.' + ext)\n-    let dir = dirname(pageFilePath)\n-\n-    // Uses startsWith to not include directories further up.\n-    while (dir.startsWith(appDir)) {\n-      for (const potentialLayoutFile of potentialLayoutFiles) {\n-        const layoutFile = join(dir, potentialLayoutFile)\n-        if (!fs.existsSync(layoutFile)) {\n-          continue\n-        }\n-        layoutFiles.push(layoutFile)\n-      }\n-      // Walk up the directory tree\n-      dir = join(dir, '..')\n-    }\n-\n-    for (const layoutFile of layoutFiles) {\n-      const layoutStaticInfo = await getAppPageStaticInfo({\n-        nextConfig,\n-        pageFilePath: layoutFile,\n-        isDev,\n-        page,\n-        pageType: isInsideAppDir ? PAGE_TYPES.APP : PAGE_TYPES.PAGES,\n-      })\n-\n-      segments.unshift(layoutStaticInfo)\n-    }\n-  }\n-\n-  const config = reduceAppConfig(segments)\n-\n-  return {\n-    ...pageStaticInfo,\n-    config,\n-    runtime: config.runtime,\n-    preferredRegion: config.preferredRegion,\n-    maxDuration: config.maxDuration,\n-  }\n-}\n-\n type ObjectValue<T> = T extends { [key: string]: infer V } ? V : never\n \n /**"
        },
        {
            "sha": "cf04c5537493189035dd1f951f016ea7aabc9ad1",
            "filename": "packages/next/src/build/get-static-info-including-layouts.ts",
            "status": "added",
            "additions": 98,
            "deletions": 0,
            "changes": 98,
            "blob_url": "https://github.com/vercel/next.js/blob/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fbuild%2Fget-static-info-including-layouts.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fbuild%2Fget-static-info-including-layouts.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fget-static-info-including-layouts.ts?ref=988110276402463b00277156ea3396a473598e61",
            "patch": "@@ -0,0 +1,98 @@\n+import type { NextConfigComplete } from '../server/config-shared'\n+import type { PageStaticInfo } from './analysis/get-page-static-info'\n+import { join, dirname } from 'path'\n+import fs from 'fs'\n+import type { __ApiPreviewProps } from '../server/api-utils'\n+import { reduceAppConfig, isAppBuiltinPage } from './utils'\n+import {\n+  getAppPageStaticInfo,\n+  getPageStaticInfo,\n+} from './analysis/get-page-static-info'\n+import type { PageExtensions } from './page-extensions-type'\n+\n+import { PAGE_TYPES } from '../lib/page-types'\n+import { isAppPageRoute } from '../lib/is-app-page-route'\n+\n+import { UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY } from '../shared/lib/entry-constants'\n+\n+export async function getStaticInfoIncludingLayouts({\n+  isInsideAppDir,\n+  pageExtensions,\n+  pageFilePath,\n+  appDir,\n+  config: nextConfig,\n+  isDev,\n+  page,\n+}: {\n+  isInsideAppDir: boolean\n+  pageExtensions: PageExtensions\n+  pageFilePath: string\n+  appDir: string | undefined\n+  config: NextConfigComplete\n+  isDev: boolean | undefined\n+  page: string\n+}): Promise<PageStaticInfo> {\n+  // TODO: sync types for pages: PAGE_TYPES, ROUTER_TYPE, 'app' | 'pages', etc.\n+  const pageType = isInsideAppDir ? PAGE_TYPES.APP : PAGE_TYPES.PAGES\n+\n+  const pageStaticInfo = await getPageStaticInfo({\n+    nextConfig,\n+    pageFilePath,\n+    isDev,\n+    page,\n+    pageType,\n+  })\n+\n+  if (pageStaticInfo.type === PAGE_TYPES.PAGES || !appDir) {\n+    return pageStaticInfo\n+  }\n+\n+  // Skip inheritance for global-error pages - always use default config\n+  if (page === UNDERSCORE_GLOBAL_ERROR_ROUTE_ENTRY) {\n+    return pageStaticInfo\n+  }\n+\n+  const segments = [pageStaticInfo]\n+\n+  // inherit from layout files only if it's a page route and not a builtin page\n+  if (isAppPageRoute(page) && !isAppBuiltinPage(pageFilePath)) {\n+    const layoutFiles = []\n+    const potentialLayoutFiles = pageExtensions.map((ext) => 'layout.' + ext)\n+    let dir = dirname(pageFilePath)\n+\n+    // Uses startsWith to not include directories further up.\n+    while (dir.startsWith(appDir)) {\n+      for (const potentialLayoutFile of potentialLayoutFiles) {\n+        const layoutFile = join(dir, potentialLayoutFile)\n+        if (!fs.existsSync(layoutFile)) {\n+          continue\n+        }\n+        layoutFiles.push(layoutFile)\n+      }\n+      // Walk up the directory tree\n+      dir = join(dir, '..')\n+    }\n+\n+    for (const layoutFile of layoutFiles) {\n+      const layoutStaticInfo = await getAppPageStaticInfo({\n+        nextConfig,\n+        pageFilePath: layoutFile,\n+        isDev,\n+        page,\n+        pageType: isInsideAppDir ? PAGE_TYPES.APP : PAGE_TYPES.PAGES,\n+      })\n+\n+      segments.unshift(layoutStaticInfo)\n+    }\n+  }\n+\n+  const config = reduceAppConfig(segments)\n+\n+  return {\n+    ...pageStaticInfo,\n+    config,\n+    runtime: config.runtime,\n+    preferredRegion: config.preferredRegion,\n+    maxDuration: config.maxDuration,\n+  }\n+}"
        },
        {
            "sha": "3331ddee994ce7e5f53c4a78c4b562d540e572b1",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=988110276402463b00277156ea3396a473598e61",
            "patch": "@@ -112,8 +112,6 @@ import { Telemetry } from '../telemetry/storage'\n import {\n   createPagesMapping,\n   collectAppFiles,\n-  getStaticInfoIncludingLayouts,\n-  sortByPageExts,\n   processPageRoutes,\n   processAppRoutes,\n   processLayoutRoutes,\n@@ -124,6 +122,8 @@ import {\n   type SlotInfo,\n   collectPagesFiles,\n } from './entries'\n+import { sortByPageExts } from './sort-by-page-exts'\n+import { getStaticInfoIncludingLayouts } from './get-static-info-including-layouts'\n import { PAGE_TYPES } from '../lib/page-types'\n import { generateBuildId } from './generate-build-id'\n import { isWriteable } from './is-writeable'"
        },
        {
            "sha": "05745c8a191e449b82f69b19ea8dadc8149417fb",
            "filename": "packages/next/src/build/sort-by-page-exts.ts",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fbuild%2Fsort-by-page-exts.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fbuild%2Fsort-by-page-exts.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fsort-by-page-exts.ts?ref=988110276402463b00277156ea3396a473598e61",
            "patch": "@@ -0,0 +1,24 @@\n+import { extname } from 'path/posix'\n+import type { PageExtensions } from './page-extensions-type'\n+\n+export function sortByPageExts(pageExtensions: PageExtensions) {\n+  return (a: string, b: string) => {\n+    // prioritize entries according to pageExtensions order\n+    // for consistency as fs order can differ across systems\n+    // NOTE: this is reversed so preferred comes last and\n+    // overrides prior\n+    const aExt = extname(a)\n+    const bExt = extname(b)\n+\n+    const aNoExt = a.substring(0, a.length - aExt.length)\n+    const bNoExt = a.substring(0, b.length - bExt.length)\n+\n+    if (aNoExt !== bNoExt) return 0\n+\n+    // find extension index (skip '.' as pageExtensions doesn't have it)\n+    const aExtIndex = pageExtensions.indexOf(aExt.substring(1))\n+    const bExtIndex = pageExtensions.indexOf(bExt.substring(1))\n+\n+    return bExtIndex - aExtIndex\n+  }\n+}"
        },
        {
            "sha": "0706fd763a70443bd55bca837ee83fa5add5503f",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=988110276402463b00277156ea3396a473598e61",
            "patch": "@@ -21,9 +21,9 @@ import {\n   getEdgeServerEntry,\n   getAppEntry,\n   runDependingOnPageType,\n-  getStaticInfoIncludingLayouts,\n   getInstrumentationEntry,\n } from '../../build/entries'\n+import { getStaticInfoIncludingLayouts } from '../../build/get-static-info-including-layouts'\n import { watchCompilers } from '../../build/output'\n import * as Log from '../../build/output/log'\n import getBaseWebpackConfig, {"
        },
        {
            "sha": "f5fc68257e8307758ab00bb4b52b1eac530364f5",
            "filename": "packages/next/src/server/dev/on-demand-entry-handler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts?ref=988110276402463b00277156ea3396a473598e61",
            "patch": "@@ -13,10 +13,8 @@ import type HotReloaderWebpack from './hot-reloader-webpack'\n import createDebug from 'next/dist/compiled/debug'\n import { EventEmitter } from 'events'\n import { findPageFile } from '../lib/find-page-file'\n-import {\n-  getStaticInfoIncludingLayouts,\n-  runDependingOnPageType,\n-} from '../../build/entries'\n+import { runDependingOnPageType } from '../../build/entries'\n+import { getStaticInfoIncludingLayouts } from '../../build/get-static-info-including-layouts'\n import { join, posix } from 'path'\n import { normalizePathSep } from '../../shared/lib/page-path/normalize-path-sep'\n import { normalizePagePath } from '../../shared/lib/page-path/normalize-page-path'"
        },
        {
            "sha": "7e1e37eb3e4d65d43c98d9ab78ed1db2441808bd",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/988110276402463b00277156ea3396a473598e61/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=988110276402463b00277156ea3396a473598e61",
            "patch": "@@ -1,10 +1,7 @@\n import type { NextConfigComplete } from '../../config-shared'\n import type { FilesystemDynamicRoute } from './filesystem'\n import type { UnwrapPromise } from '../../../lib/coalesced-function'\n-import {\n-  getPageStaticInfo,\n-  type MiddlewareMatcher,\n-} from '../../../build/analysis/get-page-static-info'\n+import type { MiddlewareMatcher } from '../../../build/analysis/get-page-static-info'\n import type { RoutesManifest } from '../../../build'\n import type { MiddlewareRouteMatch } from '../../../shared/lib/router/utils/middleware-route-matcher'\n import type { PropagateToWorkersField } from './types'\n@@ -31,10 +28,7 @@ import {\n   eventCliSession,\n } from '../../../telemetry/events'\n import { getSortedRoutes } from '../../../shared/lib/router/utils'\n-import {\n-  getStaticInfoIncludingLayouts,\n-  sortByPageExts,\n-} from '../../../build/entries'\n+import { sortByPageExts } from '../../../build/sort-by-page-exts'\n import { verifyTypeScriptSetup } from '../../../lib/verify-typescript-setup'\n import { verifyPartytownSetup } from '../../../lib/verify-partytown-setup'\n import { getNamedRouteRegex } from '../../../shared/lib/router/utils/route-regex'\n@@ -438,6 +432,9 @@ async function startWatcher(\n         })\n \n         if (isMiddlewareFile(rootFile)) {\n+          const getStaticInfoIncludingLayouts = (\n+            require('../../../build/get-static-info-including-layouts') as typeof import('../../../build/get-static-info-including-layouts')\n+          ).getStaticInfoIncludingLayouts\n           const staticInfo = await getStaticInfoIncludingLayouts({\n             pageFilePath: fileName,\n             config: nextConfig,\n@@ -501,6 +498,9 @@ async function startWatcher(\n             true\n           )\n         ) {\n+          const getPageStaticInfo = (\n+            require('../../../build/analysis/get-page-static-info') as typeof import('../../../build/analysis/get-page-static-info')\n+          ).getPageStaticInfo\n           const staticInfo = await getPageStaticInfo({\n             pageFilePath: fileName,\n             nextConfig: {},"
        }
    ],
    "stats": {
        "total": 266,
        "additions": 138,
        "deletions": 128
    }
}