{
    "author": "eps1lon",
    "message": "[test] Current behavior of dynamic APIs integration with React DevTools (#85111)",
    "sha": "2346cfd67d8d25d32c79fc2efc318344aee36308",
    "files": [
        {
            "sha": "404651bc3e1a691cef093bec0b445fa9ca4c2ef7",
            "filename": "test/development/app-dir/react-performance-track/app/cookies/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fcookies%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fcookies%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fcookies%2Fpage.tsx?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -0,0 +1,7 @@\n+import { cookies } from 'next/headers'\n+\n+export default async function CookiesPage() {\n+  await cookies()\n+\n+  return <p>Done cookies</p>\n+}"
        },
        {
            "sha": "01510b00fceca235b08a9338396c2593e82faba5",
            "filename": "test/development/app-dir/react-performance-track/app/draftMode/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FdraftMode%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FdraftMode%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2FdraftMode%2Fpage.tsx?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -0,0 +1,7 @@\n+import { draftMode } from 'next/headers'\n+\n+export default async function DraftModePage() {\n+  await draftMode()\n+\n+  return <p>Done draftMode</p>\n+}"
        },
        {
            "sha": "d23c9d38c8a47d70bcdefd8229cdfc14913237d2",
            "filename": "test/development/app-dir/react-performance-track/app/headers/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fheaders%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fheaders%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fheaders%2Fpage.tsx?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -0,0 +1,7 @@\n+import { headers } from 'next/headers'\n+\n+export default async function HeadersPage() {\n+  await headers()\n+\n+  return <p>Done headers</p>\n+}"
        },
        {
            "sha": "8ca60d296d0770ae1f345ac9d27e71c4a2896cc3",
            "filename": "test/development/app-dir/react-performance-track/app/layout.tsx",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Flayout.tsx?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -16,13 +16,28 @@ export default function Root({ children }: { children: ReactNode }) {\n           <li>\n             <Link href=\"/set-timeout\">setTimeout</Link>\n           </li>\n+          <li>\n+            <Link href=\"/params/next\">params</Link>\n+          </li>\n+          <li>\n+            <Link href=\"/searchparams?slug=next\">searchParams</Link>\n+          </li>\n+          <li>\n+            <Link href=\"/headers\">headers</Link>\n+          </li>\n+          <li>\n+            <Link href=\"/cookies\">cookies</Link>\n+          </li>\n+          <li>\n+            <Link href=\"/draftMode\">draftMode</Link>\n+          </li>\n         </ul>\n         <main>\n-          <ReactServerRequests />\n           <Suspense fallback=\"Loading Server Requests\">\n             <div data-react-server-requests-done />\n             {children}\n           </Suspense>\n+          <ReactServerRequests />\n         </main>\n       </body>\n     </html>"
        },
        {
            "sha": "39b4c3870113378fbaffa7873fec93b9c03d40d0",
            "filename": "test/development/app-dir/react-performance-track/app/params/[slug]/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fparams%2F%5Bslug%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fparams%2F%5Bslug%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fparams%2F%5Bslug%5D%2Fpage.tsx?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -0,0 +1,9 @@\n+export default async function ParamsSlugPage({\n+  params,\n+}: {\n+  params: Promise<{ slug: string }>\n+}) {\n+  const { slug } = await params\n+\n+  return <p>Done {slug}</p>\n+}"
        },
        {
            "sha": "99e1753e385b7f513ab77d90d57f90b3b9ac0745",
            "filename": "test/development/app-dir/react-performance-track/app/searchparams/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fsearchparams%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fsearchparams%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fapp%2Fsearchparams%2Fpage.tsx?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -0,0 +1,7 @@\n+export default async function SearchParamsPage({\n+  searchParams,\n+}: {\n+  searchParams: Promise<Record<string, unknown>>\n+}) {\n+  return <p>Done {JSON.stringify(await searchParams)}</p>\n+}"
        },
        {
            "sha": "dc828ee75e2a23f83bb635d9d3a08e520e08c840",
            "filename": "test/development/app-dir/react-performance-track/instrumentation-client.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Finstrumentation-client.ts?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -55,16 +55,14 @@ window.reactServerRequests = {\n   },\n }\n \n-let registeredServerRequestsTrack = false\n-\n const originalConsoleTimeStamp = console.timeStamp\n console.timeStamp = (...args: any) => {\n   originalConsoleTimeStamp.apply(console, args)\n-  const [_entryName, startTime, endTime, track, name] = args\n+  const [name, startTime, endTime, track] = args\n \n   if (track === 'Server Requests ⚛') {\n-    // React will always call one console.timeStamp to register the track in Chrome's performance panel.\n-    if (registeredServerRequestsTrack) {\n+    const isRegisterTrackRequest = startTime === 0.001 && endTime === 0.001\n+    if (!isRegisterTrackRequest) {\n       reactServerRequests.push({\n         type: 'console',\n         name: name ?? '',\n@@ -76,7 +74,6 @@ console.timeStamp = (...args: any) => {\n         listener()\n       }\n     }\n-    registeredServerRequestsTrack = true\n   }\n }\n "
        },
        {
            "sha": "d02a1f770d6c0d850d45e0db770b1a89a3f9fa44",
            "filename": "test/development/app-dir/react-performance-track/next.config.js",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Fnext.config.js?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -2,8 +2,11 @@\n  * @type {import('next').NextConfig}\n  */\n const nextConfig = {\n-  // Some flag to enable react@experimental\n-  experimental: { taint: true },\n+  cacheComponents: true,\n+  experimental: {\n+    // Future but produces bad results.\n+    reactDebugChannel: false,\n+  },\n }\n \n module.exports = nextConfig"
        },
        {
            "sha": "460c706db1fddddee9997ab66815b20adc6575ee",
            "filename": "test/development/app-dir/react-performance-track/react-performance-track.test.ts",
            "status": "modified",
            "additions": 123,
            "deletions": 7,
            "changes": 130,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Freact-performance-track%2Freact-performance-track.test.ts?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -1,15 +1,20 @@\n import { nextTestSetup } from 'e2e-utils'\n \n-// Entries are flaky in CI. Without a name and without being able to repro locally,\n-// it's impossible to fix. Deactivating while we iterate on the track.\n-// It's still useful as a fixture.\n describe('react-performance-track', () => {\n+  // false is the default when visiting pages as an ordinary user.\n+  // true is the default when having Chrome DevTools open.\n+  // Hardcoded for now since most of the actual behavior is not intended.\n+  const disableCache = false\n+  const extraHTTPHeaders = disableCache\n+    ? { 'Cache-Control': 'no-cache' }\n+    : undefined\n+\n   const { next } = nextTestSetup({\n     files: __dirname,\n   })\n \n   it('should show setTimeout', async () => {\n-    const browser = await next.browser('/set-timeout')\n+    const browser = await next.browser('/set-timeout', { extraHTTPHeaders })\n     await browser.elementByCss('[data-react-server-requests-done]', {\n       state: 'attached',\n     })\n@@ -24,7 +29,7 @@ describe('react-performance-track', () => {\n   })\n \n   it('should show fetch', async () => {\n-    const browser = await next.browser('/fetch')\n+    const browser = await next.browser('/fetch', { extraHTTPHeaders })\n     await browser.elementByCss('[data-react-server-requests-done]', {\n       state: 'attached',\n     })\n@@ -35,13 +40,124 @@ describe('react-performance-track', () => {\n         {\n           // React might decide to display the shorthand in round brackets differently.\n           // Double check with React changes if a shorthand change is intended.\n-          name: '\\u200bfetch (…/random)',\n+          // TODO: Should include short name \"(…/random)\" and URL\n+          name: '\\u200bfetch',\n           properties: expect.arrayContaining([\n             ['status', '200'],\n-            ['url', '\"https://next-data-api-endpoint.vercel.app/api/random\"'],\n+            ['url', '\"\"'],\n           ]),\n         },\n       ])\n     )\n   })\n+\n+  it('should show params', async () => {\n+    const browser = await next.browser('/params/next', { extraHTTPHeaders })\n+    await browser.elementByCss('[data-react-server-requests-done]', {\n+      state: 'attached',\n+    })\n+\n+    const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n+    expect(track).toEqual(\n+      expect.arrayContaining([\n+        {\n+          name: '\\u200bparams [Prefetch]',\n+          properties: [],\n+        },\n+      ])\n+    )\n+  })\n+\n+  it('should show searchParams', async () => {\n+    const browser = await next.browser('/searchparams?slug=next', {\n+      extraHTTPHeaders,\n+    })\n+    await browser.elementByCss('[data-react-server-requests-done]', {\n+      state: 'attached',\n+    })\n+\n+    const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n+    expect(track).toEqual(\n+      expect.arrayContaining([\n+        {\n+          name: '\\u200bsearchParams [Prefetch]',\n+          properties: [],\n+        },\n+      ])\n+    )\n+  })\n+\n+  it('should show cookies', async () => {\n+    const browser = await next.browser('/cookies', { extraHTTPHeaders })\n+    await browser.elementByCss('[data-react-server-requests-done]', {\n+      state: 'attached',\n+    })\n+\n+    const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n+    expect(track).toEqual(\n+      expect.arrayContaining([\n+        {\n+          name: '\\u200bcookies [Prefetch]',\n+          properties: [],\n+        },\n+        // TODO: The error message makes this seem like it shouldn't pop up here.\n+        {\n+          name: '\\u200bcookies',\n+          properties: [\n+            [\n+              'rejected with',\n+              'During prerendering, `cookies()` rejects when the prerender is complete. ' +\n+                'Typically these errors are handled by React but if you move `cookies()` to a different context by using `setTimeout`, `after`, or similar functions you may observe this error and you should handle it in that context. ' +\n+                'This occurred at route \"/cookies\".',\n+            ],\n+          ],\n+        },\n+      ])\n+    )\n+  })\n+\n+  it('should show draftMode', async () => {\n+    const browser = await next.browser('/draftMode', { extraHTTPHeaders })\n+    await browser.elementByCss('[data-react-server-requests-done]', {\n+      state: 'attached',\n+    })\n+\n+    const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n+    // TODO: Should include \"draftMode [Prefetch]\".\n+    expect(track).toEqual([\n+      {\n+        name: '\\u200b',\n+        properties: [],\n+      },\n+    ])\n+  })\n+\n+  it('should show headers', async () => {\n+    const browser = await next.browser('/headers', { extraHTTPHeaders })\n+    await browser.elementByCss('[data-react-server-requests-done]', {\n+      state: 'attached',\n+    })\n+\n+    const track = await browser.eval('window.reactServerRequests.getSnapshot()')\n+    expect(track).toEqual(\n+      expect.arrayContaining([\n+        {\n+          name: '\\u200bheaders [Prefetch]',\n+          properties: [],\n+        },\n+        // TODO: The error message makes this seem like it shouldn't pop up here.\n+        {\n+          name: '\\u200bheaders',\n+          properties: [\n+            [\n+              'rejected with',\n+              'During prerendering, `headers()` rejects when the prerender is complete. ' +\n+                'Typically these errors are handled by React but if you move `headers()` to a different context by using `setTimeout`, `after`, or similar functions you may observe this error and you should handle it in that context. ' +\n+                'This occurred at route \"/headers\".',\n+            ],\n+          ],\n+        },\n+      ])\n+    )\n+  })\n })"
        },
        {
            "sha": "cef2b570ab7d25e8b08bbc9c20b71567ca6d355a",
            "filename": "test/lib/browsers/playwright.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fplaywright.ts?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -250,6 +250,10 @@ export class Playwright<TCurrent = undefined> {\n       cpuThrottleRate?: number\n       pushErrorAsConsoleLog?: boolean\n       beforePageLoad?: (page: Page) => void | Promise<void>\n+      /**\n+       * @see {@link https://playwright.dev/docs/api/class-page#page-set-extra-http-headers Playwright.Page.setExtraHTTPHeaders}\n+       */\n+      extraHTTPHeaders?: Record<string, string>\n       waitUntil?: PlaywrightNavigationWaitUntil\n     }\n   ) {\n@@ -265,6 +269,10 @@ export class Playwright<TCurrent = undefined> {\n \n     page.setDefaultTimeout(defaultTimeout)\n     page.setDefaultNavigationTimeout(defaultTimeout)\n+    const extraHTTPHeaders = opts?.extraHTTPHeaders\n+    if (extraHTTPHeaders !== undefined) {\n+      page.setExtraHTTPHeaders(extraHTTPHeaders)\n+    }\n \n     pageLogs = []\n     websocketFrames = []"
        },
        {
            "sha": "6e266c237d26cdae685e0e223ebca5012f5fbc19",
            "filename": "test/lib/next-webdriver.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Flib%2Fnext-webdriver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2346cfd67d8d25d32c79fc2efc318344aee36308/test%2Flib%2Fnext-webdriver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-webdriver.ts?ref=2346cfd67d8d25d32c79fc2efc318344aee36308",
            "patch": "@@ -70,6 +70,10 @@ export interface WebdriverOptions {\n    * @returns\n    */\n   beforePageLoad?: (page: Page) => void | Promise<void>\n+  /**\n+   * @see {@link https://playwright.dev/docs/api/class-page#page-set-extra-http-headers Playwright.Page.setExtraHTTPHeaders}\n+   */\n+  extraHTTPHeaders?: Record<string, string>\n   /**\n    * browser locale\n    */\n@@ -114,6 +118,7 @@ export default async function webdriver(\n     retryWaitHydration,\n     disableCache,\n     beforePageLoad,\n+    extraHTTPHeaders,\n     locale,\n     disableJavaScript,\n     ignoreHTTPSErrors,\n@@ -152,6 +157,7 @@ export default async function webdriver(\n     disableCache,\n     cpuThrottleRate,\n     beforePageLoad,\n+    extraHTTPHeaders,\n     pushErrorAsConsoleLog,\n     waitUntil,\n   })"
        }
    ],
    "stats": {
        "total": 214,
        "additions": 198,
        "deletions": 16
    }
}