{
    "author": "kdy1",
    "message": "perf(turbopack): Introduce runtime analysis for immutable tasks (#80422)\n\n### What?\r\n\r\nAfter the execution of a turbo task function, we can mark it as immutable if it does not have a way to invalidate itself. With the immutable flag, we optimize some overhead of turbo tasks by skipping activeness tracking.\r\n\r\n### Why?\r\n\r\n### How?",
    "sha": "ca72695f34b11e3ae9bd8573db177c9da5d5ff4d",
    "files": [
        {
            "sha": "5d3735f01100c1d2353a908e05ca69e5be724ac1",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 3,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/ca72695f34b11e3ae9bd8573db177c9da5d5ff4d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ca72695f34b11e3ae9bd8573db177c9da5d5ff4d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=ca72695f34b11e3ae9bd8573db177c9da5d5ff4d",
            "patch": "@@ -1671,6 +1671,12 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n \n         let has_children = !new_children.is_empty();\n \n+        // If the task is not stateful and has no children, it does not have a way to be invalidated\n+        // and we can mark it as immutable.\n+        if !stateful && !has_children {\n+            task.mark_as_immutable();\n+        }\n+\n         // Prepare all new children\n         if has_children {\n             prepare_new_children(task_id, &mut task, &new_children, &mut queue);\n@@ -1787,15 +1793,17 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n         let mut queue = AggregationUpdateQueue::new();\n \n         if has_children {\n-            let has_active_count = ctx.should_track_activeness()\n+            let is_immutable = task.is_immutable();\n+            let has_active_count = !is_immutable\n+                && ctx.should_track_activeness()\n                 && get!(task, Activeness).map_or(false, |activeness| activeness.active_counter > 0);\n             connect_children(\n                 task_id,\n                 &mut task,\n                 new_children,\n                 &mut queue,\n                 has_active_count,\n-                ctx.should_track_activeness(),\n+                !is_immutable && ctx.should_track_activeness(),\n             );\n         }\n \n@@ -2281,7 +2289,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n                     effective: u32::MAX,\n                 },\n             });\n-            if self.should_track_activeness() {\n+            if !task.state().is_immutable() && self.should_track_activeness() {\n                 task.add(CachedDataItem::Activeness {\n                     value: ActivenessState::new_root(root_type, task_id),\n                 });"
        },
        {
            "sha": "368e3809b64de956ab7519f1d4c04821381e4c1e",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/connect_child.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/ca72695f34b11e3ae9bd8573db177c9da5d5ff4d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_child.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ca72695f34b11e3ae9bd8573db177c9da5d5ff4d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_child.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fconnect_child.rs?ref=ca72695f34b11e3ae9bd8573db177c9da5d5ff4d",
            "patch": "@@ -31,6 +31,9 @@ impl ConnectChildOperation {\n     ) {\n         if !ctx.should_track_children() {\n             let mut task = ctx.task(child_task_id, TaskDataCategory::All);\n+            if is_immutable {\n+                task.mark_as_immutable();\n+            }\n             if !task.has_key(&CachedDataItemKey::Output {}) {\n                 let description = ctx.get_task_desc_fn(child_task_id);\n                 let should_schedule = task.add(CachedDataItem::new_scheduled(description));\n@@ -78,6 +81,10 @@ impl ConnectChildOperation {\n             });\n         } else {\n             let mut task = ctx.task(child_task_id, TaskDataCategory::All);\n+            if is_immutable {\n+                task.mark_as_immutable();\n+            }\n+\n             if !task.has_key(&CachedDataItemKey::Output {}) {\n                 let description = ctx.get_task_desc_fn(child_task_id);\n                 let should_schedule = task.add(CachedDataItem::new_scheduled(description));"
        },
        {
            "sha": "6be290be90d526ba91dfe35bfa9680cc65376982",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/mod.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/ca72695f34b11e3ae9bd8573db177c9da5d5ff4d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ca72695f34b11e3ae9bd8573db177c9da5d5ff4d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs?ref=ca72695f34b11e3ae9bd8573db177c9da5d5ff4d",
            "patch": "@@ -406,6 +406,8 @@ pub trait TaskGuard: Debug {\n     where\n         F: for<'a> FnMut(CachedDataItemKey, CachedDataItemValueRef<'a>) -> bool + 'l;\n     fn invalidate_serialization(&mut self);\n+    fn is_immutable(&self) -> bool;\n+    fn mark_as_immutable(&mut self);\n }\n \n struct TaskGuardImpl<'a, B: BackingStorage> {\n@@ -593,6 +595,13 @@ impl<B: BackingStorage> TaskGuard for TaskGuardImpl<'_, B> {\n             self.task.track_modification(SpecificTaskDataCategory::Meta);\n         }\n     }\n+\n+    fn is_immutable(&self) -> bool {\n+        self.task.state().is_immutable()\n+    }\n+    fn mark_as_immutable(&mut self) {\n+        self.task.state_mut().set_is_immutable(true);\n+    }\n }\n \n macro_rules! impl_operation {"
        },
        {
            "sha": "d91d6b8d45e60ad7bf6c6014c2424b0421b81424",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/storage.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/ca72695f34b11e3ae9bd8573db177c9da5d5ff4d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ca72695f34b11e3ae9bd8573db177c9da5d5ff4d/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs?ref=ca72695f34b11e3ae9bd8573db177c9da5d5ff4d",
            "patch": "@@ -98,6 +98,7 @@ bitfield! {\n     /// Item was modified after snapshot mode was entered. A snapshot was taken.\n     pub meta_snapshot, set_meta_snapshot: 4;\n     pub data_snapshot, set_data_snapshot: 5;\n+    pub is_immutable, set_is_immutable: 6;\n }\n \n impl InnerStorageState {"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 28,
        "deletions": 3
    }
}