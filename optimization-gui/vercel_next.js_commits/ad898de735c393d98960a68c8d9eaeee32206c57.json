{
    "author": "bgw",
    "message": "chore(turbo-tasks-backend): Fix build with `--features turbo-tasks-backend/lmdb` (#79530)\n\nThis had bit-rotted. Sounds like we do want to keep it around for sanity checking things from time-to-time.\n\nTested with:\n\n```\ncargo check --features turbo-tasks-backend/lmdb\n```",
    "sha": "ad898de735c393d98960a68c8d9eaeee32206c57",
    "files": [
        {
            "sha": "33b3cdb7737eb87b7d8c1c704fa41767a68f49b6",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/fresh_db_optimization.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/ad898de735c393d98960a68c8d9eaeee32206c57/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Ffresh_db_optimization.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ad898de735c393d98960a68c8d9eaeee32206c57/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Ffresh_db_optimization.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Ffresh_db_optimization.rs?ref=ad898de735c393d98960a68c8d9eaeee32206c57",
            "patch": "@@ -137,6 +137,10 @@ impl<'a, B: SerialWriteBatch<'a>> SerialWriteBatch<'a> for FreshDbOptimizationWr\n     fn delete(&mut self, key_space: KeySpace, key: WriteBuffer<'_>) -> Result<()> {\n         self.write_batch.delete(key_space, key)\n     }\n+\n+    fn flush(&mut self, key_space: KeySpace) -> Result<()> {\n+        self.write_batch.flush(key_space)\n+    }\n }\n \n impl<'a, B: ConcurrentWriteBatch<'a>> ConcurrentWriteBatch<'a>\n@@ -149,4 +153,8 @@ impl<'a, B: ConcurrentWriteBatch<'a>> ConcurrentWriteBatch<'a>\n     fn delete(&self, key_space: KeySpace, key: WriteBuffer<'_>) -> Result<()> {\n         self.write_batch.delete(key_space, key)\n     }\n+\n+    unsafe fn flush(&self, key_space: KeySpace) -> Result<()> {\n+        unsafe { self.write_batch.flush(key_space) }\n+    }\n }"
        },
        {
            "sha": "0b47c24d6c36bffe590af23d1ee0a8265d7ece64",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/lmdb/mod.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/ad898de735c393d98960a68c8d9eaeee32206c57/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Flmdb%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ad898de735c393d98960a68c8d9eaeee32206c57/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Flmdb%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Flmdb%2Fmod.rs?ref=ad898de735c393d98960a68c8d9eaeee32206c57",
            "patch": "@@ -189,4 +189,9 @@ impl<'a> SerialWriteBatch<'a> for LmbdWriteBatch<'a> {\n         )?;\n         Ok(())\n     }\n+\n+    fn flush(&mut self, _key_space: KeySpace) -> Result<()> {\n+        // this is an unimplemented optimization, this LMDB implemenation is only used in testing\n+        Ok(())\n+    }\n }"
        },
        {
            "sha": "62e7f1bd27831016e2a8682b0575465e92fe5cec",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/read_transaction_cache.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 24,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/ad898de735c393d98960a68c8d9eaeee32206c57/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fread_transaction_cache.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ad898de735c393d98960a68c8d9eaeee32206c57/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fread_transaction_cache.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fread_transaction_cache.rs?ref=ad898de735c393d98960a68c8d9eaeee32206c57",
            "patch": "@@ -6,7 +6,7 @@ use smallvec::SmallVec;\n use thread_local::ThreadLocal;\n \n use crate::database::{\n-    key_value_database::KeyValueDatabase,\n+    key_value_database::{KeySpace, KeyValueDatabase},\n     write_batch::{\n         BaseWriteBatch, ConcurrentWriteBatch, SerialWriteBatch, WriteBatch, WriteBuffer,\n     },\n@@ -88,7 +88,7 @@ impl<T: KeyValueDatabase + 'static> KeyValueDatabase for ReadTransactionCache<T>\n     fn get<'l, 'db: 'l>(\n         &'l self,\n         transaction: &'l Self::ReadTransaction<'db>,\n-        key_space: super::key_value_database::KeySpace,\n+        key_space: KeySpace,\n         key: &[u8],\n     ) -> anyhow::Result<Option<Self::ValueBuffer<'l>>> {\n         self.database\n@@ -168,11 +168,7 @@ impl<'a, T: KeyValueDatabase + 'static, B: BaseWriteBatch<'a>> BaseWriteBatch<'a\n         Self: 'l,\n         'a: 'l;\n \n-    fn get<'l>(\n-        &'l self,\n-        key_space: super::key_value_database::KeySpace,\n-        key: &[u8],\n-    ) -> Result<Option<Self::ValueBuffer<'l>>>\n+    fn get<'l>(&'l self, key_space: KeySpace, key: &[u8]) -> Result<Option<Self::ValueBuffer<'l>>>\n     where\n         'a: 'l,\n     {\n@@ -185,37 +181,32 @@ impl<'a, T: KeyValueDatabase, B: SerialWriteBatch<'a>> SerialWriteBatch<'a>\n {\n     fn put(\n         &mut self,\n-        key_space: super::key_value_database::KeySpace,\n+        key_space: KeySpace,\n         key: WriteBuffer<'_>,\n         value: WriteBuffer<'_>,\n     ) -> Result<()> {\n         self.write_batch.put(key_space, key, value)\n     }\n-    fn delete(\n-        &mut self,\n-        key_space: super::key_value_database::KeySpace,\n-        key: WriteBuffer<'_>,\n-    ) -> Result<()> {\n+    fn delete(&mut self, key_space: KeySpace, key: WriteBuffer<'_>) -> Result<()> {\n         self.write_batch.delete(key_space, key)\n     }\n+\n+    fn flush(&mut self, key_space: KeySpace) -> Result<()> {\n+        self.write_batch.flush(key_space)\n+    }\n }\n \n impl<'a, T: KeyValueDatabase, B: ConcurrentWriteBatch<'a>> ConcurrentWriteBatch<'a>\n     for ReadTransactionCacheWriteBatch<'a, T, B>\n {\n-    fn put(\n-        &self,\n-        key_space: super::key_value_database::KeySpace,\n-        key: WriteBuffer<'_>,\n-        value: WriteBuffer<'_>,\n-    ) -> Result<()> {\n+    fn put(&self, key_space: KeySpace, key: WriteBuffer<'_>, value: WriteBuffer<'_>) -> Result<()> {\n         self.write_batch.put(key_space, key, value)\n     }\n-    fn delete(\n-        &self,\n-        key_space: super::key_value_database::KeySpace,\n-        key: WriteBuffer<'_>,\n-    ) -> Result<()> {\n+    fn delete(&self, key_space: KeySpace, key: WriteBuffer<'_>) -> Result<()> {\n         self.write_batch.delete(key_space, key)\n     }\n+\n+    unsafe fn flush(&self, key_space: KeySpace) -> Result<()> {\n+        unsafe { self.write_batch.flush(key_space) }\n+    }\n }"
        },
        {
            "sha": "0f2b5338668b38fdaa824d9e711db2b61c0bdc4f",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/startup_cache.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/ad898de735c393d98960a68c8d9eaeee32206c57/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fstartup_cache.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ad898de735c393d98960a68c8d9eaeee32206c57/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fstartup_cache.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fstartup_cache.rs?ref=ad898de735c393d98960a68c8d9eaeee32206c57",
            "patch": "@@ -1,7 +1,6 @@\n use std::{\n     borrow::Borrow,\n     fs::{self, File},\n-    hash::BuildHasherDefault,\n     io::{BufWriter, Read, Write},\n     mem::transmute,\n     path::PathBuf,\n@@ -10,7 +9,7 @@ use std::{\n \n use anyhow::{Ok, Result};\n use byteorder::WriteBytesExt;\n-use rustc_hash::{FxHashMap, FxHasher};\n+use rustc_hash::FxHashMap;\n use turbo_tasks::FxDashMap;\n \n use crate::database::{\n@@ -290,6 +289,10 @@ impl<'a, B: SerialWriteBatch<'a>> SerialWriteBatch<'a> for StartupCacheWriteBatc\n         }\n         self.batch.delete(key_space, key)\n     }\n+\n+    fn flush(&mut self, key_space: KeySpace) -> Result<()> {\n+        self.batch.flush(key_space)\n+    }\n }\n \n impl<'a, B: ConcurrentWriteBatch<'a>> ConcurrentWriteBatch<'a> for StartupCacheWriteBatch<'a, B> {\n@@ -308,6 +311,10 @@ impl<'a, B: ConcurrentWriteBatch<'a>> ConcurrentWriteBatch<'a> for StartupCacheW\n         }\n         self.batch.delete(key_space, key)\n     }\n+\n+    unsafe fn flush(&self, key_space: KeySpace) -> Result<()> {\n+        unsafe { self.batch.flush(key_space) }\n+    }\n }\n \n fn write_key_value_pair("
        }
    ],
    "stats": {
        "total": 63,
        "additions": 37,
        "deletions": 26
    }
}