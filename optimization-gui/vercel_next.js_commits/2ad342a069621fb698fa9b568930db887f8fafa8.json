{
    "author": "devjiwonchoi",
    "message": "fix: use `turbopack.root` value for `outputFileTracingRoot` to have consistent tracing root (#82653)\n\nRegressed from https://github.com/vercel/next.js/pull/82164\n\nPreviously, `outputFileTracingRoot` was always set via `findRoot()` if\nthe option was not explicitly given. However,\nhttps://github.com/vercel/next.js/pull/82164 changed the behavior to run\n`findRoot()` only if neither `outputFileTracingRoot` nor\n`turbopack.root` was given.\n\nModified to:\n\n- When BOTH options are given, ensure they match, or else WARN and use\n`outputFileTracingRoot`.\n- When EITHER option is given, map the other value as the other.\n- When NONE is given, call `findDir()` and use its value.\n- After the processes above, if the root dir value is not assigned,\nthrow an error as a Next.js bug.\n\nFixes https://github.com/vercel/next.js/issues/82626",
    "sha": "2ad342a069621fb698fa9b568930db887f8fafa8",
    "files": [
        {
            "sha": "796b8a2f9ddffdf8c35135ee8e88d316abeda6d9",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2ad342a069621fb698fa9b568930db887f8fafa8/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2ad342a069621fb698fa9b568930db887f8fafa8/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=2ad342a069621fb698fa9b568930db887f8fafa8",
            "patch": "@@ -779,5 +779,6 @@\n   \"778\": \"`prerenderAndAbortInSequentialTasksWithStages` should not be called in edge runtime.\",\n   \"779\": \"Route %s used \\\"searchParams\\\" inside \\\"use cache\\\". Accessing dynamic request data inside a cache scope is not supported. If you need some search params inside a cached function await \\\"searchParams\\\" outside of the cached function and pass only the required search params as arguments to the cached function. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n   \"780\": \"Invariant: failed to find parent dynamic route for notFound route %s\",\n-  \"781\": \"No LRU node to remove\"\n+  \"781\": \"No LRU node to remove\",\n+  \"782\": \"Failed to find the root directory of the project. This is a bug in Next.js.\"\n }"
        },
        {
            "sha": "83f3db78a2e8e7ea60260de0931601b1b6c9a43f",
            "filename": "packages/next/src/lib/find-root.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2ad342a069621fb698fa9b568930db887f8fafa8/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ad342a069621fb698fa9b568930db887f8fafa8/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ffind-root.ts?ref=2ad342a069621fb698fa9b568930db887f8fafa8",
            "patch": "@@ -17,9 +17,9 @@ export function findRootLockFile(cwd: string) {\n   )\n }\n \n-export function findRootDir(cwd: string) {\n+export function findRootDir(cwd: string): string {\n   const lockFile = findRootLockFile(cwd)\n-  if (!lockFile) return undefined\n+  if (!lockFile) return cwd\n \n   const lockFiles = [lockFile]\n   while (true) {"
        },
        {
            "sha": "4a89570d2422d54cc4bfc9fa96265784f9a8df3b",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 9,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/2ad342a069621fb698fa9b568930db887f8fafa8/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ad342a069621fb698fa9b568930db887f8fafa8/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=2ad342a069621fb698fa9b568930db887f8fafa8",
            "patch": "@@ -746,20 +746,29 @@ function assignDefaults(\n     result.deploymentId = process.env.NEXT_DEPLOYMENT_ID\n   }\n \n-  if (result?.outputFileTracingRoot && !result?.turbopack?.root) {\n-    dset(result, ['turbopack', 'root'], result.outputFileTracingRoot)\n+  const tracingRoot = result?.outputFileTracingRoot\n+  const turbopackRoot = result?.turbopack?.root\n+\n+  // If both provided, validate they match. If not, use outputFileTracingRoot.\n+  if (tracingRoot && turbopackRoot && tracingRoot !== turbopackRoot) {\n+    Log.warn(\n+      `Both \\`outputFileTracingRoot\\` and \\`turbopack.root\\` are set, but they must have the same value.\\n` +\n+        `Using \\`outputFileTracingRoot\\` value: ${tracingRoot}.`\n+    )\n   }\n \n-  // use the highest level lockfile as tracing root\n-  if (!result?.outputFileTracingRoot && !result?.turbopack?.root) {\n-    let rootDir = findRootDir(dir)\n+  const rootDir = tracingRoot || turbopackRoot || findRootDir(dir)\n \n-    if (rootDir) {\n-      result.outputFileTracingRoot = rootDir\n-      dset(result, ['turbopack', 'root'], rootDir)\n-    }\n+  if (!rootDir) {\n+    throw new Error(\n+      'Failed to find the root directory of the project. This is a bug in Next.js.'\n+    )\n   }\n \n+  // Ensure both properties are set to the same value\n+  result.outputFileTracingRoot = rootDir\n+  dset(result, ['turbopack', 'root'], rootDir)\n+\n   setHttpClientAndAgentOptions(result || defaultConfig)\n \n   if (result.i18n) {"
        },
        {
            "sha": "1f274a0f9f2d8e1699999d29c1fa83411594c10d",
            "filename": "test/unit/isolated/config.test.ts",
            "status": "modified",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/2ad342a069621fb698fa9b568930db887f8fafa8/test%2Funit%2Fisolated%2Fconfig.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2ad342a069621fb698fa9b568930db887f8fafa8/test%2Funit%2Fisolated%2Fconfig.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fisolated%2Fconfig.test.ts?ref=2ad342a069621fb698fa9b568930db887f8fafa8",
            "patch": "@@ -117,4 +117,56 @@ describe('config', () => {\n     )\n     expect(config.__test__ext).toBe('ts')\n   })\n+\n+  describe('outputFileTracingRoot and turbopack.root consistency', () => {\n+    it('Should set both outputFileTracingRoot and turbopack.root to the same value when only outputFileTracingRoot is provided', async () => {\n+      const config = await loadConfig(PHASE_DEVELOPMENT_SERVER, '<rootDir>', {\n+        customConfig: {\n+          outputFileTracingRoot: '/custom/root',\n+        },\n+      })\n+      expect(config.outputFileTracingRoot).toBe('/custom/root')\n+      expect(config.turbopack.root).toBe('/custom/root')\n+    })\n+\n+    it('Should set both outputFileTracingRoot and turbopack.root to the same value when only turbopack.root is provided', async () => {\n+      const config = await loadConfig(PHASE_DEVELOPMENT_SERVER, '<rootDir>', {\n+        customConfig: {\n+          turbopack: { root: '/custom/root' },\n+        },\n+      })\n+      expect(config.outputFileTracingRoot).toBe('/custom/root')\n+      expect(config.turbopack.root).toBe('/custom/root')\n+    })\n+\n+    it('Should use outputFileTracingRoot value when both are provided with different values', async () => {\n+      const config = await loadConfig(PHASE_DEVELOPMENT_SERVER, '<rootDir>', {\n+        customConfig: {\n+          outputFileTracingRoot: '/tracing/root',\n+          turbopack: { root: '/turbo/root' },\n+        },\n+      })\n+      expect(config.outputFileTracingRoot).toBe('/tracing/root')\n+      expect(config.turbopack.root).toBe('/tracing/root')\n+    })\n+\n+    it('Should keep the same value when both are provided with matching values', async () => {\n+      const config = await loadConfig(PHASE_DEVELOPMENT_SERVER, '<rootDir>', {\n+        customConfig: {\n+          outputFileTracingRoot: '/same/root',\n+          turbopack: { root: '/same/root' },\n+        },\n+      })\n+      expect(config.outputFileTracingRoot).toBe('/same/root')\n+      expect(config.turbopack.root).toBe('/same/root')\n+    })\n+\n+    it('Should set both to findRootDir result when neither is provided', async () => {\n+      const config = await loadConfig(PHASE_DEVELOPMENT_SERVER, '<rootDir>', {\n+        customConfig: {},\n+      })\n+      expect(config.outputFileTracingRoot).toBeDefined()\n+      expect(config.turbopack.root).toBe(config.outputFileTracingRoot)\n+    })\n+  })\n })"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 74,
        "deletions": 12
    }
}