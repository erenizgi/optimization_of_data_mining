{
    "author": "mischnic",
    "message": "Turbopack: cleanup StyleSheetLike (#85718)\n\nThis abstraction was a leftover from when we had a swc_css and a lightningcss backend.\n\nAlso inspired by https://github.com/vercel/next.js/pull/85524 as there was another constant-false `PartialEq` impl.",
    "sha": "5df646547b1e9a65ad610b0b01f6fdf425ea55ec",
    "files": [
        {
            "sha": "396707a9b7050118ae627fde174962d7557e7ec9",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 64,
            "deletions": 80,
            "changes": 144,
            "blob_url": "https://github.com/vercel/next.js/blob/5df646547b1e9a65ad610b0b01f6fdf425ea55ec/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5df646547b1e9a65ad610b0b01f6fdf425ea55ec/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=5df646547b1e9a65ad610b0b01f6fdf425ea55ec",
            "patch": "@@ -43,15 +43,6 @@ use crate::{\n     },\n };\n \n-#[derive(Debug)]\n-pub struct StyleSheetLike<'i, 'o>(pub(crate) StyleSheet<'i, 'o>);\n-\n-impl PartialEq for StyleSheetLike<'_, '_> {\n-    fn eq(&self, _: &Self) -> bool {\n-        false\n-    }\n-}\n-\n pub type CssOutput = (ToCssResult, Option<Rope>);\n \n #[turbo_tasks::value(transparent)]\n@@ -94,60 +85,49 @@ async fn get_lightningcss_browser_targets(\n     }\n }\n \n-impl StyleSheetLike<'_, '_> {\n-    pub fn to_static(\n-        &self,\n-        options: ParserOptions<'static, 'static>,\n-    ) -> StyleSheetLike<'static, 'static> {\n-        StyleSheetLike(stylesheet_into_static(&self.0, options))\n-    }\n+async fn stylesheet_to_css(\n+    ss: &StyleSheet<'_, '_>,\n+    code: &str,\n+    minify_type: MinifyType,\n+    enable_srcmap: bool,\n+    handle_nesting: bool,\n+    mut origin_source_map: Option<parcel_sourcemap::SourceMap>,\n+    environment: Option<ResolvedVc<Environment>>,\n+) -> Result<CssOutput> {\n+    let mut srcmap = if enable_srcmap {\n+        Some(parcel_sourcemap::SourceMap::new(\"\"))\n+    } else {\n+        None\n+    };\n \n-    pub async fn to_css(\n-        &self,\n-        code: &str,\n-        minify_type: MinifyType,\n-        enable_srcmap: bool,\n-        handle_nesting: bool,\n-        mut origin_source_map: Option<parcel_sourcemap::SourceMap>,\n-        environment: Option<ResolvedVc<Environment>>,\n-    ) -> Result<CssOutput> {\n-        let ss = &self.0;\n-        let mut srcmap = if enable_srcmap {\n-            Some(parcel_sourcemap::SourceMap::new(\"\"))\n+    let targets =\n+        *get_lightningcss_browser_targets(environment.as_deref().copied(), handle_nesting).await?;\n+\n+    let result = ss.to_css(PrinterOptions {\n+        minify: matches!(minify_type, MinifyType::Minify { .. }),\n+        source_map: srcmap.as_mut(),\n+        targets,\n+        analyze_dependencies: None,\n+        ..Default::default()\n+    })?;\n+\n+    if let Some(srcmap) = &mut srcmap {\n+        debug_assert_eq!(ss.sources.len(), 1);\n+\n+        if let Some(origin_source_map) = origin_source_map.as_mut() {\n+            let _ = srcmap.extends(origin_source_map);\n         } else {\n-            None\n-        };\n-\n-        let targets =\n-            *get_lightningcss_browser_targets(environment.as_deref().copied(), handle_nesting)\n-                .await?;\n-\n-        let result = ss.to_css(PrinterOptions {\n-            minify: matches!(minify_type, MinifyType::Minify { .. }),\n-            source_map: srcmap.as_mut(),\n-            targets,\n-            analyze_dependencies: None,\n-            ..Default::default()\n-        })?;\n-\n-        if let Some(srcmap) = &mut srcmap {\n-            debug_assert_eq!(ss.sources.len(), 1);\n-\n-            if let Some(origin_source_map) = origin_source_map.as_mut() {\n-                let _ = srcmap.extends(origin_source_map);\n-            } else {\n-                srcmap.add_sources(ss.sources.clone());\n-                srcmap.set_source_content(0, code)?;\n-            }\n+            srcmap.add_sources(ss.sources.clone());\n+            srcmap.set_source_content(0, code)?;\n         }\n+    }\n \n-        let srcmap = match srcmap {\n-            Some(srcmap) => Some(generate_css_source_map(&srcmap)?),\n-            None => None,\n-        };\n+    let srcmap = match srcmap {\n+        Some(srcmap) => Some(generate_css_source_map(&srcmap)?),\n+        None => None,\n+    };\n \n-        Ok((result, srcmap))\n-    }\n+    Ok((result, srcmap))\n }\n \n /// Multiple [ModuleReference]s\n@@ -161,7 +141,7 @@ pub enum ParseCssResult {\n         code: ResolvedVc<FileContent>,\n \n         #[turbo_tasks(trace_ignore)]\n-        stylesheet: StyleSheetLike<'static, 'static>,\n+        stylesheet: StyleSheet<'static, 'static>,\n \n         references: ResolvedVc<ModuleReferences>,\n \n@@ -228,9 +208,16 @@ pub async fn process_css_with_placeholder(\n \n             // We use NoMinify because this is not a final css. We need to replace url references,\n             // and we do final codegen with proper minification.\n-            let (result, _) = stylesheet\n-                .to_css(&code, MinifyType::NoMinify, false, false, None, environment)\n-                .await?;\n+            let (result, _) = stylesheet_to_css(\n+                stylesheet,\n+                &code,\n+                MinifyType::NoMinify,\n+                false,\n+                false,\n+                None,\n+                environment,\n+            )\n+            .await?;\n \n             let exports = result.exports.map(|exports| {\n                 let mut exports = exports.into_iter().collect::<FxIndexMap<_, _>>();\n@@ -275,7 +262,7 @@ pub async fn finalize_css(\n                     options,\n                     code,\n                     ..\n-                } => (stylesheet.to_static(options.clone()), *code),\n+                } => (stylesheet_into_static(stylesheet, options.clone()), *code),\n                 ParseCssResult::Unparsable => return Ok(FinalCssResult::Unparsable.cell()),\n                 ParseCssResult::NotFound => return Ok(FinalCssResult::NotFound.cell()),\n             };\n@@ -305,16 +292,16 @@ pub async fn finalize_css(\n                 None\n             };\n \n-            let (result, srcmap) = stylesheet\n-                .to_css(\n-                    &code,\n-                    minify_type,\n-                    true,\n-                    true,\n-                    origin_source_map,\n-                    environment,\n-                )\n-                .await?;\n+            let (result, srcmap) = stylesheet_to_css(\n+                &stylesheet,\n+                &code,\n+                minify_type,\n+                true,\n+                true,\n+                origin_source_map,\n+                environment,\n+            )\n+            .await?;\n \n             Ok(FinalCssResult::Ok {\n                 output_code: result.code,\n@@ -435,7 +422,7 @@ async fn process_content(\n         ..Default::default()\n     };\n \n-    let stylesheet = StyleSheetLike({\n+    let stylesheet = {\n         let warnings: Arc<RwLock<_>> = Default::default();\n \n         match StyleSheet::parse(\n@@ -455,10 +442,7 @@ async fn process_content(\n                     }\n                 }\n \n-                // We need to collect here because we need to avoid holding the lock while calling\n-                // `.await` in the loop.\n-                let warnings = warnings.read().unwrap().iter().cloned().collect::<Vec<_>>();\n-                for err in warnings.iter() {\n+                for err in warnings.read().unwrap().iter() {\n                     match err.kind {\n                         lightningcss::error::ParserError::UnexpectedToken(_)\n                         | lightningcss::error::ParserError::UnexpectedImportRule\n@@ -546,10 +530,10 @@ async fn process_content(\n                 return Ok(ParseCssResult::Unparsable.cell());\n             }\n         }\n-    });\n+    };\n \n     let config = without_warnings(config);\n-    let mut stylesheet = stylesheet.to_static(config.clone());\n+    let mut stylesheet = stylesheet_into_static(&stylesheet, config.clone());\n \n     let (references, url_references) =\n         analyze_references(&mut stylesheet, source, origin, import_context).await?;"
        },
        {
            "sha": "2b4b71e546bf0750cae51d2251916534a25c1ad1",
            "filename": "turbopack/crates/turbopack-css/src/references/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/5df646547b1e9a65ad610b0b01f6fdf425ea55ec/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5df646547b1e9a65ad610b0b01f6fdf425ea55ec/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fmod.rs?ref=5df646547b1e9a65ad610b0b01f6fdf425ea55ec",
            "patch": "@@ -3,6 +3,7 @@ use std::convert::Infallible;\n use anyhow::Result;\n use lightningcss::{\n     rules::CssRule,\n+    stylesheet::StyleSheet,\n     traits::IntoOwned,\n     values::url::Url,\n     visitor::{Visit, Visitor},\n@@ -18,12 +19,9 @@ use turbopack_core::{\n     source_pos::SourcePos,\n };\n \n-use crate::{\n-    StyleSheetLike,\n-    references::{\n-        import::{ImportAssetReference, ImportAttributes},\n-        url::UrlAssetReference,\n-    },\n+use crate::references::{\n+    import::{ImportAssetReference, ImportAttributes},\n+    url::UrlAssetReference,\n };\n \n pub(crate) mod compose;\n@@ -38,7 +36,7 @@ pub type AnalyzedRefs = (\n \n /// Returns `(all_references, urls)`.\n pub async fn analyze_references(\n-    stylesheet: &mut StyleSheetLike<'static, 'static>,\n+    stylesheet: &mut StyleSheet<'static, 'static>,\n     source: ResolvedVc<Box<dyn Source>>,\n     origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n     import_context: Option<ResolvedVc<ImportContext>>,\n@@ -48,7 +46,7 @@ pub async fn analyze_references(\n \n     let mut visitor =\n         ModuleReferencesVisitor::new(source, origin, import_context, &mut references, &mut urls);\n-    stylesheet.0.visit(&mut visitor).unwrap();\n+    stylesheet.visit(&mut visitor).unwrap();\n \n     tokio::try_join!(\n         references.into_iter().map(|v| v.to_resolved()).try_join(),"
        },
        {
            "sha": "fa57f2263e915b0979ed7d77ee76c35cd7212b49",
            "filename": "turbopack/crates/turbopack-css/src/references/url.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5df646547b1e9a65ad610b0b01f6fdf425ea55ec/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Furl.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5df646547b1e9a65ad610b0b01f6fdf425ea55ec/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Furl.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Furl.rs?ref=5df646547b1e9a65ad610b0b01f6fdf425ea55ec",
            "patch": "@@ -2,6 +2,7 @@ use std::convert::Infallible;\n \n use anyhow::Result;\n use lightningcss::{\n+    stylesheet::StyleSheet,\n     values::url::Url,\n     visit_types,\n     visitor::{Visit, Visitor},\n@@ -18,7 +19,7 @@ use turbopack_core::{\n     resolve::{ModuleResolveResult, origin::ResolveOrigin, parse::Request, url_resolve},\n };\n \n-use crate::{StyleSheetLike, embed::CssEmbed};\n+use crate::embed::CssEmbed;\n \n #[turbo_tasks::value]\n pub enum ReferencedAsset {\n@@ -122,12 +123,9 @@ pub async fn resolve_url_reference(\n     Ok(Vc::cell(None))\n }\n \n-pub fn replace_url_references(\n-    ss: &mut StyleSheetLike<'static, 'static>,\n-    urls: &FxHashMap<RcStr, RcStr>,\n-) {\n+pub fn replace_url_references<'i, 'o>(ss: &mut StyleSheet<'i, 'o>, urls: &FxHashMap<RcStr, RcStr>) {\n     let mut replacer = AssetReferenceReplacer { urls };\n-    ss.0.visit(&mut replacer).unwrap();\n+    ss.visit(&mut replacer).unwrap();\n }\n \n struct AssetReferenceReplacer<'a> {"
        }
    ],
    "stats": {
        "total": 168,
        "additions": 74,
        "deletions": 94
    }
}