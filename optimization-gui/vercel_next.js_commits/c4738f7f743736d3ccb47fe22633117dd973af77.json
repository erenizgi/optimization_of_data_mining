{
    "author": "mischnic",
    "message": "Turbopack: don't execute action loader eagerly (#83049)\n\nThe server-reference-manifest.json contains the chunk item id of the action loader. The loader itself doesn't \"register\" itself in any way. So no need to execute it eagerly.",
    "sha": "c4738f7f743736d3ccb47fe22633117dd973af77",
    "files": [
        {
            "sha": "91480f9a6f5dbc15dfdeee25ccc234c15af58e61",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/c4738f7f743736d3ccb47fe22633117dd973af77/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c4738f7f743736d3ccb47fe22633117dd973af77/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=c4738f7f743736d3ccb47fe22633117dd973af77",
            "patch": "@@ -1748,7 +1748,7 @@ impl AppEndpoint {\n                     assets,\n                     availability_info,\n                 } = *chunking_context\n-                    .evaluated_chunk_group(\n+                    .chunk_group(\n                         server_action_manifest_loader.ident(),\n                         ChunkGroup::Entry(\n                             [ResolvedVc::upcast(server_action_manifest_loader)]\n@@ -1785,7 +1785,6 @@ impl AppEndpoint {\n                     bail!(\"rsc_entry must be evaluatable\");\n                 };\n \n-                evaluatable_assets.push(server_action_manifest_loader);\n                 evaluatable_assets.push(rsc_entry);\n \n                 async {\n@@ -1864,6 +1863,25 @@ impl AppEndpoint {\n                         .await?;\n                     }\n \n+                    {\n+                        let chunk_group = chunking_context\n+                            .chunk_group(\n+                                server_action_manifest_loader.ident(),\n+                                ChunkGroup::Entry(vec![ResolvedVc::upcast(\n+                                    server_action_manifest_loader,\n+                                )]),\n+                                module_graph,\n+                                current_availability_info,\n+                            )\n+                            .await?;\n+\n+                        current_chunks = current_chunks\n+                            .concatenate(*chunk_group.assets)\n+                            .resolve()\n+                            .await?;\n+                        current_availability_info = chunk_group.availability_info;\n+                    }\n+\n                     anyhow::Ok(Vc::cell(vec![\n                         chunking_context\n                             .entry_chunk_group_asset("
        },
        {
            "sha": "aa422f7713447be3ab21cddd029653e920efd932",
            "filename": "crates/next-api/src/server_actions.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/c4738f7f743736d3ccb47fe22633117dd973af77/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c4738f7f743736d3ccb47fe22633117dd973af77/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fserver_actions.rs?ref=c4738f7f743736d3ccb47fe22633117dd973af77",
            "patch": "@@ -19,11 +19,13 @@ use swc_core::{\n     },\n };\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{FxIndexMap, ResolvedVc, TryFlatJoinIterExt, ValueToString, Vc};\n+use turbo_tasks::{FxIndexMap, ResolvedVc, TryFlatJoinIterExt, Vc};\n use turbo_tasks_fs::{self, File, FileSystemPath, rope::RopeBuilder};\n use turbopack_core::{\n     asset::AssetContent,\n-    chunk::{ChunkItem, ChunkItemExt, ChunkableModule, ChunkingContext, EvaluatableAsset},\n+    chunk::{\n+        ChunkItem, ChunkItemExt, ChunkableModule, ChunkingContext, EvaluatableAsset, ModuleId,\n+    },\n     context::AssetContext,\n     file_source::FileSource,\n     ident::AssetIdent,\n@@ -168,7 +170,11 @@ async fn build_manifest(\n     let key = format!(\"app{page_name}\");\n \n     let actions_value = actions.await?;\n-    let loader_id = chunk_item.id().to_string().await?;\n+    let loader_id = chunk_item.id().await?;\n+    let loader_id = match &*loader_id {\n+        ModuleId::Number(id) => ActionManifestModuleId::Number(*id),\n+        ModuleId::String(id) => ActionManifestModuleId::String(id),\n+    };\n     let mapping = match runtime {\n         NextRuntime::Edge => &mut manifest.edge,\n         NextRuntime::NodeJs => &mut manifest.node,\n@@ -190,7 +196,7 @@ async fn build_manifest(\n         entry.workers.insert(\n             &key,\n             ActionManifestWorkerEntry {\n-                module_id: ActionManifestModuleId::String(loader_id.as_str()),\n+                module_id: loader_id.clone(),\n                 is_async: *async_module_info.is_async(chunk_item.module()).await?,\n                 exported_name: name.as_str(),\n                 filename: filename.as_str(),"
        },
        {
            "sha": "7625118fee4d10a94f4ce2dbf30b4466396a5b96",
            "filename": "crates/next-core/src/next_manifests/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c4738f7f743736d3ccb47fe22633117dd973af77/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c4738f7f743736d3ccb47fe22633117dd973af77/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fmod.rs?ref=c4738f7f743736d3ccb47fe22633117dd973af77",
            "patch": "@@ -329,11 +329,11 @@ pub struct ActionManifestWorkerEntry<'a> {\n     pub filename: &'a str,\n }\n \n-#[derive(Serialize, Debug)]\n+#[derive(Serialize, Debug, Clone)]\n #[serde(untagged)]\n pub enum ActionManifestModuleId<'a> {\n     String(&'a str),\n-    Number(f64),\n+    Number(u64),\n }\n \n #[derive("
        },
        {
            "sha": "4f90d78735940ef5c1e2fd783b26572f5a904738",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c4738f7f743736d3ccb47fe22633117dd973af77/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c4738f7f743736d3ccb47fe22633117dd973af77/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=c4738f7f743736d3ccb47fe22633117dd973af77",
            "patch": "@@ -44,7 +44,7 @@ describe('app-dir action handling', () => {\n \n           expect(itemInfo.filename).toBeString()\n           // can be outside app dir but this test suite has them all in app\n-          expect(itemInfo.filename.startsWith('app/')).toBe(true)\n+          expect(itemInfo.filename).toStartWith('app/')\n           expect(itemInfo.exportedName).toBeString()\n         } catch (err) {\n           require('console').error(`Invalid action entry ${item}`, err)"
        },
        {
            "sha": "90ad825e0b2a16f2f55cab8267301fa445fe582d",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 11,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c4738f7f743736d3ccb47fe22633117dd973af77/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c4738f7f743736d3ccb47fe22633117dd973af77/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=c4738f7f743736d3ccb47fe22633117dd973af77",
            "patch": "@@ -2697,8 +2697,7 @@ describe('Cache Components Errors', () => {\n                     |                                      ^\",\n                  \"stack\": [\n                    \"{module evaluation} app/use-cache-private-in-unstable-cache/page.tsx (21:38)\",\n-                   \"{module evaluation} .next-internal/server/app/use-cache-private-in-unstable-cache/page/actions.js (server actions loader) (1:1)\",\n-                   \"<FIXME-file-protocol>\",\n+                   \"<FIXME-next-dist-dir>\",\n                    \"<FIXME-next-dist-dir>\",\n                  ],\n                }\n@@ -2754,8 +2753,8 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n-                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-unstable-cache/page/actions.js (server actions loader):1:1)\n                      at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n                    19 | }\n                    20 |\n                  > 21 | const getCachedData = unstable_cache(async () => {\n@@ -2773,7 +2772,6 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \\`unstable_cache()\\`.\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-unstable-cache/page.tsx:21:38)\n-                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-unstable-cache/page/actions.js%20(server%20actions%20loader):1:1)\n                      at a (<next-dist-dir>)\n                    19 | }\n                    20 |\n@@ -2842,8 +2840,7 @@ describe('Cache Components Errors', () => {\n                     | ^\",\n                  \"stack\": [\n                    \"{module evaluation} app/use-cache-private-in-use-cache/page.tsx (15:1)\",\n-                   \"{module evaluation} .next-internal/server/app/use-cache-private-in-use-cache/page/actions.js (server actions loader) (1:1)\",\n-                   \"<FIXME-file-protocol>\",\n+                   \"<FIXME-next-dist-dir>\",\n                    \"<FIXME-next-dist-dir>\",\n                  ],\n                }\n@@ -2900,8 +2897,8 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-use-cache/page/actions.js (server actions loader):1:1)\n                      at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n                    13 | }\n                    14 |\n                  > 15 | async function Private() {\n@@ -2911,8 +2908,8 @@ describe('Cache Components Errors', () => {\n                    18 |   return <p>Private</p>\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-use-cache/page/actions.js (server actions loader):1:1)\n-                     at b (<next-dist-dir>)\n+                     at c (<next-dist-dir>)\n+                     at d (<next-dist-dir>)\n                    13 | }\n                    14 |\n                  > 15 | async function Private() {\n@@ -2930,7 +2927,6 @@ describe('Cache Components Errors', () => {\n                 expect(output).toMatchInlineSnapshot(`\n                  \"Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-use-cache/page/actions.js%20(server%20actions%20loader):1:1)\n                      at a (<next-dist-dir>)\n                    13 | }\n                    14 |\n@@ -2941,7 +2937,6 @@ describe('Cache Components Errors', () => {\n                    18 |   return <p>Private</p>\n                  Error: \"use cache: private\" must not be used within \"use cache\". It can only be nested inside of another \"use cache: private\".\n                      at __TURBOPACK__module__evaluation__ (bundler:///app/use-cache-private-in-use-cache/page.tsx:15:1)\n-                     at __TURBOPACK__module__evaluation__ (bundler:///.next-internal/server/app/use-cache-private-in-use-cache/page/actions.js%20(server%20actions%20loader):1:1)\n                      at b (<next-dist-dir>)\n                    13 | }\n                    14 |"
        }
    ],
    "stats": {
        "total": 59,
        "additions": 39,
        "deletions": 20
    }
}