{
    "author": "ijjk",
    "message": "Fix dynamicParams false layout case in dev (#81990)\n\nThis ensures we don't consider a path as ISR in development when it will\nbe dynamic during a build due to no `generateStaticParams` being fully\ngenerated for a path.\n\nFixes: https://github.com/vercel/next.js/issues/81976\nCloses: NEXT-4650",
    "sha": "08ee5f678fe57860ad02afc8e349200ecf6be958",
    "files": [
        {
            "sha": "bc14749d10ab36b490eaab8c43660eec7f155168",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/08ee5f678fe57860ad02afc8e349200ecf6be958/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/08ee5f678fe57860ad02afc8e349200ecf6be958/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=08ee5f678fe57860ad02afc8e349200ecf6be958",
            "patch": "@@ -1240,7 +1240,7 @@ export async function handler(\n     }\n   } catch (err) {\n     // if we aren't wrapped by base-server handle here\n-    if (!activeSpan) {\n+    if (!activeSpan && !(err instanceof NoFallbackError)) {\n       await routeModule.onRequestError(\n         req,\n         err,"
        },
        {
            "sha": "229d897844f5aef1f8b59cffeb902a04cfe119a4",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/08ee5f678fe57860ad02afc8e349200ecf6be958/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/08ee5f678fe57860ad02afc8e349200ecf6be958/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=08ee5f678fe57860ad02afc8e349200ecf6be958",
            "patch": "@@ -449,7 +449,7 @@ export async function handler(\n     }\n   } catch (err) {\n     // if we aren't wrapped by base-server handle here\n-    if (!activeSpan) {\n+    if (!activeSpan && !(err instanceof NoFallbackError)) {\n       await routeModule.onRequestError(req, err, {\n         routerKind: 'App Router',\n         routePath: normalizedSrcPage,"
        },
        {
            "sha": "e4ad95a12ce646cf041a72736ac7c377ca993cf0",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/08ee5f678fe57860ad02afc8e349200ecf6be958/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/08ee5f678fe57860ad02afc8e349200ecf6be958/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=08ee5f678fe57860ad02afc8e349200ecf6be958",
            "patch": "@@ -894,7 +894,12 @@ export default class DevServer extends Server {\n           fallbackMode: fallback,\n         }\n \n-        if (res.value?.fallbackMode !== undefined) {\n+        if (\n+          res.value?.fallbackMode !== undefined &&\n+          // This matches the hasGenerateStaticParams logic\n+          // we do during build\n+          (!isAppPath || (staticPaths && staticPaths.length > 0))\n+        ) {\n           // we write the static paths to partial manifest for\n           // fallback handling inside of entry handler's\n           const rawExistingManifest = await fs.promises.readFile("
        },
        {
            "sha": "83af0ec60ef018e5a2e92b5f0d5acd62b58d3a1b",
            "filename": "packages/next/src/server/route-modules/pages/pages-handler.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 14,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/08ee5f678fe57860ad02afc8e349200ecf6be958/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/08ee5f678fe57860ad02afc8e349200ecf6be958/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts?ref=08ee5f678fe57860ad02afc8e349200ecf6be958",
            "patch": "@@ -745,20 +745,22 @@ export const getHandler = ({\n         )\n       }\n     } catch (err) {\n-      await routeModule.onRequestError(\n-        req,\n-        err,\n-        {\n-          routerKind: 'Pages Router',\n-          routePath: srcPage,\n-          routeType: 'render',\n-          revalidateReason: getRevalidateReason({\n-            isRevalidate: hasStaticProps,\n-            isOnDemandRevalidate,\n-          }),\n-        },\n-        routerServerContext\n-      )\n+      if (!(err instanceof NoFallbackError)) {\n+        await routeModule.onRequestError(\n+          req,\n+          err,\n+          {\n+            routerKind: 'Pages Router',\n+            routePath: srcPage,\n+            routeType: 'render',\n+            revalidateReason: getRevalidateReason({\n+              isRevalidate: hasStaticProps,\n+              isOnDemandRevalidate,\n+            }),\n+          },\n+          routerServerContext\n+        )\n+      }\n \n       // rethrow so that we can handle serving error page\n       throw err"
        },
        {
            "sha": "3f595697eb07abff8a9567751d4bb7ebe5991566",
            "filename": "test/e2e/app-dir/app-static/app-static.test.ts",
            "status": "modified",
            "additions": 89,
            "deletions": 0,
            "changes": 89,
            "blob_url": "https://github.com/vercel/next.js/blob/08ee5f678fe57860ad02afc8e349200ecf6be958/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/08ee5f678fe57860ad02afc8e349200ecf6be958/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts?ref=08ee5f678fe57860ad02afc8e349200ecf6be958",
            "patch": "@@ -40,6 +40,18 @@ describe('app-dir static/dynamic handling', () => {\n     }\n   })\n \n+  if (!process.env.__NEXT_EXPERIMENTAL_PPR) {\n+    it('should respond correctly for dynamic route with dynamicParams false in layout', async () => {\n+      const res = await next.fetch('/partial-params-false/en/another')\n+      expect(res.status).toBe(200)\n+    })\n+\n+    it('should respond correctly for partially dynamic route with dynamicParams false in layout', async () => {\n+      const res = await next.fetch('/partial-params-false/en/static')\n+      expect(res.status).toBe(200)\n+    })\n+  }\n+\n   it('should use auto no cache when no fetch config', async () => {\n     const res = await next.fetch('/no-config-fetch')\n     expect(res.status).toBe(200)\n@@ -877,6 +889,10 @@ describe('app-dir static/dynamic handling', () => {\n          \"partial-gen-params-no-additional-slug/fr/first.rsc\",\n          \"partial-gen-params-no-additional-slug/fr/second.html\",\n          \"partial-gen-params-no-additional-slug/fr/second.rsc\",\n+         \"partial-params-false/en/static.html\",\n+         \"partial-params-false/en/static.rsc\",\n+         \"partial-params-false/fr/static.html\",\n+         \"partial-params-false/fr/static.rsc\",\n          \"prerendered-not-found/first.html\",\n          \"prerendered-not-found/first.rsc\",\n          \"prerendered-not-found/second.html\",\n@@ -1822,6 +1838,54 @@ describe('app-dir static/dynamic handling', () => {\n            \"initialRevalidateSeconds\": false,\n            \"srcRoute\": \"/partial-gen-params-no-additional-slug/[lang]/[slug]\",\n          },\n+         \"/partial-params-false/en/static\": {\n+           \"allowHeader\": [\n+             \"host\",\n+             \"x-matched-path\",\n+             \"x-prerender-revalidate\",\n+             \"x-prerender-revalidate-if-generated\",\n+             \"x-next-revalidated-tags\",\n+             \"x-next-revalidate-tag-token\",\n+           ],\n+           \"dataRoute\": \"/partial-params-false/en/static.rsc\",\n+           \"experimentalBypassFor\": [\n+             {\n+               \"key\": \"Next-Action\",\n+               \"type\": \"header\",\n+             },\n+             {\n+               \"key\": \"content-type\",\n+               \"type\": \"header\",\n+               \"value\": \"multipart/form-data;.*\",\n+             },\n+           ],\n+           \"initialRevalidateSeconds\": false,\n+           \"srcRoute\": \"/partial-params-false/[locale]/static\",\n+         },\n+         \"/partial-params-false/fr/static\": {\n+           \"allowHeader\": [\n+             \"host\",\n+             \"x-matched-path\",\n+             \"x-prerender-revalidate\",\n+             \"x-prerender-revalidate-if-generated\",\n+             \"x-next-revalidated-tags\",\n+             \"x-next-revalidate-tag-token\",\n+           ],\n+           \"dataRoute\": \"/partial-params-false/fr/static.rsc\",\n+           \"experimentalBypassFor\": [\n+             {\n+               \"key\": \"Next-Action\",\n+               \"type\": \"header\",\n+             },\n+             {\n+               \"key\": \"content-type\",\n+               \"type\": \"header\",\n+               \"value\": \"multipart/form-data;.*\",\n+             },\n+           ],\n+           \"initialRevalidateSeconds\": false,\n+           \"srcRoute\": \"/partial-params-false/[locale]/static\",\n+         },\n          \"/prerendered-not-found/first\": {\n            \"allowHeader\": [\n              \"host\",\n@@ -2580,6 +2644,31 @@ describe('app-dir static/dynamic handling', () => {\n            \"fallback\": false,\n            \"routeRegex\": \"^\\\\/partial\\\\-gen\\\\-params\\\\-no\\\\-additional\\\\-slug\\\\/([^\\\\/]+?)\\\\/([^\\\\/]+?)(?:\\\\/)?$\",\n          },\n+         \"/partial-params-false/[locale]/static\": {\n+           \"allowHeader\": [\n+             \"host\",\n+             \"x-matched-path\",\n+             \"x-prerender-revalidate\",\n+             \"x-prerender-revalidate-if-generated\",\n+             \"x-next-revalidated-tags\",\n+             \"x-next-revalidate-tag-token\",\n+           ],\n+           \"dataRoute\": \"/partial-params-false/[locale]/static.rsc\",\n+           \"dataRouteRegex\": \"^\\\\/partial\\\\-params\\\\-false\\\\/([^\\\\/]+?)\\\\/static\\\\.rsc$\",\n+           \"experimentalBypassFor\": [\n+             {\n+               \"key\": \"Next-Action\",\n+               \"type\": \"header\",\n+             },\n+             {\n+               \"key\": \"content-type\",\n+               \"type\": \"header\",\n+               \"value\": \"multipart/form-data;.*\",\n+             },\n+           ],\n+           \"fallback\": false,\n+           \"routeRegex\": \"^\\\\/partial\\\\-params\\\\-false\\\\/([^\\\\/]+?)\\\\/static(?:\\\\/)?$\",\n+         },\n          \"/prerendered-not-found/[slug]\": {\n            \"allowHeader\": [\n              \"host\","
        },
        {
            "sha": "7ab100431b35e45078f725f79d30376852c8966b",
            "filename": "test/e2e/app-dir/app-static/app/partial-params-false/[locale]/[slug]/page.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/08ee5f678fe57860ad02afc8e349200ecf6be958/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2F%5Bslug%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/08ee5f678fe57860ad02afc8e349200ecf6be958/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2F%5Bslug%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2F%5Bslug%5D%2Fpage.js?ref=08ee5f678fe57860ad02afc8e349200ecf6be958",
            "patch": "@@ -0,0 +1,10 @@\n+export default async function Page({ params }) {\n+  const { locale, slug } = await params\n+\n+  return (\n+    <>\n+      <p>/[locale]/[slug]/page</p>\n+      <p>params: {JSON.stringify({ locale, slug })}</p>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "e9b0920c6fa56549daf5bb24f86951b4fa51dae2",
            "filename": "test/e2e/app-dir/app-static/app/partial-params-false/[locale]/layout.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/08ee5f678fe57860ad02afc8e349200ecf6be958/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/08ee5f678fe57860ad02afc8e349200ecf6be958/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2Flayout.js?ref=08ee5f678fe57860ad02afc8e349200ecf6be958",
            "patch": "@@ -0,0 +1,16 @@\n+export const dynamicParams = false\n+\n+export function generateStaticParams() {\n+  return [\n+    {\n+      locale: 'en',\n+    },\n+    {\n+      locale: 'fr',\n+    },\n+  ]\n+}\n+\n+export default function Layout({ children }) {\n+  return <>{children}</>\n+}"
        },
        {
            "sha": "7cd2718329aee7c3bba24f2abde4be37362ec392",
            "filename": "test/e2e/app-dir/app-static/app/partial-params-false/[locale]/static/page.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/08ee5f678fe57860ad02afc8e349200ecf6be958/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2Fstatic%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/08ee5f678fe57860ad02afc8e349200ecf6be958/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2Fstatic%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fpartial-params-false%2F%5Blocale%5D%2Fstatic%2Fpage.js?ref=08ee5f678fe57860ad02afc8e349200ecf6be958",
            "patch": "@@ -0,0 +1,9 @@\n+export default async function Page({ params }) {\n+  const { locale } = await params\n+  return (\n+    <>\n+      <p>/[locale]/static</p>\n+      <p>locale: {locale}</p>\n+    </>\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 165,
        "additions": 148,
        "deletions": 17
    }
}