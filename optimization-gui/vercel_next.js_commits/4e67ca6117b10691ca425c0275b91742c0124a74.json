{
    "author": "timneutkens",
    "message": "Turbopack Build: Implement regions for pages router (#80063)\n\n## What?\n\nImplements the missing `regions` property for the edge manifest.",
    "sha": "4e67ca6117b10691ca425c0275b91742c0124a74",
    "files": [
        {
            "sha": "8354bbcfdcfc99e1a7b8992c92d19dd0d9334a3e",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 2,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/4e67ca6117b10691ca425c0275b91742c0124a74/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/4e67ca6117b10691ca425c0275b91742c0124a74/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=4e67ca6117b10691ca425c0275b91742c0124a74",
            "patch": "@@ -13,7 +13,7 @@ use next_core::{\n     next_edge::route_regex::get_named_middleware_regex,\n     next_manifests::{\n         BuildManifest, EdgeFunctionDefinition, MiddlewareMatcher, MiddlewaresManifestV2,\n-        PagesManifest,\n+        PagesManifest, Regions,\n     },\n     next_pages::create_page_ssr_entry_module,\n     next_server::{\n@@ -916,6 +916,7 @@ impl PageEndpoint {\n                     // /_app and /_document are always rendered for Node.js for this case. For edge\n                     // they're included in the page bundle.\n                     runtime: NextRuntime::NodeJs,\n+                    regions: config.regions.clone(),\n                 }\n             } else if config.runtime == NextRuntime::Edge {\n                 let modules = create_page_ssr_entry_module(\n@@ -936,6 +937,7 @@ impl PageEndpoint {\n                     app_module: modules.app_module,\n                     document_module: modules.document_module,\n                     runtime: config.runtime,\n+                    regions: config.regions.clone(),\n                 }\n             } else {\n                 let modules = create_page_ssr_entry_module(\n@@ -955,6 +957,7 @@ impl PageEndpoint {\n                     app_module: modules.app_module,\n                     document_module: modules.document_module,\n                     runtime: config.runtime,\n+                    regions: config.regions.clone(),\n                 }\n             }\n             .cell(),\n@@ -979,6 +982,7 @@ impl PageEndpoint {\n                 app_module,\n                 document_module,\n                 runtime,\n+                ref regions,\n             } = *self.internal_ssr_chunk_module().await?;\n \n             let project = this.pages_project.project();\n@@ -1074,6 +1078,7 @@ impl PageEndpoint {\n                 Ok(SsrChunk::Edge {\n                     files: current_chunks.concatenate(edge_files).to_resolved().await?,\n                     dynamic_import_entries,\n+                    regions: regions.clone(),\n                 }\n                 .cell())\n             } else {\n@@ -1348,6 +1353,7 @@ impl PageEndpoint {\n             SsrChunk::Edge {\n                 files,\n                 dynamic_import_entries,\n+                ref regions,\n             } => {\n                 let node_root = this.pages_project.project().node_root();\n                 if emit_manifests {\n@@ -1398,14 +1404,26 @@ impl PageEndpoint {\n                         original_source: pathname.clone(),\n                         ..Default::default()\n                     };\n+                    let regions = if let Some(regions) = regions.as_ref() {\n+                        if regions.len() == 1 {\n+                            regions\n+                                .first()\n+                                .map(|region| Regions::Single(region.clone()))\n+                        } else {\n+                            Some(Regions::Multiple(regions.clone()))\n+                        }\n+                    } else {\n+                        None\n+                    };\n+\n                     let original_name = this.original_name.owned().await?;\n                     let edge_function_definition = EdgeFunctionDefinition {\n                         files: file_paths_from_root,\n                         wasm: wasm_paths_to_bindings(wasm_paths_from_root).await?,\n                         assets: paths_to_bindings(all_assets),\n                         name: pathname.clone(),\n                         page: original_name.clone(),\n-                        regions: None,\n+                        regions,\n                         matchers: vec![matchers],\n                         env: this.pages_project.project().edge_env().owned().await?,\n                     };\n@@ -1464,6 +1482,7 @@ pub struct InternalSsrChunkModule {\n     pub app_module: Option<ResolvedVc<Box<dyn Module>>>,\n     pub document_module: Option<ResolvedVc<Box<dyn Module>>>,\n     pub runtime: NextRuntime,\n+    pub regions: Option<Vec<RcStr>>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -1653,5 +1672,6 @@ pub enum SsrChunk {\n     Edge {\n         files: ResolvedVc<OutputAssets>,\n         dynamic_import_entries: ResolvedVc<DynamicImportedChunks>,\n+        regions: Option<Vec<RcStr>>,\n     },\n }"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 22,
        "deletions": 2
    }
}