{
    "author": "unstubbable",
    "message": "[dynamicIO] Use owner stacks for dynamic validation errors (#81277)\n\nWith recent improvements in React, and after switching to the React\nbuilds for Node.js in #81048, we can now generate better dynamic\nvalidation error stacks in dev mode by utilizing owner stacks instead of\ncomponent stacks.\n\nFor async I/O, we're using the owner stack exclusively. For sync I/O\nwe're appending the owner stack to the call stack. In a future iteration\nwe might instead log the original error as-is where it occurs, and let\n`patchErrorInspectNodeJS` handle the owner stack appending as a general\nsolution.\n\nAdditionally, we're now guiding users in the build-time error messages\nto using `next dev` for further debugging of dynamic validation errors â€“\nor, alternatively, using `next build --debug-prerender`.\n\ncloses NAR-149",
    "sha": "2d19dc626babcaf28665c270e1b58d717846bbb9",
    "files": [
        {
            "sha": "4f27fe10f6b3029fb4c4c6180c8aa10664cc399f",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -410,6 +410,14 @@ async function exportAppImpl(\n       authInterrupts: !!nextConfig.experimental.authInterrupts,\n     },\n     reactMaxHeadersLength: nextConfig.reactMaxHeadersLength,\n+    hasReadableErrorStacks:\n+      nextConfig.experimental.serverSourceMaps === true &&\n+      // TODO(NDX-531): Checking (and setting) the minify flags should be\n+      // unnecessary once name mapping is fixed.\n+      (process.env.TURBOPACK\n+        ? nextConfig.experimental.turbopackMinify === false\n+        : nextConfig.experimental.serverMinification === false) &&\n+      nextConfig.experimental.enablePrerenderSourceMaps === true,\n   }\n \n   const { publicRuntimeConfig } = nextConfig"
        },
        {
            "sha": "8515f4382ca139d74ea80208842264241b20d2eb",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 17,
            "deletions": 5,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -664,7 +664,7 @@ async function warmupDevRender(\n ): Promise<RenderResult> {\n   const {\n     clientReferenceManifest,\n-    componentMod,\n+    componentMod: ComponentMod,\n     getDynamicParamFromSegment,\n     implicitTags,\n     renderOpts,\n@@ -684,7 +684,7 @@ async function warmupDevRender(\n   }\n \n   const rootParams = getRootParams(\n-    componentMod.tree,\n+    ComponentMod.tree,\n     getDynamicParamFromSegment\n   )\n \n@@ -725,6 +725,7 @@ async function warmupDevRender(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash: req.cookies[NEXT_HMR_REFRESH_HASH_COOKIE],\n+    captureOwnerStack: ComponentMod.captureOwnerStack,\n   }\n \n   const rscPayload = await workUnitAsyncStorage.run(\n@@ -737,7 +738,7 @@ async function warmupDevRender(\n   // which contains the subset React.\n   workUnitAsyncStorage.run(\n     prerenderStore,\n-    componentMod.renderToReadableStream,\n+    ComponentMod.renderToReadableStream,\n     rscPayload,\n     clientReferenceManifest.clientModules,\n     {\n@@ -2309,6 +2310,9 @@ async function spawnDynamicValidationInDev(\n   // to cut the render off.\n   const cacheSignal = new CacheSignal()\n \n+  const captureOwnerStackClient = React.captureOwnerStack\n+  const captureOwnerStackServer = ComponentMod.captureOwnerStack\n+\n   // The resume data cache here should use a fresh instance as it's\n   // performing a fresh prerender. If we get to implementing the\n   // prerendering of an already prerendered page, we should use the passed\n@@ -2334,6 +2338,7 @@ async function spawnDynamicValidationInDev(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash,\n+    captureOwnerStack: captureOwnerStackServer,\n   }\n \n   // We're not going to use the result of this render because the only time it could be used\n@@ -2448,6 +2453,7 @@ async function spawnDynamicValidationInDev(\n       prerenderResumeDataCache,\n       renderResumeDataCache: null,\n       hmrRefreshHash: undefined,\n+      captureOwnerStack: captureOwnerStackClient,\n     }\n \n     const prerender = (\n@@ -2541,6 +2547,7 @@ async function spawnDynamicValidationInDev(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash,\n+    captureOwnerStack: captureOwnerStackServer,\n   }\n \n   const finalAttemptRSCPayload = await workUnitAsyncStorage.run(\n@@ -2611,6 +2618,7 @@ async function spawnDynamicValidationInDev(\n     prerenderResumeDataCache,\n     renderResumeDataCache: null,\n     hmrRefreshHash,\n+    captureOwnerStack: captureOwnerStackClient,\n   }\n \n   let dynamicValidation = createDynamicValidationState()\n@@ -2643,7 +2651,7 @@ async function spawnDynamicValidationInDev(\n                   const componentStack = errorInfo.componentStack\n                   if (typeof componentStack === 'string') {\n                     trackAllowedDynamicAccess(\n-                      workStore.route,\n+                      workStore,\n                       componentStack,\n                       dynamicValidation,\n                       clientDynamicTracking\n@@ -2957,6 +2965,7 @@ async function prerenderToStream(\n         prerenderResumeDataCache,\n         renderResumeDataCache,\n         hmrRefreshHash: undefined,\n+        captureOwnerStack: undefined, // Not available in production.\n       })\n \n       // We're not going to use the result of this render because the only time it could be used\n@@ -3064,6 +3073,7 @@ async function prerenderToStream(\n           prerenderResumeDataCache,\n           renderResumeDataCache,\n           hmrRefreshHash: undefined,\n+          captureOwnerStack: undefined, // Not available in production.\n         }\n \n         const prerender = (\n@@ -3157,6 +3167,7 @@ async function prerenderToStream(\n         prerenderResumeDataCache,\n         renderResumeDataCache,\n         hmrRefreshHash: undefined,\n+        captureOwnerStack: undefined, // Not available in production.\n       })\n \n       const finalAttemptRSCPayload = await workUnitAsyncStorage.run(\n@@ -3229,6 +3240,7 @@ async function prerenderToStream(\n         prerenderResumeDataCache,\n         renderResumeDataCache,\n         hmrRefreshHash: undefined,\n+        captureOwnerStack: undefined, // Not available in production.\n       }\n \n       let clientIsDynamic = false\n@@ -3265,7 +3277,7 @@ async function prerenderToStream(\n                     ).componentStack\n                     if (typeof componentStack === 'string') {\n                       trackAllowedDynamicAccess(\n-                        workStore.route,\n+                        workStore,\n                         componentStack,\n                         dynamicValidation,\n                         clientDynamicTracking"
        },
        {
            "sha": "e74d006948a56c9cf3181a4f5aa14ad10e5da719",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 34,
            "deletions": 10,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -616,7 +616,7 @@ const hasViewportRegex = new RegExp(\n const hasOutletRegex = new RegExp(`\\\\n\\\\s+at ${OUTLET_BOUNDARY_NAME}[\\\\n\\\\s]`)\n \n export function trackAllowedDynamicAccess(\n-  route: string,\n+  workStore: WorkStore,\n   componentStack: string,\n   dynamicValidation: DynamicValidationState,\n   clientDynamic: DynamicTrackingState\n@@ -648,19 +648,25 @@ export function trackAllowedDynamicAccess(\n     )\n     return\n   } else {\n-    const message = `Route \"${route}\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense`\n-    const error = createErrorWithComponentStack(message, componentStack)\n+    const message = `Route \"${workStore.route}\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense`\n+    const error = createErrorWithComponentOrOwnerStack(message, componentStack)\n     dynamicValidation.dynamicErrors.push(error)\n     return\n   }\n }\n \n-function createErrorWithComponentStack(\n+/**\n+ * In dev mode, we prefer using the owner stack, otherwise the provided\n+ * component stack is used.\n+ */\n+function createErrorWithComponentOrOwnerStack(\n   message: string,\n   componentStack: string\n ) {\n+  const ownerStack =\n+    process.env.NODE_ENV !== 'production' ? React.captureOwnerStack() : null\n   const error = new Error(message)\n-  error.stack = 'Error: ' + message + componentStack\n+  error.stack = error.name + ': ' + message + (ownerStack ?? componentStack)\n   return error\n }\n \n@@ -670,14 +676,30 @@ export enum PreludeState {\n   Errored = 2,\n }\n \n+function logDisallowedDynamicError(workStore: WorkStore, error: Error): void {\n+  console.error(error)\n+\n+  if (!workStore.dev) {\n+    if (workStore.hasReadableErrorStacks) {\n+      console.error(\n+        `To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"${workStore.route}\" in your browser to investigate the error.`\n+      )\n+    } else {\n+      console.error(`To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+  - Start the app in development mode by running \\`next dev\\`, then open \"${workStore.route}\" in your browser to investigate the error.\n+  - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.`)\n+    }\n+  }\n+}\n+\n export function throwIfDisallowedDynamic(\n   workStore: WorkStore,\n   prelude: PreludeState,\n   dynamicValidation: DynamicValidationState,\n   serverDynamic: DynamicTrackingState\n ): void {\n   if (workStore.invalidDynamicUsageError) {\n-    console.error(workStore.invalidDynamicUsageError)\n+    logDisallowedDynamicError(workStore, workStore.invalidDynamicUsageError)\n     throw new StaticGenBailoutError()\n   }\n \n@@ -692,9 +714,11 @@ export function throwIfDisallowedDynamic(\n     if (serverDynamic.syncDynamicErrorWithStack) {\n       // There is no shell and the server did something sync dynamic likely\n       // leading to an early termination of the prerender before the shell\n-      // could be completed.\n-      console.error(serverDynamic.syncDynamicErrorWithStack)\n-      // We terminate the build/validating render\n+      // could be completed. We terminate the build/validating render.\n+      logDisallowedDynamicError(\n+        workStore,\n+        serverDynamic.syncDynamicErrorWithStack\n+      )\n       throw new StaticGenBailoutError()\n     }\n \n@@ -704,7 +728,7 @@ export function throwIfDisallowedDynamic(\n     const dynamicErrors = dynamicValidation.dynamicErrors\n     if (dynamicErrors.length > 0) {\n       for (let i = 0; i < dynamicErrors.length; i++) {\n-        console.error(dynamicErrors[i])\n+        logDisallowedDynamicError(workStore, dynamicErrors[i])\n       }\n \n       throw new StaticGenBailoutError()"
        },
        {
            "sha": "4a28c196a8a5fb329bf748be78fc74ea7f85204f",
            "filename": "packages/next/src/server/app-render/entry-base.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fentry-base.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -10,6 +10,9 @@ export {\n // eslint-disable-next-line import/no-extraneous-dependencies\n export { unstable_prerender as prerender } from 'react-server-dom-webpack/static'\n \n+// eslint-disable-next-line import/no-extraneous-dependencies\n+export { captureOwnerStack } from 'react'\n+\n export { default as LayoutRouter } from '../../client/components/layout-router'\n export { default as RenderFromTemplateContext } from '../../client/components/render-from-template-context'\n export { workAsyncStorage } from '../app-render/work-async-storage.external'"
        },
        {
            "sha": "244ef349db20454c32bc2f4b4ffd68fadc0a6960",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -263,6 +263,14 @@ export interface RenderOptsPartial {\n    */\n   isDebugDynamicAccesses?: boolean\n \n+  /**\n+   * This is true when:\n+   * - source maps are generated\n+   * - source maps are applied\n+   * - minification is disabled\n+   */\n+  hasReadableErrorStacks?: boolean\n+\n   /**\n    * The maximum length of the headers that are emitted by React and added to\n    * the response."
        },
        {
            "sha": "fc7fe25b3c4043b8d253043d6d058c141410cc61",
            "filename": "packages/next/src/server/app-render/work-async-storage.external.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-async-storage.external.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -36,6 +36,15 @@ export interface WorkStore {\n \n   readonly isOnDemandRevalidate?: boolean\n   readonly isBuildTimePrerendering?: boolean\n+\n+  /**\n+   * This is true when:\n+   * - source maps are generated\n+   * - source maps are applied\n+   * - minification is disabled\n+   */\n+  readonly hasReadableErrorStacks?: boolean\n+\n   readonly isRevalidate?: boolean\n \n   forceDynamic?: boolean"
        },
        {
            "sha": "619813f5f2b67fb1a629344224209bf2652520f4",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -142,6 +142,11 @@ export interface PrerenderStoreModern extends CommonWorkUnitStore {\n    * subsequent dynamic render.\n    */\n   readonly hmrRefreshHash: string | undefined\n+\n+  /**\n+   * Only available in dev mode.\n+   */\n+  readonly captureOwnerStack: undefined | (() => string | null)\n }\n \n export interface PrerenderStorePPR extends CommonWorkUnitStore {"
        },
        {
            "sha": "8c1c16cd8598b18c73310ea5af9e29be78c88876",
            "filename": "packages/next/src/server/async-storage/work-store.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fwork-store.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -65,6 +65,7 @@ export type WorkStoreContext = {\n     | 'isDraftMode'\n     | 'isDebugDynamicAccesses'\n     | 'dev'\n+    | 'hasReadableErrorStacks'\n   > &\n     RequestLifecycleOpts &\n     Partial<Pick<RenderOpts, 'reactLoadableManifest'>>\n@@ -123,6 +124,7 @@ export function createWorkStore({\n     cacheLifeProfiles: renderOpts.cacheLifeProfiles,\n     isRevalidate: renderOpts.isRevalidate,\n     isBuildTimePrerendering: renderOpts.nextExport,\n+    hasReadableErrorStacks: renderOpts.hasReadableErrorStacks,\n     fetchCache: renderOpts.fetchCache,\n     isOnDemandRevalidate: renderOpts.isOnDemandRevalidate,\n "
        },
        {
            "sha": "4fcdb2500ca946365f25bf1e42d1eeb50b851974",
            "filename": "packages/next/src/server/node-environment-extensions/utils.tsx",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Futils.tsx?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -44,8 +44,22 @@ export function io(expression: string, type: ApiType) {\n                 'Unknown expression type in abortOnSynchronousPlatformIOAccess.'\n               )\n           }\n+\n           const errorWithStack = new Error(message)\n \n+          if (process.env.NODE_ENV !== 'production') {\n+            const ownerStack = workUnitStore.captureOwnerStack!()\n+\n+            if (ownerStack) {\n+              // TODO: Instead of stitching the stacks here, we should log the\n+              // original error as-is when it occurs (i.e. here), and let\n+              // `patchErrorInspect` handle adding the owner stack, instead of\n+              // logging it deferred in the `LogSafely` component via\n+              // `throwIfDisallowedDynamic`.\n+              applyOwnerStack(errorWithStack, ownerStack)\n+            }\n+          }\n+\n           abortOnSynchronousPlatformIOAccess(\n             workStore.route,\n             expression,\n@@ -63,3 +77,23 @@ export function io(expression: string, type: ApiType) {\n     }\n   }\n }\n+\n+function applyOwnerStack(error: Error, ownerStack: string) {\n+  let stack = ownerStack\n+\n+  if (error.stack) {\n+    const frames: string[] = []\n+\n+    for (const frame of error.stack.split('\\n').slice(1)) {\n+      if (frame.includes('react_stack_bottom_frame')) {\n+        break\n+      }\n+\n+      frames.push(frame)\n+    }\n+\n+    stack = '\\n' + frames.join('\\n') + stack\n+  }\n+\n+  error.stack = error.name + ': ' + error.message + stack\n+}"
        },
        {
            "sha": "d6a72b79150944d3dfa73f9c6da726cacd5e4986",
            "filename": "packages/next/src/server/route-modules/app-route/module.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fapp-route%2Fmodule.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -401,6 +401,7 @@ export class AppRouteRouteModule extends RouteModule<\n               prerenderResumeDataCache: null,\n               renderResumeDataCache: null,\n               hmrRefreshHash: undefined,\n+              captureOwnerStack: undefined,\n             })\n \n           let prospectiveResult\n@@ -492,6 +493,7 @@ export class AppRouteRouteModule extends RouteModule<\n             prerenderResumeDataCache: null,\n             renderResumeDataCache: null,\n             hmrRefreshHash: undefined,\n+            captureOwnerStack: undefined,\n           })\n \n           let responseHandled = false"
        },
        {
            "sha": "62db66b5b0262e03f9980e041ac405bad794f1b6",
            "filename": "test/development/app-dir/dynamic-io-dev-errors/dynamic-io-dev-errors.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 26,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fdynamic-io-dev-errors%2Fdynamic-io-dev-errors.test.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -12,6 +12,9 @@ describe('Dynamic IO Dev Errors', () => {\n   it('should show a red box error on the SSR render', async () => {\n     const browser = await next.browser('/error')\n \n+    // TODO(veil): The \"Page <anonymous>\" frame should be omitted.\n+    // Interestingly, it only appears on initial load, and not when\n+    // soft-navigating to the page (see test below).\n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n        \"description\": \"Route \"/error\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\",\n@@ -22,6 +25,7 @@ describe('Dynamic IO Dev Errors', () => {\n          |                       ^\",\n        \"stack\": [\n          \"Page app/error/page.tsx (2:23)\",\n+         \"Page <anonymous>\",\n          \"LogSafely <anonymous>\",\n        ],\n      }\n@@ -87,33 +91,25 @@ describe('Dynamic IO Dev Errors', () => {\n       expect(normalizedCliOutput).toContain(\n         `\\nError: Route \"/no-accessed-data\": ` +\n           `A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. ` +\n-          `We don't have the exact line number added to error messages yet but you can see which component in the stack below. ` +\n           `See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense` +\n-          (isTurbopack\n-            ? '\\n    at Page (<FIXME-file-protocol>/app/no-accessed-data/page.js:1:30)' +\n-              '\\n    at main (<anonymous>)' +\n-              '\\n    at body (<anonymous>)' +\n-              '\\n    at html (<anonymous>)' +\n-              '\\n    at Root [Server] (<anonymous>)' +\n-              '\\n> 1 | export default async function Page() {' +\n-              '\\n    |                              ^' +\n-              '\\n  2 |   await new Promise((r) => setTimeout(r, 200))'\n-            : '\\n    at Page (app/no-accessed-data/page.js:1:30)' +\n-              // TODO(veil): Should be ignore-listed (see https://linear.app/vercel/issue/NDX-464/next-internals-not-ignore-listed-in-terminal-in-webpack#comment-1164a36a)\n-              '\\n    at InnerLayoutRouter (..')\n+          '\\n    at Page (<FIXME-file-protocol>/app/no-accessed-data/page.js:1:30)' +\n+          '\\n> 1 | export default async function Page() {' +\n+          '\\n    |                              ^' +\n+          '\\n  2 |   await new Promise((r) => setTimeout(r, 200))' +\n+          '\\n  3 |   return <p>Page</p>' +\n+          '\\n  4 | }'\n       )\n+\n+      // TODO(veil): Source mapping breaks due to double-encoding of the square\n+      // brackets.\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n-         \"description\": \"Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+         \"description\": \"Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n          \"source\": null,\n          \"stack\": [\n            \"<FIXME-file-protocol>\",\n-           \"main <anonymous>\",\n-           \"body <anonymous>\",\n-           \"html <anonymous>\",\n-           \"Root [Server] <anonymous>\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -122,26 +118,25 @@ describe('Dynamic IO Dev Errors', () => {\n       expect(stripAnsi(next.cliOutput.slice(outputIndex))).toContain(\n         `\\nError: Route \"/no-accessed-data\": ` +\n           `A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. ` +\n-          `We don't have the exact line number added to error messages yet but you can see which component in the stack below. ` +\n           `See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense` +\n           '\\n    at Page (app/no-accessed-data/page.js:1:30)' +\n-          // TODO(veil): Should be ignore-listed (see https://linear.app/vercel/issue/NDX-464/next-internals-not-ignore-listed-in-terminal-in-webpack#comment-1164a36a)\n-          '\\n    at InnerLayoutRouter (..'\n+          '\\n> 1 | export default async function Page() {' +\n+          '\\n    |                              ^' +\n+          '\\n  2 |   await new Promise((r) => setTimeout(r, 200))' +\n+          '\\n  3 |   return <p>Page</p>' +\n+          '\\n  4 | }'\n       )\n+\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n-         \"description\": \"Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+         \"description\": \"Route \"/no-accessed-data\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n          \"source\": \"app/no-accessed-data/page.js (1:31) @ Page\n        > 1 | export default async function Page() {\n            |                               ^\",\n          \"stack\": [\n            \"Page app/no-accessed-data/page.js (1:31)\",\n-           \"main <anonymous>\",\n-           \"body <anonymous>\",\n-           \"html <anonymous>\",\n-           \"Root [Server] <anonymous>\",\n            \"LogSafely <anonymous>\",\n          ],\n        }"
        },
        {
            "sha": "4eb64692412f88790c15ce4943b48b64ec42fa2b",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.platform-dynamic.test.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 20,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -74,11 +74,13 @@ describe.each(\n            \"description\": \"Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\",\n            \"environmentLabel\": \"Server\",\n            \"label\": \"Console Error\",\n-           \"source\": \"app/page.tsx (35:23) @ RandomReadingComponent\n-         > 35 |   const random = Math.random()\n-              |                       ^\",\n+           \"source\": \"app/page.tsx (32:15) @ getRandomNumber\n+         > 32 |   return Math.random()\n+              |               ^\",\n            \"stack\": [\n-             \"RandomReadingComponent app/page.tsx (35:23)\",\n+             \"getRandomNumber app/page.tsx (32:15)\",\n+             \"RandomReadingComponent app/page.tsx (40:18)\",\n+             \"Page app/page.tsx (18:11)\",\n              \"LogSafely <anonymous>\",\n            ],\n          }\n@@ -100,14 +102,16 @@ describe.each(\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-                 at RandomReadingComponent (turbopack:///[project]/app/page.tsx:35:22)\n-               33 |     use(new Promise((r) => process.nextTick(r)))\n-               34 |   }\n-             > 35 |   const random = Math.random()\n-                  |                      ^\n-               36 |   return (\n-               37 |     <div>\n-               38 |       <span id=\"rand\">{random}</span>\n+                 at getRandomNumber (turbopack:///[project]/app/page.tsx:32:14)\n+                 at RandomReadingComponent (turbopack:///[project]/app/page.tsx:40:17)\n+               30 |\n+               31 | function getRandomNumber() {\n+             > 32 |   return Math.random()\n+                  |              ^\n+               33 | }\n+               34 |\n+               35 | function RandomReadingComponent() {\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -117,6 +121,9 @@ describe.each(\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n                  at a (<next-dist-dir>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n@@ -125,14 +132,16 @@ describe.each(\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-                 at RandomReadingComponent (webpack:///app/page.tsx:35:22)\n-               33 |     use(new Promise((r) => process.nextTick(r)))\n-               34 |   }\n-             > 35 |   const random = Math.random()\n-                  |                      ^\n-               36 |   return (\n-               37 |     <div>\n-               38 |       <span id=\"rand\">{random}</span>\n+                 at getRandomNumber (webpack:///app/page.tsx:32:14)\n+                 at RandomReadingComponent (webpack:///app/page.tsx:40:17)\n+               30 |\n+               31 | function getRandomNumber() {\n+             > 32 |   return Math.random()\n+                  |              ^\n+               33 | }\n+               34 |\n+               35 | function RandomReadingComponent() {\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -142,6 +151,9 @@ describe.each(\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n                  at a (<next-dist-dir>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)"
        },
        {
            "sha": "a0cf69227cbe150d1118108438ead0c25c09142b",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.sync-attribution.test.ts",
            "status": "modified",
            "additions": 98,
            "deletions": 46,
            "changes": 144,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -70,20 +70,39 @@ describe.each(\n       it('should show a collapsed redbox error', async () => {\n         const browser = await next.browser('/')\n \n-        await expect(browser).toDisplayCollapsedRedbox(`\n-         {\n-           \"description\": \"Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n-           \"environmentLabel\": \"Server\",\n-           \"label\": \"Console Error\",\n-           \"source\": \"app/client.tsx (5:16) @ SyncIO\n-         > 5 |   const data = new Date().toISOString()\n-             |                ^\",\n-           \"stack\": [\n-             \"SyncIO app/client.tsx (5:16)\",\n-             \"LogSafely <anonymous>\",\n-           ],\n-         }\n-        `)\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/client.tsx (5:16) @ SyncIO\n+           > 5 |   const data = new Date().toISOString()\n+               |                ^\",\n+             \"stack\": [\n+               \"SyncIO app/client.tsx (5:16)\",\n+               \"<FIXME-file-protocol>\",\n+               \"LogSafely <anonymous>\",\n+             ],\n+           }\n+          `)\n+        } else {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/client.tsx (5:16) @ SyncIO\n+           > 5 |   const data = new Date().toISOString()\n+               |                ^\",\n+             \"stack\": [\n+               \"SyncIO app/client.tsx (5:16)\",\n+               \"Page app/page.tsx (22:9)\",\n+               \"LogSafely <anonymous>\",\n+             ],\n+           }\n+          `)\n+        }\n       })\n     } else {\n       it('should error the build with a reason related to sync IO access', async () => {\n@@ -109,6 +128,7 @@ describe.each(\n                6 |\n                7 |   return (\n                8 |     <main>\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -118,6 +138,9 @@ describe.each(\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n                  at a (<next-dist-dir>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n@@ -134,6 +157,7 @@ describe.each(\n                6 |\n                7 |   return (\n                8 |     <main>\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -143,6 +167,9 @@ describe.each(\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n                  at a (<next-dist-dir>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n@@ -170,44 +197,34 @@ describe.each(\n       it('should show a collapsed redbox error', async () => {\n         const browser = await next.browser('/')\n \n+        // TODO(veil): Source mapping breaks due to double-encoding of the\n+        // square brackets.\n         if (isTurbopack) {\n           await expect(browser).toDisplayCollapsedRedbox(`\n            {\n-             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n              \"environmentLabel\": \"Server\",\n              \"label\": \"Console Error\",\n              \"source\": null,\n              \"stack\": [\n                \"<FIXME-file-protocol>\",\n-               \"section <anonymous>\",\n-               \"main <anonymous>\",\n                \"<FIXME-file-protocol>\",\n-               \"main <anonymous>\",\n-               \"body <anonymous>\",\n-               \"html <anonymous>\",\n-               \"Root [Server] <anonymous>\",\n                \"LogSafely <anonymous>\",\n              ],\n            }\n           `)\n         } else {\n           await expect(browser).toDisplayCollapsedRedbox(`\n            {\n-             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n              \"environmentLabel\": \"Server\",\n              \"label\": \"Console Error\",\n              \"source\": \"app/page.tsx (33:16) @ RequestData\n            > 33 | async function RequestData() {\n                 |                ^\",\n              \"stack\": [\n                \"RequestData app/page.tsx (33:16)\",\n-               \"section <anonymous>\",\n-               \"main <anonymous>\",\n                \"Page app/page.tsx (27:9)\",\n-               \"main <anonymous>\",\n-               \"body <anonymous>\",\n-               \"html <anonymous>\",\n-               \"Root [Server] <anonymous>\",\n                \"LogSafely <anonymous>\",\n              ],\n            }\n@@ -229,21 +246,22 @@ describe.each(\n         if (isTurbopack) {\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at section (<anonymous>)\n                  at main (<anonymous>)\n                  at RenderFromTemplateContext (<anonymous>)\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n              \t/page: /\"\n             `)\n           } else {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at a (<anonymous>)\n                  at main (<anonymous>)\n                  at b (<next-dist-dir>)\n@@ -260,14 +278,17 @@ describe.each(\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n           }\n         } else {\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at section (<anonymous>)\n                  at main (<anonymous>)\n                  at InnerLayoutRouter (webpack://<next-src>)\n@@ -291,14 +312,15 @@ describe.each(\n                335 |   segmentPath,\n                336 |   cacheNode,\n                337 |   url,\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n              \t/page: /\"\n             `)\n           } else {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at a (<anonymous>)\n                  at main (<anonymous>)\n                  at b (<next-dist-dir>)\n@@ -315,6 +337,9 @@ describe.each(\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n@@ -342,20 +367,39 @@ describe.each(\n       it('should show a collapsed redbox error', async () => {\n         const browser = await next.browser('/')\n \n-        await expect(browser).toDisplayCollapsedRedbox(`\n-         {\n-           \"description\": \"Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n-           \"environmentLabel\": \"Server\",\n-           \"label\": \"Console Error\",\n-           \"source\": \"app/client.tsx (5:16) @ SyncIO\n-         > 5 |   const data = new Date().toISOString()\n-             |                ^\",\n-           \"stack\": [\n-             \"SyncIO app/client.tsx (5:16)\",\n-             \"LogSafely <anonymous>\",\n-           ],\n-         }\n-        `)\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/client.tsx (5:16) @ SyncIO\n+           > 5 |   const data = new Date().toISOString()\n+               |                ^\",\n+             \"stack\": [\n+               \"SyncIO app/client.tsx (5:16)\",\n+               \"<FIXME-file-protocol>\",\n+               \"LogSafely <anonymous>\",\n+             ],\n+           }\n+          `)\n+        } else {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/client.tsx (5:16) @ SyncIO\n+           > 5 |   const data = new Date().toISOString()\n+               |                ^\",\n+             \"stack\": [\n+               \"SyncIO app/client.tsx (5:16)\",\n+               \"Page app/page.tsx (22:9)\",\n+               \"LogSafely <anonymous>\",\n+             ],\n+           }\n+          `)\n+        }\n       })\n     } else {\n       it('should error the build with a reason related to sync IO access', async () => {\n@@ -381,6 +425,7 @@ describe.each(\n                6 |\n                7 |   return (\n                8 |     <main>\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -390,6 +435,9 @@ describe.each(\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n                  at a (<next-dist-dir>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n@@ -406,6 +454,7 @@ describe.each(\n                6 |\n                7 |   return (\n                8 |     <main>\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n@@ -415,6 +464,9 @@ describe.each(\n             expect(output).toMatchInlineSnapshot(`\n              \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n                  at a (<next-dist-dir>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)"
        },
        {
            "sha": "4c15c3dbe78621a1646b0754bfd900dd1da86deb",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 49,
            "deletions": 49,
            "changes": 98,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -119,27 +119,25 @@ describe.each(\n         const browser = await next.browser('/')\n \n         if (isTurbopack) {\n+          // TODO(veil): Source mapping breaks due to double-encoding of the\n+          // square brackets.\n           await expect(browser).toDisplayCollapsedRedbox(`\n            {\n-             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n              \"environmentLabel\": \"Server\",\n              \"label\": \"Console Error\",\n              \"source\": null,\n              \"stack\": [\n                \"<FIXME-file-protocol>\",\n                \"<FIXME-file-protocol>\",\n-               \"main <anonymous>\",\n-               \"body <anonymous>\",\n-               \"html <anonymous>\",\n-               \"Root [Server] <anonymous>\",\n                \"LogSafely <anonymous>\",\n              ],\n            }\n           `)\n         } else {\n           await expect(browser).toDisplayCollapsedRedbox(`\n            {\n-             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n              \"environmentLabel\": \"Server\",\n              \"label\": \"Console Error\",\n              \"source\": \"app/page.tsx (20:16) @ Dynamic\n@@ -148,10 +146,6 @@ describe.each(\n              \"stack\": [\n                \"Dynamic app/page.tsx (20:16)\",\n                \"Page app/page.tsx (15:7)\",\n-               \"main <anonymous>\",\n-               \"body <anonymous>\",\n-               \"html <anonymous>\",\n-               \"Root [Server] <anonymous>\",\n                \"LogSafely <anonymous>\",\n              ],\n            }\n@@ -174,18 +168,19 @@ describe.each(\n         if (isTurbopack) {\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n              \t/page: /\"\n             `)\n           } else {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at a (<next-dist-dir>)\n                  at b (<next-dist-dir>)\n                  at c (<next-dist-dir>)\n@@ -200,14 +195,17 @@ describe.each(\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n           }\n         } else {\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at InnerLayoutRouter (webpack://<next-src>)\n                  at RedirectErrorBoundary (webpack://<next-src>)\n                  at RedirectBoundary (webpack://<next-src>)\n@@ -229,14 +227,15 @@ describe.each(\n                335 |   segmentPath,\n                336 |   cacheNode,\n                337 |   url,\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n              \t/page: /\"\n             `)\n           } else {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at a (<next-dist-dir>)\n                  at b (<next-dist-dir>)\n                  at c (<next-dist-dir>)\n@@ -251,6 +250,9 @@ describe.each(\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n@@ -569,38 +571,29 @@ describe.each(\n         const browser = await next.browser('/')\n \n         if (isTurbopack) {\n+          // TODO(veil): Source mapping breaks due to double-encoding of the\n+          // square brackets.\n           await expect(browser).toDisplayCollapsedRedbox(`\n            [\n              {\n-               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n                \"environmentLabel\": \"Server\",\n                \"label\": \"Console Error\",\n-               \"source\": \"app/indirection.tsx (7:34) @ IndirectionTwo\n-           >  7 | export function IndirectionTwo({ children }) {\n-                |                                  ^\",\n+               \"source\": null,\n                \"stack\": [\n                  \"<FIXME-file-protocol>\",\n-                 \"IndirectionTwo app/indirection.tsx (7:34)\",\n                  \"<FIXME-file-protocol>\",\n-                 \"main <anonymous>\",\n-                 \"body <anonymous>\",\n-                 \"html <anonymous>\",\n-                 \"Root [Server] <anonymous>\",\n                  \"LogSafely <anonymous>\",\n                ],\n              },\n              {\n-               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n                \"environmentLabel\": \"Server\",\n                \"label\": \"Console Error\",\n                \"source\": null,\n                \"stack\": [\n                  \"<FIXME-file-protocol>\",\n                  \"<FIXME-file-protocol>\",\n-                 \"main <anonymous>\",\n-                 \"body <anonymous>\",\n-                 \"html <anonymous>\",\n-                 \"Root [Server] <anonymous>\",\n                  \"LogSafely <anonymous>\",\n                ],\n              },\n@@ -610,37 +603,28 @@ describe.each(\n           await expect(browser).toDisplayCollapsedRedbox(`\n            [\n              {\n-               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n                \"environmentLabel\": \"Server\",\n                \"label\": \"Console Error\",\n                \"source\": \"app/page.tsx (35:16) @ FetchingComponent\n            > 35 | async function FetchingComponent({\n                 |                ^\",\n                \"stack\": [\n                  \"FetchingComponent app/page.tsx (35:16)\",\n-                 \"IndirectionTwo app/indirection.tsx (7:34)\",\n-                 \"Page app/page.tsx (16:9)\",\n-                 \"main <anonymous>\",\n-                 \"body <anonymous>\",\n-                 \"html <anonymous>\",\n-                 \"Root [Server] <anonymous>\",\n+                 \"Page app/page.tsx (22:9)\",\n                  \"LogSafely <anonymous>\",\n                ],\n              },\n              {\n-               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n                \"environmentLabel\": \"Server\",\n                \"label\": \"Console Error\",\n                \"source\": \"app/page.tsx (35:16) @ FetchingComponent\n            > 35 | async function FetchingComponent({\n                 |                ^\",\n                \"stack\": [\n                  \"FetchingComponent app/page.tsx (35:16)\",\n-                 \"Page app/page.tsx (16:9)\",\n-                 \"main <anonymous>\",\n-                 \"body <anonymous>\",\n-                 \"html <anonymous>\",\n-                 \"Root [Server] <anonymous>\",\n+                 \"Page app/page.tsx (27:7)\",\n                  \"LogSafely <anonymous>\",\n                ],\n              },\n@@ -663,7 +647,7 @@ describe.each(\n         if (isTurbopack) {\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at IndirectionTwo (turbopack:///[project]/app/indirection.tsx:7:33)\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n@@ -675,18 +659,20 @@ describe.each(\n                 8 |   return children\n                 9 | }\n                10 |\n-             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n              \t/page: /\"\n             `)\n           } else {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at a (<next-dist-dir>)\n                  at b (<next-dist-dir>)\n                  at c (<next-dist-dir>)\n@@ -702,7 +688,10 @@ describe.each(\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n-             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at m (<next-dist-dir>)\n                  at n (<next-dist-dir>)\n                  at o (<next-dist-dir>)\n@@ -717,14 +706,17 @@ describe.each(\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)\n           }\n         } else {\n           if (inPrerenderDebugMode) {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at IndirectionTwo (webpack:///app/indirection.tsx:7:33)\n                  at InnerLayoutRouter (webpack://<next-src>)\n                  at RedirectErrorBoundary (webpack://<next-src>)\n@@ -747,7 +739,8 @@ describe.each(\n                 8 |   return children\n                 9 | }\n                10 |\n-             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at InnerLayoutRouter (webpack://<next-src>)\n                  at RedirectErrorBoundary (webpack://<next-src>)\n                  at RedirectBoundary (webpack://<next-src>)\n@@ -769,14 +762,15 @@ describe.each(\n                335 |   segmentPath,\n                336 |   cacheNode,\n                337 |   url,\n+             To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n              > Export encountered errors on following paths:\n              \t/page: /\"\n             `)\n           } else {\n             expect(output).toMatchInlineSnapshot(`\n-             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at a (<next-dist-dir>)\n                  at b (<next-dist-dir>)\n                  at c (<next-dist-dir>)\n@@ -792,7 +786,10 @@ describe.each(\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n-             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n                  at m (<next-dist-dir>)\n                  at n (<next-dist-dir>)\n                  at o (<next-dist-dir>)\n@@ -807,6 +804,9 @@ describe.each(\n                  at main (<anonymous>)\n                  at body (<anonymous>)\n                  at html (<anonymous>)\n+             To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+               - Start the app in development mode by running \\`next dev\\`, then open \"/\" in your browser to investigate the error.\n+               - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n              Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n              Export encountered an error on /page: /, exiting the build.\"\n             `)"
        },
        {
            "sha": "8b41ce29e73fdc72b0a043935a8b0d1f662c0f11",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/sync-random-without-fallback/app/page.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-without-fallback%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-without-fallback%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fsync-random-without-fallback%2Fapp%2Fpage.tsx?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -28,11 +28,17 @@ export default async function Page(props: {\n   )\n }\n \n+function getRandomNumber() {\n+  return Math.random()\n+}\n+\n function RandomReadingComponent() {\n   if (typeof window === 'undefined') {\n     use(new Promise((r) => process.nextTick(r)))\n   }\n-  const random = Math.random()\n+\n+  const random = getRandomNumber()\n+\n   return (\n     <div>\n       <span id=\"rand\">{random}</span>"
        },
        {
            "sha": "771259ffacbdac7f938da3e15d2d6ecc649238fe",
            "filename": "test/production/app-dir/build-output-prerender/build-output-prerender.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2d19dc626babcaf28665c270e1b58d717846bbb9/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts?ref=2d19dc626babcaf28665c270e1b58d717846bbb9",
            "patch": "@@ -31,13 +31,19 @@ describe('build-output-prerender', () => {\n         expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n          \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n              at x (<next-dist-dir>)\n+         To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+           - Start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n+           - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n          Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n          Export encountered an error on /client/page: /client, exiting the build.\"\n         `)\n       } else {\n         expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n          \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n              at x (<next-dist-dir>)\n+         To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+           - Start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n+           - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n          Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n          Export encountered an error on /client/page: /client, exiting the build.\"\n         `)\n@@ -91,6 +97,7 @@ describe('build-output-prerender', () => {\n              |                           ^\n            5 | }\n            6 |\n+         To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n          Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n          Error: Route \"/server\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n              at Page (turbopack:///[project]/app/server/page.tsx:13:26)\n@@ -100,6 +107,7 @@ describe('build-output-prerender', () => {\n               |                          ^\n            14 | }\n            15 |\n+         To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/server\" in your browser to investigate the error.\n          Error occurred prerendering page \"/server\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n          > Export encountered errors on following paths:\n@@ -116,6 +124,7 @@ describe('build-output-prerender', () => {\n              |                           ^\n            5 | }\n            6 |\n+         To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n          Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n          Error: Route \"/server\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n              at Page (webpack:///app/server/page.tsx:13:26)\n@@ -125,6 +134,7 @@ describe('build-output-prerender', () => {\n               |                          ^\n            14 | }\n            15 |\n+         To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/server\" in your browser to investigate the error.\n          Error occurred prerendering page \"/server\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n          > Export encountered errors on following paths:"
        }
    ],
    "stats": {
        "total": 496,
        "additions": 339,
        "deletions": 157
    }
}