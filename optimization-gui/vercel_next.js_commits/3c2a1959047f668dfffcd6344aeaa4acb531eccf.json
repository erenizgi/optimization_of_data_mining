{
    "author": "unstubbable",
    "message": "Also enforce experimental features when there's no next config file (#81679)\n\nWhen running `next build --debug-prerender`, we also want to set the experimental features even if there is no next.config.js file present.\r\n\r\nThis PR also fixes the `cloneObject` function to better handle nested optional object properties, and we're now also freezing and cloning the default config before applying changes to it.\r\n\r\n> [!NOTE]  \r\n> This PR is best reviewed with hidden whitespace changes.",
    "sha": "3c2a1959047f668dfffcd6344aeaa4acb531eccf",
    "files": [
        {
            "sha": "0edd9e88a24ef98685028d22180c7e4830f18d05",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "patch": "@@ -1283,7 +1283,7 @@ export interface NextConfig extends Record<string, any> {\n   htmlLimitedBots?: RegExp\n }\n \n-export const defaultConfig = {\n+export const defaultConfig = Object.freeze({\n   env: {},\n   webpack: null,\n   eslint: {\n@@ -1503,7 +1503,7 @@ export const defaultConfig = {\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,\n-} satisfies NextConfig\n+} satisfies NextConfig)\n \n export async function normalizeConfig(phase: string, config: any) {\n   if (typeof config === 'function') {"
        },
        {
            "sha": "37004c7a936cc4c0591183e98cbea7d72ce120c5",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 130,
            "deletions": 62,
            "changes": 192,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "patch": "@@ -1227,6 +1227,7 @@ export default async function loadConfig(\n   }\n \n   const path = await findUp(CONFIG_FILES, { cwd: dir })\n+  const configuredExperimentalFeatures: ConfiguredExperimentalFeature[] = []\n \n   // If config file was found\n   if (path?.length) {\n@@ -1280,8 +1281,6 @@ export default async function loadConfig(\n       )) as NextConfig\n     )\n \n-    const configuredExperimentalFeatures: ConfiguredExperimentalFeature[] = []\n-\n     if (reportExperimentalFeatures && loadedConfig.experimental) {\n       for (const name of Object.keys(\n         loadedConfig.experimental\n@@ -1420,58 +1419,13 @@ export default async function loadConfig(\n       userConfig.htmlLimitedBots = userConfig.htmlLimitedBots.source\n     }\n \n-    if (\n-      userConfig.experimental &&\n-      userConfig.experimental.enablePrerenderSourceMaps === undefined &&\n-      userConfig.experimental.dynamicIO === true\n-    ) {\n-      userConfig.experimental.enablePrerenderSourceMaps = true\n-      addConfiguredExperimentalFeature(\n-        configuredExperimentalFeatures,\n-        'enablePrerenderSourceMaps',\n-        true,\n-        'enabled by `experimental.dynamicIO`'\n-      )\n-    }\n-\n-    if (\n-      debugPrerender &&\n-      (phase === PHASE_PRODUCTION_BUILD || phase === PHASE_EXPORT)\n-    ) {\n-      userConfig.experimental ??= {}\n-\n-      setExperimentalFeatureForDebugPrerender(\n-        userConfig.experimental,\n-        'serverSourceMaps',\n-        true,\n-        reportExperimentalFeatures ? configuredExperimentalFeatures : undefined\n-      )\n-\n-      setExperimentalFeatureForDebugPrerender(\n-        userConfig.experimental,\n-        process.env.TURBOPACK ? 'turbopackMinify' : 'serverMinification',\n-        false,\n-        reportExperimentalFeatures ? configuredExperimentalFeatures : undefined\n-      )\n-\n-      setExperimentalFeatureForDebugPrerender(\n-        userConfig.experimental,\n-        'enablePrerenderSourceMaps',\n-        true,\n-        reportExperimentalFeatures ? configuredExperimentalFeatures : undefined\n-      )\n-\n-      setExperimentalFeatureForDebugPrerender(\n-        userConfig.experimental,\n-        'prerenderEarlyExit',\n-        false,\n-        reportExperimentalFeatures ? configuredExperimentalFeatures : undefined\n-      )\n-    }\n-\n-    if (reportExperimentalFeatures) {\n-      reportExperimentalFeatures(configuredExperimentalFeatures)\n-    }\n+    enforceExperimentalFeatures(userConfig, {\n+      configuredExperimentalFeatures: reportExperimentalFeatures\n+        ? configuredExperimentalFeatures\n+        : undefined,\n+      debugPrerender,\n+      phase,\n+    })\n \n     const completeConfig = assignDefaults(\n       dir,\n@@ -1483,6 +1437,11 @@ export default async function loadConfig(\n       },\n       silent\n     ) as NextConfigComplete\n+\n+    if (reportExperimentalFeatures) {\n+      reportExperimentalFeatures(configuredExperimentalFeatures)\n+    }\n+\n     return await applyModifyConfig(completeConfig, phase, silent)\n   } else {\n     const configBaseName = basename(CONFIG_FILES[0], extname(CONFIG_FILES[0]))\n@@ -1506,14 +1465,30 @@ export default async function loadConfig(\n     }\n   }\n \n+  const clonedDefaultConfig = cloneObject(defaultConfig) as NextConfig\n+\n+  enforceExperimentalFeatures(clonedDefaultConfig, {\n+    configuredExperimentalFeatures: reportExperimentalFeatures\n+      ? configuredExperimentalFeatures\n+      : undefined,\n+    debugPrerender,\n+    phase,\n+  })\n+\n   // always call assignDefaults to ensure settings like\n   // reactRoot can be updated correctly even with no next.config.js\n   const completeConfig = assignDefaults(\n     dir,\n-    { ...defaultConfig, configFileName },\n+    { ...clonedDefaultConfig, configFileName },\n     silent\n   ) as NextConfigComplete\n+\n   setHttpClientAndAgentOptions(completeConfig)\n+\n+  if (reportExperimentalFeatures) {\n+    reportExperimentalFeatures(configuredExperimentalFeatures)\n+  }\n+\n   return await applyModifyConfig(completeConfig, phase, silent)\n }\n \n@@ -1523,7 +1498,70 @@ export type ConfiguredExperimentalFeature = {\n   reason?: string\n }\n \n-export function addConfiguredExperimentalFeature<\n+function enforceExperimentalFeatures(\n+  config: NextConfig,\n+  options: {\n+    configuredExperimentalFeatures: ConfiguredExperimentalFeature[] | undefined\n+    debugPrerender: boolean | undefined\n+    phase: string\n+  }\n+) {\n+  const { configuredExperimentalFeatures, debugPrerender, phase } = options\n+\n+  if (\n+    config.experimental &&\n+    config.experimental.enablePrerenderSourceMaps === undefined &&\n+    config.experimental.dynamicIO === true\n+  ) {\n+    config.experimental.enablePrerenderSourceMaps = true\n+\n+    if (configuredExperimentalFeatures) {\n+      addConfiguredExperimentalFeature(\n+        configuredExperimentalFeatures,\n+        'enablePrerenderSourceMaps',\n+        true,\n+        'enabled by `experimental.dynamicIO`'\n+      )\n+    }\n+  }\n+\n+  config.experimental ??= {}\n+\n+  if (\n+    debugPrerender &&\n+    (phase === PHASE_PRODUCTION_BUILD || phase === PHASE_EXPORT)\n+  ) {\n+    setExperimentalFeatureForDebugPrerender(\n+      config.experimental,\n+      'serverSourceMaps',\n+      true,\n+      configuredExperimentalFeatures\n+    )\n+\n+    setExperimentalFeatureForDebugPrerender(\n+      config.experimental,\n+      process.env.TURBOPACK ? 'turbopackMinify' : 'serverMinification',\n+      false,\n+      configuredExperimentalFeatures\n+    )\n+\n+    setExperimentalFeatureForDebugPrerender(\n+      config.experimental,\n+      'enablePrerenderSourceMaps',\n+      true,\n+      configuredExperimentalFeatures\n+    )\n+\n+    setExperimentalFeatureForDebugPrerender(\n+      config.experimental,\n+      'prerenderEarlyExit',\n+      false,\n+      configuredExperimentalFeatures\n+    )\n+  }\n+}\n+\n+function addConfiguredExperimentalFeature<\n   KeyType extends keyof ExperimentalConfig,\n >(\n   configuredExperimentalFeatures: ConfiguredExperimentalFeature[],\n@@ -1564,20 +1602,50 @@ function setExperimentalFeatureForDebugPrerender<\n }\n \n function cloneObject(obj: any): any {\n+  // Primitives & null\n   if (obj === null || typeof obj !== 'object') {\n     return obj\n   }\n \n+  // RegExp → clone via constructor\n+  if (obj instanceof RegExp) {\n+    return new RegExp(obj.source, obj.flags)\n+  }\n+\n+  // Function → just reuse the function reference\n+  if (typeof obj === 'function') {\n+    return obj\n+  }\n+\n+  // Arrays → map each element\n   if (Array.isArray(obj)) {\n     return obj.map(cloneObject)\n   }\n-  const keys = Object.keys(obj)\n-  if (keys.length === 0) {\n+\n+  // Detect non‑plain objects (class instances)\n+  const proto = Object.getPrototypeOf(obj)\n+  const isPlainObject = proto === Object.prototype || proto === null\n+\n+  // If it's not a plain object, just return the original\n+  if (!isPlainObject) {\n     return obj\n   }\n \n-  return keys.reduce((acc, key) => {\n-    ;(acc as any)[key] = cloneObject(obj[key])\n-    return acc\n-  }, {})\n+  // Plain object → create a new object with the same prototype\n+  // and copy all properties, cloning data properties and keeping\n+  // accessor properties (getters/setters) as‑is.\n+  const result = Object.create(proto)\n+  for (const key of Reflect.ownKeys(obj)) {\n+    const descriptor = Object.getOwnPropertyDescriptor(obj, key)\n+\n+    if (descriptor && (descriptor.get || descriptor.set)) {\n+      // Accessor property → copy descriptor as‑is (get/set functions)\n+      Object.defineProperty(result, key, descriptor)\n+    } else {\n+      // Data property → clone the value\n+      result[key] = cloneObject(obj[key])\n+    }\n+  }\n+\n+  return result\n }"
        },
        {
            "sha": "af0b7981a4df72adac47d0f8e298ca839fd91171",
            "filename": "test/production/app-dir/build-output-prerender/build-output-prerender.test.ts",
            "status": "modified",
            "additions": 198,
            "deletions": 138,
            "changes": 336,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "patch": "@@ -1,154 +1,214 @@\n import { nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n const { version: nextVersion } = require('next/package.json')\n \n describe('build-output-prerender', () => {\n-  describe('without --debug-prerender', () => {\n-    const { next, isTurbopack } = nextTestSetup({\n-      files: __dirname,\n-      skipStart: true,\n-    })\n+  describe('with a next config file', () => {\n+    describe('without --debug-prerender', () => {\n+      const { next, isTurbopack } = nextTestSetup({\n+        files: path.join(__dirname, 'fixtures/with-config-file'),\n+        skipStart: true,\n+      })\n+\n+      beforeAll(() => next.build())\n+\n+      it('prints only the user-selected experimental flags', async () => {\n+        if (isTurbopack) {\n+          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"▲ Next.js x.y.z (Turbopack)\n+              - Experiments (use with caution):\n+                ✓ dynamicIO\n+                ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+          `)\n+        } else {\n+          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"▲ Next.js x.y.z\n+              - Experiments (use with caution):\n+                ✓ dynamicIO\n+                ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+          `)\n+        }\n+      })\n \n-    beforeAll(() => next.build())\n-\n-    it('prints only the user-selected experimental flags', async () => {\n-      if (isTurbopack) {\n-        expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-         \"▲ Next.js x.y.z (Turbopack)\n-            - Experiments (use with caution):\n-              ✓ dynamicIO\n-              ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n-        `)\n-      } else {\n-        expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-         \"▲ Next.js x.y.z\n-            - Experiments (use with caution):\n-              ✓ dynamicIO\n-              ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n-        `)\n-      }\n+      it('shows only a single prerender error with a mangled stack', async () => {\n+        if (isTurbopack) {\n+          // TODO(veil): Why is the location incomplete unless we enable --no-mangling?\n+          expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at c (turbopack:///[project]/app/client/page.tsx:5:0)\n+             3 | export default function Page() {\n+             4 |   return <p>Current time: {new Date().toISOString()}</p>\n+           > 5 | }\n+             6 |\n+           To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+             - Start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n+             - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+           Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /client/page: /client, exiting the build.\"\n+          `)\n+        } else {\n+          expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at x (<next-dist-dir>)\n+           To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+             - Start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n+             - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+           Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Export encountered an error on /client/page: /client, exiting the build.\"\n+          `)\n+        }\n+      })\n     })\n \n-    it('shows only a single prerender error with a mangled stack', async () => {\n-      if (isTurbopack) {\n-        // TODO(veil): Why is the location incomplete unless we enable --no-mangling?\n-        expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-         \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-             at c (turbopack:///[project]/app/client/page.tsx:5:0)\n-           3 | export default function Page() {\n-           4 |   return <p>Current time: {new Date().toISOString()}</p>\n-         > 5 | }\n-           6 |\n-         To get a more detailed stack trace and pinpoint the issue, try one of the following:\n-           - Start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n-           - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n-         Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n-         Export encountered an error on /client/page: /client, exiting the build.\"\n-        `)\n-      } else {\n-        expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-         \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-             at x (<next-dist-dir>)\n-         To get a more detailed stack trace and pinpoint the issue, try one of the following:\n-           - Start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n-           - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n-         Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n-         Export encountered an error on /client/page: /client, exiting the build.\"\n-        `)\n-      }\n+    describe('with --debug-prerender', () => {\n+      const { next, isTurbopack } = nextTestSetup({\n+        files: path.join(__dirname, 'fixtures/with-config-file'),\n+        skipStart: true,\n+        buildArgs: ['--debug-prerender'],\n+      })\n+\n+      beforeAll(() => next.build())\n+\n+      it('prints a warning and the customized experimental flags', async () => {\n+        if (isTurbopack) {\n+          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+              ▲ Next.js x.y.z (Turbopack)\n+              - Experiments (use with caution):\n+                ✓ dynamicIO\n+                ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+          `)\n+        } else {\n+          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+              ▲ Next.js x.y.z\n+              - Experiments (use with caution):\n+                ✓ dynamicIO\n+                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n+          `)\n+        }\n+      })\n+\n+      it('shows all prerender errors with readable stacks and code frames', async () => {\n+        if (isTurbopack) {\n+          expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at Page (turbopack:///[project]/app/client/page.tsx:4:27)\n+             2 |\n+             3 | export default function Page() {\n+           > 4 |   return <p>Current time: {new Date().toISOString()}</p>\n+               |                           ^\n+             5 | }\n+             6 |\n+           To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n+           Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Error: Route \"/server\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+               at Page (turbopack:///[project]/app/server/page.tsx:13:26)\n+             11 |   await cachedDelay()\n+             12 |\n+           > 13 |   return <p>Random: {Math.random()}</p>\n+                |                          ^\n+             14 | }\n+             15 |\n+           To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/server\" in your browser to investigate the error.\n+           Error occurred prerendering page \"/server\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/client/page: /client\n+           \t/server/page: /server\"\n+          `)\n+        } else {\n+          expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+               at Page (webpack:///app/client/page.tsx:4:27)\n+             2 |\n+             3 | export default function Page() {\n+           > 4 |   return <p>Current time: {new Date().toISOString()}</p>\n+               |                           ^\n+             5 | }\n+             6 |\n+           To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n+           Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n+           Error: Route \"/server\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+               at Page (webpack:///app/server/page.tsx:13:26)\n+             11 |   await cachedDelay()\n+             12 |\n+           > 13 |   return <p>Random: {Math.random()}</p>\n+                |                          ^\n+             14 | }\n+             15 |\n+           To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/server\" in your browser to investigate the error.\n+           Error occurred prerendering page \"/server\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+           > Export encountered errors on following paths:\n+           \t/client/page: /client\n+           \t/server/page: /server\"\n+          `)\n+        }\n+      })\n     })\n   })\n \n-  describe('with --debug-prerender', () => {\n-    const { next, isTurbopack } = nextTestSetup({\n-      files: __dirname,\n-      skipStart: true,\n-      buildArgs: ['--debug-prerender'],\n-    })\n+  describe('without a next config file', () => {\n+    describe('without --debug-prerender', () => {\n+      const { next, isTurbopack } = nextTestSetup({\n+        files: path.join(__dirname, 'fixtures/without-config-file'),\n+        skipStart: true,\n+      })\n \n-    beforeAll(() => next.build())\n-\n-    it('prints a warning and the customized experimental flags', async () => {\n-      if (isTurbopack) {\n-        expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-         \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-            ▲ Next.js x.y.z (Turbopack)\n-            - Experiments (use with caution):\n-              ✓ dynamicIO\n-              ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n-              ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n-              ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n-              ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n-        `)\n-      } else {\n-        expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-         \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n-            ▲ Next.js x.y.z\n-            - Experiments (use with caution):\n-              ✓ dynamicIO\n-              ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n-              ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n-              ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n-              ✓ enablePrerenderSourceMaps (enabled by \\`experimental.dynamicIO\\`)\"\n-        `)\n-      }\n+      beforeAll(() => next.build())\n+\n+      it('prints no experimental flags', async () => {\n+        if (isTurbopack) {\n+          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n+            `\"▲ Next.js x.y.z (Turbopack)\"`\n+          )\n+        } else {\n+          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(\n+            `\"▲ Next.js x.y.z\"`\n+          )\n+        }\n+      })\n     })\n \n-    it('shows all prerender errors with readable stacks and code frames', async () => {\n-      if (isTurbopack) {\n-        expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-         \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-             at Page (turbopack:///[project]/app/client/page.tsx:4:27)\n-           2 |\n-           3 | export default function Page() {\n-         > 4 |   return <p>Current time: {new Date().toISOString()}</p>\n-             |                           ^\n-           5 | }\n-           6 |\n-         To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n-         Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n-         Error: Route \"/server\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-             at Page (turbopack:///[project]/app/server/page.tsx:13:26)\n-           11 |   await cachedDelay()\n-           12 |\n-         > 13 |   return <p>Random: {Math.random()}</p>\n-              |                          ^\n-           14 | }\n-           15 |\n-         To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/server\" in your browser to investigate the error.\n-         Error occurred prerendering page \"/server\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-         > Export encountered errors on following paths:\n-         \t/client/page: /client\n-         \t/server/page: /server\"\n-        `)\n-      } else {\n-        expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n-         \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-             at Page (webpack:///app/client/page.tsx:4:27)\n-           2 |\n-           3 | export default function Page() {\n-         > 4 |   return <p>Current time: {new Date().toISOString()}</p>\n-             |                           ^\n-           5 | }\n-           6 |\n-         To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/client\" in your browser to investigate the error.\n-         Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n-         Error: Route \"/server\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-             at Page (webpack:///app/server/page.tsx:13:26)\n-           11 |   await cachedDelay()\n-           12 |\n-         > 13 |   return <p>Random: {Math.random()}</p>\n-              |                          ^\n-           14 | }\n-           15 |\n-         To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/server\" in your browser to investigate the error.\n-         Error occurred prerendering page \"/server\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-         > Export encountered errors on following paths:\n-         \t/client/page: /client\n-         \t/server/page: /server\"\n-        `)\n-      }\n+    describe('with --debug-prerender', () => {\n+      const { next, isTurbopack } = nextTestSetup({\n+        files: path.join(__dirname, 'fixtures/without-config-file'),\n+        skipStart: true,\n+        buildArgs: ['--debug-prerender'],\n+      })\n+\n+      beforeAll(() => next.build())\n+\n+      it('prints a warning and the customized experimental flags', async () => {\n+        if (isTurbopack) {\n+          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+              ▲ Next.js x.y.z (Turbopack)\n+              - Experiments (use with caution):\n+                ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+          `)\n+        } else {\n+          expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+           \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+              ▲ Next.js x.y.z\n+              - Experiments (use with caution):\n+                ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+                ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+                ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+                ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+          `)\n+        }\n+      })\n     })\n   })\n })"
        },
        {
            "sha": "215f0bea40bf5e8c4ffe27615e5d00f5c27770fd",
            "filename": "test/production/app-dir/build-output-prerender/fixtures/with-config-file/app/client/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Fclient%2Fpage.tsx?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "previous_filename": "test/production/app-dir/build-output-prerender/app/client/page.tsx"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/production/app-dir/build-output-prerender/fixtures/with-config-file/app/layout.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Flayout.tsx?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "previous_filename": "test/production/app-dir/build-output-prerender/app/layout.tsx"
        },
        {
            "sha": "7659e2bdad2cfb56b6b52dd997fffceb34ac99ee",
            "filename": "test/production/app-dir/build-output-prerender/fixtures/with-config-file/app/server/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Fserver%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Fserver%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fapp%2Fserver%2Fpage.tsx?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "previous_filename": "test/production/app-dir/build-output-prerender/app/server/page.tsx"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/production/app-dir/build-output-prerender/fixtures/with-config-file/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwith-config-file%2Fnext.config.js?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "previous_filename": "test/production/app-dir/build-output-prerender/next.config.js"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/production/app-dir/build-output-prerender/fixtures/without-config-file/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwithout-config-file%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwithout-config-file%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwithout-config-file%2Fapp%2Flayout.tsx?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/production/app-dir/build-output-prerender/fixtures/without-config-file/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwithout-config-file%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3c2a1959047f668dfffcd6344aeaa4acb531eccf/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwithout-config-file%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Ffixtures%2Fwithout-config-file%2Fapp%2Fpage.tsx?ref=3c2a1959047f668dfffcd6344aeaa4acb531eccf",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        }
    ],
    "stats": {
        "total": 543,
        "additions": 341,
        "deletions": 202
    }
}