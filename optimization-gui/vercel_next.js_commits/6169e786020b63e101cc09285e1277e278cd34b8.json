{
    "author": "mischnic",
    "message": "Fix required-server-files (#86875)\n\nFixes a regression in https://github.com/vercel/next.js/pull/86830\r\n\r\n`config.distDir` was missing\r\n\r\n<img width=\"1622\" height=\"475\" alt=\"Bildschirmfoto 2025-12-05 um 17 50 43\" src=\"https://github.com/user-attachments/assets/6460801d-949e-441b-a7d3-6fb679f22d83\" />",
    "sha": "6169e786020b63e101cc09285e1277e278cd34b8",
    "files": [
        {
            "sha": "bf675296e11073eb53e0a11cc6e2dae430feb746",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/6169e786020b63e101cc09285e1277e278cd34b8/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6169e786020b63e101cc09285e1277e278cd34b8/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=6169e786020b63e101cc09285e1277e278cd34b8",
            "patch": "@@ -1931,17 +1931,22 @@ export default async function build(\n \n           if (hasInstrumentationHook) {\n             serverFilesManifest.files.push(\n-              path.join(SERVER_DIRECTORY, `${INSTRUMENTATION_HOOK_FILENAME}.js`)\n+              path.join(\n+                config.distDir,\n+                SERVER_DIRECTORY,\n+                `${INSTRUMENTATION_HOOK_FILENAME}.js`\n+              )\n             )\n             // If there are edge routes, append the edge instrumentation hook\n             // Turbopack generates this chunk with a hashed name and references it in middleware-manifest.\n             let edgeInstrumentationHook = path.join(\n+              config.distDir,\n               SERVER_DIRECTORY,\n               `edge-${INSTRUMENTATION_HOOK_FILENAME}.js`\n             )\n             if (\n               bundler !== Bundler.Turbopack &&\n-              existsSync(path.join(distDir, edgeInstrumentationHook))\n+              existsSync(path.join(dir, edgeInstrumentationHook))\n             ) {\n               serverFilesManifest.files.push(edgeInstrumentationHook)\n             }"
        },
        {
            "sha": "be2ffc93e542763469a1a66d55fac91924c0a251",
            "filename": "test/lib/next-modes/next-start.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/6169e786020b63e101cc09285e1277e278cd34b8/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6169e786020b63e101cc09285e1277e278cd34b8/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-start.ts?ref=6169e786020b63e101cc09285e1277e278cd34b8",
            "patch": "@@ -217,7 +217,7 @@ export class NextStartInstance extends NextInstance {\n       )\n     }\n \n-    return new Promise<{\n+    let result = await new Promise<{\n       exitCode: NodeJS.Signals | number | null\n       cliOutput: string\n     }>((resolve) => {\n@@ -238,6 +238,21 @@ export class NextStartInstance extends NextInstance {\n         })\n       })\n     })\n+\n+    this._buildId = (\n+      await fs\n+        .readFile(\n+          path.join(\n+            this.testDir,\n+            this.nextConfig?.distDir || '.next',\n+            'BUILD_ID'\n+          ),\n+          'utf8'\n+        )\n+        .catch(() => '')\n+    ).trim()\n+\n+    return result\n   }\n \n   public async waitForMinPrerenderAge(minAgeMS: number): Promise<void> {"
        },
        {
            "sha": "a1c3920abc89d9197d9e0b9e0ab0c789c1e37256",
            "filename": "test/production/standalone-mode/required-server-files/instrumentation.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/6169e786020b63e101cc09285e1277e278cd34b8/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Finstrumentation.js",
            "raw_url": "https://github.com/vercel/next.js/raw/6169e786020b63e101cc09285e1277e278cd34b8/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Finstrumentation.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Finstrumentation.js?ref=6169e786020b63e101cc09285e1277e278cd34b8",
            "patch": "@@ -0,0 +1 @@\n+export function register() {}"
        },
        {
            "sha": "47f60363ebbcda13c50f60197136c741c8f078fa",
            "filename": "test/production/standalone-mode/required-server-files/required-server-files.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/6169e786020b63e101cc09285e1277e278cd34b8/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/6169e786020b63e101cc09285e1277e278cd34b8/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Frequired-server-files%2Frequired-server-files.test.ts?ref=6169e786020b63e101cc09285e1277e278cd34b8",
            "patch": "@@ -44,6 +44,9 @@ describe('required server files', () => {\n               : 'middleware.js'\n           )\n         ),\n+        'instrumentation.js': new FileRef(\n+          join(__dirname, 'instrumentation.js')\n+        ),\n         'cache-handler.js': new FileRef(join(__dirname, 'cache-handler.js')),\n         'data.txt': new FileRef(join(__dirname, 'data.txt')),\n         '.env': new FileRef(join(__dirname, '.env')),\n@@ -84,8 +87,11 @@ describe('required server files', () => {\n           }\n         },\n       },\n+      skipStart: true,\n     })\n-    await next.stop()\n+\n+    let { exitCode } = await next.build()\n+    expect(exitCode).toBe(0)\n \n     requiredFilesManifest = JSON.parse(\n       await next.readFile('.next/required-server-files.json')\n@@ -241,11 +247,11 @@ describe('required server files', () => {\n           redirect: 'manual',\n         }\n       )\n-      expect(dataRes.headers.get('cache-control')).toBe(cacheControl)\n       expect((await dataRes.json()).pageProps).toEqual({\n         __N_REDIRECT: dest,\n         __N_REDIRECT_STATUS: 307,\n       })\n+      expect(dataRes.headers.get('cache-control')).toBe(cacheControl)\n     }\n   )\n \n@@ -415,6 +421,12 @@ describe('required server files', () => {\n     expect(typeof requiredFilesManifest.appDir).toBe('string')\n     // not in a monorepo so relative app dir is empty string\n     expect(requiredFilesManifest.relativeAppDir).toBe('')\n+\n+    expect(\n+      requiredFilesManifest.files.filter(\n+        (f) => !fs.pathExistsSync(join(next.testDir, 'standalone', f))\n+      )\n+    ).toBeEmpty()\n   })\n \n   it('should de-dupe HTML/data requests', async () => {"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 38,
        "deletions": 5
    }
}