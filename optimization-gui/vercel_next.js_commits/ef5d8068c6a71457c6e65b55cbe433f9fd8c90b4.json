{
    "author": "mischnic",
    "message": "Port \"app-document\" test to e2e (#77748)\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that you follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the PR.\n- Read the Docs Contribution Guide to ensure your contribution follows the docs guidelines: https://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc https://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See https://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See: https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature request has been accepted for implementation before opening a PR. (A discussion must be opened, see https://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added (https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to understand the PR)\n- When linking to a Slack thread, you might want to share details of the conclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic behind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
    "files": [
        {
            "sha": "39ccc9a795dff7bbe6421b23ec5f92c30b7b9ff6",
            "filename": "test/e2e/app-document/client.test.ts",
            "status": "added",
            "additions": 98,
            "deletions": 0,
            "changes": 98,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fclient.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fclient.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fclient.test.ts?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "patch": "@@ -0,0 +1,98 @@\n+import { retry } from 'next-test-utils'\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('Client side', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  it('should share module state with pages', async () => {\n+    const browser = await next.browser('/shared')\n+\n+    const text = await browser.elementByCss('#currentstate').text()\n+    expect(text).toBe('UPDATED CLIENT')\n+  })\n+\n+  if (isNextDev) {\n+    it('should detect the changes to pages/_app.js and display it', async () => {\n+      const appPath = 'pages/_app.js'\n+      const originalContent = await next.readFile(appPath)\n+      try {\n+        const browser = await next.browser('/')\n+        const text = await browser.elementByCss('#hello-hmr').text()\n+        expect(text).toBe('Hello HMR')\n+\n+        // change the content\n+        const editedContent = originalContent.replace('Hello HMR', 'Hi HMR')\n+        await next.patchFile(appPath, editedContent)\n+\n+        await retry(async () =>\n+          expect(await browser.elementByCss('body').text()).toContain('Hi HMR')\n+        )\n+\n+        // add the original content\n+        await next.patchFile(appPath, originalContent)\n+\n+        await retry(async () =>\n+          expect(await browser.elementByCss('body').text()).toContain(\n+            'Hello HMR'\n+          )\n+        )\n+      } finally {\n+        await next.patchFile(appPath, originalContent)\n+      }\n+    })\n+\n+    it('should detect the changes to pages/_document.js and display it', async () => {\n+      const appPath = 'pages/_document.js'\n+      const originalContent = await next.readFile(appPath)\n+      try {\n+        const browser = await next.browser('/')\n+        const text = await browser.elementByCss('#hello-hmr').text()\n+        expect(text).toBe('Hello HMR')\n+\n+        const editedContent = originalContent.replace(\n+          'Hello Document HMR',\n+          'Hi Document HMR'\n+        )\n+\n+        // change the content\n+        await next.patchFile(appPath, editedContent)\n+\n+        await retry(async () =>\n+          expect(await browser.elementByCss('body').text()).toContain(\n+            'Hi Document HMR'\n+          )\n+        )\n+\n+        // add the original content\n+        await next.patchFile(appPath, originalContent)\n+\n+        await retry(async () =>\n+          expect(await browser.elementByCss('body').text()).toContain(\n+            'Hello Document HMR'\n+          )\n+        )\n+      } finally {\n+        await next.patchFile(appPath, originalContent)\n+      }\n+    })\n+\n+    it('should keep state between page navigations', async () => {\n+      const browser = await next.browser('/')\n+\n+      const randomNumber = await browser.elementByCss('#random-number').text()\n+\n+      const switchedRandomNumer = await browser\n+        .elementByCss('#about-link')\n+        .click()\n+        .waitForElementByCss('.page-about')\n+        .elementByCss('#random-number')\n+        .text()\n+\n+      expect(switchedRandomNumer).toBe(randomNumber)\n+      await browser.close()\n+    })\n+  }\n+})"
        },
        {
            "sha": "b96c544906ded371b6a80729a1196e154789e87d",
            "filename": "test/e2e/app-document/csp.test.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fcsp.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fcsp.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fcsp.test.ts?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "patch": "@@ -0,0 +1,23 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('With CSP enabled', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should load inline script by hash', async () => {\n+    const browser = await next.browser('/?withCSP=hash')\n+    if (global.browserName === 'chrome') {\n+      const errLog = await browser.log()\n+      expect(errLog.filter((e) => e.source === 'security')).toEqual([])\n+    }\n+  })\n+\n+  it('should load inline script by nonce', async () => {\n+    const browser = await next.browser('/?withCSP=nonce')\n+    if (global.browserName === 'chrome') {\n+      const errLog = await browser.log()\n+      expect(errLog.filter((e) => e.source === 'security')).toEqual([])\n+    }\n+  })\n+})"
        },
        {
            "sha": "1947d0bafd7e0e7483c6f2feb393b140869fbfae",
            "filename": "test/e2e/app-document/index.test.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Findex.test.ts?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "patch": "@@ -0,0 +1,14 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('Document and App', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should not have any missing key warnings', async () => {\n+    await next.fetch('/')\n+    expect(next.cliOutput).not.toContain(\n+      'Each child in a list should have a unique \"key\" prop'\n+    )\n+  })\n+})"
        },
        {
            "sha": "ecf49353c47b7300e969024924287b9993c28dd5",
            "filename": "test/e2e/app-document/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fnext.config.js?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "previous_filename": "test/integration/app-document/next.config.js"
        },
        {
            "sha": "51625045e806dbadc32d2fc492714f50103f800f",
            "filename": "test/e2e/app-document/pages/_app.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2F_app.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2F_app.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fpages%2F_app.js?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "previous_filename": "test/integration/app-document/pages/_app.js"
        },
        {
            "sha": "9430223f8d6086e382fa3373ba0970185b5f7c1a",
            "filename": "test/e2e/app-document/pages/_document.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2F_document.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2F_document.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fpages%2F_document.js?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "previous_filename": "test/integration/app-document/pages/_document.js"
        },
        {
            "sha": "329db6b4aa712849388a6885d4b7c73e053a6cba",
            "filename": "test/e2e/app-document/pages/about.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2Fabout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2Fabout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fpages%2Fabout.js?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "previous_filename": "test/integration/app-document/pages/about.js"
        },
        {
            "sha": "1a67dbf027ef19cdb485b6ebe8fbd570e8ff22b6",
            "filename": "test/e2e/app-document/pages/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fpages%2Findex.js?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "previous_filename": "test/integration/app-document/pages/index.js"
        },
        {
            "sha": "9430eafd2b1bb6c49a50fb1ec871e5e1c7536bc1",
            "filename": "test/e2e/app-document/pages/shared.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2Fshared.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fpages%2Fshared.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fpages%2Fshared.js?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "previous_filename": "test/integration/app-document/pages/shared.js"
        },
        {
            "sha": "5a54d00b70ed418bc3d66b0f5be3ca319094d566",
            "filename": "test/e2e/app-document/rendering.test.ts",
            "status": "added",
            "additions": 150,
            "deletions": 0,
            "changes": 150,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Frendering.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Frendering.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Frendering.test.ts?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "patch": "@@ -0,0 +1,150 @@\n+import { retry } from 'next-test-utils'\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('app-document - Rendering via HTTP', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  describe('_document', () => {\n+    it('should include required elements in rendered html', async () => {\n+      const $ = await next.render$('/')\n+      // It has a custom html class\n+      expect($('html').hasClass('test-html-props')).toBe(true)\n+      // It has a custom body class\n+      expect($('body').hasClass('custom_class')).toBe(true)\n+      // It injects custom head tags\n+      expect($('head').text()).toMatch('body { margin: 0 }')\n+      // It has __NEXT_DATA__ script tag\n+      expect($('script#__NEXT_DATA__')).toBeTruthy()\n+      // It passes props from Document.getInitialProps to Document\n+      expect($('#custom-property').text()).toBe('Hello Document')\n+    })\n+\n+    it('Document.getInitialProps returns html prop representing app shell', async () => {\n+      // Extract css-in-js-class from the rendered HTML, which is returned by Document.getInitialProps\n+      const $index = await next.render$('/')\n+      const $about = await next.render$('/about')\n+      expect($index('#css-in-cjs-count').text()).toBe('2')\n+      expect($about('#css-in-cjs-count').text()).toBe('0')\n+    })\n+\n+    it('adds nonces to all scripts and preload links', async () => {\n+      const $ = await next.render$('/')\n+      const nonce = 'test-nonce'\n+      let noncesAdded = true\n+      $('script, link[rel=preload]').each((index, element) => {\n+        if ($(element).attr('nonce') !== nonce) noncesAdded = false\n+      })\n+      expect(noncesAdded).toBe(true)\n+    })\n+\n+    it('adds crossOrigin to all scripts and preload links', async () => {\n+      const $ = await next.render$('/')\n+      const crossOrigin = 'anonymous'\n+      $('script, link[rel=preload]').each((index, element) => {\n+        expect($(element).attr('crossorigin') === crossOrigin).toBeTruthy()\n+      })\n+    })\n+\n+    it('renders ctx.renderPage with enhancer correctly', async () => {\n+      const $ = await next.render$('/?withEnhancer=true')\n+      const nonce = 'RENDERED'\n+      expect($('#render-page-enhance-component').text().includes(nonce)).toBe(\n+        true\n+      )\n+    })\n+\n+    it('renders ctx.renderPage with enhanceComponent correctly', async () => {\n+      const $ = await next.render$('/?withEnhanceComponent=true')\n+      const nonce = 'RENDERED'\n+      expect($('#render-page-enhance-component').text().includes(nonce)).toBe(\n+        true\n+      )\n+    })\n+\n+    it('renders ctx.renderPage with enhanceApp correctly', async () => {\n+      const $ = await next.render$('/?withEnhanceApp=true')\n+      const nonce = 'RENDERED'\n+      expect($('#render-page-enhance-app').text().includes(nonce)).toBe(true)\n+    })\n+\n+    it('renders ctx.renderPage with enhanceApp and enhanceComponent correctly', async () => {\n+      const $ = await next.render$(\n+        '/?withEnhanceComponent=true&withEnhanceApp=true'\n+      )\n+      const nonce = 'RENDERED'\n+      expect($('#render-page-enhance-app').text().includes(nonce)).toBe(true)\n+      expect($('#render-page-enhance-component').text().includes(nonce)).toBe(\n+        true\n+      )\n+    })\n+\n+    if (isNextDev) {\n+      // This is a workaround to fix https://github.com/vercel/next.js/issues/5860\n+      // TODO: remove this workaround when https://bugs.webkit.org/show_bug.cgi?id=187726 is fixed.\n+      it('adds a timestamp to link tags with preload attribute to invalidate the cache in dev', async () => {\n+        const $ = await next.render$('/', undefined, {\n+          headers: { 'user-agent': 'Safari' },\n+        })\n+        $('link[rel=preload]').each((index, element) => {\n+          const href = $(element).attr('href')\n+          expect(href.match(/\\?/g)).toHaveLength(1)\n+          expect(href).toMatch(/\\?ts=/)\n+        })\n+        $('script[src]').each((index, element) => {\n+          const src = $(element).attr('src')\n+          expect(src.match(/\\?/g)).toHaveLength(1)\n+          expect(src).toMatch(/\\?ts=/)\n+        })\n+      })\n+    }\n+  })\n+\n+  describe('_app', () => {\n+    it('shows a custom tag', async () => {\n+      const $ = await next.render$('/')\n+      expect($('#hello-app').text()).toBe('Hello App')\n+    })\n+\n+    // For example react context uses shared module state\n+    // Also known as singleton modules\n+    it('should share module state with pages', async () => {\n+      const $ = await next.render$('/shared')\n+      expect($('#currentstate').text()).toBe('UPDATED')\n+    })\n+\n+    if (isNextDev) {\n+      it('should show valid error when thrown in _app getInitialProps', async () => {\n+        const errMsg = 'have an error from _app getInitialProps'\n+        const origContent = await next.readFile('pages/_app.js')\n+\n+        expect(await next.render('/')).toContain('page-index')\n+\n+        await next.patchFile(\n+          'pages/_app.js',\n+          origContent.replace(\n+            '// throw _app GIP err here',\n+            `throw new Error(\"${errMsg}\")`\n+          )\n+        )\n+\n+        let foundErr = false\n+        try {\n+          await retry(async () =>\n+            expect(await next.render('/')).toContain(errMsg)\n+          )\n+          foundErr = true\n+        } finally {\n+          await next.patchFile('pages/_app.js', origContent)\n+\n+          // Make sure _app is restored\n+          await retry(async () =>\n+            expect(await next.render('/')).toContain('page-index')\n+          )\n+          expect(foundErr).toBeTruthy()\n+        }\n+      })\n+    }\n+  })\n+})"
        },
        {
            "sha": "359b67f87a70f233627d4aa3a346864811b2c056",
            "filename": "test/e2e/app-document/shared-module.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fshared-module.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4/test%2Fe2e%2Fapp-document%2Fshared-module.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-document%2Fshared-module.js?ref=ef5d8068c6a71457c6e65b55cbe433f9fd8c90b4",
            "previous_filename": "test/integration/app-document/shared-module.js"
        },
        {
            "sha": "311a3f2151f85aacadfd14d6cea78dc346f58e0d",
            "filename": "test/integration/app-document/test/client.js",
            "status": "removed",
            "additions": 0,
            "deletions": 97,
            "changes": 97,
            "blob_url": "https://github.com/vercel/next.js/blob/49ba0acc183e89cc3b84ac81019edb86a0ff5d89/test%2Fintegration%2Fapp-document%2Ftest%2Fclient.js",
            "raw_url": "https://github.com/vercel/next.js/raw/49ba0acc183e89cc3b84ac81019edb86a0ff5d89/test%2Fintegration%2Fapp-document%2Ftest%2Fclient.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-document%2Ftest%2Fclient.js?ref=49ba0acc183e89cc3b84ac81019edb86a0ff5d89",
            "patch": "@@ -1,97 +0,0 @@\n-/* eslint-env jest */\n-import webdriver from 'next-webdriver'\n-import { readFileSync, writeFileSync } from 'fs'\n-import { join } from 'path'\n-import { check } from 'next-test-utils'\n-\n-export default (context, render) => {\n-  describe('Client side', () => {\n-    it('should detect the changes to pages/_app.js and display it', async () => {\n-      const appPath = join(__dirname, '../', 'pages', '_app.js')\n-      const originalContent = readFileSync(appPath, 'utf8')\n-      let browser\n-      try {\n-        browser = await webdriver(context.appPort, '/')\n-        const text = await browser.elementByCss('#hello-hmr').text()\n-        expect(text).toBe('Hello HMR')\n-\n-        // change the content\n-        const editedContent = originalContent.replace('Hello HMR', 'Hi HMR')\n-        writeFileSync(appPath, editedContent, 'utf8')\n-\n-        await check(() => browser.elementByCss('body').text(), /Hi HMR/)\n-\n-        // add the original content\n-        writeFileSync(appPath, originalContent, 'utf8')\n-\n-        await check(() => browser.elementByCss('body').text(), /Hello HMR/)\n-      } finally {\n-        writeFileSync(appPath, originalContent, 'utf8')\n-        if (browser) {\n-          await browser.close()\n-        }\n-      }\n-    })\n-\n-    it('should detect the changes to pages/_document.js and display it', async () => {\n-      const appPath = join(__dirname, '../', 'pages', '_document.js')\n-      const originalContent = readFileSync(appPath, 'utf8')\n-      let browser\n-      try {\n-        browser = await webdriver(context.appPort, '/')\n-        const text = await browser.elementByCss('#hello-hmr').text()\n-        expect(text).toBe('Hello HMR')\n-\n-        const editedContent = originalContent.replace(\n-          'Hello Document HMR',\n-          'Hi Document HMR'\n-        )\n-\n-        // change the content\n-        writeFileSync(appPath, editedContent, 'utf8')\n-\n-        await check(\n-          () => browser.elementByCss('body').text(),\n-          /Hi Document HMR/\n-        )\n-\n-        // add the original content\n-        writeFileSync(appPath, originalContent, 'utf8')\n-\n-        await check(\n-          () => browser.elementByCss('body').text(),\n-          /Hello Document HMR/\n-        )\n-      } finally {\n-        writeFileSync(appPath, originalContent, 'utf8')\n-        if (browser) {\n-          await browser.close()\n-        }\n-      }\n-    })\n-\n-    it('should keep state between page navigations', async () => {\n-      const browser = await webdriver(context.appPort, '/')\n-\n-      const randomNumber = await browser.elementByCss('#random-number').text()\n-\n-      const switchedRandomNumer = await browser\n-        .elementByCss('#about-link')\n-        .click()\n-        .waitForElementByCss('.page-about')\n-        .elementByCss('#random-number')\n-        .text()\n-\n-      expect(switchedRandomNumer).toBe(randomNumber)\n-      await browser.close()\n-    })\n-\n-    it('It should share module state with pages', async () => {\n-      const browser = await webdriver(context.appPort, '/shared')\n-\n-      const text = await browser.elementByCss('#currentstate').text()\n-      expect(text).toBe('UPDATED CLIENT')\n-      await browser.close()\n-    })\n-  })\n-}"
        },
        {
            "sha": "2b8c34ad58ffe889cbfe09def7232452cea4bd84",
            "filename": "test/integration/app-document/test/csp.js",
            "status": "removed",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/49ba0acc183e89cc3b84ac81019edb86a0ff5d89/test%2Fintegration%2Fapp-document%2Ftest%2Fcsp.js",
            "raw_url": "https://github.com/vercel/next.js/raw/49ba0acc183e89cc3b84ac81019edb86a0ff5d89/test%2Fintegration%2Fapp-document%2Ftest%2Fcsp.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-document%2Ftest%2Fcsp.js?ref=49ba0acc183e89cc3b84ac81019edb86a0ff5d89",
            "patch": "@@ -1,24 +0,0 @@\n-/* eslint-env jest */\n-import webdriver from 'next-webdriver'\n-\n-export default (context, render) => {\n-  describe('With CSP enabled', () => {\n-    it('should load inline script by hash', async () => {\n-      const browser = await webdriver(context.appPort, '/?withCSP=hash')\n-      if (global.browserName === 'chrome') {\n-        const errLog = await browser.log()\n-        expect(errLog.filter((e) => e.source === 'security')).toEqual([])\n-      }\n-      await browser.close()\n-    })\n-\n-    it('should load inline script by nonce', async () => {\n-      const browser = await webdriver(context.appPort, '/?withCSP=nonce')\n-      if (global.browserName === 'chrome') {\n-        const errLog = await browser.log()\n-        expect(errLog.filter((e) => e.source === 'security')).toEqual([])\n-      }\n-      await browser.close()\n-    })\n-  })\n-}"
        },
        {
            "sha": "9fc0639cd5e72b1da7eea09a5c2017c2c3d5ea6b",
            "filename": "test/integration/app-document/test/index.test.js",
            "status": "removed",
            "additions": 0,
            "deletions": 59,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/49ba0acc183e89cc3b84ac81019edb86a0ff5d89/test%2Fintegration%2Fapp-document%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/49ba0acc183e89cc3b84ac81019edb86a0ff5d89/test%2Fintegration%2Fapp-document%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-document%2Ftest%2Findex.test.js?ref=49ba0acc183e89cc3b84ac81019edb86a0ff5d89",
            "patch": "@@ -1,59 +0,0 @@\n-/* eslint-env jest */\n-\n-import { join } from 'path'\n-import {\n-  renderViaHTTP,\n-  fetchViaHTTP,\n-  findPort,\n-  launchApp,\n-  killApp,\n-} from 'next-test-utils'\n-\n-// test suites\n-import rendering from './rendering'\n-import client from './client'\n-import csp from './csp'\n-\n-const context = {\n-  output: '',\n-}\n-\n-const collectOutput = (message) => {\n-  context.output += message\n-}\n-\n-describe('Document and App', () => {\n-  beforeAll(async () => {\n-    context.appPort = await findPort()\n-    context.server = await launchApp(join(__dirname, '../'), context.appPort, {\n-      onStdout: collectOutput,\n-      onStderr: collectOutput,\n-    })\n-\n-    // pre-build all pages at the start\n-    await Promise.all([renderViaHTTP(context.appPort, '/')])\n-  })\n-  afterAll(() => killApp(context.server))\n-\n-  it('should not have any missing key warnings', async () => {\n-    await renderViaHTTP(context.appPort, '/')\n-    expect(context.output).not.toMatch(\n-      /Each child in a list should have a unique \"key\" prop/\n-    )\n-  })\n-\n-  rendering(\n-    context,\n-    'Rendering via HTTP',\n-    (p, q) =>\n-      renderViaHTTP(context.appPort, p, q, {\n-        headers: { 'user-agent': 'Safari' },\n-      }),\n-    (p, q) =>\n-      fetchViaHTTP(context.appPort, p, q, {\n-        headers: { 'user-agent': 'Safari' },\n-      })\n-  )\n-  client(context, (p, q) => renderViaHTTP(context.appPort, p, q))\n-  csp(context, (p, q) => renderViaHTTP(context.appPort, p, q))\n-})"
        },
        {
            "sha": "eaaeff782d41eb69ce885587577f630289be4649",
            "filename": "test/integration/app-document/test/rendering.js",
            "status": "removed",
            "additions": 0,
            "deletions": 143,
            "changes": 143,
            "blob_url": "https://github.com/vercel/next.js/blob/49ba0acc183e89cc3b84ac81019edb86a0ff5d89/test%2Fintegration%2Fapp-document%2Ftest%2Frendering.js",
            "raw_url": "https://github.com/vercel/next.js/raw/49ba0acc183e89cc3b84ac81019edb86a0ff5d89/test%2Fintegration%2Fapp-document%2Ftest%2Frendering.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-document%2Ftest%2Frendering.js?ref=49ba0acc183e89cc3b84ac81019edb86a0ff5d89",
            "patch": "@@ -1,143 +0,0 @@\n-/* eslint-env jest */\n-\n-import { join } from 'path'\n-import cheerio from 'cheerio'\n-import { check, File, waitFor } from 'next-test-utils'\n-\n-export default function ({ app }, suiteName, render, fetch) {\n-  async function get$(path, query) {\n-    const html = await render(path, query)\n-    return cheerio.load(html)\n-  }\n-\n-  describe(suiteName, () => {\n-    describe('_document', () => {\n-      test('should include required elements in rendered html', async () => {\n-        const $ = await get$('/')\n-        // It has a custom html class\n-        expect($('html').hasClass('test-html-props')).toBe(true)\n-        // It has a custom body class\n-        expect($('body').hasClass('custom_class')).toBe(true)\n-        // It injects custom head tags\n-        expect($('head').text()).toMatch('body { margin: 0 }')\n-        // It has __NEXT_DATA__ script tag\n-        expect($('script#__NEXT_DATA__')).toBeTruthy()\n-        // It passes props from Document.getInitialProps to Document\n-        expect($('#custom-property').text()).toBe('Hello Document')\n-      })\n-\n-      it('Document.getInitialProps returns html prop representing app shell', async () => {\n-        // Extract css-in-js-class from the rendered HTML, which is returned by Document.getInitialProps\n-        const $index = await get$('/')\n-        const $about = await get$('/about')\n-        expect($index('#css-in-cjs-count').text()).toBe('2')\n-        expect($about('#css-in-cjs-count').text()).toBe('0')\n-      })\n-\n-      test('It adds nonces to all scripts and preload links', async () => {\n-        const $ = await get$('/')\n-        const nonce = 'test-nonce'\n-        let noncesAdded = true\n-        $('script, link[rel=preload]').each((index, element) => {\n-          if ($(element).attr('nonce') !== nonce) noncesAdded = false\n-        })\n-        expect(noncesAdded).toBe(true)\n-      })\n-\n-      test('It adds crossOrigin to all scripts and preload links', async () => {\n-        const $ = await get$('/')\n-        const crossOrigin = 'anonymous'\n-        $('script, link[rel=preload]').each((index, element) => {\n-          expect($(element).attr('crossorigin') === crossOrigin).toBeTruthy()\n-        })\n-      })\n-\n-      test('It renders ctx.renderPage with enhancer correctly', async () => {\n-        const $ = await get$('/?withEnhancer=true')\n-        const nonce = 'RENDERED'\n-        expect($('#render-page-enhance-component').text().includes(nonce)).toBe(\n-          true\n-        )\n-      })\n-\n-      test('It renders ctx.renderPage with enhanceComponent correctly', async () => {\n-        const $ = await get$('/?withEnhanceComponent=true')\n-        const nonce = 'RENDERED'\n-        expect($('#render-page-enhance-component').text().includes(nonce)).toBe(\n-          true\n-        )\n-      })\n-\n-      test('It renders ctx.renderPage with enhanceApp correctly', async () => {\n-        const $ = await get$('/?withEnhanceApp=true')\n-        const nonce = 'RENDERED'\n-        expect($('#render-page-enhance-app').text().includes(nonce)).toBe(true)\n-      })\n-\n-      test('It renders ctx.renderPage with enhanceApp and enhanceComponent correctly', async () => {\n-        const $ = await get$('/?withEnhanceComponent=true&withEnhanceApp=true')\n-        const nonce = 'RENDERED'\n-        expect($('#render-page-enhance-app').text().includes(nonce)).toBe(true)\n-        expect($('#render-page-enhance-component').text().includes(nonce)).toBe(\n-          true\n-        )\n-      })\n-\n-      // This is a workaround to fix https://github.com/vercel/next.js/issues/5860\n-      // TODO: remove this workaround when https://bugs.webkit.org/show_bug.cgi?id=187726 is fixed.\n-      test('It adds a timestamp to link tags with preload attribute to invalidate the cache (DEV only)', async () => {\n-        const $ = await get$('/')\n-        $('link[rel=preload]').each((index, element) => {\n-          const href = $(element).attr('href')\n-          expect(href.match(/\\?/g)).toHaveLength(1)\n-          expect(href).toMatch(/\\?ts=/)\n-        })\n-        $('script[src]').each((index, element) => {\n-          const src = $(element).attr('src')\n-          expect(src.match(/\\?/g)).toHaveLength(1)\n-          expect(src).toMatch(/\\?ts=/)\n-        })\n-      })\n-    })\n-\n-    describe('_app', () => {\n-      test('It shows a custom tag', async () => {\n-        const $ = await get$('/')\n-        expect($('#hello-app').text()).toBe('Hello App')\n-      })\n-\n-      // For example react context uses shared module state\n-      // Also known as singleton modules\n-      test('It should share module state with pages', async () => {\n-        const $ = await get$('/shared')\n-        expect($('#currentstate').text()).toBe('UPDATED')\n-      })\n-\n-      test('It should show valid error when thrown in _app getInitialProps', async () => {\n-        const errMsg = 'have an error from _app getInitialProps'\n-        const _app = new File(join(__dirname, '../pages/_app.js'))\n-\n-        let foundErr = false\n-        expect(await render('/')).toMatch('page-index')\n-        _app.replace(\n-          '// throw _app GIP err here',\n-          `throw new Error(\"${errMsg}\")`\n-        )\n-\n-        try {\n-          let tries = 0\n-          while (!foundErr && tries < 5) {\n-            foundErr = (await render('/')).indexOf(errMsg) > -1\n-            await waitFor(1000)\n-            tries++\n-          }\n-        } finally {\n-          _app.restore()\n-          // Make sure _app is restored\n-          await check(() => render('/'), /page-index/)\n-          expect(foundErr).toBeTruthy()\n-        }\n-      })\n-    })\n-  })\n-}"
        }
    ],
    "stats": {
        "total": 608,
        "additions": 285,
        "deletions": 323
    }
}