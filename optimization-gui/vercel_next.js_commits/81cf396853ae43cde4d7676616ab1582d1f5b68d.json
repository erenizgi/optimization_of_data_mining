{
    "author": "ijjk",
    "message": "Output server.mjs for standalone with type: module (#77944)\n\nThis ensures we output `server.mjs` when `type: 'module'` is configured\nfor a project using `standalone` mode. This also ensures we copy the\n`package.json` to the standalone folder as we were previously only\ncopying it if it was included in the traced assets.",
    "sha": "81cf396853ae43cde4d7676616ab1582d1f5b68d",
    "files": [
        {
            "sha": "5d321d1eb71295cad99ba0a7d90143368495fa65",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/81cf396853ae43cde4d7676616ab1582d1f5b68d/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/81cf396853ae43cde4d7676616ab1582d1f5b68d/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=81cf396853ae43cde4d7676616ab1582d1f5b68d",
            "patch": "@@ -1544,8 +1544,19 @@ export async function copyTracedFiles(\n   }\n   try {\n     const packageJsonPath = path.join(distDir, '../package.json')\n-    const packageJson = JSON.parse(await fs.readFile(packageJsonPath, 'utf8'))\n+    const packageJsonContent = await fs.readFile(packageJsonPath, 'utf8')\n+    const packageJson = JSON.parse(packageJsonContent)\n     moduleType = packageJson.type === 'module'\n+\n+    // we always copy the package.json to the standalone\n+    // folder to ensure any resolving logic is maintained\n+    const packageJsonOutputPath = path.join(\n+      outputPath,\n+      path.relative(tracingRoot, dir),\n+      'package.json'\n+    )\n+    await fs.mkdir(path.dirname(packageJsonOutputPath), { recursive: true })\n+    await fs.writeFile(packageJsonOutputPath, packageJsonContent)\n   } catch {}\n   const copiedFiles = new Set()\n   await fs.rm(outputPath, { recursive: true, force: true })\n@@ -1676,7 +1687,7 @@ export async function copyTracedFiles(\n   const serverOutputPath = path.join(\n     outputPath,\n     path.relative(tracingRoot, dir),\n-    'server.js'\n+    moduleType ? 'server.mjs' : 'server.js'\n   )\n   await fs.mkdir(path.dirname(serverOutputPath), { recursive: true })\n "
        },
        {
            "sha": "464bb4ecec3d9d9ad619e84bef1b13d49f35f5f5",
            "filename": "test/production/standalone-mode/type-module/index.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/81cf396853ae43cde4d7676616ab1582d1f5b68d/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/81cf396853ae43cde4d7676616ab1582d1f5b68d/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftype-module%2Findex.test.ts?ref=81cf396853ae43cde4d7676616ab1582d1f5b68d",
            "patch": "@@ -39,7 +39,9 @@ describe('type-module', () => {\n \n     await fs.move(staticSrc, staticDest)\n \n-    const serverFile = join(standalonePath, 'server.js')\n+    expect(fs.existsSync(join(standalonePath, 'package.json'))).toBe(true)\n+\n+    const serverFile = join(standalonePath, 'server.mjs')\n     const appPort = await findPort()\n     const server = await initNextServerScript(\n       serverFile,"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 16,
        "deletions": 3
    }
}