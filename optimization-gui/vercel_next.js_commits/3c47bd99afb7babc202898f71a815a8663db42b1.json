{
    "author": "feedthejim",
    "message": "chore: add Claude Code configuration (#87943)\n\nadding basic config with graphite/repo instructions\r\n\r\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\r\nTo make sure your PR is handled as smoothly as possible we request that you follow the checklist sections below.\r\nChoose the right checklist for the change(s) that you're making:\r\n\r\n## For Contributors\r\n\r\n### Improving Documentation\r\n\r\n- Run `pnpm prettier-fix` to fix formatting issues before opening the PR.\r\n- Read the Docs Contribution Guide to ensure your contribution follows the docs guidelines: https://nextjs.org/docs/community/contribution-guide\r\n\r\n### Fixing a bug\r\n\r\n- Related issues linked using `fixes #number`\r\n- Tests added. See: https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\r\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\r\n\r\n### Adding a feature\r\n\r\n- Implements an existing feature request or RFC. Make sure the feature request has been accepted for implementation before opening a PR. (A discussion must be opened, see https://github.com/vercel/next.js/discussions/new?category=ideas)\r\n- Related issues/discussions are linked using `fixes #number`\r\n- e2e tests added (https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\r\n- Documentation added\r\n- Telemetry added. In case of a feature if it's used or not.\r\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\r\n\r\n\r\n## For Maintainers\r\n\r\n- Minimal description (aim for explaining to someone not on the team to understand the PR)\r\n- When linking to a Slack thread, you might want to share details of the conclusion\r\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\r\n- Add review comments if necessary to explain to the reviewer the logic behind a change\r\n\r\n### What?\r\n\r\n### Why?\r\n\r\n### How?\r\n\r\nCloses NEXT-\r\nFixes #\r\n\r\n-->",
    "sha": "3c47bd99afb7babc202898f71a815a8663db42b1",
    "files": [
        {
            "sha": "c555bbe9dc00392b6951c21bb5dfceb458709e16",
            "filename": ".alexignore",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3c47bd99afb7babc202898f71a815a8663db42b1/.alexignore",
            "raw_url": "https://github.com/vercel/next.js/raw/3c47bd99afb7babc202898f71a815a8663db42b1/.alexignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.alexignore?ref=3c47bd99afb7babc202898f71a815a8663db42b1",
            "patch": "@@ -1,3 +1,5 @@\n CODE_OF_CONDUCT.md\n examples/\n **/*/LICENSE.md\n+.claude/\n+CLAUDE.md"
        },
        {
            "sha": "ede4766f6f428089d1027177a5bd8de28c7e244b",
            "filename": ".claude/commands/ci-failures.md",
            "status": "added",
            "additions": 161,
            "deletions": 0,
            "changes": 161,
            "blob_url": "https://github.com/vercel/next.js/blob/3c47bd99afb7babc202898f71a815a8663db42b1/.claude%2Fcommands%2Fci-failures.md",
            "raw_url": "https://github.com/vercel/next.js/raw/3c47bd99afb7babc202898f71a815a8663db42b1/.claude%2Fcommands%2Fci-failures.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.claude%2Fcommands%2Fci-failures.md?ref=3c47bd99afb7babc202898f71a815a8663db42b1",
            "patch": "@@ -0,0 +1,161 @@\n+# Check CI Failures\n+\n+Analyze failing tests from PR CI runs with parallel subagent log analysis.\n+\n+## Usage\n+\n+```\n+/ci-failures [pr-number]\n+```\n+\n+If no PR number provided, detect from current branch.\n+\n+## Instructions\n+\n+1. Get the PR number from argument or current branch:\n+\n+   ```bash\n+   gh pr view --json number,headRefName --jq '\"\\(.number) \\(.headRefName)\"'\n+   ```\n+\n+2. **CRITICAL: Always fetch fresh run IDs** - never trust cached IDs from conversation summaries:\n+\n+   ```bash\n+   gh api \"repos/vercel/next.js/actions/runs?branch={branch}&per_page=10\" \\\n+     --jq '.workflow_runs[] | select(.name == \"build-and-test\") | \"\\(.id) attempts:\\(.run_attempt) status:\\(.status) conclusion:\\(.conclusion)\"'\n+   ```\n+\n+3. **Prioritize the MOST RECENT run, even if in-progress:**\n+   - If the latest run is `in_progress` or `queued`, check it FIRST - it has the most relevant failures\n+   - Individual jobs complete before the overall run - analyze them as they finish\n+   - Only fall back to older completed runs if the current run has no completed jobs yet\n+\n+4. Get all failed jobs from the run (works for in-progress runs too):\n+\n+   ```bash\n+   gh api \"repos/vercel/next.js/actions/runs/{run_id}/jobs?per_page=100\" \\\n+     --jq '.jobs[] | select(.conclusion == \"failure\") | \"\\(.id) \\(.name)\"'\n+   ```\n+\n+   **Note:** For runs with >100 jobs, paginate:\n+\n+   ```bash\n+   gh api \"repos/vercel/next.js/actions/runs/{run_id}/jobs?per_page=100&page=2\"\n+   ```\n+\n+5. Spawn parallel haiku subagents to analyze logs (limit to 3-4 to avoid rate limits):\n+   - **CRITICAL: Use the API endpoint for logs, NOT `gh run view`**\n+   - `gh run view --job --log` FAILS when run is in-progress\n+   - **Do NOT group by job name** (e.g., \"test dev\", \"turbopack\") - group by failure pattern instead\n+   - Agent prompt should extract structured data using:\n+     ```bash\n+     # Extract assertion failures with context:\n+     gh api \"repos/vercel/next.js/actions/jobs/{job_id}/logs\" 2>&1 | \\\n+       grep -B3 -A10 \"expect.*\\(toBe\\|toContain\\|toEqual\\|toStartWith\\|toMatch\\)\" | head -100\n+     # Also check for test file paths:\n+     gh api \"repos/vercel/next.js/actions/jobs/{job_id}/logs\" 2>&1 | \\\n+       grep -E \"^\\s+at Object\\.|FAIL\\s+test/\" | head -20\n+     ```\n+   - **Agent prompt template** (copy-paste for each agent):\n+     ```\n+     Analyze CI logs for these jobs: {job_ids}\n+     For each failing test, extract:\n+     1. TEST FILE: (full path, e.g., test/production/required-server-files-ssr-404/test/index.test.ts)\n+     2. TEST NAME: (the specific test case name)\n+     3. EXPECTED: (exact expected value from assertion)\n+     4. RECEIVED: (exact received value from assertion)\n+     5. CATEGORY: (assertion|timeout|routing|source-map|build|cli-output)\n+     6. ROOT CAUSE: (one sentence hypothesis)\n+     Return structured findings grouped by TEST FILE, not by job.\n+     ```\n+\n+6. **Deduplicate by test file** before summarizing:\n+   - Group all failures by TEST FILE path, not by CI job name\n+   - If multiple jobs fail the same test file, count them but report once\n+   - Identify systemic issues (same test failing across many jobs)\n+\n+7. Create summary table **grouped by test file**:\n+   | Test File | Issue (Expected vs Received) | Jobs | Priority |\n+   |-----------|------------------------------|------|----------|\n+   | `test/production/required-server-files-ssr-404/...` | `\"second\"` vs `\"[slug]\"` (routing) | 3 | HIGH |\n+   | `test/integration/server-side-dev-errors/...` | source map paths wrong | 5 | HIGH |\n+   | `test/e2e/app-dir/disable-logging-route/...` | \"Compiling\" appearing when disabled | 2 | MEDIUM |\n+\n+8. Recommend fixes:\n+   - **HIGH priority**: Show specific expected vs actual values, include test file path\n+   - **MEDIUM priority**: Identify root cause pattern\n+   - **LOW priority**: Mark as likely flaky/transient\n+\n+## Failure Categories\n+\n+- **Infrastructure/Transient**: Network errors, 503s, timeouts unrelated to code\n+- **Assertion Failures**: Wrong output, path mismatches, snapshot differences\n+- **Build Failures**: Compilation errors, missing dependencies\n+- **Timeout**: Tests hanging, usually indicates async issues or missing server responses\n+- **Port Binding**: EADDRINUSE errors, parallel test conflicts\n+- **Routing/SSR**: Dynamic params not resolved, wrong status codes, JSON parse errors\n+- **Source Maps**: `webpack-internal://` paths, wrong line numbers, missing code frames\n+- **CLI Output**: Missing warnings, wrong log order, \"Ready\" printed before errors\n+\n+## Failure Extraction Patterns\n+\n+Use these grep patterns to identify specific failure types:\n+\n+```bash\n+# Assertion failures (most common)\n+grep -B3 -A10 \"expect.*\\(toBe\\|toContain\\|toEqual\\|toStartWith\\)\" | head -100\n+\n+# Routing issues (dynamic params, status codes)\n+grep -E \"Expected.*Received|\\[slug\\]|x-matched-path|Expected: [0-9]+\" | head -50\n+\n+# Source map issues\n+grep -E \"webpack-internal://|at .* \\(webpack\" | head -30\n+\n+# CLI output issues (missing warnings)\n+grep -E \"Ready in|deprecated|Both middleware|Compiling\" | head -30\n+\n+# Timeout issues\n+grep -E \"TIMEOUT|TimeoutError|exceeded|Exceeded timeout\" | head -20\n+\n+# Test file paths (to identify which test is failing)\n+grep -E \"FAIL test/|at Object\\.<anonymous> \\(\" | head -20\n+```\n+\n+## Common Gotchas\n+\n+### In-Progress Runs\n+\n+- `gh run view {run_id} --job {job_id} --log` **FAILS** when run is in-progress\n+- `gh api \"repos/.../actions/jobs/{job_id}/logs\"` **WORKS** for any completed job\n+- Always use the API endpoint for reliability\n+\n+### Pagination\n+\n+- GitHub API paginates at 100 jobs per page\n+- Next.js CI has ~120+ jobs - always check page 2:\n+  ```bash\n+  gh api \".../jobs?per_page=100&page=1\" --jq '[.jobs[] | select(.conclusion == \"failure\")] | length'\n+  gh api \".../jobs?per_page=100&page=2\" --jq '[.jobs[] | select(.conclusion == \"failure\")] | length'\n+  ```\n+\n+### Multiple Attempts\n+\n+- CI runs can have multiple attempts (retries)\n+- Check attempt count: `.run_attempt` field\n+- Query specific attempt: `.../runs/{id}/attempts/{n}/jobs`\n+- 404 on attempt endpoint means that attempt doesn't exist\n+\n+## Quick Reference\n+\n+```bash\n+# Get failed jobs (works for in-progress runs)\n+gh api \"repos/vercel/next.js/actions/runs/{run_id}/jobs?per_page=100\" \\\n+  --jq '.jobs[] | select(.conclusion == \"failure\") | \"\\(.id) \\(.name)\"'\n+\n+# Get logs for a specific job (works for in-progress runs)\n+gh api \"repos/vercel/next.js/actions/jobs/{job_id}/logs\" 2>&1 | head -500\n+\n+# Search logs for errors\n+gh api \"repos/vercel/next.js/actions/jobs/{job_id}/logs\" 2>&1 | \\\n+  grep -E \"FAIL|Error|error:|✕|Expected|Received\" | head -50\n+```"
        },
        {
            "sha": "3dae748bb1e05012071e565944898619de3b3dcd",
            "filename": ".gitignore",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3c47bd99afb7babc202898f71a815a8663db42b1/.gitignore",
            "raw_url": "https://github.com/vercel/next.js/raw/3c47bd99afb7babc202898f71a815a8663db42b1/.gitignore",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.gitignore?ref=3c47bd99afb7babc202898f71a815a8663db42b1",
            "patch": "@@ -63,3 +63,9 @@ test-timings.json\n \n # Storybook\n *storybook.log\n+\n+# Claude Code (local settings and session files)\n+.claude/settings.local.json\n+.claude/plans/\n+.claude/todos.json\n+CLAUDE.local.md"
        },
        {
            "sha": "582ac551676d234bee8b8fc51d04e41099398e44",
            "filename": "CLAUDE.md",
            "status": "added",
            "additions": 205,
            "deletions": 0,
            "changes": 205,
            "blob_url": "https://github.com/vercel/next.js/blob/3c47bd99afb7babc202898f71a815a8663db42b1/CLAUDE.md",
            "raw_url": "https://github.com/vercel/next.js/raw/3c47bd99afb7babc202898f71a815a8663db42b1/CLAUDE.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/CLAUDE.md?ref=3c47bd99afb7babc202898f71a815a8663db42b1",
            "patch": "@@ -0,0 +1,205 @@\n+# Next.js Development Guide\n+\n+## Git Workflow\n+\n+**Use Graphite for all git operations** instead of raw git commands:\n+\n+- `gt create <branch-name> -m \"message\"` - Create a new branch with commit\n+- `gt modify -a --no-edit` - Stage all and amend current branch's commit\n+- `gt checkout <branch>` - Switch branches (use instead of `git checkout`)\n+- `gt sync` - Sync and restack all branches\n+- `gt submit --no-edit` - Push and create/update PRs (use `--no-edit` to avoid interactive prompts)\n+- `gt log short` - View stack status\n+\n+**Note**: `gt submit` runs in interactive mode by default and won't push in automated contexts. Always use `gt submit --no-edit` or `gt submit -q` when running from Claude.\n+\n+**Graphite Stack Safety Rules:**\n+\n+- Graphite force-pushes everything - old commits only recoverable via reflog\n+- Never have uncommitted changes when switching branches - they get lost during restack\n+- Never use `git stash` with Graphite - causes conflicts when `gt modify` restacks\n+- Never use `git checkout HEAD -- <file>` after editing - silently restores unfixed version\n+- Always use `gt checkout` (not `git checkout`) to switch branches\n+- `gt modify --no-edit` with unstaged/untracked files stages ALL changes\n+- `gt sync` pulls FROM remote, doesn't push TO remote\n+- `gt modify` restacks children locally but doesn't push them\n+- Always verify with `git status -sb` after stack operations\n+- When resuming from summarized conversation, never trust cached IDs - re-fetch from git/GitHub API\n+\n+**Safe multi-branch fix workflow:**\n+\n+```bash\n+gt checkout parent-branch\n+# make edits\n+gt modify -a --no-edit        # Stage all, amend, restack children\n+git show HEAD -- <files>      # VERIFY fix is in commit\n+gt submit --no-edit           # Push immediately\n+\n+gt checkout child-branch      # Already restacked from gt modify\n+# make edits\n+gt modify -a --no-edit\n+git show HEAD -- <files>      # VERIFY\n+gt submit --no-edit\n+```\n+\n+## Build Commands\n+\n+```bash\n+# Build the Next.js package (dev server only - faster)\n+pnpm --filter=next build:dev-server\n+\n+# Build everything\n+pnpm build\n+\n+# Run specific task\n+pnpm --filter=next taskfile <task>\n+```\n+\n+## Fast Local Development\n+\n+For iterative development, use watch mode + fast test execution:\n+\n+**1. Start watch build in background:**\n+\n+```bash\n+# Runs taskr in watch mode - auto-rebuilds on file changes\n+# Use Bash(run_in_background=true) to keep working while it runs\n+pnpm --filter=next dev\n+```\n+\n+**2. Run tests fast (no isolation, no packing):**\n+\n+```bash\n+# NEXT_SKIP_ISOLATE=1 - skip packing Next.js for each test (much faster)\n+# testonly - runs with --runInBand (no worker isolation overhead)\n+NEXT_SKIP_ISOLATE=1 NEXT_TEST_MODE=dev pnpm testonly test/path/to/test.ts\n+```\n+\n+**3. When done, kill the background watch process.**\n+\n+Only use full `pnpm --filter=next build` for one-off builds (after branch switch, before CI push).\n+\n+**Always rebuild after switching branches:**\n+\n+```bash\n+gt checkout <branch>\n+pnpm build   # Required before running tests (Turborepo dedupes if unchanged)\n+```\n+\n+## Testing\n+\n+```bash\n+# Run specific test file (development mode with Turbopack)\n+pnpm test-dev-turbo test/path/to/test.test.ts\n+\n+# Run tests matching pattern\n+pnpm test-dev-turbo -t \"pattern\"\n+\n+# Run development tests\n+pnpm test-dev-turbo test/development/\n+```\n+\n+**Test commands by mode:**\n+\n+- `pnpm test-dev-turbo` - Development mode with Turbopack (default)\n+- `pnpm test-dev-webpack` - Development mode with Webpack\n+- `pnpm test-start-turbo` - Production build+start with Turbopack\n+- `pnpm test-start-webpack` - Production build+start with Webpack\n+\n+**Other test commands:**\n+\n+- `pnpm test-unit` - Run unit tests only (fast, no browser)\n+- `pnpm testonly <path>` - Run tests without rebuilding (faster iteration)\n+- `pnpm new-test` - Generate a new test file from template\n+\n+## Linting and Types\n+\n+```bash\n+pnpm lint              # Full lint (types, prettier, eslint, ast-grep)\n+pnpm lint-fix          # Auto-fix lint issues\n+pnpm prettier-fix      # Fix formatting only\n+pnpm types             # TypeScript type checking\n+```\n+\n+## Investigating CI Test Failures\n+\n+**Use `/ci-failures` for automated analysis** - analyzes failing jobs in parallel and groups by test file.\n+\n+**CI Analysis Tips:**\n+\n+- Don't spawn too many parallel agents hitting GitHub API (causes rate limits)\n+- Prioritize blocking jobs first: lint, types, then test jobs\n+- Use `gh api` for logs (works on in-progress runs), not `gh run view --log`\n+\n+**Quick triage:**\n+\n+```bash\n+# List failed jobs for a PR\n+gh pr checks <pr-number> | grep fail\n+\n+# Get failed job names\n+gh run view <run-id> --json jobs --jq '.jobs[] | select(.conclusion == \"failure\") | .name'\n+\n+# Search job logs for errors (completed runs only - use gh api for in-progress)\n+gh run view <run-id> --job <job-id> --log 2>&1 | grep -E \"FAIL|Error|error:\" | head -30\n+```\n+\n+**Common failure patterns:**\n+\n+- `rust check / build` → Run `cargo fmt -- --check` locally, fix with `cargo fmt`\n+- `lint / build` → Run `pnpm prettier --write <file>` for prettier errors\n+- Test failures → Run the specific test locally with `pnpm test-dev-turbo <test-path>`\n+\n+**Run tests in the right mode:**\n+\n+```bash\n+# Dev mode (Turbopack)\n+pnpm test-dev-turbo test/path/to/test.ts\n+\n+# Prod mode\n+pnpm test-start-turbo test/path/to/test.ts\n+```\n+\n+## Key Directories\n+\n+- `packages/next/src/` - Main Next.js source code\n+  - `server/` - Server runtime (dev server, router, rendering)\n+  - `client/` - Client-side code\n+  - `build/` - Build tooling (webpack, turbopack configs)\n+  - `cli/` - CLI entry points\n+- `packages/next/dist/` - Compiled output\n+- `turbopack/` - Turbopack bundler (Rust)\n+- `test/` - Test suites\n+  - `development/` - Dev server tests\n+  - `production/` - Production build tests\n+  - `e2e/` - End-to-end tests\n+\n+## Development Tips\n+\n+- The dev server entry point is `packages/next/src/cli/next-dev.ts`\n+- Router server: `packages/next/src/server/lib/router-server.ts`\n+- Use `DEBUG=next:*` for debug logging\n+- Use `NEXT_TELEMETRY_DISABLED=1` when testing locally\n+\n+## Commit and PR Style\n+\n+- Do NOT add \"Generated with Claude Code\" or co-author footers to commits or PRs\n+- Keep commit messages concise and descriptive\n+- PR descriptions should focus on what changed and why\n+\n+## Development Anti-Patterns\n+\n+### Test Gotchas\n+\n+- Mode-specific tests need `skipStart: true` + manual `next.start()` in `beforeAll` after mode check\n+- Don't rely on exact log messages - filter by content patterns, find sequences not positions\n+\n+### Rust/Cargo\n+\n+- cargo fmt uses ASCII order (uppercase before lowercase) - just run `cargo fmt`\n+\n+### Node.js Source Maps\n+\n+- `findSourceMap()` needs `--enable-source-maps` flag or returns undefined\n+- Source map paths vary (webpack: `./src/`, tsc: `src/`) - try multiple formats\n+- `process.cwd()` in stack trace formatting produces different paths in tests vs production"
        }
    ],
    "stats": {
        "total": 374,
        "additions": 374,
        "deletions": 0
    }
}