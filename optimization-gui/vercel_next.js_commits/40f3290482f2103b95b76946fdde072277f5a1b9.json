{
    "author": "mischnic",
    "message": "Turbopack: Webpack loader `this.fs.readFile` (#83313)\n\nUsed here: https://github.com/webpack-contrib/sass-loader/blob/master/src/utils.js#L694",
    "sha": "40f3290482f2103b95b76946fdde072277f5a1b9",
    "files": [
        {
            "sha": "e7077399c03ce1479a655dc647c0545b64531628",
            "filename": "test/e2e/app-dir/webpack-loader-fs/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Flayout.tsx?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ae3ed08abf13350368b2239e4f4ff181772d26da",
            "filename": "test/e2e/app-dir/webpack-loader-fs/app/page.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Fpage.js?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -0,0 +1,9 @@\n+import data from './test.txt'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <p id=\"test\">{data}</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "d536c882412ed3df0dc162823ca5146bcc033499",
            "filename": "test/e2e/app-dir/webpack-loader-fs/app/test.mp4",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Ftest.mp4",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Ftest.mp4",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Ftest.mp4?ref=40f3290482f2103b95b76946fdde072277f5a1b9"
        },
        {
            "sha": "4a4d2f77b63288adf2ba8caa51c2ecfd683722c6",
            "filename": "test/e2e/app-dir/webpack-loader-fs/app/test.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Ftest.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Ftest.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fapp%2Ftest.txt?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -0,0 +1 @@\n+this is some data"
        },
        {
            "sha": "7d341d1fc93b65a3e9a03012bd0be3cdced2e3d6",
            "filename": "test/e2e/app-dir/webpack-loader-fs/next.config.js",
            "status": "added",
            "additions": 22,
            "deletions": 0,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fnext.config.js?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -0,0 +1,22 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  turbopack: {\n+    rules: {\n+      '*.txt': {\n+        loaders: ['./test-file-loader.js'],\n+        as: '*.js',\n+      },\n+    },\n+  },\n+  webpack(config) {\n+    config.module.rules.push({\n+      test: /\\.txt/,\n+      use: './test-file-loader.js',\n+    })\n+    return config\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "3f0cc52c152814f21c568ac2910515f29982b425",
            "filename": "test/e2e/app-dir/webpack-loader-fs/test-file-loader.js",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Ftest-file-loader.js",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Ftest-file-loader.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Ftest-file-loader.js?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -0,0 +1,25 @@\n+const path = require('path')\n+\n+module.exports = async function (content) {\n+  let dir = path.dirname(this.resourcePath)\n+\n+  let read1 = await new Promise((res, rej) =>\n+    this.fs.readFile(path.join(dir, 'test.txt'), (err, data) => {\n+      if (err) return rej(err)\n+      res(data)\n+    })\n+  )\n+  let read2 = await new Promise((res, rej) =>\n+    this.fs.readFile(path.join(dir, 'test.txt'), 'utf8', (err, data) => {\n+      if (err) return rej(err)\n+      res(data)\n+    })\n+  )\n+  let read3 = await new Promise((res, rej) =>\n+    this.fs.readFile(path.join(dir, 'test.mp4'), (err, data) => {\n+      if (err) return rej(err)\n+      res(data)\n+    })\n+  )\n+  return `module.exports = \"Buffer read: ${read1 instanceof Buffer ? read1.length : 0}, string read: '${read2.trim()}', binary read: ${read3.length}\"`\n+}"
        },
        {
            "sha": "17eb26065ed83c94529e0127a2c021a0e5f05df3",
            "filename": "test/e2e/app-dir/webpack-loader-fs/webpack-loader-fs.test.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fwebpack-loader-fs.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fwebpack-loader-fs.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-fs%2Fwebpack-loader-fs.test.ts?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -0,0 +1,15 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('webpack-loader-fs', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  it('should allow reading the input FS', async () => {\n+    const $ = await next.render$('/')\n+    expect($('#test').text()).toBe(\n+      \"Buffer read: 18, string read: 'this is some data', binary read: 6765\"\n+    )\n+  })\n+})"
        },
        {
            "sha": "bfd925a7f234f921d500e4863c87bd39b4da3ebf",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/transforms.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 6,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Ftransforms.ts?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -30,12 +30,17 @@ export type IpcInfoMessage =\n       }>\n     }\n \n-export type IpcRequestMessage = {\n-  type: 'resolve'\n-  options: any\n-  lookupPath: string\n-  request: string\n-}\n+export type IpcRequestMessage =\n+  | {\n+      type: 'resolve'\n+      options: any\n+      lookupPath: string\n+      request: string\n+    }\n+  | {\n+      type: 'trackFileRead'\n+      file: string\n+    }\n \n export type TransformIpc = Ipc<IpcInfoMessage, IpcRequestMessage>\n "
        },
        {
            "sha": "9be523d6ebf2fb287ceec8e4693f4bd227bc133e",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/webpack-loaders.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 1,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -3,7 +3,7 @@ declare const __turbopack_external_require__: {\n } & ((id: string, thunk: () => any, esm?: boolean) => any)\n \n import type { Ipc } from '../ipc/evaluate'\n-import { dirname, resolve as pathResolve } from 'path'\n+import { dirname, resolve as pathResolve, relative } from 'path'\n import {\n   StackFrame,\n   parse as parseStackTrace,\n@@ -15,6 +15,7 @@ import {\n   toPath,\n   type TransformIpc,\n } from './transforms'\n+import fs from 'fs'\n \n export type IpcInfoMessage =\n   | {\n@@ -185,6 +186,24 @@ const transform = (\n               ? entry.options\n               : {}\n           },\n+          fs: {\n+            readFile(p: string, optionsOrCb: any, maybeCb: any) {\n+              ipc\n+                .sendRequest({\n+                  type: 'trackFileRead',\n+                  file: relative(contextDir, pathResolve(p)),\n+                })\n+                .then(\n+                  () => {\n+                    fs.readFile(p, optionsOrCb, maybeCb)\n+                  },\n+                  (err) => {\n+                    ipc.sendError(err)\n+                    // sendError is going to stop the process, no need to call callback\n+                  }\n+                )\n+            },\n+          },\n           getResolve: (options: ResolveOptions) => {\n             const rustOptions = {\n               aliasFields: undefined as undefined | string[],"
        },
        {
            "sha": "2632ff2988534c3abe54012d21c91f669e00db86",
            "filename": "turbopack/crates/turbopack-node/src/transforms/webpack.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/40f3290482f2103b95b76946fdde072277f5a1b9/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40f3290482f2103b95b76946fdde072277f5a1b9/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs?ref=40f3290482f2103b95b76946fdde072277f5a1b9",
            "patch": "@@ -408,12 +408,16 @@ pub enum RequestMessage {\n         lookup_path: RcStr,\n         request: RcStr,\n     },\n+    #[serde(rename_all = \"camelCase\")]\n+    TrackFileRead { file: RcStr },\n }\n \n #[derive(Serialize, Debug)]\n #[serde(untagged)]\n pub enum ResponseMessage {\n     Resolve { path: RcStr },\n+    // Only used for tracking invalidations, no content is returned.\n+    TrackFileRead {},\n }\n \n #[derive(Clone, PartialEq, Eq, Hash, TaskInput, Serialize, Deserialize, Debug, TraceRawVcs)]\n@@ -608,6 +612,12 @@ impl EvaluateContext for WebpackLoaderContext {\n                     );\n                 }\n             }\n+            RequestMessage::TrackFileRead { file } => {\n+                // Ignore result, we read on the JS side again to prevent some IPC overhead. Still\n+                // await the read though to cover at least one class of race conditions.\n+                let _ = &*self.cwd.join(&file)?.read().await?;\n+                Ok(ResponseMessage::TrackFileRead {})\n+            }\n         }\n     }\n "
        }
    ],
    "stats": {
        "total": 127,
        "additions": 120,
        "deletions": 7
    }
}