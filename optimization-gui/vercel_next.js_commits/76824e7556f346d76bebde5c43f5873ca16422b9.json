{
    "author": "kdy1",
    "message": "fix(turbopack): Apply `import_map` option of `swc_emotion` correctly (#71776)\n\n### What?\n\nPreserve the `import_map` config specified by the user\n\n### Why?\n\nThe default mode (webpack mode) supports the `import_map` config, so turbopack should also support it.\n\n### How?\n\nCloses https://github.com/vercel/next.js/issues/71408",
    "sha": "76824e7556f346d76bebde5c43f5873ca16422b9",
    "files": [
        {
            "sha": "8bab795bced7f08c93c38c32a49a98ead48178e1",
            "filename": "test/e2e/app-dir/emotion-js/app/page.js",
            "status": "modified",
            "additions": 11,
            "deletions": 1,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/76824e7556f346d76bebde5c43f5873ca16422b9/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/76824e7556f346d76bebde5c43f5873ca16422b9/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fapp%2Fpage.js?ref=76824e7556f346d76bebde5c43f5873ca16422b9",
            "patch": "@@ -1,5 +1,15 @@\n 'use client'\n+import { styledCss } from 'import-map-test'\n+\n+const red = styledCss`\n+  color: red;\n+`\n \n export default function Page() {\n-  return <h1 css={{ color: 'blue' }}>Blue</h1>\n+  return (\n+    <>\n+      <h1 css={{ color: 'blue' }}>Blue</h1>\n+      <p css={red}>Red</p>\n+    </>\n+  )\n }"
        },
        {
            "sha": "6a710435ba5fd842ffa98a5a24caf6da3bf6730c",
            "filename": "test/e2e/app-dir/emotion-js/index.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/76824e7556f346d76bebde5c43f5873ca16422b9/test%2Fe2e%2Fapp-dir%2Femotion-js%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/76824e7556f346d76bebde5c43f5873ca16422b9/test%2Fe2e%2Fapp-dir%2Femotion-js%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Femotion-js%2Findex.test.ts?ref=76824e7556f346d76bebde5c43f5873ca16422b9",
            "patch": "@@ -26,5 +26,15 @@ describe('app dir - emotion-js', () => {\n         ),\n       'rgb(0, 0, 255)'\n     )\n+\n+    const el2 = browser.elementByCss('p')\n+    expect(await el2.text()).toBe('Red')\n+    await check(\n+      async () =>\n+        await browser.eval(\n+          `window.getComputedStyle(document.querySelector('p')).color`\n+        ),\n+      'rgb(255, 0, 0)'\n+    )\n   })\n })"
        },
        {
            "sha": "4eea95fe8824596b4a2965e5391d6d653f519edf",
            "filename": "test/e2e/app-dir/emotion-js/next.config.js",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/76824e7556f346d76bebde5c43f5873ca16422b9/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/76824e7556f346d76bebde5c43f5873ca16422b9/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fnext.config.js?ref=76824e7556f346d76bebde5c43f5873ca16422b9",
            "patch": "@@ -2,6 +2,14 @@\n module.exports = {\n   reactStrictMode: true,\n   compiler: {\n-    emotion: true,\n+    emotion: {\n+      importMap: {\n+        'import-map-test': {\n+          styledCss: {\n+            canonicalImport: ['@emotion/react', 'css'],\n+          },\n+        },\n+      },\n+    },\n   },\n }"
        },
        {
            "sha": "5c8a0d7cae9b5990a0f2c01d4c468b503a3c039a",
            "filename": "test/e2e/app-dir/emotion-js/node_modules/import-map-test/index.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/76824e7556f346d76bebde5c43f5873ca16422b9/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fnode_modules%2Fimport-map-test%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/76824e7556f346d76bebde5c43f5873ca16422b9/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fnode_modules%2Fimport-map-test%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Femotion-js%2Fnode_modules%2Fimport-map-test%2Findex.js?ref=76824e7556f346d76bebde5c43f5873ca16422b9",
            "patch": "@@ -0,0 +1 @@\n+export { css as styledCss } from '@emotion/react'"
        },
        {
            "sha": "e314eadc43a94ff6f1de26f32fd651c1c7f6491f",
            "filename": "turbopack/crates/turbopack-ecmascript-plugins/src/transform/emotion.rs",
            "status": "modified",
            "additions": 49,
            "deletions": 4,
            "changes": 53,
            "blob_url": "https://github.com/vercel/next.js/blob/76824e7556f346d76bebde5c43f5873ca16422b9/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Femotion.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/76824e7556f346d76bebde5c43f5873ca16422b9/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Femotion.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Femotion.rs?ref=76824e7556f346d76bebde5c43f5873ca16422b9",
            "patch": "@@ -6,15 +6,19 @@ use std::{\n \n use anyhow::Result;\n use async_trait::async_trait;\n-use rustc_hash::FxHasher;\n+use indexmap::IndexMap;\n+use rustc_hash::{FxBuildHasher, FxHasher};\n use serde::{Deserialize, Serialize};\n use swc_core::{\n+    atoms::Atom,\n     common::util::take::Take,\n     ecma::{\n         ast::{Module, Program},\n         visit::FoldWith,\n     },\n };\n+use swc_emotion::ImportMap;\n+use turbo_rcstr::RcStr;\n use turbo_tasks::{trace::TraceRawVcs, NonLocalValue, OperationValue, ValueDefault, Vc};\n use turbopack_ecmascript::{CustomTransformer, TransformContext};\n \n@@ -28,15 +32,45 @@ pub enum EmotionLabelKind {\n     Never,\n }\n \n-//[TODO]: need to support importmap, there are type mismatch between\n-//next.config.js to swc's emotion options\n+#[derive(\n+    Clone, PartialEq, Eq, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue, OperationValue,\n+)]\n+#[serde(rename_all = \"camelCase\")]\n+pub struct EmotionImportItemConfig {\n+    pub canonical_import: EmotionItemSpecifier,\n+    pub styled_base_import: Option<EmotionItemSpecifier>,\n+}\n+\n+impl From<&EmotionImportItemConfig> for swc_emotion::ImportItemConfig {\n+    fn from(value: &EmotionImportItemConfig) -> Self {\n+        swc_emotion::ImportItemConfig {\n+            canonical_import: From::from(&value.canonical_import),\n+            styled_base_import: value.styled_base_import.as_ref().map(From::from),\n+        }\n+    }\n+}\n+\n+#[derive(\n+    Clone, PartialEq, Eq, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue, OperationValue,\n+)]\n+pub struct EmotionItemSpecifier(pub RcStr, pub RcStr);\n+\n+impl From<&EmotionItemSpecifier> for swc_emotion::ItemSpecifier {\n+    fn from(value: &EmotionItemSpecifier) -> Self {\n+        swc_emotion::ItemSpecifier(value.0.as_str().into(), value.1.as_str().into())\n+    }\n+}\n+\n+pub type EmotionImportMapValue = IndexMap<RcStr, EmotionImportItemConfig, FxBuildHasher>;\n+\n #[turbo_tasks::value(shared, operation)]\n #[derive(Default, Clone, Debug)]\n #[serde(rename_all = \"camelCase\")]\n pub struct EmotionTransformConfig {\n     pub sourcemap: Option<bool>,\n     pub label_format: Option<String>,\n     pub auto_label: Option<EmotionLabelKind>,\n+    pub import_map: Option<IndexMap<RcStr, EmotionImportMapValue, FxBuildHasher>>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -78,7 +112,18 @@ impl EmotionTransformer {\n             } else {\n                 None\n             },\n-            ..Default::default()\n+            import_map: config.import_map.as_ref().map(|map| {\n+                map.iter()\n+                    .map(|(k, v)| {\n+                        (\n+                            k.as_str().into(),\n+                            swc_emotion::ImportMapValue::from_iter(v.iter().map(|(k, v)| {\n+                                (k.as_str().into(), swc_emotion::ImportItemConfig::from(v))\n+                            })),\n+                        )\n+                    })\n+                    .collect()\n+            }),\n         };\n \n         Some(EmotionTransformer { config })"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 80,
        "deletions": 6
    }
}