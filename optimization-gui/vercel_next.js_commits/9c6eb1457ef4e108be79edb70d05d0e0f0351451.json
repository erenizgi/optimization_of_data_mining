{
    "author": "mischnic",
    "message": "Turbopack: prevent duplicate NFT modules (#84369)\n\nPreviously, you could have duplicate NFT modules (and duplicate analysis):\r\n- user code ESM imports external `twoslash` which loads `typescript`\r\n- user code CJS imports external `ts-morph` which loads `typescript`\r\n\r\nBoth cases would get different asset contexts, due to `externals_tracing_module_context(ExternalType::CommonJS)`  vs `externals_tracing_module_context(ExternalType::Esm)` \r\n\r\n<img width=\"2560\" height=\"856\" alt=\"Bildschirmfoto 2025-09-30 um 11 00 18\" src=\"https://github.com/user-attachments/assets/7604783b-6e16-4b34-9af3-d8aa65a0cff8\" />",
    "sha": "9c6eb1457ef4e108be79edb70d05d0e0f0351451",
    "files": [
        {
            "sha": "1f13292785aeac55367c0d89684337176144dfea",
            "filename": "crates/next-api/src/next_server_nft.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/9c6eb1457ef4e108be79edb70d05d0e0f0351451/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9c6eb1457ef4e108be79edb70d05d0e0f0351451/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs?ref=9c6eb1457ef4e108be79edb70d05d0e0f0351451",
            "patch": "@@ -18,7 +18,7 @@ use turbopack_core::{\n     file_source::FileSource,\n     output::{OutputAsset, OutputAssets},\n     reference_type::{CommonJsReferenceSubType, ReferenceType},\n-    resolve::{ExternalType, origin::PlainResolveOrigin, parse::Request},\n+    resolve::{origin::PlainResolveOrigin, parse::Request},\n     traced_asset::TracedAsset,\n };\n use turbopack_ecmascript::resolve::cjs_resolve;\n@@ -169,7 +169,6 @@ impl ServerNftJsonAsset {\n         let is_standalone = *self.project.next_config().is_standalone().await?;\n \n         let asset_context = Vc::upcast(externals_tracing_module_context(\n-            ExternalType::CommonJs,\n             get_tracing_compile_time_info(),\n         ));\n "
        },
        {
            "sha": "0c0cbc68ce4eecd357dc90bc0f27467284c0640e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/external_module.rs",
            "status": "modified",
            "additions": 36,
            "deletions": 24,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/9c6eb1457ef4e108be79edb70d05d0e0f0351451/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9c6eb1457ef4e108be79edb70d05d0e0f0351451/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs?ref=9c6eb1457ef4e108be79edb70d05d0e0f0351451",
            "patch": "@@ -4,21 +4,22 @@ use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{NonLocalValue, ResolvedVc, TaskInput, TryJoinIterExt, Vc, trace::TraceRawVcs};\n-use turbo_tasks_fs::{\n-    FileContent, FileSystem, FileSystemPath, VirtualFileSystem, glob::Glob, rope::RopeBuilder,\n-};\n+use turbo_tasks_fs::{FileContent, FileSystem, VirtualFileSystem, glob::Glob, rope::RopeBuilder};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{AsyncModuleInfo, ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n-    context::AssetContext,\n     ident::{AssetIdent, Layer},\n     module::Module,\n     module_graph::ModuleGraph,\n     raw_module::RawModule,\n     reference::{ModuleReference, ModuleReferences, TracedModuleReference},\n     reference_type::ReferenceType,\n-    resolve::parse::Request,\n+    resolve::{\n+        origin::{ResolveOrigin, ResolveOriginExt},\n+        parse::Request,\n+    },\n };\n+use turbopack_resolve::ecmascript::{cjs_resolve, esm_resolve};\n \n use crate::{\n     EcmascriptModuleContent,\n@@ -63,8 +64,7 @@ pub enum CachedExternalType {\n pub enum CachedExternalTracingMode {\n     Untraced,\n     Traced {\n-        externals_context: ResolvedVc<Box<dyn AssetContext>>,\n-        root_origin: FileSystemPath,\n+        origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n     },\n }\n \n@@ -228,29 +228,41 @@ impl Module for CachedExternalModule {\n     async fn references(&self) -> Result<Vc<ModuleReferences>> {\n         Ok(match &self.analyze_mode {\n             CachedExternalTracingMode::Untraced => ModuleReferences::empty(),\n-            CachedExternalTracingMode::Traced {\n-                externals_context,\n-                root_origin,\n-            } => {\n-                let reference_type = match self.external_type {\n+            CachedExternalTracingMode::Traced { origin } => {\n+                let external_result = match self.external_type {\n                     CachedExternalType::EcmaScriptViaImport => {\n-                        ReferenceType::EcmaScriptModules(Default::default())\n+                        esm_resolve(\n+                            **origin,\n+                            Request::parse_string(self.request.clone()),\n+                            Default::default(),\n+                            false,\n+                            None,\n+                        )\n+                        .await?\n+                        .await?\n                     }\n                     CachedExternalType::CommonJs | CachedExternalType::EcmaScriptViaRequire => {\n-                        ReferenceType::CommonJs(Default::default())\n+                        cjs_resolve(\n+                            **origin,\n+                            Request::parse_string(self.request.clone()),\n+                            Default::default(),\n+                            None,\n+                            false,\n+                        )\n+                        .await?\n+                    }\n+                    CachedExternalType::Global | CachedExternalType::Script => {\n+                        origin\n+                            .resolve_asset(\n+                                Request::parse_string(self.request.clone()),\n+                                origin.resolve_options(ReferenceType::Undefined).await?,\n+                                ReferenceType::Undefined,\n+                            )\n+                            .await?\n+                            .await?\n                     }\n-                    _ => ReferenceType::Undefined,\n                 };\n \n-                let external_result = externals_context\n-                    .resolve_asset(\n-                        root_origin.clone(),\n-                        Request::parse_string(self.request.clone()),\n-                        externals_context\n-                            .resolve_options(root_origin.clone(), reference_type.clone()),\n-                        reference_type,\n-                    )\n-                    .await?;\n                 let references = external_result\n                     .affecting_sources\n                     .iter()"
        },
        {
            "sha": "d67bb7b3830ff2d959c55448a9d09abff7ace697",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 15,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/9c6eb1457ef4e108be79edb70d05d0e0f0351451/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/9c6eb1457ef4e108be79edb70d05d0e0f0351451/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=9c6eb1457ef4e108be79edb70d05d0e0f0351451",
            "patch": "@@ -713,19 +713,14 @@ async fn process_default_internal(\n \n #[turbo_tasks::function]\n pub async fn externals_tracing_module_context(\n-    ty: ExternalType,\n     compile_time_info: Vc<CompileTimeInfo>,\n ) -> Result<Vc<ModuleAssetContext>> {\n     let resolve_options = ResolveOptionsContext {\n         enable_node_native_modules: true,\n         emulate_environment: Some(compile_time_info.await?.environment),\n         loose_errors: true,\n         collect_affecting_sources: true,\n-        custom_conditions: match ty {\n-            ExternalType::CommonJs => vec![rcstr!(\"require\"), rcstr!(\"node\")],\n-            ExternalType::EcmaScriptModule => vec![rcstr!(\"import\"), rcstr!(\"node\")],\n-            ExternalType::Url | ExternalType::Global | ExternalType::Script => vec![rcstr!(\"node\")],\n-        },\n+        custom_conditions: vec![rcstr!(\"node\")],\n         ..Default::default()\n     };\n \n@@ -869,16 +864,14 @@ impl AssetContext for ModuleAssetContext {\n                                     // anyway.\n \n                                     let options = options.await?;\n+                                    let origin = PlainResolveOrigin::new(\n+                                        Vc::upcast(externals_tracing_module_context(\n+                                            *options.compile_time_info,\n+                                        )),\n+                                        options.tracing_root.join(\"_\")?,\n+                                    );\n                                     CachedExternalTracingMode::Traced {\n-                                        externals_context: ResolvedVc::upcast(\n-                                            externals_tracing_module_context(\n-                                                ty,\n-                                                *options.compile_time_info,\n-                                            )\n-                                            .to_resolved()\n-                                            .await?,\n-                                        ),\n-                                        root_origin: options.tracing_root.join(\"_\")?,\n+                                        origin: ResolvedVc::upcast(origin.to_resolved().await?),\n                                     }\n                                 } else {\n                                     CachedExternalTracingMode::Untraced"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 45,
        "deletions": 41
    }
}