{
    "author": "sokra",
    "message": "Turbopack: add test case that checks memory leak (#83849)\n\n### What?\n\nadd test case for memory leak",
    "sha": "2838b8b0a55d14bb63f5643cbe78da0fdc09727d",
    "files": [
        {
            "sha": "c9a4f90bf110107b62b364960b2da2cbed7d3d79",
            "filename": "test/development/basic/next-rs-api.test.ts",
            "status": "modified",
            "additions": 159,
            "deletions": 1,
            "changes": 160,
            "blob_url": "https://github.com/vercel/next.js/blob/2838b8b0a55d14bb63f5643cbe78da0fdc09727d/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2838b8b0a55d14bb63f5643cbe78da0fdc09727d/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fnext-rs-api.test.ts?ref=2838b8b0a55d14bb63f5643cbe78da0fdc09727d",
            "patch": "@@ -12,7 +12,8 @@ import type {\n   UpdateInfo,\n } from 'next/dist/build/swc/types'\n import loadConfig from 'next/dist/server/config'\n-import path from 'path'\n+import path, { join } from 'path'\n+import { spawnSync } from 'child_process'\n \n function normalizePath(path: string) {\n   return path\n@@ -147,6 +148,163 @@ function appPageCode(text) {\n export default () => <div>${text}<Client /></div>;`\n }\n \n+describe('next.rs api writeToDisk multiple times', () => {\n+  it('should allow to write to disk multiple times', async () => {\n+    let next: NextInstance\n+\n+    next = await createNext({\n+      skipStart: true,\n+      files: {\n+        'pages/index.js': pagesIndexCode('hello world'),\n+        'lib/props.js': 'export default {}',\n+        'pages/page-nodejs.js': 'export default () => <div>hello world</div>',\n+        'pages/page-edge.js':\n+          'export default () => <div>hello world</div>\\nexport const config = { runtime: \"experimental-edge\" }',\n+        'pages/api/nodejs.js':\n+          'export default () => Response.json({ hello: \"world\" })',\n+        'pages/api/edge.js':\n+          'export default () => Response.json({ hello: \"world\" })\\nexport const config = { runtime: \"edge\" }',\n+        'app/layout.tsx':\n+          'export default function RootLayout({ children }: { children: any }) { return (<html><body>{children}</body></html>)}',\n+        'app/loading.tsx':\n+          'export default function Loading() { return <>Loading</> }',\n+        'app/app/page.tsx': appPageCode('hello world'),\n+        'app/app/client.tsx':\n+          '\"use client\";\\nexport default () => <div>hello world</div>',\n+        'app/app-edge/page.tsx':\n+          'export default () => <div>hello world</div>\\nexport const runtime = \"edge\"',\n+        'app/app-nodejs/page.tsx':\n+          'export default () => <div>hello world</div>',\n+        'app/route-nodejs/route.ts':\n+          'export function GET() { return Response.json({ hello: \"world\" }) }',\n+        'app/route-edge/route.ts':\n+          'export function GET() { return Response.json({ hello: \"world\" }) }\\nexport const runtime = \"edge\"',\n+        'server.js': `\n+process.title = 'next.rs api run test';\n+const path = require('path');\n+const { PHASE_DEVELOPMENT_SERVER } = require('next/constants');\n+const loadConfig = require('next/dist/server/config');\n+const { loadBindings } = require('next/dist/build/swc');\n+const { createDefineEnv } = require('next/dist/build/swc');\n+async function main() {\n+  const nextConfig = await loadConfig.default(\n+    PHASE_DEVELOPMENT_SERVER,\n+    __dirname\n+  );\n+  const bindings = await loadBindings();\n+  const rootPath = __dirname;\n+  const distDir = '.next';\n+  const project = await bindings.turbo.createProject({\n+    env: {},\n+    nextConfig: nextConfig,\n+    rootPath,\n+    projectPath: '.',\n+    distDir,\n+    watch: {\n+      enable: true,\n+    },\n+    dev: true,\n+    defineEnv: createDefineEnv({\n+      projectPath: __dirname,\n+      isTurbopack: true,\n+      clientRouterFilters: undefined,\n+      config: nextConfig,\n+      dev: true,\n+      distDir: path.join(rootPath, distDir),\n+      fetchCacheKeyPrefix: undefined,\n+      hasRewrites: false,\n+      middlewareMatchers: undefined,\n+      rewrites: {\n+        beforeFiles: [],\n+        afterFiles: [],\n+        fallback: [],\n+      },\n+    }),\n+    buildId: 'development',\n+    encryptionKey: '12345',\n+    previewProps: {\n+      previewModeId: 'development',\n+      previewModeEncryptionKey: '12345',\n+      previewModeSigningKey: '12345',\n+    },\n+    browserslistQuery: 'last 2 versions',\n+    noMangling: false,\n+    currentNodeJsVersion: '18.0.0',\n+  });\n+\n+  const entrypointsSubscription = project.entrypointsSubscribe();\n+  const entrypoints = (await entrypointsSubscription.next()).value;\n+\n+  const RUNS = 10000;\n+  async function compileRoute(route) {\n+    const endpoint = route.endpoint ?? route.htmlEndpoint ?? route.pages[0].htmlEndpoint;\n+    if (!endpoint) {\n+      console.log('unexpected route', route);\n+      process.exit(1);\n+    }\n+    for (let i = 0; i < RUNS; i++) {\n+      await endpoint.writeToDisk();\n+    }\n+  }\n+\n+  for (const [name, route] of entrypoints.routes) {\n+    console.log(name, route.type);\n+\n+    console.log('first runs');\n+    await compileRoute(route);\n+    gc(true);\n+    let old = process.memoryUsage();\n+    const initial = old;\n+    let stabilized = false;\n+    for (let j = 0; j < 10; j++) {\n+      await compileRoute(route);\n+      gc(true);\n+      const newMemory = process.memoryUsage();\n+      const addedMemory = newMemory.rss - old.rss;\n+      console.log(\\`#\\${j} \\${RUNS} runs add \\${addedMemory} bytes of memory, memory since first runs \\${newMemory.rss - initial.rss} bytes\\`);\n+      old = newMemory;\n+      if (addedMemory === 0) {\n+        console.log('memory usage stabilized');\n+        stabilized = true;\n+        break;\n+      }\n+    }\n+    if (!stabilized) {\n+      console.log('memory usage did not stabilize, failing');\n+      process.exit(1);\n+    }\n+  }\n+}\n+\n+main()\n+  .then(() => {\n+    process.exit(0);\n+  })\n+  .catch((err) => {\n+    console.error(err);\n+    process.exit(1);\n+  });\n+\n+        `,\n+      },\n+    })\n+\n+    const result = spawnSync(\n+      'node',\n+      ['--expose-gc', join(next.testDir, 'server.js')],\n+      {\n+        stdio: 'inherit',\n+        env: {\n+          ...process.env,\n+        },\n+      }\n+    )\n+    expect(result.status).toBe(0)\n+\n+    await next.destroy()\n+  })\n+})\n+\n describe('next.rs api', () => {\n   let next: NextInstance\n   beforeAll(async () => {"
        }
    ],
    "stats": {
        "total": 160,
        "additions": 159,
        "deletions": 1
    }
}