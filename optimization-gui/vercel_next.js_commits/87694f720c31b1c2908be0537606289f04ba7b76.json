{
    "author": "eps1lon",
    "message": "Only send notification if canary fails on required jobs (#83953)",
    "sha": "87694f720c31b1c2908be0537606289f04ba7b76",
    "files": [
        {
            "sha": "44782740de5613337164007795d31d2ddabc9d31",
            "filename": ".github/workflows/retry_test.yml",
            "status": "modified",
            "additions": 45,
            "deletions": 1,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/87694f720c31b1c2908be0537606289f04ba7b76/.github%2Fworkflows%2Fretry_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/87694f720c31b1c2908be0537606289f04ba7b76/.github%2Fworkflows%2Fretry_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fretry_test.yml?ref=87694f720c31b1c2908be0537606289f04ba7b76",
            "patch": "@@ -39,7 +39,7 @@ jobs:\n             const requiredJobName = {\n               'build-and-test': 'thank you, next',\n               'build-and-deploy': 'thank you, build',\n-            }[context.workflow]\n+            }[github.event.workflow_run.name]\n \n             async function rerunIfRequiredNotSuccessful() {\n               const result = await github.paginate.iterator(\n@@ -93,7 +93,51 @@ jobs:\n       }}\n     runs-on: ubuntu-latest\n     steps:\n+      - name: Check conclusion of required job\n+        id: required_job_conclusion\n+        uses: actions/github-script@v7\n+        continue-on-error: true\n+        env:\n+          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+        with:\n+          script: |\n+            // See build-and-test.yml and build-and-deploy.yml for the required job names\n+            const requiredJobName = {\n+              'build-and-test': 'thank you, next',\n+              'build-and-deploy': 'thank you, build',\n+            }[github.event.workflow_run.name]\n+\n+            async function rerunIfRequiredNotSuccessful() {\n+              const result = await github.paginate.iterator(\n+                'GET /repos/{owner}/{repo}/actions/runs/{run_id}/attempts/{attempt_number}/jobs',\n+                {\n+                  attempt_number: context.payload.workflow_run.run_attempt,\n+                  owner: context.repo.owner,\n+                  repo: context.repo.repo,\n+                  run_id: context.payload.workflow_run.id,\n+                }\n+              )\n+\n+              for await (const { data: jobs } of result) {\n+                for (const job of jobs) {\n+                  if (job.name === requiredJobName) {\n+                    console.log(\n+                      \"Using conclusion '%s' from %s\",\n+                      job.conclusion,\n+                      job.html_url\n+                    )\n+                    return job.conclusion\n+                  }\n+                }\n+              }\n+\n+              console.log(\"Couldn't find job with name '%s'\", requiredJobName)\n+              return null\n+            }\n+\n+            return await rerunIfRequiredNotSuccessful()\n       - name: send webhook\n+        if: ${{ steps.required_job_conclusion.outputs.result != 'success' }}\n         uses: slackapi/slack-github-action@v1.25.0\n         with:\n           # These urls are intentionally missing the protocol,"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 45,
        "deletions": 1
    }
}