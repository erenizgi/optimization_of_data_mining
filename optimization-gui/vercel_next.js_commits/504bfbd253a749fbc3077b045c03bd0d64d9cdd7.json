{
    "author": "xusd320",
    "message": "fix(turbopack): keep the original sourcemap of styles after source transform (#79700)\n\n## Why\nThe original sourcemap be lost after source transform. For example,\na`xyz.sass` file processed by sass-loader, return a `xyz.sass.css`, the\noutput css chunk only contains the sourcemap of `xyz.sass.css` produced\nby lightningcss, `xyz.sass` associated sourcemap been lost.\n\n## How\nExtend lightningcss generated sourcemap with the original sourcemap,\nsee:\n\nhttps://github.com/parcel-bundler/lightningcss/blob/f2dc67c4d3fe92f26693c02366db1e60cae0db27/napi/src/lib.rs#L776\n\n## Related issue\nhttps://github.com/umijs/mako/issues/1915",
    "sha": "504bfbd253a749fbc3077b045c03bd0d64d9cdd7",
    "files": [
        {
            "sha": "e7e7d29e11d9c62342f50c22f30d305fe642f1fe",
            "filename": "test/e2e/app-dir/scss/compilation-and-prefixing/compilation-and-prefixing.test.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 16,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/504bfbd253a749fbc3077b045c03bd0d64d9cdd7/test%2Fe2e%2Fapp-dir%2Fscss%2Fcompilation-and-prefixing%2Fcompilation-and-prefixing.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/504bfbd253a749fbc3077b045c03bd0d64d9cdd7/test%2Fe2e%2Fapp-dir%2Fscss%2Fcompilation-and-prefixing%2Fcompilation-and-prefixing.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fscss%2Fcompilation-and-prefixing%2Fcompilation-and-prefixing.test.ts?ref=504bfbd253a749fbc3077b045c03bd0d64d9cdd7",
            "patch": "@@ -87,25 +87,45 @@ describe.each([\n         if (process.env.IS_TURBOPACK_TEST) {\n           if (dependencies.sass) {\n             expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n-             {\n-               \"mappings\": \"AAAA,iCAAiC\",\n-               \"names\": [],\n-               \"sourcesContent\": [\n-                 \".redText ::placeholder{color:red}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}\",\n-               ],\n-               \"version\": 3,\n-             }\n+              {\n+                \"mappings\": \"AAEE,iCAKF\",\n+                \"names\": [],\n+                \"sourcesContent\": [\n+                  \"$var: red;\n+              .redText {\n+                ::placeholder {\n+                  color: $var;\n+                }\n+              }\n+\n+              .flex-parsing {\n+                flex: 0 0 calc(50% - var(--vertical-gutter));\n+              }\n+              \",\n+                ],\n+                \"version\": 3,\n+              }\n             `)\n           } else {\n             expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n-             {\n-               \"mappings\": \"AAAA,iCAAiC\",\n-               \"names\": [],\n-               \"sourcesContent\": [\n-                 \".redText ::placeholder{color:red}.flex-parsing{flex:0 0 calc(50% - var(--vertical-gutter))}\",\n-               ],\n-               \"version\": 3,\n-             }\n+              {\n+                \"mappings\": \"AAEE,iCAKF\",\n+                \"names\": [],\n+                \"sourcesContent\": [\n+                  \"$var: red;\n+              .redText {\n+                ::placeholder {\n+                  color: $var;\n+                }\n+              }\n+\n+              .flex-parsing {\n+                flex: 0 0 calc(50% - var(--vertical-gutter));\n+              }\n+              \",\n+                ],\n+                \"version\": 3,\n+              }\n             `)\n           }\n         } else {"
        },
        {
            "sha": "111ac8f449e7995e8fcbafa779a2bcdfba46b021",
            "filename": "turbopack/crates/turbopack-css/src/asset.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 3,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/504bfbd253a749fbc3077b045c03bd0d64d9cdd7/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/504bfbd253a749fbc3077b045c03bd0d64d9cdd7/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs?ref=504bfbd253a749fbc3077b045c03bd0d64d9cdd7",
            "patch": "@@ -14,6 +14,7 @@ use turbopack_core::{\n     reference_type::ImportContext,\n     resolve::origin::ResolveOrigin,\n     source::Source,\n+    source_map::GenerateSourceMap,\n };\n \n use crate::{\n@@ -91,14 +92,24 @@ impl ProcessCss for CssModuleAsset {\n     }\n \n     #[turbo_tasks::function]\n-    fn finalize_css(\n+    async fn finalize_css(\n         self: Vc<Self>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n         minify_type: MinifyType,\n-    ) -> Vc<FinalCssResult> {\n+    ) -> Result<Vc<FinalCssResult>> {\n         let process_result = self.get_css_with_placeholder();\n \n-        finalize_css(process_result, chunking_context, minify_type)\n+        let origin_source_map =\n+            match ResolvedVc::try_sidecast::<Box<dyn GenerateSourceMap>>(self.await?.source) {\n+                Some(gsm) => gsm.generate_source_map(),\n+                None => Vc::cell(None),\n+            };\n+        Ok(finalize_css(\n+            process_result,\n+            chunking_context,\n+            minify_type,\n+            origin_source_map,\n+        ))\n     }\n }\n "
        },
        {
            "sha": "bb0944f2c2ec646817071c9804f99cfe818c5528",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/504bfbd253a749fbc3077b045c03bd0d64d9cdd7/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/504bfbd253a749fbc3077b045c03bd0d64d9cdd7/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=504bfbd253a749fbc3077b045c03bd0d64d9cdd7",
            "patch": "@@ -66,6 +66,7 @@ impl StyleSheetLike<'_, '_> {\n         minify_type: MinifyType,\n         enable_srcmap: bool,\n         handle_nesting: bool,\n+        mut origin_source_map: Option<parcel_sourcemap::SourceMap>,\n     ) -> Result<CssOutput> {\n         let ss = &self.0;\n         let mut srcmap = if enable_srcmap {\n@@ -94,8 +95,12 @@ impl StyleSheetLike<'_, '_> {\n         if let Some(srcmap) = &mut srcmap {\n             debug_assert_eq!(ss.sources.len(), 1);\n \n-            srcmap.add_sources(ss.sources.clone());\n-            srcmap.set_source_content(0, code)?;\n+            if let Some(origin_source_map) = origin_source_map.as_mut() {\n+                let _ = srcmap.extends(origin_source_map);\n+            } else {\n+                srcmap.add_sources(ss.sources.clone());\n+                srcmap.set_source_content(0, code)?;\n+            }\n         }\n \n         let srcmap = match srcmap {\n@@ -193,7 +198,7 @@ pub async fn process_css_with_placeholder(\n \n             // We use NoMinify because this is not a final css. We need to replace url references,\n             // and we do final codegen with proper minification.\n-            let (result, _) = stylesheet.to_css(&code, MinifyType::NoMinify, false, false)?;\n+            let (result, _) = stylesheet.to_css(&code, MinifyType::NoMinify, false, false, None)?;\n \n             let exports = result.exports.map(|exports| {\n                 let mut exports = exports.into_iter().collect::<FxIndexMap<_, _>>();\n@@ -222,6 +227,7 @@ pub async fn finalize_css(\n     result: Vc<CssWithPlaceholderResult>,\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n     minify_type: MinifyType,\n+    origin_source_map: Vc<OptionStringifiedSourceMap>,\n ) -> Result<Vc<FinalCssResult>> {\n     let result = result.await?;\n     match &*result {\n@@ -259,7 +265,15 @@ pub async fn finalize_css(\n                 FileContent::Content(v) => v.content().to_str()?,\n                 _ => bail!(\"this case should be filtered out while parsing\"),\n             };\n-            let (result, srcmap) = stylesheet.to_css(&code, minify_type, true, true)?;\n+\n+            let origin_source_map = if let Some(rope) = &*origin_source_map.await? {\n+                Some(parcel_sourcemap::SourceMap::from_json(\"\", &rope.to_str()?)?)\n+            } else {\n+                None\n+            };\n+\n+            let (result, srcmap) =\n+                stylesheet.to_css(&code, minify_type, true, true, origin_source_map)?;\n \n             Ok(FinalCssResult::Ok {\n                 output_code: result.code,"
        }
    ],
    "stats": {
        "total": 91,
        "additions": 68,
        "deletions": 23
    }
}