{
    "author": "timneutkens",
    "message": "Turbopack: Don't add client_runtime_entries to Route Handler compilation (#83655)\n\n## What?\n\nCurrently Route Handlers trigger a compile for the client-side JS\nruntime but it's not required when compiling route handlers.",
    "sha": "498209613e882aa00cd6cdaab867925a6ceea521",
    "files": [
        {
            "sha": "6bfb84b78a954f9f3d3f29b209aca563faace5eb",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 36,
            "deletions": 19,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/498209613e882aa00cd6cdaab867925a6ceea521/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/498209613e882aa00cd6cdaab867925a6ceea521/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=498209613e882aa00cd6cdaab867925a6ceea521",
            "patch": "@@ -1213,13 +1213,21 @@ impl AppEndpoint {\n         let runtime = app_entry.config.await?.runtime.unwrap_or_default();\n \n         let rsc_entry = app_entry.rsc_entry;\n+\n+        let is_app_page = matches!(this.ty, AppEndpointType::Page { .. });\n+\n         let module_graphs = this\n             .app_project\n             .app_module_graphs(\n                 self,\n                 *rsc_entry,\n-                this.app_project.client_runtime_entries(),\n-                matches!(this.ty, AppEndpointType::Page { .. }),\n+                // We only need the client runtime entries for pages not for Route Handlers\n+                if is_app_page {\n+                    this.app_project.client_runtime_entries()\n+                } else {\n+                    EvaluatableAssets::empty()\n+                },\n+                is_app_page,\n             )\n             .await?;\n \n@@ -1241,25 +1249,34 @@ impl AppEndpoint {\n             None\n         };\n \n-        let client_shared_chunk_group = get_app_client_shared_chunk_group(\n-            AssetIdent::from_path(project.project_path().owned().await?)\n-                .with_modifier(rcstr!(\"client-shared-chunks\")),\n-            this.app_project.client_runtime_entries(),\n-            *module_graphs.full,\n-            *client_chunking_context,\n-        )\n-        .await?;\n+        // We only need the client runtime entries for pages not for Route Handlers\n+        let (availability_info, client_shared_chunks) = if is_app_page {\n+            let client_shared_chunk_group = get_app_client_shared_chunk_group(\n+                AssetIdent::from_path(project.project_path().owned().await?)\n+                    .with_modifier(rcstr!(\"client-shared-chunks\")),\n+                this.app_project.client_runtime_entries(),\n+                *module_graphs.full,\n+                *client_chunking_context,\n+            )\n+            .await?;\n \n-        let mut client_shared_chunks = vec![];\n-        for chunk in client_shared_chunk_group.assets.await?.iter().copied() {\n-            client_assets.insert(chunk);\n+            let mut client_shared_chunks = vec![];\n+            for chunk in client_shared_chunk_group.assets.await?.iter().copied() {\n+                client_assets.insert(chunk);\n \n-            let chunk_path = chunk.path().await?;\n-            if chunk_path.has_extension(\".js\") {\n-                client_shared_chunks.push(chunk);\n+                let chunk_path = chunk.path().await?;\n+                if chunk_path.has_extension(\".js\") {\n+                    client_shared_chunks.push(chunk);\n+                }\n             }\n-        }\n-        let client_shared_availability_info = client_shared_chunk_group.availability_info;\n+\n+            (\n+                client_shared_chunk_group.availability_info,\n+                client_shared_chunks,\n+            )\n+        } else {\n+            (AvailabilityInfo::Root, vec![])\n+        };\n \n         let global_information = get_global_information_for_endpoint(\n             *module_graphs.base,\n@@ -1282,7 +1299,7 @@ impl AppEndpoint {\n             *client_references,\n             *module_graphs.full,\n             *client_chunking_context,\n-            client_shared_availability_info,\n+            availability_info,\n             ssr_chunking_context.map(|ctx| *ctx),\n         )\n         .to_resolved()"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 36,
        "deletions": 19
    }
}