{
    "author": "eps1lon",
    "message": "[test] Use new Redbox matchers in app/ ReactRefreshLogBox-builtins (#76394)",
    "sha": "4095ecb5889e88be27e78f3c44d2f04acbfae4a4",
    "files": [
        {
            "sha": "359b6ec1d00b514efd7d1ca51ef6c49a08f5470c",
            "filename": "test/development/acceptance-app/ReactRefreshLogBox-builtins.test.ts",
            "status": "modified",
            "additions": 91,
            "deletions": 93,
            "changes": 184,
            "blob_url": "https://github.com/vercel/next.js/blob/4095ecb5889e88be27e78f3c44d2f04acbfae4a4/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox-builtins.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4095ecb5889e88be27e78f3c44d2f04acbfae4a4/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox-builtins.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2FReactRefreshLogBox-builtins.test.ts?ref=4095ecb5889e88be27e78f3c44d2f04acbfae4a4",
            "patch": "@@ -1,12 +1,10 @@\n import { createSandbox } from 'development-sandbox'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n import path from 'path'\n-import { describeVariants as describe } from 'next-test-utils'\n import { outdent } from 'outdent'\n \n-// TODO-APP: Investigate snapshot mismatch\n-describe.each(['default', 'turbo'])('ReactRefreshLogBox app %s', () => {\n-  const { next } = nextTestSetup({\n+describe('ReactRefreshLogBox-builtins app', () => {\n+  const { isTurbopack, next } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n     skipStart: true,\n   })\n@@ -35,7 +33,7 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox app %s', () => {\n       ])\n     )\n \n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'index.js',\n@@ -47,37 +45,40 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox app %s', () => {\n         }\n       `\n     )\n-    await session.assertHasRedbox()\n-    if (process.env.TURBOPACK) {\n-      expect(await session.getRedboxSource()).toMatchInlineSnapshot(`\n-       \"./node_modules/my-package/index.js (1:13)\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Module not found: Can't resolve 'dns'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./node_modules/my-package/index.js (1:13)\n        Module not found: Can't resolve 'dns'\n        > 1 | const dns = require('dns')\n-           |             ^^^^^^^^^^^^^^\n-         2 | module.exports = dns\n-\n-       https://nextjs.org/docs/messages/module-not-found\"\n+           |             ^^^^^^^^^^^^^^\",\n+         \"stack\": [],\n+       }\n       `)\n     } else {\n-      expect(await session.getRedboxSource()).toMatchInlineSnapshot(`\n-       \"./node_modules/my-package/index.js (1:1)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Module not found: Can't resolve 'dns'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./node_modules/my-package/index.js (1:1)\n        Module not found: Can't resolve 'dns'\n        > 1 | const dns = require('dns')\n-           | ^\n-         2 | module.exports = dns\n-\n-       https://nextjs.org/docs/messages/module-not-found\n-\n-       Import trace for requested module:\n-       ./index.js\n-       ./app/page.js\"\n+           | ^\",\n+         \"stack\": [],\n+       }\n       `)\n     }\n   })\n \n   test('Module not found', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'index.js',\n@@ -93,42 +94,40 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox app %s', () => {\n       `\n     )\n \n-    await session.assertHasRedbox()\n-\n-    const source = await session.getRedboxSource()\n-    if (process.env.TURBOPACK) {\n-      expect(source).toMatchInlineSnapshot(`\n-       \"./index.js (1:1)\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Module not found: Can't resolve 'b'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js (1:1)\n        Module not found: Can't resolve 'b'\n        > 1 | import Comp from 'b'\n-           | ^^^^^^^^^^^^^^^^^^^^\n-         2 | export default function Oops() {\n-         3 |   return (\n-         4 |     <div>\n-\n-       https://nextjs.org/docs/messages/module-not-found\"\n+           | ^^^^^^^^^^^^^^^^^^^^\",\n+         \"stack\": [],\n+       }\n       `)\n     } else {\n-      expect(source).toMatchInlineSnapshot(`\n-       \"./index.js (1:1)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Module not found: Can't resolve 'b'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./index.js (1:1)\n        Module not found: Can't resolve 'b'\n        > 1 | import Comp from 'b'\n-           | ^\n-         2 | export default function Oops() {\n-         3 |   return (\n-         4 |     <div>\n-\n-       https://nextjs.org/docs/messages/module-not-found\n-\n-       Import trace for requested module:\n-       ./app/page.js\"\n+           | ^\",\n+         \"stack\": [],\n+       }\n       `)\n     }\n   })\n \n   test('Module not found empty import trace', async () => {\n     await using sandbox = await createSandbox(next)\n-    const { session } = sandbox\n+    const { browser, session } = sandbox\n \n     await session.patch(\n       'app/page.js',\n@@ -145,34 +144,33 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox app %s', () => {\n       `\n     )\n \n-    await session.assertHasRedbox()\n-\n-    const source = await session.getRedboxSource()\n-    if (process.env.TURBOPACK) {\n-      expect(source).toMatchInlineSnapshot(`\n-       \"./app/page.js (2:1)\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Module not found: Can't resolve 'b'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/page.js (2:1)\n        Module not found: Can't resolve 'b'\n-         1 | 'use client'\n        > 2 | import Comp from 'b'\n-           | ^^^^^^^^^^^^^^^^^^^^\n-         3 | export default function Oops() {\n-         4 |   return (\n-         5 |     <div>\n-\n-       https://nextjs.org/docs/messages/module-not-found\"\n+           | ^^^^^^^^^^^^^^^^^^^^\",\n+         \"stack\": [],\n+       }\n       `)\n     } else {\n-      expect(source).toMatchInlineSnapshot(`\n-       \"./app/page.js (2:1)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Module not found: Can't resolve 'b'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/page.js (2:1)\n        Module not found: Can't resolve 'b'\n-         1 | 'use client'\n        > 2 | import Comp from 'b'\n-           | ^\n-         3 | export default function Oops() {\n-         4 |   return (\n-         5 |     <div>\n-\n-       https://nextjs.org/docs/messages/module-not-found\"\n+           | ^\",\n+         \"stack\": [],\n+       }\n       `)\n     }\n   })\n@@ -193,37 +191,37 @@ describe.each(['default', 'turbo'])('ReactRefreshLogBox app %s', () => {\n         ],\n       ])\n     )\n-    const { session } = sandbox\n-    await session.assertHasRedbox()\n-\n-    const source = await session.getRedboxSource()\n-    if (process.env.TURBOPACK) {\n-      expect(source).toMatchInlineSnapshot(`\n-       \"./app/page.js (2:1)\n+    const { browser, session } = sandbox\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Module not found: Can't resolve './non-existent.css'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/page.js (2:1)\n        Module not found: Can't resolve './non-existent.css'\n-         1 | 'use client'\n        > 2 | import './non-existent.css'\n-           | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\n-         3 | export default function Page(props) {\n-         4 |   return <p>index page</p>\n-         5 | }\n-\n-       https://nextjs.org/docs/messages/module-not-found\"\n+           | ^^^^^^^^^^^^^^^^^^^^^^^^^^^\",\n+         \"stack\": [],\n+       }\n       `)\n     } else {\n-      expect(source).toMatchInlineSnapshot(`\n-       \"./app/page.js (2:1)\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Module not found: Can't resolve './non-existent.css'\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./app/page.js (2:1)\n        Module not found: Can't resolve './non-existent.css'\n-         1 | 'use client'\n        > 2 | import './non-existent.css'\n-           | ^\n-         3 | export default function Page(props) {\n-         4 |   return <p>index page</p>\n-         5 | }\n-\n-       https://nextjs.org/docs/messages/module-not-found\"\n+           | ^\",\n+         \"stack\": [],\n+       }\n       `)\n     }\n+\n     await session.patch(\n       'app/page.js',\n       outdent`"
        }
    ],
    "stats": {
        "total": 184,
        "additions": 91,
        "deletions": 93
    }
}