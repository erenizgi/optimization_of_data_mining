{
    "author": "bgw",
    "message": "chore: Update babel types and do some light cleanup of babel loader (#82486)\n\n- Did my best to reduce the amount of stuff that's `any`-typed.\n- Add comments for bare null or boolean arguments\n- The loader was doing `.call(...)` to set `this` all over the place. Pass it as an explicit argument instead.",
    "sha": "3d5e456a928041ca638ebca54ab511a23d70cd75",
    "files": [
        {
            "sha": "5dd3b9254e916a9909a5702b06350a08d1000468",
            "filename": "packages/next/package.json",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fpackage.json?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -188,11 +188,11 @@\n     \"@taskr/clear\": \"1.1.0\",\n     \"@taskr/esnext\": \"1.1.0\",\n     \"@types/amphtml-validator\": \"1.0.0\",\n-    \"@types/babel__code-frame\": \"7.0.2\",\n-    \"@types/babel__core\": \"7.1.12\",\n-    \"@types/babel__generator\": \"7.6.2\",\n-    \"@types/babel__template\": \"7.4.0\",\n-    \"@types/babel__traverse\": \"7.11.0\",\n+    \"@types/babel__code-frame\": \"7.0.6\",\n+    \"@types/babel__core\": \"7.20.5\",\n+    \"@types/babel__generator\": \"7.27.0\",\n+    \"@types/babel__template\": \"7.4.4\",\n+    \"@types/babel__traverse\": \"7.20.7\",\n     \"@types/bytes\": \"3.1.1\",\n     \"@types/ci-info\": \"2.0.0\",\n     \"@types/compression\": \"0.0.36\","
        },
        {
            "sha": "abaf184c3377fc01f2118693f693df093edb2741",
            "filename": "packages/next/src/build/babel/loader/get-config.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 21,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Fget-config.ts?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -2,14 +2,31 @@ import { readFileSync } from 'fs'\n import JSON5 from 'next/dist/compiled/json5'\n \n import { createConfigItem, loadOptions } from 'next/dist/compiled/babel/core'\n-import loadConfig from 'next/dist/compiled/babel/core-lib-config'\n+import loadFullConfig from 'next/dist/compiled/babel/core-lib-config'\n \n import type { NextBabelLoaderOptions, NextJsLoaderContext } from './types'\n-import { consumeIterator } from './util'\n+import {\n+  consumeIterator,\n+  type SourceMap,\n+  type BabelLoaderTransformOptions,\n+} from './util'\n import * as Log from '../../output/log'\n import jsx from 'next/dist/compiled/babel/plugin-syntax-jsx'\n import { isReactCompilerRequired } from '../../swc'\n \n+/**\n+ * An internal (non-exported) type used by babel.\n+ */\n+export type ResolvedBabelConfig = {\n+  options: BabelLoaderTransformOptions\n+  passes: BabelPluginPasses\n+  externalDependencies: ReadonlyArray<string>\n+}\n+\n+export type BabelPlugin = unknown\n+export type BabelPluginPassList = ReadonlyArray<BabelPlugin>\n+export type BabelPluginPasses = ReadonlyArray<BabelPluginPassList>\n+\n const nextDistPath =\n   /(next[\\\\/]dist[\\\\/]shared[\\\\/]lib)|(next[\\\\/]dist[\\\\/]client)|(next[\\\\/]dist[\\\\/]pages)/\n \n@@ -275,13 +292,13 @@ function checkCustomBabelConfigDeprecation(\n  * This config should have no unresolved overrides, presets, etc.\n  */\n async function getFreshConfig(\n-  this: NextJsLoaderContext,\n+  ctx: NextJsLoaderContext,\n   cacheCharacteristics: CharacteristicsGermaneToCaching,\n   loaderOptions: NextBabelLoaderOptions,\n   target: string,\n   filename: string,\n-  inputSourceMap?: object | null\n-) {\n+  inputSourceMap?: SourceMap\n+): Promise<ResolvedBabelConfig | null> {\n   const hasReactCompiler = await (async () => {\n     if (\n       loaderOptions.reactCompilerPlugins &&\n@@ -314,18 +331,18 @@ async function getFreshConfig(\n \n   let { isServer, pagesDir, srcDir, development } = loaderOptions\n \n-  let options = {\n+  let options: BabelLoaderTransformOptions = {\n     babelrc: false,\n     cloneInputAst: false,\n     filename,\n-    inputSourceMap: inputSourceMap || undefined,\n+    inputSourceMap,\n \n     // Ensure that Webpack will get a full absolute path in the sourcemap\n     // so that it can properly map the module back to its internal cached\n     // modules.\n     sourceFileName: filename,\n-    sourceMaps: this.sourceMap,\n-  } as any\n+    sourceMaps: ctx.sourceMap,\n+  }\n \n   const baseCaller = {\n     name: 'next-babel-turbo-loader',\n@@ -334,7 +351,7 @@ async function getFreshConfig(\n \n     // Provide plugins with insight into webpack target.\n     // https://github.com/babel/babel-loader/issues/787\n-    target: target,\n+    target,\n \n     // Webpack 5 supports TLA behind a flag. We enable it by default\n     // for Babel, and then webpack will throw an error if the experimental\n@@ -374,7 +391,7 @@ async function getFreshConfig(\n     // but allow users to override if they want.\n     options.sourceMaps =\n       loaderOptions.sourceMaps === undefined\n-        ? this.sourceMap\n+        ? ctx.sourceMap\n         : loaderOptions.sourceMaps\n \n     options.plugins = [\n@@ -424,12 +441,12 @@ async function getFreshConfig(\n       if (!(reason instanceof Error)) {\n         reason = new Error(reason)\n       }\n-      this.emitWarning(reason)\n+      ctx.emitWarning(reason)\n     },\n   })\n \n   const loadedOptions = loadOptions(options)\n-  const config = consumeIterator(loadConfig(loadedOptions))\n+  const config = consumeIterator(loadFullConfig(loadedOptions))\n \n   return config\n }\n@@ -453,12 +470,11 @@ function getCacheKey(cacheCharacteristics: CharacteristicsGermaneToCaching) {\n   return fileNameOrExt + flags\n }\n \n-type BabelConfig = any\n-const configCache: Map<any, BabelConfig> = new Map()\n+const configCache: Map<any, ResolvedBabelConfig | null> = new Map()\n const configFiles: Set<string> = new Set()\n \n export default async function getConfig(\n-  this: NextJsLoaderContext,\n+  ctx: NextJsLoaderContext,\n   {\n     source,\n     target,\n@@ -470,9 +486,9 @@ export default async function getConfig(\n     loaderOptions: NextBabelLoaderOptions\n     target: string\n     filename: string\n-    inputSourceMap?: object | null\n+    inputSourceMap?: SourceMap | undefined\n   }\n-): Promise<BabelConfig> {\n+): Promise<ResolvedBabelConfig | null> {\n   const cacheCharacteristics = getCacheCharacteristics(\n     loaderOptions,\n     source,\n@@ -482,7 +498,7 @@ export default async function getConfig(\n \n   if (loaderOptions.transformMode === 'default' && loaderOptions.configFile) {\n     // Ensures webpack invalidates the cache for this loader when the config file changes\n-    this.addDependency(loaderOptions.configFile)\n+    ctx.addDependency(loaderOptions.configFile)\n   }\n \n   const cacheKey = getCacheKey(cacheCharacteristics)\n@@ -515,8 +531,8 @@ export default async function getConfig(\n     )\n   }\n \n-  const freshConfig = await getFreshConfig.call(\n-    this,\n+  const freshConfig = await getFreshConfig(\n+    ctx,\n     cacheCharacteristics,\n     loaderOptions,\n     target,"
        },
        {
            "sha": "68f8733cb7d830612c5547288565ae002f98e453",
            "filename": "packages/next/src/build/babel/loader/index.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 13,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Findex.ts?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -1,25 +1,27 @@\n import type { Span } from '../../../trace'\n import transform from './transform'\n import type { NextJsLoaderContext } from './types'\n+import type { SourceMap } from './util'\n+import type { webpack } from 'next/dist/compiled/webpack/webpack'\n \n async function nextBabelLoader(\n-  this: NextJsLoaderContext,\n+  ctx: NextJsLoaderContext,\n   parentTrace: Span,\n   inputSource: string,\n-  inputSourceMap: object | null | undefined\n-) {\n-  const filename = this.resourcePath\n+  inputSourceMap: SourceMap | null | undefined\n+): Promise<[string, SourceMap | null | undefined]> {\n+  const filename = ctx.resourcePath\n \n   // Ensure `.d.ts` are not processed.\n   if (filename.endsWith('.d.ts')) {\n     return [inputSource, inputSourceMap]\n   }\n \n-  const target = this.target\n+  const target = ctx.target\n   const loaderOptions: any = parentTrace\n     .traceChild('get-options')\n     // @ts-ignore TODO: remove ignore once webpack 5 types are used\n-    .traceFn(() => this.getOptions())\n+    .traceFn(() => ctx.getOptions())\n \n   if (loaderOptions.exclude && loaderOptions.exclude(filename)) {\n     return [inputSource, inputSourceMap]\n@@ -29,8 +31,8 @@ async function nextBabelLoader(\n   const { code: transformedSource, map: outputSourceMap } =\n     await loaderSpanInner.traceAsyncFn(\n       async () =>\n-        await transform.call(\n-          this,\n+        await transform(\n+          ctx,\n           inputSource,\n           inputSourceMap,\n           loaderOptions,\n@@ -43,25 +45,38 @@ async function nextBabelLoader(\n   return [transformedSource, outputSourceMap]\n }\n \n-const nextBabelLoaderOuter = function nextBabelLoaderOuter(\n+function nextBabelLoaderOuter(\n   this: NextJsLoaderContext,\n   inputSource: string,\n-  inputSourceMap: object | null | undefined\n+  // webpack's source map format is compatible with babel, but the type signature doesn't match\n+  inputSourceMap?: any\n ) {\n   const callback = this.async()\n \n   const loaderSpan = this.currentTraceSpan.traceChild('next-babel-turbo-loader')\n   loaderSpan\n     .traceAsyncFn(() =>\n-      nextBabelLoader.call(this, loaderSpan, inputSource, inputSourceMap)\n+      nextBabelLoader(this, loaderSpan, inputSource, inputSourceMap)\n     )\n     .then(\n-      ([transformedSource, outputSourceMap]: any) =>\n-        callback?.(null, transformedSource, outputSourceMap || inputSourceMap),\n+      ([transformedSource, outputSourceMap]) =>\n+        callback?.(\n+          /* err */ null,\n+          transformedSource,\n+          outputSourceMap ?? inputSourceMap\n+        ),\n       (err) => {\n         callback?.(err)\n       }\n     )\n }\n \n+// check this type matches `webpack.LoaderDefinitionFunction`, but be careful\n+// not to publicly rely on the webpack type since the generated typescript\n+// declarations will be wrong.\n+const _nextBabelLoaderOuter: webpack.LoaderDefinitionFunction<\n+  {},\n+  NextJsLoaderContext\n+> = nextBabelLoaderOuter\n+\n export default nextBabelLoaderOuter"
        },
        {
            "sha": "91f1adb1b294c50305f29d23958598077857e6e1",
            "filename": "packages/next/src/build/babel/loader/transform.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftransform.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftransform.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftransform.ts?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -3,7 +3,9 @@\n  */\n \n import traverse from 'next/dist/compiled/babel/traverse'\n-import generate from 'next/dist/compiled/babel/generator'\n+import generate, {\n+  type GeneratorResult,\n+} from 'next/dist/compiled/babel/generator'\n import normalizeFile from 'next/dist/compiled/babel/core-lib-normalize-file'\n import normalizeOpts from 'next/dist/compiled/babel/core-lib-normalize-opts'\n import loadBlockHoistPlugin from 'next/dist/compiled/babel/core-lib-block-hoist-plugin'\n@@ -13,6 +15,7 @@ import getConfig from './get-config'\n import { consumeIterator } from './util'\n import type { Span } from '../../../trace'\n import type { NextJsLoaderContext } from './types'\n+import type { SourceMap } from './util'\n \n function getTraversalParams(file: any, pluginPairs: any[]) {\n   const passPairs = []\n@@ -70,24 +73,25 @@ function transformAst(file: any, babelConfig: any, parentSpan: Span) {\n }\n \n export default async function transform(\n-  this: NextJsLoaderContext,\n+  ctx: NextJsLoaderContext,\n   source: string,\n-  inputSourceMap: object | null | undefined,\n+  inputSourceMap: SourceMap | null | undefined,\n   loaderOptions: any,\n   filename: string,\n   target: string,\n   parentSpan: Span\n-) {\n+): Promise<GeneratorResult> {\n   const getConfigSpan = parentSpan.traceChild('babel-turbo-get-config')\n-  const babelConfig = await getConfig.call(this, {\n+\n+  const babelConfig = await getConfig(ctx, {\n     source,\n     loaderOptions,\n-    inputSourceMap,\n+    inputSourceMap: inputSourceMap ?? undefined,\n     target,\n     filename,\n   })\n   if (!babelConfig) {\n-    return { code: source, map: inputSourceMap }\n+    return { code: source, map: inputSourceMap ?? null }\n   }\n   getConfigSpan.stop()\n "
        },
        {
            "sha": "ae10480d50f82b82a9af2fb59e3c10ee675c9dfd",
            "filename": "packages/next/src/build/babel/loader/types.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftypes.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftypes.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Ftypes.d.ts?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -30,7 +30,7 @@ export type NextBabelLoaderOptionDefaultPresets = NextBabelLoaderBaseOptions & {\n   transformMode: 'default'\n   hasJsxRuntime: boolean\n   hasReactRefresh: boolean\n-  sourceMaps?: any[]\n+  sourceMaps?: boolean | 'inline' | 'both' | null | undefined\n   overrides: any\n   configFile: string | undefined\n }"
        },
        {
            "sha": "5921e27bc908d198eadf880108fde31535cbf8eb",
            "filename": "packages/next/src/build/babel/loader/util.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Futil.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Futil.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Floader%2Futil.ts?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -1,3 +1,5 @@\n+import type { TransformOptions } from 'next/dist/compiled/babel/core'\n+\n export function consumeIterator(iter: Iterator<any>) {\n   while (true) {\n     const { value, done } = iter.next()\n@@ -6,3 +8,19 @@ export function consumeIterator(iter: Iterator<any>) {\n     }\n   }\n }\n+\n+/**\n+ * Source map standard format as to revision 3.\n+ *\n+ * `TransformOptions` uses this type, but doesn't export it separately\n+ */\n+export type SourceMap = NonNullable<TransformOptions['inputSourceMap']>\n+\n+/**\n+ * An extension of the normal babel configuration, with extra `babel-loader`-specific fields that transforms can read.\n+ *\n+ * See: https://github.com/babel/babel-loader/blob/main/src/injectCaller.js\n+ */\n+export type BabelLoaderTransformOptions = TransformOptions & {\n+  target?: string\n+}"
        },
        {
            "sha": "2f8e1e74c6d314d77451e21578b54f70a26aa65e",
            "filename": "packages/next/src/build/babel/plugins/jsx-pragma.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fplugins%2Fjsx-pragma.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fplugins%2Fjsx-pragma.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fplugins%2Fjsx-pragma.ts?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -70,12 +70,7 @@ export default function ({\n                 ;[newPath] = path.unshiftContainer('body', mapping)\n               }\n \n-              for (const declar of newPath.get('declarations')) {\n-                path.scope.registerBinding(\n-                  newPath.node.kind,\n-                  declar as NodePath<BabelTypes.Node>\n-                )\n-              }\n+              path.scope.registerDeclaration(newPath)\n             }\n \n             if (!existingBinding) {"
        },
        {
            "sha": "094a41f3056b326a6d9abb2b64539f87fc322ff0",
            "filename": "packages/next/src/build/babel/plugins/react-loadable-plugin.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fplugins%2Freact-loadable-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fplugins%2Freact-loadable-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbabel%2Fplugins%2Freact-loadable-plugin.ts?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -62,7 +62,7 @@ export default function ({\n           let callExpression = refPath.parentPath\n \n           if (\n-            callExpression.isMemberExpression() &&\n+            callExpression?.isMemberExpression() &&\n             callExpression.node.computed === false\n           ) {\n             const property = callExpression.get('property')\n@@ -74,14 +74,11 @@ export default function ({\n             }\n           }\n \n-          if (!callExpression.isCallExpression()) return\n+          if (!callExpression?.isCallExpression()) return\n \n-          const callExpression_ =\n-            callExpression as NodePath<BabelTypes.CallExpression>\n-\n-          let args = callExpression_.get('arguments')\n+          let args = callExpression.get('arguments')\n           if (args.length > 2) {\n-            throw callExpression_.buildCodeFrameError(\n+            throw callExpression.buildCodeFrameError(\n               'next/dynamic only accepts 2 arguments'\n             )\n           }\n@@ -97,10 +94,10 @@ export default function ({\n             options = args[0]\n           } else {\n             if (!args[1]) {\n-              callExpression_.node.arguments.push(t.objectExpression([]))\n+              callExpression.node.arguments.push(t.objectExpression([]))\n             }\n             // This is needed as the code is modified above\n-            args = callExpression_.get('arguments')\n+            args = callExpression.get('arguments')\n             loader = args[0]\n             options = args[1]\n           }"
        },
        {
            "sha": "28e1fcb32e294aa7d7a456e2463ad6893a099304",
            "filename": "packages/next/src/build/swc/index.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 12,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Findex.ts?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -814,23 +814,21 @@ function bindingToApi(\n     if (reactCompilerOptions) {\n       const ruleKeys = ['*.ts', '*.js', '*.jsx', '*.tsx']\n       if (\n-        Object.keys(nextConfig?.turbopack?.rules ?? []).some((key) =>\n+        Object.keys(nextConfig?.turbopack?.rules ?? {}).some((key) =>\n           ruleKeys.includes(key)\n         )\n       ) {\n         Log.warn(\n-          `The React Compiler cannot be enabled automatically because 'turbopack.rules' contains a rule for '*.ts', '*.js', '*.jsx', and '*.tsx'. Remove this rule, or add 'babel-loader' and 'babel-plugin-react-compiler' to the Turbopack configuration manually.`\n+          \"The React Compiler cannot be enabled automatically because 'turbopack.rules' contains \" +\n+            \"a rule for '*.ts', '*.js', '*.jsx', and '*.tsx'. Remove this rule, or add \" +\n+            \"'babel-loader' and 'babel-plugin-react-compiler' to the Turbopack configuration \" +\n+            'manually.'\n         )\n       } else {\n-        if (!nextConfig.turbopack) {\n-          nextConfig.turbopack = {}\n-        }\n-\n-        if (!nextConfig.turbopack.rules) {\n-          nextConfig.turbopack.rules = {}\n-        }\n+        nextConfig.turbopack ??= {}\n+        nextConfig.turbopack.rules ??= {}\n \n-        for (const key of ['*.ts', '*.js', '*.jsx', '*.tsx']) {\n+        for (const key of ruleKeys) {\n           nextConfig.turbopack.rules[key] = {\n             browser: {\n               foreign: false,\n@@ -839,8 +837,8 @@ function bindingToApi(\n                   originalNextConfig.experimental.reactCompiler,\n                   projectPath,\n                   nextConfig.dev,\n-                  false,\n-                  undefined\n+                  /* isServer */ false,\n+                  /* reactCompilerExclude */ undefined\n                 ),\n               ],\n             },"
        },
        {
            "sha": "a41f0956e3d525a925d35fe9ab05644ab29f428e",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 27,
            "deletions": 52,
            "changes": 79,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -1115,20 +1115,20 @@ importers:\n         specifier: 1.0.0\n         version: 1.0.0\n       '@types/babel__code-frame':\n-        specifier: 7.0.2\n-        version: 7.0.2\n+        specifier: 7.0.6\n+        version: 7.0.6\n       '@types/babel__core':\n-        specifier: 7.1.12\n-        version: 7.1.12\n+        specifier: 7.20.5\n+        version: 7.20.5\n       '@types/babel__generator':\n-        specifier: 7.6.2\n-        version: 7.6.2\n+        specifier: 7.27.0\n+        version: 7.27.0\n       '@types/babel__template':\n-        specifier: 7.4.0\n-        version: 7.4.0\n+        specifier: 7.4.4\n+        version: 7.4.4\n       '@types/babel__traverse':\n-        specifier: 7.11.0\n-        version: 7.11.0\n+        specifier: 7.20.7\n+        version: 7.20.7\n       '@types/bytes':\n         specifier: 3.1.1\n         version: 3.1.1\n@@ -5463,29 +5463,20 @@ packages:\n   '@types/aws-lambda@8.10.119':\n     resolution: {integrity: sha512-Vqm22aZrCvCd6I5g1SvpW151jfqwTzEZ7XJ3yZ6xaZG31nUEOEyzzVImjRcsN8Wi/QyPxId/x8GTtgIbsy8kEw==}\n \n-  '@types/babel__code-frame@7.0.2':\n-    resolution: {integrity: sha512-imO+jT/yjOKOAS5GQZ8SDtwiIloAGGr6OaZDKB0V5JVaSfGZLat5K5/ZRtyKW6R60XHV3RHYPTFfhYb+wDKyKg==}\n-\n-  '@types/babel__core@7.1.12':\n-    resolution: {integrity: sha512-wMTHiiTiBAAPebqaPiPDLFA4LYPKr6Ph0Xq/6rq1Ur3v66HXyG+clfR9CNETkD7MQS8ZHvpQOtA53DLws5WAEQ==}\n+  '@types/babel__code-frame@7.0.6':\n+    resolution: {integrity: sha512-Anitqkl3+KrzcW2k77lRlg/GfLZLWXBuNgbEcIOU6M92yw42vsd3xV/Z/yAHEj8m+KUjL6bWOVOFqX8PFPJ4LA==}\n \n   '@types/babel__core@7.20.5':\n     resolution: {integrity: sha512-qoQprZvz5wQFJwMDqeseRXWv3rqMvhgpbXFfVyWhbx9X47POIA6i/+dXefEmZKoAgOaTdaIgNSMqMIU61yRyzA==}\n \n-  '@types/babel__generator@7.6.2':\n-    resolution: {integrity: sha512-MdSJnBjl+bdwkLskZ3NGFp9YcXGx5ggLpQQPqtgakVhsWK0hTtNYhjpZLlWQTviGTvF8at+Bvli3jV7faPdgeQ==}\n+  '@types/babel__generator@7.27.0':\n+    resolution: {integrity: sha512-ufFd2Xi92OAVPYsy+P4n7/U7e68fex0+Ee8gSG9KX7eo084CWiQ4sdxktvdl0bOPupXtVJPY19zk6EwWqUQ8lg==}\n \n-  '@types/babel__template@7.4.0':\n-    resolution: {integrity: sha512-NTPErx4/FiPCGScH7foPyr+/1Dkzkni+rHiYHHoTjvwou7AQzJkNeD60A9CXRy+ZEN2B1bggmkTMCDb+Mv5k+A==}\n+  '@types/babel__template@7.4.4':\n+    resolution: {integrity: sha512-h/NUaSyG5EyxBIp8YRxo4RMe2/qQgvyowRwVMzhYhBCONbW8PUsg4lkFMrhgZhUe5z3L3MiLDuvyJ/CaPa2A8A==}\n \n-  '@types/babel__traverse@7.11.0':\n-    resolution: {integrity: sha512-kSjgDMZONiIfSH1Nxcr5JIRMwUetDki63FSQfpTCz8ogF3Ulqm8+mr5f78dUYs6vMiB6gBusQqfQmBvHZj/lwg==}\n-\n-  '@types/babel__traverse@7.11.1':\n-    resolution: {integrity: sha512-Vs0hm0vPahPMYi9tDjtP66llufgO3ST16WXaSTtDGEl9cewAl3AibmxWw6TINOqHPT9z0uABKAYjT9jNSg4npw==}\n-\n-  '@types/babel__traverse@7.20.6':\n-    resolution: {integrity: sha512-r1bzfrm0tomOI8g1SzvCaQHo6Lcv6zu0EA+W2kHrt8dyrHQxGzBBL4kdkzIS+jBMV+EYcMAEAqXqYaLJq5rOZg==}\n+  '@types/babel__traverse@7.20.7':\n+    resolution: {integrity: sha512-dkO5fhS7+/oos4ciWxyEyjWe48zmG6wbCheo/G2ZnHx4fs3EU6YC6UM8rk56gAjNJ9P3MTH2jo5jb92/K6wbng==}\n \n   '@types/body-parser@1.17.1':\n     resolution: {integrity: sha512-RoX2EZjMiFMjZh9lmYrwgoP9RTpAjSHiJxdp4oidAQVO02T7HER3xj9UKue5534ULWeqVEkujhWcyvUce+d68w==}\n@@ -21394,42 +21385,26 @@ snapshots:\n \n   '@types/aws-lambda@8.10.119': {}\n \n-  '@types/babel__code-frame@7.0.2': {}\n-\n-  '@types/babel__core@7.1.12':\n-    dependencies:\n-      '@babel/parser': 7.27.0\n-      '@babel/types': 7.27.0\n-      '@types/babel__generator': 7.6.2\n-      '@types/babel__template': 7.4.0\n-      '@types/babel__traverse': 7.11.1\n+  '@types/babel__code-frame@7.0.6': {}\n \n   '@types/babel__core@7.20.5':\n     dependencies:\n       '@babel/parser': 7.27.0\n       '@babel/types': 7.27.0\n-      '@types/babel__generator': 7.6.2\n-      '@types/babel__template': 7.4.0\n-      '@types/babel__traverse': 7.11.0\n+      '@types/babel__generator': 7.27.0\n+      '@types/babel__template': 7.4.4\n+      '@types/babel__traverse': 7.20.7\n \n-  '@types/babel__generator@7.6.2':\n+  '@types/babel__generator@7.27.0':\n     dependencies:\n       '@babel/types': 7.27.0\n \n-  '@types/babel__template@7.4.0':\n+  '@types/babel__template@7.4.4':\n     dependencies:\n       '@babel/parser': 7.27.0\n       '@babel/types': 7.27.0\n \n-  '@types/babel__traverse@7.11.0':\n-    dependencies:\n-      '@babel/types': 7.27.0\n-\n-  '@types/babel__traverse@7.11.1':\n-    dependencies:\n-      '@babel/types': 7.27.0\n-\n-  '@types/babel__traverse@7.20.6':\n+  '@types/babel__traverse@7.20.7':\n     dependencies:\n       '@babel/types': 7.27.0\n \n@@ -22883,7 +22858,7 @@ snapshots:\n       '@babel/template': 7.27.0\n       '@babel/types': 7.27.0\n       '@types/babel__core': 7.20.5\n-      '@types/babel__traverse': 7.11.0\n+      '@types/babel__traverse': 7.20.7\n \n   babel-plugin-macros@3.0.1:\n     dependencies:\n@@ -32378,7 +32353,7 @@ snapshots:\n       '@babel/traverse': 7.27.0\n       '@babel/types': 7.27.0\n       '@types/babel__core': 7.20.5\n-      '@types/babel__traverse': 7.20.6\n+      '@types/babel__traverse': 7.20.7\n       '@types/doctrine': 0.0.9\n       '@types/resolve': 1.20.6\n       doctrine: 3.0.0"
        }
    ],
    "stats": {
        "total": 270,
        "additions": 144,
        "deletions": 126
    }
}