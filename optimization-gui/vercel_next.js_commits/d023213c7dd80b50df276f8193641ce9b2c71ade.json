{
    "author": "wyattjoh",
    "message": "feat(app-router): add clientParamParsingOrigins config for cross-origin rewrite header control (#82849)\n\n### What?\n\nAdds a new experimental configuration option `clientParamParsingOrigins`\nthat allows selective control over which external origins can receive\nrewrite headers during cross-origin rewrites.\n\n### Why?\n\nCurrently, RSC requests only receive rewrite headers for relative\nrewrites, which limits client parameter parsing functionality for\nlegitimate cross-origin scenarios. This feature enables controlled\ncross-origin rewrite header transmission while maintaining security by\ndefault.\n\n### How?\n\n- Adds `clientParamParsingOrigins` as an optional string array to the\nexperimental config\n- Implements regex-based origin matching in the web adapter to determine\nallowed origins\n- Extends the existing rewrite header logic to include allowed\ncross-origin destinations\n- Defaults to `undefined` (secure by default) - no cross-origin rewrites\nreceive headers unless explicitly configured",
    "sha": "d023213c7dd80b50df276f8193641ce9b2c71ade",
    "files": [
        {
            "sha": "a5e77710a0fe267cd57599e37ae9c95e42ab863a",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -473,6 +473,13 @@ export type RoutesManifest = {\n      * app pages when PPR is enabled.\n      */\n     clientParamParsing: boolean\n+\n+    /**\n+     * The origins that are allowed to write the rewritten headers when\n+     * performing a non-relative rewrite. When undefined, no non-relative\n+     * rewrites will get the rewrite headers.\n+     */\n+    clientParamParsingOrigins: string[] | undefined\n   }\n   rewriteHeaders: {\n     pathHeader: typeof NEXT_REWRITTEN_PATH_HEADER\n@@ -1557,6 +1564,9 @@ export default async function build(\n                 // NOTE: once this is the default for `clientSegmentCache`, this\n                 // should exclusively be based on the `clientSegmentCache` flag.\n                 config.experimental.clientParamParsing ?? false,\n+              clientParamParsingOrigins: config.experimental.clientParamParsing\n+                ? config.experimental.clientParamParsingOrigins\n+                : undefined,\n             },\n             rewriteHeaders: {\n               pathHeader: NEXT_REWRITTEN_PATH_HEADER,"
        },
        {
            "sha": "775017636db423e72b948e81c4a157fee17882bd",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -545,6 +545,8 @@ export async function handler(\n             authInterrupts: Boolean(nextConfig.experimental.authInterrupts),\n             clientTraceMetadata:\n               nextConfig.experimental.clientTraceMetadata || ([] as any),\n+            clientParamParsingOrigins:\n+              nextConfig.experimental.clientParamParsingOrigins,\n           },\n \n           waitUntil: ctx.waitUntil,"
        },
        {
            "sha": "9d90279cba1ed0c1317db44eadf792649f152a56",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -169,6 +169,8 @@ async function requestHandler(\n         authInterrupts: Boolean(nextConfig.experimental.authInterrupts),\n         clientTraceMetadata:\n           nextConfig.experimental.clientTraceMetadata || ([] as any),\n+        clientParamParsingOrigins:\n+          nextConfig.experimental.clientParamParsingOrigins,\n       },\n \n       incrementalCache: await pageRouteModule.getIncrementalCache("
        },
        {
            "sha": "0fdd437d5a123efec639e997189bdc413637c6f6",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -405,6 +405,8 @@ async function exportAppImpl(\n           ? 'client-only'\n           : Boolean(nextConfig.experimental.clientSegmentCache),\n       clientParamParsing: nextConfig.experimental.clientParamParsing ?? false,\n+      clientParamParsingOrigins:\n+        nextConfig.experimental.clientParamParsingOrigins,\n       dynamicOnHover: nextConfig.experimental.dynamicOnHover ?? false,\n       inlineCss: nextConfig.experimental.inlineCss ?? false,\n       authInterrupts: !!nextConfig.experimental.authInterrupts,"
        },
        {
            "sha": "143f8f3e788c8c1f4de291bca3e401acdb554b57",
            "filename": "packages/next/src/server/app-render/types.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Ftypes.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -127,6 +127,13 @@ export interface RenderOptsPartial {\n     cacheComponents: boolean\n     clientSegmentCache: boolean | 'client-only'\n     clientParamParsing: boolean\n+\n+    /**\n+     * The origins that are allowed to write the rewritten headers when\n+     * performing a non-relative rewrite. When undefined, no non-relative\n+     * rewrites will get the rewrite headers.\n+     */\n+    clientParamParsingOrigins: string[] | undefined\n     dynamicOnHover: boolean\n     inlineCss: boolean\n     authInterrupts: boolean"
        },
        {
            "sha": "82c0c2d6a8dc30691bb6ec5dcb7c9379c8ca2ea5",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -571,6 +571,8 @@ export default abstract class Server<\n             : Boolean(this.nextConfig.experimental.clientSegmentCache),\n         clientParamParsing:\n           this.nextConfig.experimental.clientParamParsing ?? false,\n+        clientParamParsingOrigins:\n+          this.nextConfig.experimental.clientParamParsingOrigins,\n         dynamicOnHover: this.nextConfig.experimental.dynamicOnHover ?? false,\n         inlineCss: this.nextConfig.experimental.inlineCss ?? false,\n         authInterrupts: !!this.nextConfig.experimental.authInterrupts,"
        },
        {
            "sha": "a96612e38cbaac7291936b11a282000929e979c2",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -372,6 +372,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n           .union([z.boolean(), z.literal('client-only')])\n           .optional(),\n         clientParamParsing: z.boolean().optional(),\n+        clientParamParsingOrigins: z.array(z.string()).optional(),\n         dynamicOnHover: z.boolean().optional(),\n         disableOptimizedLoading: z.boolean().optional(),\n         disablePostcssPresetEnv: z.boolean().optional(),"
        },
        {
            "sha": "172a83dd559f201fae7fe0073bb6ae9ae7bbc0a5",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -455,6 +455,13 @@ export interface ExperimentalConfig {\n   caseSensitiveRoutes?: boolean\n   clientSegmentCache?: boolean | 'client-only'\n   clientParamParsing?: boolean\n+\n+  /**\n+   * The origins that are allowed to write the rewritten headers when\n+   * performing a non-relative rewrite. When undefined, no non-relative\n+   * rewrites will get the rewrite headers.\n+   */\n+  clientParamParsingOrigins?: string[]\n   dynamicOnHover?: boolean\n   preloadEntriesOnStart?: boolean\n   clientRouterFilter?: boolean\n@@ -1540,6 +1547,7 @@ export const defaultConfig = Object.freeze({\n     caseSensitiveRoutes: false,\n     clientSegmentCache: false,\n     clientParamParsing: false,\n+    clientParamParsingOrigins: undefined,\n     dynamicOnHover: false,\n     preloadEntriesOnStart: true,\n     clientRouterFilter: true,"
        },
        {
            "sha": "1b85f7a6665f6aff059de68bc4ff2069fa89405f",
            "filename": "packages/next/src/server/lib/router-utils/resolve-routes.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 8,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fresolve-routes.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -790,16 +790,21 @@ export function getResolveRoutes(\n             query: parsedUrl.query,\n           })\n \n-          if (parsedDestination.protocol) {\n-            return {\n-              // @ts-expect-error custom ParsedUrl\n-              parsedUrl: parsedDestination,\n-              finished: true,\n-            }\n-          }\n+          // Check to see if this is a non-relative rewrite. If it is, we need\n+          // to check to see if it's an allowed origin to receive the rewritten\n+          // headers.\n+          const parsedDestinationOrigin = parsedDestination.origin\n+          const isAllowedOrigin = parsedDestinationOrigin\n+            ? config.experimental.clientParamParsingOrigins?.some((origin) =>\n+                new RegExp(origin).test(parsedDestinationOrigin)\n+              )\n+            : false\n \n           // Set the rewrite headers only if this is a RSC request.\n-          if (req.headers[RSC_HEADER] === '1') {\n+          if (\n+            req.headers[RSC_HEADER] === '1' &&\n+            (!parsedDestination.origin || isAllowedOrigin)\n+          ) {\n             // We set the rewritten path and query headers on the response now\n             // that we know that the it's not an external rewrite.\n             if (parsedUrl.pathname !== parsedDestination.pathname) {\n@@ -817,6 +822,14 @@ export function getResolveRoutes(\n             }\n           }\n \n+          if (parsedDestination.protocol) {\n+            return {\n+              // @ts-expect-error custom ParsedUrl\n+              parsedUrl: parsedDestination,\n+              finished: true,\n+            }\n+          }\n+\n           if (config.i18n) {\n             const curLocaleResult = normalizeLocalePath(\n               removePathPrefix(parsedDestination.pathname, config.basePath),"
        },
        {
            "sha": "bd9537d398eb90db43656a37be28435806def588",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 1,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -380,10 +380,19 @@ export async function adapter(\n       response.headers.set('x-nextjs-rewrite', relativeDestination)\n     }\n \n+    // Check to see if this is a non-relative rewrite. If it is, we need\n+    // to check to see if it's an allowed origin to receive the rewritten\n+    // headers.\n+    const isAllowedOrigin = !isRelative\n+      ? params.request.nextConfig?.experimental?.clientParamParsingOrigins?.some(\n+          (origin) => new RegExp(origin).test(destination.origin)\n+        )\n+      : false\n+\n     // If this is an RSC request, and the pathname or search has changed, and\n     // this isn't an external rewrite, we need to set the rewritten pathname and\n     // query headers.\n-    if (isRSCRequest && isRelative) {\n+    if (isRSCRequest && (isRelative || isAllowedOrigin)) {\n       if (requestURL.pathname !== destination.pathname) {\n         response.headers.set(NEXT_REWRITTEN_PATH_HEADER, destination.pathname)\n       }"
        },
        {
            "sha": "7d9c88f75333c18add3f7418fabc51fdf8f6be20",
            "filename": "packages/next/src/server/web/types.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Ftypes.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -15,7 +15,10 @@ export interface RequestData {\n     basePath?: string\n     i18n?: I18NConfig | null\n     trailingSlash?: boolean\n-    experimental?: Pick<ExperimentalConfig, 'cacheLife' | 'authInterrupts'>\n+    experimental?: Pick<\n+      ExperimentalConfig,\n+      'cacheLife' | 'authInterrupts' | 'clientParamParsingOrigins'\n+    >\n   }\n   page?: {\n     name?: string"
        },
        {
            "sha": "dcf518a49410b0ae306603e3aea4e484cb1751d7",
            "filename": "packages/next/src/shared/lib/router/utils/parse-url.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fparse-url.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -11,6 +11,7 @@ export interface ParsedUrl {\n   port?: string | null\n   protocol?: string | null\n   query: ParsedUrlQuery\n+  origin?: string | null\n   search: string\n   slashes: boolean | undefined\n }\n@@ -30,6 +31,7 @@ export function parseUrl(url: string): ParsedUrl {\n     protocol: parsedURL.protocol,\n     query: searchParamsToUrlQuery(parsedURL.searchParams),\n     search: parsedURL.search,\n+    origin: parsedURL.origin,\n     slashes:\n       parsedURL.href.slice(\n         parsedURL.protocol.length,"
        },
        {
            "sha": "b82c84c83a0453067693c09fd115ce03ea0a34d3",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.test.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -17,6 +17,7 @@ describe('parseDestination', () => {\n        \"hash\": \"\",\n        \"hostname\": undefined,\n        \"href\": \"/hello/:name\",\n+       \"origin\": undefined,\n        \"pathname\": \"/hello/:name\",\n        \"query\": {},\n        \"search\": \"\",\n@@ -41,6 +42,7 @@ describe('parseDestination', () => {\n        \"hash\": \"#bar\",\n        \"hostname\": \"o:foo.com\",\n        \"href\": \"https://o:foo.com/hello/:name#bar\",\n+       \"origin\": \"https://o:foo.com\",\n        \"pathname\": \"/hello/:name\",\n        \"port\": \"\",\n        \"protocol\": \"https:\",\n@@ -67,6 +69,7 @@ describe('parseDestination', () => {\n        \"hash\": \"\",\n        \"hostname\": \"o:foo.com\",\n        \"href\": \"https://o:foo.com/hello/:name?foo=:bar\",\n+       \"origin\": \"https://o:foo.com\",\n        \"pathname\": \"/hello/:name\",\n        \"port\": \"\",\n        \"protocol\": \"https:\","
        },
        {
            "sha": "22f0b2cfac981577d97811b0ff110b226f25897c",
            "filename": "packages/next/src/shared/lib/router/utils/prepare-destination.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d023213c7dd80b50df276f8193641ce9b2c71ade/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Futils%2Fprepare-destination.ts?ref=d023213c7dd80b50df276f8193641ce9b2c71ade",
            "patch": "@@ -198,13 +198,19 @@ export function parseDestination(args: {\n     search = unescapeSegments(search)\n   }\n \n+  let origin = parsed.origin\n+  if (origin) {\n+    origin = unescapeSegments(origin)\n+  }\n+\n   return {\n     ...parsed,\n     pathname,\n     hostname,\n     href,\n     hash,\n     search,\n+    origin,\n   }\n }\n "
        }
    ],
    "stats": {
        "total": 90,
        "additions": 80,
        "deletions": 10
    }
}