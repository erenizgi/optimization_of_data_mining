{
    "author": "bgw",
    "message": "Turbopack: Switch RequestKey's `conditions` field from BTreeMap to FrozenMap (#87099)\n\nDoing this as a small trial of the new `FrozenMap` API. @lukesandberg pointed this out as a potentially good candidate.",
    "sha": "c450169e922f745feb1468f60cec53f761dc3820",
    "files": [
        {
            "sha": "1c6e6b6ba49b897fc4d5661cc010db9b99687aa8",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c450169e922f745feb1468f60cec53f761dc3820/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/c450169e922f745feb1468f60cec53f761dc3820/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=c450169e922f745feb1468f60cec53f761dc3820",
            "patch": "@@ -9674,6 +9674,7 @@ dependencies = [\n  \"tokio\",\n  \"tracing\",\n  \"turbo-bincode\",\n+ \"turbo-frozenmap\",\n  \"turbo-prehash\",\n  \"turbo-rcstr\",\n  \"turbo-tasks\","
        },
        {
            "sha": "cf99eba3dfb9a418e281e920d9bae5b7252b56d3",
            "filename": "turbopack/crates/turbo-frozenmap/src/map.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c450169e922f745feb1468f60cec53f761dc3820/turbopack%2Fcrates%2Fturbo-frozenmap%2Fsrc%2Fmap.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c450169e922f745feb1468f60cec53f761dc3820/turbopack%2Fcrates%2Fturbo-frozenmap%2Fsrc%2Fmap.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-frozenmap%2Fsrc%2Fmap.rs?ref=c450169e922f745feb1468f60cec53f761dc3820",
            "patch": "@@ -381,6 +381,17 @@ impl<K, V> FrozenMap<K, V> {\n             inner: slice.iter(),\n         }\n     }\n+\n+    /// Extend this [`FrozenMap`] by constructing a new map with the additional entries. New entries\n+    /// with overlapping keys will overwrite existing ones.\n+    #[must_use]\n+    pub fn extend(&self, entries: impl IntoIterator<Item = (K, V)>) -> Self\n+    where\n+        K: Clone + Ord,\n+        V: Clone,\n+    {\n+        self.as_slice().iter().cloned().chain(entries).collect()\n+    }\n }\n \n // Manual implementation because the derive would add unnecessary `K: Default, V: Default` bounds."
        },
        {
            "sha": "9ee2324fa143638e0fad69b198ea37bb04130ee8",
            "filename": "turbopack/crates/turbopack-core/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c450169e922f745feb1468f60cec53f761dc3820/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c450169e922f745feb1468f60cec53f761dc3820/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml?ref=c450169e922f745feb1468f60cec53f761dc3820",
            "patch": "@@ -39,6 +39,7 @@ swc_sourcemap = { workspace = true }\n swc_core = { workspace = true, features = [\"ecma_preset_env\", \"common\"] }\n tracing = { workspace = true }\n turbo-bincode = { workspace = true }\n+turbo-frozenmap = { workspace = true }\n turbo-prehash = { workspace = true }\n turbo-rcstr = { workspace = true }\n turbo-tasks = { workspace = true }\n@@ -51,7 +52,6 @@ url = { workspace = true }\n urlencoding = { workspace = true }\n uuid = { workspace = true}\n \n-\n [dev-dependencies]\n rstest = { workspace = true }\n tokio = { workspace = true }"
        },
        {
            "sha": "bcaa0fa37b2356cacfe0b2fc9d0eeb5fc51421c9",
            "filename": "turbopack/crates/turbopack-core/src/resolve/mod.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 15,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/c450169e922f745feb1468f60cec53f761dc3820/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c450169e922f745feb1468f60cec53f761dc3820/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fmod.rs?ref=c450169e922f745feb1468f60cec53f761dc3820",
            "patch": "@@ -15,6 +15,7 @@ use rustc_hash::{FxHashMap, FxHashSet};\n use serde::{Deserialize, Serialize};\n use smallvec::SmallVec;\n use tracing::{Instrument, Level};\n+use turbo_frozenmap::FrozenMap;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{\n     FxIndexMap, FxIndexSet, NonLocalValue, ReadRef, ResolvedVc, SliceMap, TaskInput,\n@@ -477,7 +478,7 @@ pub enum ResolveResultItem {\n #[turbo_tasks::value]\n pub struct RequestKey {\n     pub request: Option<RcStr>,\n-    pub conditions: BTreeMap<String, bool>,\n+    pub conditions: FrozenMap<RcStr, bool>,\n }\n \n impl Display for RequestKey {\n@@ -756,19 +757,26 @@ impl ResolveResult {\n         }\n     }\n \n-    pub fn add_conditions(&mut self, conditions: impl IntoIterator<Item = (RcStr, bool)>) {\n-        let mut primary = std::mem::take(&mut self.primary);\n-        for (k, v) in conditions {\n-            for (key, _) in primary.iter_mut() {\n-                key.conditions.insert(k.to_string(), v);\n-            }\n-        }\n-        // Deduplicate\n-        self.primary = IntoIterator::into_iter(primary)\n-            .collect::<FxIndexMap<_, _>>()\n+    pub fn with_conditions(&self, new_conditions: &[(RcStr, bool)]) -> Self {\n+        let primary = self\n+            .primary\n+            .iter()\n+            .map(|(k, v)| {\n+                (\n+                    RequestKey {\n+                        request: k.request.clone(),\n+                        conditions: k.conditions.extend(new_conditions.iter().cloned()),\n+                    },\n+                    v.clone(),\n+                )\n+            })\n+            .collect::<FxIndexMap<_, _>>() // Deduplicate\n             .into_iter()\n-            .collect::<Vec<_>>()\n-            .into_boxed_slice();\n+            .collect();\n+        ResolveResult {\n+            primary,\n+            affecting_sources: self.affecting_sources.clone(),\n+        }\n     }\n }\n \n@@ -3119,8 +3127,7 @@ async fn handle_exports_imports_field(\n             };\n \n             let resolve_result = if !conditions.is_empty() {\n-                let mut resolve_result = resolve_result.owned().await?;\n-                resolve_result.add_conditions(conditions);\n+                let resolve_result = resolve_result.await?.with_conditions(&conditions);\n                 resolve_result.cell()\n             } else {\n                 resolve_result"
        },
        {
            "sha": "89da0655c397649aa9834a539184b17c245eec99",
            "filename": "turbopack/crates/turbopack-resolve/src/typescript.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 4,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c450169e922f745feb1468f60cec53f761dc3820/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c450169e922f745feb1468f60cec53f761dc3820/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Ftypescript.rs?ref=c450169e922f745feb1468f60cec53f761dc3820",
            "patch": "@@ -15,7 +15,7 @@ use turbopack_core::{\n     },\n     reference_type::{ReferenceType, TypeScriptReferenceSubType},\n     resolve::{\n-        AliasPattern, ModuleResolveResult, handle_resolve_error,\n+        AliasPattern, ModuleResolveResult, RequestKey, handle_resolve_error,\n         node::node_cjs_resolve_options,\n         options::{\n             ConditionValue, ImportMap, ImportMapping, ResolveIntoPackage, ResolveModules,\n@@ -479,9 +479,14 @@ pub async fn type_resolve(\n pub async fn as_typings_result(result: Vc<ModuleResolveResult>) -> Result<Vc<ModuleResolveResult>> {\n     let mut result = result.owned().await?;\n     result.primary = IntoIterator::into_iter(take(&mut result.primary))\n-        .map(|(mut k, v)| {\n-            k.conditions.insert(\"types\".to_string(), true);\n-            (k, v)\n+        .map(|(k, v)| {\n+            (\n+                RequestKey {\n+                    request: k.request.clone(),\n+                    conditions: k.conditions.extend([(rcstr!(\"types\"), true)]),\n+                },\n+                v,\n+            )\n         })\n         .collect();\n     Ok(result.cell())"
        }
    ],
    "stats": {
        "total": 64,
        "additions": 44,
        "deletions": 20
    }
}