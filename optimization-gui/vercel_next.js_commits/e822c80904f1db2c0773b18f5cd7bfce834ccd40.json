{
    "author": "styfle",
    "message": "fix: add `?dpl` to fonts in `/_next/static/media` part 2 (#82488)\n\nThis is a follow up to PR https://github.com/vercel/next.js/pull/82384\nwhich fixed it for `<link>` but not for `next/font` that embeds local\nfonts in css.\n\n\nhttps://nextjs.org/docs/14/app/building-your-application/deploying#version-skew",
    "sha": "e822c80904f1db2c0773b18f5cd7bfce834ccd40",
    "files": [
        {
            "sha": "9884eb7a2eae1b79cfcda1abb21a7046d650ec44",
            "filename": "packages/font/src/google/loader.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Fgoogle%2Floader.test.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -124,6 +124,7 @@ describe('next/font/google loader', () => {\n         mockFetchResource.mockResolvedValue(Buffer.from('OK'))\n         const { css } = await nextFontGoogleFontLoader({\n           functionName,\n+          deploymentId: undefined,\n           data: [\n             {\n               adjustFontFallback: false,"
        },
        {
            "sha": "7145062ab7b05c0b406bfc5d0c783c26c35fb647",
            "filename": "packages/font/src/local/loader.test.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Ffont%2Fsrc%2Flocal%2Floader.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Ffont%2Fsrc%2Flocal%2Floader.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Flocal%2Floader.test.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -5,6 +5,7 @@ describe('next/font/local loader', () => {\n     test('Default CSS', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n+        deploymentId: undefined,\n         data: [{ src: './my-font.woff2' }],\n         emitFontFile: () => '/_next/static/media/my-font.woff2',\n         resolve: jest.fn(),\n@@ -28,9 +29,37 @@ describe('next/font/local loader', () => {\n       `)\n     })\n \n+    test('with dpl query string', async () => {\n+      const { css } = await nextFontLocalFontLoader({\n+        functionName: '',\n+        deploymentId: 'dpl_123',\n+        data: [{ src: './my-font.woff2' }],\n+        emitFontFile: () => '/_next/static/media/my-font.woff2',\n+        resolve: jest.fn(),\n+        isDev: false,\n+        isServer: true,\n+        variableName: 'myFont',\n+        loaderContext: {\n+          fs: {\n+            readFile: (_: string, cb: any) => cb(null, 'fontdata'),\n+          },\n+        } as any,\n+      })\n+\n+      expect(css).toMatchInlineSnapshot(`\n+        \"@font-face {\n+        font-family: myFont;\n+        src: url(/_next/static/media/my-font.woff2?dpl=dpl_123) format('woff2');\n+        font-display: swap;\n+        }\n+        \"\n+      `)\n+    })\n+\n     test('Weight and style', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n+        deploymentId: undefined,\n         data: [{ src: './my-font.woff2', weight: '100 900', style: 'italic' }],\n         emitFontFile: () => '/_next/static/media/my-font.woff2',\n         resolve: jest.fn(),\n@@ -59,6 +88,7 @@ describe('next/font/local loader', () => {\n     test('Other properties', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n+        deploymentId: undefined,\n         data: [\n           {\n             src: './my-font.woff2',\n@@ -95,6 +125,7 @@ describe('next/font/local loader', () => {\n     test('Multiple weights default style', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n+        deploymentId: undefined,\n         data: [\n           {\n             style: 'italic',\n@@ -171,6 +202,7 @@ describe('next/font/local loader', () => {\n     test('Multiple styles default weight', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n+        deploymentId: undefined,\n         data: [\n           {\n             weight: '400',\n@@ -233,6 +265,7 @@ describe('next/font/local loader', () => {\n     test('Custom font-family in declarations', async () => {\n       const { css } = await nextFontLocalFontLoader({\n         functionName: '',\n+        deploymentId: undefined,\n         data: [\n           {\n             src: './my-font.woff2',"
        },
        {
            "sha": "49fb93c3238288b9d0db499cd92db3ca3d6b4526",
            "filename": "packages/font/src/local/loader.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Ffont%2Fsrc%2Flocal%2Floader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Ffont%2Fsrc%2Flocal%2Floader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Ffont%2Fsrc%2Flocal%2Floader.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -19,6 +19,7 @@ const nextFontLocalFontLoader: FontLoader = async ({\n   data,\n   emitFontFile,\n   resolve,\n+  deploymentId,\n   loaderContext,\n }) => {\n   const {\n@@ -45,6 +46,10 @@ const nextFontLocalFontLoader: FontLoader = async ({\n         preload,\n         typeof adjustFontFallback === 'undefined' || !!adjustFontFallback\n       )\n+      // Should match behavior in get-asset-query-string.ts\n+      const qs = deploymentId\n+        ? `${fontUrl.includes('?') ? '&' : '?'}dpl=${deploymentId}`\n+        : ''\n \n       // Try to load font metadata from the font file using fontkit.\n       // The data is used to calculate the fallback font override values.\n@@ -66,7 +71,7 @@ const nextFontLocalFontLoader: FontLoader = async ({\n           ? declarations.map(({ prop, value }) => [prop, value])\n           : []),\n         ...(hasCustomFontFamily ? [] : [['font-family', variableName]]),\n-        ['src', `url(${fontUrl}) format('${format}')`],\n+        ['src', `url(${fontUrl + qs}) format('${format}')`],\n         ['font-display', display],\n         ...(weight ?? defaultWeight\n           ? [['font-weight', weight ?? defaultWeight]]"
        },
        {
            "sha": "0d97d953a96a58b60d05619623ccebbc7fe5e44f",
            "filename": "packages/next/font/index.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Ffont%2Findex.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Ffont%2Findex.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ffont%2Findex.d.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -19,6 +19,7 @@ export type FontLoader = (options: {\n   resolve: (src: string) => string\n   isDev: boolean\n   isServer: boolean\n+  deploymentId: string | undefined\n   loaderContext: any\n }) => Promise<{\n   css: string"
        },
        {
            "sha": "12597dcaa57cb1a65bbe93449c3ffe5b74bdd44c",
            "filename": "packages/next/src/build/webpack-config.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-config.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -2454,6 +2454,7 @@ export default async function getBaseWebpackConfig(\n     isEdgeRuntime: isEdgeServer,\n     targetWeb: isClient || isEdgeServer,\n     assetPrefix: config.assetPrefix || '',\n+    deploymentId: config.deploymentId,\n     sassOptions: config.sassOptions,\n     productionBrowserSourceMaps: config.productionBrowserSourceMaps,\n     future: config.future,"
        },
        {
            "sha": "55909b3d5e3a3f5666a28f1cafb659773150495a",
            "filename": "packages/next/src/build/webpack/config/blocks/css/loaders/next-font.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fnext-font.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fnext-font.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fcss%2Floaders%2Fnext-font.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -62,6 +62,7 @@ export function getNextFontLoader(\n       isDev: ctx.isDevelopment,\n       isServer: ctx.isServer,\n       assetPrefix: ctx.assetPrefix,\n+      deploymentId: ctx.deploymentId,\n       fontLoaderPath,\n       postcss,\n     },"
        },
        {
            "sha": "ccd7d4203374d36f0db7afacad5fddbcf8e1bcae",
            "filename": "packages/next/src/build/webpack/config/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Findex.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -19,6 +19,7 @@ export async function buildConfiguration(\n     isEdgeRuntime,\n     targetWeb,\n     assetPrefix,\n+    deploymentId,\n     sassOptions,\n     productionBrowserSourceMaps,\n     future,\n@@ -36,6 +37,7 @@ export async function buildConfiguration(\n     isEdgeRuntime: boolean\n     targetWeb: boolean\n     assetPrefix: string\n+    deploymentId: string | undefined\n     sassOptions: any\n     productionBrowserSourceMaps: boolean\n     transpilePackages: NextConfigComplete['transpilePackages']\n@@ -61,6 +63,7 @@ export async function buildConfiguration(\n         ? assetPrefix.slice(0, -1)\n         : assetPrefix\n       : '',\n+    deploymentId,\n     sassOptions,\n     productionBrowserSourceMaps,\n     transpilePackages,"
        },
        {
            "sha": "c3862a11099ff1f0d85e2657b1a3225191b16310",
            "filename": "packages/next/src/build/webpack/config/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Futils.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -19,6 +19,7 @@ export type ConfigurationContext = {\n   targetWeb: boolean\n \n   assetPrefix: string\n+  deploymentId: string | undefined\n \n   sassOptions: any\n   productionBrowserSourceMaps: boolean"
        },
        {
            "sha": "9740c07e90d5b7d64c63ffa83d7e910a137ed5f6",
            "filename": "packages/next/src/build/webpack/loaders/next-font-loader/index.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e822c80904f1db2c0773b18f5cd7bfce834ccd40/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-font-loader%2Findex.ts?ref=e822c80904f1db2c0773b18f5cd7bfce834ccd40",
            "patch": "@@ -45,6 +45,7 @@ export default async function nextFontLoader(this: any) {\n       assetPrefix,\n       fontLoaderPath,\n       postcss: getPostcss,\n+      deploymentId,\n     } = this.getOptions()\n \n     if (assetPrefix && !/^\\/|https?:\\/\\//.test(assetPrefix)) {\n@@ -66,7 +67,7 @@ export default async function nextFontLoader(this: any) {\n      * NextFontManifestPlugin uses this to see if fallback fonts are being used.\n      * This is used to collect stats on fallback fonts usage by the Google Aurora team.\n      */\n-    const emitFontFile = (\n+    const emitFontFile: Parameters<FontLoader>[0]['emitFontFile'] = (\n       content: Buffer,\n       ext: string,\n       preload: boolean,\n@@ -109,6 +110,7 @@ export default async function nextFontLoader(this: any) {\n               ),\n             isDev,\n             isServer,\n+            deploymentId,\n             loaderContext: this,\n           })\n         )"
        }
    ],
    "stats": {
        "total": 52,
        "additions": 50,
        "deletions": 2
    }
}