{
    "author": "unstubbable",
    "message": "Bypass `\"use cache\"` caches when Draft Mode is enabled (#77141)",
    "sha": "f67f44c607efd3a996c7b05dbca972bd5ab5027e",
    "files": [
        {
            "sha": "40e421fbaa322c2a63fdd5b9535e51d9b5fa28b2",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -504,7 +504,13 @@ export async function handleAction({\n     // We want the render to see any cookie writes that we performed during the action,\n     // so we need to update the immutable cookies to reflect the changes.\n     synchronizeMutableCookies(requestStore)\n+\n+    // The server action might have toggled draft mode, so we need to reflect\n+    // that in the work store to be up-to-date for subsequent rendering.\n+    workStore.isDraftMode = requestStore.draftMode.isEnabled\n+\n     requestStore.phase = 'render'\n+\n     return generateFlight(...args)\n   }\n "
        },
        {
            "sha": "c123ae648adbd8450c30ee9264d77cae644e928c",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 12,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -15,6 +15,7 @@ import type {\n } from '../resume-data-cache/resume-data-cache'\n import type { Params } from '../request/params'\n import type { ImplicitTags } from '../lib/implicit-tags'\n+import type { WorkStore } from './work-async-storage.external'\n \n export type WorkUnitPhase = 'action' | 'render' | 'after'\n \n@@ -167,10 +168,16 @@ export interface UseCacheStore extends CommonWorkUnitStore {\n   readonly isHmrRefresh: boolean\n   readonly serverComponentsHmrCache: ServerComponentsHmrCache | undefined\n   readonly forceRevalidate: boolean\n+  // Draft mode is only available if the outer work unit store is a request\n+  // store and draft mode is enabled.\n+  readonly draftMode: DraftModeProvider | undefined\n }\n \n export interface UnstableCacheStore extends CommonWorkUnitStore {\n   type: 'unstable-cache'\n+  // Draft mode is only available if the outer work unit store is a request\n+  // store and draft mode is enabled.\n+  readonly draftMode: DraftModeProvider | undefined\n }\n \n /**\n@@ -189,30 +196,40 @@ export function getExpectedRequestStore(\n   callingExpression: string\n ): RequestStore {\n   const workUnitStore = workUnitAsyncStorageInstance.getStore()\n-  if (workUnitStore) {\n-    if (workUnitStore.type === 'request') {\n+\n+  if (!workUnitStore) {\n+    throwForMissingRequestStore(callingExpression)\n+  }\n+\n+  switch (workUnitStore.type) {\n+    case 'request':\n       return workUnitStore\n-    }\n-    if (\n-      workUnitStore.type === 'prerender' ||\n-      workUnitStore.type === 'prerender-ppr' ||\n-      workUnitStore.type === 'prerender-legacy'\n-    ) {\n+\n+    case 'prerender':\n+    case 'prerender-ppr':\n+    case 'prerender-legacy':\n       // This should not happen because we should have checked it already.\n       throw new Error(\n         `\\`${callingExpression}\\` cannot be called inside a prerender. This is a bug in Next.js.`\n       )\n-    }\n-    if (workUnitStore.type === 'cache') {\n+\n+    case 'cache':\n       throw new Error(\n         `\\`${callingExpression}\\` cannot be called inside \"use cache\". Call it outside and pass an argument instead. Read more: https://nextjs.org/docs/messages/next-request-in-use-cache`\n       )\n-    } else if (workUnitStore.type === 'unstable-cache') {\n+\n+    case 'unstable-cache':\n       throw new Error(\n         `\\`${callingExpression}\\` cannot be called inside unstable_cache. Call it outside and pass an argument instead. Read more: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`\n       )\n-    }\n+\n+    default:\n+      const _exhaustiveCheck: never = workUnitStore\n+      return _exhaustiveCheck\n   }\n+}\n+\n+export function throwForMissingRequestStore(callingExpression: string): never {\n   throw new Error(\n     `\\`${callingExpression}\\` was called outside a request scope. Read more: https://nextjs.org/docs/messages/next-dynamic-api-wrong-context`\n   )\n@@ -260,3 +277,24 @@ export function getHmrRefreshHash(\n       ? workUnitStore.cookies.get('__next_hmr_refresh_hash__')?.value\n       : undefined\n }\n+\n+/**\n+ * Returns a draft mode provider only if draft mode is enabled.\n+ */\n+export function getDraftModeProviderForCacheScope(\n+  workStore: WorkStore,\n+  workUnitStore: WorkUnitStore\n+): DraftModeProvider | undefined {\n+  if (workStore.isDraftMode) {\n+    switch (workUnitStore.type) {\n+      case 'cache':\n+      case 'unstable-cache':\n+      case 'request':\n+        return workUnitStore.draftMode\n+      default:\n+        return undefined\n+    }\n+  }\n+\n+  return undefined\n+}"
        },
        {
            "sha": "c48a5b621456f330171f8e7025195e28ef6e6f57",
            "filename": "packages/next/src/server/async-storage/draft-mode-provider.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fdraft-mode-provider.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fdraft-mode-provider.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Fdraft-mode-provider.ts?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -11,7 +11,10 @@ import {\n import type { __ApiPreviewProps } from '../api-utils'\n \n export class DraftModeProvider {\n-  public readonly isEnabled: boolean\n+  /**\n+   * @internal - this declaration is stripped via `tsc --stripInternal`\n+   */\n+  private _isEnabled: boolean\n \n   /**\n    * @internal - this declaration is stripped via `tsc --stripInternal`\n@@ -37,7 +40,7 @@ export class DraftModeProvider {\n \n     const cookieValue = cookies.get(COOKIE_NAME_PRERENDER_BYPASS)?.value\n \n-    this.isEnabled = Boolean(\n+    this._isEnabled = Boolean(\n       !isOnDemandRevalidate &&\n         cookieValue &&\n         previewProps &&\n@@ -51,6 +54,10 @@ export class DraftModeProvider {\n     this._mutableCookies = mutableCookies\n   }\n \n+  get isEnabled() {\n+    return this._isEnabled\n+  }\n+\n   enable() {\n     if (!this._previewModeId) {\n       throw new Error(\n@@ -66,6 +73,8 @@ export class DraftModeProvider {\n       secure: process.env.NODE_ENV !== 'development',\n       path: '/',\n     })\n+\n+    this._isEnabled = true\n   }\n \n   disable() {\n@@ -81,5 +90,7 @@ export class DraftModeProvider {\n       path: '/',\n       expires: new Date(0),\n     })\n+\n+    this._isEnabled = false\n   }\n }"
        },
        {
            "sha": "28545fed96aa44bee04133c8b00f922930f6b1a2",
            "filename": "packages/next/src/server/request/draft-mode.ts",
            "status": "modified",
            "additions": 55,
            "deletions": 20,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -1,8 +1,14 @@\n-import { getExpectedRequestStore } from '../app-render/work-unit-async-storage.external'\n+import {\n+  getDraftModeProviderForCacheScope,\n+  throwForMissingRequestStore,\n+} from '../app-render/work-unit-async-storage.external'\n \n import type { DraftModeProvider } from '../async-storage/draft-mode-provider'\n \n-import { workAsyncStorage } from '../app-render/work-async-storage.external'\n+import {\n+  workAsyncStorage,\n+  type WorkStore,\n+} from '../app-render/work-async-storage.external'\n import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n import {\n   abortAndThrowOnSynchronousRequestDataAccess,\n@@ -41,14 +47,36 @@ export function draftMode(): Promise<DraftMode> {\n   const workStore = workAsyncStorage.getStore()\n   const workUnitStore = workUnitAsyncStorage.getStore()\n \n-  if (workUnitStore) {\n-    if (\n-      workUnitStore.type === 'cache' ||\n-      workUnitStore.type === 'unstable-cache' ||\n-      workUnitStore.type === 'prerender' ||\n-      workUnitStore.type === 'prerender-ppr' ||\n-      workUnitStore.type === 'prerender-legacy'\n-    ) {\n+  if (!workStore || !workUnitStore) {\n+    throwForMissingRequestStore(callingExpression)\n+  }\n+\n+  switch (workUnitStore.type) {\n+    case 'request':\n+      return createOrGetCachedExoticDraftMode(\n+        workUnitStore.draftMode,\n+        workStore\n+      )\n+\n+    case 'cache':\n+    case 'unstable-cache':\n+      // Inside of `\"use cache\"` or `unstable_cache`, draft mode is available if\n+      // the outmost work unit store is a request store, and if draft mode is\n+      // enabled.\n+      const draftModeProvider = getDraftModeProviderForCacheScope(\n+        workStore,\n+        workUnitStore\n+      )\n+\n+      if (draftModeProvider) {\n+        return createOrGetCachedExoticDraftMode(draftModeProvider, workStore)\n+      }\n+\n+    // Otherwise, we fall through to providing an empty draft mode.\n+    // eslint-disable-next-line no-fallthrough\n+    case 'prerender':\n+    case 'prerender-ppr':\n+    case 'prerender-legacy':\n       // Return empty draft mode\n       if (\n         process.env.NODE_ENV === 'development' &&\n@@ -59,27 +87,34 @@ export function draftMode(): Promise<DraftMode> {\n       } else {\n         return createExoticDraftMode(null)\n       }\n-    }\n+\n+    default:\n+      const _exhaustiveCheck: never = workUnitStore\n+      return _exhaustiveCheck\n   }\n+}\n \n-  const requestStore = getExpectedRequestStore(callingExpression)\n+function createOrGetCachedExoticDraftMode(\n+  draftModeProvider: DraftModeProvider,\n+  workStore: WorkStore | undefined\n+): Promise<DraftMode> {\n+  const cachedDraftMode = CachedDraftModes.get(draftMode)\n \n-  const cachedDraftMode = CachedDraftModes.get(requestStore.draftMode)\n   if (cachedDraftMode) {\n     return cachedDraftMode\n   }\n \n-  let promise\n+  let promise: Promise<DraftMode>\n+\n   if (process.env.NODE_ENV === 'development' && !workStore?.isPrefetchRequest) {\n     const route = workStore?.route\n-    promise = createExoticDraftModeWithDevWarnings(\n-      requestStore.draftMode,\n-      route\n-    )\n+    promise = createExoticDraftModeWithDevWarnings(draftModeProvider, route)\n   } else {\n-    promise = createExoticDraftMode(requestStore.draftMode)\n+    promise = createExoticDraftMode(draftModeProvider)\n   }\n-  CachedDraftModes.set(requestStore.draftMode, promise)\n+\n+  CachedDraftModes.set(draftModeProvider, promise)\n+\n   return promise\n }\n "
        },
        {
            "sha": "fcf7a994d969af0d35cf699c689b83f3650b8cd7",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 16,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -24,6 +24,7 @@ import {\n   getRenderResumeDataCache,\n   getPrerenderResumeDataCache,\n   workUnitAsyncStorage,\n+  getDraftModeProviderForCacheScope,\n } from '../app-render/work-unit-async-storage.external'\n import { runInCleanSnapshot } from '../app-render/clean-async-snapshot.external'\n \n@@ -165,6 +166,9 @@ function generateCacheEntryWithCacheContext(\n     isHmrRefresh: useCacheOrRequestStore?.isHmrRefresh ?? false,\n     serverComponentsHmrCache: useCacheOrRequestStore?.serverComponentsHmrCache,\n     forceRevalidate: shouldForceRevalidate(workStore, outerWorkUnitStore),\n+    draftMode:\n+      outerWorkUnitStore &&\n+      getDraftModeProviderForCacheScope(workStore, outerWorkUnitStore),\n   }\n \n   return workUnitAsyncStorage.run(\n@@ -749,25 +753,30 @@ export function cache(\n             timeoutError\n           )\n \n-          let savedCacheEntry\n-          if (prerenderResumeDataCache) {\n-            // Create a clone that goes into the cache scope memory cache.\n-            const split = clonePendingCacheEntry(pendingCacheEntry)\n-            savedCacheEntry = getNthCacheEntry(split, 0)\n-            prerenderResumeDataCache.cache.set(\n+          // When draft mode is enabled, we must not save the cache entry.\n+          if (!workStore.isDraftMode) {\n+            let savedCacheEntry\n+\n+            if (prerenderResumeDataCache) {\n+              // Create a clone that goes into the cache scope memory cache.\n+              const split = clonePendingCacheEntry(pendingCacheEntry)\n+              savedCacheEntry = getNthCacheEntry(split, 0)\n+              prerenderResumeDataCache.cache.set(\n+                serializedCacheKey,\n+                getNthCacheEntry(split, 1)\n+              )\n+            } else {\n+              savedCacheEntry = pendingCacheEntry\n+            }\n+\n+            const promise = cacheHandler.set(\n               serializedCacheKey,\n-              getNthCacheEntry(split, 1)\n+              savedCacheEntry\n             )\n-          } else {\n-            savedCacheEntry = pendingCacheEntry\n-          }\n \n-          const promise = cacheHandler.set(serializedCacheKey, savedCacheEntry)\n-\n-          if (!workStore.pendingRevalidateWrites) {\n-            workStore.pendingRevalidateWrites = []\n+            workStore.pendingRevalidateWrites ??= []\n+            workStore.pendingRevalidateWrites.push(promise)\n           }\n-          workStore.pendingRevalidateWrites.push(promise)\n \n           stream = newStream\n         } else {\n@@ -908,7 +917,7 @@ function shouldForceRevalidate(\n   workStore: WorkStore,\n   workUnitStore: WorkUnitStore | undefined\n ): boolean {\n-  if (workStore.isOnDemandRevalidate) {\n+  if (workStore.isOnDemandRevalidate || workStore.isDraftMode) {\n     return true\n   }\n "
        },
        {
            "sha": "af53e6e9aabf4ae3bb53576f2768c4fe21f080a3",
            "filename": "packages/next/src/server/web/spec-extension/unstable-cache.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 16,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Funstable-cache.ts?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -3,7 +3,10 @@ import type { IncrementalCache } from '../../lib/incremental-cache'\n import { CACHE_ONE_YEAR } from '../../../lib/constants'\n import { validateRevalidate, validateTags } from '../../lib/patch-fetch'\n import { workAsyncStorage } from '../../app-render/work-async-storage.external'\n-import { workUnitAsyncStorage } from '../../app-render/work-unit-async-storage.external'\n+import {\n+  getDraftModeProviderForCacheScope,\n+  workUnitAsyncStorage,\n+} from '../../app-render/work-unit-async-storage.external'\n import {\n   CachedRouteKind,\n   IncrementalCacheKind,\n@@ -141,6 +144,16 @@ export function unstable_cache<T extends Callback>(\n \n       const implicitTags = workUnitStore?.implicitTags\n \n+      const innerCacheStore: UnstableCacheStore = {\n+        type: 'unstable-cache',\n+        phase: 'render',\n+        implicitTags,\n+        draftMode:\n+          workUnitStore &&\n+          workStore &&\n+          getDraftModeProviderForCacheScope(workStore, workUnitStore),\n+      }\n+\n       if (workStore) {\n         workStore.nextFetchId = fetchIdx + 1\n \n@@ -224,11 +237,7 @@ export function unstable_cache<T extends Callback>(\n                 if (!workStore.pendingRevalidates) {\n                   workStore.pendingRevalidates = {}\n                 }\n-                const innerCacheStore: UnstableCacheStore = {\n-                  type: 'unstable-cache',\n-                  phase: 'render',\n-                  implicitTags,\n-                }\n+\n                 // We run the cache function asynchronously and save the result when it completes\n                 workStore.pendingRevalidates[invocationKey] =\n                   workUnitAsyncStorage\n@@ -258,11 +267,6 @@ export function unstable_cache<T extends Callback>(\n           }\n         }\n \n-        const innerCacheStore: UnstableCacheStore = {\n-          type: 'unstable-cache',\n-          phase: 'render',\n-          implicitTags,\n-        }\n         // If we got this far then we had an invalid cache entry and need to generate a new one\n         const result = await workUnitAsyncStorage.run(\n           innerCacheStore,\n@@ -320,11 +324,6 @@ export function unstable_cache<T extends Callback>(\n           }\n         }\n \n-        const innerCacheStore: UnstableCacheStore = {\n-          type: 'unstable-cache',\n-          phase: 'render',\n-          implicitTags,\n-        }\n         // If we got this far then we had an invalid cache entry and need to generate a new one\n         const result = await workUnitAsyncStorage.run(\n           innerCacheStore,"
        },
        {
            "sha": "5847a1db128a5d77e26503b724b070bfeba8a805",
            "filename": "test/e2e/app-dir/app-static/app-static.test.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -4236,6 +4236,21 @@ describe('app-dir static/dynamic handling', () => {\n       expect(data).not.toEqual(data2)\n     })\n \n+    it('should be able to read the draft mode status', async () => {\n+      let $ = await next.render$('/unstable-cache/dynamic')\n+      expect($('#draft-mode-enabled').text()).toBe('draft mode enabled: false')\n+\n+      const draftRes = await next.fetch('/api/draft-mode?status=enable')\n+      const setCookie = draftRes.headers.get('set-cookie')\n+      const cookieHeader = { Cookie: setCookie?.split(';', 1)[0] }\n+\n+      $ = await next.render$('/unstable-cache/dynamic', undefined, {\n+        headers: cookieHeader,\n+      })\n+\n+      expect($('#draft-mode-enabled').text()).toBe('draft mode enabled: true')\n+    })\n+\n     it('should not error when retrieving the value undefined', async () => {\n       const res = await next.fetch('/unstable-cache/dynamic-undefined')\n       const html = await res.text()"
        },
        {
            "sha": "50453a91b64bc966847716c8b335e17e611ccc20",
            "filename": "test/e2e/app-dir/app-static/app/unstable-cache/dynamic/page.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Funstable-cache%2Fdynamic%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Funstable-cache%2Fdynamic%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Funstable-cache%2Fdynamic%2Fpage.tsx?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -1,3 +1,4 @@\n+import { draftMode } from 'next/headers'\n import { unstable_expireTag, unstable_cache } from 'next/cache'\n import { RevalidateButton } from '../revalidate-button'\n \n@@ -13,6 +14,7 @@ export default async function Page() {\n     async () => {\n       return {\n         random: Math.random(),\n+        draftModeEnabled: (await draftMode()).isEnabled,\n       }\n     },\n     ['random-value'],\n@@ -25,6 +27,9 @@ export default async function Page() {\n     <div>\n       <p>random: {Math.random()}</p>\n       <p id=\"cached-data\">cachedData: {cachedData.random}</p>\n+      <p id=\"draft-mode-enabled\">\n+        draft mode enabled: {cachedData.draftModeEnabled.toString()}\n+      </p>\n       <RevalidateButton onClick={revalidate} />\n     </div>\n   )"
        },
        {
            "sha": "5dae0e1aa93c1dc3b8930ab6e4eb2deda4b1c3cd",
            "filename": "test/e2e/app-dir/use-cache/app/draft-mode/button.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdraft-mode%2Fbutton.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdraft-mode%2Fbutton.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdraft-mode%2Fbutton.tsx?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -0,0 +1,17 @@\n+'use client'\n+\n+import React from 'react'\n+import { useFormStatus } from 'react-dom'\n+\n+export function Button({\n+  children,\n+  id,\n+}: React.PropsWithChildren<{ id: string }>) {\n+  const { pending } = useFormStatus()\n+\n+  return (\n+    <button id={id} disabled={pending}>\n+      {children}\n+    </button>\n+  )\n+}"
        },
        {
            "sha": "e3367334ec8072c5567f229d2c75dff27a5f2114",
            "filename": "test/e2e/app-dir/use-cache/app/draft-mode/page.tsx",
            "status": "added",
            "additions": 81,
            "deletions": 0,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdraft-mode%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdraft-mode%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fdraft-mode%2Fpage.tsx?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -0,0 +1,81 @@\n+'use cache'\n+\n+import { cookies, draftMode } from 'next/headers'\n+import { Button } from './button'\n+\n+async function getCachedValue(\n+  iterable: Iterable<number>,\n+  fn: () => string\n+): Promise<[string, () => string]> {\n+  'use cache'\n+\n+  // Make sure we're always receiving the arguments the same way, regardless of\n+  // whether draft mode is enabled or not. We're asserting that by checking\n+  // whether an iterable was serialized/deserialized into an array by React.\n+  if (!Array.isArray(iterable)) {\n+    throw new Error(\n+      'Expected iterable to be serialized to an array because it crossed the \"use cache\" boundary.'\n+    )\n+  }\n+\n+  const date = new Date()\n+  date.setFullYear(date.getFullYear() + iterable.reduce((sum, n) => sum + n))\n+\n+  return [date.toISOString(), fn]\n+}\n+\n+export default async function Page() {\n+  const offset = 1000\n+\n+  const cachedClosure = async () => {\n+    'use cache'\n+    return new Date(Date.now() + offset).toISOString()\n+  }\n+\n+  const { isEnabled } = await draftMode()\n+\n+  // Accessing request-scoped data in \"use cache\" should not be allowed, even if\n+  // draft mode is enabled. We expect the access to throw.\n+  let isAccessingRequestScopedDataAllowedInUseCache = isEnabled\n+\n+  if (isAccessingRequestScopedDataAllowedInUseCache) {\n+    try {\n+      await cookies()\n+    } catch {\n+      isAccessingRequestScopedDataAllowedInUseCache = false\n+    }\n+  }\n+\n+  const [cachedValue, passthroughFn] = await getCachedValue(\n+    {\n+      [Symbol.iterator]: function* () {\n+        yield 1\n+        yield 2\n+        yield 3\n+      },\n+    },\n+    () => 'value from passed-through function'\n+  )\n+\n+  return (\n+    <form\n+      action={async () => {\n+        'use server'\n+        const draft = await draftMode()\n+        if (draft.isEnabled) {\n+          draft.disable()\n+        } else {\n+          draft.enable()\n+        }\n+      }}\n+    >\n+      <p id=\"top-level\">{cachedValue}</p>\n+      <p id=\"closure\">{await cachedClosure()}</p>\n+      <p id=\"is-accessing-request-scoped-data-allowed-in-use-cache\">\n+        {isAccessingRequestScopedDataAllowedInUseCache.toString()}\n+      </p>\n+      <p>{passthroughFn()}</p>\n+      <Button id=\"toggle\">{isEnabled ? 'Disable' : 'Enable'} Draft Mode</Button>\n+    </form>\n+  )\n+}"
        },
        {
            "sha": "f03d35d27f3384201286bbb570c38e42ac274916",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 92,
            "deletions": 0,
            "changes": 92,
            "blob_url": "https://github.com/vercel/next.js/blob/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f67f44c607efd3a996c7b05dbca972bd5ab5027e/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=f67f44c607efd3a996c7b05dbca972bd5ab5027e",
            "patch": "@@ -503,6 +503,7 @@ describe('use-cache', () => {\n         '/cache-fetch-no-store',\n         '/cache-life',\n         '/cache-tag',\n+        '/draft-mode',\n         '/form',\n         '/imported-from-client',\n         '/logs',\n@@ -737,6 +738,97 @@ describe('use-cache', () => {\n     expect(text).toBe('This page could not be found.')\n   })\n \n+  it('should not read nor write cached data when draft mode is enabled', async () => {\n+    const browser = await next.browser('/draft-mode')\n+\n+    expect(await browser.elementByCss('button#toggle').text()).toBe(\n+      'Enable Draft Mode'\n+    )\n+\n+    let initialTopLevelValue = await browser.elementById('top-level').text()\n+\n+    if (isNextDeploy) {\n+      await retry(async () => {\n+        // Wait for the background revalidation after the deployment to settle.\n+        await browser.refresh()\n+\n+        expect(await browser.elementById('top-level').text()).not.toBe(\n+          initialTopLevelValue\n+        )\n+      })\n+\n+      initialTopLevelValue = await browser.elementById('top-level').text()\n+    }\n+\n+    // Draft mode is disabled, cached data should be returned on refresh.\n+\n+    const initialClosureValue = await browser.elementById('closure').text()\n+\n+    await browser.refresh()\n+\n+    expect(await browser.elementById('top-level').text()).toBe(\n+      initialTopLevelValue\n+    )\n+    expect(await browser.elementById('closure').text()).toBe(\n+      initialClosureValue\n+    )\n+\n+    await browser.elementByCss('button#toggle').click()\n+    await browser.waitForElementByCss('button#toggle:enabled')\n+\n+    expect(await browser.elementByCss('button#toggle').text()).toBe(\n+      'Disable Draft Mode'\n+    )\n+\n+    // Draft mode is now enabled, no cached data should be returned on refresh.\n+\n+    const newTopLevelValue = await browser.elementById('top-level').text()\n+    const newClosureValue = await browser.elementById('closure').text()\n+    console.log(await browser.elementById('top-level').text())\n+\n+    expect(newTopLevelValue).not.toBe(initialTopLevelValue)\n+    expect(newClosureValue).not.toBe(initialClosureValue)\n+\n+    await browser.refresh()\n+\n+    expect(await browser.elementById('top-level').text()).not.toBe(\n+      newTopLevelValue\n+    )\n+    console.log(await browser.elementById('top-level').text())\n+\n+    expect(await browser.elementById('closure').text()).not.toBe(\n+      newClosureValue\n+    )\n+\n+    // Accessing request-scoped data should still not be allowed.\n+    expect(\n+      await browser\n+        .elementById('is-accessing-request-scoped-data-allowed-in-use-cache')\n+        .text()\n+    ).toBe('false')\n+\n+    await browser.elementByCss('button#toggle').click()\n+    await browser.waitForElementByCss('button#toggle:enabled')\n+\n+    expect(await browser.elementByCss('button#toggle').text()).toBe(\n+      'Enable Draft Mode'\n+    )\n+\n+    // Draft mode is disabled again, the initially cached data should be\n+    // returned again.\n+\n+    console.log(await browser.elementById('top-level').text())\n+    await browser.refresh()\n+    console.log(await browser.elementById('top-level').text())\n+\n+    expect(await browser.elementById('top-level').text()).toBe(\n+      initialTopLevelValue\n+    )\n+    expect(await browser.elementById('closure').text()).toBe(\n+      initialClosureValue\n+    )\n+  })\n+\n   if (isNextDev) {\n     it('should not have unhandled rejection of Request data promises when use cache is enabled without dynamicIO', async () => {\n       await next.render('/unhandled-promise-regression')"
        }
    ],
    "stats": {
        "total": 440,
        "additions": 374,
        "deletions": 66
    }
}