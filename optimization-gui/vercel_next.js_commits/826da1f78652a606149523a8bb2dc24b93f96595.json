{
    "author": "Cy-Tek",
    "message": "update(turbopack): Update the messaging UX for timing writing files to disk (#79469)\n\n## Refactor Turbopack Compilation Events and Timing Reporting\n\n### What?\nThis PR refactors how compilation events are created, displayed, and\nformatted in Turbopack. It introduces a dedicated `TimingEvent` type for\ntiming-related messages and improves the formatting of duration\ndisplays.\n\nAdditionally we now display all compilation events now that it has been\nshown to be stable with no breakages.\n\n### Why?\nTo provide more consistent and user-friendly output for compilation\nevents, especially for timing information. The new approach makes\nduration formatting more readable by automatically selecting appropriate\nunits (ms, s, min) based on the duration length.\n\n### How?\n- Added a new `TimingEvent` struct that properly formats durations based\non their duration\n- Updated the `DiagnosticEvent` constructor to take severity first, then\nmessage\n- Improved event handling in the build process to properly categorize\nand display different severity levels\n- Enhanced file I/O benchmarking to use the new timing event format\n- Fixed the formatting of compilation events in the UI\n\n---------\n\nCo-authored-by: Niklas Mischkulnig <4586894+mischnic@users.noreply.github.com>",
    "sha": "826da1f78652a606149523a8bb2dc24b93f96595",
    "files": [
        {
            "sha": "dcec9518bbc3b1d43f77298addf5ea6b0a8cae84",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 13,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/826da1f78652a606149523a8bb2dc24b93f96595/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/826da1f78652a606149523a8bb2dc24b93f96595/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=826da1f78652a606149523a8bb2dc24b93f96595",
            "patch": "@@ -31,7 +31,7 @@ use turbo_rcstr::RcStr;\n use turbo_tasks::{\n     Completion, Effects, FxIndexSet, OperationVc, ReadRef, ResolvedVc, TransientInstance,\n     TryJoinIterExt, UpdateInfo, Vc, get_effects,\n-    message_queue::{CompilationEvent, DiagnosticEvent, Severity},\n+    message_queue::{CompilationEvent, DiagnosticEvent, Severity, TimingEvent},\n };\n use turbo_tasks_fs::{\n     DiskFileSystem, FileContent, FileSystem, FileSystemPath, get_relative_path_to,\n@@ -405,8 +405,8 @@ pub async fn project_new(\n     )?;\n \n     turbo_tasks.send_compilation_event(Arc::new(DiagnosticEvent::new(\n-        \"Starting the compilation events server...\".to_owned(),\n-        Severity::Trace,\n+        Severity::Info,\n+        \"Starting the compilation events server ...\".to_owned(),\n     )));\n \n     let stats_path = std::env::var_os(\"NEXT_TURBOPACK_TASK_STATISTICS\");\n@@ -850,21 +850,14 @@ pub async fn project_write_all_entrypoints_to_disk(\n \n             // Start timing writing the files to disk\n             let now = Instant::now();\n-            compilation_event_sender.send_compilation_event(Arc::new(DiagnosticEvent::new(\n-                \"Starting to write all entrypoints to disk...\".to_owned(),\n-                Severity::Event,\n-            )));\n \n             // Write the files to disk\n             effects.apply().await?;\n \n             // Send a compilation event to indicate that the files have been written to disk\n-            compilation_event_sender.send_compilation_event(Arc::new(DiagnosticEvent::new(\n-                format!(\n-                    \"Finished writing all entrypoints to disk in {:?}\",\n-                    now.elapsed()\n-                ),\n-                Severity::Event,\n+            compilation_event_sender.send_compilation_event(Arc::new(TimingEvent::new(\n+                \"Finished writing all entrypoints to disk\".to_owned(),\n+                now.elapsed(),\n             )));\n \n             Ok((entrypoints.clone(), issues.clone(), diagnostics.clone()))"
        },
        {
            "sha": "47cf2d84ac05191f4323b2943f016480f49aea17",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 2,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/826da1f78652a606149523a8bb2dc24b93f96595/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/826da1f78652a606149523a8bb2dc24b93f96595/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=826da1f78652a606149523a8bb2dc24b93f96595",
            "patch": "@@ -91,8 +91,27 @@ export async function turbopackBuild(): Promise<{\n   try {\n     ;(async function logCompilationEvents() {\n       for await (const event of project.compilationEventsSubscribe()) {\n-        if (event.severity === 'EVENT') {\n-          Log.event(event.message)\n+        switch (event.severity) {\n+          case 'EVENT':\n+            Log.event(event.message)\n+            break\n+          case 'TRACE':\n+            Log.trace(event.message)\n+            break\n+          case 'INFO':\n+            Log.info(event.message)\n+            break\n+          case 'WARNING':\n+            Log.warn(event.message)\n+            break\n+          case 'ERROR':\n+            Log.error(event.message)\n+            break\n+          case 'FATAL':\n+            Log.error(event.message)\n+            break\n+          default:\n+            break\n         }\n       }\n     })()"
        },
        {
            "sha": "f4d7ca8dc33b556fcd3b0aaf3747921a0075d913",
            "filename": "turbopack/crates/turbo-tasks/src/message_queue.rs",
            "status": "modified",
            "additions": 80,
            "deletions": 2,
            "changes": 82,
            "blob_url": "https://github.com/vercel/next.js/blob/826da1f78652a606149523a8bb2dc24b93f96595/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/826da1f78652a606149523a8bb2dc24b93f96595/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmessage_queue.rs?ref=826da1f78652a606149523a8bb2dc24b93f96595",
            "patch": "@@ -1,4 +1,4 @@\n-use std::{any::Any, collections::VecDeque, fmt::Display, sync::Arc};\n+use std::{any::Any, collections::VecDeque, fmt::Display, sync::Arc, time::Duration};\n \n use dashmap::DashMap;\n use tokio::sync::{Mutex, mpsc};\n@@ -155,14 +155,64 @@ impl Display for Severity {\n     }\n }\n \n+#[derive(Debug, Clone, serde::Serialize, serde::Deserialize)]\n+/// Compilation event that is used to log the duration of a task\n+pub struct TimingEvent {\n+    /// Message of the event without the timing information\n+    ///\n+    /// Example:\n+    /// ```rust\n+    /// let event = TimingEvent::new(\"Compiled successfully\".to_string(), Duration::from_millis(100));\n+    /// let message = event.message();\n+    /// assert_eq!(message, \"Compiled successfully in 100ms\");\n+    /// ```\n+    pub message: String,\n+    /// Duration in milliseconds\n+    pub duration: Duration,\n+}\n+\n+impl TimingEvent {\n+    pub fn new(message: String, duration: Duration) -> Self {\n+        Self { message, duration }\n+    }\n+}\n+\n+impl CompilationEvent for TimingEvent {\n+    fn type_name(&self) -> &'static str {\n+        \"TimingEvent\"\n+    }\n+\n+    fn severity(&self) -> Severity {\n+        Severity::Event\n+    }\n+\n+    fn message(&self) -> String {\n+        let duration_secs = self.duration.as_secs_f64();\n+        let duration_string = if duration_secs > 120.0 {\n+            format!(\"{:.1}min\", duration_secs / 60.0)\n+        } else if duration_secs > 40.0 {\n+            format!(\"{duration_secs:.0}s\")\n+        } else if duration_secs > 2.0 {\n+            format!(\"{duration_secs:.1}s\")\n+        } else {\n+            format!(\"{:.0}ms\", duration_secs * 1000.0)\n+        };\n+        format!(\"{} in {}\", self.message, duration_string)\n+    }\n+\n+    fn to_json(&self) -> String {\n+        serde_json::to_string(self).unwrap()\n+    }\n+}\n+\n #[derive(Debug, Clone, serde::Serialize, serde::Deserialize)]\n pub struct DiagnosticEvent {\n     pub message: String,\n     pub severity: Severity,\n }\n \n impl DiagnosticEvent {\n-    pub fn new(message: String, severity: Severity) -> Self {\n+    pub fn new(severity: Severity, message: String) -> Self {\n         Self { message, severity }\n     }\n }\n@@ -184,3 +234,31 @@ impl CompilationEvent for DiagnosticEvent {\n         serde_json::to_string(self).unwrap()\n     }\n }\n+\n+#[cfg(test)]\n+mod tests {\n+    use super::*;\n+\n+    #[test]\n+    fn test_timing_event_string_formatting() {\n+        let tests = vec![\n+            (Duration::from_nanos(1588), \"0ms\"),\n+            (Duration::from_nanos(1022616), \"1ms\"),\n+            (Duration::from_millis(100), \"100ms\"),\n+            (Duration::from_millis(1000), \"1000ms\"),\n+            (Duration::from_millis(10000), \"10.0s\"),\n+            (Duration::from_millis(20381), \"20.4s\"),\n+            (Duration::from_secs(60), \"60s\"),\n+            (Duration::from_secs(100), \"100s\"),\n+            (Duration::from_secs(125), \"2.1min\"),\n+        ];\n+\n+        for (duration, expected) in tests {\n+            let event = TimingEvent::new(\"Compiled successfully\".to_string(), duration);\n+            assert_eq!(\n+                event.message(),\n+                format!(\"Compiled successfully in {expected}\")\n+            );\n+        }\n+    }\n+}"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 107,
        "deletions": 17
    }
}