{
    "author": "devjiwonchoi",
    "message": "[next-ts-plugin] fix: language service crashes / metadata plugin not working (#77213)\n\n### Why?\n\nThis PR tackles two issues:\n\n1. The Next.js TS plugin for metadata wasn't working.\n2. The language service occasionally crashes in large projects.\n\n#### The Next.js TS plugin for metadata wasn't working\n\nThe plugin wasn't working due to the position mismatch of\n`optionalReplacementSpan` since VSCode\n[v1.86](https://code.visualstudio.com/updates/v1_86) due to the behavior\nchange of mapping the `replacementSpan` with `optionalReplacementSpan`\nif it exists.\n\nx-ref:\nhttps://github.com/microsoft/vscode/pull/200945/files#diff-9027dfcf905374dcada6a75144ed94935254a5a6bf325a20d557201cd7fbe704R766\n\n#### The language service occasionally crashes in large projects\n\nSince we spun up another language service and a custom language service\nhost for metadata rules, it occasionally crashed on large projects.\n\n### How?\n\n- Synced the `optionalReplacementSpan` to the new position.\n- Removed creating another language service and relying on\n`@typescript/vfs` for the virtual file system, which is recommended:\n\"where files on disk aren't the source of truth\".\n\n\nhttps://github.com/user-attachments/assets/b5b325a4-fd2f-4210-be68-1aa5e40229c2\n\n### Success Criteria\n\n- [x] Does it do completions with `export const metadata = { a }`?\n- [x] Does it disable the plugin with `{ enabled: false }` in the\ntsconfig.json?\n- [x] Does the language service not break when used in large projects?\n\n### Follow Up\n\nThis fix is a partial port from the commit\n[071d839](https://github.com/vercel/next.js/pull/77206/commits/071d83904588c10d276a09f4f1e78ec7305ff80d)\nand will continue to follow up on the refactors from PR #77206,\nincluding a proper test to prevent regression.\n\n---------\n\nCo-authored-by: Zack Tanner <1939140+ztanner@users.noreply.github.com>",
    "sha": "5c499049ef3942750e9359e06b506536946fcc17",
    "files": [
        {
            "sha": "5ac6daf4880c165feb68418f165ea21e464e8368",
            "filename": "packages/next/package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fpackage.json?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -218,6 +218,7 @@\n     \"@types/ua-parser-js\": \"0.7.36\",\n     \"@types/webpack-sources1\": \"npm:@types/webpack-sources@0.1.5\",\n     \"@types/ws\": \"8.2.0\",\n+    \"@typescript/vfs\": \"1.6.1\",\n     \"@vercel/ncc\": \"0.34.0\",\n     \"@vercel/nft\": \"0.27.1\",\n     \"@vercel/turbopack-ecmascript-runtime\": \"*\","
        },
        {
            "sha": "9f2bf75b16d0192b299ef5be6d1ddc9759ac162d",
            "filename": "packages/next/src/compiled/@typescript/vfs/LICENSE",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2FLICENSE",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2FLICENSE",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2FLICENSE?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -0,0 +1,17 @@\n+The MIT License (MIT)\n+Copyright (c) Microsoft Corporation\n+\n+Permission is hereby granted, free of charge, to any person obtaining a copy of this software and \n+associated documentation files (the \"Software\"), to deal in the Software without restriction, \n+including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, \n+and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, \n+subject to the following conditions:\n+\n+The above copyright notice and this permission notice shall be included in all copies or substantial \n+portions of the Software.\n+\n+THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT \n+NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. \n+IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, \n+WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE \n+SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE."
        },
        {
            "sha": "b1d8d243e2de7c5214229fd298d46d2353f18657",
            "filename": "packages/next/src/compiled/@typescript/vfs/index.js",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Findex.js?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -0,0 +1 @@\n+(()=>{\"use strict\";var t={188:(t,r,i)=>{if(process.env.NODE_ENV===\"production\"){t.exports=i(994)}else{t.exports=i(121)}},121:(t,r,i)=>{Object.defineProperty(r,\"__esModule\",{value:true});function _extends(){_extends=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var i=arguments[r];for(var p in i){if(Object.prototype.hasOwnProperty.call(i,p)){t[p]=i[p]}}}return t};return _extends.apply(this,arguments)}var p=false;try{p=typeof localStorage!==\"undefined\"}catch(t){}var m=typeof process!==\"undefined\";var g=p&&localStorage.getItem(\"DEBUG\")||m&&process.env.DEBUG;var v=g?console.log:function(t){return\"\"};function createVirtualTypeScriptEnvironment(t,r,i,p,m){if(p===void 0){p={}}var g=_extends({},w(i),p);var v=createVirtualLanguageServiceHost(t,r,g,i,m),y=v.languageServiceHost,h=v.updateFile,F=v.deleteFile;var x=i.createLanguageService(y);var S=x.getCompilerOptionsDiagnostics();if(S.length){var E=createVirtualCompilerHost(t,p,i);throw new Error(i.formatDiagnostics(S,E.compilerHost))}return{name:\"vfs\",sys:t,languageService:x,getSourceFile:function getSourceFile(t){var r;return(r=x.getProgram())==null?void 0:r.getSourceFile(t)},createFile:function createFile(t,r){h(i.createSourceFile(t,r,g.target,false))},updateFile:function updateFile(t,r,p){var m=x.getProgram().getSourceFile(t);if(!m){throw new Error(\"Did not find a source file for \"+t)}var g=m.text;var v=p!=null?p:i.createTextSpan(0,g.length);var y=g.slice(0,v.start)+r+g.slice(v.start+v.length);var F=i.updateSourceFile(m,y,{span:v,newLength:r.length});h(F)},deleteFile:function deleteFile(t){var r=x.getProgram().getSourceFile(t);if(r){F(r)}}}}var y=function knownLibFilesForCompilerOptions(t,r){var i=t.target||r.ScriptTarget.ES5;var p=t.lib||[];var m=[\"lib.d.ts\",\"lib.core.d.ts\",\"lib.decorators.d.ts\",\"lib.decorators.legacy.d.ts\",\"lib.dom.asynciterable.d.ts\",\"lib.dom.d.ts\",\"lib.dom.iterable.d.ts\",\"lib.webworker.asynciterable.d.ts\",\"lib.webworker.d.ts\",\"lib.webworker.importscripts.d.ts\",\"lib.webworker.iterable.d.ts\",\"lib.scripthost.d.ts\",\"lib.es5.d.ts\",\"lib.es6.d.ts\",\"lib.es7.d.ts\",\"lib.core.es6.d.ts\",\"lib.core.es7.d.ts\",\"lib.es2015.collection.d.ts\",\"lib.es2015.core.d.ts\",\"lib.es2015.d.ts\",\"lib.es2015.generator.d.ts\",\"lib.es2015.iterable.d.ts\",\"lib.es2015.promise.d.ts\",\"lib.es2015.proxy.d.ts\",\"lib.es2015.reflect.d.ts\",\"lib.es2015.symbol.d.ts\",\"lib.es2015.symbol.wellknown.d.ts\",\"lib.es2016.array.include.d.ts\",\"lib.es2016.d.ts\",\"lib.es2016.full.d.ts\",\"lib.es2016.intl.d.ts\",\"lib.es2017.arraybuffer.d.ts\",\"lib.es2017.d.ts\",\"lib.es2017.date.d.ts\",\"lib.es2017.full.d.ts\",\"lib.es2017.intl.d.ts\",\"lib.es2017.object.d.ts\",\"lib.es2017.sharedmemory.d.ts\",\"lib.es2017.string.d.ts\",\"lib.es2017.typedarrays.d.ts\",\"lib.es2018.asyncgenerator.d.ts\",\"lib.es2018.asynciterable.d.ts\",\"lib.es2018.d.ts\",\"lib.es2018.full.d.ts\",\"lib.es2018.intl.d.ts\",\"lib.es2018.promise.d.ts\",\"lib.es2018.regexp.d.ts\",\"lib.es2019.array.d.ts\",\"lib.es2019.d.ts\",\"lib.es2019.full.d.ts\",\"lib.es2019.intl.d.ts\",\"lib.es2019.object.d.ts\",\"lib.es2019.string.d.ts\",\"lib.es2019.symbol.d.ts\",\"lib.es2020.bigint.d.ts\",\"lib.es2020.d.ts\",\"lib.es2020.date.d.ts\",\"lib.es2020.full.d.ts\",\"lib.es2020.intl.d.ts\",\"lib.es2020.number.d.ts\",\"lib.es2020.promise.d.ts\",\"lib.es2020.sharedmemory.d.ts\",\"lib.es2020.string.d.ts\",\"lib.es2020.symbol.wellknown.d.ts\",\"lib.es2021.d.ts\",\"lib.es2021.full.d.ts\",\"lib.es2021.intl.d.ts\",\"lib.es2021.promise.d.ts\",\"lib.es2021.string.d.ts\",\"lib.es2021.weakref.d.ts\",\"lib.es2022.array.d.ts\",\"lib.es2022.d.ts\",\"lib.es2022.error.d.ts\",\"lib.es2022.full.d.ts\",\"lib.es2022.intl.d.ts\",\"lib.es2022.object.d.ts\",\"lib.es2022.regexp.d.ts\",\"lib.es2022.sharedmemory.d.ts\",\"lib.es2022.string.d.ts\",\"lib.es2023.array.d.ts\",\"lib.es2023.collection.d.ts\",\"lib.es2023.d.ts\",\"lib.es2023.full.d.ts\",\"lib.es2023.intl.d.ts\",\"lib.es2024.arraybuffer.d.ts\",\"lib.es2024.collection.d.ts\",\"lib.es2024.d.ts\",\"lib.es2024.full.d.ts\",\"lib.es2024.object.d.ts\",\"lib.es2024.promise.d.ts\",\"lib.es2024.regexp.d.ts\",\"lib.es2024.sharedmemory.d.ts\",\"lib.es2024.string.d.ts\",\"lib.esnext.array.d.ts\",\"lib.esnext.asynciterable.d.ts\",\"lib.esnext.bigint.d.ts\",\"lib.esnext.collection.d.ts\",\"lib.esnext.d.ts\",\"lib.esnext.decorators.d.ts\",\"lib.esnext.disposable.d.ts\",\"lib.esnext.float16.d.ts\",\"lib.esnext.full.d.ts\",\"lib.esnext.intl.d.ts\",\"lib.esnext.iterator.d.ts\",\"lib.esnext.object.d.ts\",\"lib.esnext.promise.d.ts\",\"lib.esnext.regexp.d.ts\",\"lib.esnext.string.d.ts\",\"lib.esnext.symbol.d.ts\",\"lib.esnext.weakref.d.ts\"];var g=r.ScriptTarget[i];var v=m.filter((function(t){return t.startsWith(\"lib.\"+g.toLowerCase())}));var y=m.indexOf(v.pop());var h=function getMax(t){return t&&t.length?t.reduce((function(t,r){return r>t?r:t})):undefined};var F=p.map((function(t){var r=m.filter((function(r){return r.startsWith(\"lib.\"+t.toLowerCase())}));if(r.length===0)return 0;var i=m.indexOf(r.pop());return i}));var x=h(F)||0;var S=Math.max(y,x);return m.slice(0,S+1)};var h=function createDefaultMapFromNodeModules(t,r,p){var m=D();var g=C();var v=function getLib(t){var r=p||m.dirname(i.ab+\"typescript.js\");return g.readFileSync(m.join(r,t),\"utf8\")};var y=function isDtsFile(t){return/\\.d\\.([^\\.]+\\.)?[cm]?ts$/i.test(t)};var h=g.readdirSync(p||m.dirname(i.ab+\"typescript.js\"));var F=h.filter((function(t){return t.startsWith(\"lib.\")&&y(t)}));var x=new Map;F.forEach((function(t){x.set(\"/\"+t,v(t))}));return x};var F=function addAllFilesFromFolder(t,r){var i=D();var p=C();var m=function walk(t){var r=[];var m=p.readdirSync(t);m.forEach((function(m){m=i.join(t,m);var g=p.statSync(m);if(g&&g.isDirectory()){r=r.concat(walk(m))}else{r.push(m)}}));return r};var g=m(r);g.forEach((function(m){var g=\"/node_modules/@types\"+m.replace(r,\"\");var v=p.readFileSync(m,\"utf8\");var y=[\".ts\",\".tsx\"];if(y.includes(i.extname(g))){t.set(g,v)}}))};var x=function addFilesForTypesIntoFolder(t){return F(t,\"node_modules/@types\")};var S=function createDefaultMapFromCDN(t,r,i,p,m,g,v){var h=g||fetch;var F=new Map;var x=y(t,p);var S=\"https://playgroundcdn.typescriptlang.org/cdn/\"+r+\"/typescript/lib/\";function zip(t){return m?m.compressToUTF16(t):t}function unzip(t){return m?m.decompressFromUTF16(t):t}function uncached(){return Promise.all(x.map((function(t){return h(S+t).then((function(t){return t.text()}))}))).then((function(t){t.forEach((function(t,r){return F.set(\"/\"+x[r],t)}))}))[\"catch\"]((function(){}))}function cached(){var t=v||localStorage;var i=Object.keys(t);i.forEach((function(i){if(i.startsWith(\"ts-lib-\")&&!i.startsWith(\"ts-lib-\"+r)){t.removeItem(i)}}));return Promise.all(x.map((function(i){var p=\"ts-lib-\"+r+\"-\"+i;var m=t.getItem(p);if(!m){return h(S+i).then((function(t){return t.text()})).then((function(r){t.setItem(p,zip(r));return r}))[\"catch\"]((function(){}))}else{return Promise.resolve(unzip(m))}}))).then((function(t){t.forEach((function(t,r){if(t){var i=\"/\"+x[r];F.set(i,t)}}))}))}var w=i?cached:uncached;return w().then((function(){return F}))};function notImplemented(t){throw new Error(\"Method '\"+t+\"' is not implemented.\")}function audit(t,r){return function(){for(var i=arguments.length,p=new Array(i),m=0;m<i;m++){p[m]=arguments[m]}var g=r.apply(void 0,p);var y=typeof g===\"string\"?g.slice(0,80)+\"...\":g;v.apply(void 0,[\"> \"+t].concat(p));v(\"< \"+y);return g}}var w=function defaultCompilerOptions(t){return _extends({},t.getDefaultCompilerOptions(),{jsx:t.JsxEmit.React,strict:true,esModuleInterop:true,module:t.ModuleKind.ESNext,suppressOutputPathCheck:true,skipLibCheck:true,skipDefaultLibCheck:true,moduleResolution:t.ModuleResolutionKind.NodeJs})};var E=function libize(t){return t.replace(\"/\",\"/lib.\").toLowerCase()};function createSystem(t){return{args:[],createDirectory:function createDirectory(){return notImplemented(\"createDirectory\")},directoryExists:audit(\"directoryExists\",(function(r){return Array.from(t.keys()).some((function(t){return t.startsWith(r)}))})),exit:function exit(){return notImplemented(\"exit\")},fileExists:audit(\"fileExists\",(function(r){return t.has(r)||t.has(E(r))})),getCurrentDirectory:function getCurrentDirectory(){return\"/\"},getDirectories:function getDirectories(){return[]},getExecutingFilePath:function getExecutingFilePath(){return notImplemented(\"getExecutingFilePath\")},readDirectory:audit(\"readDirectory\",(function(r){return r===\"/\"?Array.from(t.keys()):[]})),readFile:audit(\"readFile\",(function(r){var i;return(i=t.get(r))!=null?i:t.get(E(r))})),resolvePath:function resolvePath(t){return t},newLine:\"\\n\",useCaseSensitiveFileNames:true,write:function write(){return notImplemented(\"write\")},writeFile:function writeFile(r,i){t.set(r,i)},deleteFile:function deleteFile(r){t[\"delete\"](r)}}}function createFSBackedSystem(t,r,p,m){var g=r+\"/vfs\";var v=D();var y=p.sys;var h=m!=null?m:v.dirname(i.ab+\"typescript.js\");return{name:\"fs-vfs\",root:g,args:[],createDirectory:function createDirectory(){return notImplemented(\"createDirectory\")},directoryExists:audit(\"directoryExists\",(function(r){return Array.from(t.keys()).some((function(t){return t.startsWith(r)}))||y.directoryExists(r)})),exit:y.exit,fileExists:audit(\"fileExists\",(function(r){if(t.has(r))return true;if(r.includes(\"tsconfig.json\")||r.includes(\"tsconfig.json\"))return false;if(r.startsWith(\"/lib\")){var i=h+\"/\"+r.replace(\"/\",\"\");return y.fileExists(i)}return y.fileExists(r)})),getCurrentDirectory:function getCurrentDirectory(){return g},getDirectories:y.getDirectories,getExecutingFilePath:function getExecutingFilePath(){return notImplemented(\"getExecutingFilePath\")},readDirectory:audit(\"readDirectory\",(function(){if((arguments.length<=0?undefined:arguments[0])===\"/\"){return Array.from(t.keys())}else{return y.readDirectory.apply(y,arguments)}})),readFile:audit(\"readFile\",(function(r){if(t.has(r))return t.get(r);if(r.startsWith(\"/lib\")){var i=h+\"/\"+r.replace(\"/\",\"\");var p=y.readFile(i);if(!p){var m=y.readDirectory(h);throw new Error(\"TSVFS: A request was made for \"+i+\" but there wasn't a file found in the file map. You likely have a mismatch in the compiler options for the CDN download vs the compiler program. Existing Libs: \"+m+\".\")}return p}return y.readFile(r)})),resolvePath:function resolvePath(r){if(t.has(r))return r;return y.resolvePath(r)},newLine:\"\\n\",useCaseSensitiveFileNames:true,write:function write(){return notImplemented(\"write\")},writeFile:function writeFile(r,i){t.set(r,i)},deleteFile:function deleteFile(r){t[\"delete\"](r)},realpath:y.realpath}}function createVirtualCompilerHost(t,r,i){var p=new Map;var m=function save(t){p.set(t.fileName,t);return t};var g={compilerHost:_extends({},t,{getCanonicalFileName:function getCanonicalFileName(t){return t},getDefaultLibFileName:function getDefaultLibFileName(){return\"/\"+i.getDefaultLibFileName(r)},getNewLine:function getNewLine(){return t.newLine},getSourceFile:function getSourceFile(g,v){var y;return p.get(g)||m(i.createSourceFile(g,t.readFile(g),(y=v!=null?v:r.target)!=null?y:w(i).target,false))},useCaseSensitiveFileNames:function useCaseSensitiveFileNames(){return t.useCaseSensitiveFileNames}}),updateFile:function updateFile(r){var i=p.has(r.fileName);t.writeFile(r.fileName,r.text);p.set(r.fileName,r);return i},deleteFile:function deleteFile(r){var i=p.has(r.fileName);p[\"delete\"](r.fileName);t.deleteFile(r.fileName);return i}};return g}function createVirtualLanguageServiceHost(t,r,i,p,m){var g=[].concat(r);var v=createVirtualCompilerHost(t,i,p),y=v.compilerHost,h=v.updateFile,F=v.deleteFile;var x=new Map;var S=0;var w=_extends({},y,{getProjectVersion:function getProjectVersion(){return S.toString()},getCompilationSettings:function getCompilationSettings(){return i},getCustomTransformers:function getCustomTransformers(){return m},getScriptFileNames:function getScriptFileNames(){return g.slice()},getScriptSnapshot:function getScriptSnapshot(r){var i=t.readFile(r);if(i&&typeof i===\"string\"){return p.ScriptSnapshot.fromString(i)}return},getScriptVersion:function getScriptVersion(t){return x.get(t)||\"0\"},writeFile:t.writeFile});var E={languageServiceHost:w,updateFile:function updateFile(t){S++;x.set(t.fileName,S.toString());if(!g.includes(t.fileName)){g.push(t.fileName)}h(t)},deleteFile:function deleteFile(t){S++;x.set(t.fileName,S.toString());var r=g.indexOf(t.fileName);if(r!==-1){g.splice(r,1)}F(t)}};return E}var D=function requirePath(){return require(String.fromCharCode(112,97,116,104))};var C=function requireFS(){return require(String.fromCharCode(102,115))};r.addAllFilesFromFolder=F;r.addFilesForTypesIntoFolder=x;r.createDefaultMapFromCDN=S;r.createDefaultMapFromNodeModules=h;r.createFSBackedSystem=createFSBackedSystem;r.createSystem=createSystem;r.createVirtualCompilerHost=createVirtualCompilerHost;r.createVirtualLanguageServiceHost=createVirtualLanguageServiceHost;r.createVirtualTypeScriptEnvironment=createVirtualTypeScriptEnvironment;r.knownLibFilesForCompilerOptions=y},994:(t,r,i)=>{function e(){return e=Object.assign?Object.assign.bind():function(t){for(var r=1;r<arguments.length;r++){var i=arguments[r];for(var p in i)Object.prototype.hasOwnProperty.call(i,p)&&(t[p]=i[p])}return t},e.apply(this,arguments)}Object.defineProperty(r,\"__esModule\",{value:!0});var p=!1;try{p=\"undefined\"!=typeof localStorage}catch(e){}var m=\"undefined\"!=typeof process,g=p&&localStorage.getItem(\"DEBUG\")||m&&process.env.DEBUG?console.log:function(t){return\"\"},s=function(t,r){var i,p=t.lib||[],m=[\"lib.d.ts\",\"lib.core.d.ts\",\"lib.decorators.d.ts\",\"lib.decorators.legacy.d.ts\",\"lib.dom.asynciterable.d.ts\",\"lib.dom.d.ts\",\"lib.dom.iterable.d.ts\",\"lib.webworker.asynciterable.d.ts\",\"lib.webworker.d.ts\",\"lib.webworker.importscripts.d.ts\",\"lib.webworker.iterable.d.ts\",\"lib.scripthost.d.ts\",\"lib.es5.d.ts\",\"lib.es6.d.ts\",\"lib.es7.d.ts\",\"lib.core.es6.d.ts\",\"lib.core.es7.d.ts\",\"lib.es2015.collection.d.ts\",\"lib.es2015.core.d.ts\",\"lib.es2015.d.ts\",\"lib.es2015.generator.d.ts\",\"lib.es2015.iterable.d.ts\",\"lib.es2015.promise.d.ts\",\"lib.es2015.proxy.d.ts\",\"lib.es2015.reflect.d.ts\",\"lib.es2015.symbol.d.ts\",\"lib.es2015.symbol.wellknown.d.ts\",\"lib.es2016.array.include.d.ts\",\"lib.es2016.d.ts\",\"lib.es2016.full.d.ts\",\"lib.es2016.intl.d.ts\",\"lib.es2017.arraybuffer.d.ts\",\"lib.es2017.d.ts\",\"lib.es2017.date.d.ts\",\"lib.es2017.full.d.ts\",\"lib.es2017.intl.d.ts\",\"lib.es2017.object.d.ts\",\"lib.es2017.sharedmemory.d.ts\",\"lib.es2017.string.d.ts\",\"lib.es2017.typedarrays.d.ts\",\"lib.es2018.asyncgenerator.d.ts\",\"lib.es2018.asynciterable.d.ts\",\"lib.es2018.d.ts\",\"lib.es2018.full.d.ts\",\"lib.es2018.intl.d.ts\",\"lib.es2018.promise.d.ts\",\"lib.es2018.regexp.d.ts\",\"lib.es2019.array.d.ts\",\"lib.es2019.d.ts\",\"lib.es2019.full.d.ts\",\"lib.es2019.intl.d.ts\",\"lib.es2019.object.d.ts\",\"lib.es2019.string.d.ts\",\"lib.es2019.symbol.d.ts\",\"lib.es2020.bigint.d.ts\",\"lib.es2020.d.ts\",\"lib.es2020.date.d.ts\",\"lib.es2020.full.d.ts\",\"lib.es2020.intl.d.ts\",\"lib.es2020.number.d.ts\",\"lib.es2020.promise.d.ts\",\"lib.es2020.sharedmemory.d.ts\",\"lib.es2020.string.d.ts\",\"lib.es2020.symbol.wellknown.d.ts\",\"lib.es2021.d.ts\",\"lib.es2021.full.d.ts\",\"lib.es2021.intl.d.ts\",\"lib.es2021.promise.d.ts\",\"lib.es2021.string.d.ts\",\"lib.es2021.weakref.d.ts\",\"lib.es2022.array.d.ts\",\"lib.es2022.d.ts\",\"lib.es2022.error.d.ts\",\"lib.es2022.full.d.ts\",\"lib.es2022.intl.d.ts\",\"lib.es2022.object.d.ts\",\"lib.es2022.regexp.d.ts\",\"lib.es2022.sharedmemory.d.ts\",\"lib.es2022.string.d.ts\",\"lib.es2023.array.d.ts\",\"lib.es2023.collection.d.ts\",\"lib.es2023.d.ts\",\"lib.es2023.full.d.ts\",\"lib.es2023.intl.d.ts\",\"lib.es2024.arraybuffer.d.ts\",\"lib.es2024.collection.d.ts\",\"lib.es2024.d.ts\",\"lib.es2024.full.d.ts\",\"lib.es2024.object.d.ts\",\"lib.es2024.promise.d.ts\",\"lib.es2024.regexp.d.ts\",\"lib.es2024.sharedmemory.d.ts\",\"lib.es2024.string.d.ts\",\"lib.esnext.array.d.ts\",\"lib.esnext.asynciterable.d.ts\",\"lib.esnext.bigint.d.ts\",\"lib.esnext.collection.d.ts\",\"lib.esnext.d.ts\",\"lib.esnext.decorators.d.ts\",\"lib.esnext.disposable.d.ts\",\"lib.esnext.float16.d.ts\",\"lib.esnext.full.d.ts\",\"lib.esnext.intl.d.ts\",\"lib.esnext.iterator.d.ts\",\"lib.esnext.object.d.ts\",\"lib.esnext.promise.d.ts\",\"lib.esnext.regexp.d.ts\",\"lib.esnext.string.d.ts\",\"lib.esnext.symbol.d.ts\",\"lib.esnext.weakref.d.ts\"],g=r.ScriptTarget[t.target||r.ScriptTarget.ES5],v=m.filter((function(t){return t.startsWith(\"lib.\"+g.toLowerCase())})),y=m.indexOf(v.pop()),h=p.map((function(t){var r=m.filter((function(r){return r.startsWith(\"lib.\"+t.toLowerCase())}));return 0===r.length?0:m.indexOf(r.pop())})),F=((i=h)&&i.length?i.reduce((function(t,r){return r>t?r:t})):void 0)||0,x=Math.max(y,F);return m.slice(0,x+1)},n=function(t,r){var i=f(),p=b();(function e(t){var r=[];return p.readdirSync(t).forEach((function(m){m=i.join(t,m);var g=p.statSync(m);g&&g.isDirectory()?r=r.concat(e(m)):r.push(m)})),r})(r).forEach((function(m){var g=\"/node_modules/@types\"+m.replace(r,\"\"),v=p.readFileSync(m,\"utf8\");[\".ts\",\".tsx\"].includes(i.extname(g))&&t.set(g,v)}))};function l(t){throw new Error(\"Method '\"+t+\"' is not implemented.\")}function o(t,r){return function(){for(var i=arguments.length,p=new Array(i),m=0;m<i;m++)p[m]=arguments[m];var v=r.apply(void 0,p),y=\"string\"==typeof v?v.slice(0,80)+\"...\":v;return g.apply(void 0,[\"> \"+t].concat(p)),g(\"< \"+y),v}}var a=function(t){return e({},t.getDefaultCompilerOptions(),{jsx:t.JsxEmit.React,strict:!0,esModuleInterop:!0,module:t.ModuleKind.ESNext,suppressOutputPathCheck:!0,skipLibCheck:!0,skipDefaultLibCheck:!0,moduleResolution:t.ModuleResolutionKind.NodeJs})},c=function(t){return t.replace(\"/\",\"/lib.\").toLowerCase()};function u(t,r,i){var p=new Map;return{compilerHost:e({},t,{getCanonicalFileName:function(t){return t},getDefaultLibFileName:function(){return\"/\"+i.getDefaultLibFileName(r)},getNewLine:function(){return t.newLine},getSourceFile:function(m,g){var v,y;return p.get(m)||(y=i.createSourceFile(m,t.readFile(m),null!=(v=null!=g?g:r.target)?v:a(i).target,!1),p.set(y.fileName,y),y)},useCaseSensitiveFileNames:function(){return t.useCaseSensitiveFileNames}}),updateFile:function(r){var i=p.has(r.fileName);return t.writeFile(r.fileName,r.text),p.set(r.fileName,r),i},deleteFile:function(r){var i=p.has(r.fileName);return p.delete(r.fileName),t.deleteFile(r.fileName),i}}}function d(t,r,i,p,m){var g=[].concat(r),v=u(t,i,p),y=v.compilerHost,h=v.updateFile,F=v.deleteFile,x=new Map,S=0;return{languageServiceHost:e({},y,{getProjectVersion:function(){return S.toString()},getCompilationSettings:function(){return i},getCustomTransformers:function(){return m},getScriptFileNames:function(){return g.slice()},getScriptSnapshot:function(r){var i=t.readFile(r);if(i&&\"string\"==typeof i)return p.ScriptSnapshot.fromString(i)},getScriptVersion:function(t){return x.get(t)||\"0\"},writeFile:t.writeFile}),updateFile:function(t){S++,x.set(t.fileName,S.toString()),g.includes(t.fileName)||g.push(t.fileName),h(t)},deleteFile:function(t){S++,x.set(t.fileName,S.toString());var r=g.indexOf(t.fileName);-1!==r&&g.splice(r,1),F(t)}}}var f=function(){return require(String.fromCharCode(112,97,116,104))},b=function(){return require(String.fromCharCode(102,115))};r.addAllFilesFromFolder=n,r.addFilesForTypesIntoFolder=function(t){return n(t,\"node_modules/@types\")},r.createDefaultMapFromCDN=function(t,r,i,p,m,g,v){var y=g||fetch,h=new Map,F=s(t,p),x=\"https://playgroundcdn.typescriptlang.org/cdn/\"+r+\"/typescript/lib/\";return(i?function(){var t=v||localStorage;return Object.keys(t).forEach((function(i){i.startsWith(\"ts-lib-\")&&!i.startsWith(\"ts-lib-\"+r)&&t.removeItem(i)})),Promise.all(F.map((function(i){var p,g=\"ts-lib-\"+r+\"-\"+i,v=t.getItem(g);return v?Promise.resolve((p=v,m?m.decompressFromUTF16(p):p)):y(x+i).then((function(t){return t.text()})).then((function(r){var i;return t.setItem(g,(i=r,m?m.compressToUTF16(i):i)),r})).catch((function(){}))}))).then((function(t){t.forEach((function(t,r){t&&h.set(\"/\"+F[r],t)}))}))}:function(){return Promise.all(F.map((function(t){return y(x+t).then((function(t){return t.text()}))}))).then((function(t){t.forEach((function(t,r){return h.set(\"/\"+F[r],t)}))})).catch((function(){}))})().then((function(){return h}))},r.createDefaultMapFromNodeModules=function(t,r,p){var m=f(),g=b(),v=g.readdirSync(p||m.dirname(i.ab+\"typescript.js\")).filter((function(t){return t.startsWith(\"lib.\")&&/\\.d\\.([^\\.]+\\.)?[cm]?ts$/i.test(t)})),y=new Map;return v.forEach((function(t){y.set(\"/\"+t,function(t){var r=p||m.dirname(i.ab+\"typescript.js\");return g.readFileSync(m.join(r,t),\"utf8\")}(t))})),y},r.createFSBackedSystem=function(t,r,p,m){var g=r+\"/vfs\",v=f(),y=p.sys,h=null!=m?m:v.dirname(i.ab+\"typescript.js\");return{name:\"fs-vfs\",root:g,args:[],createDirectory:function(){return l(\"createDirectory\")},directoryExists:o(\"directoryExists\",(function(r){return Array.from(t.keys()).some((function(t){return t.startsWith(r)}))||y.directoryExists(r)})),exit:y.exit,fileExists:o(\"fileExists\",(function(r){if(t.has(r))return!0;if(r.includes(\"tsconfig.json\")||r.includes(\"tsconfig.json\"))return!1;if(r.startsWith(\"/lib\")){var i=h+\"/\"+r.replace(\"/\",\"\");return y.fileExists(i)}return y.fileExists(r)})),getCurrentDirectory:function(){return g},getDirectories:y.getDirectories,getExecutingFilePath:function(){return l(\"getExecutingFilePath\")},readDirectory:o(\"readDirectory\",(function(){return\"/\"===(arguments.length<=0?void 0:arguments[0])?Array.from(t.keys()):y.readDirectory.apply(y,arguments)})),readFile:o(\"readFile\",(function(r){if(t.has(r))return t.get(r);if(r.startsWith(\"/lib\")){var i=h+\"/\"+r.replace(\"/\",\"\"),p=y.readFile(i);if(!p){var m=y.readDirectory(h);throw new Error(\"TSVFS: A request was made for \"+i+\" but there wasn't a file found in the file map. You likely have a mismatch in the compiler options for the CDN download vs the compiler program. Existing Libs: \"+m+\".\")}return p}return y.readFile(r)})),resolvePath:function(r){return t.has(r)?r:y.resolvePath(r)},newLine:\"\\n\",useCaseSensitiveFileNames:!0,write:function(){return l(\"write\")},writeFile:function(r,i){t.set(r,i)},deleteFile:function(r){t.delete(r)},realpath:y.realpath}},r.createSystem=function(t){return{args:[],createDirectory:function(){return l(\"createDirectory\")},directoryExists:o(\"directoryExists\",(function(r){return Array.from(t.keys()).some((function(t){return t.startsWith(r)}))})),exit:function(){return l(\"exit\")},fileExists:o(\"fileExists\",(function(r){return t.has(r)||t.has(c(r))})),getCurrentDirectory:function(){return\"/\"},getDirectories:function(){return[]},getExecutingFilePath:function(){return l(\"getExecutingFilePath\")},readDirectory:o(\"readDirectory\",(function(r){return\"/\"===r?Array.from(t.keys()):[]})),readFile:o(\"readFile\",(function(r){var i;return null!=(i=t.get(r))?i:t.get(c(r))})),resolvePath:function(t){return t},newLine:\"\\n\",useCaseSensitiveFileNames:!0,write:function(){return l(\"write\")},writeFile:function(r,i){t.set(r,i)},deleteFile:function(r){t.delete(r)}}},r.createVirtualCompilerHost=u,r.createVirtualLanguageServiceHost=d,r.createVirtualTypeScriptEnvironment=function(t,r,i,p,m){void 0===p&&(p={});var g=e({},a(i),p),v=d(t,r,g,i,m),y=v.updateFile,h=v.deleteFile,F=i.createLanguageService(v.languageServiceHost),x=F.getCompilerOptionsDiagnostics();if(x.length){var S=u(t,p,i);throw new Error(i.formatDiagnostics(x,S.compilerHost))}return{name:\"vfs\",sys:t,languageService:F,getSourceFile:function(t){var r;return null==(r=F.getProgram())?void 0:r.getSourceFile(t)},createFile:function(t,r){y(i.createSourceFile(t,r,g.target,!1))},updateFile:function(t,r,p){var m=F.getProgram().getSourceFile(t);if(!m)throw new Error(\"Did not find a source file for \"+t);var g=m.text,v=null!=p?p:i.createTextSpan(0,g.length),h=g.slice(0,v.start)+r+g.slice(v.start+v.length),x=i.updateSourceFile(m,h,{span:v,newLength:r.length});y(x)},deleteFile:function(t){var r=F.getProgram().getSourceFile(t);r&&h(r)}}},r.knownLibFilesForCompilerOptions=s}};var r={};function __nccwpck_require__(i){var p=r[i];if(p!==undefined){return p.exports}var m=r[i]={exports:{}};var g=true;try{t[i](m,m.exports,__nccwpck_require__);g=false}finally{if(g)delete r[i]}return m.exports}if(typeof __nccwpck_require__!==\"undefined\")__nccwpck_require__.ab=__dirname+\"/\";var i=__nccwpck_require__(188);module.exports=i})();\n\\ No newline at end of file"
        },
        {
            "sha": "8e5c933168498e826d394086eb12332248108d76",
            "filename": "packages/next/src/compiled/@typescript/vfs/package.json",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Fpackage.json?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -0,0 +1 @@\n+{\"name\":\"@typescript/vfs\",\"main\":\"index.js\",\"author\":\"TypeScript team\",\"license\":\"MIT\"}"
        },
        {
            "sha": "9373e1a75d4c3c9e6618fa3f5dcbf68202d1700a",
            "filename": "packages/next/src/compiled/@typescript/vfs/typescript.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Ftypescript.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Ftypescript.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcompiled%2F%40typescript%2Fvfs%2Ftypescript.js?ref=5c499049ef3942750e9359e06b506536946fcc17"
        },
        {
            "sha": "d398dd5bff6d1cd06ce351202f2f7c077a232930",
            "filename": "packages/next/src/server/typescript/index.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 13,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Findex.ts?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -32,18 +32,6 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n   typescript: ts,\n }) => {\n   function create(info: tsModule.server.PluginCreateInfo) {\n-    init({\n-      ts,\n-      info,\n-    })\n-\n-    // Set up decorator object\n-    const proxy = Object.create(null)\n-    for (let k of Object.keys(info.languageService)) {\n-      const x = (info.languageService as any)[k]\n-      proxy[k] = (...args: Array<{}>) => x.apply(info.languageService, args)\n-    }\n-\n     // Get plugin options\n     // config is the plugin options from the user's tsconfig.json\n     // e.g. { \"plugins\": [{ \"name\": \"next\", \"enabled\": true }] }\n@@ -52,9 +40,22 @@ export const createTSPlugin: tsModule.server.PluginModuleFactory = ({\n     const isPluginEnabled = info.config.enabled ?? true\n \n     if (!isPluginEnabled) {\n-      return proxy\n+      return info.languageService\n     }\n \n+    // Set up decorator object\n+    const proxy: tsModule.LanguageService = Object.create(null)\n+    for (let k of Object.keys(info.languageService)) {\n+      const x = info.languageService[k as keyof tsModule.LanguageService]\n+      // @ts-expect-error - JS runtime trickery which is tricky to type tersely\n+      proxy[k] = (...args: Array<{}>) => x.apply(info.languageService, args)\n+    }\n+\n+    init({\n+      ts,\n+      info,\n+    })\n+\n     // Auto completion\n     proxy.getCompletionsAtPosition = (\n       fileName: string,"
        },
        {
            "sha": "2e1081489cc61b164e81570c3f07fa4b3d1afffb",
            "filename": "packages/next/src/server/typescript/rules/metadata.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 112,
            "changes": 142,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fmetadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fmetadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Frules%2Fmetadata.ts?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -1,10 +1,12 @@\n import { NEXT_TS_ERRORS } from '../constant'\n import {\n-  getInfo,\n   getSource,\n+  getSourceFromVirtualTsEnv,\n   getTs,\n   getTypeChecker,\n   isPositionInsideNode,\n+  log,\n+  virtualTsEnv,\n } from '../utils'\n \n import type tsModule from 'typescript/lib/tsserverlibrary'\n@@ -49,101 +51,6 @@ function getMetadataExport(fileName: string, position: number) {\n   return metadataExport\n }\n \n-let cachedProxiedLanguageService: tsModule.LanguageService | undefined\n-let cachedProxiedLanguageServiceHost: tsModule.LanguageServiceHost | undefined\n-function getProxiedLanguageService() {\n-  if (cachedProxiedLanguageService)\n-    return {\n-      languageService: cachedProxiedLanguageService as tsModule.LanguageService,\n-      languageServiceHost:\n-        cachedProxiedLanguageServiceHost as tsModule.LanguageServiceHost & {\n-          addFile: (fileName: string, body: string) => void\n-        },\n-    }\n-\n-  const languageServiceHost = getInfo().languageServiceHost\n-\n-  const ts = getTs()\n-  class ProxiedLanguageServiceHost implements tsModule.LanguageServiceHost {\n-    files: {\n-      [fileName: string]: { file: tsModule.IScriptSnapshot; ver: number }\n-    } = {}\n-\n-    log = () => {}\n-    trace = () => {}\n-    error = () => {}\n-    getCompilationSettings = () => languageServiceHost.getCompilationSettings()\n-    getScriptIsOpen = () => true\n-    getCurrentDirectory = () => languageServiceHost.getCurrentDirectory()\n-    getDefaultLibFileName = (o: any) =>\n-      languageServiceHost.getDefaultLibFileName(o)\n-\n-    getScriptVersion = (fileName: string) => {\n-      const file = this.files[fileName]\n-      if (!file) return languageServiceHost.getScriptVersion(fileName)\n-      return file.ver.toString()\n-    }\n-\n-    getScriptSnapshot = (fileName: string) => {\n-      const file = this.files[fileName]\n-      if (!file) return languageServiceHost.getScriptSnapshot(fileName)\n-      return file.file\n-    }\n-\n-    getScriptFileNames(): string[] {\n-      const names: Set<string> = new Set()\n-      for (var name in this.files) {\n-        if (this.files.hasOwnProperty(name)) {\n-          names.add(name)\n-        }\n-      }\n-      const files = languageServiceHost.getScriptFileNames()\n-      for (const file of files) {\n-        names.add(file)\n-      }\n-      return [...names]\n-    }\n-\n-    addFile(fileName: string, body: string) {\n-      const snap = ts.ScriptSnapshot.fromString(body)\n-      snap.getChangeRange = (_) => undefined\n-      const existing = this.files[fileName]\n-      if (existing) {\n-        this.files[fileName].ver++\n-        this.files[fileName].file = snap\n-      } else {\n-        this.files[fileName] = { ver: 1, file: snap }\n-      }\n-    }\n-\n-    readFile(fileName: string) {\n-      const file = this.files[fileName]\n-      return file\n-        ? file.file.getText(0, file.file.getLength())\n-        : languageServiceHost.readFile(fileName)\n-    }\n-    fileExists(fileName: string) {\n-      return (\n-        this.files[fileName] !== undefined ||\n-        languageServiceHost.fileExists(fileName)\n-      )\n-    }\n-  }\n-\n-  cachedProxiedLanguageServiceHost = new ProxiedLanguageServiceHost()\n-  cachedProxiedLanguageService = ts.createLanguageService(\n-    cachedProxiedLanguageServiceHost,\n-    ts.createDocumentRegistry()\n-  )\n-  return {\n-    languageService: cachedProxiedLanguageService as tsModule.LanguageService,\n-    languageServiceHost:\n-      cachedProxiedLanguageServiceHost as tsModule.LanguageServiceHost & {\n-        addFile: (fileName: string, body: string) => void\n-      },\n-  }\n-}\n-\n function updateVirtualFileWithType(\n   fileName: string,\n   node: tsModule.VariableDeclaration | tsModule.FunctionDeclaration,\n@@ -178,8 +85,17 @@ function updateVirtualFileWithType(\n     annotation +\n     sourceText.slice(nodeEnd) +\n     TYPE_IMPORT\n-  const { languageServiceHost } = getProxiedLanguageService()\n-  languageServiceHost.addFile(fileName, newSource)\n+\n+  if (virtualTsEnv.sys.fileExists(fileName)) {\n+    log('Updating file: ' + fileName)\n+    // FIXME: updateFile() breaks as the file doesn't exists, which is weird.\n+    // virtualTsEnv.updateFile(fileName, newSource)\n+    virtualTsEnv.deleteFile(fileName)\n+    virtualTsEnv.createFile(fileName, newSource)\n+  } else {\n+    log('Creating file: ' + fileName)\n+    virtualTsEnv.createFile(fileName, newSource)\n+  }\n \n   return [nodeEnd, annotation.length]\n }\n@@ -196,9 +112,9 @@ function proxyDiagnostics(\n   n: tsModule.VariableDeclaration | tsModule.FunctionDeclaration\n ) {\n   // Get diagnostics\n-  const { languageService } = getProxiedLanguageService()\n-  const diagnostics = languageService.getSemanticDiagnostics(fileName)\n-  const source = getSource(fileName)\n+  const diagnostics =\n+    virtualTsEnv.languageService.getSemanticDiagnostics(fileName)\n+  const source = getSourceFromVirtualTsEnv(fileName)\n \n   // Filter and map the results\n   return diagnostics\n@@ -232,24 +148,26 @@ const metadata = {\n     if (!node) return prior\n     if (isTyped(node)) return prior\n \n-    const ts = getTs()\n-\n     // We annotate with the type in a virtual language service\n     const pos = updateVirtualFileWithType(fileName, node)\n     if (pos === undefined) return prior\n \n     // Get completions\n-    const { languageService } = getProxiedLanguageService()\n     const newPos = position <= pos[0] ? position : position + pos[1]\n-    const completions = languageService.getCompletionsAtPosition(\n+    const completions = virtualTsEnv.languageService.getCompletionsAtPosition(\n       fileName,\n       newPos,\n       undefined\n     )\n \n     if (completions) {\n+      const ts = getTs()\n       completions.isIncomplete = true\n-\n+      // https://github.com/microsoft/TypeScript/blob/4dc677b292354f4b9162452b2e00f4d7dd118221/src/services/types.ts#L1428-L1433\n+      if (completions.optionalReplacementSpan) {\n+        // Adjust the start position of the text span to original source.\n+        completions.optionalReplacementSpan.start -= newPos - position\n+      }\n       completions.entries = completions.entries\n         .filter((e) => {\n           return [\n@@ -465,10 +383,9 @@ const metadata = {\n     const pos = updateVirtualFileWithType(fileName, node)\n     if (pos === undefined) return\n \n-    const { languageService } = getProxiedLanguageService()\n     const newPos = position <= pos[0] ? position : position + pos[1]\n \n-    const details = languageService.getCompletionEntryDetails(\n+    const details = virtualTsEnv.languageService.getCompletionEntryDetails(\n       fileName,\n       newPos,\n       entryName,\n@@ -489,9 +406,11 @@ const metadata = {\n     const pos = updateVirtualFileWithType(fileName, node)\n     if (pos === undefined) return\n \n-    const { languageService } = getProxiedLanguageService()\n     const newPos = position <= pos[0] ? position : position + pos[1]\n-    const insight = languageService.getQuickInfoAtPosition(fileName, newPos)\n+    const insight = virtualTsEnv.languageService.getQuickInfoAtPosition(\n+      fileName,\n+      newPos\n+    )\n     return insight\n   },\n \n@@ -503,11 +422,10 @@ const metadata = {\n     // We annotate with the type in a virtual language service\n     const pos = updateVirtualFileWithType(fileName, node)\n     if (pos === undefined) return\n-    const { languageService } = getProxiedLanguageService()\n     const newPos = position <= pos[0] ? position : position + pos[1]\n \n     const definitionInfoAndBoundSpan =\n-      languageService.getDefinitionAndBoundSpan(fileName, newPos)\n+      virtualTsEnv.languageService.getDefinitionAndBoundSpan(fileName, newPos)\n \n     if (definitionInfoAndBoundSpan) {\n       // Adjust the start position of the text span"
        },
        {
            "sha": "64cd9ebe87f656bb7c0589dc47bde0f297515a6d",
            "filename": "packages/next/src/server/typescript/utils.ts",
            "status": "modified",
            "additions": 44,
            "deletions": 4,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Ftypescript%2Futils.ts?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -1,28 +1,61 @@\n-import path from 'path'\n+import type { VirtualTypeScriptEnvironment } from 'next/dist/compiled/@typescript/vfs'\n+import {\n+  createFSBackedSystem,\n+  createDefaultMapFromNodeModules,\n+  createVirtualTypeScriptEnvironment,\n+} from 'next/dist/compiled/@typescript/vfs'\n+\n+import path, { join } from 'path'\n \n import type tsModule from 'typescript/lib/tsserverlibrary'\n type TypeScript = typeof import('typescript/lib/tsserverlibrary')\n \n let ts: TypeScript\n let info: tsModule.server.PluginCreateInfo\n let appDirRegExp: RegExp\n+export let virtualTsEnv: VirtualTypeScriptEnvironment\n \n export function log(message: string) {\n-  info.project.projectService.logger.info(message)\n+  info.project.projectService.logger.info('[next] ' + message)\n }\n \n // This function has to be called initially.\n export function init(opts: {\n   ts: TypeScript\n   info: tsModule.server.PluginCreateInfo\n }) {\n+  const projectDir = opts.info.project.getCurrentDirectory()\n   ts = opts.ts\n   info = opts.info\n-  const projectDir = info.project.getCurrentDirectory()\n   appDirRegExp = new RegExp(\n     '^' + (projectDir + '(/src)?/app').replace(/[\\\\/]/g, '[\\\\/]')\n   )\n-  log('Starting Next.js TypeScript plugin: ' + projectDir)\n+\n+  log('Initializing Next.js TypeScript plugin: ' + projectDir)\n+\n+  const compilerOptions = info.project.getCompilerOptions()\n+  const fsMap = createDefaultMapFromNodeModules(\n+    compilerOptions,\n+    ts,\n+    join(projectDir, 'node_modules/typescript/lib')\n+  )\n+  const system = createFSBackedSystem(fsMap, projectDir, ts)\n+\n+  virtualTsEnv = createVirtualTypeScriptEnvironment(\n+    system,\n+    [],\n+    ts,\n+    compilerOptions\n+  )\n+\n+  if (virtualTsEnv) {\n+    log(\n+      'Failed to create virtual TypeScript environment. This is a bug in Next.js TypeScript plugin. Please report it by opening an issue at https://github.com/vercel/next.js/issues.'\n+    )\n+    return\n+  }\n+\n+  log('Successfully initialized Next.js TypeScript plugin!')\n }\n \n export function getTs() {\n@@ -41,6 +74,13 @@ export function getSource(fileName: string) {\n   return info.languageService.getProgram()?.getSourceFile(fileName)\n }\n \n+export function getSourceFromVirtualTsEnv(fileName: string) {\n+  if (virtualTsEnv.sys.fileExists(fileName)) {\n+    return virtualTsEnv.getSourceFile(fileName)\n+  }\n+  return getSource(fileName)\n+}\n+\n export function removeStringQuotes(str: string): string {\n   return str.replace(/^['\"`]|['\"`]$/g, '')\n }"
        },
        {
            "sha": "942df19a49bb9a001a61be37fce2f5f66e649c11",
            "filename": "packages/next/taskfile.js",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Ftaskfile.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Ftaskfile.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftaskfile.js?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -2234,6 +2234,14 @@ export async function ncc_https_proxy_agent(task, opts) {\n     .target('src/compiled/https-proxy-agent')\n }\n \n+externals['@typescript/vfs'] = 'next/dist/compiled/@typescript/vfs'\n+export async function ncc_typescript_vfs(task, opts) {\n+  await task\n+    .source(relative(__dirname, require.resolve('@typescript/vfs')))\n+    .ncc({ packageName: '@typescript/vfs', externals })\n+    .target('src/compiled/@typescript/vfs')\n+}\n+\n export async function precompile(task, opts) {\n   await task.parallel(\n     ['browser_polyfills', 'copy_ncced', 'copy_styled_jsx_assets'],\n@@ -2381,6 +2389,7 @@ export async function ncc(task, opts) {\n         'ncc_opentelemetry_api',\n         'ncc_http_proxy_agent',\n         'ncc_https_proxy_agent',\n+        'ncc_typescript_vfs',\n         'ncc_mini_css_extract_plugin',\n       ],\n       opts"
        },
        {
            "sha": "6be8aaf43b0c470323d49a9ae486809a263b4c55",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -747,6 +747,11 @@ declare module 'next/dist/compiled/zod-validation-error' {\n   export = zve\n }\n \n+declare module 'next/dist/compiled/@typescript/vfs' {\n+  import m from '@typescript/vfs'\n+  export = m\n+}\n+\n declare module 'mini-css-extract-plugin'\n declare module 'next/dist/compiled/loader-utils3'\n "
        },
        {
            "sha": "293cf0fd64952b8f102c66b66bab0822da59f23e",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/5c499049ef3942750e9359e06b506536946fcc17/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/5c499049ef3942750e9359e06b506536946fcc17/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=5c499049ef3942750e9359e06b506536946fcc17",
            "patch": "@@ -1179,6 +1179,9 @@ importers:\n       '@types/ws':\n         specifier: 8.2.0\n         version: 8.2.0\n+      '@typescript/vfs':\n+        specifier: 1.6.1\n+        version: 1.6.1(typescript@5.8.2)\n       '@vercel/ncc':\n         specifier: 0.34.0\n         version: 0.34.0\n@@ -6414,6 +6417,11 @@ packages:\n     resolution: {integrity: sha512-0/TdC3aeRAsW7MDvYRwEc1Uwm0TIBfzjPFgg60UU2Haj5qsCs9cc3zNgY71edqE3LbWfF/WoZQd3lJoDXFQpag==}\n     engines: {node: ^18.18.0 || ^20.9.0 || >=21.1.0}\n \n+  '@typescript/vfs@1.6.1':\n+    resolution: {integrity: sha512-JwoxboBh7Oz1v38tPbkrZ62ZXNHAk9bJ7c9x0eI5zBfBnBYGhURdbnh7Z4smN/MV48Y5OCcZb58n972UtbazsA==}\n+    peerDependencies:\n+      typescript: '*'\n+\n   '@ungap/structured-clone@1.2.0':\n     resolution: {integrity: sha512-zuVdFrMJiuCDQUMCzQaD6KL28MjnqqN8XnAqiEq9PNm/hCPTSGfrXCOfwj1ow4LFb/tNymJPwsNbVePc1xFqrQ==}\n \n@@ -19659,7 +19667,7 @@ snapshots:\n   '@eslint/eslintrc@2.1.4':\n     dependencies:\n       ajv: 6.12.6\n-      debug: 4.3.7\n+      debug: 4.4.0\n       espree: 9.6.1\n       globals: 13.24.0\n       ignore: 5.3.2\n@@ -19942,7 +19950,7 @@ snapshots:\n   '@humanwhocodes/config-array@0.11.14':\n     dependencies:\n       '@humanwhocodes/object-schema': 2.0.3\n-      debug: 4.3.7\n+      debug: 4.4.0\n       minimatch: 3.1.2\n     transitivePeerDependencies:\n       - supports-color\n@@ -22864,7 +22872,7 @@ snapshots:\n     dependencies:\n       '@typescript-eslint/typescript-estree': 7.16.0(typescript@5.6.3)\n       '@typescript-eslint/utils': 7.16.0(eslint@9.12.0)(typescript@5.6.3)\n-      debug: 4.3.7\n+      debug: 4.4.0\n       eslint: 9.12.0\n       ts-api-utils: 1.3.0(typescript@5.6.3)\n     optionalDependencies:\n@@ -22911,7 +22919,7 @@ snapshots:\n     dependencies:\n       '@typescript-eslint/types': 7.16.0\n       '@typescript-eslint/visitor-keys': 7.16.0\n-      debug: 4.3.7\n+      debug: 4.4.0\n       globby: 11.1.0\n       is-glob: 4.0.3\n       minimatch: 9.0.5\n@@ -23023,6 +23031,13 @@ snapshots:\n       eslint-visitor-keys: 3.4.3\n     optional: true\n \n+  '@typescript/vfs@1.6.1(typescript@5.8.2)':\n+    dependencies:\n+      debug: 4.1.1\n+      typescript: 5.8.2\n+    transitivePeerDependencies:\n+      - supports-color\n+\n   '@ungap/structured-clone@1.2.0': {}\n \n   '@vercel/fetch-cached-dns@2.0.2(node-fetch@2.6.7(encoding@0.1.13))':"
        }
    ],
    "stats": {
        "total": 295,
        "additions": 162,
        "deletions": 133
    }
}