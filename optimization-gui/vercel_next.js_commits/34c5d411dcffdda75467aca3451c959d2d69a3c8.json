{
    "author": "devjiwonchoi",
    "message": "[ts-next-plugin] add testing utils (#79079)\n\nPorted from https://github.com/vercel/next.js/pull/78505, this PR adds testing utils and a basic log test for the Next.js TypeScript language service plugin.",
    "sha": "34c5d411dcffdda75467aca3451c959d2d69a3c8",
    "files": [
        {
            "sha": "a212c04408fdcafc25b972f7c2e0189cce9bff88",
            "filename": "test/development/typescript-plugin/index.test.ts",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/34c5d411dcffdda75467aca3451c959d2d69a3c8/test%2Fdevelopment%2Ftypescript-plugin%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/34c5d411dcffdda75467aca3451c959d2d69a3c8/test%2Fdevelopment%2Ftypescript-plugin%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ftypescript-plugin%2Findex.test.ts?ref=34c5d411dcffdda75467aca3451c959d2d69a3c8",
            "patch": "@@ -0,0 +1,18 @@\n+import type { PluginLanguageService } from './test-utils'\n+import { getPluginLanguageService } from './test-utils'\n+\n+describe('typescript-plugin', () => {\n+  let languageService: PluginLanguageService\n+\n+  beforeAll(() => {\n+    languageService = getPluginLanguageService(__dirname)\n+  })\n+\n+  it('should be able to get the language service', () => {\n+    expect(languageService).toBeDefined()\n+    const capturedLogs = languageService.getCapturedLogs()\n+    expect(capturedLogs).toContain(\n+      '[next] Initialized Next.js TypeScript plugin'\n+    )\n+  })\n+})"
        },
        {
            "sha": "1aeabb308708cfcac9e3d1520ec45e96a1b62c7f",
            "filename": "test/development/typescript-plugin/test-utils.ts",
            "status": "added",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/34c5d411dcffdda75467aca3451c959d2d69a3c8/test%2Fdevelopment%2Ftypescript-plugin%2Ftest-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/34c5d411dcffdda75467aca3451c959d2d69a3c8/test%2Fdevelopment%2Ftypescript-plugin%2Ftest-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Ftypescript-plugin%2Ftest-utils.ts?ref=34c5d411dcffdda75467aca3451c959d2d69a3c8",
            "patch": "@@ -0,0 +1,70 @@\n+import tsNextPluginFactory from 'next'\n+import ts from 'typescript'\n+export { NEXT_TS_ERRORS } from 'next/dist/server/typescript/constant'\n+\n+export type PluginLanguageService = ts.LanguageService & {\n+  getCapturedLogs: () => string\n+}\n+\n+export function getPluginLanguageService(dir: string): PluginLanguageService {\n+  const files = ts.sys.readDirectory(dir)\n+\n+  const compilerOptions = ts.getDefaultCompilerOptions()\n+  const compilerHost = ts.createCompilerHost(compilerOptions)\n+\n+  let logs = ''\n+  const logger = {\n+    info: (...args: any[]) => {\n+      const message = args\n+        .map((arg) => (typeof arg === 'string' ? arg : JSON.stringify(arg)))\n+        .join(' ')\n+      logs += message + '\\n'\n+      console.log(...args)\n+    },\n+  }\n+\n+  const languageServiceHost: ts.LanguageServiceHost = {\n+    ...compilerHost,\n+    getCompilationSettings: () => compilerOptions,\n+    getScriptFileNames: () => files,\n+    getScriptSnapshot: (fileName) => {\n+      const contents = ts.sys.readFile(fileName)\n+      if (contents && typeof contents === 'string') {\n+        return ts.ScriptSnapshot.fromString(contents)\n+      }\n+      return\n+    },\n+    getScriptVersion: () => '0',\n+    writeFile: ts.sys.writeFile,\n+  }\n+\n+  const languageService = ts.createLanguageService(languageServiceHost)\n+\n+  const pluginCreateInfo: ts.server.PluginCreateInfo = {\n+    project: {\n+      projectService: {\n+        logger,\n+      },\n+      getCurrentDirectory: () => dir,\n+    } as unknown as ts.server.Project,\n+    languageService,\n+    languageServiceHost,\n+    serverHost: null,\n+    config: {},\n+  }\n+\n+  const plugin: ts.server.PluginModule = (\n+    tsNextPluginFactory as unknown as ts.server.PluginModuleFactory\n+  )({ typescript: ts })\n+\n+  const service = plugin.create(pluginCreateInfo) as PluginLanguageService\n+\n+  // Add a custom method to get captured logs\n+  service.getCapturedLogs = () => logs\n+\n+  return service\n+}\n+\n+export function getTsFiles(dir: string): string[] {\n+  return ts.sys.readDirectory(dir)\n+}"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 88,
        "deletions": 0
    }
}