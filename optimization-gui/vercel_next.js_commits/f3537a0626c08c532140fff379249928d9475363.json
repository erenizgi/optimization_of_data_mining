{
    "author": "sokra",
    "message": "Turbopack: Change run once signature to avoid exposing TaskId (#83844)\n\n### What?\n\nchange signature of run_once to make the behavior more clear\n\nsimplify stuff",
    "sha": "f3537a0626c08c532140fff379249928d9475363",
    "files": [
        {
            "sha": "21613df1a97acb0b5d30044523d80918ea344ce9",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 14,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -32,9 +32,8 @@ use tracing::Instrument;\n use tracing_subscriber::{Registry, layer::SubscriberExt, util::SubscriberInitExt};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{\n-    Completion, Effects, FxIndexSet, NonLocalValue, OperationValue, OperationVc, ReadRef,\n-    ResolvedVc, TaskInput, TransientInstance, TryJoinIterExt, TurboTasksApi, UpdateInfo, Vc,\n-    get_effects,\n+    Effects, FxIndexSet, NonLocalValue, OperationValue, OperationVc, ReadRef, ResolvedVc,\n+    TaskInput, TransientInstance, TryJoinIterExt, TurboTasksApi, UpdateInfo, Vc, get_effects,\n     message_queue::{CompilationEvent, Severity, TimingEvent},\n     trace::TraceRawVcs,\n };\n@@ -465,13 +464,18 @@ pub fn project_new(\n             .or_else(|e| turbopack_ctx.throw_turbopack_internal_result(&e))\n             .await?;\n \n-        turbo_tasks.spawn_once_task({\n+        turbo_tasks.start_once_process({\n             let tt = turbo_tasks.clone();\n-            async move {\n-                benchmark_file_io(tt, container.project().node_root().owned().await?)\n-                    .await\n-                    .inspect_err(|err| tracing::warn!(%err, \"failed to benchmark file IO\"))\n-            }\n+            Box::pin(async move {\n+                let future = async move {\n+                    benchmark_file_io(tt, container.project().node_root().owned().await?).await\n+                };\n+                if let Err(err) = future.await {\n+                    // TODO Not ideal to print directly to stdout.\n+                    // We should use a compilation event instead to report async errors.\n+                    println!(\"Failed to benchmark file IO: {err}\");\n+                }\n+            })\n         });\n \n         Ok(External::new(ProjectInstance {\n@@ -519,10 +523,7 @@ impl CompilationEvent for SlowFilesystemEvent {\n /// - https://x.com/jarredsumner/status/1637549427677364224\n /// - https://github.com/oven-sh/bun/blob/06a9aa80c38b08b3148bfeabe560/src/install/install.zig#L3038\n #[tracing::instrument(skip(turbo_tasks))]\n-async fn benchmark_file_io(\n-    turbo_tasks: NextTurboTasks,\n-    directory: FileSystemPath,\n-) -> Result<Vc<Completion>> {\n+async fn benchmark_file_io(turbo_tasks: NextTurboTasks, directory: FileSystemPath) -> Result<()> {\n     // try to get the real file path on disk so that we can use it with tokio\n     let fs = ResolvedVc::try_downcast_type::<DiskFileSystem>(directory.fs)\n         .context(anyhow!(\n@@ -567,7 +568,7 @@ async fn benchmark_file_io(\n         }));\n     }\n \n-    Ok(Completion::new())\n+    Ok(())\n }\n \n #[napi]"
        },
        {
            "sha": "e532eae1a394a349a69fd5f56b54c5c5870ec0ed",
            "filename": "turbopack/crates/turbo-tasks-backend/benches/scope_stress.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fscope_stress.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fscope_stress.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fscope_stress.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -1,6 +1,6 @@\n use anyhow::Result;\n use criterion::{BenchmarkId, Criterion};\n-use turbo_tasks::{Completion, ReadConsistency, TryJoinIterExt, TurboTasks, Vc};\n+use turbo_tasks::{Completion, TryJoinIterExt, TurboTasks, Vc};\n use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n \n pub fn scope_stress(c: &mut Criterion) {\n@@ -47,12 +47,11 @@ pub fn scope_stress(c: &mut Criterion) {\n                             .map(|(a, b)| {\n                                 let tt = &tt;\n                                 async move {\n-                                    let task = tt.spawn_once_task(async move {\n+                                    tt.run_once(async move {\n                                         rectangle(a, b).strongly_consistent().await?;\n-                                        Ok::<Vc<()>, _>(Default::default())\n-                                    });\n-                                    tt.wait_task_completion(task, ReadConsistency::Eventual)\n-                                        .await\n+                                        Ok(())\n+                                    })\n+                                    .await\n                                 }\n                             })\n                             .try_join()"
        },
        {
            "sha": "c5c53077bfbd59ece9060076fdf6c6e4221cc678",
            "filename": "turbopack/crates/turbo-tasks-backend/benches/stress.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 8,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fstress.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fstress.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fbenches%2Fstress.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -1,6 +1,6 @@\n use anyhow::Result;\n use criterion::{BenchmarkId, Criterion};\n-use turbo_tasks::{ReadConsistency, TryJoinIterExt, TurboTasks, Vc};\n+use turbo_tasks::{TryJoinIterExt, TurboTasks, Vc};\n use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n \n pub fn fibonacci(c: &mut Criterion) {\n@@ -37,18 +37,16 @@ pub fn fibonacci(c: &mut Criterion) {\n                     noop_backing_storage(),\n                 ));\n                 async move {\n-                    let task = tt.spawn_once_task(async move {\n+                    tt.run_once(async move {\n                         // Number of tasks:\n                         // 1 root task\n                         // size >= 1 => + fib(0) = 1\n                         // size >= 2 => + fib(1) = 2\n                         (0..size).map(|i| fib(i, i)).try_join().await?;\n-                        Ok::<Vc<()>, _>(Default::default())\n-                    });\n-                    tt.wait_task_completion(task, ReadConsistency::Eventual)\n-                        .await\n-                        .unwrap();\n-                    tt\n+                        Ok(())\n+                    })\n+                    .await\n+                    .unwrap();\n                 }\n             })\n         });"
        },
        {
            "sha": "e5795a27eca2713ad637abf59d2a261b3400236d",
            "filename": "turbopack/crates/turbo-tasks-testing/src/lib.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 5,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbo-tasks-testing%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbo-tasks-testing%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Fsrc%2Flib.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -7,6 +7,7 @@ use std::{\n     future::Future,\n     mem::replace,\n     panic::AssertUnwindSafe,\n+    pin::Pin,\n     sync::{Arc, Mutex, Weak},\n };\n \n@@ -120,22 +121,30 @@ impl TurboTasksCallApi for VcStorage {\n     fn run_once(\n         &self,\n         _future: std::pin::Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId {\n+    ) -> Pin<\n+        Box<\n+            (dyn futures::Future<Output = Result<(), anyhow::Error>> + std::marker::Send + 'static),\n+        >,\n+    > {\n         unreachable!()\n     }\n \n     fn run_once_with_reason(\n         &self,\n         _reason: StaticOrArc<dyn InvalidationReason>,\n         _future: std::pin::Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId {\n+    ) -> Pin<\n+        Box<\n+            (dyn futures::Future<Output = Result<(), anyhow::Error>> + std::marker::Send + 'static),\n+        >,\n+    > {\n         unreachable!()\n     }\n \n-    fn run_once_process(\n+    fn start_once_process(\n         &self,\n-        _future: std::pin::Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId {\n+        _future: std::pin::Pin<Box<dyn Future<Output = ()> + Send + 'static>>,\n+    ) {\n         unreachable!()\n     }\n }"
        },
        {
            "sha": "fb9cfed8bce08869c77c2a66a6ae56eb34e28a4c",
            "filename": "turbopack/crates/turbo-tasks/src/manager.rs",
            "status": "modified",
            "additions": 33,
            "deletions": 44,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmanager.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -77,16 +77,13 @@ pub trait TurboTasksCallApi: Sync + Send {\n     fn run_once(\n         &self,\n         future: Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId;\n+    ) -> Pin<Box<dyn Future<Output = Result<()>> + Send>>;\n     fn run_once_with_reason(\n         &self,\n         reason: StaticOrArc<dyn InvalidationReason>,\n         future: Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId;\n-    fn run_once_process(\n-        &self,\n-        future: Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId;\n+    ) -> Pin<Box<dyn Future<Output = Result<()>> + Send>>;\n+    fn start_once_process(&self, future: Pin<Box<dyn Future<Output = ()> + Send + 'static>>);\n }\n \n /// A type-erased subset of [`TurboTasks`] stored inside a thread local when we're in a turbo task\n@@ -493,7 +490,7 @@ impl<B: Backend + 'static> TurboTasks<B> {\n     /// Creates a new root task, that is only executed once.\n     /// Dependencies will not invalidate the task.\n     #[track_caller]\n-    pub fn spawn_once_task<T, Fut>(&self, future: Fut) -> TaskId\n+    fn spawn_once_task<T, Fut>(&self, future: Fut) -> TaskId\n     where\n         T: ?Sized,\n         Fut: Future<Output = Result<Vc<T>>> + Send + 'static,\n@@ -533,6 +530,21 @@ impl<B: Backend + 'static> TurboTasks<B> {\n         Ok(rx.await?)\n     }\n \n+    pub fn start_once_process(&self, future: impl Future<Output = ()> + Send + 'static) {\n+        let this = self.pin();\n+        tokio::spawn(async move {\n+            this.pin()\n+                .run_once(async move {\n+                    this.finish_foreground_job();\n+                    future.await;\n+                    this.begin_foreground_job();\n+                    Ok(())\n+                })\n+                .await\n+                .unwrap()\n+        });\n+    }\n+\n     pub(crate) fn native_call(\n         &self,\n         native_fn: &'static NativeFunction,\n@@ -1109,41 +1121,28 @@ impl<B: Backend + 'static> TurboTasksCallApi for TurboTasks<B> {\n     fn run_once(\n         &self,\n         future: Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId {\n-        self.spawn_once_task(async move {\n-            future.await?;\n-            Ok(Completion::new())\n-        })\n+    ) -> Pin<Box<dyn Future<Output = Result<()>> + Send>> {\n+        let this = self.pin();\n+        Box::pin(async move { this.run_once(future).await })\n     }\n \n     #[track_caller]\n     fn run_once_with_reason(\n         &self,\n         reason: StaticOrArc<dyn InvalidationReason>,\n         future: Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId {\n+    ) -> Pin<Box<dyn Future<Output = Result<()>> + Send>> {\n         {\n             let (_, reason_set) = &mut *self.aggregated_update.lock().unwrap();\n             reason_set.insert(reason);\n         }\n-        self.spawn_once_task(async move {\n-            future.await?;\n-            Ok(Completion::new())\n-        })\n+        let this = self.pin();\n+        Box::pin(async move { this.run_once(future).await })\n     }\n \n     #[track_caller]\n-    fn run_once_process(\n-        &self,\n-        future: Pin<Box<dyn Future<Output = Result<()>> + Send + 'static>>,\n-    ) -> TaskId {\n-        let this = self.pin();\n-        self.spawn_once_task(async move {\n-            this.finish_foreground_job();\n-            future.await?;\n-            this.begin_foreground_job();\n-            Ok(Completion::new())\n-        })\n+    fn start_once_process(&self, future: Pin<Box<dyn Future<Output = ()> + Send + 'static>>) {\n+        self.start_once_process(future)\n     }\n }\n \n@@ -1428,18 +1427,13 @@ pub async fn run_once<T: Send + 'static>(\n ) -> Result<T> {\n     let (tx, rx) = tokio::sync::oneshot::channel();\n \n-    let task_id = tt.run_once(Box::pin(async move {\n+    tt.run_once(Box::pin(async move {\n         let result = future.await?;\n         tx.send(result)\n             .map_err(|_| anyhow!(\"unable to send result\"))?;\n         Ok(())\n-    }));\n-\n-    // INVALIDATION: A Once task will never invalidate, therefore we don't need to\n-    // track a dependency\n-    let raw_result = read_task_output_untracked(&*tt, task_id, ReadConsistency::Eventual).await?;\n-    let raw_future = raw_result.into_read().untracked();\n-    turbo_tasks_future_scope(tt, ReadVcFuture::<Completion>::from(raw_future)).await?;\n+    }))\n+    .await?;\n \n     Ok(rx.await?)\n }\n@@ -1451,21 +1445,16 @@ pub async fn run_once_with_reason<T: Send + 'static>(\n ) -> Result<T> {\n     let (tx, rx) = tokio::sync::oneshot::channel();\n \n-    let task_id = tt.run_once_with_reason(\n+    tt.run_once_with_reason(\n         (Arc::new(reason) as Arc<dyn InvalidationReason>).into(),\n         Box::pin(async move {\n             let result = future.await?;\n             tx.send(result)\n                 .map_err(|_| anyhow!(\"unable to send result\"))?;\n             Ok(())\n         }),\n-    );\n-\n-    // INVALIDATION: A Once task will never invalidate, therefore we don't need to\n-    // track a dependency\n-    let raw_result = read_task_output_untracked(&*tt, task_id, ReadConsistency::Eventual).await?;\n-    let raw_future = raw_result.into_read().untracked();\n-    turbo_tasks_future_scope(tt, ReadVcFuture::<Completion>::from(raw_future)).await?;\n+    )\n+    .await?;\n \n     Ok(rx.await?)\n }"
        },
        {
            "sha": "9a8c8663716f220dab41c93c72ab5bf04051c1a0",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 40,
            "deletions": 46,
            "changes": 86,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -9,9 +9,7 @@ use anyhow::{Context, Result, bail};\n use rustc_hash::FxHashSet;\n use tracing::Instrument;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{\n-    ReadConsistency, ResolvedVc, TransientInstance, TryJoinIterExt, TurboTasks, Vc, apply_effects,\n-};\n+use turbo_tasks::{ResolvedVc, TransientInstance, TryJoinIterExt, TurboTasks, Vc, apply_effects};\n use turbo_tasks_backend::{\n     BackendOptions, NoopBackingStorage, TurboTasksBackend, noop_backing_storage,\n };\n@@ -143,51 +141,47 @@ impl TurbopackBuildBuilder {\n     }\n \n     pub async fn build(self) -> Result<()> {\n-        let task = self.turbo_tasks.spawn_once_task::<(), _>(async move {\n-            let build_result_op = build_internal(\n-                self.project_dir.clone(),\n-                self.root_dir,\n-                self.entry_requests.clone(),\n-                self.browserslist_query,\n-                self.source_maps_type,\n-                self.minify_type,\n-                self.target,\n-                self.scope_hoist,\n-            );\n-\n-            // Await the result to propagate any errors.\n-            build_result_op.read_strongly_consistent().await?;\n-\n-            apply_effects(build_result_op)\n-                .instrument(tracing::info_span!(\"apply effects\"))\n-                .await?;\n-\n-            let issue_reporter: Vc<Box<dyn IssueReporter>> =\n-                Vc::upcast(ConsoleUi::new(TransientInstance::new(LogOptions {\n-                    project_dir: PathBuf::from(self.project_dir),\n-                    current_dir: current_dir().unwrap(),\n-                    show_all: self.show_all,\n-                    log_detail: self.log_detail,\n-                    log_level: self.log_level,\n-                })));\n-\n-            handle_issues(\n-                build_result_op,\n-                issue_reporter,\n-                IssueSeverity::Error,\n-                None,\n-                None,\n-            )\n-            .await?;\n-\n-            Ok(Default::default())\n-        });\n-\n         self.turbo_tasks\n-            .wait_task_completion(task, ReadConsistency::Strong)\n-            .await?;\n+            .run_once(async move {\n+                let build_result_op = build_internal(\n+                    self.project_dir.clone(),\n+                    self.root_dir,\n+                    self.entry_requests.clone(),\n+                    self.browserslist_query,\n+                    self.source_maps_type,\n+                    self.minify_type,\n+                    self.target,\n+                    self.scope_hoist,\n+                );\n+\n+                // Await the result to propagate any errors.\n+                build_result_op.read_strongly_consistent().await?;\n+\n+                apply_effects(build_result_op)\n+                    .instrument(tracing::info_span!(\"apply effects\"))\n+                    .await?;\n+\n+                let issue_reporter: Vc<Box<dyn IssueReporter>> =\n+                    Vc::upcast(ConsoleUi::new(TransientInstance::new(LogOptions {\n+                        project_dir: PathBuf::from(self.project_dir),\n+                        current_dir: current_dir().unwrap(),\n+                        show_all: self.show_all,\n+                        log_detail: self.log_detail,\n+                        log_level: self.log_level,\n+                    })));\n+\n+                handle_issues(\n+                    build_result_op,\n+                    issue_reporter,\n+                    IssueSeverity::Error,\n+                    None,\n+                    None,\n+                )\n+                .await?;\n \n-        Ok(())\n+                Ok(())\n+            })\n+            .await\n     }\n }\n "
        },
        {
            "sha": "4b2e51bb24adf31b9844d8dc9c6a9ef4eb4bb0e2",
            "filename": "turbopack/crates/turbopack-dev-server/src/update/server.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fupdate%2Fserver.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fupdate%2Fserver.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fupdate%2Fserver.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -52,11 +52,10 @@ where\n \n     /// Run the update server loop.\n     pub fn run(self, tt: &dyn TurboTasksApi, ws: HyperWebsocket) {\n-        tt.run_once_process(Box::pin(async move {\n+        tt.start_once_process(Box::pin(async move {\n             if let Err(err) = self.run_internal(ws).await {\n                 println!(\"[UpdateServer]: error {err:#}\");\n             }\n-            Ok(())\n         }));\n     }\n "
        },
        {
            "sha": "e6e3e32b63eda62d3e509df581148df7b72759b6",
            "filename": "turbopack/crates/turbopack-nft/src/main.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 7,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nft%2Fsrc%2Fmain.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -6,7 +6,7 @@ use std::env::current_dir;\n use anyhow::Result;\n use clap::Parser;\n use tracing_subscriber::{Registry, layer::SubscriberExt, util::SubscriberInitExt};\n-use turbo_tasks::{ReadConsistency, TurboTasks};\n+use turbo_tasks::TurboTasks;\n use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n use turbo_tasks_malloc::TurboMalloc;\n use turbopack_nft::nft::node_file_trace;\n@@ -90,7 +90,7 @@ async fn main_inner(args: Arguments) -> Result<()> {\n         noop_backing_storage(),\n     ));\n \n-    let task = tt.spawn_once_task::<(), _>(async move {\n+    tt.run_once(async move {\n         node_file_trace(\n             current_dir()?.to_str().unwrap().into(),\n             args.entry.into(),\n@@ -99,11 +99,9 @@ async fn main_inner(args: Arguments) -> Result<()> {\n             args.depth,\n         )\n         .await?;\n-        Ok(Default::default())\n-    });\n-\n-    tt.wait_task_completion(task, ReadConsistency::Strong)\n-        .await?;\n+        Ok(())\n+    })\n+    .await?;\n \n     // Intentionally leak this `Arc`. Otherwise we'll waste time during process exit performing a\n     // ton of drop calls."
        },
        {
            "sha": "105fb1004c21dbde307679ab64b2db8cb0f2e5ec",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -11,7 +11,7 @@ use rustc_hash::FxHashSet;\n use serde::Deserialize;\n use serde_json::json;\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ReadConsistency, ResolvedVc, TurboTasks, ValueToString, Vc, apply_effects};\n+use turbo_tasks::{ResolvedVc, TurboTasks, ValueToString, Vc, apply_effects};\n use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n use turbo_tasks_env::DotenvProcessEnv;\n use turbo_tasks_fs::{\n@@ -201,15 +201,14 @@ async fn run(resource: PathBuf) -> Result<()> {\n         },\n         noop_backing_storage(),\n     ));\n-    let task = tt.spawn_once_task(async move {\n+    tt.run_once(async move {\n         let emit_op = run_inner_operation(resource.to_str().unwrap().into());\n         emit_op.read_strongly_consistent().await?;\n         apply_effects(emit_op).await?;\n \n-        Ok(Vc::<()>::default())\n-    });\n-    tt.wait_task_completion(task, ReadConsistency::Strong)\n-        .await?;\n+        Ok(())\n+    })\n+    .await?;\n \n     Ok(())\n }"
        },
        {
            "sha": "f9aa9a3d78483489e127920271bc43dae6848302",
            "filename": "turbopack/crates/turbopack-tracing/benches/node_file_trace.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-tracing%2Fbenches%2Fnode_file_trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f3537a0626c08c532140fff379249928d9475363/turbopack%2Fcrates%2Fturbopack-tracing%2Fbenches%2Fnode_file_trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Fbenches%2Fnode_file_trace.rs?ref=f3537a0626c08c532140fff379249928d9475363",
            "patch": "@@ -3,7 +3,7 @@ use std::{fs, path::PathBuf};\n use criterion::{Bencher, BenchmarkId, Criterion};\n use regex::Regex;\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ReadConsistency, ResolvedVc, TurboTasks, Vc, apply_effects};\n+use turbo_tasks::{ResolvedVc, TurboTasks, Vc, apply_effects};\n use turbo_tasks_backend::{BackendOptions, TurboTasksBackend, noop_backing_storage};\n use turbo_tasks_fs::{DiskFileSystem, FileSystem, NullFileSystem};\n use turbopack::{\n@@ -75,7 +75,7 @@ fn bench_emit(b: &mut Bencher, bench_input: &BenchInput) {\n         let tests_root: RcStr = bench_input.tests_root.clone().into();\n         let input: RcStr = bench_input.input.clone().into();\n         async move {\n-            let task = tt.spawn_once_task(async move {\n+            tt.run_once(async move {\n                 let input_fs = DiskFileSystem::new(rcstr!(\"tests\"), tests_root.clone());\n                 let input = input_fs.root().await?.join(&input)?;\n \n@@ -125,11 +125,10 @@ fn bench_emit(b: &mut Bencher, bench_input: &BenchInput) {\n                 emit_op.read_strongly_consistent().await?;\n                 apply_effects(emit_op).await?;\n \n-                Ok::<Vc<()>, _>(Default::default())\n-            });\n-            tt.wait_task_completion(task, ReadConsistency::Strong)\n-                .await\n-                .unwrap();\n+                Ok(())\n+            })\n+            .await\n+            .unwrap();\n         }\n     })\n }"
        }
    ],
    "stats": {
        "total": 275,
        "additions": 130,
        "deletions": 145
    }
}