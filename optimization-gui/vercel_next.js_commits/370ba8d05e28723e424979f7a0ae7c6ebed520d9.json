{
    "author": "povilasv",
    "message": "[OTel] fix: Root span name should not include high cardinality URL (#75416)\n\n> HTTP span names SHOULD be {method} {target} if there is a\n(low-cardinality) target available. If there is no (low-cardinality)\n{target} available, HTTP span names SHOULD be {method}.\n\nSome root spans don't have the `next.route` name available. In that\ncase, we used the `req.url` in the name. However, the OTel docs\nrecommend using only the method if the target is high cardinality.\nTherefore, removed the usage of `req.url` in the name of root spans.\n\nx-ref: [OTel\ndocs](https://opentelemetry.io/docs/specs/semconv/http/http-spans/#:~:text=HTTP%20span%20names%20SHOULD%20be%20%7Bmethod%7D%20%7Btarget%7D%20if%20there%20is%20a%20(low%2Dcardinality)%20target%20available.%20If%20there%20is%20no%20(low%2Dcardinality)%20%7Btarget%7D%20available%2C%20HTTP%20span%20names%20SHOULD%20be%20%7Bmethod%7D.)\nRelated: https://github.com/vercel/next.js/discussions/59645\n\n---------\n\nCo-authored-by: Jiwon Choi <devjiwonchoi@gmail.com>\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "370ba8d05e28723e424979f7a0ae7c6ebed520d9",
    "files": [
        {
            "sha": "8b856d5616e95dc306288d289151723c22882fdb",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=370ba8d05e28723e424979f7a0ae7c6ebed520d9",
            "patch": "@@ -459,7 +459,7 @@ export async function handler(\n           })\n           span.updateName(name)\n         } else {\n-          span.updateName(`${method} ${req.url}`)\n+          span.updateName(`${method}`)\n         }\n       })\n     }\n@@ -1396,7 +1396,7 @@ export async function handler(\n         tracer.trace(\n           BaseServerSpan.handleRequest,\n           {\n-            spanName: `${method} ${req.url}`,\n+            spanName: `${method}`,\n             kind: SpanKind.SERVER,\n             attributes: {\n               'http.method': method,"
        },
        {
            "sha": "25a5e915b691409cd00ef2030a3ad260032b58f8",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=370ba8d05e28723e424979f7a0ae7c6ebed520d9",
            "patch": "@@ -258,7 +258,7 @@ export async function handler(\n           })\n           span.updateName(name)\n         } else {\n-          span.updateName(`${method} ${req.url}`)\n+          span.updateName(`${method}`)\n         }\n       })\n     }\n@@ -454,7 +454,7 @@ export async function handler(\n         tracer.trace(\n           BaseServerSpan.handleRequest,\n           {\n-            spanName: `${method} ${req.url}`,\n+            spanName: `${method}`,\n             kind: SpanKind.SERVER,\n             attributes: {\n               'http.method': method,"
        },
        {
            "sha": "f6e41bf1d4669c6699dce7e08d133e8b10d06fd2",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=370ba8d05e28723e424979f7a0ae7c6ebed520d9",
            "patch": "@@ -317,7 +317,7 @@ async function requestHandler(\n             })\n             span.updateName(name)\n           } else {\n-            span.updateName(`${req.method} ${relativeUrl}`)\n+            span.updateName(`${req.method}`)\n           }\n         })\n \n@@ -340,7 +340,7 @@ async function requestHandler(\n     tracer.trace(\n       BaseServerSpan.handleRequest,\n       {\n-        spanName: `${req.method} ${relativeUrl}`,\n+        spanName: `${req.method}`,\n         kind: SpanKind.SERVER,\n         attributes: {\n           'http.method': req.method,"
        },
        {
            "sha": "26998d5de8d13e160e95035dd18099b9d5bea9c5",
            "filename": "packages/next/src/build/templates/edge-ssr.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts?ref=370ba8d05e28723e424979f7a0ae7c6ebed520d9",
            "patch": "@@ -296,7 +296,7 @@ async function requestHandler(\n             })\n             span.updateName(name)\n           } else {\n-            span.updateName(`${req.method} ${relativeUrl}`)\n+            span.updateName(`${req.method}`)\n           }\n         })\n \n@@ -343,7 +343,7 @@ async function requestHandler(\n     tracer.trace(\n       BaseServerSpan.handleRequest,\n       {\n-        spanName: `${req.method} ${relativeUrl}`,\n+        spanName: `${req.method}`,\n         kind: SpanKind.SERVER,\n         attributes: {\n           'http.method': req.method,"
        },
        {
            "sha": "d171866fd9b2a0e78f84cbb34fbed60d832810a5",
            "filename": "packages/next/src/build/templates/pages-api.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-api.ts?ref=370ba8d05e28723e424979f7a0ae7c6ebed520d9",
            "patch": "@@ -133,7 +133,7 @@ export async function handler(\n             })\n             span.updateName(name)\n           } else {\n-            span.updateName(`${method} ${req.url}`)\n+            span.updateName(`${method}`)\n           }\n         })\n \n@@ -146,7 +146,7 @@ export async function handler(\n         tracer.trace(\n           BaseServerSpan.handleRequest,\n           {\n-            spanName: `${method} ${req.url}`,\n+            spanName: `${method}`,\n             kind: SpanKind.SERVER,\n             attributes: {\n               'http.method': method,"
        },
        {
            "sha": "b6ecf642777820ab8f06ac894af9cd4025b0642a",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 7,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/370ba8d05e28723e424979f7a0ae7c6ebed520d9/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=370ba8d05e28723e424979f7a0ae7c6ebed520d9",
            "patch": "@@ -882,13 +882,13 @@ export default abstract class Server<\n   ): Promise<void> {\n     await this.prepare()\n     const method = req.method.toUpperCase()\n-\n     const tracer = getTracer()\n+\n     return tracer.withPropagatedContext(req.headers, () => {\n       return tracer.trace(\n         BaseServerSpan.handleRequest,\n         {\n-          spanName: `${method} ${req.url}`,\n+          spanName: `${method}`,\n           kind: SpanKind.SERVER,\n           attributes: {\n             'http.method': method,\n@@ -944,11 +944,7 @@ export default abstract class Server<\n               })\n               span.updateName(name)\n             } else {\n-              span.updateName(\n-                isRSCRequest\n-                  ? `RSC ${method} ${req.url}`\n-                  : `${method} ${req.url}`\n-              )\n+              span.updateName(isRSCRequest ? `RSC ${method}` : `${method}`)\n             }\n           })\n       )"
        },
        {
            "sha": "4063ff50791b5f7606daebeef2e39efdc2b2dae1",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/370ba8d05e28723e424979f7a0ae7c6ebed520d9/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/370ba8d05e28723e424979f7a0ae7c6ebed520d9/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=370ba8d05e28723e424979f7a0ae7c6ebed520d9",
            "patch": "@@ -333,10 +333,10 @@ describe('opentelemetry', () => {\n                 traceId: env.span.traceId,\n                 parentId: env.span.rootParentId,\n                 runtime: 'nodejs',\n-                name: 'GET /app/param/rsc-fetch/edge',\n+                name: 'GET',\n                 kind: 1,\n                 attributes: {\n-                  'next.span_name': 'GET /app/param/rsc-fetch/edge',\n+                  'next.span_name': 'GET',\n                   'next.span_type': 'BaseServer.handleRequest',\n                   'http.method': 'GET',\n                   'http.target': '/app/param/rsc-fetch/edge',\n@@ -468,10 +468,10 @@ describe('opentelemetry', () => {\n                 runtime: 'nodejs',\n                 traceId: env.span.traceId,\n                 parentId: env.span.rootParentId,\n-                name: 'GET /api/app/param/data/edge',\n+                name: 'GET',\n                 kind: 1,\n                 attributes: {\n-                  'next.span_name': 'GET /api/app/param/data/edge',\n+                  'next.span_name': 'GET',\n                   'next.span_type': 'BaseServer.handleRequest',\n                   'http.method': 'GET',\n                   'http.target': '/api/app/param/data/edge',\n@@ -831,10 +831,10 @@ describe('opentelemetry', () => {\n                 runtime: 'nodejs',\n                 traceId: env.span.traceId,\n                 parentId: env.span.rootParentId,\n-                name: 'GET /pages/param/edge/getServerSideProps',\n+                name: 'GET',\n                 kind: 1,\n                 attributes: {\n-                  'next.span_name': 'GET /pages/param/edge/getServerSideProps',\n+                  'next.span_name': 'GET',\n                   'next.span_type': 'BaseServer.handleRequest',\n                   'http.method': 'GET',\n                   'http.target': '/pages/param/edge/getServerSideProps',\n@@ -1100,10 +1100,10 @@ describe('opentelemetry', () => {\n                 runtime: 'nodejs',\n                 traceId: env.span.traceId,\n                 parentId: env.span.rootParentId,\n-                name: 'GET /api/pages/param/edge',\n+                name: 'GET',\n                 kind: 1,\n                 attributes: {\n-                  'next.span_name': 'GET /api/pages/param/edge',\n+                  'next.span_name': 'GET',\n                   'next.span_type': 'BaseServer.handleRequest',\n                   'http.method': 'GET',\n                   'http.target': '/api/pages/param/edge',"
        }
    ],
    "stats": {
        "total": 46,
        "additions": 21,
        "deletions": 25
    }
}