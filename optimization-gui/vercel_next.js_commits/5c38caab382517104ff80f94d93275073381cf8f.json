{
    "author": "xusd320",
    "message": "refactor(turbo-tasks-fs): change FS to_sys_path to be synchronous (#82341)",
    "sha": "5c38caab382517104ff80f94d93275073381cf8f",
    "files": [
        {
            "sha": "48228597ca4c709afcf9a9b77fd021e4de060252",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c38caab382517104ff80f94d93275073381cf8f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c38caab382517104ff80f94d93275073381cf8f/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=5c38caab382517104ff80f94d93275073381cf8f",
            "patch": "@@ -541,7 +541,7 @@ async fn benchmark_file_io(\n         ))?\n         .await?;\n \n-    let directory = fs.to_sys_path(directory).await?;\n+    let directory = fs.to_sys_path(directory)?;\n     let temp_path = directory.join(format!(\n         \"tmp_file_io_benchmark_{:x}\",\n         rand::random::<u128>()"
        },
        {
            "sha": "59205def86e6a6a6d53de9a4aa6fdb7513902483",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5c38caab382517104ff80f94d93275073381cf8f/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c38caab382517104ff80f94d93275073381cf8f/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=5c38caab382517104ff80f94d93275073381cf8f",
            "patch": "@@ -474,7 +474,7 @@ impl DiskFileSystem {\n         self.inner.watcher.stop_watching();\n     }\n \n-    pub async fn to_sys_path(&self, fs_path: FileSystemPath) -> Result<PathBuf> {\n+    pub fn to_sys_path(&self, fs_path: FileSystemPath) -> Result<PathBuf> {\n         // just in case there's a windows unc path prefix we remove it with `dunce`\n         let path = self.inner.root_path();\n         Ok(if fs_path.path.is_empty() {\n@@ -545,7 +545,7 @@ impl FileSystem for DiskFileSystem {\n     #[turbo_tasks::function(fs)]\n     async fn read(&self, fs_path: FileSystemPath) -> Result<Vc<FileContent>> {\n         mark_session_dependent();\n-        let full_path = self.to_sys_path(fs_path).await?;\n+        let full_path = self.to_sys_path(fs_path)?;\n         self.inner.register_read_invalidator(&full_path)?;\n \n         let _lock = self.inner.lock_path(&full_path).await;\n@@ -571,7 +571,7 @@ impl FileSystem for DiskFileSystem {\n     #[turbo_tasks::function(fs)]\n     async fn raw_read_dir(&self, fs_path: FileSystemPath) -> Result<Vc<RawDirectoryContent>> {\n         mark_session_dependent();\n-        let full_path = self.to_sys_path(fs_path).await?;\n+        let full_path = self.to_sys_path(fs_path)?;\n         self.inner.register_dir_invalidator(&full_path)?;\n \n         // we use the sync std function here as it's a lot faster (600%) in\n@@ -626,7 +626,7 @@ impl FileSystem for DiskFileSystem {\n     #[turbo_tasks::function(fs)]\n     async fn read_link(&self, fs_path: FileSystemPath) -> Result<Vc<LinkContent>> {\n         mark_session_dependent();\n-        let full_path = self.to_sys_path(fs_path.clone()).await?;\n+        let full_path = self.to_sys_path(fs_path.clone())?;\n         self.inner.register_read_invalidator(&full_path)?;\n \n         let _lock = self.inner.lock_path(&full_path).await;\n@@ -716,7 +716,7 @@ impl FileSystem for DiskFileSystem {\n         // `write` purely declares a side effect and does not need to be reexecuted in the next\n         // session. All side effects are reexecuted in general.\n \n-        let full_path = self.to_sys_path(fs_path).await?;\n+        let full_path = self.to_sys_path(fs_path)?;\n         let content = content.await?;\n         let inner = self.inner.clone();\n         let invalidator = turbo_tasks::get_invalidator();\n@@ -851,7 +851,7 @@ impl FileSystem for DiskFileSystem {\n         // `write_link` purely declares a side effect and does not need to be reexecuted in the next\n         // session. All side effects are reexecuted in general.\n \n-        let full_path = self.to_sys_path(fs_path).await?;\n+        let full_path = self.to_sys_path(fs_path)?;\n         let content = target.await?;\n         let inner = self.inner.clone();\n         let invalidator = turbo_tasks::get_invalidator();\n@@ -975,7 +975,7 @@ impl FileSystem for DiskFileSystem {\n     #[turbo_tasks::function(fs)]\n     async fn metadata(&self, fs_path: FileSystemPath) -> Result<Vc<FileMeta>> {\n         mark_session_dependent();\n-        let full_path = self.to_sys_path(fs_path).await?;\n+        let full_path = self.to_sys_path(fs_path)?;\n         self.inner.register_read_invalidator(&full_path)?;\n \n         let _lock = self.inner.lock_path(&full_path).await;\n@@ -2308,7 +2308,7 @@ pub async fn to_sys_path(mut path: FileSystemPath) -> Result<Option<PathBuf>> {\n         }\n \n         if let Some(fs) = Vc::try_resolve_downcast_type::<DiskFileSystem>(path.fs()).await? {\n-            let sys_path = fs.await?.to_sys_path(path).await?;\n+            let sys_path = fs.await?.to_sys_path(path)?;\n             return Ok(Some(sys_path));\n         }\n "
        },
        {
            "sha": "f87b5bf34908e51b343103d8fd6ddfbef7cce274",
            "filename": "turbopack/crates/turbo-tasks-fs/src/util.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 8,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/5c38caab382517104ff80f94d93275073381cf8f/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c38caab382517104ff80f94d93275073381cf8f/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Futil.rs?ref=5c38caab382517104ff80f94d93275073381cf8f",
            "patch": "@@ -152,8 +152,7 @@ pub async fn uri_from_file(root: FileSystemPath, path: Option<&str>) -> Result<S\n                 .to_sys_path(match path {\n                     Some(path) => root.join(path)?,\n                     None => root,\n-                })\n-                .await?\n+                })?\n                 .to_string_lossy()\n         )\n         .split('/')\n@@ -171,12 +170,10 @@ pub async fn uri_from_file(root: FileSystemPath, path: Option<&str>) -> Result<S\n         .context(\"Expected root to have a DiskFileSystem\")?\n         .await?;\n \n-    let sys_path = root_fs\n-        .to_sys_path(match path {\n-            Some(path) => root.join(path.into())?,\n-            None => root,\n-        })\n-        .await?;\n+    let sys_path = root_fs.to_sys_path(match path {\n+        Some(path) => root.join(path.into())?,\n+        None => root,\n+    })?;\n \n     let raw_path = sys_path.to_string_lossy().to_string();\n     let normalized_path = raw_path.replace('\\\\', \"/\");"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 14,
        "deletions": 17
    }
}