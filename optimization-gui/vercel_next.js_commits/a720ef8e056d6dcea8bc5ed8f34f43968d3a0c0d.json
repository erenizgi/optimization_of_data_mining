{
    "author": "kdy1",
    "message": "refactor(turbopack): Make invalidator flag explicit (#80414)\n\n### What?\n\nMake `#[turbo_tasks::function(invalidator)]` a thing. It's a preparation for the automatic (runtime) detection of statically-analyzable immutable turbo task.\n\n### Why?\n\nWe need it for an advanced optimization",
    "sha": "a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
    "files": [
        {
            "sha": "7e418f2157d6d4a260eab189d833693ee46564a8",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -423,7 +423,7 @@ impl ProjectContainer {\n \n #[turbo_tasks::value_impl]\n impl ProjectContainer {\n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     pub async fn project(&self) -> Result<Vc<Project>> {\n         let env_map: Vc<EnvMap>;\n         let next_config;"
        },
        {
            "sha": "a40a8760c8708e2ffe337805d9f99be8a8107709",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -551,7 +551,7 @@ impl Debug for DiskFileSystem {\n \n #[turbo_tasks::value_impl]\n impl FileSystem for DiskFileSystem {\n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn read(&self, fs_path: Vc<FileSystemPath>) -> Result<Vc<FileContent>> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -577,7 +577,7 @@ impl FileSystem for DiskFileSystem {\n         Ok(content.cell())\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn raw_read_dir(&self, fs_path: Vc<FileSystemPath>) -> Result<Vc<RawDirectoryContent>> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -632,7 +632,7 @@ impl FileSystem for DiskFileSystem {\n         Ok(RawDirectoryContent::new(entries))\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn read_link(&self, fs_path: Vc<FileSystemPath>) -> Result<Vc<LinkContent>> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -718,7 +718,7 @@ impl FileSystem for DiskFileSystem {\n         .cell())\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn write(&self, fs_path: Vc<FileSystemPath>, content: Vc<FileContent>) -> Result<()> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -843,7 +843,7 @@ impl FileSystem for DiskFileSystem {\n         Ok(())\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn write_link(&self, fs_path: Vc<FileSystemPath>, target: Vc<LinkContent>) -> Result<()> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;\n@@ -962,7 +962,7 @@ impl FileSystem for DiskFileSystem {\n         Ok(())\n     }\n \n-    #[turbo_tasks::function(fs)]\n+    #[turbo_tasks::function(fs, invalidator)]\n     async fn metadata(&self, fs_path: Vc<FileSystemPath>) -> Result<Vc<FileMeta>> {\n         mark_session_dependent();\n         let full_path = self.to_sys_path(fs_path).await?;"
        },
        {
            "sha": "fc599d59ec7324bee165a1bfcc8ca9975f39a7f0",
            "filename": "turbopack/crates/turbo-tasks-macros-tests/tests/function/fail_attribute_invalid_args.stderr",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args.stderr?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -1,4 +1,4 @@\n-error: unexpected token, expected one of: \"fs\", \"network\", \"operation\", \"local\"\n+error: unexpected token, expected one of: \"fs\", \"network\", \"operation\", \"local\", \"invalidator\"\n  --> tests/function/fail_attribute_invalid_args.rs:9:25\n   |\n 9 | #[turbo_tasks::function(invalid_argument)]"
        },
        {
            "sha": "80a5d65669fad70000c631d07131f06739e473b6",
            "filename": "turbopack/crates/turbo-tasks-macros-tests/tests/function/fail_attribute_invalid_args_inherent_impl.stderr",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args_inherent_impl.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args_inherent_impl.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ffunction%2Ffail_attribute_invalid_args_inherent_impl.stderr?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -1,4 +1,4 @@\n-error: unexpected token, expected one of: \"fs\", \"network\", \"operation\", \"local\"\n+error: unexpected token, expected one of: \"fs\", \"network\", \"operation\", \"local\", \"invalidator\"\n   --> tests/function/fail_attribute_invalid_args_inherent_impl.rs:14:29\n    |\n 14 |     #[turbo_tasks::function(invalid_argument)]"
        },
        {
            "sha": "5155391e24fe22fe1535927ff04ad97e0c9ef6e0",
            "filename": "turbopack/crates/turbo-tasks-macros/src/func.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunc.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -733,6 +733,9 @@ pub struct FunctionArguments {\n     /// task-local state. The function call itself will not be cached, but cells will be created on\n     /// the parent task.\n     pub local: Option<Span>,\n+    /// If true, the function will be allowed to call `get_invalidator` . If this is false, the\n+    /// `get_invalidator` function will panic on calls.\n+    pub invalidator: Option<Span>,\n }\n \n impl Parse for FunctionArguments {\n@@ -760,11 +763,14 @@ impl Parse for FunctionArguments {\n                 (\"local\", Meta::Path(_)) => {\n                     parsed_args.local = Some(meta.span());\n                 }\n+                (\"invalidator\", Meta::Path(_)) => {\n+                    parsed_args.invalidator = Some(meta.span());\n+                }\n                 (_, meta) => {\n                     return Err(syn::Error::new_spanned(\n                         meta,\n                         \"unexpected token, expected one of: \\\"fs\\\", \\\"network\\\", \\\"operation\\\", \\\n-                         \\\"local\\\"\",\n+                         \\\"local\\\", \\\"invalidator\\\"\",\n                     ));\n                 }\n             }\n@@ -1092,6 +1098,7 @@ pub struct NativeFn {\n     pub is_self_used: bool,\n     pub filter_trait_call_args: Option<FilterTraitCallArgsTokens>,\n     pub local: bool,\n+    pub invalidator: bool,\n }\n \n impl NativeFn {\n@@ -1107,6 +1114,7 @@ impl NativeFn {\n             is_self_used,\n             filter_trait_call_args,\n             local,\n+            invalidator,\n         } = self;\n \n         if *is_method {\n@@ -1133,6 +1141,7 @@ impl NativeFn {\n                             #function_path_string.to_owned(),\n                             turbo_tasks::macro_helpers::FunctionMeta {\n                                 local: #local,\n+                                invalidator: #invalidator,\n                             },\n                             #arg_filter,\n                             #function_path,\n@@ -1147,6 +1156,7 @@ impl NativeFn {\n                             #function_path_string.to_owned(),\n                             turbo_tasks::macro_helpers::FunctionMeta {\n                                 local: #local,\n+                                invalidator: #invalidator,\n                             },\n                             #arg_filter,\n                             #function_path,\n@@ -1162,6 +1172,7 @@ impl NativeFn {\n                         #function_path_string.to_owned(),\n                         turbo_tasks::macro_helpers::FunctionMeta {\n                             local: #local,\n+                            invalidator: #invalidator,\n                         },\n                         #function_path,\n                     )"
        },
        {
            "sha": "7a12b69b2a81a00f563491ea672a0fcb70f4dbb6",
            "filename": "turbopack/crates/turbo-tasks-macros/src/function_macro.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Ffunction_macro.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -42,6 +42,7 @@ pub fn function(args: TokenStream, input: TokenStream) -> TokenStream {\n         .inspect_err(|err| errors.push(err.to_compile_error()))\n         .unwrap_or_default();\n     let local = args.local.is_some();\n+    let invalidator = args.invalidator.is_some();\n     let is_self_used = args.operation.is_some() || is_self_used(&block);\n \n     let Some(turbo_fn) = TurboFn::new(&sig, DefinitionContext::NakedFn, args) else {\n@@ -65,6 +66,7 @@ pub fn function(args: TokenStream, input: TokenStream) -> TokenStream {\n         is_self_used,\n         filter_trait_call_args: None, // not a trait method\n         local,\n+        invalidator,\n     };\n     let native_function_ident = get_native_function_ident(ident);\n     let native_function_ty = native_fn.ty();"
        },
        {
            "sha": "a9292fc4ae70012e0f8bb7f405bd9db7cf6258c4",
            "filename": "turbopack/crates/turbo-tasks-macros/src/value_impl_macro.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_impl_macro.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -84,6 +84,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     continue;\n                 };\n                 let local = func_args.local.is_some();\n+                let invalidator = func_args.invalidator.is_some();\n                 let is_self_used = func_args.operation.is_some() || is_self_used(block);\n \n                 let Some(turbo_fn) =\n@@ -106,6 +107,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     is_self_used,\n                     filter_trait_call_args: None, // not a trait method\n                     local,\n+                    invalidator,\n                 };\n \n                 let native_function_ident = get_inherent_impl_function_ident(ty_ident, ident);\n@@ -191,6 +193,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                 };\n \n                 let local = func_args.local.is_some();\n+                let invalidator = func_args.invalidator.is_some();\n                 let is_self_used = func_args.operation.is_some() || is_self_used(block);\n \n                 let Some(turbo_fn) =\n@@ -223,6 +226,7 @@ pub fn value_impl(args: TokenStream, input: TokenStream) -> TokenStream {\n                     is_self_used,\n                     filter_trait_call_args: turbo_fn.filter_trait_call_args(),\n                     local,\n+                    invalidator,\n                 };\n \n                 let native_function_ident ="
        },
        {
            "sha": "73ee61cb07d2911bf7efb50c688e280f8262a6cf",
            "filename": "turbopack/crates/turbo-tasks-macros/src/value_trait_macro.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros%2Fsrc%2Fvalue_trait_macro.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -139,6 +139,7 @@ pub fn value_trait(args: TokenStream, input: TokenStream) -> TokenStream {\n                 //   argument. (This could be fixed)\n                 // - This only makes sense when a default implementation is present.\n                 local: false,\n+                invalidator: func_args.invalidator.is_some(),\n             };\n \n             let native_function_ident = get_trait_default_impl_function_ident(trait_ident, ident);"
        },
        {
            "sha": "921d9be73c4fa7fc52fd740bcd92f85f1ab58b0d",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/read_ref_cell.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fread_ref_cell.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fread_ref_cell.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Fread_ref_cell.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -70,7 +70,7 @@ impl Counter {\n \n #[turbo_tasks::value_impl]\n impl Counter {\n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     async fn get_value(&self) -> Result<Vc<CounterValue>> {\n         let mut lock = self.value.lock().unwrap();\n         lock.1 = Some(get_invalidator());"
        },
        {
            "sha": "882280ec2fa08340e6d906ee2e82361d855dfcaa",
            "filename": "turbopack/crates/turbo-tasks-testing/tests/trait_ref_cell.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftrait_ref_cell.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftrait_ref_cell.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-testing%2Ftests%2Ftrait_ref_cell.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -85,7 +85,7 @@ trait CounterTrait {\n \n #[turbo_tasks::value_impl]\n impl CounterTrait for Counter {\n-    #[turbo_tasks::function]\n+    #[turbo_tasks::function(invalidator)]\n     async fn get_value(&self) -> Result<Vc<CounterValue>> {\n         let mut lock = self.value.lock().unwrap();\n         lock.1 = Some(get_invalidator());"
        },
        {
            "sha": "119abbb4948a66e12127bdca385684f1d4af015d",
            "filename": "turbopack/crates/turbo-tasks/src/invalidation.rs",
            "status": "modified",
            "additions": 19,
            "deletions": 1,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Finvalidation.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -9,7 +9,7 @@ use std::{\n use anyhow::Result;\n use indexmap::map::Entry;\n use serde::{Deserialize, Serialize, de::Visitor};\n-use tokio::runtime::Handle;\n+use tokio::{runtime::Handle, task_local};\n \n use crate::{\n     FxIndexMap, FxIndexSet, TaskId, TurboTasksApi,\n@@ -19,9 +19,27 @@ use crate::{\n     util::StaticOrArc,\n };\n \n+#[cfg(debug_assertions)]\n+task_local! {\n+    static ALLOW_INVALIDATOR: ();\n+}\n+\n+#[cfg(debug_assertions)]\n+pub fn allow_invalidator<R>(f: impl Future<Output = R>) -> impl Future<Output = R> {\n+    ALLOW_INVALIDATOR.scope((), f)\n+}\n+\n /// Get an [`Invalidator`] that can be used to invalidate the current task\n /// based on external events.\n pub fn get_invalidator() -> Invalidator {\n+    #[cfg(debug_assertions)]\n+    if ALLOW_INVALIDATOR.try_with(|_| {}).is_err() {\n+        panic!(\n+            \"Invalidator can only be used in the turbo-tasks function that has \\\n+             #[turbo_tasks::function(invalidator)] attribute\"\n+        );\n+    }\n+\n     let handle = Handle::current();\n     Invalidator {\n         task: current_task(\"turbo_tasks::get_invalidator()\"),"
        },
        {
            "sha": "15c0ebb89044b9d84e23fac3fff3a698e64321e9",
            "filename": "turbopack/crates/turbo-tasks/src/native_function.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs?ref=a720ef8e056d6dcea8bc5ed8f34f43968d3a0c0d",
            "patch": "@@ -144,6 +144,10 @@ pub struct FunctionMeta {\n     /// task-local state. The function call itself will not be cached, but cells will be created on\n     /// the parent task.\n     pub local: bool,\n+\n+    /// If true, the function will be allowed to call `get_invalidator` . If this is false, the\n+    /// `get_invalidator` function will panic on calls.\n+    pub invalidator: bool,\n }\n \n /// A native (rust) turbo-tasks function. It's used internally by\n@@ -235,7 +239,14 @@ impl NativeFunction {\n     /// Executed the function\n     pub fn execute(&'static self, this: Option<RawVc>, arg: &dyn MagicAny) -> NativeTaskFuture {\n         match (self.implementation).functor(this, arg) {\n-            Ok(functor) => functor,\n+            Ok(functor) => {\n+                #[cfg(debug_assertions)]\n+                if self.function_meta.invalidator {\n+                    return Box::pin(crate::invalidation::allow_invalidator(functor));\n+                }\n+\n+                functor\n+            }\n             Err(err) => Box::pin(async { Err(err) }),\n         }\n     }"
        }
    ],
    "stats": {
        "total": 75,
        "additions": 61,
        "deletions": 14
    }
}