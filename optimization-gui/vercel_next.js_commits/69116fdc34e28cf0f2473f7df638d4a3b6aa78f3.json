{
    "author": "eps1lon",
    "message": "[test] Use new Redbox matchers in pages/ ReactRefreshLogBox-app-doc (#76551)",
    "sha": "69116fdc34e28cf0f2473f7df638d4a3b6aa78f3",
    "files": [
        {
            "sha": "6b6b3a67f73ec7945b28939d687e9ae679885588",
            "filename": "test/development/acceptance/ReactRefreshLogBox-app-doc.test.ts",
            "status": "modified",
            "additions": 179,
            "deletions": 159,
            "changes": 338,
            "blob_url": "https://github.com/vercel/next.js/blob/69116fdc34e28cf0f2473f7df638d4a3b6aa78f3/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-app-doc.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/69116fdc34e28cf0f2473f7df638d4a3b6aa78f3/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-app-doc.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2FReactRefreshLogBox-app-doc.test.ts?ref=69116fdc34e28cf0f2473f7df638d4a3b6aa78f3",
            "patch": "@@ -1,54 +1,67 @@\n import { createSandbox } from 'development-sandbox'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n-import { describeVariants as describe } from 'next-test-utils'\n import { outdent } from 'outdent'\n import path from 'path'\n \n-describe.each(['default', 'turbo'])(\n-  'ReactRefreshLogBox _app _document %s',\n-  () => {\n-    const { next } = nextTestSetup({\n-      files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n-      skipStart: true,\n-    })\n-\n-    test('empty _app shows logbox', async () => {\n-      await using sandbox = await createSandbox(\n-        next,\n-        new Map([['pages/_app.js', ``]])\n-      )\n-      const { session } = sandbox\n-      await session.assertHasRedbox()\n-      expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-        `\"Error: The default export is not a React Component in page: \"/_app\"\"`\n-      )\n-\n-      await session.patch(\n-        'pages/_app.js',\n-        outdent`\n+describe('ReactRefreshLogBox _app _document', () => {\n+  const { isTurbopack, next } = nextTestSetup({\n+    files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n+    skipStart: true,\n+  })\n+\n+  test('empty _app shows logbox', async () => {\n+    await using sandbox = await createSandbox(\n+      next,\n+      new Map([['pages/_app.js', ``]])\n+    )\n+    const { browser, session } = sandbox\n+    await expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"Error: The default export is not a React Component in page: \"/_app\"\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": null,\n+       \"stack\": [],\n+     }\n+    `)\n+    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n+      `\"Error: The default export is not a React Component in page: \"/_app\"\"`\n+    )\n+\n+    await session.patch(\n+      'pages/_app.js',\n+      outdent`\n         function MyApp({ Component, pageProps }) {\n           return <Component {...pageProps} />;\n         }\n         export default MyApp\n       `\n-      )\n-      await session.assertNoRedbox()\n-    })\n-\n-    test('empty _document shows logbox', async () => {\n-      await using sandbox = await createSandbox(\n-        next,\n-        new Map([['pages/_document.js', ``]])\n-      )\n-      const { session } = sandbox\n-      await session.assertHasRedbox()\n-      expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-        `\"Error: The default export is not a React Component in page: \"/_document\"\"`\n-      )\n-\n-      await session.patch(\n-        'pages/_document.js',\n-        outdent`\n+    )\n+    await session.assertNoRedbox()\n+  })\n+\n+  test('empty _document shows logbox', async () => {\n+    await using sandbox = await createSandbox(\n+      next,\n+      new Map([['pages/_document.js', ``]])\n+    )\n+    const { browser, session } = sandbox\n+\n+    await expect(browser).toDisplayRedbox(`\n+     {\n+       \"count\": 1,\n+       \"description\": \"Error: The default export is not a React Component in page: \"/_document\"\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": null,\n+       \"stack\": [],\n+     }\n+    `)\n+\n+    await session.patch(\n+      'pages/_document.js',\n+      outdent`\n         import Document, { Html, Head, Main, NextScript } from 'next/document'\n \n         class MyDocument extends Document {\n@@ -72,85 +85,91 @@ describe.each(['default', 'turbo'])(\n \n         export default MyDocument\n       `\n-      )\n-      await session.assertNoRedbox()\n-    })\n-\n-    test('_app syntax error shows logbox', async () => {\n-      await using sandbox = await createSandbox(\n-        next,\n-        new Map([\n-          [\n-            'pages/_app.js',\n-            outdent`\n+    )\n+    await session.assertNoRedbox()\n+  })\n+\n+  test('_app syntax error shows logbox', async () => {\n+    await using sandbox = await createSandbox(\n+      next,\n+      new Map([\n+        [\n+          'pages/_app.js',\n+          outdent`\n             function MyApp({ Component, pageProps }) {\n               return <<Component {...pageProps} />;\n             }\n             export default MyApp\n           `,\n-          ],\n-        ])\n-      )\n-      const { session } = sandbox\n-      await session.assertHasRedbox()\n-      const content = await session.getRedboxSource()\n-      const source = next.normalizeTestDirContent(content)\n-      if (process.env.TURBOPACK) {\n-        expect(source).toMatchInlineSnapshot(`\n-         \"./pages/_app.js (2:11)\n-         Parsing ecmascript source code failed\n-           1 | function MyApp({ Component, pageProps }) {\n-         > 2 |   return <<Component {...pageProps} />;\n-             |           ^\n-           3 | }\n-           4 | export default MyApp\n-\n-         Expression expected\"\n-        `)\n-      } else {\n-        expect(source).toMatchInlineSnapshot(`\n-          \"./pages/_app.js\n-          Error:   x Expression expected\n-             ,-[2:1]\n-           1 | function MyApp({ Component, pageProps }) {\n-           2 |   return <<Component {...pageProps} />;\n-             :           ^\n-           3 | }\n-           4 | export default MyApp\n-             \\`----\n-            x Expression expected\n-             ,-[2:1]\n-           1 | function MyApp({ Component, pageProps }) {\n-           2 |   return <<Component {...pageProps} />;\n-             :            ^^^^^^^^^\n-           3 | }\n-           4 | export default MyApp\n-             \\`----\n-\n-          Caused by:\n-              Syntax Error\"\n-        `)\n-      }\n-\n-      await session.patch(\n-        'pages/_app.js',\n-        outdent`\n+        ],\n+      ])\n+    )\n+    const { browser, session } = sandbox\n+\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./pages/_app.js (2:11)\n+       Parsing ecmascript source code failed\n+       > 2 |   return <<Component {...pageProps} />;\n+           |           ^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Expression expected\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./pages/_app.js\n+       Error:   x Expression expected\n+          ,-[2:1]\n+        1 | function MyApp({ Component, pageProps }) {\n+        2 |   return <<Component {...pageProps} />;\n+          :           ^\n+        3 | }\n+        4 | export default MyApp\n+          \\`----\n+         x Expression expected\n+          ,-[2:1]\n+        1 | function MyApp({ Component, pageProps }) {\n+        2 |   return <<Component {...pageProps} />;\n+          :            ^^^^^^^^^\n+        3 | }\n+        4 | export default MyApp\n+          \\`----\n+       Caused by:\n+           Syntax Error\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n+\n+    await session.patch(\n+      'pages/_app.js',\n+      outdent`\n         function MyApp({ Component, pageProps }) {\n           return <Component {...pageProps} />;\n         }\n         export default MyApp\n       `\n-      )\n-      await session.assertNoRedbox()\n-    })\n-\n-    test('_document syntax error shows logbox', async () => {\n-      await using sandbox = await createSandbox(\n-        next,\n-        new Map([\n-          [\n-            'pages/_document.js',\n-            outdent`\n+    )\n+    await session.assertNoRedbox()\n+  })\n+\n+  test('_document syntax error shows logbox', async () => {\n+    await using sandbox = await createSandbox(\n+      next,\n+      new Map([\n+        [\n+          'pages/_document.js',\n+          outdent`\n             import Document, { Html, Head, Main, NextScript } from 'next/document'\n \n             class MyDocument extends Document {{\n@@ -174,50 +193,52 @@ describe.each(['default', 'turbo'])(\n \n             export default MyDocument\n           `,\n-          ],\n-        ])\n-      )\n-      const { session } = sandbox\n-      await session.assertHasRedbox()\n-      const source = next.normalizeTestDirContent(\n-        await session.getRedboxSource()\n-      )\n-      if (process.env.TURBOPACK) {\n-        expect(source).toMatchInlineSnapshot(`\n-         \"./pages/_document.js (3:36)\n-         Parsing ecmascript source code failed\n-           1 | import Document, { Html, Head, Main, NextScript } from 'next/document'\n-           2 |\n-         > 3 | class MyDocument extends Document {{\n-             |                                    ^\n-           4 |   static async getInitialProps(ctx) {\n-           5 |     const initialProps = await Document.getInitialProps(ctx)\n-           6 |     return { ...initialProps }\n-\n-         Unexpected token \\`{\\`. Expected identifier, string literal, numeric literal or [ for the computed key\"\n-        `)\n-      } else {\n-        expect(source).toMatchInlineSnapshot(`\n-          \"./pages/_document.js\n-          Error:   x Unexpected token \\`{\\`. Expected identifier, string literal, numeric literal or [ for the computed key\n-             ,-[3:1]\n-           1 | import Document, { Html, Head, Main, NextScript } from 'next/document'\n-           2 | \n-           3 | class MyDocument extends Document {{\n-             :                                    ^\n-           4 |   static async getInitialProps(ctx) {\n-           5 |     const initialProps = await Document.getInitialProps(ctx)\n-           6 |     return { ...initialProps }\n-             \\`----\n-\n-          Caused by:\n-              Syntax Error\"\n-        `)\n-      }\n-\n-      await session.patch(\n-        'pages/_document.js',\n-        outdent`\n+        ],\n+      ])\n+    )\n+    const { browser, session } = sandbox\n+    if (isTurbopack) {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Parsing ecmascript source code failed\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./pages/_document.js (3:36)\n+       Parsing ecmascript source code failed\n+       > 3 | class MyDocument extends Document {{\n+           |                                    ^\",\n+         \"stack\": [],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"count\": 1,\n+         \"description\": \"Error:   x Unexpected token \\`{\\`. Expected identifier, string literal, numeric literal or [ for the computed key\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Build Error\",\n+         \"source\": \"./pages/_document.js\n+       Error:   x Unexpected token \\`{\\`. Expected identifier, string literal, numeric literal or [ for the computed key\n+          ,-[3:1]\n+        1 | import Document, { Html, Head, Main, NextScript } from 'next/document'\n+        2 |\n+        3 | class MyDocument extends Document {{\n+          :                                    ^\n+        4 |   static async getInitialProps(ctx) {\n+        5 |     const initialProps = await Document.getInitialProps(ctx)\n+        6 |     return { ...initialProps }\n+          \\`----\n+       Caused by:\n+           Syntax Error\",\n+         \"stack\": [],\n+       }\n+      `)\n+    }\n+\n+    await session.patch(\n+      'pages/_document.js',\n+      outdent`\n         import Document, { Html, Head, Main, NextScript } from 'next/document'\n \n         class MyDocument extends Document {\n@@ -241,8 +262,7 @@ describe.each(['default', 'turbo'])(\n \n         export default MyDocument\n       `\n-      )\n-      await session.assertNoRedbox()\n-    })\n-  }\n-)\n+    )\n+    await session.assertNoRedbox()\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 338,
        "additions": 179,
        "deletions": 159
    }
}