{
    "author": "xusd320",
    "message": "refactor(turbopack): remove lazy_static dependency (#80226)\n\n## Why\r\nlazy_static  is deprecated, see [Officially deprecate lazy_static #214\r\n](https://github.com/rust-lang-nursery/lazy-static.rs/issues/214)",
    "sha": "c8ac2a52d8b131783a63812523ad73d45f69ee48",
    "files": [
        {
            "sha": "d2f22bf7de6f21c014c512ca3890e2da410ca6d9",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -4216,7 +4216,6 @@ dependencies = [\n  \"indoc\",\n  \"itertools 0.10.5\",\n  \"lazy-regex\",\n- \"lazy_static\",\n  \"mime_guess\",\n  \"modularize_imports\",\n  \"next-custom-transforms\",\n@@ -4268,7 +4267,6 @@ dependencies = [\n  \"hex\",\n  \"indexmap 2.7.1\",\n  \"indoc\",\n- \"lazy_static\",\n  \"modularize_imports\",\n  \"once_cell\",\n  \"pathdiff\",\n@@ -9361,7 +9359,6 @@ dependencies = [\n  \"anyhow\",\n  \"codspeed-criterion-compat\",\n  \"difference\",\n- \"lazy_static\",\n  \"regex\",\n  \"rstest\",\n  \"rstest_reuse\",\n@@ -9513,7 +9510,6 @@ dependencies = [\n  \"either\",\n  \"futures\",\n  \"indexmap 2.7.1\",\n- \"lazy_static\",\n  \"once_cell\",\n  \"patricia_tree\",\n  \"petgraph 0.6.3\",\n@@ -9627,7 +9623,6 @@ dependencies = [\n  \"either\",\n  \"indexmap 2.7.1\",\n  \"indoc\",\n- \"lazy_static\",\n  \"num-bigint\",\n  \"num-traits\",\n  \"once_cell\",\n@@ -9831,7 +9826,6 @@ name = \"turbopack-resolve\"\n version = \"0.1.0\"\n dependencies = [\n  \"anyhow\",\n- \"lazy_static\",\n  \"regex\",\n  \"serde\",\n  \"serde_json\","
        },
        {
            "sha": "c35a7f5d327a362670acf321eb313c2e61c7c01d",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 9,
            "deletions": 8,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -14,9 +14,7 @@ members = [\n   \"turbopack/xtask\",\n ]\n \n-exclude = [\n-  \"crates/next-error-code-swc-plugin\",\n-]\n+exclude = [\"crates/next-error-code-swc-plugin\"]\n \n [workspace.lints.clippy]\n too_many_arguments = \"allow\"\n@@ -350,15 +348,14 @@ image = { version = \"0.25.0\", default-features = false }\n indexmap = \"2.7.1\"\n indoc = \"2.0.0\"\n itertools = \"0.10.5\"\n-lazy_static = \"1.4.0\"\n lightningcss = { version = \"1.0.0-alpha.66\", features = [\n   \"serde\",\n   \"visitor\",\n   \"into_owned\",\n ] }\n lightningcss-napi = { version = \"0.4.4\", default-features = false, features = [\n-  \"visitor\"\n-]}\n+  \"visitor\",\n+] }\n markdown = \"1.0.0-alpha.18\"\n mime = \"0.3.16\"\n napi = { version = \"2\", default-features = false, features = [\n@@ -418,8 +415,12 @@ triomphe = { git = \"https://github.com/sokra/triomphe\", branch = \"sokra/unstable\n unsize = \"1.1.0\"\n url = \"2.2.2\"\n urlencoding = \"2.1.2\"\n-vergen = { version = \"9.0.6\", features = [\"cargo\"] }\n-vergen-gitcl = { version = \"1.0.8\", features = [\"cargo\"] }\n+vergen = { version = \"9.0.6\", features = [\n+  \"cargo\",\n+] }\n+vergen-gitcl = { version = \"1.0.8\", features = [\n+  \"cargo\",\n+] }\n webbrowser = \"0.8.7\"\n \n [patch.crates-io]"
        },
        {
            "sha": "59af44e67be7a5b78de37d8a173bf291876c58da",
            "filename": "crates/next-core/Cargo.toml",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/crates%2Fnext-core%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/crates%2Fnext-core%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2FCargo.toml?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -28,7 +28,6 @@ mime_guess = \"2.0.4\"\n indoc = { workspace = true }\n allsorts = { workspace = true }\n futures = { workspace = true }\n-lazy_static = { workspace = true }\n thiserror = { workspace = true }\n tracing = { workspace = true }\n rustc-hash = { workspace = true }\n@@ -69,7 +68,9 @@ turbopack = { workspace = true }\n turbopack-browser = { workspace = true }\n turbopack-core = { workspace = true }\n turbopack-ecmascript = { workspace = true }\n-turbopack-ecmascript-plugins = { workspace = true, features = [\"transform_emotion\"] }\n+turbopack-ecmascript-plugins = { workspace = true, features = [\n+  \"transform_emotion\",\n+] }\n turbopack-ecmascript-runtime = { workspace = true }\n turbopack-image = { workspace = true }\n turbopack-node = { workspace = true }"
        },
        {
            "sha": "5bcd80cbdd9a6dbd8ddea471790a187c4dcb4dad",
            "filename": "crates/next-core/src/next_shared/resolve.rs",
            "status": "modified",
            "additions": 22,
            "deletions": 19,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fresolve.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fresolve.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Fresolve.rs?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -1,5 +1,6 @@\n+use std::sync::LazyLock;\n+\n use anyhow::Result;\n-use lazy_static::lazy_static;\n use rustc_hash::FxHashMap;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, Vc};\n@@ -21,24 +22,26 @@ use turbopack_core::{\n \n use crate::{next_server::ServerContextType, next_telemetry::ModuleFeatureTelemetry};\n \n-lazy_static! {\n-    // Set of the features we want to track, following existing references in webpack/plugins/telemetry-plugin.\n-    static ref FEATURE_MODULES: FxHashMap<&'static str, Vec<&'static str>> = FxHashMap::from_iter([\n-        (\n-            \"next\",\n-            vec![\n-                \"/image\",\n-                \"/future/image\",\n-                \"/legacy/image\",\n-                \"/script\",\n-                \"/dynamic\",\n-                \"/font/google\",\n-                \"/font/local\"\n-            ]\n-        ),\n-        (\"@next\", vec![\"/font/google\", \"/font/local\"])\n-    ]);\n-}\n+// Set of the features we want to track, following existing references in\n+// webpack/plugins/telemetry-plugin.\n+static FEATURE_MODULES: LazyLock<FxHashMap<&'static str, Vec<&'static str>>> =\n+    LazyLock::new(|| {\n+        FxHashMap::from_iter([\n+            (\n+                \"next\",\n+                vec![\n+                    \"/image\",\n+                    \"/future/image\",\n+                    \"/legacy/image\",\n+                    \"/script\",\n+                    \"/dynamic\",\n+                    \"/font/google\",\n+                    \"/font/local\",\n+                ],\n+            ),\n+            (\"@next\", vec![\"/font/google\", \"/font/local\"]),\n+        ])\n+    });\n \n #[turbo_tasks::value(shared)]\n pub struct InvalidImportModuleIssue {"
        },
        {
            "sha": "4ffec0c4692630cd64c3e6cf78833d332f1ae1c8",
            "filename": "crates/next-custom-transforms/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/crates%2Fnext-custom-transforms%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/crates%2Fnext-custom-transforms%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2FCargo.toml?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -38,7 +38,6 @@ serde_json = { workspace = true, features = [\"preserve_order\"] }\n sha1 = \"0.10.1\"\n tracing = { version = \"0.1.37\" }\n anyhow = { workspace = true }\n-lazy_static = { workspace = true }\n \n swc_core = { workspace = true, features = [\n   \"base\",\n@@ -73,5 +72,5 @@ remove_console = \"0.42.0\"\n preset_env_base = \"3.0.1\"\n \n [dev-dependencies]\n-swc_core = { workspace = true, features = [\"testing_transform\"]}\n+swc_core = { workspace = true, features = [\"testing_transform\"] }\n testing = { workspace = true }"
        },
        {
            "sha": "f1cc24521a17bf8676cb38712afd1d155b8fe37f",
            "filename": "crates/next-custom-transforms/src/transforms/page_static_info/collect_exports_visitor.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exports_visitor.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exports_visitor.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fpage_static_info%2Fcollect_exports_visitor.rs?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -1,6 +1,5 @@\n-use std::iter::FromIterator;\n+use std::{iter::FromIterator, sync::LazyLock};\n \n-use lazy_static::lazy_static;\n use rustc_hash::FxHashSet;\n use swc_core::{\n     atoms::atom,\n@@ -15,15 +14,15 @@ use swc_core::{\n \n use super::{ExportInfo, ExportInfoWarning};\n \n-lazy_static! {\n-    static ref EXPORTS_SET: FxHashSet<&'static str> = FxHashSet::from_iter([\n+static EXPORTS_SET: LazyLock<FxHashSet<&'static str>> = LazyLock::new(|| {\n+    FxHashSet::from_iter([\n         \"getStaticProps\",\n         \"getServerSideProps\",\n         \"generateImageMetadata\",\n         \"generateSitemaps\",\n         \"generateStaticParams\",\n-    ]);\n-}\n+    ])\n+});\n \n pub(crate) struct CollectExportsVisitor {\n     pub export_info: Option<ExportInfo>,"
        },
        {
            "sha": "d031bba416ff9a71f5e3a893da1187fe6c9fd630",
            "filename": "turbopack/crates/turbopack-core/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2FCargo.toml?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -22,13 +22,12 @@ data-encoding = { workspace = true }\n either = { workspace = true }\n futures = { workspace = true }\n indexmap = { workspace = true }\n-lazy_static = { workspace = true }\n once_cell = { workspace = true }\n patricia_tree = \"0.5.5\"\n petgraph = { workspace = true, features = [\"serde-1\"] }\n roaring = { version = \"0.10.10\", features = [\"serde\"] }\n ref-cast = \"1.0.20\"\n-rustc-hash ={ workspace = true }\n+rustc-hash = { workspace = true }\n regex = { workspace = true }\n serde = { workspace = true, features = [\"rc\"] }\n serde_bytes = { workspace = true }"
        },
        {
            "sha": "6571ee04b389be7677ab803b1a09e951cf3b7802",
            "filename": "turbopack/crates/turbopack-core/src/resolve/parse.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 7,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fparse.rs?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -1,5 +1,6 @@\n+use std::sync::LazyLock;\n+\n use anyhow::{Ok, Result};\n-use lazy_static::lazy_static;\n use regex::Regex;\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n@@ -89,12 +90,12 @@ fn split_off_query_fragment(mut raw: &str) -> (Pattern, RcStr, RcStr) {\n     (Pattern::Constant(RcStr::from(raw)), query, hash)\n }\n \n-lazy_static! {\n-    static ref WINDOWS_PATH: Regex = Regex::new(r\"^[A-Za-z]:\\\\|\\\\\\\\\").unwrap();\n-    static ref URI_PATH: Regex = Regex::new(r\"^([^/\\\\:]+:)(.+)$\").unwrap();\n-    static ref DATA_URI_REMAINDER: Regex = Regex::new(r\"^([^;,]*)(?:;([^,]+))?,(.*)$\").unwrap();\n-    static ref MODULE_PATH: Regex = Regex::new(r\"^((?:@[^/]+/)?[^/]+)(.*)$\").unwrap();\n-}\n+static WINDOWS_PATH: LazyLock<Regex> = LazyLock::new(|| Regex::new(r\"^[A-Za-z]:\\\\|\\\\\\\\\").unwrap());\n+static URI_PATH: LazyLock<Regex> = LazyLock::new(|| Regex::new(r\"^([^/\\\\:]+:)(.+)$\").unwrap());\n+static DATA_URI_REMAINDER: LazyLock<Regex> =\n+    LazyLock::new(|| Regex::new(r\"^([^;,]*)(?:;([^,]+))?,(.*)$\").unwrap());\n+static MODULE_PATH: LazyLock<Regex> =\n+    LazyLock::new(|| Regex::new(r\"^((?:@[^/]+/)?[^/]+)(.*)$\").unwrap());\n \n impl Request {\n     /// Turns the request into a string."
        },
        {
            "sha": "458d43939d707ef0ef6df85fd53e63bcafb9cfa5",
            "filename": "turbopack/crates/turbopack-core/src/resolve/pattern.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 16,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fresolve%2Fpattern.rs?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -2,10 +2,10 @@ use std::{\n     collections::{VecDeque, hash_map::Entry},\n     fmt::Display,\n     mem::take,\n+    sync::LazyLock,\n };\n \n use anyhow::Result;\n-use lazy_static::lazy_static;\n use regex::Regex;\n use rustc_hash::{FxHashMap, FxHashSet};\n use serde::{Deserialize, Serialize};\n@@ -846,11 +846,11 @@ impl Pattern {\n                 }\n             }\n             Pattern::Dynamic => {\n-                lazy_static! {\n-                    static ref FORBIDDEN: Regex =\n-                        Regex::new(r\"(/|^)(ROOT|\\.|/|(node_modules|__tests?__)(/|$))\").unwrap();\n-                    static ref FORBIDDEN_MATCH: Regex = Regex::new(r\"\\.d\\.ts$|\\.map$\").unwrap();\n-                }\n+                static FORBIDDEN: LazyLock<Regex> = LazyLock::new(|| {\n+                    Regex::new(r\"(/|^)(ROOT|\\.|/|(node_modules|__tests?__)(/|$))\").unwrap()\n+                });\n+                static FORBIDDEN_MATCH: LazyLock<Regex> =\n+                    LazyLock::new(|| Regex::new(r\"\\.d\\.ts$|\\.map$\").unwrap());\n                 if let Some(m) = FORBIDDEN.find(value) {\n                     MatchResult::Consumed {\n                         remaining: value,\n@@ -932,11 +932,11 @@ impl Pattern {\n                 }\n             }\n             Pattern::Dynamic => {\n-                lazy_static! {\n-                    static ref FORBIDDEN: Regex =\n-                        Regex::new(r\"(/|^)(ROOT|\\.|/|(node_modules|__tests?__)(/|$))\").unwrap();\n-                    static ref FORBIDDEN_MATCH: Regex = Regex::new(r\"\\.d\\.ts$|\\.map$\").unwrap();\n-                }\n+                static FORBIDDEN: LazyLock<Regex> = LazyLock::new(|| {\n+                    Regex::new(r\"(/|^)(ROOT|\\.|/|(node_modules|__tests?__)(/|$))\").unwrap()\n+                });\n+                static FORBIDDEN_MATCH: LazyLock<Regex> =\n+                    LazyLock::new(|| Regex::new(r\"\\.d\\.ts$|\\.map$\").unwrap());\n                 if let Some(m) = FORBIDDEN.find(value) {\n                     MatchResult::Consumed {\n                         remaining: value,\n@@ -1046,11 +1046,11 @@ impl Pattern {\n                 }\n             }\n             Pattern::Dynamic => {\n-                lazy_static! {\n-                    static ref FORBIDDEN: Regex =\n-                        Regex::new(r\"(/|^)(\\.|(node_modules|__tests?__)(/|$))\").unwrap();\n-                    static ref FORBIDDEN_MATCH: Regex = Regex::new(r\"\\.d\\.ts$|\\.map$\").unwrap();\n-                }\n+                static FORBIDDEN: LazyLock<Regex> = LazyLock::new(|| {\n+                    Regex::new(r\"(/|^)(\\.|(node_modules|__tests?__)(/|$))\").unwrap()\n+                });\n+                static FORBIDDEN_MATCH: LazyLock<Regex> =\n+                    LazyLock::new(|| Regex::new(r\"\\.d\\.ts$|\\.map$\").unwrap());\n                 if let Some(m) = FORBIDDEN.find(value) {\n                     NextConstantUntilResult::Consumed(value, Some(m.start()))\n                 } else if FORBIDDEN_MATCH.find(value).is_some() {"
        },
        {
            "sha": "bb315ed2ab7b03aecff437f5880b76805fde86da",
            "filename": "turbopack/crates/turbopack-ecmascript/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2FCargo.toml?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -21,7 +21,6 @@ data-encoding = { workspace = true }\n either = { workspace = true }\n indexmap = { workspace = true }\n indoc = { workspace = true }\n-lazy_static = { workspace = true }\n num-bigint = \"0.4\"\n num-traits = \"0.2.15\"\n once_cell = { workspace = true }"
        },
        {
            "sha": "0f917b6f2da50a27df83c6b7a367e533f6842087",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 19,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -18,14 +18,20 @@ pub mod unreachable;\n pub mod util;\n pub mod worker;\n \n-use std::{borrow::Cow, collections::BTreeMap, future::Future, mem::take, ops::Deref, sync::Arc};\n+use std::{\n+    borrow::Cow,\n+    collections::BTreeMap,\n+    future::Future,\n+    mem::take,\n+    ops::Deref,\n+    sync::{Arc, LazyLock},\n+};\n \n use anyhow::{Result, bail};\n use constant_condition::{ConstantConditionCodeGen, ConstantConditionValue};\n use constant_value::ConstantValueCodeGen;\n use either::Either;\n use indexmap::map::Entry;\n-use lazy_static::lazy_static;\n use num_traits::Zero;\n use once_cell::sync::Lazy;\n use parking_lot::Mutex;\n@@ -632,15 +638,14 @@ pub(crate) async fn analyse_ecmascript_module_internal(\n             if let Some(comments) = comments.get_leading(pos) {\n                 for comment in comments.iter() {\n                     if let CommentKind::Line = comment.kind {\n-                        lazy_static! {\n-                            static ref REFERENCE_PATH: Regex =\n-                                Regex::new(r#\"^/\\s*<reference\\s*path\\s*=\\s*[\"'](.+)[\"']\\s*/>\\s*$\"#)\n-                                    .unwrap();\n-                            static ref REFERENCE_TYPES: Regex = Regex::new(\n-                                r#\"^/\\s*<reference\\s*types\\s*=\\s*[\"'](.+)[\"']\\s*/>\\s*$\"#\n-                            )\n-                            .unwrap();\n-                        }\n+                        static REFERENCE_PATH: LazyLock<Regex> = LazyLock::new(|| {\n+                            Regex::new(r#\"^/\\s*<reference\\s*path\\s*=\\s*[\"'](.+)[\"']\\s*/>\\s*$\"#)\n+                                .unwrap()\n+                        });\n+                        static REFERENCE_TYPES: LazyLock<Regex> = LazyLock::new(|| {\n+                            Regex::new(r#\"^/\\s*<reference\\s*types\\s*=\\s*[\"'](.+)[\"']\\s*/>\\s*$\"#)\n+                                .unwrap()\n+                        });\n                         let text = &comment.text;\n                         if let Some(m) = REFERENCE_PATH.captures(text) {\n                             let path = &m[1];\n@@ -673,10 +678,8 @@ pub(crate) async fn analyse_ecmascript_module_internal(\n             let mut paths_by_pos = Vec::new();\n             for (pos, comments) in comments.trailing.iter() {\n                 for comment in comments.iter().rev() {\n-                    lazy_static! {\n-                        static ref SOURCE_MAP_FILE_REFERENCE: Regex =\n-                            Regex::new(r\"# sourceMappingURL=(.*)$\").unwrap();\n-                    }\n+                    static SOURCE_MAP_FILE_REFERENCE: LazyLock<Regex> =\n+                        LazyLock::new(|| Regex::new(r\"# sourceMappingURL=(.*)$\").unwrap());\n                     if let Some(m) = SOURCE_MAP_FILE_REFERENCE.captures(&comment.text) {\n                         let path = m.get(1).unwrap().as_str();\n                         paths_by_pos.push((pos, path));\n@@ -687,10 +690,9 @@ pub(crate) async fn analyse_ecmascript_module_internal(\n \n             let mut source_map_from_comment = false;\n             if let Some((_, path)) = paths_by_pos.into_iter().max_by_key(|&(pos, _)| pos) {\n-                lazy_static! {\n-                    static ref JSON_DATA_URL_BASE64: Regex =\n-                        Regex::new(r\"^data:application\\/json;(?:charset=utf-8;)?base64\").unwrap();\n-                }\n+                static JSON_DATA_URL_BASE64: LazyLock<Regex> = LazyLock::new(|| {\n+                    Regex::new(r\"^data:application\\/json;(?:charset=utf-8;)?base64\").unwrap()\n+                });\n                 let origin_path = origin.origin_path();\n                 if path.ends_with(\".map\") {\n                     let source_map_origin = origin_path.parent().join(path.into());"
        },
        {
            "sha": "4c3e0a5b5ce3442a120aba91b506b08856ed9d3e",
            "filename": "turbopack/crates/turbopack-resolve/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-resolve%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-resolve%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2FCargo.toml?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -14,7 +14,6 @@ workspace = true\n \n [dependencies]\n anyhow = { workspace = true }\n-lazy_static = { workspace = true }\n regex = { workspace = true }\n serde = { workspace = true }\n serde_json = { workspace = true }"
        },
        {
            "sha": "525574e83dbe28f7f3ba0b8b336f15418622e5e3",
            "filename": "turbopack/crates/turbopack-resolve/src/node_native_binding.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 22,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fnode_native_binding.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fnode_native_binding.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-resolve%2Fsrc%2Fnode_native_binding.rs?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -1,5 +1,6 @@\n+use std::sync::LazyLock;\n+\n use anyhow::Result;\n-use lazy_static::lazy_static;\n use regex::Regex;\n use serde::{Deserialize, Serialize};\n use turbo_rcstr::{RcStr, rcstr};\n@@ -86,17 +87,16 @@ pub async fn resolve_node_pre_gyp_files(\n     config_file_pattern: Vc<Pattern>,\n     compile_target: Vc<CompileTarget>,\n ) -> Result<Vc<ModuleResolveResult>> {\n-    lazy_static! {\n-        static ref NAPI_VERSION_TEMPLATE: Regex =\n-            Regex::new(r\"\\{(napi_build_version|node_napi_label)\\}\")\n-                .expect(\"create napi_build_version regex failed\");\n-        static ref PLATFORM_TEMPLATE: Regex =\n-            Regex::new(r\"\\{platform\\}\").expect(\"create node_platform regex failed\");\n-        static ref ARCH_TEMPLATE: Regex =\n-            Regex::new(r\"\\{arch\\}\").expect(\"create node_arch regex failed\");\n-        static ref LIBC_TEMPLATE: Regex =\n-            Regex::new(r\"\\{libc\\}\").expect(\"create node_libc regex failed\");\n-    }\n+    static NAPI_VERSION_TEMPLATE: LazyLock<Regex> = LazyLock::new(|| {\n+        Regex::new(r\"\\{(napi_build_version|node_napi_label)\\}\")\n+            .expect(\"create napi_build_version regex failed\")\n+    });\n+    static PLATFORM_TEMPLATE: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(r\"\\{platform\\}\").expect(\"create node_platform regex failed\"));\n+    static ARCH_TEMPLATE: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(r\"\\{arch\\}\").expect(\"create node_arch regex failed\"));\n+    static LIBC_TEMPLATE: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(r\"\\{libc\\}\").expect(\"create node_libc regex failed\"));\n     let config = resolve_raw(context_dir, config_file_pattern, true)\n         .first_source()\n         .await?;\n@@ -261,12 +261,11 @@ pub async fn resolve_node_gyp_build_files(\n     context_dir: Vc<FileSystemPath>,\n     compile_target: Vc<CompileTarget>,\n ) -> Result<Vc<ModuleResolveResult>> {\n-    lazy_static! {\n-        // TODO Proper parser\n-        static ref GYP_BUILD_TARGET_NAME: Regex =\n-            Regex::new(r#\"['\"]target_name['\"]\\s*:\\s*(?:\"(.*?)\"|'(.*?)')\"#)\n-                .expect(\"create napi_build_version regex failed\");\n-    }\n+    // TODO Proper parser\n+    static GYP_BUILD_TARGET_NAME: LazyLock<Regex> = LazyLock::new(|| {\n+        Regex::new(r#\"['\"]target_name['\"]\\s*:\\s*(?:\"(.*?)\"|'(.*?)')\"#)\n+            .expect(\"create napi_build_version regex failed\")\n+    });\n     let binding_gyp_pat = Pattern::new(Pattern::Constant(rcstr!(\"binding.gyp\")));\n     let gyp_file = resolve_raw(context_dir, binding_gyp_pat, true);\n     if let [binding_gyp] = &gyp_file.primary_sources().await?[..] {\n@@ -370,15 +369,15 @@ pub async fn resolve_node_bindings_files(\n     context_dir: Vc<FileSystemPath>,\n     file_name: RcStr,\n ) -> Result<Vc<ModuleResolveResult>> {\n-    lazy_static! {\n-        static ref BINDINGS_TRY: [&'static str; 5] = [\n+    static BINDINGS_TRY: LazyLock<[&'static str; 5]> = LazyLock::new(|| {\n+        [\n             \"build/bindings\",\n             \"build/Release\",\n             \"build/Release/bindings\",\n             \"out/Release/bindings\",\n             \"Release/bindings\",\n-        ];\n-    }\n+        ]\n+    });\n     let mut root_context_dir = context_dir;\n     loop {\n         let resolved = resolve_raw("
        },
        {
            "sha": "49a24421422a2631ec9c502bd9b627277ebfa4ed",
            "filename": "turbopack/crates/turbopack/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2FCargo.toml?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -18,7 +18,6 @@ workspace = true\n \n [dependencies]\n anyhow = { workspace = true }\n-lazy_static = { workspace = true }\n regex = { workspace = true }\n rustc-hash = { workspace = true }\n smallvec = { workspace = true }"
        },
        {
            "sha": "5323805b820805da941af2bc2d29777639d40c40",
            "filename": "turbopack/crates/turbopack/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 17,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c8ac2a52d8b131783a63812523ad73d45f69ee48/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Ftests%2Fnode-file-trace.rs?ref=c8ac2a52d8b131783a63812523ad73d45f69ee48",
            "patch": "@@ -12,14 +12,13 @@ use std::{\n     },\n     io::{ErrorKind, Write as _},\n     path::{Path, PathBuf},\n-    sync::{Arc, Mutex},\n+    sync::{Arc, LazyLock, Mutex},\n     time::{Duration, Instant},\n };\n \n use anyhow::{Context, Result, anyhow};\n use difference::Changeset;\n use helpers::print_changeset;\n-use lazy_static::lazy_static;\n use regex::Regex;\n use rstest::*;\n use rstest_reuse::{\n@@ -393,9 +392,8 @@ fn node_file_trace<B: Backend + 'static>(\n     timeout_len: u64,\n     create_turbo_tasks: impl Fn(&Path) -> Arc<TurboTasks<B>>,\n ) {\n-    lazy_static! {\n-        static ref BENCH_SUITES: Arc<Mutex<Vec<BenchSuite>>> = Arc::new(Mutex::new(Vec::new()));\n-    };\n+    static BENCH_SUITES: LazyLock<Arc<Mutex<Vec<BenchSuite>>>> =\n+        LazyLock::new(|| Arc::new(Mutex::new(Vec::new())));\n \n     let r = &mut {\n         let mut builder = if multi_threaded {\n@@ -633,24 +631,20 @@ async fn exec_node(directory: &str, path: &str) -> Result<CommandOutput> {\n }\n \n fn clean_stderr(str: &str) -> String {\n-    lazy_static! {\n-        static ref EXPERIMENTAL_WARNING: Regex =\n-            Regex::new(r\"\\(node:\\d+\\) ExperimentalWarning:\").unwrap();\n-        static ref DEPRECATION_WARNING: Regex =\n-            Regex::new(r\"\\(node:\\d+\\) \\[DEP\\d+] DeprecationWarning:\").unwrap();\n-    }\n+    static EXPERIMENTAL_WARNING: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(r\"\\(node:\\d+\\) ExperimentalWarning:\").unwrap());\n+    static DEPRECATION_WARNING: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(r\"\\(node:\\d+\\) \\[DEP\\d+] DeprecationWarning:\").unwrap());\n     let str = EXPERIMENTAL_WARNING.replace_all(str, \"(node:XXXX) ExperimentalWarning:\");\n     let str = DEPRECATION_WARNING.replace_all(&str, \"(node:XXXX) [DEPXXXX] DeprecationWarning:\");\n     str.to_string()\n }\n \n fn diff(expected: &str, actual: &str) -> String {\n-    lazy_static! {\n-        static ref JAVASCRIPT_TIMESTAMP: Regex =\n-            Regex::new(r\"\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z\").unwrap();\n-        static ref JAVASCRIPT_DATE_TIME: Regex =\n-            Regex::new(r\"\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}.\\d{6}\").unwrap();\n-    }\n+    static JAVASCRIPT_TIMESTAMP: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(r\"\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{3}Z\").unwrap());\n+    static JAVASCRIPT_DATE_TIME: LazyLock<Regex> =\n+        LazyLock::new(|| Regex::new(r\"\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}.\\d{6}\").unwrap());\n     // Remove timestamps from the output.\n     if JAVASCRIPT_DATE_TIME.replace_all(JAVASCRIPT_TIMESTAMP.replace_all(actual, \"\").as_ref(), \"\")\n         == JAVASCRIPT_DATE_TIME"
        }
    ],
    "stats": {
        "total": 247,
        "additions": 118,
        "deletions": 129
    }
}