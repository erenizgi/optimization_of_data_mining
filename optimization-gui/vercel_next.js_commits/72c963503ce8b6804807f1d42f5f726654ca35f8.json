{
    "author": "eps1lon",
    "message": "Pass `filterStackFrame` everywhere (#81516)",
    "sha": "72c963503ce8b6804807f1d42f5f726654ca35f8",
    "files": [
        {
            "sha": "873a4c75212e18349f1f45d10a6f1e2e71076ff2",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 43,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/72c963503ce8b6804807f1d42f5f726654ca35f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/72c963503ce8b6804807f1d42f5f726654ca35f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=72c963503ce8b6804807f1d42f5f726654ca35f8",
            "patch": "@@ -253,6 +253,12 @@ const flightDataPathHeadKey = 'h'\n const getFlightViewportKey = (requestId: string) => requestId + 'v'\n const getFlightMetadataKey = (requestId: string) => requestId + 'm'\n \n+const filterStackFrame =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+        .filterStackFrameDEV\n+    : undefined\n+\n interface ParsedRequestHeaders {\n   /**\n    * Router state provided from the client-side router. Used to handle rendering\n@@ -633,11 +639,6 @@ async function generateDynamicFlightRenderResult(\n     )\n   }\n \n-  const filterStackFrame =\n-    process.env.NODE_ENV !== 'production'\n-      ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n-          .filterStackFrameDEV\n-      : undefined\n   // For app dir, use the bundled version of Flight server renderer (renderToReadableStream)\n   // which contains the subset React.\n   const flightReadableStream = workUnitAsyncStorage.run(\n@@ -740,11 +741,6 @@ async function warmupDevRender(\n     ctx\n   )\n \n-  const filterStackFrame =\n-    process.env.NODE_ENV !== 'production'\n-      ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n-          .filterStackFrameDEV\n-      : undefined\n   // For app dir, use the bundled version of Flight server renderer (renderToReadableStream)\n   // which contains the subset React.\n   workUnitAsyncStorage.run(\n@@ -1877,11 +1873,6 @@ async function renderToStream(\n   const setHeader = res.setHeader.bind(res)\n   const appendHeader = res.appendHeader.bind(res)\n \n-  const filterStackFrame =\n-    process.env.NODE_ENV !== 'production'\n-      ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n-          .filterStackFrameDEV\n-      : undefined\n   try {\n     if (\n       // We only want this behavior when running `next dev`\n@@ -2368,11 +2359,6 @@ async function spawnDynamicValidationInDev(\n     isNotFound\n   )\n \n-  const filterStackFrame =\n-    process.env.NODE_ENV !== 'production'\n-      ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n-          .filterStackFrameDEV\n-      : undefined\n   const pendingInitialServerResult = workUnitAsyncStorage.run(\n     initialServerPrerenderStore,\n     ComponentMod.prerender,\n@@ -3004,12 +2990,6 @@ async function prerenderToStream(\n         res.statusCode === 404\n       )\n \n-      const filterStackFrame =\n-        process.env.NODE_ENV !== 'production'\n-          ? (\n-              require('../lib/source-maps') as typeof import('../lib/source-maps')\n-            ).filterStackFrameDEV\n-          : undefined\n       const pendingInitialServerResult = workUnitAsyncStorage.run(\n         initialServerPrerenderStore,\n         ComponentMod.prerender,\n@@ -3494,12 +3474,6 @@ async function prerenderToStream(\n         ctx,\n         res.statusCode === 404\n       )\n-      const filterStackFrame =\n-        process.env.NODE_ENV !== 'production'\n-          ? (\n-              require('../lib/source-maps') as typeof import('../lib/source-maps')\n-            ).filterStackFrameDEV\n-          : undefined\n       const reactServerResult = (reactServerPrerenderResult =\n         await createReactServerPrerenderResultFromRender(\n           workUnitAsyncStorage.run(\n@@ -3730,12 +3704,6 @@ async function prerenderToStream(\n         res.statusCode === 404\n       )\n \n-      const filterStackFrame =\n-        process.env.NODE_ENV !== 'production'\n-          ? (\n-              require('../lib/source-maps') as typeof import('../lib/source-maps')\n-            ).filterStackFrameDEV\n-          : undefined\n       const reactServerResult = (reactServerPrerenderResult =\n         await createReactServerPrerenderResultFromRender(\n           workUnitAsyncStorage.run(\n@@ -3909,11 +3877,6 @@ async function prerenderToStream(\n       errorType\n     )\n \n-    const filterStackFrame =\n-      process.env.NODE_ENV !== 'production'\n-        ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n-            .filterStackFrameDEV\n-        : undefined\n     const errorServerStream = workUnitAsyncStorage.run(\n       prerenderLegacyStore,\n       ComponentMod.renderToReadableStream,"
        },
        {
            "sha": "3d55668e174e88fa3f8863c1bd3dd0f0ffb6f781",
            "filename": "packages/next/src/server/app-render/collect-segment-data.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/72c963503ce8b6804807f1d42f5f726654ca35f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/72c963503ce8b6804807f1d42f5f726654ca35f8/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fcollect-segment-data.tsx?ref=72c963503ce8b6804807f1d42f5f726654ca35f8",
            "patch": "@@ -64,6 +64,12 @@ export type SegmentPrefetch = {\n   isPartial: boolean\n }\n \n+const filterStackFrame =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+        .filterStackFrameDEV\n+    : undefined\n+\n function onSegmentPrerenderError(error: unknown) {\n   const digest = getDigestForWellKnownError(error)\n   if (digest) {\n@@ -128,6 +134,7 @@ export async function collectSegmentData(\n     />,\n     clientModules,\n     {\n+      filterStackFrame,\n       signal: abortController.signal,\n       onError: onSegmentPrerenderError,\n     }\n@@ -349,6 +356,7 @@ async function renderSegmentPrefetch(\n     segmentPrefetch,\n     clientModules,\n     {\n+      filterStackFrame,\n       signal: abortController.signal,\n       onError: onSegmentPrerenderError,\n     }\n@@ -379,6 +387,7 @@ async function isPartialRSCData(\n     abortController.abort()\n   })\n   await prerender(rsc, clientModules, {\n+    filterStackFrame,\n     signal: abortController.signal,\n     onError() {},\n     onPostpone() {"
        },
        {
            "sha": "c847bd727ce180318ceada862609486a5380bffa",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 6,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/72c963503ce8b6804807f1d42f5f726654ca35f8/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72c963503ce8b6804807f1d42f5f726654ca35f8/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=72c963503ce8b6804807f1d42f5f726654ca35f8",
            "patch": "@@ -80,6 +80,12 @@ const debug = process.env.NEXT_PRIVATE_DEBUG_CACHE\n   ? console.debug.bind(console, 'use-cache:')\n   : undefined\n \n+const filterStackFrame =\n+  process.env.NODE_ENV !== 'production'\n+    ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n+        .filterStackFrameDEV\n+    : undefined\n+\n function generateCacheEntry(\n   workStore: WorkStore,\n   outerWorkUnitStore: WorkUnitStore | undefined,\n@@ -446,6 +452,7 @@ async function generateCacheEntryImpl(\n       clientReferenceManifest.clientModules,\n       {\n         environmentName: 'Cache',\n+        filterStackFrame,\n         signal: abortSignal,\n         temporaryReferences,\n         onError(error) {\n@@ -490,12 +497,6 @@ async function generateCacheEntryImpl(\n       stream = prelude\n     }\n   } else {\n-    const filterStackFrame =\n-      process.env.NODE_ENV !== 'production'\n-        ? (require('../lib/source-maps') as typeof import('../lib/source-maps'))\n-            .filterStackFrameDEV\n-        : undefined\n-\n     stream = renderToReadableStream(\n       resultPromise,\n       clientReferenceManifest.clientModules,"
        },
        {
            "sha": "9aff98b8ce32fa09ef67bfd3126580223d87c7eb",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 12,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/72c963503ce8b6804807f1d42f5f726654ca35f8/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72c963503ce8b6804807f1d42f5f726654ca35f8/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=72c963503ce8b6804807f1d42f5f726654ca35f8",
            "patch": "@@ -141,12 +141,17 @@ declare module 'react-server-dom-webpack/server.edge' {\n     options?: {\n       temporaryReferences?: TemporaryReferenceSet\n       environmentName?: string | (() => string)\n-      filterStackFrame?: (\n-        url: string,\n-        functionName: string,\n-        lineNumber: number,\n-        columnNumber: number\n-      ) => boolean\n+      // This is actually optional.\n+      // But we want to not miss callsites accidentally and explicitly choose\n+      // at each callsite which implementation to choose.\n+      filterStackFrame:\n+        | ((\n+            url: string,\n+            functionName: string,\n+            lineNumber: number,\n+            columnNumber: number\n+          ) => boolean)\n+        | undefined\n       onError?: (error: unknown) => void\n       onPostpone?: (reason: string) => void\n       signal?: AbortSignal\n@@ -267,12 +272,17 @@ declare module 'react-server-dom-webpack/static' {\n     },\n     options?: {\n       environmentName?: string | (() => string)\n-      filterStackFrame?: (\n-        url: string,\n-        functionName: string,\n-        lineNumber: number,\n-        columnNumber: number\n-      ) => boolean\n+      // This is actually optional.\n+      // But we want to not miss callsites accidentally and explicitly choose\n+      // at each callsite which implementation to choose.\n+      filterStackFrame:\n+        | ((\n+            url: string,\n+            functionName: string,\n+            lineNumber: number,\n+            columnNumber: number\n+          ) => boolean)\n+        | undefined\n       identifierPrefix?: string\n       signal?: AbortSignal\n       temporaryReferences?: TemporaryReferenceSet"
        }
    ],
    "stats": {
        "total": 105,
        "additions": 44,
        "deletions": 61
    }
}