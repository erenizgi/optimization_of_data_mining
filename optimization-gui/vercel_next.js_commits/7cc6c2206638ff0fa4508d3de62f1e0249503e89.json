{
    "author": "sokra",
    "message": "Turbopack: add tracing to turbo-persistence (#78777)\n\n### What?\n\nAdd support for tracing and add a few trace spans",
    "sha": "7cc6c2206638ff0fa4508d3de62f1e0249503e89",
    "files": [
        {
            "sha": "a892bff7082ba60c2f37caf262178556cce1b157",
            "filename": "turbopack/crates/turbo-persistence/src/db.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs?ref=7cc6c2206638ff0fa4508d3de62f1e0249503e89",
            "patch": "@@ -18,6 +18,7 @@ use lzzzz::lz4::decompress;\n use memmap2::Mmap;\n use parking_lot::{Mutex, RwLock};\n use rayon::iter::{IndexedParallelIterator, IntoParallelIterator, ParallelIterator};\n+use tracing::Span;\n \n use crate::{\n     arc_slice::ArcSlice,\n@@ -548,6 +549,7 @@ impl TurboPersistence {\n         max_merge_sequence: usize,\n         max_merge_size: usize,\n     ) -> Result<()> {\n+        let _span = tracing::info_span!(\"compact database\").entered();\n         if self\n             .active_write_operation\n             .compare_exchange(false, true, Ordering::AcqRel, Ordering::Acquire)\n@@ -653,11 +655,13 @@ impl TurboPersistence {\n         let path = &self.path;\n \n         let log_mutex = Mutex::new(());\n+        let span = Span::current();\n         let result = sst_by_family\n             .into_par_iter()\n             .with_min_len(1)\n             .enumerate()\n             .map(|(family, ssts_with_ranges)| {\n+                let _span = span.clone().entered();\n                 let coverage = total_coverage(&ssts_with_ranges, (0, u64::MAX));\n                 if coverage <= max_coverage {\n                     return Ok((Vec::new(), Vec::new()));\n@@ -710,10 +714,12 @@ impl TurboPersistence {\n                     .collect::<Vec<_>>();\n \n                 // Merge SST files\n+                let span = tracing::trace_span!(\"merge files\");\n                 let merge_result = merge_jobs\n                     .into_par_iter()\n                     .with_min_len(1)\n                     .map(|indicies| {\n+                        let _span = span.clone().entered();\n                         fn create_sst_file(\n                             family: u32,\n                             entries: &[LookupEntry],\n@@ -722,6 +728,7 @@ impl TurboPersistence {\n                             path: &Path,\n                             seq: u32,\n                         ) -> Result<(u32, File)> {\n+                            let _span = tracing::trace_span!(\"write merged sst file\").entered();\n                             let builder = StaticSortedFileBuilder::new(\n                                 family,\n                                 entries,\n@@ -865,10 +872,12 @@ impl TurboPersistence {\n                     .collect::<Vec<_>>();\n \n                 // Move SST files\n+                let span = tracing::trace_span!(\"move files\");\n                 let mut new_sst_files = move_jobs\n                     .into_par_iter()\n                     .with_min_len(1)\n                     .map(|(index, seq)| {\n+                        let _span = span.clone().entered();\n                         let index = ssts_with_ranges[index].index;\n                         let sst = &static_sorted_files[index];\n                         let src_path = self.path.join(format!(\"{:08}.sst\", sst.sequence_number()));"
        },
        {
            "sha": "e23dbe5e8e31c615cf0c72d04dcb51e7d00eaf81",
            "filename": "turbopack/crates/turbo-persistence/src/static_sorted_file_builder.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fstatic_sorted_file_builder.rs?ref=7cc6c2206638ff0fa4508d3de62f1e0249503e89",
            "patch": "@@ -103,6 +103,7 @@ impl StaticSortedFileBuilder {\n     }\n \n     /// Computes a AQMF from the keys of all entries.\n+    #[tracing::instrument(level = \"trace\", skip_all)]\n     fn compute_aqmf<E: Entry>(&mut self, entries: &[E]) {\n         let mut filter = qfilter::Filter::new(entries.len() as u64, AQMF_FALSE_POSITIVE_RATE)\n             // This won't fail as we limit the number of entries per SST file\n@@ -117,6 +118,7 @@ impl StaticSortedFileBuilder {\n     }\n \n     /// Computes compression dictionaries from keys and values of all entries\n+    #[tracing::instrument(level = \"trace\", skip_all)]\n     fn compute_compression_dictionary<E: Entry>(\n         &mut self,\n         entries: &[E],\n@@ -202,6 +204,7 @@ impl StaticSortedFileBuilder {\n     }\n \n     /// Compute index, key and value blocks.\n+    #[tracing::instrument(level = \"trace\", skip_all)]\n     fn compute_blocks<E: Entry>(&mut self, entries: &[E]) {\n         // TODO implement multi level index\n         // TODO place key and value block near to each other\n@@ -352,16 +355,19 @@ impl StaticSortedFileBuilder {\n     }\n \n     /// Compresses an index or key block.\n+    #[tracing::instrument(level = \"trace\", skip_all)]\n     fn compress_key_block(&self, block: &[u8]) -> (u32, Vec<u8>) {\n         self.compress_block(block, &self.key_compression_dictionary)\n     }\n \n     /// Compresses a value block.\n+    #[tracing::instrument(level = \"trace\", skip_all)]\n     fn compress_value_block(&self, block: &[u8]) -> (u32, Vec<u8>) {\n         self.compress_block(block, &self.value_compression_dictionary)\n     }\n \n     /// Writes the SST file.\n+    #[tracing::instrument(level = \"trace\", skip_all)]\n     pub fn write(&self, file: &Path) -> io::Result<File> {\n         let mut file = BufWriter::new(File::create(file)?);\n         // magic number and version"
        },
        {
            "sha": "0a48ab74746012649235948e9baa41e9c0e0d85c",
            "filename": "turbopack/crates/turbo-persistence/src/write_batch.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fwrite_batch.rs?ref=7cc6c2206638ff0fa4508d3de62f1e0249503e89",
            "patch": "@@ -138,6 +138,7 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n         Ok(collector)\n     }\n \n+    #[tracing::instrument(level = \"trace\", skip(self, collector))]\n     fn flush_thread_local_collector(\n         &self,\n         family: u32,\n@@ -235,6 +236,7 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n     ///\n     /// Caller must ensure that no concurrent put or delete operation is happening on the flushed\n     /// family.\n+    #[tracing::instrument(level = \"trace\", skip(self))]\n     pub unsafe fn flush(&self, family: u32) -> Result<()> {\n         // Flush the thread local collectors to the global collector.\n         let mut collectors = Vec::new();\n@@ -290,12 +292,14 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n \n     /// Finishes the write batch by returning the new sequence number and the new SST files. This\n     /// writes all outstanding thread local data to disk.\n+    #[tracing::instrument(level = \"trace\", skip(self))]\n     pub(crate) fn finish(&mut self) -> Result<FinishResult> {\n         let mut new_blob_files = Vec::new();\n         let shared_error = Mutex::new(Ok(()));\n \n         // First, we flush all thread local collectors to the global collectors.\n         scope(|scope| {\n+            let _span = tracing::trace_span!(\"flush thread local collectors\").entered();\n             let mut collectors = [const { Vec::new() }; FAMILIES];\n             for cell in self.thread_locals.iter_mut() {\n                 let state = cell.get_mut();\n@@ -312,7 +316,9 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n                 for mut collector in thread_local_collectors {\n                     let this = &self;\n                     let shared_error = &shared_error;\n+                    let span = Span::current();\n                     scope.spawn(move |_| {\n+                        let _span = span.entered();\n                         if let Err(err) =\n                             this.flush_thread_local_collector(family as u32, &mut collector)\n                         {\n@@ -324,13 +330,16 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n             }\n         });\n \n+        let _span = tracing::trace_span!(\"flush collectors\").entered();\n+\n         // Now we reduce the global collectors in parallel\n         let mut new_sst_files = take(self.new_sst_files.get_mut());\n         let shared_new_sst_files = Mutex::new(&mut new_sst_files);\n \n         let new_collectors = [(); FAMILIES]\n             .map(|_| Mutex::new(GlobalCollectorState::Unsharded(self.get_new_collector())));\n         let collectors = replace(&mut self.collectors, new_collectors);\n+        let span = Span::current();\n         collectors\n             .into_par_iter()\n             .enumerate()\n@@ -348,6 +357,7 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n                 }\n             })\n             .try_for_each(|(family, mut collector)| {\n+                let _span = span.clone().entered();\n                 let family = family as u32;\n                 if !collector.is_empty() {\n                     let sst = self.create_sst_file(family, collector.sorted())?;\n@@ -370,6 +380,7 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n \n     /// Creates a new blob file with the given value.\n     /// Returns a tuple of (sequence number, file).\n+    #[tracing::instrument(level = \"trace\", skip(self, value), fields(value_len = value.len()))]\n     fn create_blob(&self, value: &[u8]) -> Result<(u32, File)> {\n         let seq = self.current_sequence_number.fetch_add(1, Ordering::SeqCst) + 1;\n         let mut buffer = Vec::new();\n@@ -387,6 +398,7 @@ impl<K: StoreKey + Send + Sync, const FAMILIES: usize> WriteBatch<K, FAMILIES> {\n \n     /// Creates a new SST file with the given collector data.\n     /// Returns a tuple of (sequence number, file).\n+    #[tracing::instrument(level = \"trace\", skip(self, collector_data))]\n     fn create_sst_file(\n         &self,\n         family: u32,"
        },
        {
            "sha": "592dff5b0a6ed4c33541914a0f9aac8f2471fcf7",
            "filename": "turbopack/crates/turbo-tasks-backend/src/kv_backing_storage.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs?ref=7cc6c2206638ff0fa4508d3de62f1e0249503e89",
            "patch": "@@ -184,9 +184,11 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorage\n                 {\n                     let _span = tracing::trace_span!(\"update task data\").entered();\n                     process_task_data(snapshots, Some(batch))?;\n+                    let span = tracing::trace_span!(\"flush task data\").entered();\n                     [KeySpace::TaskMeta, KeySpace::TaskData]\n                         .into_par_iter()\n                         .try_for_each(|key_space| {\n+                            let _span = span.clone().entered();\n                             // Safety: We already finished all processing of the task data and task\n                             // meta\n                             unsafe { batch.flush(key_space) }\n@@ -208,6 +210,7 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorage\n                         .into_par_iter()\n                         .with_max_len(1)\n                         .map(|updates| {\n+                            let _span = _span.clone().entered();\n                             let mut max_task_id = 0;\n \n                             let mut task_type_bytes = Vec::new();"
        },
        {
            "sha": "b3422fe86a1cf0874829955027cbcc33490c4c87",
            "filename": "turbopack/crates/turbopack-trace-utils/src/tracing_presets.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbopack-trace-utils%2Fsrc%2Ftracing_presets.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc6c2206638ff0fa4508d3de62f1e0249503e89/turbopack%2Fcrates%2Fturbopack-trace-utils%2Fsrc%2Ftracing_presets.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-trace-utils%2Fsrc%2Ftracing_presets.rs?ref=7cc6c2206638ff0fa4508d3de62f1e0249503e89",
            "patch": "@@ -71,6 +71,7 @@ pub static TRACING_TURBO_TASKS_TARGETS: Lazy<Vec<&str>> = Lazy::new(|| {\n             \"turbo_tasks_hash=trace\",\n             \"turbo_tasks_memory=trace\",\n             \"turbo_tasks_backend=trace\",\n+            \"turbo_persistence=trace\",\n         ],\n     ]\n     .concat()"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 31,
        "deletions": 0
    }
}