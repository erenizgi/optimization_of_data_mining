{
    "author": "eps1lon",
    "message": "[sourcemaps] Improve ignore-listing performance (#81311)\n\nThis improves performance of finding the relevant section in Index Source Maps by using binary search (O(N) -> O(log N)).\r\n\r\nThis allows us to improve the performance of the fast path for checking if a source is ignore-listed in Index Source Maps:\r\nInstead of checking if every section in Index Source Maps ignores everything, we just find the relevant section (now O(log N) instead of O(N)) and check if that section ignores everything.",
    "sha": "05ec5674c2d1d6cf3493287a37661f8468bbb1f9",
    "files": [
        {
            "sha": "2a324ec2cf2578cd61f963fe0416c691513f5c24",
            "filename": "packages/next/src/server/dev/middleware-webpack.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 20,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/05ec5674c2d1d6cf3493287a37661f8468bbb1f9/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/05ec5674c2d1d6cf3493287a37661f8468bbb1f9/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts?ref=05ec5674c2d1d6cf3493287a37661f8468bbb1f9",
            "patch": "@@ -5,7 +5,9 @@ import { SourceMapConsumer } from 'next/dist/compiled/source-map08'\n import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import { getSourceMapFromFile } from './get-source-map-from-file'\n import {\n+  findApplicableSourceMapPayload,\n   sourceMapIgnoreListsEverything,\n+  type BasicSourceMapPayload,\n   type ModernSourceMapPayload,\n } from '../lib/source-maps'\n import { openFileInEditor } from '../../next-devtools/server/launch-editor'\n@@ -50,13 +52,13 @@ type SourceAttributes = {\n type Source =\n   | {\n       type: 'file'\n-      sourceMap: ModernSourceMapPayload\n+      sourceMap: BasicSourceMapPayload\n       ignoredSources: IgnoredSources\n       moduleURL: string\n     }\n   | {\n       type: 'bundle'\n-      sourceMap: ModernSourceMapPayload\n+      sourceMap: BasicSourceMapPayload\n       ignoredSources: IgnoredSources\n       compilation: webpack.Compilation\n       moduleId: string\n@@ -284,11 +286,16 @@ async function getSourceMapFromCompilation(\n }\n \n async function getSource(\n-  sourceURL: string,\n+  frame: {\n+    file: string | null\n+    lineNumber: number | null\n+    column: number | null\n+  },\n   options: {\n     getCompilations: () => webpack.Compilation[]\n   }\n ): Promise<Source | undefined> {\n+  let sourceURL = frame.file ?? ''\n   const { getCompilations } = options\n \n   // Rspack is now using file:// URLs for source maps. Remove the rsc prefix to produce the file:/// url.\n@@ -308,7 +315,11 @@ async function getSource(\n     const sourceMapPayload = nativeSourceMap.payload\n     return {\n       type: 'file',\n-      sourceMap: sourceMapPayload,\n+      sourceMap: findApplicableSourceMapPayload(\n+        frame.lineNumber ?? 0,\n+        frame.column ?? 0,\n+        sourceMapPayload\n+      )!,\n \n       ignoredSources: getIgnoredSources(\n         // @ts-expect-error -- TODO: Support IndexSourceMap\n@@ -435,7 +446,7 @@ async function getOriginalStackFrame({\n   rootDirectory: string\n }): Promise<OriginalStackFrameResponse> {\n   const filename = frame.file ?? ''\n-  const source = await getSource(filename, {\n+  const source = await getSource(frame, {\n     getCompilations: () => {\n       const compilations: webpack.Compilation[] = []\n \n@@ -658,23 +669,31 @@ export function getSourceMapMiddleware(options: {\n     let source: Source | undefined\n \n     try {\n-      source = await getSource(filename, {\n-        getCompilations: () => {\n-          const compilations: webpack.Compilation[] = []\n-\n-          for (const stats of [\n-            clientStats(),\n-            serverStats(),\n-            edgeServerStats(),\n-          ]) {\n-            if (stats?.compilation) {\n-              compilations.push(stats.compilation)\n+      source = await getSource(\n+        {\n+          file: filename,\n+          // Webpack doesn't use Index Source Maps\n+          lineNumber: null,\n+          column: null,\n+        },\n+        {\n+          getCompilations: () => {\n+            const compilations: webpack.Compilation[] = []\n+\n+            for (const stats of [\n+              clientStats(),\n+              serverStats(),\n+              edgeServerStats(),\n+            ]) {\n+              if (stats?.compilation) {\n+                compilations.push(stats.compilation)\n+              }\n             }\n-          }\n \n-          return compilations\n-        },\n-      })\n+            return compilations\n+          },\n+        }\n+      )\n     } catch (error) {\n       return middlewareResponse.internalServerError(res, error)\n     }"
        },
        {
            "sha": "40cdfc0280d1c92093e4114254436f902fd9df66",
            "filename": "packages/next/src/server/lib/source-maps.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 23,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/05ec5674c2d1d6cf3493287a37661f8468bbb1f9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/05ec5674c2d1d6cf3493287a37661f8468bbb1f9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fsource-maps.ts?ref=05ec5674c2d1d6cf3493287a37661f8468bbb1f9",
            "patch": "@@ -18,7 +18,7 @@ interface IndexSourceMap {\n }\n \n /** https://tc39.es/ecma426/#sec-source-map-format */\n-interface BasicSourceMapPayload {\n+export interface BasicSourceMapPayload {\n   version: number\n   // TODO: Move to https://github.com/jridgewell/sourcemaps which is actively maintained\n   /** WARNING: `file` is optional. */\n@@ -34,17 +34,9 @@ interface BasicSourceMapPayload {\n \n export type ModernSourceMapPayload = BasicSourceMapPayload | IndexSourceMap\n \n-// TODO: This should take the BasicSourceMapPayload. Only the relevant section\n-// needs to ignore list everything making this check effectively O(1) multiplied\n-// by the complexity of finding the section.\n export function sourceMapIgnoreListsEverything(\n-  sourceMap: ModernSourceMapPayload\n+  sourceMap: BasicSourceMapPayload\n ): boolean {\n-  if ('sections' in sourceMap) {\n-    return sourceMap.sections.every((section) => {\n-      return sourceMapIgnoreListsEverything(section.map)\n-    })\n-  }\n   return (\n     sourceMap.ignoreList !== undefined &&\n     sourceMap.sources.length === sourceMap.ignoreList.length\n@@ -56,26 +48,40 @@ export function sourceMapIgnoreListsEverything(\n  * Equal to the input unless an Index Source Map is used.\n  */\n export function findApplicableSourceMapPayload(\n-  lineNumber: number,\n-  columnNumber: number,\n+  line: number,\n+  column: number,\n   payload: ModernSourceMapPayload\n ): BasicSourceMapPayload | undefined {\n   if ('sections' in payload) {\n+    if (payload.sections.length === 0) {\n+      return undefined\n+    }\n+\n     // Sections must not overlap and must be sorted: https://tc39.es/source-map/#section-object\n     // Therefore the last section that has an offset less than or equal to the frame is the applicable one.\n-    // TODO(veil): Binary search\n-    let section: IndexSourceMapSection | undefined = payload.sections[0]\n-    for (\n-      let i = 0;\n-      i < payload.sections.length &&\n-      payload.sections[i].offset.line <= lineNumber &&\n-      payload.sections[i].offset.column <= columnNumber;\n-      i++\n-    ) {\n-      section = payload.sections[i]\n+    const sections = payload.sections\n+    let left = 0\n+    let right = sections.length - 1\n+    let result: IndexSourceMapSection | null = null\n+\n+    while (left <= right) {\n+      // fast Math.floor\n+      const middle = ~~((left + right) / 2)\n+      const section = sections[middle]\n+      const offset = section.offset\n+\n+      if (\n+        offset.line < line ||\n+        (offset.line === line && offset.column <= column)\n+      ) {\n+        result = section\n+        left = middle + 1\n+      } else {\n+        right = middle - 1\n+      }\n     }\n \n-    return section === undefined ? undefined : section.map\n+    return result === null ? undefined : result.map\n   } else {\n     return payload\n   }"
        },
        {
            "sha": "a8e3f59e6725e5e1c1cef295eafbf212e64d159d",
            "filename": "packages/next/src/server/patch-error-inspect.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/05ec5674c2d1d6cf3493287a37661f8468bbb1f9/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/05ec5674c2d1d6cf3493287a37661f8468bbb1f9/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fpatch-error-inspect.ts?ref=05ec5674c2d1d6cf3493287a37661f8468bbb1f9",
            "patch": "@@ -208,7 +208,14 @@ function getSourcemappedFrameIfPossible(\n     line: frame.lineNumber ?? 1,\n   })\n \n-  let ignored = sourceMapIgnoreListsEverything(sourceMapPayload)\n+  const applicableSourceMap = findApplicableSourceMapPayload(\n+    frame.lineNumber ?? 0,\n+    frame.column ?? 0,\n+    sourceMapPayload\n+  )\n+  let ignored =\n+    applicableSourceMap !== undefined &&\n+    sourceMapIgnoreListsEverything(applicableSourceMap)\n   if (sourcePosition.source === null) {\n     return {\n       stack: {\n@@ -223,11 +230,6 @@ function getSourcemappedFrameIfPossible(\n     }\n   }\n \n-  const applicableSourceMap = findApplicableSourceMapPayload(\n-    frame.lineNumber ?? 0,\n-    frame.column ?? 0,\n-    sourceMapPayload\n-  )\n   // TODO(veil): Upstream a method to sourcemap consumer that immediately says if a frame is ignored or not.\n   if (applicableSourceMap === undefined) {\n     console.error('No applicable source map found in sections for frame', frame)"
        }
    ],
    "stats": {
        "total": 125,
        "additions": 76,
        "deletions": 49
    }
}