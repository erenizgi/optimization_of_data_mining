{
    "author": "ztanner",
    "message": "fix: prevent fetch abort errors propagating to user error boundaries (#86277)\n\nWhen navigating away from a page due to an MPA navigation or browser\nrefresh, we were aborting any pending RSC requests. However, in the case\nwhere the abort was due to an MPA navigation, the browser would restore\nthe execution context via the built-in bfcache, and the aborted fetch\nwould cause React to get in an errored state, leading to\n\"BodyStreamBuffer was aborted\".\n\nRather than aborting the pending requests, we instead mark that we would\nhave aborted due to the page unloading. That still solves the original\nreason the flag was added (suppressing the fetch errors that get logged)\n\nFixes NAR-519",
    "sha": "06d45e7de8f6333ece208b80b9d5310f1572145a",
    "files": [
        {
            "sha": "2fc85d808f7b5e3dfca0917e3c28ccd21983aaf1",
            "filename": "packages/next/src/client/components/router-reducer/fetch-server-response.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 12,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -102,21 +102,20 @@ function doMpaNavigation(url: string): FetchServerResponseResult {\n   return urlToUrlWithoutFlightMarker(new URL(url, location.origin)).toString()\n }\n \n-let abortController = new AbortController()\n+let isPageUnloading = false\n \n if (typeof window !== 'undefined') {\n-  // Abort any in-flight requests when the page is unloaded, e.g. due to\n-  // reloading the page or performing hard navigations. This allows us to ignore\n-  // what would otherwise be a thrown TypeError when the browser cancels the\n-  // requests.\n+  // Track when the page is unloading, e.g. due to reloading the page or\n+  // performing hard navigations. This allows us to suppress error logging when\n+  // the browser cancels in-flight requests during page unload.\n   window.addEventListener('pagehide', () => {\n-    abortController.abort()\n+    isPageUnloading = true\n   })\n \n-  // Use a fresh AbortController instance on pageshow, e.g. when navigating back\n-  // and the JavaScript execution context is restored by the browser.\n+  // Reset the flag on pageshow, e.g. when navigating back and the JavaScript\n+  // execution context is restored by the browser.\n   window.addEventListener('pageshow', () => {\n-    abortController = new AbortController()\n+    isPageUnloading = false\n   })\n }\n \n@@ -197,8 +196,7 @@ export async function fetchServerResponse(\n       url,\n       headers,\n       fetchPriority,\n-      shouldImmediatelyDecode,\n-      abortController.signal\n+      shouldImmediatelyDecode\n     )\n \n     const responseUrl = urlToUrlWithoutFlightMarker(new URL(res.url))\n@@ -287,7 +285,7 @@ export async function fetchServerResponse(\n       debugInfo: flightResponsePromise._debugInfo ?? null,\n     }\n   } catch (err) {\n-    if (!abortController.signal.aborted) {\n+    if (!isPageUnloading) {\n       console.error(\n         `Failed to fetch RSC payload for ${originalUrl}. Falling back to browser navigation.`,\n         err"
        },
        {
            "sha": "e324d469a48136e421aaf270106aa8f53622c0bd",
            "filename": "test/e2e/app-dir/fetch-abort-on-refresh/app/(root1)/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Flayout.tsx?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -0,0 +1,13 @@\n+import React from 'react'\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "a5ef2e0aa09a5c9b7e131b5ace2c3f56e47974d4",
            "filename": "test/e2e/app-dir/fetch-abort-on-refresh/app/(root1)/mpa.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fmpa.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fmpa.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fmpa.tsx?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -0,0 +1,19 @@\n+'use client'\n+\n+import { useRouter } from 'next/navigation'\n+\n+export function TriggerMpaNavigation() {\n+  const router = useRouter()\n+  return (\n+    <button\n+      id=\"trigger-navigation\"\n+      onClick={async () => {\n+        router.push('/slow-page')\n+        await new Promise((resolve) => setTimeout(resolve, 500))\n+        router.push('/other-root')\n+      }}\n+    >\n+      Trigger Navigation\n+    </button>\n+  )\n+}"
        },
        {
            "sha": "2ccf430a865a5335bae9b00b21fc1009a61aa461",
            "filename": "test/e2e/app-dir/fetch-abort-on-refresh/app/(root1)/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fpage.tsx?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -0,0 +1,10 @@\n+import { TriggerMpaNavigation } from './mpa'\n+\n+export default function StartPage() {\n+  return (\n+    <div style={{ padding: '20px' }}>\n+      <h1 id=\"start-page\">Start Page</h1>\n+      <TriggerMpaNavigation />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "6d3618316c5ea29bfa893e5ba84efb1659738e4c",
            "filename": "test/e2e/app-dir/fetch-abort-on-refresh/app/(root1)/slow-page/page.tsx",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fslow-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fslow-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root1)%2Fslow-page%2Fpage.tsx?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -0,0 +1,28 @@\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+async function SlowData() {\n+  // Artificial delay to simulate slow RSC fetch\n+  await connection()\n+  await new Promise((resolve) => setTimeout(resolve, 5_000))\n+  return (\n+    <div\n+      id=\"slow-data-loaded\"\n+      style={{ padding: '10px', background: '#e0e0ff' }}\n+    >\n+      Slow data loaded successfully!\n+    </div>\n+  )\n+}\n+\n+export default function SlowPage() {\n+  return (\n+    <div id=\"slow-page\">\n+      <Suspense\n+        fallback={<div id=\"loading-slow-data\">Loading slow data...</div>}\n+      >\n+        <SlowData />\n+      </Suspense>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "e324d469a48136e421aaf270106aa8f53622c0bd",
            "filename": "test/e2e/app-dir/fetch-abort-on-refresh/app/(root2)/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root2)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root2)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root2)%2Flayout.tsx?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -0,0 +1,13 @@\n+import React from 'react'\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "297482998a2fe0067fe9d0a40b785b7604f9a441",
            "filename": "test/e2e/app-dir/fetch-abort-on-refresh/app/(root2)/other-root/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root2)%2Fother-root%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root2)%2Fother-root%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2F(root2)%2Fother-root%2Fpage.tsx?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -0,0 +1,3 @@\n+export default function StartPage() {\n+  return <div id=\"root-2\">Root 2</div>\n+}"
        },
        {
            "sha": "9483fcd7bc56b7a19b920d72a581951262cb1bf6",
            "filename": "test/e2e/app-dir/fetch-abort-on-refresh/app/global-error.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2Fglobal-error.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2Fglobal-error.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Fapp%2Fglobal-error.tsx?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -0,0 +1,19 @@\n+'use client' // Error boundaries must be Client Components\n+\n+export default function GlobalError({\n+  error,\n+  reset,\n+}: {\n+  error: Error & { digest?: string }\n+  reset: () => void\n+}) {\n+  return (\n+    // global-error must include html and body tags\n+    <html>\n+      <body>\n+        <h2 id=\"global-error\">Something went wrong!</h2>\n+        <button onClick={() => reset()}>Try again</button>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "3a06fe37bdfc593bf189d444ff5cb1555844688d",
            "filename": "test/e2e/app-dir/fetch-abort-on-refresh/fetch-abort-on-refresh.test.ts",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Ffetch-abort-on-refresh.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/06d45e7de8f6333ece208b80b9d5310f1572145a/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Ffetch-abort-on-refresh.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ffetch-abort-on-refresh%2Ffetch-abort-on-refresh.test.ts?ref=06d45e7de8f6333ece208b80b9d5310f1572145a",
            "patch": "@@ -0,0 +1,33 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+const describeHeaded = process.env.HEADLESS ? describe.skip : describe\n+\n+describeHeaded('fetch-abort-on-refresh', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should not show abort error in global error boundary when restoring from bfcache', async () => {\n+    // This test ensures that when restoring a page from the browser bfcache that was pending RSC data,\n+    // that the abort does not propagate to a user's error boundary.\n+    const browser = await next.browser('/', { headless: false })\n+\n+    await browser.elementById('trigger-navigation').click()\n+\n+    await browser.waitForElementByCss('#root-2')\n+\n+    // Go back to trigger bfcache restoration\n+    // we overwrite the typical waitUntil: 'load' option here as the event is never being triggered if we hit the bfcache\n+    await browser.back({ waitUntil: 'commit' })\n+\n+    // Check that we're back on the slow page (the page that was first redirected to, before the MPA, not the error boundary)\n+    // We use element checks instead of eval() because eval() triggers waitForLoadState which times out with bfcache\n+    const hasSlowPage = await browser.hasElementByCss('#slow-page')\n+    const hasGlobalError = await browser.hasElementByCss(\n+      'h2:has-text(\"Something went wrong!\")'\n+    )\n+\n+    expect(hasSlowPage).toBe(true)\n+    expect(hasGlobalError).toBe(false)\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 160,
        "additions": 148,
        "deletions": 12
    }
}