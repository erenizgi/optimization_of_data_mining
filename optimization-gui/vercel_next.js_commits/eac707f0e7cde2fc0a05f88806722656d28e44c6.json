{
    "author": "lubieowoce",
    "message": "fix: compiler error when next/cache is used in a client module (#75979)\n\nMost functions in `next/cache` don't work on the client, and produce\r\nconfusing error messages when called there. It's better to just ban them\r\nat compile time.\r\n\r\nNOTE: For legacy/compat reasons, we're allowing `unstable_cache` and\r\n`unstable_noStore`, since they don't currently throw when called.",
    "sha": "eac707f0e7cde2fc0a05f88806722656d28e44c6",
    "files": [
        {
            "sha": "29007e0698ebf26fbdd645987fdf6540232b1731",
            "filename": "crates/next-custom-transforms/src/transforms/react_server_components.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -639,7 +639,22 @@ impl ReactServerComponentValidator {\n \n             invalid_client_imports: vec![Atom::from(\"server-only\"), Atom::from(\"next/headers\")],\n \n-            invalid_client_lib_apis_mapping: FxHashMap::from_iter([(\"next/server\", vec![\"after\"])]),\n+            invalid_client_lib_apis_mapping: FxHashMap::from_iter([\n+                (\"next/server\", vec![\"after\"]),\n+                (\n+                    \"next/cache\",\n+                    vec![\n+                        \"revalidatePath\",\n+                        \"revalidateTag\",\n+                        // \"unstable_cache\", // useless in client, but doesn't technically error\n+                        \"unstable_cacheLife\",\n+                        \"unstable_cacheTag\",\n+                        \"unstable_expirePath\",\n+                        \"unstable_expireTag\",\n+                        // \"unstable_noStore\" // no-op in client, but allowed for legacy reasons\n+                    ],\n+                ),\n+            ]),\n             imports: ImportMap::default(),\n         }\n     }"
        },
        {
            "sha": "c83baa735cdec4b516cc84e9c484b86f433fa4ff",
            "filename": "test/development/acceptance-app/fixtures/rsc-build-errors/app/server-with-errors/next-cache-in-client/revalidatepath/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Frevalidatepath%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Frevalidatepath%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Frevalidatepath%2Fpage.js?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+import { revalidatePath } from 'next/cache'\n+\n+console.log({ revalidatePath })\n+\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "b99e5380347bd59c7bc52d005e0a99b60d2e8124",
            "filename": "test/development/acceptance-app/fixtures/rsc-build-errors/app/server-with-errors/next-cache-in-client/revalidatetag/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Frevalidatetag%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Frevalidatetag%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Frevalidatetag%2Fpage.js?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+import { revalidateTag } from 'next/cache'\n+\n+console.log({ revalidateTag })\n+\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "84682694699f6b74c3b9a1a9e90634361cdafc91",
            "filename": "test/development/acceptance-app/fixtures/rsc-build-errors/app/server-with-errors/next-cache-in-client/unstable_cache/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cache%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cache%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cache%2Fpage.js?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+import { unstable_cache } from 'next/cache'\n+\n+console.log({ unstable_cache })\n+\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "6d6652a6111bba3e0cd23e854a9b5b6f55816f6b",
            "filename": "test/development/acceptance-app/fixtures/rsc-build-errors/app/server-with-errors/next-cache-in-client/unstable_cachelife/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cachelife%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cachelife%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cachelife%2Fpage.js?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+import { unstable_cacheLife } from 'next/cache'\n+\n+console.log({ unstable_cacheLife })\n+\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "a75f2e7b612869b8a1a7fafcc7dfdb8f4eaa385e",
            "filename": "test/development/acceptance-app/fixtures/rsc-build-errors/app/server-with-errors/next-cache-in-client/unstable_cachetag/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cachetag%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cachetag%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_cachetag%2Fpage.js?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+import { unstable_cacheTag } from 'next/cache'\n+\n+console.log({ unstable_cacheTag })\n+\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "5aa667268aa156e416b641299a3efa23f834a814",
            "filename": "test/development/acceptance-app/fixtures/rsc-build-errors/app/server-with-errors/next-cache-in-client/unstable_expirepath/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_expirepath%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_expirepath%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_expirepath%2Fpage.js?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+import { unstable_expirePath } from 'next/cache'\n+\n+console.log({ unstable_expirePath })\n+\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "dbe846ba5fc49a10f798b30c27ff892ebf22e094",
            "filename": "test/development/acceptance-app/fixtures/rsc-build-errors/app/server-with-errors/next-cache-in-client/unstable_expiretag/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_expiretag%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_expiretag%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_expiretag%2Fpage.js?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+import { unstable_expireTag } from 'next/cache'\n+\n+console.log({ unstable_expireTag })\n+\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "a933917bf5408087df74275c9a35a18eddfbe332",
            "filename": "test/development/acceptance-app/fixtures/rsc-build-errors/app/server-with-errors/next-cache-in-client/unstable_nostore/page.js",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_nostore%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_nostore%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Frsc-build-errors%2Fapp%2Fserver-with-errors%2Fnext-cache-in-client%2Funstable_nostore%2Fpage.js?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -0,0 +1,8 @@\n+'use client'\n+import { unstable_noStore } from 'next/cache'\n+\n+console.log({ unstable_noStore })\n+\n+export default function Page() {\n+  return null\n+}"
        },
        {
            "sha": "cff28ae85751971950404777b6f22d77e2860b95",
            "filename": "test/development/acceptance-app/rsc-build-errors.test.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Frsc-build-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance-app%2Frsc-build-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Frsc-build-errors.test.ts?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -273,6 +273,41 @@ describe('Error overlay - RSC build errors', () => {\n     )\n   })\n \n+  describe(\"importing 'next/cache' APIs in a client component\", () => {\n+    test.each([\n+      'revalidatePath',\n+      'revalidateTag',\n+      'unstable_cacheLife',\n+      'unstable_cacheTag',\n+      'unstable_expirePath',\n+      'unstable_expireTag',\n+    ])('%s is not allowed', async (api) => {\n+      await using sandbox = await createSandbox(\n+        next,\n+        undefined,\n+        `/server-with-errors/next-cache-in-client/${api.toLowerCase()}`\n+      )\n+      const { session } = sandbox\n+      await session.assertHasRedbox()\n+      expect(await session.getRedboxSource()).toInclude(\n+        `You're importing a component that needs \"${api}\". That only works in a Server Component but one of its parents is marked with \"use client\", so it's a Client Component.`\n+      )\n+    })\n+\n+    test.each([\n+      'unstable_cache', // useless in client, but doesn't technically error\n+      'unstable_noStore', // no-op in client, but allowed for legacy reasons\n+    ])('%s is allowed', async (api) => {\n+      await using sandbox = await createSandbox(\n+        next,\n+        undefined,\n+        `/server-with-errors/next-cache-in-client/${api.toLowerCase()}`\n+      )\n+      const { session } = sandbox\n+      await session.assertNoRedbox()\n+    })\n+  })\n+\n   it('should error for invalid undefined module retuning from next dynamic', async () => {\n     await using sandbox = await createSandbox(\n       next,"
        },
        {
            "sha": "df05fa36e9f0a4fb9b3265f4cdc6115e60b40734",
            "filename": "test/development/acceptance/server-component-compiler-errors-in-pages.test.ts",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance%2Fserver-component-compiler-errors-in-pages.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eac707f0e7cde2fc0a05f88806722656d28e44c6/test%2Fdevelopment%2Facceptance%2Fserver-component-compiler-errors-in-pages.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance%2Fserver-component-compiler-errors-in-pages.test.ts?ref=eac707f0e7cde2fc0a05f88806722656d28e44c6",
            "patch": "@@ -200,6 +200,57 @@ describe('Error Overlay for server components compiler errors in pages', () => {\n       `)\n     }\n   })\n+\n+  describe(\"importing 'next/cache' APIs in pages\", () => {\n+    test.each([\n+      'revalidatePath',\n+      'revalidateTag',\n+      'unstable_cacheLife',\n+      'unstable_cacheTag',\n+      'unstable_expirePath',\n+      'unstable_expireTag',\n+    ])('%s is not allowed', async (api) => {\n+      await using sandbox = await createSandbox(next, initialFiles)\n+      const { session } = sandbox\n+\n+      await next.patchFile(\n+        'components/Comp.js',\n+        outdent`\n+          import { ${api} } from 'next/cache'\n+\n+          export default function Page() {\n+            return 'hello world'\n+          }\n+        `\n+      )\n+\n+      await session.assertHasRedbox()\n+      await expect(session.getRedboxSource()).resolves.toMatch(\n+        `You're importing a component that needs \"${api}\". That only works in a Server Component which is not supported in the pages/ directory.`\n+      )\n+    })\n+\n+    test.each([\n+      'unstable_cache', // useless in client, but doesn't technically error\n+      'unstable_noStore', // no-op in client, but allowed for legacy reasons\n+    ])('%s is allowed', async (api) => {\n+      await using sandbox = await createSandbox(next, initialFiles)\n+      const { session } = sandbox\n+\n+      await next.patchFile(\n+        'components/Comp.js',\n+        outdent`\n+          import { ${api} } from 'next/cache'\n+  \n+          export default function Page() {\n+            return 'hello world'\n+          }\n+        `\n+      )\n+\n+      await session.assertNoRedbox()\n+    })\n+  })\n })\n \n const takeUpToString = (text: string, str: string): string =>"
        }
    ],
    "stats": {
        "total": 167,
        "additions": 166,
        "deletions": 1
    }
}