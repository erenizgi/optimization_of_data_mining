{
    "author": "luwes",
    "message": "Turbopack: Support passing binary data to Webpack loaders (#75056)\n\nCo-authored-by: Niklas Mischkulnig <4586894+mischnic@users.noreply.github.com>",
    "sha": "d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
    "files": [
        {
            "sha": "8be104c156ce0a8e2a8914084adf70a9a8a5443a",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -10037,6 +10037,7 @@ dependencies = [\n  \"anyhow\",\n  \"async-stream\",\n  \"async-trait\",\n+ \"base64 0.21.4\",\n  \"const_format\",\n  \"either\",\n  \"futures\","
        },
        {
            "sha": "4692bd3a5bea808e528397d1c5e49126b5debf63",
            "filename": "test/e2e/app-dir/turbopack-loader-resource-query/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/test%2Fe2e%2Fapp-dir%2Fturbopack-loader-resource-query%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/test%2Fe2e%2Fapp-dir%2Fturbopack-loader-resource-query%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fturbopack-loader-resource-query%2Fnext.config.js?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -1,13 +0,0 @@\n-/** @type {import('next').NextConfig} */\n-const nextConfig = {\n-  turbopack: {\n-    rules: {\n-      '*.mdx': {\n-        loaders: ['test-loader.js'],\n-        as: '*.js',\n-      },\n-    },\n-  },\n-}\n-\n-module.exports = nextConfig"
        },
        {
            "sha": "aa0bfe8307a0845b53e5a2fca81c45ff8a82114d",
            "filename": "test/e2e/app-dir/turbopack-loader-resource-query/turbopack-loader-resource-query.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 16,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/76747986daa7ede0f40ad97ce9c4a85d241a95ae/test%2Fe2e%2Fapp-dir%2Fturbopack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/76747986daa7ede0f40ad97ce9c4a85d241a95ae/test%2Fe2e%2Fapp-dir%2Fturbopack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fturbopack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts?ref=76747986daa7ede0f40ad97ce9c4a85d241a95ae",
            "patch": "@@ -1,16 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n-  'turbopack-loader-resource-query',\n-  () => {\n-    const { next } = nextTestSetup({\n-      files: __dirname,\n-    })\n-\n-    // Recommended for tests that check HTML. Cheerio is a HTML parser that has a jQuery like API.\n-    it('should pass query to loader', async () => {\n-      await next.render$('/')\n-\n-      expect(next.cliOutput).toContain('resource query:  ?test=hi')\n-    })\n-  }\n-)"
        },
        {
            "sha": "e7077399c03ce1479a655dc647c0545b64531628",
            "filename": "test/e2e/app-dir/webpack-loader-binary/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Flayout.tsx?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "167849537bcfa5e0b8274e0234578e28b9ec4785",
            "filename": "test/e2e/app-dir/webpack-loader-binary/app/page.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Fpage.js?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -0,0 +1,11 @@\n+import dataText from './test.txt'\n+import dataBinary from './test.mp4'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <p id=\"text\">{dataText}</p>\n+      <p id=\"binary\">{dataBinary}</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "d536c882412ed3df0dc162823ca5146bcc033499",
            "filename": "test/e2e/app-dir/webpack-loader-binary/app/test.mp4",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Ftest.mp4",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Ftest.mp4",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Ftest.mp4?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04"
        },
        {
            "sha": "4a4d2f77b63288adf2ba8caa51c2ecfd683722c6",
            "filename": "test/e2e/app-dir/webpack-loader-binary/app/test.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Ftest.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Ftest.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fapp%2Ftest.txt?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -0,0 +1 @@\n+this is some data"
        },
        {
            "sha": "319dfefbd328053164562dc19bd1783c82afa865",
            "filename": "test/e2e/app-dir/webpack-loader-binary/next.config.js",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fnext.config.js?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -0,0 +1,30 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  turbopack: {\n+    rules: {\n+      '*.txt': {\n+        loaders: [require.resolve('./test-file-loader.js')],\n+        as: '*.js',\n+      },\n+      '*.mp4': {\n+        loaders: [require.resolve('./test-file-loader.js')],\n+        as: '*.js',\n+      },\n+    },\n+  },\n+  webpack(config) {\n+    config.module.rules.push({\n+      test: /\\.txt/,\n+      use: require.resolve('./test-file-loader.js'),\n+    })\n+    config.module.rules.push({\n+      test: /\\.mp4/,\n+      use: require.resolve('./test-file-loader.js'),\n+    })\n+    return config\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "4d5f93954aec4f441faf7647d3745faf959100cd",
            "filename": "test/e2e/app-dir/webpack-loader-binary/test-file-loader.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Ftest-file-loader.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Ftest-file-loader.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Ftest-file-loader.js?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -0,0 +1,10 @@\n+module.exports = function (content) {\n+  let result\n+  if (content instanceof Buffer) {\n+    result = `Got a buffer of ${content.length} bytes`\n+  } else {\n+    result = `Didn't receive a buffer`\n+  }\n+  return Buffer.from(`module.exports = ${JSON.stringify(result)}`)\n+}\n+module.exports.raw = true"
        },
        {
            "sha": "92000d3d9d411df13f231bed53929fb9e3fdaafe",
            "filename": "test/e2e/app-dir/webpack-loader-binary/webpack-loader-binary.test.ts",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fwebpack-loader-binary.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fwebpack-loader-binary.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-binary%2Fwebpack-loader-binary.test.ts?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -0,0 +1,14 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('webpack-loader-ts-transform', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  it('should allow passing binary assets to and from a Webpack loader', async () => {\n+    const $ = await next.render$('/')\n+    expect($('#text').text()).toBe('Got a buffer of 18 bytes')\n+    expect($('#binary').text()).toBe('Got a buffer of 6765 bytes')\n+  })\n+})"
        },
        {
            "sha": "7c2515e8987b4cbba5702d091d6fd4612df6b12d",
            "filename": "test/e2e/app-dir/webpack-loader-conditions/webpack-loader-conditions.test.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 28,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fwebpack-loader-conditions.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fwebpack-loader-conditions.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-conditions%2Fwebpack-loader-conditions.test.ts?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -1,32 +1,30 @@\n import { nextTestSetup } from 'e2e-utils'\n \n-describe('webpack-loader-conditions', () => {\n-  const { next, isTurbopack, skipped } = nextTestSetup({\n-    files: __dirname,\n-    // This test is skipped because it's only expected to run in turbopack, which isn't enabled for builds\n-    skipDeployment: true,\n-  })\n+// Specifically tests turbopack.rules.*.foreign config\n+;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n+  'webpack-loader-conditions',\n+  () => {\n+    const { next } = nextTestSetup({\n+      files: __dirname,\n+      skipDeployment: true,\n+    })\n \n-  if (!isTurbopack || skipped) {\n-    it('should only run the test in turbopack', () => {})\n-    return\n-  }\n-\n-  it('should render correctly on server site', async () => {\n-    const res = await next.fetch('/')\n-    const html = (await res.text()).replaceAll(/<!-- -->/g, '')\n-    expect(html).toContain(`server: {&quot;default&quot;:true}`)\n-    expect(html).toContain(`client: {&quot;default&quot;:true}`)\n-    expect(html).toContain(`foreignClient: {}`)\n-  })\n+    it('should render correctly on server site', async () => {\n+      const res = await next.fetch('/')\n+      const html = (await res.text()).replaceAll(/<!-- -->/g, '')\n+      expect(html).toContain(`server: {&quot;default&quot;:true}`)\n+      expect(html).toContain(`client: {&quot;default&quot;:true}`)\n+      expect(html).toContain(`foreignClient: {}`)\n+    })\n \n-  it('should render correctly on client side', async () => {\n-    const browser = await next.browser('/')\n-    const text = await browser.elementByCss('body').text()\n-    expect(text).toContain(`server: ${JSON.stringify({ default: true })}`)\n-    expect(text).toContain(`client: ${JSON.stringify({ browser: true })}`)\n-    expect(text).toContain(\n-      `foreignClient: ${JSON.stringify({ browser: true, foreign: true })}`\n-    )\n-  })\n-})\n+    it('should render correctly on client side', async () => {\n+      const browser = await next.browser('/')\n+      const text = await browser.elementByCss('body').text()\n+      expect(text).toContain(`server: ${JSON.stringify({ default: true })}`)\n+      expect(text).toContain(`client: ${JSON.stringify({ browser: true })}`)\n+      expect(text).toContain(\n+        `foreignClient: ${JSON.stringify({ browser: true, foreign: true })}`\n+      )\n+    })\n+  }\n+)"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/webpack-loader-resource-query/app/layout.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Flayout.tsx?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "previous_filename": "test/e2e/app-dir/turbopack-loader-resource-query/app/layout.tsx"
        },
        {
            "sha": "d4ca1cbf7a05b27b134b8aaa611d2e6b85dc6c30",
            "filename": "test/e2e/app-dir/webpack-loader-resource-query/app/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Fpage.tsx?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "previous_filename": "test/e2e/app-dir/turbopack-loader-resource-query/app/page.tsx"
        },
        {
            "sha": "0437e4d393b40fffd76293dae58dee93534cbedf",
            "filename": "test/e2e/app-dir/webpack-loader-resource-query/app/test.mdx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Ftest.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Ftest.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fapp%2Ftest.mdx?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "previous_filename": "test/e2e/app-dir/turbopack-loader-resource-query/app/test.mdx"
        },
        {
            "sha": "2b1af2ed85a311e6160ff19b473331ceb39da54a",
            "filename": "test/e2e/app-dir/webpack-loader-resource-query/next.config.js",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fnext.config.js?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -0,0 +1,20 @@\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  turbopack: {\n+    rules: {\n+      '*.mdx': {\n+        loaders: [require.resolve('./test-file-loader.js')],\n+        as: '*.js',\n+      },\n+    },\n+  },\n+  webpack(config) {\n+    config.module.rules.push({\n+      test: /\\.mdx/,\n+      use: require.resolve('./test-file-loader.js'),\n+    })\n+    return config\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "d54779c267ee3f187c20035e5bf047de20b8c0bc",
            "filename": "test/e2e/app-dir/webpack-loader-resource-query/test-file-loader.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Ftest-file-loader.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Ftest-file-loader.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Ftest-file-loader.js?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "previous_filename": "test/e2e/app-dir/turbopack-loader-resource-query/node_modules/test-loader.js"
        },
        {
            "sha": "71e92c3ebb4f7612a35c693fec0c91a1c91b1580",
            "filename": "test/e2e/app-dir/webpack-loader-resource-query/turbopack-loader-resource-query.test.ts",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-resource-query%2Fturbopack-loader-resource-query.test.ts?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -0,0 +1,15 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('webpack-loader-resource-query', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+  })\n+\n+  // Recommended for tests that check HTML. Cheerio is a HTML parser that has a jQuery like API.\n+  it('should pass query to loader', async () => {\n+    await next.render$('/')\n+\n+    expect(next.cliOutput).toContain('resource query:  ?test=hi')\n+  })\n+})"
        },
        {
            "sha": "29161a8c7b94a300f887b752b4f820d8d0ec5ac9",
            "filename": "test/e2e/app-dir/webpack-loader-ts-transform/next.config.js",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-ts-transform%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-ts-transform%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fwebpack-loader-ts-transform%2Fnext.config.js?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -7,6 +7,13 @@ const nextConfig = {\n       '*.test-file.ts': [require.resolve('./test-file-loader.js')],\n     },\n   },\n+  webpack(config) {\n+    config.module.rules.push({\n+      test: /\\.test-file\\.ts/,\n+      use: require.resolve('./test-file-loader.js'),\n+    })\n+    return config\n+  },\n }\n \n module.exports = nextConfig"
        },
        {
            "sha": "5437164dabe928efdf3e56674b52cd8ca84e7fcc",
            "filename": "turbopack/crates/turbopack-node/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/turbopack%2Fcrates%2Fturbopack-node%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/turbopack%2Fcrates%2Fturbopack-node%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2FCargo.toml?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -20,6 +20,7 @@ workspace = true\n anyhow = { workspace = true }\n async-stream = \"0.3.4\"\n async-trait = { workspace = true }\n+base64 = \"0.21.0\"\n const_format = { workspace = true }\n either = { workspace = true, features = [\"serde\"] }\n futures = { workspace = true }"
        },
        {
            "sha": "aa541cd408a0e3a170fe7180ceb54b705f188883",
            "filename": "turbopack/crates/turbopack-node/js/src/transforms/webpack-loaders.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fjs%2Fsrc%2Ftransforms%2Fwebpack-loaders.ts?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -171,7 +171,7 @@ process.env = new Proxy(originalEnv, {\n \n const transform = (\n   ipc: Ipc<IpcInfoMessage, IpcRequestMessage>,\n-  content: string,\n+  content: string | { binary: string },\n   name: string,\n   query: string,\n   loaders: LoaderConfig[],\n@@ -455,8 +455,12 @@ const transform = (\n           options: loader.options,\n         })),\n         readResource: (_filename, callback) => {\n-          // TODO assuming the filename === resource, but loaders might change that\n-          callback(null, Buffer.from(content, \"utf-8\"));\n+          // TODO assuming that filename === resource, but loaders might change that\n+          let data =\n+            typeof content === \"string\"\n+              ? Buffer.from(content, \"utf-8\")\n+              : Buffer.from(content.binary, \"base64\")\n+          callback(null, data);\n         },\n       },\n       (err, result) => {"
        },
        {
            "sha": "4788e5e777197c51d4e754a30605c277fd206c29",
            "filename": "turbopack/crates/turbopack-node/src/transforms/webpack.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 4,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d4a191e9a97bc48422f6d0b2fe7b548973a04c04/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs?ref=d4a191e9a97bc48422f6d0b2fe7b548973a04c04",
            "patch": "@@ -2,10 +2,11 @@ use std::mem::take;\n \n use anyhow::{bail, Context, Result};\n use async_trait::async_trait;\n+use base64::Engine;\n use either::Either;\n use futures::try_join;\n use serde::{Deserialize, Serialize};\n-use serde_json::{json, Value as JsonValue};\n+use serde_json::{json, Map as JsonMap, Value as JsonValue};\n use serde_with::serde_as;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{\n@@ -213,15 +214,27 @@ impl WebpackLoadersProcessedAsset {\n         let AssetContent::File(file) = *source_content.await? else {\n             bail!(\"Webpack Loaders transform only support transforming files\");\n         };\n-        let FileContent::Content(content) = &*file.await? else {\n+        let FileContent::Content(file_content) = &*file.await? else {\n             return Ok(ProcessWebpackLoadersResult {\n                 content: AssetContent::File(FileContent::NotFound.resolved_cell()).resolved_cell(),\n                 assets: Vec::new(),\n                 source_map: ResolvedVc::cell(None),\n             }\n             .cell());\n         };\n-        let content = content.content().to_str()?;\n+\n+        // If the content is not a valid string (e.g. binary file), handle the error and pass a\n+        // Buffer to Webpack instead of a Base64 string so the build process doesn't crash.\n+        let content: JsonValue = match file_content.content().to_str() {\n+            Ok(utf8_str) => utf8_str.to_string().into(),\n+            Err(_) => JsonValue::Object(JsonMap::from_iter(std::iter::once((\n+                \"binary\".to_string(),\n+                JsonValue::from(\n+                    base64::engine::general_purpose::STANDARD\n+                        .encode(file_content.content().to_bytes().unwrap()),\n+                ),\n+            )))),\n+        };\n         let evaluate_context = transform.evaluate_context;\n \n         let webpack_loaders_executor = webpack_loaders_executor(*evaluate_context)\n@@ -251,7 +264,7 @@ impl WebpackLoadersProcessedAsset {\n             chunking_context,\n             resolve_options_context: Some(transform.resolve_options_context),\n             args: vec![\n-                ResolvedVc::cell(content.into()),\n+                ResolvedVc::cell(content),\n                 // We need to pass the query string to the loader\n                 ResolvedVc::cell(resource_path.to_string().into()),\n                 ResolvedVc::cell(this.source.ident().query().await?.to_string().into()),"
        }
    ],
    "stats": {
        "total": 231,
        "additions": 167,
        "deletions": 64
    }
}