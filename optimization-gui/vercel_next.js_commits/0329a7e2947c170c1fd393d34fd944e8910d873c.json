{
    "author": "Cy-Tek",
    "message": "fix(turbopack): Allow google font fetch errors to propagate when in production (#79999)\n\n## Fail Google Fonts in Production Builds When Fetch Fails\n\n### What?\nThis PR changes the behavior of Google Fonts in Next.js to properly fail\nproduction builds when font fetching fails, while still allowing\ndevelopment to continue with fallback fonts.\n\n### Why?\nPreviously, font fetch failures were only logged as warnings but didn't\nstop production builds. This could lead to production deployments with\nmissing fonts, creating a poor user experience. Development mode should\nbe more forgiving to allow work to continue offline.\n\n### How?\n- Added `is_dev_mode()` method to the `ChunkingContext` trait to\ndetermine the current environment\n- Modified the Google font fetching logic to:\n- In development: Show a warning and use fallback fonts when fetching\nfails\n- In production: Throw an error that fails the build when fetching fails\n- Passed the execution context to the font file replacer to access the\nchunking context\n\nThis ensures that production builds will fail fast when font resources\ncan't be fetched, while development builds can continue with appropriate\nfallbacks.\n\nFixes #PACK-4667\n\n### Future Hopes\n\nI would hope to eventually expose an enum for the build mode rather than\njust a boolean flag like I have here. I started going down that path for\nthis PR, but it was expanding the scope significantly of what would have\nto be done, so I have left it as a bool to fix this problem.",
    "sha": "0329a7e2947c170c1fd393d34fd944e8910d873c",
    "files": [
        {
            "sha": "b7e5768c37455ddb18ac6a75fbb056be73627259",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=0329a7e2947c170c1fd393d34fd944e8910d873c",
            "patch": "@@ -161,7 +161,7 @@ pub async fn get_client_resolve_options_context(\n     execution_context: Vc<ExecutionContext>,\n ) -> Result<Vc<ResolveOptionsContext>> {\n     let next_client_import_map =\n-        get_next_client_import_map(*project_path, ty, next_config, execution_context)\n+        get_next_client_import_map(*project_path, ty, next_config, mode, execution_context)\n             .to_resolved()\n             .await?;\n     let next_client_fallback_import_map = get_next_client_fallback_import_map(ty)"
        },
        {
            "sha": "c199c1f9cea408e6db0185770789f27253e6cb86",
            "filename": "crates/next-core/src/next_edge/context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_edge%2Fcontext.rs?ref=0329a7e2947c170c1fd393d34fd944e8910d873c",
            "patch": "@@ -110,7 +110,7 @@ pub async fn get_edge_resolve_options_context(\n     execution_context: Vc<ExecutionContext>,\n ) -> Result<Vc<ResolveOptionsContext>> {\n     let next_edge_import_map =\n-        get_next_edge_import_map(*project_path, ty, next_config, execution_context)\n+        get_next_edge_import_map(*project_path, ty, next_config, mode, execution_context)\n             .to_resolved()\n             .await?;\n "
        },
        {
            "sha": "08f471876f16ef797fa9eb3a851f3808302845e2",
            "filename": "crates/next-core/src/next_font/google/mod.rs",
            "status": "modified",
            "additions": 59,
            "deletions": 15,
            "changes": 74,
            "blob_url": "https://github.com/vercel/next.js/blob/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs?ref=0329a7e2947c170c1fd393d34fd944e8910d873c",
            "patch": "@@ -20,7 +20,7 @@ use turbopack_core::{\n     asset::AssetContent,\n     context::AssetContext,\n     ident::AssetIdent,\n-    issue::{IssueExt, IssueSeverity},\n+    issue::{IssueExt, IssueSeverity, StyledString},\n     reference_type::{InnerAssets, ReferenceType},\n     resolve::{\n         ResolveResult,\n@@ -48,7 +48,8 @@ use super::{\n     },\n };\n use crate::{\n-    embed_js::next_js_file_path, next_app::metadata::split_extension, util::load_next_js_templateon,\n+    embed_js::next_js_file_path, mode::NextMode, next_app::metadata::split_extension,\n+    next_font::issue::NextFontIssue, util::load_next_js_templateon,\n };\n \n pub mod font_fallback;\n@@ -179,6 +180,7 @@ impl ImportMappingReplacement for NextFontGoogleReplacer {\n pub struct NextFontGoogleCssModuleReplacer {\n     project_path: ResolvedVc<FileSystemPath>,\n     execution_context: ResolvedVc<ExecutionContext>,\n+    next_mode: ResolvedVc<NextMode>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -187,10 +189,12 @@ impl NextFontGoogleCssModuleReplacer {\n     pub fn new(\n         project_path: ResolvedVc<FileSystemPath>,\n         execution_context: ResolvedVc<ExecutionContext>,\n+        next_mode: ResolvedVc<NextMode>,\n     ) -> Vc<Self> {\n         Self::cell(NextFontGoogleCssModuleReplacer {\n             project_path,\n             execution_context,\n+            next_mode,\n         })\n     }\n \n@@ -215,6 +219,7 @@ impl NextFontGoogleCssModuleReplacer {\n         // requests to Google Fonts.\n         let env = Vc::upcast::<Box<dyn ProcessEnv>>(CommandLineProcessEnv::new());\n         let mocked_responses_path = &*env.read(\"NEXT_FONT_GOOGLE_MOCKED_RESPONSES\".into()).await?;\n+\n         let stylesheet_str = mocked_responses_path\n             .as_ref()\n             .map_or_else(\n@@ -224,7 +229,6 @@ impl NextFontGoogleCssModuleReplacer {\n             .await?;\n \n         let font_fallback = get_font_fallback(*self.project_path, options);\n-\n         let stylesheet = match stylesheet_str {\n             Some(s) => Some(\n                 update_google_stylesheet(\n@@ -237,10 +241,57 @@ impl NextFontGoogleCssModuleReplacer {\n                 .await?,\n             ),\n             None => {\n-                println!(\n-                    \"Failed to download `{}` from Google Fonts. Using fallback font instead.\",\n-                    options.await?.font_family\n-                );\n+                match *self.next_mode.await? {\n+                    // If we're in production mode, we want to fail the build to ensure proper font\n+                    // rendering.\n+                    NextMode::Build => {\n+                        NextFontIssue {\n+                            path: css_virtual_path.to_resolved().await?,\n+                            title: StyledString::Line(vec![\n+                                StyledString::Code(\"next/font:\".into()),\n+                                StyledString::Text(\" error:\".into()),\n+                            ])\n+                            .resolved_cell(),\n+                            description: StyledString::Text(\n+                                format!(\n+                                    \"Failed to fetch `{}` from Google Fonts.\",\n+                                    options.await?.font_family\n+                                )\n+                                .into(),\n+                            )\n+                            .resolved_cell(),\n+                            severity: IssueSeverity::Error.resolved_cell(),\n+                        }\n+                        .resolved_cell()\n+                        .emit();\n+                    }\n+                    // Inform the user of the failure to retreive the stylesheet / font, but don't\n+                    // propagate this error. We don't want e.g. offline connections to prevent page\n+                    // renders during development.\n+                    NextMode::Development => {\n+                        NextFontIssue {\n+                            path: css_virtual_path.to_resolved().await?,\n+                            title: StyledString::Line(vec![\n+                                StyledString::Code(\"next/font:\".into()),\n+                                StyledString::Text(\" warning:\".into()),\n+                            ])\n+                            .resolved_cell(),\n+                            description: StyledString::Text(\n+                                format!(\n+                                    \"Failed to download `{}` from Google Fonts. Using fallback \\\n+                                     font instead.\",\n+                                    options.await?.font_family\n+                                )\n+                                .into(),\n+                            )\n+                            .resolved_cell(),\n+                            severity: IssueSeverity::Warning.resolved_cell(),\n+                        }\n+                        .resolved_cell()\n+                        .emit();\n+                    }\n+                }\n+\n                 None\n             }\n         };\n@@ -610,16 +661,9 @@ async fn fetch_from_google_fonts(\n     )\n     .await?;\n \n-    Ok(match &*result {\n+    Ok(match *result {\n         Ok(r) => Some(*r.await?.body),\n         Err(err) => {\n-            // Inform the user of the failure to retreive the stylesheet / font, but don't\n-            // propagate this error. We don't want e.g. offline connections to prevent page\n-            // renders during development. During production builds, however, this error\n-            // should propagate.\n-            //\n-            // TODO(WEB-283): Use fallback in dev in this case\n-            // TODO(WEB-293): Fail production builds (not dev) in this case\n             err.to_issue(IssueSeverity::Warning.into(), virtual_path)\n                 .to_resolved()\n                 .await?"
        },
        {
            "sha": "4a142cbe653859acb0b10077f470ba5f7ab08248",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=0329a7e2947c170c1fd393d34fd944e8910d873c",
            "patch": "@@ -93,6 +93,7 @@ pub async fn get_next_client_import_map(\n     project_path: ResolvedVc<FileSystemPath>,\n     ty: Value<ClientContextType>,\n     next_config: Vc<NextConfig>,\n+    next_mode: Vc<NextMode>,\n     execution_context: Vc<ExecutionContext>,\n ) -> Result<Vc<ImportMap>> {\n     let mut import_map = ImportMap::empty();\n@@ -102,6 +103,7 @@ pub async fn get_next_client_import_map(\n         project_path,\n         execution_context,\n         next_config,\n+        next_mode,\n         false,\n     )\n     .await?;\n@@ -289,6 +291,7 @@ pub async fn get_next_server_import_map(\n     project_path: ResolvedVc<FileSystemPath>,\n     ty: Value<ServerContextType>,\n     next_config: Vc<NextConfig>,\n+    next_mode: Vc<NextMode>,\n     execution_context: Vc<ExecutionContext>,\n ) -> Result<Vc<ImportMap>> {\n     let mut import_map = ImportMap::empty();\n@@ -298,6 +301,7 @@ pub async fn get_next_server_import_map(\n         project_path,\n         execution_context,\n         next_config,\n+        next_mode,\n         false,\n     )\n     .await?;\n@@ -384,6 +388,7 @@ pub async fn get_next_edge_import_map(\n     project_path: ResolvedVc<FileSystemPath>,\n     ty: Value<ServerContextType>,\n     next_config: Vc<NextConfig>,\n+    next_mode: Vc<NextMode>,\n     execution_context: Vc<ExecutionContext>,\n ) -> Result<Vc<ImportMap>> {\n     let mut import_map = ImportMap::empty();\n@@ -435,6 +440,7 @@ pub async fn get_next_edge_import_map(\n         project_path,\n         execution_context,\n         next_config,\n+        next_mode,\n         true,\n     )\n     .await?;\n@@ -845,6 +851,7 @@ async fn insert_next_shared_aliases(\n     project_path: ResolvedVc<FileSystemPath>,\n     execution_context: Vc<ExecutionContext>,\n     next_config: Vc<NextConfig>,\n+    next_mode: Vc<NextMode>,\n     is_runtime_edge: bool,\n ) -> Result<()> {\n     let package_root = next_js_fs().root().to_resolved().await?;\n@@ -892,7 +899,7 @@ async fn insert_next_shared_aliases(\n     import_map.insert_alias(\n         AliasPattern::exact(\"@vercel/turbopack-next/internal/font/google/cssmodule.module.css\"),\n         ImportMapping::Dynamic(ResolvedVc::upcast(\n-            NextFontGoogleCssModuleReplacer::new(*project_path, execution_context)\n+            NextFontGoogleCssModuleReplacer::new(*project_path, execution_context, next_mode)\n                 .to_resolved()\n                 .await?,\n         ))"
        },
        {
            "sha": "a31f5feb84cc44fc177b851d16711ab9e1eb3bac",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0329a7e2947c170c1fd393d34fd944e8910d873c/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=0329a7e2947c170c1fd393d34fd944e8910d873c",
            "patch": "@@ -134,7 +134,7 @@ pub async fn get_server_resolve_options_context(\n     execution_context: Vc<ExecutionContext>,\n ) -> Result<Vc<ResolveOptionsContext>> {\n     let next_server_import_map =\n-        get_next_server_import_map(*project_path, ty, next_config, execution_context)\n+        get_next_server_import_map(*project_path, ty, next_config, mode, execution_context)\n             .to_resolved()\n             .await?;\n     let foreign_code_context_condition ="
        },
        {
            "sha": "433309587c53fe8415ba5cead91f2417ee428c6b",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/0329a7e2947c170c1fd393d34fd944e8910d873c/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/0329a7e2947c170c1fd393d34fd944e8910d873c/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=0329a7e2947c170c1fd393d34fd944e8910d873c",
            "patch": "@@ -7745,8 +7745,8 @@\n     \"runtimeError\": false\n   },\n   \"test/e2e/next-font/google-fetch-error.test.ts\": {\n-    \"passed\": [],\n-    \"failed\": [\"next/font/google fetch error should error when not in dev\"],\n+    \"passed\": [\"next/font/google fetch error should error when not in dev\"],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 72,
        "deletions": 21
    }
}