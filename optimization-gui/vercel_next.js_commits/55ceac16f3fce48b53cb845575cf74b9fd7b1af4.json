{
    "author": "bgw",
    "message": "refactor(turbo-tasks-backend): Use ringmap crate instead of custom DequeSet type for aggregation updates (#80867)\n\n`ringmap` is a pretty new library from the same folks behind `indexmap` (and it's actually a fork of `indexmap`) that uses a `VecDeque` instead of a `Vec`.\n\nhttps://github.com/indexmap-rs/ringmap/\n\nThis adds an extra dependency, but it's a drop-in replacement, and our current `DequeSet` type is pretty far from ideal.\n\n## Benchmarks\n\nI thought this might improve perf, but this looks neutral on codspeed. So it's just a matter of if we think this improves the code or not.",
    "sha": "55ceac16f3fce48b53cb845575cf74b9fd7b1af4",
    "files": [
        {
            "sha": "d18accaee59b5491d19bbe5c169fd4c3d8599c1c",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 13,
            "deletions": 1,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=55ceac16f3fce48b53cb845575cf74b9fd7b1af4",
            "patch": "@@ -2763,7 +2763,7 @@ dependencies = [\n  \"httpdate\",\n  \"itoa\",\n  \"pin-project-lite\",\n- \"socket2 0.4.9\",\n+ \"socket2 0.5.10\",\n  \"tokio\",\n  \"tower-service\",\n  \"tracing\",\n@@ -5940,6 +5940,17 @@ dependencies = [\n  \"windows-sys 0.52.0\",\n ]\n \n+[[package]]\n+name = \"ringmap\"\n+version = \"0.1.3\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"963156bc0da83715cf1aa699f60533a20fcd771c4bbb06548d628eccf1c1ac3e\"\n+dependencies = [\n+ \"equivalent\",\n+ \"hashbrown 0.15.2\",\n+ \"serde\",\n+]\n+\n [[package]]\n name = \"rkyv\"\n version = \"0.7.45\"\n@@ -9217,6 +9228,7 @@ dependencies = [\n  \"rand 0.9.0\",\n  \"rayon\",\n  \"regex\",\n+ \"ringmap\",\n  \"rstest\",\n  \"rustc-hash 2.1.1\",\n  \"serde\","
        },
        {
            "sha": "a78d083060a1bdc0cd893ec7f514ce6c32976934",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=55ceac16f3fce48b53cb845575cf74b9fd7b1af4",
            "patch": "@@ -396,6 +396,7 @@ rayon = \"1.10.0\"\n regex = \"1.10.6\"\n regress = \"0.10.3\"\n reqwest = { version = \"0.12.20\", default-features = false }\n+ringmap = \"0.1.3\"\n rstest = \"0.16.0\"\n rustc-hash = \"2.1.1\"\n semver = \"1.0.16\""
        },
        {
            "sha": "8c878414b23e3e075dbc4c9ccec8a03e5d7c592a",
            "filename": "turbopack/crates/turbo-tasks-backend/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/turbopack%2Fcrates%2Fturbo-tasks-backend%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/turbopack%2Fcrates%2Fturbo-tasks-backend%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2FCargo.toml?ref=55ceac16f3fce48b53cb845575cf74b9fd7b1af4",
            "patch": "@@ -39,6 +39,7 @@ parking_lot = { workspace = true }\n pot = \"3.0.0\"\n rand = { workspace = true }\n rayon = { workspace = true }\n+ringmap = { workspace = true, features = [\"serde\"] }\n rustc-hash = { workspace = true }\n serde = { workspace = true }\n serde_json = { workspace = true }"
        },
        {
            "sha": "ba0893b06af6bf9806eb9b02c5c524b19c55bbc0",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/aggregation_update.rs",
            "status": "modified",
            "additions": 14,
            "deletions": 11,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Faggregation_update.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Faggregation_update.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Faggregation_update.rs?ref=55ceac16f3fce48b53cb845575cf74b9fd7b1af4",
            "patch": "@@ -11,7 +11,8 @@ use std::{\n \n use anyhow::Result;\n use indexmap::map::Entry;\n-use rustc_hash::{FxHashMap, FxHashSet};\n+use ringmap::RingSet;\n+use rustc_hash::{FxBuildHasher, FxHashMap, FxHashSet};\n use serde::{Deserialize, Serialize, Serializer, ser::SerializeSeq};\n use smallvec::{SmallVec, smallvec};\n #[cfg(any(\n@@ -33,9 +34,11 @@ use crate::{\n         ActivenessState, AggregationNumber, CachedDataItem, CachedDataItemKey, CollectibleRef,\n         DirtyContainerCount,\n     },\n-    utils::{deque_set::DequeSet, swap_retain},\n+    utils::swap_retain,\n };\n \n+type FxRingSet<T> = RingSet<T, FxBuildHasher>;\n+\n pub const LEAF_NUMBER: u32 = 16;\n const MAX_COUNT_BEFORE_YIELD: usize = 1000;\n const MAX_UPPERS_FOLLOWER_PRODUCT: usize = 31;\n@@ -609,10 +612,10 @@ pub struct AggregationUpdateQueue {\n     jobs: VecDeque<AggregationUpdateJobItem>,\n     number_updates: FxIndexMap<TaskId, AggregationNumberUpdate>,\n     done_number_updates: FxHashMap<TaskId, AggregationNumberUpdate>,\n-    find_and_schedule: DequeSet<FindAndScheduleJob>,\n+    find_and_schedule: FxRingSet<FindAndScheduleJob>,\n     done_find_and_schedule: FxHashSet<TaskId>,\n-    balance_queue: DequeSet<BalanceJob>,\n-    optimize_queue: DequeSet<OptimizeJob>,\n+    balance_queue: FxRingSet<BalanceJob>,\n+    optimize_queue: FxRingSet<OptimizeJob>,\n }\n \n impl AggregationUpdateQueue {\n@@ -622,10 +625,10 @@ impl AggregationUpdateQueue {\n             jobs: VecDeque::with_capacity(0),\n             number_updates: FxIndexMap::default(),\n             done_number_updates: FxHashMap::default(),\n-            find_and_schedule: DequeSet::default(),\n+            find_and_schedule: FxRingSet::default(),\n             done_find_and_schedule: FxHashSet::default(),\n-            balance_queue: DequeSet::default(),\n-            optimize_queue: DequeSet::default(),\n+            balance_queue: FxRingSet::default(),\n+            optimize_queue: FxRingSet::default(),\n         }\n     }\n \n@@ -698,7 +701,7 @@ impl AggregationUpdateQueue {\n             }\n             AggregationUpdateJob::BalanceEdge { upper_id, task_id } => {\n                 self.balance_queue\n-                    .insert_back(BalanceJob::new(upper_id, task_id));\n+                    .push_back(BalanceJob::new(upper_id, task_id));\n             }\n             _ => {\n                 self.jobs.push_back(AggregationUpdateJobItem::new(job));\n@@ -717,7 +720,7 @@ impl AggregationUpdateQueue {\n     pub fn push_find_and_schedule_dirty(&mut self, task_id: TaskId) {\n         if !self.done_find_and_schedule.contains(&task_id) {\n             self.find_and_schedule\n-                .insert_back(FindAndScheduleJob::new(task_id));\n+                .push_back(FindAndScheduleJob::new(task_id));\n         }\n     }\n \n@@ -733,7 +736,7 @@ impl AggregationUpdateQueue {\n \n     /// Pushes a job to optimize a task.\n     fn push_optimize_task(&mut self, task_id: TaskId) {\n-        self.optimize_queue.insert_back(OptimizeJob::new(task_id));\n+        self.optimize_queue.push_back(OptimizeJob::new(task_id));\n     }\n \n     /// Runs the job and all dependent jobs until it's done. It can persist the operation, so"
        },
        {
            "sha": "5ee5a3095f4ee09871385bb875a72bfa53a439da",
            "filename": "turbopack/crates/turbo-tasks-backend/src/utils/deque_set.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 77,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/8b8057d307f39974936fdd899e22e337e2567776/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdeque_set.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8b8057d307f39974936fdd899e22e337e2567776/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdeque_set.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fdeque_set.rs?ref=8b8057d307f39974936fdd899e22e337e2567776",
            "patch": "@@ -1,77 +0,0 @@\n-use std::{\n-    collections::{HashSet, VecDeque},\n-    fmt::Debug,\n-    hash::{BuildHasher, BuildHasherDefault, Hash},\n-};\n-\n-use rustc_hash::FxHasher;\n-use serde::{Deserialize, Serialize};\n-\n-// TODO This could be more efficent:\n-// - Not storing items twice\n-// - Not serializing items twice\n-\n-#[derive(Clone, Serialize, Deserialize)]\n-#[serde(bound(\n-    deserialize = \"T: Hash + Eq + Deserialize<'de>, B: BuildHasher + Default\",\n-    serialize = \"T: Hash + Eq + Serialize, B: BuildHasher + Default\"\n-))]\n-pub struct DequeSet<T, B: BuildHasher = BuildHasherDefault<FxHasher>> {\n-    set: HashSet<T, B>,\n-    queue: VecDeque<T>,\n-}\n-\n-impl<T: Debug, B: BuildHasher> Debug for DequeSet<T, B> {\n-    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {\n-        self.queue.fmt(f)\n-    }\n-}\n-\n-impl<T, B: BuildHasher + Default> Default for DequeSet<T, B> {\n-    fn default() -> Self {\n-        Self {\n-            set: Default::default(),\n-            queue: VecDeque::with_capacity(0),\n-        }\n-    }\n-}\n-\n-impl<T, B: BuildHasher> DequeSet<T, B> {\n-    pub fn is_empty(&self) -> bool {\n-        self.queue.is_empty()\n-    }\n-\n-    #[allow(dead_code)]\n-    pub fn len(&self) -> usize {\n-        self.queue.len()\n-    }\n-}\n-\n-impl<T: Hash + Eq + Clone, B: BuildHasher> DequeSet<T, B> {\n-    pub fn insert_back(&mut self, item: T) -> bool {\n-        if self.set.insert(item.clone()) {\n-            self.queue.push_back(item);\n-            true\n-        } else {\n-            false\n-        }\n-    }\n-\n-    pub fn pop_front(&mut self) -> Option<T> {\n-        if let Some(item) = self.queue.pop_front() {\n-            self.set.remove(&item);\n-            Some(item)\n-        } else {\n-            None\n-        }\n-    }\n-}\n-\n-impl<T: Hash + Eq + Clone, B: BuildHasher> Extend<T> for DequeSet<T, B> {\n-    fn extend<I: IntoIterator<Item = T>>(&mut self, iter: I) {\n-        self.queue.extend(\n-            iter.into_iter()\n-                .filter(|item| self.set.insert(item.clone())),\n-        );\n-    }\n-}"
        },
        {
            "sha": "1cb30f53a1ff6593972f41118e3ae29e262951b6",
            "filename": "turbopack/crates/turbo-tasks-backend/src/utils/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/55ceac16f3fce48b53cb845575cf74b9fd7b1af4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs?ref=55ceac16f3fce48b53cb845575cf74b9fd7b1af4",
            "patch": "@@ -1,7 +1,6 @@\n pub mod bi_map;\n pub mod chunked_vec;\n pub mod dash_map_multi;\n-pub mod deque_set;\n pub mod ptr_eq_arc;\n pub mod sharded;\n pub mod swap_retain;"
        }
    ],
    "stats": {
        "total": 119,
        "additions": 29,
        "deletions": 90
    }
}