{
    "author": "bgw",
    "message": "Turbopack: Add an option to use system TLS certificates (fixes #79060, fixes #79059) (#81818)\n\nIt's common in enterprise environments for employers to MITM all HTTPS traffic on employee machines to enforce network policies or to detect and block malware. For this to work, they install custom CA roots into the system store. Applications must read from this store.\n\nThe default behavior of `reqwests` is to bundle the mozilla CA roots into the application, and only trust those. This is reasonable given some of the tradeoffs of the current rustls resolver implementations they use, but long-term it's better for most applications to just use the system CA store.\n\nThis provides an opt-in experimental option for using the system CA store. We may use system CA certs by default in the future once https://github.com/seanmonstar/reqwest/issues/2159 is resolved.\n\nFixes #79059\nFixes #79060\n\n### Testing\n\n- Install [mitmproxy](https://docs.mitmproxy.org/stable/overview/installation/).\n- Install the generated mitmproxy CA cert to the system store: https://docs.mitmproxy.org/stable/concepts/certificates/\n- Run `./mitmdump` (with no arguments)\n- Run an example app that uses google fonts:\n\n```\npnpm pack-next --project ~/shadcn-ui/apps/v4 --no-js-build -- --release\ncd ~/shadcn-ui/apps/v4\npnpm i\nNEXT_TURBOPACK_EXPERIMENTAL_USE_SYSTEM_TLS_CERTS=0 HTTP_PROXY=localhost:8080 HTTPS_PROXY=localhost:8080 pnpm dev\nNEXT_TURBOPACK_EXPERIMENTAL_USE_SYSTEM_TLS_CERTS=1 HTTP_PROXY=localhost:8080 HTTPS_PROXY=localhost:8080 pnpm dev\n```\n\nWhen system TLS certs are disabled, we get warnings like this:\n\n```\n ⚠ [next]/internal/font/google/geist_mono_77f2790.module.css\nError while requesting resource\nThere was an issue establishing a connection while requesting https://fonts.googleapis.com/css2?family=Geist+Mono:wght@400&display=swap.\n\nImport trace:\n  [next]/internal/font/google/geist_mono_77f2790.module.css\n  [next]/internal/font/google/geist_mono_77f2790.js\n  ./apps/v4/lib/fonts.ts\n  ./apps/v4/app/layout.tsx\n```\n\nAnd mitmproxy shows the handshakes failing\n\n![Screenshot 2025-07-21 at 1.11.11 PM.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/HAZVitxRNnZz8QMiPn4a/2efc4b97-f50e-412c-9daf-5cdd00a6d82b.png)\n\nWhen system TLS certs are enabled, the app works.",
    "sha": "56fed4d6b489b9b60cd3b7647b21597f09768be9",
    "files": [
        {
            "sha": "41d24de307ca3b0a3848c7d060c477f0e91b2e56",
            "filename": ".changeset/silent-houses-lay.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/.changeset%2Fsilent-houses-lay.md",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/.changeset%2Fsilent-houses-lay.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Fsilent-houses-lay.md?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+'@next/swc': patch\n+---\n+\n+Added an experimental option for using the system CA store for fetching Google Fonts in Turbopack"
        },
        {
            "sha": "28d5eaf6bf1a6ee3d13196e5693053c4e3b21df2",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 27,
            "deletions": 3,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -2869,6 +2869,7 @@ dependencies = [\n  \"hyper 1.6.0\",\n  \"hyper-util\",\n  \"rustls\",\n+ \"rustls-native-certs\",\n  \"rustls-pki-types\",\n  \"tokio\",\n  \"tokio-rustls\",\n@@ -5945,9 +5946,9 @@ dependencies = [\n \n [[package]]\n name = \"reqwest\"\n-version = \"0.12.20\"\n+version = \"0.12.22\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"eabf4c97d9130e2bf606614eb937e86edac8292eaa6f422f995d7e8de1eb1813\"\n+checksum = \"cbc931937e6ca3a06e3b6c0aa7841849b160a90351d6ab467a8b9b9959767531\"\n dependencies = [\n  \"base64 0.22.1\",\n  \"bytes\",\n@@ -5966,6 +5967,7 @@ dependencies = [\n  \"pin-project-lite\",\n  \"quinn\",\n  \"rustls\",\n+ \"rustls-native-certs\",\n  \"rustls-pki-types\",\n  \"serde\",\n  \"serde_json\",\n@@ -6194,6 +6196,28 @@ dependencies = [\n  \"zeroize\",\n ]\n \n+[[package]]\n+name = \"rustls-native-certs\"\n+version = \"0.8.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"fcaf18a4f2be7326cd874a5fa579fae794320a0f388d365dca7e480e55f83f8a\"\n+dependencies = [\n+ \"openssl-probe\",\n+ \"rustls-pemfile\",\n+ \"rustls-pki-types\",\n+ \"schannel\",\n+ \"security-framework\",\n+]\n+\n+[[package]]\n+name = \"rustls-pemfile\"\n+version = \"2.2.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"dce314e5fee3f39953d46bb63bb8a46d40c2f8fb7cc5a3b6cab2bde9721d6e50\"\n+dependencies = [\n+ \"rustls-pki-types\",\n+]\n+\n [[package]]\n name = \"rustls-pki-types\"\n version = \"1.10.1\"\n@@ -9313,7 +9337,7 @@ dependencies = [\n  \"anyhow\",\n  \"mockito\",\n  \"quick_cache\",\n- \"reqwest 0.12.20\",\n+ \"reqwest 0.12.22\",\n  \"serde\",\n  \"tokio\",\n  \"turbo-rcstr\","
        },
        {
            "sha": "f0ba997758b0354b1ed1400b93e90029f64973fe",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -400,7 +400,7 @@ rand = \"0.9.0\"\n rayon = \"1.10.0\"\n regex = \"1.10.6\"\n regress = \"0.10.3\"\n-reqwest = { version = \"0.12.20\", default-features = false }\n+reqwest = { version = \"0.12.22\", default-features = false }\n ringmap = \"0.1.3\"\n roaring = \"0.10.10\"\n rstest = \"0.16.0\""
        },
        {
            "sha": "3f8d1f853c7fa8a3a00a7a4bb43e882e2f245d71",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 30,
            "deletions": 2,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -3,12 +3,13 @@ use rustc_hash::FxHashSet;\n use serde::{Deserialize, Deserializer, Serialize};\n use serde_json::Value as JsonValue;\n use turbo_esregex::EsRegex;\n-use turbo_rcstr::RcStr;\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{\n     FxIndexMap, NonLocalValue, OperationValue, ResolvedVc, TaskInput, Vc, debug::ValueDebugFormat,\n     trace::TraceRawVcs,\n };\n-use turbo_tasks_env::EnvMap;\n+use turbo_tasks_env::{EnvMap, ProcessEnv};\n+use turbo_tasks_fetch::ReqwestClientConfig;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack::module_options::{\n     ConditionItem, ConditionPath, LoaderRuleItem, OptionWebpackRules,\n@@ -801,6 +802,7 @@ pub struct ExperimentalConfig {\n     turbopack_source_maps: Option<bool>,\n     turbopack_tree_shaking: Option<bool>,\n     turbopack_scope_hoisting: Option<bool>,\n+    turbopack_use_system_tls_certs: Option<bool>,\n     // Whether to enable the global-not-found convention\n     global_not_found: Option<bool>,\n     /// Defaults to false in development mode, true in production mode.\n@@ -1721,6 +1723,32 @@ impl NextConfig {\n     pub fn output_file_tracing_excludes(&self) -> Vc<OptionJsonValue> {\n         Vc::cell(self.output_file_tracing_excludes.clone())\n     }\n+\n+    #[turbo_tasks::function]\n+    pub async fn reqwest_client_config(\n+        &self,\n+        env: Vc<Box<dyn ProcessEnv>>,\n+    ) -> Result<Vc<ReqwestClientConfig>> {\n+        // Support both an env var and the experimental flag to provide more flexibility to\n+        // developers on locked down systems, depending on if they want to configure this on a\n+        // per-system or per-project basis.\n+        let use_system_tls_certs = env\n+            .read(rcstr!(\"NEXT_TURBOPACK_EXPERIMENTAL_USE_SYSTEM_TLS_CERTS\"))\n+            .await?\n+            .as_ref()\n+            .and_then(|env_value| {\n+                // treat empty value same as an unset value\n+                (!env_value.is_empty()).then(|| env_value == \"1\" || env_value == \"true\")\n+            })\n+            .or(self.experimental.turbopack_use_system_tls_certs)\n+            .unwrap_or(false);\n+        Ok(ReqwestClientConfig {\n+            proxy: None,\n+            tls_built_in_webpki_certs: !use_system_tls_certs,\n+            tls_built_in_native_certs: use_system_tls_certs,\n+        }\n+        .cell())\n+    }\n }\n \n /// A subset of ts/jsconfig that next.js implicitly"
        },
        {
            "sha": "cf59798e14526f3b0d5de8a38451e1dde71e8b30",
            "filename": "crates/next-core/src/next_font/google/mod.rs",
            "status": "modified",
            "additions": 31,
            "deletions": 6,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_font%2Fgoogle%2Fmod.rs?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -182,6 +182,7 @@ pub struct NextFontGoogleCssModuleReplacer {\n     project_path: FileSystemPath,\n     execution_context: ResolvedVc<ExecutionContext>,\n     next_mode: ResolvedVc<NextMode>,\n+    reqwest_client_config: ResolvedVc<ReqwestClientConfig>,\n }\n \n #[turbo_tasks::value_impl]\n@@ -191,11 +192,13 @@ impl NextFontGoogleCssModuleReplacer {\n         project_path: FileSystemPath,\n         execution_context: ResolvedVc<ExecutionContext>,\n         next_mode: ResolvedVc<NextMode>,\n+        reqwest_client_config: ResolvedVc<ReqwestClientConfig>,\n     ) -> Vc<Self> {\n         Self::cell(NextFontGoogleCssModuleReplacer {\n             project_path,\n             execution_context,\n             next_mode,\n+            reqwest_client_config,\n         })\n     }\n \n@@ -228,7 +231,14 @@ impl NextFontGoogleCssModuleReplacer {\n         let stylesheet_str = mocked_responses_path\n             .as_ref()\n             .map_or_else(\n-                || fetch_real_stylesheet(stylesheet_url.clone(), css_virtual_path.clone()).boxed(),\n+                || {\n+                    fetch_real_stylesheet(\n+                        stylesheet_url.clone(),\n+                        css_virtual_path.clone(),\n+                        *self.reqwest_client_config,\n+                    )\n+                    .boxed()\n+                },\n                 |p| get_mock_stylesheet(stylesheet_url.clone(), p, *self.execution_context).boxed(),\n             )\n             .await?;\n@@ -365,13 +375,20 @@ struct NextFontGoogleFontFileOptions {\n #[turbo_tasks::value(shared)]\n pub struct NextFontGoogleFontFileReplacer {\n     project_path: FileSystemPath,\n+    reqwest_client_config: ResolvedVc<ReqwestClientConfig>,\n }\n \n #[turbo_tasks::value_impl]\n impl NextFontGoogleFontFileReplacer {\n     #[turbo_tasks::function]\n-    pub fn new(project_path: FileSystemPath) -> Vc<Self> {\n-        Self::cell(NextFontGoogleFontFileReplacer { project_path })\n+    pub fn new(\n+        project_path: FileSystemPath,\n+        reqwest_client_config: ResolvedVc<ReqwestClientConfig>,\n+    ) -> Vc<Self> {\n+        Self::cell(NextFontGoogleFontFileReplacer {\n+            project_path,\n+            reqwest_client_config,\n+        })\n     }\n }\n \n@@ -426,7 +443,12 @@ impl ImportMappingReplacement for NextFontGoogleFontFileReplacer {\n \n         // doesn't seem ideal to download the font into a string, but probably doesn't\n         // really matter either.\n-        let Some(font) = fetch_from_google_fonts(url.into(), font_virtual_path.clone()).await?\n+        let Some(font) = fetch_from_google_fonts(\n+            url.into(),\n+            font_virtual_path.clone(),\n+            *self.reqwest_client_config,\n+        )\n+        .await?\n         else {\n             return Ok(ImportMapResult::Result(ResolveResult::unresolvable()).cell());\n         };\n@@ -650,20 +672,23 @@ fn font_file_options_from_query_map(query: &RcStr) -> Result<NextFontGoogleFontF\n async fn fetch_real_stylesheet(\n     stylesheet_url: RcStr,\n     css_virtual_path: FileSystemPath,\n+    reqwest_client_config: Vc<ReqwestClientConfig>,\n ) -> Result<Option<Vc<RcStr>>> {\n-    let body = fetch_from_google_fonts(stylesheet_url, css_virtual_path).await?;\n+    let body =\n+        fetch_from_google_fonts(stylesheet_url, css_virtual_path, reqwest_client_config).await?;\n \n     Ok(body.map(|body| body.to_string()))\n }\n \n async fn fetch_from_google_fonts(\n     url: RcStr,\n     virtual_path: FileSystemPath,\n+    reqwest_client_config: Vc<ReqwestClientConfig>,\n ) -> Result<Option<Vc<HttpResponseBody>>> {\n     let result = fetch(\n         url,\n         Some(rcstr!(USER_AGENT_FOR_GOOGLE_FONTS)),\n-        ReqwestClientConfig { proxy: None }.cell(),\n+        reqwest_client_config,\n     )\n     .await?;\n "
        },
        {
            "sha": "83e9a623a6ceab2122496f905cfed490029ba17c",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -1022,13 +1022,15 @@ async fn insert_next_shared_aliases(\n         next_font_google_replacer_mapping,\n     );\n \n+    let reqwest_client_config = next_config.reqwest_client_config(execution_context.env());\n     import_map.insert_alias(\n         AliasPattern::exact(\"@vercel/turbopack-next/internal/font/google/cssmodule.module.css\"),\n         ImportMapping::Dynamic(ResolvedVc::upcast(\n             NextFontGoogleCssModuleReplacer::new(\n                 project_path.clone(),\n                 execution_context,\n                 next_mode,\n+                reqwest_client_config,\n             )\n             .to_resolved()\n             .await?,\n@@ -1039,7 +1041,7 @@ async fn insert_next_shared_aliases(\n     import_map.insert_alias(\n         AliasPattern::exact(GOOGLE_FONTS_INTERNAL_PREFIX),\n         ImportMapping::Dynamic(ResolvedVc::upcast(\n-            NextFontGoogleFontFileReplacer::new(project_path.clone())\n+            NextFontGoogleFontFileReplacer::new(project_path.clone(), reqwest_client_config)\n                 .to_resolved()\n                 .await?,\n         ))"
        },
        {
            "sha": "e37b2487980e6e22a554e15c5ed715ae28679440",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -462,6 +462,26 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n         turbopackTreeShaking: z.boolean().optional(),\n         turbopackRemoveUnusedExports: z.boolean().optional(),\n         turbopackScopeHoisting: z.boolean().optional(),\n+        /**\n+         * Use the system-provided CA roots instead of bundled CA roots for external HTTPS requests\n+         * made by Turbopack. Currently this is only used for fetching data from Google Fonts.\n+         *\n+         * This may be useful in cases where you or an employer are MITMing traffic.\n+         *\n+         * This option is experimental because:\n+         * - This may cause small performance problems, as it uses [`rustls-native-certs`](\n+         *   https://github.com/rustls/rustls-native-certs).\n+         * - In the future, this may become the default, and this option may be eliminated, once\n+         *   <https://github.com/seanmonstar/reqwest/issues/2159> is resolved.\n+         *\n+         * Users who need to configure this behavior system-wide can override the project\n+         * configuration using the `NEXT_TURBOPACK_EXPERIMENTAL_USE_SYSTEM_TLS_CERTS=1` environment\n+         * variable.\n+         *\n+         * This option is ignored on Windows on ARM, where the native TLS implementation is always\n+         * used.\n+         */\n+        turbopackUseSystemTlsCerts: z.boolean().optional(),\n         optimizePackageImports: z.array(z.string()).optional(),\n         optimizeServerReact: z.boolean().optional(),\n         clientTraceMetadata: z.array(z.string()).optional(),"
        },
        {
            "sha": "2113a046d64c060b212d57d4d3d0360f4d109131",
            "filename": "turbopack/crates/turbo-tasks-fetch/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/turbopack%2Fcrates%2Fturbo-tasks-fetch%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/turbopack%2Fcrates%2Fturbo-tasks-fetch%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2FCargo.toml?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -20,8 +20,9 @@ workspace = true\n [target.'cfg(all(target_os = \"windows\", target_arch = \"aarch64\"))'.dependencies]\n reqwest = { workspace = true, features = [\"native-tls\"] }\n \n+# If you modify this cfg, make sure you update `ReqwestClientConfig::try_build`.\n [target.'cfg(not(any(all(target_os = \"windows\", target_arch = \"aarch64\"), target_arch=\"wasm32\")))'.dependencies]\n-reqwest = { workspace = true, features = [\"rustls-tls\"] }\n+reqwest = { workspace = true, features = [\"rustls-tls-webpki-roots\", \"rustls-tls-native-roots\"] }\n \n [dependencies]\n anyhow = { workspace = true }"
        },
        {
            "sha": "4c9e278bd2b83b9b23ae6a1b075b4494bcbbedc8",
            "filename": "turbopack/crates/turbo-tasks-fetch/src/reqwest_client_cache.rs",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Freqwest_client_cache.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Freqwest_client_cache.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Fsrc%2Freqwest_client_cache.rs?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -26,6 +26,29 @@ pub enum ProxyConfig {\n #[derive(Hash)]\n pub struct ReqwestClientConfig {\n     pub proxy: Option<ProxyConfig>,\n+    /// Whether to load embedded webpki root certs with rustls. Default is true.\n+    ///\n+    /// Ignored for:\n+    /// - Windows on ARM, which uses `native-tls` instead of `rustls-tls`.\n+    /// - Ignored for WASM targets, which use the runtime's TLS implementation.\n+    pub tls_built_in_webpki_certs: bool,\n+    /// Whether to load native root certs using the `rustls-native-certs` crate. This may make\n+    /// reqwest client initialization slower, so it's not used by default.\n+    ///\n+    /// Ignored for:\n+    /// - Windows on ARM, which uses `native-tls` instead of `rustls-tls`.\n+    /// - Ignored for WASM targets, which use the runtime's TLS implementation.\n+    pub tls_built_in_native_certs: bool,\n+}\n+\n+impl Default for ReqwestClientConfig {\n+    fn default() -> Self {\n+        Self {\n+            proxy: None,\n+            tls_built_in_webpki_certs: true,\n+            tls_built_in_native_certs: false,\n+        }\n+    }\n }\n \n impl ReqwestClientConfig {\n@@ -40,6 +63,17 @@ impl ReqwestClientConfig {\n             }\n             None => {}\n         };\n+\n+        // make sure this cfg matches the one in `Cargo.toml`!\n+        #[cfg(not(any(\n+            all(target_os = \"windows\", target_arch = \"aarch64\"),\n+            target_arch = \"wasm32\"\n+        )))]\n+        let client_builder = client_builder\n+            .tls_built_in_root_certs(false)\n+            .tls_built_in_webpki_certs(self.tls_built_in_webpki_certs)\n+            .tls_built_in_native_certs(self.tls_built_in_native_certs);\n+\n         client_builder.build()\n     }\n }"
        },
        {
            "sha": "31fd898a14aa4bb45b462210e4d3fefe41b23f95",
            "filename": "turbopack/crates/turbo-tasks-fetch/tests/fetch.rs",
            "status": "modified",
            "additions": 27,
            "deletions": 14,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/56fed4d6b489b9b60cd3b7647b21597f09768be9/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ffetch.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/56fed4d6b489b9b60cd3b7647b21597f09768be9/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ffetch.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ffetch.rs?ref=56fed4d6b489b9b60cd3b7647b21597f09768be9",
            "patch": "@@ -6,7 +6,7 @@ use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::Vc;\n use turbo_tasks_fetch::{\n     __test_only_reqwest_client_cache_clear, __test_only_reqwest_client_cache_len, FetchErrorKind,\n-    ProxyConfig, ReqwestClientConfig, fetch,\n+    ReqwestClientConfig, fetch,\n };\n use turbo_tasks_fs::{DiskFileSystem, FileSystem, FileSystemPath};\n use turbo_tasks_testing::{Registration, register, run};\n@@ -29,7 +29,7 @@ async fn basic_get() {\n             .create_async()\n             .await;\n \n-        let config_vc = ReqwestClientConfig { proxy: None }.cell();\n+        let config_vc = ReqwestClientConfig::default().cell();\n         let response = &*fetch(\n             RcStr::from(format!(\"{}/foo.woff\", server.url())),\n             /* user_agent */ None,\n@@ -63,7 +63,7 @@ async fn sends_user_agent() {\n \n         eprintln!(\"{}\", server.url());\n \n-        let config_vc = ReqwestClientConfig { proxy: None }.cell();\n+        let config_vc = ReqwestClientConfig::default().cell();\n         let response = &*fetch(\n             RcStr::from(format!(\"{}/foo.woff\", server.url())),\n             Some(rcstr!(\"mock-user-agent\")),\n@@ -98,7 +98,7 @@ async fn invalidation_does_not_invalidate() {\n             .await;\n \n         let url = RcStr::from(format!(\"{}/foo.woff\", server.url()));\n-        let config_vc = ReqwestClientConfig { proxy: None }.cell();\n+        let config_vc = ReqwestClientConfig::default().cell();\n         let response = &*fetch(url.clone(), /* user_agent */ None, config_vc)\n             .await?\n             .unwrap()\n@@ -136,7 +136,7 @@ async fn errors_on_failed_connection() {\n         // `ECONNREFUSED`.\n         // Other values (e.g. domain name, reserved IP address block) may result in long timeouts.\n         let url = rcstr!(\"http://127.0.0.1:0/foo.woff\");\n-        let config_vc = ReqwestClientConfig { proxy: None }.cell();\n+        let config_vc = ReqwestClientConfig::default().cell();\n         let response_vc = fetch(url.clone(), None, config_vc);\n         let err_vc = &*response_vc.await?.unwrap_err();\n         let err = err_vc.await?;\n@@ -171,7 +171,7 @@ async fn errors_on_404() {\n             .await;\n \n         let url = RcStr::from(server.url());\n-        let config_vc = ReqwestClientConfig { proxy: None }.cell();\n+        let config_vc = ReqwestClientConfig::default().cell();\n         let response_vc = fetch(url.clone(), None, config_vc);\n         let err_vc = &*response_vc.await?.unwrap_err();\n         let err = err_vc.await?;\n@@ -225,26 +225,39 @@ async fn client_cache() {\n         __test_only_reqwest_client_cache_clear();\n         assert_eq!(__test_only_reqwest_client_cache_len(), 0);\n \n-        simple_fetch(\"/foo\", ReqwestClientConfig { proxy: None })\n-            .await\n-            .unwrap();\n+        simple_fetch(\n+            \"/foo\",\n+            ReqwestClientConfig {\n+                tls_built_in_native_certs: false,\n+                ..Default::default()\n+            },\n+        )\n+        .await\n+        .unwrap();\n         assert_eq!(__test_only_reqwest_client_cache_len(), 1);\n \n         // the client is reused if the config is the same (by equality)\n-        simple_fetch(\"/bar\", ReqwestClientConfig { proxy: None })\n-            .await\n-            .unwrap();\n+        simple_fetch(\n+            \"/bar\",\n+            ReqwestClientConfig {\n+                tls_built_in_native_certs: false,\n+                ..Default::default()\n+            },\n+        )\n+        .await\n+        .unwrap();\n         assert_eq!(__test_only_reqwest_client_cache_len(), 1);\n \n         // the client is recreated if the config is different\n         simple_fetch(\n             \"/bar\",\n             ReqwestClientConfig {\n-                proxy: Some(ProxyConfig::Http(RcStr::from(\"http://127.0.0.1:0/\"))),\n+                tls_built_in_native_certs: true,\n+                ..Default::default()\n             },\n         )\n         .await\n-        .unwrap_err();\n+        .unwrap();\n         assert_eq!(__test_only_reqwest_client_cache_len(), 2);\n \n         Ok(())"
        }
    ],
    "stats": {
        "total": 208,
        "additions": 180,
        "deletions": 28
    }
}