{
    "author": "bgw",
    "message": "Turbopack: Fix compound assignment expression evaluation (#85478) (#85593)\n\nMigrated from https://github.com/vercel/next.js/pull/85478 into this non-fork because we had some issues with our CI infra that should be fixed going forward: https://vercel.slack.com/archives/C04KC8A53T7/p1761862171772939 \r\n\r\n---\r\n\r\nfixes #85474 \r\n\r\nPreviously, the analyzer treated all assignment expressions the same way, evaluating them as their right-hand side value. This was incorrect for compound assignments (+=, -=, *=, |=, >>=, etc.), which compute a new value based on both the left and right operands.\r\n\r\nThis commit distinguishes between simple assignments (=) and compound assignments. Simple assignments continue to evaluate to the right-hand side, while compound assignments are now properly marked as unknown values with side effects.\r\n\r\nAlso adds tests for compound assignments in conditionals, covering bitshift operations (>>=, <<=, >>>=) and bitwise operations (|=, &=, ^=) with both numbers and bigints.",
    "sha": "40102ab5ad345ca17290c161ccbe89dc8b7e1495",
    "files": [
        {
            "sha": "3a4506e7090d672bc58cd303728286a030577d12",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/graph.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fgraph.rs?ref=40102ab5ad345ca17290c161ccbe89dc8b7e1495",
            "patch": "@@ -802,7 +802,10 @@ impl EvalContext {\n                 ..\n             }) => JsValue::WellKnownObject(WellKnownObjectKind::ImportMeta),\n \n-            Expr::Assign(AssignExpr { right, .. }) => self.eval(right),\n+            Expr::Assign(AssignExpr { op, right, .. }) => match op {\n+                AssignOp::Assign => self.eval(right),\n+                _ => JsValue::unknown_empty(true, \"compound assignment expression\"),\n+            },\n \n             _ => JsValue::unknown_empty(true, \"unsupported expression\"),\n         }"
        },
        {
            "sha": "ded879e18f49b7d3bacb5b3c775d3642b84859c4",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/react-dom-production/graph-explained.snapshot",
            "status": "modified",
            "additions": 13,
            "deletions": 5,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fgraph-explained.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fgraph-explained.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fgraph-explained.snapshot?ref=40102ab5ad345ca17290c161ccbe89dc8b7e1495",
            "patch": "@@ -3330,8 +3330,10 @@ c#169 = (???*0* | ???*1*)\n - *1* unsupported assign operation\n   ⚠️  This value might have side effects\n \n-c#171 = (b | ???*0*)\n-- *0* unsupported assign operation\n+c#171 = (???*0* | ???*1*)\n+- *0* compound assignment expression\n+  ⚠️  This value might have side effects\n+- *1* unsupported assign operation\n   ⚠️  This value might have side effects\n \n c#175 = arguments[2]\n@@ -4829,8 +4831,14 @@ f#423 = (b[\"contextType\"] | (Zf(b) ? Xf : H[\"current\"]) | b[\"getDerivedStateFrom\n \n f#424 = (`${a}` | undefined)\n \n-f#431 = (...) => (c | (???*0* ? c : d))\n-- *0* unsupported expression\n+f#431 = (...) => (???*0* | (???*1* ? ???*2* : d) | c)\n+- *0* c\n+  ⚠️  sequence with side effects\n+  ⚠️  This value might have side effects\n+- *1* unsupported expression\n+  ⚠️  This value might have side effects\n+- *2* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n \n f#440 = c[\"type\"]\n@@ -6198,7 +6206,7 @@ sh (const after eval) = (...) => (b[\"ref\"] | b | a)\n \n si (const after eval) = (...) => di()[\"memoizedState\"]\n \n-sj (const after eval) = (...) => (???*0* | null | f | tj(a, b, g, null) | tj(a, b, g, d) | b)\n+sj (const after eval) = (...) => (???*0* | f | tj(a, b, g, null) | tj(a, b, g, d) | b)\n - *0* tj(a, b, g, d)\n   ⚠️  sequence with side effects\n   ⚠️  This value might have side effects"
        },
        {
            "sha": "bda826d02831fd30bc0ef7c8aadd830ff65cb359",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/react-dom-production/resolved-effects.snapshot",
            "status": "modified",
            "additions": 69,
            "deletions": 33,
            "changes": 102,
            "blob_url": "https://github.com/vercel/next.js/blob/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-effects.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-effects.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-effects.snapshot?ref=40102ab5ad345ca17290c161ccbe89dc8b7e1495",
            "patch": "@@ -8242,8 +8242,8 @@ ${La}${a}`(\"SuspenseList\")\n   ⚠️  nested operation\n - *5* unsupported expression\n   ⚠️  This value might have side effects\n-- *6* arguments[1]\n-  ⚠️  function calls are not analyzed yet\n+- *6* compound assignment expression\n+  ⚠️  This value might have side effects\n - *7* unsupported assign operation\n   ⚠️  This value might have side effects\n \n@@ -24836,14 +24836,20 @@ ${La}${a}`(\"SuspenseList\")\n - *1* max number of linking steps reached\n   ⚠️  This value might have side effects\n \n-0 -> 3401 call = (...) => (c | (???*0* ? c : d))(???*1*, ???*2*, (0 | ???*3*))\n-- *0* unsupported expression\n+0 -> 3401 call = (...) => (???*0* | (???*1* ? ???*2* : d) | c)(???*3*, ???*4*, (0 | ???*5*))\n+- *0* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *1* max number of linking steps reached\n+- *1* unsupported expression\n   ⚠️  This value might have side effects\n-- *2* max number of linking steps reached\n+- *2* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *3* updated with update expression\n+- *3* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *4* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *5* updated with update expression\n   ⚠️  This value might have side effects\n \n 0 -> 3402 conditional = (null === ???*0*)\n@@ -24891,14 +24897,20 @@ ${La}${a}`(\"SuspenseList\")\n - *4* arguments[3]\n   ⚠️  function calls are not analyzed yet\n \n-3409 -> 3413 call = (...) => (c | (???*0* ? c : d))(???*1*, ???*2*, (0 | ???*3*))\n-- *0* unsupported expression\n+3409 -> 3413 call = (...) => (???*0* | (???*1* ? ???*2* : d) | c)(???*3*, ???*4*, (0 | ???*5*))\n+- *0* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *1* max number of linking steps reached\n+- *1* unsupported expression\n   ⚠️  This value might have side effects\n-- *2* max number of linking steps reached\n+- *2* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *3* updated with update expression\n+- *3* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *4* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *5* updated with update expression\n   ⚠️  This value might have side effects\n \n 3409 -> 3414 conditional = (null === ???*0*)\n@@ -24963,14 +24975,20 @@ ${La}${a}`(\"SuspenseList\")\n - *6* max number of linking steps reached\n   ⚠️  This value might have side effects\n \n-3409 -> 3428 call = (...) => (c | (???*0* ? c : d))(???*1*, ???*2*, (0 | ???*3*))\n-- *0* unsupported expression\n+3409 -> 3428 call = (...) => (???*0* | (???*1* ? ???*2* : d) | c)(???*3*, ???*4*, (0 | ???*5*))\n+- *0* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *1* max number of linking steps reached\n+- *1* unsupported expression\n   ⚠️  This value might have side effects\n-- *2* max number of linking steps reached\n+- *2* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *3* updated with update expression\n+- *3* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *4* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *5* updated with update expression\n   ⚠️  This value might have side effects\n \n 3409 -> 3429 conditional = (null === ???*0*)\n@@ -25085,14 +25103,20 @@ ${La}${a}`(\"SuspenseList\")\n - *1* max number of linking steps reached\n   ⚠️  This value might have side effects\n \n-0 -> 3460 call = (...) => (c | (???*0* ? c : d))(???*1*, ???*2*, (0 | ???*3*))\n-- *0* unsupported expression\n+0 -> 3460 call = (...) => (???*0* | (???*1* ? ???*2* : d) | c)(???*3*, ???*4*, (0 | ???*5*))\n+- *0* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *1* max number of linking steps reached\n+- *1* unsupported expression\n   ⚠️  This value might have side effects\n-- *2* max number of linking steps reached\n+- *2* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *3* updated with update expression\n+- *3* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *4* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *5* updated with update expression\n   ⚠️  This value might have side effects\n \n 0 -> 3461 conditional = (null === ???*0*)\n@@ -25144,14 +25168,20 @@ ${La}${a}`(\"SuspenseList\")\n - *4* arguments[3]\n   ⚠️  function calls are not analyzed yet\n \n-3468 -> 3474 call = (...) => (c | (???*0* ? c : d))(???*1*, ???*2*, (0 | ???*3*))\n-- *0* unsupported expression\n+3468 -> 3474 call = (...) => (???*0* | (???*1* ? ???*2* : d) | c)(???*3*, ???*4*, (0 | ???*5*))\n+- *0* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *1* max number of linking steps reached\n+- *1* unsupported expression\n   ⚠️  This value might have side effects\n-- *2* max number of linking steps reached\n+- *2* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *3* updated with update expression\n+- *3* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *4* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *5* updated with update expression\n   ⚠️  This value might have side effects\n \n 3468 -> 3475 conditional = (null === ???*0*)\n@@ -25221,14 +25251,20 @@ ${La}${a}`(\"SuspenseList\")\n - *6* max number of linking steps reached\n   ⚠️  This value might have side effects\n \n-3468 -> 3491 call = (...) => (c | (???*0* ? c : d))(???*1*, ???*2*, (0 | ???*3*))\n-- *0* unsupported expression\n+3468 -> 3491 call = (...) => (???*0* | (???*1* ? ???*2* : d) | c)(???*3*, ???*4*, (0 | ???*5*))\n+- *0* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *1* max number of linking steps reached\n+- *1* unsupported expression\n   ⚠️  This value might have side effects\n-- *2* max number of linking steps reached\n+- *2* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n-- *3* updated with update expression\n+- *3* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *4* max number of linking steps reached\n+  ⚠️  This value might have side effects\n+- *5* updated with update expression\n   ⚠️  This value might have side effects\n \n 3468 -> 3492 conditional = (null === ???*0*)\n@@ -35905,7 +35941,7 @@ ${La}${a}`(\"SuspenseList\")\n - *0* max number of linking steps reached\n   ⚠️  This value might have side effects\n \n-4626 -> 4627 call = (...) => (???*0* | null | f | tj(a, b, g, null) | tj(a, b, g, d) | b)(???*1*, ???*2*, ???*3*, ???*4*, ???*5*, ???*6*, (???*7* | ???*8*))\n+4626 -> 4627 call = (...) => (???*0* | f | tj(a, b, g, null) | tj(a, b, g, d) | b)(???*1*, ???*2*, ???*3*, ???*4*, ???*5*, ???*6*, (???*7* | ???*8*))\n - *0* tj(a, b, g, d)\n   ⚠️  sequence with side effects\n   ⚠️  This value might have side effects"
        },
        {
            "sha": "45cf0a5fdd7abf1d71ade1de61a58007a2dd83a1",
            "filename": "turbopack/crates/turbopack-ecmascript/tests/analyzer/graph/react-dom-production/resolved-explained.snapshot",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-explained.snapshot",
            "raw_url": "https://github.com/vercel/next.js/raw/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-explained.snapshot",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Ftests%2Fanalyzer%2Fgraph%2Freact-dom-production%2Fresolved-explained.snapshot?ref=40102ab5ad345ca17290c161ccbe89dc8b7e1495",
            "patch": "@@ -9730,8 +9730,8 @@ c#169 = (???*0* | ???*1*)\n   ⚠️  This value might have side effects\n \n c#171 = (???*0* | ???*1*)\n-- *0* arguments[1]\n-  ⚠️  function calls are not analyzed yet\n+- *0* compound assignment expression\n+  ⚠️  This value might have side effects\n - *1* unsupported assign operation\n   ⚠️  This value might have side effects\n \n@@ -17480,8 +17480,14 @@ f#424 = (???*0* | ???*1* | undefined)\n - *2* arguments[2]\n   ⚠️  function calls are not analyzed yet\n \n-f#431 = (...) => (c | (???*0* ? c : d))\n-- *0* unsupported expression\n+f#431 = (...) => (???*0* | (???*1* ? ???*2* : d) | c)\n+- *0* c\n+  ⚠️  sequence with side effects\n+  ⚠️  This value might have side effects\n+- *1* unsupported expression\n+  ⚠️  This value might have side effects\n+- *2* c\n+  ⚠️  sequence with side effects\n   ⚠️  This value might have side effects\n \n f#440 = ???*0*\n@@ -21224,7 +21230,7 @@ sh = (...) => (b[\"ref\"] | b | a)\n \n si = (...) => di()[\"memoizedState\"]\n \n-sj = (...) => (???*0* | null | f | tj(a, b, g, null) | tj(a, b, g, d) | b)\n+sj = (...) => (???*0* | f | tj(a, b, g, null) | tj(a, b, g, d) | b)\n - *0* tj(a, b, g, d)\n   ⚠️  sequence with side effects\n   ⚠️  This value might have side effects"
        },
        {
            "sha": "9b31eaef39c05dc62593aee4bb17d9e4cefd7734",
            "filename": "turbopack/crates/turbopack-tests/tests/execution/turbopack/basic/compound-assign-in-conditional/input/index.js",
            "status": "added",
            "additions": 69,
            "deletions": 0,
            "changes": 69,
            "blob_url": "https://github.com/vercel/next.js/blob/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fcompound-assign-in-conditional%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/40102ab5ad345ca17290c161ccbe89dc8b7e1495/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fcompound-assign-in-conditional%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fexecution%2Fturbopack%2Fbasic%2Fcompound-assign-in-conditional%2Finput%2Findex.js?ref=40102ab5ad345ca17290c161ccbe89dc8b7e1495",
            "patch": "@@ -0,0 +1,69 @@\n+it('should handle right shift assignment in conditional for number', () => {\n+  let value = 16\n+  let entered = false\n+  if ((value >>= 2)) {\n+    entered = true\n+  }\n+  expect(value).toBe(4)\n+  expect(entered).toBe(true)\n+})\n+\n+it('should handle right shift assignment in conditional for bigint', () => {\n+  let value = 16n\n+  let entered = false\n+  if ((value >>= 2n)) {\n+    entered = true\n+  }\n+  expect(value).toBe(4n)\n+  expect(entered).toBe(true)\n+})\n+\n+it('should handle left shift assignment in conditional for number', () => {\n+  let value = 3\n+  let entered = false\n+  if ((value <<= 2)) {\n+    entered = true\n+  }\n+  expect(value).toBe(12)\n+  expect(entered).toBe(true)\n+})\n+\n+it('should handle unsigned right shift assignment in conditional for number', () => {\n+  let value = 16\n+  let entered = false\n+  if ((value >>>= 2)) {\n+    entered = true\n+  }\n+  expect(value).toBe(4)\n+  expect(entered).toBe(true)\n+})\n+\n+it('should handle bitwise OR assignment in conditional', () => {\n+  let value = 0\n+  let entered = false\n+  if ((value |= 5)) {\n+    entered = true\n+  }\n+  expect(value).toBe(5)\n+  expect(entered).toBe(true)\n+})\n+\n+it('should handle bitwise AND assignment in conditional', () => {\n+  let value = 7\n+  let entered = false\n+  if ((value &= 3)) {\n+    entered = true\n+  }\n+  expect(value).toBe(3)\n+  expect(entered).toBe(true)\n+})\n+\n+it('should handle bitwise XOR assignment in conditional', () => {\n+  let value = 5\n+  let entered = false\n+  if ((value ^= 3)) {\n+    entered = true\n+  }\n+  expect(value).toBe(6)\n+  expect(entered).toBe(true)\n+})"
        }
    ],
    "stats": {
        "total": 210,
        "additions": 166,
        "deletions": 44
    }
}