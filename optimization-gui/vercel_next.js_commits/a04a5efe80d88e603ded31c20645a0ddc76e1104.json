{
    "author": "lukesandberg",
    "message": "Add an e2e test for the css serving issue (#81683)\n\n## Add a regression test for when a not-found component depends on css and triggers a bug in turbopack\n\nTo correctly serve js and css resources during server side rendering we construct a client manifest that lists all the server components and their required resources.  Turbopack has a bug where we fail to collect css that is used by the page if it is also used by a not-found page (and other error handlers as well).\n\nWhen a not-found component is present all pages pages implicitly depend on this module and depend on it as an early dependency of the generated `app-page.js` file.  This means if a `not-found.js` file (or a global error file) would happen to depend on the same css as a normal component we would associate it as a client-reference of that component instead of any other.  Then on a server side render we would simply omit it.  This PR adds a regression test for this issue.\n\nSee  #77861 and  #79535",
    "sha": "a04a5efe80d88e603ded31c20645a0ddc76e1104",
    "files": [
        {
            "sha": "3f7a9c6663aadd6d8cc248bda4285929bce089a0",
            "filename": "test/e2e/app-dir/initial-css-not-found/app/(default)/layout.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2F(default)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2F(default)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2F(default)%2Flayout.tsx?ref=a04a5efe80d88e603ded31c20645a0ddc76e1104",
            "patch": "@@ -0,0 +1,10 @@\n+import type { ReactNode } from 'react'\n+import styles from '../styles.module.css'\n+\n+export default function RootLayout({ children }: { children: ReactNode }) {\n+  return (\n+    <html lang=\"en\">\n+      <body className={styles.foo}>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/initial-css-not-found/app/(default)/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2F(default)%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2F(default)%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2F(default)%2Fpage.tsx?ref=a04a5efe80d88e603ded31c20645a0ddc76e1104",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "43311f3894427f016a0284033640a97702280ad2",
            "filename": "test/e2e/app-dir/initial-css-not-found/app/layout.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Flayout.tsx?ref=a04a5efe80d88e603ded31c20645a0ddc76e1104",
            "patch": "@@ -0,0 +1,5 @@\n+import type { ReactNode } from 'react'\n+\n+export default function Layout({ children }: { children: ReactNode }) {\n+  return children\n+}"
        },
        {
            "sha": "0a091793fd277c0b9938aa7afec67ddff1f5108c",
            "filename": "test/e2e/app-dir/initial-css-not-found/app/not-found.tsx",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Fnot-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Fnot-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Fnot-found.tsx?ref=a04a5efe80d88e603ded31c20645a0ddc76e1104",
            "patch": "@@ -0,0 +1,18 @@\n+import styles from './styles.module.css'\n+\n+/**\n+ * The mere existence of a not found page importing the same css as a layout used to prevent it from being served.\n+ *\n+ * See https://github.com/vercel/next.js/issues/77861 and https://github.com/vercel/next.js/issues/79535\n+ */\n+export default function NotFoundPage() {\n+  return (\n+    <html lang=\"en\">\n+      <body className={styles.foo}>\n+        <main>\n+          <h1>Page not found</h1>\n+        </main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "a15c877ac01f4146af0d179f365960a37fe4632e",
            "filename": "test/e2e/app-dir/initial-css-not-found/app/styles.module.css",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Fstyles.module.css",
            "raw_url": "https://github.com/vercel/next.js/raw/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Fstyles.module.css",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fapp%2Fstyles.module.css?ref=a04a5efe80d88e603ded31c20645a0ddc76e1104",
            "patch": "@@ -0,0 +1,3 @@\n+.foo {\n+  color: red;\n+}"
        },
        {
            "sha": "83c2130b2f88c2e6bef633004290a5a16b166ede",
            "filename": "test/e2e/app-dir/initial-css-not-found/initial-css-not-found.test.ts",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Finitial-css-not-found.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Finitial-css-not-found.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Finitial-css-not-found.test.ts?ref=a04a5efe80d88e603ded31c20645a0ddc76e1104",
            "patch": "@@ -0,0 +1,24 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('initial-css-not-found', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  // Regression test for a bug where the existence of a not-found page would prevent the css from being discovered.\n+  // See https://github.com/vercel/next.js/issues/77861 and https://github.com/vercel/next.js/issues/79535\n+  it('should serve styles', async () => {\n+    const browser = await next.browser('/')\n+\n+    expect(\n+      await browser.eval(\n+        `window.getComputedStyle(document.querySelector('body')).color`\n+      )\n+    ).toBe(\n+      // This only fails in production turbopack builds\n+      process.env.IS_TURBOPACK_TEST && process.env.NEXT_TEST_MODE !== 'dev'\n+        ? 'rgb(0, 0, 0)'\n+        : 'rgb(255, 0, 0)'\n+    )\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/e2e/app-dir/initial-css-not-found/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/a04a5efe80d88e603ded31c20645a0ddc76e1104/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finitial-css-not-found%2Fnext.config.js?ref=a04a5efe80d88e603ded31c20645a0ddc76e1104",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 69,
        "deletions": 0
    }
}