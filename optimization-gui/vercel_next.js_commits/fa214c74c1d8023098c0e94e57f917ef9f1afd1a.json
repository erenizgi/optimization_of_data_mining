{
    "author": "kdy1",
    "message": "fix(styled-jsx): Pass `useLightningcss` option to `styled-jsx` correctly (#77008)\n\n### What?\n\nPreviously, `styled_jsx.useLightningcss` was not passed correctly. This PR fixes it.\n\n### Why?\n\nIt's required to enable lightningcss mode for styled-jsx.",
    "sha": "fa214c74c1d8023098c0e94e57f917ef9f1afd1a",
    "files": [
        {
            "sha": "a045f35d15f77cb254fe3860b6daada0120d8aa8",
            "filename": "crates/next-custom-transforms/src/chain_transforms.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/fa214c74c1d8023098c0e94e57f917ef9f1afd1a/crates%2Fnext-custom-transforms%2Fsrc%2Fchain_transforms.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fa214c74c1d8023098c0e94e57f917ef9f1afd1a/crates%2Fnext-custom-transforms%2Fsrc%2Fchain_transforms.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Fchain_transforms.rs?ref=fa214c74c1d8023098c0e94e57f917ef9f1afd1a",
            "patch": "@@ -117,6 +117,9 @@ pub struct TransformOptions {\n \n     #[serde(default)]\n     pub lint_codemod_comments: bool,\n+\n+    #[serde(default)]\n+    pub css_env: Option<swc_core::ecma::preset_env::Config>,\n }\n \n pub fn custom_before_pass<'a, C>(\n@@ -151,20 +154,21 @@ where\n         }\n     };\n \n-    let target_browsers = opts\n-        .swc\n-        .config\n-        .env\n-        .as_ref()\n-        .map(|env| targets_to_versions(env.targets.clone()).expect(\"failed to parse env.targets\"))\n-        .unwrap_or_default();\n-\n     let styled_jsx = {\n         let cm = cm.clone();\n         let file = file.clone();\n \n         fn_pass(move |program| {\n             if let Some(config) = opts.styled_jsx.to_option() {\n+                let target_browsers = opts\n+                    .css_env\n+                    .as_ref()\n+                    .map(|env| {\n+                        targets_to_versions(env.targets.clone())\n+                            .expect(\"failed to parse env.targets\")\n+                    })\n+                    .unwrap_or_default();\n+\n                 program.mutate(styled_jsx::visitor::styled_jsx(\n                     cm.clone(),\n                     &file.name,"
        },
        {
            "sha": "cc535bcf60c6053e6d74f0ecc1fb267b3ee3988f",
            "filename": "crates/next-custom-transforms/tests/full.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/fa214c74c1d8023098c0e94e57f917ef9f1afd1a/crates%2Fnext-custom-transforms%2Ftests%2Ffull.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/fa214c74c1d8023098c0e94e57f917ef9f1afd1a/crates%2Fnext-custom-transforms%2Ftests%2Ffull.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffull.rs?ref=fa214c74c1d8023098c0e94e57f917ef9f1afd1a",
            "patch": "@@ -81,6 +81,7 @@ fn test(input: &Path, minify: bool) {\n                 optimize_server_react: None,\n                 prefer_esm: false,\n                 debug_function_name: false,\n+                css_env: None,\n             };\n \n             let unresolved_mark = Mark::new();"
        },
        {
            "sha": "4a3207c62f3dd6915ed7c9025932b9b79882f549",
            "filename": "packages/next/src/build/swc/options.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/fa214c74c1d8023098c0e94e57f917ef9f1afd1a/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fa214c74c1d8023098c0e94e57f917ef9f1afd1a/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fswc%2Foptions.ts?ref=fa214c74c1d8023098c0e94e57f917ef9f1afd1a",
            "patch": "@@ -65,6 +65,7 @@ function getBaseSWCOptions({\n   compilerOptions,\n   resolvedBaseUrl,\n   jsConfig,\n+  supportedBrowsers,\n   swcCacheDir,\n   serverComponents,\n   serverReferenceHashSalt,\n@@ -84,6 +85,7 @@ function getBaseSWCOptions({\n   swcPlugins: ExperimentalConfig['swcPlugins']\n   resolvedBaseUrl?: ResolvedBaseUrl\n   jsConfig: any\n+  supportedBrowsers: string[] | undefined\n   swcCacheDir?: string\n   serverComponents?: boolean\n   serverReferenceHashSalt: string\n@@ -196,7 +198,9 @@ function getBaseSWCOptions({\n       : undefined,\n     relay: compilerOptions?.relay,\n     // Always transform styled-jsx and error when `client-only` condition is triggered\n-    styledJsx: {},\n+    styledJsx: compilerOptions?.styledJsx ?? {\n+      useLightningcss: jsConfig?.experimental?.useLightningcss ?? false,\n+    },\n     // Disable css-in-js libs (without client-only integration) transform on server layer for server components\n     ...(!isReactServerLayer && {\n       // eslint-disable-next-line @typescript-eslint/no-use-before-define\n@@ -232,6 +236,14 @@ function getBaseSWCOptions({\n     preferEsm: esm,\n     lintCodemodComments: true,\n     debugFunctionName: development,\n+\n+    ...(supportedBrowsers && supportedBrowsers.length > 0\n+      ? {\n+          cssEnv: {\n+            targets: supportedBrowsers,\n+          },\n+        }\n+      : {}),\n   }\n }\n \n@@ -319,6 +331,7 @@ export function getJestSWCOptions({\n     compilerOptions,\n     jsConfig,\n     resolvedBaseUrl,\n+    supportedBrowsers: undefined,\n     esm,\n     // Don't apply server layer transformations for Jest\n     // Disable server / client graph assertions for Jest\n@@ -408,6 +421,7 @@ export function getLoaderSWCOptions({\n     compilerOptions,\n     jsConfig,\n     // resolvedBaseUrl,\n+    supportedBrowsers,\n     swcCacheDir,\n     bundleLayer,\n     serverComponents,"
        }
    ],
    "stats": {
        "total": 37,
        "additions": 28,
        "deletions": 9
    }
}