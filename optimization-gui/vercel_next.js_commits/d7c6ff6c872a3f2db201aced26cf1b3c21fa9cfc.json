{
    "author": "mischnic",
    "message": "Turbopack: remove GlobalTypeofs AST pass (#83479)\n\nPort `EcmascriptInputTransform::GlobalTypeofs` from an extra AST pass to using the `CompileTimeInfo` replacement infrastructure.\r\n\r\nIdeally, we'd get rid of the `enable_typeof_window_inlining` option entirely. But currently you cannot have different `CompileTimeInfo` per module asset context, so it's not possible to different replacements per directory (which is what we unfortunately want for `typeof window` replacements).\r\n\r\nBasically closes PACK-5049",
    "sha": "d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc",
    "files": [
        {
            "sha": "b9dfb28f849170a8575a8b961e9b9d9b17607402",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc",
            "patch": "@@ -8,7 +8,7 @@ use turbo_tasks_fs::FileSystemPath;\n use turbopack::{\n     css::chunk::CssChunkType,\n     module_options::{\n-        CssOptionsContext, EcmascriptOptionsContext, JsxTransformOptions, ModuleRule, TypeofWindow,\n+        CssOptionsContext, EcmascriptOptionsContext, JsxTransformOptions, ModuleRule,\n         TypescriptTransformOptions, module_options_context::ModuleOptionsContext,\n     },\n     resolve_options_context::ResolveOptionsContext,\n@@ -28,7 +28,7 @@ use turbopack_core::{\n     module_graph::export_usage::OptionExportUsageInfo,\n     resolve::{parse::Request, pattern::Pattern},\n };\n-use turbopack_ecmascript::chunk::EcmascriptChunkType;\n+use turbopack_ecmascript::{TypeofWindow, chunk::EcmascriptChunkType};\n use turbopack_node::{\n     execution_context::ExecutionContext,\n     transforms::postcss::{PostCssConfigLocation, PostCssTransformOptions},"
        },
        {
            "sha": "a5366dc4aea99262900e6d15dec9a1ca28f404f5",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc",
            "patch": "@@ -9,7 +9,7 @@ use turbopack::{\n     css::chunk::CssChunkType,\n     module_options::{\n         CssOptionsContext, EcmascriptOptionsContext, ExternalsTracingOptions, JsxTransformOptions,\n-        ModuleOptionsContext, ModuleRule, TypeofWindow, TypescriptTransformOptions,\n+        ModuleOptionsContext, ModuleRule, TypescriptTransformOptions,\n     },\n     resolve_options_context::ResolveOptionsContext,\n     transition::Transition,\n@@ -28,7 +28,9 @@ use turbopack_core::{\n     module_graph::export_usage::OptionExportUsageInfo,\n     target::CompileTarget,\n };\n-use turbopack_ecmascript::{chunk::EcmascriptChunkType, references::esm::UrlRewriteBehavior};\n+use turbopack_ecmascript::{\n+    TypeofWindow, chunk::EcmascriptChunkType, references::esm::UrlRewriteBehavior,\n+};\n use turbopack_ecmascript_plugins::transform::directives::{\n     client::ClientDirectiveTransformer, client_disallowed::ClientDisallowedDirectiveTransformer,\n };"
        },
        {
            "sha": "cf38622ed3ac6e42751e89de999de1d1d74b39f2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 25,
            "deletions": 1,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc",
            "patch": "@@ -175,8 +175,27 @@ pub enum TreeShakingMode {\n #[turbo_tasks::value(transparent)]\n pub struct OptionTreeShaking(pub Option<TreeShakingMode>);\n \n+/// The constant to replace `typeof window` with.\n+#[derive(\n+    Copy,\n+    Clone,\n+    PartialEq,\n+    Eq,\n+    Debug,\n+    Hash,\n+    Serialize,\n+    Deserialize,\n+    TraceRawVcs,\n+    NonLocalValue,\n+    TaskInput,\n+)]\n+pub enum TypeofWindow {\n+    Object,\n+    Undefined,\n+}\n+\n #[turbo_tasks::value(shared)]\n-#[derive(Hash, Debug, Default, Copy, Clone)]\n+#[derive(Debug, Default, Copy, Clone)]\n pub struct EcmascriptOptions {\n     /// variant of tree shaking to use\n     pub tree_shaking_mode: Option<TreeShakingMode>,\n@@ -203,6 +222,11 @@ pub struct EcmascriptOptions {\n     /// Whether the modules in this context are never chunked/codegen-ed, but only used for\n     /// tracing.\n     pub is_tracing: bool,\n+    // TODO this should just be handled via CompileTimeInfo FreeVarReferences, but then it\n+    // (currently) wouldn't be possible to have different replacement values in user code vs\n+    // node_modules.\n+    /// Whether to replace `typeof window` with some constant value.\n+    pub enable_typeof_window_inlining: Option<TypeofWindow>,\n }\n \n #[turbo_tasks::value]"
        },
        {
            "sha": "abc9788d630e06deb12076a4cbda70bb4b6d1473",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 37,
            "deletions": 9,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc",
            "patch": "@@ -67,8 +67,8 @@ use turbo_tasks::{\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n     compile_time_info::{\n-        CompileTimeDefineValue, CompileTimeInfo, DefinableNameSegment, FreeVarReference,\n-        FreeVarReferences, FreeVarReferencesIndividual, InputRelativeConstant,\n+        CompileTimeDefineValue, CompileTimeDefines, CompileTimeInfo, DefinableNameSegment,\n+        FreeVarReference, FreeVarReferences, FreeVarReferencesIndividual, InputRelativeConstant,\n     },\n     environment::Rendering,\n     error::PrettyPrintError,\n@@ -130,7 +130,7 @@ use super::{\n pub use crate::references::esm::export::{FollowExportsResult, follow_reexports};\n use crate::{\n     EcmascriptInputTransforms, EcmascriptModuleAsset, EcmascriptParsable, SpecifiedModuleType,\n-    TreeShakingMode,\n+    TreeShakingMode, TypeofWindow,\n     analyzer::{\n         ConstantNumber, ConstantString, JsValueUrlKind, RequireContextValue,\n         builtin::early_replace_builtin,\n@@ -617,10 +617,13 @@ pub async fn analyse_ecmascript_module_internal(\n     analysis.set_has_side_effect_free_directive(has_side_effect_free_directive);\n \n     let is_esm = eval_context.is_esm(specified_type);\n-    let compile_time_info =\n-        compile_time_info_for_module_type(*raw_module.compile_time_info, is_esm)\n-            .to_resolved()\n-            .await?;\n+    let compile_time_info = compile_time_info_for_module_options(\n+        *raw_module.compile_time_info,\n+        is_esm,\n+        options.enable_typeof_window_inlining,\n+    )\n+    .to_resolved()\n+    .await?;\n \n     let pos = program.span().lo;\n     if analyze_types {\n@@ -1471,9 +1474,10 @@ pub async fn analyse_ecmascript_module_internal(\n }\n \n #[turbo_tasks::function]\n-async fn compile_time_info_for_module_type(\n+async fn compile_time_info_for_module_options(\n     compile_time_info: Vc<CompileTimeInfo>,\n     is_esm: bool,\n+    enable_typeof_window_inlining: Option<TypeofWindow>,\n ) -> Result<Vc<CompileTimeInfo>> {\n     let compile_time_info = compile_time_info.await?;\n     let free_var_references = compile_time_info.free_var_references;\n@@ -1584,9 +1588,33 @@ async fn compile_time_info_for_module_type(\n         } else {\n             rcstr!(\"object\").into()\n         });\n+\n+    let mut defines = compile_time_info.defines;\n+    if let Some(enable_typeof_window_inlining) = enable_typeof_window_inlining {\n+        let value = match enable_typeof_window_inlining {\n+            TypeofWindow::Object => rcstr!(\"object\"),\n+            TypeofWindow::Undefined => rcstr!(\"undefined\"),\n+        };\n+        let window = rcstr!(\"window\");\n+        let mut defines_value = defines.owned().await?;\n+        defines_value\n+            .entry(vec![\n+                DefinableNameSegment::Name(window.clone()),\n+                DefinableNameSegment::TypeOf,\n+            ])\n+            .or_insert(value.clone().into());\n+        free_var_references\n+            .entry(vec![\n+                DefinableNameSegment::Name(window),\n+                DefinableNameSegment::TypeOf,\n+            ])\n+            .or_insert(value.into());\n+        defines = CompileTimeDefines(defines_value).resolved_cell()\n+    }\n+\n     Ok(CompileTimeInfo {\n         environment: compile_time_info.environment,\n-        defines: compile_time_info.defines,\n+        defines,\n         free_var_references: FreeVarReferences(free_var_references).resolved_cell(),\n     }\n     .cell())"
        },
        {
            "sha": "4b7e9847b7efcf24d28f74983895bef24ef581ad",
            "filename": "turbopack/crates/turbopack-ecmascript/src/transform/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 21,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs?ref=d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc",
            "patch": "@@ -2,7 +2,6 @@ use std::{fmt::Debug, hash::Hash, sync::Arc};\n \n use anyhow::Result;\n use async_trait::async_trait;\n-use rustc_hash::FxHashMap;\n use swc_core::{\n     atoms::{Atom, atom},\n     base::SwcComments,\n@@ -15,7 +14,6 @@ use swc_core::{\n                 assumptions::Assumptions,\n                 helpers::{HELPERS, HelperData, Helpers},\n             },\n-            optimization::inline_globals,\n             react::react,\n         },\n         utils::IsDirective,\n@@ -44,9 +42,6 @@ pub enum EcmascriptInputTransform {\n         // swc.jsc.transform.react.runtime,\n         runtime: ResolvedVc<Option<RcStr>>,\n     },\n-    GlobalTypeofs {\n-        window_value: RcStr,\n-    },\n     // These options are subset of swc_core::ecma::transforms::typescript::Config, but\n     // it doesn't derive `Copy` so repeating values in here\n     TypeScript {\n@@ -139,22 +134,6 @@ impl EcmascriptInputTransform {\n         } = ctx;\n \n         Ok(match self {\n-            EcmascriptInputTransform::GlobalTypeofs { window_value } => {\n-                let mut typeofs: FxHashMap<Atom, Atom> = Default::default();\n-                typeofs.insert(Atom::from(\"window\"), Atom::from(&**window_value));\n-\n-                apply_transform(\n-                    program,\n-                    helpers,\n-                    inline_globals(\n-                        unresolved_mark,\n-                        Default::default(),\n-                        Default::default(),\n-                        Default::default(),\n-                        Arc::new(typeofs),\n-                    ),\n-                )\n-            }\n             EcmascriptInputTransform::React {\n                 development,\n                 refresh,"
        },
        {
            "sha": "4b999d2538d24441acecf3921993875fc7071b61",
            "filename": "turbopack/crates/turbopack/src/module_options/mod.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmod.rs?ref=d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc",
            "patch": "@@ -207,7 +207,7 @@ impl ModuleOptions {\n                     ignore_dynamic_requests,\n                     import_externals,\n                     esm_url_rewrite_behavior,\n-                    ref enable_typeof_window_inlining,\n+                    enable_typeof_window_inlining,\n                     source_maps: ecmascript_source_maps,\n                     ..\n                 },\n@@ -282,6 +282,7 @@ impl ModuleOptions {\n             extract_source_map: matches!(ecmascript_source_maps, SourceMapsType::Full),\n             keep_last_successful_parse,\n             is_tracing,\n+            enable_typeof_window_inlining,\n             ..Default::default()\n         };\n         let ecmascript_options_vc = ecmascript_options.resolved_cell();\n@@ -290,15 +291,6 @@ impl ModuleOptions {\n             postprocess.push(EcmascriptInputTransform::PresetEnv(environment));\n         }\n \n-        if let Some(enable_typeof_window_inlining) = enable_typeof_window_inlining {\n-            postprocess.push(EcmascriptInputTransform::GlobalTypeofs {\n-                window_value: match enable_typeof_window_inlining {\n-                    TypeofWindow::Object => rcstr!(\"object\"),\n-                    TypeofWindow::Undefined => rcstr!(\"undefined\"),\n-                },\n-            });\n-        }\n-\n         let ts_transform = if let Some(options) = enable_typescript_transform {\n             let options = options.await?;\n             Some(EcmascriptInputTransform::TypeScript {"
        },
        {
            "sha": "1d6a1fb78c5ddb44cdceac72bf6e7d0062a17ce6",
            "filename": "turbopack/crates/turbopack/src/module_options/module_options_context.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 8,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Fmodule_options%2Fmodule_options_context.rs?ref=d7c6ff6c872a3f2db201aced26cf1b3c21fa9cfc",
            "patch": "@@ -9,7 +9,7 @@ use turbopack_core::{\n     chunk::SourceMapsType, compile_time_info::CompileTimeInfo, condition::ContextCondition,\n     environment::Environment, resolve::options::ImportMapping,\n };\n-use turbopack_ecmascript::{TreeShakingMode, references::esm::UrlRewriteBehavior};\n+use turbopack_ecmascript::{TreeShakingMode, TypeofWindow, references::esm::UrlRewriteBehavior};\n pub use turbopack_mdx::MdxTransformOptions;\n use turbopack_node::{\n     execution_context::ExecutionContext,\n@@ -108,13 +108,6 @@ pub enum DecoratorsKind {\n     Ecma,\n }\n \n-/// The types when replacing `typeof window` with a constant.\n-#[derive(Copy, Clone, PartialEq, Eq, Debug, TraceRawVcs, Serialize, Deserialize, NonLocalValue)]\n-pub enum TypeofWindow {\n-    Object,\n-    Undefined,\n-}\n-\n /// Configuration options for the decorators transform.\n ///\n /// This is not part of Typescript transform: while there are typescript\n@@ -223,6 +216,9 @@ pub struct ModuleOptionsContext {\n #[derive(Clone, Default)]\n #[serde(default)]\n pub struct EcmascriptOptionsContext {\n+    // TODO this should just be handled via CompileTimeInfo FreeVarReferences, but then it\n+    // (currently) wouldn't be possible to have different replacement values in user code vs\n+    // node_modules.\n     pub enable_typeof_window_inlining: Option<TypeofWindow>,\n     pub enable_jsx: Option<ResolvedVc<JsxTransformOptions>>,\n     /// Follow type references and resolve declaration files in additional to"
        }
    ],
    "stats": {
        "total": 127,
        "additions": 74,
        "deletions": 53
    }
}