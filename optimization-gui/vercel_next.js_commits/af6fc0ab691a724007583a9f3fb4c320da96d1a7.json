{
    "author": "sokra",
    "message": "Turbopack: handle all side effects and improve pattern (#81455)\n\nAvoid the `let _ = task().resolve().await?` pattern.\nInstead use the `task().as_side_effect().await?` pattern.\n\nThis is much better, because the compiler will yell at you if you miss\nout the `as_side_effect()` or the `await?` due to `must_use`. In the old\npattern forgetting the `.resolve()` or the `await?` did not trigger any\nwarning but silently ignored errors.\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that\nyou follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the\nPR.\n- Read the Docs Contribution Guide to ensure your contribution follows\nthe docs guidelines:\nhttps://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc\nhttps://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See\nhttps://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See:\nhttps://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature\nrequest has been accepted for implementation before opening a PR. (A\ndiscussion must be opened, see\nhttps://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added\n(https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see\nhttps://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to\nunderstand the PR)\n- When linking to a Slack thread, you might want to share details of the\nconclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic\nbehind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "af6fc0ab691a724007583a9f3fb4c320da96d1a7",
    "files": [
        {
            "sha": "a9d131b7059555d8c27e4130a50c06df672b8275",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -947,10 +947,10 @@ pub async fn all_entrypoints_write_to_disk_operation(\n     project: ResolvedVc<ProjectContainer>,\n     app_dir_only: bool,\n ) -> Result<Vc<Entrypoints>> {\n-    let _ = project\n+    project\n         .project()\n         .emit_all_output_assets(output_assets_operation(project, app_dir_only))\n-        .resolve()\n+        .as_side_effect()\n         .await?;\n \n     Ok(project.entrypoints())"
        },
        {
            "sha": "4bd7ecc3c52f60ae4387f206a762866ad8ec2810",
            "filename": "crates/next-api/src/module_graph.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmodule_graph.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -752,7 +752,7 @@ impl GlobalBuildInformation {\n                 .collect::<FxIndexMap<_, _>>();\n             let identifier_map = ModuleNameMap(identifier_map).cell();\n \n-            let _ = graphs\n+            graphs\n                 .iter()\n                 .map(|graph| {\n                     validate_pages_css_imports(\n@@ -762,6 +762,7 @@ impl GlobalBuildInformation {\n                         app_module,\n                         identifier_map,\n                     )\n+                    .as_side_effect()\n                 })\n                 .try_join()\n                 .await?;"
        },
        {
            "sha": "f6edf44327f9da43b3c522ba4f495de86feafc6c",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 11,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -1625,25 +1625,24 @@ impl Project {\n             let node_root = self.node_root().await?.clone_value();\n \n             if let Some(map) = self.await?.versioned_content_map {\n-                let _ = map\n-                    .insert_output_assets(\n-                        all_output_assets,\n-                        node_root.clone(),\n-                        client_relative_path.clone(),\n-                        node_root.clone(),\n-                    )\n-                    .resolve()\n-                    .await?;\n+                map.insert_output_assets(\n+                    all_output_assets,\n+                    node_root.clone(),\n+                    client_relative_path.clone(),\n+                    node_root.clone(),\n+                )\n+                .as_side_effect()\n+                .await?;\n \n                 Ok(())\n             } else {\n-                let _ = emit_assets(\n+                emit_assets(\n                     all_output_assets.connect(),\n                     node_root.clone(),\n                     client_relative_path.clone(),\n                     node_root.clone(),\n                 )\n-                .resolve()\n+                .as_side_effect()\n                 .await?;\n \n                 Ok(())"
        },
        {
            "sha": "f5466441ca6795ff425e5fb126771054ff36b7aa",
            "filename": "crates/next-api/src/route.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-api%2Fsrc%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-api%2Fsrc%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Froute.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -81,9 +81,9 @@ pub async fn endpoint_write_to_disk(\n         ..\n     } = *output_op.connect().await?;\n \n-    let _ = project\n+    project\n         .emit_all_output_assets(endpoint_output_assets_operation(output_op))\n-        .resolve()\n+        .as_side_effect()\n         .await?;\n \n     Ok(*output_paths)"
        },
        {
            "sha": "695538e8e728546c772a03f70ed1e1ea7beb441e",
            "filename": "crates/next-api/src/versioned_content_map.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-api%2Fsrc%2Fversioned_content_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-api%2Fsrc%2Fversioned_content_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fversioned_content_map.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -151,13 +151,13 @@ impl VersionedContentMap {\n         });\n \n         // Make sure all written client assets are up-to-date\n-        let _ = emit_assets(\n+        emit_assets(\n             assets_operation.connect(),\n             node_root,\n             client_relative_path,\n             client_output_path,\n         )\n-        .resolve()\n+        .as_side_effect()\n         .await?;\n         let map_entry = Vc::cell(Some(MapEntry {\n             assets_operation,"
        },
        {
            "sha": "c0ded4e5172a0d2724d2cab8511ea8255559768b",
            "filename": "crates/next-core/src/emit.rs",
            "status": "modified",
            "additions": 19,
            "deletions": 12,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-core%2Fsrc%2Femit.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-core%2Fsrc%2Femit.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Femit.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -22,13 +22,13 @@ pub async fn emit_all_assets(\n     client_relative_path: FileSystemPath,\n     client_output_path: FileSystemPath,\n ) -> Result<()> {\n-    let _ = emit_assets(\n+    emit_assets(\n         all_assets_from_entries(assets),\n         node_root,\n         client_relative_path,\n         client_output_path,\n     )\n-    .resolve()\n+    .as_side_effect()\n     .await?;\n     Ok(())\n }\n@@ -45,7 +45,7 @@ pub async fn emit_assets(\n     client_relative_path: FileSystemPath,\n     client_output_path: FileSystemPath,\n ) -> Result<()> {\n-    let _: Vec<Vc<()>> = assets\n+    let _: Vec<()> = assets\n         .await?\n         .iter()\n         .copied()\n@@ -59,16 +59,16 @@ pub async fn emit_assets(\n                 let span = tracing::info_span!(\"emit asset\", name = %path.value_to_string().await?);\n                 async move {\n                     Ok(if path.is_inside_ref(&node_root) {\n-                        Some(emit(*asset))\n+                        Some(emit(*asset).as_side_effect().await?)\n                     } else if path.is_inside_ref(&client_relative_path) {\n                         // Client assets are emitted to the client output path, which is prefixed\n                         // with _next. We need to rebase them to remove that\n                         // prefix.\n-                        Some(emit_rebase(\n-                            *asset,\n-                            client_relative_path,\n-                            client_output_path,\n-                        ))\n+                        Some(\n+                            emit_rebase(*asset, client_relative_path, client_output_path)\n+                                .as_side_effect()\n+                                .await?,\n+                        )\n                     } else {\n                         None\n                     })\n@@ -84,10 +84,12 @@ pub async fn emit_assets(\n \n #[turbo_tasks::function]\n async fn emit(asset: Vc<Box<dyn OutputAsset>>) -> Result<()> {\n-    let _ = asset\n+    asset\n         .content()\n-        .write(asset.path().await?.clone_value())\n         .resolve()\n+        .await?\n+        .write(asset.path().await?.clone_value())\n+        .as_side_effect()\n         .await?;\n     Ok(())\n }\n@@ -102,7 +104,12 @@ async fn emit_rebase(\n         .await?\n         .clone_value();\n     let content = asset.content();\n-    let _ = content.resolve().await?.write(path).resolve().await?;\n+    content\n+        .resolve()\n+        .await?\n+        .write(path)\n+        .as_side_effect()\n+        .await?;\n     Ok(())\n }\n "
        },
        {
            "sha": "06c5a1a2619415fa7f0bf76263018531d77ef4d8",
            "filename": "crates/next-core/src/next_app/metadata/route.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -57,7 +57,7 @@ pub async fn get_app_metadata_route_entry(\n     mode: NextMode,\n     metadata: MetadataItem,\n     next_config: Vc<NextConfig>,\n-) -> Vc<AppEntry> {\n+) -> Result<Vc<AppEntry>> {\n     // Read original source's segment config before replacing source into\n     // dynamic|static metadata route handler.\n     let original_path = metadata.clone().into_path();\n@@ -82,30 +82,28 @@ pub async fn get_app_metadata_route_entry(\n         // remove the last /route segment of page\n         page.0.pop();\n \n-        let _ = if is_multi_dynamic {\n-            page.push(PageSegment::Dynamic(\"__metadata_id__\".into()))\n+        if is_multi_dynamic {\n+            page.push(PageSegment::Dynamic(\"__metadata_id__\".into()))?;\n         } else {\n             // if page last segment is sitemap, change to sitemap.xml\n             if page.last() == Some(&PageSegment::Static(\"sitemap\".into())) {\n                 page.0.pop();\n-                page.push(PageSegment::Static(\"sitemap.xml\".into()))\n-            } else {\n-                Ok(())\n+                page.push(PageSegment::Static(\"sitemap.xml\".into()))?\n             }\n         };\n         // Push /route back\n-        let _ = page.push(PageSegment::PageType(PageType::Route));\n+        page.push(PageSegment::PageType(PageType::Route))?;\n     };\n \n-    get_app_route_entry(\n+    Ok(get_app_route_entry(\n         nodejs_context,\n         edge_context,\n         get_app_metadata_route_source(mode, metadata, is_multi_dynamic),\n         page,\n         project_root,\n         Some(segment_config),\n         next_config,\n-    )\n+    ))\n }\n \n const CACHE_HEADER_NONE: &str = \"no-cache, no-store\";"
        },
        {
            "sha": "eb6aa3ee8679380ee4506a3a0c2bab25b08bfc83",
            "filename": "crates/next-custom-transforms/src/transforms/react_server_components.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Freact_server_components.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -154,7 +154,7 @@ impl<C: Comments> VisitMut for ReactServerComponents<C> {\n impl<C: Comments> ReactServerComponents<C> {\n     /// removes specific directive from the AST.\n     fn remove_top_level_directive(&mut self, module: &mut Module) {\n-        let _ = &module.body.retain(|item| {\n+        module.body.retain(|item| {\n             if let ModuleItem::Stmt(stmt) = item {\n                 if let Some(expr_stmt) = stmt.as_expr() {\n                     if let Expr::Lit(Lit::Str(Str { value, .. })) = &*expr_stmt.expr {"
        },
        {
            "sha": "4f8c27d45390fbc75870426ad4a1816dfb2eefa4",
            "filename": "turbopack/crates/turbo-tasks/src/vc/mod.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvc%2Fmod.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -421,6 +421,13 @@ where\n         }\n     }\n \n+    /// Runs the operation, but ignores the returned Vc. Use that when only interested in running\n+    /// the task for side effects.\n+    pub async fn as_side_effect(self) -> Result<()> {\n+        self.node.resolve().await?;\n+        Ok(())\n+    }\n+\n     /// Do not use this: Use [`Vc::to_resolved`] instead. If you must have a resolved [`Vc`] type\n     /// and not a [`ResolvedVc`] type, simply deref the result of [`Vc::to_resolved`].\n     pub async fn resolve(self) -> Result<Vc<T>> {"
        },
        {
            "sha": "0f67758abe860917eb05064fcd762601b622ac6e",
            "filename": "turbopack/crates/turbopack-core/src/asset.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fasset.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -92,16 +92,18 @@ impl AssetContent {\n         let this = self.await?;\n         match &*this {\n             AssetContent::File(file) => {\n-                let _ = path.write(**file);\n+                path.write(**file).as_side_effect().await?;\n             }\n             AssetContent::Redirect { target, link_type } => {\n-                let _ = path.write_link(\n+                path.write_link(\n                     LinkContent::Link {\n                         target: target.clone(),\n                         link_type: *link_type,\n                     }\n                     .cell(),\n-                );\n+                )\n+                .as_side_effect()\n+                .await?;\n             }\n         }\n         Ok(())"
        },
        {
            "sha": "620e1addc8f9974c022f54b5c4720eb134632f09",
            "filename": "turbopack/crates/turbopack-node/src/evaluate.rs",
            "status": "modified",
            "additions": 52,
            "deletions": 37,
            "changes": 89,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Fevaluate.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -2,7 +2,6 @@ use std::{borrow::Cow, iter, ops::ControlFlow, thread::available_parallelism, ti\n \n use anyhow::{Result, anyhow, bail};\n use async_stream::try_stream as generator;\n-use async_trait::async_trait;\n use futures::{\n     SinkExt, StreamExt,\n     channel::mpsc::{UnboundedSender, unbounded},\n@@ -181,8 +180,12 @@ async fn emit_evaluate_pool_assets_operation(\n     );\n \n     let output_root = chunking_context.output_root().await?.clone_value();\n-    let _ = emit_package_json(output_root.clone())?.resolve().await?;\n-    let _ = emit(bootstrap, output_root.clone()).resolve().await?;\n+    emit_package_json(output_root.clone())?\n+        .as_side_effect()\n+        .await?;\n+    emit(bootstrap, output_root.clone())\n+        .as_side_effect()\n+        .await?;\n \n     Ok(EmittedEvaluatePoolAssets {\n         bootstrap: bootstrap.to_resolved().await?,\n@@ -331,37 +334,47 @@ impl futures_retry::ErrorHandler<anyhow::Error> for PoolErrorHandler {\n     }\n }\n \n-#[async_trait]\n pub trait EvaluateContext {\n     type InfoMessage: DeserializeOwned;\n     type RequestMessage: DeserializeOwned;\n     type ResponseMessage: Serialize;\n     type State: Default;\n \n-    fn compute(self, sender: Vc<JavaScriptStreamSender>);\n+    fn compute(self, sender: Vc<JavaScriptStreamSender>)\n+    -> impl Future<Output = Result<()>> + Send;\n     fn pool(&self) -> OperationVc<NodeJsPool>;\n     fn keep_alive(&self) -> bool {\n         false\n     }\n     fn args(&self) -> &[ResolvedVc<JsonValue>];\n     fn cwd(&self) -> Vc<FileSystemPath>;\n-    async fn emit_error(&self, error: StructuredError, pool: &NodeJsPool) -> Result<()>;\n-    async fn info(\n+    fn emit_error(\n+        &self,\n+        error: StructuredError,\n+        pool: &NodeJsPool,\n+    ) -> impl Future<Output = Result<()>> + Send;\n+    fn info(\n         &self,\n         state: &mut Self::State,\n         data: Self::InfoMessage,\n         pool: &NodeJsPool,\n-    ) -> Result<()>;\n-    async fn request(\n+    ) -> impl Future<Output = Result<()>> + Send;\n+    fn request(\n         &self,\n         state: &mut Self::State,\n         data: Self::RequestMessage,\n         pool: &NodeJsPool,\n-    ) -> Result<Self::ResponseMessage>;\n-    async fn finish(&self, _state: Self::State, _pool: &NodeJsPool) -> Result<()>;\n+    ) -> impl Future<Output = Result<Self::ResponseMessage>> + Send;\n+    fn finish(\n+        &self,\n+        state: Self::State,\n+        pool: &NodeJsPool,\n+    ) -> impl Future<Output = Result<()>> + Send;\n }\n \n-pub fn custom_evaluate(evaluate_context: impl EvaluateContext) -> Vc<JavaScriptEvaluation> {\n+pub async fn custom_evaluate(\n+    evaluate_context: impl EvaluateContext,\n+) -> Result<Vc<JavaScriptEvaluation>> {\n     // TODO: The way we invoke compute_evaluate_stream as side effect is not\n     // GC-safe, so we disable GC for this task.\n     prevent_gc();\n@@ -385,34 +398,36 @@ pub fn custom_evaluate(evaluate_context: impl EvaluateContext) -> Vc<JavaScriptE\n     let initial = Mutex::new(Some(sender));\n \n     // run the evaluation as side effect\n-    evaluate_context.compute(\n-        JavaScriptStreamSender {\n-            get: Box::new(move || {\n-                if let Some(sender) = initial.lock().take() {\n-                    sender\n-                } else {\n-                    // In cases when only [compute_evaluate_stream] is (re)executed, we need to\n-                    // update the old stream with a new value.\n-                    let (sender, receiver) = unbounded();\n-                    cell.update(JavaScriptEvaluation(JavaScriptStream::new_open(\n-                        vec![],\n-                        Box::new(receiver),\n-                    )));\n-                    sender\n-                }\n-            }),\n-        }\n-        .cell(),\n-    );\n+    evaluate_context\n+        .compute(\n+            JavaScriptStreamSender {\n+                get: Box::new(move || {\n+                    if let Some(sender) = initial.lock().take() {\n+                        sender\n+                    } else {\n+                        // In cases when only [compute_evaluate_stream] is (re)executed, we need to\n+                        // update the old stream with a new value.\n+                        let (sender, receiver) = unbounded();\n+                        cell.update(JavaScriptEvaluation(JavaScriptStream::new_open(\n+                            vec![],\n+                            Box::new(receiver),\n+                        )));\n+                        sender\n+                    }\n+                }),\n+            }\n+            .cell(),\n+        )\n+        .await?;\n \n     let raw: RawVc = cell.into();\n-    raw.into()\n+    Ok(raw.into())\n }\n \n /// Pass the file you cared as `runtime_entries` to invalidate and reload the\n /// evaluated result automatically.\n #[turbo_tasks::function]\n-pub fn evaluate(\n+pub async fn evaluate(\n     module_asset: ResolvedVc<Box<dyn Module>>,\n     cwd: FileSystemPath,\n     env: ResolvedVc<Box<dyn ProcessEnv>>,\n@@ -423,7 +438,7 @@ pub fn evaluate(\n     args: Vec<ResolvedVc<JsonValue>>,\n     additional_invalidation: ResolvedVc<Completion>,\n     debug: bool,\n-) -> Vc<JavaScriptEvaluation> {\n+) -> Result<Vc<JavaScriptEvaluation>> {\n     custom_evaluate(BasicEvaluateContext {\n         module_asset,\n         cwd,\n@@ -436,6 +451,7 @@ pub fn evaluate(\n         additional_invalidation,\n         debug,\n     })\n+    .await\n }\n \n pub async fn compute(\n@@ -606,15 +622,14 @@ struct BasicEvaluateContext {\n     debug: bool,\n }\n \n-#[async_trait]\n impl EvaluateContext for BasicEvaluateContext {\n     type InfoMessage = ();\n     type RequestMessage = ();\n     type ResponseMessage = ();\n     type State = ();\n \n-    fn compute(self, sender: Vc<JavaScriptStreamSender>) {\n-        let _ = basic_compute(self, sender);\n+    async fn compute(self, sender: Vc<JavaScriptStreamSender>) -> Result<()> {\n+        basic_compute(self, sender).as_side_effect().await\n     }\n \n     fn pool(&self) -> OperationVc<crate::pool::NodeJsPool> {"
        },
        {
            "sha": "b1aff8cab28c488b36986da3eb98076e2ee6d0ad",
            "filename": "turbopack/crates/turbopack-node/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Flib.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -216,8 +216,8 @@ pub async fn get_renderer_pool_operation(\n ) -> Result<Vc<NodeJsPool>> {\n     emit_package_json(intermediate_output_path.clone())?.await?;\n \n-    let _ = emit(*intermediate_asset, output_root.clone())\n-        .resolve()\n+    emit(*intermediate_asset, output_root.clone())\n+        .as_side_effect()\n         .await?;\n     let assets_for_source_mapping =\n         internal_assets_for_source_mapping(*intermediate_asset, output_root.clone());"
        },
        {
            "sha": "f631da5700b9f727c92d6a09a1ee671e17a20435",
            "filename": "turbopack/crates/turbopack-node/src/transforms/webpack.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-node%2Fsrc%2Ftransforms%2Fwebpack.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -1,7 +1,6 @@\n use std::mem::take;\n \n use anyhow::{Context, Result, bail};\n-use async_trait::async_trait;\n use base64::Engine;\n use either::Either;\n use futures::try_join;\n@@ -315,10 +314,10 @@ impl WebpackLoadersProcessedAsset {\n }\n \n #[turbo_tasks::function]\n-pub(crate) fn evaluate_webpack_loader(\n+pub(crate) async fn evaluate_webpack_loader(\n     webpack_loader_context: WebpackLoaderContext,\n-) -> Vc<JavaScriptEvaluation> {\n-    custom_evaluate(webpack_loader_context)\n+) -> Result<Vc<JavaScriptEvaluation>> {\n+    custom_evaluate(webpack_loader_context).await\n }\n \n #[turbo_tasks::function]\n@@ -426,15 +425,16 @@ pub struct WebpackLoaderContext {\n     pub additional_invalidation: ResolvedVc<Completion>,\n }\n \n-#[async_trait]\n impl EvaluateContext for WebpackLoaderContext {\n     type InfoMessage = InfoMessage;\n     type RequestMessage = RequestMessage;\n     type ResponseMessage = ResponseMessage;\n     type State = Vec<LogInfo>;\n \n-    fn compute(self, sender: Vc<JavaScriptStreamSender>) {\n-        let _ = compute_webpack_loader_evaluation(self, sender);\n+    async fn compute(self, sender: Vc<JavaScriptStreamSender>) -> Result<()> {\n+        compute_webpack_loader_evaluation(self, sender)\n+            .as_side_effect()\n+            .await\n     }\n \n     fn pool(&self) -> OperationVc<crate::pool::NodeJsPool> {"
        },
        {
            "sha": "513200169b6693bf0cc24d3d2123be1902427fd4",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 26,
            "deletions": 8,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/af6fc0ab691a724007583a9f3fb4c320da96d1a7/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=af6fc0ab691a724007583a9f3fb4c320da96d1a7",
            "patch": "@@ -886,8 +886,13 @@ impl AssetContext for ModuleAssetContext {\n }\n \n #[turbo_tasks::function]\n-pub fn emit_with_completion(asset: Vc<Box<dyn OutputAsset>>, output_dir: FileSystemPath) {\n-    let _ = emit_assets_aggregated(asset, output_dir);\n+pub async fn emit_with_completion(\n+    asset: Vc<Box<dyn OutputAsset>>,\n+    output_dir: FileSystemPath,\n+) -> Result<()> {\n+    emit_assets_aggregated(asset, output_dir)\n+        .as_side_effect()\n+        .await\n }\n \n #[turbo_tasks::function(operation)]\n@@ -899,9 +904,14 @@ pub fn emit_with_completion_operation(\n }\n \n #[turbo_tasks::function]\n-fn emit_assets_aggregated(asset: Vc<Box<dyn OutputAsset>>, output_dir: FileSystemPath) {\n+async fn emit_assets_aggregated(\n+    asset: Vc<Box<dyn OutputAsset>>,\n+    output_dir: FileSystemPath,\n+) -> Result<()> {\n     let aggregated = aggregate(asset);\n-    let _ = emit_aggregated_assets(aggregated, output_dir);\n+    emit_aggregated_assets(aggregated, output_dir)\n+        .as_side_effect()\n+        .await\n }\n \n #[turbo_tasks::function]\n@@ -911,11 +921,15 @@ async fn emit_aggregated_assets(\n ) -> Result<()> {\n     match &*aggregated.content().await? {\n         AggregatedGraphNodeContent::Asset(asset) => {\n-            let _ = emit_asset_into_dir(**asset, output_dir);\n+            emit_asset_into_dir(**asset, output_dir)\n+                .as_side_effect()\n+                .await?;\n         }\n         AggregatedGraphNodeContent::Children(children) => {\n             for aggregated in children {\n-                let _ = emit_aggregated_assets(**aggregated, output_dir.clone());\n+                emit_aggregated_assets(**aggregated, output_dir.clone())\n+                    .as_side_effect()\n+                    .await?;\n             }\n         }\n     }\n@@ -924,7 +938,11 @@ async fn emit_aggregated_assets(\n \n #[turbo_tasks::function]\n pub async fn emit_asset(asset: Vc<Box<dyn OutputAsset>>) -> Result<()> {\n-    let _ = asset.content().write(asset.path().await?.clone_value());\n+    asset\n+        .content()\n+        .write(asset.path().await?.clone_value())\n+        .as_side_effect()\n+        .await?;\n \n     Ok(())\n }\n@@ -936,7 +954,7 @@ pub async fn emit_asset_into_dir(\n ) -> Result<()> {\n     let dir = output_dir.clone();\n     if asset.path().await?.is_inside_ref(&dir) {\n-        let _ = emit_asset(asset);\n+        emit_asset(asset).as_side_effect().await?;\n     }\n     Ok(())\n }"
        }
    ],
    "stats": {
        "total": 241,
        "additions": 144,
        "deletions": 97
    }
}