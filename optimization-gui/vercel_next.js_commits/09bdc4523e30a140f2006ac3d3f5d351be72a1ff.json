{
    "author": "sokra",
    "message": "Turbopack: improve incremental build performance when deployment id changes (#84460)\n\n### What?\n\n* avoid dependencies due to tracing\n* Avoid invalidating client chunking context when chunk_suffix_path changes\n* BrowserChunkingContext::chunk_path only depends on a selected subset of fields\n* select cross_origin field instead of depending on the whole config\n* select NextConfig::output field instead of depending on the whole config\n* make all next config fields private to ensure using selector functions",
    "sha": "09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
    "files": [
        {
            "sha": "63304b4b9d3f471f2a01f6335d8391570d73402a",
            "filename": "crates/next-api/src/middleware.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -157,14 +157,14 @@ impl MiddlewareEndpoint {\n             parse_segment_config_from_source(*self.await?.source, ParseSegmentMode::Base).await?;\n         let runtime = config.runtime.unwrap_or(NextRuntime::Edge);\n \n-        let next_config = this.project.next_config().await?;\n-        let has_i18n = next_config.i18n.is_some();\n-        let has_i18n_locales = next_config\n-            .i18n\n+        let next_config = this.project.next_config();\n+        let i18n = next_config.i18n().await?;\n+        let has_i18n = i18n.is_some();\n+        let has_i18n_locales = i18n\n             .as_ref()\n             .map(|i18n| i18n.locales.len() > 1)\n             .unwrap_or(false);\n-        let base_path = next_config.base_path.as_ref();\n+        let base_path = next_config.base_path().await?;\n \n         let matchers = if let Some(matchers) = config.middleware_matcher.as_ref() {\n             matchers\n@@ -202,7 +202,7 @@ impl MiddlewareEndpoint {\n \n                     source.insert_str(0, \"/:nextData(_next/data/[^/]{1,})?\");\n \n-                    if let Some(base_path) = base_path {\n+                    if let Some(base_path) = base_path.as_ref() {\n                         source.insert_str(0, base_path);\n                     }\n "
        },
        {
            "sha": "9caa4f904faed2db810274df1fafb550ecd9e574",
            "filename": "crates/next-api/src/nft_json.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnft_json.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -408,7 +408,9 @@ pub async fn all_assets_from_entries_filtered(\n                         Ok((\n                             *asset,\n                             if emit_spans {\n-                                Some(asset.path().to_string().await?)\n+                                // INVALIDATION: we don't need to invalidate the list of assets when\n+                                // the span name changes\n+                                Some(asset.path_string().untracked().await?)\n                             } else {\n                                 None\n                             },\n@@ -498,7 +500,9 @@ async fn get_referenced_server_assets(\n             Ok(Some((\n                 *asset,\n                 if emit_spans {\n-                    Some(asset.path().to_string().await?)\n+                    // INVALIDATION: we don't need to invalidate the list of assets when the span\n+                    // name changes\n+                    Some(asset.path_string().untracked().await?)\n                 } else {\n                     None\n                 },"
        },
        {
            "sha": "2d1328f9dcf5139f82ee7e50885d4d2154315f84",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 29,
            "deletions": 13,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -479,8 +479,8 @@ impl ProjectContainer {\n         }\n \n         let dist_dir = next_config\n+            .dist_dir()\n             .await?\n-            .dist_dir\n             .as_ref()\n             .map_or_else(|| rcstr!(\".next\"), |d| d.clone());\n \n@@ -722,13 +722,17 @@ impl Project {\n \n     #[turbo_tasks::function]\n     pub async fn client_relative_path(self: Vc<Self>) -> Result<Vc<FileSystemPath>> {\n-        let next_config = self.next_config().await?;\n+        let next_config = self.next_config();\n         Ok(self\n             .client_root()\n             .await?\n             .join(&format!(\n                 \"{}/_next\",\n-                next_config.base_path.clone().unwrap_or_default(),\n+                next_config\n+                    .base_path()\n+                    .await?\n+                    .as_deref()\n+                    .unwrap_or_default(),\n             ))?\n             .cell())\n     }\n@@ -1156,26 +1160,38 @@ impl Project {\n             *config.persistent_caching_enabled().await?,\n         );\n \n-        let config = &config.await?;\n-\n-        emit_event(\"modularizeImports\", config.modularize_imports.is_some());\n-        emit_event(\"transpilePackages\", config.transpile_packages.is_some());\n+        emit_event(\n+            \"modularizeImports\",\n+            !config.modularize_imports().await?.is_empty(),\n+        );\n+        emit_event(\n+            \"transpilePackages\",\n+            !config.transpile_packages().await?.is_empty(),\n+        );\n         emit_event(\"turbotrace\", false);\n \n         // compiler options\n-        let compiler_options = config.compiler.as_ref();\n-        let swc_relay_enabled = compiler_options.and_then(|c| c.relay.as_ref()).is_some();\n+        let compiler_options = config.compiler().await?;\n+        let swc_relay_enabled = compiler_options.relay.is_some();\n         let styled_components_enabled = compiler_options\n-            .and_then(|c| c.styled_components.as_ref().map(|sc| sc.is_enabled()))\n+            .styled_components\n+            .as_ref()\n+            .map(|sc| sc.is_enabled())\n             .unwrap_or_default();\n         let react_remove_properties_enabled = compiler_options\n-            .and_then(|c| c.react_remove_properties.as_ref().map(|rc| rc.is_enabled()))\n+            .react_remove_properties\n+            .as_ref()\n+            .map(|rc| rc.is_enabled())\n             .unwrap_or_default();\n         let remove_console_enabled = compiler_options\n-            .and_then(|c| c.remove_console.as_ref().map(|rc| rc.is_enabled()))\n+            .remove_console\n+            .as_ref()\n+            .map(|rc| rc.is_enabled())\n             .unwrap_or_default();\n         let emotion_enabled = compiler_options\n-            .and_then(|c| c.emotion.as_ref().map(|e| e.is_enabled()))\n+            .emotion\n+            .as_ref()\n+            .map(|e| e.is_enabled())\n             .unwrap_or_default();\n \n         emit_event(\"swcRelay\", swc_relay_enabled);"
        },
        {
            "sha": "d92a124d909e1f03e4e662dc97120e261bed4423",
            "filename": "crates/next-core/src/emit.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 3,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Femit.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Femit.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Femit.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -2,7 +2,7 @@ use anyhow::Result;\n use tracing::{Instrument, Level, Span};\n use turbo_rcstr::RcStr;\n use turbo_tasks::{\n-    FxIndexSet, ReadRef, ResolvedVc, TryFlatJoinIterExt, TryJoinIterExt, ValueToString, Vc,\n+    FxIndexSet, ReadRef, ResolvedVc, TryFlatJoinIterExt, TryJoinIterExt, Vc,\n     graph::{AdjacencyMap, GraphTraversal, Visit, VisitControlFlow},\n };\n use turbo_tasks_fs::{FileSystemPath, rebase};\n@@ -161,7 +161,9 @@ pub async fn all_assets_from_entries(entries: Vc<OutputAssets>) -> Result<Vc<Out\n                         Ok((\n                             *asset,\n                             if emit_spans {\n-                                Some(asset.path().to_string().await?)\n+                                // INVALIDATION: we don't need to invalidate when the span name\n+                                // changes\n+                                Some(asset.path_string().untracked().await?)\n                             } else {\n                                 None\n                             },\n@@ -195,7 +197,9 @@ async fn get_referenced_assets(\n             Ok((\n                 *asset,\n                 if emit_spans {\n-                    Some(asset.path().to_string().await?)\n+                    // INVALIDATION: we don't need to invalidate the list of assets when the span\n+                    // name changes\n+                    Some(asset.path_string().untracked().await?)\n                 } else {\n                     None\n                 },"
        },
        {
            "sha": "a95fd69c1820e3e9f368aa079dfb12bd877fbdda",
            "filename": "crates/next-core/src/next_app/app_page_entry.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -48,7 +48,7 @@ pub async fn get_app_page_entry(\n     let server_component_transition =\n         ResolvedVc::upcast(NextServerComponentTransition::new().to_resolved().await?);\n \n-    let base_path = next_config.await?.base_path.clone();\n+    let base_path = next_config.base_path().owned().await?;\n     let loader_tree = AppPageLoaderTreeModule::build(\n         loader_tree,\n         module_asset_context,"
        },
        {
            "sha": "a6468b47ff7309ab6acefbc9b9b1f2007a6e524f",
            "filename": "crates/next-core/src/next_app/app_route_entry.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -60,8 +60,8 @@ pub async fn get_app_route_entry(\n     let inner = rcstr!(\"INNER_APP_ROUTE\");\n \n     let output_type: &str = next_config\n+        .output()\n         .await?\n-        .output\n         .as_ref()\n         .map(|o| match o {\n             OutputType::Standalone => \"\\\"standalone\\\"\","
        },
        {
            "sha": "4830c856d8d4b759ef29362b3ef08ffa29ba2d10",
            "filename": "crates/next-core/src/next_client/context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client%2Fcontext.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -447,7 +447,7 @@ pub async fn get_client_chunking_context(\n \n     let next_mode = mode.await?;\n     let asset_prefix = asset_prefix.owned().await?;\n-    let chunk_suffix_path = chunk_suffix_path.owned().await?;\n+    let chunk_suffix_path = chunk_suffix_path.to_resolved().await?;\n     let mut builder = BrowserChunkingContext::builder(\n         root_path,\n         client_root.clone(),"
        },
        {
            "sha": "959c86b440f0b4901a846116486e990ace9013c6",
            "filename": "crates/next-core/src/next_client_reference/visit_client_reference.rs",
            "status": "modified",
            "additions": 47,
            "deletions": 13,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -3,10 +3,10 @@ use std::future::Future;\n use anyhow::Result;\n use rustc_hash::FxHashSet;\n use serde::{Deserialize, Serialize};\n-use tracing::Instrument;\n+use tracing::{Instrument, Level, Span};\n use turbo_rcstr::RcStr;\n use turbo_tasks::{\n-    FxIndexSet, NonLocalValue, ReadRef, ResolvedVc, TryJoinIterExt, ValueToString, Vc,\n+    FxIndexSet, NonLocalValue, ReadRef, ResolvedVc, TryJoinIterExt, Vc,\n     debug::ValueDebugFormat,\n     graph::{AdjacencyMap, GraphTraversal, Visit, VisitControlFlow},\n     trace::TraceRawVcs,\n@@ -121,14 +121,23 @@ pub async fn find_server_entries(\n     include_traced: bool,\n ) -> Result<Vc<ServerEntries>> {\n     async move {\n+        let emit_spans = tracing::enabled!(Level::INFO);\n         let graph = AdjacencyMap::new()\n             .skip_duplicates()\n             .visit(\n                 vec![FindServerEntriesNode::Internal(\n                     entry,\n-                    entry.ident().to_string().await?,\n+                    if emit_spans {\n+                        // INVALIDATION: we don't need to invalidate when the span name changes\n+                        Some(entry.ident_string().untracked().await?)\n+                    } else {\n+                        None\n+                    },\n                 )],\n-                FindServerEntries { include_traced },\n+                FindServerEntries {\n+                    include_traced,\n+                    emit_spans,\n+                },\n             )\n             .await\n             .completed()?\n@@ -161,6 +170,7 @@ pub async fn find_server_entries(\n struct FindServerEntries {\n     /// Whether to walk ChunkingType::Traced references\n     include_traced: bool,\n+    emit_spans: bool,\n }\n \n #[derive(\n@@ -177,9 +187,12 @@ struct FindServerEntries {\n )]\n enum FindServerEntriesNode {\n     ClientReference,\n-    ServerComponentEntry(ResolvedVc<NextServerComponentModule>, ReadRef<RcStr>),\n-    ServerUtilEntry(ResolvedVc<NextServerUtilityModule>, ReadRef<RcStr>),\n-    Internal(ResolvedVc<Box<dyn Module>>, ReadRef<RcStr>),\n+    ServerComponentEntry(\n+        ResolvedVc<NextServerComponentModule>,\n+        Option<ReadRef<RcStr>>,\n+    ),\n+    ServerUtilEntry(ResolvedVc<NextServerUtilityModule>, Option<ReadRef<RcStr>>),\n+    Internal(ResolvedVc<Box<dyn Module>>, Option<ReadRef<RcStr>>),\n }\n \n impl Visit<FindServerEntriesNode> for FindServerEntries {\n@@ -208,6 +221,7 @@ impl Visit<FindServerEntriesNode> for FindServerEntries {\n             FindServerEntriesNode::ServerUtilEntry(module, _) => Vc::upcast(**module),\n             FindServerEntriesNode::ServerComponentEntry(module, _) => Vc::upcast(**module),\n         };\n+        let emit_spans = self.emit_spans;\n         async move {\n             // Pass include_traced to reuse the same cached `primary_chunkable_referenced_modules`\n             // task result, but the traced references will be filtered out again afterwards.\n@@ -235,7 +249,13 @@ impl Visit<FindServerEntriesNode> for FindServerEntries {\n                     {\n                         return Ok(FindServerEntriesNode::ServerComponentEntry(\n                             server_component_asset,\n-                            server_component_asset.ident().to_string().await?,\n+                            if emit_spans {\n+                                // INVALIDATION: we don't need to invalidate when the span name\n+                                // changes\n+                                Some(server_component_asset.ident_string().untracked().await?)\n+                            } else {\n+                                None\n+                            },\n                         ));\n                     }\n \n@@ -244,13 +264,24 @@ impl Visit<FindServerEntriesNode> for FindServerEntries {\n                     {\n                         return Ok(FindServerEntriesNode::ServerUtilEntry(\n                             server_util_module,\n-                            module.ident().to_string().await?,\n+                            if emit_spans {\n+                                // INVALIDATION: we don't need to invalidate when the span name\n+                                // changes\n+                                Some(module.ident_string().untracked().await?)\n+                            } else {\n+                                None\n+                            },\n                         ));\n                     }\n \n                     Ok(FindServerEntriesNode::Internal(\n                         *module,\n-                        module.ident().to_string().await?,\n+                        if emit_spans {\n+                            // INVALIDATION: we don't need to invalidate when the span name changes\n+                            Some(module.ident_string().untracked().await?)\n+                        } else {\n+                            None\n+                        },\n                     ))\n                 });\n \n@@ -261,18 +292,21 @@ impl Visit<FindServerEntriesNode> for FindServerEntries {\n     }\n \n     fn span(&mut self, node: &FindServerEntriesNode) -> tracing::Span {\n+        if !self.emit_spans {\n+            return Span::current();\n+        }\n         match node {\n             FindServerEntriesNode::ClientReference => {\n                 tracing::info_span!(\"client reference\")\n             }\n             FindServerEntriesNode::Internal(_, name) => {\n-                tracing::info_span!(\"module\", name = display(name))\n+                tracing::info_span!(\"module\", name = display(name.as_ref().unwrap()))\n             }\n             FindServerEntriesNode::ServerUtilEntry(_, name) => {\n-                tracing::info_span!(\"server util\", name = display(name))\n+                tracing::info_span!(\"server util\", name = display(name.as_ref().unwrap()))\n             }\n             FindServerEntriesNode::ServerComponentEntry(_, name) => {\n-                tracing::info_span!(\"layout segment\", name = display(name))\n+                tracing::info_span!(\"layout segment\", name = display(name.as_ref().unwrap()))\n             }\n         }\n     }"
        },
        {
            "sha": "937e565c86e3ea4741e8af2a4732fe6f9b614a5d",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 76,
            "deletions": 37,
            "changes": 113,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -75,40 +75,40 @@ impl Default for CacheKinds {\n #[derive(Clone, Debug, Default, PartialEq)]\n #[serde(default, rename_all = \"camelCase\")]\n pub struct NextConfig {\n-    // TODO all fields should be private and access should be wrapped within a turbo-tasks function\n-    // Otherwise changing NextConfig will lead to invalidating all tasks accessing it.\n-    pub config_file: Option<RcStr>,\n-    pub config_file_name: RcStr,\n+    // IMPORTANT: all fields should be private and access should be wrapped within a turbo-tasks\n+    // function. Otherwise changing NextConfig will lead to invalidating all tasks accessing it.\n+    config_file: Option<RcStr>,\n+    config_file_name: RcStr,\n \n     /// In-memory cache size in bytes.\n     ///\n     /// If `cache_max_memory_size: 0` disables in-memory caching.\n-    pub cache_max_memory_size: Option<f64>,\n+    cache_max_memory_size: Option<f64>,\n     /// custom path to a cache handler to use\n-    pub cache_handler: Option<RcStr>,\n-\n-    pub env: FxIndexMap<String, JsonValue>,\n-    pub experimental: ExperimentalConfig,\n-    pub images: ImageConfig,\n-    pub page_extensions: Vec<RcStr>,\n-    pub react_compiler: Option<ReactCompilerOptionsOrBoolean>,\n-    pub react_production_profiling: Option<bool>,\n-    pub react_strict_mode: Option<bool>,\n-    pub transpile_packages: Option<Vec<RcStr>>,\n-    pub modularize_imports: Option<FxIndexMap<String, ModularizeImportPackageConfig>>,\n-    pub dist_dir: Option<RcStr>,\n-    pub deployment_id: Option<RcStr>,\n+    cache_handler: Option<RcStr>,\n+\n+    env: FxIndexMap<String, JsonValue>,\n+    experimental: ExperimentalConfig,\n+    images: ImageConfig,\n+    page_extensions: Vec<RcStr>,\n+    react_compiler: Option<ReactCompilerOptionsOrBoolean>,\n+    react_production_profiling: Option<bool>,\n+    react_strict_mode: Option<bool>,\n+    transpile_packages: Option<Vec<RcStr>>,\n+    modularize_imports: Option<FxIndexMap<String, ModularizeImportPackageConfig>>,\n+    dist_dir: Option<RcStr>,\n+    deployment_id: Option<RcStr>,\n     sass_options: Option<serde_json::Value>,\n-    pub trailing_slash: Option<bool>,\n-    pub asset_prefix: Option<RcStr>,\n-    pub base_path: Option<RcStr>,\n-    pub skip_middleware_url_normalize: Option<bool>,\n-    pub skip_trailing_slash_redirect: Option<bool>,\n-    pub i18n: Option<I18NConfig>,\n-    pub cross_origin: Option<CrossOriginConfig>,\n-    pub dev_indicators: Option<DevIndicatorsConfig>,\n-    pub output: Option<OutputType>,\n-    pub turbopack: Option<TurbopackConfig>,\n+    trailing_slash: Option<bool>,\n+    asset_prefix: Option<RcStr>,\n+    base_path: Option<RcStr>,\n+    skip_middleware_url_normalize: Option<bool>,\n+    skip_trailing_slash_redirect: Option<bool>,\n+    i18n: Option<I18NConfig>,\n+    cross_origin: Option<CrossOriginConfig>,\n+    dev_indicators: Option<DevIndicatorsConfig>,\n+    output: Option<OutputType>,\n+    turbopack: Option<TurbopackConfig>,\n     production_browser_source_maps: bool,\n     output_file_tracing_includes: Option<serde_json::Value>,\n     output_file_tracing_excludes: Option<serde_json::Value>,\n@@ -119,21 +119,21 @@ pub struct NextConfig {\n     /// server-side bundles.\n     ///\n     /// [API Reference](https://nextjs.org/docs/pages/api-reference/next-config-js/bundlePagesRouterDependencies)\n-    pub bundle_pages_router_dependencies: Option<bool>,\n+    bundle_pages_router_dependencies: Option<bool>,\n \n     /// A list of packages that should be treated as external on the server\n     /// build.\n     ///\n     /// [API Reference](https://nextjs.org/docs/app/api-reference/next-config-js/serverExternalPackages)\n-    pub server_external_packages: Option<Vec<RcStr>>,\n+    server_external_packages: Option<Vec<RcStr>>,\n \n     #[serde(rename = \"_originalRedirects\")]\n-    pub original_redirects: Option<Vec<Redirect>>,\n+    original_redirects: Option<Vec<Redirect>>,\n \n     // Partially supported\n-    pub compiler: Option<CompilerConfig>,\n+    compiler: Option<CompilerConfig>,\n \n-    pub optimize_fonts: Option<bool>,\n+    optimize_fonts: Option<bool>,\n \n     clean_dist_dir: bool,\n     compress: bool,\n@@ -157,14 +157,17 @@ pub struct NextConfig {\n }\n \n #[derive(\n-    Clone, Debug, PartialEq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n+    Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n )]\n #[serde(rename_all = \"kebab-case\")]\n pub enum CrossOriginConfig {\n     Anonymous,\n     UseCredentials,\n }\n \n+#[turbo_tasks::value(transparent)]\n+pub struct OptionCrossOriginConfig(Option<CrossOriginConfig>);\n+\n #[derive(\n     Clone,\n     Debug,\n@@ -262,7 +265,7 @@ struct HttpAgentConfig {\n }\n \n #[derive(\n-    Clone, Debug, PartialEq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n+    Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n )]\n #[serde(rename_all = \"camelCase\")]\n pub struct DomainLocale {\n@@ -273,7 +276,7 @@ pub struct DomainLocale {\n }\n \n #[derive(\n-    Clone, Debug, PartialEq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n+    Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n )]\n #[serde(rename_all = \"camelCase\")]\n pub struct I18NConfig {\n@@ -283,15 +286,21 @@ pub struct I18NConfig {\n     pub locales: Vec<String>,\n }\n \n+#[turbo_tasks::value(transparent)]\n+pub struct OptionI18NConfig(Option<I18NConfig>);\n+\n #[derive(\n-    Clone, Debug, PartialEq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n+    Clone, Debug, PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, NonLocalValue, OperationValue,\n )]\n #[serde(rename_all = \"kebab-case\")]\n pub enum OutputType {\n     Standalone,\n     Export,\n }\n \n+#[turbo_tasks::value(transparent)]\n+pub struct OptionOutputType(Option<OutputType>);\n+\n #[derive(\n     Debug,\n     Clone,\n@@ -1330,6 +1339,11 @@ impl NextConfig {\n         Vc::cell(self.output == Some(OutputType::Standalone))\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn base_path(&self) -> Vc<Option<RcStr>> {\n+        Vc::cell(self.base_path.clone())\n+    }\n+\n     #[turbo_tasks::function]\n     pub fn cache_handler(&self, project_path: FileSystemPath) -> Result<Vc<OptionFileSystemPath>> {\n         if let Some(handler) = &self.cache_handler {\n@@ -1531,6 +1545,11 @@ impl NextConfig {\n         }))\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn inline_css(&self) -> Vc<bool> {\n+        Vc::cell(self.experimental.inline_css.unwrap_or(false))\n+    }\n+\n     #[turbo_tasks::function]\n     pub fn mdx_rs(&self) -> Vc<OptionalMdxTransformOptions> {\n         let options = &self.experimental.mdx_rs;\n@@ -1566,6 +1585,11 @@ impl NextConfig {\n         Vc::cell(self.modularize_imports.clone().unwrap_or_default())\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn dist_dir(&self) -> Vc<Option<RcStr>> {\n+        Vc::cell(self.dist_dir.clone())\n+    }\n+\n     #[turbo_tasks::function]\n     pub fn experimental_cache_handlers(\n         &self,\n@@ -1857,6 +1881,21 @@ impl NextConfig {\n         ))\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn cross_origin(&self) -> Vc<OptionCrossOriginConfig> {\n+        Vc::cell(self.cross_origin.clone())\n+    }\n+\n+    #[turbo_tasks::function]\n+    pub fn i18n(&self) -> Vc<OptionI18NConfig> {\n+        Vc::cell(self.i18n.clone())\n+    }\n+\n+    #[turbo_tasks::function]\n+    pub fn output(&self) -> Vc<OptionOutputType> {\n+        Vc::cell(self.output.clone())\n+    }\n+\n     #[turbo_tasks::function]\n     pub fn output_file_tracing_includes(&self) -> Vc<OptionJsonValue> {\n         Vc::cell(self.output_file_tracing_includes.clone())"
        },
        {
            "sha": "960ee9703dd33a2b54671893b4bbbe3fa78e0a1d",
            "filename": "crates/next-core/src/next_manifests/client_reference_manifest.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 7,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_manifests%2Fclient_reference_manifest.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -175,11 +175,7 @@ async fn build_manifest(\n         // TODO: Add `suffix` to the manifest for React to use.\n         // entry_manifest.module_loading.prefix = prefix_path;\n \n-        entry_manifest.module_loading.cross_origin = next_config\n-            .await?\n-            .cross_origin\n-            .as_ref()\n-            .map(|p| p.to_owned());\n+        entry_manifest.module_loading.cross_origin = next_config.cross_origin().owned().await?;\n         let ClientReferencesChunks {\n             client_component_client_chunks,\n             layout_segment_client_chunks,\n@@ -442,8 +438,7 @@ async fn build_manifest(\n                 cached_chunk_paths(&mut client_chunk_path_cache, client_chunks.iter().copied())\n                     .await?;\n             // Inlining breaks HMR so it is always disabled in dev.\n-            let inlined_css =\n-                next_config.await?.experimental.inline_css.unwrap_or(false) && mode.is_production();\n+            let inlined_css = *next_config.inline_css().await? && mode.is_production();\n \n             for (chunk, chunk_path) in client_chunks_with_path {\n                 if let Some(path) = client_relative_path.get_path_to(&chunk_path) {"
        },
        {
            "sha": "f8903e058525b62e41506641dcb55fa6c17ce7e5",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 35,
            "deletions": 9,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -125,8 +125,8 @@ impl BrowserChunkingContextBuilder {\n         self\n     }\n \n-    pub fn chunk_suffix_path(mut self, chunk_suffix_path: Option<RcStr>) -> Self {\n-        self.chunking_context.chunk_suffix_path = chunk_suffix_path;\n+    pub fn chunk_suffix_path(mut self, chunk_suffix_path: ResolvedVc<Option<RcStr>>) -> Self {\n+        self.chunking_context.chunk_suffix_path = Some(chunk_suffix_path);\n         self\n     }\n \n@@ -222,7 +222,7 @@ pub struct BrowserChunkingContext {\n     chunk_base_path: Option<RcStr>,\n     /// Suffix path that will be appended to all chunk URLs when loading them.\n     /// This path will not appear in chunk paths or chunk data.\n-    chunk_suffix_path: Option<RcStr>,\n+    chunk_suffix_path: Option<ResolvedVc<Option<RcStr>>>,\n     /// URL prefix that will be prepended to all static asset URLs when loading\n     /// them.\n     asset_base_path: Option<RcStr>,\n@@ -381,7 +381,11 @@ impl BrowserChunkingContext {\n     /// Returns the asset suffix path.\n     #[turbo_tasks::function]\n     pub fn chunk_suffix_path(&self) -> Vc<Option<RcStr>> {\n-        Vc::cell(self.chunk_suffix_path.clone())\n+        if let Some(chunk_suffix_path) = self.chunk_suffix_path {\n+            *chunk_suffix_path\n+        } else {\n+            Vc::cell(None)\n+        }\n     }\n \n     /// Returns the source map type.\n@@ -395,6 +399,17 @@ impl BrowserChunkingContext {\n     pub fn minify_type(&self) -> Vc<MinifyType> {\n         self.minify_type.cell()\n     }\n+\n+    /// Returns the chunk path information.\n+    #[turbo_tasks::function]\n+    fn chunk_path_info(&self) -> Vc<ChunkPathInfo> {\n+        ChunkPathInfo {\n+            root_path: self.root_path.clone(),\n+            chunk_root_path: self.chunk_root_path.clone(),\n+            content_hashing: self.content_hashing,\n+        }\n+        .cell()\n+    }\n }\n \n #[turbo_tasks::value_impl]\n@@ -435,7 +450,7 @@ impl ChunkingContext for BrowserChunkingContext {\n \n     #[turbo_tasks::function]\n     async fn chunk_path(\n-        &self,\n+        self: Vc<Self>,\n         asset: Option<Vc<Box<dyn Asset>>>,\n         ident: Vc<AssetIdent>,\n         prefix: Option<RcStr>,\n@@ -445,11 +460,15 @@ impl ChunkingContext for BrowserChunkingContext {\n             extension.starts_with(\".\"),\n             \"`extension` should include the leading '.', got '{extension}'\"\n         );\n-        let root_path = self.chunk_root_path.clone();\n-        let name = match self.content_hashing {\n+        let ChunkPathInfo {\n+            chunk_root_path,\n+            content_hashing,\n+            root_path,\n+        } = &*self.chunk_path_info().await?;\n+        let name = match *content_hashing {\n             None => {\n                 ident\n-                    .output_name(self.root_path.clone(), prefix, extension)\n+                    .output_name(root_path.clone(), prefix, extension)\n                     .owned()\n                     .await?\n             }\n@@ -474,7 +493,7 @@ impl ChunkingContext for BrowserChunkingContext {\n                 }\n             }\n         };\n-        Ok(root_path.join(&name)?.cell())\n+        Ok(chunk_root_path.join(&name)?.cell())\n     }\n \n     #[turbo_tasks::function]\n@@ -794,3 +813,10 @@ impl ChunkingContext for BrowserChunkingContext {\n         Ok(Vc::cell(self.await?.debug_ids))\n     }\n }\n+\n+#[turbo_tasks::value]\n+struct ChunkPathInfo {\n+    root_path: FileSystemPath,\n+    chunk_root_path: FileSystemPath,\n+    content_hashing: Option<ContentHashing>,\n+}"
        },
        {
            "sha": "1da1e018ea56192b95648d1dfc3ac6124c4c8e11",
            "filename": "turbopack/crates/turbopack-core/src/module.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -1,4 +1,5 @@\n-use turbo_tasks::{ResolvedVc, TaskInput, Vc};\n+use turbo_rcstr::RcStr;\n+use turbo_tasks::{ResolvedVc, TaskInput, ValueToString, Vc};\n \n use crate::{asset::Asset, ident::AssetIdent, reference::ModuleReferences};\n \n@@ -18,6 +19,13 @@ pub trait Module: Asset {\n     #[turbo_tasks::function]\n     fn ident(&self) -> Vc<AssetIdent>;\n \n+    /// The identifier of the [Module] as string. It's expected to be unique and capture\n+    /// all properties of the [Module].\n+    #[turbo_tasks::function]\n+    fn ident_string(self: Vc<Self>) -> Vc<RcStr> {\n+        self.ident().to_string()\n+    }\n+\n     /// Other [Module]s or [OutputAsset]s referenced from this [Module].\n     // TODO refactor to avoid returning [OutputAsset]s here\n     #[turbo_tasks::function]"
        },
        {
            "sha": "986d9fe05c509784ed4cf73ba954672363ff2456",
            "filename": "turbopack/crates/turbopack-core/src/module_graph/mod.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fmodule_graph%2Fmod.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -1702,7 +1702,8 @@ impl SingleModuleGraphBuilderNode {\n         Ok(Self::Module {\n             module,\n             ident: if emit_spans {\n-                Some(ident.to_string().await?)\n+                // INVALIDATION: we don't need to invalidate when the span name changes\n+                Some(ident.to_string().untracked().await?)\n             } else {\n                 None\n             },\n@@ -1718,13 +1719,15 @@ impl SingleModuleGraphBuilderNode {\n             ref_data,\n             source,\n             source_ident: if emit_spans {\n-                Some(source.ident().to_string().await?)\n+                // INVALIDATION: we don't need to invalidate when the span name changes\n+                Some(source.ident_string().untracked().await?)\n             } else {\n                 None\n             },\n             target,\n             target_ident: if emit_spans {\n-                Some(target.ident().to_string().await?)\n+                // INVALIDATION: we don't need to invalidate when the span name changes\n+                Some(target.ident_string().untracked().await?)\n             } else {\n                 None\n             },"
        },
        {
            "sha": "111ced479be425571a5438496b4303f7c5fa056d",
            "filename": "turbopack/crates/turbopack-core/src/output.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Foutput.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/09bdc4523e30a140f2006ac3d3f5d351be72a1ff/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Foutput.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Foutput.rs?ref=09bdc4523e30a140f2006ac3d3f5d351be72a1ff",
            "patch": "@@ -1,5 +1,6 @@\n use anyhow::Result;\n-use turbo_tasks::{FxIndexSet, ResolvedVc, Vc};\n+use turbo_rcstr::RcStr;\n+use turbo_tasks::{FxIndexSet, ResolvedVc, ValueToString, Vc};\n use turbo_tasks_fs::FileSystemPath;\n \n use crate::asset::Asset;\n@@ -16,6 +17,13 @@ pub trait OutputAsset: Asset {\n     #[turbo_tasks::function]\n     fn path(&self) -> Vc<FileSystemPath>;\n \n+    /// The identifier of the [OutputAsset] as string. It's expected to be unique and\n+    /// capture all properties of the [OutputAsset].\n+    #[turbo_tasks::function]\n+    async fn path_string(self: Vc<Self>) -> Result<Vc<RcStr>> {\n+        Ok(self.path().resolve().await?.to_string())\n+    }\n+\n     /// Other references [OutputAsset]s from this [OutputAsset].\n     #[turbo_tasks::function]\n     fn references(self: Vc<Self>) -> Vc<OutputAssets> {"
        }
    ],
    "stats": {
        "total": 333,
        "additions": 235,
        "deletions": 98
    }
}