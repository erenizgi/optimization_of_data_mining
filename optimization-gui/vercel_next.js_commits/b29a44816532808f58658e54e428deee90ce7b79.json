{
    "author": "ztanner",
    "message": "remove direct ip/port bypass in dev origin check (#77414)\n\nIt's potentially unsafe to allow any sort of origin bypass if `allowedDevOrigins` is configured as it's trivial to stand up a remote server on the same port. This removes the case that would bypass the origin check.",
    "sha": "b29a44816532808f58658e54e428deee90ce7b79",
    "files": [
        {
            "sha": "bc808b253279626b1af807876fed286967f84ece",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 16,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/b29a44816532808f58658e54e428deee90ce7b79/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b29a44816532808f58658e54e428deee90ce7b79/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=b29a44816532808f58658e54e428deee90ce7b79",
            "patch": "@@ -323,15 +323,7 @@ export async function initialize(opts: {\n \n       // handle hot-reloader first\n       if (developmentBundler) {\n-        if (\n-          blockCrossSite(\n-            req,\n-            res,\n-            config.allowedDevOrigins,\n-            opts.hostname,\n-            `${opts.port}`\n-          )\n-        ) {\n+        if (blockCrossSite(req, res, config.allowedDevOrigins, opts.hostname)) {\n           return\n         }\n         const origUrl = req.url || '/'\n@@ -698,13 +690,7 @@ export async function initialize(opts: {\n \n       if (opts.dev && developmentBundler && req.url) {\n         if (\n-          blockCrossSite(\n-            req,\n-            socket,\n-            config.allowedDevOrigins,\n-            opts.hostname,\n-            `${opts.port}`\n-          )\n+          blockCrossSite(req, socket, config.allowedDevOrigins, opts.hostname)\n         ) {\n           return\n         }"
        },
        {
            "sha": "47562bbd8101ed5ca2871398b593cc730525c4c7",
            "filename": "packages/next/src/server/lib/router-utils/block-cross-site.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 13,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/b29a44816532808f58658e54e428deee90ce7b79/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b29a44816532808f58658e54e428deee90ce7b79/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fblock-cross-site.ts?ref=b29a44816532808f58658e54e428deee90ce7b79",
            "patch": "@@ -1,7 +1,6 @@\n import type { Duplex } from 'stream'\n import type { IncomingMessage, ServerResponse } from 'webpack-dev-server'\n import { parseUrl } from '../../../lib/url'\n-import net from 'net'\n import { warnOnce } from '../../../build/output/log'\n import { isCsrfOriginAllowed } from '../../app-render/csrf-protection'\n \n@@ -36,8 +35,7 @@ export const blockCrossSite = (\n   req: IncomingMessage,\n   res: ServerResponse | Duplex,\n   allowedDevOrigins: string[] | undefined,\n-  hostname: string | undefined,\n-  activePort: string\n+  hostname: string | undefined\n ): boolean => {\n   // in the future, these will be blocked by default when allowed origins aren't configured.\n   // for now, we warn when allowed origins aren't configured\n@@ -52,7 +50,7 @@ export const blockCrossSite = (\n     allowedOrigins.push(hostname)\n   }\n \n-  // only process _next URLs when\n+  // only process _next URLs\n   if (!req.url?.includes('/_next')) {\n     return false\n   }\n@@ -73,16 +71,8 @@ export const blockCrossSite = (\n \n     if (parsedOrigin) {\n       const originLowerCase = parsedOrigin.hostname.toLowerCase()\n-      const isMatchingPort = parsedOrigin.port === activePort\n-      const isIpRequest =\n-        net.isIPv4(originLowerCase) || net.isIPv6(originLowerCase)\n \n-      if (\n-        // allow requests if direct IP and matching port and\n-        // allow if any of the allowed origins match\n-        !(isIpRequest && isMatchingPort) &&\n-        !isCsrfOriginAllowed(originLowerCase, allowedOrigins)\n-      ) {\n+      if (!isCsrfOriginAllowed(originLowerCase, allowedOrigins)) {\n         return warnOrBlockRequest(res, originLowerCase, mode)\n       }\n     }"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 5,
        "deletions": 29
    }
}