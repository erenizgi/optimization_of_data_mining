{
    "author": "unstubbable",
    "message": "Add `--debug-prerender` option for `next build` (#80667)\n\nWhen running `next build --debug-prerender`, we will set a few experimental flags that ensure the following:\r\n\r\n- No minification is applied to server code.\r\n    - `experimental.serverMinification = false`, or\r\n    - `experimental.turbopackMinify = false`\r\n- Source maps for server bundles are generated.\r\n    - `experimental.serverSourceMaps = true`\r\n- Source maps are consumed by Node.js in the spawned child processes that prerender the routes.\r\n    - `experimental.enablePrerenderSourceMaps = true`\r\n- The build is not exited after the first error to show a complete list of prerender errors.\r\n    - `experimental.prerenderEarlyExit = false`\r\n\r\nWhile `next dev` remains the primary recommended way to debug prerender errors when `dynamicIO` is enabled, this build option does offer an alternative to get a more usable build output, with readable stacks and code frames.\r\n\r\n**Note:** For performance reasons, artifacts generated with `next build --debug-prerender` should not be deployed to production. This mode is only intended for debugging purposes.\r\n\r\nCloses NAR-142",
    "sha": "e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
    "files": [
        {
            "sha": "68b8f6237bf3879257682e5ef0531cce9fbf7871",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -124,7 +124,10 @@ program\n     )}`\n   )\n   .option('-d, --debug', 'Enables a more verbose build output.')\n-\n+  .option(\n+    '--debug-prerender',\n+    'Enables debug mode for prerendering. Not for production use!'\n+  )\n   .option('--no-lint', 'Disables linting.')\n   .option('--no-mangling', 'Disables mangling.')\n   .option('--profile', 'Enables production profiling for React.')"
        },
        {
            "sha": "e0be8fc1f896043507678a98c59f014ef37be63a",
            "filename": "packages/next/src/build/build-context.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbuild%2Fbuild-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbuild%2Fbuild-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fbuild-context.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -94,4 +94,5 @@ export const NextBuildContext: Partial<{\n   fetchCacheKeyPrefix?: string\n   allowedRevalidateHeaderKeys?: string[]\n   isCompileMode?: boolean\n+  debugPrerender: boolean\n }> = {}"
        },
        {
            "sha": "82356d5f0a82edb0f04acd5aa812608a0817e355",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 3,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -807,6 +807,7 @@ export default async function build(\n   dir: string,\n   reactProductionProfiling = false,\n   debugOutput = false,\n+  debugPrerender = false,\n   runLint = true,\n   noMangling = false,\n   appDirOnly = false,\n@@ -832,6 +833,7 @@ export default async function build(\n     NextBuildContext.appDirOnly = appDirOnly\n     NextBuildContext.reactProductionProfiling = reactProductionProfiling\n     NextBuildContext.noMangling = noMangling\n+    NextBuildContext.debugPrerender = debugPrerender\n \n     await nextBuildSpan.traceAsyncFn(async () => {\n       // attempt to load global env values so they are available in next.config.js\n@@ -850,6 +852,7 @@ export default async function build(\n                 // Log for next.config loading process\n                 silent: false,\n                 reactProductionProfiling,\n+                debugPrerender,\n               }),\n             turborepoAccessTraceResult\n           )\n@@ -970,10 +973,12 @@ export default async function build(\n       )\n \n       // Always log next version first then start rest jobs\n-      const { envInfo, experimentalFeatures } = await getStartServerInfo(\n+      const { envInfo, experimentalFeatures } = await getStartServerInfo({\n         dir,\n-        false\n-      )\n+        dev: false,\n+        debugPrerender,\n+      })\n+\n       logStartInfo({\n         networkUrl: null,\n         appUrl: null,\n@@ -2738,6 +2743,7 @@ export default async function build(\n               silent: true,\n               buildExport: true,\n               debugOutput,\n+              debugPrerender,\n               pages: combinedPages,\n               outdir,\n               statusMessage: 'Generating static pages',"
        },
        {
            "sha": "17e202ac6651c4d6146fdef50986c767cd6eb404",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -249,7 +249,8 @@ export async function workerMain(workerData: {\n   /// load the config because it's not serializable\n   NextBuildContext.config = await loadConfig(\n     PHASE_PRODUCTION_BUILD,\n-    NextBuildContext.dir!\n+    NextBuildContext.dir!,\n+    { debugPrerender: NextBuildContext.debugPrerender }\n   )\n \n   // Matches handling in build/index.ts"
        },
        {
            "sha": "402e4b630ea563dd29e1a8a44febad10c62c6b1f",
            "filename": "packages/next/src/build/webpack-build/impl.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -385,7 +385,8 @@ export async function workerMain(workerData: {\n   /// load the config because it's not serializable\n   NextBuildContext.config = await loadConfig(\n     PHASE_PRODUCTION_BUILD,\n-    NextBuildContext.dir!\n+    NextBuildContext.dir!,\n+    { debugPrerender: NextBuildContext.debugPrerender }\n   )\n   NextBuildContext.nextBuildSpan = trace(\n     `worker-main-${workerData.compilerName}`"
        },
        {
            "sha": "a2df58fdc4135664a9299c42e6ac978300eff58a",
            "filename": "packages/next/src/cli/next-build.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 1,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -13,6 +13,7 @@ import { disableMemoryDebuggingMode } from '../lib/memory/shutdown'\n \n export type NextBuildOptions = {\n   debug?: boolean\n+  debugPrerender?: boolean\n   profile?: boolean\n   lint: boolean\n   mangling: boolean\n@@ -31,6 +32,7 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n \n   const {\n     debug,\n+    debugPrerender,\n     experimentalDebugMemoryUsage,\n     profile,\n     lint,\n@@ -51,7 +53,7 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n \n   if (!mangling) {\n     warn(\n-      'Mangling is disabled. Note: This may affect performance and should only be used for debugging purposes.'\n+      `Mangling is disabled. ${italic('Note: This may affect performance and should only be used for debugging purposes.')}`\n     )\n   }\n \n@@ -61,6 +63,14 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n     )\n   }\n \n+  if (debugPrerender) {\n+    warn(\n+      `Prerendering is running in debug mode. ${italic(\n+        'Note: This may affect performance and should not be used for production.'\n+      )}`\n+    )\n+  }\n+\n   if (experimentalDebugMemoryUsage) {\n     process.env.EXPERIMENTAL_DEBUG_MEMORY_USAGE = '1'\n     enableMemoryDebuggingMode()\n@@ -83,6 +93,7 @@ const nextBuild = (options: NextBuildOptions, directory?: string) => {\n     dir,\n     profile,\n     debug || Boolean(process.env.NEXT_DEBUG_BUILD),\n+    debugPrerender,\n     lint,\n     !mangling,\n     experimentalAppOnly,"
        },
        {
            "sha": "81368828a858ff4f87ea522f387fec7f98cf7c61",
            "filename": "packages/next/src/export/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Findex.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -89,9 +89,11 @@ async function exportAppImpl(\n \n   const nextConfig =\n     options.nextConfig ||\n-    (await span\n-      .traceChild('load-next-config')\n-      .traceAsyncFn(() => loadConfig(PHASE_EXPORT, dir)))\n+    (await span.traceChild('load-next-config').traceAsyncFn(() =>\n+      loadConfig(PHASE_EXPORT, dir, {\n+        debugPrerender: options.debugPrerender,\n+      })\n+    ))\n \n   const distDir = join(dir, nextConfig.distDir)\n   const telemetry = options.buildExport ? null : new Telemetry({ distDir })"
        },
        {
            "sha": "a8bd4c38fb835386d61c75ff67ee16d6d3157eb4",
            "filename": "packages/next/src/export/types.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Ftypes.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -105,6 +105,7 @@ export interface ExportAppOptions {\n   enabledDirectories: NextEnabledDirectories\n   silent?: boolean\n   debugOutput?: boolean\n+  debugPrerender?: boolean\n   pages?: string[]\n   buildExport: boolean\n   statusMessage?: string"
        },
        {
            "sha": "6ea826ff282a1df728472f7a19fbba4d037eb184",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 111,
            "deletions": 42,
            "changes": 153,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -7,6 +7,7 @@ import * as ciEnvironment from '../server/ci-info'\n import {\n   CONFIG_FILES,\n   PHASE_DEVELOPMENT_SERVER,\n+  PHASE_EXPORT,\n   PHASE_PRODUCTION_BUILD,\n   PHASE_PRODUCTION_SERVER,\n } from '../shared/lib/constants'\n@@ -1156,14 +1157,18 @@ export default async function loadConfig(\n     customConfig,\n     rawConfig,\n     silent = true,\n-    onLoadUserConfig,\n+    reportExperimentalFeatures,\n     reactProductionProfiling,\n+    debugPrerender,\n   }: {\n     customConfig?: object | null\n     rawConfig?: boolean\n     silent?: boolean\n-    onLoadUserConfig?: (conf: NextConfig) => void\n+    reportExperimentalFeatures?: (\n+      configuredExperimentalFeatures: ConfiguredExperimentalFeature[]\n+    ) => void\n     reactProductionProfiling?: boolean\n+    debugPrerender?: boolean\n   } = {}\n ): Promise<NextConfigComplete> {\n   if (!process.env.__NEXT_PRIVATE_RENDER_WORKER) {\n@@ -1259,11 +1264,35 @@ export default async function loadConfig(\n       throw err\n     }\n \n+    const loadedConfig = Object.freeze(\n+      (await normalizeConfig(\n+        phase,\n+        interopDefault(userConfigModule)\n+      )) as NextConfig\n+    )\n+\n+    const configuredExperimentalFeatures: ConfiguredExperimentalFeature[] = []\n+\n+    if (reportExperimentalFeatures && loadedConfig.experimental) {\n+      for (const name of Object.keys(\n+        loadedConfig.experimental\n+      ) as (keyof ExperimentalConfig)[]) {\n+        const value = loadedConfig.experimental[name]\n+\n+        if (name === 'turbo' && !process.env.TURBOPACK) {\n+          // Ignore any Turbopack config if Turbopack is not enabled\n+          continue\n+        }\n+\n+        addConfiguredExperimentalFeature(\n+          configuredExperimentalFeatures,\n+          name,\n+          value\n+        )\n+      }\n+    }\n+\n     // Clone a new userConfig each time to avoid mutating the original\n-    const loadedConfig = (await normalizeConfig(\n-      phase,\n-      interopDefault(userConfigModule)\n-    )) as NextConfig\n     const userConfig = cloneObject(loadedConfig) as NextConfig\n \n     if (!process.env.NEXT_MINIMAL) {\n@@ -1382,7 +1411,45 @@ export default async function loadConfig(\n       userConfig.htmlLimitedBots = userConfig.htmlLimitedBots.source\n     }\n \n-    onLoadUserConfig?.(Object.freeze(loadedConfig))\n+    if (\n+      debugPrerender &&\n+      (phase === PHASE_PRODUCTION_BUILD || phase === PHASE_EXPORT)\n+    ) {\n+      userConfig.experimental ??= {}\n+\n+      setExperimentalFeatureForDebugPrerender(\n+        userConfig.experimental,\n+        'serverSourceMaps',\n+        true,\n+        reportExperimentalFeatures ? configuredExperimentalFeatures : undefined\n+      )\n+\n+      setExperimentalFeatureForDebugPrerender(\n+        userConfig.experimental,\n+        process.env.TURBOPACK ? 'turbopackMinify' : 'serverMinification',\n+        false,\n+        reportExperimentalFeatures ? configuredExperimentalFeatures : undefined\n+      )\n+\n+      setExperimentalFeatureForDebugPrerender(\n+        userConfig.experimental,\n+        'enablePrerenderSourceMaps',\n+        true,\n+        reportExperimentalFeatures ? configuredExperimentalFeatures : undefined\n+      )\n+\n+      setExperimentalFeatureForDebugPrerender(\n+        userConfig.experimental,\n+        'prerenderEarlyExit',\n+        false,\n+        reportExperimentalFeatures ? configuredExperimentalFeatures : undefined\n+      )\n+    }\n+\n+    if (reportExperimentalFeatures) {\n+      reportExperimentalFeatures(configuredExperimentalFeatures)\n+    }\n+\n     const completeConfig = assignDefaults(\n       dir,\n       {\n@@ -1427,48 +1494,50 @@ export default async function loadConfig(\n   return await applyModifyConfig(completeConfig, phase, silent)\n }\n \n-export type ConfiguredExperimentalFeature =\n-  | { name: keyof ExperimentalConfig; type: 'boolean'; value: boolean }\n-  | { name: keyof ExperimentalConfig; type: 'number'; value: number }\n-  | { name: keyof ExperimentalConfig; type: 'other' }\n+export type ConfiguredExperimentalFeature = {\n+  key: keyof ExperimentalConfig\n+  value: ExperimentalConfig[keyof ExperimentalConfig]\n+  reason?: string\n+}\n \n-export function getConfiguredExperimentalFeatures(\n-  userNextConfigExperimental: NextConfig['experimental']\n+export function addConfiguredExperimentalFeature<\n+  KeyType extends keyof ExperimentalConfig,\n+>(\n+  configuredExperimentalFeatures: ConfiguredExperimentalFeature[],\n+  key: KeyType,\n+  value: ExperimentalConfig[KeyType],\n+  reason?: string\n ) {\n-  const configuredExperimentalFeatures: ConfiguredExperimentalFeature[] = []\n-\n-  if (!userNextConfigExperimental) {\n-    return configuredExperimentalFeatures\n+  if (value !== (defaultConfig.experimental as Record<string, unknown>)[key]) {\n+    configuredExperimentalFeatures.push({ key, value, reason })\n   }\n+}\n \n-  // defaultConfig.experimental is predefined and will never be undefined\n-  // This is only a type guard for the typescript\n-  if (defaultConfig.experimental) {\n-    for (const name of Object.keys(\n-      userNextConfigExperimental\n-    ) as (keyof ExperimentalConfig)[]) {\n-      const value = userNextConfigExperimental[name]\n-\n-      if (name === 'turbo' && !process.env.TURBOPACK) {\n-        // Ignore any Turbopack config if Turbopack is not enabled\n-        continue\n-      }\n+function setExperimentalFeatureForDebugPrerender<\n+  KeyType extends keyof ExperimentalConfig,\n+>(\n+  experimentalConfig: ExperimentalConfig,\n+  key: KeyType,\n+  value: ExperimentalConfig[KeyType],\n+  configuredExperimentalFeatures: ConfiguredExperimentalFeature[] | undefined\n+) {\n+  if (experimentalConfig[key] !== value) {\n+    experimentalConfig[key] = value\n \n-      if (\n-        name in defaultConfig.experimental &&\n-        value !== (defaultConfig.experimental as Record<string, unknown>)[name]\n-      ) {\n-        configuredExperimentalFeatures.push(\n-          typeof value === 'boolean'\n-            ? { name, type: 'boolean', value }\n-            : typeof value === 'number'\n-              ? { name, type: 'number', value }\n-              : { name, type: 'other' }\n-        )\n-      }\n+    if (configuredExperimentalFeatures) {\n+      const action =\n+        value === true ? 'enabled' : value === false ? 'disabled' : 'set'\n+\n+      const reason = `${action} by \\`--debug-prerender\\``\n+\n+      addConfiguredExperimentalFeature(\n+        configuredExperimentalFeatures,\n+        key,\n+        value,\n+        reason\n+      )\n     }\n   }\n-  return configuredExperimentalFeatures\n }\n \n function cloneObject(obj: any): any {"
        },
        {
            "sha": "fda653fa9a39cfb0ba58a3aef545c5bcd3e16e5d",
            "filename": "packages/next/src/server/lib/app-info-log.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 16,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fapp-info-log.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -5,10 +5,7 @@ import {\n   PHASE_DEVELOPMENT_SERVER,\n   PHASE_PRODUCTION_BUILD,\n } from '../../shared/lib/constants'\n-import loadConfig, {\n-  getConfiguredExperimentalFeatures,\n-  type ConfiguredExperimentalFeature,\n-} from '../config'\n+import loadConfig, { type ConfiguredExperimentalFeature } from '../config'\n \n export function logStartInfo({\n   networkUrl,\n@@ -50,15 +47,16 @@ export function logStartInfo({\n     // only show a maximum number of flags\n     for (const exp of experimentalFeatures.slice(0, maxExperimentalFeatures)) {\n       const symbol =\n-        exp.type === 'boolean'\n+        typeof exp.value === 'boolean'\n           ? exp.value === true\n             ? bold('✓')\n             : bold('⨯')\n           : '·'\n \n-      const suffix = exp.type === 'number' ? `: ${exp.value}` : ''\n+      const suffix = typeof exp.value === 'number' ? `: ${exp.value}` : ''\n+      const reason = exp.reason ? ` (${exp.reason})` : ''\n \n-      Log.bootstrap(`  ${symbol} ${exp.name}${suffix}`)\n+      Log.bootstrap(`  ${symbol} ${exp.key}${suffix}${reason}`)\n     }\n     /* indicate if there are more than the maximum shown no. flags */\n     if (experimentalFeatures.length > maxExperimentalFeatures) {\n@@ -70,10 +68,15 @@ export function logStartInfo({\n   Log.info('')\n }\n \n-export async function getStartServerInfo(\n-  dir: string,\n+export async function getStartServerInfo({\n+  dir,\n+  dev,\n+  debugPrerender,\n+}: {\n+  dir: string\n   dev: boolean\n-): Promise<{\n+  debugPrerender?: boolean\n+}): Promise<{\n   envInfo?: string[]\n   experimentalFeatures?: ConfiguredExperimentalFeature[]\n }> {\n@@ -82,14 +85,12 @@ export async function getStartServerInfo(\n     dev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_BUILD,\n     dir,\n     {\n-      onLoadUserConfig(userConfig) {\n-        const configuredExperimentalFeatures =\n-          getConfiguredExperimentalFeatures(userConfig.experimental)\n-\n-        experimentalFeatures = configuredExperimentalFeatures.sort(\n-          ({ name: a }, { name: b }) => a.length - b.length\n+      reportExperimentalFeatures(features) {\n+        experimentalFeatures = features.sort(\n+          ({ key: a }, { key: b }) => a.length - b.length\n         )\n       },\n+      debugPrerender,\n     }\n   )\n "
        },
        {
            "sha": "e1de5d8523506bc9e99898bc292c70f024ccd993",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -278,7 +278,7 @@ export async function startServer(\n       let envInfo: string[] | undefined\n       let experimentalFeatures: ConfiguredExperimentalFeature[] | undefined\n       if (isDev) {\n-        const startServerInfo = await getStartServerInfo(dir, isDev)\n+        const startServerInfo = await getStartServerInfo({ dir, dev: isDev })\n         envInfo = startServerInfo.envInfo\n         experimentalFeatures = startServerInfo.experimentalFeatures\n       }"
        },
        {
            "sha": "215f0bea40bf5e8c4ffe27615e5d00f5c27770fd",
            "filename": "test/production/app-dir/build-output-prerender/app/client/page.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Fclient%2Fpage.tsx?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export default function Page() {\n+  return <p>Current time: {new Date().toISOString()}</p>\n+}"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/production/app-dir/build-output-prerender/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Flayout.tsx?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "7659e2bdad2cfb56b6b52dd997fffceb34ac99ee",
            "filename": "test/production/app-dir/build-output-prerender/app/server/page.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Fserver%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Fserver%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fapp%2Fserver%2Fpage.tsx?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -0,0 +1,14 @@\n+import { setTimeout } from 'timers/promises'\n+\n+async function cachedDelay() {\n+  'use cache'\n+  await setTimeout(3000)\n+}\n+\n+export default async function Page() {\n+  // Defer rendering to ensure the prerender order is deterministic, i.e. the\n+  // client page will be finished prerendering first.\n+  await cachedDelay()\n+\n+  return <p>Random: {Math.random()}</p>\n+}"
        },
        {
            "sha": "c43ac86c7f7815344c37a4a5dfcec41a095ccccf",
            "filename": "test/production/app-dir/build-output-prerender/build-output-prerender.test.ts",
            "status": "added",
            "additions": 181,
            "deletions": 0,
            "changes": 181,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fbuild-output-prerender.test.ts?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -0,0 +1,181 @@\n+import { nextTestSetup } from 'e2e-utils'\n+const { version: nextVersion } = require('next/package.json')\n+\n+describe('build-output-prerender', () => {\n+  describe('without --debug-prerender', () => {\n+    const { next, isTurbopack } = nextTestSetup({\n+      files: __dirname,\n+      skipStart: true,\n+    })\n+\n+    beforeAll(() => next.build())\n+\n+    it('prints only the user-selected experimental flags', async () => {\n+      if (isTurbopack) {\n+        expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+         \"▲ Next.js x.y.z (Turbopack)\n+            - Experiments (use with caution):\n+              ✓ dynamicIO\"\n+        `)\n+      } else {\n+        expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+         \"▲ Next.js x.y.z\n+            - Experiments (use with caution):\n+              ✓ dynamicIO\"\n+        `)\n+      }\n+    })\n+\n+    it('shows only a single prerender error with a mangled stack', async () => {\n+      if (isTurbopack) {\n+        expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+         \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+             at x (<next-dist-dir>)\n+         Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n+         Export encountered an error on /client/page: /client, exiting the build.\"\n+        `)\n+      } else {\n+        expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+         \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+             at x (<next-dist-dir>)\n+         Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n+         Export encountered an error on /client/page: /client, exiting the build.\"\n+        `)\n+      }\n+    })\n+  })\n+\n+  describe('with --debug-prerender', () => {\n+    const { next, isTurbopack } = nextTestSetup({\n+      files: __dirname,\n+      skipStart: true,\n+      buildOptions: ['--debug-prerender'],\n+    })\n+\n+    beforeAll(() => next.build())\n+\n+    it('prints a warning and the customized experimental flags', async () => {\n+      if (isTurbopack) {\n+        expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+         \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+            ▲ Next.js x.y.z (Turbopack)\n+            - Experiments (use with caution):\n+              ✓ dynamicIO\n+              ⨯ turbopackMinify (disabled by \\`--debug-prerender\\`)\n+              ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+              ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+              ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+        `)\n+      } else {\n+        expect(getPreambleOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+         \"⚠ Prerendering is running in debug mode. Note: This may affect performance and should not be used for production.\n+            ▲ Next.js x.y.z\n+            - Experiments (use with caution):\n+              ✓ dynamicIO\n+              ✓ serverSourceMaps (enabled by \\`--debug-prerender\\`)\n+              ⨯ serverMinification (disabled by \\`--debug-prerender\\`)\n+              ⨯ prerenderEarlyExit (disabled by \\`--debug-prerender\\`)\n+              ✓ enablePrerenderSourceMaps (enabled by \\`--debug-prerender\\`)\"\n+        `)\n+      }\n+    })\n+\n+    it('shows all prerender errors with readable stacks and code frames', async () => {\n+      if (isTurbopack) {\n+        expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+         \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+             at Page (turbopack:///[project]/app/client/page.tsx:4:27)\n+           2 |\n+           3 | export default function Page() {\n+         > 4 |   return <p>Current time: {new Date().toISOString()}</p>\n+             |                           ^\n+           5 | }\n+           6 |\n+         Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n+         Error: Route \"/server\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+             at Page (turbopack:///[project]/app/server/page.tsx:13:26)\n+           11 |   await cachedDelay()\n+           12 |\n+         > 13 |   return <p>Random: {Math.random()}</p>\n+              |                          ^\n+           14 | }\n+           15 |\n+         Error occurred prerendering page \"/server\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+         > Export encountered errors on following paths:\n+         \t/client/page: /client\n+         \t/server/page: /server\"\n+        `)\n+      } else {\n+        expect(getPrerenderOutput(next.cliOutput)).toMatchInlineSnapshot(`\n+         \"Error: Route \"/client\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+             at Page (webpack:///app/client/page.tsx:4:27)\n+           2 |\n+           3 | export default function Page() {\n+         > 4 |   return <p>Current time: {new Date().toISOString()}</p>\n+             |                           ^\n+           5 | }\n+           6 |\n+         Error occurred prerendering page \"/client\". Read more: https://nextjs.org/docs/messages/prerender-error\n+         Error: Route \"/server\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+             at Page (webpack:///app/server/page.tsx:13:26)\n+           11 |   await cachedDelay()\n+           12 |\n+         > 13 |   return <p>Random: {Math.random()}</p>\n+              |                          ^\n+           14 | }\n+           15 |\n+         Error occurred prerendering page \"/server\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+         > Export encountered errors on following paths:\n+         \t/client/page: /client\n+         \t/server/page: /server\"\n+        `)\n+      }\n+    })\n+  })\n+})\n+\n+function getPreambleOutput(cliOutput: string): string {\n+  const lines: string[] = []\n+\n+  for (const line of cliOutput.split('\\n')) {\n+    if (line.includes('Creating an optimized production build')) {\n+      break\n+    }\n+\n+    // Ignore the test-only warning that `experimental.ppr` has been defaulted\n+    // to `true` when `__NEXT_EXPERIMENTAL_PPR` is set to `true`.\n+    if (line.includes('__NEXT_EXPERIMENTAL_PPR')) {\n+      continue\n+    }\n+\n+    lines.push(line.replace(nextVersion, 'x.y.z'))\n+  }\n+\n+  return lines.join('\\n').trim()\n+}\n+\n+function getPrerenderOutput(cliOutput: string): string {\n+  let foundPrerenderingLine = false\n+  const lines: string[] = []\n+\n+  for (const line of cliOutput.split('\\n')) {\n+    if (line.includes('Collecting page data')) {\n+      foundPrerenderingLine = true\n+      continue\n+    }\n+\n+    if (line.includes('Next.js build worker exited')) {\n+      break\n+    }\n+\n+    if (foundPrerenderingLine && !line.includes('Generating static pages')) {\n+      lines.push(\n+        line.replace(/at \\w+ \\(.next[^)]+\\)/, 'at x (<next-dist-dir>)')\n+      )\n+    }\n+  }\n+\n+  return lines.join('\\n').trim()\n+}"
        },
        {
            "sha": "ac4afcf432196896657dae6577717292a9b9e15e",
            "filename": "test/production/app-dir/build-output-prerender/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/e4c838c1d07dea560ae7f00f96e58ec18e602d5e/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-prerender%2Fnext.config.js?ref=e4c838c1d07dea560ae7f00f96e58ec18e602d5e",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    dynamicIO: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 452,
        "additions": 383,
        "deletions": 69
    }
}