{
    "author": "ijjk",
    "message": "Fix resolvedPathname for middleware rewrite (#81144)\n\nThis updates the handling of `resolvedPathname` to handle the case we\ndon't know the `rewroteURL` for example when it's a middleware rewrite\nand we can't derive it since it's fully dynamic. Since we always know\nthe `srcPage` we can always recreate the final URL using the params\nwhich this does as it's more reliable than relying on the parsed URL as\na backup.\n\nValidated against our deploy tests\nhttps://github.com/vercel/next.js/actions/runs/16014327609/job/45178072108\nand\nhttps://github.com/vercel/vercel/actions/runs/16014347060/job/45178081995?pr=13509\n\nx-ref: [slack thread](https://vercel.slack.com/archives/C093RLQ7RGC)",
    "sha": "3e022577f2cacfc5c5bb0553327b3e116a58f68d",
    "files": [
        {
            "sha": "335853579ce1f77a1993b4112c4907d4377b3ca3",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 12,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -41,7 +41,6 @@ import {\n   type ResponseCacheEntry,\n   type ResponseGenerator,\n } from '../../server/response-cache'\n-import { decodePathParams } from '../../server/lib/router-utils/decode-path-params'\n import { FallbackMode, parseFallbackField } from '../../lib/fallback'\n import RenderResult from '../../server/render-result'\n import { CACHE_ONE_YEAR, NEXT_CACHE_TAGS_HEADER } from '../../lib/constants'\n@@ -156,7 +155,7 @@ export async function handler(\n     subresourceIntegrityManifest,\n     prerenderManifest,\n     isDraftMode,\n-\n+    resolvedPathname,\n     revalidateOnlyGenerated,\n     routerServerContext,\n     nextConfig,\n@@ -167,16 +166,6 @@ export async function handler(\n \n   let { isOnDemandRevalidate } = prepareResult\n \n-  // TODO: rework this to not be necessary as a middleware\n-  // rewrite should not need to pass this context like this\n-  // maybe we rely on rewrite header instead\n-  let resolvedPathname = getRequestMeta(req, 'rewroteURL') || pathname\n-\n-  if (resolvedPathname === '/index') {\n-    resolvedPathname = '/'\n-  }\n-  resolvedPathname = decodePathParams(resolvedPathname)\n-\n   const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage]\n   const isPrerendered = prerenderManifest.routes[resolvedPathname]\n "
        },
        {
            "sha": "1346d9e4e8ae6d37c89ac72c3cd5e766793c00b8",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -55,6 +55,8 @@ import {\n   routerServerGlobal,\n   type RouterServerContext,\n } from '../lib/router-utils/router-server-context'\n+import { decodePathParams } from '../lib/router-utils/decode-path-params'\n+import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n \n /**\n  * RouteModuleOptions is the options that are passed to the route module, other\n@@ -402,6 +404,7 @@ export abstract class RouteModule<\n         previewData: PreviewData\n         pageIsDynamic: boolean\n         isDraftMode: boolean\n+        resolvedPathname: string\n         isNextDataRequest: boolean\n         buildManifest: DeepReadonly<BuildManifest>\n         nextFontManifest: DeepReadonly<NextFontManifest>\n@@ -670,6 +673,22 @@ export abstract class RouteModule<\n       const nextConfig =\n         routerServerContext?.nextConfig || serverFilesManifest.config\n \n+      const normalizedSrcPage = normalizeAppPath(srcPage)\n+      let resolvedPathname =\n+        getRequestMeta(req, 'rewroteURL') || normalizedSrcPage\n+\n+      if (isDynamicRoute(resolvedPathname) && params) {\n+        resolvedPathname = serverUtils.interpolateDynamicPath(\n+          resolvedPathname,\n+          params\n+        )\n+      }\n+\n+      if (resolvedPathname === '/index') {\n+        resolvedPathname = '/'\n+      }\n+      resolvedPathname = decodePathParams(resolvedPathname)\n+\n       return {\n         query,\n         originalQuery,\n@@ -683,6 +702,7 @@ export abstract class RouteModule<\n         isDraftMode,\n         previewData,\n         pageIsDynamic,\n+        resolvedPathname,\n         isOnDemandRevalidate,\n         revalidateOnlyGenerated,\n         ...manifests,"
        },
        {
            "sha": "718d6fea4835ec2d246af9800eddb7ffb276240c",
            "filename": "test/e2e/app-dir/middleware-rewrite-dynamic/app/favicon.ico",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Ffavicon.ico",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Ffavicon.ico",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Ffavicon.ico?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d"
        },
        {
            "sha": "9aa96e93885702b7ca4ee8501f9f2c8423ace781",
            "filename": "test/e2e/app-dir/middleware-rewrite-dynamic/app/layout.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Flayout.tsx?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -0,0 +1,33 @@\n+import type { Metadata } from 'next'\n+import { Geist, Geist_Mono } from 'next/font/google'\n+\n+const geistSans = Geist({\n+  variable: '--font-geist-sans',\n+  subsets: ['latin'],\n+})\n+\n+const geistMono = Geist_Mono({\n+  variable: '--font-geist-mono',\n+  subsets: ['latin'],\n+})\n+\n+export const metadata: Metadata = {\n+  title: 'Create Next App',\n+  description: 'Generated by create next app',\n+}\n+\n+export default function RootLayout({\n+  children,\n+}: Readonly<{\n+  children: React.ReactNode\n+}>) {\n+  return (\n+    <html lang=\"en\">\n+      <body\n+        className={`${geistSans.variable} ${geistMono.variable} antialiased`}\n+      >\n+        {children}\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "7a5011548102abb7885c76ae2a19d163f8d05153",
            "filename": "test/e2e/app-dir/middleware-rewrite-dynamic/app/page.tsx",
            "status": "added",
            "additions": 103,
            "deletions": 0,
            "changes": 103,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Fpage.tsx?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -0,0 +1,103 @@\n+import Image from 'next/image'\n+\n+export default function Home() {\n+  return (\n+    <div className=\"grid grid-rows-[20px_1fr_20px] items-center justify-items-center min-h-screen p-8 pb-20 gap-16 sm:p-20 font-[family-name:var(--font-geist-sans)]\">\n+      <main className=\"flex flex-col gap-[32px] row-start-2 items-center sm:items-start\">\n+        <Image\n+          className=\"dark:invert\"\n+          src=\"/next.svg\"\n+          alt=\"Next.js logo\"\n+          width={180}\n+          height={38}\n+          priority\n+        />\n+        <ol className=\"list-inside list-decimal text-sm/6 text-center sm:text-left font-[family-name:var(--font-geist-mono)]\">\n+          <li className=\"mb-2 tracking-[-.01em]\">\n+            Get started by editing{' '}\n+            <code className=\"bg-black/[.05] dark:bg-white/[.06] px-1 py-0.5 rounded font-[family-name:var(--font-geist-mono)] font-semibold\">\n+              app/page.tsx\n+            </code>\n+            .\n+          </li>\n+          <li className=\"tracking-[-.01em]\">\n+            Save and see your changes instantly.\n+          </li>\n+        </ol>\n+\n+        <div className=\"flex gap-4 items-center flex-col sm:flex-row\">\n+          <a\n+            className=\"rounded-full border border-solid border-transparent transition-colors flex items-center justify-center bg-foreground text-background gap-2 hover:bg-[#383838] dark:hover:bg-[#ccc] font-medium text-sm sm:text-base h-10 sm:h-12 px-4 sm:px-5 sm:w-auto\"\n+            href=\"https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app\"\n+            target=\"_blank\"\n+            rel=\"noopener noreferrer\"\n+          >\n+            <Image\n+              className=\"dark:invert\"\n+              src=\"/vercel.svg\"\n+              alt=\"Vercel logomark\"\n+              width={20}\n+              height={20}\n+            />\n+            Deploy now\n+          </a>\n+          <a\n+            className=\"rounded-full border border-solid border-black/[.08] dark:border-white/[.145] transition-colors flex items-center justify-center hover:bg-[#f2f2f2] dark:hover:bg-[#1a1a1a] hover:border-transparent font-medium text-sm sm:text-base h-10 sm:h-12 px-4 sm:px-5 w-full sm:w-auto md:w-[158px]\"\n+            href=\"https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app\"\n+            target=\"_blank\"\n+            rel=\"noopener noreferrer\"\n+          >\n+            Read our docs\n+          </a>\n+        </div>\n+      </main>\n+      <footer className=\"row-start-3 flex gap-[24px] flex-wrap items-center justify-center\">\n+        <a\n+          className=\"flex items-center gap-2 hover:underline hover:underline-offset-4\"\n+          href=\"https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app\"\n+          target=\"_blank\"\n+          rel=\"noopener noreferrer\"\n+        >\n+          <Image\n+            aria-hidden\n+            src=\"/file.svg\"\n+            alt=\"File icon\"\n+            width={16}\n+            height={16}\n+          />\n+          Learn\n+        </a>\n+        <a\n+          className=\"flex items-center gap-2 hover:underline hover:underline-offset-4\"\n+          href=\"https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app\"\n+          target=\"_blank\"\n+          rel=\"noopener noreferrer\"\n+        >\n+          <Image\n+            aria-hidden\n+            src=\"/window.svg\"\n+            alt=\"Window icon\"\n+            width={16}\n+            height={16}\n+          />\n+          Examples\n+        </a>\n+        <a\n+          className=\"flex items-center gap-2 hover:underline hover:underline-offset-4\"\n+          href=\"https://nextjs.org?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app\"\n+          target=\"_blank\"\n+          rel=\"noopener noreferrer\"\n+        >\n+          <Image\n+            aria-hidden\n+            src=\"/globe.svg\"\n+            alt=\"Globe icon\"\n+            width={16}\n+            height={16}\n+          />\n+          Go to nextjs.org â†’\n+        </a>\n+      </footer>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "ae7bed373a19e1d9ed58962dce93de085b9b9ab6",
            "filename": "test/e2e/app-dir/middleware-rewrite-dynamic/app/render/next/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Frender%2Fnext%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Frender%2Fnext%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Frender%2Fnext%2Fpage.tsx?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -0,0 +1,13 @@\n+import { headers } from 'next/headers'\n+\n+export default async function Home() {\n+  const headersList = await headers()\n+  console.log('headers', headersList.get('x-nextjs-cache'))\n+  return (\n+    <div className=\"grid grid-rows-[20px_1fr_20px] items-center justify-items-center min-h-screen p-8 pb-20 gap-16 sm:p-20 font-[family-name:var(--font-geist-sans)]\">\n+      <main className=\"flex flex-col gap-[32px] row-start-2 items-center sm:items-start\">\n+        Render next\n+      </main>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "d5df4f019774d5d68c3ea35ba867fc7505205ba1",
            "filename": "test/e2e/app-dir/middleware-rewrite-dynamic/app/robots.txt",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Frobots.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Frobots.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fapp%2Frobots.txt?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -0,0 +1,5 @@\n+User-Agent: *\n+Allow: /\n+Disallow: /private/\n+\n+Sitemap: https://acme.com/sitemap.xml\n\\ No newline at end of file"
        },
        {
            "sha": "9a5e2720e9a35d7be3b2e7e5f7e26fb3e6dba810",
            "filename": "test/e2e/app-dir/middleware-rewrite-dynamic/middleware-rewrite-dynamic.test.ts",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fmiddleware-rewrite-dynamic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fmiddleware-rewrite-dynamic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fmiddleware-rewrite-dynamic.test.ts?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -0,0 +1,19 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('app dir - middleware rewrite dynamic', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should properly rewrite for /robots.txt', async () => {\n+    const res = await next.fetch('/robots.txt')\n+    expect(res.status).toBe(200)\n+    expect(await res.text()).toContain('Render next')\n+  })\n+\n+  it('should properly rewrite for /favicon.ico', async () => {\n+    const res = await next.fetch('/favicon.ico')\n+    expect(res.status).toBe(200)\n+    expect(await res.text()).toContain('Render next')\n+  })\n+})"
        },
        {
            "sha": "acc313c4ba68fd8bdfc3c18a9cc794d9199b349c",
            "filename": "test/e2e/app-dir/middleware-rewrite-dynamic/middleware.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fmiddleware.ts?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -0,0 +1,5 @@\n+import { NextResponse } from 'next/server'\n+\n+export function middleware(request: Request) {\n+  return NextResponse.rewrite(new URL('/render/next', request.url))\n+}"
        },
        {
            "sha": "73290639bc0ae1d251322dd57c81c24e6934dfb7",
            "filename": "test/e2e/app-dir/middleware-rewrite-dynamic/next.config.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fnext.config.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3e022577f2cacfc5c5bb0553327b3e116a58f68d/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fnext.config.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmiddleware-rewrite-dynamic%2Fnext.config.ts?ref=3e022577f2cacfc5c5bb0553327b3e116a58f68d",
            "patch": "@@ -0,0 +1,7 @@\n+import type { NextConfig } from 'next'\n+\n+const nextConfig: NextConfig = {\n+  /* config options here */\n+}\n+\n+export default nextConfig"
        }
    ],
    "stats": {
        "total": 218,
        "additions": 206,
        "deletions": 12
    }
}