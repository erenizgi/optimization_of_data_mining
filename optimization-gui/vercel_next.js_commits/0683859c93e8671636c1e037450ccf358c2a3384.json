{
    "author": "mischnic",
    "message": "Migrate app-dir-export test to be isolated (#86534)\n\nFlakey:\r\n```\r\n❌ test/integration/app-dir-export/test/start.test.ts output:\r\nHEADLESS=true NEXT_TELEMETRY_DISABLED=1 CI= NEXT_TEST_CI=true IS_RETRY=undefined TRACE_PLAYWRIGHT=true CIRCLECI= GITHUB_ACTIONS= CONTINUOUS_INTEGRATION= RUN_ID= BUILD_NUMBER= JEST_JUNIT_OUTPUT_NAME=test_integration_app-dir-export_test_start.test.ts JEST_SUITE_NAME=default:12/13:integration:test/integration/app-dir-export/test/start.test.ts /root/actions-runner/_work/next.js/next.js/node_modules/.bin/jest '--ci' '--runInBand' '--forceExit' '--verbose' '--json' '--outputFile=test/integration/app-dir-export/test/start.test.ts.results.json' 'test/integration/app-dir-export/test/start.test.ts'\r\n[08:48:33.323Z] Running command \"next build /root/actions-runner/_work/next.js/next.js/test/integration/app-dir-export\"\r\n▲ Next.js 16.1.0-canary.1\r\n- Local:         http://[::1]:36371\r\n- Network:       http://[::]:36371\r\n\r\n✓ Starting...\r\nError: \"next start\" does not work with \"output: export\" configuration. Use \"npx serve@latest out\" instead.\r\n    at <unknown> (dist/server/next.js:230:53)\r\n    at async NextServer.prepare (dist/server/next.js:177:24)\r\n    at async initializeImpl (dist/server/lib/render-server.js:132:5)\r\n    at async initialize (dist/server/lib/router-server.js:538:22)\r\n    at async Server.<anonymous> (dist/server/lib/start-server.js:381:36)\r\n[08:49:12.558Z] Running command \"next build /root/actions-runner/_work/next.js/next.js/test/integration/app-dir-export\"\r\nFAIL webpack test/integration/app-dir-export/test/start.test.ts (100.119 s)\r\n  app dir - with output export (next start)\r\n    production mode\r\n      ✓ should error during next start with output export (39235 ms)\r\n      ✕ should warn during next start with output standalone (60029 ms)\r\n\r\n  ● app dir - with output export (next start) › production mode › should warn during next start with output standalone\r\n\r\n    thrown: \"Exceeded timeout of 60000 ms for a test.\r\n    Add a timeout value to this test to increase the timeout, if this is a long-running test. See https://jestjs.io/docs/api#testname-fn-timeout.\"\r\n\r\n      46 |\r\n      47 |       // TODO: Move this test to test/production to run in isolation.\r\n    > 48 |       ;(process.env.TURBOPACK_BUILD ? it.skip : it)(\r\n         |                                                  ^\r\n      49 |         'should warn during next start with output standalone',\r\n      50 |         async () => {\r\n      51 |           nextConfig.replace(`output: 'export'`, `output: 'standalone'`)\r\n\r\n      at integration/app-dir-export/test/start.test.ts:48:50\r\n      at integration/app-dir-export/test/start.test.ts:21:56\r\n      at Object.describe (integration/app-dir-export/test/start.test.ts:20:1)\r\n\r\n```",
    "sha": "0683859c93e8671636c1e037450ccf358c2a3384",
    "files": [
        {
            "sha": "d8ac81fb357856a34b0cdfa72fd4dbb391e94daa",
            "filename": "test/cache-components-tests-manifest.json",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fcache-components-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fcache-components-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fcache-components-tests-manifest.json?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -290,6 +290,13 @@\n       \"test/e2e/app-dir/use-selected-layout-segment-s/use-selected-layout-segment-s.test.ts\",\n       \"test/e2e/app-dir/use-server-inserted-html/use-server-inserted-html.test.ts\",\n       \"test/e2e/app-dir/with-exported-function-config/with-exported-function-config.test.ts\",\n+      \"test/e2e/app-dir-export/test/config.test.ts\",\n+      \"test/e2e/app-dir-export/test/dev-custom-dist-dir.test.ts\",\n+      \"test/e2e/app-dir-export/test/dynamic-missing-gsp.test.ts\",\n+      \"test/e2e/app-dir-export/test/dynamicapiroute.test.ts\",\n+      \"test/e2e/app-dir-export/test/dynamicpage.test.ts\",\n+      \"test/e2e/app-dir-export/test/start.test.ts\",\n+      \"test/e2e/app-dir-export/test/trailing-slash.test.ts\",\n       \"test/e2e/app-document/client.test.ts\",\n       \"test/e2e/app-document/csp.test.ts\",\n       \"test/e2e/app-document/index.test.ts\","
        },
        {
            "sha": "d8886cd11c8dc70d91579a276765653c3969f83b",
            "filename": "test/e2e/app-dir-export/app/another/[slug]/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fanother%2F%5Bslug%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fanother%2F%5Bslug%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fanother%2F%5Bslug%5D%2Fpage.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/another/[slug]/page.js"
        },
        {
            "sha": "22525ff6bd0a85122f54b39b4a23ef602d7742d9",
            "filename": "test/e2e/app-dir-export/app/another/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fanother%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fanother%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fanother%2Fpage.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/another/page.js"
        },
        {
            "sha": "5f1cbb1d6d7086dd5dcc562c1712c838c1d547b5",
            "filename": "test/e2e/app-dir-export/app/api/json/route.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fapi%2Fjson%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fapi%2Fjson%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fapi%2Fjson%2Froute.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/api/json/route.js"
        },
        {
            "sha": "fef2b2f0302e85655a42ac6b1ff2374147a17e03",
            "filename": "test/e2e/app-dir-export/app/api/txt/route.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fapi%2Ftxt%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fapi%2Ftxt%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fapi%2Ftxt%2Froute.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/api/txt/route.js"
        },
        {
            "sha": "0800094685df89f1113eb3f91866ee1a3b93db7f",
            "filename": "test/e2e/app-dir-export/app/client/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fclient%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fclient%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fclient%2Fpage.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/client/page.js"
        },
        {
            "sha": "718d6fea4835ec2d246af9800eddb7ffb276240c",
            "filename": "test/e2e/app-dir-export/app/favicon.ico",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Ffavicon.ico",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Ffavicon.ico",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Ffavicon.ico?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/favicon.ico"
        },
        {
            "sha": "614ffe45b82f5b833a1162f2efc0c161c4a7bb7d",
            "filename": "test/e2e/app-dir-export/app/image-import/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fimage-import%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fimage-import%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fimage-import%2Fpage.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/image-import/page.js"
        },
        {
            "sha": "e14fafc5cf3bc63b70914ad20467f40f7fecd572",
            "filename": "test/e2e/app-dir-export/app/image-import/test.png",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fimage-import%2Ftest.png",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fimage-import%2Ftest.png",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fimage-import%2Ftest.png?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/image-import/test.png"
        },
        {
            "sha": "4ee00a218505ac95ed8f4b2cb12779643277286d",
            "filename": "test/e2e/app-dir-export/app/layout.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Flayout.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/layout.js"
        },
        {
            "sha": "982eb4b94d19a78ea24c6a8b2f45f57d278af2fc",
            "filename": "test/e2e/app-dir-export/app/not-found.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fnot-found.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fnot-found.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fnot-found.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/not-found.js"
        },
        {
            "sha": "287e369bdaec08037f7c8dfc20a00f6d25bd95fe",
            "filename": "test/e2e/app-dir-export/app/page.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Fpage.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/page.js"
        },
        {
            "sha": "c2a49f4fb82f19ffa9089fcf8630e5a2870d3feb",
            "filename": "test/e2e/app-dir-export/app/robots.txt",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Frobots.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fapp%2Frobots.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fapp%2Frobots.txt?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/app/robots.txt"
        },
        {
            "sha": "4f31b8c21276651cef47e3df7e66075b919e0618",
            "filename": "test/e2e/app-dir-export/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Fnext.config.js?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "previous_filename": "test/integration/app-dir-export/next.config.js"
        },
        {
            "sha": "dd38f3c71313b668f6447d55f2a2fc7818d1e0ae",
            "filename": "test/e2e/app-dir-export/test/config.test.ts",
            "status": "added",
            "additions": 102,
            "deletions": 0,
            "changes": 102,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fconfig.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fconfig.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fconfig.test.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -0,0 +1,102 @@\n+import { runNextCommand } from 'next-test-utils'\n+import { join } from 'path'\n+import { expectedWhenTrailingSlashTrue, getFiles } from './utils'\n+import { FileRef, isNextStart, nextTestSetup, PatchedFileRef } from 'e2e-utils'\n+\n+describe('app dir - with output export', () => {\n+  if (isNextStart) {\n+    describe('with exportPathMap configured', () => {\n+      let { next } = nextTestSetup({\n+        files: {\n+          app: new FileRef(join(__dirname, '..', 'app')),\n+          'next.config.js': new PatchedFileRef(\n+            join(__dirname, '..', 'next.config.js'),\n+            (content) =>\n+              content.replace(\n+                'trailingSlash: true,',\n+                `trailingSlash: true,\n+       exportPathMap: async function (map) {\n+        return map\n+      },`\n+              )\n+          ),\n+        },\n+        skipStart: true,\n+      })\n+\n+      it('should throw', async () => {\n+        let { exitCode, cliOutput } = await next.build()\n+        expect(exitCode).toBe(1)\n+        expect(cliOutput).toContain(\n+          'The \"exportPathMap\" configuration cannot be used with the \"app\" directory. Please use generateStaticParams() instead.'\n+        )\n+      })\n+    })\n+\n+    describe('without next config', () => {\n+      let { next } = nextTestSetup({\n+        files: {\n+          app: new FileRef(join(__dirname, '..', 'app')),\n+        },\n+        skipStart: true,\n+      })\n+\n+      it('should error when running next export', async () => {\n+        let { exitCode } = await next.build()\n+        expect(exitCode).toBe(0)\n+        expect(await getFiles(join(next.testDir, 'out'))).toEqual([])\n+\n+        let stdout = ''\n+        let stderr = ''\n+        let error = undefined\n+        try {\n+          await runNextCommand(['export'], {\n+            cwd: next.testDir,\n+            onStdout(msg) {\n+              stdout += msg\n+            },\n+            onStderr(msg) {\n+              stderr += msg\n+            },\n+          })\n+        } catch (e) {\n+          error = e\n+        }\n+        expect(error).toBeDefined()\n+        expect(stderr).toContain(\n+          `\\`next export\\` has been removed in favor of 'output: export' in next.config.js`\n+        )\n+        expect(stdout).not.toContain('Export successful. Files written to')\n+        expect(await getFiles(join(next.testDir, 'out'))).toEqual([])\n+      })\n+    })\n+\n+    describe('with distDir configured', () => {\n+      let { next } = nextTestSetup({\n+        files: {\n+          app: new FileRef(join(__dirname, '..', 'app')),\n+          'next.config.js': new PatchedFileRef(\n+            join(__dirname, '..', 'next.config.js'),\n+            (content) =>\n+              content.replace(\n+                'trailingSlash: true,',\n+                `trailingSlash: true,\n+       distDir: 'output',`\n+              )\n+          ),\n+        },\n+        skipStart: true,\n+      })\n+\n+      it('should correctly emit exported assets to config.distDir', async () => {\n+        let { exitCode } = await next.build()\n+        expect(exitCode).toBe(0)\n+        expect(await getFiles(join(next.testDir, 'output'))).toEqual(\n+          expectedWhenTrailingSlashTrue\n+        )\n+      })\n+    })\n+  } else {\n+    it('skipped in dev', () => {})\n+  }\n+})"
        },
        {
            "sha": "fe7f583d210900406ef44115715451923d21d402",
            "filename": "test/e2e/app-dir-export/test/dev-custom-dist-dir.test.ts",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdev-custom-dist-dir.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdev-custom-dist-dir.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdev-custom-dist-dir.test.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -0,0 +1,25 @@\n+import { join } from 'path'\n+import { FileRef, isNextDev, nextTestSetup, PatchedFileRef } from 'e2e-utils'\n+\n+describe('app dir - with output export and custom distDir in dev', () => {\n+  if (isNextDev) {\n+    const { next } = nextTestSetup({\n+      files: {\n+        app: new FileRef(join(__dirname, '..', 'app')),\n+        'next.config.js': new PatchedFileRef(\n+          join(__dirname, '..', 'next.config.js'),\n+          (content) => content.replace('// distDir', 'distDir')\n+        ),\n+      },\n+    })\n+\n+    it('should render properly in dev', async () => {\n+      expect(next.distDir).toContain('.next-custom')\n+\n+      const res = await next.render('/')\n+      expect(res).toContain('Home')\n+    })\n+  } else {\n+    it('skipped in prod', () => {})\n+  }\n+})"
        },
        {
            "sha": "4b26c43adc9eacae9174778502b0498c905fc1d3",
            "filename": "test/e2e/app-dir-export/test/dynamic-missing-gsp.test.ts",
            "status": "added",
            "additions": 37,
            "deletions": 0,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp.test.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -0,0 +1,37 @@\n+import { isNextDev } from 'e2e-utils'\n+import { runTests } from './utils'\n+\n+describe('app dir - with output export - dynamic missing gsp', () => {\n+  describe('should error when dynamic route is missing generateStaticParams', () => {\n+    runTests({\n+      dynamicPage: 'undefined',\n+      generateStaticParamsOpt: 'set noop',\n+      expectedErrMsg: isNextDev\n+        ? 'Page \"/another/[slug]/page\" is missing exported function \"generateStaticParams()\", which is required with \"output: export\" config.'\n+        : 'Page \"/another/[slug]\" is missing \"generateStaticParams()\" so it cannot be used with \"output: export\" config.',\n+    })\n+  })\n+\n+  describe('should error when client component has generateStaticParams', () => {\n+    const expectedErrMsg = process.env.IS_TURBOPACK_TEST\n+      ? 'App pages cannot use both \"use client\" and export function \"generateStaticParams()\".'\n+      : 'Page \"/another/[slug]/page\" cannot use both \"use client\" and export function \"generateStaticParams()\".'\n+\n+    runTests({\n+      dynamicPage: 'undefined',\n+      generateStaticParamsOpt: 'set client',\n+      expectedErrMsg: expectedErrMsg,\n+    })\n+  })\n+\n+  if (isNextDev) {\n+    describe('should error when dynamic route is set to true', () => {\n+      runTests({\n+        dynamicPage: 'undefined',\n+        dynamicParams: 'true',\n+        expectedErrMsg:\n+          '\"dynamicParams: true\" cannot be used with \"output: export\". See more info here: https://nextjs.org/docs/app/building-your-application/deploying/static-exports',\n+      })\n+    })\n+  }\n+})"
        },
        {
            "sha": "3b4107ea14d528b3d798043e7940398763f490fb",
            "filename": "test/e2e/app-dir-export/test/dynamicapiroute.test.ts",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamicapiroute.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamicapiroute.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamicapiroute.test.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -0,0 +1,23 @@\n+import { runTests } from './utils'\n+\n+describe('app dir - with output export - dynamic api route', () => {\n+  describe.each([\n+    {\n+      dynamicApiRoute: 'undefined',\n+      expectedErrMsg:\n+        'export const dynamic = \"force-static\"/export const revalidate not configured on route',\n+    },\n+    { dynamicApiRoute: \"'error'\" },\n+    { dynamicApiRoute: \"'force-static'\" },\n+    {\n+      dynamicApiRoute: \"'force-dynamic'\",\n+      expectedErrMsg:\n+        'export const dynamic = \"force-dynamic\" on page \"/api/json\" cannot be used with \"output: export\".',\n+    },\n+  ])(\n+    'should work in prod with dynamicApiRoute $dynamicApiRoute',\n+    ({ dynamicApiRoute, expectedErrMsg }) => {\n+      runTests({ dynamicApiRoute, expectedErrMsg })\n+    }\n+  )\n+})"
        },
        {
            "sha": "ae53c3b536b28040c6d5d8cff7005e8639e4fd24",
            "filename": "test/e2e/app-dir-export/test/dynamicpage.test.ts",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamicpage.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamicpage.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fdynamicpage.test.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -0,0 +1,19 @@\n+import { runTests } from './utils'\n+\n+describe('app dir - with output export - dynamic api route', () => {\n+  describe.each([\n+    { dynamicPage: 'undefined' },\n+    { dynamicPage: \"'error'\" },\n+    { dynamicPage: \"'force-static'\" },\n+    {\n+      dynamicPage: \"'force-dynamic'\",\n+      expectedErrMsg:\n+        'Page with `dynamic = \"force-dynamic\"` couldn\\'t be exported. `output: \"export\"` requires all pages be renderable statically',\n+    },\n+  ])(\n+    'should work in prod with dynamicPage $dynamicPage',\n+    ({ dynamicPage, expectedErrMsg }) => {\n+      runTests({ dynamicPage, expectedErrMsg })\n+    }\n+  )\n+})"
        },
        {
            "sha": "f4c60a37ff4bd8120cac6ef3d26e2331bd804157",
            "filename": "test/e2e/app-dir-export/test/start.test.ts",
            "status": "added",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fstart.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fstart.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Ftest%2Fstart.test.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -0,0 +1,51 @@\n+import { join } from 'path'\n+import { isNextStart, nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n+\n+describe('app dir - with output export (next start)', () => {\n+  if (isNextStart) {\n+    const { next } = nextTestSetup({\n+      files: join(__dirname, '..'),\n+      skipStart: true,\n+    })\n+\n+    it('should error during next start with output export', async () => {\n+      const { exitCode } = await next.build()\n+      expect(exitCode).toBe(0)\n+\n+      try {\n+        await next.start({ skipBuild: true })\n+      } catch (e) {}\n+\n+      await retry(() => {\n+        expect(next.cliOutput).toContain(\n+          `\"next start\" does not work with \"output: export\" configuration. Use \"npx serve@latest out\" instead.`\n+        )\n+      })\n+    })\n+\n+    it('should warn during next start with output standalone', async () => {\n+      await next.patchFile(\n+        'next.config.js',\n+        (content) =>\n+          content.replace(`output: 'export'`, `output: 'standalone'`),\n+        async () => {\n+          const { exitCode } = await next.build()\n+          expect(exitCode).toBe(0)\n+\n+          try {\n+            await next.start({ skipBuild: true })\n+          } catch (e) {}\n+\n+          await retry(() => {\n+            expect(next.cliOutput).toContain(\n+              `\"next start\" does not work with \"output: standalone\" configuration. Use \"node .next/standalone/server.js\" instead.`\n+            )\n+          })\n+        }\n+      )\n+    })\n+  } else {\n+    it('skipped in dev', () => {})\n+  }\n+})"
        },
        {
            "sha": "716fa9e3cc47abdd11c5b4414df708e5d6381727",
            "filename": "test/e2e/app-dir-export/test/trailing-slash.test.ts",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Ftrailing-slash.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Ftrailing-slash.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Ftest%2Ftrailing-slash.test.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -0,0 +1,10 @@\n+import { runTests } from './utils'\n+\n+describe('app dir - with output export - trailing slash', () => {\n+  describe.each([{ trailingSlash: false }, { trailingSlash: true }])(\n+    \"should work in prod with trailingSlash '$trailingSlash'\",\n+    ({ trailingSlash }) => {\n+      runTests({ trailingSlash })\n+    }\n+  )\n+})"
        },
        {
            "sha": "2f315966cb00d5c77d6a667275b50520046017c9",
            "filename": "test/e2e/app-dir-export/test/utils.ts",
            "status": "renamed",
            "additions": 125,
            "deletions": 89,
            "changes": 214,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Fe2e%2Fapp-dir-export%2Ftest%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir-export%2Ftest%2Futils.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -3,30 +3,21 @@\n import { join } from 'path'\n import { promisify } from 'util'\n import fs from 'fs-extra'\n-import webdriver from 'next-webdriver'\n import globOrig from 'glob'\n import {\n   waitForRedbox,\n-  check,\n-  fetchViaHTTP,\n-  File,\n-  findPort,\n   getRedboxHeader,\n   getRedboxSource,\n-  killApp,\n-  launchApp,\n-  nextBuild,\n+  retry,\n+  findPort,\n   startStaticServer,\n   stopApp,\n+  fetchViaHTTP,\n } from 'next-test-utils'\n+import { nextTestSetup } from 'e2e-utils'\n+import webdriver from 'next-webdriver'\n \n const glob = promisify(globOrig)\n-export const appDir = join(__dirname, '..')\n-export const distDir = join(appDir, '.next')\n-export const exportDir = join(appDir, 'out')\n-export const nextConfig = new File(join(appDir, 'next.config.js'))\n-const slugPage = new File(join(appDir, 'app/another/[slug]/page.js'))\n-const apiJson = new File(join(appDir, 'app/api/json/route.js'))\n \n export const expectedWhenTrailingSlashTrue = [\n   '404.html',\n@@ -180,7 +171,7 @@ const expectedWhenTrailingSlashFalse = [\n   'robots.txt',\n ]\n \n-export async function getFiles(cwd = exportDir) {\n+export async function getFiles(cwd) {\n   const opts = { cwd, nodir: true }\n   const files = ((await glob('**/*', opts)) as string[])\n     .filter(\n@@ -192,79 +183,102 @@ export async function getFiles(cwd = exportDir) {\n     .sort()\n   return files\n }\n-export async function runTests({\n-  isDev = false,\n+export function runTests({\n   trailingSlash = true,\n   dynamicPage,\n   dynamicParams,\n   dynamicApiRoute,\n   generateStaticParamsOpt,\n   expectedErrMsg,\n }: {\n-  isDev?: boolean\n   trailingSlash?: boolean\n   dynamicPage?: string\n   dynamicParams?: string\n   dynamicApiRoute?: string\n   generateStaticParamsOpt?: 'set noop' | 'set client'\n   expectedErrMsg?: string | RegExp\n }) {\n-  if (trailingSlash !== undefined) {\n-    nextConfig.replace(\n-      'trailingSlash: true,',\n-      `trailingSlash: ${trailingSlash},`\n-    )\n+  let { next, skipped, isNextDev } = nextTestSetup({\n+    files: join(__dirname, '..'),\n+    skipDeployment: true,\n+    skipStart: true,\n+  })\n+  if (skipped) {\n+    return\n   }\n \n-  if (dynamicPage !== undefined) {\n-    slugPage.replace(\n-      `export const dynamic = 'force-static'`,\n-      dynamicPage === 'undefined' ? '' : `export const dynamic = ${dynamicPage}`\n-    )\n-  }\n+  beforeAll(async () => {\n+    if (trailingSlash !== undefined) {\n+      await next.patchFile('next.config.js', (content) =>\n+        content.replace(\n+          'trailingSlash: true,',\n+          `trailingSlash: ${trailingSlash},`\n+        )\n+      )\n+    }\n \n-  if (dynamicApiRoute !== undefined) {\n-    apiJson.replace(\n-      `export const dynamic = 'force-static'`,\n-      `export const dynamic = ${dynamicApiRoute}`\n-    )\n-  }\n+    if (dynamicPage !== undefined) {\n+      await next.patchFile('app/another/[slug]/page.js', (content) =>\n+        content.replace(\n+          `export const dynamic = 'force-static'`,\n+          dynamicPage === 'undefined'\n+            ? ''\n+            : `export const dynamic = ${dynamicPage}`\n+        )\n+      )\n+    }\n \n-  if (dynamicParams !== undefined) {\n-    slugPage.prepend(`export const dynamicParams = ${dynamicParams}\\n`)\n-  }\n+    if (dynamicApiRoute !== undefined) {\n+      await next.patchFile('app/api/json/route.js', (content) =>\n+        content.replace(\n+          `export const dynamic = 'force-static'`,\n+          `export const dynamic = ${dynamicApiRoute}`\n+        )\n+      )\n+    }\n \n-  if (generateStaticParamsOpt === 'set noop') {\n-    slugPage.replace('export function generateStaticParams', 'function noop')\n-  } else if (generateStaticParamsOpt === 'set client') {\n-    slugPage.prepend('\"use client\"\\n')\n-  }\n-  await fs.remove(distDir)\n-  await fs.remove(exportDir)\n-  const port = await findPort()\n-  let stopOrKill: () => Promise<void>\n-  let result = { code: 0, stdout: '', stderr: '' }\n-  if (isDev) {\n-    const app = await launchApp(appDir, port, {\n-      stdout: false,\n-      onStdout(msg: string) {\n-        result.stdout += msg || ''\n-      },\n-      stderr: false,\n-      onStderr(msg: string) {\n-        result.stderr += msg || ''\n-      },\n-    })\n-    stopOrKill = async () => await killApp(app)\n-  } else {\n-    result = await nextBuild(appDir, [], { stdout: true, stderr: true })\n-    const app = await startStaticServer(exportDir, null, port)\n-    stopOrKill = async () => await stopApp(app)\n-  }\n+    if (dynamicParams !== undefined) {\n+      await next.patchFile(\n+        'app/another/[slug]/page.js',\n+        (content) => `export const dynamicParams = ${dynamicParams}\\n` + content\n+      )\n+    }\n+\n+    if (generateStaticParamsOpt === 'set noop') {\n+      await next.patchFile('app/another/[slug]/page.js', (content) =>\n+        content.replace('export function generateStaticParams', 'function noop')\n+      )\n+    } else if (generateStaticParamsOpt === 'set client') {\n+      await next.patchFile(\n+        'app/another/[slug]/page.js',\n+        (content) => '\"use client\"\\n' + content\n+      )\n+    }\n+  })\n \n-  try {\n+  let port: number\n+  let stopOrKill: (() => Promise<void>) | undefined\n+  beforeAll(async () => {\n+    if (isNextDev) {\n+      await next.start()\n+      port = Number(next.appPort)\n+    } else {\n+      await next.build()\n+\n+      port = await findPort()\n+      const app = await startStaticServer(join(next.testDir, 'out'), null, port)\n+      stopOrKill = () => stopApp(app)\n+    }\n+  })\n+  afterAll(async () => {\n+    if (stopOrKill) {\n+      await stopOrKill()\n+    }\n+  })\n+\n+  it('should work', async () => {\n     if (expectedErrMsg) {\n-      if (isDev) {\n+      if (isNextDev) {\n         const url = dynamicPage ? '/another/first' : '/api/json'\n         const browser = await webdriver(port, url)\n         await waitForRedbox(browser)\n@@ -276,58 +290,80 @@ export async function runTests({\n           expect(`${header}\\n${source}`).toContain(expectedErrMsg)\n         }\n       } else {\n-        await check(() => result.stderr, /error/i)\n+        await retry(() => expect(next.cliOutput).toMatch(/error/i))\n       }\n-      expect(result.stderr).toMatch(expectedErrMsg)\n+      expect(next.cliOutput).toMatch(expectedErrMsg)\n     } else {\n       const a = (n: number) => `li:nth-child(${n}) a`\n       const browser = await webdriver(port, '/')\n-      await check(() => browser.elementByCss('h1').text(), 'Home')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('Home')\n+      )\n       expect(await browser.elementByCss(a(1)).text()).toBe(\n         'another no trailingslash'\n       )\n       await browser.elementByCss(a(1)).click()\n \n-      await check(() => browser.elementByCss('h1').text(), 'Another')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('Another')\n+      )\n       expect(await browser.elementByCss(a(1)).text()).toBe(\n         'Visit the home page'\n       )\n       await browser.elementByCss(a(1)).click()\n \n-      await check(() => browser.elementByCss('h1').text(), 'Home')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('Home')\n+      )\n       expect(await browser.elementByCss(a(2)).text()).toBe(\n         'another has trailingslash'\n       )\n       await browser.elementByCss(a(2)).click()\n \n-      await check(() => browser.elementByCss('h1').text(), 'Another')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('Another')\n+      )\n       expect(await browser.elementByCss(a(1)).text()).toBe(\n         'Visit the home page'\n       )\n       await browser.elementByCss(a(1)).click()\n \n-      await check(() => browser.elementByCss('h1').text(), 'Home')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('Home')\n+      )\n       expect(await browser.elementByCss(a(3)).text()).toBe('another first page')\n       await browser.elementByCss(a(3)).click()\n-      await check(() => browser.elementByCss('h1').text(), 'first')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('first')\n+      )\n       expect(await browser.elementByCss(a(1)).text()).toBe('Visit another page')\n       await browser.elementByCss(a(1)).click()\n \n-      await check(() => browser.elementByCss('h1').text(), 'Another')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('Another')\n+      )\n       expect(await browser.elementByCss(a(4)).text()).toBe(\n         'another second page'\n       )\n       await browser.elementByCss(a(4)).click()\n \n-      await check(() => browser.elementByCss('h1').text(), 'second')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('second')\n+      )\n       expect(await browser.elementByCss(a(1)).text()).toBe('Visit another page')\n       await browser.elementByCss(a(1)).click()\n \n-      await check(() => browser.elementByCss('h1').text(), 'Another')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain('Another')\n+      )\n       expect(await browser.elementByCss(a(5)).text()).toBe('image import page')\n       await browser.elementByCss(a(5)).click()\n \n-      await check(() => browser.elementByCss('h1').text(), 'Image Import')\n+      await retry(async () =>\n+        expect(await browser.elementByCss('h1').text()).toContain(\n+          'Image Import'\n+        )\n+      )\n       expect(await browser.elementByCss(a(2)).text()).toBe('View the image')\n       expect(await browser.elementByCss(a(2)).getAttribute('href')).toMatch(\n         /\\/test\\.(.*)\\.png/\n@@ -340,20 +376,20 @@ export async function runTests({\n       expect(res2.status).toBe(200)\n       expect(await res2.text()).toEqual('this is plain text')\n \n-      if (!isDev) {\n+      if (!isNextDev) {\n+        let outputDir = join(next.testDir, 'out')\n         if (trailingSlash) {\n-          expect(await getFiles()).toEqual(expectedWhenTrailingSlashTrue)\n+          expect(await getFiles(outputDir)).toEqual(\n+            expectedWhenTrailingSlashTrue\n+          )\n         } else {\n-          expect(await getFiles()).toEqual(expectedWhenTrailingSlashFalse)\n+          expect(await getFiles(outputDir)).toEqual(\n+            expectedWhenTrailingSlashFalse\n+          )\n         }\n-        const html404 = await fs.readFile(join(exportDir, '404.html'), 'utf8')\n+        const html404 = await fs.readFile(join(outputDir, '404.html'), 'utf8')\n         expect(html404).toContain('<h1>My custom not found page</h1>')\n       }\n     }\n-  } finally {\n-    await stopOrKill()\n-    nextConfig.restore()\n-    slugPage.restore()\n-    apiJson.restore()\n-  }\n+  })\n }",
            "previous_filename": "test/integration/app-dir-export/test/utils.ts"
        },
        {
            "sha": "a450e982e2a2f80fdb08655f3e964c406396c56d",
            "filename": "test/integration/app-dir-export/test/config.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 94,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fconfig.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fconfig.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fconfig.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,94 +0,0 @@\n-import fs from 'fs-extra'\n-import { nextBuild, runNextCommand } from 'next-test-utils'\n-import { join } from 'path'\n-import {\n-  appDir,\n-  distDir,\n-  expectedWhenTrailingSlashTrue,\n-  exportDir,\n-  getFiles,\n-  nextConfig,\n-} from './utils'\n-\n-describe('app dir - with output export (next dev / next build)', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      it('should throw when exportPathMap configured', async () => {\n-        nextConfig.replace(\n-          'trailingSlash: true,',\n-          `trailingSlash: true,\n-       exportPathMap: async function (map) {\n-        return map\n-      },`\n-        )\n-        await fs.remove(distDir)\n-        await fs.remove(exportDir)\n-        let result = { code: 0, stderr: '' }\n-        try {\n-          result = await nextBuild(appDir, [], { stderr: true })\n-        } finally {\n-          nextConfig.restore()\n-        }\n-        expect(result.code).toBe(1)\n-        expect(result.stderr).toContain(\n-          'The \"exportPathMap\" configuration cannot be used with the \"app\" directory. Please use generateStaticParams() instead.'\n-        )\n-      })\n-      it('should error when running next export', async () => {\n-        await fs.remove(distDir)\n-        await fs.remove(exportDir)\n-        nextConfig.delete()\n-        try {\n-          await nextBuild(appDir)\n-          expect(await getFiles()).toEqual([])\n-          let stdout = ''\n-          let stderr = ''\n-          let error = undefined\n-          try {\n-            await runNextCommand(['export', appDir], {\n-              onStdout(msg) {\n-                stdout += msg\n-              },\n-              onStderr(msg) {\n-                stderr += msg\n-              },\n-            })\n-          } catch (e) {\n-            error = e\n-          }\n-          expect(error).toBeDefined()\n-          expect(stderr).toContain(\n-            `\\`next export\\` has been removed in favor of 'output: export' in next.config.js`\n-          )\n-          expect(stdout).not.toContain('Export successful. Files written to')\n-          expect(await getFiles()).toEqual([])\n-        } finally {\n-          nextConfig.restore()\n-          await fs.remove(distDir)\n-          await fs.remove(exportDir)\n-        }\n-      })\n-      it('should correctly emit exported assets to config.distDir', async () => {\n-        const outputDir = join(appDir, 'output')\n-        await fs.remove(distDir)\n-        await fs.remove(outputDir)\n-        nextConfig.replace(\n-          'trailingSlash: true,',\n-          `trailingSlash: true,\n-       distDir: 'output',`\n-        )\n-        try {\n-          await nextBuild(appDir)\n-          expect(await getFiles(outputDir)).toEqual(\n-            expectedWhenTrailingSlashTrue\n-          )\n-        } finally {\n-          nextConfig.restore()\n-          await fs.remove(distDir)\n-          await fs.remove(outputDir)\n-        }\n-      })\n-    }\n-  )\n-})"
        },
        {
            "sha": "e64d07f475b755717cad602b08ce1cdada002e62",
            "filename": "test/integration/app-dir-export/test/dev-custom-dist-dir.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 36,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdev-custom-dist-dir.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdev-custom-dist-dir.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdev-custom-dist-dir.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,36 +0,0 @@\n-/* eslint-env jest */\n-\n-import { join } from 'path'\n-import fs from 'fs-extra'\n-import {\n-  fetchViaHTTP,\n-  File,\n-  findPort,\n-  killApp,\n-  launchApp,\n-} from 'next-test-utils'\n-\n-const appDir = join(__dirname, '..')\n-const distDir = join(appDir, '.next-custom')\n-const nextConfig = new File(join(appDir, 'next.config.js'))\n-let app\n-let appPort\n-\n-describe('app dir - with output export and custom distDir (next dev)', () => {\n-  beforeAll(async () => {\n-    nextConfig.replace('// distDir', 'distDir')\n-    appPort = await findPort()\n-    app = await launchApp(appDir, appPort)\n-  })\n-  afterAll(async () => {\n-    nextConfig.restore()\n-    await fs.remove(distDir)\n-    await killApp(app)\n-  })\n-\n-  it('should render properly', async () => {\n-    const res = await fetchViaHTTP(appPort, '/')\n-    expect(res.status).toBe(200)\n-    expect(await res.text()).toContain('Home')\n-  })\n-})"
        },
        {
            "sha": "c053a5056307bd516ee7ac470cae505091357b85",
            "filename": "test/integration/app-dir-export/test/dynamic-missing-gsp-dev.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 40,
            "changes": 40,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-dev.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-dev.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-dev.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,40 +0,0 @@\n-import { runTests } from './utils'\n-\n-describe('app dir - with output export - dynamic missing gsp dev', () => {\n-  ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n-    'development mode',\n-    () => {\n-      it('should error when dynamic route is missing generateStaticParams', async () => {\n-        await runTests({\n-          isDev: true,\n-          dynamicPage: 'undefined',\n-          generateStaticParamsOpt: 'set noop',\n-          expectedErrMsg:\n-            'Page \"/another/[slug]/page\" is missing exported function \"generateStaticParams()\", which is required with \"output: export\" config.',\n-        })\n-      })\n-\n-      it('should error when dynamic route is set to true', async () => {\n-        await runTests({\n-          isDev: true,\n-          dynamicPage: 'undefined',\n-          dynamicParams: 'true',\n-          expectedErrMsg:\n-            '\"dynamicParams: true\" cannot be used with \"output: export\". See more info here: https://nextjs.org/docs/app/building-your-application/deploying/static-exports',\n-        })\n-      })\n-\n-      it('should error when client component has generateStaticParams', async () => {\n-        const expectedErrMsg = process.env.IS_TURBOPACK_TEST\n-          ? 'App pages cannot use both \"use client\" and export function \"generateStaticParams()\".'\n-          : 'Page \"/another/[slug]/page\" cannot use both \"use client\" and export function \"generateStaticParams()\".'\n-        await runTests({\n-          isDev: true,\n-          dynamicPage: 'undefined',\n-          generateStaticParamsOpt: 'set client',\n-          expectedErrMsg,\n-        })\n-      })\n-    }\n-  )\n-})"
        },
        {
            "sha": "654754b353ebf9714968c316100d11d6f480ccb9",
            "filename": "test/integration/app-dir-export/test/dynamic-missing-gsp-prod.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 31,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-prod.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-prod.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamic-missing-gsp-prod.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,31 +0,0 @@\n-import { runTests } from './utils'\n-\n-describe('app dir - with output export - dynamic missing gsp prod', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      it('should error when dynamic route is missing generateStaticParams', async () => {\n-        await runTests({\n-          isDev: false,\n-          dynamicPage: 'undefined',\n-          generateStaticParamsOpt: 'set noop',\n-          expectedErrMsg:\n-            'Page \"/another/[slug]\" is missing \"generateStaticParams()\" so it cannot be used with \"output: export\" config.',\n-        })\n-      })\n-\n-      it('should error when client component has generateStaticParams', async () => {\n-        const expectedErrMsg = process.env.IS_TURBOPACK_TEST\n-          ? 'App pages cannot use both \"use client\" and export function \"generateStaticParams()\".'\n-          : 'Page \"/another/[slug]/page\" cannot use both \"use client\" and export function \"generateStaticParams()\".'\n-\n-        await runTests({\n-          isDev: false,\n-          dynamicPage: 'undefined',\n-          generateStaticParamsOpt: 'set client',\n-          expectedErrMsg: expectedErrMsg,\n-        })\n-      })\n-    }\n-  )\n-})"
        },
        {
            "sha": "46075a5b7f8b171d84c8b57843118e2829facd06",
            "filename": "test/integration/app-dir-export/test/dynamicapiroute-dev.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 28,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicapiroute-dev.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicapiroute-dev.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicapiroute-dev.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,28 +0,0 @@\n-import { runTests } from './utils'\n-\n-describe('app dir - with output export - dynamic api route dev', () => {\n-  ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n-    'development mode',\n-    () => {\n-      it.each([\n-        {\n-          dynamicApiRoute: 'undefined',\n-          expectedErrMsg:\n-            'export const dynamic = \"force-static\"/export const revalidate not configured on route',\n-        },\n-        { dynamicApiRoute: \"'error'\" },\n-        { dynamicApiRoute: \"'force-static'\" },\n-        {\n-          dynamicApiRoute: \"'force-dynamic'\",\n-          expectedErrMsg:\n-            'export const dynamic = \"force-dynamic\" on page \"/api/json\" cannot be used with \"output: export\".',\n-        },\n-      ])(\n-        'should work in dev with dynamicApiRoute $dynamicApiRoute',\n-        async ({ dynamicApiRoute, expectedErrMsg }) => {\n-          await runTests({ isDev: true, dynamicApiRoute, expectedErrMsg })\n-        }\n-      )\n-    }\n-  )\n-})"
        },
        {
            "sha": "3161bffcfd3d3606b8462c608e0c803e08119150",
            "filename": "test/integration/app-dir-export/test/dynamicapiroute-prod.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 28,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicapiroute-prod.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicapiroute-prod.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicapiroute-prod.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,28 +0,0 @@\n-import { runTests } from './utils'\n-\n-describe('app dir - with output export - dynamic api route prod', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      it.each([\n-        {\n-          dynamicApiRoute: 'undefined',\n-          expectedErrMsg:\n-            'export const dynamic = \"force-static\"/export const revalidate not configured on route',\n-        },\n-        { dynamicApiRoute: \"'error'\" },\n-        { dynamicApiRoute: \"'force-static'\" },\n-        {\n-          dynamicApiRoute: \"'force-dynamic'\",\n-          expectedErrMsg:\n-            'export const dynamic = \"force-dynamic\" on page \"/api/json\" cannot be used with \"output: export\".',\n-        },\n-      ])(\n-        'should work in prod with dynamicApiRoute $dynamicApiRoute',\n-        async ({ dynamicApiRoute, expectedErrMsg }) => {\n-          await runTests({ isDev: false, dynamicApiRoute, expectedErrMsg })\n-        }\n-      )\n-    }\n-  )\n-})"
        },
        {
            "sha": "0220d9c28e298cd7a14074a66171e450a113fe7d",
            "filename": "test/integration/app-dir-export/test/dynamicpage-dev.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicpage-dev.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicpage-dev.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicpage-dev.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,24 +0,0 @@\n-import { runTests } from './utils'\n-\n-describe('app dir - with output export - dynamic page dev', () => {\n-  ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n-    'development mode',\n-    () => {\n-      it.each([\n-        { dynamicPage: 'undefined' },\n-        { dynamicPage: \"'error'\" },\n-        { dynamicPage: \"'force-static'\" },\n-        {\n-          dynamicPage: \"'force-dynamic'\",\n-          expectedErrMsg:\n-            'Page with `dynamic = \"force-dynamic\"` couldn\\'t be exported. `output: \"export\"` requires all pages be renderable statically',\n-        },\n-      ])(\n-        'should work in dev with dynamicPage $dynamicPage',\n-        async ({ dynamicPage, expectedErrMsg }) => {\n-          await runTests({ isDev: true, dynamicPage, expectedErrMsg })\n-        }\n-      )\n-    }\n-  )\n-})"
        },
        {
            "sha": "4a04638cd42c8da52d6fd3e99cda8a489e650e2d",
            "filename": "test/integration/app-dir-export/test/dynamicpage-prod.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 24,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicpage-prod.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicpage-prod.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fdynamicpage-prod.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,24 +0,0 @@\n-import { runTests } from './utils'\n-\n-describe('app dir - with output export - dynamic api route prod', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      it.each([\n-        { dynamicPage: 'undefined' },\n-        { dynamicPage: \"'error'\" },\n-        { dynamicPage: \"'force-static'\" },\n-        {\n-          dynamicPage: \"'force-dynamic'\",\n-          expectedErrMsg:\n-            'Page with `dynamic = \"force-dynamic\"` couldn\\'t be exported. `output: \"export\"` requires all pages be renderable statically',\n-        },\n-      ])(\n-        'should work in prod with dynamicPage $dynamicPage',\n-        async ({ dynamicPage, expectedErrMsg }) => {\n-          await runTests({ isDev: false, dynamicPage, expectedErrMsg })\n-        }\n-      )\n-    }\n-  )\n-})"
        },
        {
            "sha": "21545989c7c3a77a37f930a9d4506ab9828d91d6",
            "filename": "test/integration/app-dir-export/test/start.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 71,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fstart.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fstart.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Fstart.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,71 +0,0 @@\n-/* eslint-env jest */\n-\n-import { join } from 'path'\n-import fs from 'fs-extra'\n-import {\n-  check,\n-  File,\n-  findPort,\n-  killApp,\n-  nextBuild,\n-  nextStart,\n-} from 'next-test-utils'\n-\n-const appDir = join(__dirname, '..')\n-const distDir = join(appDir, '.next')\n-const exportDir = join(appDir, 'out')\n-const nextConfig = new File(join(appDir, 'next.config.js'))\n-let app\n-\n-describe('app dir - with output export (next start)', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      afterEach(async () => {\n-        await killApp(app)\n-        nextConfig.restore()\n-        await fs.remove(distDir)\n-        await fs.remove(exportDir)\n-      })\n-\n-      it('should error during next start with output export', async () => {\n-        const { code } = await nextBuild(appDir)\n-        expect(code).toBe(0)\n-        const port = await findPort()\n-        let stderr = ''\n-        app = await nextStart(appDir, port, {\n-          onStderr(msg: string) {\n-            stderr += msg || ''\n-          },\n-        })\n-        await check(() => stderr, /error/i)\n-        expect(stderr).toContain(\n-          '\"next start\" does not work with \"output: export\" configuration. Use \"npx serve@latest out\" instead.'\n-        )\n-      })\n-\n-      // TODO: Move this test to test/production to run in isolation.\n-      ;(process.env.TURBOPACK_BUILD ? it.skip : it)(\n-        'should warn during next start with output standalone',\n-        async () => {\n-          nextConfig.replace(`output: 'export'`, `output: 'standalone'`)\n-          const { code } = await nextBuild(appDir)\n-          // eslint-disable-next-line jest/no-standalone-expect\n-          expect(code).toBe(0)\n-          const port = await findPort()\n-          let stderr = ''\n-          app = await nextStart(appDir, port, {\n-            onStderr(msg: string) {\n-              stderr += msg || ''\n-            },\n-          })\n-          await check(() => stderr, /⚠/i)\n-          // eslint-disable-next-line jest/no-standalone-expect\n-          expect(stderr).toContain(\n-            `\"next start\" does not work with \"output: standalone\" configuration. Use \"node .next/standalone/server.js\" instead.`\n-          )\n-        }\n-      )\n-    }\n-  )\n-})"
        },
        {
            "sha": "e0d8c6a3dc0aa904bebf54c44f5c9d66b6807770",
            "filename": "test/integration/app-dir-export/test/trailing-slash-dev.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Ftrailing-slash-dev.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Ftrailing-slash-dev.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Ftrailing-slash-dev.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,15 +0,0 @@\n-import { runTests } from './utils'\n-\n-describe('app dir - with output export - trailing slash dev', () => {\n-  ;(process.env.TURBOPACK_BUILD ? describe.skip : describe)(\n-    'development mode',\n-    () => {\n-      it.each([{ trailingSlash: false }, { trailingSlash: true }])(\n-        \"should work in dev with trailingSlash '$trailingSlash'\",\n-        async ({ trailingSlash }) => {\n-          await runTests({ isDev: true, trailingSlash })\n-        }\n-      )\n-    }\n-  )\n-})"
        },
        {
            "sha": "fc3964600e7af04839fa7b44d7999f96f795a32d",
            "filename": "test/integration/app-dir-export/test/trailing-slash-start.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 15,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Ftrailing-slash-start.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f71ce534a8e9429f4341998ae386b23055c5888c/test%2Fintegration%2Fapp-dir-export%2Ftest%2Ftrailing-slash-start.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fapp-dir-export%2Ftest%2Ftrailing-slash-start.test.ts?ref=f71ce534a8e9429f4341998ae386b23055c5888c",
            "patch": "@@ -1,15 +0,0 @@\n-import { runTests } from './utils'\n-\n-describe('app dir - with output export - trailing slash prod', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      it.each([{ trailingSlash: false }, { trailingSlash: true }])(\n-        \"should work in prod with trailingSlash '$trailingSlash'\",\n-        async ({ trailingSlash }) => {\n-          await runTests({ isDev: false, trailingSlash })\n-        }\n-      )\n-    }\n-  )\n-})"
        },
        {
            "sha": "fdac23b30939c0be8ea6e6f79951c205759d48ed",
            "filename": "test/lib/e2e-utils/index.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Flib%2Fe2e-utils%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Flib%2Fe2e-utils%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fe2e-utils%2Findex.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -127,6 +127,20 @@ export class FileRef {\n   }\n }\n \n+/**\n+ * FileRef is wrapper around a file path that is meant be copied\n+ * to the location where the next instance is being created\n+ */\n+export class PatchedFileRef {\n+  public fsPath: string\n+  public cb: (content: string) => string\n+\n+  constructor(path: string, cb: (content: string) => string) {\n+    this.fsPath = path\n+    this.cb = cb\n+  }\n+}\n+\n let nextInstance: NextInstance | undefined = undefined\n \n if (typeof afterAll === 'function') {"
        },
        {
            "sha": "ff609f34a44106b4ac9c618c066540ecf0660a93",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -3,7 +3,7 @@ import path from 'path'\n import { existsSync, promises as fs, rmSync, readFileSync } from 'fs'\n import treeKill from 'tree-kill'\n import type { NextConfig } from 'next'\n-import { FileRef, isNextDeploy } from '../e2e-utils'\n+import { FileRef, isNextDeploy, PatchedFileRef } from '../e2e-utils'\n import { ChildProcess } from 'child_process'\n import { createNextInstall } from '../create-next-install'\n import { Span } from 'next/dist/trace'\n@@ -30,7 +30,10 @@ export type PackageJson = {\n   [key: string]: unknown\n }\n \n-type ResolvedFileConfig = FileRef | { [filename: string]: string | FileRef }\n+type ResolvedFileConfig =\n+  | FileRef\n+  | PatchedFileRef\n+  | { [filename: string]: string | FileRef | PatchedFileRef }\n type FilesConfig = ResolvedFileConfig | string\n export interface NextInstanceOpts {\n   files: FilesConfig\n@@ -155,7 +158,7 @@ export class NextInstance {\n         if (typeof item === 'string') {\n           await fs.mkdir(path.dirname(outputFilename), { recursive: true })\n           await fs.writeFile(outputFilename, item)\n-        } else {\n+        } else if (item instanceof FileRef) {\n           try {\n             const existingStat = await fs.lstat(outputFilename)\n             if (existingStat.isFile() || existingStat.isSymbolicLink()) {\n@@ -166,6 +169,20 @@ export class NextInstance {\n           }\n \n           await fs.cp(item.fsPath, outputFilename, { recursive: true })\n+        } else if (item instanceof PatchedFileRef) {\n+          try {\n+            const existingStat = await fs.lstat(outputFilename)\n+            if (existingStat.isFile() || existingStat.isSymbolicLink()) {\n+              await fs.unlink(outputFilename)\n+            }\n+          } catch {\n+            // file might not exist or can't be unliked. carry on\n+          }\n+\n+          await fs.writeFile(\n+            outputFilename,\n+            item.cb(await fs.readFile(item.fsPath, 'utf8'))\n+          )\n         }\n       }\n     }"
        },
        {
            "sha": "1aa0597d63d078c0abd769d0ef463d8e71c804ab",
            "filename": "test/lib/next-modes/next-start.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/0683859c93e8671636c1e037450ccf358c2a3384/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0683859c93e8671636c1e037450ccf358c2a3384/test%2Flib%2Fnext-modes%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-start.ts?ref=0683859c93e8671636c1e037450ccf358c2a3384",
            "patch": "@@ -110,13 +110,15 @@ export class NextStartInstance extends NextInstance {\n         this.handleStdio(this.childProcess)\n \n         this.childProcess.on('close', (code, signal) => {\n-          if (this.isStopping) return\n+          this.childProcess = undefined\n           if (code || signal) {\n-            require('console').error(\n-              `next start exited unexpectedly with code/signal ${\n-                code || signal\n-              }`\n-            )\n+            let message = `next start exited unexpectedly with code/signal ${\n+              code || signal\n+            }`\n+            if (!this.isStopping) {\n+              require('console').error(message)\n+            }\n+            reject(new Error(message))\n           }\n         })\n "
        }
    ],
    "stats": {
        "total": 945,
        "additions": 441,
        "deletions": 504
    }
}