{
    "author": "lukesandberg",
    "message": "Remove `turbo_tasks::function` from `AssetContext::layer` (#80592)\n\n## Refactor `AssetContext.layer()` from a task function to a regular method\n\n### Why?\nThis eliminates a turbo task and a cell, but does not change invalidation behavior.\n\nI don't really anticipate a performance delta in any direction, but this this means in  https://github.com/vercel/next.js/pull/80388 the new `LayerName` struct would not need to be a `turbo_tasks::value`",
    "sha": "2555cdff13a328852373ff34e3feeb4bcb55b733",
    "files": [
        {
            "sha": "4a1c54d46e0ad1bc7141bf7677f7ef8ce2c4e032",
            "filename": "crates/next-core/src/next_client_reference/ecmascript_client_reference/ecmascript_client_reference_module.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2555cdff13a328852373ff34e3feeb4bcb55b733/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2555cdff13a328852373ff34e3feeb4bcb55b733/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs?ref=2555cdff13a328852373ff34e3feeb4bcb55b733",
            "patch": "@@ -3,7 +3,7 @@ use std::{io::Write, iter::once};\n use anyhow::{Context, Result, bail};\n use indoc::writedoc;\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n+use turbo_tasks::{IntoTraitRef, ResolvedVc, ValueToString, Vc};\n use turbo_tasks_fs::File;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n@@ -187,7 +187,7 @@ impl Module for EcmascriptClientReferenceModule {\n         Ok(self\n             .server_ident\n             .with_modifier(rcstr!(\"client reference proxy\"))\n-            .with_layer(self.server_asset_context.layer().owned().await?))\n+            .with_layer(self.server_asset_context.into_trait_ref().await?.layer()))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "a174d101c7b81ea5dca7c33859c10ced1b93a8fe",
            "filename": "turbopack/crates/turbopack-core/src/context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcontext.rs?ref=2555cdff13a328852373ff34e3feeb4bcb55b733",
            "patch": "@@ -64,8 +64,7 @@ pub trait AssetContext {\n     fn compile_time_info(self: Vc<Self>) -> Vc<CompileTimeInfo>;\n \n     /// Gets the layer of the asset context.\n-    #[turbo_tasks::function]\n-    fn layer(self: Vc<Self>) -> Vc<RcStr>;\n+    fn layer(&self) -> RcStr;\n \n     /// Gets the resolve options for a given path.\n     #[turbo_tasks::function]"
        },
        {
            "sha": "93b319097cf6edd947cf9176d16c64e7f6d061e7",
            "filename": "turbopack/crates/turbopack-css/src/asset.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs?ref=2555cdff13a328852373ff34e3feeb4bcb55b733",
            "patch": "@@ -1,6 +1,6 @@\n use anyhow::Result;\n use turbo_rcstr::rcstr;\n-use turbo_tasks::{ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n+use turbo_tasks::{IntoTraitRef, ResolvedVc, TryJoinIterExt, ValueToString, Vc};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n@@ -121,7 +121,7 @@ impl Module for CssModuleAsset {\n             .source\n             .ident()\n             .with_modifier(rcstr!(\"css\"))\n-            .with_layer(self.asset_context.layer().owned().await?);\n+            .with_layer(self.asset_context.into_trait_ref().await?.layer());\n         if let Some(import_context) = self.import_context {\n             ident = ident.with_modifier(import_context.modifier().owned().await?)\n         }"
        },
        {
            "sha": "d93d819b5cf495d0487c913bb4a10f1bf3921799",
            "filename": "turbopack/crates/turbopack-css/src/module_asset.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs?ref=2555cdff13a328852373ff34e3feeb4bcb55b733",
            "patch": "@@ -5,7 +5,7 @@ use indoc::formatdoc;\n use lightningcss::css_modules::CssModuleReference;\n use swc_core::common::{BytePos, FileName, LineCol, SourceMap};\n use turbo_rcstr::{RcStr, rcstr};\n-use turbo_tasks::{FxIndexMap, ResolvedVc, ValueToString, Vc};\n+use turbo_tasks::{FxIndexMap, IntoTraitRef, ResolvedVc, ValueToString, Vc};\n use turbo_tasks_fs::{FileSystemPath, rope::Rope};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n@@ -64,7 +64,7 @@ impl Module for ModuleCssAsset {\n             .source\n             .ident()\n             .with_modifier(rcstr!(\"css module\"))\n-            .with_layer(self.asset_context.layer().owned().await?))\n+            .with_layer(self.asset_context.into_trait_ref().await?.layer()))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "33377c65e87b179e9d706edb25185fbc4db24eb9",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=2555cdff13a328852373ff34e3feeb4bcb55b733",
            "patch": "@@ -71,8 +71,8 @@ pub use transform::{\n };\n use turbo_rcstr::rcstr;\n use turbo_tasks::{\n-    FxIndexMap, NonLocalValue, ReadRef, ResolvedVc, TaskInput, TryJoinIterExt, ValueToString, Vc,\n-    trace::TraceRawVcs,\n+    FxIndexMap, IntoTraitRef, NonLocalValue, ReadRef, ResolvedVc, TaskInput, TryJoinIterExt,\n+    ValueToString, Vc, trace::TraceRawVcs,\n };\n use turbo_tasks_fs::{FileJsonContent, FileSystemPath, glob::Glob, rope::Rope};\n use turbopack_core::{\n@@ -645,7 +645,7 @@ impl Module for EcmascriptModuleAsset {\n             }\n         }\n         ident.add_modifier(rcstr!(\"ecmascript\"));\n-        ident.layer = Some(self.asset_context.layer().owned().await?);\n+        ident.layer = Some(self.asset_context.into_trait_ref().await?.layer());\n         Ok(AssetIdent::new(ident))\n     }\n "
        },
        {
            "sha": "7e77482e423ccf2177793842b519ce4a65626aca",
            "filename": "turbopack/crates/turbopack-wasm/src/module_asset.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fmodule_asset.rs?ref=2555cdff13a328852373ff34e3feeb4bcb55b733",
            "patch": "@@ -1,6 +1,6 @@\n use anyhow::{Context, Result, bail};\n use turbo_rcstr::rcstr;\n-use turbo_tasks::{ResolvedVc, Vc, fxindexmap};\n+use turbo_tasks::{IntoTraitRef, ResolvedVc, Vc, fxindexmap};\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n@@ -127,7 +127,7 @@ impl Module for WebAssemblyModuleAsset {\n             .source\n             .ident()\n             .with_modifier(rcstr!(\"wasm module\"))\n-            .with_layer(self.asset_context.layer().owned().await?))\n+            .with_layer(self.asset_context.into_trait_ref().await?.layer()))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "8d73b8f1b32e7f26a94357741e88948802510b66",
            "filename": "turbopack/crates/turbopack-wasm/src/raw.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fraw.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fraw.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-wasm%2Fsrc%2Fraw.rs?ref=2555cdff13a328852373ff34e3feeb4bcb55b733",
            "patch": "@@ -1,6 +1,6 @@\n use anyhow::{Result, bail};\n use turbo_rcstr::rcstr;\n-use turbo_tasks::{ResolvedVc, Vc};\n+use turbo_tasks::{IntoTraitRef, ResolvedVc, Vc};\n use turbopack_core::{\n     asset::{Asset, AssetContent},\n     chunk::{ChunkItem, ChunkType, ChunkableModule, ChunkingContext},\n@@ -57,7 +57,7 @@ impl Module for RawWebAssemblyModuleAsset {\n             .source\n             .ident()\n             .with_modifier(rcstr!(\"wasm raw\"))\n-            .with_layer(self.asset_context.layer().owned().await?))\n+            .with_layer(self.asset_context.into_trait_ref().await?.layer()))\n     }\n }\n "
        },
        {
            "sha": "c176fa14ad25f8f602cee4814bd54014eb3563bc",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2555cdff13a328852373ff34e3feeb4bcb55b733/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=2555cdff13a328852373ff34e3feeb4bcb55b733",
            "patch": "@@ -701,9 +701,8 @@ impl AssetContext for ModuleAssetContext {\n         *self.compile_time_info\n     }\n \n-    #[turbo_tasks::function]\n-    fn layer(&self) -> Vc<RcStr> {\n-        Vc::cell(self.layer.clone())\n+    fn layer(&self) -> RcStr {\n+        self.layer.clone()\n     }\n \n     #[turbo_tasks::function]"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 16,
        "deletions": 18
    }
}