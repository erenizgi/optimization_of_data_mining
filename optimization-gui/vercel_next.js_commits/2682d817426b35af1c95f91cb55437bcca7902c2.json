{
    "author": "unstubbable",
    "message": "Allow intercepting dynamic routes to be partially prerendered (#80851)\n\nFor intercepting dynamic routes we do prerender `.prefetch.rsc`, as well\nas `.segment.rsc` files if `clientSegmentCache` is enabled. However, we\nomitted adding those routes to the prerender manifest, which resulted in\nserver errors when looking up the RSC files.\n\nI've added two tests to verify the one-line fix, one in\n`test/e2e/app-dir/parallel-routes-and-interception` (relevant when tests\nare run with `__NEXT_EXPERIMENTAL_PPR=true`), and one in\n`test/e2e/app-dir/segment-cache/basic` (has `dynamicIO` and\n`clientSegmentCache` enabled). Both tests are written in the style of\nthe existing tests in the respective test suites.\n\n---------\n\nCo-authored-by: Jimmy Lai <laijimmy0@gmail.com>",
    "sha": "2682d817426b35af1c95f91cb55437bcca7902c2",
    "files": [
        {
            "sha": "128498ce4e9075dc11085507923571c340f93ac5",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -69,7 +69,6 @@ import { normalizeAppPath } from '../shared/lib/router/utils/app-paths'\n import { denormalizeAppPagePath } from '../shared/lib/page-path/denormalize-app-path'\n import { RouteKind } from '../server/route-kind'\n import type { PageExtensions } from './page-extensions-type'\n-import { isInterceptionRouteAppPath } from '../shared/lib/router/utils/interception-routes'\n import { checkIsRoutePPREnabled } from '../server/lib/experimental/ppr'\n import type { FallbackMode } from '../lib/fallback'\n import type { OutgoingHttpHeaders } from 'http'\n@@ -1175,7 +1174,6 @@ export async function isPageStatic({\n         // in incremental mode.\n         isRoutePPREnabled =\n           routeModule.definition.kind === RouteKind.APP_PAGE &&\n-          !isInterceptionRouteAppPath(page) &&\n           checkIsRoutePPREnabled(pprConfig, appConfig)\n \n         // If force dynamic was set and we don't have PPR enabled, then set the"
        },
        {
            "sha": "257d5d408d84a8b20ee8e8d84d3e0b4d50e9a51e",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception/app/intercepting-routes-dynamic-prerendered/photos/(.)[id]/page.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2F(.)%5Bid%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2F(.)%5Bid%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2F(.)%5Bid%5D%2Fpage.js?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -0,0 +1,10 @@\n+export default async function Page({ params }) {\n+  const { id } = await params\n+  return <p id={`photo-intercepted-${id}`}>Photo INTERCEPTED {id}</p>\n+}\n+\n+export function generateStaticParams() {\n+  return Array.from({ length: 3 }).map((_, i) => ({\n+    id: i.toString(),\n+  }))\n+}"
        },
        {
            "sha": "33a9c905ce78577fd7501ae8a5175f283f3e32e5",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception/app/intercepting-routes-dynamic-prerendered/photos/[id]/page.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2F%5Bid%5D%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2F%5Bid%5D%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2F%5Bid%5D%2Fpage.js?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -0,0 +1,10 @@\n+export default async function Page({ params }) {\n+  const { id } = await params\n+  return <p id={`photo-page-${id}`}>Photo PAGE {id}</p>\n+}\n+\n+export function generateStaticParams() {\n+  return Array.from({ length: 3 }).map((_, i) => ({\n+    id: i.toString(),\n+  }))\n+}"
        },
        {
            "sha": "2f9b076f3525a9fd1e3b3e40847a318612190ac6",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception/app/intercepting-routes-dynamic-prerendered/photos/page.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fapp%2Fintercepting-routes-dynamic-prerendered%2Fphotos%2Fpage.js?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -0,0 +1,18 @@\n+import Link from 'next/link'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <h1 id=\"photos-page\">Photos</h1>\n+      <ul>\n+        {Array.from({ length: 3 }).map((_, i) => (\n+          <li key={i}>\n+            <Link href={`/intercepting-routes-dynamic-prerendered/photos/${i}`}>\n+              Link {i}\n+            </Link>\n+          </li>\n+        ))}\n+      </ul>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "6698791a4f273aca9f7ec4eb10a17694bf8402bc",
            "filename": "test/e2e/app-dir/parallel-routes-and-interception/parallel-routes-and-interception.test.ts",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fparallel-routes-and-interception.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fparallel-routes-and-interception.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fparallel-routes-and-interception%2Fparallel-routes-and-interception.test.ts?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -487,6 +487,49 @@ describe('parallel-routes-and-interception', () => {\n     })\n   })\n \n+  describe('route intercepting with prerendered dynamic routes ', () => {\n+    it('should render intercepted route', async () => {\n+      const browser = await next.browser(\n+        '/intercepting-routes-dynamic-prerendered/photos'\n+      )\n+\n+      // Check if navigation to modal route works.\n+      await browser\n+        .elementByCss(\n+          '[href=\"/intercepting-routes-dynamic-prerendered/photos/1\"]'\n+        )\n+        .click()\n+\n+      // This should load the intercepted page.\n+      await retry(async () => {\n+        expect(\n+          await browser.waitForElementByCss('#photo-intercepted-1').text()\n+        ).toBe('Photo INTERCEPTED 1')\n+      })\n+\n+      // Check if url matches even though it was intercepted.\n+      expect(await browser.url()).toBe(\n+        next.url + '/intercepting-routes-dynamic-prerendered/photos/1'\n+      )\n+\n+      // There must not be any errors from prefetching the intercepted page.\n+      expect(\n+        (await browser.log()).filter(({ source }) => source === 'error')\n+      ).toEqual([])\n+\n+      // Trigger a refresh, this should load the normal page, not the modal.\n+      await browser.refresh()\n+      expect(await browser.waitForElementByCss('#photo-page-1').text()).toBe(\n+        'Photo PAGE 1'\n+      )\n+\n+      // Check if the url matches still.\n+      expect(await browser.url()).toBe(\n+        next.url + '/intercepting-routes-dynamic-prerendered/photos/1'\n+      )\n+    })\n+  })\n+\n   describe('route intercepting with dynamic optional catch-all routes', () => {\n     it('should render intercepted route', async () => {\n       const browser = await next.browser("
        },
        {
            "sha": "13ced50d4918b03c052fe02b81a4420144daf849",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/interception-with-params/feed/(..)photo/[id]/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2F(..)photo%2F%5Bid%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2F(..)photo%2F%5Bid%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2F(..)photo%2F%5Bid%5D%2Fpage.tsx?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -0,0 +1,17 @@\n+export default async function InterceptedPhotoPage({\n+  params,\n+}: {\n+  params: Promise<{ id: string }>\n+}) {\n+  const { id } = await params\n+\n+  return (\n+    <div id=\"intercepted-photo-page\">\n+      Intercepted photo page for id {JSON.stringify(id)}\n+    </div>\n+  )\n+}\n+\n+export function generateStaticParams() {\n+  return [{ id: '1' }]\n+}"
        },
        {
            "sha": "e10750e17cf86abdf9f82fe33fd18f1872c834e7",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/interception-with-params/feed/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2Flayout.tsx?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -0,0 +1,8 @@\n+export default function FeedLayout({ children }) {\n+  return (\n+    <div>\n+      Feed layout\n+      <div>{children}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "f853ee97ba8ff9fd243fbbc506361d94c4045519",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/interception-with-params/feed/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Ffeed%2Fpage.tsx?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -0,0 +1,9 @@\n+import { LinkAccordion } from '../../../components/link-accordion'\n+\n+export default function FeedPage() {\n+  return (\n+    <LinkAccordion href=\"/interception-with-params/photo/1\">\n+      Go to photo\n+    </LinkAccordion>\n+  )\n+}"
        },
        {
            "sha": "a272c9442cc2a91cfab5e7a293f9d800579dfee1",
            "filename": "test/e2e/app-dir/segment-cache/basic/app/interception-with-params/photo/[id]/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Fphoto%2F%5Bid%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Fphoto%2F%5Bid%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fapp%2Finterception-with-params%2Fphoto%2F%5Bid%5D%2Fpage.tsx?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -0,0 +1,13 @@\n+export default async function PhotoPage({\n+  params,\n+}: {\n+  params: Promise<{ id: string }>\n+}) {\n+  const { id } = await params\n+\n+  return `Photo page for id ${JSON.stringify(id)} (normal, not intercepted)`\n+}\n+\n+export function generateStaticParams() {\n+  return [{ id: '1' }]\n+}"
        },
        {
            "sha": "7ebbc27d77a7eb78d79b38b2391dd65ecd3f9c66",
            "filename": "test/e2e/app-dir/segment-cache/basic/segment-cache-basic.test.ts",
            "status": "modified",
            "additions": 32,
            "deletions": 0,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fbasic%2Fsegment-cache-basic.test.ts?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -162,6 +162,38 @@ describe('segment cache (basic tests)', () => {\n     )\n   })\n \n+  it('prefetch interception route with params', async () => {\n+    let act: ReturnType<typeof createRouterAct>\n+    const browser = await next.browser('/interception-with-params/feed', {\n+      beforePageLoad(page) {\n+        act = createRouterAct(page)\n+      },\n+    })\n+\n+    // Reveal the link to trigger a prefetch.\n+    const reveal = await browser.elementByCss('input[type=\"checkbox\"]')\n+    const link = await act(\n+      async () => {\n+        await reveal.click()\n+        return await browser.elementByCss('a')\n+      },\n+      { includes: 'intercepted-photo-page' }\n+    )\n+\n+    // Navigate to the test page\n+    await act(\n+      async () => {\n+        await link.click()\n+\n+        // The page should render immediately because it was prefetched\n+        const div = await browser.elementById('intercepted-photo-page')\n+        expect(await div.innerHTML()).toBe('Intercepted photo page for id \"1\"')\n+      },\n+      // No additional requests were required, because everything was prefetched\n+      'no-requests'\n+    )\n+  })\n+\n   it('skips dynamic request if prefetched data is fully static', async () => {\n     let act: ReturnType<typeof createRouterAct>\n     const browser = await next.browser('/fully-static', {"
        },
        {
            "sha": "6bf8b8db3466ae63feeb87adcc1f6584d33f6e7d",
            "filename": "test/e2e/app-dir/segment-cache/router-act.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2682d817426b35af1c95f91cb55437bcca7902c2/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Frouter-act.ts?ref=2682d817426b35af1c95f91cb55437bcca7902c2",
            "patch": "@@ -275,6 +275,19 @@ ${fulfilled.body}\n \n               throw error\n             }\n+            if (fulfilled.status >= 400) {\n+              error.message = `\n+Received a response with an error status code.\n+\n+Status: ${fulfilled.status}\n+URL: ${request.url()}\n+Headers: ${JSON.stringify(fulfilled.headers)}\n+\n+Response:\n+${fulfilled.body}\n+`\n+              throw error\n+            }\n             if (expectedResponses !== null) {\n               let alreadyMatchedByThisResponse: string | null = null\n               for (const expectedResponse of expectedResponses) {"
        }
    ],
    "stats": {
        "total": 175,
        "additions": 173,
        "deletions": 2
    }
}