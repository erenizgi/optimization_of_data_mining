{
    "author": "bgw",
    "message": "chore(CI): Use `TEST_CONCURRENCY` by default in `run-tests.js` (#78731)\n\nIt seems too easy to accidentally not pass through `TEST_CONCURRENCY` in `build_and_test.yml`, so IMO `run-tests.js` should use it by default, still allowing overriding with `-c` or `--concurrency`.\n\nI tested by spot-checking CI jobs for log lines like this:\n\n```\nRunning tests with concurrency: 4 in test mode undefined\n```\n\nor\n\n```\nRunning tests with concurrency: 1 in test mode undefined\n```",
    "sha": "005db43079c7b59fd8c2594e8362761dc4cb3211",
    "files": [
        {
            "sha": "5206f6e451d4d0211ea45cb6f5ae3ee244afc030",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 16,
            "deletions": 20,
            "changes": 36,
            "blob_url": "https://github.com/vercel/next.js/blob/005db43079c7b59fd8c2594e8362761dc4cb3211/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/005db43079c7b59fd8c2594e8362761dc4cb3211/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=005db43079c7b59fd8c2594e8362761dc4cb3211",
            "patch": "@@ -11,7 +11,6 @@ env:\n   TURBO_VERSION: 2.3.3\n   NODE_MAINTENANCE_VERSION: 18\n   NODE_LTS_VERSION: 20\n-  TEST_CONCURRENCY: 8\n   # disable backtrace for test snapshots\n   RUST_BACKTRACE: 0\n \n@@ -259,8 +258,7 @@ jobs:\n         node run-tests.js \\\n           --test-pattern '^(test\\/(development|e2e))/.*\\.test\\.(js|jsx|ts|tsx)$' \\\n           --timings \\\n-          -g ${{ matrix.group }} \\\n-          -c $TEST_CONCURRENCY\n+          -g ${{ matrix.group }}\n       stepName: 'test-turbopack-dev-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -291,7 +289,6 @@ jobs:\n         node run-tests.js \\\n           --timings \\\n           -g ${{ matrix.group }} \\\n-          -c $TEST_CONCURRENCY \\\n           --type integration\n       stepName: 'test-turbopack-integration-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n@@ -324,7 +321,7 @@ jobs:\n         export NEXT_TEST_MODE=start\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n \n-        node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type production\n+        node run-tests.js --timings -g ${{ matrix.group }} --type production\n       stepName: 'test-turbopack-production-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -348,7 +345,6 @@ jobs:\n         node run-tests.js \\\n           --timings \\\n           -g ${{ matrix.group }} \\\n-          -c ${TEST_CONCURRENCY} \\\n           --type integration\n       stepName: 'test-turbopack-production-integration-${{ matrix.group }}'\n     secrets: inherit\n@@ -408,7 +404,7 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: ${{ matrix.node }}\n-      afterBuild: node run-tests.js -c ${TEST_CONCURRENCY} --type unit\n+      afterBuild: node run-tests.js --type unit\n       stepName: 'test-unit-${{ matrix.node }}'\n \n     secrets: inherit\n@@ -426,7 +422,7 @@ jobs:\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n       nodeVersion: ${{ matrix.node }}\n-      afterBuild: node run-tests.js -c ${TEST_CONCURRENCY} --type unit\n+      afterBuild: node run-tests.js --type unit\n       stepName: 'test-unit-windows-${{ matrix.node }}'\n       runs_on_labels: '[\"windows\",\"self-hosted\",\"x64\"]'\n       buildNativeTarget: 'x86_64-pc-windows-msvc'\n@@ -523,7 +519,6 @@ jobs:\n         node run-tests.js \\\n           --timings \\\n           -g ${{ matrix.group }} \\\n-          -c ${TEST_CONCURRENCY} \\\n           --type development\n       stepName: 'test-dev-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n@@ -546,7 +541,6 @@ jobs:\n         export NEXT_TEST_MODE=dev\n \n         node run-tests.js \\\n-          -c ${TEST_CONCURRENCY} \\\n           test/e2e/app-dir/app/index.test.ts \\\n           test/e2e/app-dir/app-edge/app-edge.test.ts\n       stepName: 'test-dev-windows'\n@@ -571,7 +565,7 @@ jobs:\n       nodeVersion: 18.18.2\n       afterBuild: |\n         node run-tests.js \\\n-          -c 4 \\\n+          --concurrency 4 \\\n           test/production/pages-dir/production/test/index.test.ts \\\n           test/integration/css-client-nav/test/index.test.js \\\n           test/integration/rewrites-has-condition/test/index.test.js \\\n@@ -624,7 +618,11 @@ jobs:\n         react: ['', '18.3.1']\n     uses: ./.github/workflows/build_reusable.yml\n     with:\n-      afterBuild: NEXT_TEST_MODE=start NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\" node run-tests.js --timings -g ${{ matrix.group }} -c ${TEST_CONCURRENCY} --type production\n+      afterBuild: |\n+        export NEXT_TEST_MODE=start\n+        export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+\n+        node run-tests.js --timings -g ${{ matrix.group }} --type production\n       stepName: 'test-prod-react-${{ matrix.react }}-${{ matrix.group }}'\n     secrets: inherit\n \n@@ -665,7 +663,6 @@ jobs:\n         node run-tests.js \\\n           --timings \\\n           -g ${{ matrix.group }} \\\n-          -c ${TEST_CONCURRENCY} \\\n           --type integration\n       stepName: 'test-integration-${{ matrix.group }}-react-${{ matrix.react }}'\n     secrets: inherit\n@@ -680,15 +677,17 @@ jobs:\n       afterBuild: |\n         pnpm playwright install\n \n-        # these all run without concurrency (`-c 1`) because they're heavier\n-        BROWSER_NAME=firefox node run-tests.js -c 1 \\\n+        # these all run without concurrency because they're heavier\n+        export TEST_CONCURRENCY=1\n+\n+        BROWSER_NAME=firefox node run-tests.js \\\n           test/production/pages-dir/production/test/index.test.ts\n \n-        NEXT_TEST_MODE=start BROWSER_NAME=safari node run-tests.js -c 1 \\\n+        NEXT_TEST_MODE=start BROWSER_NAME=safari node run-tests.js \\\n           test/production/pages-dir/production/test/index.test.ts \\\n           test/e2e/basepath/basepath.test.ts\n \n-        BROWSER_NAME=safari DEVICE_NAME='iPhone XR' node run-tests.js -c 1 \\\n+        BROWSER_NAME=safari DEVICE_NAME='iPhone XR' node run-tests.js \\\n           test/production/prerender-prefetch/index.test.ts\n       stepName: 'test-firefox-safari'\n     secrets: inherit\n@@ -709,7 +708,6 @@ jobs:\n \n         node run-tests.js \\\n           --timings \\\n-          -c ${TEST_CONCURRENCY} \\\n           --type integration\n       stepName: 'test-ppr-integration'\n     secrets: inherit\n@@ -733,7 +731,6 @@ jobs:\n         node run-tests.js \\\n           --timings \\\n           -g ${{ matrix.group }} \\\n-          -c ${TEST_CONCURRENCY} \\\n           --type development\n       stepName: 'test-ppr-dev-${{ matrix.group }}'\n     secrets: inherit\n@@ -757,7 +754,6 @@ jobs:\n         node run-tests.js \\\n           --timings \\\n           -g ${{ matrix.group }} \\\n-          -c ${TEST_CONCURRENCY} \\\n           --type production\n       stepName: 'test-ppr-prod-${{ matrix.group }}'\n     secrets: inherit"
        },
        {
            "sha": "22758e90de6d537c746318ac72612f7099b68662",
            "filename": ".github/workflows/build_reusable.yml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/005db43079c7b59fd8c2594e8362761dc4cb3211/.github%2Fworkflows%2Fbuild_reusable.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/005db43079c7b59fd8c2594e8362761dc4cb3211/.github%2Fworkflows%2Fbuild_reusable.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_reusable.yml?ref=005db43079c7b59fd8c2594e8362761dc4cb3211",
            "patch": "@@ -74,6 +74,8 @@ env:\n   NAPI_CLI_VERSION: 2.14.7\n   TURBO_VERSION: 2.3.3\n   NODE_LTS_VERSION: 20.9.0\n+  # run-tests.js reads `TEST_CONCURRENCY` if no explicit `--concurrency` or `-c`\n+  # argument is provided\n   TEST_CONCURRENCY: 8\n   # disable backtrace for test snapshots\n   RUST_BACKTRACE: 0"
        },
        {
            "sha": "167c84849eb66503c71a6782177acce7758e1345",
            "filename": ".github/workflows/integration_tests_reusable.yml",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/005db43079c7b59fd8c2594e8362761dc4cb3211/.github%2Fworkflows%2Fintegration_tests_reusable.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/005db43079c7b59fd8c2594e8362761dc4cb3211/.github%2Fworkflows%2Fintegration_tests_reusable.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fintegration_tests_reusable.yml?ref=005db43079c7b59fd8c2594e8362761dc4cb3211",
            "patch": "@@ -101,7 +101,6 @@ jobs:\n \n         node run-tests.js \\\n           --group ${{ matrix.group }}/${{ inputs.e2e_groups }} \\\n-          --concurrency $TEST_CONCURRENCY \\\n           --retries ${{ inputs.num_retries }} \\\n           --type ${{ inputs.test_type }}\n       stepName: test-${{ inputs.name }}-${{ matrix.group }}\n@@ -140,7 +139,6 @@ jobs:\n \n         node run-tests.js \\\n           --group ${{ matrix.group }}/${{ inputs.integration_groups }} \\\n-          --concurrency $TEST_CONCURRENCY \\\n           --retries ${{ inputs.num_retries }} \\\n           --type integration\n       stepName: test-${{ inputs.name }}-integration-${{ matrix.group }}"
        },
        {
            "sha": "6b352ddb6b6eb06be362c65403525eac737162c5",
            "filename": "run-tests.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/005db43079c7b59fd8c2594e8362761dc4cb3211/run-tests.js",
            "raw_url": "https://github.com/vercel/next.js/raw/005db43079c7b59fd8c2594e8362761dc4cb3211/run-tests.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/run-tests.js?ref=005db43079c7b59fd8c2594e8362761dc4cb3211",
            "patch": "@@ -200,8 +200,13 @@ async function main() {\n   // Ensure we have the arguments awaited from yargs.\n   argv = await argv\n \n+  // `.github/workflows/build_reusable.yml` sets this, we should use it unless\n+  // it's overridden by an explicit `--concurrency` argument.\n+  const envConcurrency =\n+    process.env.TEST_CONCURRENCY && parseInt(process.env.TEST_CONCURRENCY, 10)\n+\n   const options = {\n-    concurrency: argv.concurrency || DEFAULT_CONCURRENCY,\n+    concurrency: argv.concurrency ?? envConcurrency ?? DEFAULT_CONCURRENCY,\n     debug: argv.debug ?? false,\n     timings: argv.timings ?? false,\n     writeTimings: argv.writeTimings ?? false,"
        }
    ],
    "stats": {
        "total": 47,
        "additions": 24,
        "deletions": 23
    }
}