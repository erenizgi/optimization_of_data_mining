{
    "author": "unstubbable",
    "message": "Refactor: Get rid of overly generic `getExpectedRequestStore` function (#81791)\n\nThe places in which we called `getExpectedRequestStore()` were already narrowing down the work unit store type to a request store. This allows us to delete the function, and call `throwForMissingRequestStore()` directly instead.",
    "sha": "55e90412bb469c619935972cbe57a03489238596",
    "files": [
        {
            "sha": "8adc38931ebe7cd1784ec7e349fa1e4ade3e1920",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 37,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=55e90412bb469c619935972cbe57a03489238596",
            "patch": "@@ -250,43 +250,6 @@ export type WorkUnitAsyncStorage = AsyncLocalStorage<WorkUnitStore>\n \n export { workUnitAsyncStorageInstance as workUnitAsyncStorage }\n \n-export function getExpectedRequestStore(\n-  callingExpression: string\n-): RequestStore {\n-  const workUnitStore = workUnitAsyncStorageInstance.getStore()\n-\n-  if (!workUnitStore) {\n-    throwForMissingRequestStore(callingExpression)\n-  }\n-\n-  switch (workUnitStore.type) {\n-    case 'request':\n-      return workUnitStore\n-\n-    case 'prerender':\n-    case 'prerender-client':\n-    case 'prerender-ppr':\n-    case 'prerender-legacy':\n-      // This should not happen because we should have checked it already.\n-      throw new Error(\n-        `\\`${callingExpression}\\` cannot be called inside a prerender. This is a bug in Next.js.`\n-      )\n-\n-    case 'cache':\n-      throw new Error(\n-        `\\`${callingExpression}\\` cannot be called inside \"use cache\". Call it outside and pass an argument instead. Read more: https://nextjs.org/docs/messages/next-request-in-use-cache`\n-      )\n-\n-    case 'unstable-cache':\n-      throw new Error(\n-        `\\`${callingExpression}\\` cannot be called inside unstable_cache. Call it outside and pass an argument instead. Read more: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`\n-      )\n-\n-    default:\n-      return workUnitStore satisfies never\n-  }\n-}\n-\n export function throwForMissingRequestStore(callingExpression: string): never {\n   throw new Error(\n     `\\`${callingExpression}\\` was called outside a request scope. Read more: https://nextjs.org/docs/messages/next-dynamic-api-wrong-context`"
        },
        {
            "sha": "676ed25e5fba5e6ed2cae4394978e6d2f076fd8f",
            "filename": "packages/next/src/server/async-storage/request-store.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts?ref=55e90412bb469c619935972cbe57a03489238596",
            "patch": "@@ -14,7 +14,7 @@ import {\n   MutableRequestCookiesAdapter,\n   RequestCookiesAdapter,\n   responseCookiesToRequestCookies,\n-  wrapWithMutableAccessCheck,\n+  createCookiesWithMutableAccessCheck,\n   type ReadonlyRequestCookies,\n } from '../web/spec-extension/adapters/request-cookies'\n import { ResponseCookies, RequestCookies } from '../web/spec-extension/cookies'\n@@ -235,9 +235,8 @@ function createRequestStoreImpl(\n     },\n     get userspaceMutableCookies() {\n       if (!cache.userspaceMutableCookies) {\n-        const userspaceMutableCookies = wrapWithMutableAccessCheck(\n-          this.mutableCookies\n-        )\n+        const userspaceMutableCookies =\n+          createCookiesWithMutableAccessCheck(this)\n         cache.userspaceMutableCookies = userspaceMutableCookies\n       }\n       return cache.userspaceMutableCookies"
        },
        {
            "sha": "21f395324ffb34dd4448d7bc69e8389a4c5364ba",
            "filename": "packages/next/src/server/request/cookies.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 31,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts?ref=55e90412bb469c619935972cbe57a03489238596",
            "patch": "@@ -7,6 +7,7 @@ import {\n import { RequestCookies } from '../web/spec-extension/cookies'\n import { workAsyncStorage } from '../app-render/work-async-storage.external'\n import {\n+  throwForMissingRequestStore,\n   workUnitAsyncStorage,\n   type PrerenderStoreModern,\n } from '../app-render/work-unit-async-storage.external'\n@@ -16,7 +17,6 @@ import {\n   trackDynamicDataInDynamicRender,\n   trackSynchronousRequestDataAccessInDev,\n } from '../app-render/dynamic-rendering'\n-import { getExpectedRequestStore } from '../app-render/work-unit-async-storage.external'\n import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n import { makeHangingPromise } from '../dynamic-rendering-utils'\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n@@ -116,43 +116,45 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n           )\n         case 'request':\n           trackDynamicDataInDynamicRender(workUnitStore)\n+\n+          let underlyingCookies: ReadonlyRequestCookies\n+\n+          if (areCookiesMutableInCurrentPhase(workUnitStore)) {\n+            // We can't conditionally return different types here based on the context.\n+            // To avoid confusion, we always return the readonly type here.\n+            underlyingCookies =\n+              workUnitStore.userspaceMutableCookies as unknown as ReadonlyRequestCookies\n+          } else {\n+            underlyingCookies = workUnitStore.cookies\n+          }\n+\n+          if (\n+            process.env.NODE_ENV === 'development' &&\n+            !workStore?.isPrefetchRequest\n+          ) {\n+            if (process.env.__NEXT_CACHE_COMPONENTS) {\n+              return makeUntrackedCookiesWithDevWarnings(\n+                underlyingCookies,\n+                workStore?.route\n+              )\n+            }\n+\n+            return makeUntrackedExoticCookiesWithDevWarnings(\n+              underlyingCookies,\n+              workStore?.route\n+            )\n+          } else {\n+            return makeUntrackedExoticCookies(underlyingCookies)\n+          }\n           break\n         default:\n           workUnitStore satisfies never\n       }\n     }\n   }\n \n-  // cookies is being called in a dynamic context\n-\n-  const requestStore = getExpectedRequestStore(callingExpression)\n-\n-  let underlyingCookies: ReadonlyRequestCookies\n-\n-  if (areCookiesMutableInCurrentPhase(requestStore)) {\n-    // We can't conditionally return different types here based on the context.\n-    // To avoid confusion, we always return the readonly type here.\n-    underlyingCookies =\n-      requestStore.userspaceMutableCookies as unknown as ReadonlyRequestCookies\n-  } else {\n-    underlyingCookies = requestStore.cookies\n-  }\n-\n-  if (process.env.NODE_ENV === 'development' && !workStore?.isPrefetchRequest) {\n-    if (process.env.__NEXT_CACHE_COMPONENTS) {\n-      return makeUntrackedCookiesWithDevWarnings(\n-        underlyingCookies,\n-        workStore?.route\n-      )\n-    }\n-\n-    return makeUntrackedExoticCookiesWithDevWarnings(\n-      underlyingCookies,\n-      workStore?.route\n-    )\n-  } else {\n-    return makeUntrackedExoticCookies(underlyingCookies)\n-  }\n+  // If we end up here, there was no work store or work unit store present.\n+  throwForMissingRequestStore(callingExpression)\n }\n \n function createEmptyCookies(): ReadonlyRequestCookies {"
        },
        {
            "sha": "e58bbba1c92908b2b4346c9077ba03edd193dd2a",
            "filename": "packages/next/src/server/request/headers.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 19,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts?ref=55e90412bb469c619935972cbe57a03489238596",
            "patch": "@@ -3,7 +3,7 @@ import {\n   type ReadonlyHeaders,\n } from '../web/spec-extension/adapters/headers'\n import { workAsyncStorage } from '../app-render/work-async-storage.external'\n-import { getExpectedRequestStore } from '../app-render/work-unit-async-storage.external'\n+import { throwForMissingRequestStore } from '../app-render/work-unit-async-storage.external'\n import {\n   workUnitAsyncStorage,\n   type PrerenderStoreModern,\n@@ -55,6 +55,7 @@ export type UnsafeUnwrappedHeaders = ReadonlyHeaders\n  * Read more: [Next.js Docs: `headers`](https://nextjs.org/docs/app/api-reference/functions/headers)\n  */\n export function headers(): Promise<ReadonlyHeaders> {\n+  const callingExpression = 'headers'\n   const workStore = workAsyncStorage.getStore()\n   const workUnitStore = workUnitAsyncStorage.getStore()\n \n@@ -122,7 +123,7 @@ export function headers(): Promise<ReadonlyHeaders> {\n           // TODO consider switching the semantic to throw on property access instead\n           return postponeWithTracking(\n             workStore.route,\n-            'headers',\n+            callingExpression,\n             workUnitStore.dynamicTracking\n           )\n         case 'prerender-legacy':\n@@ -131,35 +132,40 @@ export function headers(): Promise<ReadonlyHeaders> {\n           // We track dynamic access here so we don't need to wrap the headers in\n           // individual property access tracking.\n           return throwToInterruptStaticGeneration(\n-            'headers',\n+            callingExpression,\n             workStore,\n             workUnitStore\n           )\n         case 'request':\n           trackDynamicDataInDynamicRender(workUnitStore)\n+\n+          if (\n+            process.env.NODE_ENV === 'development' &&\n+            !workStore?.isPrefetchRequest\n+          ) {\n+            if (process.env.__NEXT_CACHE_COMPONENTS) {\n+              return makeUntrackedHeadersWithDevWarnings(\n+                workUnitStore.headers,\n+                workStore?.route\n+              )\n+            }\n+\n+            return makeUntrackedExoticHeadersWithDevWarnings(\n+              workUnitStore.headers,\n+              workStore?.route\n+            )\n+          } else {\n+            return makeUntrackedExoticHeaders(workUnitStore.headers)\n+          }\n           break\n         default:\n           workUnitStore satisfies never\n       }\n     }\n   }\n \n-  const requestStore = getExpectedRequestStore('headers')\n-  if (process.env.NODE_ENV === 'development' && !workStore?.isPrefetchRequest) {\n-    if (process.env.__NEXT_CACHE_COMPONENTS) {\n-      return makeUntrackedHeadersWithDevWarnings(\n-        requestStore.headers,\n-        workStore?.route\n-      )\n-    }\n-\n-    return makeUntrackedExoticHeadersWithDevWarnings(\n-      requestStore.headers,\n-      workStore?.route\n-    )\n-  } else {\n-    return makeUntrackedExoticHeaders(requestStore.headers)\n-  }\n+  // If we end up here, there was no work store or work unit store present.\n+  throwForMissingRequestStore(callingExpression)\n }\n \n interface CacheLifetime {}"
        },
        {
            "sha": "e1085370f2fd2222fb0ecfe53b31d0cbbc0d6ebc",
            "filename": "packages/next/src/server/web/spec-extension/adapters/request-cookies.test.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 14,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Frequest-cookies.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Frequest-cookies.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Frequest-cookies.test.ts?ref=55e90412bb469c619935972cbe57a03489238596",
            "patch": "@@ -7,7 +7,7 @@ import {\n   ReadonlyRequestCookiesError,\n   RequestCookiesAdapter,\n   MutableRequestCookiesAdapter,\n-  wrapWithMutableAccessCheck,\n+  createCookiesWithMutableAccessCheck,\n } from './request-cookies'\n \n describe('RequestCookiesAdapter', () => {\n@@ -107,15 +107,21 @@ describe('MutableRequestCookiesAdapter', () => {\n })\n \n describe('wrapWithMutableAccessCheck', () => {\n-  const createMockRequestStore = (phase: RequestStore['phase']) =>\n-    ({ type: 'request', phase }) as RequestStore\n+  const createMockRequestStore = (phase: RequestStore['phase']) => {\n+    const headers = new Headers({})\n+    const underlyingCookies = new ResponseCookies(headers)\n+\n+    return {\n+      type: 'request',\n+      phase,\n+      mutableCookies: underlyingCookies,\n+    } as RequestStore\n+  }\n \n   it('prevents setting cookies in the render phase', () => {\n     const requestStore = createMockRequestStore('action')\n     workUnitAsyncStorage.run(requestStore, () => {\n-      const headers = new Headers({})\n-      const underlyingCookies = new ResponseCookies(headers)\n-      const wrappedCookies = wrapWithMutableAccessCheck(underlyingCookies)\n+      const cookies = createCookiesWithMutableAccessCheck(requestStore)\n \n       // simulate changing phases\n       requestStore.phase = 'render'\n@@ -124,20 +130,18 @@ describe('wrapWithMutableAccessCheck', () => {\n         /Cookies can only be modified in a Server Action or Route Handler\\./\n \n       expect(() => {\n-        wrappedCookies.set('foo', '1')\n+        cookies.set('foo', '1')\n       }).toThrow(EXPECTED_ERROR)\n \n-      expect(wrappedCookies.get('foo')).toBe(undefined)\n+      expect(cookies.get('foo')).toBe(undefined)\n     })\n   })\n \n   it('prevents deleting cookies in the render phase', () => {\n     const requestStore = createMockRequestStore('action')\n     workUnitAsyncStorage.run(requestStore, () => {\n-      const headers = new Headers({})\n-      const underlyingCookies = new ResponseCookies(headers)\n-      const wrappedCookies = wrapWithMutableAccessCheck(underlyingCookies)\n-      wrappedCookies.set('foo', '1')\n+      const cookies = createCookiesWithMutableAccessCheck(requestStore)\n+      cookies.set('foo', '1')\n \n       // simulate changing phases\n       requestStore.phase = 'render'\n@@ -146,9 +150,9 @@ describe('wrapWithMutableAccessCheck', () => {\n         /Cookies can only be modified in a Server Action or Route Handler\\./\n \n       expect(() => {\n-        wrappedCookies.delete('foo')\n+        cookies.delete('foo')\n       }).toThrow(EXPECTED_ERROR)\n-      expect(wrappedCookies.get('foo')?.value).toEqual('1')\n+      expect(cookies.get('foo')?.value).toEqual('1')\n     })\n   })\n })"
        },
        {
            "sha": "41e63198cf4154249a23be93741e163d9b277a1f",
            "filename": "packages/next/src/server/web/spec-extension/adapters/request-cookies.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 11,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Frequest-cookies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/55e90412bb469c619935972cbe57a03489238596/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Frequest-cookies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Frequest-cookies.ts?ref=55e90412bb469c619935972cbe57a03489238596",
            "patch": "@@ -3,10 +3,7 @@ import { RequestCookies } from '../cookies'\n import { ResponseCookies } from '../cookies'\n import { ReflectAdapter } from './reflect'\n import { workAsyncStorage } from '../../../app-render/work-async-storage.external'\n-import {\n-  getExpectedRequestStore,\n-  type RequestStore,\n-} from '../../../app-render/work-unit-async-storage.external'\n+import type { RequestStore } from '../../../app-render/work-unit-async-storage.external'\n \n /**\n  * @internal\n@@ -180,21 +177,21 @@ export class MutableRequestCookiesAdapter {\n   }\n }\n \n-export function wrapWithMutableAccessCheck(\n-  responseCookies: ResponseCookies\n+export function createCookiesWithMutableAccessCheck(\n+  requestStore: RequestStore\n ): ResponseCookies {\n-  const wrappedCookies = new Proxy(responseCookies, {\n+  const wrappedCookies = new Proxy(requestStore.mutableCookies, {\n     get(target, prop, receiver) {\n       switch (prop) {\n         case 'delete':\n           return function (...args: [string] | [ResponseCookie]) {\n-            ensureCookiesAreStillMutable('cookies().delete')\n+            ensureCookiesAreStillMutable(requestStore, 'cookies().delete')\n             target.delete(...args)\n             return wrappedCookies\n           }\n         case 'set':\n           return function (...args: SetCookieArgs) {\n-            ensureCookiesAreStillMutable('cookies().set')\n+            ensureCookiesAreStillMutable(requestStore, 'cookies().set')\n             target.set(...args)\n             return wrappedCookies\n           }\n@@ -218,8 +215,10 @@ export function areCookiesMutableInCurrentPhase(requestStore: RequestStore) {\n  *   'render' -> 'after'\n  *   'action' -> 'render'\n  * */\n-function ensureCookiesAreStillMutable(callingExpression: string) {\n-  const requestStore = getExpectedRequestStore(callingExpression)\n+function ensureCookiesAreStillMutable(\n+  requestStore: RequestStore,\n+  _callingExpression: string\n+) {\n   if (!areCookiesMutableInCurrentPhase(requestStore)) {\n     // TODO: maybe we can give a more precise error message based on callingExpression?\n     throw new ReadonlyRequestCookiesError()"
        }
    ],
    "stats": {
        "total": 205,
        "additions": 89,
        "deletions": 116
    }
}