{
    "author": "huozhi",
    "message": "Add graceful error fallback for bots requests (#77916)",
    "sha": "88019a045d945999da8d825cbfb9f5b2f3ace9af",
    "files": [
        {
            "sha": "8d0e72fb230619d93bfed285800b817b8fcf4b53",
            "filename": "packages/next/src/client/app-index.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-index.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -25,6 +25,7 @@ import type { InitialRSCPayload } from '../server/app-render/types'\n import { createInitialRouterState } from './components/router-reducer/create-initial-router-state'\n import { MissingSlotContext } from '../shared/lib/app-router-context.shared-runtime'\n import { setAppBuildId } from './app-build-id'\n+import { isBot } from '../shared/lib/router/utils/is-bot'\n \n /// <reference types=\"react-dom/experimental\" />\n \n@@ -169,6 +170,7 @@ function ServerRoot({\n \n   const router = (\n     <AppRouter\n+      gracefullyDegrade={isBot(window.navigator.userAgent)}\n       actionQueue={actionQueue}\n       globalErrorComponentAndStyles={initialRSCPayload.G}\n       assetPrefix={initialRSCPayload.p}"
        },
        {
            "sha": "f2442b4e03d308fe96d50b336fdd589175ce7ded",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 37,
            "deletions": 21,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -198,10 +198,12 @@ function Router({\n   actionQueue,\n   assetPrefix,\n   globalError,\n+  gracefullyDegrade,\n }: {\n   actionQueue: AppRouterActionQueue\n   assetPrefix: string\n   globalError: [GlobalErrorComponent, React.ReactNode]\n+  gracefullyDegrade: boolean\n }) {\n   const state = useActionQueue(actionQueue)\n   const { canonicalUrl } = state\n@@ -512,15 +514,18 @@ function Router({\n       </HotReloader>\n     )\n   } else {\n-    // In production, we only apply the user-customized global error boundary.\n-    content = (\n-      <ErrorBoundary\n-        errorComponent={globalError[0]}\n-        errorStyles={globalError[1]}\n-      >\n-        {content}\n-      </ErrorBoundary>\n-    )\n+    // If gracefully degrading is applied in production,\n+    // leave the app as it is rather than caught by GlobalError boundary.\n+    if (!gracefullyDegrade) {\n+      content = (\n+        <ErrorBoundary\n+          errorComponent={globalError[0]}\n+          errorStyles={globalError[1]}\n+        >\n+          {content}\n+        </ErrorBoundary>\n+      )\n+    }\n   }\n \n   return (\n@@ -555,26 +560,37 @@ export default function AppRouter({\n   actionQueue,\n   globalErrorComponentAndStyles: [globalErrorComponent, globalErrorStyles],\n   assetPrefix,\n+  gracefullyDegrade,\n }: {\n   actionQueue: AppRouterActionQueue\n   globalErrorComponentAndStyles: [GlobalErrorComponent, React.ReactNode]\n   assetPrefix: string\n+  gracefullyDegrade: boolean\n }) {\n   useNavFailureHandler()\n \n-  return (\n-    <ErrorBoundary\n-      // At the very top level, use the default GlobalError component as the final fallback.\n-      // When the app router itself fails, which means the framework itself fails, we show the default error.\n-      errorComponent={DefaultGlobalError}\n-    >\n-      <Router\n-        actionQueue={actionQueue}\n-        assetPrefix={assetPrefix}\n-        globalError={[globalErrorComponent, globalErrorStyles]}\n-      />\n-    </ErrorBoundary>\n+  const router = (\n+    <Router\n+      actionQueue={actionQueue}\n+      assetPrefix={assetPrefix}\n+      globalError={[globalErrorComponent, globalErrorStyles]}\n+      gracefullyDegrade={gracefullyDegrade}\n+    />\n   )\n+\n+  if (gracefullyDegrade) {\n+    return router\n+  } else {\n+    return (\n+      <ErrorBoundary\n+        // At the very top level, use the default GlobalError component as the final fallback.\n+        // When the app router itself fails, which means the framework itself fails, we show the default error.\n+        errorComponent={DefaultGlobalError}\n+      >\n+        {router}\n+      </ErrorBoundary>\n+    )\n+  }\n }\n \n const runtimeStyles = new Set<string>()"
        },
        {
            "sha": "ca0afee2dab1ef77c1e52038575dbc91b0efb367",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 21,
            "deletions": 1,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -1075,15 +1075,17 @@ function App<T>({\n   reactServerStream,\n   preinitScripts,\n   clientReferenceManifest,\n-  nonce,\n   ServerInsertedHTMLProvider,\n   ServerInsertedMetadataProvider,\n+  gracefullyDegrade,\n+  nonce,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n   preinitScripts: () => void\n   clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedHTMLProvider: React.ComponentType<{ children: JSX.Element }>\n   ServerInsertedMetadataProvider: React.ComponentType<{ children: JSX.Element }>\n+  gracefullyDegrade: boolean\n   nonce?: string\n }): JSX.Element {\n   preinitScripts()\n@@ -1128,6 +1130,7 @@ function App<T>({\n             actionQueue={actionQueue}\n             globalErrorComponentAndStyles={response.G}\n             assetPrefix={response.p}\n+            gracefullyDegrade={gracefullyDegrade}\n           />\n         </ServerInsertedHTMLProvider>\n       </ServerInsertedMetadataProvider>\n@@ -1144,13 +1147,15 @@ function ErrorApp<T>({\n   clientReferenceManifest,\n   ServerInsertedMetadataProvider,\n   ServerInsertedHTMLProvider,\n+  gracefullyDegrade,\n   nonce,\n }: {\n   reactServerStream: BinaryStreamOf<T>\n   preinitScripts: () => void\n   clientReferenceManifest: NonNullable<RenderOpts['clientReferenceManifest']>\n   ServerInsertedMetadataProvider: React.ComponentType<{ children: JSX.Element }>\n   ServerInsertedHTMLProvider: React.ComponentType<{ children: JSX.Element }>\n+  gracefullyDegrade: boolean\n   nonce?: string\n }): JSX.Element {\n   preinitScripts()\n@@ -1186,6 +1191,7 @@ function ErrorApp<T>({\n           actionQueue={actionQueue}\n           globalErrorComponentAndStyles={response.G}\n           assetPrefix={response.p}\n+          gracefullyDegrade={gracefullyDegrade}\n         />\n       </ServerInsertedHTMLProvider>\n     </ServerInsertedMetadataProvider>\n@@ -1960,6 +1966,7 @@ async function renderToStream(\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n             nonce={ctx.nonce}\n+            gracefullyDegrade={!!ctx.renderOpts.botType}\n           />,\n           postponed,\n           {\n@@ -2000,6 +2007,7 @@ async function renderToStream(\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n         ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+        gracefullyDegrade={!!ctx.renderOpts.botType}\n         nonce={ctx.nonce}\n       />,\n       {\n@@ -2157,6 +2165,7 @@ async function renderToStream(\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               preinitScripts={errorPreinitScripts}\n               clientReferenceManifest={clientReferenceManifest}\n+              gracefullyDegrade={!!ctx.renderOpts.botType}\n               nonce={ctx.nonce}\n             />\n           ),\n@@ -2378,6 +2387,7 @@ async function spawnDynamicValidationInDev(\n         clientReferenceManifest={clientReferenceManifest}\n         ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n         ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+        gracefullyDegrade={!!ctx.renderOpts.botType}\n         nonce={nonce}\n       />,\n       {\n@@ -2523,6 +2533,7 @@ async function spawnDynamicValidationInDev(\n             clientReferenceManifest={clientReferenceManifest}\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+            gracefullyDegrade={!!ctx.renderOpts.botType}\n             nonce={ctx.nonce}\n           />,\n           {\n@@ -2912,6 +2923,7 @@ async function prerenderToStream(\n                   ServerInsertedMetadataProvider={\n                     ServerInsertedMetadataProvider\n                   }\n+                  gracefullyDegrade={!!ctx.renderOpts.botType}\n                   nonce={nonce}\n                 />,\n                 {\n@@ -3070,6 +3082,7 @@ async function prerenderToStream(\n                 clientReferenceManifest={clientReferenceManifest}\n                 ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n                 ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+                gracefullyDegrade={!!ctx.renderOpts.botType}\n                 nonce={nonce}\n               />,\n               {\n@@ -3195,6 +3208,7 @@ async function prerenderToStream(\n                 clientReferenceManifest={clientReferenceManifest}\n                 ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n                 ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+                gracefullyDegrade={!!ctx.renderOpts.botType}\n                 nonce={nonce}\n               />,\n               JSON.parse(JSON.stringify(postponed)),\n@@ -3386,6 +3400,7 @@ async function prerenderToStream(\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+              gracefullyDegrade={!!ctx.renderOpts.botType}\n               nonce={nonce}\n             />,\n             {\n@@ -3541,6 +3556,7 @@ async function prerenderToStream(\n                   ServerInsertedMetadataProvider={\n                     ServerInsertedMetadataProvider\n                   }\n+                  gracefullyDegrade={!!ctx.renderOpts.botType}\n                   nonce={nonce}\n                 />,\n                 {\n@@ -3720,6 +3736,7 @@ async function prerenderToStream(\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n           ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+          gracefullyDegrade={!!ctx.renderOpts.botType}\n           nonce={nonce}\n         />,\n         {\n@@ -3852,6 +3869,7 @@ async function prerenderToStream(\n               clientReferenceManifest={clientReferenceManifest}\n               ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n               ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+              gracefullyDegrade={!!ctx.renderOpts.botType}\n               nonce={nonce}\n             />,\n             JSON.parse(JSON.stringify(postponed)),\n@@ -3931,6 +3949,7 @@ async function prerenderToStream(\n           clientReferenceManifest={clientReferenceManifest}\n           ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n           ServerInsertedMetadataProvider={ServerInsertedMetadataProvider}\n+          gracefullyDegrade={!!ctx.renderOpts.botType}\n           nonce={nonce}\n         />,\n         {\n@@ -4095,6 +4114,7 @@ async function prerenderToStream(\n             ServerInsertedHTMLProvider={ServerInsertedHTMLProvider}\n             preinitScripts={errorPreinitScripts}\n             clientReferenceManifest={clientReferenceManifest}\n+            gracefullyDegrade={!!ctx.renderOpts.botType}\n             nonce={nonce}\n           />\n         ),"
        },
        {
            "sha": "495686b45ae9f28c055cace282989a05a70656f6",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 3,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -1795,14 +1795,13 @@ export default abstract class Server<\n     >\n   ): Promise<void> {\n     const ua = partialContext.req.headers['user-agent'] || ''\n-    const isBotRequest = isBot(ua)\n \n     const ctx: RequestContext<ServerRequest, ServerResponse> = {\n       ...partialContext,\n       renderOpts: {\n         ...this.renderOpts,\n-        supportsDynamicResponse: !isBotRequest,\n-        botType: getBotType(ua),\n+        // `renderOpts.botType` is accumulated in `this.renderImpl()`\n+        supportsDynamicResponse: !this.renderOpts.botType,\n         serveStreamingMetadata: shouldServeStreamingMetadata(\n           ua,\n           this.nextConfig.htmlLimitedBots\n@@ -1933,6 +1932,9 @@ export default abstract class Server<\n       pathname = '/'\n     }\n \n+    const ua = req.headers['user-agent'] || ''\n+    this.renderOpts.botType = getBotType(ua)\n+\n     // we allow custom servers to call render for all URLs\n     // so check if we need to serve a static _next file or not.\n     // we don't modify the URL for _next/data request but still"
        },
        {
            "sha": "11048f03e25566a2b7235bbc0cb557810e0850b0",
            "filename": "packages/next/src/server/render.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frender.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -283,6 +283,7 @@ export type RenderOptsPartial = {\n   isPossibleServerAction?: boolean\n   isExperimentalCompile?: boolean\n   isPrefetch?: boolean\n+  isBot?: boolean\n   expireTime?: number\n   experimental: {\n     clientTraceMetadata?: string[]"
        },
        {
            "sha": "289b0fcaf5d2d1c8dfbd6ea677cbc8c6753bc72d",
            "filename": "test/lib/browsers/base.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Flib%2Fbrowsers%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Flib%2Fbrowsers%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fbase.ts?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -54,7 +54,8 @@ export abstract class BrowserInterface<TCurrent = any> {\n     locale: string,\n     javaScriptEnabled: boolean,\n     ignoreHttpsErrors: boolean,\n-    headless: boolean\n+    headless: boolean,\n+    userAgent: string | undefined\n   ): Promise<void>\n   abstract close(): Promise<void>\n "
        },
        {
            "sha": "44dfa3d1e20424bb265b8fdfddf5c46febfc83e4",
            "filename": "test/lib/browsers/playwright.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fplaywright.ts?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -125,7 +125,8 @@ export class Playwright extends BrowserInterface {\n     locale: string,\n     javaScriptEnabled: boolean,\n     ignoreHTTPSErrors: boolean,\n-    headless: boolean\n+    headless: boolean,\n+    userAgent: string | undefined\n   ) {\n     let device\n \n@@ -148,6 +149,7 @@ export class Playwright extends BrowserInterface {\n           locale,\n           javaScriptEnabled,\n           ignoreHTTPSErrors,\n+          ...(userAgent ? { userAgent } : {}),\n           ...device,\n         })\n         contextHasJSEnabled = javaScriptEnabled\n@@ -160,6 +162,7 @@ export class Playwright extends BrowserInterface {\n       locale,\n       javaScriptEnabled,\n       ignoreHTTPSErrors,\n+      ...(userAgent ? { userAgent } : {}),\n       ...device,\n     })\n     contextHasJSEnabled = javaScriptEnabled"
        },
        {
            "sha": "c79fa0aedda7e6690ba255f0ce4c8305c2e09643",
            "filename": "test/lib/next-webdriver.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Flib%2Fnext-webdriver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Flib%2Fnext-webdriver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-webdriver.ts?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -75,6 +75,11 @@ export interface WebdriverOptions {\n   ignoreHTTPSErrors?: boolean\n   cpuThrottleRate?: number\n   pushErrorAsConsoleLog?: boolean\n+\n+  /**\n+   * Override the user agent\n+   */\n+  userAgent?: string\n }\n \n /**\n@@ -107,6 +112,7 @@ export default async function webdriver(\n     headless,\n     cpuThrottleRate,\n     pushErrorAsConsoleLog,\n+    userAgent,\n   } = options\n \n   const { Playwright, quit } = await import('./browsers/playwright')\n@@ -121,7 +127,8 @@ export default async function webdriver(\n     !disableJavaScript,\n     ignoreHTTPSErrors,\n     // allow headless to be overwritten for a particular test\n-    typeof headless !== 'undefined' ? headless : !!process.env.HEADLESS\n+    typeof headless !== 'undefined' ? headless : !!process.env.HEADLESS,\n+    userAgent\n   )\n   ;(global as any).browserName = browserName\n "
        },
        {
            "sha": "436cd68a7caecf8d1ef5db1d3e04f52c31cbf5a8",
            "filename": "test/production/app-dir/graceful-degrade-error/app/async-content.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fasync-content.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fasync-content.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fasync-content.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+import dynamic from 'next/dynamic'\n+\n+export const Large = dynamic(() => import('./content'))"
        },
        {
            "sha": "f5bc87188a045de711d147b0b254a8dfeefed1a7",
            "filename": "test/production/app-dir/graceful-degrade-error/app/async-layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fasync-layout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fasync-layout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fasync-layout.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+import dynamic from 'next/dynamic'\n+\n+const AsyncLayout = dynamic(async () => import('./layout-wrapper'))\n+\n+export default AsyncLayout"
        },
        {
            "sha": "5f723c0b11c023d58b677b4af9064efbfbac14bf",
            "filename": "test/production/app-dir/graceful-degrade-error/app/content.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fcontent.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fcontent.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fcontent.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export default function Large() {\n+  return <p>large test content</p>\n+}"
        },
        {
            "sha": "7622c0e3e0a559a43090e4f7a02b7adbc8dc2887",
            "filename": "test/production/app-dir/graceful-degrade-error/app/layout-wrapper.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Flayout-wrapper.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Flayout-wrapper.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Flayout-wrapper.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+export default ({ children }: any) => (\n+  <html className=\"layout-cls\">\n+    <body className=\"body-cls\">{children}</body>\n+  </html>\n+)"
        },
        {
            "sha": "c6cf49049d63efddbdb05b4932e01b2f1f402f13",
            "filename": "test/production/app-dir/graceful-degrade-error/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Flayout.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+import AsyncLayout from './async-layout'\n+\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return <AsyncLayout>{children}</AsyncLayout>\n+}"
        },
        {
            "sha": "1314b13f0d034687c53daa8a1fb840078c646f23",
            "filename": "test/production/app-dir/graceful-degrade-error/app/page-client.tsx",
            "status": "added",
            "additions": 12,
            "deletions": 0,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fpage-client.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fpage-client.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fpage-client.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,12 @@\n+'use client'\n+\n+import { Large } from './async-content'\n+\n+export default function Page() {\n+  return (\n+    <div className=\"page\">\n+      <p>hello world von server</p>\n+      <Large />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "67686cd31a09097770bb03df083f013fbca17251",
            "filename": "test/production/app-dir/graceful-degrade-error/app/page.tsx",
            "status": "added",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fapp%2Fpage.tsx?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,2 @@\n+export { default } from './page-client'\n+export const dynamic = 'force-dynamic'"
        },
        {
            "sha": "a9f8513249fc92709c334226ea2ca64725ba555a",
            "filename": "test/production/app-dir/graceful-degrade-error/delete-dynamic-chunk.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fdelete-dynamic-chunk.js",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fdelete-dynamic-chunk.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fdelete-dynamic-chunk.js?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,26 @@\n+import fs from 'fs'\n+import path from 'path'\n+\n+export function deleteBrowserDynamicChunks(next) {\n+  const clientChunkDir = path.join(next.testDir, '.next', 'static', 'chunks')\n+  const clientChunkFiles = fs\n+    .readdirSync(clientChunkDir)\n+    // filter out the js file that contains the text \"large test content\"\n+    .filter((filename) => {\n+      const filePath = path.join(clientChunkDir, filename)\n+      const isJsFile = filename.endsWith('.js')\n+      const fileContent = isJsFile\n+        ? fs.readFileSync(filePath, { encoding: 'utf8' })\n+        : ''\n+\n+      return (\n+        isJsFile && fileContent && fileContent.includes('large test content')\n+      )\n+    })\n+    .map((file) => path.join(clientChunkDir, file))\n+\n+  // Intended to log to help debugging tests\n+  console.log('Deleting client chunk files:', clientChunkFiles)\n+  // delete all chunk files\n+  clientChunkFiles.map((file) => fs.rmSync(file))\n+}"
        },
        {
            "sha": "74032c10577ccfc654252ef313ca2743a8ae5b05",
            "filename": "test/production/app-dir/graceful-degrade-error/graceful-degrade-error-non-bot.test.ts",
            "status": "added",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fgraceful-degrade-error-non-bot.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fgraceful-degrade-error-non-bot.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fgraceful-degrade-error-non-bot.test.ts?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,39 @@\n+// Duplicate the test file of graceful-degrade-error-bot.test.ts since we need to\n+// restart with a new browser context for UA setting. Otherwise the browser context\n+// will not be closed and reset properly. TODO: investigate why browser.close didn't help.\n+\n+import { nextTestSetup } from 'e2e-utils'\n+import { deleteBrowserDynamicChunks } from './delete-dynamic-chunk'\n+\n+describe('graceful-degrade-error - non bot', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  // Delete client chunks to simulate chunk loading failure\n+  beforeAll(() => {\n+    deleteBrowserDynamicChunks(next)\n+  })\n+\n+  it('should not degrade to graceful error when chunk loading fails in ssr for non-bot user agents', async () => {\n+    const browser = await next.browser('/')\n+\n+    const logs = await browser.log()\n+    const errors = logs\n+      .filter((x) => x.source === 'error')\n+      .map((x) => x.message)\n+      .join('\\n')\n+\n+    expect(errors).toMatch(/Failed to load resource./)\n+    // Should not show the original content\n+    const html = await browser.elementByCss('html')\n+    const body = await browser.elementByCss('body')\n+    expect(await html.getAttribute('class')).not.toBe('layout-cls')\n+    expect(await body.getAttribute('class')).not.toBe('body-cls')\n+\n+    const bodyText = await body.text()\n+    expect(bodyText).toMatch(\n+      /Application error: a client-side exception has occurred while loading/\n+    )\n+  })\n+})"
        },
        {
            "sha": "a4a95edf4dfcf6118a84b57661b68f64a0e04b17",
            "filename": "test/production/app-dir/graceful-degrade-error/graceful-degrade-error.test.ts",
            "status": "added",
            "additions": 38,
            "deletions": 0,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fgraceful-degrade-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fgraceful-degrade-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fgraceful-degrade-error.test.ts?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,38 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { deleteBrowserDynamicChunks } from './delete-dynamic-chunk'\n+\n+describe('graceful-degrade-error', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  // Delete client chunks to simulate chunk loading failure\n+  beforeAll(() => {\n+    deleteBrowserDynamicChunks(next)\n+  })\n+\n+  it('should degrade to graceful error when chunk loading fails in ssr for bot', async () => {\n+    const browser = await next.browser('/', {\n+      userAgent: 'Googlebot',\n+    })\n+\n+    const logs = await browser.log()\n+    const errors = logs\n+      .filter((x) => x.source === 'error')\n+      .map((x) => x.message)\n+      .join('\\n')\n+\n+    expect(errors).toMatch(/Failed to load resource./)\n+    // Should show the original content\n+    const originHtml = await browser.elementByCss('html')\n+    const originBody = await browser.elementByCss('body')\n+    expect(await originHtml.getAttribute('class')).toBe('layout-cls')\n+    expect(await originBody.getAttribute('class')).toBe('body-cls')\n+\n+    // Do not contain the global error boundary text\n+    const bodyText = await originBody.text()\n+    expect(bodyText).not.toMatch(\n+      /Application error: a client-side exception has occurred while loading/\n+    )\n+  })\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/app-dir/graceful-degrade-error/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/88019a045d945999da8d825cbfb9f5b2f3ace9af/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fgraceful-degrade-error%2Fnext.config.js?ref=88019a045d945999da8d825cbfb9f5b2f3ace9af",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 262,
        "additions": 234,
        "deletions": 28
    }
}