{
    "author": "eps1lon",
    "message": "[testmode] Fix types of `wrapRequestHandler` (#80055)\n\nWas previously shadowed because we used an uncast `require` which results in `any`.\r\n\r\nFixes\r\n```\r\nArgument of type '<T>(request: NextRequestHint, fn: () => T) => T' is not assignable to parameter of type '(req: Request, fn: () => T) => T'.\r\n  Types of parameters 'request' and 'req' are incompatible.\r\n    Type 'Request' is missing the following properties from type 'NextRequestHint': sourcePage, fetchMetrics, request, respondWith, and 6 more.ts(2345)\r\n```",
    "sha": "7a0db3a159e6c25424f6e784ac973cb6e044ad70",
    "files": [
        {
            "sha": "5ffdb54b21afb88f88b75943a82004a72abb94a2",
            "filename": "packages/next/src/experimental/testmode/server-edge.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7a0db3a159e6c25424f6e784ac973cb6e044ad70/packages%2Fnext%2Fsrc%2Fexperimental%2Ftestmode%2Fserver-edge.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7a0db3a159e6c25424f6e784ac973cb6e044ad70/packages%2Fnext%2Fsrc%2Fexperimental%2Ftestmode%2Fserver-edge.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexperimental%2Ftestmode%2Fserver-edge.ts?ref=7a0db3a159e6c25424f6e784ac973cb6e044ad70",
            "patch": "@@ -5,8 +5,8 @@ export function interceptTestApis(): () => void {\n   return interceptFetch(global.fetch)\n }\n \n-export function wrapRequestHandler<T>(\n-  handler: (req: Request, fn: () => T) => T\n-): (req: Request, fn: () => T) => T {\n+export function wrapRequestHandler<T, TRequest extends Request>(\n+  handler: (req: TRequest, fn: () => T) => T\n+): (req: TRequest, fn: () => T) => T {\n   return (req, fn) => withRequestContext(req, reader, () => handler(req, fn))\n }"
        },
        {
            "sha": "cccd85db3cb28de07cef6bd25ca0c8ff316f71c6",
            "filename": "packages/next/src/server/lib/router-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7a0db3a159e6c25424f6e784ac973cb6e044ad70/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7a0db3a159e6c25424f6e784ac973cb6e044ad70/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-server.ts?ref=7a0db3a159e6c25424f6e784ac973cb6e044ad70",
            "patch": "@@ -634,7 +634,7 @@ export async function initialize(opts: {\n   if (config.experimental.testProxy) {\n     // Intercept fetch and other testmode apis.\n     const { wrapRequestHandlerWorker, interceptTestApis } =\n-      require('next/dist/experimental/testmode/server') as typeof import('next/src/experimental/testmode/server')\n+      require('next/dist/experimental/testmode/server') as typeof import('../../experimental/testmode/server')\n     requestHandler = wrapRequestHandlerWorker(requestHandler)\n     interceptTestApis()\n     // We treat the intercepted fetch as \"original\" fetch that should be reset to during HMR."
        },
        {
            "sha": "6d1f4828994a0a13cc57d14364037cf3623d1eeb",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/7a0db3a159e6c25424f6e784ac973cb6e044ad70/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7a0db3a159e6c25424f6e784ac973cb6e044ad70/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=7a0db3a159e6c25424f6e784ac973cb6e044ad70",
            "patch": "@@ -345,9 +345,8 @@ export default class NextNodeServer extends BaseServer<\n     // Intercept fetch and other testmode apis.\n     if (this.serverOptions.experimentalTestProxy) {\n       process.env.NEXT_PRIVATE_TEST_PROXY = 'true'\n-      const {\n-        interceptTestApis,\n-      } = require('next/dist/experimental/testmode/server')\n+      const { interceptTestApis } =\n+        require('next/dist/experimental/testmode/server') as typeof import('../experimental/testmode/server')\n       interceptTestApis()\n     }\n \n@@ -1250,9 +1249,8 @@ export default class NextNodeServer extends BaseServer<\n   public getRequestHandler(): NodeRequestHandler {\n     const handler = this.makeRequestHandler()\n     if (this.serverOptions.experimentalTestProxy) {\n-      const {\n-        wrapRequestHandlerNode,\n-      } = require('next/dist/experimental/testmode/server')\n+      const { wrapRequestHandlerNode } =\n+        require('next/dist/experimental/testmode/server') as typeof import('../experimental/testmode/server')\n       return wrapRequestHandlerNode(handler)\n     }\n     return handler"
        },
        {
            "sha": "9a6b92bce95a7fbd21eb21c29598664ef2090c59",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 4,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7a0db3a159e6c25424f6e784ac973cb6e044ad70/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7a0db3a159e6c25424f6e784ac973cb6e044ad70/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=7a0db3a159e6c25424f6e784ac973cb6e044ad70",
            "patch": "@@ -87,10 +87,8 @@ function ensureTestApisIntercepted() {\n   if (!testApisIntercepted) {\n     testApisIntercepted = true\n     if (process.env.NEXT_PRIVATE_TEST_PROXY === 'true') {\n-      const {\n-        interceptTestApis,\n-        wrapRequestHandler,\n-      } = require('next/dist/experimental/testmode/server-edge')\n+      const { interceptTestApis, wrapRequestHandler } =\n+        require('next/dist/experimental/testmode/server-edge') as typeof import('../../experimental/testmode/server-edge')\n       interceptTestApis()\n       propagator = wrapRequestHandler(propagator)\n     }"
        }
    ],
    "stats": {
        "total": 24,
        "additions": 10,
        "deletions": 14
    }
}