{
    "author": "feedthejim",
    "message": "feat: add --experimental-cpu-prof flag for dev, build, and start (#87946)\n\n## What\n\nAdds a `--experimental-cpu-prof` flag to `next dev`, `next build`, and\n`next start` commands to capture V8 CPU profiles for debugging\nperformance bottlenecks.\n\n## Why\n\nWhen investigating slow builds, slow dev server startups, or production\nserver performance issues, having access to CPU profiles is invaluable.\nThis provides a first-party way to capture these profiles without\nneeding to manually set up the V8 inspector.\n\n## How\n\n- Adds `--experimental-cpu-prof` flag to CLI commands\n- Uses V8's built-in CPU profiler via Node.js inspector module\n- Profiles are saved to `.next/cpu-profiles/` with descriptive filenames\n- Profiles are saved on process exit (Ctrl+C, SIGTERM, or normal exit)\n\n### Profile files generated\n\n**`next dev`:**\n- `dev-main-*` - Parent process (dev server orchestration)\n- `dev-server-*` - Child server process (request handling and rendering)\n\n**`next build` (Turbopack):**\n- `build-main-*` - Main build orchestration process\n- `build-turbopack-*` - Turbopack compilation worker\n\n**`next build` (Webpack):**\n- `build-main-*` - Main build orchestration process\n- `build-webpack-client-*` - Client bundle compilation worker\n- `build-webpack-server-*` - Server bundle compilation worker\n- `build-webpack-edge-server-*` - Edge runtime compilation worker\n\n**`next start`:**\n- `start-main-*` - Production server process\n\n## Changes addressing PR review comments\n\n- Removed signal handlers from `cpu-profile.ts` to prevent conflicts\nwith CLI cleanup logic (telemetry, traces, etc.)\n- Added synchronous exit handler for non-signal process exits (errors,\n`process.exit()` calls)\n- CLI commands now explicitly call `saveCpuProfile()` as part of their\ncleanup before exiting\n- Replaced raw ANSI escape codes with `picocolors` library\n- Added comprehensive documentation about profile file naming for each\ncommand\n- Added build profiling test that verifies correct profile generation\nfor both Turbopack and Webpack modes\n\n---------\n\nCo-authored-by: Tim Neutkens <tim@timneutkens.nl>",
    "sha": "fd5817d00462f68c56982012fb62fc255816f9bd",
    "files": [
        {
            "sha": "37576c93753c541608856b4569089070bdfcde5f",
            "filename": "docs/01-app/03-api-reference/06-cli/next.mdx",
            "status": "modified",
            "additions": 43,
            "deletions": 0,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/docs%2F01-app%2F03-api-reference%2F06-cli%2Fnext.mdx?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -56,6 +56,7 @@ The following commands are available:\n | `--experimental-https-cert <path>`       | Path to a HTTPS certificate file.                                                                                                                    |\n | `--experimental-https-ca <path>`         | Path to a HTTPS certificate authority file.                                                                                                          |\n | `--experimental-upload-trace <traceUrl>` | Reports a subset of the debugging trace to a remote HTTP URL.                                                                                        |\n+| `--experimental-cpu-prof`                | Enables CPU profiling using V8's inspector. Profiles are saved to `.next/cpu-profiles/` on exit.                                                     |\n \n ### `next build` options\n \n@@ -87,6 +88,7 @@ The following options are available for the `next build` command:\n | `--experimental-build-mode [mode]` | Uses an experimental build mode. (choices: \"compile\", \"generate\", default: \"default\")                                                                                              |\n | `--debug-prerender`                | Debug prerender errors in development.                                                                                                                                             |\n | `--debug-build-paths=<patterns>`   | Build only specific routes for debugging.                                                                                                                                          |\n+| `--experimental-cpu-prof`          | Enables CPU profiling using V8's inspector. Profiles are saved to `.next/cpu-profiles/` on exit.                                                                                   |\n \n ### `next start` options\n \n@@ -101,6 +103,7 @@ The following options are available for the `next start` command:\n | `-p` or `--port <port>`                 | Specify a port number on which to start the application. (default: 3000, env: PORT)                             |\n | `-H` or `--hostname <hostname>`         | Specify a hostname on which to start the application (default: 0.0.0.0).                                        |\n | `--keepAliveTimeout <keepAliveTimeout>` | Specify the maximum amount of milliseconds to wait before closing the inactive connections.                     |\n+| `--experimental-cpu-prof`               | Enables CPU profiling using V8's inspector. Profiles are saved to `.next/cpu-profiles/` on exit.                |\n \n ### `next info` options\n \n@@ -334,6 +337,46 @@ NODE_OPTIONS='-r esm' next\n NODE_OPTIONS='--inspect' next\n ```\n \n+### CPU profiling\n+\n+You can capture CPU profiles to analyze performance bottlenecks in your Next.js application. The `--experimental-cpu-prof` flag enables V8's built-in CPU profiler and saves profiles to `.next/cpu-profiles/` when the process exits:\n+\n+```bash filename=\"Terminal\"\n+# Profile the build process\n+next build --experimental-cpu-prof\n+\n+# Profile the dev server (profile saved on Ctrl+C or SIGTERM)\n+next dev --experimental-cpu-prof\n+\n+# Profile the production server\n+next start --experimental-cpu-prof\n+```\n+\n+The generated `.cpuprofile` files can be opened in Chrome DevTools (Performance tab → Load profile) or other V8-compatible profiling tools.\n+\n+> **Good to know**: Profile files are named with a descriptive prefix and timestamp. The profiles generated depend on the command:\n+>\n+> **`next dev`:**\n+>\n+> - `dev-main-*` - Parent process (dev server orchestration)\n+> - `dev-server-*` - Child server process (request handling and rendering) - this is typically what you want to analyze\n+>\n+> **`next build` (Turbopack):**\n+>\n+> - `build-main-*` - Main build orchestration process\n+> - `build-turbopack-*` - Turbopack compilation worker\n+>\n+> **`next build` (Webpack):**\n+>\n+> - `build-main-*` - Main build orchestration process\n+> - `build-webpack-client-*` - Client bundle compilation worker\n+> - `build-webpack-server-*` - Server bundle compilation worker\n+> - `build-webpack-edge-server-*` - Edge runtime compilation worker\n+>\n+> **`next start`:**\n+>\n+> - `start-main-*` - Production server process\n+\n | Version   | Changes                                                                         |\n | --------- | ------------------------------------------------------------------------------- |\n | `v16.1.0` | Add the `next experimental-analyze` command                                     |"
        },
        {
            "sha": "99a4f4002991108a85fd802fb63c661f157452d6",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 40,
            "deletions": 1,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -186,15 +186,32 @@ program\n     '--debug-build-paths <patterns>',\n     'Comma-separated glob patterns or explicit paths for selective builds. Examples: \"app/*\", \"app/page.tsx\", \"app/**/page.tsx\"'\n   )\n+  .option(\n+    '--experimental-cpu-prof',\n+    'Enable CPU profiling. Profile is saved to .next/cpu-profiles/ on completion.'\n+  )\n   .action((directory: string, options: NextBuildOptions) => {\n     if (options.experimentalNextConfigStripTypes) {\n       process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'true'\n     }\n+    if (options.experimentalCpuProf) {\n+      process.env.NEXT_CPU_PROF = '1'\n+      process.env.__NEXT_PRIVATE_CPU_PROFILE = 'build-main'\n+      const { join } = require('path') as typeof import('path')\n+      const dir = directory || process.cwd()\n+      process.env.NEXT_CPU_PROF_DIR = join(dir, '.next', 'cpu-profiles')\n+    }\n \n     // ensure process exits after build completes so open handles/connections\n     // don't cause process to hang\n     return import('../cli/next-build.js').then((mod) =>\n-      mod.nextBuild(options, directory).then(() => process.exit(0))\n+      mod.nextBuild(options, directory).then(async () => {\n+        // Save CPU profile before exiting if enabled\n+        if (options.experimentalCpuProf) {\n+          await mod.saveCpuProfile()\n+        }\n+        process.exit(0)\n+      })\n     )\n   })\n   .usage('[directory] [options]')\n@@ -297,11 +314,22 @@ program\n     '--experimental-next-config-strip-types',\n     'Use Node.js native TypeScript resolution for next.config.(ts|mts)'\n   )\n+  .option(\n+    '--experimental-cpu-prof',\n+    'Enable CPU profiling. Profiles are saved to .next/cpu-profiles/ on exit.'\n+  )\n   .action(\n     (directory: string, options: NextDevOptions, { _optionValueSources }) => {\n       if (options.experimentalNextConfigStripTypes) {\n         process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'true'\n       }\n+      if (options.experimentalCpuProf) {\n+        process.env.NEXT_CPU_PROF = '1'\n+        process.env.__NEXT_PRIVATE_CPU_PROFILE = 'dev-main'\n+        const { join } = require('path') as typeof import('path')\n+        const dir = directory || process.cwd()\n+        process.env.NEXT_CPU_PROF_DIR = join(dir, '.next', 'cpu-profiles')\n+      }\n       const portSource = _optionValueSources.port\n       import('../cli/next-dev.js').then((mod) =>\n         mod.nextDev(options, portSource, directory)\n@@ -363,10 +391,21 @@ program\n     '--experimental-next-config-strip-types',\n     'Use Node.js native TypeScript resolution for next.config.(ts|mts)'\n   )\n+  .option(\n+    '--experimental-cpu-prof',\n+    'Enable CPU profiling. Profiles are saved to .next/cpu-profiles/ on exit.'\n+  )\n   .action((directory: string, options: NextStartOptions) => {\n     if (options.experimentalNextConfigStripTypes) {\n       process.env.__NEXT_NODE_NATIVE_TS_LOADER_ENABLED = 'true'\n     }\n+    if (options.experimentalCpuProf) {\n+      process.env.NEXT_CPU_PROF = '1'\n+      process.env.__NEXT_PRIVATE_CPU_PROFILE = 'start-main'\n+      const { join } = require('path') as typeof import('path')\n+      const dir = directory || process.cwd()\n+      process.env.NEXT_CPU_PROF_DIR = join(dir, '.next', 'cpu-profiles')\n+    }\n     return import('../cli/next-start.js').then((mod) =>\n       mod.nextStart(options, directory)\n     )"
        },
        {
            "sha": "3a5a4eaaf8ee3a2dadefb504a35d2f9006faa7ff",
            "filename": "packages/next/src/build/collect-build-traces.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,3 +1,5 @@\n+// Import cpu-profile to start profiling early if enabled\n+import '../server/lib/cpu-profile'\n import { Span } from '../trace'\n import type { NextConfigComplete } from '../server/config-shared'\n "
        },
        {
            "sha": "49051f07105ed803ac82e133be398003eba7a76d",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -831,6 +831,15 @@ export function createStaticWorker(\n     isolatedMemory: true,\n     enableWorkerThreads: config.experimental.workerThreads,\n     exposedMethods: staticWorkerExposedMethods,\n+    forkOptions: process.env.NEXT_CPU_PROF\n+      ? {\n+          env: {\n+            NEXT_CPU_PROF: '1',\n+            NEXT_CPU_PROF_DIR: process.env.NEXT_CPU_PROF_DIR,\n+            __NEXT_PRIVATE_CPU_PROFILE: 'build-static-worker',\n+          },\n+        }\n+      : undefined,\n   }) as StaticWorker\n }\n \n@@ -1735,6 +1744,15 @@ export default async function build(\n                     isolatedMemory: false,\n                     numWorkers: 1,\n                     exposedMethods: ['collectBuildTraces'],\n+                    forkOptions: process.env.NEXT_CPU_PROF\n+                      ? {\n+                          env: {\n+                            NEXT_CPU_PROF: '1',\n+                            NEXT_CPU_PROF_DIR: process.env.NEXT_CPU_PROF_DIR,\n+                            __NEXT_PRIVATE_CPU_PROFILE: 'build-trace-worker',\n+                          },\n+                        }\n+                      : undefined,\n                   }\n                 ) as Worker & typeof import('./collect-build-traces')\n "
        },
        {
            "sha": "d9019bcd5daabe424d8b898ee024cff25c628006",
            "filename": "packages/next/src/build/turbopack-build/impl.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Fimpl.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,3 +1,5 @@\n+// Import cpu-profile first to start profiling early if enabled\n+import { saveCpuProfile } from '../../server/lib/cpu-profile'\n import path from 'path'\n import { validateTurboNextConfig } from '../../lib/turbopack-warning'\n import { isFileSystemCacheEnabledForBuild } from '../../shared/lib/turbopack/utils'\n@@ -261,6 +263,8 @@ export async function workerMain(workerData: {\n   } finally {\n     // Always flush telemetry before worker exits (waits for async operations like setTimeout in debug mode)\n     await telemetry.flush()\n+    // Save CPU profile before worker exits\n+    await saveCpuProfile()\n   }\n }\n "
        },
        {
            "sha": "096d50d878d3bc7b510f67f134b6b2ba8678a667",
            "filename": "packages/next/src/build/turbopack-build/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fturbopack-build%2Findex.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -17,6 +17,13 @@ async function turbopackBuildWithWorker(): ReturnType<\n       forkOptions: {\n         env: {\n           NEXT_PRIVATE_BUILD_WORKER: '1',\n+          ...(process.env.NEXT_CPU_PROF\n+            ? {\n+                NEXT_CPU_PROF: '1',\n+                NEXT_CPU_PROF_DIR: process.env.NEXT_CPU_PROF_DIR,\n+                __NEXT_PRIVATE_CPU_PROFILE: 'build-turbopack',\n+              }\n+            : undefined),\n         },\n       },\n     }) as Worker & typeof import('./impl')"
        },
        {
            "sha": "bc398ae634fae9021db463056663fcf75cf88a88",
            "filename": "packages/next/src/build/webpack-build/impl.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Fimpl.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,3 +1,5 @@\n+// Import cpu-profile first to start profiling early if enabled\n+import { saveCpuProfile } from '../../server/lib/cpu-profile'\n import type { webpack } from 'next/dist/compiled/webpack/webpack'\n import { stringBufferUtils } from 'next/dist/compiled/webpack-sources3'\n import { red } from '../../lib/picocolors'\n@@ -416,5 +418,8 @@ export async function workerMain(workerData: {\n   NextBuildContext.nextBuildSpan.stop()\n   await telemetry.flush()\n \n+  // Save CPU profile before worker exits\n+  await saveCpuProfile()\n+\n   return { ...result, debugTraceEvents: getTraceEvents() }\n }"
        },
        {
            "sha": "61f6aa58ab6bec7efdf7f73cdcc23c919dbdd82d",
            "filename": "packages/next/src/build/webpack-build/index.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack-build%2Findex.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -54,6 +54,13 @@ async function webpackBuildWithWorker(\n       forkOptions: {\n         env: {\n           NEXT_PRIVATE_BUILD_WORKER: '1',\n+          ...(process.env.NEXT_CPU_PROF\n+            ? {\n+                NEXT_CPU_PROF: '1',\n+                NEXT_CPU_PROF_DIR: process.env.NEXT_CPU_PROF_DIR,\n+                __NEXT_PRIVATE_CPU_PROFILE: `build-webpack-${compilerName}`,\n+              }\n+            : undefined),\n         },\n       },\n     }) as Worker & typeof import('./impl')"
        },
        {
            "sha": "87a55a2ff9cc037cbde71df93c4dd2e31b7ee273",
            "filename": "packages/next/src/build/worker.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fbuild%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fworker.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,4 +1,6 @@\n import '../server/require-hook'\n+// Import cpu-profile to start profiling early if enabled\n+import '../server/lib/cpu-profile'\n \n export {\n   getDefinedNamedExports,"
        },
        {
            "sha": "5a2b9e715914bb3771e2a710c3ea592330d5a7e9",
            "filename": "packages/next/src/cli/next-analyze.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,6 +1,7 @@\n #!/usr/bin/env node\n \n import '../server/lib/cpu-profile'\n+import { saveCpuProfile } from '../server/lib/cpu-profile'\n import { existsSync } from 'fs'\n import { italic } from '../lib/picocolors'\n import analyze from '../build/analyze'\n@@ -18,8 +19,14 @@ export type NextAnalyzeOptions = {\n }\n \n const nextAnalyze = async (options: NextAnalyzeOptions, directory?: string) => {\n-  process.on('SIGTERM', () => process.exit(143))\n-  process.on('SIGINT', () => process.exit(130))\n+  process.on('SIGTERM', () => {\n+    saveCpuProfile()\n+    process.exit(143)\n+  })\n+  process.on('SIGINT', () => {\n+    saveCpuProfile()\n+    process.exit(130)\n+  })\n \n   const { profile, mangling, experimentalAppOnly, output, port } = options\n "
        },
        {
            "sha": "bebb0bb9dec0e789774ad0f7c25114da958206e5",
            "filename": "packages/next/src/cli/next-build.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-build.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,6 +1,6 @@\n #!/usr/bin/env node\n \n-import '../server/lib/cpu-profile'\n+import { saveCpuProfile } from '../server/lib/cpu-profile'\n import { existsSync } from 'fs'\n import { italic } from '../lib/picocolors'\n import build from '../build'\n@@ -32,11 +32,18 @@ export type NextBuildOptions = {\n   experimentalUploadTrace?: string\n   experimentalNextConfigStripTypes?: boolean\n   debugBuildPaths?: string\n+  experimentalCpuProf?: boolean\n }\n \n const nextBuild = async (options: NextBuildOptions, directory?: string) => {\n-  process.on('SIGTERM', () => process.exit(143))\n-  process.on('SIGINT', () => process.exit(130))\n+  process.on('SIGTERM', () => {\n+    saveCpuProfile()\n+    process.exit(143)\n+  })\n+  process.on('SIGINT', () => {\n+    saveCpuProfile()\n+    process.exit(130)\n+  })\n \n   const {\n     experimentalAnalyze,\n@@ -157,4 +164,4 @@ const nextBuild = async (options: NextBuildOptions, directory?: string) => {\n     })\n }\n \n-export { nextBuild }\n+export { nextBuild, saveCpuProfile }"
        },
        {
            "sha": "2787de380757fcdf76228527fcaf7c954ef808e1",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,6 +1,7 @@\n #!/usr/bin/env node\n \n import '../server/lib/cpu-profile'\n+import { saveCpuProfile } from '../server/lib/cpu-profile'\n import type { StartServerOptions } from '../server/lib/start-server'\n import {\n   RESTART_EXIT_CODE,\n@@ -60,6 +61,7 @@ export type NextDevOptions = {\n   experimentalHttpsCa?: string\n   experimentalUploadTrace?: string\n   experimentalNextConfigStripTypes?: boolean\n+  experimentalCpuProf?: boolean\n }\n \n type PortSource = 'cli' | 'default' | 'env'\n@@ -162,6 +164,9 @@ const handleSessionStop = async (signal: NodeJS.Signals | number | null) => {\n     })\n   }\n \n+  // Save CPU profile if it was enabled (before exiting)\n+  saveCpuProfile()\n+\n   // ensure we re-enable the terminal cursor before exiting\n   // the program, or the cursor could remain hidden\n   process.stdout.write('\\x1B[?25h')\n@@ -189,6 +194,12 @@ const nextDev = async (\n     printAndExit(`> No such directory exists as the project root: ${dir}`)\n   }\n \n+  if (options.experimentalCpuProf) {\n+    Log.info(\n+      `CPU profiling enabled. Profile will be saved to .next/cpu-profiles/ on exit (Ctrl+C).`\n+    )\n+  }\n+\n   async function preflight(skipOnReboot: boolean) {\n     const { getPackageVersion, getDependencies } = (await Promise.resolve(\n       require('../lib/get-package-version') as typeof import('../lib/get-package-version')\n@@ -318,6 +329,14 @@ const nextDev = async (\n           // https://github.com/nodejs/node/issues/29949\n           WATCHPACK_WATCHER_LIMIT:\n             os.platform() === 'darwin' ? '20' : undefined,\n+          // Enable CPU profiling if requested\n+          ...(options.experimentalCpuProf\n+            ? {\n+                NEXT_CPU_PROF: '1',\n+                NEXT_CPU_PROF_DIR: path.join(dir, '.next', 'cpu-profiles'),\n+                __NEXT_PRIVATE_CPU_PROFILE: 'dev-server',\n+              }\n+            : undefined),\n         },\n       })\n "
        },
        {
            "sha": "4fbb70f780435e7e81f0158b1873db2626eb09f4",
            "filename": "packages/next/src/cli/next-start.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fcli%2Fnext-start.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fcli%2Fnext-start.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-start.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,19 +1,22 @@\n #!/usr/bin/env node\n \n import '../server/lib/cpu-profile'\n+import { saveCpuProfile } from '../server/lib/cpu-profile'\n import { startServer } from '../server/lib/start-server'\n import { printAndExit } from '../server/lib/utils'\n import { getProjectDir } from '../lib/get-project-dir'\n import {\n   getReservedPortExplanation,\n   isPortIsReserved,\n } from '../lib/helpers/get-reserved-port'\n+import * as Log from '../build/output/log'\n \n export type NextStartOptions = {\n   port: number\n   hostname?: string\n   keepAliveTimeout?: number\n   experimentalNextConfigStripTypes?: boolean\n+  experimentalCpuProf?: boolean\n }\n \n /**\n@@ -32,6 +35,13 @@ const nextStart = async (options: NextStartOptions, directory?: string) => {\n     printAndExit(getReservedPortExplanation(port), 1)\n   }\n \n+  if (options.experimentalCpuProf) {\n+    Log.info(`CPU profiling enabled. Profile will be saved on exit (Ctrl+C).`)\n+    // Save CPU profile on shutdown signals, but let start-server.ts handle graceful exit\n+    process.on('SIGTERM', () => saveCpuProfile())\n+    process.on('SIGINT', () => saveCpuProfile())\n+  }\n+\n   await startServer({\n     dir,\n     isDev: false,"
        },
        {
            "sha": "9420e7a7c081681bc1e41d60af5f619e3f887645",
            "filename": "packages/next/src/server/lib/cpu-profile.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 18,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcpu-profile.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcpu-profile.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fcpu-profile.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -1,32 +1,67 @@\n const privateCpuProfileName = process.env.__NEXT_PRIVATE_CPU_PROFILE\n const isCpuProfileEnabled = process.env.NEXT_CPU_PROF || privateCpuProfileName\n+const cpuProfileDir = process.env.NEXT_CPU_PROF_DIR\n+\n+let session: import('inspector').Session | null = null\n+let profileSaved = false\n \n if (isCpuProfileEnabled) {\n   const { Session } = require('inspector') as typeof import('inspector')\n-  const fs = require('fs') as typeof import('fs')\n \n-  const session = new Session()\n+  session = new Session()\n   session.connect()\n \n   session.post('Profiler.enable')\n   session.post('Profiler.start')\n \n-  function saveProfile() {\n-    session.post('Profiler.stop', (error, param) => {\n-      if (error) {\n-        console.error('Cannot generate CPU profiling:', error)\n-        return\n-      }\n+  process.on('exit', () => {\n+    saveCpuProfile()\n+  })\n+}\n \n-      // Write profile to disk\n-      const filename = `${\n-        privateCpuProfileName || 'CPU.main'\n-      }.${Date.now()}.cpuprofile`\n-      fs.writeFileSync(`./${filename}`, JSON.stringify(param.profile))\n-      process.exit(0)\n-    })\n+/**\n+ * Save the CPU profile to disk.\n+ *\n+ * This is synchronous despite the callback-based API because inspector's\n+ * session.post() executes its callback synchronously when connected to\n+ * the same process (via session.connect()).\n+ */\n+export function saveCpuProfile(): void {\n+  if (!session || profileSaved || !isCpuProfileEnabled) {\n+    return\n   }\n-  process.on('SIGINT', saveProfile)\n-  process.on('SIGTERM', saveProfile)\n-  process.on('exit', saveProfile)\n+  profileSaved = true\n+\n+  const fs = require('fs') as typeof import('fs')\n+  const path = require('path') as typeof import('path')\n+\n+  session!.post('Profiler.stop', (error, param) => {\n+    if (error) {\n+      console.error('Cannot generate CPU profiling:', error)\n+      return\n+    }\n+\n+    const timestamp = new Date()\n+      .toISOString()\n+      .replace(/[:.]/g, '-')\n+      .slice(0, 19)\n+    const baseName = privateCpuProfileName || 'cpu-profile'\n+    const filename = `${baseName}-${timestamp}.cpuprofile`\n+\n+    let outputPath: string\n+    if (cpuProfileDir) {\n+      if (!fs.existsSync(cpuProfileDir)) {\n+        fs.mkdirSync(cpuProfileDir, { recursive: true })\n+      }\n+      outputPath = path.join(cpuProfileDir, filename)\n+    } else {\n+      outputPath = `./${filename}`\n+    }\n+\n+    fs.writeFileSync(outputPath, JSON.stringify(param.profile))\n+    const { green } =\n+      require('../../lib/picocolors') as typeof import('../../lib/picocolors')\n+    console.log(`\\n${green('CPU profile saved:')} ${outputPath}`)\n+    console.log('Open in Chrome DevTools → Performance tab → Load profile')\n+  })\n }"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/cpu-profiling/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fcpu-profiling%2Fapp%2Flayout.tsx?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "e6cb3bffbf6c7cc4f1ef4e47f99c53d6bab6a72e",
            "filename": "test/e2e/cpu-profiling/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fcpu-profiling%2Fapp%2Fpage.tsx?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Home() {\n+  return <h1>Hello from CPU Profiling Test</h1>\n+}"
        },
        {
            "sha": "23f12d1f3fff2e8947bb9385153ed506e15f5459",
            "filename": "test/e2e/cpu-profiling/cpu-profiling-build.test.ts",
            "status": "added",
            "additions": 57,
            "deletions": 0,
            "changes": 57,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling-build.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling-build.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling-build.test.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,57 @@\n+import { nextTestSetup, isNextDeploy } from 'e2e-utils'\n+import { pathExists, readdir } from 'fs-extra'\n+import { join } from 'path'\n+\n+describe('CPU Profiling - next build', () => {\n+  const { next, isNextDev, skipped, isTurbopack } = nextTestSetup({\n+    files: __dirname,\n+    buildCommand: 'pnpm next build --experimental-cpu-prof',\n+    dependencies: {},\n+    skipStart: true,\n+    skipDeployment: true,\n+  })\n+\n+  // CPU profiling only works with local `next build`, not dev or deploy modes\n+  if (isNextDev || isNextDeploy || skipped) {\n+    it('skip for development/deploy mode', () => {})\n+    return\n+  }\n+\n+  beforeAll(async () => {\n+    // Run the build with CPU profiling enabled\n+    await next.build()\n+  })\n+\n+  it('should create CPU profile files after build', async () => {\n+    const profileDir = join(next.testDir, '.next', 'cpu-profiles')\n+\n+    const profileDirExists = await pathExists(profileDir)\n+    expect(profileDirExists).toBe(true)\n+\n+    const files = await readdir(profileDir)\n+    const cpuProfiles = files.filter((f: string) => f.endsWith('.cpuprofile'))\n+\n+    // Main profile should always exist\n+    expect(cpuProfiles.some((f) => f.startsWith('build-main-'))).toBe(true)\n+\n+    if (isTurbopack) {\n+      // Turbopack mode generates: build-main, build-turbopack\n+      expect(cpuProfiles.length).toBe(2)\n+      expect(cpuProfiles.some((f) => f.startsWith('build-turbopack-'))).toBe(\n+        true\n+      )\n+    } else {\n+      // Webpack mode generates: build-main, build-webpack-client, build-webpack-server, build-webpack-edge-server\n+      expect(cpuProfiles.length).toBe(4)\n+      expect(\n+        cpuProfiles.some((f) => f.startsWith('build-webpack-client-'))\n+      ).toBe(true)\n+      expect(\n+        cpuProfiles.some((f) => f.startsWith('build-webpack-server-'))\n+      ).toBe(true)\n+      expect(\n+        cpuProfiles.some((f) => f.startsWith('build-webpack-edge-server-'))\n+      ).toBe(true)\n+    }\n+  })\n+})"
        },
        {
            "sha": "66685a59b13872064b5973ca5324ba2da5a104fd",
            "filename": "test/e2e/cpu-profiling/cpu-profiling-dev.test.ts",
            "status": "added",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling-dev.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling-dev.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling-dev.test.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,46 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { pathExists, readdir } from 'fs-extra'\n+import { join } from 'path'\n+import { retry } from 'next-test-utils'\n+\n+describe('CPU Profiling - next dev', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+    startCommand: 'pnpm next dev --experimental-cpu-prof',\n+    dependencies: {},\n+  })\n+\n+  if (!isNextDev) {\n+    it('skip for production mode', () => {})\n+    return\n+  }\n+\n+  it('should create CPU profile files on exit', async () => {\n+    const profileDir = join(next.testDir, '.next', 'cpu-profiles')\n+\n+    // Make a request to ensure the server is running\n+    const res = await next.fetch('/')\n+    expect(res.status).toBe(200)\n+\n+    // Stop the server with SIGTERM to trigger profile save (SIGKILL doesn't allow cleanup)\n+    await next.stop('SIGTERM')\n+\n+    // Retry until profile files are written\n+    const cpuProfiles = await retry(async () => {\n+      const profileDirExists = await pathExists(profileDir)\n+      expect(profileDirExists).toBe(true)\n+\n+      const files = await readdir(profileDir)\n+      const profiles = files.filter((f: string) => f.endsWith('.cpuprofile'))\n+      expect(profiles.length).toBeGreaterThanOrEqual(1)\n+      return profiles\n+    })\n+\n+    // Verify profile names are meaningful\n+    for (const profile of cpuProfiles) {\n+      expect(profile).toMatch(\n+        /^(dev-main|dev-server)-\\d{4}-\\d{2}-\\d{2}T\\d{2}-\\d{2}-\\d{2}\\.cpuprofile$/\n+      )\n+    }\n+  })\n+})"
        },
        {
            "sha": "6be270bc7aba3f1822bd60732ec22653445a4ecf",
            "filename": "test/e2e/cpu-profiling/cpu-profiling.test.ts",
            "status": "added",
            "additions": 52,
            "deletions": 0,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fcpu-profiling%2Fcpu-profiling.test.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,52 @@\n+import { nextTestSetup, isNextDeploy } from 'e2e-utils'\n+import { pathExists, readdir } from 'fs-extra'\n+import { join } from 'path'\n+import { retry } from 'next-test-utils'\n+\n+describe('CPU Profiling - next start', () => {\n+  const { next, isNextDev, skipped } = nextTestSetup({\n+    files: __dirname,\n+    startCommand: 'pnpm next start --experimental-cpu-prof',\n+    dependencies: {},\n+    skipStart: true, // Skip auto-start to avoid failure in dev/deploy mode\n+  })\n+\n+  // CPU profiling only works with local `next start`, not dev or deploy modes\n+  if (isNextDev || isNextDeploy || skipped) {\n+    it('skip for development/deploy mode', () => {})\n+    return\n+  }\n+\n+  beforeAll(async () => {\n+    await next.start()\n+  })\n+\n+  it('should create CPU profile files on exit', async () => {\n+    const profileDir = join(next.testDir, '.next', 'cpu-profiles')\n+\n+    // Make a request to ensure the server is running\n+    const res = await next.fetch('/')\n+    expect(res.status).toBe(200)\n+\n+    // Stop the server with SIGTERM to trigger profile save (SIGKILL doesn't allow cleanup)\n+    await next.stop('SIGTERM')\n+\n+    // Retry until profile files are written\n+    const cpuProfiles = await retry(async () => {\n+      const profileDirExists = await pathExists(profileDir)\n+      expect(profileDirExists).toBe(true)\n+\n+      const files = await readdir(profileDir)\n+      const profiles = files.filter((f: string) => f.endsWith('.cpuprofile'))\n+      expect(profiles.length).toBeGreaterThan(0)\n+      return profiles\n+    })\n+\n+    // Verify profile name is meaningful (start-main)\n+    for (const profile of cpuProfiles) {\n+      expect(profile).toMatch(\n+        /^start-main-\\d{4}-\\d{2}-\\d{2}T\\d{2}-\\d{2}-\\d{2}\\.cpuprofile$/\n+      )\n+    }\n+  })\n+})"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/integration/cpu-profiling/fixtures/basic-app/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Fapp%2Flayout.tsx?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "f54faf15c6bcdf94e9534dff2de896ec7f7b6f87",
            "filename": "test/integration/cpu-profiling/fixtures/basic-app/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Fapp%2Fpage.tsx?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <h1>Hello</h1>\n+}"
        },
        {
            "sha": "c124ed94be3320809f0514583a6582072d35413d",
            "filename": "test/integration/cpu-profiling/fixtures/basic-app/tsconfig.json",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Ftsconfig.json",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Ftsconfig.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcpu-profiling%2Ffixtures%2Fbasic-app%2Ftsconfig.json?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,31 @@\n+{\n+  \"compilerOptions\": {\n+    \"target\": \"ES2017\",\n+    \"lib\": [\"dom\", \"dom.iterable\", \"esnext\"],\n+    \"allowJs\": true,\n+    \"skipLibCheck\": true,\n+    \"strict\": false,\n+    \"noEmit\": true,\n+    \"incremental\": true,\n+    \"module\": \"esnext\",\n+    \"esModuleInterop\": true,\n+    \"moduleResolution\": \"node\",\n+    \"resolveJsonModule\": true,\n+    \"isolatedModules\": true,\n+    \"jsx\": \"react-jsx\",\n+    \"plugins\": [\n+      {\n+        \"name\": \"next\"\n+      }\n+    ]\n+  },\n+  \"include\": [\n+    \"next-env.d.ts\",\n+    \".next/types/**/*.ts\",\n+    \".next/dev/types/**/*.ts\",\n+    \"**/*.mts\",\n+    \"**/*.ts\",\n+    \"**/*.tsx\"\n+  ],\n+  \"exclude\": [\"node_modules\"]\n+}"
        },
        {
            "sha": "e24118c37d1c16f9fce21fb18bfc16a64b7c509a",
            "filename": "test/integration/cpu-profiling/test/index.test.ts",
            "status": "added",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fintegration%2Fcpu-profiling%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fd5817d00462f68c56982012fb62fc255816f9bd/test%2Fintegration%2Fcpu-profiling%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcpu-profiling%2Ftest%2Findex.test.ts?ref=fd5817d00462f68c56982012fb62fc255816f9bd",
            "patch": "@@ -0,0 +1,61 @@\n+/* eslint-env jest */\n+\n+import { remove, pathExists, readdir } from 'fs-extra'\n+import { nextBuild } from 'next-test-utils'\n+import { join } from 'path'\n+\n+const fixturesDir = join(__dirname, '..', 'fixtures')\n+const appDir = join(fixturesDir, 'basic-app')\n+\n+describe('CPU Profiling', () => {\n+  beforeEach(async () => {\n+    await remove(join(appDir, '.next'))\n+  })\n+\n+  describe('next build --experimental-cpu-prof', () => {\n+    it('should create CPU profile files with meaningful names', async () => {\n+      const profileDir = join(appDir, '.next', 'cpu-profiles')\n+\n+      const { stdout } = await nextBuild(appDir, ['--experimental-cpu-prof'], {\n+        stdout: true,\n+        stderr: true,\n+      })\n+\n+      expect(stdout).toContain('CPU profile saved')\n+\n+      const profileDirExists = await pathExists(profileDir)\n+      expect(profileDirExists).toBe(true)\n+\n+      const files = await readdir(profileDir)\n+      const cpuProfiles = files.filter((f) => f.endsWith('.cpuprofile'))\n+      expect(cpuProfiles.length).toBeGreaterThan(0)\n+\n+      // Verify profile names are meaningful (not just random numbers)\n+      for (const profile of cpuProfiles) {\n+        // Profile names should contain descriptive prefixes like 'build-main', 'build-webpack-server', etc.\n+        expect(profile).toMatch(\n+          /^(build-main|build-webpack-(server|client|edge-server)|build-turbopack|build-static-worker|build-trace-worker)-\\d{4}-\\d{2}-\\d{2}T\\d{2}-\\d{2}-\\d{2}\\.cpuprofile$/\n+        )\n+      }\n+    })\n+\n+    it('should create profiles for worker processes', async () => {\n+      const profileDir = join(appDir, '.next', 'cpu-profiles')\n+\n+      await nextBuild(appDir, ['--experimental-cpu-prof'], {\n+        stdout: true,\n+        stderr: true,\n+      })\n+\n+      const files = await readdir(profileDir)\n+      const cpuProfiles = files.filter((f) => f.endsWith('.cpuprofile'))\n+\n+      // Should have at least main process profile and potentially worker profiles\n+      expect(cpuProfiles.length).toBeGreaterThanOrEqual(1)\n+\n+      // Verify we have the main build profile\n+      const mainProfile = cpuProfiles.find((f) => f.startsWith('build-main'))\n+      expect(mainProfile).toBeDefined()\n+    })\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 530,
        "additions": 505,
        "deletions": 25
    }
}