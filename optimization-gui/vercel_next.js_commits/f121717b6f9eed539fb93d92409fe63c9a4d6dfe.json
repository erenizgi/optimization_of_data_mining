{
    "author": "lubieowoce",
    "message": "add types for `__next_app__` module loading functions (#74566)\n\n`__next_app__.require` and `__next_app__.loadChunk` were typed as `any` for no good reason. i made them more strict + adjusted callsites as needed.\r\n\r\nalso contains a drive-by fix for `wrapClientComponentLoader` -- it was using a `try ... finally` without awaiting, so it wasn't measuring anything (because `loadChunk`, being async, would always return immediately)",
    "sha": "f121717b6f9eed539fb93d92409fe63c9a4d6dfe",
    "files": [
        {
            "sha": "87cf0c811f76c54f6ec4d9f5d1deead6cba2a727",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/f121717b6f9eed539fb93d92409fe63c9a4d6dfe/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f121717b6f9eed539fb93d92409fe63c9a4d6dfe/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=f121717b6f9eed539fb93d92409fe63c9a4d6dfe",
            "patch": "@@ -21,8 +21,8 @@ export { tree, pages }\n export { default as GlobalError } from 'VAR_MODULE_GLOBAL_ERROR' with { 'turbopack-transition': 'next-server-utility' }\n \n // These are injected by the loader afterwards.\n-declare const __next_app_require__: any\n-declare const __next_app_load_chunk__: any\n+declare const __next_app_require__: (id: string | number) => unknown\n+declare const __next_app_load_chunk__: (id: string | number) => Promise<unknown>\n \n // INJECT:__next_app_require__\n // INJECT:__next_app_load_chunk__"
        },
        {
            "sha": "ac763262807ad0c0345fcf26eb3bb4ecea484192",
            "filename": "packages/next/src/server/app-render/action-handler.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/f121717b6f9eed539fb93d92409fe63c9a4d6dfe/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f121717b6f9eed539fb93d92409fe63c9a4d6dfe/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Faction-handler.ts?ref=f121717b6f9eed539fb93d92409fe63c9a4d6dfe",
            "patch": "@@ -912,12 +912,14 @@ export async function handleAction({\n         }\n       }\n \n-      const actionHandler = (\n-        await ComponentMod.__next_app__.require(actionModId)\n-      )[\n-        // `actionId` must exist if we got here, as otherwise we would have thrown an error above\n-        actionId!\n-      ]\n+      const actionMod = (await ComponentMod.__next_app__.require(\n+        actionModId\n+      )) as Record<string, (...args: unknown[]) => Promise<unknown>>\n+      const actionHandler =\n+        actionMod[\n+          // `actionId` must exist if we got here, as otherwise we would have thrown an error above\n+          actionId!\n+        ]\n \n       const returnVal = await workUnitAsyncStorage.run(requestStore, () =>\n         actionHandler.apply(null, boundActionArguments)"
        },
        {
            "sha": "0510318d83b0b6a6fb8f0afdaefcb7126dc39eb0",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f121717b6f9eed539fb93d92409fe63c9a4d6dfe/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f121717b6f9eed539fb93d92409fe63c9a4d6dfe/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=f121717b6f9eed539fb93d92409fe63c9a4d6dfe",
            "patch": "@@ -1189,12 +1189,13 @@ async function renderToHTMLOrFlightImpl(\n     // cache reads we wrap the loadChunk in this tracking. This allows us\n     // to treat chunk loading with similar semantics as cache reads to avoid\n     // async loading chunks from causing a prerender to abort too early.\n-    // @ts-ignore\n-    globalThis.__next_chunk_load__ = (...args: Array<any>) => {\n+    const __next_chunk_load__: typeof instrumented.loadChunk = (...args) => {\n       const loadingChunk = instrumented.loadChunk(...args)\n       trackChunkLoading(loadingChunk)\n       return loadingChunk\n     }\n+    // @ts-expect-error\n+    globalThis.__next_chunk_load__ = __next_chunk_load__\n   }\n \n   if (process.env.NODE_ENV === 'development') {"
        },
        {
            "sha": "20b5febca26ca2b4448627236832cf9da58e228b",
            "filename": "packages/next/src/server/client-component-renderer-logger.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 7,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/f121717b6f9eed539fb93d92409fe63c9a4d6dfe/packages%2Fnext%2Fsrc%2Fserver%2Fclient-component-renderer-logger.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f121717b6f9eed539fb93d92409fe63c9a4d6dfe/packages%2Fnext%2Fsrc%2Fserver%2Fclient-component-renderer-logger.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fclient-component-renderer-logger.ts?ref=f121717b6f9eed539fb93d92409fe63c9a4d6dfe",
            "patch": "@@ -1,15 +1,19 @@\n+import type { AppPageModule } from './route-modules/app-page/module'\n+\n // Combined load times for loading client components\n let clientComponentLoadStart = 0\n let clientComponentLoadTimes = 0\n let clientComponentLoadCount = 0\n \n-export function wrapClientComponentLoader(ComponentMod: any) {\n+export function wrapClientComponentLoader(\n+  ComponentMod: AppPageModule\n+): AppPageModule['__next_app__'] {\n   if (!('performance' in globalThis)) {\n     return ComponentMod.__next_app__\n   }\n \n   return {\n-    require: (...args: any[]) => {\n+    require: (...args) => {\n       const startTime = performance.now()\n \n       if (clientComponentLoadStart === 0) {\n@@ -23,13 +27,15 @@ export function wrapClientComponentLoader(ComponentMod: any) {\n         clientComponentLoadTimes += performance.now() - startTime\n       }\n     },\n-    loadChunk: (...args: any[]) => {\n+    loadChunk: (...args) => {\n       const startTime = performance.now()\n-      try {\n-        return ComponentMod.__next_app__.loadChunk(...args)\n-      } finally {\n+      const result = ComponentMod.__next_app__.loadChunk(...args)\n+      // Avoid wrapping `loadChunk`'s result in an extra promise in case something like React depends on its identity.\n+      // We only need to know when it's settled.\n+      result.finally(() => {\n         clientComponentLoadTimes += performance.now() - startTime\n-      }\n+      })\n+      return result\n     },\n   }\n }"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 26,
        "deletions": 17
    }
}