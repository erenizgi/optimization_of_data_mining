{
    "author": "eps1lon",
    "message": "webpack: Sourcemap externals when replayed in the browser (#75863)\n\nThis was already implemented in the middleware for Turbopack but absent when Webpack was used. We now always prefer the native `findSourceMap` over invoking Webpack's API.\n\nThis way stackframes from externals are now properly sourcemapped (and therefore ignore-listed)\n\nNotice how the `react-server-dom-webpack...` stackframe (`console.error` method) wasn't ignore-listed before.\n\nBefore:\n\n![CleanShot 2025-02-10 at 14.34.44.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/dLGs20hkgfWzupsPjSxb/2a8147d4-4b6f-4170-ae36-8b544ff0bb1a.png)\n\nAfter:\n\n![CleanShot 2025-02-10 at 14.36.15.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/dLGs20hkgfWzupsPjSxb/f713e36d-88f4-4185-8bf8-0293a7b7f4f1.png)",
    "sha": "ed676009e3e2914f1bbdd43d8d247c177bea5bea",
    "files": [
        {
            "sha": "08639644a64f4f0c9c7bb813cfd22cd4d63385b1",
            "filename": "packages/next/src/client/components/react-dev-overlay/server/middleware-webpack.ts",
            "status": "modified",
            "additions": 27,
            "deletions": 4,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/ed676009e3e2914f1bbdd43d8d247c177bea5bea/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ed676009e3e2914f1bbdd43d8d247c177bea5bea/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fserver%2Fmiddleware-webpack.ts?ref=ed676009e3e2914f1bbdd43d8d247c177bea5bea",
            "patch": "@@ -1,4 +1,5 @@\n import { constants as FS, promises as fs } from 'fs'\n+import { findSourceMap, type SourceMap } from 'module'\n import path from 'path'\n import { fileURLToPath, pathToFileURL } from 'url'\n import {\n@@ -128,8 +129,10 @@ async function findOriginalSourcePositionAndContent(\n   }\n }\n \n-export function getIgnoredSources(sourceMap: RawSourceMap): IgnoredSources {\n-  const ignoreList = new Set<number>()\n+export function getIgnoredSources(\n+  sourceMap: RawSourceMap & { ignoreList?: number[] }\n+): IgnoredSources {\n+  const ignoreList = new Set<number>(sourceMap.ignoreList ?? [])\n   const moduleFilenames = sourceMap?.sources ?? []\n \n   for (let index = 0; index < moduleFilenames.length; index++) {\n@@ -289,6 +292,26 @@ async function getSource(\n ): Promise<Source | undefined> {\n   const { getCompilations } = options\n \n+  let nativeSourceMap: SourceMap | undefined\n+  try {\n+    nativeSourceMap = findSourceMap(sourceURL)\n+  } catch (cause) {\n+    throw new Error(\n+      `${sourceURL}: Invalid source map. Only conformant source maps can be used to find the original code.`,\n+      { cause }\n+    )\n+  }\n+\n+  if (nativeSourceMap !== undefined) {\n+    const sourceMapPayload = nativeSourceMap.payload\n+    return {\n+      type: 'file',\n+      sourceMap: sourceMapPayload,\n+      ignoredSources: getIgnoredSources(sourceMapPayload),\n+      moduleURL: sourceURL,\n+    }\n+  }\n+\n   if (path.isAbsolute(sourceURL)) {\n     sourceURL = pathToFileURL(sourceURL).href\n   }\n@@ -316,7 +339,7 @@ async function getSource(\n     .replace(/\\?\\d+$/, '')\n \n   // (rsc)/./src/hello.tsx => ./src/hello.tsx\n-  const modulePath = moduleId.replace(/^(\\(.*\\)\\/?)/, '')\n+  const moduleURL = moduleId.replace(/^(\\(.*\\)\\/?)/, '')\n \n   for (const compilation of getCompilations()) {\n     const sourceMap = await getSourceMapFromCompilation(moduleId, compilation)\n@@ -328,7 +351,7 @@ async function getSource(\n         sourceMap,\n         compilation,\n         moduleId,\n-        moduleURL: modulePath,\n+        moduleURL,\n         ignoredSources,\n       }\n     }"
        }
    ],
    "stats": {
        "total": 31,
        "additions": 27,
        "deletions": 4
    }
}