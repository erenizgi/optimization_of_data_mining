{
    "author": "unstubbable",
    "message": "Add a test to show that `'use cache'` works in `generateMetadata` (#80172)\n\nWhen calling a function with a `'use cache'` directive from\n`generateMetadata`, and from the page/layout, the invocations are\ndeduped and the result is shared.\n\nWhen `generateMetadata` itself also has a `'use cache'` directive, and\nit calls a nested function with a `'use cache'` directive, we do need to\nland #78703 for proper deduplication of the nested cache.",
    "sha": "04ee28ff1ed3b8b641073f74753dd292833a06e1",
    "files": [
        {
            "sha": "374125e6699e055e9f77d6bcf371a33c502cb4f3",
            "filename": "test/e2e/app-dir/use-cache/app/generate-metadata/cached-data.ts",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/04ee28ff1ed3b8b641073f74753dd292833a06e1/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Fcached-data.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04ee28ff1ed3b8b641073f74753dd292833a06e1/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Fcached-data.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Fcached-data.ts?ref=04ee28ff1ed3b8b641073f74753dd292833a06e1",
            "patch": "@@ -0,0 +1,7 @@\n+import { setTimeout } from 'timers/promises'\n+\n+export async function getCachedData() {\n+  'use cache'\n+  await setTimeout(1000)\n+  return new Date().toISOString()\n+}"
        },
        {
            "sha": "ec2adaa98bb77a42e89526f67a2eaff9af4f0ac6",
            "filename": "test/e2e/app-dir/use-cache/app/generate-metadata/layout.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/04ee28ff1ed3b8b641073f74753dd292833a06e1/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/04ee28ff1ed3b8b641073f74753dd292833a06e1/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Flayout.tsx?ref=04ee28ff1ed3b8b641073f74753dd292833a06e1",
            "patch": "@@ -0,0 +1,15 @@\n+import { getCachedData } from './cached-data'\n+\n+export default async function Layout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <>\n+      <h1>Layout</h1>\n+      <p id=\"layout-data\">{await getCachedData()}</p>\n+      <div>{children}</div>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "dc213645e3f65ef0b7513840292ec3b4090bca52",
            "filename": "test/e2e/app-dir/use-cache/app/generate-metadata/page.tsx",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/04ee28ff1ed3b8b641073f74753dd292833a06e1/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/04ee28ff1ed3b8b641073f74753dd292833a06e1/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2Fgenerate-metadata%2Fpage.tsx?ref=04ee28ff1ed3b8b641073f74753dd292833a06e1",
            "patch": "@@ -0,0 +1,24 @@\n+import { Metadata } from 'next'\n+import { connection } from 'next/server'\n+import { getCachedData } from './cached-data'\n+\n+export async function generateMetadata(): Promise<Metadata> {\n+  // TODO: Deduping with nested caches requires #78703.\n+  // 'use cache'\n+\n+  return {\n+    description: new Date().toISOString(),\n+    title: await getCachedData(),\n+  }\n+}\n+\n+export default async function Page() {\n+  await connection()\n+\n+  return (\n+    <>\n+      <h2>Page</h2>\n+      <p id=\"page-data\">{await getCachedData()}</p>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "bc6920bcf89252ca87d4064698281aad33ff69a1",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/04ee28ff1ed3b8b641073f74753dd292833a06e1/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04ee28ff1ed3b8b641073f74753dd292833a06e1/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=04ee28ff1ed3b8b641073f74753dd292833a06e1",
            "patch": "@@ -980,6 +980,34 @@ describe('use-cache', () => {\n       expect(randomOne).toBe(randomTwo)\n     })\n   })\n+\n+  it('shares caches between the page/layout and generateMetadata', async () => {\n+    const browser = await next.browser('/generate-metadata')\n+    const layoutData = await browser.elementByCss('#layout-data').text()\n+    const pageData = await browser.elementByCss('#page-data').text()\n+    const title = await browser.eval('document.title')\n+\n+    expect(layoutData).toBe(pageData)\n+    expect(pageData).toBe(title)\n+\n+    const initialDescription = await browser\n+      .elementByCss('meta[name=\"description\"]')\n+      .getAttribute('content')\n+\n+    expect(initialDescription).not.toBe(title)\n+\n+    await browser.refresh()\n+\n+    const description = await browser\n+      .elementByCss('meta[name=\"description\"]')\n+      .getAttribute('content')\n+\n+    // TODO: After #78703 has landed, we can enable the outer 'use cache' in\n+    // generateMetadata, and still have the cached title (a nested cache) be\n+    // shared with the page/layout. Then the description will also be cached (by\n+    // the outer 'use cache'), and this expectation needs to be flipped.\n+    expect(description).not.toBe(initialDescription)\n+  })\n })\n \n async function getSanitizedLogs(browser: Playwright): Promise<string[]> {"
        }
    ],
    "stats": {
        "total": 74,
        "additions": 74,
        "deletions": 0
    }
}