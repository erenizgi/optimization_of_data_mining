{
    "author": "devjiwonchoi",
    "message": "Sync devFallbackParams when generateStaticParams change (#85741)\n\nSince `generateStaticParams` runs in the background, when accessing the\n`devFallbackParams` during the render, it is still set to the previous\nresult from the cache. Therefore, when the result has changed, re-render\nthe RSC to sync the `devFallbackParams` with the new result.\n\nCloses NAR-491\n\n---------\n\nCo-authored-by: Josh Story <story@hey.com>",
    "sha": "a976c918e8b05be17ea1048ffae84b2b95123d72",
    "files": [
        {
            "sha": "9b4c315aa395b2716c3720963453a59055f6bc8c",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=a976c918e8b05be17ea1048ffae84b2b95123d72",
            "patch": "@@ -2096,8 +2096,7 @@ async function renderToHTMLOrFlightImpl(\n       null\n \n     const rootParams = getRootParams(loaderTree, ctx.getDynamicParamFromSegment)\n-    const devValidatingFallbackParams =\n-      getRequestMeta(req, 'devValidatingFallbackParams') || null\n+    const devFallbackParams = getRequestMeta(req, 'devFallbackParams') || null\n \n     const createRequestStore = createRequestStoreForRender.bind(\n       null,\n@@ -2111,7 +2110,7 @@ async function renderToHTMLOrFlightImpl(\n       isHmrRefresh,\n       serverComponentsHmrCache,\n       renderResumeDataCache,\n-      devValidatingFallbackParams\n+      devFallbackParams\n     )\n     const requestStore = createRequestStore()\n \n@@ -2201,7 +2200,7 @@ async function renderToHTMLOrFlightImpl(\n             postponedState,\n             metadata,\n             undefined, // Prevent restartable-render behavior in dev + Cache Components mode\n-            devValidatingFallbackParams\n+            devFallbackParams\n           )\n \n           return new RenderResult(stream, {\n@@ -2245,7 +2244,7 @@ async function renderToHTMLOrFlightImpl(\n       // and we currently we don't copy changes over when creating a new store,\n       // so the restarted render wouldn't be correct.\n       didExecuteServerAction ? undefined : createRequestStore,\n-      devValidatingFallbackParams\n+      devFallbackParams\n     )\n \n     // Invalid dynamic usages should only error the request in development.\n@@ -2451,7 +2450,7 @@ async function renderToStream(\n   postponedState: PostponedState | null,\n   metadata: AppPageRenderResultMetadata,\n   createRequestStore: (() => RequestStore) | undefined,\n-  devValidatingFallbackParams: OpaqueFallbackRouteParams | null\n+  devFallbackParams: OpaqueFallbackRouteParams | null\n ): Promise<ReadableStream<Uint8Array>> {\n   /* eslint-disable @next/internal/no-ambiguous-jsx -- React Client */\n   const {\n@@ -2689,7 +2688,7 @@ async function renderToStream(\n         res.statusCode === 404,\n         clientReferenceManifest,\n         requestStore,\n-        devValidatingFallbackParams\n+        devFallbackParams\n       )\n     } else {\n       // This is a dynamic render. We don't do dynamic tracking because we're not prerendering"
        },
        {
            "sha": "4026f012db77ea29462146da2be0fb9bd2bc73d1",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=a976c918e8b05be17ea1048ffae84b2b95123d72",
            "patch": "@@ -2298,7 +2298,7 @@ export default abstract class Server<\n           if (smallestFallbackRouteParams) {\n             addRequestMeta(\n               req,\n-              'devValidatingFallbackParams',\n+              'devFallbackParams',\n               createOpaqueFallbackRouteParams(smallestFallbackRouteParams)!\n             )\n           }"
        },
        {
            "sha": "3f634426313d2259cf64dbbcc91fe5ff1b3822a1",
            "filename": "packages/next/src/server/dev/next-dev-server.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fnext-dev-server.ts?ref=a976c918e8b05be17ea1048ffae84b2b95123d72",
            "patch": "@@ -76,6 +76,7 @@ import {\n import type { PrerenderManifest } from '../../build'\n import { getRouteRegex } from '../../shared/lib/router/utils/route-regex'\n import type { PrerenderedRoute } from '../../build/static-paths/types'\n+import { HMR_MESSAGE_SENT_TO_BROWSER } from './hot-reloader-types'\n \n // Load ReactDevOverlay only when needed\n let PagesDevOverlayBridgeImpl: PagesDevOverlayBridgeType\n@@ -802,6 +803,24 @@ export default class DevServer extends Server {\n               )\n             }\n           }\n+\n+          // Since generateStaticParams run on the background, when accessing the\n+          // devFallbackParams during the render, it is still set to the previous\n+          // result from the cache. Therefore when the result has changed, re-render\n+          // the Server Component to sync the devFallbackParams with the new result.\n+          if (\n+            isAppPath &&\n+            this.nextConfig.cacheComponents &&\n+            // Ensure this is not the first invocation.\n+            result &&\n+            // Ideally, we would want to compare the whole objects, but that is too expensive.\n+            result.prerenderedRoutes?.length !== prerenderedRoutes?.length\n+          ) {\n+            this.bundlerService.triggerHMR({\n+              type: HMR_MESSAGE_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES,\n+              hash: `generateStaticParams-${Date.now()}`,\n+            })\n+          }\n         }\n \n         if (!isAppPath && this.nextConfig.output === 'export') {"
        },
        {
            "sha": "9b820afbdbb275396e6cc16002a4e39945592866",
            "filename": "packages/next/src/server/lib/dev-bundler-service.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fdev-bundler-service.ts?ref=a976c918e8b05be17ea1048ffae84b2b95123d72",
            "patch": "@@ -4,7 +4,10 @@ import type { WorkerRequestHandler } from './types'\n \n import { LRUCache } from './lru-cache'\n import { createRequestResponseMocks } from './mock-request'\n-import { HMR_MESSAGE_SENT_TO_BROWSER } from '../dev/hot-reloader-types'\n+import {\n+  HMR_MESSAGE_SENT_TO_BROWSER,\n+  type HmrMessageSentToBrowser,\n+} from '../dev/hot-reloader-types'\n import type { ReactDebugChannelForBrowser } from '../dev/debug-channel'\n import type { ServerCacheStatus } from '../../next-devtools/dev-overlay/cache-indicator'\n \n@@ -137,4 +140,8 @@ export class DevBundlerService {\n   public close() {\n     this.bundler.hotReloader.close()\n   }\n+\n+  public triggerHMR(message: HmrMessageSentToBrowser) {\n+    this.bundler.hotReloader.send(message)\n+  }\n }"
        },
        {
            "sha": "438f7565a1cbd94b671fb28831cee84ddf328dc1",
            "filename": "packages/next/src/server/request-meta.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a976c918e8b05be17ea1048ffae84b2b95123d72/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest-meta.ts?ref=a976c918e8b05be17ea1048ffae84b2b95123d72",
            "patch": "@@ -261,7 +261,7 @@ export interface RequestMeta {\n   /**\n    * DEV only: The fallback params that should be used when validating prerenders during dev\n    */\n-  devValidatingFallbackParams?: OpaqueFallbackRouteParams\n+  devFallbackParams?: OpaqueFallbackRouteParams\n \n   /**\n    * DEV only: Request timings in process.hrtime.bigint()"
        }
    ],
    "stats": {
        "total": 45,
        "additions": 35,
        "deletions": 10
    }
}