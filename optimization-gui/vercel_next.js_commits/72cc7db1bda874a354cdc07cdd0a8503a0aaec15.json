{
    "author": "schoenwaldnils",
    "message": "fix to use https urls in meta data images when using experimental-https (#80276)\n\nfixes #80275 \n\n.. to generate https image urls in meta data when using the\n--experimental-https flag\n\n---------\n\nCo-authored-by: Zack Tanner <1939140+ztanner@users.noreply.github.com>\nCo-authored-by: JJ Kasper <jj@jjsweb.site>",
    "sha": "72cc7db1bda874a354cdc07cdd0a8503a0aaec15",
    "files": [
        {
            "sha": "d596f86d830ef8153dc21a06b44ecc186c871e88",
            "filename": ".changeset/open-dodos-admire.md",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/.changeset%2Fopen-dodos-admire.md",
            "raw_url": "https://github.com/vercel/next.js/raw/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/.changeset%2Fopen-dodos-admire.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.changeset%2Fopen-dodos-admire.md?ref=72cc7db1bda874a354cdc07cdd0a8503a0aaec15",
            "patch": "@@ -0,0 +1,5 @@\n+---\n+'next': patch\n+---\n+\n+Fix to use https urls in meta data images when using --experimental-https flag"
        },
        {
            "sha": "7039002fa8bad1ebb10ea82fed19f6400c5b33f3",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-url.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.test.ts?ref=72cc7db1bda874a354cdc07cdd0a8503a0aaec15",
            "patch": "@@ -140,6 +140,7 @@ describe('getSocialImageFallbackMetadataBase', () => {\n       delete process.env.VERCEL_ENV\n       delete process.env.VERCEL_BRANCH_URL\n       delete process.env.VERCEL_PROJECT_PRODUCTION_URL\n+      delete process.env.__NEXT_EXPERIMENTAL_HTTPS\n \n       process.env = originalEnv\n     })\n@@ -160,6 +161,24 @@ describe('getSocialImageFallbackMetadataBase', () => {\n       )\n     })\n \n+    it('should return localhost url in local dev mode with experimental https', () => {\n+      // @ts-expect-error override process env\n+      process.env.NODE_ENV = 'development'\n+      process.env.__NEXT_EXPERIMENTAL_HTTPS = '1'\n+      expect(getSocialImageFallbackMetadataBaseHelper()).toBe(\n+        'https://localhost:3000/'\n+      )\n+    })\n+\n+    it('should return localhost url in local build mode with experimental https', () => {\n+      // @ts-expect-error override process env\n+      process.env.NODE_ENV = 'production'\n+      process.env.__NEXT_EXPERIMENTAL_HTTPS = '1'\n+      expect(getSocialImageFallbackMetadataBaseHelper()).toBe(\n+        'https://localhost:3000/'\n+      )\n+    })\n+\n     it('should prefer branch url in preview deployment if presents', () => {\n       // @ts-expect-error override process env\n       process.env.NODE_ENV = 'production'"
        },
        {
            "sha": "f151ebf4fbb2a5644028b788c45d3f2d6fa5ec15",
            "filename": "packages/next/src/lib/metadata/resolvers/resolve-url.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fmetadata%2Fresolvers%2Fresolve-url.ts?ref=72cc7db1bda874a354cdc07cdd0a8503a0aaec15",
            "patch": "@@ -6,7 +6,10 @@ function isStringOrURL(icon: any): icon is string | URL {\n }\n \n function createLocalMetadataBase() {\n-  return new URL(`http://localhost:${process.env.PORT || 3000}`)\n+  // Check if experimental HTTPS is enabled\n+  const isExperimentalHttps = Boolean(process.env.__NEXT_EXPERIMENTAL_HTTPS)\n+  const protocol = isExperimentalHttps ? 'https' : 'http'\n+  return new URL(`${protocol}://localhost:${process.env.PORT || 3000}`)\n }\n \n function getPreviewDeploymentUrl(): URL | undefined {"
        },
        {
            "sha": "0189d1ac26681adfdf55ffc6f97cdb1ef32b8b28",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=72cc7db1bda874a354cdc07cdd0a8503a0aaec15",
            "patch": "@@ -349,6 +349,11 @@ export async function startServer(\n \n       process.env.__NEXT_PRIVATE_ORIGIN = appUrl\n \n+      // Set experimental HTTPS flag for metadata resolution\n+      if (selfSignedCertificate) {\n+        process.env.__NEXT_EXPERIMENTAL_HTTPS = '1'\n+      }\n+\n       // Only load env and config in dev to for logging purposes\n       let envInfo: string[] | undefined\n       let experimentalFeatures: ConfiguredExperimentalFeature[] | undefined"
        },
        {
            "sha": "d5268403e3114a6f49620c686710734e0b3a977c",
            "filename": "test/development/experimental-https-server/app/opengraph-image.tsx",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/test%2Fdevelopment%2Fexperimental-https-server%2Fapp%2Fopengraph-image.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/test%2Fdevelopment%2Fexperimental-https-server%2Fapp%2Fopengraph-image.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fexperimental-https-server%2Fapp%2Fopengraph-image.tsx?ref=72cc7db1bda874a354cdc07cdd0a8503a0aaec15",
            "patch": "@@ -0,0 +1,34 @@\n+import { ImageResponse } from 'next/og'\n+\n+export const alt = 'Test OpenGraph Image'\n+export const size = {\n+  width: 800,\n+  height: 600,\n+}\n+\n+export const contentType = 'image/png'\n+\n+export default async function Image() {\n+  return new ImageResponse(\n+    (\n+      <div\n+        style={{\n+          fontSize: 24,\n+          background: 'linear-gradient(90deg, #000 0%, #111 100%)',\n+          color: 'white',\n+          width: '100%',\n+          height: '100%',\n+          display: 'flex',\n+          textAlign: 'center',\n+          alignItems: 'center',\n+          justifyContent: 'center',\n+        }}\n+      >\n+        OpenGraph Test Image\n+      </div>\n+    ),\n+    {\n+      ...size,\n+    }\n+  )\n+}"
        },
        {
            "sha": "2669c2486b87e110293716a4bd086ebce910b8e6",
            "filename": "test/development/experimental-https-server/https-server-opengraph-image.test.ts",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server-opengraph-image.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72cc7db1bda874a354cdc07cdd0a8503a0aaec15/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server-opengraph-image.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fexperimental-https-server%2Fhttps-server-opengraph-image.test.ts?ref=72cc7db1bda874a354cdc07cdd0a8503a0aaec15",
            "patch": "@@ -0,0 +1,30 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { shouldRunTurboDevTest } from 'next-test-utils'\n+\n+describe('experimental-https-server OpenGraph image', () => {\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    startCommand: `pnpm next ${\n+      shouldRunTurboDevTest() ? 'dev --turbo' : 'dev'\n+    } --experimental-https`,\n+    skipStart: !process.env.NEXT_TEST_CI,\n+  })\n+  if (skipped) return\n+\n+  if (!process.env.NEXT_TEST_CI) {\n+    console.warn('only runs on CI as it requires administrator privileges')\n+    it('only runs on CI as it requires administrator privileges', () => {})\n+    return\n+  }\n+\n+  it('should generate https:// URLs for OpenGraph images when experimental HTTPS is enabled', async () => {\n+    expect(next.url).toContain('https://')\n+    const browser = await next.browser('/1', {\n+      ignoreHTTPSErrors: true,\n+    })\n+    const html = await browser.eval('document.documentElement.innerHTML')\n+    expect(html).toContain('Hello from App')\n+    expect(html).toMatch(/<meta property=\"og:image\" content=\"https:\\/\\//)\n+    expect(html).toMatch(/<meta name=\"twitter:image\" content=\"https:\\/\\//)\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 97,
        "deletions": 1
    }
}