{
    "author": "kdy1",
    "message": "refactor(turbopack): Remove `PassFactory` (#79555)\n\n### What?\n\nRemove `PassFactory`. Instead, merge it into `AstModifier`.\n\n### Why?\n\n`PassFactory` was a temporary solution required only for step-by-step refactoring. Now the refactoring is done, we don't need it anymore.",
    "sha": "dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29",
    "files": [
        {
            "sha": "f1fe76ce8f7c84d95d001a81ef53be3e6d4f9cea",
            "filename": "turbopack/crates/turbopack-ecmascript/src/code_gen.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 22,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fcode_gen.rs?ref=dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29",
            "patch": "@@ -2,7 +2,7 @@ use anyhow::Result;\n use serde::{Deserialize, Serialize};\n use swc_core::ecma::{\n     ast::{\n-        BlockStmt, CallExpr, Expr, Lit, MemberExpr, ModuleDecl, ModuleItem, Pass, Pat, Prop,\n+        BlockStmt, CallExpr, Expr, Lit, MemberExpr, ModuleDecl, ModuleItem, Pat, Program, Prop,\n         SimpleAssignTarget, Stmt, Str, SwitchCase,\n     },\n     visit::AstParentKind,\n@@ -38,7 +38,6 @@ use crate::references::{\n #[derive(Default)]\n pub struct CodeGeneration {\n     /// ast nodes matching the span will be visitor by the visitor\n-    pub root_visitors: Vec<Box<dyn PassFactory>>,\n     pub visitors: Vec<(Vec<AstParentKind>, Box<dyn AstModifier>)>,\n     pub hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n     pub early_hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n@@ -52,34 +51,18 @@ impl CodeGeneration {\n     }\n \n     pub fn new(\n-        root_visitors: Vec<Box<dyn PassFactory>>,\n         visitors: Vec<(Vec<AstParentKind>, Box<dyn AstModifier>)>,\n         hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n         early_hoisted_stmts: Vec<CodeGenerationHoistedStmt>,\n     ) -> Self {\n         CodeGeneration {\n-            root_visitors,\n             visitors,\n             hoisted_stmts,\n             early_hoisted_stmts,\n         }\n     }\n \n-    pub fn root_visitors(root_visitors: Vec<Box<dyn PassFactory>>) -> Self {\n-        CodeGeneration {\n-            root_visitors,\n-            ..Default::default()\n-        }\n-    }\n-\n     pub fn visitors(visitors: Vec<(Vec<AstParentKind>, Box<dyn AstModifier>)>) -> Self {\n-        #[cfg(debug_assertions)]\n-        for (path, _) in visitors.iter() {\n-            if path.is_empty() {\n-                unreachable!(\"if the path is empty, the visitor should be a root visitor\");\n-            }\n-        }\n-\n         CodeGeneration {\n             visitors,\n             ..Default::default()\n@@ -113,10 +96,6 @@ impl CodeGenerationHoistedStmt {\n     }\n }\n \n-pub trait PassFactory: Send + Sync {\n-    fn create<'a>(&'a self) -> Box<dyn Pass + Send + Sync + 'a>;\n-}\n-\n macro_rules! method {\n     ($name:ident, $T:ty) => {\n         fn $name(&self, _node: &mut $T) {}\n@@ -137,6 +116,7 @@ pub trait AstModifier: Send + Sync {\n     method!(visit_mut_str, Str);\n     method!(visit_mut_block_stmt, BlockStmt);\n     method!(visit_mut_switch_case, SwitchCase);\n+    method!(visit_mut_program, Program);\n }\n \n pub trait ModifiableAst {\n@@ -166,6 +146,7 @@ impl_modify!(visit_mut_lit, Lit);\n impl_modify!(visit_mut_str, Str);\n impl_modify!(visit_mut_block_stmt, BlockStmt);\n impl_modify!(visit_mut_switch_case, SwitchCase);\n+impl_modify!(visit_mut_program, Program);\n \n #[derive(PartialEq, Eq, Serialize, Deserialize, TraceRawVcs, ValueDebugFormat, NonLocalValue)]\n pub enum CodeGen {"
        },
        {
            "sha": "8d7c6af9a63cc08510e516cdcf46760473b461e8",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29",
            "patch": "@@ -94,7 +94,7 @@ pub use turbopack_resolve::ecmascript as resolve;\n use self::chunk::{EcmascriptChunkItemContent, EcmascriptChunkType, EcmascriptExports};\n use crate::{\n     chunk::{EcmascriptChunkPlaceable, placeable::is_marked_as_side_effect_free},\n-    code_gen::CodeGens,\n+    code_gen::{CodeGens, ModifiableAst},\n     parse::generate_js_source_map,\n     references::{\n         analyse_ecmascript_module, async_module::OptionAsyncModule, esm::base::EsmAssetReferences,\n@@ -1172,13 +1172,10 @@ fn process_content_with_code_gens(\n         for CodeGenerationHoistedStmt { key, stmt } in code_gen.early_hoisted_stmts.drain(..) {\n             early_hoisted_stmts.insert(key.clone(), stmt);\n         }\n-        for visitor in &code_gen.root_visitors {\n-            root_visitors.push(visitor.create());\n-        }\n \n         for (path, visitor) in &code_gen.visitors {\n             if path.is_empty() {\n-                unreachable!(\"if the path is empty, the visitor should be a root visitor\");\n+                root_visitors.push(&**visitor);\n             } else {\n                 visitors.push((path, &**visitor));\n             }\n@@ -1193,7 +1190,7 @@ fn process_content_with_code_gens(\n             );\n         }\n         for pass in root_visitors {\n-            program.mutate(pass);\n+            program.modify(pass);\n         }\n         program.visit_mut_with(\n             &mut swc_core::ecma::transforms::base::hygiene::hygiene_with_config("
        },
        {
            "sha": "e4a75fed70b6842119ad22777bbebf44d4ad0fb2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=dcd5ed0ae81cee5f3ea36e9742d30260b35f7f29",
            "patch": "@@ -678,7 +678,6 @@ impl EsmExports {\n         };\n \n         Ok(CodeGeneration::new(\n-            vec![],\n             vec![],\n             [dynamic_stmt\n                 .map(|stmt| CodeGenerationHoistedStmt::new(\"__turbopack_dynamic__\".into(), stmt))]"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 6,
        "deletions": 29
    }
}