{
    "author": "unstubbable",
    "message": "[Cache Components] Avoid cache misses when resuming a cached page (#82578)\n\nWhen a page component (or a parallel route slot) is cached, but other\nparts of the component tree are dynamic, we generate a partially static\nshell at buildtime that's resumed at runtime. During the resume, we need\nto ensure that the cache key is the same as during prerendering. This is\ncurrently not the case because we automatically include the (unused)\n`searchParams` prop in the cache key. Its value is a hanging promise\nduring prerendering, and a resolving promise at runtime, leading to a\ncache miss when looking up the cached page data in the Resume Data Cache\n(RDC). Subsequently, hydration errors might occur when the recomputed\nresult is different than the prerendered result.\n\nSince search params are not allowed to be read in public cache scopes\nanyways, we can pass erroring search params into the cached page,\ninstead of using a hanging promise, and omit them from the generated\ncache key. We already used this technique when `cacheComponents` is not\nenabled.\n\ncloses NAR-87",
    "sha": "2036a5b1bf844a5492e109a841b47317613eface",
    "files": [
        {
            "sha": "f5594832be72b75800320f20f3b8f4ff3f5279c0",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -776,5 +776,6 @@\n   \"775\": \"Node.js instrumentation extensions should not be loaded in the Edge runtime.\",\n   \"776\": \"`unstable_isUnrecognizedActionError` can only be used on the client.\",\n   \"777\": \"Invariant: failed to find source route %s for prerender %s\",\n-  \"778\": \"`prerenderAndAbortInSequentialTasksWithStages` should not be called in edge runtime.\"\n+  \"778\": \"`prerenderAndAbortInSequentialTasksWithStages` should not be called in edge runtime.\",\n+  \"779\": \"Route %s used \\\"searchParams\\\" inside \\\"use cache\\\". Accessing dynamic request data inside a cache scope is not supported. If you need some search params inside a cached function await \\\"searchParams\\\" outside of the cached function and pass only the required search params as arguments to the cached function. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\"\n }"
        },
        {
            "sha": "265471bea79e255cf97c5cf8fc83e58f4af4b683",
            "filename": "packages/next/src/server/request/search-params.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -460,7 +460,7 @@ function makeErroringExoticSearchParams(\n  * error on access, because accessing searchParams inside of `\"use cache\"` is\n  * not allowed.\n  */\n-export function makeErroringExoticSearchParamsForUseCache(\n+export function makeErroringSearchParamsForUseCache(\n   workStore: WorkStore\n ): Promise<SearchParams> {\n   const cachedSearchParams = CachedSearchParamsForUseCache.get(workStore)"
        },
        {
            "sha": "789aa58d1c3a3ecd22e22ef5d7a3cbcebad6889c",
            "filename": "packages/next/src/server/request/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Futils.ts?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -25,7 +25,7 @@ export function throwForSearchParamsAccessInUseCache(\n   constructorOpt: Function\n ): never {\n   const error = new Error(\n-    `Route ${workStore.route} used \"searchParams\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"searchParams\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n+    `Route ${workStore.route} used \"searchParams\" inside \"use cache\". Accessing dynamic request data inside a cache scope is not supported. If you need some search params inside a cached function await \"searchParams\" outside of the cached function and pass only the required search params as arguments to the cached function. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n   )\n \n   Error.captureStackTrace(error, constructorOpt)"
        },
        {
            "sha": "377816db3b3186ee60864786104b257201ca49cc",
            "filename": "packages/next/src/server/use-cache/use-cache-wrapper.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 23,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fuse-cache%2Fuse-cache-wrapper.ts?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -59,7 +59,7 @@ import {\n   throwToInterruptStaticGeneration,\n } from '../app-render/dynamic-rendering'\n import {\n-  makeErroringExoticSearchParamsForUseCache,\n+  makeErroringSearchParamsForUseCache,\n   type SearchParams,\n } from '../request/search-params'\n import type { Params } from '../request/params'\n@@ -91,6 +91,11 @@ type CacheKeyParts =\n   | [buildId: string, id: string, args: unknown[]]\n   | [buildId: string, id: string, args: unknown[], hmrRefreshHash: string]\n \n+interface UseCacheInnerPageComponentProps {\n+  params: Promise<Params>\n+  searchParams?: Promise<SearchParams>\n+}\n+\n export interface UseCachePageComponentProps {\n   params: Promise<Params>\n   searchParams: Promise<SearchParams>\n@@ -981,37 +986,38 @@ export function cache(\n         isPageOrLayout = true\n \n         const [{ params: outerParams, searchParams: outerSearchParams }] = args\n-        const keepSearchParams = workStore.cacheComponentsEnabled || isPrivate\n \n-        args = [\n-          {\n-            params: outerParams,\n-            searchParams: keepSearchParams\n-              ? outerSearchParams\n-              : Promise.resolve({}),\n-            // omit $$isPageComponent.\n-          },\n-        ]\n+        const props: UseCacheInnerPageComponentProps = {\n+          params: outerParams,\n+          // Omit searchParams and $$isPageComponent.\n+        }\n+\n+        if (isPrivate) {\n+          // Private caches allow accessing search params. We need to include\n+          // them in the serialized args and when generating the cache key.\n+          props.searchParams = outerSearchParams\n+        }\n+\n+        args = [props]\n \n         fn = {\n           [name]: async ({\n             params: _innerParams,\n             searchParams: innerSearchParams,\n-          }: Omit<UseCachePageComponentProps, '$$isPageComponent'>) =>\n+          }: UseCacheInnerPageComponentProps) =>\n             originalFn.apply(null, [\n               {\n                 params: outerParams,\n-                searchParams: keepSearchParams\n-                  ? innerSearchParams\n-                  : // When cacheComponents is not enabled, we can not encode\n-                    // searchParams as a hanging promise. To still avoid unused\n-                    // search params from making a page dynamic, we define them\n-                    // as a promise that resolves to an empty object above. And\n-                    // here, we're creating an erroring searchParams prop, when\n-                    // invoking the original function. This ensures that used\n-                    // searchParams inside of cached functions would still yield\n-                    // an error.\n-                    makeErroringExoticSearchParamsForUseCache(workStore),\n+                searchParams:\n+                  innerSearchParams ??\n+                  // For public caches, search params are omitted from the cache\n+                  // key (and the serialized args) to avoid mismatches between\n+                  // prerendering and resuming a cached page that does not\n+                  // access search params. This is also the reason why we're not\n+                  // using a hanging promise for search params. For cached pages\n+                  // that do access them, which is an invalid dynamic usage, we\n+                  // need to ensure that an error is shown.\n+                  makeErroringSearchParamsForUseCache(workStore),\n               },\n             ]),\n         }[name] as (...args: unknown[]) => Promise<unknown>"
        },
        {
            "sha": "8311e9fd27f642cd8b63184ed822c3debbec38b6",
            "filename": "test/cache-components-tests-manifest.json",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fcache-components-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fcache-components-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fcache-components-tests-manifest.json?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -276,7 +276,6 @@\n       \"test/e2e/app-dir/use-cache-metadata-route-handler/**/*\",\n       \"test/e2e/app-dir/use-cache-route-handler-only/**/*\",\n       \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\",\n-      \"test/e2e/app-dir/use-cache-standalone-search-params/use-cache-standalone-search-params.test.ts\",\n       \"test/e2e/app-dir/use-cache-without-experimental-flag/use-cache-without-experimental-flag.test.ts\",\n       \"test/e2e/app-dir/use-params/use-params.test.ts\",\n       \"test/e2e/app-dir/use-selected-layout-segment-s/use-selected-layout-segment-s.test.ts\","
        },
        {
            "sha": "4eac0fe1a4148f938d423935d52ac5b8939e501e",
            "filename": "test/e2e/app-dir/use-cache-hanging-inputs/app/search-params-caught/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 28,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params-caught%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params-caught%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params-caught%2Fpage.tsx?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -1,28 +0,0 @@\n-async function getSearchParam({\n-  searchParams,\n-}: {\n-  searchParams: Promise<{ n: string }>\n-}): Promise<string> {\n-  'use cache'\n-\n-  return (await searchParams).n\n-}\n-\n-export default async function Page({\n-  searchParams,\n-}: {\n-  searchParams: Promise<{ n: string }>\n-}) {\n-  let searchParam: string | undefined\n-\n-  try {\n-    searchParam = await getSearchParam({ searchParams })\n-  } catch {\n-    // Ignore not having access to searchParams. This is still an invalid\n-    // dynamic access though that we need to detect.\n-  }\n-\n-  return (\n-    <p>{searchParam ? `search param: ${searchParam}` : 'no search param'}</p>\n-  )\n-}"
        },
        {
            "sha": "eaed87c4a6bb918c3c00f70ed9c9ae4d409f6111",
            "filename": "test/e2e/app-dir/use-cache-hanging-inputs/app/search-params-unused/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 9,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params-unused%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params-unused%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params-unused%2Fpage.tsx?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -1,9 +0,0 @@\n-'use cache'\n-\n-export default async function Page({\n-  searchParams,\n-}: {\n-  searchParams: Promise<{ n: string }>\n-}) {\n-  return <p>search params not used</p>\n-}"
        },
        {
            "sha": "2e525c33ccabc6a78fb04a0d2c31971d183d0821",
            "filename": "test/e2e/app-dir/use-cache-hanging-inputs/app/search-params/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 11,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fapp%2Fsearch-params%2Fpage.tsx?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -1,11 +0,0 @@\n-'use cache'\n-\n-export default async function Page({\n-  searchParams,\n-}: {\n-  searchParams: Promise<{ n: string }>\n-}) {\n-  const { n } = await searchParams\n-\n-  return <p>search param: {n}</p>\n-}"
        },
        {
            "sha": "dc3ca708784a6d382def08f3a05f565a0f5fb2ec",
            "filename": "test/e2e/app-dir/use-cache-hanging-inputs/use-cache-hanging-inputs.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 127,
            "changes": 128,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fuse-cache-hanging-inputs.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fuse-cache-hanging-inputs.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fuse-cache-hanging-inputs.test.ts?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -7,7 +7,6 @@ import {\n   assertHasRedbox,\n   getRedboxTitle,\n   getRedboxTotalErrorCount,\n-  assertNoRedbox,\n } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n@@ -26,123 +25,6 @@ describe('use-cache-hanging-inputs', () => {\n   }\n \n   if (isNextDev) {\n-    describe('when searchParams are used inside of \"use cache\"', () => {\n-      it('should show an error toast after a timeout', async () => {\n-        const outputIndex = next.cliOutput.length\n-        const browser = await next.browser('/search-params?n=1')\n-\n-        // The request is pending while we stall on the hanging inputs, and\n-        // playwright will wait for the load event before continuing. So we\n-        // don't need to wait for the \"use cache\" timeout of 50 seconds here.\n-\n-        await openRedbox(browser)\n-\n-        const errorCount = await getRedboxTotalErrorCount(browser)\n-        const errorDescription = await getRedboxDescription(browser)\n-        const errorSource = await getRedboxSource(browser)\n-\n-        expect(errorCount).toBe(1)\n-        expect(errorDescription).toBe(expectedTimeoutErrorMessage)\n-\n-        const cliOutput = stripAnsi(next.cliOutput.slice(outputIndex))\n-\n-        if (isTurbopack) {\n-          expect(errorSource).toMatchInlineSnapshot(`\n-           \"app/search-params/page.tsx (3:16) @ {module evaluation}\n-\n-             1 | 'use cache'\n-             2 |\n-           > 3 | export default async function Page({\n-               |                ^\n-             4 |   searchParams,\n-             5 | }: {\n-             6 |   searchParams: Promise<{ n: string }>\"\n-          `)\n-\n-          expect(cliOutput).toContain(`Error: ${expectedTimeoutErrorMessage}\n-    at __TURBOPACK__module__evaluation__`)\n-        } else {\n-          expect(errorSource).toMatchInlineSnapshot(`\n-           \"app/search-params/page.tsx (3:16) @ eval\n-\n-             1 | 'use cache'\n-             2 |\n-           > 3 | export default async function Page({\n-               |                ^\n-             4 |   searchParams,\n-             5 | }: {\n-             6 |   searchParams: Promise<{ n: string }>\"\n-          `)\n-\n-          expect(cliOutput).toContain(`Error: ${expectedTimeoutErrorMessage}\n-    at eval (app/search-params/page.tsx:3:16)`)\n-        }\n-      }, 180_000)\n-    })\n-\n-    describe('when searchParams are used inside of \"use cache\", wrapped in try/catch', () => {\n-      it('should show an error toast after a timeout', async () => {\n-        const outputIndex = next.cliOutput.length\n-        const browser = await next.browser('/search-params-caught?n=1')\n-\n-        // The request is pending while we stall on the hanging inputs, and\n-        // playwright will wait for the load event before continuing. So we\n-        // don't need to wait for the \"use cache\" timeout of 50 seconds here.\n-\n-        await openRedbox(browser)\n-\n-        const errorCount = await getRedboxTotalErrorCount(browser)\n-        const errorDescription = await getRedboxDescription(browser)\n-        const errorSource = await getRedboxSource(browser)\n-\n-        expect(errorCount).toBe(1)\n-        expect(errorDescription).toBe(expectedTimeoutErrorMessage)\n-\n-        const cliOutput = stripAnsi(next.cliOutput.slice(outputIndex))\n-\n-        if (isTurbopack) {\n-          expect(errorSource).toMatchInlineSnapshot(`\n-           \"app/search-params-caught/page.tsx (1:1) @ {module evaluation}\n-\n-           > 1 | async function getSearchParam({\n-               | ^\n-             2 |   searchParams,\n-             3 | }: {\n-             4 |   searchParams: Promise<{ n: string }>\"\n-          `)\n-\n-          expect(cliOutput).toContain(`Error: ${expectedTimeoutErrorMessage}\n-    at __TURBOPACK__module__evaluation__`)\n-        } else {\n-          expect(errorSource).toMatchInlineSnapshot(`\n-           \"app/search-params-caught/page.tsx (1:1) @ eval\n-\n-           > 1 | async function getSearchParam({\n-               | ^\n-             2 |   searchParams,\n-             3 | }: {\n-             4 |   searchParams: Promise<{ n: string }>\"\n-          `)\n-\n-          expect(cliOutput).toContain(`Error: ${expectedTimeoutErrorMessage}\n-    at eval (app/search-params-caught/page.tsx:1:1)`)\n-        }\n-      }, 180_000)\n-    })\n-\n-    describe('when searchParams are unused inside of \"use cache\"', () => {\n-      it('should not show an error', async () => {\n-        const outputIndex = next.cliOutput.length\n-        const browser = await next.browser('/search-params-unused?n=1')\n-\n-        await assertNoRedbox(browser)\n-\n-        const cliOutput = stripAnsi(next.cliOutput.slice(outputIndex))\n-\n-        expect(cliOutput).not.toContain(`Error: ${expectedTimeoutErrorMessage}`)\n-      })\n-    })\n-\n     describe('when an uncached promise is used inside of \"use cache\"', () => {\n       it('should show an error toast after a timeout', async () => {\n         const outputIndex = next.cliOutput.length\n@@ -333,21 +215,13 @@ describe('use-cache-hanging-inputs', () => {\n \n       expect(cliOutput).toIncludeRepeated(\n         escapeStringRegexp(expectedTimeoutErrorMessage),\n-        6\n+        4\n       )\n \n       expect(cliOutput).toInclude(\n         createExpectedBuildErrorMessage('/bound-args')\n       )\n \n-      expect(cliOutput).toInclude(\n-        createExpectedBuildErrorMessage('/search-params')\n-      )\n-\n-      expect(cliOutput).toInclude(\n-        createExpectedBuildErrorMessage('/search-params-caught')\n-      )\n-\n       expect(cliOutput).toInclude(\n         createExpectedBuildErrorMessage('/transformed-params/[slug]')\n       )"
        },
        {
            "sha": "06cc9793f6c124fb98a0e543b86f8e0972d44992",
            "filename": "test/e2e/app-dir/use-cache-search-params/app/layout.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Flayout.tsx?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -0,0 +1,25 @@\n+import { connection } from 'next/server'\n+import { ReactNode, Suspense } from 'react'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <Suspense fallback={<p>Loading...</p>}>\n+          <Dynamic />\n+        </Suspense>\n+        {children}\n+      </body>\n+    </html>\n+  )\n+}\n+\n+async function Dynamic() {\n+  await connection()\n+\n+  return (\n+    <p>\n+      Layout: <span id=\"layout-date\">{new Date().toISOString()}</span>\n+    </p>\n+  )\n+}"
        },
        {
            "sha": "141fe12424875f5c9b4166c9da6e5ac6a23f27b6",
            "filename": "test/e2e/app-dir/use-cache-search-params/app/search-params-caught/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-caught%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-caught%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-caught%2Fpage.tsx?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "previous_filename": "test/e2e/app-dir/use-cache-standalone-search-params/app/search-params-caught/page.tsx"
        },
        {
            "sha": "7185f091db7d19d6156c0d84088e3c03330db01e",
            "filename": "test/e2e/app-dir/use-cache-search-params/app/search-params-unused/page.tsx",
            "status": "renamed",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-unused%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-unused%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-unused%2Fpage.tsx?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -5,5 +5,9 @@ export default async function Page({\n }: {\n   searchParams: Promise<{ [key: string]: string | string[] | undefined }>\n }) {\n-  return <p>hello world</p>\n+  return (\n+    <p>\n+      Page: <span id=\"page-date\">{new Date().toISOString()}</span>\n+    </p>\n+  )\n }",
            "previous_filename": "test/e2e/app-dir/use-cache-standalone-search-params/app/search-params-unused/page.tsx"
        },
        {
            "sha": "295c76e6af79ddbea01db53a4d8f034ee136878c",
            "filename": "test/e2e/app-dir/use-cache-search-params/app/search-params-used/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-used%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-used%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fapp%2Fsearch-params-used%2Fpage.tsx?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "previous_filename": "test/e2e/app-dir/use-cache-standalone-search-params/app/search-params-used/page.tsx"
        },
        {
            "sha": "dd2e95b8393dba556c7d99cbf2ffb53e52cf25d6",
            "filename": "test/e2e/app-dir/use-cache-search-params/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fnext.config.js?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "previous_filename": "test/e2e/app-dir/use-cache-standalone-search-params/next.config.js"
        },
        {
            "sha": "4098462780265a10016b391a2c9375299830612e",
            "filename": "test/e2e/app-dir/use-cache-search-params/use-cache-search-params.test.ts",
            "status": "renamed",
            "additions": 47,
            "deletions": 2,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fuse-cache-search-params.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fuse-cache-search-params.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-search-params%2Fuse-cache-search-params.test.ts?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -1,16 +1,17 @@\n import { nextTestSetup } from 'e2e-utils'\n import {\n   assertHasRedbox,\n+  assertNoConsoleErrors,\n   assertNoRedbox,\n   getRedboxDescription,\n   getRedboxSource,\n } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n const getExpectedErrorMessage = (route: string) =>\n-  `Route ${route} used \"searchParams\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"searchParams\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n+  `Route ${route} used \"searchParams\" inside \"use cache\". Accessing dynamic request data inside a cache scope is not supported. If you need some search params inside a cached function await \"searchParams\" outside of the cached function and pass only the required search params as arguments to the cached function. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n \n-describe('use-cache-standalone-search-params', () => {\n+describe('use-cache-search-params', () => {\n   const { next, isNextDev, skipped } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n@@ -128,6 +129,10 @@ describe('use-cache-standalone-search-params', () => {\n       })\n     })\n   } else {\n+    afterEach(async () => {\n+      await next.stop()\n+    })\n+\n     it('should fail the build with errors', async () => {\n       const { cliOutput } = await next.build()\n \n@@ -147,9 +152,49 @@ describe('use-cache-standalone-search-params', () => {\n         'Error occurred prerendering page \"/search-params-used\"'\n       )\n \n+      expect(cliOutput).toInclude(\n+        'Error occurred prerendering page \"/search-params-caught\"'\n+      )\n+\n       expect(cliOutput).not.toInclude(\n         'Error occurred prerendering page \"/search-params-unused\"'\n       )\n     })\n+\n+    it('should resume a cached page that does not access search params without hydration errors', async () => {\n+      await next.build({\n+        env: {\n+          NEXT_PRIVATE_APP_PATHS: JSON.stringify([\n+            '/search-params-unused/page.tsx',\n+          ]),\n+        },\n+      })\n+\n+      await next.start({ skipBuild: true })\n+\n+      let browser = await next.browser('/search-params-unused', {\n+        disableJavaScript: true,\n+      })\n+\n+      const prerenderedPageDate = await browser.elementById('page-date').text()\n+\n+      await browser.close()\n+\n+      browser = await next.browser('/search-params-unused', {\n+        pushErrorAsConsoleLog: true,\n+      })\n+\n+      // After hydration, the resumed page date should be the prerendered date.\n+      // Note: When cacheComponents is not enabled, the page is not actually\n+      // prerendered, but because the page is cached on the first page load, the\n+      // date should still be the same for the second page load.\n+      expect(await browser.elementById('page-date').text()).toBe(\n+        prerenderedPageDate\n+      )\n+\n+      // There should also be no hydration errors due to a buildtime date being\n+      // replaced by a new runtime date.\n+      await assertNoConsoleErrors(browser)\n+    })\n   }\n })",
            "previous_filename": "test/e2e/app-dir/use-cache-standalone-search-params/use-cache-standalone-search-params.test.ts"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/e2e/app-dir/use-cache-standalone-search-params/app/layout.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3d5e456a928041ca638ebca54ab511a23d70cd75/test%2Fe2e%2Fapp-dir%2Fuse-cache-standalone-search-params%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/3d5e456a928041ca638ebca54ab511a23d70cd75/test%2Fe2e%2Fapp-dir%2Fuse-cache-standalone-search-params%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-standalone-search-params%2Fapp%2Flayout.tsx?ref=3d5e456a928041ca638ebca54ab511a23d70cd75",
            "patch": "@@ -1,8 +0,0 @@\n-import { ReactNode } from 'react'\n-export default function Root({ children }: { children: ReactNode }) {\n-  return (\n-    <html>\n-      <body>{children}</body>\n-    </html>\n-  )\n-}"
        },
        {
            "sha": "b6fe05097c5e7c731f42909080efdaf79f7ace15",
            "filename": "test/rspack-build-tests-manifest.json",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Frspack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Frspack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-build-tests-manifest.json?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -6492,18 +6492,16 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\": {\n-    \"passed\": [\n-      \"use-cache-segment-configs it should error when using segment configs that aren't supported by useCache\"\n-    ],\n+  \"test/e2e/app-dir/use-cache-search-params/use-cache-search-params.test.ts\": {\n+    \"passed\": [\"use-cache-search-params should fail the build with errors\"],\n     \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/app-dir/use-cache-standalone-search-params/use-cache-standalone-search-params.test.ts\": {\n+  \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\": {\n     \"passed\": [\n-      \"use-cache-standalone-search-params should fail the build with errors\"\n+      \"use-cache-segment-configs it should error when using segment configs that aren't supported by useCache\"\n     ],\n     \"failed\": [],\n     \"pending\": [],"
        },
        {
            "sha": "58846ea1884500fb86a5e133dbb930f323843497",
            "filename": "test/rspack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 10,
            "deletions": 10,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Frspack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Frspack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Frspack-dev-tests-manifest.json?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -10298,23 +10298,23 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\": {\n-    \"passed\": [],\n+  \"test/e2e/app-dir/use-cache-search-params/use-cache-search-params.test.ts\": {\n+    \"passed\": [\n+      \"use-cache-search-params when searchParams are caught inside of \\\"use cache\\\" should also show an error after the second reload\",\n+      \"use-cache-search-params when searchParams are caught inside of \\\"use cache\\\" should show an error\",\n+      \"use-cache-search-params when searchParams are unused inside of \\\"use cache\\\" should not show an error\"\n+    ],\n     \"failed\": [\n-      \"use-cache-segment-configs it should error when using segment configs that aren't supported by useCache\"\n+      \"use-cache-search-params when searchParams are used inside of \\\"use cache\\\" should show an error\"\n     ],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/app-dir/use-cache-standalone-search-params/use-cache-standalone-search-params.test.ts\": {\n-    \"passed\": [\n-      \"use-cache-standalone-search-params when searchParams are caught inside of \\\"use cache\\\" should also show an error after the second reload\",\n-      \"use-cache-standalone-search-params when searchParams are caught inside of \\\"use cache\\\" should show an error\",\n-      \"use-cache-standalone-search-params when searchParams are unused inside of \\\"use cache\\\" should not show an error\"\n-    ],\n+  \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\": {\n+    \"passed\": [],\n     \"failed\": [\n-      \"use-cache-standalone-search-params when searchParams are used inside of \\\"use cache\\\" should show an error\"\n+      \"use-cache-segment-configs it should error when using segment configs that aren't supported by useCache\"\n     ],\n     \"pending\": [],\n     \"flakey\": [],"
        },
        {
            "sha": "e0639d4acf759102c782f0b7a34b412730c51135",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -6065,18 +6065,16 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\": {\n-    \"passed\": [\n-      \"use-cache-segment-configs it should error when using segment configs that aren't supported by useCache\"\n-    ],\n+  \"test/e2e/app-dir/use-cache-search-params/use-cache-search-params.test.ts\": {\n+    \"passed\": [\"use-cache-search-params should fail the build with errors\"],\n     \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/app-dir/use-cache-standalone-search-params/use-cache-standalone-search-params.test.ts\": {\n+  \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\": {\n     \"passed\": [\n-      \"use-cache-standalone-search-params should fail the build with errors\"\n+      \"use-cache-segment-configs it should error when using segment configs that aren't supported by useCache\"\n     ],\n     \"failed\": [],\n     \"pending\": [],"
        },
        {
            "sha": "4f13552853684e8effe7dce638cffa7b1ede6712",
            "filename": "test/turbopack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 7,
            "deletions": 7,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/2036a5b1bf844a5492e109a841b47317613eface/test%2Fturbopack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/2036a5b1bf844a5492e109a841b47317613eface/test%2Fturbopack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-dev-tests-manifest.json?ref=2036a5b1bf844a5492e109a841b47317613eface",
            "patch": "@@ -9639,21 +9639,21 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\": {\n+  \"test/e2e/app-dir/use-cache-search-params/use-cache-search-params.test.ts\": {\n     \"passed\": [\n-      \"use-cache-segment-configs it should error when using segment configs that aren't supported by useCache\"\n+      \"use-cache-search-params when searchParams are caught inside of \\\"use cache\\\" should also show an error after the second reload\",\n+      \"use-cache-search-params when searchParams are caught inside of \\\"use cache\\\" should show an error\",\n+      \"use-cache-search-params when searchParams are unused inside of \\\"use cache\\\" should not show an error\",\n+      \"use-cache-search-params when searchParams are used inside of \\\"use cache\\\" should show an error\"\n     ],\n     \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n-  \"test/e2e/app-dir/use-cache-standalone-search-params/use-cache-standalone-search-params.test.ts\": {\n+  \"test/e2e/app-dir/use-cache-segment-configs/use-cache-segment-configs.test.ts\": {\n     \"passed\": [\n-      \"use-cache-standalone-search-params when searchParams are caught inside of \\\"use cache\\\" should also show an error after the second reload\",\n-      \"use-cache-standalone-search-params when searchParams are caught inside of \\\"use cache\\\" should show an error\",\n-      \"use-cache-standalone-search-params when searchParams are unused inside of \\\"use cache\\\" should not show an error\",\n-      \"use-cache-standalone-search-params when searchParams are used inside of \\\"use cache\\\" should show an error\"\n+      \"use-cache-segment-configs it should error when using segment configs that aren't supported by useCache\"\n     ],\n     \"failed\": [],\n     \"pending\": [],"
        }
    ],
    "stats": {
        "total": 378,
        "additions": 136,
        "deletions": 242
    }
}