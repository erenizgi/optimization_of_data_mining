{
    "author": "devjiwonchoi",
    "message": "[release] create empty changeset for next when no changeset found during canary release (#79049)\n\n### Why?\n\nWhen there are no changesets for `next`, the canary release won't be\npublished even if there are new commits. If this is the case, add an\nempty changeset for `next` to let the canary release proceed.\n\nNote that this will result in an empty Changelog and GitHub Release, but\nthis PR does not cover handling that part.\n\n### Testing Plan\n\nSet env `RELEASE_TYPE=canary` and run `ci:version` locally to see the\nresult.\n\n---------\n\nCo-authored-by: JJ Kasper <jj@jjsweb.site>\nCo-authored-by: Sebastian \"Sebbie\" Silbermann <sebastian.silbermann@vercel.com>",
    "sha": "3fc7d1743670c8b191c1b9b75cfe4ff0415c607a",
    "files": [
        {
            "sha": "3016caf650b2c154fd08693f29b3984a5710916e",
            "filename": "scripts/release/version-packages.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 4,
            "changes": 69,
            "blob_url": "https://github.com/vercel/next.js/blob/3fc7d1743670c8b191c1b9b75cfe4ff0415c607a/scripts%2Frelease%2Fversion-packages.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3fc7d1743670c8b191c1b9b75cfe4ff0415c607a/scripts%2Frelease%2Fversion-packages.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Frelease%2Fversion-packages.ts?ref=3fc7d1743670c8b191c1b9b75cfe4ff0415c607a",
            "patch": "@@ -1,6 +1,26 @@\n import execa from 'execa'\n-import { existsSync } from 'node:fs'\n-import { join } from 'node:path'\n+import { existsSync } from 'fs'\n+import { writeFile, readFile, unlink } from 'fs/promises'\n+import { join } from 'path'\n+\n+// NOTE: This type may change over time.\n+type ChangesetStatusJson = {\n+  changesets: {\n+    releases: {\n+      name: string\n+      type: string\n+      summary: string\n+      id: string\n+    }[]\n+  }[]\n+  releases: {\n+    name: string\n+    type: string\n+    oldVersion: string\n+    changesets: string[]\n+    newVersion: string\n+  }[]\n+}\n \n async function versionPackages() {\n   const preConfigPath = join(process.cwd(), '.changeset', 'pre.json')\n@@ -23,13 +43,54 @@ async function versionPackages() {\n     await execa('pnpm', ['changeset', 'pre', 'enter', 'canary'], {\n       stdio: 'inherit',\n     })\n-    // TODO: Create empty changeset for `next` to bump canary version\n-    // even if there is no changeset.\n+\n+    console.log(\n+      '▲   Preparing to bump the canary version, checking if there are any changesets.'\n+    )\n+\n+    // Create an empty changeset for `next` to bump the canary version\n+    // even if there are no changesets for `next`.\n+    await execa('pnpm', [\n+      'changeset',\n+      'status',\n+      '--output',\n+      './changeset-status.json',\n+    ])\n+\n+    let hasNextChangeset = false\n+    if (existsSync('./changeset-status.json')) {\n+      const changesetStatus: ChangesetStatusJson = JSON.parse(\n+        await readFile('./changeset-status.json', 'utf8')\n+      )\n+\n+      console.log('▲   Changeset Status:')\n+      console.log(changesetStatus)\n+\n+      hasNextChangeset =\n+        changesetStatus.releases.find((release) => release.name === 'next') !==\n+        undefined\n+\n+      await unlink('./changeset-status.json')\n+    }\n+\n+    if (!hasNextChangeset) {\n+      console.log(\n+        '▲   No changesets found for `next`, creating an empty changeset.'\n+      )\n+      // TODO: Since this is temporary until we hard-require a changeset, we will\n+      // need to remove this in the future to prevent publishing empty releases.\n+      await writeFile(\n+        join(process.cwd(), '.changeset', `next-canary-${Date.now()}.md`),\n+        `---\\n'next': patch\\n---`\n+      )\n+    }\n   }\n \n   await execa('pnpm', ['changeset', 'version'], {\n     stdio: 'inherit',\n   })\n+  // TODO: Update the pnpm-lock.yaml since the packages' depend on\n+  // each other. Remove this once they use `workspace:` protocol.\n   await execa('pnpm', ['install', '--no-frozen-lockfile'], {\n     stdio: 'inherit',\n   })"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 65,
        "deletions": 4
    }
}