{
    "author": "bgw",
    "message": "Turbopack: chore: Remove mopa dependency in turbo-tasks (2nd attempt) (#85286)\n\nThis is a recreation of my _very first_ Turbopack PR in https://github.com/vercel/turborepo/pull/7206 (reverted in https://github.com/vercel/turborepo/pull/7573)\n\nInstead of using a trait upcast helper method, this uses the recently-stabilized trait upcasting compiler feature.\n\nI used claude to help write this, but cleaned it up by hand.",
    "sha": "94caeadff3f9f2820c9e33e4b03f52ae13d7a925",
    "files": [
        {
            "sha": "525976e64715bad4d41926a223209c099e0b3d31",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=94caeadff3f9f2820c9e33e4b03f52ae13d7a925",
            "patch": "@@ -4105,12 +4105,6 @@ dependencies = [\n  \"swc_ecma_visit\",\n ]\n \n-[[package]]\n-name = \"mopa\"\n-version = \"0.2.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"a785740271256c230f57462d3b83e52f998433a7062fc18f96d5999474a9f915\"\n-\n [[package]]\n name = \"more-asserts\"\n version = \"0.2.2\"\n@@ -9184,7 +9178,6 @@ dependencies = [\n  \"futures\",\n  \"indexmap 2.9.0\",\n  \"inventory\",\n- \"mopa\",\n  \"once_cell\",\n  \"parking_lot\",\n  \"pin-project-lite\","
        },
        {
            "sha": "b17f3eadaa977fef111cd8196a3999149933f5aa",
            "filename": "turbopack/crates/turbo-tasks/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2FCargo.toml?ref=94caeadff3f9f2820c9e33e4b03f52ae13d7a925",
            "patch": "@@ -31,7 +31,6 @@ erased-serde = { workspace = true }\n event-listener = \"5.4.0\"\n futures = { workspace = true }\n indexmap = { workspace = true, features = [\"serde\"] }\n-mopa = \"0.2.0\"\n once_cell = { workspace = true }\n parking_lot = { workspace = true, features = [\"serde\"]}\n pin-project-lite = { workspace = true }"
        },
        {
            "sha": "57235e54467d112054dcd3319636de284249aaf5",
            "filename": "turbopack/crates/turbo-tasks/src/magic_any.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 59,
            "changes": 69,
            "blob_url": "https://github.com/vercel/next.js/blob/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs?ref=94caeadff3f9f2820c9e33e4b03f52ae13d7a925",
            "patch": "@@ -1,92 +1,43 @@\n-use core::fmt;\n-use std::{\n-    any::{Any, TypeId},\n-    fmt::Debug,\n-    hash::Hash,\n-    sync::Arc,\n-};\n+use std::{any::Any, fmt::Debug, hash::Hash};\n \n use serde::{Deserialize, Serialize, de::DeserializeSeed};\n use turbo_dyn_eq_hash::{\n-    DynEq, DynHash, DynPartialEq, impl_eq_for_dyn, impl_hash_for_dyn, impl_partial_eq_for_dyn,\n+    DynEq, DynHash, impl_eq_for_dyn, impl_hash_for_dyn, impl_partial_eq_for_dyn,\n };\n \n-use crate::trace::{TraceRawVcs, TraceRawVcsContext};\n-\n-pub trait MagicAny: mopa::Any + DynPartialEq + DynEq + DynHash + Send + Sync {\n-    fn magic_any_arc(self: Arc<Self>) -> Arc<dyn Any + Sync + Send>;\n-\n-    fn magic_debug(&self, f: &mut fmt::Formatter) -> fmt::Result;\n-\n-    fn magic_trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext);\n+use crate::trace::TraceRawVcs;\n \n+pub trait MagicAny: Debug + DynEq + DynHash + TraceRawVcs + Send + Sync + 'static {\n     #[cfg(debug_assertions)]\n     fn magic_type_name(&self) -> &'static str;\n }\n \n-#[allow(clippy::transmute_ptr_to_ref)] // can't fix as it's in the macro\n-mod clippy {\n-    use mopa::mopafy;\n-\n-    use super::MagicAny;\n-\n-    mopafy!(MagicAny);\n-}\n-\n-impl<T: Debug + Eq + Hash + Send + Sync + TraceRawVcs + 'static> MagicAny for T {\n-    fn magic_any_arc(self: Arc<Self>) -> Arc<dyn Any + Sync + Send> {\n-        self\n-    }\n-\n-    fn magic_debug(&self, f: &mut fmt::Formatter) -> fmt::Result {\n-        let mut d = f.debug_tuple(\"MagicAny\");\n-        d.field(&TypeId::of::<Self>());\n-\n-        #[cfg(debug_assertions)]\n-        d.field(&std::any::type_name::<Self>());\n-\n-        d.field(&(self as &Self));\n-        d.finish()\n-    }\n-\n-    fn magic_trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext) {\n-        self.trace_raw_vcs(trace_context);\n-    }\n-\n+impl<T> MagicAny for T\n+where\n+    T: Debug + Eq + Hash + Send + Sync + TraceRawVcs + 'static,\n+{\n     #[cfg(debug_assertions)]\n     fn magic_type_name(&self) -> &'static str {\n         std::any::type_name::<T>()\n     }\n }\n \n-impl fmt::Debug for dyn MagicAny {\n-    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {\n-        self.magic_debug(f)\n-    }\n-}\n-\n impl_partial_eq_for_dyn!(dyn MagicAny);\n impl_eq_for_dyn!(dyn MagicAny);\n impl_hash_for_dyn!(dyn MagicAny);\n \n-impl TraceRawVcs for dyn MagicAny {\n-    fn trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext) {\n-        self.magic_trace_raw_vcs(trace_context)\n-    }\n-}\n-\n impl dyn MagicAny {\n     pub fn as_serialize<T: Debug + Eq + Hash + Serialize + Send + Sync + TraceRawVcs + 'static>(\n         &self,\n     ) -> &dyn erased_serde::Serialize {\n-        if let Some(r) = self.downcast_ref::<T>() {\n+        if let Some(r) = (self as &dyn Any).downcast_ref::<T>() {\n             r\n         } else {\n             #[cfg(debug_assertions)]\n             panic!(\n                 \"MagicAny::as_serializable broken: got {} but expected {}\",\n                 self.magic_type_name(),\n-                std::any::type_name::<T>()\n+                std::any::type_name::<T>(),\n             );\n             #[cfg(not(debug_assertions))]\n             panic!(\"MagicAny::as_serializable bug\");"
        },
        {
            "sha": "32313df66ee39106ad261b2685ec1acf14f51dbb",
            "filename": "turbopack/crates/turbo-tasks/src/native_function.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 12,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fnative_function.rs?ref=94caeadff3f9f2820c9e33e4b03f52ae13d7a925",
            "patch": "@@ -1,4 +1,4 @@\n-use std::{fmt::Debug, hash::Hash, pin::Pin};\n+use std::{any::Any, fmt::Debug, hash::Hash, pin::Pin};\n \n use anyhow::Result;\n use futures::Future;\n@@ -105,32 +105,36 @@ fn resolve_functor_impl<T: MagicAny + TaskInput>(value: &dyn MagicAny) -> Resolv\n \n #[cfg(debug_assertions)]\n #[inline(never)]\n-pub fn debug_downcast_args_error_msg(expected: &str, actual: &dyn MagicAny) -> String {\n-    format!(\n-        \"Invalid argument type, expected {expected} got {}\",\n-        (*actual).magic_type_name()\n-    )\n+pub fn debug_downcast_args_error_msg(expected: &str, actual: &str) -> String {\n+    format!(\"Invalid argument type, expected {expected} got {actual}\")\n }\n \n pub fn downcast_args_owned<T: MagicAny>(args: Box<dyn MagicAny>) -> Box<T> {\n-    #[allow(unused_variables)]\n-    args.downcast::<T>()\n-        .map_err(|args| {\n+    #[cfg(debug_assertions)]\n+    let args_type_name = args.magic_type_name();\n+\n+    (args as Box<dyn Any>)\n+        .downcast::<T>()\n+        .map_err(|_args| {\n             #[cfg(debug_assertions)]\n-            return debug_downcast_args_error_msg(std::any::type_name::<T>(), &*args);\n+            return anyhow::anyhow!(debug_downcast_args_error_msg(\n+                std::any::type_name::<T>(),\n+                args_type_name,\n+            ));\n             #[cfg(not(debug_assertions))]\n             return anyhow::anyhow!(\"Invalid argument type\");\n         })\n         .unwrap()\n }\n \n pub fn downcast_args_ref<T: MagicAny>(args: &dyn MagicAny) -> &T {\n-    args.downcast_ref::<T>()\n+    (args as &dyn Any)\n+        .downcast_ref::<T>()\n         .ok_or_else(|| {\n             #[cfg(debug_assertions)]\n             return anyhow::anyhow!(debug_downcast_args_error_msg(\n                 std::any::type_name::<T>(),\n-                args\n+                args.magic_type_name(),\n             ));\n             #[cfg(not(debug_assertions))]\n             return anyhow::anyhow!(\"Invalid argument type\");"
        },
        {
            "sha": "9fe47d8741fc6386b4479a4059bb284f1b5634c3",
            "filename": "turbopack/crates/turbo-tasks/src/task/function.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ffunction.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/94caeadff3f9f2820c9e33e4b03f52ae13d7a925/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ffunction.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Ftask%2Ffunction.rs?ref=94caeadff3f9f2820c9e33e4b03f52ae13d7a925",
            "patch": "@@ -172,10 +172,13 @@ macro_rules! task_inputs_impl {\n /// gives the compiler more chances to dedupe monomorphized code across small functions with less\n /// typevars.\n fn get_args<T: MagicAny + Clone>(arg: &dyn MagicAny) -> Result<T> {\n-    let value = arg.downcast_ref::<T>().cloned();\n+    let value = (arg as &dyn std::any::Any).downcast_ref::<T>().cloned();\n     #[cfg(debug_assertions)]\n     return anyhow::Context::with_context(value, || {\n-        crate::native_function::debug_downcast_args_error_msg(std::any::type_name::<T>(), arg)\n+        crate::native_function::debug_downcast_args_error_msg(\n+            std::any::type_name::<T>(),\n+            arg.magic_type_name(),\n+        )\n     });\n     #[cfg(not(debug_assertions))]\n     return anyhow::Context::context(value, \"Invalid argument type\");"
        }
    ],
    "stats": {
        "total": 112,
        "additions": 31,
        "deletions": 81
    }
}