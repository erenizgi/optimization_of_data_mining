{
    "author": "gnoff",
    "message": "[Cache Components] Allow hiding logs after abort (#84579)\n\nWhen Next.js prerenders with Cache Components enabled it will abort\nprerenders before they have completed. It is common for user code to log\nin a catch block and with this new prerendering behavior these logs will\ntrigger frequently for cases where the rejection only happened because\nwe are abandoning the work. This is analagous to treating a fetch\nrejection as an error even when you pass an abortSignal into the fetch\nand then abort it.\n\nCurrently when logs occur after an aborted prerender we dim the log\noutput to signify that the log line is not particuarly important. This\nis useful and for folks who want to see everything output by their\nprogram this is potentially the best behavior. However many log\ncollectors don't support colors and have no way of contextualizing the\ndimmed log which can lead to them appearing to be more significant than\nthey are.\n\nTo combat this we expose a new experimental flag that allows you to\ncompletely disable logs after aborting. This means the log lines you see\nare much higher signal.\n\nThe implementation is somewhat complex because we install the\nenvironment extensions as early as possible before any user code can run\nbut we can't install the hiding behavior until we have a config in\nscope. I've added the hiding installation to next-server and the worker\nexportPages entrypoints. I believe this is sufficient to cover all\ncontexts in which we will prerender.",
    "sha": "bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
    "files": [
        {
            "sha": "2656df4730845c3e806dfd8589ca130a78d17c04",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -871,5 +871,6 @@\n   \"870\": \"refresh can only be called from within a Server Action. See more info here: https://nextjs.org/docs/app/api-reference/functions/refresh\",\n   \"871\": \"Image with src \\\"%s\\\" is using a query string which is not configured in images.localPatterns.\\\\nRead more: https://nextjs.org/docs/messages/next-image-unconfigured-localpatterns\",\n   \"872\": \"updateTag can only be called from within a Server Action. To invalidate cache tags in Route Handlers or other contexts, use revalidateTag instead. See more info here: https://nextjs.org/docs/app/api-reference/functions/updateTag\",\n-  \"873\": \"Invalid profile provided \\\"%s\\\" must be configured under cacheLife in next.config or be \\\"max\\\"\"\n+  \"873\": \"Invalid profile provided \\\"%s\\\" must be configured under cacheLife in next.config or be \\\"max\\\"\",\n+  \"874\": \"Expected not to install Node.js global behaviors in the edge runtime.\"\n }"
        },
        {
            "sha": "7a59874c2fe48b114e1ab7549cdf3d01c5184f1b",
            "filename": "packages/next/src/export/worker.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fexport%2Fworker.ts?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -50,6 +50,7 @@ import type { PagesRenderContext, PagesSharedContext } from '../server/render'\n import type { AppSharedContext } from '../server/app-render/app-render'\n import { MultiFileWriter } from '../lib/multi-file-writer'\n import { createRenderResumeDataCache } from '../server/resume-data-cache/resume-data-cache'\n+import { installGlobalBehaviors } from '../server/node-environment-extensions/global-behaviors'\n ;(globalThis as any).__NEXT_DATA__ = {\n   nextExport: true,\n }\n@@ -336,6 +337,8 @@ export async function exportPages(\n     renderResumeDataCachesByPage = {},\n   } = input\n \n+  installGlobalBehaviors(nextConfig)\n+\n   if (nextConfig.experimental.enablePrerenderSourceMaps) {\n     try {\n       // Same as `next dev`"
        },
        {
            "sha": "712af8e4f4675c261d3c70ceb0956b17b06d663e",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -346,6 +346,7 @@ export const experimentalSchema = {\n     ])\n     .optional(),\n   lockDistDir: z.boolean().optional(),\n+  hideLogsAfterAbort: z.boolean().optional(),\n }\n \n export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>"
        },
        {
            "sha": "1a4a4737e55d9a186455cc9aeb73c5bf18fbc174",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -817,6 +817,14 @@ export interface ExperimentalConfig {\n    * @default true\n    */\n   lockDistDir?: boolean\n+\n+  /**\n+   * Hide logs that occur after a render has already aborted.\n+   * This can help reduce noise in the console when dealing with aborted renders.\n+   *\n+   * @default false\n+   */\n+  hideLogsAfterAbort?: boolean\n }\n \n export type ExportPathMap = {\n@@ -1499,6 +1507,7 @@ export const defaultConfig = Object.freeze({\n     lockDistDir: true,\n     isolatedDevBuild: true,\n     middlewareClientMaxBodySize: 10_485_760, // 10MB\n+    hideLogsAfterAbort: false,\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,"
        },
        {
            "sha": "644d99c87da9a05074f59ee68e43b8415af0e3ee",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -123,6 +123,7 @@ import {\n   RouterServerContextSymbol,\n   routerServerGlobal,\n } from './lib/router-utils/router-server-context'\n+import { installGlobalBehaviors } from './node-environment-extensions/global-behaviors'\n \n export * from './base-server'\n \n@@ -273,6 +274,8 @@ export default class NextNodeServer extends BaseServer<\n     // Initialize super class\n     super(options)\n \n+    installGlobalBehaviors(this.nextConfig)\n+\n     const isDev = options.dev ?? false\n     this.isDev = isDev\n     this.sriEnabled = Boolean(options.conf.experimental?.sri?.algorithm)"
        },
        {
            "sha": "2f83c1e820aea699ca88c508be481db38b0ad874",
            "filename": "packages/next/src/server/node-environment-extensions/console-dim.external.tsx",
            "status": "modified",
            "additions": 89,
            "deletions": 64,
            "changes": 153,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fconsole-dim.external.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -11,6 +11,17 @@ export function registerGetCacheSignal(getSignal: GetCacheSignal): void {\n   cacheSignals.push(getSignal)\n }\n \n+// eslint-disable-next-line @typescript-eslint/no-unused-vars -- we may use later and want parity with the HIDDEN_STYLE value\n+const DIMMED_STYLE = 'dimmed'\n+const HIDDEN_STYLE = 'hidden'\n+\n+type LogStyle = typeof DIMMED_STYLE | typeof HIDDEN_STYLE\n+\n+let currentAbortedLogsStyle: LogStyle = 'dimmed'\n+export function setAbortedLogsStyle(style: LogStyle) {\n+  currentAbortedLogsStyle = style\n+}\n+\n type InterceptableConsoleMethod =\n   | 'error'\n   | 'assert'\n@@ -175,75 +186,89 @@ function patchConsoleMethod(methodName: InterceptableConsoleMethod): void {\n     const wrapperMethod = function (this: typeof console, ...args: any[]) {\n       const consoleStore = consoleAsyncStorage.getStore()\n \n-      if (consoleStore?.dim === true) {\n-        return applyWithDimming.call(\n-          this,\n-          consoleStore,\n-          originalMethod,\n-          methodName,\n-          args\n-        )\n-      } else {\n-        // First we see if there is a cache signal for our current scope. If we're in a client render it'll\n-        // come from the client React cacheSignal implementation. If we are in a server render it'll come from\n-        // the server React cacheSignal implementation. Any particular console call will be in one, the other, or neither\n-        // scope and these signals return null if you are out of scope so this can be called from a single global patch\n-        // and still work properly.\n-        for (let i = 0; i < cacheSignals.length; i++) {\n-          const signal = cacheSignals[i]() // try to get a signal from registered functions\n-          if (signal) {\n-            // We are in a React Server render and can consult the React cache signal to determine if logs\n-            // are now dimmable.\n-            if (signal.aborted) {\n-              return applyWithDimming.call(\n-                this,\n-                consoleStore,\n-                originalMethod,\n-                methodName,\n-                args\n-              )\n-            } else {\n-              return originalMethod.apply(this, args)\n+      // First we see if there is a cache signal for our current scope. If we're in a client render it'll\n+      // come from the client React cacheSignal implementation. If we are in a server render it'll come from\n+      // the server React cacheSignal implementation. Any particular console call will be in one, the other, or neither\n+      // scope and these signals return null if you are out of scope so this can be called from a single global patch\n+      // and still work properly.\n+      for (let i = 0; i < cacheSignals.length; i++) {\n+        const signal = cacheSignals[i]() // try to get a signal from registered functions\n+        if (signal) {\n+          // We are in a React Server render and can consult the React cache signal to determine if logs\n+          // are now dimmable.\n+          if (signal.aborted) {\n+            if (currentAbortedLogsStyle === HIDDEN_STYLE) {\n+              return\n             }\n+            return applyWithDimming.call(\n+              this,\n+              consoleStore,\n+              originalMethod,\n+              methodName,\n+              args\n+            )\n+          } else if (consoleStore?.dim === true) {\n+            return applyWithDimming.call(\n+              this,\n+              consoleStore,\n+              originalMethod,\n+              methodName,\n+              args\n+            )\n+          } else {\n+            return originalMethod.apply(this, args)\n           }\n         }\n-        // We need to fall back to checking the work unit store for two reasons.\n-        // 1. Client React does not yet implement cacheSignal (it always returns null)\n-        // 2. route.ts files aren't rendered with React but do have prerender semantics\n-        // TODO in the future we should be able to remove this once there is a runnable cache\n-        // scope independent of actual React rendering.\n-        const workUnitStore = workUnitAsyncStorage.getStore()\n-        switch (workUnitStore?.type) {\n-          case 'prerender':\n-          case 'prerender-runtime':\n-          // These can be hit in a route handler. In the future we can use potential React.createCache API\n-          // to create a cache scope for arbitrary computation and can move over to cacheSignal exclusively.\n-          // fallthrough\n-          case 'prerender-client':\n-            // This is a react-dom/server render and won't have a cacheSignal until React adds this for the client world.\n-            const renderSignal = workUnitStore.renderSignal\n-            if (renderSignal.aborted) {\n-              return applyWithDimming.call(\n-                this,\n-                consoleStore,\n-                originalMethod,\n-                methodName,\n-                args\n-              )\n-            } else {\n-              return originalMethod.apply(this, args)\n+      }\n+\n+      // We need to fall back to checking the work unit store for two reasons.\n+      // 1. Client React does not yet implement cacheSignal (it always returns null)\n+      // 2. route.ts files aren't rendered with React but do have prerender semantics\n+      // TODO in the future we should be able to remove this once there is a runnable cache\n+      // scope independent of actual React rendering.\n+      const workUnitStore = workUnitAsyncStorage.getStore()\n+      switch (workUnitStore?.type) {\n+        case 'prerender':\n+        case 'prerender-runtime':\n+        // These can be hit in a route handler. In the future we can use potential React.createCache API\n+        // to create a cache scope for arbitrary computation and can move over to cacheSignal exclusively.\n+        // fallthrough\n+        case 'prerender-client':\n+          // This is a react-dom/server render and won't have a cacheSignal until React adds this for the client world.\n+          const renderSignal = workUnitStore.renderSignal\n+          if (renderSignal.aborted) {\n+            if (currentAbortedLogsStyle === HIDDEN_STYLE) {\n+              return\n             }\n-          case 'prerender-legacy':\n-          case 'prerender-ppr':\n-          case 'cache':\n-          case 'unstable-cache':\n-          case 'private-cache':\n-          case 'request':\n-          case undefined:\n+            return applyWithDimming.call(\n+              this,\n+              consoleStore,\n+              originalMethod,\n+              methodName,\n+              args\n+            )\n+          }\n+        // intentional fallthrough\n+        case 'prerender-legacy':\n+        case 'prerender-ppr':\n+        case 'cache':\n+        case 'unstable-cache':\n+        case 'private-cache':\n+        case 'request':\n+        case undefined:\n+          if (consoleStore?.dim === true) {\n+            return applyWithDimming.call(\n+              this,\n+              consoleStore,\n+              originalMethod,\n+              methodName,\n+              args\n+            )\n+          } else {\n             return originalMethod.apply(this, args)\n-          default:\n-            workUnitStore satisfies never\n-        }\n+          }\n+        default:\n+          workUnitStore satisfies never\n       }\n     }\n     if (originalName) {"
        },
        {
            "sha": "4f53c2b4ceb0793cf60c124985196901d999d458",
            "filename": "packages/next/src/server/node-environment-extensions/global-behaviors.tsx",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fglobal-behaviors.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fglobal-behaviors.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnode-environment-extensions%2Fglobal-behaviors.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,23 @@\n+/**\n+ * Unlike most files in the node-environment-extensions folder this one is not\n+ * an extension itself but it exposes a function to install config based global\n+ * behaviors that should be loaded whenever a Node Server or Node Worker are created.\n+ */\n+import type { NextConfigComplete } from '../config-shared'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n+\n+import { setAbortedLogsStyle } from './console-dim.external'\n+\n+export function installGlobalBehaviors(config: NextConfigComplete) {\n+  if (process.env.NEXT_RUNTIME === 'edge') {\n+    throw new InvariantError(\n+      'Expected not to install Node.js global behaviors in the edge runtime.'\n+    )\n+  }\n+\n+  if (config.experimental?.hideLogsAfterAbort === true) {\n+    setAbortedLogsStyle('hidden')\n+  } else {\n+    setAbortedLogsStyle('dimmed')\n+  }\n+}"
        },
        {
            "sha": "4f5029a93f79b92c40a7f5dfce78bc260380a8b1",
            "filename": "test/e2e/app-dir/cache-components-console/cache-components.console.test.ts",
            "status": "added",
            "additions": 799,
            "deletions": 0,
            "changes": 799,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Fcache-components.console.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Fcache-components.console.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Fcache-components.console.test.ts?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,799 @@\n+import { isNextDev, nextTestSetup } from 'e2e-utils'\n+import { retry } from 'next-test-utils'\n+import stripAnsi from 'strip-ansi'\n+\n+describe('cache-components - Console Dimming - Validation', () => {\n+  const { next, skipped, isTurbopack } = nextTestSetup({\n+    env: {\n+      FORCE_COLOR: '1',\n+    },\n+    files: __dirname + '/fixtures/default',\n+    skipDeployment: true,\n+    skipStart: !isNextDev,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('dims console calls during prospective rendering', async () => {\n+    const path: string = '/console'\n+    if (isNextDev) {\n+      const browser = await next.browser(path, {})\n+      await retry(() => {\n+        expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n+      })\n+\n+      // do not strip ANSI codes here since we're explicitly testing coloring.\n+      const cliOutputFromPage = next.cliOutput.match(\n+        new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n+      )[1]\n+\n+      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+      expect(reorderedLines).toMatchInlineSnapshot(`\n+       \":::0:out::: /console: template(one: one, two: two)\n+       :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       :::0:out::: /console: template(one: one, two: two)\n+       :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: template(one: one, two: two)\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: This is a console page. Don't match the codeframe.\n+       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Error: :::0:err::: /console: test\n+           at ConsolePage (app/console/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+       Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: This is an assert message with a template\n+       \u001b[0m\u001b[7m Cache \u001b[0m Assertion failed: :::0:err::: /console: This is an assert message with a template\n+       \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       :::1:out::: /console: template(one: one, two: two)\n+       :::1:out::: /console: This is a console page. Don't match the codeframe.\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mError: :::1:err::: /console: test\n+           at ConsolePage (app/console/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: :::1:err::: /console: This is an assert message with a template\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2mAssertion failed: :::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       :::2:out::: /console: template(one: one, two: two)\n+       :::2:out::: /console: This is a console page. Don't match the codeframe.\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mError: :::2:err::: /console: test\n+           at ConsolePage (app/console/page.tsx:<line>:<col>)\n+       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       :::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+       Assertion failed: :::2:err::: /console: This is an assert message with a template\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2mAssertion failed: \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2mAssertion failed: :::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[22m\n+       \"\n+      `)\n+\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"description\": \":::0:err::: /console: test\",\n+         \"environmentLabel\": \"Prerender\",\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/console/page.tsx (44:17) @ ConsolePage\n+       > 44 |   console.error(new Error(\\`\\${errBadge} /console: test\\`))\n+            |                 ^\",\n+         \"stack\": [\n+           \"ConsolePage app/console/page.tsx (44:17)\",\n+           \"ConsolePage <anonymous>\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      try {\n+        await next.build({\n+          env: {\n+            NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n+          },\n+        })\n+      } catch (err) {\n+        const error = new Error(\n+          'Expected build to complete successfully, but it failed'\n+        )\n+        error.cause = err\n+        throw error\n+      }\n+      // do not strip ANSI codes here since we're explicitly testing coloring.\n+      const cliOutputFromPage = next.cliOutput.match(\n+        /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n+      )[1]\n+\n+      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+      if (isTurbopack) {\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: /console: template(one: one, two: two)\n+         :::0:out::: /console: This is a console page. Don't match the codeframe.\n+         :::0:out::: /console: template(one: one, two: two)\n+         :::0:out::: /console: This is a console page. Don't match the codeframe.\n+         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::0:err::: /console: test\n+             at e (turbopack:///[project]/app/console/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+          \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+          \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+         Assertion failed: :::0:err::: /console: This is an assert message with a template\n+         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::0:err::: /console: This is an assert message with a template\n+         :::1:out::: /console: template(one: one, two: two)\n+         :::1:out::: /console: This is a console page. Don't match the codeframe.\n+         :::1:out::: /console: template(one: one, two: two)\n+         :::1:out::: /console: This is a console page. Don't match the codeframe.\n+         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::1:err::: /console: test\n+             at e (turbopack:///[project]/app/console/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 42 |\u001b[39m   })\n+          \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n+          \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+         Assertion failed: :::1:err::: /console: This is an assert message with a template\n+         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::1:err::: /console: This is an assert message with a template\"\n+        `)\n+      } else {\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: /console: template(one: one, two: two)\n+         :::0:out::: /console: This is a console page. Don't match the codeframe.\n+         :::0:out::: /console: template(one: one, two: two)\n+         :::0:out::: /console: This is a console page. Don't match the codeframe.\n+         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::0:err::: /console: test\n+             at g (.next/server/app/console/page.js:<line>:<col>)\n+         Assertion failed: :::0:err::: /console: This is an assert message with a template\n+         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::0:err::: /console: This is an assert message with a template\n+         :::1:out::: /console: template(one: one, two: two)\n+         :::1:out::: /console: This is a console page. Don't match the codeframe.\n+         :::1:out::: /console: template(one: one, two: two)\n+         :::1:out::: /console: This is a console page. Don't match the codeframe.\n+         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::1:err::: /console: test\n+             at g (.next/server/app/console/page.js:<line>:<col>)\n+         Assertion failed: :::1:err::: /console: This is an assert message with a template\n+         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::1:err::: /console: This is an assert message with a template\"\n+        `)\n+      }\n+    }\n+  })\n+})\n+\n+describe('cache-components - Logging after Abort', () => {\n+  describe('(default) With Dimming - Server', () => {\n+    const { next, skipped, isTurbopack } = nextTestSetup({\n+      env: {\n+        FORCE_COLOR: '1',\n+      },\n+      files: __dirname + '/fixtures/default',\n+      skipDeployment: true,\n+      skipStart: !isNextDev,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    it('dims console calls after a prerender has aborted', async () => {\n+      const path: string = '/console-after-abort/server'\n+\n+      if (isNextDev) {\n+        const browser = await next.browser(path, {})\n+\n+        await retry(() => {\n+          expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n+        })\n+\n+        // do not strip ANSI codes here since we're explicitly testing coloring.\n+        const cliOutputFromPage = next.cliOutput.match(\n+          new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n+        )[1]\n+\n+        const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: /console-after-abort/server: logging before trying await headers()\n+         :::0:out::: /console-after-abort/server: template(one: one, two: two)\n+         :::0:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\n+         :::0:out::: /console-after-abort/server: template(one: one, two: two)\n+         :::0:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\n+         \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console-after-abort/server: template(one: one, two: two)\n+         \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\n+         :::0:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::0:err::: /console-after-abort/server: test\n+             at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 59 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 60 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 61 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/server: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 62 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 63 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 64 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/server: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+         Assertion failed: :::0:err::: /console-after-abort/server: This is an assert message with a template\n+         :::0:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::0:err::: /console-after-abort/server: This is an assert message with a template\n+         \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console-after-abort/server: This is an assert message with a template\n+         \u001b[0m\u001b[7m Cache \u001b[0m Assertion failed: :::0:err::: /console-after-abort/server: This is an assert message with a template\n+         \u001b[2m:::1:out::: /console-after-abort/server: logging before trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console-after-abort/server: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: /console-after-abort/server: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::1:err::: /console-after-abort/server: test\n+             at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 59 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 60 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 61 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/server: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 62 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 63 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 64 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/server: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console-after-abort/server: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/server: logging before trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/server: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:err::: /console-after-abort/server: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::2:err::: /console-after-abort/server: test\n+             at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 59 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 60 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 61 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/server: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 62 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 63 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 64 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/server: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console-after-abort/server: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+         \"\n+        `)\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \":::0:err::: /console-after-abort/server: test\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/console-after-abort/server/page.tsx (61:17) @ ConsolePage\n+         > 61 |   console.error(new Error(\\`\\${errBadge} /console-after-abort/server: test\\`))\n+              |                 ^\",\n+           \"stack\": [\n+             \"ConsolePage app/console-after-abort/server/page.tsx (61:17)\",\n+             \"ConsolePage <anonymous>\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        try {\n+          await next.build({\n+            env: {\n+              NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n+            },\n+          })\n+        } catch (err) {\n+          const error = new Error(\n+            'Expected build to complete successfully, but it failed'\n+          )\n+          error.cause = err\n+          throw error\n+        }\n+\n+        const unorderedLines = next.cliOutput.match(\n+          /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n+        )[1]\n+\n+        const reorderedLines = reorderLinesByBadge(unorderedLines)\n+\n+        if (isTurbopack) {\n+          expect(reorderedLines).toMatchInlineSnapshot(`\n+           \":::0:out::: /console-after-abort/server: logging before trying await headers()\n+           \u001b[2m:::0:out::: /console-after-abort/server: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:err::: /console-after-abort/server: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mError: :::0:err::: /console-after-abort/server: test\n+               at g (turbopack:///[project]/app/console-after-abort/server/page.tsx:<line>:<col>)\n+           \u001b[0m \u001b[90m 59 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+            \u001b[90m 60 |\u001b[39m   })\n+           \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 61 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/server: test\\`\u001b[39m))\n+            \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+            \u001b[90m 62 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+            \u001b[90m 63 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+            \u001b[90m 64 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/server: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console-after-abort/server: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+           :::1:out::: /console-after-abort/server: logging before trying await headers()\n+           \u001b[2m:::1:out::: /console-after-abort/server: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:err::: /console-after-abort/server: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mError: :::1:err::: /console-after-abort/server: test\n+               at g (turbopack:///[project]/app/console-after-abort/server/page.tsx:<line>:<col>)\n+           \u001b[0m \u001b[90m 59 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+            \u001b[90m 60 |\u001b[39m   })\n+           \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 61 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/server: test\\`\u001b[39m))\n+            \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+            \u001b[90m 62 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+            \u001b[90m 63 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+            \u001b[90m 64 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/server: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console-after-abort/server: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n+          `)\n+        } else {\n+          expect(reorderedLines).toMatchInlineSnapshot(`\n+           \":::0:out::: /console-after-abort/server: logging before trying await headers()\n+           \u001b[2m:::0:out::: /console-after-abort/server: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:err::: /console-after-abort/server: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mError: :::0:err::: /console-after-abort/server: test\n+               at i (.next/server/app/console-after-abort/server/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console-after-abort/server: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+           :::1:out::: /console-after-abort/server: logging before trying await headers()\n+           \u001b[2m:::1:out::: /console-after-abort/server: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:err::: /console-after-abort/server: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mError: :::1:err::: /console-after-abort/server: test\n+               at i (.next/server/app/console-after-abort/server/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console-after-abort/server: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n+          `)\n+        }\n+      }\n+    })\n+  })\n+\n+  describe('(default) With Dimming - Client', () => {\n+    const { next, skipped, isTurbopack } = nextTestSetup({\n+      env: {\n+        FORCE_COLOR: '1',\n+      },\n+      files: __dirname + '/fixtures/default',\n+      skipDeployment: true,\n+      skipStart: !isNextDev,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    it('dims console calls after a prerender has aborted', async () => {\n+      const path: string = '/console-after-abort/client'\n+\n+      if (isNextDev) {\n+        const browser = await next.browser(path, {})\n+\n+        await retry(() => {\n+          expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n+        })\n+\n+        // do not strip ANSI codes here since we're explicitly testing coloring.\n+        const cliOutputFromPage = next.cliOutput.match(\n+          new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n+        )[1]\n+\n+        const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: /console-after-abort/client: logging before prerender abort\n+         :::0:out::: /console-after-abort/client: logging before prerender aborts in client component\n+         :::0:out::: /console-after-abort/client: template(one: one, two: two)\n+         :::0:out::: /console-after-abort/client: This is a console page. Don't match the codeframe.\n+         :::0:err::: /console-after-abort/client: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::0:err::: /console-after-abort/client: test\n+             at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 16 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 17 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 18 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/client: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 19 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 20 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 21 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/client: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+         Assertion failed: :::0:err::: /console-after-abort/client: This is an assert message with a template\n+         \u001b[2m:::1:out::: /console-after-abort/client: logging before prerender abort\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console-after-abort/client: logging before prerender aborts in client component\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console-after-abort/client: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console-after-abort/client: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:err::: /console-after-abort/client: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::1:err::: /console-after-abort/client: test\n+             at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 16 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 17 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 18 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/client: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 19 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 20 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 21 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/client: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console-after-abort/client: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/client: logging before prerender abort\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/client: logging before prerender aborts in client component\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/client: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/client: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:err::: /console-after-abort/client: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mError: :::2:err::: /console-after-abort/client: test\n+             at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 16 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 17 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 18 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/client: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 19 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 20 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 21 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/client: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console-after-abort/client: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+         \"\n+        `)\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \":::0:err::: /console-after-abort/client: test\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/console-after-abort/client/client.tsx (18:17) @ log\n+         > 18 |   console.error(new Error(\\`\\${errBadge} /console-after-abort/client: test\\`))\n+              |                 ^\",\n+           \"stack\": [\n+             \"log app/console-after-abort/client/client.tsx (18:17)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        try {\n+          await next.build({\n+            env: {\n+              NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n+            },\n+          })\n+        } catch (err) {\n+          const error = new Error(\n+            'Expected build to complete successfully, but it failed'\n+          )\n+          error.cause = err\n+          throw error\n+        }\n+\n+        const unorderedLines = next.cliOutput.match(\n+          /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n+        )[1]\n+\n+        const reorderedLines = reorderLinesByBadge(unorderedLines)\n+\n+        if (isTurbopack) {\n+          expect(reorderedLines).toMatchInlineSnapshot(`\n+           \":::0:out::: /console-after-abort/client: logging before prerender abort\n+           :::0:out::: /console-after-abort/client: logging before prerender aborts in client component\n+           \u001b[2m:::0:out::: /console-after-abort/client: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:out::: /console-after-abort/client: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:err::: /console-after-abort/client: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mError: :::0:err::: /console-after-abort/client: test\n+               at c (turbopack:///[project]/app/console-after-abort/client/client.tsx:<line>:<col>)\n+           \u001b[0m \u001b[90m 16 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+            \u001b[90m 17 |\u001b[39m   })\n+           \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 18 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/client: test\\`\u001b[39m))\n+            \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+            \u001b[90m 19 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+            \u001b[90m 20 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+            \u001b[90m 21 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/client: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console-after-abort/client: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+           :::1:out::: /console-after-abort/client: logging before prerender abort\n+           :::1:out::: /console-after-abort/client: logging before prerender aborts in client component\n+           \u001b[2m:::1:out::: /console-after-abort/client: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:out::: /console-after-abort/client: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:err::: /console-after-abort/client: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mError: :::1:err::: /console-after-abort/client: test\n+               at c (turbopack:///[project]/app/console-after-abort/client/client.tsx:<line>:<col>)\n+           \u001b[0m \u001b[90m 16 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+            \u001b[90m 17 |\u001b[39m   })\n+           \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 18 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/client: test\\`\u001b[39m))\n+            \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+            \u001b[90m 19 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+            \u001b[90m 20 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+            \u001b[90m 21 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/client: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console-after-abort/client: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n+          `)\n+        } else {\n+          expect(reorderedLines).toMatchInlineSnapshot(`\n+           \":::0:out::: /console-after-abort/client: logging before prerender abort\n+           :::0:out::: /console-after-abort/client: logging before prerender aborts in client component\n+           \u001b[2m:::0:out::: /console-after-abort/client: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:out::: /console-after-abort/client: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::0:err::: /console-after-abort/client: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mError: :::0:err::: /console-after-abort/client: test\n+               at e (.next/server/app/console-after-abort/client/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console-after-abort/client: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n+           :::1:out::: /console-after-abort/client: logging before prerender abort\n+           :::1:out::: /console-after-abort/client: logging before prerender aborts in client component\n+           \u001b[2m:::1:out::: /console-after-abort/client: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:out::: /console-after-abort/client: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2m:::1:err::: /console-after-abort/client: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mError: :::1:err::: /console-after-abort/client: test\n+               at e (.next/server/app/console-after-abort/client/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n+           \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console-after-abort/client: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n+          `)\n+        }\n+      }\n+    })\n+  })\n+\n+  describe('With Hiding - Server', () => {\n+    const { next, skipped } = nextTestSetup({\n+      env: {\n+        FORCE_COLOR: '1',\n+      },\n+      files: __dirname + '/fixtures/hide-logs-after-abort',\n+      skipDeployment: true,\n+      skipStart: !isNextDev,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    it('hides console calls after a prerender has aborted', async () => {\n+      const path: string = '/console-after-abort/server'\n+\n+      if (isNextDev) {\n+        const browser = await next.browser(path, {})\n+\n+        await retry(() => {\n+          expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n+        })\n+\n+        // do not strip ANSI codes here since we're explicitly testing coloring.\n+        const cliOutputFromPage = next.cliOutput.match(\n+          new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n+        )[1]\n+\n+        const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: /console-after-abort/server: logging before trying await headers()\n+         :::0:out::: /console-after-abort/server: template(one: one, two: two)\n+         :::0:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\n+         :::0:out::: /console-after-abort/server: template(one: one, two: two)\n+         :::0:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\n+         \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console-after-abort/server: template(one: one, two: two)\n+         \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console-after-abort/server: This is a console page. Don't match the codeframe.\n+         :::0:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::0:err::: /console-after-abort/server: test\n+             at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 59 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 60 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 61 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/server: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 62 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 63 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 64 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/server: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+         Assertion failed: :::0:err::: /console-after-abort/server: This is an assert message with a template\n+         :::0:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: :::0:err::: /console-after-abort/server: This is an assert message with a template\n+         \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console-after-abort/server: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Assertion failed: \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console-after-abort/server: This is an assert message with a template\n+         \u001b[0m\u001b[7m Cache \u001b[0m Assertion failed: :::0:err::: /console-after-abort/server: This is an assert message with a template\n+         \u001b[2m:::1:out::: /console-after-abort/server: logging before trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/server: logging before trying await headers()\u001b[22m\u001b[2m\u001b[22m\n+         \"\n+        `)\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \":::0:err::: /console-after-abort/server: test\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/console-after-abort/server/page.tsx (61:17) @ ConsolePage\n+         > 61 |   console.error(new Error(\\`\\${errBadge} /console-after-abort/server: test\\`))\n+              |                 ^\",\n+           \"stack\": [\n+             \"ConsolePage app/console-after-abort/server/page.tsx (61:17)\",\n+             \"ConsolePage <anonymous>\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        try {\n+          await next.build({\n+            env: {\n+              NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n+            },\n+          })\n+        } catch (err) {\n+          const error = new Error(\n+            'Expected build to complete successfully, but it failed'\n+          )\n+          error.cause = err\n+          throw error\n+        }\n+\n+        const unorderedLines = next.cliOutput.match(\n+          /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n+        )[1]\n+\n+        const reorderedLines = reorderLinesByBadge(unorderedLines)\n+\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+           \":::0:out::: /console-after-abort/server: logging before trying await headers()\n+           :::1:out::: /console-after-abort/server: logging before trying await headers()\"\n+          `)\n+      }\n+    })\n+  })\n+\n+  describe('With Hiding - Client', () => {\n+    const { next, skipped } = nextTestSetup({\n+      env: {\n+        FORCE_COLOR: '1',\n+      },\n+      files: __dirname + '/fixtures/hide-logs-after-abort',\n+      skipDeployment: true,\n+      skipStart: !isNextDev,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    it('hides console calls after a prerender has aborted', async () => {\n+      const path: string = '/console-after-abort/client'\n+\n+      if (isNextDev) {\n+        const browser = await next.browser(path, {})\n+\n+        await retry(() => {\n+          expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n+        })\n+\n+        // do not strip ANSI codes here since we're explicitly testing coloring.\n+        const cliOutputFromPage = next.cliOutput.match(\n+          new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n+        )[1]\n+\n+        const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n+\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+         \":::0:out::: /console-after-abort/client: logging before prerender abort\n+         :::0:out::: /console-after-abort/client: logging before prerender aborts in client component\n+         :::0:out::: /console-after-abort/client: template(one: one, two: two)\n+         :::0:out::: /console-after-abort/client: This is a console page. Don't match the codeframe.\n+         :::0:err::: /console-after-abort/client: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n+         Error: :::0:err::: /console-after-abort/client: test\n+             at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n+         \u001b[0m \u001b[90m 16 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 17 |\u001b[39m   })\n+         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 18 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console-after-abort/client: test\\`\u001b[39m))\n+          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n+          \u001b[90m 19 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n+          \u001b[90m 20 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n+          \u001b[90m 21 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console-after-abort/client: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n+         Assertion failed: :::0:err::: /console-after-abort/client: This is an assert message with a template\n+         \u001b[2m:::1:out::: /console-after-abort/client: logging before prerender abort\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::1:out::: /console-after-abort/client: logging before prerender aborts in client component\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/client: logging before prerender abort\u001b[22m\u001b[2m\u001b[22m\n+         \u001b[2m:::2:out::: /console-after-abort/client: logging before prerender aborts in client component\u001b[22m\u001b[2m\u001b[22m\n+         \"\n+        `)\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \":::0:err::: /console-after-abort/client: test\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/console-after-abort/client/client.tsx (18:17) @ log\n+         > 18 |   console.error(new Error(\\`\\${errBadge} /console-after-abort/client: test\\`))\n+              |                 ^\",\n+           \"stack\": [\n+             \"log app/console-after-abort/client/client.tsx (18:17)\",\n+           ],\n+         }\n+        `)\n+      } else {\n+        try {\n+          await next.build({\n+            env: {\n+              NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n+            },\n+          })\n+        } catch (err) {\n+          const error = new Error(\n+            'Expected build to complete successfully, but it failed'\n+          )\n+          error.cause = err\n+          throw error\n+        }\n+\n+        const unorderedLines = next.cliOutput.match(\n+          /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n+        )[1]\n+\n+        const reorderedLines = reorderLinesByBadge(unorderedLines)\n+\n+        expect(reorderedLines).toMatchInlineSnapshot(`\n+           \":::0:out::: /console-after-abort/client: logging before prerender abort\n+           :::0:out::: /console-after-abort/client: logging before prerender aborts in client component\n+           :::1:out::: /console-after-abort/client: logging before prerender abort\n+           :::1:out::: /console-after-abort/client: logging before prerender aborts in client component\"\n+          `)\n+      }\n+    })\n+  })\n+})\n+\n+type RenderGroups = Map<string | null, StreamGroups>\n+type StreamGroups = Map<string | null, Lines>\n+type Lines = Array<string>\n+\n+function reorderLinesByBadge(selectedOutput: string) {\n+  const unorderedLines = selectedOutput\n+    .split('\\n')\n+    .filter(\n+      (l) => !(l.includes('Generating static pages') || l.includes(' GET '))\n+    )\n+    .map((l) => l.replace(/( at .*):\\d+:\\d+/, '$1:<line>:<col>'))\n+\n+  let currentLines: Lines = []\n+  const renderGroups: RenderGroups = new Map([\n+    [null, new Map([[null, currentLines]]) satisfies StreamGroups],\n+  ])\n+\n+  for (let line of unorderedLines) {\n+    let match = line.match(/:::([^: \\n]+):([^: \\n]+):::/)\n+    if (match) {\n+      const [_, render, stream] = match\n+      const streamGroups = renderGroups.get(render)\n+      if (!streamGroups) {\n+        currentLines = []\n+        renderGroups.set(render, new Map([[stream, currentLines]]))\n+      } else {\n+        currentLines = streamGroups.get(stream)\n+        if (!currentLines) {\n+          streamGroups.set(stream, (currentLines = []))\n+        }\n+      }\n+    }\n+    currentLines.push(line)\n+  }\n+\n+  const orderedRenders = Array.from(renderGroups.values())\n+  const orderedStreams = orderedRenders.map((s) =>\n+    Array.from(s.values()).flat()\n+  )\n+\n+  return orderedStreams.flat().join('\\n')\n+}"
        },
        {
            "sha": "1f9f175e09a2bbc8bbc73163ef1f78b3c189a970",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/default/app/console-after-abort/client/client.tsx",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,47 @@\n+'use client'\n+\n+import { use } from 'react'\n+\n+function log(outBadge: string, errBadge: string) {\n+  console.info(\n+    `${outBadge} /console-after-abort/client: template(one: %s, two: %s)`,\n+    'one',\n+    'two'\n+  )\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console-after-abort/client: This is a console page. Don't match the codeframe.`\n+  )\n+  console.warn(`${errBadge} /console-after-abort/client: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  console.error(new Error(`${errBadge} /console-after-abort/client: test`))\n+  console.assert(\n+    false,\n+    `${errBadge} /console-after-abort/client: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console-after-abort/client: This is an assert message without a template`\n+  )\n+}\n+\n+export default function ClientConsolePage({\n+  data,\n+  outBadge,\n+  errBadge,\n+}: {\n+  data: Promise<any>\n+  outBadge: string\n+  errBadge: string\n+}) {\n+  console.log(\n+    `${outBadge} /console-after-abort/client: logging before prerender aborts in client component`\n+  )\n+  setTimeout(log.bind(null, outBadge, errBadge), 1)\n+\n+  use(data)\n+\n+  return null\n+}"
        },
        {
            "sha": "19bacfc16ddc06d3948b27c3ab0522c2daa38f61",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/default/app/console-after-abort/client/page.tsx",
            "status": "renamed",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -9,7 +9,9 @@ export default async function ConsolePage() {\n \n   const outBadge = `:::${i}:out:::`\n   const errBadge = `:::${i++}:err:::`\n-  console.log(`${outBadge} logging before prerender abort`)\n+  console.log(\n+    `${outBadge} /console-after-abort/client: logging before prerender abort`\n+  )\n \n   return (\n     <ClientConsolePage data={data} outBadge={outBadge} errBadge={errBadge} />",
            "previous_filename": "test/e2e/app-dir/cache-components/app/console-after-abort/client/page.tsx"
        },
        {
            "sha": "63a9604cde7b44730f733b76146de2406d0ee6c6",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/default/app/console-after-abort/layout.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Flayout.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "previous_filename": "test/e2e/app-dir/cache-components/app/console-after-abort/layout.tsx"
        },
        {
            "sha": "f1d0963f076936cab8d2a3ab7920813088130c52",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/default/app/console-after-abort/server/page.tsx",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,75 @@\n+import { headers } from 'next/headers'\n+\n+async function cachedConsoleCalls(outBadge: string, errBadge: string) {\n+  'use cache'\n+  console.info(\n+    `${outBadge} /console-after-abort/server: template(one: %s, two: %s)`,\n+    'one',\n+    'two'\n+  )\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console-after-abort/server: This is a console page` +\n+      \". Don't match the codeframe.\"\n+  )\n+  console.warn(`${errBadge} /console-after-abort/server: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  // TODO(veil): Assert on inspected errors once we sourcemap errors replayed from Cache environment.\n+  // console.error(new Error('/console-after-abort/server: test'))\n+  console.assert(\n+    false,\n+    `${errBadge} /console-after-abort/server: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console-after-abort/server: This is an assert message without a template`\n+  )\n+}\n+\n+let i = 0\n+export default async function ConsolePage() {\n+  const outBadge = `:::${i}:out:::`\n+  const errBadge = `:::${i++}:err:::`\n+\n+  console.log(\n+    `${outBadge} /console-after-abort/server: logging before trying await headers()`\n+  )\n+  try {\n+    await headers()\n+  } catch (error) {\n+    console.error(\n+      `${errBadge} /console-after-abort/server: caught error trying await headers()`\n+    )\n+  }\n+  // We add some delay because in tests this sometimes runs after the second render pass\n+  // has already started and that can lead to out-of-order console logs.\n+  console.info(\n+    `${outBadge} /console-after-abort/server: template(one: %s, two: %s)`,\n+    'one',\n+    'two'\n+  )\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console-after-abort/server: This is a console page` +\n+      \". Don't match the codeframe.\"\n+  )\n+  console.warn(`${errBadge} /console-after-abort/server: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  console.error(new Error(`${errBadge} /console-after-abort/server: test`))\n+  console.assert(\n+    false,\n+    `${errBadge} /console-after-abort/server: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console-after-abort/server: This is an assert message without a template`\n+  )\n+\n+  await cachedConsoleCalls(outBadge, errBadge)\n+\n+  return null\n+}"
        },
        {
            "sha": "5c0c587fb55ac95d854a941c4ec92b7a923b99bf",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/default/app/console/page.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Fconsole%2Fpage.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "previous_filename": "test/e2e/app-dir/cache-components/app/console/page.tsx"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/default/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fapp%2Flayout.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "30a826fdacc568ffb8cd6641fe15330a3c9d618d",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/default/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fdefault%2Fnext.config.js?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    cacheComponents: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "1f9f175e09a2bbc8bbc73163ef1f78b3c189a970",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/hide-logs-after-abort/app/console-after-abort/client/client.tsx",
            "status": "added",
            "additions": 47,
            "deletions": 0,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,47 @@\n+'use client'\n+\n+import { use } from 'react'\n+\n+function log(outBadge: string, errBadge: string) {\n+  console.info(\n+    `${outBadge} /console-after-abort/client: template(one: %s, two: %s)`,\n+    'one',\n+    'two'\n+  )\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console-after-abort/client: This is a console page. Don't match the codeframe.`\n+  )\n+  console.warn(`${errBadge} /console-after-abort/client: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  console.error(new Error(`${errBadge} /console-after-abort/client: test`))\n+  console.assert(\n+    false,\n+    `${errBadge} /console-after-abort/client: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console-after-abort/client: This is an assert message without a template`\n+  )\n+}\n+\n+export default function ClientConsolePage({\n+  data,\n+  outBadge,\n+  errBadge,\n+}: {\n+  data: Promise<any>\n+  outBadge: string\n+  errBadge: string\n+}) {\n+  console.log(\n+    `${outBadge} /console-after-abort/client: logging before prerender aborts in client component`\n+  )\n+  setTimeout(log.bind(null, outBadge, errBadge), 1)\n+\n+  use(data)\n+\n+  return null\n+}"
        },
        {
            "sha": "19bacfc16ddc06d3948b27c3ab0522c2daa38f61",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/hide-logs-after-abort/app/console-after-abort/client/page.tsx",
            "status": "added",
            "additions": 19,
            "deletions": 0,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fclient%2Fpage.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,19 @@\n+import { headers } from 'next/headers'\n+\n+import ClientConsolePage from './client'\n+\n+let i = 0\n+\n+export default async function ConsolePage() {\n+  const data = headers().then(() => null)\n+\n+  const outBadge = `:::${i}:out:::`\n+  const errBadge = `:::${i++}:err:::`\n+  console.log(\n+    `${outBadge} /console-after-abort/client: logging before prerender abort`\n+  )\n+\n+  return (\n+    <ClientConsolePage data={data} outBadge={outBadge} errBadge={errBadge} />\n+  )\n+}"
        },
        {
            "sha": "63a9604cde7b44730f733b76146de2406d0ee6c6",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/hide-logs-after-abort/app/console-after-abort/layout.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Flayout.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,5 @@\n+import { Suspense } from 'react'\n+\n+export default async function layout({ children }) {\n+  return <Suspense>{children}</Suspense>\n+}"
        },
        {
            "sha": "f1d0963f076936cab8d2a3ab7920813088130c52",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/hide-logs-after-abort/app/console-after-abort/server/page.tsx",
            "status": "added",
            "additions": 75,
            "deletions": 0,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole-after-abort%2Fserver%2Fpage.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,75 @@\n+import { headers } from 'next/headers'\n+\n+async function cachedConsoleCalls(outBadge: string, errBadge: string) {\n+  'use cache'\n+  console.info(\n+    `${outBadge} /console-after-abort/server: template(one: %s, two: %s)`,\n+    'one',\n+    'two'\n+  )\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console-after-abort/server: This is a console page` +\n+      \". Don't match the codeframe.\"\n+  )\n+  console.warn(`${errBadge} /console-after-abort/server: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  // TODO(veil): Assert on inspected errors once we sourcemap errors replayed from Cache environment.\n+  // console.error(new Error('/console-after-abort/server: test'))\n+  console.assert(\n+    false,\n+    `${errBadge} /console-after-abort/server: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console-after-abort/server: This is an assert message without a template`\n+  )\n+}\n+\n+let i = 0\n+export default async function ConsolePage() {\n+  const outBadge = `:::${i}:out:::`\n+  const errBadge = `:::${i++}:err:::`\n+\n+  console.log(\n+    `${outBadge} /console-after-abort/server: logging before trying await headers()`\n+  )\n+  try {\n+    await headers()\n+  } catch (error) {\n+    console.error(\n+      `${errBadge} /console-after-abort/server: caught error trying await headers()`\n+    )\n+  }\n+  // We add some delay because in tests this sometimes runs after the second render pass\n+  // has already started and that can lead to out-of-order console logs.\n+  console.info(\n+    `${outBadge} /console-after-abort/server: template(one: %s, two: %s)`,\n+    'one',\n+    'two'\n+  )\n+  console.log(\n+    // eslint-disable-next-line no-useless-concat\n+    `${outBadge} /console-after-abort/server: This is a console page` +\n+      \". Don't match the codeframe.\"\n+  )\n+  console.warn(`${errBadge} /console-after-abort/server: not a template`, {\n+    foo: 'just-some-object',\n+  })\n+  console.error(new Error(`${errBadge} /console-after-abort/server: test`))\n+  console.assert(\n+    false,\n+    `${errBadge} /console-after-abort/server: This is an assert message with a %s`,\n+    'template'\n+  )\n+  console.assert(\n+    true,\n+    `${errBadge} /console-after-abort/server: This is an assert message without a template`\n+  )\n+\n+  await cachedConsoleCalls(outBadge, errBadge)\n+\n+  return null\n+}"
        },
        {
            "sha": "5c0c587fb55ac95d854a941c4ec92b7a923b99bf",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/hide-logs-after-abort/app/console/page.tsx",
            "status": "renamed",
            "additions": 8,
            "deletions": 11,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Fconsole%2Fpage.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -1,16 +1,17 @@\n-import { headers } from 'next/headers'\n-\n async function cachedConsoleCalls(outBadge: string, errBadge: string) {\n   'use cache'\n   console.info(`${outBadge} /console: template(one: %s, two: %s)`, 'one', 'two')\n+  await 1\n   console.log(\n     // eslint-disable-next-line no-useless-concat\n     `${outBadge} /console: This is a console page` +\n       \". Don't match the codeframe.\"\n   )\n+  await 1\n   console.warn(`${errBadge} /console: not a template`, {\n     foo: 'just-some-object',\n   })\n+  await 1\n   // TODO(veil): Assert on inspected errors once we sourcemap errors replayed from Cache environment.\n   // console.error(new Error('/console: test'))\n   console.assert(\n@@ -28,25 +29,20 @@ let i = 0\n export default async function ConsolePage() {\n   const outBadge = `:::${i}:out:::`\n   const errBadge = `:::${i++}:err:::`\n-\n-  console.log(`${outBadge} logging before trying await headers()`)\n-  try {\n-    await headers()\n-  } catch (error) {\n-    console.error(`${errBadge} caught error trying await headers()`)\n-  }\n-  // We add some delay because in tests this sometimes runs after the second render pass\n-  // has already started and that can lead to out-of-order console logs.\n   console.info(`${outBadge} /console: template(one: %s, two: %s)`, 'one', 'two')\n+  await 1\n   console.log(\n     // eslint-disable-next-line no-useless-concat\n     `${outBadge} /console: This is a console page` +\n       \". Don't match the codeframe.\"\n   )\n+  await 1\n   console.warn(`${errBadge} /console: not a template`, {\n     foo: 'just-some-object',\n   })\n+  await 1\n   console.error(new Error(`${errBadge} /console: test`))\n+  await 1\n   console.assert(\n     false,\n     `${errBadge} /console: This is an assert message with a %s`,\n@@ -57,6 +53,7 @@ export default async function ConsolePage() {\n     `${errBadge} /console: This is an assert message without a template`\n   )\n \n+  await 1\n   await cachedConsoleCalls(outBadge, errBadge)\n \n   return null",
            "previous_filename": "test/e2e/app-dir/cache-components/app/console-after-abort/server/page.tsx"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/hide-logs-after-abort/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fapp%2Flayout.tsx?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "a7f689191ecc20c488b6b8b1a9efc348fee6cf16",
            "filename": "test/e2e/app-dir/cache-components-console/fixtures/hide-logs-after-abort/next.config.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-console%2Ffixtures%2Fhide-logs-after-abort%2Fnext.config.js?ref=bc51d9bb6a6cbcb50a302e4dcc1c8f653bcc86b4",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    cacheComponents: true,\n+    hideLogsAfterAbort: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "b57864dbb530ddeb22423e6f2cb21eda76f7e198",
            "filename": "test/e2e/app-dir/cache-components/app/console-after-abort/client/client.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 41,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/a89f854f3eb13814930943e53f4afbd721fd3fac/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/a89f854f3eb13814930943e53f4afbd721fd3fac/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fapp%2Fconsole-after-abort%2Fclient%2Fclient.tsx?ref=a89f854f3eb13814930943e53f4afbd721fd3fac",
            "patch": "@@ -1,41 +0,0 @@\n-'use client'\n-\n-import { use } from 'react'\n-\n-function log(outBadge: string, errBadge: string) {\n-  console.info(`${outBadge} /console: template(one: %s, two: %s)`, 'one', 'two')\n-  console.log(\n-    // eslint-disable-next-line no-useless-concat\n-    `${outBadge} /console: This is a console page. Don't match the codeframe.`\n-  )\n-  console.warn(`${errBadge} /console: not a template`, {\n-    foo: 'just-some-object',\n-  })\n-  console.error(new Error(`${errBadge} /console: test`))\n-  console.assert(\n-    false,\n-    `${errBadge} /console: This is an assert message with a %s`,\n-    'template'\n-  )\n-  console.assert(\n-    true,\n-    `${errBadge} /console: This is an assert message without a template`\n-  )\n-}\n-\n-export default function ClientConsolePage({\n-  data,\n-  outBadge,\n-  errBadge,\n-}: {\n-  data: Promise<any>\n-  outBadge: string\n-  errBadge: string\n-}) {\n-  console.log(`${outBadge} logging before prerender aborts in client component`)\n-  setTimeout(log.bind(null, outBadge, errBadge), 1)\n-\n-  use(data)\n-\n-  return null\n-}"
        },
        {
            "sha": "e4b440c156a87d5717f4f62da484cb2c7a5e99d2",
            "filename": "test/e2e/app-dir/cache-components/cache-components.console.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 596,
            "changes": 596,
            "blob_url": "https://github.com/vercel/next.js/blob/a89f854f3eb13814930943e53f4afbd721fd3fac/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fcache-components.console.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a89f854f3eb13814930943e53f4afbd721fd3fac/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fcache-components.console.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components%2Fcache-components.console.test.ts?ref=a89f854f3eb13814930943e53f4afbd721fd3fac",
            "patch": "@@ -1,596 +0,0 @@\n-import { isNextDev, nextTestSetup } from 'e2e-utils'\n-import { retry } from 'next-test-utils'\n-import stripAnsi from 'strip-ansi'\n-\n-describe('cache-components - Console Dimming - Validation', () => {\n-  const { next, skipped, isTurbopack } = nextTestSetup({\n-    env: {\n-      FORCE_COLOR: '1',\n-    },\n-    files: __dirname,\n-    skipDeployment: true,\n-    skipStart: !isNextDev,\n-  })\n-\n-  if (skipped) {\n-    return\n-  }\n-\n-  it('dims console calls during prospective rendering', async () => {\n-    const path: string = '/console'\n-    if (isNextDev) {\n-      const browser = await next.browser(path, {})\n-      await retry(() => {\n-        expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n-      })\n-\n-      // do not strip ANSI codes here since we're explicitly testing coloring.\n-      const cliOutputFromPage = next.cliOutput.match(\n-        new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n-      )[1]\n-\n-      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n-\n-      expect(reorderedLines).toMatchInlineSnapshot(`\n-       \":::0:out::: /console: template(one: one, two: two)\n-       :::0:out::: /console: This is a console page. Don't match the codeframe.\n-       :::0:out::: /console: template(one: one, two: two)\n-       :::0:out::: /console: This is a console page. Don't match the codeframe.\n-       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: template(one: one, two: two)\n-       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: This is a console page. Don't match the codeframe.\n-       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Error: :::0:err::: /console: test\n-           at ConsolePage (app/console/page.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n-        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n-       Assertion failed: :::0:err::: /console: This is an assert message with a template\n-       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Assertion failed: :::0:err::: /console: This is an assert message with a template\n-       \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Assertion failed: \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: This is an assert message with a template\n-       \u001b[0m\u001b[7m Cache \u001b[0m Assertion failed: :::0:err::: /console: This is an assert message with a template\n-       \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       :::1:out::: /console: template(one: one, two: two)\n-       :::1:out::: /console: This is a console page. Don't match the codeframe.\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mError: :::1:err::: /console: test\n-           at ConsolePage (app/console/page.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n-        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Assertion failed: :::1:err::: /console: This is an assert message with a template\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2mAssertion failed: :::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       :::2:out::: /console: template(one: one, two: two)\n-       :::2:out::: /console: This is a console page. Don't match the codeframe.\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mError: :::2:err::: /console: test\n-           at ConsolePage (app/console/page.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 42 |\u001b[39m   })\n-        \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-        \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       :::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Assertion failed: :::2:err::: /console: This is an assert message with a template\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m\u001b[0m\u001b[7m Cache \u001b[0m \u001b[2mAssertion failed: :::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[22m\n-       \"\n-      `)\n-\n-      await expect(browser).toDisplayCollapsedRedbox(`\n-       {\n-         \"description\": \":::0:err::: /console: test\",\n-         \"environmentLabel\": \"Prerender\",\n-         \"label\": \"Console Error\",\n-         \"source\": \"app/console/page.tsx (44:17) @ ConsolePage\n-       > 44 |   console.error(new Error(\\`\\${errBadge} /console: test\\`))\n-            |                 ^\",\n-         \"stack\": [\n-           \"ConsolePage app/console/page.tsx (44:17)\",\n-           \"ConsolePage <anonymous>\",\n-         ],\n-       }\n-      `)\n-    } else {\n-      try {\n-        await next.build({\n-          env: {\n-            NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n-          },\n-        })\n-      } catch (err) {\n-        const error = new Error(\n-          'Expected build to complete successfully, but it failed'\n-        )\n-        error.cause = err\n-        throw error\n-      }\n-      // do not strip ANSI codes here since we're explicitly testing coloring.\n-      const cliOutputFromPage = next.cliOutput.match(\n-        /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n-      )[1]\n-\n-      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n-\n-      if (isTurbopack) {\n-        expect(reorderedLines).toMatchInlineSnapshot(`\n-         \":::0:out::: /console: template(one: one, two: two)\n-         :::0:out::: /console: This is a console page. Don't match the codeframe.\n-         :::0:out::: /console: template(one: one, two: two)\n-         :::0:out::: /console: This is a console page. Don't match the codeframe.\n-         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-         Error: :::0:err::: /console: test\n-             at e (turbopack:///[project]/app/console/page.tsx:<line>:<col>)\n-         \u001b[0m \u001b[90m 42 |\u001b[39m   })\n-          \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-          \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-          \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-          \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n-         Assertion failed: :::0:err::: /console: This is an assert message with a template\n-         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-         Assertion failed: :::0:err::: /console: This is an assert message with a template\n-         :::1:out::: /console: template(one: one, two: two)\n-         :::1:out::: /console: This is a console page. Don't match the codeframe.\n-         :::1:out::: /console: template(one: one, two: two)\n-         :::1:out::: /console: This is a console page. Don't match the codeframe.\n-         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-         Error: :::1:err::: /console: test\n-             at e (turbopack:///[project]/app/console/page.tsx:<line>:<col>)\n-         \u001b[0m \u001b[90m 42 |\u001b[39m   })\n-          \u001b[90m 43 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 44 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-          \u001b[90m 45 |\u001b[39m   \u001b[36mawait\u001b[39m \u001b[35m1\u001b[39m\n-          \u001b[90m 46 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-          \u001b[90m 47 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n-         Assertion failed: :::1:err::: /console: This is an assert message with a template\n-         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-         Assertion failed: :::1:err::: /console: This is an assert message with a template\"\n-        `)\n-      } else {\n-        expect(reorderedLines).toMatchInlineSnapshot(`\n-         \":::0:out::: /console: template(one: one, two: two)\n-         :::0:out::: /console: This is a console page. Don't match the codeframe.\n-         :::0:out::: /console: template(one: one, two: two)\n-         :::0:out::: /console: This is a console page. Don't match the codeframe.\n-         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-         Error: :::0:err::: /console: test\n-             at g (.next/server/app/console/page.js:<line>:<col>)\n-         Assertion failed: :::0:err::: /console: This is an assert message with a template\n-         :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-         Assertion failed: :::0:err::: /console: This is an assert message with a template\n-         :::1:out::: /console: template(one: one, two: two)\n-         :::1:out::: /console: This is a console page. Don't match the codeframe.\n-         :::1:out::: /console: template(one: one, two: two)\n-         :::1:out::: /console: This is a console page. Don't match the codeframe.\n-         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-         Error: :::1:err::: /console: test\n-             at g (.next/server/app/console/page.js:<line>:<col>)\n-         Assertion failed: :::1:err::: /console: This is an assert message with a template\n-         :::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-         Assertion failed: :::1:err::: /console: This is an assert message with a template\"\n-        `)\n-      }\n-    }\n-  })\n-})\n-\n-describe('cache-components - Console Dimming - Logging after Abort in Server', () => {\n-  const { next, skipped, isTurbopack } = nextTestSetup({\n-    env: {\n-      FORCE_COLOR: '1',\n-    },\n-    files: __dirname,\n-    skipDeployment: true,\n-    skipStart: !isNextDev,\n-  })\n-\n-  if (skipped) {\n-    return\n-  }\n-\n-  it('dims console calls after a prerender has aborted', async () => {\n-    const path: string = '/console-after-abort/server'\n-\n-    if (isNextDev) {\n-      const browser = await next.browser(path, {})\n-\n-      await retry(() => {\n-        expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n-      })\n-\n-      // do not strip ANSI codes here since we're explicitly testing coloring.\n-      const cliOutputFromPage = next.cliOutput.match(\n-        new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n-      )[1]\n-\n-      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n-\n-      expect(reorderedLines).toMatchInlineSnapshot(`\n-       \":::0:out::: logging before trying await headers()\n-       :::0:out::: /console: template(one: one, two: two)\n-       :::0:out::: /console: This is a console page. Don't match the codeframe.\n-       :::0:out::: /console: template(one: one, two: two)\n-       :::0:out::: /console: This is a console page. Don't match the codeframe.\n-       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: template(one: one, two: two)\n-       \u001b[0m\u001b[7m Cache \u001b[0m :::0:out::: /console: This is a console page. Don't match the codeframe.\n-       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Error: :::0:err::: /console: test\n-           at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 48 |\u001b[39m   })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n-       Assertion failed: :::0:err::: /console: This is an assert message with a template\n-       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Assertion failed: :::0:err::: /console: This is an assert message with a template\n-       \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Assertion failed: \u001b[0m\u001b[7m Cache \u001b[0m :::0:err::: /console: This is an assert message with a template\n-       \u001b[0m\u001b[7m Cache \u001b[0m Assertion failed: :::0:err::: /console: This is an assert message with a template\n-       \u001b[2m:::1:out::: logging before trying await headers()\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mError: :::1:err::: /console: test\n-           at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 48 |\u001b[39m   })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: logging before trying await headers()\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mError: :::2:err::: /console: test\n-           at ConsolePage (app/console-after-abort/server/page.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 48 |\u001b[39m   })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \"\n-      `)\n-\n-      await expect(browser).toDisplayCollapsedRedbox(`\n-       {\n-         \"description\": \":::0:err::: /console: test\",\n-         \"environmentLabel\": \"Server\",\n-         \"label\": \"Console Error\",\n-         \"source\": \"app/console-after-abort/server/page.tsx (49:17) @ ConsolePage\n-       > 49 |   console.error(new Error(\\`\\${errBadge} /console: test\\`))\n-            |                 ^\",\n-         \"stack\": [\n-           \"ConsolePage app/console-after-abort/server/page.tsx (49:17)\",\n-           \"ConsolePage <anonymous>\",\n-         ],\n-       }\n-      `)\n-    } else {\n-      try {\n-        await next.build({\n-          env: {\n-            NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n-          },\n-        })\n-      } catch (err) {\n-        const error = new Error(\n-          'Expected build to complete successfully, but it failed'\n-        )\n-        error.cause = err\n-        throw error\n-      }\n-\n-      const unorderedLines = next.cliOutput.match(\n-        /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n-      )[1]\n-\n-      const reorderedLines = reorderLinesByBadge(unorderedLines)\n-\n-      if (isTurbopack) {\n-        expect(reorderedLines).toMatchInlineSnapshot(`\n-         \":::0:out::: logging before trying await headers()\n-         \u001b[2m:::0:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mError: :::0:err::: /console: test\n-             at g (turbopack:///[project]/app/console-after-abort/server/page.tsx:<line>:<col>)\n-         \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-          \u001b[90m 48 |\u001b[39m   })\n-         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-          \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-          \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-          \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-         :::1:out::: logging before trying await headers()\n-         \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mError: :::1:err::: /console: test\n-             at g (turbopack:///[project]/app/console-after-abort/server/page.tsx:<line>:<col>)\n-         \u001b[0m \u001b[90m 47 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-          \u001b[90m 48 |\u001b[39m   })\n-         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 49 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-          \u001b[90m 50 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-          \u001b[90m 51 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-          \u001b[90m 52 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n-        `)\n-      } else {\n-        expect(reorderedLines).toMatchInlineSnapshot(`\n-         \":::0:out::: logging before trying await headers()\n-         \u001b[2m:::0:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mError: :::0:err::: /console: test\n-             at i (.next/server/app/console-after-abort/server/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-         :::1:out::: logging before trying await headers()\n-         \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:err::: caught error trying await headers()\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mError: :::1:err::: /console: test\n-             at i (.next/server/app/console-after-abort/server/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n-        `)\n-      }\n-    }\n-  })\n-})\n-\n-describe('cache-components - Console Dimming - Logging after Abort in Client', () => {\n-  const { next, skipped, isTurbopack } = nextTestSetup({\n-    env: {\n-      FORCE_COLOR: '1',\n-    },\n-    files: __dirname,\n-    skipDeployment: true,\n-    skipStart: !isNextDev,\n-  })\n-\n-  if (skipped) {\n-    return\n-  }\n-\n-  it('dims console calls after a prerender has aborted', async () => {\n-    const path: string = '/console-after-abort/client'\n-\n-    if (isNextDev) {\n-      const browser = await next.browser(path, {})\n-\n-      await retry(() => {\n-        expect(stripAnsi(next.cliOutput)).toContain(`GET ${path} 200`)\n-      })\n-\n-      // do not strip ANSI codes here since we're explicitly testing coloring.\n-      const cliOutputFromPage = next.cliOutput.match(\n-        new RegExp(`Compiled ${path}[^\\n]+\\n(.*)`, 's')\n-      )[1]\n-\n-      const reorderedLines = reorderLinesByBadge(cliOutputFromPage)\n-\n-      expect(reorderedLines).toMatchInlineSnapshot(`\n-       \":::0:out::: logging before prerender abort\n-       :::0:out::: logging before prerender aborts in client component\n-       :::0:out::: /console: template(one: one, two: two)\n-       :::0:out::: /console: This is a console page. Don't match the codeframe.\n-       :::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\n-       Error: :::0:err::: /console: test\n-           at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 13 |\u001b[39m   })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\n-       Assertion failed: :::0:err::: /console: This is an assert message with a template\n-       \u001b[2m:::1:out::: logging before prerender abort\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:out::: logging before prerender aborts in client component\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mError: :::1:err::: /console: test\n-           at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 13 |\u001b[39m   })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: logging before prerender abort\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: logging before prerender aborts in client component\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2m:::2:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mError: :::2:err::: /console: test\n-           at log (app/console-after-abort/client/client.tsx:<line>:<col>)\n-       \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 13 |\u001b[39m   })\n-       \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-        \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-        \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-        \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-        \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-       \u001b[2mAssertion failed: \u001b[2m:::2:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-       \"\n-      `)\n-\n-      await expect(browser).toDisplayCollapsedRedbox(`\n-       {\n-         \"description\": \":::0:err::: /console: test\",\n-         \"environmentLabel\": null,\n-         \"label\": \"Console Error\",\n-         \"source\": \"app/console-after-abort/client/client.tsx (14:17) @ log\n-       > 14 |   console.error(new Error(\\`\\${errBadge} /console: test\\`))\n-            |                 ^\",\n-         \"stack\": [\n-           \"log app/console-after-abort/client/client.tsx (14:17)\",\n-         ],\n-       }\n-      `)\n-    } else {\n-      try {\n-        await next.build({\n-          env: {\n-            NEXT_PRIVATE_APP_PATHS: `[\"${path === '/' ? '' : path}/page.tsx\"]`,\n-          },\n-        })\n-      } catch (err) {\n-        const error = new Error(\n-          'Expected build to complete successfully, but it failed'\n-        )\n-        error.cause = err\n-        throw error\n-      }\n-\n-      const unorderedLines = next.cliOutput.match(\n-        /Collecting page data[^\\n]+\\n(.*)\\n.*Finalizing page optimization /s\n-      )[1]\n-\n-      const reorderedLines = reorderLinesByBadge(unorderedLines)\n-\n-      if (isTurbopack) {\n-        expect(reorderedLines).toMatchInlineSnapshot(`\n-         \":::0:out::: logging before prerender abort\n-         :::0:out::: logging before prerender aborts in client component\n-         \u001b[2m:::0:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mError: :::0:err::: /console: test\n-             at c (turbopack:///[project]/app/console-after-abort/client/client.tsx:<line>:<col>)\n-         \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-          \u001b[90m 13 |\u001b[39m   })\n-         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-          \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-          \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-          \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-         :::1:out::: logging before prerender abort\n-         :::1:out::: logging before prerender aborts in client component\n-         \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mError: :::1:err::: /console: test\n-             at c (turbopack:///[project]/app/console-after-abort/client/client.tsx:<line>:<col>)\n-         \u001b[0m \u001b[90m 12 |\u001b[39m     foo\u001b[33m:\u001b[39m \u001b[32m'just-some-object'\u001b[39m\u001b[33m,\u001b[39m\n-          \u001b[90m 13 |\u001b[39m   })\n-         \u001b[31m\u001b[1m>\u001b[22m\u001b[39m\u001b[90m 14 |\u001b[39m   console\u001b[33m.\u001b[39merror(\u001b[36mnew\u001b[39m \u001b[33mError\u001b[39m(\u001b[32m\\`\\${errBadge} /console: test\\`\u001b[39m))\n-          \u001b[90m    |\u001b[39m                 \u001b[31m\u001b[1m^\u001b[22m\u001b[39m\n-          \u001b[90m 15 |\u001b[39m   console\u001b[33m.\u001b[39massert(\n-          \u001b[90m 16 |\u001b[39m     \u001b[36mfalse\u001b[39m\u001b[33m,\u001b[39m\n-          \u001b[90m 17 |\u001b[39m     \u001b[32m\\`\\${errBadge} /console: This is an assert message with a %s\\`\u001b[39m\u001b[33m,\u001b[39m\u001b[0m\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n-        `)\n-      } else {\n-        expect(reorderedLines).toMatchInlineSnapshot(`\n-         \":::0:out::: logging before prerender abort\n-         :::0:out::: logging before prerender aborts in client component\n-         \u001b[2m:::0:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::0:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mError: :::0:err::: /console: test\n-             at e (.next/server/app/console-after-abort/client/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mAssertion failed: \u001b[2m:::0:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\n-         :::1:out::: logging before prerender abort\n-         :::1:out::: logging before prerender aborts in client component\n-         \u001b[2m:::1:out::: /console: template(one: one, two: two)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:out::: /console: This is a console page. Don't match the codeframe.\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2m:::1:err::: /console: not a template { foo: \u001b[32m'just-some-object'\u001b[39m }\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mError: :::1:err::: /console: test\n-             at e (.next/server/app/console-after-abort/client/page.js:<line>:<col>)\u001b[22m\u001b[2m\u001b[22m\n-         \u001b[2mAssertion failed: \u001b[2m:::1:err::: /console: This is an assert message with a template\u001b[22m\u001b[2m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\u001b[2m\u001b[22m\"\n-        `)\n-      }\n-    }\n-  })\n-})\n-\n-type RenderGroups = Map<string | null, StreamGroups>\n-type StreamGroups = Map<string | null, Lines>\n-type Lines = Array<string>\n-\n-function reorderLinesByBadge(selectedOutput: string) {\n-  const unorderedLines = selectedOutput\n-    .split('\\n')\n-    .filter(\n-      (l) => !(l.includes('Generating static pages') || l.includes(' GET '))\n-    )\n-    .map((l) => l.replace(/( at .*):\\d+:\\d+/, '$1:<line>:<col>'))\n-\n-  let currentLines: Lines = []\n-  const renderGroups: RenderGroups = new Map([\n-    [null, new Map([[null, currentLines]]) satisfies StreamGroups],\n-  ])\n-\n-  for (let line of unorderedLines) {\n-    let match = line.match(/:::([^: \\n]+):([^: \\n]+):::/)\n-    if (match) {\n-      const [_, render, stream] = match\n-      const streamGroups = renderGroups.get(render)\n-      if (!streamGroups) {\n-        currentLines = []\n-        renderGroups.set(render, new Map([[stream, currentLines]]))\n-      } else {\n-        currentLines = streamGroups.get(stream)\n-        if (!currentLines) {\n-          streamGroups.set(stream, (currentLines = []))\n-        }\n-      }\n-    }\n-    currentLines.push(line)\n-  }\n-\n-  const orderedRenders = Array.from(renderGroups.values())\n-  const orderedStreams = orderedRenders.map((s) =>\n-    Array.from(s.values()).flat()\n-  )\n-\n-  return orderedStreams.flat().join('\\n')\n-}"
        }
    ],
    "stats": {
        "total": 1961,
        "additions": 1247,
        "deletions": 714
    }
}