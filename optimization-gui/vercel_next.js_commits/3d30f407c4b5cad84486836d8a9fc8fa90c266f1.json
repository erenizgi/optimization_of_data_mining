{
    "author": "unstubbable",
    "message": "Allow exporting object and array literals in `'use cache'` files again (#86655)\n\nIn #86014 we added a validation for exporting object and array literals\nfrom `'use cache'` files. This was a bit too restrictive, and\nshort-sighted, as it would prevent exporting common things like metadata\nor viewport objects from page and layout files, if the file uses a `'use\ncache'` top-level directive.",
    "sha": "3d30f407c4b5cad84486836d8a9fc8fa90c266f1",
    "files": [
        {
            "sha": "1abac4fb07804d9f378a90bc4a2387d05d0a9a8d",
            "filename": "crates/next-custom-transforms/src/transforms/server_actions.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 9,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Fsrc%2Ftransforms%2Fserver_actions.rs?ref=3d30f407c4b5cad84486836d8a9fc8fa90c266f1",
            "patch": "@@ -1895,18 +1895,17 @@ impl<C: Comments> VisitMut for ServerActions<C> {\n                             Decl::Var(var) => {\n                                 let mut has_export_needing_wrapper = false;\n \n-                                // Validate exports and check for cache runtime wrappers. Disallow\n-                                // exporting literals, objects, and arrays directly (destructuring\n-                                // patterns are allowed since we can't statically know if the\n-                                // destructured value is a function).\n                                 for decl in &var.decls {\n                                     if let Pat::Ident(_) = &decl.name {\n                                         if let Some(init) = &decl.init {\n-                                            match &**init {\n-                                                Expr::Lit(_) | Expr::Object(_) | Expr::Array(_) => {\n-                                                    disallowed_export_span = *span;\n-                                                }\n-                                                _ => {}\n+                                            // Disallow exporting literals. Admittedly, this is\n+                                            // pretty arbitrary. We don't disallow exporting object\n+                                            // and array literals, as that would be too restrictive,\n+                                            // especially for page and layout files with\n+                                            // 'use cache', that may want to export metadata or\n+                                            // viewport objects.\n+                                            if let Expr::Lit(_) = &**init {\n+                                                disallowed_export_span = *span;\n                                             }\n                                         }\n                                     }"
        },
        {
            "sha": "2a9ae959c796c588f5170962deabbabd574fdbd4",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/client-graph/3/output.stderr",
            "status": "removed",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/53ab225ca205f7e7acd0ec94e58a0fb057731290/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fclient-graph%2F3%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/53ab225ca205f7e7acd0ec94e58a0fb057731290/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fclient-graph%2F3%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fclient-graph%2F3%2Foutput.stderr?ref=53ab225ca205f7e7acd0ec94e58a0fb057731290",
            "patch": "@@ -1,7 +0,0 @@\n-  x Only async functions are allowed to be exported in a \"use cache\" file.\n-  | \n-   ,-[input.js:3:1]\n- 2 |     \n- 3 | ,-> export const foo = {},\n- 4 | `->   bar = [1]\n-   `----"
        },
        {
            "sha": "66ac0246c493b43c31f14499522594dd491db8fb",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/23/input.js",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F23%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F23%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F23%2Finput.js?ref=3d30f407c4b5cad84486836d8a9fc8fa90c266f1",
            "patch": "@@ -16,7 +16,7 @@ async function a() {\n   }\n }\n \n-export const { foo } = {\n+export const obj = {\n   foo() {\n     return 42\n   },"
        },
        {
            "sha": "35c90b66096ecfaa51397250992cd8d942ceddaa",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/23/output.js",
            "status": "modified",
            "additions": 1,
            "deletions": 15,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F23%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F23%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F23%2Foutput.js?ref=3d30f407c4b5cad84486836d8a9fc8fa90c266f1",
            "patch": "@@ -1,6 +1,3 @@\n-/* __next_internal_action_entry_do_not_use__ {\"ffab21efdafbe611287bc25c0462b1e0510d13e48b\":\"foo\"} */ import { registerServerReference } from \"private-next-rsc-server-reference\";\n-import { cache as $$cache__ } from \"private-next-rsc-cache-wrapper\";\n-import { cache as $$reactCache__ } from \"react\";\n // not exported!\n async function a() {\n     // this is allowed here\n@@ -14,7 +11,7 @@ async function a() {\n         console.log(arguments);\n     };\n }\n-const { foo } = {\n+export const obj = {\n     foo () {\n         return 42;\n     },\n@@ -25,14 +22,3 @@ const { foo } = {\n         console.log(arguments);\n     }\n };\n-let $$RSC_SERVER_CACHE_foo = foo;\n-if (typeof foo === \"function\") {\n-    $$RSC_SERVER_CACHE_foo = $$reactCache__(function() {\n-        return $$cache__(\"default\", \"ffab21efdafbe611287bc25c0462b1e0510d13e48b\", 0, foo, arguments);\n-    });\n-    registerServerReference($$RSC_SERVER_CACHE_foo, \"ffab21efdafbe611287bc25c0462b1e0510d13e48b\", null);\n-    Object[\"defineProperty\"]($$RSC_SERVER_CACHE_foo, \"name\", {\n-        value: \"foo\"\n-    });\n-}\n-export { $$RSC_SERVER_CACHE_foo as foo };"
        },
        {
            "sha": "2a9ae959c796c588f5170962deabbabd574fdbd4",
            "filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/31/output.stderr",
            "status": "removed",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/53ab225ca205f7e7acd0ec94e58a0fb057731290/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F31%2Foutput.stderr",
            "raw_url": "https://github.com/vercel/next.js/raw/53ab225ca205f7e7acd0ec94e58a0fb057731290/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F31%2Foutput.stderr",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ferrors%2Fserver-actions%2Fserver-graph%2F31%2Foutput.stderr?ref=53ab225ca205f7e7acd0ec94e58a0fb057731290",
            "patch": "@@ -1,7 +0,0 @@\n-  x Only async functions are allowed to be exported in a \"use cache\" file.\n-  | \n-   ,-[input.js:3:1]\n- 2 |     \n- 3 | ,-> export const foo = {},\n- 4 | `->   bar = [1]\n-   `----"
        },
        {
            "sha": "92299559dd3d60d9783a772d372f9f60bea97dac",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/client-graph/17/input.js",
            "status": "renamed",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fclient-graph%2F17%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fclient-graph%2F17%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fclient-graph%2F17%2Finput.js?ref=3d30f407c4b5cad84486836d8a9fc8fa90c266f1",
            "patch": "@@ -1,4 +1,5 @@\n 'use cache'\n \n+// Should not get cache runtime wrappers.\n export const foo = {},\n   bar = [1]",
            "previous_filename": "crates/next-custom-transforms/tests/errors/server-actions/client-graph/3/input.js"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/client-graph/17/output.js",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fclient-graph%2F17%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fclient-graph%2F17%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fclient-graph%2F17%2Foutput.js?ref=3d30f407c4b5cad84486836d8a9fc8fa90c266f1"
        },
        {
            "sha": "92299559dd3d60d9783a772d372f9f60bea97dac",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/server-graph/69/input.js",
            "status": "renamed",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F69%2Finput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F69%2Finput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F69%2Finput.js?ref=3d30f407c4b5cad84486836d8a9fc8fa90c266f1",
            "patch": "@@ -1,4 +1,5 @@\n 'use cache'\n \n+// Should not get cache runtime wrappers.\n export const foo = {},\n   bar = [1]",
            "previous_filename": "crates/next-custom-transforms/tests/errors/server-actions/server-graph/31/input.js"
        },
        {
            "sha": "9ea8bcb852cf30c2eaf9a17c497e1eb7388a1756",
            "filename": "crates/next-custom-transforms/tests/fixture/server-actions/server-graph/69/output.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F69%2Foutput.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3d30f407c4b5cad84486836d8a9fc8fa90c266f1/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F69%2Foutput.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-custom-transforms%2Ftests%2Ffixture%2Fserver-actions%2Fserver-graph%2F69%2Foutput.js?ref=3d30f407c4b5cad84486836d8a9fc8fa90c266f1",
            "patch": "@@ -0,0 +1,4 @@\n+// Should not get cache runtime wrappers.\n+export const foo = {}, bar = [\n+    1\n+];"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 16,
        "deletions": 39
    }
}