{
    "author": "unstubbable",
    "message": "Improve error handling for `headers`/`cookies`/`draftMode` in `'use cache'` (#81716)\n\nThis ensures that we show a proper error with an error stack\n(potentially source-mapped) when accessing\n`headers`/`cookies`/`draftMode` in `'use cache'`, even when caught in\nuser-land code. For `searchParams` (currently triggering a timeout\nerror) we'll need a slightly different solution, which will be handled\nin a future PR.\n\nThe approach chosen here is somewhat temporary, as we'd like to\nimplement compile-time errors instead for accessing any kind of request\ndata in `'use cache'` functions. However, this would require a larger\nchange to our bundlers.\n\ncloses NAR-201",
    "sha": "4e0b1125a466bdc81ead94969008c55509ea4ad0",
    "files": [
        {
            "sha": "340da527bcd36e2a6f420faa71cb13130e9d7439",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -135,6 +135,7 @@ import {\n   PreludeState,\n   consumeDynamicAccess,\n   type DynamicAccess,\n+  logDisallowedDynamicError,\n } from './dynamic-rendering'\n import {\n   getClientComponentLoaderMetrics,\n@@ -1456,7 +1457,8 @@ async function renderToHTMLOrFlightImpl(\n     // If we encountered any unexpected errors during build we fail the\n     // prerendering phase and the build.\n     if (workStore.invalidDynamicUsageError) {\n-      throw workStore.invalidDynamicUsageError\n+      logDisallowedDynamicError(workStore, workStore.invalidDynamicUsageError)\n+      throw new StaticGenBailoutError()\n     }\n     if (response.digestErrorsMap.size) {\n       const buildFailingError = response.digestErrorsMap.values().next().value\n@@ -3047,7 +3049,8 @@ async function prerenderToStream(\n       // We don't need to continue the prerender process if we already\n       // detected invalid dynamic usage in the initial prerender phase.\n       if (workStore.invalidDynamicUsageError) {\n-        throw workStore.invalidDynamicUsageError\n+        logDisallowedDynamicError(workStore, workStore.invalidDynamicUsageError)\n+        throw new StaticGenBailoutError()\n       }\n \n       let initialServerResult"
        },
        {
            "sha": "0f8bbd7701505bae733927827e5c8fa791556451",
            "filename": "packages/next/src/server/app-render/dynamic-rendering.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fdynamic-rendering.ts?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -678,7 +678,10 @@ export enum PreludeState {\n   Errored = 2,\n }\n \n-function logDisallowedDynamicError(workStore: WorkStore, error: Error): void {\n+export function logDisallowedDynamicError(\n+  workStore: WorkStore,\n+  error: Error\n+): void {\n   console.error(error)\n \n   if (!workStore.dev) {\n@@ -700,11 +703,6 @@ export function throwIfDisallowedDynamic(\n   dynamicValidation: DynamicValidationState,\n   serverDynamic: DynamicTrackingState\n ): void {\n-  if (workStore.invalidDynamicUsageError) {\n-    logDisallowedDynamicError(workStore, workStore.invalidDynamicUsageError)\n-    throw new StaticGenBailoutError()\n-  }\n-\n   if (prelude !== PreludeState.Full) {\n     if (dynamicValidation.hasSuspenseAboveBody) {\n       // This route has opted into allowing fully dynamic rendering"
        },
        {
            "sha": "07460d5e9671c1b030421c2d7ca07e5e35c0cfbe",
            "filename": "packages/next/src/server/request/cookies.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -81,9 +81,12 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n     if (workUnitStore) {\n       switch (workUnitStore.type) {\n         case 'cache':\n-          throw new Error(\n+          const error = new Error(\n             `Route ${workStore.route} used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n           )\n+          Error.captureStackTrace(error, cookies)\n+          workStore.invalidDynamicUsageError ??= error\n+          throw error\n         case 'unstable-cache':\n           throw new Error(\n             `Route ${workStore.route} used \"cookies\" inside a function cached with \"unstable_cache(...)\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`"
        },
        {
            "sha": "a251706ed0365e0ba916fe844c3191bae5cbce9b",
            "filename": "packages/next/src/server/request/draft-mode.ts",
            "status": "modified",
            "additions": 25,
            "deletions": 19,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fdraft-mode.ts?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -229,13 +229,13 @@ class DraftMode {\n   public enable() {\n     // We have a store we want to track dynamic data access to ensure we\n     // don't statically generate routes that manipulate draft mode.\n-    trackDynamicDraftMode('draftMode().enable()')\n+    trackDynamicDraftMode('draftMode().enable()', this.enable)\n     if (this._provider !== null) {\n       this._provider.enable()\n     }\n   }\n   public disable() {\n-    trackDynamicDraftMode('draftMode().disable()')\n+    trackDynamicDraftMode('draftMode().disable()', this.disable)\n     if (this._provider !== null) {\n       this._provider.disable()\n     }\n@@ -286,63 +286,69 @@ function createDraftModeAccessError(\n   )\n }\n \n-function trackDynamicDraftMode(expression: string) {\n-  const store = workAsyncStorage.getStore()\n+function trackDynamicDraftMode(expression: string, constructorOpt: Function) {\n+  const workStore = workAsyncStorage.getStore()\n   const workUnitStore = workUnitAsyncStorage.getStore()\n-  if (store) {\n+\n+  if (workStore) {\n     // We have a store we want to track dynamic data access to ensure we\n     // don't statically generate routes that manipulate draft mode.\n     if (workUnitStore?.phase === 'after') {\n       throw new Error(\n-        `Route ${store.route} used \"${expression}\" inside \\`after\\`. The enabled status of draftMode can be read inside \\`after\\` but you cannot enable or disable draftMode. See more info here: https://nextjs.org/docs/app/api-reference/functions/after`\n+        `Route ${workStore.route} used \"${expression}\" inside \\`after\\`. The enabled status of draftMode can be read inside \\`after\\` but you cannot enable or disable draftMode. See more info here: https://nextjs.org/docs/app/api-reference/functions/after`\n       )\n     }\n \n-    if (store.dynamicShouldError) {\n+    if (workStore.dynamicShouldError) {\n       throw new StaticGenBailoutError(\n-        `Route ${store.route} with \\`dynamic = \"error\"\\` couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n+        `Route ${workStore.route} with \\`dynamic = \"error\"\\` couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n       )\n     }\n \n     if (workUnitStore) {\n       switch (workUnitStore.type) {\n-        case 'cache':\n-          throw new Error(\n-            `Route ${store.route} used \"${expression}\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n+        case 'cache': {\n+          const error = new Error(\n+            `Route ${workStore.route} used \"${expression}\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n           )\n+          Error.captureStackTrace(error, constructorOpt)\n+          workStore.invalidDynamicUsageError ??= error\n+          throw error\n+        }\n         case 'unstable-cache':\n           throw new Error(\n-            `Route ${store.route} used \"${expression}\" inside a function cached with \"unstable_cache(...)\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`\n+            `Route ${workStore.route} used \"${expression}\" inside a function cached with \"unstable_cache(...)\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`\n           )\n-        case 'prerender':\n+        case 'prerender': {\n           const error = new Error(\n-            `Route ${store.route} used ${expression} without first calling \\`await connection()\\`. See more info here: https://nextjs.org/docs/messages/next-prerender-sync-headers`\n+            `Route ${workStore.route} used ${expression} without first calling \\`await connection()\\`. See more info here: https://nextjs.org/docs/messages/next-prerender-sync-headers`\n           )\n           return abortAndThrowOnSynchronousRequestDataAccess(\n-            store.route,\n+            workStore.route,\n             expression,\n             error,\n             workUnitStore\n           )\n+        }\n         case 'prerender-client':\n           const exportName = '`draftMode`'\n           throw new InvariantError(\n             `${exportName} must not be used within a client component. Next.js should be preventing ${exportName} from being included in client components statically, but did not in this case.`\n           )\n         case 'prerender-ppr':\n           return postponeWithTracking(\n-            store.route,\n+            workStore.route,\n             expression,\n             workUnitStore.dynamicTracking\n           )\n         case 'prerender-legacy':\n           workUnitStore.revalidate = 0\n \n           const err = new DynamicServerError(\n-            `Route ${store.route} couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`\n+            `Route ${workStore.route} couldn't be rendered statically because it used \\`${expression}\\`. See more info here: https://nextjs.org/docs/messages/dynamic-server-error`\n           )\n-          store.dynamicUsageDescription = expression\n-          store.dynamicUsageStack = err.stack\n+          workStore.dynamicUsageDescription = expression\n+          workStore.dynamicUsageStack = err.stack\n \n           throw err\n         case 'request':"
        },
        {
            "sha": "cfa09096fb711b889b989973bc0f75fa37a1fb14",
            "filename": "packages/next/src/server/request/headers.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -79,9 +79,12 @@ export function headers(): Promise<ReadonlyHeaders> {\n     if (workUnitStore) {\n       switch (workUnitStore.type) {\n         case 'cache':\n-          throw new Error(\n+          const error = new Error(\n             `Route ${workStore.route} used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache`\n           )\n+          Error.captureStackTrace(error, headers)\n+          workStore.invalidDynamicUsageError ??= error\n+          throw error\n         case 'unstable-cache':\n           throw new Error(\n             `Route ${workStore.route} used \"headers\" inside a function cached with \"unstable_cache(...)\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/app/api-reference/functions/unstable_cache`"
        },
        {
            "sha": "539d1db7093a61170af434514c864bc78d594426",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 368,
            "deletions": 0,
            "changes": 368,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -2038,5 +2038,373 @@ describe('Dynamic IO Errors', () => {\n         }\n       })\n     })\n+\n+    describe('Inside `use cache`', () => {\n+      describe('cookies', () => {\n+        const pathname = '/use-cache-cookies'\n+\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser(pathname)\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-cookies/page.tsx (22:18) @ CookiesReadingComponent\n+               > 22 |     await cookies()\n+                    |                  ^\",\n+                 \"stack\": [\n+                   \"CookiesReadingComponent app/use-cache-cookies/page.tsx (22:18)\",\n+                 ],\n+               }\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-cookies/page.tsx (22:18) @ CookiesReadingComponent\n+               > 22 |     await cookies()\n+                    |                  ^\",\n+                 \"stack\": [\n+                   \"CookiesReadingComponent app/use-cache-cookies/page.tsx (22:18)\",\n+                 ],\n+               }\n+              `)\n+            }\n+          })\n+        } else {\n+          it('should error the build', async () => {\n+            try {\n+              await prerender(pathname)\n+            } catch {\n+              // we expect the build to fail\n+            }\n+\n+            const output = getPrerenderOutput(\n+              next.cliOutput.slice(cliOutputLength),\n+              { isMinified: !isDebugPrerender }\n+            )\n+\n+            if (isTurbopack) {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at CookiesReadingComponent (turbopack:///[project]/app/use-cache-cookies/page.tsx:22:18)\n+                   20 |   // in userland.\n+                   21 |   try {\n+                 > 22 |     await cookies()\n+                      |                  ^\n+                   23 |   } catch {}\n+                   24 |\n+                   25 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-cookies\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-cookies/page: /use-cache-cookies\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at <unknown> (turbopack:///[project]/app/use-cache-cookies/page.tsx:22:11)\n+                   20 |   // in userland.\n+                   21 |   try {\n+                 > 22 |     await cookies()\n+                      |           ^\n+                   23 |   } catch {}\n+                   24 |\n+                   25 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-cookies\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-cookies/page: /use-cache-cookies, exiting the build.\"\n+                `)\n+              }\n+            } else {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at CookiesReadingComponent (webpack:///app/use-cache-cookies/page.tsx:22:18)\n+                     at <unknown> (webpack://<next-src>)\n+                   20 |   // in userland.\n+                   21 |   try {\n+                 > 22 |     await cookies()\n+                      |                  ^\n+                   23 |   } catch {}\n+                   24 |\n+                   25 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-cookies\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-cookies/page: /use-cache-cookies\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-cookies used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n+                     at c (<next-dist-dir>)\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-cookies\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-cookies\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-cookies/page: /use-cache-cookies, exiting the build.\"\n+                `)\n+              }\n+            }\n+          })\n+        }\n+      })\n+\n+      describe('draftMode', () => {\n+        const pathname = '/use-cache-draft-mode'\n+\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser(pathname)\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-draft-mode/page.tsx (20:26) @ DraftModeEnablingComponent\n+               > 20 |     ;(await draftMode()).enable()\n+                    |                          ^\",\n+                 \"stack\": [\n+                   \"DraftModeEnablingComponent app/use-cache-draft-mode/page.tsx (20:26)\",\n+                 ],\n+               }\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-draft-mode/page.tsx (20:26) @ DraftModeEnablingComponent\n+               > 20 |     ;(await draftMode()).enable()\n+                    |                          ^\",\n+                 \"stack\": [\n+                   \"DraftModeEnablingComponent app/use-cache-draft-mode/page.tsx (20:26)\",\n+                 ],\n+               }\n+              `)\n+            }\n+          })\n+        } else {\n+          it('should error the build', async () => {\n+            try {\n+              await prerender(pathname)\n+            } catch {\n+              // we expect the build to fail\n+            }\n+\n+            const output = getPrerenderOutput(\n+              next.cliOutput.slice(cliOutputLength),\n+              { isMinified: !isDebugPrerender }\n+            )\n+\n+            if (isTurbopack) {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at DraftModeEnablingComponent (turbopack:///[project]/app/use-cache-draft-mode/page.tsx:20:26)\n+                   18 |   // here to ensure that this error is shown even when it's caught in userland.\n+                   19 |   try {\n+                 > 20 |     ;(await draftMode()).enable()\n+                      |                          ^\n+                   21 |   } catch {}\n+                   22 |\n+                   23 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-draft-mode\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-draft-mode\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-draft-mode/page: /use-cache-draft-mode\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at <unknown> (turbopack:///[project]/app/use-cache-draft-mode/page.tsx:20:26)\n+                   18 |   // here to ensure that this error is shown even when it's caught in userland.\n+                   19 |   try {\n+                 > 20 |     ;(await draftMode()).enable()\n+                      |                          ^\n+                   21 |   } catch {}\n+                   22 |\n+                   23 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-draft-mode\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-draft-mode\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-draft-mode/page: /use-cache-draft-mode, exiting the build.\"\n+                `)\n+              }\n+            } else {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at DraftModeEnablingComponent (webpack:///app/use-cache-draft-mode/page.tsx:20:26)\n+                   18 |   // here to ensure that this error is shown even when it's caught in userland.\n+                   19 |   try {\n+                 > 20 |     ;(await draftMode()).enable()\n+                      |                          ^\n+                   21 |   } catch {}\n+                   22 |\n+                   23 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-draft-mode\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-draft-mode\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-draft-mode/page: /use-cache-draft-mode\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-draft-mode used \"draftMode().enable()\" inside \"use cache\". The enabled status of draftMode can be read in caches but you must not enable or disable draftMode inside a cache. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at a (<next-dist-dir>)\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-draft-mode\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-draft-mode\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-draft-mode/page: /use-cache-draft-mode, exiting the build.\"\n+                `)\n+              }\n+            }\n+          })\n+        }\n+      })\n+\n+      describe('headers', () => {\n+        const pathname = '/use-cache-headers'\n+\n+        if (isNextDev) {\n+          it('should show a redbox error', async () => {\n+            const browser = await next.browser(pathname)\n+\n+            if (isTurbopack) {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-headers/page.tsx (21:18) @ HeadersReadingComponent\n+               > 21 |     await headers()\n+                    |                  ^\",\n+                 \"stack\": [\n+                   \"HeadersReadingComponent app/use-cache-headers/page.tsx (21:18)\",\n+                 ],\n+               }\n+              `)\n+            } else {\n+              await expect(browser).toDisplayRedbox(`\n+               {\n+                 \"description\": \"Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\",\n+                 \"environmentLabel\": null,\n+                 \"label\": \"Runtime Error\",\n+                 \"source\": \"app/use-cache-headers/page.tsx (21:18) @ HeadersReadingComponent\n+               > 21 |     await headers()\n+                    |                  ^\",\n+                 \"stack\": [\n+                   \"HeadersReadingComponent app/use-cache-headers/page.tsx (21:18)\",\n+                 ],\n+               }\n+              `)\n+            }\n+          })\n+        } else {\n+          it('should error the build', async () => {\n+            try {\n+              await prerender(pathname)\n+            } catch {\n+              // we expect the build to fail\n+            }\n+\n+            const output = getPrerenderOutput(\n+              next.cliOutput.slice(cliOutputLength),\n+              { isMinified: !isDebugPrerender }\n+            )\n+\n+            if (isTurbopack) {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at HeadersReadingComponent (turbopack:///[project]/app/use-cache-headers/page.tsx:21:18)\n+                   19 |   // to ensure that this error is shown even when it's caught in userland.\n+                   20 |   try {\n+                 > 21 |     await headers()\n+                      |                  ^\n+                   22 |   } catch {}\n+                   23 |\n+                   24 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-headers\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-headers\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-headers/page: /use-cache-headers\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at <unknown> (turbopack:///[project]/app/use-cache-headers/page.tsx:21:11)\n+                   19 |   // to ensure that this error is shown even when it's caught in userland.\n+                   20 |   try {\n+                 > 21 |     await headers()\n+                      |           ^\n+                   22 |   } catch {}\n+                   23 |\n+                   24 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-headers\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-headers\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-headers/page: /use-cache-headers, exiting the build.\"\n+                `)\n+              }\n+            } else {\n+              if (isDebugPrerender) {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at HeadersReadingComponent (webpack:///app/use-cache-headers/page.tsx:21:18)\n+                     at <unknown> (webpack://<next-src>)\n+                   19 |   // to ensure that this error is shown even when it's caught in userland.\n+                   20 |   try {\n+                 > 21 |     await headers()\n+                      |                  ^\n+                   22 |   } catch {}\n+                   23 |\n+                   24 |   return null\n+                 To get a more detailed stack trace and pinpoint the issue, start the app in development mode by running \\`next dev\\`, then open \"/use-cache-headers\" in your browser to investigate the error.\n+                 Error occurred prerendering page \"/use-cache-headers\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+                 > Export encountered errors on following paths:\n+                 \t/use-cache-headers/page: /use-cache-headers\"\n+                `)\n+              } else {\n+                expect(output).toMatchInlineSnapshot(`\n+                 \"Error: Route /use-cache-headers used \"headers\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"headers\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache\n+                     at a (<next-dist-dir>)\n+                     at b (<next-dist-dir>)\n+                     at c (<next-dist-dir>)\n+                 To get a more detailed stack trace and pinpoint the issue, try one of the following:\n+                   - Start the app in development mode by running \\`next dev\\`, then open \"/use-cache-headers\" in your browser to investigate the error.\n+                   - Rerun the production build with \\`next build --debug-prerender\\` to generate better stack traces.\n+                 Error occurred prerendering page \"/use-cache-headers\". Read more: https://nextjs.org/docs/messages/prerender-error\n+                 Export encountered an error on /use-cache-headers/page: /use-cache-headers, exiting the build.\"\n+                `)\n+              }\n+            }\n+          })\n+        }\n+      })\n+    })\n   })\n })"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/default/app/use-cache-cookies/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-cookies%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-cookies%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-cookies%2Flayout.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "80665a5f22b3c78132336a23196e2e6997e9fbd2",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/default/app/use-cache-cookies/page.tsx",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-cookies%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-cookies%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-cookies%2Fpage.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -0,0 +1,26 @@\n+import { cookies } from 'next/headers'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page accesses `cookies()` in `'use cache'`, which triggers an\n+        error.\n+      </p>\n+      <CookiesReadingComponent />\n+    </>\n+  )\n+}\n+\n+async function CookiesReadingComponent() {\n+  'use cache'\n+\n+  // Reading cookies in a non-private cache context is not allowed. We're\n+  // try/catching here to ensure that this error is shown even when it's caught\n+  // in userland.\n+  try {\n+    await cookies()\n+  } catch {}\n+\n+  return null\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/default/app/use-cache-draft-mode/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-draft-mode%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-draft-mode%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-draft-mode%2Flayout.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "d9b55c1797d032d0ae72de520010afc94612395c",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/default/app/use-cache-draft-mode/page.tsx",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-draft-mode%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-draft-mode%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-draft-mode%2Fpage.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -0,0 +1,24 @@\n+import { draftMode } from 'next/headers'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page enables draft mode in `'use cache'`, which triggers an error.\n+      </p>\n+      <DraftModeEnablingComponent />\n+    </>\n+  )\n+}\n+\n+async function DraftModeEnablingComponent() {\n+  'use cache'\n+\n+  // Enabling draft mode in a cache context is not allowed. We're try/catching\n+  // here to ensure that this error is shown even when it's caught in userland.\n+  try {\n+    ;(await draftMode()).enable()\n+  } catch {}\n+\n+  return null\n+}"
        },
        {
            "sha": "745e32b8a8d235ef098d1a265f57c0254df40b5d",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/default/app/use-cache-headers/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-headers%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-headers%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-headers%2Flayout.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -0,0 +1,9 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>\n+        <main>{children}</main>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "6b4cdb895f83fb813bdb3b60167c123e1250c903",
            "filename": "test/e2e/app-dir/dynamic-io-errors/fixtures/default/app/use-cache-headers/page.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-headers%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-headers%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Ffixtures%2Fdefault%2Fapp%2Fuse-cache-headers%2Fpage.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -0,0 +1,25 @@\n+import { headers } from 'next/headers'\n+\n+export default async function Page() {\n+  return (\n+    <>\n+      <p>\n+        This page accesses `headers()` in `'use cache'`, which triggers an\n+        error.\n+      </p>\n+      <HeadersReadingComponent />\n+    </>\n+  )\n+}\n+\n+async function HeadersReadingComponent() {\n+  'use cache'\n+\n+  // Reading headers in a cache context is not allowed. We're try/catching here\n+  // to ensure that this error is shown even when it's caught in userland.\n+  try {\n+    await headers()\n+  } catch {}\n+\n+  return null\n+}"
        },
        {
            "sha": "2aaa3f797bea150a40e9f0ff935ea4fe93de0b8a",
            "filename": "test/e2e/app-dir/use-cache-hanging-inputs/use-cache-hanging-inputs.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 8,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fuse-cache-hanging-inputs.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fuse-cache-hanging-inputs.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-hanging-inputs%2Fuse-cache-hanging-inputs.test.ts?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import escapeStringRegexp from 'escape-string-regexp'\n import {\n   getRedboxDescription,\n   getRedboxSource,\n@@ -323,11 +324,16 @@ describe('use-cache-hanging-inputs', () => {\n       })\n     })\n   } else {\n+    // TODO: Be more precise about the expected error messages and stacks.\n     it('should fail the build with errors after a timeout', async () => {\n       const { cliOutput } = await next.build()\n \n-      expect(cliOutput).toInclude(\n-        createExpectedBuildErrorMessage('/error', 'kaputt!')\n+      expect(cliOutput).toInclude(createExpectedBuildErrorMessage('/error'))\n+      expect(cliOutput).toInclude('Error: kaputt!')\n+\n+      expect(cliOutput).toIncludeRepeated(\n+        escapeStringRegexp(expectedTimeoutErrorMessage),\n+        6\n       )\n \n       expect(cliOutput).toInclude(\n@@ -357,10 +363,6 @@ describe('use-cache-hanging-inputs', () => {\n   }\n })\n \n-function createExpectedBuildErrorMessage(\n-  pathname: string,\n-  errorMessage: string = expectedTimeoutErrorMessage\n-) {\n-  return `Error occurred prerendering page \"${pathname}\". Read more: https://nextjs.org/docs/messages/prerender-error\n-Error: ${errorMessage}`\n+function createExpectedBuildErrorMessage(pathname: string) {\n+  return `Error occurred prerendering page \"${pathname}\". Read more: https://nextjs.org/docs/messages/prerender-error`\n }"
        },
        {
            "sha": "2b05725c7babaa67473607f0c97cb53965143434",
            "filename": "test/e2e/app-dir/use-cache/app/(dynamic)/errors/error-boundary.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 26,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Ferror-boundary.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Ferror-boundary.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Ferror-boundary.tsx?ref=63090e20f198f7bda7bb746e29fe6a25a1391d8c",
            "patch": "@@ -1,26 +0,0 @@\n-'use client'\n-\n-import { Component, Suspense } from 'react'\n-\n-export default class ErrorBoundary extends Component<\n-  { id: string; children: React.ReactNode },\n-  { message: null | string }\n-> {\n-  state = { message: null }\n-  static getDerivedStateFromError(error: any) {\n-    return { message: error.message }\n-  }\n-  render() {\n-    let content\n-    if (this.state.message !== null) {\n-      content = this.state.message\n-    } else {\n-      content = this.props.children\n-    }\n-    return (\n-      <p id={this.props.id}>\n-        <Suspense>{content}</Suspense>\n-      </p>\n-    )\n-  }\n-}"
        },
        {
            "sha": "42278f43b4b18c0cc7fae6dd32a4686b1c6230ba",
            "filename": "test/e2e/app-dir/use-cache/app/(dynamic)/errors/page.tsx",
            "status": "removed",
            "additions": 0,
            "deletions": 37,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Fpage.tsx?ref=63090e20f198f7bda7bb746e29fe6a25a1391d8c",
            "patch": "@@ -1,37 +0,0 @@\n-import ErrorBoundary from './error-boundary'\n-\n-import { cookies } from 'next/headers'\n-\n-import { currentUser, currentReferer, isEditing } from './util'\n-\n-async function Cookie() {\n-  'use cache'\n-  return <div>User: {currentUser()}</div>\n-}\n-\n-async function Header() {\n-  'use cache'\n-  return <div>Referer: {currentReferer()}</div>\n-}\n-\n-async function DraftMode() {\n-  'use cache'\n-  return <div>Editing: {isEditing()}</div>\n-}\n-\n-export default async function Page() {\n-  await cookies()\n-  return (\n-    <div>\n-      <ErrorBoundary id=\"cookies\">\n-        <Cookie />\n-      </ErrorBoundary>\n-      <ErrorBoundary id=\"headers\">\n-        <Header />\n-      </ErrorBoundary>\n-      <ErrorBoundary id=\"draft-mode\">\n-        <DraftMode />\n-      </ErrorBoundary>\n-    </div>\n-  )\n-}"
        },
        {
            "sha": "42257e2e1c1f2cc3261cc34f3c76a4f0a1aa2cfe",
            "filename": "test/e2e/app-dir/use-cache/app/(dynamic)/errors/util.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Futil.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/63090e20f198f7bda7bb746e29fe6a25a1391d8c/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Futil.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(dynamic)%2Ferrors%2Futil.ts?ref=63090e20f198f7bda7bb746e29fe6a25a1391d8c",
            "patch": "@@ -1,13 +0,0 @@\n-import { cookies, headers, draftMode } from 'next/headers'\n-\n-export async function currentUser() {\n-  return (await cookies()).get('user')?.value\n-}\n-\n-export async function currentReferer() {\n-  return (await headers()).get('referer')\n-}\n-\n-export async function isEditing() {\n-  return String((await draftMode()).isEnabled)\n-}"
        },
        {
            "sha": "5dae0e1aa93c1dc3b8930ab6e4eb2deda4b1c3cd",
            "filename": "test/e2e/app-dir/use-cache/app/(partially-static)/draft-mode/[mode]/button.tsx",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fdraft-mode%2F%5Bmode%5D%2Fbutton.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fdraft-mode%2F%5Bmode%5D%2Fbutton.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fdraft-mode%2F%5Bmode%5D%2Fbutton.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "previous_filename": "test/e2e/app-dir/use-cache/app/(partially-static)/draft-mode/button.tsx"
        },
        {
            "sha": "fee433e9aaa810dffeff667f635908815903ff55",
            "filename": "test/e2e/app-dir/use-cache/app/(partially-static)/draft-mode/[mode]/page.tsx",
            "status": "renamed",
            "additions": 14,
            "deletions": 14,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fdraft-mode%2F%5Bmode%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fdraft-mode%2F%5Bmode%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fapp%2F(partially-static)%2Fdraft-mode%2F%5Bmode%5D%2Fpage.tsx?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -1,5 +1,3 @@\n-'use cache'\n-\n import { cookies, draftMode } from 'next/headers'\n import { Button } from './button'\n \n@@ -24,7 +22,14 @@ async function getCachedValue(\n   return [date.toISOString(), fn]\n }\n \n-export default async function Page() {\n+export default async function Page({\n+  params,\n+}: {\n+  params: Promise<{ mode: string }>\n+}) {\n+  'use cache'\n+\n+  const { mode } = await params\n   const offset = 1000\n \n   const cachedClosure = async () => {\n@@ -36,14 +41,8 @@ export default async function Page() {\n \n   // Accessing request-scoped data in \"use cache\" should not be allowed, even if\n   // draft mode is enabled. We expect the access to throw.\n-  let isAccessingRequestScopedDataAllowedInUseCache = isEnabled\n-\n-  if (isAccessingRequestScopedDataAllowedInUseCache) {\n-    try {\n-      await cookies()\n-    } catch {\n-      isAccessingRequestScopedDataAllowedInUseCache = false\n-    }\n+  if (isEnabled && mode === 'with-cookies') {\n+    await cookies()\n   }\n \n   const [cachedValue, passthroughFn] = await getCachedValue(\n@@ -71,11 +70,12 @@ export default async function Page() {\n     >\n       <p id=\"top-level\">{cachedValue}</p>\n       <p id=\"closure\">{await cachedClosure()}</p>\n-      <p id=\"is-accessing-request-scoped-data-allowed-in-use-cache\">\n-        {isAccessingRequestScopedDataAllowedInUseCache.toString()}\n-      </p>\n       <p>{passthroughFn()}</p>\n       <Button id=\"toggle\">{isEnabled ? 'Disable' : 'Enable'} Draft Mode</Button>\n     </form>\n   )\n }\n+\n+export function generateStaticParams() {\n+  return [{ mode: 'with-cookies' }, { mode: 'without-cookies' }]\n+}",
            "previous_filename": "test/e2e/app-dir/use-cache/app/(partially-static)/draft-mode/page.tsx"
        },
        {
            "sha": "9ef3f32739a4cf26bf3cee77178e0d1ce3022853",
            "filename": "test/e2e/app-dir/use-cache/use-cache.test.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 66,
            "changes": 131,
            "blob_url": "https://github.com/vercel/next.js/blob/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4e0b1125a466bdc81ead94969008c55509ea4ad0/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache%2Fuse-cache.test.ts?ref=4e0b1125a466bdc81ead94969008c55509ea4ad0",
            "patch": "@@ -134,37 +134,6 @@ describe('use-cache', () => {\n     )\n   })\n \n-  it('should error when cookies/headers/draftMode is used inside \"use cache\"', async () => {\n-    const browser = await next.browser('/errors')\n-\n-    await retry(async () => {\n-      expect(await browser.elementById('cookies').text()).toContain(\n-        isNextDev\n-          ? 'Route /errors used \"cookies\" inside \"use cache\".'\n-          : GENERIC_RSC_ERROR\n-      )\n-      expect(await browser.elementById('headers').text()).toContain(\n-        isNextDev\n-          ? 'Route /errors used \"headers\" inside \"use cache\".'\n-          : GENERIC_RSC_ERROR\n-      )\n-    })\n-\n-    expect(await browser.elementById('draft-mode').text()).toContain(\n-      'Editing: false'\n-    )\n-\n-    // CLI assertions are skipped in deploy mode because `next.cliOutput` will only contain build-time logs.\n-    if (!isNextDeploy) {\n-      expect(next.cliOutput).toContain(\n-        'Route /errors used \"cookies\" inside \"use cache\". '\n-      )\n-      expect(next.cliOutput).toContain(\n-        'Route /errors used \"headers\" inside \"use cache\". '\n-      )\n-    }\n-  })\n-\n   it('should cache results in route handlers', async () => {\n     const response = await next.fetch('/api')\n     const { rand1, rand2 } = await response.json()\n@@ -515,7 +484,8 @@ describe('use-cache', () => {\n           '/cache-tag',\n           '/directive-in-node-modules/with-handler',\n           '/directive-in-node-modules/without-handler',\n-          '/draft-mode',\n+          '/draft-mode/with-cookies',\n+          '/draft-mode/without-cookies',\n           '/form',\n           '/imported-from-client',\n           '/logs',\n@@ -771,46 +741,60 @@ describe('use-cache', () => {\n   })\n \n   describe('should not read nor write cached data when draft mode is enabled', () => {\n-    if (isNextDeploy) {\n-      // Wait for the background revalidation after the deployment to settle.\n-      beforeAll(async () => {\n-        const browser = await next.browser('/draft-mode')\n-        try {\n-          const initialTopLevelValue = await browser\n-            .elementById('top-level')\n-            .text()\n-          await retry(async () => {\n-            await browser.refresh()\n-\n-            expect(await browser.elementById('top-level').text()).not.toBe(\n-              initialTopLevelValue\n-            )\n-          })\n-        } finally {\n-          // we're not in a test, so the browser won't get cleaned up automatically.\n-          await browser.close()\n-        }\n-      })\n-    }\n-\n     it.each([\n-      { description: 'js enabled', disableJavaScript: false },\n-      { description: 'js disabled', disableJavaScript: true },\n-    ])('$description', async ({ disableJavaScript }) => {\n-      const browser = await next.browser('/draft-mode', {\n+      {\n+        description: 'js enabled, with cookies',\n+        disableJavaScript: false,\n+        mode: 'with-cookies',\n+      },\n+      {\n+        description: 'js disabled, with cookies',\n+        disableJavaScript: true,\n+        mode: 'with-cookies',\n+      },\n+      {\n+        description: 'js enabled, without cookies',\n+        disableJavaScript: false,\n+        mode: 'without-cookies',\n+      },\n+      {\n+        description: 'js disabled, without cookies',\n+        disableJavaScript: true,\n+        mode: 'without-cookies',\n+      },\n+    ])('$description', async ({ disableJavaScript, mode }) => {\n+      const pathname = `/draft-mode/${mode}`\n+\n+      const browser = await next.browser(pathname, {\n         // This test relies on a server action to set draft mode.\n         // To ensure that it works for both fetch actions and MPA actions,\n         // we test it with javascript disabled too.\n         // (this is because of a bug where draft mode status was not correctly propagated to the workStore for MPA actions)\n         disableJavaScript,\n+        pushErrorAsConsoleLog: true,\n       })\n \n+      if (isNextDeploy) {\n+        // Wait for the background revalidation after the deployment to settle.\n+        const initialTopLevelValue = await browser\n+          .elementById('top-level')\n+          .text()\n+\n+        await retry(async () => {\n+          await browser.refresh()\n+\n+          expect(await browser.elementById('top-level').text()).not.toBe(\n+            initialTopLevelValue\n+          )\n+        })\n+      }\n+\n       const refreshAfterServerAction = async () => {\n         if (disableJavaScript) {\n           // browser.refresh() seems to automatically resubmit POST requests,\n           // so if we submitted an MPA action, it'll trigger the action again,\n           // which in this case will toggle draftMode again.\n-          await browser.get(new URL('/draft-mode', next.url).href)\n+          await browser.get(new URL(pathname, next.url).href)\n         } else {\n           await browser.refresh()\n         }\n@@ -835,7 +819,29 @@ describe('use-cache', () => {\n         initialClosureValue\n       )\n \n+      // Enable draft mode.\n       await browser.elementByCss('button#toggle').click()\n+\n+      // When reading cookies, we expect an error.\n+      // TODO: Ideally this would be a compile-time error.\n+      if (mode === 'with-cookies') {\n+        return retry(async () => {\n+          const logs = await browser.log()\n+\n+          const expectedErrorMessage = disableJavaScript\n+            ? 'Failed to load resource: the server responded with a status of 500 (Internal Server Error)'\n+            : isNextDev\n+              ? 'Route /draft-mode/[mode] used \"cookies\" inside \"use cache\". Accessing Dynamic data sources inside a cache scope is not supported. If you need this data inside a cached function use \"cookies\" outside of the cached function and pass the required dynamic data in as an argument. See more info here: https://nextjs.org/docs/messages/next-request-in-use-cache'\n+              : GENERIC_RSC_ERROR\n+\n+          expect(logs).toMatchObject(\n+            expect.arrayContaining([\n+              { source: 'error', message: expectedErrorMessage },\n+            ])\n+          )\n+        })\n+      }\n+\n       await browser.waitForElementByCss('button#toggle:enabled')\n \n       expect(await browser.elementByCss('button#toggle').text()).toBe(\n@@ -862,13 +868,6 @@ describe('use-cache', () => {\n         newClosureValue\n       )\n \n-      // Accessing request-scoped data should still not be allowed.\n-      expect(\n-        await browser\n-          .elementById('is-accessing-request-scoped-data-allowed-in-use-cache')\n-          .text()\n-      ).toBe('false')\n-\n       await browser.elementByCss('button#toggle').click()\n       await browser.waitForElementByCss('button#toggle:enabled')\n "
        }
    ],
    "stats": {
        "total": 794,
        "additions": 601,
        "deletions": 193
    }
}