{
    "author": "mischnic",
    "message": "Turbopack: fix NFT of readFileSync of relative path (#84155)\n\nTests are missing\r\n\r\nPreviously, `readFileSync(\"./data/foo.txt\")` was relative to the current file, not relative to `process.cwd()`",
    "sha": "3abe25186f7868f0885e4950410d69d4edc53e20",
    "files": [
        {
            "sha": "56f94c94d83e0effdfdb7c40262f42737b7bf500",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -998,7 +998,7 @@ impl Project {\n         let this = self.await?;\n         Ok(get_server_compile_time_info(\n             // `/ROOT` corresponds to `[project]/`, so we need exactly the `path` part.\n-            format!(\"/ROOT/{}\", self.project_path().await?.path).into(),\n+            self.project_path(),\n             this.define_env.nodejs(),\n             self.current_node_js_version(),\n         ))"
        },
        {
            "sha": "109e635d184cb33d555c8448b5699915b0d1fe7a",
            "filename": "crates/next-core/src/next_server/context.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fcontext.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -358,7 +358,7 @@ async fn next_server_free_vars(define_env: Vc<OptionEnvMap>) -> Result<Vc<FreeVa\n \n #[turbo_tasks::function]\n pub async fn get_server_compile_time_info(\n-    cwd: RcStr,\n+    cwd: Vc<FileSystemPath>,\n     define_env: Vc<OptionEnvMap>,\n     node_version: ResolvedVc<NodeJsVersion>,\n ) -> Result<Vc<CompileTimeInfo>> {\n@@ -367,7 +367,7 @@ pub async fn get_server_compile_time_info(\n             NodeJsEnvironment {\n                 compile_target: CompileTarget::current().to_resolved().await?,\n                 node_version,\n-                cwd: ResolvedVc::cell(Some(cwd)),\n+                cwd: ResolvedVc::cell(Some(cwd.owned().await?)),\n             }\n             .resolved_cell(),\n         ))"
        },
        {
            "sha": "fc2a5559872f928261d2a407b84c72845b348ce2",
            "filename": "test/production/standalone-mode/node-modules/app/page.js",
            "status": "removed",
            "additions": 0,
            "deletions": 10,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/4350081689818d805dbe0b6ade4577b9061a3b16/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4350081689818d805dbe0b6ade4577b9061a3b16/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fapp%2Fpage.js?ref=4350081689818d805dbe0b6ade4577b9061a3b16",
            "patch": "@@ -1,10 +0,0 @@\n-import path from 'path'\n-\n-import 'foo'\n-\n-const projectDir = process.cwd()\n-path.join(projectDir, 'app', 'static-from-app.txt')\n-\n-export default function Page() {\n-  return 'hello'\n-}"
        },
        {
            "sha": "a76d4f0fddfe9e11f6d819cf1be379d40da6f398",
            "filename": "test/production/standalone-mode/node-modules/foo/index.js",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/4350081689818d805dbe0b6ade4577b9061a3b16/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/4350081689818d805dbe0b6ade4577b9061a3b16/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Ffoo%2Findex.js?ref=4350081689818d805dbe0b6ade4577b9061a3b16",
            "patch": "@@ -1,6 +0,0 @@\n-import path from 'path'\n-\n-const projectDir = process.cwd()\n-path.join(projectDir, 'app', 'static-from-pkg.txt')\n-\n-export default 'foo'"
        },
        {
            "sha": "a6badcb1852e0cf46c00a043d23e567e47a7bbc0",
            "filename": "test/production/standalone-mode/node-modules/node-modules.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 22,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/4350081689818d805dbe0b6ade4577b9061a3b16/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnode-modules.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4350081689818d805dbe0b6ade4577b9061a3b16/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnode-modules.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Fnode-modules%2Fnode-modules.test.ts?ref=4350081689818d805dbe0b6ade4577b9061a3b16",
            "patch": "@@ -1,22 +0,0 @@\n-import { nextTestSetup } from 'e2e-utils'\n-\n-describe('standalone mode - NFT in node_modules', () => {\n-  const dependencies = require('./package.json').dependencies\n-\n-  const { next, skipped } = nextTestSetup({\n-    files: __dirname,\n-    dependencies,\n-    skipDeployment: true,\n-  })\n-\n-  if (skipped) {\n-    return\n-  }\n-\n-  it('should not trace process.cwd calls in node_modules', async () => {\n-    let trace = await next.readJSON('.next/server/app/page.js.nft.json')\n-\n-    expect(trace.files).toContain('../../../app/static-from-app.txt')\n-    expect(trace.files).not.toContain('../../../app/static-from-pkg.txt')\n-  })\n-})"
        },
        {
            "sha": "0facb2f8c269ddfb2edd99e8263b568745136593",
            "filename": "test/production/standalone-mode/tracing/app/layout.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fapp%2Flayout.js?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "previous_filename": "test/production/standalone-mode/node-modules/app/layout.js"
        },
        {
            "sha": "54012bb78f9a0f1ccc35500e112388ee036d7e52",
            "filename": "test/production/standalone-mode/tracing/app/page.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fapp%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fapp%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fapp%2Fpage.js?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -0,0 +1,13 @@\n+import path from 'path'\n+\n+import 'foo'\n+\n+const projectDir = process.cwd()\n+path.join(projectDir, 'data', 'static-from-app-cwd.txt')\n+\n+path.join('data', 'static-from-app-rel-join.txt')\n+path.join('data', 'static-from-app-rel-read.txt')\n+\n+export default function Page() {\n+  return 'hello'\n+}"
        },
        {
            "sha": "ce013625030ba8dba906f756967f9e9ca394464a",
            "filename": "test/production/standalone-mode/tracing/data/static-from-app-cwd.txt",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-cwd.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-cwd.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-cwd.txt?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "previous_filename": "test/production/standalone-mode/node-modules/app/static-from-app.txt"
        },
        {
            "sha": "ce013625030ba8dba906f756967f9e9ca394464a",
            "filename": "test/production/standalone-mode/tracing/data/static-from-app-rel-join.txt",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-rel-join.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-rel-join.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-rel-join.txt?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "previous_filename": "test/production/standalone-mode/node-modules/app/static-from-pkg.txt"
        },
        {
            "sha": "ce013625030ba8dba906f756967f9e9ca394464a",
            "filename": "test/production/standalone-mode/tracing/data/static-from-app-rel-read.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-rel-read.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-rel-read.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-app-rel-read.txt?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -0,0 +1 @@\n+hello"
        },
        {
            "sha": "ce013625030ba8dba906f756967f9e9ca394464a",
            "filename": "test/production/standalone-mode/tracing/data/static-from-pkg.txt",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-pkg.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-pkg.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fdata%2Fstatic-from-pkg.txt?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -0,0 +1 @@\n+hello"
        },
        {
            "sha": "e69de29bb2d1d6434b8b29ae775ad8c2e48c5391",
            "filename": "test/production/standalone-mode/tracing/foo/foo.txt",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Ffoo.txt",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Ffoo.txt",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Ffoo.txt?ref=3abe25186f7868f0885e4950410d69d4edc53e20"
        },
        {
            "sha": "30b23bc2d726bf9da49ec766f7812325674ed8da",
            "filename": "test/production/standalone-mode/tracing/foo/index.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Findex.js?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -0,0 +1,10 @@\n+import path from 'path'\n+\n+const projectDir = process.cwd()\n+path.join(projectDir, 'data', 'static-from-pkg.txt')\n+path.join('data', 'static-from-pkg.txt')\n+\n+globalThis.myDirname = __dirname\n+path.join(globalThis.myDirname, 'foo.txt')\n+\n+export default 'foo'"
        },
        {
            "sha": "1aea491022211e28c1c4dd68868236fd015138a3",
            "filename": "test/production/standalone-mode/tracing/foo/package.json",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ffoo%2Fpackage.json?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "previous_filename": "test/production/standalone-mode/node-modules/foo/package.json"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/standalone-mode/tracing/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fnext.config.js?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "previous_filename": "test/production/standalone-mode/node-modules/next.config.js"
        },
        {
            "sha": "2511e3bc7558fc3f72727730a56cdf486f449e66",
            "filename": "test/production/standalone-mode/tracing/package.json",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Fpackage.json?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "previous_filename": "test/production/standalone-mode/node-modules/package.json"
        },
        {
            "sha": "913a37e1ab20e957265f2fb1b8b89ce0e9e76323",
            "filename": "test/production/standalone-mode/tracing/tracing.test.ts",
            "status": "added",
            "additions": 42,
            "deletions": 0,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ftracing.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ftracing.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fstandalone-mode%2Ftracing%2Ftracing.test.ts?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -0,0 +1,42 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('standalone mode - tracing', () => {\n+  const dependencies = require('./package.json').dependencies\n+\n+  const { next, skipped } = nextTestSetup({\n+    files: __dirname,\n+    dependencies,\n+    skipDeployment: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should trace process.cwd calls in node_modules', async () => {\n+    let trace = await next.readJSON('.next/server/app/page.js.nft.json')\n+\n+    // should trace process.cwd and relative calls relative to the root\n+    expect(trace.files).toContain('../../../data/static-from-app-cwd.txt')\n+    if (process.env.IS_TURBOPACK_TEST) {\n+      // Webpack doesn't trace these relative reference\n+      expect(trace.files).toContain(\n+        '../../../data/static-from-app-rel-join.txt'\n+      )\n+      expect(trace.files).toContain(\n+        '../../../data/static-from-app-rel-read.txt'\n+      )\n+    }\n+\n+    if (process.env.IS_TURBOPACK_TEST) {\n+      // Webpack doesn't trace these relative reference\n+      expect(trace.files).toContainEqual(\n+        expect.stringMatching(/.*\\/node_modules\\/foo\\/foo.txt/)\n+      )\n+    }\n+\n+    // should not trace process.cwd or relative calls in node_modules (only relative to file)\n+    expect(trace.files).not.toContain('../../../app/static-from-pkg.txt')\n+    expect(trace.files).not.toContain('../../../foo/foo.txt')\n+  })\n+})"
        },
        {
            "sha": "30351f3726cf995e5a9d84d13a37a1ed0bb1d9c0",
            "filename": "turbopack/crates/turbopack-core/src/environment.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fenvironment.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -9,6 +9,7 @@ use swc_core::ecma::preset_env::{Version, Versions};\n use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::{ResolvedVc, TaskInput, Vc};\n use turbo_tasks_env::ProcessEnv;\n+use turbo_tasks_fs::FileSystemPathOption;\n \n use crate::target::CompileTarget;\n \n@@ -213,7 +214,7 @@ impl Environment {\n     }\n \n     #[turbo_tasks::function]\n-    pub async fn cwd(&self) -> Result<Vc<Option<RcStr>>> {\n+    pub async fn cwd(&self) -> Result<Vc<FileSystemPathOption>> {\n         let env = self;\n         Ok(match env.execution {\n             ExecutionEnvironment::NodeJsBuildTime(env)\n@@ -258,7 +259,7 @@ pub struct NodeJsEnvironment {\n     pub compile_target: ResolvedVc<CompileTarget>,\n     pub node_version: ResolvedVc<NodeJsVersion>,\n     // user specified process.cwd\n-    pub cwd: ResolvedVc<Option<RcStr>>,\n+    pub cwd: ResolvedVc<FileSystemPathOption>,\n }\n \n impl Default for NodeJsEnvironment {"
        },
        {
            "sha": "8a429c017268a9d40aa9ebb433888096e4fc3ef7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/well_known.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fwell_known.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -15,7 +15,7 @@ use crate::analyzer::RequireContextValue;\n pub async fn replace_well_known(\n     value: JsValue,\n     compile_time_info: Vc<CompileTimeInfo>,\n-    define_process_cwd: bool,\n+    allow_project_root_tracing: bool,\n ) -> Result<(JsValue, bool)> {\n     Ok(match value {\n         JsValue::Call(_, box JsValue::WellKnownFunction(kind), args) => (\n@@ -24,7 +24,7 @@ pub async fn replace_well_known(\n                 JsValue::unknown_empty(false, \"this is not analyzed yet\"),\n                 args,\n                 compile_time_info,\n-                define_process_cwd,\n+                allow_project_root_tracing,\n             )\n             .await?,\n             true,\n@@ -69,7 +69,7 @@ pub async fn well_known_function_call(\n     _this: JsValue,\n     args: Vec<JsValue>,\n     compile_time_info: Vc<CompileTimeInfo>,\n-    define_process_cwd: bool,\n+    allow_project_root_tracing: bool,\n ) -> Result<JsValue> {\n     Ok(match kind {\n         WellKnownFunctionKind::ObjectAssign => object_assign(args),\n@@ -103,9 +103,10 @@ pub async fn well_known_function_call(\n             .as_str()\n             .into(),\n         WellKnownFunctionKind::ProcessCwd => {\n-            if define_process_cwd && let Some(cwd) = &*compile_time_info.environment().cwd().await?\n+            if allow_project_root_tracing\n+                && let Some(cwd) = &*compile_time_info.environment().cwd().await?\n             {\n-                cwd.clone().into()\n+                format!(\"/ROOT/{}\", cwd.path).into()\n             } else {\n                 JsValue::unknown(\n                     JsValue::call(Box::new(JsValue::WellKnownFunction(kind)), args),"
        },
        {
            "sha": "f66ce92ef286284a96819908c4a41f032c523a24",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/mod.rs",
            "status": "modified",
            "additions": 93,
            "deletions": 51,
            "changes": 144,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fmod.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -427,7 +427,10 @@ struct AnalysisState<'a> {\n     origin: ResolvedVc<Box<dyn ResolveOrigin>>,\n     compile_time_info: ResolvedVc<CompileTimeInfo>,\n     var_graph: &'a VarGraph,\n-    define_process_cwd: bool,\n+    /// Whether to allow tracing to reference files from the project root. This is used to prevent\n+    /// random node_modules packages from tracing the entire project due to some dynamic\n+    /// `path.join(foo, bar)` call.\n+    allow_project_root_tracing: bool,\n     /// This is the current state of known values of function\n     /// arguments.\n     fun_args_values: Mutex<FxHashMap<u32, Vec<JsValue>>>,\n@@ -460,7 +463,7 @@ impl AnalysisState<'_> {\n                     &self.free_var_references,\n                     self.var_graph,\n                     attributes,\n-                    self.define_process_cwd,\n+                    self.allow_project_root_tracing,\n                 )\n             },\n             &self.fun_args_values,\n@@ -962,7 +965,12 @@ pub async fn analyze_ecmascript_module_internal(\n             origin,\n             compile_time_info,\n             var_graph: &var_graph,\n-            define_process_cwd: !source.ident().path().await?.path.contains(\"/node_modules/\"),\n+            allow_project_root_tracing: !source\n+                .ident()\n+                .path()\n+                .await?\n+                .path\n+                .contains(\"/node_modules/\"),\n             fun_args_values: Default::default(),\n             var_cache: Default::default(),\n             first_import_meta: true,\n@@ -1606,6 +1614,7 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n         ignore_dynamic_requests,\n         url_rewrite_behavior,\n         collect_affecting_sources,\n+        allow_project_root_tracing,\n         ..\n     } = state;\n     fn explain_args(args: &[JsValue]) -> (String, String) {\n@@ -1722,6 +1731,18 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n         return Ok(());\n     }\n \n+    let get_traced_project_dir = async || {\n+        // readFileSync(\"./foo\") should always be relative to the project root, but this is\n+        // dangerous inside of node_modules as it can cause a lot of false positives in the\n+        // tracing, if some package does `path.join(dynamic)`, it would include everything from\n+        // the project root as well.\n+        if allow_project_root_tracing {\n+            compile_time_info.environment().cwd().owned().await\n+        } else {\n+            Ok(Some(source.ident().path().await?.parent()))\n+        }\n+    };\n+\n     match func {\n         JsValue::Alternatives {\n             total_nodes: _,\n@@ -1950,11 +1971,17 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                         return Ok(());\n                     }\n                 }\n-                analysis.add_reference(\n-                    FileSourceReference::new(*source, Pattern::new(pat), collect_affecting_sources)\n+                if let Some(context_dir) = get_traced_project_dir().await? {\n+                    analysis.add_reference(\n+                        FileSourceReference::new(\n+                            context_dir,\n+                            Pattern::new(pat),\n+                            collect_affecting_sources,\n+                        )\n                         .to_resolved()\n                         .await?,\n-                );\n+                    );\n+                }\n                 return Ok(());\n             }\n             let (args, hints) = explain_args(&args);\n@@ -1999,11 +2026,13 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                     return Ok(());\n                 }\n             }\n-            analysis.add_reference(\n-                FileSourceReference::new(*source, Pattern::new(pat), collect_affecting_sources)\n-                    .to_resolved()\n-                    .await?,\n-            );\n+            if let Some(context_dir) = get_traced_project_dir().await? {\n+                analysis.add_reference(\n+                    DirAssetReference::new(context_dir, Pattern::new(pat))\n+                        .to_resolved()\n+                        .await?,\n+                );\n+            }\n             return Ok(());\n         }\n \n@@ -2039,11 +2068,13 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                     return Ok(());\n                 }\n             }\n-            analysis.add_reference(\n-                DirAssetReference::new(*source, Pattern::new(pat))\n-                    .to_resolved()\n-                    .await?,\n-            );\n+            if let Some(context_dir) = get_traced_project_dir().await? {\n+                analysis.add_reference(\n+                    DirAssetReference::new(context_dir, Pattern::new(pat))\n+                        .to_resolved()\n+                        .await?,\n+                );\n+            }\n             return Ok(());\n         }\n         JsValue::WellKnownFunction(WellKnownFunctionKind::ChildProcessSpawnMethod(name))\n@@ -2087,10 +2118,12 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                 if dynamic {\n                     show_dynamic_warning = true;\n                 }\n-                if !dynamic || !ignore_dynamic_requests {\n+                if (!dynamic || !ignore_dynamic_requests)\n+                    && let Some(context_dir) = get_traced_project_dir().await?\n+                {\n                     analysis.add_reference(\n                         FileSourceReference::new(\n-                            *source,\n+                            context_dir,\n                             Pattern::new(pat),\n                             collect_affecting_sources,\n                         )\n@@ -2321,11 +2354,13 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                                     .await?;\n                                 js_value_to_pattern(&linked_func_call)\n                             };\n-                            analysis.add_reference(\n-                                DirAssetReference::new(*source, Pattern::new(abs_pattern))\n-                                    .to_resolved()\n-                                    .await?,\n-                            );\n+                            if let Some(context_dir) = get_traced_project_dir().await? {\n+                                analysis.add_reference(\n+                                    DirAssetReference::new(context_dir, Pattern::new(abs_pattern))\n+                                        .to_resolved()\n+                                        .await?,\n+                                );\n+                            }\n                             return Ok(());\n                         }\n                     }\n@@ -2384,11 +2419,13 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n                         .await?;\n                     js_value_to_pattern(&linked_func_call)\n                 };\n-                analysis.add_reference(\n-                    DirAssetReference::new(*source, Pattern::new(abs_pattern))\n-                        .to_resolved()\n-                        .await?,\n-                );\n+                if let Some(context_dir) = get_traced_project_dir().await? {\n+                    analysis.add_reference(\n+                        DirAssetReference::new(context_dir, Pattern::new(abs_pattern))\n+                            .to_resolved()\n+                            .await?,\n+                    );\n+                }\n                 return Ok(());\n             }\n             let (args, hints) = explain_args(&args);\n@@ -2436,27 +2473,32 @@ async fn handle_call<G: Fn(Vec<Effect>) + Send + Sync>(\n             if args.len() == 2\n                 && let Some(JsValue::Object { parts, .. }) = args.get(1)\n             {\n-                let resolved_dirs = parts\n-                    .iter()\n-                    .filter_map(|object_part| match object_part {\n-                        ObjectPart::KeyValue(\n-                            JsValue::Constant(key),\n-                            JsValue::Array { items: dirs, .. },\n-                        ) if key.as_str() == Some(\"includeDirs\") => {\n-                            Some(dirs.iter().filter_map(|dir| dir.as_str()))\n-                        }\n-                        _ => None,\n-                    })\n-                    .flatten()\n-                    .map(|dir| {\n-                        DirAssetReference::new(*source, Pattern::new(Pattern::Constant(dir.into())))\n+                if let Some(context_dir) = get_traced_project_dir().await? {\n+                    let resolved_dirs = parts\n+                        .iter()\n+                        .filter_map(|object_part| match object_part {\n+                            ObjectPart::KeyValue(\n+                                JsValue::Constant(key),\n+                                JsValue::Array { items: dirs, .. },\n+                            ) if key.as_str() == Some(\"includeDirs\") => {\n+                                Some(dirs.iter().filter_map(|dir| dir.as_str()))\n+                            }\n+                            _ => None,\n+                        })\n+                        .flatten()\n+                        .map(|dir| {\n+                            DirAssetReference::new(\n+                                context_dir.clone(),\n+                                Pattern::new(Pattern::Constant(dir.into())),\n+                            )\n                             .to_resolved()\n-                    })\n-                    .try_join()\n-                    .await?;\n+                        })\n+                        .try_join()\n+                        .await?;\n \n-                for resolved_dir_ref in resolved_dirs {\n-                    analysis.add_reference(resolved_dir_ref);\n+                    for resolved_dir_ref in resolved_dirs {\n+                        analysis.add_reference(resolved_dir_ref);\n+                    }\n                 }\n \n                 return Ok(());\n@@ -2929,7 +2971,7 @@ async fn value_visitor(\n     >,\n     var_graph: &VarGraph,\n     attributes: &ImportAttributes,\n-    define_process_cwd: bool,\n+    allow_project_root_tracing: bool,\n ) -> Result<(JsValue, bool)> {\n     let (mut v, modified) = value_visitor_inner(\n         origin,\n@@ -2938,7 +2980,7 @@ async fn value_visitor(\n         free_var_references,\n         var_graph,\n         attributes,\n-        define_process_cwd,\n+        allow_project_root_tracing,\n     )\n     .await?;\n     v.normalize_shallow();\n@@ -2955,7 +2997,7 @@ async fn value_visitor_inner(\n     >,\n     var_graph: &VarGraph,\n     attributes: &ImportAttributes,\n-    define_process_cwd: bool,\n+    allow_project_root_tracing: bool,\n ) -> Result<(JsValue, bool)> {\n     let ImportAttributes { ignore, .. } = *attributes;\n     // This check is just an optimization\n@@ -3082,7 +3124,7 @@ async fn value_visitor_inner(\n         }\n         _ => {\n             let (mut v, mut modified) =\n-                replace_well_known(v, compile_time_info, define_process_cwd).await?;\n+                replace_well_known(v, compile_time_info, allow_project_root_tracing).await?;\n             modified = replace_builtin(&mut v) || modified;\n             modified = modified || v.make_nested_operations_unknown();\n             return Ok((v, modified));"
        },
        {
            "sha": "944a0470bb85c95d7c87dfdbd87cc6ba4780748b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/node.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fnode.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fnode.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fnode.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -12,7 +12,6 @@ use turbopack_core::{\n         ModuleResolveResult, RequestKey,\n         pattern::{Pattern, PatternMatch, read_matches},\n     },\n-    source::Source,\n };\n \n #[turbo_tasks::value]\n@@ -58,20 +57,20 @@ impl ValueToString for PackageJsonReference {\n #[turbo_tasks::value]\n #[derive(Hash, Debug)]\n pub struct DirAssetReference {\n-    pub source: ResolvedVc<Box<dyn Source>>,\n+    pub context_dir: FileSystemPath,\n     pub path: ResolvedVc<Pattern>,\n }\n \n #[turbo_tasks::value_impl]\n impl DirAssetReference {\n     #[turbo_tasks::function]\n-    pub fn new(source: ResolvedVc<Box<dyn Source>>, path: ResolvedVc<Pattern>) -> Vc<Self> {\n-        Self::cell(DirAssetReference { source, path })\n+    pub fn new(context_dir: FileSystemPath, path: ResolvedVc<Pattern>) -> Vc<Self> {\n+        Self::cell(DirAssetReference { context_dir, path })\n     }\n }\n \n async fn resolve_reference_from_dir(\n-    parent_path: FileSystemPath,\n+    context_dir: FileSystemPath,\n     path: Vc<Pattern>,\n ) -> Result<Vc<ModuleResolveResult>> {\n     let path_ref = path.await?;\n@@ -83,7 +82,7 @@ async fn resolve_reference_from_dir(\n     let abs_matches = if let Some(abs_path) = &abs_path {\n         Some(\n             read_matches(\n-                parent_path.root().owned().await?,\n+                context_dir.root().owned().await?,\n                 rcstr!(\"/ROOT/\"),\n                 true,\n                 Pattern::new(abs_path.or_any_nested_file()),\n@@ -96,7 +95,7 @@ async fn resolve_reference_from_dir(\n     let rel_matches = if let Some(rel_path) = &rel_path {\n         Some(\n             read_matches(\n-                parent_path,\n+                context_dir,\n                 rcstr!(\"\"),\n                 true,\n                 Pattern::new(rel_path.or_any_nested_file()),\n@@ -149,12 +148,11 @@ async fn resolve_reference_from_dir(\n impl ModuleReference for DirAssetReference {\n     #[turbo_tasks::function]\n     async fn resolve_reference(&self) -> Result<Vc<ModuleResolveResult>> {\n-        let parent_path = self.source.ident().path().await?.parent();\n         let span = tracing::info_span!(\n             \"trace directory\",\n             pattern = display(self.path.to_string().await?)\n         );\n-        resolve_reference_from_dir(parent_path, *self.path)\n+        resolve_reference_from_dir(self.context_dir.clone(), *self.path)\n             .instrument(span)\n             .await\n     }"
        },
        {
            "sha": "6ea857725b5423d3a141a31006d5ce0805761b27",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/raw.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 9,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fraw.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fraw.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fraw.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -2,31 +2,31 @@ use anyhow::Result;\n use tracing::Instrument;\n use turbo_rcstr::RcStr;\n use turbo_tasks::{ResolvedVc, ValueToString, Vc};\n+use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::{\n     chunk::{ChunkableModuleReference, ChunkingType, ChunkingTypeOption},\n     reference::ModuleReference,\n     resolve::{ModuleResolveResult, pattern::Pattern, resolve_raw},\n-    source::Source,\n };\n \n #[turbo_tasks::value]\n #[derive(Hash, Debug)]\n pub struct FileSourceReference {\n-    pub source: ResolvedVc<Box<dyn Source>>,\n-    pub path: ResolvedVc<Pattern>,\n-    pub collect_affecting_sources: bool,\n+    context_dir: FileSystemPath,\n+    path: ResolvedVc<Pattern>,\n+    collect_affecting_sources: bool,\n }\n \n #[turbo_tasks::value_impl]\n impl FileSourceReference {\n     #[turbo_tasks::function]\n     pub fn new(\n-        source: ResolvedVc<Box<dyn Source>>,\n+        context_dir: FileSystemPath,\n         path: ResolvedVc<Pattern>,\n         collect_affecting_sources: bool,\n     ) -> Vc<Self> {\n         Self::cell(FileSourceReference {\n-            source,\n+            context_dir,\n             path,\n             collect_affecting_sources,\n         })\n@@ -37,15 +37,13 @@ impl FileSourceReference {\n impl ModuleReference for FileSourceReference {\n     #[turbo_tasks::function]\n     async fn resolve_reference(&self) -> Result<Vc<ModuleResolveResult>> {\n-        let context_dir = self.source.ident().path().await?.parent();\n-\n         let span = tracing::info_span!(\n             \"trace file\",\n             pattern = display(self.path.to_string().await?)\n         );\n         async {\n             resolve_raw(\n-                context_dir,\n+                self.context_dir.clone(),\n                 *self.path,\n                 self.collect_affecting_sources,\n                 /* force_in_lookup_dir */ false,"
        },
        {
            "sha": "8a45fdc9f08df80388c5d7afa78cde1f4160a227",
            "filename": "turbopack/crates/turbopack-tracing/tests/node-file-trace.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Fnode-file-trace.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -351,7 +351,11 @@ async fn node_file_trace_operation(\n \n     let source = FileSource::new(input);\n     let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n-        NodeJsEnvironment::default().resolved_cell(),\n+        NodeJsEnvironment {\n+            cwd: ResolvedVc::cell(Some(input_dir.join(\"tests/node-file-trace/integration\")?)),\n+            ..Default::default()\n+        }\n+        .resolved_cell(),\n     ));\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),"
        },
        {
            "sha": "9744aa725252a35e2e43851fd5eafbcdfefb9845",
            "filename": "turbopack/crates/turbopack-tracing/tests/unit.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3abe25186f7868f0885e4950410d69d4edc53e20/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tracing%2Ftests%2Funit.rs?ref=3abe25186f7868f0885e4950410d69d4edc53e20",
            "patch": "@@ -186,9 +186,13 @@ async fn node_file_trace_operation(package_root: RcStr, input: RcStr) -> Result<\n     let input_dir = workspace_fs.root().owned().await?;\n     let input = input_dir.join(&input)?;\n \n-    let source = FileSource::new(input);\n+    let source = FileSource::new(input.clone());\n     let environment = Environment::new(ExecutionEnvironment::NodeJsLambda(\n-        NodeJsEnvironment::default().resolved_cell(),\n+        NodeJsEnvironment {\n+            cwd: ResolvedVc::cell(Some(input.parent())),\n+            ..Default::default()\n+        }\n+        .resolved_cell(),\n     ));\n     let module_asset_context = ModuleAssetContext::new(\n         Default::default(),"
        }
    ],
    "stats": {
        "total": 317,
        "additions": 197,
        "deletions": 120
    }
}