{
    "author": "ijjk",
    "message": "Add postpone handling in app-page handler (#86101)\n\nThis adds the resume postpone handling into the `app-page` handler so it\ndoesn't rely on `base-server`.",
    "sha": "4050a8a3f745ce10f60bfcf33530d163fa20f1bb",
    "files": [
        {
            "sha": "68a2387bc561fb55e5604f70762ae817dbcfdc69",
            "filename": "packages/next/src/build/templates/app-page.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 4,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/4050a8a3f745ce10f60bfcf33530d163fa20f1bb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/4050a8a3f745ce10f60bfcf33530d163fa20f1bb/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-page.ts?ref=4050a8a3f745ce10f60bfcf33530d163fa20f1bb",
            "patch": "@@ -51,6 +51,7 @@ import {\n   CACHE_ONE_YEAR,\n   HTML_CONTENT_TYPE_HEADER,\n   NEXT_CACHE_TAGS_HEADER,\n+  NEXT_RESUME_HEADER,\n } from '../../lib/constants'\n import type { CacheControl } from '../../server/lib/cache-control'\n import { ENCODED_TAGS } from '../../server/stream-utils/encoded-tags'\n@@ -121,6 +122,10 @@ export async function handler(\n   if (routeModule.isDev) {\n     addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint())\n   }\n+  const isMinimalMode = Boolean(\n+    process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode')\n+  )\n+\n   let srcPage = 'VAR_DEFINITION_PAGE'\n \n   // turbopack doesn't normalize `/index` in the page name\n@@ -135,10 +140,6 @@ export async function handler(\n   const multiZoneDraftMode = process.env\n     .__NEXT_MULTI_ZONE_DRAFT_MODE as any as boolean\n \n-  const isMinimalMode = Boolean(\n-    process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode')\n-  )\n-\n   const prepareResult = await routeModule.prepare(req, res, {\n     srcPage,\n     multiZoneDraftMode,\n@@ -219,6 +220,25 @@ export async function handler(\n     nextConfig.experimental.ppr\n   )\n \n+  if (\n+    !getRequestMeta(req, 'postponed') &&\n+    couldSupportPPR &&\n+    req.headers[NEXT_RESUME_HEADER] === '1' &&\n+    req.method === 'POST'\n+  ) {\n+    // Decode the postponed state from the request body, it will come as\n+    // an array of buffers, so collect them and then concat them to form\n+    // the string.\n+\n+    const body: Array<Buffer> = []\n+    for await (const chunk of req) {\n+      body.push(chunk)\n+    }\n+    const postponed = Buffer.concat(body).toString('utf8')\n+\n+    addRequestMeta(req, 'postponed', postponed)\n+  }\n+\n   // When enabled, this will allow the use of the `?__nextppronly` query to\n   // enable debugging of the static shell.\n   const hasDebugStaticShellQuery ="
        }
    ],
    "stats": {
        "total": 28,
        "additions": 24,
        "deletions": 4
    }
}