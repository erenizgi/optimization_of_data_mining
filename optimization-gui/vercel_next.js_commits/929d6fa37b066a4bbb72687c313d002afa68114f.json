{
    "author": "gnoff",
    "message": "[Cache Components] Defer Request Data API resolution to another task in dev when it would suspend when prerendering (#82386)\n\nStacked on #82381\n\nWhen resolving these Request Data APIs in dev we now do so in a new\nTask. This allows the environment tracking to properly move stuff that\nwas previously in the Prerender environment to the Server environment\nwhen a Request Data API is used before them. This also has the nice side\neffect of causing these functions to appear as IO in the new\nsuspended-by features of React Devtools.\n\nIn Prod we don't need to do any additional delaying because the all of\nthe features this is designed to interact with are dev only.",
    "sha": "929d6fa37b066a4bbb72687c313d002afa68114f",
    "files": [
        {
            "sha": "8d01e4d1ba87b0e00741fb32e4ca48fe4142a4ee",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 10,
            "deletions": 7,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -1783,6 +1783,8 @@ async function renderToHTMLOrFlightImpl(\n       renderOpts.renderResumeDataCache ?? postponedState?.renderResumeDataCache\n \n     const rootParams = getRootParams(loaderTree, ctx.getDynamicParamFromSegment)\n+    const devValidatingFallbackParams =\n+      getRequestMeta(req, 'devValidatingFallbackParams') || null\n     const requestStore = createRequestStoreForRender(\n       req,\n       res,\n@@ -1793,7 +1795,8 @@ async function renderToHTMLOrFlightImpl(\n       renderOpts.previewProps,\n       isHmrRefresh,\n       serverComponentsHmrCache,\n-      renderResumeDataCache\n+      renderResumeDataCache,\n+      devValidatingFallbackParams\n     )\n \n     if (\n@@ -1865,7 +1868,8 @@ async function renderToHTMLOrFlightImpl(\n             notFoundLoaderTree,\n             formState,\n             postponedState,\n-            metadata\n+            metadata,\n+            devValidatingFallbackParams\n           )\n \n           return new RenderResult(stream, {\n@@ -1896,7 +1900,8 @@ async function renderToHTMLOrFlightImpl(\n       loaderTree,\n       formState,\n       postponedState,\n-      metadata\n+      metadata,\n+      devValidatingFallbackParams\n     )\n \n     // Invalid dynamic usages should only error the request in development.\n@@ -2079,7 +2084,8 @@ async function renderToStream(\n   tree: LoaderTree,\n   formState: any,\n   postponedState: PostponedState | null,\n-  metadata: AppPageRenderResultMetadata\n+  metadata: AppPageRenderResultMetadata,\n+  devValidatingFallbackParams: FallbackRouteParams | null\n ): Promise<ReadableStream<Uint8Array>> {\n   const { assetPrefix, nonce, pagePath, renderOpts } = ctx\n \n@@ -2226,9 +2232,6 @@ async function renderToStream(\n         }\n       )\n \n-      const devValidatingFallbackParams =\n-        getRequestMeta(req, 'devValidatingFallbackParams') || null\n-\n       spawnDynamicValidationInDev(\n         resolveValidation,\n         tree,"
        },
        {
            "sha": "4e8c42d21175a0e279681078cde95c882cb1b86d",
            "filename": "packages/next/src/server/app-render/work-unit-async-storage.external.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fwork-unit-async-storage.external.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -18,6 +18,7 @@ import type { Params } from '../request/params'\n import type { ImplicitTags } from '../lib/implicit-tags'\n import type { WorkStore } from './work-async-storage.external'\n import { NEXT_HMR_REFRESH_HASH_COOKIE } from '../../client/components/app-router-headers'\n+import { InvariantError } from '../../shared/lib/invariant-error'\n \n export type WorkUnitPhase = 'action' | 'render' | 'after'\n \n@@ -67,6 +68,7 @@ export interface RequestStore extends CommonWorkUnitStore {\n   // DEV-only\n   usedDynamic?: boolean\n   prerenderPhase?: boolean\n+  devFallbackParams?: FallbackRouteParams | null\n }\n \n /**\n@@ -335,6 +337,10 @@ export function throwForMissingRequestStore(callingExpression: string): never {\n   )\n }\n \n+export function throwInvariantForMissingStore(): never {\n+  throw new InvariantError('Expected workUnitAsyncStorage to have a store.')\n+}\n+\n export function getPrerenderResumeDataCache(\n   workUnitStore: WorkUnitStore\n ): PrerenderResumeDataCache | null {"
        },
        {
            "sha": "af17890120d1dc8d80c73c4f046e90720954b8bf",
            "filename": "packages/next/src/server/async-storage/request-store.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fasync-storage%2Frequest-store.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -24,6 +24,7 @@ import type { ServerComponentsHmrCache } from '../response-cache'\n import type { RenderResumeDataCache } from '../resume-data-cache/resume-data-cache'\n import type { Params } from '../request/params'\n import type { ImplicitTags } from '../lib/implicit-tags'\n+import type { FallbackRouteParams } from '../request/fallback-params'\n \n function getHeaders(headers: Headers | IncomingHttpHeaders): ReadonlyHeaders {\n   const cleaned = HeadersAdapter.from(headers)\n@@ -114,7 +115,8 @@ export function createRequestStoreForRender(\n   previewProps: WrapperRenderOpts['previewProps'],\n   isHmrRefresh: RequestContext['isHmrRefresh'],\n   serverComponentsHmrCache: RequestContext['serverComponentsHmrCache'],\n-  renderResumeDataCache: RenderResumeDataCache | undefined\n+  renderResumeDataCache: RenderResumeDataCache | undefined,\n+  devFallbackParams: FallbackRouteParams | null\n ): RequestStore {\n   return createRequestStoreImpl(\n     // Pages start in render phase by default\n@@ -128,7 +130,8 @@ export function createRequestStoreForRender(\n     renderResumeDataCache,\n     previewProps,\n     isHmrRefresh,\n-    serverComponentsHmrCache\n+    serverComponentsHmrCache,\n+    devFallbackParams\n   )\n }\n \n@@ -151,7 +154,8 @@ export function createRequestStoreForAPI(\n     undefined,\n     previewProps,\n     false,\n-    undefined\n+    undefined,\n+    null\n   )\n }\n \n@@ -166,7 +170,8 @@ function createRequestStoreImpl(\n   renderResumeDataCache: RenderResumeDataCache | undefined,\n   previewProps: WrapperRenderOpts['previewProps'],\n   isHmrRefresh: RequestContext['isHmrRefresh'],\n-  serverComponentsHmrCache: RequestContext['serverComponentsHmrCache']\n+  serverComponentsHmrCache: RequestContext['serverComponentsHmrCache'],\n+  devFallbackParams: FallbackRouteParams | null | undefined\n ): RequestStore {\n   function defaultOnUpdateCookies(cookies: string[]) {\n     if (res) {\n@@ -258,6 +263,7 @@ function createRequestStoreImpl(\n     serverComponentsHmrCache:\n       serverComponentsHmrCache ||\n       (globalThis as any).__serverComponentsHmrCache,\n+    devFallbackParams,\n   }\n }\n "
        },
        {
            "sha": "17e4fe608bd9701e4f8556f8dac62e742d1d08c0",
            "filename": "packages/next/src/server/dynamic-rendering-utils.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Fdynamic-rendering-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Fdynamic-rendering-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdynamic-rendering-utils.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -72,3 +72,14 @@ export function makeHangingPromise<T>(\n }\n \n function ignoreReject() {}\n+\n+export function makeDevtoolsIOAwarePromise<T>(underlying: T): Promise<T> {\n+  // in React DevTools if we resolve in a setTimeout we will observe\n+  // the promise resolution as something that can suspend a boundary or root.\n+  return new Promise<T>((resolve) => {\n+    // Must use setTimeout to be considered IO React DevTools. setImmediate will not work.\n+    setTimeout(() => {\n+      resolve(underlying)\n+    }, 0)\n+  })\n+}"
        },
        {
            "sha": "62a87eb0965ced70a509e6273d25b0457d348e2b",
            "filename": "packages/next/src/server/request/connection.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 4,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fconnection.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -1,12 +1,18 @@\n import { workAsyncStorage } from '../app-render/work-async-storage.external'\n-import { workUnitAsyncStorage } from '../app-render/work-unit-async-storage.external'\n+import {\n+  throwForMissingRequestStore,\n+  workUnitAsyncStorage,\n+} from '../app-render/work-unit-async-storage.external'\n import {\n   postponeWithTracking,\n   throwToInterruptStaticGeneration,\n   trackDynamicDataInDynamicRender,\n } from '../app-render/dynamic-rendering'\n import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n-import { makeHangingPromise } from '../dynamic-rendering-utils'\n+import {\n+  makeHangingPromise,\n+  makeDevtoolsIOAwarePromise,\n+} from '../dynamic-rendering-utils'\n import { isRequestAPICallableInsideAfter } from './utils'\n \n /**\n@@ -15,6 +21,7 @@ import { isRequestAPICallableInsideAfter } from './utils'\n  * During prerendering it will never resolve and during rendering it resolves immediately.\n  */\n export function connection(): Promise<void> {\n+  const callingExpression = 'connection'\n   const workStore = workAsyncStorage.getStore()\n   const workUnitStore = workUnitAsyncStorage.getStore()\n \n@@ -94,12 +101,20 @@ export function connection(): Promise<void> {\n           )\n         case 'request':\n           trackDynamicDataInDynamicRender(workUnitStore)\n-          break\n+          if (process.env.NODE_ENV === 'development') {\n+            // Semantically we only need the dev tracking when running in `next dev`\n+            // but since you would never use next dev with production NODE_ENV we use this\n+            // as a proxy so we can statically exclude this code from production builds.\n+            return makeDevtoolsIOAwarePromise(undefined)\n+          } else {\n+            return Promise.resolve(undefined)\n+          }\n         default:\n           workUnitStore satisfies never\n       }\n     }\n   }\n \n-  return Promise.resolve(undefined)\n+  // If we end up here, there was no work store or work unit store present.\n+  throwForMissingRequestStore(callingExpression)\n }"
        },
        {
            "sha": "191b7735fe4a687bb73c02912c8e1f6520140cdf",
            "filename": "packages/next/src/server/request/cookies.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 12,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fcookies.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -22,9 +22,11 @@ import {\n   trackSynchronousRequestDataAccessInDev,\n } from '../app-render/dynamic-rendering'\n import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n-import { makeHangingPromise } from '../dynamic-rendering-utils'\n+import {\n+  makeDevtoolsIOAwarePromise,\n+  makeHangingPromise,\n+} from '../dynamic-rendering-utils'\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n-import { scheduleImmediate } from '../../lib/scheduler'\n import { isRequestAPICallableInsideAfter } from './utils'\n import { InvariantError } from '../../shared/lib/invariant-error'\n import { ReflectAdapter } from '../web/spec-extension/adapters/reflect'\n@@ -143,10 +145,10 @@ export function cookies(): Promise<ReadonlyRequestCookies> {\n             underlyingCookies = workUnitStore.cookies\n           }\n \n-          if (\n-            process.env.NODE_ENV === 'development' &&\n-            !workStore?.isPrefetchRequest\n-          ) {\n+          if (process.env.NODE_ENV === 'development') {\n+            // Semantically we only need the dev tracking when running in `next dev`\n+            // but since you would never use next dev with production NODE_ENV we use this\n+            // as a proxy so we can statically exclude this code from production builds.\n             if (process.env.__NEXT_CACHE_COMPONENTS) {\n               return makeUntrackedCookiesWithDevWarnings(\n                 underlyingCookies,\n@@ -290,9 +292,7 @@ function makeUntrackedExoticCookiesWithDevWarnings(\n     return cachedCookies\n   }\n \n-  const promise = new Promise<ReadonlyRequestCookies>((resolve) =>\n-    scheduleImmediate(() => resolve(underlyingCookies))\n-  )\n+  const promise = makeDevtoolsIOAwarePromise(underlyingCookies)\n   CachedCookies.set(underlyingCookies, promise)\n \n   Object.defineProperties(promise, {\n@@ -443,9 +443,7 @@ function makeUntrackedCookiesWithDevWarnings(\n     return cachedCookies\n   }\n \n-  const promise = new Promise<ReadonlyRequestCookies>((resolve) =>\n-    scheduleImmediate(() => resolve(underlyingCookies))\n-  )\n+  const promise = makeDevtoolsIOAwarePromise(underlyingCookies)\n \n   const proxiedPromise = new Proxy(promise, {\n     get(target, prop, receiver) {"
        },
        {
            "sha": "bb5867073209e3c9c9a87fcd7dcb75f378d3cca0",
            "filename": "packages/next/src/server/request/headers.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 13,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fheaders.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -6,8 +6,8 @@ import {\n   workAsyncStorage,\n   type WorkStore,\n } from '../app-render/work-async-storage.external'\n-import { throwForMissingRequestStore } from '../app-render/work-unit-async-storage.external'\n import {\n+  throwForMissingRequestStore,\n   workUnitAsyncStorage,\n   type PrerenderStoreModern,\n } from '../app-render/work-unit-async-storage.external'\n@@ -18,9 +18,11 @@ import {\n   trackSynchronousRequestDataAccessInDev,\n } from '../app-render/dynamic-rendering'\n import { StaticGenBailoutError } from '../../client/components/static-generation-bailout'\n-import { makeHangingPromise } from '../dynamic-rendering-utils'\n+import {\n+  makeDevtoolsIOAwarePromise,\n+  makeHangingPromise,\n+} from '../dynamic-rendering-utils'\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n-import { scheduleImmediate } from '../../lib/scheduler'\n import { isRequestAPICallableInsideAfter } from './utils'\n import { InvariantError } from '../../shared/lib/invariant-error'\n import { ReflectAdapter } from '../web/spec-extension/adapters/reflect'\n@@ -153,10 +155,10 @@ export function headers(): Promise<ReadonlyHeaders> {\n         case 'request':\n           trackDynamicDataInDynamicRender(workUnitStore)\n \n-          if (\n-            process.env.NODE_ENV === 'development' &&\n-            !workStore?.isPrefetchRequest\n-          ) {\n+          if (process.env.NODE_ENV === 'development') {\n+            // Semantically we only need the dev tracking when running in `next dev`\n+            // but since you would never use next dev with production NODE_ENV we use this\n+            // as a proxy so we can statically exclude this code from production builds.\n             if (process.env.__NEXT_CACHE_COMPONENTS) {\n               return makeUntrackedHeadersWithDevWarnings(\n                 workUnitStore.headers,\n@@ -281,9 +283,7 @@ function makeUntrackedExoticHeadersWithDevWarnings(\n     return cachedHeaders\n   }\n \n-  const promise = new Promise<ReadonlyHeaders>((resolve) =>\n-    scheduleImmediate(() => resolve(underlyingHeaders))\n-  )\n+  const promise = makeDevtoolsIOAwarePromise(underlyingHeaders)\n \n   CachedHeaders.set(underlyingHeaders, promise)\n \n@@ -402,9 +402,7 @@ function makeUntrackedHeadersWithDevWarnings(\n     return cachedHeaders\n   }\n \n-  const promise = new Promise<ReadonlyHeaders>((resolve) =>\n-    scheduleImmediate(() => resolve(underlyingHeaders))\n-  )\n+  const promise = makeDevtoolsIOAwarePromise(underlyingHeaders)\n \n   const proxiedPromise = new Proxy(promise, {\n     get(target, prop, receiver) {"
        },
        {
            "sha": "09faab99fbc2fc2ce3e433e78da3b4f5a2acc487",
            "filename": "packages/next/src/server/request/params.ts",
            "status": "modified",
            "additions": 117,
            "deletions": 43,
            "changes": 160,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fparams.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -18,15 +18,19 @@ import {\n   type PrerenderStoreLegacy,\n   type StaticPrerenderStoreModern,\n   type StaticPrerenderStore,\n+  throwInvariantForMissingStore,\n+  type PrerenderStoreModernRuntime,\n } from '../app-render/work-unit-async-storage.external'\n import { InvariantError } from '../../shared/lib/invariant-error'\n import {\n   describeStringPropertyAccess,\n   wellKnownProperties,\n } from '../../shared/lib/utils/reflect-utils'\n-import { makeHangingPromise } from '../dynamic-rendering-utils'\n+import {\n+  makeDevtoolsIOAwarePromise,\n+  makeHangingPromise,\n+} from '../dynamic-rendering-utils'\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n-import { scheduleImmediate } from '../../lib/scheduler'\n import { dynamicAccessAsyncStorage } from '../app-render/dynamic-access-async-storage.external'\n \n export type ParamValue = string | Array<string> | undefined\n@@ -63,15 +67,19 @@ export type UnsafeUnwrappedParams<P> =\n export function createParamsFromClient(\n   underlyingParams: Params,\n   workStore: WorkStore\n-) {\n+): Promise<Params> {\n   const workUnitStore = workUnitAsyncStorage.getStore()\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n       case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n-        return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n+        return createStaticPrerenderParams(\n+          underlyingParams,\n+          workStore,\n+          workUnitStore\n+        )\n       case 'cache':\n       case 'private-cache':\n       case 'unstable-cache':\n@@ -83,12 +91,24 @@ export function createParamsFromClient(\n           'createParamsFromClient should not be called in a runtime prerender.'\n         )\n       case 'request':\n-        break\n+        if (process.env.NODE_ENV === 'development') {\n+          // Semantically we only need the dev tracking when running in `next dev`\n+          // but since you would never use next dev with production NODE_ENV we use this\n+          // as a proxy so we can statically exclude this code from production builds.\n+          const devFallbackParams = workUnitStore.devFallbackParams\n+          return createRenderParamsInDev(\n+            underlyingParams,\n+            devFallbackParams,\n+            workStore\n+          )\n+        } else {\n+          return createRenderParamsInProd(underlyingParams)\n+        }\n       default:\n         workUnitStore satisfies never\n     }\n   }\n-  return createRenderParams(underlyingParams, workStore)\n+  throwInvariantForMissingStore()\n }\n \n // generateMetadata always runs in RSC context so it is equivalent to a Server Page Component\n@@ -99,33 +119,46 @@ export const createServerParamsForMetadata = createServerParamsForServerSegment\n export function createServerParamsForRoute(\n   underlyingParams: Params,\n   workStore: WorkStore\n-) {\n+): Promise<Params> {\n   const workUnitStore = workUnitAsyncStorage.getStore()\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n       case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n-        return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n+        return createStaticPrerenderParams(\n+          underlyingParams,\n+          workStore,\n+          workUnitStore\n+        )\n       case 'cache':\n       case 'private-cache':\n       case 'unstable-cache':\n         throw new InvariantError(\n           'createServerParamsForRoute should not be called in cache contexts.'\n         )\n       case 'prerender-runtime':\n-        return delayUntilRuntimeStage(\n-          workUnitStore,\n-          createRenderParams(underlyingParams, workStore)\n-        )\n+        return createRuntimePrerenderParams(underlyingParams, workUnitStore)\n       case 'request':\n-        break\n+        if (process.env.NODE_ENV === 'development') {\n+          // Semantically we only need the dev tracking when running in `next dev`\n+          // but since you would never use next dev with production NODE_ENV we use this\n+          // as a proxy so we can statically exclude this code from production builds.\n+          const devFallbackParams = workUnitStore.devFallbackParams\n+          return createRenderParamsInDev(\n+            underlyingParams,\n+            devFallbackParams,\n+            workStore\n+          )\n+        } else {\n+          return createRenderParamsInProd(underlyingParams)\n+        }\n       default:\n         workUnitStore satisfies never\n     }\n   }\n-  return createRenderParams(underlyingParams, workStore)\n+  throwInvariantForMissingStore()\n }\n \n export function createServerParamsForServerSegment(\n@@ -139,25 +172,38 @@ export function createServerParamsForServerSegment(\n       case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n-        return createPrerenderParams(underlyingParams, workStore, workUnitStore)\n+        return createStaticPrerenderParams(\n+          underlyingParams,\n+          workStore,\n+          workUnitStore\n+        )\n       case 'cache':\n       case 'private-cache':\n       case 'unstable-cache':\n         throw new InvariantError(\n           'createServerParamsForServerSegment should not be called in cache contexts.'\n         )\n       case 'prerender-runtime':\n-        return delayUntilRuntimeStage(\n-          workUnitStore,\n-          createRenderParams(underlyingParams, workStore)\n-        )\n+        return createRuntimePrerenderParams(underlyingParams, workUnitStore)\n       case 'request':\n-        break\n+        if (process.env.NODE_ENV === 'development') {\n+          // Semantically we only need the dev tracking when running in `next dev`\n+          // but since you would never use next dev with production NODE_ENV we use this\n+          // as a proxy so we can statically exclude this code from production builds.\n+          const devFallbackParams = workUnitStore.devFallbackParams\n+          return createRenderParamsInDev(\n+            underlyingParams,\n+            devFallbackParams,\n+            workStore\n+          )\n+        } else {\n+          return createRenderParamsInProd(underlyingParams)\n+        }\n       default:\n         workUnitStore satisfies never\n     }\n   }\n-  return createRenderParams(underlyingParams, workStore)\n+  throwInvariantForMissingStore()\n }\n \n export function createPrerenderParamsForClientSegment(\n@@ -213,7 +259,7 @@ export function createPrerenderParamsForClientSegment(\n   return Promise.resolve(underlyingParams)\n }\n \n-function createPrerenderParams(\n+function createStaticPrerenderParams(\n   underlyingParams: Params,\n   workStore: WorkStore,\n   prerenderStore: StaticPrerenderStore\n@@ -268,29 +314,53 @@ function createPrerenderParams(\n   }\n }\n \n-function createRenderParams(\n+function createRuntimePrerenderParams(\n+  underlyingParams: Params,\n+  workUnitStore: PrerenderStoreModernRuntime\n+): Promise<Params> {\n+  return delayUntilRuntimeStage(\n+    workUnitStore,\n+    process.env.__NEXT_CACHE_COMPONENTS\n+      ? makeUntrackedParams(underlyingParams)\n+      : makeUntrackedExoticParams(underlyingParams)\n+  )\n+}\n+\n+function createRenderParamsInProd(underlyingParams: Params): Promise<Params> {\n+  if (process.env.__NEXT_CACHE_COMPONENTS) {\n+    return makeUntrackedParams(underlyingParams)\n+  }\n+\n+  return makeUntrackedExoticParams(underlyingParams)\n+}\n+\n+function createRenderParamsInDev(\n   underlyingParams: Params,\n+  devFallbackParams: FallbackRouteParams | null | undefined,\n   workStore: WorkStore\n ): Promise<Params> {\n-  if (process.env.NODE_ENV === 'development' && !workStore.isPrefetchRequest) {\n-    if (process.env.__NEXT_CACHE_COMPONENTS) {\n-      return makeDynamicallyTrackedParamsWithDevWarnings(\n-        underlyingParams,\n-        workStore\n-      )\n+  let hasFallbackParams = false\n+  if (devFallbackParams) {\n+    for (let key in underlyingParams) {\n+      if (devFallbackParams.has(key)) {\n+        hasFallbackParams = true\n+        break\n+      }\n     }\n-\n-    return makeDynamicallyTrackedExoticParamsWithDevWarnings(\n+  }\n+  if (process.env.__NEXT_CACHE_COMPONENTS) {\n+    return makeDynamicallyTrackedParamsWithDevWarnings(\n       underlyingParams,\n+      hasFallbackParams,\n       workStore\n     )\n-  } else {\n-    if (process.env.__NEXT_CACHE_COMPONENTS) {\n-      return makeUntrackedParams(underlyingParams)\n-    }\n-\n-    return makeUntrackedExoticParams(underlyingParams)\n   }\n+\n+  return makeDynamicallyTrackedExoticParamsWithDevWarnings(\n+    underlyingParams,\n+    hasFallbackParams,\n+    workStore\n+  )\n }\n \n interface CacheLifetime {}\n@@ -481,6 +551,7 @@ function makeUntrackedParams(underlyingParams: Params): Promise<Params> {\n \n function makeDynamicallyTrackedExoticParamsWithDevWarnings(\n   underlyingParams: Params,\n+  hasFallbackParams: boolean,\n   store: WorkStore\n ): Promise<Params> {\n   const cachedParams = CachedParams.get(underlyingParams)\n@@ -491,9 +562,10 @@ function makeDynamicallyTrackedExoticParamsWithDevWarnings(\n   // We don't use makeResolvedReactPromise here because params\n   // supports copying with spread and we don't want to unnecessarily\n   // instrument the promise with spreadable properties of ReactPromise.\n-  const promise = new Promise<Params>((resolve) =>\n-    scheduleImmediate(() => resolve(underlyingParams))\n-  )\n+  const promise = hasFallbackParams\n+    ? makeDevtoolsIOAwarePromise(underlyingParams)\n+    : // We don't want to force an environment transition when this params is not part of the fallback params set\n+      Promise.resolve(underlyingParams)\n \n   const proxiedProperties = new Set<string>()\n   const unproxiedProperties: Array<string> = []\n@@ -543,6 +615,7 @@ function makeDynamicallyTrackedExoticParamsWithDevWarnings(\n // logging the sync access without actually defining the params on the promise.\n function makeDynamicallyTrackedParamsWithDevWarnings(\n   underlyingParams: Params,\n+  hasFallbackParams: boolean,\n   store: WorkStore\n ): Promise<Params> {\n   const cachedParams = CachedParams.get(underlyingParams)\n@@ -553,9 +626,10 @@ function makeDynamicallyTrackedParamsWithDevWarnings(\n   // We don't use makeResolvedReactPromise here because params\n   // supports copying with spread and we don't want to unnecessarily\n   // instrument the promise with spreadable properties of ReactPromise.\n-  const promise = new Promise<Params>((resolve) =>\n-    scheduleImmediate(() => resolve(underlyingParams))\n-  )\n+  const promise = hasFallbackParams\n+    ? makeDevtoolsIOAwarePromise(underlyingParams)\n+    : // We don't want to force an environment transition when this params is not part of the fallback params set\n+      Promise.resolve(underlyingParams)\n \n   const proxiedProperties = new Set<string>()\n   const unproxiedProperties: Array<string> = []"
        },
        {
            "sha": "f405c44f1966bb7bd0a3fb92b454412e3a29a10e",
            "filename": "packages/next/src/server/request/pathname.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fpathname.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -7,6 +7,7 @@ import {\n } from '../app-render/dynamic-rendering'\n \n import {\n+  throwInvariantForMissingStore,\n   workUnitAsyncStorage,\n   type StaticPrerenderStore,\n } from '../app-render/work-unit-async-storage.external'\n@@ -43,12 +44,12 @@ export function createServerPathnameForMetadata(\n           createRenderPathname(underlyingPathname)\n         )\n       case 'request':\n-        break\n+        return createRenderPathname(underlyingPathname)\n       default:\n         workUnitStore satisfies never\n     }\n   }\n-  return createRenderPathname(underlyingPathname)\n+  throwInvariantForMissingStore()\n }\n \n function createPrerenderPathname("
        },
        {
            "sha": "456b068fd8f558fcfc1fd76197dce6f77af3af11",
            "filename": "packages/next/src/server/request/search-params.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 26,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequest%2Fsearch-params.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -15,10 +15,15 @@ import {\n   type PrerenderStoreLegacy,\n   type PrerenderStorePPR,\n   type PrerenderStoreModern,\n+  type PrerenderStoreModernRuntime,\n   type StaticPrerenderStore,\n+  throwInvariantForMissingStore,\n } from '../app-render/work-unit-async-storage.external'\n import { InvariantError } from '../../shared/lib/invariant-error'\n-import { makeHangingPromise } from '../dynamic-rendering-utils'\n+import {\n+  makeDevtoolsIOAwarePromise,\n+  makeHangingPromise,\n+} from '../dynamic-rendering-utils'\n import { createDedupedByCallsiteServerErrorLoggerDev } from '../create-deduped-by-callsite-server-error-logger'\n import {\n   describeStringPropertyAccess,\n@@ -29,7 +34,6 @@ import {\n   throwWithStaticGenerationBailoutErrorWithDynamicError,\n   throwForSearchParamsAccessInUseCache,\n } from './utils'\n-import { scheduleImmediate } from '../../lib/scheduler'\n \n export type SearchParams = { [key: string]: string | string[] | undefined }\n \n@@ -64,15 +68,15 @@ export type UnsafeUnwrappedSearchParams<P> =\n export function createSearchParamsFromClient(\n   underlyingSearchParams: SearchParams,\n   workStore: WorkStore\n-) {\n+): Promise<SearchParams> {\n   const workUnitStore = workUnitAsyncStorage.getStore()\n   if (workUnitStore) {\n     switch (workUnitStore.type) {\n       case 'prerender':\n       case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n-        return createPrerenderSearchParams(workStore, workUnitStore)\n+        return createStaticPrerenderSearchParams(workStore, workUnitStore)\n       case 'prerender-runtime':\n         throw new InvariantError(\n           'createSearchParamsFromClient should not be called in a runtime prerender.'\n@@ -84,12 +88,12 @@ export function createSearchParamsFromClient(\n           'createSearchParamsFromClient should not be called in cache contexts.'\n         )\n       case 'request':\n-        break\n+        return createRenderSearchParams(underlyingSearchParams, workStore)\n       default:\n         workUnitStore satisfies never\n     }\n   }\n-  return createRenderSearchParams(underlyingSearchParams, workStore)\n+  throwInvariantForMissingStore()\n }\n \n // generateMetadata always runs in RSC context so it is equivalent to a Server Page Component\n@@ -107,25 +111,25 @@ export function createServerSearchParamsForServerPage(\n       case 'prerender-client':\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n-        return createPrerenderSearchParams(workStore, workUnitStore)\n+        return createStaticPrerenderSearchParams(workStore, workUnitStore)\n       case 'cache':\n       case 'private-cache':\n       case 'unstable-cache':\n         throw new InvariantError(\n           'createServerSearchParamsForServerPage should not be called in cache contexts.'\n         )\n       case 'prerender-runtime':\n-        return delayUntilRuntimeStage(\n-          workUnitStore,\n-          createRenderSearchParams(underlyingSearchParams, workStore)\n+        return createRuntimePrerenderSearchParams(\n+          underlyingSearchParams,\n+          workUnitStore\n         )\n       case 'request':\n-        break\n+        return createRenderSearchParams(underlyingSearchParams, workStore)\n       default:\n         workUnitStore satisfies never\n     }\n   }\n-  return createRenderSearchParams(underlyingSearchParams, workStore)\n+  throwInvariantForMissingStore()\n }\n \n export function createPrerenderSearchParamsForClientPage(\n@@ -162,18 +166,15 @@ export function createPrerenderSearchParamsForClientPage(\n       case 'prerender-ppr':\n       case 'prerender-legacy':\n       case 'request':\n-        break\n+        return Promise.resolve({})\n       default:\n         workUnitStore satisfies never\n     }\n   }\n-  // We're prerendering in a mode that does not abort. We resolve the promise\n-  // without any tracking because we're just transporting a value from server to\n-  // client where the tracking will be applied.\n-  return Promise.resolve({})\n+  throwInvariantForMissingStore()\n }\n \n-function createPrerenderSearchParams(\n+function createStaticPrerenderSearchParams(\n   workStore: WorkStore,\n   prerenderStore: StaticPrerenderStore\n ): Promise<SearchParams> {\n@@ -198,6 +199,18 @@ function createPrerenderSearchParams(\n   }\n }\n \n+function createRuntimePrerenderSearchParams(\n+  underlyingSearchParams: SearchParams,\n+  workUnitStore: PrerenderStoreModernRuntime\n+): Promise<SearchParams> {\n+  return delayUntilRuntimeStage(\n+    workUnitStore,\n+    process.env.__NEXT_CACHE_COMPONENTS\n+      ? makeUntrackedSearchParams(underlyingSearchParams)\n+      : makeUntrackedExoticSearchParams(underlyingSearchParams)\n+  )\n+}\n+\n function createRenderSearchParams(\n   underlyingSearchParams: SearchParams,\n   workStore: WorkStore\n@@ -207,10 +220,10 @@ function createRenderSearchParams(\n     // dictionary object.\n     return Promise.resolve({})\n   } else {\n-    if (\n-      process.env.NODE_ENV === 'development' &&\n-      !workStore.isPrefetchRequest\n-    ) {\n+    if (process.env.NODE_ENV === 'development') {\n+      // Semantically we only need the dev tracking when running in `next dev`\n+      // but since you would never use next dev with production NODE_ENV we use this\n+      // as a proxy so we can statically exclude this code from production builds.\n       if (process.env.__NEXT_CACHE_COMPONENTS) {\n         return makeUntrackedSearchParamsWithDevWarnings(\n           underlyingSearchParams,\n@@ -633,9 +646,7 @@ function makeDynamicallyTrackedExoticSearchParamsWithDevWarnings(\n   // We don't use makeResolvedReactPromise here because searchParams\n   // supports copying with spread and we don't want to unnecessarily\n   // instrument the promise with spreadable properties of ReactPromise.\n-  const promise = new Promise<SearchParams>((resolve) =>\n-    scheduleImmediate(() => resolve(underlyingSearchParams))\n-  )\n+  const promise = makeDevtoolsIOAwarePromise(underlyingSearchParams)\n   promise.then(() => {\n     promiseInitialized = true\n   })\n@@ -736,7 +747,7 @@ function makeUntrackedSearchParamsWithDevWarnings(\n \n   const proxiedProperties = new Set<string>()\n   const unproxiedProperties: Array<string> = []\n-  const promise = Promise.resolve(underlyingSearchParams)\n+  const promise = makeDevtoolsIOAwarePromise(underlyingSearchParams)\n \n   Object.keys(underlyingSearchParams).forEach((prop) => {\n     if (wellKnownProperties.has(prop)) {"
        },
        {
            "sha": "c6dd7bd13a233dc74115848976dd73b4e599e4ce",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -1275,7 +1275,7 @@ describe('Cache Components Errors', () => {\n                [\n                  {\n                    \"description\": \"Route \"/sync-cookies-runtime\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-                   \"environmentLabel\": \"Prerender\",\n+                   \"environmentLabel\": \"Server\",\n                    \"label\": \"Console Error\",\n                    \"source\": \"app/sync-cookies-runtime/page.tsx (24:25) @ CookiesReadingComponent\n                > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n@@ -1287,7 +1287,7 @@ describe('Cache Components Errors', () => {\n                  },\n                  {\n                    \"description\": \"(0 , <turbopack-module-id>.cookies)(...).get is not a function\",\n-                   \"environmentLabel\": \"Prerender\",\n+                   \"environmentLabel\": \"Server\",\n                    \"label\": \"Runtime TypeError\",\n                    \"source\": \"app/sync-cookies-runtime/page.tsx (24:66) @ CookiesReadingComponent\n                > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n@@ -1303,7 +1303,7 @@ describe('Cache Components Errors', () => {\n                [\n                  {\n                    \"description\": \"Route \"/sync-cookies-runtime\" used \\`cookies().get\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-                   \"environmentLabel\": \"Prerender\",\n+                   \"environmentLabel\": \"Server\",\n                    \"label\": \"Console Error\",\n                    \"source\": \"app/sync-cookies-runtime/page.tsx (24:17) @ CookiesReadingComponent\n                > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n@@ -1315,7 +1315,7 @@ describe('Cache Components Errors', () => {\n                  },\n                  {\n                    \"description\": \"(0 , <webpack-module-id>.cookies)(...).get is not a function\",\n-                   \"environmentLabel\": \"Prerender\",\n+                   \"environmentLabel\": \"Server\",\n                    \"label\": \"Runtime TypeError\",\n                    \"source\": \"app/sync-cookies-runtime/page.tsx (24:66) @ CookiesReadingComponent\n                > 24 |   const token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n@@ -1592,7 +1592,7 @@ describe('Cache Components Errors', () => {\n                [\n                  {\n                    \"description\": \"Route \"/sync-headers-runtime\" used \\`headers().get\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-                   \"environmentLabel\": \"Prerender\",\n+                   \"environmentLabel\": \"Server\",\n                    \"label\": \"Console Error\",\n                    \"source\": \"app/sync-headers-runtime/page.tsx (24:29) @ HeadersReadingComponent\n                > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n@@ -1604,7 +1604,7 @@ describe('Cache Components Errors', () => {\n                  },\n                  {\n                    \"description\": \"(0 , <turbopack-module-id>.headers)(...).get is not a function\",\n-                   \"environmentLabel\": \"Prerender\",\n+                   \"environmentLabel\": \"Server\",\n                    \"label\": \"Runtime TypeError\",\n                    \"source\": \"app/sync-headers-runtime/page.tsx (24:70) @ HeadersReadingComponent\n                > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n@@ -1620,7 +1620,7 @@ describe('Cache Components Errors', () => {\n                [\n                  {\n                    \"description\": \"Route \"/sync-headers-runtime\" used \\`headers().get\\`. \\`headers()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n-                   \"environmentLabel\": \"Prerender\",\n+                   \"environmentLabel\": \"Server\",\n                    \"label\": \"Console Error\",\n                    \"source\": \"app/sync-headers-runtime/page.tsx (24:21) @ HeadersReadingComponent\n                > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get(\n@@ -1632,7 +1632,7 @@ describe('Cache Components Errors', () => {\n                  },\n                  {\n                    \"description\": \"(0 , <webpack-module-id>.headers)(...).get is not a function\",\n-                   \"environmentLabel\": \"Prerender\",\n+                   \"environmentLabel\": \"Server\",\n                    \"label\": \"Runtime TypeError\",\n                    \"source\": \"app/sync-headers-runtime/page.tsx (24:70) @ HeadersReadingComponent\n                > 24 |   const userAgent = (headers() as unknown as UnsafeUnwrappedHeaders).get("
        },
        {
            "sha": "3a8a10f7c2e9dbaebdfd42dc0420dfb7e7c1f9a1",
            "filename": "test/e2e/opentelemetry/instrumentation/opentelemetry.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/929d6fa37b066a4bbb72687c313d002afa68114f/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/929d6fa37b066a4bbb72687c313d002afa68114f/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fopentelemetry%2Finstrumentation%2Fopentelemetry.test.ts?ref=929d6fa37b066a4bbb72687c313d002afa68114f",
            "patch": "@@ -624,7 +624,7 @@ describe('opentelemetry', () => {\n                       },\n                       {\n                         attributes: {\n-                          'next.clientComponentLoadCount': isNextDev ? 9 : 8,\n+                          'next.clientComponentLoadCount': isNextDev ? 11 : 8,\n                           'next.span_type':\n                             'NextNodeServer.clientComponentLoading',\n                         },"
        }
    ],
    "stats": {
        "total": 363,
        "additions": 243,
        "deletions": 120
    }
}