{
    "author": "acdlite",
    "message": "[Segment Cache] Omit from bundle if flag disabled (#76622)\n\nAlternative to https://github.com/vercel/next.js/pull/76597.\n\nThis works by importing all Segment Cache related code through a single\nentry point (segment-cache.ts), and wrapping each export in a feature\nflag check.\n\nThis fixes the size regression in v15.2 but long term I don't love this\napproach. Since experimental flags are an essential part of our\nworkflow, we should establish a better pattern for dead code\nelimination. Ideally it would be done at the bundler level, like how\nReact's build process works. In the React repo, you don't even need to\nadd any extra configuration per experiment — if the code is not\nreachable, it gets stripped from the build automatically by Rollup. Or,\nshorter term, we could stub out experimental modules at build time by\nupdating the build config, i.e. a more automated version of what I'm\ndoing manually for this particular flag.",
    "sha": "e3f0a1ac9d656327294400483698e1b4110af499",
    "files": [
        {
            "sha": "57313bc8e8d7aeeef14713eed23affecc2fa54f4",
            "filename": ".vscode/settings.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/.vscode%2Fsettings.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/.vscode%2Fsettings.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.vscode%2Fsettings.json?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -61,7 +61,8 @@\n     \"packages/next/src/server/app-render/after-task-async-storage-instance.ts\",\n     \"packages/next/src/server/app-render/clean-async-snapshot-instance.ts\",\n     \"packages/next/src/server/app-render/work-async-storage-instance.ts\",\n-    \"packages/next/src/server/app-render/work-unit-async-storage-instance.ts\"\n+    \"packages/next/src/server/app-render/work-unit-async-storage-instance.ts\",\n+    \"packages/next/src/client/components/segment-cache-impl/*\"\n   ],\n   // Disable TypeScript surveys.\n   \"typescript.surveys.enabled\": false,"
        },
        {
            "sha": "db893689ed1630d6b39f692789c572e5471dea87",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -651,5 +651,6 @@\n   \"650\": \"experimental.nodeMiddleware\",\n   \"651\": \"Unexpected module type %s\",\n   \"652\": \"Expected cached value for cache key %s not to be a %s kind, got \\\"FETCH\\\" instead.\",\n-  \"653\": \"Expected cached value for cache key %s to be a \\\"FETCH\\\" kind, got %s instead.\"\n+  \"653\": \"Expected cached value for cache key %s to be a \\\"FETCH\\\" kind, got %s instead.\",\n+  \"654\": \"Segment Cache experiment is not enabled. This is a bug in Next.js.\"\n }"
        },
        {
            "sha": "8965d87c7f7696ae8e12f7fb832ddf2e6f7043c0",
            "filename": "packages/next/src/client/app-dir/form.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Fform.tsx?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -16,10 +16,7 @@ import {\n   hasUnsupportedSubmitterAttributes,\n   type FormProps,\n } from '../form-shared'\n-import {\n-  mountLinkInstance,\n-  unmountLinkInstance,\n-} from '../components/segment-cache/links'\n+import { mountLinkInstance, unmountLinkInstance } from '../components/links'\n \n export type { FormProps }\n "
        },
        {
            "sha": "22593e1d28c0b5e9824e87f5eda6c4dd96fcbc74",
            "filename": "packages/next/src/client/app-dir/link.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-dir%2Flink.tsx?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -16,7 +16,7 @@ import {\n   mountLinkInstance,\n   onNavigationIntent,\n   unmountLinkInstance,\n-} from '../components/segment-cache/links'\n+} from '../components/links'\n \n type Url = string | UrlObject\n type RequiredKeys<T> = {"
        },
        {
            "sha": "3a173f34f77ffc519c2f86e322ecd48b0434a9f8",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -58,11 +58,11 @@ import type { FlightRouterState } from '../../server/app-render/types'\n import { useNavFailureHandler } from './nav-failure-handler'\n import { useServerActionDispatcher } from '../app-call-server'\n import type { AppRouterActionQueue } from '../../shared/lib/router/action-queue'\n-import { prefetch as prefetchWithSegmentCache } from '../components/segment-cache/prefetch'\n+import { prefetch as prefetchWithSegmentCache } from './segment-cache'\n import { getRedirectTypeFromError, getURLFromRedirectError } from './redirect'\n import { isRedirectError, RedirectType } from './redirect-error'\n import { prefetchReducer } from './router-reducer/reducers/prefetch-reducer'\n-import { pingVisibleLinks } from './segment-cache/links'\n+import { pingVisibleLinks } from './links'\n \n const globalMutable: {\n   pendingMpaPath?: string"
        },
        {
            "sha": "3117f215ac6a5c907609fbb8d38c4029580f8430",
            "filename": "packages/next/src/client/components/links.ts",
            "status": "renamed",
            "additions": 8,
            "deletions": 8,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flinks.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -1,17 +1,17 @@\n-import type { FlightRouterState } from '../../../server/app-render/types'\n-import type { AppRouterInstance } from '../../../shared/lib/app-router-context.shared-runtime'\n-import { getCurrentAppRouterState } from '../../../shared/lib/router/action-queue'\n-import { createPrefetchURL } from '../app-router'\n-import { PrefetchKind } from '../router-reducer/router-reducer-types'\n-import { getCurrentCacheVersion } from './cache'\n-import { createCacheKey } from './cache-key'\n+import type { FlightRouterState } from '../../server/app-render/types'\n+import type { AppRouterInstance } from '../../shared/lib/app-router-context.shared-runtime'\n+import { getCurrentAppRouterState } from '../../shared/lib/router/action-queue'\n+import { createPrefetchURL } from './app-router'\n+import { PrefetchKind } from './router-reducer/router-reducer-types'\n+import { getCurrentCacheVersion } from './segment-cache'\n+import { createCacheKey } from './segment-cache'\n import {\n   type PrefetchTask,\n   PrefetchPriority,\n   schedulePrefetchTask as scheduleSegmentPrefetchTask,\n   cancelPrefetchTask,\n   bumpPrefetchTask,\n-} from './scheduler'\n+} from './segment-cache'\n \n type LinkElement = HTMLAnchorElement | SVGAElement | HTMLFormElement\n ",
            "previous_filename": "packages/next/src/client/components/segment-cache/links.ts"
        },
        {
            "sha": "717abecdf435bf23ebd5e428e290d62952e839d8",
            "filename": "packages/next/src/client/components/router-reducer/reducers/navigate-reducer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fnavigate-reducer.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -32,7 +32,7 @@ import {\n   navigate as navigateUsingSegmentCache,\n   NavigationResultTag,\n   type NavigationResult,\n-} from '../../segment-cache/navigation'\n+} from '../../segment-cache'\n \n export function handleExternalUrl(\n   state: ReadonlyReducerState,\n@@ -203,9 +203,6 @@ export function navigateReducer(\n     // Temporary glue code between the router reducer and the new navigation\n     // implementation. Eventually we'll rewrite the router reducer to a\n     // state machine.\n-    // TODO: Currently this always returns an async result, but in the future\n-    // it will return a sync result if the navigation was prefetched. Hence\n-    // a result type that's more complicated than you might expect.\n     const result = navigateUsingSegmentCache(\n       url,\n       state.cache,"
        },
        {
            "sha": "74a4a0757e70330e02213a5b760191db4f5f326b",
            "filename": "packages/next/src/client/components/router-reducer/reducers/prefetch-reducer.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fprefetch-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fprefetch-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fprefetch-reducer.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -8,7 +8,6 @@ import {\n   getOrCreatePrefetchCacheEntry,\n   prunePrefetchCache,\n } from '../prefetch-cache-utils'\n-\n export const prefetchQueue = new PromiseQueue(5)\n \n export const prefetchReducer = process.env.__NEXT_CLIENT_SEGMENT_CACHE"
        },
        {
            "sha": "6f1e2dc02cedccba1448e30a5a74058e5cc3444e",
            "filename": "packages/next/src/client/components/router-reducer/reducers/refresh-reducer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Frefresh-reducer.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -16,7 +16,7 @@ import { createEmptyCacheNode } from '../../app-router'\n import { handleSegmentMismatch } from '../handle-segment-mismatch'\n import { hasInterceptionRouteInCurrentTree } from './has-interception-route-in-current-tree'\n import { refreshInactiveParallelSegments } from '../refetch-inactive-parallel-segments'\n-import { revalidateEntireCache } from '../../segment-cache/cache'\n+import { revalidateEntireCache } from '../../segment-cache'\n \n export function refreshReducer(\n   state: ReadonlyReducerState,"
        },
        {
            "sha": "c5979a1af831c1b73c08aa4b56267f0086d24f82",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -56,7 +56,7 @@ import {\n   extractInfoFromServerReferenceId,\n   omitUnusedArgs,\n } from '../../../../shared/lib/server-reference-info'\n-import { revalidateEntireCache } from '../../segment-cache/cache'\n+import { revalidateEntireCache } from '../../segment-cache'\n \n type FetchServerActionResult = {\n   redirectLocation: URL | undefined"
        },
        {
            "sha": "1c55b46f193d591d254f4dd75a59a6410b923737",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache-key.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache-key.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache-key.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache-key.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "previous_filename": "packages/next/src/client/components/segment-cache/cache-key.ts"
        },
        {
            "sha": "41c4d5abfd7fb5c9e2ffd7ffe39666c8fc50ef7f",
            "filename": "packages/next/src/client/components/segment-cache-impl/cache.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fcache.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -52,7 +52,7 @@ import type {\n } from '../../../server/app-render/types'\n import { normalizeFlightData } from '../../flight-data-helpers'\n import { STATIC_STALETIME_MS } from '../router-reducer/prefetch-cache-utils'\n-import { pingVisibleLinks } from './links'\n+import { pingVisibleLinks } from '../links'\n \n // A note on async/await when working in the prefetch cache:\n //",
            "previous_filename": "packages/next/src/client/components/segment-cache/cache.ts"
        },
        {
            "sha": "cbc47587a5fffd319a027bd3b246d39433d2dcee",
            "filename": "packages/next/src/client/components/segment-cache-impl/lru.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Flru.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Flru.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Flru.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "previous_filename": "packages/next/src/client/components/segment-cache/lru.ts"
        },
        {
            "sha": "3f9ae1e6319617d3e5c7b967b0bb63eeb010aa5f",
            "filename": "packages/next/src/client/components/segment-cache-impl/navigation.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fnavigation.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -24,13 +24,7 @@ import {\n   type RouteTree,\n } from './cache'\n import { createCacheKey } from './cache-key'\n-\n-export const enum NavigationResultTag {\n-  MPA,\n-  Success,\n-  NoOp,\n-  Async,\n-}\n+import { NavigationResultTag } from '../segment-cache'\n \n type MPANavigationResult = {\n   tag: NavigationResultTag.MPA",
            "previous_filename": "packages/next/src/client/components/segment-cache/navigation.ts"
        },
        {
            "sha": "0942a4f543f9e3f2cee13d41665f8a41f694d57b",
            "filename": "packages/next/src/client/components/segment-cache-impl/prefetch.ts",
            "status": "renamed",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fprefetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fprefetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fprefetch.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -1,7 +1,8 @@\n import type { FlightRouterState } from '../../../server/app-render/types'\n-import { createPrefetchURL } from '../../components/app-router'\n+import { createPrefetchURL } from '../app-router'\n import { createCacheKey } from './cache-key'\n-import { schedulePrefetchTask, PrefetchPriority } from './scheduler'\n+import { schedulePrefetchTask } from './scheduler'\n+import { PrefetchPriority } from '../segment-cache'\n \n /**\n  * Entrypoint for prefetching a URL into the Segment Cache.",
            "previous_filename": "packages/next/src/client/components/segment-cache/prefetch.ts"
        },
        {
            "sha": "8d48899a5bde576533ef9edf6a4f7b46329fa519",
            "filename": "packages/next/src/client/components/segment-cache-impl/scheduler.ts",
            "status": "renamed",
            "additions": 1,
            "deletions": 21,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fscheduler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fscheduler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Fscheduler.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -25,6 +25,7 @@ import {\n   resetRevalidatingSegmentEntry,\n } from './cache'\n import type { RouteCacheKey } from './cache-key'\n+import { PrefetchPriority } from '../segment-cache'\n \n const scheduleMicrotask =\n   typeof queueMicrotask === 'function'\n@@ -136,27 +137,6 @@ const enum PrefetchTaskExitStatus {\n   Done,\n }\n \n-/**\n- * The priority of the prefetch task. Higher numbers are higher priority.\n- */\n-export const enum PrefetchPriority {\n-  /**\n-   * Assigned to any visible link that was hovered/touched at some point. This\n-   * is not removed on mouse exit, because a link that was momentarily\n-   * hovered is more likely to to be interacted with than one that was not.\n-   */\n-  Intent = 2,\n-  /**\n-   * The default priority for prefetch tasks.\n-   */\n-  Default = 1,\n-  /**\n-   * Assigned to tasks when they spawn non-blocking background work, like\n-   * revalidating a partially cached entry to see if more data is available.\n-   */\n-  Background = 0,\n-}\n-\n /**\n  * Prefetch tasks are processed in two phases: first the route tree is fetched,\n  * then the segments. We use this to priortize tasks that have not yet fetched",
            "previous_filename": "packages/next/src/client/components/segment-cache/scheduler.ts"
        },
        {
            "sha": "d78ba1b1727a2cb56c7dc587095acad36851cea1",
            "filename": "packages/next/src/client/components/segment-cache-impl/tuple-map.ts",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Ftuple-map.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Ftuple-map.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache-impl%2Ftuple-map.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "previous_filename": "packages/next/src/client/components/segment-cache/tuple-map.ts"
        },
        {
            "sha": "e776efe4d3eac3a00ea61b2891783ad01f0d655b",
            "filename": "packages/next/src/client/components/segment-cache.ts",
            "status": "added",
            "additions": 126,
            "deletions": 0,
            "changes": 126,
            "blob_url": "https://github.com/vercel/next.js/blob/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e3f0a1ac9d656327294400483698e1b4110af499/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fsegment-cache.ts?ref=e3f0a1ac9d656327294400483698e1b4110af499",
            "patch": "@@ -0,0 +1,126 @@\n+/**\n+ * Entry point to the Segment Cache implementation.\n+ *\n+ * All code related to the Segment Cache lives `segment-cache-impl` directory.\n+ * Callers access it through this indirection.\n+ *\n+ * This is to ensure the code is dead code eliminated from the bundle if the\n+ * flag is disabled.\n+ *\n+ * TODO: This is super tedious. Since experimental flags are an essential part\n+ * of our workflow, we should establish a better pattern for dead code\n+ * elimination. Ideally it would be done at the bundler level, like how React's\n+ * build process works. In the React repo, you don't even need to add any extra\n+ * configuration per experiment — if the code is not reachable, it gets stripped\n+ * from the build automatically by Rollup. Or, shorter term, we could stub out\n+ * experimental modules at build time by updating the build config, i.e. a more\n+ * automated version of what I'm doing manually in this file.\n+ */\n+\n+export type { NavigationResult } from './segment-cache-impl/navigation'\n+export type { PrefetchTask } from './segment-cache-impl/scheduler'\n+\n+const notEnabled: any = () => {\n+  throw new Error(\n+    'Segment Cache experiment is not enabled. This is a bug in Next.js.'\n+  )\n+}\n+\n+export const prefetch: typeof import('./segment-cache-impl/prefetch').prefetch =\n+  process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? function (...args) {\n+        return require('./segment-cache-impl/prefetch').prefetch(...args)\n+      }\n+    : notEnabled\n+\n+export const navigate: typeof import('./segment-cache-impl/navigation').navigate =\n+  process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? function (...args) {\n+        return require('./segment-cache-impl/navigation').navigate(...args)\n+      }\n+    : notEnabled\n+\n+export const revalidateEntireCache: typeof import('./segment-cache-impl/cache').revalidateEntireCache =\n+  process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? function (...args) {\n+        return require('./segment-cache-impl/cache').revalidateEntireCache(\n+          ...args\n+        )\n+      }\n+    : notEnabled\n+\n+export const getCurrentCacheVersion: typeof import('./segment-cache-impl/cache').getCurrentCacheVersion =\n+  process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? function (...args) {\n+        return require('./segment-cache-impl/cache').getCurrentCacheVersion(\n+          ...args\n+        )\n+      }\n+    : notEnabled\n+\n+export const schedulePrefetchTask: typeof import('./segment-cache-impl/scheduler').schedulePrefetchTask =\n+  process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? function (...args) {\n+        return require('./segment-cache-impl/scheduler').schedulePrefetchTask(\n+          ...args\n+        )\n+      }\n+    : notEnabled\n+\n+export const cancelPrefetchTask: typeof import('./segment-cache-impl/scheduler').cancelPrefetchTask =\n+  process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? function (...args) {\n+        return require('./segment-cache-impl/scheduler').cancelPrefetchTask(\n+          ...args\n+        )\n+      }\n+    : notEnabled\n+\n+export const bumpPrefetchTask: typeof import('./segment-cache-impl/scheduler').bumpPrefetchTask =\n+  process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? function (...args) {\n+        return require('./segment-cache-impl/scheduler').bumpPrefetchTask(\n+          ...args\n+        )\n+      }\n+    : notEnabled\n+\n+export const createCacheKey: typeof import('./segment-cache-impl/cache-key').createCacheKey =\n+  process.env.__NEXT_CLIENT_SEGMENT_CACHE\n+    ? function (...args) {\n+        return require('./segment-cache-impl/cache-key').createCacheKey(...args)\n+      }\n+    : notEnabled\n+\n+/**\n+ * Below are public constants. They're small enough that we don't need to\n+ * DCE them.\n+ */\n+\n+export const enum NavigationResultTag {\n+  MPA,\n+  Success,\n+  NoOp,\n+  Async,\n+}\n+\n+/**\n+ * The priority of the prefetch task. Higher numbers are higher priority.\n+ */\n+export const enum PrefetchPriority {\n+  /**\n+   * Assigned to any visible link that was hovered/touched at some point. This\n+   * is not removed on mouse exit, because a link that was momentarily\n+   * hovered is more likely to to be interacted with than one that was not.\n+   */\n+  Intent = 2,\n+  /**\n+   * The default priority for prefetch tasks.\n+   */\n+  Default = 1,\n+  /**\n+   * Assigned to tasks when they spawn non-blocking background work, like\n+   * revalidating a partially cached entry to see if more data is available.\n+   */\n+  Background = 0,\n+}"
        }
    ],
    "stats": {
        "total": 206,
        "additions": 151,
        "deletions": 55
    }
}