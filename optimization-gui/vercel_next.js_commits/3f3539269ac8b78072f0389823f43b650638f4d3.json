{
    "author": "lukesandberg",
    "message": "[turbopack] Fix the stubbed out implementation of `signature`  so that it works in a web worker. (#79509)\n\n## What\nFix the stubbed out runtime hook for react HMR to correctly support both the `register` and `signature` APIs, by moving the stubs into the runtime directly.  This way TSC can tell us we failed to uphold the function signature.\n\n## Why\n\nThe `swc` react transform looks for certain naming conventions and function signatures to register top level items for HMR.  However, if a module is loaded in a web worker the react hooks are not installed.  We could potentially try to avoid running the react transform on modules loaded in workers but as a dev-only transform this might actually be slower (for shared modules).  So instead we just supply an alternate fake implementation.",
    "sha": "3f3539269ac8b78072f0389823f43b650638f4d3",
    "files": [
        {
            "sha": "30e8286f3e774e3aea7c4e7777607f7b5b9305cb",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/js/src/browser/runtime/base/dev-base.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 24,
            "changes": 45,
            "blob_url": "https://github.com/vercel/next.js/blob/3f3539269ac8b78072f0389823f43b650638f4d3/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fdev-base.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3f3539269ac8b78072f0389823f43b650638f4d3/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fdev-base.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fdev-base.ts?ref=3f3539269ac8b78072f0389823f43b650638f4d3",
            "patch": "@@ -129,15 +129,6 @@ const getOrInstantiateModuleFromParent: GetOrInstantiateModuleFromParent<\n   })\n }\n \n-function getDevWorkerBlobURL(chunks: ChunkPath[]) {\n-  return getWorkerBlobURL(\n-    chunks,\n-    `// noop fns to prevent runtime errors during initialization\n-self.$RefreshReg$ = function() {};\n-self.$RefreshSig$ = function() {};`\n-  )\n-}\n-\n // @ts-ignore Defined in `runtime-base.ts`\n function instantiateModule(id: ModuleId, source: SourceInfo): Module {\n   const moduleFactory = moduleFactories[id]\n@@ -229,7 +220,7 @@ function instantiateModule(id: ModuleId, source: SourceInfo): Module {\n           U: relativeURL,\n           k: refresh,\n           R: createResolvePathFromModule(r),\n-          b: getDevWorkerBlobURL,\n+          b: getWorkerBlobURL,\n           z: requireStub,\n         })\n       )\n@@ -257,22 +248,28 @@ function runModuleExecutionHooks(\n   module: Module,\n   executeModule: (ctx: RefreshContext) => void\n ) {\n-  const cleanupReactRefreshIntercept =\n-    typeof globalThis.$RefreshInterceptModuleExecution$ === 'function'\n-      ? globalThis.$RefreshInterceptModuleExecution$(module.id)\n-      : () => {}\n-\n-  try {\n+  if (typeof globalThis.$RefreshInterceptModuleExecution$ === 'function') {\n+    const cleanupReactRefreshIntercept =\n+      globalThis.$RefreshInterceptModuleExecution$(module.id)\n+    try {\n+      executeModule({\n+        register: globalThis.$RefreshReg$,\n+        signature: globalThis.$RefreshSig$,\n+        registerExports: registerExportsAndSetupBoundaryForReactRefresh,\n+      })\n+    } finally {\n+      // Always cleanup the intercept, even if module execution failed.\n+      cleanupReactRefreshIntercept()\n+    }\n+  } else {\n+    // If the react refresh hooks are not installed we need to bind dummy functions.\n+    // This is expected when running in a Web Worker.  It is also common in some of\n+    // our test environments.\n     executeModule({\n-      register: globalThis.$RefreshReg$,\n-      signature: globalThis.$RefreshSig$,\n-      registerExports: registerExportsAndSetupBoundaryForReactRefresh,\n+      register: (type, id) => {},\n+      signature: () => (type) => {},\n+      registerExports: (module, helpers) => {},\n     })\n-  } catch (e) {\n-    throw e\n-  } finally {\n-    // Always cleanup the intercept, even if module execution failed.\n-    cleanupReactRefreshIntercept()\n   }\n }\n "
        },
        {
            "sha": "43e1d2bb426ca164e64ed0c93a716d8139620d53",
            "filename": "turbopack/crates/turbopack-ecmascript-runtime/js/src/browser/runtime/base/runtime-base.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 6,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3f3539269ac8b78072f0389823f43b650638f4d3/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fruntime-base.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/3f3539269ac8b78072f0389823f43b650638f4d3/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fruntime-base.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-runtime%2Fjs%2Fsrc%2Fbrowser%2Fruntime%2Fbase%2Fruntime-base.ts?ref=3f3539269ac8b78072f0389823f43b650638f4d3",
            "patch": "@@ -255,15 +255,12 @@ function resolveAbsolutePath(modulePath?: string): string {\n /**\n  * Returns a blob URL for the worker.\n  * @param chunks list of chunks to load\n- * @param beforeLoad code to run before code is loaded. Used in dev for HMR setup.\n  */\n-function getWorkerBlobURL(\n-  chunks: ChunkPath[],\n-  beforeLoad: string | undefined\n-): string {\n+function getWorkerBlobURL(chunks: ChunkPath[]): string {\n+  // It is important to reverse the array so when bootstrapping we can infer what chunk is being\n+  // evaluated by poping urls off of this array.  See `getPathFromScript`\n   let bootstrap = `self.TURBOPACK_WORKER_LOCATION = ${JSON.stringify(location.origin)};\n self.TURBOPACK_NEXT_CHUNK_URLS = ${JSON.stringify(chunks.reverse().map(getChunkRelativeUrl), null, 2)};\n-${beforeLoad || ''}\n importScripts(...self.TURBOPACK_NEXT_CHUNK_URLS.map(c => self.TURBOPACK_WORKER_LOCATION + c).reverse());`\n   let blob = new Blob([bootstrap], { type: 'text/javascript' })\n   return URL.createObjectURL(blob)"
        },
        {
            "sha": "002a2562321490c5c46437a98dbcb5a928f65e22",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/runtime/default_dev_runtime/output/b1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js",
            "status": "modified",
            "additions": 23,
            "deletions": 19,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/3f3539269ac8b78072f0389823f43b650638f4d3/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js",
            "raw_url": "https://github.com/vercel/next.js/raw/3f3539269ac8b78072f0389823f43b650638f4d3/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js?ref=3f3539269ac8b78072f0389823f43b650638f4d3",
            "patch": "@@ -496,11 +496,11 @@ async function loadChunkPath(source, chunkPath) {\n /**\n  * Returns a blob URL for the worker.\n  * @param chunks list of chunks to load\n- * @param beforeLoad code to run before code is loaded. Used in dev for HMR setup.\n- */ function getWorkerBlobURL(chunks, beforeLoad) {\n+ */ function getWorkerBlobURL(chunks) {\n+    // It is important to reverse the array so when bootstrapping we can infer what chunk is being\n+    // evaluated by poping urls off of this array.  See `getPathFromScript`\n     let bootstrap = `self.TURBOPACK_WORKER_LOCATION = ${JSON.stringify(location.origin)};\n self.TURBOPACK_NEXT_CHUNK_URLS = ${JSON.stringify(chunks.reverse().map(getChunkRelativeUrl), null, 2)};\n-${beforeLoad || ''}\n importScripts(...self.TURBOPACK_NEXT_CHUNK_URLS.map(c => self.TURBOPACK_WORKER_LOCATION + c).reverse());`;\n     let blob = new Blob([\n         bootstrap\n@@ -660,11 +660,6 @@ const getOrInstantiateModuleFromParent = (id, sourceModule)=>{\n         parentId: sourceModule.id\n     });\n };\n-function getDevWorkerBlobURL(chunks) {\n-    return getWorkerBlobURL(chunks, `// noop fns to prevent runtime errors during initialization\n-self.$RefreshReg$ = function() {};\n-self.$RefreshSig$ = function() {};`);\n-}\n // @ts-ignore Defined in `runtime-base.ts`\n function instantiateModule(id, source) {\n     const moduleFactory = moduleFactories[id];\n@@ -751,7 +746,7 @@ function instantiateModule(id, source) {\n                 U: relativeURL,\n                 k: refresh,\n                 R: createResolvePathFromModule(r),\n-                b: getDevWorkerBlobURL,\n+                b: getWorkerBlobURL,\n                 z: requireStub\n             }));\n         });\n@@ -771,18 +766,27 @@ function instantiateModule(id, source) {\n  * Next.js' React Refresh runtime hooks into to add module context to the\n  * refresh registry.\n  */ function runModuleExecutionHooks(module, executeModule) {\n-    const cleanupReactRefreshIntercept = typeof globalThis.$RefreshInterceptModuleExecution$ === 'function' ? globalThis.$RefreshInterceptModuleExecution$(module.id) : ()=>{};\n-    try {\n+    if (typeof globalThis.$RefreshInterceptModuleExecution$ === 'function') {\n+        const cleanupReactRefreshIntercept = globalThis.$RefreshInterceptModuleExecution$(module.id);\n+        try {\n+            executeModule({\n+                register: globalThis.$RefreshReg$,\n+                signature: globalThis.$RefreshSig$,\n+                registerExports: registerExportsAndSetupBoundaryForReactRefresh\n+            });\n+        } finally{\n+            // Always cleanup the intercept, even if module execution failed.\n+            cleanupReactRefreshIntercept();\n+        }\n+    } else {\n+        // If the react refresh hooks are not installed we need to bind dummy functions.\n+        // This is expected when running in a Web Worker.  It is also common in some of\n+        // our test environments.\n         executeModule({\n-            register: globalThis.$RefreshReg$,\n-            signature: globalThis.$RefreshSig$,\n-            registerExports: registerExportsAndSetupBoundaryForReactRefresh\n+            register: (type, id)=>{},\n+            signature: ()=>(type)=>{},\n+            registerExports: (module, helpers)=>{}\n         });\n-    } catch (e) {\n-        throw e;\n-    } finally{\n-        // Always cleanup the intercept, even if module execution failed.\n-        cleanupReactRefreshIntercept();\n     }\n }\n /**"
        },
        {
            "sha": "3937c57789bce28fc913518b5f1b3efbd3035c1f",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/runtime/default_dev_runtime/output/b1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js.map",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/3f3539269ac8b78072f0389823f43b650638f4d3/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/3f3539269ac8b78072f0389823f43b650638f4d3/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fruntime%2Fdefault_dev_runtime%2Foutput%2Fb1abf_turbopack-tests_tests_snapshot_runtime_default_dev_runtime_input_index_75df6705.js.map?ref=3f3539269ac8b78072f0389823f43b650638f4d3"
        }
    ],
    "stats": {
        "total": 104,
        "additions": 51,
        "deletions": 53
    }
}