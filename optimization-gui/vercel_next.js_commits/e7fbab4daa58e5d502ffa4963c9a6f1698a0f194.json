{
    "author": "sokra",
    "message": "Turbopack: Make tasks deterministic (#85524)\n\n### What?\n\nFix Equal implementation on a bunch of structs.\nMake tasks deterministic",
    "sha": "e7fbab4daa58e5d502ffa4963c9a6f1698a0f194",
    "files": [
        {
            "sha": "7077ef7de777a47b9a9ebad817c4ab315ba4757f",
            "filename": "turbopack/crates/turbopack-core/src/changed.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchanged.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchanged.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchanged.rs?ref=e7fbab4daa58e5d502ffa4963c9a6f1698a0f194",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::Result;\n use turbo_tasks::{\n     Completion, Completions, ResolvedVc, TryJoinIterExt, Vc,\n-    graph::{GraphTraversal, NonDeterministic},\n+    graph::{AdjacencyMap, GraphTraversal, NonDeterministic},\n };\n \n use crate::{\n@@ -32,13 +32,13 @@ pub async fn get_referenced_modules(\n pub async fn any_content_changed_of_module(\n     root: ResolvedVc<Box<dyn Module>>,\n ) -> Result<Vc<Completion>> {\n-    let completions = NonDeterministic::new()\n+    let completions = AdjacencyMap::new()\n         .skip_duplicates()\n         .visit([root], get_referenced_modules)\n         .await\n         .completed()?\n         .into_inner()\n-        .into_iter()\n+        .into_postorder_topological()\n         .map(|m| content_changed(*ResolvedVc::upcast(m)))\n         .map(|v| v.to_resolved())\n         .try_join()"
        },
        {
            "sha": "a3df679862f2aefca6053d5f0c627bd0b3e53198",
            "filename": "turbopack/crates/turbopack-css/src/asset.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fasset.rs?ref=e7fbab4daa58e5d502ffa4963c9a6f1698a0f194",
            "patch": "@@ -330,7 +330,6 @@ impl CssChunkItem for CssModuleChunkItem {\n         if let FinalCssResult::Ok {\n             output_code,\n             source_map,\n-            ..\n         } = &*result\n         {\n             Ok(CssChunkItemContent {"
        },
        {
            "sha": "6c83674a4c9f3c23e80361cf6d1031e425eb242b",
            "filename": "turbopack/crates/turbopack-css/src/process.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 12,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fprocess.rs?ref=e7fbab4daa58e5d502ffa4963c9a6f1698a0f194",
            "patch": "@@ -2,7 +2,7 @@ use std::sync::{Arc, RwLock};\n \n use anyhow::{Result, bail};\n use lightningcss::{\n-    css_modules::{CssModuleExport, CssModuleExports, Pattern, Segment},\n+    css_modules::{CssModuleExport, Pattern, Segment},\n     stylesheet::{MinifyOptions, ParserOptions, PrinterOptions, StyleSheet, ToCssResult},\n     targets::{BrowserslistConfig, Features, Targets},\n     traits::ToCss,\n@@ -193,27 +193,18 @@ pub enum CssWithPlaceholderResult {\n     NotFound,\n }\n \n-#[turbo_tasks::value(shared, serialization = \"none\", eq = \"manual\")]\n+#[turbo_tasks::value(shared, serialization = \"none\")]\n pub enum FinalCssResult {\n     Ok {\n         #[turbo_tasks(trace_ignore)]\n         output_code: String,\n \n-        #[turbo_tasks(trace_ignore)]\n-        exports: Option<CssModuleExports>,\n-\n         source_map: ResolvedVc<OptionStringifiedSourceMap>,\n     },\n     Unparsable,\n     NotFound,\n }\n \n-impl PartialEq for FinalCssResult {\n-    fn eq(&self, _: &Self) -> bool {\n-        false\n-    }\n-}\n-\n #[turbo_tasks::function]\n pub async fn process_css_with_placeholder(\n     parse_result: ResolvedVc<ParseCssResult>,\n@@ -327,7 +318,6 @@ pub async fn finalize_css(\n \n             Ok(FinalCssResult::Ok {\n                 output_code: result.code,\n-                exports: result.exports,\n                 source_map: ResolvedVc::cell(srcmap),\n             }\n             .cell())"
        },
        {
            "sha": "a33430cb6f81f10656d41770fc77e091da8d2c8b",
            "filename": "turbopack/crates/turbopack-css/src/references/import.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 5,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fimport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fimport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Freferences%2Fimport.rs?ref=e7fbab4daa58e5d502ffa4963c9a6f1698a0f194",
            "patch": "@@ -21,6 +21,7 @@ use crate::{\n };\n \n #[turbo_tasks::value(eq = \"manual\", serialization = \"none\", shared)]\n+#[derive(PartialEq)]\n pub enum ImportAttributes {\n     LightningCss {\n         #[turbo_tasks(trace_ignore)]\n@@ -32,11 +33,7 @@ pub enum ImportAttributes {\n     },\n }\n \n-impl PartialEq for ImportAttributes {\n-    fn eq(&self, _: &Self) -> bool {\n-        false\n-    }\n-}\n+impl Eq for ImportAttributes {}\n \n impl ImportAttributes {\n     pub fn new_from_lightningcss(prelude: &ImportRule<'static>) -> Self {"
        },
        {
            "sha": "431579812fc234abe305ab1b5608663de3d894a2",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=e7fbab4daa58e5d502ffa4963c9a6f1698a0f194",
            "patch": "@@ -500,7 +500,8 @@ impl EcmascriptParsable for EcmascriptModuleAsset {\n         if this.options.await?.keep_last_successful_parse {\n             let real_result_value = real_result.await?;\n             let result_value = if matches!(*real_result_value, ParseResult::Ok { .. }) {\n-                this.last_successful_parse.set(real_result_value.clone());\n+                this.last_successful_parse\n+                    .set_unconditionally(real_result_value.clone());\n                 real_result_value\n             } else {\n                 let state_ref = this.last_successful_parse.get();"
        },
        {
            "sha": "02071065021a691cfd6e0d5eeeb7273de8fca109",
            "filename": "turbopack/crates/turbopack-ecmascript/src/parse.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 10,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/e7fbab4daa58e5d502ffa4963c9a6f1698a0f194/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs?ref=e7fbab4daa58e5d502ffa4963c9a6f1698a0f194",
            "patch": "@@ -51,7 +51,7 @@ use crate::{\n     transform::{EcmascriptInputTransforms, TransformContext},\n };\n \n-#[turbo_tasks::value(shared, serialization = \"none\", eq = \"manual\")]\n+#[turbo_tasks::value(shared, serialization = \"none\", eq = \"manual\", cell = \"new\")]\n #[allow(clippy::large_enum_variant)]\n pub enum ParseResult {\n     // Note: Ok must not contain any Vc as it's snapshot by failsafe_parse\n@@ -73,15 +73,6 @@ pub enum ParseResult {\n     NotFound,\n }\n \n-impl PartialEq for ParseResult {\n-    fn eq(&self, other: &Self) -> bool {\n-        match (self, other) {\n-            (Self::Ok { .. }, Self::Ok { .. }) => false,\n-            _ => core::mem::discriminant(self) == core::mem::discriminant(other),\n-        }\n-    }\n-}\n-\n /// `original_source_maps_complete` indicates whether the `original_source_maps` cover the whole\n /// map, i.e. whether every module that ended up in `mappings` had an original sourcemap.\n #[instrument(level = \"info\", name = \"generate source map\", skip_all)]"
        }
    ],
    "stats": {
        "total": 42,
        "additions": 10,
        "deletions": 32
    }
}