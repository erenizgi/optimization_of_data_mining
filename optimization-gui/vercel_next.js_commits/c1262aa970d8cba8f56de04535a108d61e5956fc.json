{
    "author": "unstubbable",
    "message": "Fix false-positive `\"use cache\"` misplacement error (#79151)\n\nThis fixes an error where we incorrectly showed the following compiler\nerror when using Turbopack:\n\n```sh\nEcmascript file had an error\n> 1 | 'use cache'\n    | ^^^^^^^^^^^\n  2 |\n  3 | import { useStuff } from './client-module'\n  4 |\n\nThe \"use cache\" directive must be at the top of the file.\n```\n\nThe directive was regarded as not being at the top of the file, because\nthe React transform (`EcmascriptInputTransform::React`) injects a\nvariable declaration for React Refresh (e.g. `var _s =\n__turbopack_context__.k.signature`) at the top of the file, before the\n`\"use cache\"` directive.\n\nWe can fix this by ensuring that the server action transform (should\nreally be called \"server _function_ transform\") runs first.\n\nAs a consequence, the transform now needs to be able to parse JSX AST\nnodes, which was already explicitly implemented.\n\ncloses NAR-130",
    "sha": "c1262aa970d8cba8f56de04535a108d61e5956fc",
    "files": [
        {
            "sha": "93ece0814ab76de0fb2755488c5c3a7e326080f5",
            "filename": "crates/next-core/src/next_shared/transforms/server_actions.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c1262aa970d8cba8f56de04535a108d61e5956fc/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c1262aa970d8cba8f56de04535a108d61e5956fc/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fserver_actions.rs?ref=c1262aa970d8cba8f56de04535a108d61e5956fc",
            "patch": "@@ -40,8 +40,8 @@ pub async fn get_server_actions_transform_rule(\n     Ok(ModuleRule::new(\n         module_rule_match_js_no_url(enable_mdx_rs),\n         vec![ModuleRuleEffect::ExtendEcmascriptTransforms {\n-            prepend: ResolvedVc::cell(vec![]),\n-            append: ResolvedVc::cell(vec![transformer]),\n+            prepend: ResolvedVc::cell(vec![transformer]),\n+            append: ResolvedVc::cell(vec![]),\n         }],\n     ))\n }"
        },
        {
            "sha": "4d3d72499d1ff068ff570ee5c786ed9e90d1a0e2",
            "filename": "test/development/app-dir/use-cache-errors/app/client-module.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fclient-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fclient-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fclient-module.ts?ref=c1262aa970d8cba8f56de04535a108d61e5956fc",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export function useStuff() {\n+  return 'stuff'\n+}"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/development/app-dir/use-cache-errors/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Flayout.tsx?ref=c1262aa970d8cba8f56de04535a108d61e5956fc",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "9cec2cbff9b2f3f953d43633891b68bb3455ca40",
            "filename": "test/development/app-dir/use-cache-errors/app/module-with-use-cache.ts",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fmodule-with-use-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fmodule-with-use-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fmodule-with-use-cache.ts?ref=c1262aa970d8cba8f56de04535a108d61e5956fc",
            "patch": "@@ -0,0 +1,17 @@\n+'use cache'\n+\n+// This file simulates adding a \"use cache\" directive to a client module that's\n+// mistaken as a server module. It does not have itself a \"use client\"\n+// directive, but is imported by a client module with a \"use client\" directive,\n+// while also importing another client module with a \"use client\" directive.\n+// Adding the \"use cache\" directive here, effectively forces the module to be a\n+// server module, which then results in an error when trying to call the client\n+// function.\n+\n+import { useStuff } from './client-module'\n+\n+export async function useCachedStuff() {\n+  // Intentional misusage (using hooks in async functions).\n+  // eslint-disable-next-line react-hooks/rules-of-hooks\n+  return useStuff()\n+}"
        },
        {
            "sha": "fff7bc3cbc841d480c2228251e9d75a6aa37258b",
            "filename": "test/development/app-dir/use-cache-errors/app/page.tsx",
            "status": "added",
            "additions": 23,
            "deletions": 0,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fapp%2Fpage.tsx?ref=c1262aa970d8cba8f56de04535a108d61e5956fc",
            "patch": "@@ -0,0 +1,23 @@\n+'use client'\n+\n+import { useActionState } from 'react'\n+import { useCachedStuff } from './module-with-use-cache'\n+\n+function OtherClientComponent({\n+  getCachedStuff,\n+}: {\n+  getCachedStuff: () => Promise<string>\n+}) {\n+  const [result, formAction] = useActionState(getCachedStuff, null)\n+\n+  return (\n+    <form action={formAction}>\n+      <button id=\"action-button\">Submit</button>\n+      <p>{result}</p>\n+    </form>\n+  )\n+}\n+\n+export default function Page() {\n+  return <OtherClientComponent getCachedStuff={useCachedStuff} />\n+}"
        },
        {
            "sha": "b236fa0c14150c1afe9b69ecaaf0176a12c249ac",
            "filename": "test/development/app-dir/use-cache-errors/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fnext.config.js?ref=c1262aa970d8cba8f56de04535a108d61e5956fc",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    useCache: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "7c513f3f72347f792a0117523d0bb319aee7ee42",
            "filename": "test/development/app-dir/use-cache-errors/use-cache-errors.test.ts",
            "status": "added",
            "additions": 56,
            "deletions": 0,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c1262aa970d8cba8f56de04535a108d61e5956fc/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts?ref=c1262aa970d8cba8f56de04535a108d61e5956fc",
            "patch": "@@ -0,0 +1,56 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { assertNoRedbox } from '../../../lib/next-test-utils'\n+\n+describe('use-cache-errors', () => {\n+  const { next, isTurbopack } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should not show a false-positive compiler error about a misplaced \"use cache\" directive', async () => {\n+    // This is a regression test to ensure that an injected React Refresh\n+    // statement (`var _s = __turbopack_context__.k.signature`) does not\n+    // interfere with our \"use cache\" directive misplacement detection.\n+    const browser = await next.browser('/')\n+    await assertNoRedbox(browser)\n+  })\n+\n+  it('should show a runtime error when calling the incorrectly used cache function', async () => {\n+    const browser = await next.browser('/')\n+    await browser.elementById('action-button').click()\n+\n+    if (isTurbopack) {\n+      // TODO(veil): The wrong stack frame is used for the source snippet.\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"Attempted to call useStuff() from the server but useStuff is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n+         \"environmentLabel\": \"Cache\",\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/page.tsx (22:10) @ Page\n+       > 22 |   return <OtherClientComponent getCachedStuff={useCachedStuff} />\n+            |          ^\",\n+         \"stack\": [\n+           \"<FIXME-file-protocol>\",\n+           \"<FIXME-file-protocol>\",\n+           \"Page app/page.tsx (22:10)\",\n+         ],\n+       }\n+      `)\n+    } else {\n+      await expect(browser).toDisplayRedbox(`\n+       {\n+         \"description\": \"Attempted to call useStuff() from the server but useStuff is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n+         \"environmentLabel\": \"Cache\",\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/module-with-use-cache.ts (16:18) @ useCachedStuff\n+       > 16 |   return useStuff()\n+            |                  ^\",\n+         \"stack\": [\n+           \"<FIXME-file-protocol>\",\n+           \"useCachedStuff app/module-with-use-cache.ts (16:18)\",\n+           \"Page app/page.tsx (22:10)\",\n+         ],\n+       }\n+      `)\n+    }\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 123,
        "additions": 121,
        "deletions": 2
    }
}