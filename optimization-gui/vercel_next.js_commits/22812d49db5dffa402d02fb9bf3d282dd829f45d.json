{
    "author": "kdy1",
    "message": "fix(turbopack): Use correct `SyntaxContext` for `__turbopack_esm__` (#73544)\n\n### What?\n\n### Why?\n\nFor description about the `resolver`/`hygiene` system, please see https://rustdoc.swc.rs/swc_core/ecma/transforms/base/fn.resolver.html\n\n### How?\n\n - Closes https://github.com/vercel/next.js/issues/72232\n - Closes PACK-3372\n\n\n - Closes https://github.com/vercel/next.js/issues/73383\n - Closes PACK-3586\n\n---------\n\nCo-authored-by: Benjamin Woodruff <benjamin.woodruff@vercel.com>\nCo-authored-by: Tobias Koppers <tobias.koppers@googlemail.com>",
    "sha": "22812d49db5dffa402d02fb9bf3d282dd829f45d",
    "files": [
        {
            "sha": "ad05241f498ba39638aa8523074318d531f99591",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/imports.rs",
            "status": "modified",
            "additions": 46,
            "deletions": 0,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs?ref=22812d49db5dffa402d02fb9bf3d282dd829f45d",
            "patch": "@@ -7,6 +7,7 @@ use swc_core::{\n     ecma::{\n         ast::*,\n         atoms::{atom, Atom},\n+        utils::find_pat_ids,\n         visit::{Visit, VisitWith},\n     },\n };\n@@ -178,6 +179,8 @@ pub(crate) struct ImportMap {\n     /// The module specifiers of star imports that are accessed dynamically and should be imported\n     /// as a whole.\n     full_star_imports: FxHashSet<Atom>,\n+\n+    pub(crate) exports: FxHashMap<RcStr, Id>,\n }\n \n /// Represents a collection of [webpack-style \"magic comments\"][magic] that override import\n@@ -605,7 +608,28 @@ impl Visit for Analyzer<'_> {\n             // only visit children if we potentially need to mark import / requires\n             n.visit_children_with(self);\n         }\n+\n+        match &n.decl {\n+            Decl::Class(n) => {\n+                self.data\n+                    .exports\n+                    .insert(n.ident.sym.as_str().into(), n.ident.to_id());\n+            }\n+            Decl::Fn(n) => {\n+                self.data\n+                    .exports\n+                    .insert(n.ident.sym.as_str().into(), n.ident.to_id());\n+            }\n+            Decl::Var(..) | Decl::Using(..) => {\n+                let ids: Vec<Id> = find_pat_ids(&n.decl);\n+                for id in ids {\n+                    self.data.exports.insert(id.0.as_str().into(), id);\n+                }\n+            }\n+            _ => {}\n+        }\n     }\n+\n     fn visit_export_default_decl(&mut self, n: &ExportDefaultDecl) {\n         self.data.has_exports = true;\n \n@@ -623,6 +647,28 @@ impl Visit for Analyzer<'_> {\n         }\n     }\n \n+    fn visit_export_named_specifier(&mut self, n: &ExportNamedSpecifier) {\n+        if let ModuleExportName::Ident(ident) = &n.exported.as_ref().unwrap_or(&n.orig) {\n+            self.data\n+                .exports\n+                .insert(ident.sym.as_str().into(), ident.to_id());\n+        }\n+    }\n+\n+    fn visit_export_default_specifier(&mut self, n: &ExportDefaultSpecifier) {\n+        self.data\n+            .exports\n+            .insert(\"default\".into(), n.exported.to_id());\n+    }\n+\n+    fn visit_export_namespace_specifier(&mut self, n: &ExportNamespaceSpecifier) {\n+        if let ModuleExportName::Ident(ident) = &n.name {\n+            self.data\n+                .exports\n+                .insert(ident.sym.as_str().into(), ident.to_id());\n+        }\n+    }\n+\n     fn visit_program(&mut self, m: &Program) {\n         self.data.has_top_level_await = has_top_level_await(m).is_some();\n "
        },
        {
            "sha": "c9cfbc5abe3892548f6c4e855ee2660c700a08f7",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=22812d49db5dffa402d02fb9bf3d282dd829f45d",
            "patch": "@@ -809,7 +809,7 @@ impl EcmascriptModuleContent {\n                 if let EcmascriptExports::EsmExports(exports) = *exports.await? {\n                     Some(\n                         exports\n-                            .code_generation(module_graph, chunking_context)\n+                            .code_generation(module_graph, chunking_context, *parsed)\n                             .await?,\n                     )\n                 } else {"
        },
        {
            "sha": "d37865a0118fbc9f380087c42dd7f32499843da1",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/esm/export.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 7,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fesm%2Fexport.rs?ref=22812d49db5dffa402d02fb9bf3d282dd829f45d",
            "patch": "@@ -31,6 +31,7 @@ use crate::{\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n     code_gen::{CodeGeneration, CodeGenerationHoistedStmt},\n     magic_identifier,\n+    parse::ParseResult,\n     runtime_functions::{TURBOPACK_DYNAMIC, TURBOPACK_ESM},\n };\n \n@@ -494,8 +495,14 @@ impl EsmExports {\n         self: Vc<Self>,\n         _module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n+        parsed: Vc<ParseResult>,\n     ) -> Result<CodeGeneration> {\n         let expanded = self.expand_exports().await?;\n+        let parsed = parsed.await?;\n+        let eval_context = match &*parsed {\n+            ParseResult::Ok { eval_context, .. } => Some(eval_context),\n+            _ => None,\n+        };\n \n         let mut dynamic_exports = Vec::<Box<Expr>>::new();\n         for dynamic_export_asset in &expanded.dynamic_exports {\n@@ -522,20 +529,22 @@ impl EsmExports {\n                     } else {\n                         Cow::Borrowed(name.as_str())\n                     };\n+                    let ctxt = eval_context\n+                        .and_then(|eval_context| {\n+                            eval_context.imports.exports.get(name).map(|id| id.1)\n+                        })\n+                        .unwrap_or_default();\n+\n                     if *mutable {\n                         Some(quote!(\n                             \"([() => $local, ($new) => $local = $new])\" as Expr,\n-                            local = Ident::new(local.into(), DUMMY_SP, Default::default()),\n-                            new = Ident::new(\n-                                format!(\"new_{name}\").into(),\n-                                DUMMY_SP,\n-                                Default::default()\n-                            ),\n+                            local = Ident::new(local.into(), DUMMY_SP, ctxt),\n+                            new = Ident::new(format!(\"new_{name}\").into(), DUMMY_SP, ctxt),\n                         ))\n                     } else {\n                         Some(quote!(\n                             \"(() => $local)\" as Expr,\n-                            local = Ident::new((name as &str).into(), DUMMY_SP, Default::default())\n+                            local = Ident::new((name as &str).into(), DUMMY_SP, ctxt)\n                         ))\n                     }\n                 }"
        },
        {
            "sha": "741c257bc5e2fc01224ad648574d7c7522dfa2e5",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/chunk_item.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fchunk_item.rs?ref=22812d49db5dffa402d02fb9bf3d282dd829f45d",
            "patch": "@@ -68,7 +68,11 @@ impl EcmascriptChunkItem for EcmascriptModuleFacadeChunkItem {\n \n         let esm_code_gens = self\n             .module\n-            .code_generation(*self.module_graph, *chunking_context)\n+            .code_generation(\n+                *self.module_graph,\n+                *chunking_context,\n+                *self.module.await?.parsed,\n+            )\n             .await?;\n         let additional_code_gens = [\n             self.module\n@@ -80,7 +84,11 @@ impl EcmascriptChunkItem for EcmascriptModuleFacadeChunkItem {\n                 )\n                 .await?,\n             exports\n-                .code_generation(*self.module_graph, *chunking_context)\n+                .code_generation(\n+                    *self.module_graph,\n+                    *chunking_context,\n+                    *self.module.await?.parsed,\n+                )\n                 .await?,\n         ];\n         let code_gens = esm_code_gens.iter().chain(additional_code_gens.iter());"
        },
        {
            "sha": "7fe36ac27e65c670dd59d3e4cab7241ba4d5c232",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/facade/module.rs",
            "status": "modified",
            "additions": 72,
            "deletions": 33,
            "changes": 105,
            "blob_url": "https://github.com/vercel/next.js/blob/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Ffacade%2Fmodule.rs?ref=22812d49db5dffa402d02fb9bf3d282dd829f45d",
            "patch": "@@ -17,6 +17,7 @@ use super::chunk_item::EcmascriptModuleFacadeChunkItem;\n use crate::{\n     chunk::{EcmascriptChunkPlaceable, EcmascriptExports},\n     code_gen::CodeGeneration,\n+    parse::ParseResult,\n     references::{\n         async_module::{AsyncModule, OptionAsyncModule},\n         esm::{EsmExport, EsmExports},\n@@ -31,14 +32,19 @@ use crate::{\n #[turbo_tasks::value]\n pub struct EcmascriptModuleFacadeModule {\n     pub module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+    pub parsed: ResolvedVc<ParseResult>,\n     pub ty: ModulePart,\n }\n \n #[turbo_tasks::value_impl]\n impl EcmascriptModuleFacadeModule {\n     #[turbo_tasks::function]\n-    pub fn new(module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>, ty: ModulePart) -> Vc<Self> {\n-        EcmascriptModuleFacadeModule { module, ty }.cell()\n+    pub fn new(\n+        module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+        parsed: ResolvedVc<ParseResult>,\n+        ty: ModulePart,\n+    ) -> Vc<Self> {\n+        EcmascriptModuleFacadeModule { module, parsed, ty }.cell()\n     }\n \n     #[turbo_tasks::function]\n@@ -65,6 +71,7 @@ impl EcmascriptModuleFacadeModule {\n         self: Vc<Self>,\n         module_graph: Vc<ModuleGraph>,\n         chunking_context: Vc<Box<dyn ChunkingContext>>,\n+        parsed: Vc<ParseResult>,\n     ) -> Result<Vec<CodeGeneration>> {\n         let this = self.await?;\n         Ok(match &this.ty {\n@@ -86,9 +93,13 @@ impl EcmascriptModuleFacadeModule {\n                     .try_join()\n                     .await?;\n                 code_gens.push(\n-                    EcmascriptModulePartReference::new_part(*this.module, ModulePart::locals())\n-                        .code_generation(module_graph, chunking_context)\n-                        .await?,\n+                    EcmascriptModulePartReference::new_part(\n+                        *this.module,\n+                        parsed,\n+                        ModulePart::locals(),\n+                    )\n+                    .code_generation(module_graph, chunking_context)\n+                    .await?,\n                 );\n                 code_gens\n             }\n@@ -110,29 +121,41 @@ impl EcmascriptModuleFacadeModule {\n                     .try_join()\n                     .await?;\n                 code_gens.push(\n-                    EcmascriptModulePartReference::new_part(*this.module, ModulePart::locals())\n-                        .code_generation(module_graph, chunking_context)\n-                        .await?,\n+                    EcmascriptModulePartReference::new_part(\n+                        *this.module,\n+                        parsed,\n+                        ModulePart::locals(),\n+                    )\n+                    .code_generation(module_graph, chunking_context)\n+                    .await?,\n                 );\n                 code_gens\n             }\n             ModulePart::Facade => {\n                 vec![\n-                    EcmascriptModulePartReference::new_part(*this.module, ModulePart::evaluation())\n-                        .code_generation(module_graph, chunking_context)\n-                        .await?,\n-                    EcmascriptModulePartReference::new_part(*this.module, ModulePart::exports())\n-                        .code_generation(module_graph, chunking_context)\n-                        .await?,\n+                    EcmascriptModulePartReference::new_part(\n+                        *this.module,\n+                        parsed,\n+                        ModulePart::evaluation(),\n+                    )\n+                    .code_generation(module_graph, chunking_context)\n+                    .await?,\n+                    EcmascriptModulePartReference::new_part(\n+                        *this.module,\n+                        parsed,\n+                        ModulePart::exports(),\n+                    )\n+                    .code_generation(module_graph, chunking_context)\n+                    .await?,\n                 ]\n             }\n             ModulePart::RenamedNamespace { .. } => vec![\n-                EcmascriptModulePartReference::new(*this.module)\n+                EcmascriptModulePartReference::new(*this.module, parsed)\n                     .code_generation(module_graph, chunking_context)\n                     .await?,\n             ],\n             ModulePart::RenamedExport { .. } => vec![\n-                EcmascriptModulePartReference::new(*this.module)\n+                EcmascriptModulePartReference::new(*this.module, parsed)\n                     .code_generation(module_graph, chunking_context)\n                     .await?,\n             ],\n@@ -171,9 +194,13 @@ impl Module for EcmascriptModuleFacadeModule {\n                     .iter()\n                     .map(|r| ResolvedVc::upcast(*r))\n                     .chain(std::iter::once(ResolvedVc::upcast(\n-                        EcmascriptModulePartReference::new_part(*self.module, ModulePart::locals())\n-                            .to_resolved()\n-                            .await?,\n+                        EcmascriptModulePartReference::new_part(\n+                            *self.module,\n+                            *self.parsed,\n+                            ModulePart::locals(),\n+                        )\n+                        .to_resolved()\n+                        .await?,\n                     )))\n                     .collect()\n             }\n@@ -193,9 +220,13 @@ impl Module for EcmascriptModuleFacadeModule {\n                     .iter()\n                     .map(|r| ResolvedVc::upcast(*r))\n                     .chain(std::iter::once(ResolvedVc::upcast(\n-                        EcmascriptModulePartReference::new_part(*self.module, ModulePart::locals())\n-                            .to_resolved()\n-                            .await?,\n+                        EcmascriptModulePartReference::new_part(\n+                            *self.module,\n+                            *self.parsed,\n+                            ModulePart::locals(),\n+                        )\n+                        .to_resolved()\n+                        .await?,\n                     )))\n                     .collect()\n             }\n@@ -204,6 +235,7 @@ impl Module for EcmascriptModuleFacadeModule {\n                     ResolvedVc::upcast(\n                         EcmascriptModulePartReference::new_part(\n                             *self.module,\n+                            *self.parsed,\n                             ModulePart::evaluation(),\n                         )\n                         .to_resolved()\n@@ -212,6 +244,7 @@ impl Module for EcmascriptModuleFacadeModule {\n                     ResolvedVc::upcast(\n                         EcmascriptModulePartReference::new_part(\n                             *self.module,\n+                            *self.parsed,\n                             ModulePart::exports(),\n                         )\n                         .to_resolved()\n@@ -221,14 +254,14 @@ impl Module for EcmascriptModuleFacadeModule {\n             }\n             ModulePart::RenamedNamespace { .. } => {\n                 vec![ResolvedVc::upcast(\n-                    EcmascriptModulePartReference::new(*self.module)\n+                    EcmascriptModulePartReference::new(*self.module, *self.parsed)\n                         .to_resolved()\n                         .await?,\n                 )]\n             }\n             ModulePart::RenamedExport { .. } => {\n                 vec![ResolvedVc::upcast(\n-                    EcmascriptModulePartReference::new(*self.module)\n+                    EcmascriptModulePartReference::new(*self.module, *self.parsed)\n                         .to_resolved()\n                         .await?,\n                 )]\n@@ -290,6 +323,7 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                                     ResolvedVc::upcast(\n                                         EcmascriptModulePartReference::new_part(\n                                             *self.module,\n+                                            *self.parsed,\n                                             ModulePart::locals(),\n                                         )\n                                         .to_resolved()\n@@ -337,6 +371,7 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                             ResolvedVc::upcast(\n                                 EcmascriptModulePartReference::new_part(\n                                     *self.module,\n+                                    *self.parsed,\n                                     ModulePart::exports(),\n                                 )\n                                 .to_resolved()\n@@ -348,9 +383,13 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                     );\n                 }\n                 star_exports.push(ResolvedVc::upcast(\n-                    EcmascriptModulePartReference::new_part(*self.module, ModulePart::exports())\n-                        .to_resolved()\n-                        .await?,\n+                    EcmascriptModulePartReference::new_part(\n+                        *self.module,\n+                        *self.parsed,\n+                        ModulePart::exports(),\n+                    )\n+                    .to_resolved()\n+                    .await?,\n                 ));\n             }\n             ModulePart::RenamedExport {\n@@ -361,7 +400,7 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                     export.clone(),\n                     EsmExport::ImportedBinding(\n                         ResolvedVc::upcast(\n-                            EcmascriptModulePartReference::new(*self.module)\n+                            EcmascriptModulePartReference::new(*self.module, *self.parsed)\n                                 .to_resolved()\n                                 .await?,\n                         ),\n@@ -374,7 +413,7 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n                 exports.insert(\n                     export.clone(),\n                     EsmExport::ImportedNamespace(ResolvedVc::upcast(\n-                        EcmascriptModulePartReference::new(*self.module)\n+                        EcmascriptModulePartReference::new(*self.module, *self.parsed)\n                             .to_resolved()\n                             .await?,\n                     )),\n@@ -419,19 +458,19 @@ impl EcmascriptChunkPlaceable for EcmascriptModuleFacadeModule {\n #[turbo_tasks::value_impl]\n impl ChunkableModule for EcmascriptModuleFacadeModule {\n     #[turbo_tasks::function]\n-    fn as_chunk_item(\n+    async fn as_chunk_item(\n         self: ResolvedVc<Self>,\n         module_graph: ResolvedVc<ModuleGraph>,\n         chunking_context: ResolvedVc<Box<dyn ChunkingContext>>,\n-    ) -> Vc<Box<dyn turbopack_core::chunk::ChunkItem>> {\n-        Vc::upcast(\n+    ) -> Result<Vc<Box<dyn turbopack_core::chunk::ChunkItem>>> {\n+        Ok(Vc::upcast(\n             EcmascriptModuleFacadeChunkItem {\n                 module: self,\n                 module_graph,\n                 chunking_context,\n             }\n             .cell(),\n-        )\n+        ))\n     }\n }\n "
        },
        {
            "sha": "3929faf5c5af76acfc9e75cc011a922af258b98e",
            "filename": "turbopack/crates/turbopack-ecmascript/src/side_effect_optimization/reference.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fside_effect_optimization%2Freference.rs?ref=22812d49db5dffa402d02fb9bf3d282dd829f45d",
            "patch": "@@ -17,7 +17,7 @@ use super::{\n     facade::module::EcmascriptModuleFacadeModule, locals::module::EcmascriptModuleLocalsModule,\n };\n use crate::{\n-    chunk::EcmascriptChunkPlaceable, code_gen::CodeGeneration,\n+    chunk::EcmascriptChunkPlaceable, code_gen::CodeGeneration, parse::ParseResult,\n     references::esm::base::ReferencedAsset, runtime_functions::TURBOPACK_IMPORT,\n     utils::module_id_to_lit,\n };\n@@ -27,6 +27,7 @@ use crate::{\n #[turbo_tasks::value]\n pub struct EcmascriptModulePartReference {\n     pub module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+    pub parsed: ResolvedVc<ParseResult>,\n     pub part: Option<ModulePart>,\n }\n \n@@ -35,18 +36,28 @@ impl EcmascriptModulePartReference {\n     #[turbo_tasks::function]\n     pub fn new_part(\n         module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+        parsed: ResolvedVc<ParseResult>,\n         part: ModulePart,\n     ) -> Vc<Self> {\n         EcmascriptModulePartReference {\n             module,\n+            parsed,\n             part: Some(part),\n         }\n         .cell()\n     }\n \n     #[turbo_tasks::function]\n-    pub fn new(module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>) -> Vc<Self> {\n-        EcmascriptModulePartReference { module, part: None }.cell()\n+    pub fn new(\n+        module: ResolvedVc<Box<dyn EcmascriptChunkPlaceable>>,\n+        parsed: ResolvedVc<ParseResult>,\n+    ) -> Vc<Self> {\n+        EcmascriptModulePartReference {\n+            module,\n+            parsed,\n+            part: None,\n+        }\n+        .cell()\n     }\n }\n \n@@ -81,7 +92,7 @@ impl ModuleReference for EcmascriptModulePartReference {\n                 | ModulePart::Facade\n                 | ModulePart::RenamedExport { .. }\n                 | ModulePart::RenamedNamespace { .. } => Vc::upcast(\n-                    EcmascriptModuleFacadeModule::new(*self.module, part.clone()),\n+                    EcmascriptModuleFacadeModule::new(*self.module, *self.parsed, part.clone()),\n                 ),\n                 ModulePart::Export(..)\n                 | ModulePart::Internal(..)"
        },
        {
            "sha": "38376b43bba4e1dda5149be6a54201a5e797ec78",
            "filename": "turbopack/crates/turbopack-ecmascript/src/tree_shake/asset.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftree_shake%2Fasset.rs?ref=22812d49db5dffa402d02fb9bf3d282dd829f45d",
            "patch": "@@ -162,13 +162,16 @@ impl EcmascriptModulePartAsset {\n                 ..\n             } = &*result.await?;\n \n+            let parsed = module.parse();\n+\n             let final_module = if let Some(new_export) = new_export {\n                 if *new_export == export {\n                     *final_module\n                 } else {\n                     ResolvedVc::upcast(\n                         EcmascriptModuleFacadeModule::new(\n                             **final_module,\n+                            parsed,\n                             ModulePart::renamed_export(new_export.clone(), export.clone()),\n                         )\n                         .to_resolved()\n@@ -179,6 +182,7 @@ impl EcmascriptModulePartAsset {\n                 ResolvedVc::upcast(\n                     EcmascriptModuleFacadeModule::new(\n                         **final_module,\n+                        parsed,\n                         ModulePart::renamed_namespace(export.clone()),\n                     )\n                     .to_resolved()"
        },
        {
            "sha": "0cf7de364a33ee9a4c5561163c6b485ffa04abc3",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/22812d49db5dffa402d02fb9bf3d282dd829f45d/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=22812d49db5dffa402d02fb9bf3d282dd829f45d",
            "patch": "@@ -54,6 +54,7 @@ use turbopack_core::{\n pub use turbopack_css as css;\n pub use turbopack_ecmascript as ecmascript;\n use turbopack_ecmascript::{\n+    parse::ParseResult,\n     references::external_module::{CachedExternalModule, CachedExternalType},\n     tree_shake::asset::EcmascriptModulePartAsset,\n };\n@@ -157,6 +158,7 @@ async fn apply_module_type(\n                     }\n                 }\n \n+                let parsed = module.parse();\n                 let options = options.await?;\n                 match options.tree_shaking_mode {\n                     Some(TreeShakingMode::ModuleFragments) => {\n@@ -172,6 +174,7 @@ async fn apply_module_type(\n                                     if *module.get_exports().needs_facade().await? {\n                                         Vc::upcast(EcmascriptModuleFacadeModule::new(\n                                             Vc::upcast(module),\n+                                            parsed,\n                                             part,\n                                         ))\n                                     } else {\n@@ -189,17 +192,20 @@ async fn apply_module_type(\n                                             Vc::upcast(\n                                                 EcmascriptModuleFacadeModule::new(\n                                                     Vc::upcast(module),\n+                                                    parsed,\n                                                     ModulePart::exports(),\n                                                 )\n                                                 .resolve()\n                                                 .await?,\n                                             ),\n+                                            parsed,\n                                             part,\n                                             side_effect_free_packages,\n                                         )\n                                     } else {\n                                         apply_reexport_tree_shaking(\n                                             Vc::upcast(module.resolve().await?),\n+                                            parsed,\n                                             part,\n                                             side_effect_free_packages,\n                                         )\n@@ -214,6 +220,7 @@ async fn apply_module_type(\n                         } else if *module.get_exports().needs_facade().await? {\n                             Vc::upcast(EcmascriptModuleFacadeModule::new(\n                                 Vc::upcast(module),\n+                                parsed,\n                                 ModulePart::facade(),\n                             ))\n                         } else {\n@@ -276,6 +283,7 @@ async fn apply_module_type(\n #[turbo_tasks::function]\n async fn apply_reexport_tree_shaking(\n     module: Vc<Box<dyn EcmascriptChunkPlaceable>>,\n+    parsed: Vc<ParseResult>,\n     part: ModulePart,\n     side_effect_free_packages: Vc<Glob>,\n ) -> Result<Vc<Box<dyn Module>>> {\n@@ -291,12 +299,14 @@ async fn apply_reexport_tree_shaking(\n             } else {\n                 Vc::upcast(EcmascriptModuleFacadeModule::new(\n                     **final_module,\n+                    parsed,\n                     ModulePart::renamed_export(new_export.clone(), export.clone()),\n                 ))\n             }\n         } else {\n             Vc::upcast(EcmascriptModuleFacadeModule::new(\n                 **final_module,\n+                parsed,\n                 ModulePart::renamed_namespace(export.clone()),\n             ))\n         };"
        }
    ],
    "stats": {
        "total": 221,
        "additions": 174,
        "deletions": 47
    }
}