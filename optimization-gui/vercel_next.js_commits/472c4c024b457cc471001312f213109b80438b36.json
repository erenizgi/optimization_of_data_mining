{
    "author": "timneutkens",
    "message": "Route modules: Call setReferenceManifestsSingleton for app-route to match app-page (#82908)\n\n## What?\n\nThe changes in #82903 highlighted some failing tests because `use cache`\nrelies on the global singleton being set which accidentally depended on\nthe `load-components` call to `setReferenceManifestsSingleton`. The\n`app-page` template did the right thing calling\n`setReferenceManifestsSingleton` already but `app-route` did not,\ncausing those tests to fail when I removed calling\n`setReferenceManifestsSingleton` in the PR further in the stack.",
    "sha": "472c4c024b457cc471001312f213109b80438b36",
    "files": [
        {
            "sha": "c17d1773269fb854bb86ccde59ac31b4156d0f24",
            "filename": "packages/next/src/build/templates/app-route.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/472c4c024b457cc471001312f213109b80438b36/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/472c4c024b457cc471001312f213109b80438b36/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fapp-route.ts?ref=472c4c024b457cc471001312f213109b80438b36",
            "patch": "@@ -8,6 +8,8 @@ import { patchFetch as _patchFetch } from '../../server/lib/patch-fetch'\n import type { IncomingMessage, ServerResponse } from 'node:http'\n import { getRequestMeta } from '../../server/request-meta'\n import { getTracer, type Span, SpanKind } from '../../server/lib/trace/tracer'\n+import { setReferenceManifestsSingleton } from '../../server/app-render/encryption-utils'\n+import { createServerModuleMap } from '../../server/app-render/action-utils'\n import { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n import { NodeNextRequest, NodeNextResponse } from '../../server/base-http/node'\n import {\n@@ -119,6 +121,8 @@ export async function handler(\n     isOnDemandRevalidate,\n     revalidateOnlyGenerated,\n     resolvedPathname,\n+    clientReferenceManifest,\n+    serverActionsManifest,\n   } = prepareResult\n \n   const normalizedSrcPage = normalizeAppPath(srcPage)\n@@ -160,6 +164,20 @@ export async function handler(\n   // request.\n   const isRevalidate = isIsr && !supportsDynamicResponse\n \n+  // Before rendering (which initializes component tree modules), we have to\n+  // set the reference manifests to our global store so Server Action's\n+  // encryption util can access to them at the top level of the page module.\n+  if (serverActionsManifest && clientReferenceManifest) {\n+    setReferenceManifestsSingleton({\n+      page: srcPage,\n+      clientReferenceManifest,\n+      serverActionsManifest,\n+      serverModuleMap: createServerModuleMap({\n+        serverActionsManifest,\n+      }),\n+    })\n+  }\n+\n   const method = req.method || 'GET'\n   const tracer = getTracer()\n   const activeSpan = tracer.getActiveScopeSpan()"
        }
    ],
    "stats": {
        "total": 18,
        "additions": 18,
        "deletions": 0
    }
}