{
    "author": "mischnic",
    "message": "Don't externalize various new `next/*` entrypoints (#77844)\n\n`next/cache`,`next/form`,`next/head`, `next/compat/router`, and\n`next/server` were missing in the regex",
    "sha": "46fe103ded7b8540e9c0ff3c5400391cb90926e7",
    "files": [
        {
            "sha": "0d9501e89496cf6fd9f8ffb2fddd26851821b8b1",
            "filename": "crates/next-core/src/next_import_map.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 31,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/46fe103ded7b8540e9c0ff3c5400391cb90926e7/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/46fe103ded7b8540e9c0ff3c5400391cb90926e7/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_import_map.rs?ref=46fe103ded7b8540e9c0ff3c5400391cb90926e7",
            "patch": "@@ -249,37 +249,6 @@ pub async fn get_next_client_import_map(\n     Ok(import_map.cell())\n }\n \n-/// Computes the Next-specific client import map.\n-#[turbo_tasks::function]\n-pub async fn get_next_build_import_map() -> Result<Vc<ImportMap>> {\n-    let mut import_map = ImportMap::empty();\n-\n-    insert_package_alias(\n-        &mut import_map,\n-        &format!(\"{VIRTUAL_PACKAGE_NAME}/\"),\n-        next_js_fs().root().to_resolved().await?,\n-    );\n-\n-    let external = ImportMapping::External(None, ExternalType::CommonJs, ExternalTraced::Traced)\n-        .resolved_cell();\n-\n-    import_map.insert_exact_alias(\"next\", external);\n-    import_map.insert_wildcard_alias(\"next/\", external);\n-    import_map.insert_exact_alias(\"styled-jsx\", external);\n-    import_map.insert_exact_alias(\n-        \"styled-jsx/style\",\n-        ImportMapping::External(\n-            Some(\"styled-jsx/style.js\".into()),\n-            ExternalType::CommonJs,\n-            ExternalTraced::Traced,\n-        )\n-        .resolved_cell(),\n-    );\n-    import_map.insert_wildcard_alias(\"styled-jsx/\", external);\n-\n-    Ok(import_map.cell())\n-}\n-\n /// Computes the Next-specific client fallback import map, which provides\n /// polyfills to Node.js externals.\n #[turbo_tasks::function]"
        },
        {
            "sha": "954f6168652c03a5f3ecbbc5005203c7e2196116",
            "filename": "crates/next-core/src/next_server/resolve.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/46fe103ded7b8540e9c0ff3c5400391cb90926e7/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/46fe103ded7b8540e9c0ff3c5400391cb90926e7/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fresolve.rs?ref=46fe103ded7b8540e9c0ff3c5400391cb90926e7",
            "patch": "@@ -93,7 +93,7 @@ impl AfterResolvePlugin for ExternalCjsModulesResolvePlugin {\n         };\n \n         // from https://github.com/vercel/next.js/blob/8d1c619ad650f5d147207f267441caf12acd91d1/packages/next/src/build/handle-externals.ts#L188\n-        let never_external_regex = lazy_regex::regex!(\"^(?:private-next-pages\\\\/|next\\\\/(?:dist\\\\/pages\\\\/|(?:app|document|link|image|legacy\\\\/image|constants|dynamic|script|navigation|headers|router)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference$)\");\n+        let never_external_regex = lazy_regex::regex!(\"^(?:private-next-pages\\\\/|next\\\\/(?:dist\\\\/pages\\\\/|(?:app|cache|document|link|form|head|image|legacy\\\\/image|constants|dynamic|script|navigation|headers|router|compat\\\\/router|server)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference|private-next-rsc-cache-wrapper$)\");\n \n         let Pattern::Constant(package_subpath) = package_subpath else {\n             return Ok(ResolveResultOption::none());"
        },
        {
            "sha": "8cf2ed944942d4c75d3c5d7b3a73d36dfba3c358",
            "filename": "packages/next/src/build/handle-externals.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/46fe103ded7b8540e9c0ff3c5400391cb90926e7/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/46fe103ded7b8540e9c0ff3c5400391cb90926e7/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fhandle-externals.ts?ref=46fe103ded7b8540e9c0ff3c5400391cb90926e7",
            "patch": "@@ -189,7 +189,7 @@ export function makeExternalHandler({\n       }\n \n       const notExternalModules =\n-        /^(?:private-next-pages\\/|next\\/(?:dist\\/pages\\/|(?:app|document|link|form|image|legacy\\/image|constants|dynamic|script|navigation|headers|router)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference|private-next-rsc-cache-wrapper$)/\n+        /^(?:private-next-pages\\/|next\\/(?:dist\\/pages\\/|(?:app|cache|document|link|form|head|image|legacy\\/image|constants|dynamic|script|navigation|headers|router|compat\\/router|server)$)|string-hash|private-next-rsc-action-validate|private-next-rsc-action-client-wrapper|private-next-rsc-server-reference|private-next-rsc-cache-wrapper$)/\n       if (notExternalModules.test(request)) {\n         return\n       }"
        }
    ],
    "stats": {
        "total": 35,
        "additions": 2,
        "deletions": 33
    }
}