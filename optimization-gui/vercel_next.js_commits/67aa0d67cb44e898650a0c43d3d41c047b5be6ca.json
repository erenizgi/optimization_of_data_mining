{
    "author": "huozhi",
    "message": "[dev-overlay] solidate the line number parsing (#78868)\n\n### What\r\n\r\nEnhance the line break solution of dev overlay code frame from #77078\r\n\r\nWe parse the tokens and group them into lines by detect the line break token. There's a missing case we didn't notice before where the line break token could contain spaces look like below:\r\n\r\n![image](https://github.com/user-attachments/assets/20760ca4-46d9-40bf-9a0f-1cb9a8014fd2)\r\n\r\n* The content before `\\n` should belong to previous line\r\n* The content after `\\n` should belong to the next line\r\n\r\nAlso improved the memoization situation in the code frame to avoid re-parsing the lines and tokens.\r\n\r\nCloses NDX-1042",
    "sha": "67aa0d67cb44e898650a0c43d3d41c047b5be6ca",
    "files": [
        {
            "sha": "b6a7c9ef2a0bd7857c8ad06efc38284c4d1ab9fd",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/code-frame/code-frame.tsx",
            "status": "modified",
            "additions": 12,
            "deletions": 11,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/67aa0d67cb44e898650a0c43d3d41c047b5be6ca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fcode-frame.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/67aa0d67cb44e898650a0c43d3d41c047b5be6ca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fcode-frame.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fcode-frame.tsx?ref=67aa0d67cb44e898650a0c43d3d41c047b5be6ca",
            "patch": "@@ -14,14 +14,16 @@ import {\n export type CodeFrameProps = { stackFrame: StackFrame; codeFrame: string }\n \n export function CodeFrame({ stackFrame, codeFrame }: CodeFrameProps) {\n-  const formattedFrame = useMemo<string>(\n-    () => formatCodeFrame(codeFrame),\n-    [codeFrame]\n-  )\n-  const decodedLines = useMemo(\n-    () => groupCodeFrameLines(formattedFrame),\n-    [formattedFrame]\n-  )\n+  const parsedLineStates = useMemo(() => {\n+    const decodedLines = groupCodeFrameLines(formatCodeFrame(codeFrame))\n+\n+    return decodedLines.map((line) => {\n+      return {\n+        line,\n+        parsedLine: parseLineNumberFromCodeFrameLine(line, stackFrame),\n+      }\n+    })\n+  }, [codeFrame, stackFrame])\n \n   const open = useOpenInEditor({\n     file: stackFrame.file,\n@@ -60,9 +62,8 @@ export function CodeFrame({ stackFrame, codeFrame }: CodeFrameProps) {\n         </p>\n       </div>\n       <pre className=\"code-frame-pre\">\n-        {decodedLines.map((line, lineIndex) => {\n-          const { lineNumber, isErroredLine } =\n-            parseLineNumberFromCodeFrameLine(line, stackFrame)\n+        {parsedLineStates.map(({ line, parsedLine }, lineIndex) => {\n+          const { lineNumber, isErroredLine } = parsedLine\n \n           const lineNumberProps: Record<string, string | boolean> = {}\n           if (lineNumber) {"
        },
        {
            "sha": "d8f5b2fa5972318ef8ff7e22d7ad47f79b2595e9",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/code-frame/parse-code-frame.test.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 0,
            "changes": 41,
            "blob_url": "https://github.com/vercel/next.js/blob/67aa0d67cb44e898650a0c43d3d41c047b5be6ca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/67aa0d67cb44e898650a0c43d3d41c047b5be6ca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.test.ts?ref=67aa0d67cb44e898650a0c43d3d41c047b5be6ca",
            "patch": "@@ -49,4 +49,45 @@ describe('parse line numbers', () => {\n       isErroredLine: false,\n     })\n   })\n+\n+  it('parse line numbers when a token contains both break and spaces', () => {\n+    //   4 |   return (\n+    //   5 |     <p>\n+    // > 6 |       <p>nest</p>\n+    //     |       ^\n+    //   7 |     </p>\n+    //   8 |   )\n+    //   9 | }\n+    const input = {\n+      stackFrame: {\n+        file: 'app/page.tsx',\n+        lineNumber: 6,\n+        column: 7,\n+        methodName: 'Page',\n+        arguments: [],\n+      },\n+      codeFrame: `\"\\u001b[0m \\u001b[90m 4 |\\u001b[39m   \\u001b[36mreturn\\u001b[39m (\\n \\u001b[90m 5 |\\u001b[39m     \\u001b[33m<\\u001b[39m\\u001b[33mp\\u001b[39m\\u001b[33m>\\u001b[39m\\n\\u001b[31m\\u001b[1m>\\u001b[22m\\u001b[39m\\u001b[90m 6 |\\u001b[39m       \\u001b[33m<\\u001b[39m\\u001b[33mp\\u001b[39m\\u001b[33m>\\u001b[39mnest\\u001b[33m<\\u001b[39m\\u001b[33m/\\u001b[39m\\u001b[33mp\\u001b[39m\\u001b[33m>\\u001b[39m\\n \\u001b[90m   |\\u001b[39m       \\u001b[31m\\u001b[1m^\\u001b[22m\\u001b[39m\\n \\u001b[90m 7 |\\u001b[39m     \\u001b[33m<\\u001b[39m\\u001b[33m/\\u001b[39m\\u001b[33mp\\u001b[39m\\u001b[33m>\\u001b[39m\\n \\u001b[90m 8 |\\u001b[39m   )\\n \\u001b[90m 9 |\\u001b[39m }\\u001b[0m\"`,\n+    }\n+    const formattedFrame = formatCodeFrame(input.codeFrame)\n+    const decodedLines = groupCodeFrameLines(formattedFrame)\n+\n+    expect(\n+      parseLineNumberFromCodeFrameLine(decodedLines[1], input.stackFrame)\n+    ).toEqual({\n+      lineNumber: '5',\n+      isErroredLine: false,\n+    })\n+    expect(\n+      parseLineNumberFromCodeFrameLine(decodedLines[2], input.stackFrame)\n+    ).toEqual({\n+      lineNumber: '6',\n+      isErroredLine: true,\n+    })\n+    expect(\n+      parseLineNumberFromCodeFrameLine(decodedLines[4], input.stackFrame)\n+    ).toEqual({\n+      lineNumber: '7',\n+      isErroredLine: false,\n+    })\n+  })\n })"
        },
        {
            "sha": "1301c67d11d2026baab3a92fa9d9eecc23a97ffa",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/components/code-frame/parse-code-frame.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/67aa0d67cb44e898650a0c43d3d41c047b5be6ca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/67aa0d67cb44e898650a0c43d3d41c047b5be6ca/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fcomponents%2Fcode-frame%2Fparse-code-frame.ts?ref=67aa0d67cb44e898650a0c43d3d41c047b5be6ca",
            "patch": "@@ -43,9 +43,24 @@ export function groupCodeFrameLines(formattedFrame: string) {\n \n   let line: typeof decoded = []\n   for (const token of decoded) {\n-    if (token.content === '\\n') {\n-      lines.push(line)\n-      line = []\n+    // If the token is a new line with only line break \"\\n\",\n+    // break here into a new line.\n+    // The line could also contain spaces, it's still considered line break if \"\\n\" line has spaces.\n+    if (typeof token.content === 'string' && token.content.includes('\\n')) {\n+      const segments = token.content.split('\\n')\n+      for (let i = 0; i < segments.length; i++) {\n+        const segment = segments[i]\n+        if (segment) {\n+          line.push({\n+            ...token,\n+            content: segment,\n+          })\n+        }\n+        if (i < segments.length - 1) {\n+          lines.push(line)\n+          line = []\n+        }\n+      }\n     } else {\n       line.push(token)\n     }\n@@ -66,7 +81,6 @@ export function parseLineNumberFromCodeFrameLine(\n   // parse line number from line first 2 tokens\n   // e.g. ` > 1 | const foo = 'bar'` => `1`, first token is `1 |`\n   // e.g. `  2 | const foo = 'bar'` => `2`. first 2 tokens are ' ' and ' 2 |'\n-  // console.log('line', line)\n   if (line[0]?.content === '>' || line[0]?.content === ' ') {\n     lineNumberToken = line[1]\n     lineNumber = lineNumberToken?.content?.replace('|', '')?.trim()"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 71,
        "deletions": 15
    }
}