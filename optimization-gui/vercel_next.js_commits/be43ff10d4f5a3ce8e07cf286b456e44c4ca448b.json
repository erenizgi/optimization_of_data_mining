{
    "author": "huozhi",
    "message": "[segment explorer] open in editor (#80856)\n\nWhen click each file label in segment explorer, open the file in editor.\r\n\r\n\r\nhttps://github.com/user-attachments/assets/fcec113c-2d65-477c-9b44-22d46dcc42ae",
    "sha": "be43ff10d4f5a3ce8e07cf286b456e44c4ca448b",
    "files": [
        {
            "sha": "3ec2a5f838daca7fb21ec3894fe23ae07cd3ac3b",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 20,
            "deletions": 2,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=be43ff10d4f5a3ce8e07cf286b456e44c4ca448b",
            "patch": "@@ -114,11 +114,14 @@ function PageSegmentTreeLayerPresentation({\n                     if (!childNode || !childNode.value) {\n                       return null\n                     }\n-                    const fileName =\n-                      childNode.value.pagePath.split('/').pop() || ''\n+                    const filePath = childNode.value.pagePath\n+                    const fileName = filePath.split('/').pop() || ''\n                     return (\n                       <span\n                         key={fileChildSegment}\n+                        onClick={() => {\n+                          openInEditor({ filePath })\n+                        }}\n                         className={cx(\n                           'segment-explorer-file-label',\n                           `segment-explorer-file-label--${childNode.value.type}`\n@@ -215,6 +218,7 @@ export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n     font-size: var(--size-12);\n     font-weight: 500;\n     user-select: none;\n+    cursor: pointer;\n   }\n   .segment-explorer-file-label--layout,\n   .segment-explorer-file-label--template,\n@@ -242,3 +246,17 @@ export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n     color: var(--color-red-900);\n   }\n `\n+\n+function openInEditor({ filePath }: { filePath: string }) {\n+  const params = new URLSearchParams({\n+    file: filePath,\n+    // Mark the file path is relative to the app directory,\n+    // The editor launcher will complete the full path for it.\n+    isAppRelativePath: '1',\n+  })\n+  fetch(\n+    `${\n+      process.env.__NEXT_ROUTER_BASEPATH || ''\n+    }/__nextjs_launch-editor?${params.toString()}`\n+  )\n+}"
        },
        {
            "sha": "c3277db855eee82ece8103c3eb8861a7776ec525",
            "filename": "packages/next/src/next-devtools/server/launch-editor.ts",
            "status": "modified",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Flaunch-editor.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Flaunch-editor.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fserver%2Flaunch-editor.ts?ref=be43ff10d4f5a3ce8e07cf286b456e44c4ca448b",
            "patch": "@@ -24,6 +24,7 @@\n import { cyan, green, red } from '../../lib/picocolors'\n import child_process from 'child_process'\n import fs from 'fs'\n+import fsp from 'fs/promises'\n import os from 'os'\n import path from 'path'\n import shellQuote from 'next/dist/compiled/shell-quote'\n@@ -428,3 +429,28 @@ export function launchEditor(\n     })\n   }\n }\n+\n+// Open the file in editor if exists, otherwise return an error\n+export async function openFileInEditor(\n+  filePath: string,\n+  line: number,\n+  col: number\n+) {\n+  const result = {\n+    found: false,\n+    error: null as Error | null,\n+  }\n+  const existed = await fsp.access(filePath, fs.constants.F_OK).then(\n+    () => true,\n+    () => false\n+  )\n+  if (existed) {\n+    try {\n+      launchEditor(filePath, line, col)\n+      result.found = true\n+    } catch (err) {\n+      result.error = err as Error\n+    }\n+  }\n+  return result\n+}"
        },
        {
            "sha": "9afae30a2bdfcd43eaef97b0dc0f0ed6e1b32a4d",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 2,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=be43ff10d4f5a3ce8e07cf286b456e44c4ca448b",
            "patch": "@@ -156,7 +156,7 @@ function getSourceMapFromTurbopack(\n }\n \n export async function createHotReloaderTurbopack(\n-  opts: SetupOpts,\n+  opts: SetupOpts & { isSrcDir: boolean },\n   serverFields: ServerFields,\n   distDir: string,\n   resetFetch: () => void\n@@ -652,7 +652,11 @@ export async function createHotReloaderTurbopack(\n   )\n \n   const middlewares = [\n-    getOverlayMiddleware(project, projectPath),\n+    getOverlayMiddleware({\n+      project,\n+      projectPath,\n+      isSrcDir: opts.isSrcDir,\n+    }),\n     getSourceMapMiddleware(project),\n     getNextErrorFeedbackMiddleware(opts.telemetry),\n     getDevOverlayFontMiddleware(),"
        },
        {
            "sha": "8f28110e4b9234e67e31e606118c9517b22352d3",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=be43ff10d4f5a3ce8e07cf286b456e44c4ca448b",
            "patch": "@@ -262,6 +262,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n   }\n   private devtoolsFrontendUrl: string | undefined\n   private reloadAfterInvalidation: boolean = false\n+  private isSrcDir: boolean\n \n   public serverStats: webpack.Stats | null\n   public edgeServerStats: webpack.Stats | null\n@@ -274,6 +275,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     dir: string,\n     {\n       config,\n+      isSrcDir,\n       pagesDir,\n       distDir,\n       buildId,\n@@ -285,6 +287,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       resetFetch,\n     }: {\n       config: NextConfigComplete\n+      isSrcDir: boolean\n       pagesDir?: string\n       distDir: string\n       buildId: string\n@@ -302,6 +305,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     this.buildId = buildId\n     this.encryptionKey = encryptionKey\n     this.dir = dir\n+    this.isSrcDir = isSrcDir\n     this.middlewares = []\n     this.pagesDir = pagesDir\n     this.appDir = appDir\n@@ -1567,6 +1571,7 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n     this.middlewares = [\n       getOverlayMiddleware({\n         rootDirectory: this.dir,\n+        isSrcDir: this.isSrcDir,\n         clientStats: () => this.clientStats,\n         serverStats: () => this.serverStats,\n         edgeServerStats: () => this.edgeServerStats,"
        },
        {
            "sha": "88c0d136e3164181fc7bb034c1e2385dde4fd142",
            "filename": "packages/next/src/server/dev/middleware-turbopack.ts",
            "status": "modified",
            "additions": 35,
            "deletions": 17,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts?ref=be43ff10d4f5a3ce8e07cf286b456e44c4ca448b",
            "patch": "@@ -6,10 +6,9 @@ import {\n   type OriginalStackFramesResponse,\n } from '../../next-devtools/server/shared'\n import { middlewareResponse } from '../../next-devtools/server/middleware-response'\n-import fs, { constants as FS } from 'fs/promises'\n import path from 'path'\n import url from 'url'\n-import { launchEditor } from '../../next-devtools/server/launch-editor'\n+import { openFileInEditor } from '../../next-devtools/server/launch-editor'\n import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import {\n   SourceMapConsumer,\n@@ -371,7 +370,15 @@ async function createOriginalStackFrame(\n   }\n }\n \n-export function getOverlayMiddleware(project: Project, projectPath: string) {\n+export function getOverlayMiddleware({\n+  project,\n+  projectPath,\n+  isSrcDir,\n+}: {\n+  project: Project\n+  projectPath: string\n+  isSrcDir: boolean\n+}) {\n   return async function (\n     req: IncomingMessage,\n     res: ServerResponse,\n@@ -421,23 +428,34 @@ export function getOverlayMiddleware(project: Project, projectPath: string) {\n \n       return middlewareResponse.json(res, result)\n     } else if (pathname === '/__nextjs_launch-editor') {\n-      const frame = createStackFrame(searchParams)\n-\n-      if (!frame) return middlewareResponse.badRequest(res)\n-\n-      const fileExists = await fs.access(frame.file, FS.F_OK).then(\n-        () => true,\n-        () => false\n-      )\n-      if (!fileExists) return middlewareResponse.notFound(res)\n+      const isAppRelativePath = searchParams.get('isAppRelativePath') === '1'\n+\n+      let openEditorResult\n+      if (isAppRelativePath) {\n+        const relativeFilePath = searchParams.get('file') || ''\n+        const absoluteFilePath = path.join(\n+          projectPath,\n+          'app',\n+          isSrcDir ? 'src' : '',\n+          relativeFilePath\n+        )\n+        openEditorResult = await openFileInEditor(absoluteFilePath, 1, 1)\n+      } else {\n+        const frame = createStackFrame(searchParams)\n+        if (!frame) return middlewareResponse.badRequest(res)\n+        openEditorResult = await openFileInEditor(\n+          frame.file,\n+          frame.line ?? 1,\n+          frame.column ?? 1\n+        )\n+      }\n \n-      try {\n-        launchEditor(frame.file, frame.line ?? 1, frame.column ?? 1)\n-      } catch (err) {\n-        console.log('Failed to launch editor:', err)\n+      if (openEditorResult.error) {\n         return middlewareResponse.internalServerError(res)\n       }\n-\n+      if (!openEditorResult.found) {\n+        return middlewareResponse.notFound(res)\n+      }\n       return middlewareResponse.noContent(res)\n     }\n "
        },
        {
            "sha": "e5a70fbfe174fc38d89c97324d34557dc20a2452",
            "filename": "packages/next/src/server/dev/middleware-webpack.ts",
            "status": "modified",
            "additions": 36,
            "deletions": 20,
            "changes": 56,
            "blob_url": "https://github.com/vercel/next.js/blob/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-webpack.ts?ref=be43ff10d4f5a3ce8e07cf286b456e44c4ca448b",
            "patch": "@@ -1,4 +1,3 @@\n-import { constants as FS, promises as fs } from 'fs'\n import { findSourceMap, type SourceMap } from 'module'\n import path from 'path'\n import { fileURLToPath, pathToFileURL } from 'url'\n@@ -8,7 +7,7 @@ import {\n } from 'next/dist/compiled/source-map08'\n import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import { getSourceMapFromFile } from './get-source-map-from-file'\n-import { launchEditor } from '../../next-devtools/server/launch-editor'\n+import { openFileInEditor } from '../../next-devtools/server/launch-editor'\n import {\n   getOriginalCodeFrame,\n   type OriginalStackFrameResponse,\n@@ -514,11 +513,13 @@ async function getOriginalStackFrame({\n \n export function getOverlayMiddleware(options: {\n   rootDirectory: string\n+  isSrcDir: boolean\n   clientStats: () => webpack.Stats | null\n   serverStats: () => webpack.Stats | null\n   edgeServerStats: () => webpack.Stats | null\n }) {\n-  const { rootDirectory, clientStats, serverStats, edgeServerStats } = options\n+  const { rootDirectory, isSrcDir, clientStats, serverStats, edgeServerStats } =\n+    options\n \n   return async function (\n     req: IncomingMessage,\n@@ -577,24 +578,39 @@ export function getOverlayMiddleware(options: {\n \n       if (!frame.file) return middlewareResponse.badRequest(res)\n \n-      // frame files may start with their webpack layer, like (middleware)/middleware.js\n-      const filePath = path.resolve(\n-        rootDirectory,\n-        frame.file.replace(/^\\([^)]+\\)\\//, '')\n-      )\n-      const fileExists = await fs.access(filePath, FS.F_OK).then(\n-        () => true,\n-        () => false\n-      )\n-      if (!fileExists) return middlewareResponse.notFound(res)\n-\n-      try {\n-        launchEditor(filePath, frame.lineNumber, frame.column ?? 1)\n-      } catch (err) {\n-        console.log('Failed to launch editor:', err)\n-        return middlewareResponse.internalServerError(res)\n+      let openEditorResult\n+      const isAppRelativePath = searchParams.get('isAppRelativePath') === '1'\n+      if (isAppRelativePath) {\n+        const relativeFilePath = searchParams.get('file') || ''\n+        const absoluteFilePath = path.join(\n+          rootDirectory,\n+          'app',\n+          isSrcDir ? 'src' : '',\n+          relativeFilePath\n+        )\n+        openEditorResult = await openFileInEditor(absoluteFilePath, 1, 1)\n+      } else {\n+        // frame files may start with their webpack layer, like (middleware)/middleware.js\n+        const filePath = path.resolve(\n+          rootDirectory,\n+          frame.file.replace(/^\\([^)]+\\)\\//, '')\n+        )\n+        openEditorResult = await openFileInEditor(\n+          filePath,\n+          frame.lineNumber,\n+          frame.column ?? 1\n+        )\n+      }\n+      if (openEditorResult.error) {\n+        console.error('Failed to launch editor:', openEditorResult.error)\n+        return middlewareResponse.internalServerError(\n+          res,\n+          openEditorResult.error\n+        )\n+      }\n+      if (!openEditorResult.found) {\n+        return middlewareResponse.notFound(res)\n       }\n-\n       return middlewareResponse.noContent(res)\n     }\n "
        },
        {
            "sha": "78d5a61691f3495f198d08e36b10f37273007aa4",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/be43ff10d4f5a3ce8e07cf286b456e44c4ca448b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=be43ff10d4f5a3ce8e07cf286b456e44c4ca448b",
            "patch": "@@ -158,7 +158,11 @@ export async function propagateServerField(\n   await opts.renderServer?.instance?.propagateServerField(opts.dir, field, args)\n }\n \n-async function startWatcher(opts: SetupOpts) {\n+async function startWatcher(\n+  opts: SetupOpts & {\n+    isSrcDir: boolean\n+  }\n+) {\n   const { nextConfig, appDir, pagesDir, dir, resetFetch } = opts\n   const { useFileSystemPublicRoutes } = nextConfig\n   const usingTypeScript = await verifyTypeScript(opts)\n@@ -191,6 +195,7 @@ async function startWatcher(opts: SetupOpts) {\n   const hotReloader: NextJsHotReloaderInterface = opts.turbo\n     ? await createHotReloaderTurbopack(opts, serverFields, distDir, resetFetch)\n     : new HotReloaderWebpack(opts.dir, {\n+        isSrcDir: opts.isSrcDir,\n         appDir,\n         pagesDir,\n         distDir,\n@@ -1026,7 +1031,10 @@ export async function setupDevBundler(opts: SetupOpts) {\n     .relative(opts.dir, opts.pagesDir || opts.appDir || '')\n     .startsWith('src')\n \n-  const result = await startWatcher(opts)\n+  const result = await startWatcher({\n+    ...opts,\n+    isSrcDir,\n+  })\n \n   opts.telemetry.record(\n     eventCliSession("
        }
    ],
    "stats": {
        "total": 181,
        "additions": 138,
        "deletions": 43
    }
}