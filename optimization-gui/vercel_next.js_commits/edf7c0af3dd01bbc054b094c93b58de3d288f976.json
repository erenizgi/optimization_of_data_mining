{
    "author": "devjiwonchoi",
    "message": "[devtools] fullscreen mode should not be draggable (#80845)\n\nWhen the DevTools panel is in full-screen mode, it should not be draggable.\r\n\r\nCloses NEXT-4565",
    "sha": "edf7c0af3dd01bbc054b094c93b58de3d288f976",
    "files": [
        {
            "sha": "a41f39ccaf216588927421bc5097a9e0446c32b6",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-panel/devtools-panel-footer.tsx",
            "status": "modified",
            "additions": 6,
            "deletions": 10,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/edf7c0af3dd01bbc054b094c93b58de3d288f976/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel-footer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/edf7c0af3dd01bbc054b094c93b58de3d288f976/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel-footer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel-footer.tsx?ref=edf7c0af3dd01bbc054b094c93b58de3d288f976",
            "patch": "@@ -7,14 +7,19 @@ import { css } from '../../utils/css'\n \n export function DevToolsPanelFooter({\n   versionInfo,\n+  isDraggable,\n }: {\n   versionInfo: OverlayState['versionInfo']\n+  isDraggable: boolean\n }) {\n   const bundlerName = (\n     process.env.__NEXT_BUNDLER || 'WEBPACK'\n   ).toUpperCase() as 'WEBPACK' | 'TURBOPACK' | 'RSPACK'\n   return (\n-    <div data-nextjs-devtools-panel-footer>\n+    <div\n+      data-nextjs-devtools-panel-footer\n+      data-nextjs-devtools-panel-draggable={isDraggable}\n+    >\n       <div data-nextjs-devtools-panel-footer-tab-group>\n         <DevToolsPanelVersionInfo versionInfo={versionInfo} />\n         <div data-nextjs-devtools-panel-footer-tab>\n@@ -51,15 +56,6 @@ export const DEVTOOLS_PANEL_FOOTER_STYLES = css`\n     align-items: center;\n     border-top: 1px solid var(--color-gray-400);\n     border-radius: 0 0 var(--rounded-xl) var(--rounded-xl);\n-\n-    /* For draggable */\n-    cursor: move;\n-    user-select: none;\n-    & > * {\n-      cursor: auto;\n-      /* user-select: auto; follows the parent (parent none -> child none), so reset the direct child to text */\n-      user-select: text;\n-    }\n   }\n \n   [data-nextjs-devtools-panel-footer-tab-group] {"
        },
        {
            "sha": "c62650045badf864c907882e99a0412e82e22a74",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/devtools-panel/devtools-panel.tsx",
            "status": "modified",
            "additions": 19,
            "deletions": 11,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/edf7c0af3dd01bbc054b094c93b58de3d288f976/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/edf7c0af3dd01bbc054b094c93b58de3d288f976/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Fdevtools-panel%2Fdevtools-panel.tsx?ref=edf7c0af3dd01bbc054b094c93b58de3d288f976",
            "patch": "@@ -110,6 +110,7 @@ export function DevToolsPanel({\n           })\n         }}\n         dragHandleSelector=\"[data-nextjs-devtools-panel-header], [data-nextjs-devtools-panel-footer]\"\n+        disableDrag={isFullscreen}\n       >\n         <>\n           <Dialog\n@@ -120,7 +121,10 @@ export function DevToolsPanel({\n           >\n             <DialogContent data-nextjs-devtools-panel-dialog-content>\n               <DialogHeader data-nextjs-devtools-panel-dialog-header>\n-                <div data-nextjs-devtools-panel-header>\n+                <div\n+                  data-nextjs-devtools-panel-header\n+                  data-nextjs-devtools-panel-draggable={!isFullscreen}\n+                >\n                   <div data-nextjs-devtools-panel-header-tab-group>\n                     <button\n                       data-nextjs-devtools-panel-header-tab={\n@@ -187,7 +191,10 @@ export function DevToolsPanel({\n                 />\n               </DialogBody>\n             </DialogContent>\n-            <DevToolsPanelFooter versionInfo={state.versionInfo} />\n+            <DevToolsPanelFooter\n+              versionInfo={state.versionInfo}\n+              isDraggable={!isFullscreen}\n+            />\n           </Dialog>\n         </>\n       </Draggable>\n@@ -273,15 +280,6 @@ export const DEVTOOLS_PANEL_STYLES = css`\n     justify-content: space-between;\n     align-items: center;\n     border-bottom: 1px solid var(--color-gray-400);\n-\n-    /* For draggable */\n-    cursor: move;\n-    user-select: none;\n-    & > * {\n-      cursor: auto;\n-      /* user-select: auto; follows the parent (parent none -> child none), so reset the direct child to text */\n-      user-select: text;\n-    }\n   }\n \n   [data-nextjs-devtools-panel-header-tab-group] {\n@@ -357,4 +355,14 @@ export const DEVTOOLS_PANEL_STYLES = css`\n       background-color: var(--color-gray-300);\n     }\n   }\n+\n+  [data-nextjs-devtools-panel-draggable='true'] {\n+    cursor: move;\n+    user-select: none;\n+    & > * {\n+      cursor: auto;\n+      /* user-select: auto; follows the parent (parent none -> child none), so reset the direct child to text */\n+      user-select: text;\n+    }\n+  }\n `"
        },
        {
            "sha": "a5aae22d9df6f0b7d5b92e283df433ae0f2d1b7a",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/errors/dev-tools-indicator/draggable.tsx",
            "status": "modified",
            "additions": 58,
            "deletions": 17,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/edf7c0af3dd01bbc054b094c93b58de3d288f976/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdraggable.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/edf7c0af3dd01bbc054b094c93b58de3d288f976/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdraggable.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Ferrors%2Fdev-tools-indicator%2Fdraggable.tsx?ref=edf7c0af3dd01bbc054b094c93b58de3d288f976",
            "patch": "@@ -1,5 +1,5 @@\n import type { Corners } from '../../../shared'\n-import { useRef } from 'react'\n+import { useCallback, useLayoutEffect, useRef } from 'react'\n \n interface Point {\n   x: number\n@@ -18,6 +18,7 @@ export function Draggable({\n   setPosition: setCurrentCorner,\n   onDragStart,\n   dragHandleSelector,\n+  disableDrag = false,\n   ...props\n }: {\n   children: React.ReactElement\n@@ -26,8 +27,10 @@ export function Draggable({\n   setPosition: (position: Corners) => void\n   onDragStart?: () => void\n   dragHandleSelector?: string\n+  disableDrag?: boolean\n }) {\n   const { ref, animate, ...drag } = useDrag({\n+    disabled: disableDrag,\n     threshold: 5,\n     onDragStart,\n     onDragEnd,\n@@ -132,6 +135,7 @@ export function Draggable({\n }\n \n interface UseDragOptions {\n+  disabled: boolean\n   onDragStart?: () => void\n   onDrag?: (translation: Point) => void\n   onDragEnd?: (translation: Point, velocity: Point) => void\n@@ -147,13 +151,45 @@ interface Velocity {\n \n export function useDrag(options: UseDragOptions) {\n   const ref = useRef<HTMLDivElement>(null)\n-  const state = useRef<'idle' | 'press' | 'drag' | 'drag-end'>('idle')\n+  const machine = useRef<\n+    | { state: 'idle' | 'press' | 'drag-end' }\n+    | { state: 'drag'; pointerId: number }\n+  >({\n+    state: 'idle',\n+  })\n+  const cleanup = useRef<() => void>(null)\n \n   const origin = useRef<Point>({ x: 0, y: 0 })\n   const translation = useRef<Point>({ x: 0, y: 0 })\n   const lastTimestamp = useRef(0)\n   const velocities = useRef<Velocity[]>([])\n \n+  const cancel = useCallback(() => {\n+    if (machine.current.state === 'drag') {\n+      ref.current?.releasePointerCapture(machine.current.pointerId)\n+    }\n+\n+    machine.current =\n+      machine.current.state === 'drag'\n+        ? { state: 'drag-end' }\n+        : { state: 'idle' }\n+\n+    if (cleanup.current !== null) {\n+      cleanup.current()\n+      cleanup.current = null\n+    }\n+\n+    velocities.current = []\n+\n+    ref.current?.classList.remove('dev-tools-grabbing')\n+  }, [])\n+\n+  useLayoutEffect(() => {\n+    if (options.disabled) {\n+      cancel()\n+    }\n+  }, [cancel, options.disabled])\n+\n   function set(position: Point) {\n     if (ref.current) {\n       translation.current = position\n@@ -181,10 +217,10 @@ export function useDrag(options: UseDragOptions) {\n   }\n \n   function onClick(e: MouseEvent) {\n-    if (state.current === 'drag-end') {\n+    if (machine.current.state === 'drag-end') {\n       e.preventDefault()\n       e.stopPropagation()\n-      state.current = 'idle'\n+      machine.current = { state: 'idle' }\n       ref.current?.removeEventListener('click', onClick)\n     }\n   }\n@@ -215,27 +251,37 @@ export function useDrag(options: UseDragOptions) {\n     }\n \n     origin.current = { x: e.clientX, y: e.clientY }\n-    state.current = 'press'\n+    machine.current = { state: 'press' }\n     window.addEventListener('pointermove', onPointerMove)\n     window.addEventListener('pointerup', onPointerUp)\n+\n+    if (cleanup.current !== null) {\n+      cleanup.current()\n+      cleanup.current = null\n+    }\n+    cleanup.current = () => {\n+      window.removeEventListener('pointermove', onPointerMove)\n+      window.removeEventListener('pointerup', onPointerUp)\n+    }\n+\n     ref.current?.addEventListener('click', onClick)\n   }\n \n   function onPointerMove(e: PointerEvent) {\n-    if (state.current === 'press') {\n+    if (machine.current.state === 'press') {\n       const dx = e.clientX - origin.current.x\n       const dy = e.clientY - origin.current.y\n       const distance = Math.sqrt(dx * dx + dy * dy)\n \n       if (distance >= options.threshold) {\n-        state.current = 'drag'\n+        machine.current = { state: 'drag', pointerId: e.pointerId }\n         ref.current?.setPointerCapture(e.pointerId)\n         ref.current?.classList.add('dev-tools-grabbing')\n         options.onDragStart?.()\n       }\n     }\n \n-    if (state.current !== 'drag') return\n+    if (machine.current.state !== 'drag') return\n \n     const currentPosition = { x: e.clientX, y: e.clientY }\n \n@@ -265,17 +311,12 @@ export function useDrag(options: UseDragOptions) {\n     options.onDrag?.(translation.current)\n   }\n \n-  function onPointerUp(e: PointerEvent) {\n-    state.current = state.current === 'drag' ? 'drag-end' : 'idle'\n-\n-    window.removeEventListener('pointermove', onPointerMove)\n-    window.removeEventListener('pointerup', onPointerUp)\n-\n+  function onPointerUp() {\n     const velocity = calculateVelocity(velocities.current)\n-    velocities.current = []\n \n-    ref.current?.classList.remove('dev-tools-grabbing')\n-    ref.current?.releasePointerCapture(e.pointerId)\n+    cancel()\n+\n+    // TODO: This is the onDragEnd when the pointerdown event was fired not the onDragEnd when the pointerup event was fired\n     options.onDragEnd?.(translation.current, velocity)\n   }\n "
        }
    ],
    "stats": {
        "total": 121,
        "additions": 83,
        "deletions": 38
    }
}