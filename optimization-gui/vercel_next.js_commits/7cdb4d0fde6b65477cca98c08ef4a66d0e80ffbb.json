{
    "author": "mischnic",
    "message": "Abstract deployment id access into module (#86727)\n\nThis also helps with persistent-caching performance, since fewer chunks change (only the ones containing this module, as opposed to the chunks containing all the users of the value)",
    "sha": "7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
    "files": [
        {
            "sha": "dc27f1787aa3f93dc95b7a51396a49fd6c3e8077",
            "filename": "packages/next/src/build/deployment-id.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/342adb0e64465d07e2dcba922ca1fbdd6007c031/packages%2Fnext%2Fsrc%2Fbuild%2Fdeployment-id.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/342adb0e64465d07e2dcba922ca1fbdd6007c031/packages%2Fnext%2Fsrc%2Fbuild%2Fdeployment-id.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fdeployment-id.ts?ref=342adb0e64465d07e2dcba922ca1fbdd6007c031",
            "patch": "@@ -1,6 +0,0 @@\n-export function getDeploymentIdQueryOrEmptyString(): string {\n-  if (process.env.NEXT_DEPLOYMENT_ID) {\n-    return `?dpl=${process.env.NEXT_DEPLOYMENT_ID}`\n-  }\n-  return ''\n-}"
        },
        {
            "sha": "2786b0d8f122b6267b9b03e8103ba8d0a626b200",
            "filename": "packages/next/src/build/webpack/plugins/flight-manifest-plugin.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-manifest-plugin.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -19,7 +19,7 @@ import { getProxiedPluginState } from '../../build-context'\n import { WEBPACK_LAYERS } from '../../../lib/constants'\n import { normalizePagePath } from '../../../shared/lib/page-path/normalize-page-path'\n import { CLIENT_STATIC_FILES_RUNTIME_MAIN_APP } from '../../../shared/lib/constants'\n-import { getDeploymentIdQueryOrEmptyString } from '../../deployment-id'\n+import { getDeploymentIdQueryOrEmptyString } from '../../../shared/lib/deployment-id'\n import {\n   formatBarrelOptimizedResource,\n   getModuleReferencesInOrder,"
        },
        {
            "sha": "50a942a7770446d72f8a9d64d4942523d0d82fb0",
            "filename": "packages/next/src/client/app-webpack.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fapp-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fapp-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fapp-webpack.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -1,7 +1,7 @@\n // Override chunk URL mapping in the webpack runtime\n // https://github.com/webpack/webpack/blob/2738eebc7880835d88c727d364ad37f3ec557593/lib/RuntimeGlobals.js#L204\n \n-import { getDeploymentIdQueryOrEmptyString } from '../build/deployment-id'\n+import { getDeploymentIdQueryOrEmptyString } from '../shared/lib/deployment-id'\n import { encodeURIPath } from '../shared/lib/encode-uri-path'\n \n declare const __webpack_require__: any"
        },
        {
            "sha": "607e03f8941dbc265e44ec7b5b07ec0c9cd23be0",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -46,6 +46,7 @@ import RootErrorBoundary from './errors/root-error-boundary'\n import DefaultGlobalError from './builtin/global-error'\n import { RootLayoutBoundary } from '../../lib/framework/boundary-components'\n import type { StaticIndicatorState } from '../dev/hot-reloader/app/hot-reloader-app'\n+import { getDeploymentIdQueryOrEmptyString } from '../../shared/lib/deployment-id'\n \n const globalMutable: {\n   pendingMpaPath?: string\n@@ -622,9 +623,7 @@ function RuntimeStyles() {\n     }\n   }, [renderedStylesSize, forceUpdate])\n \n-  const dplId = process.env.NEXT_DEPLOYMENT_ID\n-    ? `?dpl=${process.env.NEXT_DEPLOYMENT_ID}`\n-    : ''\n+  const dplId = getDeploymentIdQueryOrEmptyString()\n   return [...runtimeStyles].map((href, i) => (\n     <link\n       key={i}"
        },
        {
            "sha": "3f712ac3aa8e4c3ed3c65adbf3bd3477f30d93c5",
            "filename": "packages/next/src/client/components/router-reducer/fetch-server-response.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Ffetch-server-response.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -41,6 +41,7 @@ import {\n   urlToUrlWithoutFlightMarker,\n } from '../../route-params'\n import type { NormalizedSearch } from '../segment-cache/cache-key'\n+import { getDeploymentId } from '../../../shared/lib/deployment-id'\n \n const createFromReadableStream =\n   createFromReadableStreamBrowser as (typeof import('react-server-dom-webpack/client.browser'))['createFromReadableStream']\n@@ -329,8 +330,9 @@ export async function createFetch<T>(\n     headers['Next-Test-Fetch-Priority'] = fetchPriority\n   }\n \n-  if (process.env.NEXT_DEPLOYMENT_ID) {\n-    headers['x-deployment-id'] = process.env.NEXT_DEPLOYMENT_ID\n+  const deploymentId = getDeploymentId()\n+  if (deploymentId) {\n+    headers['x-deployment-id'] = deploymentId\n   }\n \n   if (process.env.NODE_ENV !== 'production') {"
        },
        {
            "sha": "a6d721d0f08058460b90de7b877afa634d6146d0",
            "filename": "packages/next/src/client/components/router-reducer/reducers/server-action-reducer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Fserver-action-reducer.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -56,6 +56,7 @@ import {\n   omitUnusedArgs,\n } from '../../../../shared/lib/server-reference-info'\n import { revalidateEntireCache } from '../../segment-cache/cache'\n+import { getDeploymentId } from '../../../../shared/lib/deployment-id'\n \n const createFromFetch =\n   createFromFetchBrowser as (typeof import('react-server-dom-webpack/client.browser'))['createFromFetch']\n@@ -110,8 +111,9 @@ async function fetchServerAction(\n     ),\n   }\n \n-  if (process.env.NEXT_DEPLOYMENT_ID) {\n-    headers['x-deployment-id'] = process.env.NEXT_DEPLOYMENT_ID\n+  const deploymentId = getDeploymentId()\n+  if (deploymentId) {\n+    headers['x-deployment-id'] = deploymentId\n   }\n \n   if (nextUrl) {"
        },
        {
            "sha": "43cbda00636d152020b139063240cf4efe72270e",
            "filename": "packages/next/src/client/route-loader.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Froute-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Froute-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Froute-loader.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -3,7 +3,7 @@ import type { ProxyMatcher } from '../build/analysis/get-page-static-info'\n import getAssetPathFromRoute from '../shared/lib/router/utils/get-asset-path-from-route'\n import { __unsafeCreateTrustedScriptURL } from './trusted-types'\n import { requestIdleCallback } from './request-idle-callback'\n-import { getDeploymentIdQueryOrEmptyString } from '../build/deployment-id'\n+import { getDeploymentIdQueryOrEmptyString } from '../shared/lib/deployment-id'\n import { encodeURIPath } from '../shared/lib/encode-uri-path'\n \n // 3.8s was arbitrarily chosen as it's what https://web.dev/interactive"
        },
        {
            "sha": "dd0f5ba38f62c6840b9498c83f24068f0fda58c7",
            "filename": "packages/next/src/client/webpack.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fwebpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fclient%2Fwebpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fwebpack.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -1,11 +1,14 @@\n declare const __webpack_require__: any\n declare let __webpack_public_path__: string\n \n-import { getDeploymentIdQueryOrEmptyString } from '../build/deployment-id'\n+import {\n+  getDeploymentId,\n+  getDeploymentIdQueryOrEmptyString,\n+} from '../shared/lib/deployment-id'\n \n // If we have a deployment ID, we need to append it to the webpack chunk names\n // I am keeping the process check explicit so this can be statically optimized\n-if (process.env.NEXT_DEPLOYMENT_ID) {\n+if (getDeploymentId()) {\n   const suffix = getDeploymentIdQueryOrEmptyString()\n   const getChunkScriptFilename = __webpack_require__.u\n   __webpack_require__.u = (...args: any[]) =>"
        },
        {
            "sha": "b8c7b7bd197424049b5caf64b029d743132ca0f5",
            "filename": "packages/next/src/server/route-modules/pages/pages-handler.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Fpages%2Fpages-handler.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -42,6 +42,7 @@ import type {\n   GetStaticPaths,\n   GetStaticProps,\n } from '../../../types'\n+import { getDeploymentId } from '../../../shared/lib/deployment-id'\n \n export const getHandler = ({\n   srcPage: originalSrcPage,\n@@ -257,7 +258,7 @@ export const getHandler = ({\n                     buildId,\n                     customServer:\n                       Boolean(routerServerContext?.isCustomServer) || undefined,\n-                    deploymentId: process.env.NEXT_DEPLOYMENT_ID,\n+                    deploymentId: getDeploymentId(),\n                   },\n                   renderOpts: {\n                     params,"
        },
        {
            "sha": "6ca906f00fe7e6b6ad1865425f9cd8ccfd41cfc1",
            "filename": "packages/next/src/shared/lib/deployment-id.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdeployment-id.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdeployment-id.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fdeployment-id.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -0,0 +1,13 @@\n+// This could also be a variable instead of a function, but some unit tests want to change the ID at\n+// runtime. Even though that would never happen in a real deployment.\n+export function getDeploymentId(): string | undefined {\n+  return process.env.NEXT_DEPLOYMENT_ID\n+}\n+\n+export function getDeploymentIdQueryOrEmptyString(): string {\n+  let deploymentId = getDeploymentId()\n+  if (deploymentId) {\n+    return `?dpl=${deploymentId}`\n+  }\n+  return ''\n+}"
        },
        {
            "sha": "16041bc50c8746b1f53a4d1364d3bb4bf4bfa632",
            "filename": "packages/next/src/shared/lib/image-loader.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fimage-loader.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -1,5 +1,6 @@\n import type { ImageLoaderPropsWithConfig } from './image-config'\n import { findClosestQuality } from './find-closest-quality'\n+import { getDeploymentId } from './deployment-id'\n \n function defaultLoader({\n   config,\n@@ -94,9 +95,10 @@ function defaultLoader({\n \n   const q = findClosestQuality(quality, config)\n \n+  let deploymentId = getDeploymentId()\n   return `${config.path}?url=${encodeURIComponent(src)}&w=${width}&q=${q}${\n-    src.startsWith('/_next/static/media/') && process.env.NEXT_DEPLOYMENT_ID\n-      ? `&dpl=${process.env.NEXT_DEPLOYMENT_ID}`\n+    src.startsWith('/_next/static/media/') && deploymentId\n+      ? `&dpl=${deploymentId}`\n       : ''\n   }`\n }"
        },
        {
            "sha": "42e38a8a25f2a67f0de739ca67c84e582531aac9",
            "filename": "packages/next/src/shared/lib/lazy-dynamic/preload-chunks.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Flazy-dynamic%2Fpreload-chunks.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Flazy-dynamic%2Fpreload-chunks.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Flazy-dynamic%2Fpreload-chunks.tsx?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -4,6 +4,7 @@ import { preload } from 'react-dom'\n \n import { workAsyncStorage } from '../../../server/app-render/work-async-storage.external'\n import { encodeURIPath } from '../encode-uri-path'\n+import { getDeploymentIdQueryOrEmptyString } from '../deployment-id'\n \n export function PreloadChunks({\n   moduleIds,\n@@ -37,9 +38,7 @@ export function PreloadChunks({\n     return null\n   }\n \n-  const dplId = process.env.NEXT_DEPLOYMENT_ID\n-    ? `?dpl=${process.env.NEXT_DEPLOYMENT_ID}`\n-    : ''\n+  const dplId = getDeploymentIdQueryOrEmptyString()\n \n   return (\n     <>"
        },
        {
            "sha": "233f8b31f734026303e05d79ea3084d1feb1699a",
            "filename": "packages/next/src/shared/lib/router/router.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Frouter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Frouter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Frouter%2Frouter.ts?ref=7cdb4d0fde6b65477cca98c08ef4a66d0e80ffbb",
            "patch": "@@ -43,6 +43,7 @@ import { interpolateAs } from './utils/interpolate-as'\n import { disableSmoothScrollDuringRouteTransition } from './utils/disable-smooth-scroll'\n import type { Params } from '../../../server/request/params'\n import { MATCHED_PATH_HEADER } from '../../../lib/constants'\n+import { getDeploymentId } from '../deployment-id'\n \n let resolveRewrites: typeof import('./utils/resolve-rewrites').default\n if (process.env.__NEXT_HAS_REWRITES) {\n@@ -497,15 +498,14 @@ function fetchNextData({\n   unstable_skipClientCache,\n }: FetchNextDataParams): Promise<FetchDataOutput> {\n   const { href: cacheKey } = new URL(dataHref, window.location.href)\n+  const deploymentId = getDeploymentId()\n   const getData = (params?: { method?: 'HEAD' | 'GET' }) =>\n     fetchRetry(dataHref, isServerRender ? 3 : 1, {\n       headers: Object.assign(\n         {} as HeadersInit,\n         isPrefetch ? { purpose: 'prefetch' } : {},\n         isPrefetch && hasMiddleware ? { 'x-middleware-prefetch': '1' } : {},\n-        process.env.NEXT_DEPLOYMENT_ID\n-          ? { 'x-deployment-id': process.env.NEXT_DEPLOYMENT_ID }\n-          : {}\n+        deploymentId ? { 'x-deployment-id': deploymentId } : {}\n       ),\n       method: params?.method ?? 'GET',\n     })"
        }
    ],
    "stats": {
        "total": 69,
        "additions": 42,
        "deletions": 27
    }
}