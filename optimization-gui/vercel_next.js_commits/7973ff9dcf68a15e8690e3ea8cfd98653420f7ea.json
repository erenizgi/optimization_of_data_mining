{
    "author": "mischnic",
    "message": "Store preview id for two weeks (#79972)\n\nCreate a file `.previewinfo` (like `.rscinfo`) to store the preview mode keys (which are stored in `prerender-manifest.json` and were previously changing on every single commit)\n```\n  \"preview\": {\n    \"previewModeId\": \"6ec938745bce9b5d51329802d1a9788a\",\n    \"previewModeSigningKey\": \"f3df5e714dd35c14fedb15b396566ae9530e058f5dde09a82b12941214d96c4d\",\n    \"previewModeEncryptionKey\": \"675f97882ebc73c55bc51903f4e5c8d3a17ac90108847ed1b1b90a46d84f368e\"\n  }\n```",
    "sha": "7973ff9dcf68a15e8690e3ea8cfd98653420f7ea",
    "files": [
        {
            "sha": "0309800f9392407e31769377d820d418bad99892",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 6,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/7973ff9dcf68a15e8690e3ea8cfd98653420f7ea/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7973ff9dcf68a15e8690e3ea8cfd98653420f7ea/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=7973ff9dcf68a15e8690e3ea8cfd98653420f7ea",
            "patch": "@@ -9,7 +9,6 @@ import '../lib/setup-exception-listeners'\n \n import { loadEnvConfig, type LoadedEnvFiles } from '@next/env'\n import { bold, yellow } from '../lib/picocolors'\n-import crypto from 'crypto'\n import { makeRe } from 'next/dist/compiled/picomatch'\n import { existsSync, promises as fs } from 'fs'\n import os from 'os'\n@@ -210,6 +209,7 @@ import { durationToString } from './duration-to-string'\n import { traceGlobals } from '../trace/shared'\n import { extractNextErrorCode } from '../lib/error-telemetry-utils'\n import { runAfterProductionCompile } from './after-production-compile'\n+import { generatePreviewKeys } from './preview-key-utils'\n \n type Fallback = null | boolean | string\n \n@@ -1093,11 +1093,10 @@ export default async function build(\n \n       NextBuildContext.hasInstrumentationHook = hasInstrumentationHook\n \n-      const previewProps: __ApiPreviewProps = {\n-        previewModeId: crypto.randomBytes(16).toString('hex'),\n-        previewModeSigningKey: crypto.randomBytes(32).toString('hex'),\n-        previewModeEncryptionKey: crypto.randomBytes(32).toString('hex'),\n-      }\n+      const previewProps: __ApiPreviewProps = await generatePreviewKeys({\n+        isBuild: true,\n+        distDir,\n+      })\n       NextBuildContext.previewProps = previewProps\n \n       const mappedPages = await nextBuildSpan"
        },
        {
            "sha": "970ed3d8e48aab18ed5637828449ace7a018fbc7",
            "filename": "packages/next/src/build/preview-key-utils.ts",
            "status": "added",
            "additions": 100,
            "deletions": 0,
            "changes": 100,
            "blob_url": "https://github.com/vercel/next.js/blob/7973ff9dcf68a15e8690e3ea8cfd98653420f7ea/packages%2Fnext%2Fsrc%2Fbuild%2Fpreview-key-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7973ff9dcf68a15e8690e3ea8cfd98653420f7ea/packages%2Fnext%2Fsrc%2Fbuild%2Fpreview-key-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fpreview-key-utils.ts?ref=7973ff9dcf68a15e8690e3ea8cfd98653420f7ea",
            "patch": "@@ -0,0 +1,100 @@\n+import path from 'path'\n+import fs from 'fs'\n+import crypto from 'crypto'\n+import type { __ApiPreviewProps } from '../server/api-utils'\n+import { getStorageDirectory } from '../server/cache-dir'\n+\n+const CONFIG_FILE = '.previewinfo'\n+const PREVIEW_ID = 'previewModeId'\n+const PREVIEW_SIGNING_KEY = 'previewModeSigningKey'\n+const PREVIEW_ENCRYPTION_KEY = 'previewModeEncryptionKey'\n+const PREVIEW_EXPIRE_AT = 'expireAt'\n+const EXPIRATION = 1000 * 60 * 60 * 24 * 14 // 14 days\n+\n+async function writeCache(distDir: string, config: __ApiPreviewProps) {\n+  const cacheBaseDir = getStorageDirectory(distDir)\n+  if (!cacheBaseDir) return\n+\n+  const configPath = path.join(cacheBaseDir, CONFIG_FILE)\n+  if (!fs.existsSync(cacheBaseDir)) {\n+    await fs.promises.mkdir(cacheBaseDir, { recursive: true })\n+  }\n+  await fs.promises.writeFile(\n+    configPath,\n+    JSON.stringify({\n+      [PREVIEW_ID]: config.previewModeId,\n+      [PREVIEW_SIGNING_KEY]: config.previewModeSigningKey,\n+      [PREVIEW_ENCRYPTION_KEY]: config.previewModeEncryptionKey,\n+      [PREVIEW_EXPIRE_AT]: Date.now() + EXPIRATION,\n+    })\n+  )\n+}\n+\n+function generateConfig() {\n+  return {\n+    previewModeId: crypto.randomBytes(16).toString('hex'),\n+    previewModeSigningKey: crypto.randomBytes(32).toString('hex'),\n+    previewModeEncryptionKey: crypto.randomBytes(32).toString('hex'),\n+  }\n+}\n+\n+// This utility is used to get a key for the cache directory. If the\n+// key is not present, it will generate a new one and store it in the\n+// cache directory inside dist.\n+// The key will also expire after a certain amount of time. Once it\n+// expires, a new one will be generated.\n+export async function generatePreviewKeys({\n+  distDir,\n+  isBuild,\n+}: {\n+  distDir: string\n+  isBuild: boolean\n+}): Promise<__ApiPreviewProps> {\n+  const cacheBaseDir = getStorageDirectory(distDir)\n+\n+  if (!cacheBaseDir) {\n+    // There's no persistent storage available. We generate a new config.\n+    // This also covers development time.\n+    return generateConfig()\n+  }\n+\n+  const configPath = path.join(cacheBaseDir, CONFIG_FILE)\n+  async function tryReadCachedConfig(): Promise<false | __ApiPreviewProps> {\n+    if (!fs.existsSync(configPath)) return false\n+    try {\n+      const config = JSON.parse(await fs.promises.readFile(configPath, 'utf8'))\n+      if (!config) return false\n+      if (\n+        typeof config[PREVIEW_ID] !== 'string' ||\n+        typeof config[PREVIEW_ENCRYPTION_KEY] !== 'string' ||\n+        typeof config[PREVIEW_SIGNING_KEY] !== 'string' ||\n+        typeof config[PREVIEW_EXPIRE_AT] !== 'number'\n+      ) {\n+        return false\n+      }\n+      // For build time, we need to rotate the key if it's expired. Otherwise\n+      // (next start) we have to keep the key as it is so the runtime key matches\n+      // the build time key.\n+      if (isBuild && config[PREVIEW_EXPIRE_AT] < Date.now()) {\n+        return false\n+      }\n+\n+      return {\n+        previewModeId: config[PREVIEW_ID],\n+        previewModeSigningKey: config[PREVIEW_SIGNING_KEY],\n+        previewModeEncryptionKey: config[PREVIEW_ENCRYPTION_KEY],\n+      }\n+    } catch (e) {\n+      // Broken config file. We should generate a new key and overwrite it.\n+      return false\n+    }\n+  }\n+  const maybeValidConfig = await tryReadCachedConfig()\n+  if (maybeValidConfig !== false) {\n+    return maybeValidConfig\n+  }\n+  const config = generateConfig()\n+  await writeCache(distDir, config)\n+\n+  return config\n+}"
        }
    ],
    "stats": {
        "total": 111,
        "additions": 105,
        "deletions": 6
    }
}