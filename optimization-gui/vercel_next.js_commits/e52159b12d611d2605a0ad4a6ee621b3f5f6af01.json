{
    "author": "wbinnssmith",
    "message": "bundle-analyzer: make running the web server default (#87258)",
    "sha": "e52159b12d611d2605a0ad4a6ee621b3f5f6af01",
    "files": [
        {
            "sha": "abfaae3afc8e3ea4b955c23f8f86305f6258dbde",
            "filename": "packages/next/src/bin/next.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 3,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/e52159b12d611d2605a0ad4a6ee621b3f5f6af01/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e52159b12d611d2605a0ad4a6ee621b3f5f6af01/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbin%2Fnext.ts?ref=e52159b12d611d2605a0ad4a6ee621b3f5f6af01",
            "patch": "@@ -202,7 +202,7 @@ program\n program\n   .command('experimental-analyze')\n   .description(\n-    'Analyze bundle output. Does not produce build artifacts. Only compatible with Turbopack.'\n+    'Analyze production bundle output with an interactive web ui. Does not produce an application build. Only compatible with Turbopack.'\n   )\n   .argument(\n     '[directory]',\n@@ -212,7 +212,10 @@ program\n   )\n   .option('--no-mangling', 'Disables mangling.')\n   .option('--profile', 'Enables production profiling for React.')\n-  .option('--serve', 'Serve the bundle analyzer in a browser after analysis.')\n+  .option(\n+    '-o, --output [path]',\n+    'Only write analysis files to disk. Does not start the server. Optionally specify a custom output path (defaults to .next/diagnostics/analyze).'\n+  )\n   .addOption(\n     new Option(\n       '--port <port>',\n@@ -227,7 +230,7 @@ program\n     return import('../cli/next-analyze.js')\n       .then((mod) => mod.nextAnalyze(options, directory))\n       .then(() => {\n-        if (!options.serve) {\n+        if (options.output) {\n           // The Next.js process is held open by something on the event loop. Exit manually like the `build` command does.\n           // TODO: Fix the underlying issue so this is not necessary.\n           process.exit(0)"
        },
        {
            "sha": "58955a8fec1cf10a346829b438a6b0fe872b7de4",
            "filename": "packages/next/src/build/analyze/index.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 9,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/e52159b12d611d2605a0ad4a6ee621b3f5f6af01/packages%2Fnext%2Fsrc%2Fbuild%2Fanalyze%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e52159b12d611d2605a0ad4a6ee621b3f5f6af01/packages%2Fnext%2Fsrc%2Fbuild%2Fanalyze%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fanalyze%2Findex.ts?ref=e52159b12d611d2605a0ad4a6ee621b3f5f6af01",
            "patch": "@@ -37,7 +37,7 @@ export type AnalyzeOptions = {\n   reactProductionProfiling?: boolean\n   noMangling?: boolean\n   appDirOnly?: boolean\n-  serve?: boolean\n+  output?: boolean | string\n   port?: number\n }\n \n@@ -46,7 +46,7 @@ export default async function analyze({\n   reactProductionProfiling = false,\n   noMangling = false,\n   appDirOnly = false,\n-  serve = false,\n+  output = false,\n   port = 4000,\n }: AnalyzeOptions): Promise<void> {\n   try {\n@@ -77,26 +77,33 @@ export default async function analyze({\n       await turbopackAnalyze(analyzeContext)\n \n     const durationString = durationToString(analyzeDuration)\n+\n+    // Determine the output path: use custom path if provided, otherwise default\n+    const outputPath = typeof output === 'string' ? output : ANALYZE_PATH\n+    const resolvedOutputPath = path.isAbsolute(outputPath)\n+      ? outputPath\n+      : path.join(dir, outputPath)\n+\n     let logMessage = `Analyze completed in ${durationString}.`\n-    if (!serve) {\n-      logMessage += ` To explore the analyze results, run \\`next experimental-analyze --serve\\`.`\n+    if (output) {\n+      logMessage += ` Results written to ${outputPath}.\\nTo explore the analyze results interactively, run \\`next experimental-analyze\\` without \\`--output\\`.`\n     }\n     Log.event(logMessage)\n \n     await shutdownPromise\n \n     await cp(\n       path.join(__dirname, '../../bundle-analyzer'),\n-      path.join(dir, ANALYZE_PATH),\n+      resolvedOutputPath,\n       { recursive: true }\n     )\n \n     // Collect and write routes for the bundle analyzer\n     const routes = await collectRoutesForAnalyze(dir, config, appDirOnly)\n \n-    await mkdir(path.join(dir, ANALYZE_PATH, 'data'), { recursive: true })\n+    await mkdir(path.join(resolvedOutputPath, 'data'), { recursive: true })\n     await writeFile(\n-      path.join(dir, ANALYZE_PATH, 'data', 'routes.json'),\n+      path.join(resolvedOutputPath, 'data', 'routes.json'),\n       JSON.stringify(routes, null, 2)\n     )\n \n@@ -108,8 +115,8 @@ export default async function analyze({\n       })\n     )\n \n-    if (serve) {\n-      await startServer(path.join(dir, ANALYZE_PATH), port)\n+    if (!output) {\n+      await startServer(resolvedOutputPath, port)\n     }\n   } catch (e) {\n     const telemetry = traceGlobals.get('telemetry') as Telemetry | undefined"
        },
        {
            "sha": "315626820a6ab5c799b29344b91f448e1a76c733",
            "filename": "packages/next/src/cli/next-analyze.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/e52159b12d611d2605a0ad4a6ee621b3f5f6af01/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e52159b12d611d2605a0ad4a6ee621b3f5f6af01/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-analyze.ts?ref=e52159b12d611d2605a0ad4a6ee621b3f5f6af01",
            "patch": "@@ -13,15 +13,15 @@ export type NextAnalyzeOptions = {\n   profile?: boolean\n   mangling: boolean\n   port: number\n-  serve: boolean\n+  output: boolean | string\n   experimentalAppOnly?: boolean\n }\n \n const nextAnalyze = async (options: NextAnalyzeOptions, directory?: string) => {\n   process.on('SIGTERM', () => process.exit(143))\n   process.on('SIGINT', () => process.exit(130))\n \n-  const { profile, mangling, experimentalAppOnly, serve, port } = options\n+  const { profile, mangling, experimentalAppOnly, output, port } = options\n \n   if (!mangling) {\n     warn(\n@@ -46,7 +46,7 @@ const nextAnalyze = async (options: NextAnalyzeOptions, directory?: string) => {\n     reactProductionProfiling: profile,\n     noMangling: !mangling,\n     appDirOnly: experimentalAppOnly,\n-    serve,\n+    output,\n     port,\n   })\n }"
        },
        {
            "sha": "3b921f99d1c6ee43f9264444b1fa3b7eb10e9fe2",
            "filename": "test/e2e/next-analyze/next-analyze.test.ts",
            "status": "modified",
            "additions": 75,
            "deletions": 9,
            "changes": 84,
            "blob_url": "https://github.com/vercel/next.js/blob/e52159b12d611d2605a0ad4a6ee621b3f5f6af01/test%2Fe2e%2Fnext-analyze%2Fnext-analyze.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/e52159b12d611d2605a0ad4a6ee621b3f5f6af01/test%2Fe2e%2Fnext-analyze%2Fnext-analyze.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fnext-analyze%2Fnext-analyze.test.ts?ref=e52159b12d611d2605a0ad4a6ee621b3f5f6af01",
            "patch": "@@ -2,9 +2,11 @@ import { nextTestSetup } from 'e2e-utils'\n import { runNextCommand, shouldUseTurbopack } from 'next-test-utils'\n import path from 'node:path'\n import { ChildProcess, spawn } from 'node:child_process'\n+import { existsSync, readFileSync } from 'node:fs'\n \n describe('next experimental-analyze', () => {\n   if (!shouldUseTurbopack()) {\n+    // Test suites require at least one test\n     it('skips in non-Turbopack tests', () => {})\n     return\n   }\n@@ -16,25 +18,18 @@ describe('next experimental-analyze', () => {\n   })\n \n   if (skipped) {\n+    // Test suites require at least one test\n     it('is skipped', () => {})\n     return\n   }\n \n   it('runs successfully without errors', async () => {\n-    const { code, stderr } = await runNextCommand(['experimental-analyze'], {\n-      cwd: next.testDir,\n-      stderr: true,\n-    })\n-\n-    expect(code).toBe(0)\n-    expect(stderr).not.toContain('Error')\n-\n     const nextDir = path.dirname(require.resolve('next/package'))\n     const nextBin = path.join(nextDir, 'dist/bin/next')\n \n     const serveProcess = spawn(\n       'node',\n-      [nextBin, 'experimental-analyze', '--serve', '--port', '0'],\n+      [nextBin, 'experimental-analyze', '--port', '0'],\n       {\n         cwd: next.testDir,\n         stdio: ['ignore', 'pipe', 'pipe'],\n@@ -52,6 +47,77 @@ describe('next experimental-analyze', () => {\n       serveProcess.kill()\n     }\n   })\n+  ;['-o', '--output'].forEach((flag) => {\n+    describe(`with ${flag} flag`, () => {\n+      it('writes output to default path when no path is specified', async () => {\n+        const defaultOutputPath = path.join(\n+          next.testDir,\n+          '.next/diagnostics/analyze'\n+        )\n+\n+        const { code, stderr, stdout } = await runNextCommand(\n+          ['experimental-analyze', flag],\n+          {\n+            cwd: next.testDir,\n+            stderr: true,\n+            stdout: true,\n+          }\n+        )\n+\n+        expect(code).toBe(0)\n+        expect(stderr).not.toContain('Error')\n+        expect(stdout).toContain('.next/diagnostics/analyze')\n+\n+        expect(existsSync(defaultOutputPath)).toBe(true)\n+        expect(existsSync(path.join(defaultOutputPath, 'index.html'))).toBe(\n+          true\n+        )\n+        expect(\n+          existsSync(path.join(defaultOutputPath, 'data', 'routes.json'))\n+        ).toBe(true)\n+\n+        const routesJson = readFileSync(\n+          path.join(defaultOutputPath, 'data', 'routes.json'),\n+          'utf-8'\n+        )\n+        const routes = JSON.parse(routesJson)\n+        expect(routes).toEqual(['/', '/_not-found'])\n+      })\n+\n+      it('writes output to custom path', async () => {\n+        const customOutputPath = path.join(\n+          next.testDir,\n+          'nested/output/directory'\n+        )\n+\n+        const { code, stderr, stdout } = await runNextCommand(\n+          ['experimental-analyze', flag, 'nested/output/directory'],\n+          {\n+            cwd: next.testDir,\n+            stderr: true,\n+            stdout: true,\n+          }\n+        )\n+\n+        expect(code).toBe(0)\n+        expect(stderr).not.toContain('Error')\n+        expect(stdout).toContain('nested/output/directory')\n+\n+        expect(existsSync(customOutputPath)).toBe(true)\n+        expect(existsSync(path.join(customOutputPath, 'index.html'))).toBe(true)\n+        expect(\n+          existsSync(path.join(customOutputPath, 'data', 'routes.json'))\n+        ).toBe(true)\n+\n+        const routesJson = readFileSync(\n+          path.join(customOutputPath, 'data', 'routes.json'),\n+          'utf-8'\n+        )\n+        const routes = JSON.parse(routesJson)\n+        expect(routes).toEqual(['/', '/_not-found'])\n+      })\n+    })\n+  })\n })\n \n function waitForServer(process: ChildProcess, timeoutMs: number = 30000) {"
        }
    ],
    "stats": {
        "total": 124,
        "additions": 100,
        "deletions": 24
    }
}