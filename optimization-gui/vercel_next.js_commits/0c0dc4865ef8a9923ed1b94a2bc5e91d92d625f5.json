{
    "author": "eps1lon",
    "message": "[sourcemaps] Ensure codeframe when calling Client Functions from Server (#81918)\n\nWe just need to give a special name to that module so that we can ignore-list it later.\r\n\r\nFor Webpack I chose the same approach as https://github.com/vercel/next.js/pull/81229. Turbopack already sourcemapped the generated module.\r\n\r\nCloses https://linear.app/vercel/issue/NAR-234\r\n\r\nRSPack team is informed. Their compat layer doesn't implement `createFilename`",
    "sha": "0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5",
    "files": [
        {
            "sha": "ad6aa7eb0f41efaf8f1c5bb107600cdd835ca8f4",
            "filename": "crates/next-core/src/next_client_reference/ecmascript_client_reference/ecmascript_client_reference_module.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fecmascript_client_reference%2Fecmascript_client_reference_module.rs?ref=0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5",
            "patch": "@@ -85,6 +85,7 @@ impl EcmascriptClientReferenceModule {\n             writedoc!(\n                 code,\n                 r#\"\n+                    // This file is generated by next-core EcmascriptClientReferenceModule.\n                     import {{ registerClientReference }} from \"react-server-dom-turbopack/server\";\n                 \"#,\n             )?;\n@@ -135,6 +136,7 @@ impl EcmascriptClientReferenceModule {\n             writedoc!(\n                 code,\n                 r#\"\n+                    // This file is generated by next-core EcmascriptClientReferenceModule.\n                     const {{ createClientModuleProxy }} = require(\"react-server-dom-turbopack/server\");\n \n                     {TURBOPACK_EXPORT_NAMESPACE}(createClientModuleProxy({server_module_path}));\n@@ -149,11 +151,15 @@ impl EcmascriptClientReferenceModule {\n \n         let proxy_source = VirtualSource::new(\n             self.server_ident.path().await?.join(\n-                // Depending on the original format, we call the file `proxy.mjs` or `proxy.cjs`.\n-                // This is because we're placing the virtual module next to the original code, so\n-                // its parsing will be affected by `type` fields in package.json --\n-                // a bare `proxy.js` may end up being unexpectedly parsed as the wrong format.\n-                &format!(\"proxy.{}\", if is_esm { \"mjs\" } else { \"cjs\" }),\n+                // We choose the extension based on the original file because we're placing the\n+                // virtual module next to the original code, so its parsing will be\n+                // affected by `type` fields in package.json -- a bare `proxy.js`\n+                // may end up being unexpectedly parsed as the wrong format.\n+                // The name special cased later to always ignore-list this module.\n+                &format!(\n+                    \"__nextjs-internal-proxy.{}\",\n+                    if is_esm { \"mjs\" } else { \"cjs\" }\n+                ),\n             )?,\n             proxy_module_content,\n         );"
        },
        {
            "sha": "c73a2a854dad16b3189970ffe5c8e1e9f4291435",
            "filename": "packages/next/src/build/webpack/config/blocks/base.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fconfig%2Fblocks%2Fbase.ts?ref=0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5",
            "patch": "@@ -9,6 +9,8 @@ import { getRspackCore } from '../../../../shared/lib/get-rspack'\n function shouldIgnorePath(modulePath: string): boolean {\n   return (\n     modulePath.includes('node_modules') ||\n+    modulePath.endsWith('__nextjs-internal-proxy.cjs') ||\n+    modulePath.endsWith('__nextjs-internal-proxy.mjs') ||\n     // Only relevant for when Next.js is symlinked e.g. in the Next.js monorepo\n     modulePath.includes('next/dist')\n   )"
        },
        {
            "sha": "cb9844d3b841dc97a7f4085b6bfe83ac8ed4820f",
            "filename": "packages/next/src/build/webpack/loaders/next-flight-loader/index.ts",
            "status": "modified",
            "additions": 53,
            "deletions": 7,
            "changes": 60,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-flight-loader%2Findex.ts?ref=0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5",
            "patch": "@@ -1,4 +1,9 @@\n-import type { NormalModule, webpack } from 'next/dist/compiled/webpack/webpack'\n+import type {\n+  javascript,\n+  LoaderContext,\n+  NormalModule,\n+  webpack,\n+} from 'next/dist/compiled/webpack/webpack'\n import { RSC_MOD_REF_PROXY_ALIAS } from '../../../../lib/constants'\n import {\n   BARREL_OPTIMIZATION_PREFIX,\n@@ -8,10 +13,7 @@ import { warnOnce } from '../../../../shared/lib/utils/warn-once'\n import { getRSCModuleInformation } from '../../../analysis/get-page-static-info'\n import { formatBarrelOptimizedResource } from '../../utils'\n import { getModuleBuildInfo } from '../get-module-build-info'\n-import type {\n-  javascript,\n-  LoaderContext,\n-} from 'next/dist/compiled/webpack/webpack'\n+import { ModuleFilenameHelpers } from 'next/dist/compiled/webpack/webpack'\n \n type SourceType = javascript.JavascriptParser['sourceType'] | 'commonjs'\n \n@@ -72,6 +74,7 @@ export default function transformSource(\n     prefix = `/* __rspack_internal_rsc_module_information_do_not_use__ ${rscModuleInformationJson} */\\n`\n     source = prefix + source\n   }\n+  prefix += `// This file is generated by the Webpack next-flight-loader.\\n`\n \n   // Resource key is the unique identifier for the resource. When RSC renders\n   // a client module, that key is used to identify that module across all compiler\n@@ -144,7 +147,28 @@ ${JSON.stringify(ref)},\n         }\n       }\n \n-      return this.callback(null, esmSource, sourceMap)\n+      const compilation = this._compilation!\n+      const originalSourceURL = ModuleFilenameHelpers.createFilename(\n+        module,\n+        {\n+          moduleFilenameTemplate:\n+            'webpack://[namespace]/[resource-path]/__nextjs-internal-proxy.mjs',\n+          namespace: '_N_E',\n+        },\n+        {\n+          requestShortener: compilation.requestShortener,\n+          chunkGraph: compilation.chunkGraph,\n+          hashFunction: compilation.outputOptions.hashFunction,\n+        }\n+      )\n+\n+      return this.callback(null, esmSource, {\n+        version: 3,\n+        sources: [originalSourceURL],\n+        // minimal, parseable mappings\n+        mappings: 'AAAA',\n+        sourcesContent: [esmSource],\n+      })\n     } else if (assumedSourceType === 'commonjs') {\n       let cjsSource =\n         prefix +\n@@ -153,7 +177,29 @@ const { createProxy } = require(\"${MODULE_PROXY_PATH}\")\n \n module.exports = createProxy(${stringifiedResourceKey})\n `\n-      return this.callback(null, cjsSource, sourceMap)\n+\n+      const compilation = this._compilation!\n+      const originalSourceURL = ModuleFilenameHelpers.createFilename(\n+        module,\n+        {\n+          moduleFilenameTemplate:\n+            'webpack://[namespace]/[resource-path]/__nextjs-internal-proxy.cjs',\n+          namespace: '_N_E',\n+        },\n+        {\n+          requestShortener: compilation.requestShortener,\n+          chunkGraph: compilation.chunkGraph,\n+          hashFunction: compilation.outputOptions.hashFunction,\n+        }\n+      )\n+\n+      return this.callback(null, cjsSource, {\n+        version: 3,\n+        sources: [originalSourceURL],\n+        // minimal, parseable mappings\n+        mappings: 'AAAA',\n+        sourcesContent: [cjsSource],\n+      })\n     }\n   }\n "
        },
        {
            "sha": "0f740606790203e31aab9a195053c0bd1754bbdc",
            "filename": "test/development/app-dir/source-mapping/source-mapping.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 33,
            "changes": 47,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fsource-mapping.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fsource-mapping.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsource-mapping%2Fsource-mapping.test.ts?ref=0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5",
            "patch": "@@ -5,7 +5,7 @@ const isCacheComponentsEnabled =\n   process.env.__NEXT_EXPERIMENTAL_CACHE_COMPONENTS === 'true'\n \n describe('source-mapping', () => {\n-  const { isTurbopack, next } = nextTestSetup({\n+  const { next } = nextTestSetup({\n     files: __dirname,\n   })\n \n@@ -172,37 +172,18 @@ describe('source-mapping', () => {\n   it('should show an error when client functions are called from server components', async () => {\n     const browser = await next.browser('/server-client')\n \n-    // TODO(veil): Top stack should be ignore-listed\n-    if (isTurbopack) {\n-      await expect(browser).toDisplayRedbox(`\n-       {\n-         \"description\": \"Attempted to call useClient() from the server but useClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n-         \"environmentLabel\": \"${isCacheComponentsEnabled ? 'Prerender' : 'Server'}\",\n-         \"label\": \"Runtime Error\",\n-         \"source\": \"app/server-client/client.js/proxy.mjs (3:24) @ <anonymous>\n-       > 3 |     function() { throw new Error(\"Attempted to call useClient() from the server but useClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n-           |                        ^\",\n-         \"stack\": [\n-           \"<anonymous> app/server-client/client.js/proxy.mjs (3:24)\",\n-           \"Component app/server-client/page.js (5:12)\",\n-         ],\n-       }\n-      `)\n-    } else {\n-      await expect(browser).toDisplayRedbox(`\n-       {\n-         \"description\": \"Attempted to call useClient() from the server but useClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n-         \"environmentLabel\": \"${isCacheComponentsEnabled ? 'Prerender' : 'Server'}\",\n-         \"label\": \"Runtime Error\",\n-         \"source\": \"app/server-client/page.js (5:12) @ Component\n-       > 5 |   useClient()\n-           |            ^\",\n-         \"stack\": [\n-           \"<FIXME-file-protocol>\",\n-           \"Component app/server-client/page.js (5:12)\",\n-         ],\n-       }\n-      `)\n-    }\n+    await expect(browser).toDisplayRedbox(`\n+     {\n+       \"description\": \"Attempted to call useClient() from the server but useClient is on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\",\n+       \"environmentLabel\": \"${isCacheComponentsEnabled ? 'Prerender' : 'Server'}\",\n+       \"label\": \"Runtime Error\",\n+       \"source\": \"app/server-client/page.js (5:12) @ Component\n+     > 5 |   useClient()\n+         |            ^\",\n+       \"stack\": [\n+         \"Component app/server-client/page.js (5:12)\",\n+       ],\n+     }\n+    `)\n   })\n })"
        },
        {
            "sha": "9077655cb70b29dc778ee3bee25b3f583fe58de8",
            "filename": "test/development/app-dir/use-cache-errors/use-cache-errors.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fuse-cache-errors%2Fuse-cache-errors.test.ts?ref=0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5",
            "patch": "@@ -43,7 +43,6 @@ describe('use-cache-errors', () => {\n        > 16 |   return useStuff()\n             |                  ^\",\n          \"stack\": [\n-           \"<FIXME-file-protocol>\",\n            \"useCachedStuff app/module-with-use-cache.ts (16:18)\",\n            \"Page app/page.tsx (22:10)\",\n          ],"
        },
        {
            "sha": "9b14c8821835b1cfe26501a762fb1e78779ef0e1",
            "filename": "turbopack/crates/turbopack-core/src/source_map/utils.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fsource_map%2Futils.rs?ref=0c0dc4865ef8a9923ed1b94a2bc5e91d92d625f5",
            "patch": "@@ -19,6 +19,8 @@ pub fn add_default_ignore_list(map: &mut swc_sourcemap::SourceMap) {\n         if source.starts_with(concatcp!(SOURCE_URL_PROTOCOL, \"///[next]\"))\n             || source.starts_with(concatcp!(SOURCE_URL_PROTOCOL, \"///[turbopack]\"))\n             || source.contains(\"/node_modules/\")\n+            || source.ends_with(\"__nextjs-internal-proxy.cjs\")\n+            || source.ends_with(\"__nextjs-internal-proxy.mjs\")\n         {\n             ignored_ids.insert(source_id);\n         }"
        }
    ],
    "stats": {
        "total": 128,
        "additions": 82,
        "deletions": 46
    }
}