{
    "author": "sokra",
    "message": "Turbopack: In CI only persist at the end (#87316)\n\n### What?\n\nUsually we persist the database every 2 minutes inside of `next build`, so you can continue from a partial build.\n\nBut in CI that doesn't make sense, so this changes it to only persist on shutdown.",
    "sha": "0a21e7dd753649b6e300d6b8ec83963d5a4ae1eb",
    "files": [
        {
            "sha": "21e550f0bc1c612d291f7c58e5ae7750746a8b3f",
            "filename": "crates/napi/src/next_api/turbopack_ctx.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/0a21e7dd753649b6e300d6b8ec83963d5a4ae1eb/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0a21e7dd753649b6e300d6b8ec83963d5a4ae1eb/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs?ref=0a21e7dd753649b6e300d6b8ec83963d5a4ae1eb",
            "patch": "@@ -204,6 +204,8 @@ pub fn create_turbo_tasks(\n             BackendOptions {\n                 storage_mode: Some(if std::env::var(\"TURBO_ENGINE_READ_ONLY\").is_ok() {\n                     turbo_tasks_backend::StorageMode::ReadOnly\n+                } else if is_ci {\n+                    turbo_tasks_backend::StorageMode::ReadWriteOnShutdown\n                 } else {\n                     turbo_tasks_backend::StorageMode::ReadWrite\n                 }),"
        },
        {
            "sha": "305719ee876ef8c9bfd37ba9f0239725ab6f6418",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 4,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/0a21e7dd753649b6e300d6b8ec83963d5a4ae1eb/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/0a21e7dd753649b6e300d6b8ec83963d5a4ae1eb/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=0a21e7dd753649b6e300d6b8ec83963d5a4ae1eb",
            "patch": "@@ -122,8 +122,11 @@ pub enum StorageMode {\n     /// Queries the storage for cache entries that don't exist locally.\n     ReadOnly,\n     /// Queries the storage for cache entries that don't exist locally.\n-    /// Keeps a log of all changes and regularly push them to the backing storage.\n+    /// Regularly pushes changes to the backing storage.\n     ReadWrite,\n+    /// Queries the storage for cache entries that don't exist locally.\n+    /// On shutdown, pushes all changes to the backing storage.\n+    ReadWriteOnShutdown,\n }\n \n pub struct BackendOptions {\n@@ -242,7 +245,10 @@ impl<B: BackingStorage> TurboTasksBackend<B> {\n impl<B: BackingStorage> TurboTasksBackendInner<B> {\n     pub fn new(mut options: BackendOptions, backing_storage: B) -> Self {\n         let shard_amount = compute_shard_amount(options.num_workers, options.small_preallocation);\n-        let need_log = matches!(options.storage_mode, Some(StorageMode::ReadWrite));\n+        let need_log = matches!(\n+            options.storage_mode,\n+            Some(StorageMode::ReadWrite) | Some(StorageMode::ReadWriteOnShutdown)\n+        );\n         if !options.dependency_tracking {\n             options.active_tracking = false;\n         }\n@@ -369,7 +375,10 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n     }\n \n     fn should_persist(&self) -> bool {\n-        matches!(self.options.storage_mode, Some(StorageMode::ReadWrite))\n+        matches!(\n+            self.options.storage_mode,\n+            Some(StorageMode::ReadWrite) | Some(StorageMode::ReadWriteOnShutdown)\n+        )\n     }\n \n     fn should_restore(&self) -> bool {\n@@ -1262,7 +1271,9 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             }\n         }\n \n-        if self.should_persist() {\n+        // Only when it should write regularly to the storage, we schedule the initial snapshot\n+        // job.\n+        if matches!(self.options.storage_mode, Some(StorageMode::ReadWrite)) {\n             // Schedule the snapshot job\n             let _span = trace_span!(\"persisting background job\").entered();\n             let _span = tracing::info_span!(\"thread\").entered();"
        }
    ],
    "stats": {
        "total": 21,
        "additions": 17,
        "deletions": 4
    }
}