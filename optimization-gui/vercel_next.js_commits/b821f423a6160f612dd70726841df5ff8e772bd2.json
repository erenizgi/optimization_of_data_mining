{
    "author": "eps1lon",
    "message": "Revert \"dx: avoid next-env.d.ts change in dev\" (#88153)\n\nReverting since it produced merge conflicts with in-progress\n[strict-route-types\nproject](https://linear.app/vercel/project/nextjs-strict-route-types-2f0a70110d5d/overview):\n\nThe lesson learned from the earlier PR was that this is a risky change.\nWe'll land a similar change flagged in\nhttps://github.com/vercel/next.js/pull/87768",
    "sha": "b821f423a6160f612dd70726841df5ff8e772bd2",
    "files": [
        {
            "sha": "9f779fd75a19b6da41f2b8f50c9192fed614a6ce",
            "filename": "packages/next/src/build/type-check.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftype-check.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -20,7 +20,6 @@ import { hrtimeDurationToString } from './duration-to-string'\n function verifyTypeScriptSetup(\n   dir: string,\n   distDir: string,\n-  distDirRoot: string | undefined,\n   typeCheckPreflight: boolean,\n   tsconfigPath: string | undefined,\n   disableStaticImages: boolean,\n@@ -51,7 +50,6 @@ function verifyTypeScriptSetup(\n     .verifyTypeScriptSetup({\n       dir,\n       distDir,\n-      distDirRoot,\n       typeCheckPreflight,\n       tsconfigPath,\n       disableStaticImages,\n@@ -119,7 +117,6 @@ export async function startTypeChecking({\n         verifyTypeScriptSetup(\n           dir,\n           config.distDir,\n-          config.distDirRoot,\n           !ignoreTypeScriptErrors,\n           config.typescript.tsconfigPath,\n           config.images.disableStaticImages,"
        },
        {
            "sha": "91a76a7e4a924e2d31199239d5ef0660577930e9",
            "filename": "packages/next/src/cli/next-test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-test.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -140,7 +140,6 @@ async function runPlaywright(\n     const { version: typeScriptVersion } = await verifyTypeScriptSetup({\n       dir: baseDir,\n       distDir: nextConfig.distDir,\n-      distDirRoot: nextConfig.distDirRoot,\n       typeCheckPreflight: false,\n       tsconfigPath: nextConfig.typescript.tsconfigPath,\n       disableStaticImages: nextConfig.images.disableStaticImages,"
        },
        {
            "sha": "46db023f1e111b1a68ece4fc79b8cae9b9d53b92",
            "filename": "packages/next/src/cli/next-typegen.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-typegen.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -57,7 +57,6 @@ const nextTypegen = async (\n   await verifyTypeScriptSetup({\n     dir: baseDir,\n     distDir: nextConfig.distDir,\n-    distDirRoot: nextConfig.distDirRoot,\n     typeCheckPreflight: false,\n     tsconfigPath: nextConfig.typescript.tsconfigPath,\n     disableStaticImages: nextConfig.images.disableStaticImages,"
        },
        {
            "sha": "772f9cfaa0493c551de98604af12d66d980999cb",
            "filename": "packages/next/src/lib/typescript/writeAppTypeDeclarations.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 8,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Ftypescript%2FwriteAppTypeDeclarations.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -5,15 +5,12 @@ import { promises as fs } from 'fs'\n export async function writeAppTypeDeclarations({\n   baseDir,\n   distDir,\n-  distDirRoot,\n   imageImportsEnabled,\n   hasPagesDir,\n   hasAppDir,\n }: {\n   baseDir: string\n   distDir: string\n-  /** The original distDir before any modifications (e.g., for isolatedDevBuild). Used for stable type imports. */\n-  distDirRoot?: string\n   imageImportsEnabled: boolean\n   hasPagesDir: boolean\n   hasAppDir: boolean\n@@ -60,12 +57,10 @@ export async function writeAppTypeDeclarations({\n     )\n   }\n \n-  // Use distDirRoot for stable path that doesn't change between dev/build modes\n-  const stableDistDir = (distDirRoot ?? distDir).replaceAll(\n-    path.win32.sep,\n-    path.posix.sep\n+  const routeTypesPath = path.posix.join(\n+    distDir.replaceAll(path.win32.sep, path.posix.sep),\n+    'types/routes.d.ts'\n   )\n-  const routeTypesPath = path.posix.join(stableDistDir, 'types/routes.d.ts')\n \n   // Use ESM import instead of triple-slash reference for better ESLint compatibility\n   directives.push(`import \"./${routeTypesPath}\";`)"
        },
        {
            "sha": "bec4cedd8a50dd1f3b6af2653ff23a2971c938b2",
            "filename": "packages/next/src/lib/verify-typescript-setup.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fverify-typescript-setup.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -36,7 +36,6 @@ const requiredPackages = [\n export async function verifyTypeScriptSetup({\n   dir,\n   distDir,\n-  distDirRoot,\n   cacheDir,\n   tsconfigPath,\n   typeCheckPreflight,\n@@ -50,8 +49,6 @@ export async function verifyTypeScriptSetup({\n }: {\n   dir: string\n   distDir: string\n-  /** The original distDir before any modifications (e.g., for isolatedDevBuild). */\n-  distDirRoot?: string\n   cacheDir?: string\n   tsconfigPath: string | undefined\n   typeCheckPreflight: boolean\n@@ -146,7 +143,6 @@ export async function verifyTypeScriptSetup({\n     await writeAppTypeDeclarations({\n       baseDir: dir,\n       distDir,\n-      distDirRoot,\n       imageImportsEnabled: !disableStaticImages,\n       hasPagesDir,\n       hasAppDir,"
        },
        {
            "sha": "6eb0733b2e6c30d29c877f310184236483302db1",
            "filename": "packages/next/src/server/lib/router-utils/route-types-utils.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 25,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Froute-types-utils.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -395,28 +395,3 @@ export async function writeValidatorFile(\n       : generateValidatorFile(manifest)\n   )\n }\n-\n-/**\n- * Writes a proxy routes.d.ts file at the stable path that re-exports from\n- * the actual dev types location. This allows next-env.d.ts to always reference\n- * the same stable path regardless of dev/build mode.\n- *\n- * @param stableTypesDir - The stable types directory (e.g., .next/types)\n- * @param devTypesRelativePath - Relative path from stable dir to dev types (e.g., ../dev/types/routes.d.ts)\n- */\n-export async function writeRouteTypesProxy(\n-  stableTypesDir: string,\n-  devTypesRelativePath: string\n-) {\n-  if (!fs.existsSync(stableTypesDir)) {\n-    await fs.promises.mkdir(stableTypesDir, { recursive: true })\n-  }\n-\n-  const proxyFilePath = path.join(stableTypesDir, 'routes.d.ts')\n-  const proxyContent = `// This file re-exports route types from the dev types location.\n-// This provides a stable import path for next-env.d.ts across dev/build modes.\n-export * from '${devTypesRelativePath}';\n-`\n-\n-  await fs.promises.writeFile(proxyFilePath, proxyContent)\n-}"
        },
        {
            "sha": "44e7005db137fe72dcd6db79bc91cb7168d4acf6",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 13,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -85,7 +85,6 @@ import {\n   createRouteTypesManifest,\n   writeRouteTypesManifest,\n   writeValidatorFile,\n-  writeRouteTypesProxy,\n } from './route-types-utils'\n import { writeCacheLifeTypes } from './cache-life-type-utils'\n import { isParallelRouteSegment } from '../../../shared/lib/segment'\n@@ -144,7 +143,6 @@ async function verifyTypeScript(opts: SetupOpts) {\n   const verifyResult = await verifyTypeScriptSetup({\n     dir: opts.dir,\n     distDir: opts.nextConfig.distDir,\n-    distDirRoot: opts.nextConfig.distDirRoot,\n     typeCheckPreflight: false,\n     tsconfigPath: opts.nextConfig.typescript.tsconfigPath,\n     disableStaticImages: opts.nextConfig.images.disableStaticImages,\n@@ -268,17 +266,6 @@ async function startWatcher(\n     opts.nextConfig\n   )\n \n-  // When isolatedDevBuild is enabled, write a proxy file at the stable path\n-  // that re-exports from the dev types location\n-  if (opts.nextConfig.experimental.isolatedDevBuild) {\n-    const stableTypesDir = path.join(\n-      opts.dir,\n-      opts.nextConfig.distDirRoot,\n-      'types'\n-    )\n-    await writeRouteTypesProxy(stableTypesDir, '../dev/types/routes.d.ts')\n-  }\n-\n   const routesManifestPath = path.join(distDir, ROUTES_MANIFEST)\n   const routesManifest: DevRoutesManifest = {\n     version: 3,"
        },
        {
            "sha": "edf7dba2722de61bab523cfd2221e7f0a61266af",
            "filename": "test/development/app-dir/isolated-dev-build/isolated-dev-build.test.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 28,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fisolated-dev-build%2Fisolated-dev-build.test.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -23,32 +23,4 @@ describe('isolated-dev-build', () => {\n       expect(await browser.elementByCss('p').text()).toBe('hello updated world')\n     })\n   })\n-\n-  it('should use stable path in next-env.d.ts that does not change between dev/build', async () => {\n-    const nextEnvContent = await next.readFile('next-env.d.ts')\n-    // Snapshot ensures next-env.d.ts content stays stable\n-    expect(nextEnvContent).toMatchInlineSnapshot(`\n-      \"/// <reference types=\"next\" />\n-      /// <reference types=\"next/image-types/global\" />\n-      import \"./.next/types/routes.d.ts\";\n-\n-      // NOTE: This file should not be edited\n-      // see https://nextjs.org/docs/app/api-reference/config/typescript for more information.\n-      \"\n-    `)\n-  })\n-\n-  it('should create proxy routes.d.ts at stable path that re-exports from dev types', async () => {\n-    // The proxy file should re-export from the dev types location\n-    const proxyContent = await next.readFile('.next/types/routes.d.ts')\n-    expect(proxyContent).toMatchInlineSnapshot(`\n-      \"// This file re-exports route types from the dev types location.\n-      // This provides a stable import path for next-env.d.ts across dev/build modes.\n-      export * from '../dev/types/routes.d.ts';\n-      \"\n-    `)\n-\n-    // The actual dev types should exist\n-    expect(await next.hasFile('.next/dev/types/routes.d.ts')).toBe(true)\n-  })\n })"
        },
        {
            "sha": "83311bdfa26499785257d6fe0bac03e61f315690",
            "filename": "test/integration/custom-server-types/next-env.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/test%2Fintegration%2Fcustom-server-types%2Fnext-env.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/test%2Fintegration%2Fcustom-server-types%2Fnext-env.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcustom-server-types%2Fnext-env.d.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -1,6 +1,6 @@\n /// <reference types=\"next\" />\n /// <reference types=\"next/image-types/global\" />\n-import './.next/types/routes.d.ts'\n+import './.next/dev/types/routes.d.ts'\n \n // NOTE: This file should not be edited\n // see https://nextjs.org/docs/pages/api-reference/config/typescript for more information."
        },
        {
            "sha": "7996d352f43b1634b55c59fbf6d9621ea3da97a2",
            "filename": "test/integration/typescript-app-type-declarations/next-env.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b821f423a6160f612dd70726841df5ff8e772bd2/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b821f423a6160f612dd70726841df5ff8e772bd2/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftypescript-app-type-declarations%2Fnext-env.d.ts?ref=b821f423a6160f612dd70726841df5ff8e772bd2",
            "patch": "@@ -1,6 +1,6 @@\n /// <reference types=\"next\" />\n /// <reference types=\"next/image-types/global\" />\n-import \"./.next/types/routes.d.ts\";\n+import \"./.next/dev/types/routes.d.ts\";\n \n // NOTE: This file should not be edited\n // see https://nextjs.org/docs/pages/api-reference/config/typescript for more information."
        }
    ],
    "stats": {
        "total": 90,
        "additions": 5,
        "deletions": 85
    }
}