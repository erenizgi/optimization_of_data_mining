{
    "author": "kdy1",
    "message": "perf(turbopack): Do not inline synthesized content for sourcemaps (#79173)\n\n### What?\n\nDisable `inline_sources_content` of SWC source map generator for `minify()`.\n\n### Why?\n\nRegardless, it's the wrong value from the user's perspective, so we cannot use it anyway.\n\n\nbuild_sourcemap will fill the sourcemap with the content provided by the value passed to cm.new_source_file at\nhttps://github.com/vercel/next.js/blob/bcd799fc688fc3b1535150e24c6057033e29bf3c/turbopack/crates/turbopack-ecmascript/src/minify.rs#L41-L44\nbut for minify(), it's not the input string (written by the user) but it's a codegen-ed string.\n\n\nAlso, `sourcemap::SourceMap::adjust_mappings` says\n\n> /// This function assumes that `adjustment` contains no relevant\ninformation except for mappings.\n> ///  All information about sources and names is copied from `self`.\n\nso we do not need inline source contents regardless if we are going to call it.",
    "sha": "7ddd5ef0bb85aca47548cbb9dda59cc79be22635",
    "files": [
        {
            "sha": "66b2ca0f220550e7117cd32ab7d6af45746ae522",
            "filename": "turbopack/crates/turbopack-css/src/module_asset.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/7ddd5ef0bb85aca47548cbb9dda59cc79be22635/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7ddd5ef0bb85aca47548cbb9dda59cc79be22635/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-css%2Fsrc%2Fmodule_asset.rs?ref=7ddd5ef0bb85aca47548cbb9dda59cc79be22635",
            "patch": "@@ -432,7 +432,7 @@ fn generate_minimal_source_map(filename: String, source: String) -> Result<Rope>\n     }\n     let sm: Arc<SourceMap> = Default::default();\n     sm.new_source_file(FileName::Custom(filename).into(), source);\n-    let map = generate_js_source_map(sm, mappings, None)?;\n+    let map = generate_js_source_map(sm, mappings, None, true)?;\n     Ok(map)\n }\n "
        },
        {
            "sha": "18decbed9c1bc6dc689f519073bf8c10bf488053",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/7ddd5ef0bb85aca47548cbb9dda59cc79be22635/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7ddd5ef0bb85aca47548cbb9dda59cc79be22635/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=7ddd5ef0bb85aca47548cbb9dda59cc79be22635",
            "patch": "@@ -1131,9 +1131,15 @@ async fn emit_content(content: CodeGenResult) -> Result<Vc<EcmascriptModuleConte\n                 source_map.clone(),\n                 mappings,\n                 original_source_map.generate_source_map().await?.as_ref(),\n+                true,\n             )?)\n         } else {\n-            Some(generate_js_source_map(source_map.clone(), mappings, None)?)\n+            Some(generate_js_source_map(\n+                source_map.clone(),\n+                mappings,\n+                None,\n+                true,\n+            )?)\n         }\n     } else {\n         None"
        },
        {
            "sha": "a7e85af651ba1ba580f71a727560e6dae8137963",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/7ddd5ef0bb85aca47548cbb9dda59cc79be22635/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7ddd5ef0bb85aca47548cbb9dda59cc79be22635/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=7ddd5ef0bb85aca47548cbb9dda59cc79be22635",
            "patch": "@@ -134,7 +134,15 @@ pub fn minify(code: &Code, source_maps: bool, mangle: Option<MangleType>) -> Res\n         src_map_buf.shrink_to_fit();\n         builder.push_source(\n             &src.into(),\n-            Some(generate_js_source_map(cm, src_map_buf, Some(original_map))?),\n+            Some(generate_js_source_map(\n+                cm,\n+                src_map_buf,\n+                Some(original_map),\n+                // We do not inline source contents.\n+                // We provide a synthesized value to `cm.new_source_file` above, so it cannot be\n+                // the value user expect anyway.\n+                false,\n+            )?),\n         );\n     } else {\n         builder.push_source(&src.into(), None);"
        },
        {
            "sha": "1eafa2b3f5d1c2c99a58b8084c53163048cfe4aa",
            "filename": "turbopack/crates/turbopack-ecmascript/src/parse.rs",
            "status": "modified",
            "additions": 18,
            "deletions": 4,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/7ddd5ef0bb85aca47548cbb9dda59cc79be22635/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7ddd5ef0bb85aca47548cbb9dda59cc79be22635/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fparse.rs?ref=7ddd5ef0bb85aca47548cbb9dda59cc79be22635",
            "patch": "@@ -103,6 +103,7 @@ pub fn generate_js_source_map(\n     files_map: Arc<swc_core::common::SourceMap>,\n     mappings: Vec<(BytePos, LineCol)>,\n     original_source_map: Option<&Rope>,\n+    inline_sources_content: bool,\n ) -> Result<Rope> {\n     let input_map = if let Some(original_source_map) = original_source_map {\n         Some(match sourcemap::decode(original_source_map.read())? {\n@@ -115,8 +116,19 @@ pub fn generate_js_source_map(\n         None\n     };\n \n-    let map =\n-        files_map.build_source_map_with_config(&mappings, None, InlineSourcesContentConfig {});\n+    let map = files_map.build_source_map_with_config(\n+        &mappings,\n+        None,\n+        InlineSourcesContentConfig {\n+            // If we are going to adjust the source map, we are going to throw the source contents\n+            // of this source map away regardless.\n+            //\n+            // In other words, we don't need the content of `B` in source map chain of A -> B -> C.\n+            // We only need the source content of `A`, and a way to map the content of `B` back to\n+            // `A`, while constructing the final source map, `C`.\n+            inline_sources_content: inline_sources_content && input_map.is_none(),\n+        },\n+    );\n \n     let mut map = match input_map {\n         Some(mut input_map) => {\n@@ -135,7 +147,9 @@ pub fn generate_js_source_map(\n /// A config to generate a source map which includes the source content of every\n /// source file. SWC doesn't inline sources content by default when generating a\n /// sourcemap, so we need to provide a custom config to do it.\n-pub struct InlineSourcesContentConfig {}\n+pub struct InlineSourcesContentConfig {\n+    inline_sources_content: bool,\n+}\n \n impl SourceMapGenConfig for InlineSourcesContentConfig {\n     fn file_name_to_source(&self, f: &FileName) -> String {\n@@ -148,7 +162,7 @@ impl SourceMapGenConfig for InlineSourcesContentConfig {\n     }\n \n     fn inline_sources_content(&self, _f: &FileName) -> bool {\n-        true\n+        self.inline_sources_content\n     }\n }\n "
        }
    ],
    "stats": {
        "total": 42,
        "additions": 35,
        "deletions": 7
    }
}