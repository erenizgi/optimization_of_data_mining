{
    "author": "seeplusplus",
    "message": "use port zero for --inspect when forking, if used by parent (#85128)\n\nCo-authored-by: Sebastian Sebbie Silbermann <sebastian.silbermann@vercel.com>",
    "sha": "04c962cfe1e806963e7e348d9bf8cfc8828ef906",
    "files": [
        {
            "sha": "6616c0fed212a9ac383b45208db03761f202d187",
            "filename": "packages/next/src/cli/next-dev.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/04c962cfe1e806963e7e348d9bf8cfc8828ef906/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04c962cfe1e806963e7e348d9bf8cfc8828ef906/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fcli%2Fnext-dev.ts?ref=04c962cfe1e806963e7e348d9bf8cfc8828ef906",
            "patch": "@@ -282,7 +282,7 @@ const nextDev = async (\n \n       if (nodeDebugType) {\n         const address = getParsedDebugAddress()\n-        address.port = address.port + 1\n+        address.port = address.port === 0 ? 0 : address.port + 1\n         nodeOptions[nodeDebugType] = formatDebugAddress(address)\n       }\n "
        },
        {
            "sha": "0c09f18c1d88ef794f66e1b9eff460691d3445ac",
            "filename": "packages/next/src/lib/worker.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/04c962cfe1e806963e7e348d9bf8cfc8828ef906/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04c962cfe1e806963e7e348d9bf8cfc8828ef906/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fworker.ts?ref=04c962cfe1e806963e7e348d9bf8cfc8828ef906",
            "patch": "@@ -85,10 +85,12 @@ export class Worker {\n       if (nodeDebugType) {\n         const address = getParsedDebugAddress()\n         address.port =\n-          address.port +\n-          // current process runs on `address.port`\n-          1 +\n-          debuggerPortOffset\n+          address.port === 0\n+            ? 0\n+            : address.port +\n+              // current process runs on `address.port`\n+              1 +\n+              debuggerPortOffset\n         nodeOptions[nodeDebugType] = formatDebugAddress(address)\n       }\n     }"
        },
        {
            "sha": "fbade93a589e940a61d67b41b9ede190b9bc2ef7",
            "filename": "packages/next/src/server/lib/start-server.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/04c962cfe1e806963e7e348d9bf8cfc8828ef906/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04c962cfe1e806963e7e348d9bf8cfc8828ef906/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fstart-server.ts?ref=04c962cfe1e806963e7e348d9bf8cfc8828ef906",
            "patch": "@@ -26,6 +26,7 @@ import {\n   RESTART_EXIT_CODE,\n   getFormattedDebugAddress,\n   getNodeDebugType,\n+  isDebugAddressEphemeral,\n } from './utils'\n import { formatHostname } from './format-hostname'\n import { initialize } from './router-server'\n@@ -347,8 +348,12 @@ export async function startServer(\n \n       if (nodeDebugType) {\n         const formattedDebugAddress = getFormattedDebugAddress()\n+        const isEphemeral = isDebugAddressEphemeral()\n         Log.info(\n-          `the --${nodeDebugType} option was detected, the Next.js router server should be inspected at ${formattedDebugAddress}.`\n+          `the --${nodeDebugType} option was detected` +\n+            (isEphemeral\n+              ? ''\n+              : `, the Next.js router server should be inspected at ${formattedDebugAddress}.`)\n         )\n       }\n "
        },
        {
            "sha": "e11abd4bc4b3bac706c194db2d1b27d377c50d73",
            "filename": "packages/next/src/server/lib/utils.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/04c962cfe1e806963e7e348d9bf8cfc8828ef906/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/04c962cfe1e806963e7e348d9bf8cfc8828ef906/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Futils.ts?ref=04c962cfe1e806963e7e348d9bf8cfc8828ef906",
            "patch": "@@ -171,6 +171,13 @@ export const getParsedDebugAddress = (): DebugAddress => {\n   return { host: undefined, port: parseInt(address, 10) }\n }\n \n+/**\n+ * Checks if the debug address from `NODE_OPTIONS` specifies to use a random port (e.g., the port set to 0).\n+ *\n+ * @returns A boolean indicating whether or not the debug address is assigned to a random port.\n+ */\n+export const isDebugAddressEphemeral = () => getParsedDebugAddress()?.port === 0\n+\n /**\n  * Get the debug address from the `NODE_OPTIONS` environment variable and format\n  * it into a string."
        },
        {
            "sha": "a94934b3ead7971748d819c832981d56cf5f5bc3",
            "filename": "test/integration/cli/test/index.test.js",
            "status": "modified",
            "additions": 29,
            "deletions": 0,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/04c962cfe1e806963e7e348d9bf8cfc8828ef906/test%2Fintegration%2Fcli%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/04c962cfe1e806963e7e348d9bf8cfc8828ef906/test%2Fintegration%2Fcli%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcli%2Ftest%2Findex.test.js?ref=04c962cfe1e806963e7e348d9bf8cfc8828ef906",
            "patch": "@@ -571,6 +571,35 @@ describe('CLI Usage', () => {\n       }\n     })\n \n+    test(\"NODE_OPTIONS='--inspect=:0'\", async () => {\n+      const port = await findPort()\n+      let output = ''\n+      let errOutput = ''\n+      const app = await runNextCommandDev(\n+        [dirBasic, '--port', port],\n+        undefined,\n+        {\n+          onStdout(msg) {\n+            output += stripAnsi(msg)\n+          },\n+          onStderr(msg) {\n+            errOutput += stripAnsi(msg)\n+          },\n+          env: { NODE_OPTIONS: '--inspect=:0' },\n+        }\n+      )\n+      try {\n+        await check(() => output, new RegExp(`http://localhost:${port}`))\n+        await check(() => errOutput, /Debugger listening on/)\n+        expect(errOutput).not.toContain('address already in use')\n+        expect(errOutput).toContain('Debugger listening on')\n+        console.log(output)\n+        expect(output).toContain('the --inspect option was detected')\n+      } finally {\n+        await killApp(app)\n+      }\n+    })\n+\n     test(\"NODE_OPTIONS='--require=file with spaces to-require-with-node-require-option.js'\", async () => {\n       const port = await findPort()\n       let output = ''"
        }
    ],
    "stats": {
        "total": 55,
        "additions": 49,
        "deletions": 6
    }
}