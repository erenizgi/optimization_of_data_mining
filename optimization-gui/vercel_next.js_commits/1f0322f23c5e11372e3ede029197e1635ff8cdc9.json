{
    "author": "huozhi",
    "message": "perf: revert to use the light safe stringify for is-error (#86053)\n\n`is-error` is a helper that being used accorss client and server now, in\n#84909 we switched the underlying safe stringify error implementation to\nthe precompiled dependency `safe-stable-stringify`. But it increased the\nclient bundle size a bit.\n\nThe change in #84909 was only for applying the `safe-stable-stringify`\nfor client file logger with mcp, not really necessary need to change for\nis-error helper\n\nNote: Save minified around 12kb. it's actually 7.5kb on bundlephobia,\nbut because we're using ncc to compile it to cjs dependency that the\nsize seems slightly larger than their metrics. The saved gzip size would\nbe around 2-3.x kb",
    "sha": "1f0322f23c5e11372e3ede029197e1635ff8cdc9",
    "files": [
        {
            "sha": "477814d40dd1ae3afec57d3cbcd3fcae1c7c6b2e",
            "filename": "packages/next/src/lib/is-error.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 2,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/1f0322f23c5e11372e3ede029197e1635ff8cdc9/packages%2Fnext%2Fsrc%2Flib%2Fis-error.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1f0322f23c5e11372e3ede029197e1635ff8cdc9/packages%2Fnext%2Fsrc%2Flib%2Fis-error.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fis-error.ts?ref=1f0322f23c5e11372e3ede029197e1635ff8cdc9",
            "patch": "@@ -1,5 +1,4 @@\n import { isPlainObject } from '../shared/lib/is-plain-object'\n-import safeStringify from 'next/dist/compiled/safe-stable-stringify'\n \n // We allow some additional attached properties for Next.js errors\n export interface NextError extends Error {\n@@ -10,6 +9,28 @@ export interface NextError extends Error {\n   digest?: number\n }\n \n+/**\n+ * This is a safe stringify function that handles circular references.\n+ * We're using a simpler version here to avoid introducing\n+ * the dependency `safe-stable-stringify` into production bundle.\n+ *\n+ * This helper is used both in development and production.\n+ */\n+function safeStringifyLite(obj: any) {\n+  const seen = new WeakSet()\n+\n+  return JSON.stringify(obj, (_key, value) => {\n+    // If value is an object and already seen, replace with \"[Circular]\"\n+    if (typeof value === 'object' && value !== null) {\n+      if (seen.has(value)) {\n+        return '[Circular]'\n+      }\n+      seen.add(value)\n+    }\n+    return value\n+  })\n+}\n+\n /**\n  * Checks whether the given value is a NextError.\n  * This can be used to print a more detailed error message with properties like `code` & `digest`.\n@@ -43,5 +64,5 @@ export function getProperError(err: unknown): Error {\n     }\n   }\n \n-  return new Error(isPlainObject(err) ? safeStringify(err) : err + '')\n+  return new Error(isPlainObject(err) ? safeStringifyLite(err) : err + '')\n }"
        },
        {
            "sha": "26cfcfbf9341cb7de1865b8f35b65d6b524f6169",
            "filename": "test/development/app-dir/serialize-circular-error/serialize-circular-error.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/1f0322f23c5e11372e3ede029197e1635ff8cdc9/test%2Fdevelopment%2Fapp-dir%2Fserialize-circular-error%2Fserialize-circular-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1f0322f23c5e11372e3ede029197e1635ff8cdc9/test%2Fdevelopment%2Fapp-dir%2Fserialize-circular-error%2Fserialize-circular-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fserialize-circular-error%2Fserialize-circular-error.test.ts?ref=1f0322f23c5e11372e3ede029197e1635ff8cdc9",
            "patch": "@@ -19,7 +19,7 @@ describe('serialize-circular-error', () => {\n     `)\n     const output = next.cliOutput\n     expect(output).toContain(\n-      'Error: {\"objA\":{\"other\":{\"a\":\"[Circular]\"}},\"objB\":{\"a\":{\"other\":\"[Circular]\"}}}'\n+      'Error: {\"objA\":{\"other\":{\"a\":\"[Circular]\"}},\"objB\":\"[Circular]\"}'\n     )\n   })\n \n@@ -44,7 +44,7 @@ describe('serialize-circular-error', () => {\n \n     const output = next.cliOutput\n     expect(output).toContain(\n-      'Error: {\"objC\":{\"other\":{\"a\":\"[Circular]\"}},\"objD\":{\"a\":{\"other\":\"[Circular]\"}}}'\n+      'Error: {\"objC\":{\"other\":{\"a\":\"[Circular]\"}},\"objD\":\"[Circular]\"}'\n     )\n   })\n })"
        },
        {
            "sha": "74b0d7a9031707c544dcc728735e48db187709b6",
            "filename": "test/production/app-dir/browser-chunks/browser-chunks.test.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/1f0322f23c5e11372e3ede029197e1635ff8cdc9/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1f0322f23c5e11372e3ede029197e1635ff8cdc9/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbrowser-chunks%2Fbrowser-chunks.test.ts?ref=1f0322f23c5e11372e3ede029197e1635ff8cdc9",
            "patch": "@@ -48,4 +48,18 @@ describe('browser-chunks', () => {\n       )\n     }\n   })\n+\n+  it('must not include heavy dependencies into browser chunks', () => {\n+    const heavyDependencies = sources.filter((source) => {\n+      return source.includes('next/dist/compiled/safe-stable-stringify')\n+    })\n+\n+    if (heavyDependencies.length > 0) {\n+      const message = `Found the following heavy dependencies:\\n  ${heavyDependencies.join('\\n  ')}`\n+\n+      throw new Error(\n+        'Did not expect any heavy dependencies in browser chunks.\\n' + message\n+      )\n+    }\n+  })\n })"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 39,
        "deletions": 4
    }
}