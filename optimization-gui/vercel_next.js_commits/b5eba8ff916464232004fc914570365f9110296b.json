{
    "author": "gnoff",
    "message": "[Cache Components] Schedule work on timeouts (#84344)\n\nPreviously we used the immediate queue to schedule the consecutive tasks\nthat would prerender and abort and page prerender. This works fine but\nsince React does not consider immediates as IO for async work tracking\nit means we can't use it for scheduling more advanced cases like\nstatic->runtime->dynamic where the IO that unblocks in runtime phase can\nbe picked up.\n\nWhile React could change to include immediates as IO the argument here\nis that it isn't really IO since it is immediate work while timeouts\ngenerally have to schedule something to fire later with timeout zero\nbeing a sort of special case where later === now.\n\nSo instead we are going to move to scheduling our consecutive tasks\nusing timeout as well that way we can align the Next.js and React\nheuristic for identifying IO and make certain kinds of debugging easier\nto implement.",
    "sha": "b5eba8ff916464232004fc914570365f9110296b",
    "files": [
        {
            "sha": "5fb61c0485474703fb8e94b3bf175187d5ab3c46",
            "filename": "packages/next/src/server/app-render/app-render-prerender-utils.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 11,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/b5eba8ff916464232004fc914570365f9110296b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render-prerender-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b5eba8ff916464232004fc914570365f9110296b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render-prerender-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render-prerender-utils.ts?ref=b5eba8ff916464232004fc914570365f9110296b",
            "patch": "@@ -2,7 +2,7 @@ import { InvariantError } from '../../shared/lib/invariant-error'\n \n /**\n  * This is a utility function to make scheduling sequential tasks that run back to back easier.\n- * We schedule on the same queue (setImmediate) at the same time to ensure no other events can sneak in between.\n+ * We schedule on the same queue (setTimeout) at the same time to ensure no other events can sneak in between.\n  */\n export function prerenderAndAbortInSequentialTasks<R>(\n   prerender: () => Promise<R>,\n@@ -15,18 +15,18 @@ export function prerenderAndAbortInSequentialTasks<R>(\n   } else {\n     return new Promise((resolve, reject) => {\n       let pendingResult: Promise<R>\n-      setImmediate(() => {\n+      setTimeout(() => {\n         try {\n           pendingResult = prerender()\n           pendingResult.catch(() => {})\n         } catch (err) {\n           reject(err)\n         }\n-      })\n-      setImmediate(() => {\n+      }, 0)\n+      setTimeout(() => {\n         abort()\n         resolve(pendingResult)\n-      })\n+      }, 0)\n     })\n   }\n }\n@@ -47,21 +47,21 @@ export function prerenderAndAbortInSequentialTasksWithStages<R>(\n   } else {\n     return new Promise((resolve, reject) => {\n       let pendingResult: Promise<R>\n-      setImmediate(() => {\n+      setTimeout(() => {\n         try {\n           pendingResult = prerender()\n           pendingResult.catch(() => {})\n         } catch (err) {\n           reject(err)\n         }\n-      })\n-      setImmediate(() => {\n+      }, 0)\n+      setTimeout(() => {\n         advanceStage()\n-      })\n-      setImmediate(() => {\n+      }, 0)\n+      setTimeout(() => {\n         abort()\n         resolve(pendingResult)\n-      })\n+      }, 0)\n     })\n   }\n }"
        },
        {
            "sha": "c7728d0a3fca9acce12037126549e1b5775ee127",
            "filename": "packages/next/src/server/app-render/app-render-render-utils.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/b5eba8ff916464232004fc914570365f9110296b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render-render-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b5eba8ff916464232004fc914570365f9110296b/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render-render-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render-render-utils.ts?ref=b5eba8ff916464232004fc914570365f9110296b",
            "patch": "@@ -2,7 +2,7 @@ import { InvariantError } from '../../shared/lib/invariant-error'\n \n /**\n  * This is a utility function to make scheduling sequential tasks that run back to back easier.\n- * We schedule on the same queue (setImmediate) at the same time to ensure no other events can sneak in between.\n+ * We schedule on the same queue (setTimeout) at the same time to ensure no other events can sneak in between.\n  */\n export function scheduleInSequentialTasks<R>(\n   render: () => R | Promise<R>,\n@@ -15,17 +15,17 @@ export function scheduleInSequentialTasks<R>(\n   } else {\n     return new Promise((resolve, reject) => {\n       let pendingResult: R | Promise<R>\n-      setImmediate(() => {\n+      setTimeout(() => {\n         try {\n           pendingResult = render()\n         } catch (err) {\n           reject(err)\n         }\n-      })\n-      setImmediate(() => {\n+      }, 0)\n+      setTimeout(() => {\n         followup()\n         resolve(pendingResult)\n-      })\n+      }, 0)\n     })\n   }\n }"
        },
        {
            "sha": "58279520a5ceed443723656bf94e0420b0bd60ed",
            "filename": "packages/next/src/server/lib/patch-fetch.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 2,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/b5eba8ff916464232004fc914570365f9110296b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b5eba8ff916464232004fc914570365f9110296b/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Fpatch-fetch.ts?ref=b5eba8ff916464232004fc914570365f9110296b",
            "patch": "@@ -27,7 +27,6 @@ import {\n   type ServerComponentsHmrCache,\n   type SetIncrementalFetchCacheContext,\n } from '../response-cache'\n-import { waitAtLeastOneReactRenderTask } from '../../lib/scheduler'\n import { cloneResponse } from './clone-response'\n import type { IncrementalCache } from './incremental-cache'\n \n@@ -911,7 +910,7 @@ export function createPatchedFetcher(\n                   // make sure we still exclude them from prerenders if\n                   // cacheComponents is on so we introduce an artificial task boundary\n                   // here.\n-                  await waitAtLeastOneReactRenderTask()\n+                  await getTimeoutBoundary()\n                   break\n                 case 'prerender-ppr':\n                 case 'prerender-legacy':\n@@ -1191,3 +1190,16 @@ export function patchFetch(options: PatchableModule) {\n   // Set the global fetch to the patched fetch.\n   globalThis.fetch = createPatchedFetcher(original, options)\n }\n+\n+let currentTimeoutBoundary: null | Promise<void> = null\n+function getTimeoutBoundary() {\n+  if (!currentTimeoutBoundary) {\n+    currentTimeoutBoundary = new Promise((r) => {\n+      setTimeout(() => {\n+        currentTimeoutBoundary = null\n+        r()\n+      }, 0)\n+    })\n+  }\n+  return currentTimeoutBoundary\n+}"
        },
        {
            "sha": "4a0b7301ff7ce6778399a3fb645e31247d35a29d",
            "filename": "test/development/app-dir/cache-components-dev-fallback-validation/cache-components-dev-fallback-validation.test.ts",
            "status": "modified",
            "additions": 72,
            "deletions": 72,
            "changes": 144,
            "blob_url": "https://github.com/vercel/next.js/blob/b5eba8ff916464232004fc914570365f9110296b/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-fallback-validation%2Fcache-components-dev-fallback-validation.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b5eba8ff916464232004fc914570365f9110296b/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-fallback-validation%2Fcache-components-dev-fallback-validation.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fcache-components-dev-fallback-validation%2Fcache-components-dev-fallback-validation.test.ts?ref=b5eba8ff916464232004fc914570365f9110296b",
            "patch": "@@ -55,11 +55,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/partial/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31) @ Page\n-       > 1 | export default async function Page(props: {\n-           |                               ^\",\n+         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26) @ Page\n+       > 6 |       Top: {(await props.params).top}, Bottom: {(await props.params).bottom}\n+           |                          ^\",\n          \"stack\": [\n-           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31)\",\n+           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -70,11 +70,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/partial/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31) @ Page\n-       > 1 | export default async function Page(props: {\n-           |                               ^\",\n+         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26) @ Page\n+       > 6 |       Top: {(await props.params).top}, Bottom: {(await props.params).bottom}\n+           |                          ^\",\n          \"stack\": [\n-           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31)\",\n+           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -88,11 +88,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/partial/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31) @ Page\n-       > 1 | export default async function Page(props: {\n-           |                               ^\",\n+         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26) @ Page\n+       > 6 |       Top: {(await props.params).top}, Bottom: {(await props.params).bottom}\n+           |                          ^\",\n          \"stack\": [\n-           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31)\",\n+           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -103,11 +103,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/partial/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31) @ Page\n-       > 1 | export default async function Page(props: {\n-           |                               ^\",\n+         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26) @ Page\n+       > 6 |       Top: {(await props.params).top}, Bottom: {(await props.params).bottom}\n+           |                          ^\",\n          \"stack\": [\n-           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31)\",\n+           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -121,11 +121,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/partial/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31) @ Page\n-       > 1 | export default async function Page(props: {\n-           |                               ^\",\n+         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26) @ Page\n+       > 6 |       Top: {(await props.params).top}, Bottom: {(await props.params).bottom}\n+           |                          ^\",\n          \"stack\": [\n-           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31)\",\n+           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -136,11 +136,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/partial/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31) @ Page\n-       > 1 | export default async function Page(props: {\n-           |                               ^\",\n+         \"source\": \"app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26) @ Page\n+       > 6 |       Top: {(await props.params).top}, Bottom: {(await props.params).bottom}\n+           |                          ^\",\n          \"stack\": [\n-           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (1:31)\",\n+           \"Page app/partial/[top]/unwrapped/[bottom]/page.tsx (6:26)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -158,11 +158,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/wrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/wrapped/layout.tsx (3:31) @ Layout\n-       > 3 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/wrapped/layout.tsx (10:3) @ Layout\n+       > 10 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/wrapped/layout.tsx (3:31)\",\n+           \"Layout app/none/[top]/wrapped/layout.tsx (10:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -173,11 +173,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/wrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/wrapped/layout.tsx (3:31) @ Layout\n-       > 3 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/wrapped/layout.tsx (10:3) @ Layout\n+       > 10 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/wrapped/layout.tsx (3:31)\",\n+           \"Layout app/none/[top]/wrapped/layout.tsx (10:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -191,11 +191,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/wrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/wrapped/layout.tsx (3:31) @ Layout\n-       > 3 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/wrapped/layout.tsx (10:3) @ Layout\n+       > 10 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/wrapped/layout.tsx (3:31)\",\n+           \"Layout app/none/[top]/wrapped/layout.tsx (10:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -206,11 +206,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/wrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/wrapped/layout.tsx (3:31) @ Layout\n-       > 3 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/wrapped/layout.tsx (10:3) @ Layout\n+       > 10 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/wrapped/layout.tsx (3:31)\",\n+           \"Layout app/none/[top]/wrapped/layout.tsx (10:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -224,11 +224,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/wrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/wrapped/layout.tsx (3:31) @ Layout\n-       > 3 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/wrapped/layout.tsx (10:3) @ Layout\n+       > 10 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/wrapped/layout.tsx (3:31)\",\n+           \"Layout app/none/[top]/wrapped/layout.tsx (10:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -239,11 +239,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/wrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/wrapped/layout.tsx (3:31) @ Layout\n-       > 3 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/wrapped/layout.tsx (10:3) @ Layout\n+       > 10 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/wrapped/layout.tsx (3:31)\",\n+           \"Layout app/none/[top]/wrapped/layout.tsx (10:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -257,11 +257,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/unwrapped/layout.tsx (1:31) @ Layout\n-       > 1 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/unwrapped/layout.tsx (8:3) @ Layout\n+       >  8 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/unwrapped/layout.tsx (1:31)\",\n+           \"Layout app/none/[top]/unwrapped/layout.tsx (8:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -272,11 +272,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/unwrapped/layout.tsx (1:31) @ Layout\n-       > 1 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/unwrapped/layout.tsx (8:3) @ Layout\n+       >  8 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/unwrapped/layout.tsx (1:31)\",\n+           \"Layout app/none/[top]/unwrapped/layout.tsx (8:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -290,11 +290,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/unwrapped/layout.tsx (1:31) @ Layout\n-       > 1 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/unwrapped/layout.tsx (8:3) @ Layout\n+       >  8 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/unwrapped/layout.tsx (1:31)\",\n+           \"Layout app/none/[top]/unwrapped/layout.tsx (8:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -305,11 +305,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/unwrapped/layout.tsx (1:31) @ Layout\n-       > 1 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/unwrapped/layout.tsx (8:3) @ Layout\n+       >  8 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/unwrapped/layout.tsx (1:31)\",\n+           \"Layout app/none/[top]/unwrapped/layout.tsx (8:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -323,11 +323,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/unwrapped/layout.tsx (1:31) @ Layout\n-       > 1 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/unwrapped/layout.tsx (8:3) @ Layout\n+       >  8 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/unwrapped/layout.tsx (1:31)\",\n+           \"Layout app/none/[top]/unwrapped/layout.tsx (8:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }\n@@ -338,11 +338,11 @@ describe('Cache Components Fallback Validation', () => {\n          \"description\": \"Route \"/none/[top]/unwrapped/[bottom]\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n          \"environmentLabel\": \"Server\",\n          \"label\": \"Console Error\",\n-         \"source\": \"app/none/[top]/unwrapped/layout.tsx (1:31) @ Layout\n-       > 1 | export default async function Layout({\n-           |                               ^\",\n+         \"source\": \"app/none/[top]/unwrapped/layout.tsx (8:3) @ Layout\n+       >  8 |   await params\n+            |   ^\",\n          \"stack\": [\n-           \"Layout app/none/[top]/unwrapped/layout.tsx (1:31)\",\n+           \"Layout app/none/[top]/unwrapped/layout.tsx (8:3)\",\n            \"LogSafely <anonymous>\",\n          ],\n        }"
        },
        {
            "sha": "28518a852b3271a0888321de8a8de4963ff02e2d",
            "filename": "test/e2e/app-dir/cache-components-errors/cache-components-errors.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 32,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/b5eba8ff916464232004fc914570365f9110296b/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b5eba8ff916464232004fc914570365f9110296b/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fcache-components-errors%2Fcache-components-errors.test.ts?ref=b5eba8ff916464232004fc914570365f9110296b",
            "patch": "@@ -159,11 +159,11 @@ describe('Cache Components Errors', () => {\n              \"description\": \"Route \"/dynamic-metadata-error-route\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n              \"environmentLabel\": \"Server\",\n              \"label\": \"Console Error\",\n-             \"source\": \"app/dynamic-metadata-error-route/page.tsx (21:9) @ Dynamic\n-           > 21 |   await new Promise((r) => setTimeout(r))\n-                |         ^\",\n+             \"source\": \"app/dynamic-metadata-error-route/page.tsx (20:16) @ Dynamic\n+           > 20 | async function Dynamic() {\n+                |                ^\",\n              \"stack\": [\n-               \"Dynamic app/dynamic-metadata-error-route/page.tsx (21:9)\",\n+               \"Dynamic app/dynamic-metadata-error-route/page.tsx (20:16)\",\n                \"Page app/dynamic-metadata-error-route/page.tsx (15:7)\",\n                \"LogSafely <anonymous>\",\n              ],\n@@ -3081,35 +3081,13 @@ describe('Cache Components Errors', () => {\n             )\n \n             if (isTurbopack) {\n-              await expect(browser).toDisplayCollapsedRedbox(`\n-               {\n-                 \"description\": \"Route \"/use-cache-private-without-suspense\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n-                 \"environmentLabel\": \"Server\",\n-                 \"label\": \"Console Error\",\n-                 \"source\": \"app/use-cache-private-without-suspense/page.tsx (10:7) @ Page\n-               > 10 |       <Private />\n-                    |       ^\",\n-                 \"stack\": [\n-                   \"Page app/use-cache-private-without-suspense/page.tsx (10:7)\",\n-                   \"LogSafely <anonymous>\",\n-                 ],\n-               }\n-              `)\n+              await expect(browser).toDisplayCollapsedRedbox(\n+                `\"Redbox did not open.\"`\n+              )\n             } else {\n-              await expect(browser).toDisplayCollapsedRedbox(`\n-               {\n-                 \"description\": \"Route \"/use-cache-private-without-suspense\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n-                 \"environmentLabel\": \"Server\",\n-                 \"label\": \"Console Error\",\n-                 \"source\": \"app/use-cache-private-without-suspense/page.tsx (10:7) @ Page\n-               > 10 |       <Private />\n-                    |       ^\",\n-                 \"stack\": [\n-                   \"Page app/use-cache-private-without-suspense/page.tsx (10:7)\",\n-                   \"LogSafely <anonymous>\",\n-                 ],\n-               }\n-              `)\n+              await expect(browser).toDisplayCollapsedRedbox(\n+                `\"Redbox did not open.\"`\n+              )\n             }\n           })\n         } else {"
        }
    ],
    "stats": {
        "total": 234,
        "additions": 112,
        "deletions": 122
    }
}