{
    "author": "lubieowoce",
    "message": "[Cache Components] give the \"seconds\" profile a 30s staleTime (#82332)\n\nCloses NAR-262",
    "sha": "eb756a63696e2c073ca6c6f3148f4a77ea89a412",
    "files": [
        {
            "sha": "f0a18754e9d02f28bdabf6b22d30476c6f048324",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/eb756a63696e2c073ca6c6f3148f4a77ea89a412/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb756a63696e2c073ca6c6f3148f4a77ea89a412/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=eb756a63696e2c073ca6c6f3148f4a77ea89a412",
            "patch": "@@ -1355,7 +1355,7 @@ export const defaultConfig = Object.freeze({\n         expire: INFINITE_CACHE,\n       },\n       seconds: {\n-        stale: undefined, // defaults to staleTimes.dynamic\n+        stale: 30, // 30 seconds\n         revalidate: 1, // 1 second\n         expire: 60, // 1 minute\n       },"
        },
        {
            "sha": "da1cf8fccfb4843531b10a7aace9debc1ef64c52",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 12,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/eb756a63696e2c073ca6c6f3148f4a77ea89a412/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb756a63696e2c073ca6c6f3148f4a77ea89a412/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=eb756a63696e2c073ca6c6f3148f4a77ea89a412",
            "patch": "@@ -942,18 +942,6 @@ function assignDefaults(\n           result.expireTime ?? defaultDefault.expire\n       }\n     }\n-    // This is the most dynamic cache life profile.\n-    const secondsCacheLifeProfile = result.experimental.cacheLife['seconds']\n-    if (\n-      secondsCacheLifeProfile &&\n-      secondsCacheLifeProfile.stale === undefined\n-    ) {\n-      // We default this to whatever stale time you had configured for dynamic content.\n-      // Since this is basically a dynamic cache life profile.\n-      const dynamicStaleTime = result.experimental.staleTimes?.dynamic\n-      secondsCacheLifeProfile.stale =\n-        dynamicStaleTime ?? defaultConfig.experimental?.staleTimes?.dynamic\n-    }\n   }\n \n   if (result.experimental?.cacheHandlers) {"
        },
        {
            "sha": "bbe86fd90cd1699d3f67ec7b8b0c287bdce6086d",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/caches/private-seconds/page.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fprivate-seconds%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fprivate-seconds%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fprivate-seconds%2Fpage.tsx?ref=eb756a63696e2c073ca6c6f3148f4a77ea89a412",
            "patch": "@@ -0,0 +1,33 @@\n+import { Suspense } from 'react'\n+import { cachedDelay, DebugRenderKind } from '../../../shared'\n+import { unstable_cacheLife } from 'next/cache'\n+\n+export default async function Page() {\n+  return (\n+    <main>\n+      <DebugRenderKind />\n+      <p id=\"intro\">\n+        This page uses a short-lived private cache (with cacheLife(\"seconds\")),\n+        which should not be included in a static prefetch, but should be\n+        included in a runtime prefetch, because it has a long enough stale time\n+        (&ge; RUNTIME_PREFETCH_DYNAMIC_STALE, 30s)\n+      </p>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading...</div>}>\n+        <ShortLivedCache />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function ShortLivedCache() {\n+  'use cache: private'\n+  unstable_cacheLife('seconds')\n+  await cachedDelay([__filename])\n+\n+  return (\n+    <div style={{ border: '1px solid blue', padding: '1em' }}>\n+      Short-lived cached content\n+      <div id=\"cached-value\">{Date.now()}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "78005bb1123eabc12ee75d77b5606d579e531142",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/caches/public-seconds/page.tsx",
            "status": "added",
            "additions": 33,
            "deletions": 0,
            "changes": 33,
            "blob_url": "https://github.com/vercel/next.js/blob/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fpublic-seconds%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fpublic-seconds%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fpublic-seconds%2Fpage.tsx?ref=eb756a63696e2c073ca6c6f3148f4a77ea89a412",
            "patch": "@@ -0,0 +1,33 @@\n+import { Suspense } from 'react'\n+import { cachedDelay, DebugRenderKind } from '../../../shared'\n+import { unstable_cacheLife } from 'next/cache'\n+\n+export default async function Page() {\n+  return (\n+    <main>\n+      <DebugRenderKind />\n+      <p id=\"intro\">\n+        This page uses a short-lived public cache (with cacheLife(\"seconds\")),\n+        which should not be included in a static prefetch, but should be\n+        included in a runtime prefetch, because it has a long enough stale time\n+        (&ge; RUNTIME_PREFETCH_DYNAMIC_STALE, 30s)\n+      </p>\n+      <Suspense fallback={<div style={{ color: 'grey' }}>Loading...</div>}>\n+        <ShortLivedCache />\n+      </Suspense>\n+    </main>\n+  )\n+}\n+\n+async function ShortLivedCache() {\n+  'use cache'\n+  unstable_cacheLife('seconds')\n+  await cachedDelay([__filename])\n+\n+  return (\n+    <div style={{ border: '1px solid blue', padding: '1em' }}>\n+      Short-lived cached content\n+      <div id=\"cached-value\">{Date.now()}</div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "807657f7d81fe8b155ac0d496114471e9bf46402",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/caches/public-short-expire-long-stale/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fpublic-short-expire-long-stale%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fpublic-short-expire-long-stale%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fcaches%2Fpublic-short-expire-long-stale%2Fpage.tsx?ref=eb756a63696e2c073ca6c6f3148f4a77ea89a412",
            "patch": "@@ -10,7 +10,7 @@ export default async function Page() {\n         This page uses a short-lived public cache (expire &lt; DYNAMIC_EXPIRE,\n         5min), which should not be included in a static prefetch, but should be\n         included in a runtime prefetch, because it has a long enough stale time\n-        (&gt; RUNTIME_PREFETCH_DYNAMIC_STALE, 30s)\n+        (&ge; RUNTIME_PREFETCH_DYNAMIC_STALE, 30s)\n       </p>\n       <Suspense fallback={<div style={{ color: 'grey' }}>Loading...</div>}>\n         <ShortLivedCache />"
        },
        {
            "sha": "f549f90003488a234ccbacb9120b92cd7313a1c0",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/app/(default)/page.tsx",
            "status": "modified",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fapp%2F(default)%2Fpage.tsx?ref=eb756a63696e2c073ca6c6f3148f4a77ea89a412",
            "patch": "@@ -189,6 +189,40 @@ export default async function Page() {\n             </li>\n           </ul>\n         </li>\n+        <li>\n+          public, cacheLife(\"seconds\")\n+          <ul>\n+            <li>\n+              <DebugLinkAccordion\n+                href=\"/caches/public-seconds\"\n+                prefetch={'auto'}\n+              />\n+            </li>\n+            <li>\n+              <DebugLinkAccordion\n+                href=\"/caches/public-seconds\"\n+                prefetch={true}\n+              />\n+            </li>\n+          </ul>\n+        </li>\n+        <li>\n+          private, cacheLife(\"seconds\")\n+          <ul>\n+            <li>\n+              <DebugLinkAccordion\n+                href=\"/caches/private-seconds\"\n+                prefetch={'auto'}\n+              />\n+            </li>\n+            <li>\n+              <DebugLinkAccordion\n+                href=\"/caches/private-seconds\"\n+                prefetch={true}\n+              />\n+            </li>\n+          </ul>\n+        </li>\n       </ul>\n \n       <h2>misc</h2>"
        },
        {
            "sha": "b90cc210ce7de6d509e402ca21aa408070577adc",
            "filename": "test/e2e/app-dir/segment-cache/prefetch-runtime/prefetch-runtime.test.ts",
            "status": "modified",
            "additions": 30,
            "deletions": 13,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eb756a63696e2c073ca6c6f3148f4a77ea89a412/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fsegment-cache%2Fprefetch-runtime%2Fprefetch-runtime.test.ts?ref=eb756a63696e2c073ca6c6f3148f4a77ea89a412",
            "patch": "@@ -670,10 +670,32 @@ describe('<Link prefetch={true}> (runtime prefetch)', () => {\n   })\n \n   describe('cache stale time handling', () => {\n-    it('includes short-lived public caches with a long enough staleTime', async () => {\n-      // If a cache has an expiration time under 5min (DYNAMIC_EXPIRE), we omit it from static prerenders.\n-      // However, it should still be included in a runtime prefetch if it's stale time is above 30s. (RUNTIME_PREFETCH_DYNAMIC_STALE)\n-\n+    it.each([\n+      {\n+        // If a cache has an expiration time under 5min (DYNAMIC_EXPIRE), we omit it from static prerenders.\n+        // However, it should still be included in a runtime prefetch if its stale time is >=30s. (RUNTIME_PREFETCH_DYNAMIC_STALE)\n+        description:\n+          'includes short-lived public caches with a long enough staleTime',\n+        staticContent: 'This page uses a short-lived public cache',\n+        path: '/caches/public-short-expire-long-stale',\n+      },\n+      {\n+        // If a cache has an expiration time under 5min (DYNAMIC_EXPIRE), we omit it from static prerenders.\n+        // However, it should still be included in a runtime prefetch if its stale time is >=30s. (RUNTIME_PREFETCH_DYNAMIC_STALE)\n+        // `cacheLife(\"seconds\")` is deliberately set to have a stale time of 30s to stay above this treshold.\n+        description: 'includes public caches with cacheLife(\"seconds\")',\n+        staticContent: 'This page uses a short-lived public cache',\n+        path: '/caches/public-seconds',\n+      },\n+      {\n+        // A Private cache will always be omitted from static prerenders.\n+        // However, it should still be included in a runtime prefetch if its stale time is >=30s. (RUNTIME_PREFETCH_DYNAMIC_STALE)\n+        // `cacheLife(\"seconds\")` is deliberately set to have a stale time of 30s to stay above this treshold.\n+        description: 'includes private caches with cacheLife(\"seconds\")',\n+        staticContent: 'This page uses a short-lived private cache',\n+        path: '/caches/private-seconds',\n+      },\n+    ])('$description', async ({ path, staticContent }) => {\n       let page: Playwright.Page\n       const browser = await next.browser('/', {\n         beforePageLoad(p: Playwright.Page) {\n@@ -682,22 +704,20 @@ describe('<Link prefetch={true}> (runtime prefetch)', () => {\n       })\n       const act = createRouterAct(page)\n \n-      const STATIC_CONTENT = 'This page uses a short-lived public cache'\n       const DYNAMICALLY_PREFETCHABLE_CONTENT = 'Short-lived cached content'\n \n       // Reveal the link to trigger a static prefetch\n       await act(async () => {\n         const linkToggle = await browser.elementByCss(\n-          `input[data-prefetch=\"auto\"][data-link-accordion=\"/caches/public-short-expire-long-stale\"]`\n+          `input[data-prefetch=\"auto\"][data-link-accordion=\"${path}\"]`\n         )\n         await linkToggle.click()\n       }, [\n         // Should include the static shell\n         {\n-          includes: STATIC_CONTENT,\n+          includes: staticContent,\n         },\n         // Should not include the short-lived cache\n-        // (We set the `expire` value to be under 5min, so it will be excluded from prerenders)\n         {\n           includes: DYNAMICALLY_PREFETCHABLE_CONTENT,\n           block: 'reject',\n@@ -707,12 +727,11 @@ describe('<Link prefetch={true}> (runtime prefetch)', () => {\n       // Reveal the link to trigger a runtime prefetch\n       await act(async () => {\n         const linkToggle = await browser.elementByCss(\n-          `input[data-prefetch=\"runtime\"][data-link-accordion=\"/caches/public-short-expire-long-stale\"]`\n+          `input[data-prefetch=\"runtime\"][data-link-accordion=\"${path}\"]`\n         )\n         await linkToggle.click()\n       }, [\n         // Should include the short-lived cache\n-        // (We set `stale` to be above 30s, which means it shouldn't be omitted)\n         {\n           includes: DYNAMICALLY_PREFETCHABLE_CONTENT,\n         },\n@@ -721,9 +740,7 @@ describe('<Link prefetch={true}> (runtime prefetch)', () => {\n       // Navigate to the page. We didn't include any uncached IO, so the page is fully prefetched,\n       // and this shouldn't issue any more requests\n       await act(async () => {\n-        await browser\n-          .elementByCss(`a[href=\"/caches/public-short-expire-long-stale\"]`)\n-          .click()\n+        await browser.elementByCss(`a[href=\"${path}\"]`).click()\n       }, 'no-requests')\n \n       expect(await browser.elementByCss('main').text()).toInclude("
        }
    ],
    "stats": {
        "total": 159,
        "additions": 132,
        "deletions": 27
    }
}