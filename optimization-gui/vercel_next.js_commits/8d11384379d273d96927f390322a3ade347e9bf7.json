{
    "author": "bgw",
    "message": "fix(turbo-tasks-fs): Update notify-rs, handle recursive symlinks in realpath implementation, add an e2e test for symlinked files (#78220)\n\nWhile working on filesystem watching stuff, I saw that `notify-rs` had a new `with_follow_symlinks` flag, which seems very relevant to us and how we handle symlinks.\n\nWhen looking to enable this, I noticed that we lacked e2e tests for symlinks. I added a few tests, but found lots of other bugs...\n\n- I ran into https://github.com/vercel/next.js/discussions/77463#discussioncomment-12847522, which I documented, but am not fixing, because it's too far out of scope.\n- I ran into a bug with realpath, which is fixed here.",
    "sha": "8d11384379d273d96927f390322a3ade347e9bf7",
    "files": [
        {
            "sha": "702f7d04f08824669139d677d5632f7c5260f4fa",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 32,
            "deletions": 26,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -734,7 +734,7 @@ version = \"0.70.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"f49d8fed880d473ea71efb9bf597651e77201bdd4893efe54c9e5d65ae04ce6f\"\n dependencies = [\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"cexpr\",\n  \"clang-sys\",\n  \"itertools 0.13.0\",\n@@ -777,9 +777,9 @@ checksum = \"bef38d45163c2f1dde094a7dfd33ccf595c92905c8f8f4fdc18d06fb1037718a\"\n \n [[package]]\n name = \"bitflags\"\n-version = \"2.5.0\"\n+version = \"2.9.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"cf4b9d6a944f767f8e5e0db018570623c85f3d925ac718db4e06d0187adb21c1\"\n+checksum = \"5c8214115b7bf84099f1309324e63141d4c5d7cc26862f97a0a857dbefe165bd\"\n \n [[package]]\n name = \"bitreader\"\n@@ -3354,11 +3354,11 @@ checksum = \"9f2cb48b81b1dc9f39676bf99f5499babfec7cd8fe14307f7b3d747208fb5690\"\n \n [[package]]\n name = \"inotify\"\n-version = \"0.9.6\"\n+version = \"0.11.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"f8069d3ec154eb856955c1c0fbffefbf5f3c40a104ec912d4797314c1801abff\"\n+checksum = \"f37dccff2791ab604f9babef0ba14fbe0be30bd368dc541e2b08d07c8aa908f3\"\n dependencies = [\n- \"bitflags 1.3.2\",\n+ \"bitflags 2.9.0\",\n  \"inotify-sys\",\n  \"libc\",\n ]\n@@ -3823,7 +3823,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"c84f971730745f4aaac013b6cf4328baf1548efc973c0d95cfd843a3c1ca07af\"\n dependencies = [\n  \"ahash 0.8.11\",\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"const-str\",\n  \"cssparser\",\n  \"cssparser-color\",\n@@ -4310,7 +4310,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"214f07a80874bb96a8433b3cdfc84980d56c7b02e1a0d7ba4ba0db5cef785e2b\"\n dependencies = [\n  \"anyhow\",\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"ctor\",\n  \"napi-derive\",\n  \"napi-sys\",\n@@ -4647,7 +4647,7 @@ version = \"0.28.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"ab2156c4fce2f8df6c499cc1c763e4394b7482525bf2a9701c9d79d215f519e4\"\n dependencies = [\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"cfg-if\",\n  \"cfg_aliases\",\n  \"libc\",\n@@ -4680,23 +4680,29 @@ dependencies = [\n \n [[package]]\n name = \"notify\"\n-version = \"6.1.1\"\n+version = \"8.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"6205bd8bb1e454ad2e27422015fb5e4f2bcc7e08fa8f27058670d208324a4d2d\"\n+checksum = \"2fee8403b3d66ac7b26aee6e40a897d85dc5ce26f44da36b8b73e987cc52e943\"\n dependencies = [\n- \"bitflags 2.5.0\",\n- \"crossbeam-channel\",\n+ \"bitflags 2.9.0\",\n  \"filetime\",\n  \"fsevent-sys\",\n  \"inotify\",\n  \"kqueue\",\n  \"libc\",\n  \"log\",\n- \"mio 0.8.11\",\n+ \"mio 1.0.3\",\n+ \"notify-types\",\n  \"walkdir\",\n- \"windows-sys 0.48.0\",\n+ \"windows-sys 0.59.0\",\n ]\n \n+[[package]]\n+name = \"notify-types\"\n+version = \"2.0.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"5e0826a989adedc2a244799e823aece04662b66609d96af8dff7ac6df9a8925d\"\n+\n [[package]]\n name = \"nu-ansi-term\"\n version = \"0.46.0\"\n@@ -4993,7 +4999,7 @@ version = \"0.28.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"dccbc6fb560df303a44e511618256029410efbc87779018f751ef12c488271fe\"\n dependencies = [\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"cssparser\",\n  \"log\",\n  \"phf\",\n@@ -6211,7 +6217,7 @@ version = \"0.38.41\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"d7f649912bc1495e167a6edee79151c84b1bad49748cb4f1f1167f459f6224f6\"\n dependencies = [\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"errno\",\n  \"libc\",\n  \"linux-raw-sys 0.4.14\",\n@@ -7339,7 +7345,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"0f75578c97d9338cb6ae4007bda693690bac1c5b5d0bf817d43cd0b0e08632a1\"\n dependencies = [\n  \"auto_impl\",\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"rustc-hash 2.1.0\",\n  \"serde\",\n  \"swc_atoms\",\n@@ -7367,7 +7373,7 @@ version = \"8.0.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"fbfec0694cca0950515b8d87dd8dda991e45d36e257f5efd8cb7682e7617c125\"\n dependencies = [\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"once_cell\",\n  \"serde\",\n  \"serde_json\",\n@@ -7459,7 +7465,7 @@ version = \"8.1.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"4062a54522a9c02d2b68cc09282774b87121cd48693b0e67ae8c18b31b709866\"\n dependencies = [\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"bytecheck 0.8.0\",\n  \"is-macro\",\n  \"num-bigint\",\n@@ -7812,7 +7818,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"18757f2b1656db8b10d7fd153871d969d87e2909f4150378a4ae925fa6cc6768\"\n dependencies = [\n  \"arrayvec 0.7.4\",\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"either\",\n  \"new_debug_unreachable\",\n  \"num-bigint\",\n@@ -7914,7 +7920,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"b46e3a36213d78fb4233e596b8a5c81c6cdafe02d03d780eed006c983aa0a724\"\n dependencies = [\n  \"better_scoped_tls\",\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"indexmap 2.7.1\",\n  \"once_cell\",\n  \"par-core\",\n@@ -8004,7 +8010,7 @@ checksum = \"d0cf50886962aa3d7d20317a486971b91002a930b236c1e4af1f1050280b4070\"\n dependencies = [\n  \"Inflector\",\n  \"anyhow\",\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"indexmap 2.7.1\",\n  \"is-macro\",\n  \"path-clean 1.0.1\",\n@@ -8414,7 +8420,7 @@ version = \"11.0.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"e8538a8b2e8d8a3ebbf58fe7f933d7b4bb01a291fbd7356352ea255cc15bbc70\"\n dependencies = [\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"petgraph 0.7.1\",\n  \"rustc-hash 2.1.0\",\n  \"swc_atoms\",\n@@ -11204,7 +11210,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"bcdee6bea3619d311fb4b299721e89a986c3470f804b6d534340e412589028e3\"\n dependencies = [\n  \"ahash 0.8.11\",\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n  \"hashbrown 0.14.5\",\n  \"indexmap 2.7.1\",\n  \"semver 1.0.23\",\n@@ -11709,7 +11715,7 @@ version = \"0.39.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"6f42320e61fe2cfd34354ecb597f86f413484a798ba44a8ca1165c58d42da6c1\"\n dependencies = [\n- \"bitflags 2.5.0\",\n+ \"bitflags 2.9.0\",\n ]\n \n [[package]]"
        },
        {
            "sha": "332cd0c4012962b01f5dff39d627bbb448d0f0d4",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -370,7 +370,7 @@ lightningcss-napi = { version = \"0.4.3\", default-features = false, features = [\n markdown = \"1.0.0-alpha.18\"\n mime = \"0.3.16\"\n nohash-hasher = \"0.2.0\"\n-notify = \"6.1.1\"\n+notify = \"8.0.0\"\n once_cell = \"1.17.1\"\n owo-colors = \"3.5.0\"\n par-core = { version = \"1.0.3\", features = [\"rayon\"] }"
        },
        {
            "sha": "716a8db36f52c5b3b068de4e1d3c3bd64290a8be",
            "filename": "test/development/app-dir/hmr-symlink/app/layout.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Flayout.tsx?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -0,0 +1,9 @@\n+import { ReactNode } from 'react'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "69ad017d7a228859a490ad6b8fc9db1c6115ed6d",
            "filename": "test/development/app-dir/hmr-symlink/app/symlink-chain/page.tsx",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-chain%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-chain%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-chain%2Fpage.tsx?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -0,0 +1 @@\n+../symlink-link/page.tsx\n\\ No newline at end of file"
        },
        {
            "sha": "6c65d7d780c26c376d286a11c66b93ca92e8afd4",
            "filename": "test/development/app-dir/hmr-symlink/app/symlink-link/page.tsx",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-link%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-link%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-link%2Fpage.tsx?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -0,0 +1 @@\n+../symlink-target/page.tsx\n\\ No newline at end of file"
        },
        {
            "sha": "4042fe3588f6d5aff0ac60a7a30d191abff312d5",
            "filename": "test/development/app-dir/hmr-symlink/app/symlink-target/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-target%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-target%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-target%2Fpage.tsx?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <h1>This is the symlink target</h1>\n+}"
        },
        {
            "sha": "a6cad1cc7990e86198db7c006630b39de8bac671",
            "filename": "test/development/app-dir/hmr-symlink/app/symlink-target2/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-target2%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-target2%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fapp%2Fsymlink-target2%2Fpage.tsx?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <h1>This is the second symlink target</h1>\n+}"
        },
        {
            "sha": "dc7a4721b863602ff0c8d61d27fbad565b80ed8a",
            "filename": "test/development/app-dir/hmr-symlink/hmr-symlink.test.ts",
            "status": "added",
            "additions": 94,
            "deletions": 0,
            "changes": 94,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fhmr-symlink.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fhmr-symlink.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fhmr-symlink.test.ts?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -0,0 +1,94 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { assertNoRedbox, retry } from 'next-test-utils'\n+\n+// This tests file symlinks, but not directory symlinks. Directory symlinks are\n+// known to break route manifest generation:\n+// https://github.com/vercel/next.js/discussions/77463\n+describe('HMR symlinks', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('tracks updates to symlinked target', async () => {\n+    const browser = await next.browser('/symlink-link')\n+\n+    expect(await browser.elementByCss('h1').text()).toBe(\n+      'This is the symlink target'\n+    )\n+\n+    await next.patchFile(\n+      'app/symlink-target/page.tsx',\n+      (content) => content.replace('symlink target', 'updated symlink target'),\n+      async () => {\n+        await retry(async () => {\n+          await assertNoRedbox(browser)\n+          expect(await browser.elementByCss('h1').text()).toBe(\n+            'This is the updated symlink target'\n+          )\n+        })\n+      }\n+    )\n+  })\n+\n+  /* eslint-disable jest/no-standalone-expect */\n+  // This works in Turbopack and Rspack, but is broken in webpack!\n+  ;(process.env.IS_TURBOPACK_TEST || process.env.NEXT_RSPACK ? it : it.skip)(\n+    'tracks updates to the symlink',\n+    async () => {\n+      const browser = await next.browser('/symlink-link')\n+\n+      expect(await browser.elementByCss('h1').text()).toBe(\n+        'This is the symlink target'\n+      )\n+\n+      try {\n+        await next.symlink(\n+          'app/symlink-target2/page.tsx',\n+          'app/symlink-link/page.tsx'\n+        )\n+        await retry(async () => {\n+          await assertNoRedbox(browser)\n+          expect(await browser.elementByCss('h1').text()).toBe(\n+            'This is the second symlink target'\n+          )\n+        })\n+      } finally {\n+        await next.symlink(\n+          'app/symlink-target/page.tsx',\n+          'app/symlink-link/page.tsx'\n+        )\n+      }\n+    }\n+  )\n+\n+  // This works in Turbopack, but is broken in webpack!\n+  ;(process.env.IS_TURBOPACK_TEST ? it : it.skip)(\n+    'tracks updates to the middle of a symlink chain',\n+    async () => {\n+      const browser = await next.browser('/symlink-chain')\n+\n+      expect(await browser.elementByCss('h1').text()).toBe(\n+        'This is the symlink target'\n+      )\n+\n+      try {\n+        await next.symlink(\n+          'app/symlink-target2/page.tsx',\n+          'app/symlink-link/page.tsx'\n+        )\n+        await retry(async () => {\n+          await assertNoRedbox(browser)\n+          expect(await browser.elementByCss('h1').text()).toBe(\n+            'This is the second symlink target'\n+          )\n+        })\n+      } finally {\n+        await next.symlink(\n+          'app/symlink-target/page.tsx',\n+          'app/symlink-link/page.tsx'\n+        )\n+      }\n+    }\n+  )\n+  /* eslint-enable jest/no-standalone-expect */\n+})"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/development/app-dir/hmr-symlink/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhmr-symlink%2Fnext.config.js?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "40bbf16c540ef5db5b66849e95b1d23585c649bd",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -620,6 +620,23 @@ export class NextInstance {\n     )\n   }\n \n+  /**\n+   * Makes `linkFilename` point to `targetFilename`.\n+   *\n+   * Performs an atomic update to the symlink:\n+   * https://blog.moertel.com/posts/2005-08-22-how-to-change-symlinks-atomically.html\n+   */\n+  public async symlink(targetFilename: string, linkFilename: string) {\n+    const tmpLinkPath = path.join(this.testDir, linkFilename + '.tmp')\n+    try {\n+      await fs.symlink(path.join(this.testDir, targetFilename), tmpLinkPath)\n+      await fs.rename(tmpLinkPath, path.join(this.testDir, linkFilename))\n+    } catch (e) {\n+      await fs.unlink(tmpLinkPath)\n+      throw e\n+    }\n+  }\n+\n   public async renameFolder(foldername: string, newFoldername: string) {\n     await fs.rename(\n       path.join(this.testDir, foldername),"
        },
        {
            "sha": "86f7d022bca4c702a996bfc591405910bafb4883",
            "filename": "test/turbopack-dev-tests-manifest.json",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fturbopack-dev-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/test%2Fturbopack-dev-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-dev-tests-manifest.json?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -2468,6 +2468,17 @@\n     \"flakey\": [],\n     \"runtimeError\": false\n   },\n+  \"test/development/app-dir/hmr-symlink/hmr-symlink.test.ts\": {\n+    \"passed\": [\n+      \"HMR symlinks tracks updates to symlinked target\",\n+      \"HMR symlinks tracks updates to the symlink\",\n+      \"HMR symlinks tracks updates to the middle of a symlink chain\"\n+    ],\n+    \"failed\": [],\n+    \"pending\": [],\n+    \"flakey\": [],\n+    \"runtimeError\": false\n+  },\n   \"test/development/app-dir/hook-function-names/hook-function-names.test.ts\": {\n     \"passed\": [\n       \"hook-function-names should show readable hook names in stacks\","
        },
        {
            "sha": "e06819c04c6e495ba2ab368cfdecf881a8cb3191",
            "filename": "turbopack/crates/turbo-tasks-fs/src/lib.rs",
            "status": "modified",
            "additions": 72,
            "deletions": 32,
            "changes": 104,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Flib.rs?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -37,10 +37,11 @@ use std::{\n };\n \n use anyhow::{anyhow, bail, Context, Result};\n-use auto_hash_map::AutoMap;\n+use auto_hash_map::{AutoMap, AutoSet};\n use bitflags::bitflags;\n use dunce::simplified;\n use glob::Glob;\n+use indexmap::IndexSet;\n use invalidation::InvalidateFilesystem;\n use invalidator_map::InvalidatorMap;\n use jsonc_parser::{parse_to_serde_value, ParseOptions};\n@@ -1563,46 +1564,85 @@ impl FileSystemPath {\n \n     #[turbo_tasks::function]\n     pub async fn realpath_with_links(self: ResolvedVc<Self>) -> Result<Vc<RealPathResult>> {\n-        let this = self.await?;\n-        if this.is_root() {\n-            return Ok(RealPathResult {\n-                path: self,\n-                symlinks: Vec::new(),\n+        let mut current_vc = self;\n+        let mut symlinks: IndexSet<ResolvedVc<FileSystemPath>> = IndexSet::new();\n+        let mut visited: AutoSet<RcStr> = AutoSet::new();\n+        // Pick some arbitrary symlink depth limit... similar to the ELOOP logic for realpath(3).\n+        // SYMLOOP_MAX is 40 for Linux: https://unix.stackexchange.com/q/721724\n+        for _i in 0..40 {\n+            let current = current_vc.await?;\n+            if current.is_root() {\n+                // fast path\n+                return Ok(RealPathResult {\n+                    path: self,\n+                    symlinks: symlinks.into_iter().collect(),\n+                }\n+                .cell());\n             }\n-            .cell());\n-        }\n-        let parent = self.parent().to_resolved().await?;\n-        let parent_result = parent.realpath_with_links().owned().await?;\n-        let basename = this\n-            .path\n-            .rsplit_once('/')\n-            .map_or(this.path.as_str(), |(_, name)| name);\n-        let real_self = if parent_result.path != parent {\n-            parent_result\n+\n+            if !visited.insert(current.path.clone()) {\n+                break; // we detected a cycle\n+            }\n+\n+            // see if a parent segment of the path is a symlink and resolve that first\n+            let parent = self.parent().to_resolved().await?;\n+            let parent_result = parent.realpath_with_links().owned().await?;\n+            let basename = current\n                 .path\n-                .join(basename.into())\n-                .to_resolved()\n-                .await?\n-        } else {\n-            self\n-        };\n-        let mut result = parent_result;\n-        if matches!(*real_self.get_type().await?, FileSystemEntryType::Symlink) {\n-            if let LinkContent::Link { target, link_type } = &*real_self.read_link().await? {\n-                result.symlinks.push(real_self);\n-                result.path = if link_type.contains(LinkType::ABSOLUTE) {\n-                    real_self.root().to_resolved().await?\n+                .rsplit_once('/')\n+                .map_or(current.path.as_str(), |(_, name)| name);\n+            if parent_result.path != parent {\n+                current_vc = parent_result\n+                    .path\n+                    .join(basename.into())\n+                    .to_resolved()\n+                    .await?;\n+            }\n+            symlinks.extend(parent_result.symlinks);\n+\n+            // use `get_type` before trying `read_link`, as there's a good chance of a cache hit on\n+            // `get_type`, and `read_link` isn't the common codepath.\n+            if !matches!(*current_vc.get_type().await?, FileSystemEntryType::Symlink) {\n+                return Ok(RealPathResult {\n+                    path: current_vc,\n+                    symlinks: symlinks.into_iter().collect(), // convert set to vec\n+                }\n+                .cell());\n+            }\n+\n+            if let LinkContent::Link { target, link_type } = &*current_vc.read_link().await? {\n+                symlinks.insert(current_vc);\n+                current_vc = if link_type.contains(LinkType::ABSOLUTE) {\n+                    current_vc.root()\n                 } else {\n-                    result.path\n+                    *parent_result.path\n                 }\n                 .join(target.clone())\n                 .to_resolved()\n                 .await?;\n-                return Ok(result.cell());\n+            } else {\n+                // get_type() and read_link() might disagree temporarily due to turbo-tasks\n+                // eventual consistency or if the file gets invalidated before the directory does\n+                return Ok(RealPathResult {\n+                    path: current_vc,\n+                    symlinks: symlinks.into_iter().collect(), // convert set to vec\n+                }\n+                .cell());\n             }\n         }\n-        result.path = real_self;\n-        Ok(result.cell())\n+\n+        // Too many attempts or detected a cycle, we bailed out!\n+        //\n+        // TODO: There's no proper way to indicate an non-turbo-tasks error here, so just return the\n+        // original path and all the symlinks we followed.\n+        //\n+        // Returning the followed symlinks is still important, even if there is an error! Otherwise\n+        // we may never notice if the symlink loop is fixed.\n+        Ok(RealPathResult {\n+            path: self,\n+            symlinks: symlinks.into_iter().collect(),\n+        }\n+        .cell())\n     }\n }\n "
        },
        {
            "sha": "5c4a7ae53723f33db44ba8dda8de2b6980d327e7",
            "filename": "turbopack/crates/turbo-tasks-fs/src/watcher.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/8d11384379d273d96927f390322a3ade347e9bf7/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fwatcher.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8d11384379d273d96927f390322a3ade347e9bf7/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fwatcher.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Fwatcher.rs?ref=8d11384379d273d96927f390322a3ade347e9bf7",
            "patch": "@@ -150,6 +150,8 @@ impl DiskWatcher {\n         // Create a watcher object, delivering debounced events.\n         // The notification back-end is selected based on the platform.\n         let config = Config::default();\n+        // we should track and invalidate each part of a symlink chain ourselves in turbo-tasks-fs\n+        config.with_follow_symlinks(false);\n \n         let mut watcher = if let Some(poll_interval) = poll_interval {\n             let config = config.with_poll_interval(poll_interval);"
        }
    ],
    "stats": {
        "total": 311,
        "additions": 252,
        "deletions": 59
    }
}