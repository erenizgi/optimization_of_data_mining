{
    "author": "mischnic",
    "message": "Turbopack: respect `productionBrowserSourceMaps` (#78014)\n\nLet's try this again\r\n\r\n~~Blocked by https://github.com/vercel/next.js/pull/78058~~\r\nBlocked by https://github.com/vercel/next.js/pull/82448\r\n\r\n- [x] Add regression test\r\n- [x] Update failing assertions\r\n\r\nCloses PACK-4304",
    "sha": "f23f93545642bbb997815a2b5b20ffd3e4b9a907",
    "files": [
        {
            "sha": "5aee3c690b225033a86ba974ffda14ec57e4fcb1",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/f23f93545642bbb997815a2b5b20ffd3e4b9a907/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f23f93545642bbb997815a2b5b20ffd3e4b9a907/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=f23f93545642bbb997815a2b5b20ffd3e4b9a907",
            "patch": "@@ -1701,12 +1701,12 @@ impl NextConfig {\n     }\n \n     #[turbo_tasks::function]\n-    pub fn client_source_maps(&self, _mode: Vc<NextMode>) -> Result<Vc<bool>> {\n-        // Temporarily always enable client source maps as tests regress.\n-        // TODO: Respect both `self.experimental.turbopack_source_maps` and\n-        //       `self.production_browser_source_maps`\n+    pub async fn client_source_maps(&self, mode: Vc<NextMode>) -> Result<Vc<bool>> {\n         let source_maps = self.experimental.turbopack_source_maps;\n-        Ok(Vc::cell(source_maps.unwrap_or(true)))\n+        Ok(Vc::cell(source_maps.unwrap_or(match &*mode.await? {\n+            NextMode::Development => true,\n+            NextMode::Build => self.production_browser_source_maps,\n+        })))\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "52231fd92e5bb8bb02f062bb9a48e9da53f563a5",
            "filename": "test/integration/css-fixtures/next.config.js",
            "status": "modified",
            "additions": 1,
            "deletions": 4,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fintegration%2Fcss-fixtures%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fintegration%2Fcss-fixtures%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss-fixtures%2Fnext.config.js?ref=f23f93545642bbb997815a2b5b20ffd3e4b9a907",
            "patch": "@@ -3,8 +3,5 @@ module.exports = {\n     // Make sure entries are not getting disposed.\n     maxInactiveAge: 1000 * 60 * 60,\n   },\n-  webpack(cfg) {\n-    cfg.devtool = 'source-map'\n-    return cfg\n-  },\n+  productionBrowserSourceMaps: true,\n }"
        },
        {
            "sha": "35fb8d079071af89e480210235563fe2d75c5c3c",
            "filename": "test/integration/css/test/css-compilation.test.js",
            "status": "modified",
            "additions": 4,
            "deletions": 33,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fcss%2Ftest%2Fcss-compilation.test.js?ref=f23f93545642bbb997815a2b5b20ffd3e4b9a907",
            "patch": "@@ -116,39 +116,8 @@ module.exports = {\n               delete sourceMapContentParsed.file\n               delete sourceMapContentParsed.sources\n \n-              if (process.env.IS_TURBOPACK_TEST && useLightningcss) {\n-                expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n-                 {\n-                   \"mappings\": \"AAAA,qDACE,2BAKF,0DAIA,kDAIA,uCAIA\",\n-                   \"names\": [],\n-                   \"sourcesContent\": [\n-                     \"@media (480px <= width < 768px) {\n-                   ::placeholder {\n-                     color: green;\n-                   }\n-                 }\n-\n-                 .flex-parsing {\n-                   flex: 0 0 calc(50% - var(--vertical-gutter));\n-                 }\n-\n-                 .transform-parsing {\n-                   transform: translate3d(0px, 0px);\n-                 }\n-\n-                 .css-grid-shorthand {\n-                   grid-column: span 2;\n-                 }\n-\n-                 .g-docs-sidenav .filter::-webkit-input-placeholder {\n-                   opacity: 80%;\n-                 }\n-                 \",\n-                   ],\n-                   \"version\": 3,\n-                 }\n-                `)\n-              } else if (process.env.IS_TURBOPACK_TEST && !useLightningcss) {\n+              if (process.env.IS_TURBOPACK_TEST) {\n+                // Turbopack always uses lightningcss\n                 expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n                  {\n                    \"mappings\": \"AAAA,qDACE,2BAKF,0DAIA,kDAIA,uCAIA\",\n@@ -183,6 +152,7 @@ module.exports = {\n               } else if (useLightningcss) {\n                 expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n                  {\n+                   \"ignoreList\": [],\n                    \"mappings\": \"AAAA,qDACE,cACE,WACF,CACF,CAEA,cACE,2CACF,CAEA,mBACE,0BACF,CAEA,oBACE,kBACF,CAEA,mDACE,UACF\",\n                    \"names\": [],\n                    \"sourceRoot\": \"\",\n@@ -217,6 +187,7 @@ module.exports = {\n               } else {\n                 expect(sourceMapContentParsed).toMatchInlineSnapshot(`\n                   {\n+                    \"ignoreList\": [],\n                     \"mappings\": \"AAAA,+CACE,cACE,WACF,CACF,CAEA,cACE,2CACF,CAEA,mBACE,0BACF,CAEA,oBACE,kBACF,CAEA,mDACE,WACF\",\n                     \"names\": [],\n                     \"sourceRoot\": \"\","
        },
        {
            "sha": "9f4db8c561a59b523ea02beeac61dabffdd8227a",
            "filename": "test/integration/production-browser-sourcemaps/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/test%2Fintegration%2Fproduction-browser-sourcemaps%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/test%2Fintegration%2Fproduction-browser-sourcemaps%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fproduction-browser-sourcemaps%2Fnext.config.js?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -1,3 +0,0 @@\n-module.exports = {\n-  productionBrowserSourceMaps: true,\n-}"
        },
        {
            "sha": "867bdd3076bf1c7ad787c1aee7766a6e96caa6cf",
            "filename": "test/integration/production-browser-sourcemaps/test/index.test.js",
            "status": "removed",
            "additions": 0,
            "deletions": 58,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/0ec5511da47c98112e86290d2f1550ad261d91b2/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/0ec5511da47c98112e86290d2f1550ad261d91b2/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fproduction-browser-sourcemaps%2Ftest%2Findex.test.js?ref=0ec5511da47c98112e86290d2f1550ad261d91b2",
            "patch": "@@ -1,58 +0,0 @@\n-/* eslint-env jest */\n-import fs from 'fs-extra'\n-import { dirname, join } from 'path'\n-import { nextBuild, getPageFilesFromBuildManifest } from 'next-test-utils'\n-import { recursiveReadDir } from 'next/dist/lib/recursive-readdir'\n-\n-const appDir = join(__dirname, '../')\n-\n-function extractSourceMappingURL(jsContent) {\n-  // Matches both //# and //@ sourceMappingURL=...\n-  const match = jsContent.match(/\\/\\/[#@] sourceMappingURL=([^\\s]+)/)\n-  return match ? match[1] : null\n-}\n-\n-async function checkSourceMapExistsForFile(jsFilePath) {\n-  const jsContent = await fs.readFile(jsFilePath, 'utf8')\n-  const sourceMappingURL = extractSourceMappingURL(jsContent)\n-  if (!sourceMappingURL) {\n-    return\n-  }\n-  expect(sourceMappingURL).toBeTruthy()\n-  const mapPath = join(dirname(jsFilePath), sourceMappingURL)\n-  expect(await fs.pathExists(mapPath)).toBe(true)\n-}\n-\n-describe('Production browser sourcemaps', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      describe('Server support', () => {\n-        beforeAll(async () => {\n-          await nextBuild(appDir, [], {})\n-        })\n-\n-        it('includes sourcemaps for all browser files', async () => {\n-          const staticDir = join(appDir, '.next', 'static', 'chunks')\n-          const browserFiles = await recursiveReadDir(staticDir)\n-          const jsFiles = browserFiles.filter((file) => file.endsWith('.js'))\n-          expect(jsFiles).not.toBeEmpty()\n-\n-          for (const file of jsFiles) {\n-            const jsPath = join(staticDir, file)\n-            checkSourceMapExistsForFile(jsPath)\n-          }\n-        })\n-\n-        it('correctly generated the source map', async () => {\n-          const dotNextDir = join(appDir, '.next')\n-          const jsFiles = getPageFilesFromBuildManifest(appDir, '/static')\n-          for (const file of jsFiles) {\n-            const jsPath = join(dotNextDir, file)\n-            checkSourceMapExistsForFile(jsPath)\n-          }\n-        })\n-      })\n-    }\n-  )\n-})"
        },
        {
            "sha": "f27998261a36a5ed3e67d384bcc84986d6d77ef7",
            "filename": "test/production/production-browser-sourcemaps/index.test.ts",
            "status": "added",
            "additions": 78,
            "deletions": 0,
            "changes": 78,
            "blob_url": "https://github.com/vercel/next.js/blob/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fproduction%2Fproduction-browser-sourcemaps%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fproduction%2Fproduction-browser-sourcemaps%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fproduction-browser-sourcemaps%2Findex.test.ts?ref=f23f93545642bbb997815a2b5b20ffd3e4b9a907",
            "patch": "@@ -0,0 +1,78 @@\n+import fs from 'fs-extra'\n+import path from 'path'\n+import { getBuildManifest } from 'next-test-utils'\n+import { recursiveReadDir } from 'next/dist/lib/recursive-readdir'\n+import { nextTestSetup } from 'e2e-utils'\n+\n+function extractSourceMappingURL(jsContent): string | null {\n+  // Matches both //# and //@ sourceMappingURL=...\n+  const match = jsContent.match(/\\/\\/[#@] sourceMappingURL=([^\\s]+)/)\n+  return match ? match[1] : null\n+}\n+\n+async function sourceMapExistsForFile(jsFilePath) {\n+  const jsContent = await fs.readFile(jsFilePath, 'utf8')\n+  const sourceMappingURL = extractSourceMappingURL(jsContent)\n+  if (!sourceMappingURL) {\n+    if (/^__turbopack_load_page_chunks__\\([\"']/.test(jsContent)) {\n+      // There is no sourcemap in these loader chunks, ignore\n+      return undefined\n+    }\n+    return false\n+  }\n+  const mapPath = path.join(path.dirname(jsFilePath), sourceMappingURL)\n+  return await fs.pathExists(mapPath)\n+}\n+\n+describe('Production browser sourcemaps', () => {\n+  describe.each([false, true] as const)(\n+    'productionBrowserSourceMaps = %s',\n+    (productionBrowserSourceMaps) => {\n+      const { next, skipped } = nextTestSetup({\n+        files: __dirname,\n+        nextConfig: {\n+          productionBrowserSourceMaps,\n+        },\n+        skipDeployment: true,\n+      })\n+\n+      if (skipped) {\n+        return\n+      }\n+\n+      it('check sourcemaps for all browser files', async () => {\n+        const buildManifest = getBuildManifest(next.testDir)\n+\n+        // These currently don't have sourcemaps\n+        let polyfillFiles = new Set(\n+          buildManifest.polyfillFiles.map((f) => '/' + path.basename(f))\n+        )\n+\n+        const staticDir = path.join(next.testDir, '.next', 'static', 'chunks')\n+        const browserFiles = await recursiveReadDir(staticDir)\n+        const jsFiles = browserFiles.filter(\n+          (file) => file.endsWith('.js') && !polyfillFiles.has(file)\n+        )\n+        expect(jsFiles).not.toBeEmpty()\n+\n+        for (const file of jsFiles) {\n+          const jsPath = path.join(staticDir, file)\n+          expect(await sourceMapExistsForFile(jsPath)).toBeOneOf([\n+            productionBrowserSourceMaps,\n+            undefined,\n+          ])\n+        }\n+\n+        for (let page of ['/ssr', '/static']) {\n+          const jsFiles = buildManifest.pages[page]\n+          for (const file of jsFiles) {\n+            const jsPath = path.join(next.testDir, '.next', file)\n+            expect(await sourceMapExistsForFile(jsPath)).toBe(\n+              productionBrowserSourceMaps\n+            )\n+          }\n+        }\n+      })\n+    }\n+  )\n+})"
        },
        {
            "sha": "232135b322067f7f16c04889c335a5f55b4e1894",
            "filename": "test/production/production-browser-sourcemaps/pages/ssr.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fproduction%2Fproduction-browser-sourcemaps%2Fpages%2Fssr.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fproduction%2Fproduction-browser-sourcemaps%2Fpages%2Fssr.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fproduction-browser-sourcemaps%2Fpages%2Fssr.js?ref=f23f93545642bbb997815a2b5b20ffd3e4b9a907",
            "previous_filename": "test/integration/production-browser-sourcemaps/pages/ssr.js"
        },
        {
            "sha": "0f2b27fd198174a2634876cf810b6f2873fb5930",
            "filename": "test/production/production-browser-sourcemaps/pages/static.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fproduction%2Fproduction-browser-sourcemaps%2Fpages%2Fstatic.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f23f93545642bbb997815a2b5b20ffd3e4b9a907/test%2Fproduction%2Fproduction-browser-sourcemaps%2Fpages%2Fstatic.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fproduction-browser-sourcemaps%2Fpages%2Fstatic.js?ref=f23f93545642bbb997815a2b5b20ffd3e4b9a907",
            "previous_filename": "test/integration/production-browser-sourcemaps/pages/static.js"
        }
    ],
    "stats": {
        "total": 191,
        "additions": 88,
        "deletions": 103
    }
}