{
    "author": "sebmarkbage",
    "message": "Add comment that we expect the function passed to bind to be anonymous (#85070)\n\nSee https://github.com/facebook/react/pull/34911\n\nThis is a weird one but we need some consistent name to ignore these\nbecause otherwise they show up as I/O.\n\nThe simplest is to simply not assign a name to the function being\npassed. It also can't be auto-assigned by a compiler. Because whatever\nname the function is given is the name given to the AsyncResource.",
    "sha": "deec81d2f82c3752ab7590a5f28e88b478a512f4",
    "files": [
        {
            "sha": "ca4a878d96522b236bdf2bf9a953e0cee01379d0",
            "filename": "packages/next/src/server/after/after-context.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 8,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/deec81d2f82c3752ab7590a5f28e88b478a512f4/packages%2Fnext%2Fsrc%2Fserver%2Fafter%2Fafter-context.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/deec81d2f82c3752ab7590a5f28e88b478a512f4/packages%2Fnext%2Fsrc%2Fserver%2Fafter%2Fafter-context.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fafter%2Fafter-context.ts?ref=deec81d2f82c3752ab7590a5f28e88b478a512f4",
            "patch": "@@ -84,15 +84,19 @@ export class AfterContext {\n     //   after(() => x())\n     //   after(x())\n     //   await x()\n-    const wrappedCallback = bindSnapshot(async () => {\n-      try {\n-        await afterTaskAsyncStorage.run({ rootTaskSpawnPhase }, () =>\n-          callback()\n-        )\n-      } catch (error) {\n-        this.reportTaskError('function', error)\n+    const wrappedCallback = bindSnapshot(\n+      // WARNING: Don't make this a named function. It must be anonymous.\n+      // See: https://github.com/facebook/react/pull/34911\n+      async () => {\n+        try {\n+          await afterTaskAsyncStorage.run({ rootTaskSpawnPhase }, () =>\n+            callback()\n+          )\n+        } catch (error) {\n+          this.reportTaskError('function', error)\n+        }\n       }\n-    })\n+    )\n \n     this.callbackQueue.add(wrappedCallback)\n   }"
        },
        {
            "sha": "664337b51456f8588f0cc93315bcefde0584ca53",
            "filename": "packages/next/src/server/app-render/async-local-storage.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/deec81d2f82c3752ab7590a5f28e88b478a512f4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fasync-local-storage.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/deec81d2f82c3752ab7590a5f28e88b478a512f4/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fasync-local-storage.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fasync-local-storage.ts?ref=deec81d2f82c3752ab7590a5f28e88b478a512f4",
            "patch": "@@ -45,7 +45,10 @@ export function createAsyncLocalStorage<\n   return new FakeAsyncLocalStorage()\n }\n \n-export function bindSnapshot<T>(fn: T): T {\n+export function bindSnapshot<T>(\n+  // WARNING: Don't pass a named function to this argument! See: https://github.com/facebook/react/pull/34911\n+  fn: T\n+): T {\n   if (maybeGlobalAsyncLocalStorage) {\n     return maybeGlobalAsyncLocalStorage.bind(fn)\n   }"
        }
    ],
    "stats": {
        "total": 25,
        "additions": 16,
        "deletions": 9
    }
}