{
    "author": "sokra",
    "message": "Turbopack: ensure max merge segments is respected accros families (#82223)\n\n### What?\n\nWe try to limit the maximum number of merge jobs with the `max_merge_segment_count` option. But as we run `get_merge_segments` for every key family it only limits the merge jobs per family. This results in much more merge jobs then configured.\n\nThis change applied the limits across families. Lower number families will be compacted first, which is a new behavior, so maybe we want to reorder the key families to improve the order (see enum KeySpace)",
    "sha": "d3303229b397f2017a14b0712668d52a860efc7e",
    "files": [
        {
            "sha": "814a4aa87a69e30fc040aae2aad4b9c1f3d94711",
            "filename": "turbopack/crates/turbo-persistence/src/compaction/selector.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/d3303229b397f2017a14b0712668d52a860efc7e/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d3303229b397f2017a14b0712668d52a860efc7e/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fcompaction%2Fselector.rs?ref=d3303229b397f2017a14b0712668d52a860efc7e",
            "patch": "@@ -104,6 +104,7 @@ pub fn compute_metrics<T: Compactable>(\n }\n \n /// Configuration for the compaction algorithm.\n+#[derive(Clone)]\n pub struct CompactConfig {\n     /// The minimum number of files to merge at once.\n     pub min_merge_count: usize,"
        },
        {
            "sha": "c8afca6caae0f9a701bc515a2a69eddf23cf35b1",
            "filename": "turbopack/crates/turbo-persistence/src/db.rs",
            "status": "modified",
            "additions": 15,
            "deletions": 3,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/d3303229b397f2017a14b0712668d52a860efc7e/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d3303229b397f2017a14b0712668d52a860efc7e/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-persistence%2Fsrc%2Fdb.rs?ref=d3303229b397f2017a14b0712668d52a860efc7e",
            "patch": "@@ -787,16 +787,28 @@ impl TurboPersistence {\n             keys_written: u64,\n         }\n \n+        let mut compact_config = compact_config.clone();\n+        let merge_jobs = sst_by_family\n+            .iter()\n+            .map(|ssts_with_ranges| {\n+                if compact_config.max_merge_segment_count == 0 {\n+                    return Vec::new();\n+                }\n+                let merge_jobs = get_merge_segments(ssts_with_ranges, &compact_config);\n+                compact_config.max_merge_segment_count -= merge_jobs.len();\n+                merge_jobs\n+            })\n+            .collect::<Vec<_>>();\n+\n         let result = sst_by_family\n             .into_par_iter()\n+            .zip(merge_jobs.into_par_iter())\n             .with_min_len(1)\n             .enumerate()\n-            .map(|(family, ssts_with_ranges)| {\n+            .map(|(family, (ssts_with_ranges, merge_jobs))| {\n                 let family = family as u32;\n                 let _span = span.clone().entered();\n \n-                let merge_jobs = get_merge_segments(&ssts_with_ranges, compact_config);\n-\n                 if merge_jobs.is_empty() {\n                     return Ok(PartialResultPerFamily {\n                         new_meta_file: None,"
        }
    ],
    "stats": {
        "total": 19,
        "additions": 16,
        "deletions": 3
    }
}