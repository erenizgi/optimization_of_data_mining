{
    "author": "sokra",
    "message": "[Turbopack] try to avoid cloning AST during code generation, pass final_read_hint (#75853)\n\n### What?\r\n\r\n* try to avoid cloning AST during code generation, pass final_read_hint\r\n* fix tree shake ident on code generation",
    "sha": "d910a6cfa8075df11dbbb3afbde54f7cd83d7b8d",
    "files": [
        {
            "sha": "bdbdf870719e0b6219f7c4f3d262c582d589c689",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 60,
            "deletions": 13,
            "changes": 73,
            "blob_url": "https://github.com/vercel/next.js/blob/d910a6cfa8075df11dbbb3afbde54f7cd83d7b8d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d910a6cfa8075df11dbbb3afbde54f7cd83d7b8d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=d910a6cfa8075df11dbbb3afbde54f7cd83d7b8d",
            "patch": "@@ -34,19 +34,24 @@ pub mod utils;\n pub mod webpack;\n pub mod worker_chunk;\n \n-use std::fmt::{Display, Formatter};\n+use std::{\n+    fmt::{Display, Formatter},\n+    mem::take,\n+    sync::Arc,\n+};\n \n use anyhow::Result;\n use chunk::EcmascriptChunkItem;\n use code_gen::{CodeGenerateable, CodeGeneration, CodeGenerationHoistedStmt};\n+use either::Either;\n use parse::{parse, ParseResult};\n use path_visitor::ApplyVisitors;\n use references::esm::UrlRewriteBehavior;\n pub use references::{AnalyzeEcmascriptModuleResult, TURBOPACK_HELPER};\n use serde::{Deserialize, Serialize};\n pub use static_code::StaticEcmascriptCode;\n use swc_core::{\n-    common::{Globals, Mark, GLOBALS},\n+    common::{comments::Comments, util::take::Take, Globals, Mark, GLOBALS},\n     ecma::{\n         ast::{self, ModuleItem, Program, Script},\n         codegen::{text_writer::JsWriter, Emitter},\n@@ -835,18 +840,51 @@ async fn gen_content_with_code_gens(\n     generate_source_map: Vc<bool>,\n     original_source_map: ResolvedVc<OptionStringifiedSourceMap>,\n ) -> Result<Vc<EcmascriptModuleContent>> {\n-    let parsed = parsed.await?;\n+    let parsed = parsed.final_read_hint().await?;\n \n     match &*parsed {\n-        ParseResult::Ok {\n-            program,\n-            source_map,\n-            globals,\n-            eval_context,\n-            comments,\n-            ..\n-        } => {\n-            let mut program = program.clone();\n+        ParseResult::Ok { .. } => {\n+            // We need a mutable version of the AST. We try to avoid cloning it by unwrapping the\n+            // ReadRef.\n+            let mut parsed = ReadRef::try_unwrap(parsed);\n+            let (mut program, source_map, globals, eval_context, comments) = match &mut parsed {\n+                Ok(ParseResult::Ok {\n+                    program,\n+                    source_map,\n+                    globals,\n+                    eval_context,\n+                    comments,\n+                }) => (\n+                    program.take(),\n+                    &*source_map,\n+                    &*globals,\n+                    &*eval_context,\n+                    match Arc::try_unwrap(take(comments)) {\n+                        Ok(comments) => Either::Left(comments),\n+                        Err(comments) => Either::Right(comments),\n+                    },\n+                ),\n+                Err(parsed) => {\n+                    let ParseResult::Ok {\n+                        program,\n+                        source_map,\n+                        globals,\n+                        eval_context,\n+                        comments,\n+                    } = &**parsed\n+                    else {\n+                        unreachable!();\n+                    };\n+                    (\n+                        program.clone(),\n+                        source_map,\n+                        globals,\n+                        eval_context,\n+                        Either::Right(comments.clone()),\n+                    )\n+                }\n+                _ => unreachable!(),\n+            };\n \n             process_content_with_code_gens(\n                 &mut program,\n@@ -864,7 +902,15 @@ async fn gen_content_with_code_gens(\n             let generate_source_map = *generate_source_map.await?;\n \n             {\n-                let comments = comments.consumable();\n+                let comments = match comments {\n+                    Either::Left(comments) => Either::Left(comments.into_consumable()),\n+                    Either::Right(ref comments) => Either::Right(comments.consumable()),\n+                };\n+                let comments: &dyn Comments = match &comments {\n+                    Either::Left(comments) => comments,\n+                    Either::Right(comments) => comments,\n+                };\n+\n                 let mut emitter = Emitter {\n                     cfg: swc_core::ecma::codegen::Config::default(),\n                     cm: source_map.clone(),\n@@ -876,6 +922,7 @@ async fn gen_content_with_code_gens(\n                         generate_source_map.then_some(&mut mappings),\n                     ),\n                 };\n+\n                 emitter.emit_program(&program)?;\n             }\n "
        },
        {
            "sha": "4c9000aa06aed6ba6f74206c3a0b039277b40f47",
            "filename": "turbopack/crates/turbopack-ecmascript/src/swc_comments.rs",
            "status": "modified",
            "additions": 38,
            "deletions": 11,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/d910a6cfa8075df11dbbb3afbde54f7cd83d7b8d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fswc_comments.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d910a6cfa8075df11dbbb3afbde54f7cd83d7b8d/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fswc_comments.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fswc_comments.rs?ref=d910a6cfa8075df11dbbb3afbde54f7cd83d7b8d",
            "patch": "@@ -1,4 +1,4 @@\n-use std::{cell::RefCell, mem::take};\n+use std::{borrow::Cow, cell::RefCell, mem::take};\n \n use rustc_hash::FxHashMap;\n use swc_core::{\n@@ -12,6 +12,7 @@ use swc_core::{\n /// Immutable version of [SwcComments] which doesn't allow mutation. The `take`\n /// variants are still implemented, but do not mutate the content. They are used\n /// by the SWC Emitter.\n+#[derive(Default)]\n pub struct ImmutableComments {\n     pub leading: FxHashMap<BytePos, Vec<Comment>>,\n     pub trailing: FxHashMap<BytePos, Vec<Comment>>,\n@@ -39,8 +40,12 @@ impl ImmutableComments {\n         }\n     }\n \n+    pub fn into_consumable(self) -> CowComments<'static> {\n+        CowComments::owned(self)\n+    }\n+\n     pub fn consumable(&self) -> CowComments<'_> {\n-        CowComments::new(self)\n+        CowComments::borrowed(self)\n     }\n }\n \n@@ -186,25 +191,44 @@ impl Comments for ImmutableComments {\n }\n \n pub struct CowComments<'a> {\n-    leading: RefCell<FxHashMap<BytePos, &'a Vec<Comment>>>,\n-    trailing: RefCell<FxHashMap<BytePos, &'a Vec<Comment>>>,\n+    leading: RefCell<FxHashMap<BytePos, Cow<'a, Vec<Comment>>>>,\n+    trailing: RefCell<FxHashMap<BytePos, Cow<'a, Vec<Comment>>>>,\n }\n \n impl<'a> CowComments<'a> {\n-    fn new(comments: &'a ImmutableComments) -> Self {\n+    fn borrowed(comments: &'a ImmutableComments) -> Self {\n         Self {\n             leading: RefCell::new(\n                 comments\n                     .leading\n                     .iter()\n-                    .map(|(&key, value)| (key, value))\n+                    .map(|(&key, value)| (key, Cow::Borrowed(value)))\n                     .collect(),\n             ),\n             trailing: RefCell::new(\n                 comments\n                     .trailing\n                     .iter()\n-                    .map(|(&key, value)| (key, value))\n+                    .map(|(&key, value)| (key, Cow::Borrowed(value)))\n+                    .collect(),\n+            ),\n+        }\n+    }\n+\n+    fn owned(comments: ImmutableComments) -> Self {\n+        Self {\n+            leading: RefCell::new(\n+                comments\n+                    .leading\n+                    .into_iter()\n+                    .map(|(key, value)| (key, Cow::Owned(value)))\n+                    .collect(),\n+            ),\n+            trailing: RefCell::new(\n+                comments\n+                    .trailing\n+                    .into_iter()\n+                    .map(|(key, value)| (key, Cow::Owned(value)))\n                     .collect(),\n             ),\n         }\n@@ -240,14 +264,17 @@ impl Comments for CowComments<'_> {\n         &self,\n         pos: swc_core::common::BytePos,\n     ) -> Option<Vec<swc_core::common::comments::Comment>> {\n-        self.leading.borrow_mut().remove(&pos).map(|v| v.to_owned())\n+        self.leading\n+            .borrow_mut()\n+            .remove(&pos)\n+            .map(|v| v.into_owned())\n     }\n \n     fn get_leading(\n         &self,\n         pos: swc_core::common::BytePos,\n     ) -> Option<Vec<swc_core::common::comments::Comment>> {\n-        self.leading.borrow().get(&pos).map(|&v| v.to_owned())\n+        self.leading.borrow().get(&pos).map(|v| (**v).clone())\n     }\n \n     fn add_trailing(\n@@ -281,14 +308,14 @@ impl Comments for CowComments<'_> {\n         self.trailing\n             .borrow_mut()\n             .remove(&pos)\n-            .map(|v| v.to_owned())\n+            .map(|v| v.into_owned())\n     }\n \n     fn get_trailing(\n         &self,\n         pos: swc_core::common::BytePos,\n     ) -> Option<Vec<swc_core::common::comments::Comment>> {\n-        self.trailing.borrow().get(&pos).map(|&v| v.to_owned())\n+        self.trailing.borrow().get(&pos).map(|v| (**v).clone())\n     }\n \n     fn add_pure_comment(&self, _pos: swc_core::common::BytePos) {"
        }
    ],
    "stats": {
        "total": 122,
        "additions": 98,
        "deletions": 24
    }
}