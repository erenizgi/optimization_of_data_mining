{
    "author": "huozhi",
    "message": "[mcp] change get-project-path to get-project-metadata (#84619)",
    "sha": "5e59617d5478080e392f6c2eee9fb7298e803b54",
    "files": [
        {
            "sha": "c90340fafbd5e0c47bd94d3a6280e4bdc7f5c45b",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=5e59617d5478080e392f6c2eee9fb7298e803b54",
            "patch": "@@ -758,12 +758,13 @@ export async function createHotReloaderTurbopack(\n     }),\n     ...(nextConfig.experimental.mcpServer\n       ? [\n-          getMcpMiddleware(\n+          getMcpMiddleware({\n             projectPath,\n             distDir,\n-            (message) => hotReloader.send(message),\n-            () => clients.size\n-          ),\n+            sendHmrMessage: (message) => hotReloader.send(message),\n+            getActiveConnectionCount: () => clients.size,\n+            getDevServerUrl: () => process.env.__NEXT_PRIVATE_ORIGIN,\n+          }),\n         ]\n       : []),\n   ]"
        },
        {
            "sha": "25323d2ef731bec105528fb8ae3af2d68a2702b1",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 6,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=5e59617d5478080e392f6c2eee9fb7298e803b54",
            "patch": "@@ -1632,12 +1632,14 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n       }),\n       ...(this.config.experimental.mcpServer\n         ? [\n-            getMcpMiddleware(\n-              this.dir,\n-              this.distDir,\n-              (message) => this.send(message),\n-              () => this.webpackHotMiddleware?.getClientCount() ?? 0\n-            ),\n+            getMcpMiddleware({\n+              projectPath: this.dir,\n+              distDir: this.distDir,\n+              sendHmrMessage: (message) => this.send(message),\n+              getActiveConnectionCount: () =>\n+                this.webpackHotMiddleware?.getClientCount() ?? 0,\n+              getDevServerUrl: () => process.env.__NEXT_PRIVATE_ORIGIN,\n+            }),\n           ]\n         : []),\n     ]"
        },
        {
            "sha": "962b0d45d1c8091bd4a814af4e54f0d7a044195b",
            "filename": "packages/next/src/server/mcp/get-mcp-middleware.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 14,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-mcp-middleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-mcp-middleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-mcp-middleware.ts?ref=5e59617d5478080e392f6c2eee9fb7298e803b54",
            "patch": "@@ -1,15 +1,12 @@\n import type { ServerResponse, IncomingMessage } from 'http'\n-import { getOrCreateMcpServer } from './get-or-create-mcp-server'\n+import {\n+  getOrCreateMcpServer,\n+  type McpServerOptions,\n+} from './get-or-create-mcp-server'\n import { parseBody } from '../api-utils/node/parse-body'\n import { StreamableHTTPServerTransport } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/streamableHttp'\n-import type { HmrMessageSentToBrowser } from '../dev/hot-reloader-types'\n \n-export function getMcpMiddleware(\n-  projectPath: string,\n-  distDir: string,\n-  sendHmrMessage: (message: HmrMessageSentToBrowser) => void,\n-  getActiveConnectionCount: () => number\n-) {\n+export function getMcpMiddleware(options: McpServerOptions) {\n   return async function (\n     req: IncomingMessage,\n     res: ServerResponse,\n@@ -19,12 +16,7 @@ export function getMcpMiddleware(\n     if (!pathname.startsWith('/_next/mcp')) {\n       return next()\n     }\n-    const mcpServer = getOrCreateMcpServer(\n-      projectPath,\n-      distDir,\n-      sendHmrMessage,\n-      getActiveConnectionCount\n-    )\n+    const mcpServer = getOrCreateMcpServer(options)\n     const transport = new StreamableHTTPServerTransport({\n       sessionIdGenerator: undefined,\n     })"
        },
        {
            "sha": "70f29a3f948ca8fb45a646659221a6555be565d7",
            "filename": "packages/next/src/server/mcp/get-or-create-mcp-server.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 13,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Fget-or-create-mcp-server.ts?ref=5e59617d5478080e392f6c2eee9fb7298e803b54",
            "patch": "@@ -1,19 +1,22 @@\n import { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n-import { registerGetProjectPathTool } from './tools/get-project-path'\n+import { registerGetProjectMetadataTool } from './tools/get-project-metadata'\n import { registerGetErrorsTool } from './tools/get-errors'\n import { registerGetPageMetadataTool } from './tools/get-page-metadata'\n import { registerGetLogsTool } from './tools/get-logs'\n import { registerGetActionByIdTool } from './tools/get-server-action-by-id'\n import type { HmrMessageSentToBrowser } from '../dev/hot-reloader-types'\n \n+export interface McpServerOptions {\n+  projectPath: string\n+  distDir: string\n+  sendHmrMessage: (message: HmrMessageSentToBrowser) => void\n+  getActiveConnectionCount: () => number\n+  getDevServerUrl: () => string | undefined\n+}\n+\n let mcpServer: McpServer | undefined\n \n-export const getOrCreateMcpServer = (\n-  projectPath: string,\n-  distDir: string,\n-  sendHmrMessage: (message: HmrMessageSentToBrowser) => void,\n-  getActiveConnectionCount: () => number\n-) => {\n+export const getOrCreateMcpServer = (options: McpServerOptions) => {\n   if (mcpServer) {\n     return mcpServer\n   }\n@@ -23,15 +26,23 @@ export const getOrCreateMcpServer = (\n     version: '0.1.0',\n   })\n \n-  registerGetProjectPathTool(mcpServer, projectPath)\n-  registerGetErrorsTool(mcpServer, sendHmrMessage, getActiveConnectionCount)\n+  registerGetProjectMetadataTool(\n+    mcpServer,\n+    options.projectPath,\n+    options.getDevServerUrl\n+  )\n+  registerGetErrorsTool(\n+    mcpServer,\n+    options.sendHmrMessage,\n+    options.getActiveConnectionCount\n+  )\n   registerGetPageMetadataTool(\n     mcpServer,\n-    sendHmrMessage,\n-    getActiveConnectionCount\n+    options.sendHmrMessage,\n+    options.getActiveConnectionCount\n   )\n-  registerGetLogsTool(mcpServer, distDir)\n-  registerGetActionByIdTool(mcpServer, distDir)\n+  registerGetLogsTool(mcpServer, options.distDir)\n+  registerGetActionByIdTool(mcpServer, options.distDir)\n \n   return mcpServer\n }"
        },
        {
            "sha": "877da4a7a1291fd0c1a6184480f2cbfd73b866d1",
            "filename": "packages/next/src/server/mcp/tools/get-project-metadata.ts",
            "status": "renamed",
            "additions": 11,
            "deletions": 5,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-metadata.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5e59617d5478080e392f6c2eee9fb7298e803b54/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-metadata.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fmcp%2Ftools%2Fget-project-metadata.ts?ref=5e59617d5478080e392f6c2eee9fb7298e803b54",
            "patch": "@@ -1,14 +1,15 @@\n import type { McpServer } from 'next/dist/compiled/@modelcontextprotocol/sdk/server/mcp'\n \n-export function registerGetProjectPathTool(\n+export function registerGetProjectMetadataTool(\n   server: McpServer,\n-  projectPath: string\n+  projectPath: string,\n+  getDevServerUrl: () => string | undefined\n ) {\n   server.registerTool(\n-    'get_project_path',\n+    'get_project_metadata',\n     {\n       description:\n-        'Returns the absolute path of the root directory for this Next.js project.',\n+        'Returns the the metadata of this Next.js project, including project path, dev server URL, etc.',\n       inputSchema: {},\n     },\n     async (_request) => {\n@@ -24,11 +25,16 @@ export function registerGetProjectPathTool(\n           }\n         }\n \n+        const devServerUrl = getDevServerUrl()\n+\n         return {\n           content: [\n             {\n               type: 'text',\n-              text: projectPath,\n+              text: JSON.stringify({\n+                projectPath,\n+                devServerUrl,\n+              }),\n             },\n           ],\n         }",
            "previous_filename": "packages/next/src/server/mcp/tools/get-project-path.ts"
        },
        {
            "sha": "5c9272827518ec8c3ffc8466f078c69cb221240c",
            "filename": "test/development/mcp-server/mcp-server-get-project-metadata.test.ts",
            "status": "renamed",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/5e59617d5478080e392f6c2eee9fb7298e803b54/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-project-metadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5e59617d5478080e392f6c2eee9fb7298e803b54/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-project-metadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-project-metadata.test.ts?ref=5e59617d5478080e392f6c2eee9fb7298e803b54",
            "patch": "@@ -1,14 +1,14 @@\n import { FileRef, nextTestSetup } from 'e2e-utils'\n import path from 'path'\n \n-describe('mcp-server get_project_path tool', () => {\n+describe('mcp-server get_project_metadata tool', () => {\n   const { next } = nextTestSetup({\n     files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n   })\n-  it('should return correct project path via get_project_path tool', async () => {\n+  it('should return correct project metadata via get_project_metadata tool', async () => {\n     const mcpEndpoint = `${next.url}/_next/mcp`\n \n-    // Call get_project_path tool\n+    // Call get_project_metadata tool\n     const callToolResponse = await fetch(mcpEndpoint, {\n       method: 'POST',\n       headers: {\n@@ -20,7 +20,7 @@ describe('mcp-server get_project_path tool', () => {\n         id: 'call-tool-1',\n         method: 'tools/call',\n         params: {\n-          name: 'get_project_path',\n+          name: 'get_project_metadata',\n           arguments: {},\n         },\n       }),\n@@ -38,12 +38,23 @@ describe('mcp-server get_project_path tool', () => {\n     expect(content).toBeInstanceOf(Array)\n     expect(content?.[0]?.type).toBe('text')\n \n-    const actualProjectPath = content?.[0]?.text\n+    const metadataText = content?.[0]?.text\n+    expect(metadataText).toBeTruthy()\n \n-    // Verify it's an absolute path\n-    expect(path.isAbsolute(actualProjectPath)).toBe(true)\n+    const metadata = JSON.parse(metadataText)\n \n-    // Should match the test directory\n-    expect(actualProjectPath).toBe(next.testDir)\n+    // Verify projectPath\n+    expect(metadata.projectPath).toBeTruthy()\n+    expect(path.isAbsolute(metadata.projectPath)).toBe(true)\n+    expect(metadata.projectPath).toBe(next.testDir)\n+\n+    // Verify devServerUrl\n+    expect(metadata.devServerUrl).toBeTruthy()\n+    expect(metadata.devServerUrl).toMatch(/^https?:\\/\\//)\n+    expect(metadata.devServerUrl).toContain('localhost')\n+\n+    // The devServerUrl should match the next.url (base URL without path)\n+    const expectedBaseUrl = next.url\n+    expect(metadata.devServerUrl).toBe(expectedBaseUrl)\n   })\n })",
            "previous_filename": "test/development/mcp-server/mcp-server-get-project-path.test.ts"
        }
    ],
    "stats": {
        "total": 125,
        "additions": 74,
        "deletions": 51
    }
}