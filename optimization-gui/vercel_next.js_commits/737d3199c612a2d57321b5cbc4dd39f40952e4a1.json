{
    "author": "huozhi",
    "message": "[segment-explorer] optimize tree view (#80392)",
    "sha": "737d3199c612a2d57321b5cbc4dd39f40952e4a1",
    "files": [
        {
            "sha": "ab14394535a0853dd2634c014237cf5b90be21e7",
            "filename": "packages/next/src/next-devtools/dev-overlay/components/overview/segment-explorer.tsx",
            "status": "modified",
            "additions": 79,
            "deletions": 118,
            "changes": 197,
            "blob_url": "https://github.com/vercel/next.js/blob/737d3199c612a2d57321b5cbc4dd39f40952e4a1/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/737d3199c612a2d57321b5cbc4dd39f40952e4a1/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fnext-devtools%2Fdev-overlay%2Fcomponents%2Foverview%2Fsegment-explorer.tsx?ref=737d3199c612a2d57321b5cbc4dd39f40952e4a1",
            "patch": "@@ -2,53 +2,12 @@ import type { HTMLProps } from 'react'\n import { css } from '../../utils/css'\n import type { DevToolsInfoPropsCore } from '../errors/dev-tools-indicator/dev-tools-info/dev-tools-info'\n import { DevToolsInfo } from '../errors/dev-tools-indicator/dev-tools-info/dev-tools-info'\n-import { cx } from '../../utils/cx'\n import {\n   type SegmentNode,\n   useSegmentTreeClientState,\n } from '../../../../shared/lib/devtool/app-segment-tree'\n import type { Trie, TrieNode } from '../../../../shared/lib/devtool/trie'\n \n-const IconLayout = (props: React.SVGProps<SVGSVGElement>) => {\n-  return (\n-    <svg\n-      {...props}\n-      viewBox=\"0 0 16 16\"\n-      fill=\"none\"\n-      xmlns=\"http://www.w3.org/2000/svg\"\n-    >\n-      <path\n-        d=\"M16 12.5L15.9873 12.7559C15.8677 13.9323 14.9323 14.8677 13.7559 14.9873L13.5 15H2.5L2.24414 14.9873C1.06772 14.8677 0.132274 13.9323 0.0126953 12.7559L0 12.5V1H16V12.5ZM1.5 6.25488V12.5C1.5 13.0523 1.94772 13.5 2.5 13.5H4.99512V6.25488H1.5ZM6.24512 6.25488V13.5H13.5C14.0523 13.5 14.5 13.0523 14.5 12.5V6.25488H6.24512ZM1.5 5.00488H14.5V2.5H1.5V5.00488Z\"\n-        fill=\"currentColor\"\n-      />\n-    </svg>\n-  )\n-}\n-\n-const IconPage = (props: React.SVGProps<SVGSVGElement>) => {\n-  return (\n-    <svg\n-      {...props}\n-      viewBox=\"0 0 16 16\"\n-      fill=\"none\"\n-      strokeLinejoin=\"round\"\n-      xmlns=\"http://www.w3.org/2000/svg\"\n-    >\n-      <path\n-        fillRule=\"evenodd\"\n-        clipRule=\"evenodd\"\n-        d=\"M14.5 6.5V13.5C14.5 14.8807 13.3807 16 12 16H4C2.61929 16 1.5 14.8807 1.5 13.5V1.5V0H3H8H9.08579C9.351 0 9.60536 0.105357 9.79289 0.292893L14.2071 4.70711C14.3946 4.89464 14.5 5.149 14.5 5.41421V6.5ZM13 6.5V13.5C13 14.0523 12.5523 14.5 12 14.5H4C3.44772 14.5 3 14.0523 3 13.5V1.5H8V5V6.5H9.5H13ZM9.5 2.12132V5H12.3787L9.5 2.12132Z\"\n-        fill=\"currentColor\"\n-      />\n-    </svg>\n-  )\n-}\n-\n-const ICONS = {\n-  layout: <IconLayout width={16} />,\n-  page: <IconPage width={16} />,\n-}\n-\n function PageSegmentTree({ tree }: { tree: Trie<SegmentNode> | undefined }) {\n   if (!tree) {\n     return null\n@@ -63,6 +22,7 @@ function PageSegmentTree({ tree }: { tree: Trie<SegmentNode> | undefined }) {\n         node={tree.getRoot()}\n         level={0}\n         segment=\"\"\n+        parentSegment=\"\"\n       />\n     </div>\n   )\n@@ -71,19 +31,22 @@ function PageSegmentTree({ tree }: { tree: Trie<SegmentNode> | undefined }) {\n function PageSegmentTreeLayerPresentation({\n   tree,\n   segment,\n+  parentSegment,\n   node,\n   level,\n }: {\n   tree: Trie<SegmentNode>\n   segment: string\n+  parentSegment: string\n   node: TrieNode<SegmentNode>\n   level: number\n }) {\n   const pagePath = node.value?.pagePath || ''\n   const nodeName = node.value?.type\n+  const isFile = !!nodeName\n \n   const segments = pagePath.split('/') || []\n-  const fileName = segments.pop() || ''\n+  const fileName = isFile ? segments.pop() || '' : ''\n   const childrenKeys = Object.keys(node.children)\n \n   const sortedChildrenKeys = childrenKeys.sort((a, b) => {\n@@ -97,65 +60,64 @@ function PageSegmentTreeLayerPresentation({\n     return a.localeCompare(b)\n   })\n \n+  // check if it has file children\n+  const hasFileChildren = sortedChildrenKeys.some((key) => {\n+    const childNode = node.children[key]\n+    return !!childNode?.value?.type\n+  })\n+\n+  // If it's the 1st level and contains a file, use 'app' as the folder name\n+  const folderName = level === 1 && isFile ? 'app' : parentSegment\n+\n   return (\n-    <div\n-      className=\"segment-explorer-item\"\n-      data-nextjs-devtool-segment-explorer-segment={segment}\n-    >\n-      {fileName ? (\n-        <div className={cx('segment-explorer-item-row')}>\n-          <div className=\"segment-explorer-line\">\n-            <div className={`segment-explorer-line-text-${nodeName}`}>\n-              <span\n-                className={cx(\n-                  'segment-explorer-line-icon',\n-                  `segment-explorer-line-icon-${nodeName}`\n-                )}\n-              >\n-                {nodeName === 'layout' ? ICONS.layout : ICONS.page}\n-              </span>\n-              <span className=\"segment-explorer-filename-path\">{fileName}</span>\n-            </div>\n-          </div>\n-        </div>\n-      ) : segment ? (\n-        <div className={'segment-explorer-item-row'}>\n-          <div className=\"segment-explorer-line\">\n-            <div className={`segment-explorer-line-text-${nodeName}`}>\n-              <span\n-                className={cx(\n-                  'segment-explorer-line-icon',\n-                  `segment-explorer-line-icon-${nodeName}`\n-                )}\n-              ></span>\n-              <span className=\"segment-explorer-filename-path\">\n-                {`${segment}/`}\n-              </span>\n+    <>\n+      {isFile ? (\n+        <div\n+          className=\"segment-explorer-item\"\n+          data-nextjs-devtool-segment-explorer-segment={segment}\n+        >\n+          <div\n+            className=\"segment-explorer-item-row\"\n+            style={{\n+              // If it's children levels, show indents if there's any file at that level.\n+              // Otherwise it's empty folder, no need to show indents.\n+              ...(level > 0 && isFile && { paddingLeft: `${level * 8}px` }),\n+            }}\n+          >\n+            <div className=\"segment-explorer-line\">\n+              <div className={`segment-explorer-line-text-${nodeName}`}>\n+                <div className=\"segment-explorer-filename\">\n+                  {folderName && (\n+                    <span className=\"segment-explorer-filename--path\">\n+                      {folderName}\n+                    </span>\n+                  )}\n+                  <span className=\"segment-explorer-filename--name\">\n+                    {fileName}\n+                  </span>\n+                </div>\n+              </div>\n             </div>\n           </div>\n         </div>\n       ) : null}\n-\n-      <div\n-        className=\"segment-explorer-segment-children\"\n-        data-nextjs-devtool-segment-explorer-level={level}\n-      >\n-        {sortedChildrenKeys.map((childSegment) => {\n-          const child = node.children[childSegment]\n-          return (\n-            child && (\n-              <PageSegmentTreeLayerPresentation\n-                key={childSegment}\n-                segment={childSegment}\n-                tree={tree}\n-                node={child}\n-                level={level + 1}\n-              />\n-            )\n-          )\n-        })}\n-      </div>\n-    </div>\n+      {sortedChildrenKeys.map((childSegment) => {\n+        const child = node.children[childSegment]\n+        if (!child) {\n+          return null\n+        }\n+        return (\n+          <PageSegmentTreeLayerPresentation\n+            key={childSegment}\n+            segment={childSegment}\n+            parentSegment={segment}\n+            tree={tree}\n+            node={child}\n+            level={hasFileChildren ? level + 1 : level}\n+          />\n+        )\n+      })}\n+    </>\n   )\n }\n \n@@ -177,47 +139,46 @@ export function SegmentsExplorer(\n export const DEV_TOOLS_INFO_RENDER_FILES_STYLES = css`\n   .segment-explorer-content {\n     overflow-y: auto;\n-    padding: 0 12px;\n     font-size: var(--size-14);\n+    margin: -12px -8px;\n+  }\n+\n+  .segment-explorer-item {\n+    margin: 4px 0;\n+  }\n+\n+  .segment-explorer-item:nth-child(odd) {\n+    background-color: var(--color-gray-100);\n   }\n \n   .segment-explorer-item-row {\n     display: flex;\n     align-items: center;\n-    gap: 8px;\n-    padding: 2px 0;\n+    padding: 4px 24px;\n+    border-radius: 6px;\n   }\n \n-  [data-nextjs-devtool-segment-explorer-level].segment-explorer-segment-children {\n-    padding-left: 20px;\n-  }\n-  [data-nextjs-devtool-segment-explorer-level='0'].segment-explorer-segment-children {\n-    padding-left: 0px;\n+  .segment-explorer-children--intended {\n+    padding-left: 16px;\n   }\n \n-  .segment-explorer-filename-path {\n-    display: inline-block;\n+  .segment-explorer-filename--path {\n+    margin-right: 8px;\n   }\n-\n-  .segment-explorer-filename-path a {\n-    color: inherit;\n-    text-decoration: inherit;\n+  .segment-explorer-filename--name {\n+    color: var(--color-gray-800);\n   }\n \n   .segment-explorer-line {\n     white-space: pre;\n     cursor: default;\n   }\n \n-  .segment-explorer-line-icon {\n-    margin-right: 4px;\n-  }\n-  .segment-explorer-line-icon-page {\n-    color: inherit;\n+  .segment-explorer-line {\n+    color: var(--color-gray-1000);\n   }\n \n-  .segment-explorer-line-text-page {\n-    color: var(--color-gray-1000);\n-    font-weight: 500;\n+  [data-nextjs-devtool-segment-explorer-level='odd'] {\n+    background-color: var(--color-gray-100);\n   }\n `"
        },
        {
            "sha": "38c0bcafb7e076c4681d32668dd3d9a6aa0442b1",
            "filename": "test/development/app-dir/segment-explorer/segment-explorer.test.ts",
            "status": "modified",
            "additions": 12,
            "deletions": 23,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/737d3199c612a2d57321b5cbc4dd39f40952e4a1/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/737d3199c612a2d57321b5cbc4dd39f40952e4a1/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fsegment-explorer%2Fsegment-explorer.test.ts?ref=737d3199c612a2d57321b5cbc4dd39f40952e4a1",
            "patch": "@@ -26,35 +26,24 @@ describe('segment-explorer', () => {\n   it('should render the segment explorer for parallel routes', async () => {\n     const browser = await next.browser('/parallel-routes')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     parallel-routes/\n-     layout.tsx\n-     page.tsx\n-     @bar/\n-     layout.tsx\n-     page.tsx\n-     @foo/\n-     layout.tsx\n-     page.tsx\"\n+     \"applayout.tsx\n+     parallel-routeslayout.tsx\n+     parallel-routespage.tsx\n+     @barlayout.tsx\n+     @barpage.tsx\n+     @foolayout.tsx\n+     @foopage.tsx\"\n     `)\n   })\n \n   it('should render the segment explorer for nested routes', async () => {\n     const browser = await next.browser('/blog/~/grid')\n     expect(await getSegmentExplorerContent(browser)).toMatchInlineSnapshot(`\n-     \"app/\n-     layout.tsx\n-     (v2)/\n-     layout.tsx\n-     blog/\n-     (team)/\n-     layout.tsx\n-     ~/\n-     (overview)/\n-     layout.tsx\n-     grid/\n-     page.tsx\"\n+     \"applayout.tsx\n+     (v2)layout.tsx\n+     (team)layout.tsx\n+     (overview)layout.tsx\n+     gridpage.tsx\"\n     `)\n   })\n })"
        }
    ],
    "stats": {
        "total": 232,
        "additions": 91,
        "deletions": 141
    }
}