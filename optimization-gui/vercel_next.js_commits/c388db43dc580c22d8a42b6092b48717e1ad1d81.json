{
    "author": "devjiwonchoi",
    "message": "CI: Enable `experimental.isolatedDevBuild` for `test-dev` (#84562)\n\nEnabling `experimental.isolatedDevBuild` required many changes to the\ncurrent workflow, so we will incrementally roll out to the tests.\n\nEnabling on test-dev instead of test-experimental-dev because\n`-experimental` CIs are filtered via `experimental-tests-manifest.json`\nand they don't cover all tests. We want to enable this feature by\ndefault so we should ensure this incremental rollout is covered on all\ntest cases.\n\nThe flag was enabled for `test-experimental-dev` at\nhttps://github.com/vercel/next.js/pull/84099, and this PR moves the flag\nto the `test-dev` job.\n\n1. ~~test-experimental-dev\n([link](https://github.com/vercel/next.js/pull/84099))~~\n2. test-dev (here)\n3. test-prod\n4. test-integration\n5. test-unit\n6. Enable by default, remove the flag, and update the rest\n\nx-ref: https://github.com/vercel/next.js/pull/84043",
    "sha": "c388db43dc580c22d8a42b6092b48717e1ad1d81",
    "files": [
        {
            "sha": "ceb68f362a6b012ea717187ab93ec95204b9d071",
            "filename": ".github/workflows/build_and_test.yml",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/.github%2Fworkflows%2Fbuild_and_test.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/.github%2Fworkflows%2Fbuild_and_test.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_test.yml?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -735,6 +735,7 @@ jobs:\n         export IS_WEBPACK_TEST=1\n         export NEXT_TEST_MODE=dev\n         export NEXT_TEST_REACT_VERSION=\"${{ matrix.react }}\"\n+        export __NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD=true\n \n         node run-tests.js \\\n           --timings \\\n@@ -964,7 +965,6 @@ jobs:\n         export __NEXT_EXPERIMENTAL_DEBUG_CHANNEL=true\n         export NEXT_EXTERNAL_TESTS_FILTERS=\"test/experimental-tests-manifest.json\"\n         export NEXT_TEST_MODE=dev\n-        export __NEXT_EXPERIMENTAL_ISOLATED_DEV_BUILD=true\n         export IS_WEBPACK_TEST=1\n \n         node run-tests.js \\"
        },
        {
            "sha": "a5e2c2fc17a6f1e80c9ec2c91edc0fc759420b09",
            "filename": "test/development/basic/hmr/run-error-recovery-hmr-test.util.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fbasic%2Fhmr%2Frun-error-recovery-hmr-test.util.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -9,6 +9,7 @@ import {\n   retry,\n   waitFor,\n   trimEndMultiline,\n+  getDistDir,\n } from 'next-test-utils'\n import { nextTestSetup } from 'e2e-utils'\n import { outdent } from 'outdent'\n@@ -767,7 +768,7 @@ export function runErrorRecoveryHmrTest(nextConfig: {\n \n   if (!process.env.IS_TURBOPACK_TEST) {\n     it('should have client HMR events in trace file', async () => {\n-      const traceData = await next.readFile('.next/trace')\n+      const traceData = await next.readFile(`${getDistDir()}/trace`)\n       expect(traceData).toContain('client-hmr-latency')\n       expect(traceData).toContain('client-error')\n       expect(traceData).toContain('client-success')"
        },
        {
            "sha": "bd5e84b980bcf8d5e1fcbf38200de385c145ae78",
            "filename": "test/development/mcp-server/mcp-server-get-server-action-by-id.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-server-action-by-id.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-server-action-by-id.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmcp-server%2Fmcp-server-get-server-action-by-id.test.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -1,6 +1,7 @@\n import { FileRef, nextTestSetup } from 'e2e-utils'\n import path from 'path'\n import fs from 'fs/promises'\n+import { getDistDir } from 'next-test-utils'\n \n describe('mcp-server get_server_action_by_id tool', () => {\n   const { next } = nextTestSetup({\n@@ -16,7 +17,7 @@ describe('mcp-server get_server_action_by_id tool', () => {\n     // Read the manifest to get a valid action ID\n     const manifestPath = path.join(\n       next.testDir,\n-      '.next',\n+      getDistDir(),\n       'server',\n       'server-reference-manifest.json'\n     )\n@@ -114,7 +115,7 @@ describe('mcp-server get_server_action_by_id tool', () => {\n     // Read the manifest to get inline action ID\n     const manifestPath = path.join(\n       next.testDir,\n-      '.next',\n+      getDistDir(),\n       'server',\n       'server-reference-manifest.json'\n     )"
        },
        {
            "sha": "04d6a83cfaff3a8c721bd4433f42624f416b58ef",
            "filename": "test/development/middleware-errors/index.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fmiddleware-errors%2Findex.test.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -1,4 +1,4 @@\n-import { assertNoRedbox, check, retry } from 'next-test-utils'\n+import { assertNoRedbox, check, getDistDir, retry } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n import { nextTestSetup } from 'e2e-utils'\n \n@@ -303,7 +303,7 @@ describe('middleware - development errors', () => {\n               '\\n    at <unknown> (middleware.js:3)' +\n               // TODO: Should be ignore-listed\n               '\\n    at eval (middleware.js:3:13)' +\n-              '\\n    at (middleware)/./middleware.js (.next/server/middleware.js:18:1)' +\n+              `\\n    at (middleware)/./middleware.js (${getDistDir()}/server/middleware.js:18:1)` +\n               '\\n    at __webpack_require__ '\n       )\n     })"
        },
        {
            "sha": "0ddf19750283c7c8ee010111bda93de514ba13bd",
            "filename": "test/development/pages-dir/client-navigation/rendering.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fpages-dir%2Fclient-navigation%2Frendering.test.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -2,7 +2,7 @@\n \n import cheerio from 'cheerio'\n import { nextTestSetup } from 'e2e-utils'\n-import { fetchViaHTTP, renderViaHTTP } from 'next-test-utils'\n+import { fetchViaHTTP, getDistDir, renderViaHTTP } from 'next-test-utils'\n import webdriver from 'next-webdriver'\n import { BUILD_MANIFEST, REACT_LOADABLE_MANIFEST } from 'next/constants'\n import path from 'path'\n@@ -333,11 +333,13 @@ describe('Client Navigation rendering', () => {\n       // build dynamic page\n       await fetch('/dynamic/ssr')\n \n-      const buildManifest = await next.readJSON(`.next/${BUILD_MANIFEST}`)\n+      const buildManifest = await next.readJSON(\n+        `${getDistDir()}/${BUILD_MANIFEST}`\n+      )\n       const reactLoadableManifest = await next.readJSON(\n         process.env.IS_TURBOPACK_TEST\n-          ? `.next/server/pages/dynamic/ssr/${REACT_LOADABLE_MANIFEST}`\n-          : `.next/${REACT_LOADABLE_MANIFEST}`\n+          ? `${getDistDir()}/server/pages/dynamic/ssr/${REACT_LOADABLE_MANIFEST}`\n+          : `${getDistDir()}/${REACT_LOADABLE_MANIFEST}`\n       )\n       const resources = []\n "
        },
        {
            "sha": "58c44d709957f5f370d88858d45cdf56ec8b70c1",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -6,6 +6,7 @@ import {\n   check,\n   waitFor,\n   getRedboxSource,\n+  getDistDir,\n } from 'next-test-utils'\n import type { Request, Response } from 'playwright'\n import fs from 'node:fs/promises'\n@@ -32,7 +33,7 @@ describe('app-dir action handling', () => {\n   if (isNextStart) {\n     it('should output exportName and filename info in manifest', async () => {\n       const referenceManifest = await next.readJSON(\n-        '.next/server/server-reference-manifest.json'\n+        `${getDistDir()}/server/server-reference-manifest.json`\n       )\n       let foundExportNames = []\n \n@@ -935,7 +936,7 @@ describe('app-dir action handling', () => {\n     it('should not expose action content in sourcemaps', async () => {\n       // We check all sourcemaps in the `static` folder for sensitive information given that chunking\n       const sourcemaps = await fs\n-        .readdir(join(next.testDir, '.next', 'static'), {\n+        .readdir(join(next.testDir, getDistDir(), 'static'), {\n           recursive: true,\n           encoding: 'utf8',\n         })\n@@ -944,7 +945,7 @@ describe('app-dir action handling', () => {\n             files\n               .filter((f) => f.endsWith('.js.map'))\n               .map((f) =>\n-                fs.readFile(join(next.testDir, '.next', 'static', f), {\n+                fs.readFile(join(next.testDir, getDistDir(), 'static', f), {\n                   encoding: 'utf8',\n                 })\n               )\n@@ -1022,14 +1023,14 @@ describe('app-dir action handling', () => {\n     it('should bundle external libraries if they are on the action layer', async () => {\n       await next.fetch('/client')\n       const pageBundle = await fs.readFile(\n-        join(next.testDir, '.next', 'server', 'app', 'client', 'page.js'),\n+        join(next.testDir, getDistDir(), 'server', 'app', 'client', 'page.js'),\n         { encoding: 'utf8' }\n       )\n       if (isTurbopack) {\n         const chunkPaths = pageBundle.matchAll(/R\\.c\\(\"([^\"]*)\"\\)/g)\n         const reads = [...chunkPaths].map(async (match) => {\n           const bundle = await fs.readFile(\n-            join(next.testDir, '.next', ...match[1].split(/[\\\\/]/g)),\n+            join(next.testDir, getDistDir(), ...match[1].split(/[\\\\/]/g)),\n             { encoding: 'utf8' }\n           )\n           return bundle.includes('node_modules/nanoid/index.js')"
        },
        {
            "sha": "2bf59c9a049fb9628f17a2cb64156cd1b3eeb801",
            "filename": "test/e2e/app-dir/app-external/app-external.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Fapp-external%2Fapp-external.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Fapp-external%2Fapp-external.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-external%2Fapp-external.test.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -1,5 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { assertNoRedbox, check, retry } from 'next-test-utils'\n+import { assertNoRedbox, check, getDistDir, retry } from 'next-test-utils'\n \n async function resolveStreamResponse(response: any, onData?: any) {\n   let result = ''\n@@ -274,7 +274,7 @@ describe('app dir - external dependency', () => {\n     expect(html).toContain('resolve response')\n \n     const outputFile = await next.readFile(\n-      '.next/server/app/cjs/server/page.js'\n+      `${getDistDir()}/server/app/cjs/server/page.js`\n     )\n     expect(outputFile).not.toContain('image-response')\n   })"
        },
        {
            "sha": "ce2c0164f58b4ab718d10ac31f9d90f1a56a5ed6",
            "filename": "test/e2e/app-dir/metadata-dynamic-routes/index.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Findex.test.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -1,6 +1,6 @@\n import { nextTestSetup } from 'e2e-utils'\n import imageSize from 'image-size'\n-import { check } from 'next-test-utils'\n+import { check, getDistDir } from 'next-test-utils'\n \n const CACHE_HEADERS = {\n   NONE: 'no-cache, no-store',\n@@ -228,12 +228,12 @@ describe('app dir - metadata dynamic routes', () => {\n \n       if (isNextDev) {\n         await check(async () => {\n-          next.hasFile('.next/server/app-paths-manifest.json')\n+          next.hasFile(`${getDistDir()}/server/app-paths-manifest.json`)\n           return 'success'\n         }, /success/)\n \n         const appPathsManifest = JSON.parse(\n-          await next.readFile('.next/server/app-paths-manifest.json')\n+          await next.readFile(`${getDistDir()}/server/app-paths-manifest.json`)\n         )\n         const entryKeys = Object.keys(appPathsManifest)\n         // Only has one route for twitter-image with catch-all routes in dev"
        },
        {
            "sha": "2c1d7148dc55bd7cdb7117577c5ffcf4b5170614",
            "filename": "test/e2e/app-dir/rsc-basic/rsc-basic.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 4,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frsc-basic%2Frsc-basic.test.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -1,5 +1,5 @@\n import path from 'path'\n-import { check } from 'next-test-utils'\n+import { check, getDistDir } from 'next-test-utils'\n import { nextTestSetup } from 'e2e-utils'\n import cheerio from 'cheerio'\n import {\n@@ -42,7 +42,7 @@ describe('app dir - rsc basics', () => {\n         const clientReferenceManifest = JSON.parse(\n           (\n             await next.readFile(\n-              '.next/server/app/page_client-reference-manifest.js'\n+              `${getDistDir()}/server/app/page_client-reference-manifest.js`\n             )\n           ).match(/]=(.+)$/)[1]\n         )\n@@ -632,13 +632,15 @@ describe('app dir - rsc basics', () => {\n   if (isNextStart) {\n     it('should generate edge SSR manifests for Node.js', async () => {\n       const requiredServerFiles = JSON.parse(\n-        await next.readFile('.next/required-server-files.json')\n+        await next.readFile(`${getDistDir()}/required-server-files.json`)\n       ).files\n \n       const files = ['middleware-build-manifest.js', 'middleware-manifest.json']\n \n       let promises = files.map(async (file) => {\n-        expect(await next.hasFile(path.join('.next/server', file))).toBe(true)\n+        expect(\n+          await next.hasFile(path.join(`${getDistDir()}/server`, file))\n+        ).toBe(true)\n       })\n       await Promise.all(promises)\n "
        },
        {
            "sha": "3b73ed05a26730585772ba617f0487dc6a3b19c6",
            "filename": "test/e2e/app-dir/typed-routes-validator/typed-routes-validator.test.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c388db43dc580c22d8a42b6092b48717e1ad1d81/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts?ref=c388db43dc580c22d8a42b6092b48717e1ad1d81",
            "patch": "@@ -1,4 +1,5 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { getDistDir } from 'next-test-utils'\n \n describe('typed-routes-validator', () => {\n   const { next, isNextStart, skipped } = nextTestSetup({\n@@ -11,7 +12,7 @@ describe('typed-routes-validator', () => {\n   }\n \n   it('should generate route validation correctly', async () => {\n-    const dts = await next.readFile('.next/types/validator.ts')\n+    const dts = await next.readFile(`${getDistDir()}/types/validator.ts`)\n     // sanity check that dev generation is working\n     expect(dts).toContain('const handler = {} as typeof import(')\n   })"
        }
    ],
    "stats": {
        "total": 58,
        "additions": 33,
        "deletions": 25
    }
}