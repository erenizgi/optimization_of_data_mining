{
    "author": "bgw",
    "message": "fix(CI): On musl/alpine builds, pin llvm to llvm20, add llvm bin directory to path (#81519)\n\nAlpine Edge recently removed `llvm-config` from the PATH:\n\n- 3.22:\nhttps://pkgs.alpinelinux.org/contents?file=llvm-config&path=&name=&branch=v3.22&repo=&arch=x86_64\n- Edge:\nhttps://pkgs.alpinelinux.org/contents?file=llvm-config&path=&name=&branch=edge&repo=&arch=x86_64\n\nCI job: https://github.com/vercel/next.js/actions/runs/16208743604\n\nAlso, fix a bunch of escaping problems with how we invoke bash inside of\ndocker...\n\nCo-authored-by: Will Binns-Smith <wbinnssmith@gmail.com>",
    "sha": "a4a754d01cd1dd1f1d1498a2135c382328537dd0",
    "files": [
        {
            "sha": "a84d93b672c4849957c4813a2ad01af0494ad126",
            "filename": ".github/workflows/build_and_deploy.yml",
            "status": "modified",
            "additions": 51,
            "deletions": 45,
            "changes": 96,
            "blob_url": "https://github.com/vercel/next.js/blob/a4a754d01cd1dd1f1d1498a2135c382328537dd0/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/a4a754d01cd1dd1f1d1498a2135c382328537dd0/.github%2Fworkflows%2Fbuild_and_deploy.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_and_deploy.yml?ref=a4a754d01cd1dd1f1d1498a2135c382328537dd0",
            "patch": "@@ -224,16 +224,16 @@ jobs:\n             # - zig linker with portable glibc is avoided as it has known issues with static tls + node.js + multi threaded\n             #   environment.\n             docker: ghcr.io/napi-rs/napi-rs/nodejs-rust:stable-2023-09-17-x64\n-            build: >-\n-              set -ex &&\n-              apt update &&\n-              apt install -y pkg-config xz-utils dav1d libdav1d-dev &&\n-              rustup show &&\n-              rustup target add x86_64-unknown-linux-gnu &&\n-              npm i -g \"@napi-rs/cli@${NAPI_CLI_VERSION}\" &&\n-              unset CC_x86_64_unknown_linux_gnu && unset CC &&\n-              cd packages/next-swc && npm run build-native-release -- --target x86_64-unknown-linux-gnu &&\n-              strip native/next-swc.*.node &&\n+            build: |\n+              apt update\n+              apt install -y pkg-config xz-utils dav1d libdav1d-dev\n+              rustup show\n+              rustup target add x86_64-unknown-linux-gnu\n+              npm i -g \"@napi-rs/cli@${NAPI_CLI_VERSION}\"\n+              unset CC_x86_64_unknown_linux_gnu && unset CC\n+              cd packages/next-swc\n+              npm run build-native-release -- --target x86_64-unknown-linux-gnu\n+              strip native/next-swc.*.node\n               objdump -T native/next-swc.*.node | grep GLIBC_\n \n           - host:\n@@ -244,16 +244,17 @@ jobs:\n \n             target: 'x86_64-unknown-linux-musl'\n             docker: ghcr.io/napi-rs/napi-rs/nodejs-rust:stable-2023-09-17-alpine\n-            build: >-\n-              set -ex &&\n-              apk update &&\n-              apk del llvm &&\n-              apk add --no-cache libc6-compat pkgconfig dav1d libdav1d dav1d-dev clang-static llvm llvm-dev &&\n-              rustup show &&\n-              rustup target add x86_64-unknown-linux-musl &&\n-              npm i -g \"@napi-rs/cli@${NAPI_CLI_VERSION}\" &&\n-              export RUSTFLAGS='--cfg tokio_unstable -Zshare-generics=y -Zthreads=8 -Csymbol-mangling-version=v0 -Ctarget-feature=-crt-static' &&\n-              cd packages/next-swc && npm run build-native-release -- --target x86_64-unknown-linux-musl &&\n+            build: |\n+              apk update\n+              apk del llvm\n+              apk add --no-cache libc6-compat pkgconfig dav1d libdav1d dav1d-dev clang20-static llvm20 llvm20-dev\n+              export PATH=\"/usr/lib/llvm20/bin:$PATH\"\n+              rustup show\n+              rustup target add x86_64-unknown-linux-musl\n+              npm i -g \"@napi-rs/cli@${NAPI_CLI_VERSION}\"\n+              export RUSTFLAGS='--cfg tokio_unstable -Zshare-generics=y -Zthreads=8 -Csymbol-mangling-version=v0 -Ctarget-feature=-crt-static'\n+              cd packages/next-swc\n+              npm run build-native-release -- --target x86_64-unknown-linux-musl\n               strip native/next-swc.*.node\n \n           - host:\n@@ -264,18 +265,18 @@ jobs:\n \n             target: 'aarch64-unknown-linux-gnu'\n             docker: ghcr.io/napi-rs/napi-rs/nodejs-rust:stable-2023-09-17-aarch64\n-            build: >-\n-              set -ex &&\n-              apt update &&\n-              apt install -y pkg-config xz-utils dav1d libdav1d-dev &&\n-              export JEMALLOC_SYS_WITH_LG_PAGE=16 &&\n-              rustup show &&\n-              rustup target add aarch64-unknown-linux-gnu &&\n-              npm i -g \"@napi-rs/cli@${NAPI_CLI_VERSION}\" &&\n-              export CC_aarch64_unknown_linux_gnu=/usr/bin/clang &&\n-              export CFLAGS_aarch64_unknown_linux_gnu=\\\"--target=aarch64-unknown-linux-gnu --sysroot=/usr/aarch64-unknown-linux-gnu\\\" &&\n-              cd packages/next-swc && npm run build-native-release -- --target aarch64-unknown-linux-gnu &&\n-              llvm-strip -x native/next-swc.*.node &&\n+            build: |\n+              apt update\n+              apt install -y pkg-config xz-utils dav1d libdav1d-dev\n+              export JEMALLOC_SYS_WITH_LG_PAGE=16\n+              rustup show\n+              rustup target add aarch64-unknown-linux-gnu\n+              npm i -g \"@napi-rs/cli@${NAPI_CLI_VERSION}\"\n+              export CC_aarch64_unknown_linux_gnu=/usr/bin/clang\n+              export CFLAGS_aarch64_unknown_linux_gnu=\"--target=aarch64-unknown-linux-gnu --sysroot=/usr/aarch64-unknown-linux-gnu\"\n+              cd packages/next-swc\n+              npm run build-native-release -- --target aarch64-unknown-linux-gnu\n+              llvm-strip -x native/next-swc.*.node\n               objdump -T native/next-swc.*.node | grep GLIBC_\n \n           - host:\n@@ -286,17 +287,18 @@ jobs:\n \n             target: 'aarch64-unknown-linux-musl'\n             docker: ghcr.io/napi-rs/napi-rs/nodejs-rust:stable-2023-09-17-alpine\n-            build: >-\n-              set -ex &&\n-              apk update &&\n-              apk del llvm &&\n-              apk add --no-cache libc6-compat pkgconfig dav1d libdav1d dav1d-dev clang-static llvm llvm-dev &&\n-              export JEMALLOC_SYS_WITH_LG_PAGE=16 &&\n-              npm i -g \"@napi-rs/cli@${NAPI_CLI_VERSION}\" &&\n-              rustup show &&\n-              rustup target add aarch64-unknown-linux-musl &&\n-              export RUSTFLAGS='--cfg tokio_unstable -Zshare-generics=y -Zthreads=8 -Zunstable-options -Csymbol-mangling-version=v0 -Clinker-flavor=gnu-lld-cc -Clink-self-contained=+linker' &&\n-              cd packages/next-swc && npm run build-native-release -- --target aarch64-unknown-linux-musl &&\n+            build: |\n+              apk update\n+              apk del llvm\n+              apk add --no-cache libc6-compat pkgconfig dav1d libdav1d dav1d-dev clang20-static llvm20 llvm20-dev\n+              export PATH=\"/usr/lib/llvm20/bin:$PATH\"\n+              export JEMALLOC_SYS_WITH_LG_PAGE=16\n+              npm i -g \"@napi-rs/cli@${NAPI_CLI_VERSION}\"\n+              rustup show\n+              rustup target add aarch64-unknown-linux-musl\n+              export RUSTFLAGS='--cfg tokio_unstable -Zshare-generics=y -Zthreads=8 -Zunstable-options -Csymbol-mangling-version=v0 -Clinker-flavor=gnu-lld-cc -Clink-self-contained=+linker'\n+              cd packages/next-swc\n+              npm run build-native-release -- --target aarch64-unknown-linux-musl\n               llvm-strip -x native/next-swc.*.node\n \n     name: stable - ${{ matrix.settings.target }} - node@16\n@@ -373,6 +375,9 @@ jobs:\n \n       - name: Build in docker\n         if: ${{ matrix.settings.docker && steps.build-exists.outputs.BUILD_EXISTS == 'no' }}\n+        env:\n+          # put the command in an environment variable to avoid escaping issues\n+          DOCKER_CMD: ${{ matrix.settings.build }}\n         run: |\n           docker run -v \"/var/run/docker.sock\":\"/var/run/docker.sock\" \\\n             -e CI -e RUST_BACKTRACE -e NAPI_CLI_VERSION -e CARGO_TERM_COLOR -e CARGO_INCREMENTAL \\\n@@ -382,8 +387,9 @@ jobs:\n             -v ${{ env.HOME }}/.cargo/registry:/root/.cargo/registry \\\n             -v ${{ github.workspace }}:/build \\\n             -w /build \\\n-            --entrypoint=bash ${{ matrix.settings.docker }} \\\n-            -c \"${{ matrix.settings.build }}\"\n+            --entrypoint=bash \\\n+            ${{ matrix.settings.docker }} \\\n+            -xeo pipefail -c \"$DOCKER_CMD\" # these args are passed to the entrypoint (bash)\n \n       - name: cache build\n         if: ${{ matrix.settings.docker && steps.build-exists.outputs.BUILD_EXISTS == 'no' }}"
        }
    ],
    "stats": {
        "total": 96,
        "additions": 51,
        "deletions": 45
    }
}