{
    "author": "timneutkens",
    "message": "Turbopack Build: Fix metadata test (#79776)\n\n## What?\n\nChanges the test to not use the `.next` folder but instead fetch the\nrunning server which makes sure it does not rely on specific formats.",
    "sha": "54acbd43476e615f4c0994cc1fab4096385ddee5",
    "files": [
        {
            "sha": "30b77a21fc5e3882437d799810ca28ad1cbe19b4",
            "filename": "test/lib/next-modes/base.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Flib%2Fnext-modes%2Fbase.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Flib%2Fnext-modes%2Fbase.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fbase.ts?ref=54acbd43476e615f4c0994cc1fab4096385ddee5",
            "patch": "@@ -545,6 +545,16 @@ export class NextInstance {\n     return fs.readFile(path.join(this.testDir, filename), 'utf8')\n   }\n \n+  public async readFileBuffer(\n+    filename: string\n+  ): Promise<Buffer<ArrayBufferLike>> {\n+    return fs.readFile(path.join(this.testDir, filename))\n+  }\n+\n+  public async writeFileBuffer(filename: string, data: Buffer): Promise<void> {\n+    return fs.writeFile(path.join(this.testDir, filename), data)\n+  }\n+\n   public async readFiles(\n     dirname: string,\n     predicate: (filename: string) => boolean"
        },
        {
            "sha": "af98450595e8b8efd9e505cddc5ed705b665a4d8",
            "filename": "test/production/app-dir/metadata-static-route-cache/app/favicon.ico",
            "status": "modified",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.ico",
            "raw_url": "https://github.com/vercel/next.js/raw/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.ico",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.ico?ref=54acbd43476e615f4c0994cc1fab4096385ddee5"
        },
        {
            "sha": "82339b3b1dbbcf4550b737faf99c7774196fb8cb",
            "filename": "test/production/app-dir/metadata-static-route-cache/app/favicon.ico.new",
            "status": "removed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/e66680dcf9e8aa1eb978e51564e2e73511be4ae0/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.ico.new",
            "raw_url": "https://github.com/vercel/next.js/raw/e66680dcf9e8aa1eb978e51564e2e73511be4ae0/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.ico.new",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.ico.new?ref=e66680dcf9e8aa1eb978e51564e2e73511be4ae0"
        },
        {
            "sha": "40cc5977d4d3a3f386438ca6b0bb4e3e4b978e1e",
            "filename": "test/production/app-dir/metadata-static-route-cache/app/favicon.new.ico",
            "status": "added",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.new.ico",
            "raw_url": "https://github.com/vercel/next.js/raw/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.new.ico",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Ffavicon.new.ico?ref=54acbd43476e615f4c0994cc1fab4096385ddee5"
        },
        {
            "sha": "c7295294439d6f927620e7678ae9e9b007480c93",
            "filename": "test/production/app-dir/metadata-static-route-cache/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Flayout.tsx?ref=54acbd43476e615f4c0994cc1fab4096385ddee5",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Layout({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "b7bb4dc1497bac8e6f4c339b760dcecbc67de692",
            "filename": "test/production/app-dir/metadata-static-route-cache/app/opengraph-image.new.png",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Fopengraph-image.new.png",
            "raw_url": "https://github.com/vercel/next.js/raw/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Fopengraph-image.new.png",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Fopengraph-image.new.png?ref=54acbd43476e615f4c0994cc1fab4096385ddee5",
            "previous_filename": "test/production/app-dir/metadata-static-route-cache/app/opengraph-image.png.new"
        },
        {
            "sha": "15a9b6e44f614ce795d24c2eaef02da254b1a4f0",
            "filename": "test/production/app-dir/metadata-static-route-cache/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fapp%2Fpage.tsx?ref=54acbd43476e615f4c0994cc1fab4096385ddee5",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <h1>Hello World</h1>\n+}"
        },
        {
            "sha": "70c325b6bd9de63e57398698c962ca4fa8842fcc",
            "filename": "test/production/app-dir/metadata-static-route-cache/metadata-static-route-cache.test.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 25,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fmetadata-static-route-cache.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fmetadata-static-route-cache.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fmetadata-static-route-cache%2Fmetadata-static-route-cache.test.ts?ref=54acbd43476e615f4c0994cc1fab4096385ddee5",
            "patch": "@@ -14,39 +14,51 @@ describe('app dir - metadata static routes cache', () => {\n   })\n \n   it('should generate different content after replace the static metadata file', async () => {\n-    await next.build()\n+    await next.start()\n \n-    const faviconBuildContent = await next.readFile(\n-      '.next/server/app/favicon.ico.body'\n-    )\n-    const opengrpahImageBuildContent = await next.readFile(\n-      '.next/server/app/opengraph-image.png.body'\n-    )\n+    const $ = await next.render$('/')\n+    const faviconUrl = $('link[rel=\"icon\"]').attr('href')\n+    const faviconBody = await (await next.fetch(faviconUrl)).text()\n+    const faviconMd5 = generateMD5(faviconBody)\n \n-    const faviconMd5 = generateMD5(faviconBuildContent)\n-    const opengraphImageMd5 = generateMD5(opengrpahImageBuildContent)\n+    const opengraphImageUrl = $('meta[property=\"og:image\"]').attr('href')\n+    const opengraphImageBody = await (\n+      await next.fetch(opengraphImageUrl)\n+    ).text()\n+    const opengraphImageMd5 = generateMD5(opengraphImageBody)\n \n-    // Update favicon and opengraph image\n-    const newFaviconContent = await next.readFile('app/favicon.ico.new')\n-    await next.patchFile('app/favicon.ico', newFaviconContent)\n+    await next.stop()\n \n-    const newOpengraphImageContent = await next.readFile(\n-      'app/opengraph-image.png.new'\n-    )\n-    await next.patchFile('app/opengraph-image.png', newOpengraphImageContent)\n+    // Update favicon and opengraph image\n+    const newFaviconContent = await next.readFileBuffer('app/favicon.new.ico')\n+    await next.remove('app/favicon.ico')\n+    await next.writeFileBuffer('app/favicon.ico', newFaviconContent)\n \n-    await next.build()\n-    const faviconBuildContentNew = await next.readFile(\n-      '.next/server/app/favicon.ico.body'\n+    const newOpengraphImageContent = await next.readFileBuffer(\n+      'app/opengraph-image.new.png'\n     )\n-    const opengrpahImageBuildContentNew = await next.readFile(\n-      '.next/server/app/opengraph-image.png.body'\n+    await next.remove('app/opengraph-image.png')\n+    await next.writeFileBuffer(\n+      'app/opengraph-image.png',\n+      newOpengraphImageContent\n     )\n \n-    const faviconMd5New = generateMD5(faviconBuildContentNew)\n-    const opengraphImageMd5New = generateMD5(opengrpahImageBuildContentNew)\n+    await next.start()\n+\n+    const new$ = await next.render$('/')\n+    const newFaviconUrl = new$('link[rel=\"icon\"]').attr('href')\n+    const newFaviconBody = await (await next.fetch(newFaviconUrl)).text()\n+    const newFaviconMd5 = generateMD5(newFaviconBody)\n+\n+    const newOpengraphImageUrl = new$('meta[property=\"og:image\"]').attr('href')\n+    const newOpengraphImageBody = await (\n+      await next.fetch(newOpengraphImageUrl)\n+    ).text()\n+    const newOpengraphImageMd5 = generateMD5(newOpengraphImageBody)\n+\n+    await next.stop()\n \n-    expect(faviconMd5).not.toBe(faviconMd5New)\n-    expect(opengraphImageMd5).not.toBe(opengraphImageMd5New)\n+    expect(faviconMd5).not.toBe(newFaviconMd5)\n+    expect(opengraphImageMd5).not.toBe(newOpengraphImageMd5)\n   })\n })"
        },
        {
            "sha": "721d1ea4386fd9f88911bfd0608592f41f2224c6",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/54acbd43476e615f4c0994cc1fab4096385ddee5/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=54acbd43476e615f4c0994cc1fab4096385ddee5",
            "patch": "@@ -18519,10 +18519,10 @@\n     \"runtimeError\": false\n   },\n   \"test/production/app-dir/metadata-static-route-cache/metadata-static-route-cache.test.ts\": {\n-    \"passed\": [],\n-    \"failed\": [\n+    \"passed\": [\n       \"app dir - metadata static routes cache should generate different content after replace the static metadata file\"\n     ],\n+    \"failed\": [],\n     \"pending\": [],\n     \"flakey\": [],\n     \"runtimeError\": false"
        }
    ],
    "stats": {
        "total": 86,
        "additions": 59,
        "deletions": 27
    }
}