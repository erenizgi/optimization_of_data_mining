{
    "author": "eps1lon",
    "message": "[turbopack] Improve internal error message when source map retrieval fails (#81508)\n\nMostly so that I know which source URL slipped through.",
    "sha": "b0641f12e9fefb7e75049c6ab9477ce2d211e471",
    "files": [
        {
            "sha": "ce2409f0ee099dc542e0bd378567f79dc325ad5b",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/b0641f12e9fefb7e75049c6ab9477ce2d211e471/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/b0641f12e9fefb7e75049c6ab9477ce2d211e471/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=b0641f12e9fefb7e75049c6ab9477ce2d211e471",
            "patch": "@@ -1411,7 +1411,7 @@ pub async fn get_source_map_rope(\n                     },\n                 )\n             }\n-            _ => bail!(\"Unknown url scheme\"),\n+            _ => bail!(\"Unknown url scheme '{}'\", url.scheme()),\n         },\n         Err(_) => (file_path.to_string(), None),\n     };"
        },
        {
            "sha": "1e65298c3da63f765384e905f7b7b110d88d3ac1",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/b0641f12e9fefb7e75049c6ab9477ce2d211e471/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/b0641f12e9fefb7e75049c6ab9477ce2d211e471/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=b0641f12e9fefb7e75049c6ab9477ce2d211e471",
            "patch": "@@ -716,5 +716,6 @@\n   \"715\": \"Server Action \\\"%s\\\" was not found on the server. \\\\nRead more: https://nextjs.org/docs/messages/failed-to-find-server-action\",\n   \"716\": \"NEXT_DEVTOOLS_SIMULATED_ERROR\",\n   \"717\": \"Unsupported environment condition \\\"%s\\\" and react condition \\\"%s\\\". This is a bug in Next.js.\",\n-  \"718\": \"Invariant: projectDir is required for node runtime\"\n+  \"718\": \"Invariant: projectDir is required for node runtime\",\n+  \"719\": \"Failed to get source map for '%s'. This is a bug in Next.js\"\n }"
        },
        {
            "sha": "a510ee10197c2a063031c2696e62840162b82563",
            "filename": "packages/next/src/server/dev/middleware-turbopack.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 8,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/b0641f12e9fefb7e75049c6ab9477ce2d211e471/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b0641f12e9fefb7e75049c6ab9477ce2d211e471/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts?ref=b0641f12e9fefb7e75049c6ab9477ce2d211e471",
            "patch": "@@ -7,7 +7,6 @@ import {\n } from '../../next-devtools/server/shared'\n import { middlewareResponse } from '../../next-devtools/server/middleware-response'\n import path from 'path'\n-import url from 'url'\n import { openFileInEditor } from '../../next-devtools/server/launch-editor'\n import type { StackFrame } from 'next/dist/compiled/stacktrace-parser'\n import {\n@@ -21,7 +20,7 @@ import {\n } from '../lib/source-maps'\n import { getSourceMapFromFile } from './get-source-map-from-file'\n import { findSourceMap } from 'node:module'\n-import { pathToFileURL } from 'node:url'\n+import { fileURLToPath, pathToFileURL } from 'node:url'\n import { inspect } from 'node:util'\n \n function shouldIgnorePath(modulePath: string): boolean {\n@@ -302,7 +301,7 @@ async function createOriginalStackFrame(\n   ) {\n     normalizedStackFrameLocation = path.relative(\n       projectPath,\n-      url.fileURLToPath(normalizedStackFrameLocation)\n+      fileURLToPath(normalizedStackFrameLocation)\n     )\n   }\n \n@@ -432,11 +431,15 @@ export function getSourceMapMiddleware(project: Project) {\n     try {\n       // Turbopack chunk filenames might be URL-encoded.\n       filename = decodeURI(filename)\n+    } catch {\n+      return middlewareResponse.badRequest(res)\n+    }\n \n-      if (path.isAbsolute(filename)) {\n-        filename = url.pathToFileURL(filename).href\n-      }\n+    if (path.isAbsolute(filename)) {\n+      filename = pathToFileURL(filename).href\n+    }\n \n+    try {\n       const sourceMapString = await project.getSourceMap(filename)\n \n       if (sourceMapString) {\n@@ -450,8 +453,16 @@ export function getSourceMapMiddleware(project: Project) {\n           return middlewareResponse.json(res, sourceMap)\n         }\n       }\n-    } catch (error) {\n-      console.error('Failed to get source map:', error)\n+    } catch (cause) {\n+      return middlewareResponse.internalServerError(\n+        res,\n+        new Error(\n+          `Failed to get source map for '${filename}'. This is a bug in Next.js`,\n+          {\n+            cause,\n+          }\n+        )\n+      )\n     }\n \n     middlewareResponse.noContent(res)"
        }
    ],
    "stats": {
        "total": 32,
        "additions": 22,
        "deletions": 10
    }
}