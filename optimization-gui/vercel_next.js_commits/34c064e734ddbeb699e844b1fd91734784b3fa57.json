{
    "author": "bgw",
    "message": "fix(test/integration): Check the right thing when resetting the server-side-dev-errors tests (#80873)\n\nThis was asserting that the error still exists after resetting the file back to its original state.\n\nInstead, it should refresh the browser and check that the error was fixed.\n\nSomething was causing this to quickly reload in the rspack case, so the test was flaking there.\n\n```\npnpm test-dev integration/server-side-dev-errors/test/index.test.js -t 'api route correctly'\npnpm test-dev-turbopack integration/server-side-dev-errors/test/index.test.js -t 'api route correctly'\npnpm test-dev-rspack integration/server-side-dev-errors/test/index.test.js -t 'api route correctly'\n```\n\nTry running the tests a few times, see that they don't flake.",
    "sha": "34c064e734ddbeb699e844b1fd91734784b3fa57",
    "files": [
        {
            "sha": "eef11f4622591609c77ba2818ba4750ab726d43c",
            "filename": "test/integration/server-side-dev-errors/test/index.test.js",
            "status": "modified",
            "additions": 14,
            "deletions": 30,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/34c064e734ddbeb699e844b1fd91734784b3fa57/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/34c064e734ddbeb699e844b1fd91734784b3fa57/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fserver-side-dev-errors%2Ftest%2Findex.test.js?ref=34c064e734ddbeb699e844b1fd91734784b3fa57",
            "patch": "@@ -4,11 +4,11 @@ import fs from 'fs/promises'\n import { join } from 'path'\n import webdriver from 'next-webdriver'\n import {\n-  killApp,\n+  assertNoRedbox,\n   findPort,\n+  killApp,\n   launchApp,\n   retry,\n-  assertNoRedbox,\n } from 'next-test-utils'\n import stripAnsi from 'strip-ansi'\n \n@@ -260,21 +260,13 @@ describe('server-side dev errors', () => {\n         }\n       `)\n \n-      await fs.writeFile(apiPage, content)\n+      await fs.writeFile(apiPage, content, { flush: true })\n \n-      await expect(browser).toDisplayRedbox(`\n-        {\n-          \"description\": \"missingVar is not defined\",\n-          \"environmentLabel\": null,\n-          \"label\": \"Runtime ReferenceError\",\n-          \"source\": \"pages/api/hello.js (2:3) @ handler\n-        > 2 |   missingVar;res.status(200).json({ hello: 'world' })\n-            |   ^\",\n-          \"stack\": [\n-            \"handler pages/api/hello.js (2:3)\",\n-          ],\n-        }\n-      `)\n+      await retry(async () => {\n+        // manually refresh as this is an API route\n+        await browser.refresh()\n+        await assertNoRedbox(browser)\n+      })\n     } finally {\n       await fs.writeFile(apiPage, content)\n     }\n@@ -334,21 +326,13 @@ describe('server-side dev errors', () => {\n         }\n       `)\n \n-      await fs.writeFile(dynamicApiPage, content)\n+      await fs.writeFile(dynamicApiPage, content, { flush: true })\n \n-      await expect(browser).toDisplayRedbox(`\n-        {\n-          \"description\": \"missingVar is not defined\",\n-          \"environmentLabel\": null,\n-          \"label\": \"Runtime ReferenceError\",\n-          \"source\": \"pages/api/blog/[slug].js (2:3) @ handler\n-        > 2 |   missingVar;res.status(200).json({ slug: req.query.slug })\n-            |   ^\",\n-          \"stack\": [\n-            \"handler pages/api/blog/[slug].js (2:3)\",\n-          ],\n-        }\n-      `)\n+      await retry(async () => {\n+        // manually refresh as this is an API route\n+        await browser.refresh()\n+        await assertNoRedbox(browser)\n+      })\n     } finally {\n       await fs.writeFile(dynamicApiPage, content)\n     }"
        }
    ],
    "stats": {
        "total": 44,
        "additions": 14,
        "deletions": 30
    }
}