{
    "author": "devjiwonchoi",
    "message": "Improve Proxy invalid export error message (#84887)\n\nImprove invalid Proxy/Middleware export error message to:\r\n\r\n```\r\n> Build error occurred\r\nError: The file \"./proxy.ts\" must export a function, either as a default export or as a named \"proxy\" export.\r\nThis function is what Next.js runs for every request handled by this proxy (previously called middleware).\r\n\r\nWhy this happens:\r\n- You are migrating from `middleware` to `proxy`, but haven't updated the exported function.\r\n- The file exists but doesn't export a function.\r\n- The export is not a function (e.g., an object or constant).\r\n- There's a syntax error preventing the export from being recognized.\r\n\r\nTo fix it:\r\n- Ensure this file has either a default or \"proxy\" function export.\r\n\r\nLearn more: https://nextjs.org/docs/messages/middleware-to-proxy\r\n```\r\n\r\nTurbopack:\r\n```\r\nError: Turbopack build failed with 1 errors:\r\n./proxy.ts\r\nProxy is missing expected function export name\r\nThis function is what Next.js runs for every request handled by this proxy (previously called middleware).\r\n\r\nWhy this happens:\r\n- You are migrating from `middleware` to `proxy`, but haven't updated the exported function.\r\n- The file exists but doesn't export a function.\r\n- The export is not a function (e.g., an object or constant).\r\n- There's a syntax error preventing the export from being recognized.\r\n\r\nTo fix it:\r\n- Ensure this file has either a default or \"proxy\" function export.\r\n\r\nLearn more: https://nextjs.org/docs/messages/middleware-to-proxy\r\n```\r\n\r\nCloses NEXT-4741",
    "sha": "409b28106e3724fc66e4d4eef54770fe5994e239",
    "files": [
        {
            "sha": "efa500f3d8c072def8ba88b444028b72a4e371a5",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/409b28106e3724fc66e4d4eef54770fe5994e239/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/409b28106e3724fc66e4d4eef54770fe5994e239/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=409b28106e3724fc66e4d4eef54770fe5994e239",
            "patch": "@@ -4322,6 +4322,7 @@ dependencies = [\n  \"next-custom-transforms\",\n  \"next-taskless\",\n  \"once_cell\",\n+ \"pathdiff\",\n  \"percent-encoding\",\n  \"qstring\",\n  \"react_remove_properties\","
        },
        {
            "sha": "56845fd72accf2697529e790e0d55bea4456524f",
            "filename": "crates/next-core/src/middleware.rs",
            "status": "modified",
            "additions": 40,
            "deletions": 15,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/409b28106e3724fc66e4d4eef54770fe5994e239/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/409b28106e3724fc66e4d4eef54770fe5994e239/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs?ref=409b28106e3724fc66e4d4eef54770fe5994e239",
            "patch": "@@ -139,23 +139,48 @@ impl Issue for MiddlewareMissingExportIssue {\n     }\n \n     #[turbo_tasks::function]\n-    fn title(&self) -> Vc<StyledString> {\n-        let file_name = self.file_path.file_name();\n-\n-        StyledString::Line(vec![\n-            StyledString::Text(rcstr!(\"The \")),\n-            StyledString::Code(self.file_type.clone()),\n-            StyledString::Text(rcstr!(\" file \\\"\")),\n-            StyledString::Code(format!(\"./{}\", file_name).into()),\n-            StyledString::Text(rcstr!(\"\\\" must export a function named \")),\n-            StyledString::Code(format!(\"`{}`\", self.function_name).into()),\n-            StyledString::Text(rcstr!(\" or a default function.\")),\n-        ])\n-        .cell()\n+    async fn title(&self) -> Result<Vc<StyledString>> {\n+        let title_text = format!(\n+            \"{} is missing expected function export name\",\n+            self.file_type\n+        );\n+\n+        Ok(StyledString::Text(title_text.into()).cell())\n     }\n \n     #[turbo_tasks::function]\n-    fn description(&self) -> Vc<OptionStyledString> {\n-        Vc::cell(None)\n+    async fn description(&self) -> Result<Vc<OptionStyledString>> {\n+        let type_description = if self.file_type == \"Proxy\" {\n+            \"proxy (previously called middleware)\"\n+        } else {\n+            \"middleware\"\n+        };\n+\n+        let migration_bullet = if self.file_type == \"Proxy\" {\n+            \"- You are migrating from `middleware` to `proxy`, but haven't updated the exported \\\n+             function.\\n\"\n+        } else {\n+            \"\"\n+        };\n+\n+        // Rest of the message goes in description to avoid formatIssue indentation\n+        let description_text = format!(\n+            \"This function is what Next.js runs for every request handled by this {}.\\n\\n\\\n+             Why this happens:\\n\\\n+             {}\\\n+             - The file exists but doesn't export a function.\\n\\\n+             - The export is not a function (e.g., an object or constant).\\n\\\n+             - There's a syntax error preventing the export from being recognized.\\n\\n\\\n+             To fix it:\\n\\\n+             - Ensure this file has either a default or \\\"{}\\\" function export.\\n\\n\\\n+             Learn more: https://nextjs.org/docs/messages/middleware-to-proxy\",\n+            type_description,\n+            migration_bullet,\n+            self.function_name\n+        );\n+\n+        Ok(Vc::cell(Some(\n+            StyledString::Text(description_text.into()).resolved_cell(),\n+        )))\n     }\n }"
        },
        {
            "sha": "cbe2d5256c427d1ab314320c7ad8fc680f0ec479",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/409b28106e3724fc66e4d4eef54770fe5994e239/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/409b28106e3724fc66e4d4eef54770fe5994e239/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=409b28106e3724fc66e4d4eef54770fe5994e239",
            "patch": "@@ -900,5 +900,6 @@\n   \"899\": \"Both \\\"%s\\\" and \\\"%s\\\" files are detected. Please use \\\"%s\\\" instead. Learn more: https://nextjs.org/docs/messages/middleware-to-proxy\",\n   \"900\": \"Both %s file \\\"./%s\\\" and %s file \\\"./%s\\\" are detected. Please use \\\"./%s\\\" only. Learn more: https://nextjs.org/docs/messages/middleware-to-proxy\",\n   \"901\": \"Invalid \\\"cacheHandlers\\\" provided, expected an object e.g. { default: '/my-handler.js' }, received %s\",\n-  \"902\": \"Invalid handler fields configured for \\\"cacheHandlers\\\":\\\\n%s\"\n+  \"902\": \"Invalid handler fields configured for \\\"cacheHandlers\\\":\\\\n%s\",\n+  \"903\": \"The file \\\"%s\\\" must export a function, either as a default export or as a named \\\"%s\\\" export.\\\\nThis function is what Next.js runs for every request handled by this %s.\\\\n\\\\nWhy this happens:\\\\n%s- The file exists but doesn't export a function.\\\\n- The export is not a function (e.g., an object or constant).\\\\n- There's a syntax error preventing the export from being recognized.\\\\n\\\\nTo fix it:\\\\n- Ensure this file has either a default or \\\"%s\\\" function export.\\\\n\\\\nLearn more: https://nextjs.org/docs/messages/middleware-to-proxy\"\n }"
        },
        {
            "sha": "01314d1449e2e3dace1bd24d84beff396ce8ed83",
            "filename": "packages/next/src/build/analysis/get-page-static-info.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 3,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/409b28106e3724fc66e4d4eef54770fe5994e239/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/409b28106e3724fc66e4d4eef54770fe5994e239/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fanalysis%2Fget-page-static-info.ts?ref=409b28106e3724fc66e4d4eef54770fe5994e239",
            "patch": "@@ -2,7 +2,7 @@ import type { NextConfig } from '../../server/config-shared'\n import type { RouteHas } from '../../lib/load-custom-routes'\n \n import { promises as fs } from 'fs'\n-import { basename } from 'path'\n+import { relative } from 'path'\n import { LRUCache } from '../../server/lib/lru-cache'\n import {\n   extractExportedConstValue,\n@@ -329,7 +329,7 @@ function validateMiddlewareProxyExports({\n     return\n   }\n \n-  const fileName = isProxy ? 'proxy' : 'middleware'\n+  const fileName = isProxy ? PROXY_FILENAME : MIDDLEWARE_FILENAME\n \n   // Parse AST to get export info (since checkExports doesn't return middleware/proxy info)\n   let hasDefaultExport = false\n@@ -396,9 +396,22 @@ function validateMiddlewareProxyExports({\n     (isMiddleware && hasMiddlewareExport) ||\n     (isProxy && hasProxyExport)\n \n+  const relativeFilePath = `./${relative(process.cwd(), pageFilePath)}`\n+\n   if (!hasValidExport) {\n     throw new Error(\n-      `The ${fileName === 'proxy' ? 'Proxy' : 'Middleware'} file \"./${basename(pageFilePath)}\" must export a function named \\`${fileName}\\` or a default function.`\n+      `The file \"${relativeFilePath}\" must export a function, either as a default export or as a named \"${fileName}\" export.\\n` +\n+        `This function is what Next.js runs for every request handled by this ${fileName === 'proxy' ? 'proxy (previously called middleware)' : 'middleware'}.\\n\\n` +\n+        `Why this happens:\\n` +\n+        (isProxy\n+          ? \"- You are migrating from `middleware` to `proxy`, but haven't updated the exported function.\\n\"\n+          : '') +\n+        `- The file exists but doesn't export a function.\\n` +\n+        `- The export is not a function (e.g., an object or constant).\\n` +\n+        `- There's a syntax error preventing the export from being recognized.\\n\\n` +\n+        `To fix it:\\n` +\n+        `- Ensure this file has either a default or \"${fileName}\" function export.\\n\\n` +\n+        `Learn more: https://nextjs.org/docs/messages/middleware-to-proxy`\n     )\n   }\n }"
        },
        {
            "sha": "2637bd64dffaabb183baafb88bb4cbdfa16d112d",
            "filename": "packages/next/src/build/templates/middleware.ts",
            "status": "modified",
            "additions": 18,
            "deletions": 1,
            "changes": 19,
            "blob_url": "https://github.com/vercel/next.js/blob/409b28106e3724fc66e4d4eef54770fe5994e239/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/409b28106e3724fc66e4d4eef54770fe5994e239/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts?ref=409b28106e3724fc66e4d4eef54770fe5994e239",
            "patch": "@@ -19,8 +19,25 @@ const isProxy = page === '/proxy' || page === '/src/proxy'\n const handler = (isProxy ? mod.proxy : mod.middleware) || mod.default\n \n if (typeof handler !== 'function') {\n+  const fileName = isProxy ? 'proxy' : 'middleware'\n+  // Webpack starts the path with \".\" as relative, but Turbopack does not.\n+  const resolvedRelativeFilePath = relativeFilePath.startsWith('.')\n+    ? relativeFilePath\n+    : `./${relativeFilePath}`\n+\n   throw new Error(\n-    `The ${isProxy ? 'Proxy' : 'Middleware'} file \"${relativeFilePath.startsWith('.') ? relativeFilePath : `./${relativeFilePath}`}\" must export a function named \\`${isProxy ? 'proxy' : 'middleware'}\\` or a default function.`\n+    `The file \"${resolvedRelativeFilePath}\" must export a function, either as a default export or as a named \"${fileName}\" export.\\n` +\n+      `This function is what Next.js runs for every request handled by this ${fileName === 'proxy' ? 'proxy (previously called middleware)' : 'middleware'}.\\n\\n` +\n+      `Why this happens:\\n` +\n+      (isProxy\n+        ? \"- You are migrating from `middleware` to `proxy`, but haven't updated the exported function.\\n\"\n+        : '') +\n+      `- The file exists but doesn't export a function.\\n` +\n+      `- The export is not a function (e.g., an object or constant).\\n` +\n+      `- There's a syntax error preventing the export from being recognized.\\n\\n` +\n+      `To fix it:\\n` +\n+      `- Ensure this file has either a default or \"${fileName}\" function export.\\n\\n` +\n+      `Learn more: https://nextjs.org/docs/messages/middleware-to-proxy`\n   )\n }\n "
        },
        {
            "sha": "92faf1c94e5b2249fb9a57937695144b4180570d",
            "filename": "test/e2e/app-dir/proxy-missing-export/proxy-missing-export.test.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 8,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/409b28106e3724fc66e4d4eef54770fe5994e239/test%2Fe2e%2Fapp-dir%2Fproxy-missing-export%2Fproxy-missing-export.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/409b28106e3724fc66e4d4eef54770fe5994e239/test%2Fe2e%2Fapp-dir%2Fproxy-missing-export%2Fproxy-missing-export.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fproxy-missing-export%2Fproxy-missing-export.test.ts?ref=409b28106e3724fc66e4d4eef54770fe5994e239",
            "patch": "@@ -2,8 +2,18 @@ import { nextTestSetup } from 'e2e-utils'\n import { join } from 'node:path'\n import { writeFile } from 'node:fs/promises'\n \n-const errorMessage =\n-  'The Proxy file \"./proxy.ts\" must export a function named `proxy` or a default function.'\n+const errorMessage = `This function is what Next.js runs for every request handled by this proxy (previously called middleware).\n+\n+Why this happens:\n+- You are migrating from \\`middleware\\` to \\`proxy\\`, but haven't updated the exported function.\n+- The file exists but doesn't export a function.\n+- The export is not a function (e.g., an object or constant).\n+- There's a syntax error preventing the export from being recognized.\n+\n+To fix it:\n+- Ensure this file has either a default or \"proxy\" function export.\n+\n+Learn more: https://nextjs.org/docs/messages/middleware-to-proxy`\n \n describe('proxy-missing-export', () => {\n   const { next, isNextDev, skipped } = nextTestSetup({\n@@ -22,14 +32,26 @@ describe('proxy-missing-export', () => {\n       'export function middleware() {}'\n     )\n \n+    let cliOutput: string\n+\n     if (isNextDev) {\n       await next.start().catch(() => {})\n       // Use .catch() because Turbopack errors during compile and exits before runtime.\n       await next.browser('/').catch(() => {})\n-      expect(next.cliOutput).toContain(errorMessage)\n+      cliOutput = next.cliOutput\n+    } else {\n+      cliOutput = (await next.build()).cliOutput\n+    }\n+\n+    // TODO: Investigate why in dev-turbo, the error is shown in the browser console, not CLI output.\n+    if (process.env.IS_TURBOPACK_TEST && !isNextDev) {\n+      expect(cliOutput).toContain(`./proxy.ts\n+Proxy is missing expected function export name\n+${errorMessage}`)\n     } else {\n-      const { cliOutput } = await next.build()\n-      expect(cliOutput).toContain(errorMessage)\n+      expect(cliOutput)\n+        .toContain(`The file \"./proxy.ts\" must export a function, either as a default export or as a named \"proxy\" export.\n+${errorMessage}`)\n     }\n \n     await next.stop()\n@@ -94,16 +116,27 @@ describe('proxy-missing-export', () => {\n       'const proxy = () => {}; export { proxy as handler };'\n     )\n \n+    let cliOutput: string\n+\n     if (isNextDev) {\n       await next.start().catch(() => {})\n       // Use .catch() because Turbopack errors during compile and exits before runtime.\n       await next.browser('/').catch(() => {})\n-      expect(next.cliOutput).toContain(errorMessage)\n+      cliOutput = next.cliOutput\n     } else {\n-      const { cliOutput } = await next.build()\n-      expect(cliOutput).toContain(errorMessage)\n+      cliOutput = (await next.build()).cliOutput\n     }\n \n+    // TODO: Investigate why in dev-turbo, the error is shown in the browser console, not CLI output.\n+    if (process.env.IS_TURBOPACK_TEST && !isNextDev) {\n+      expect(cliOutput).toContain(`./proxy.ts\n+Proxy is missing expected function export name\n+${errorMessage}`)\n+    } else {\n+      expect(cliOutput)\n+        .toContain(`The file \"./proxy.ts\" must export a function, either as a default export or as a named \"proxy\" export.\n+${errorMessage}`)\n+    }\n     await next.stop()\n   })\n })"
        }
    ],
    "stats": {
        "total": 146,
        "additions": 118,
        "deletions": 28
    }
}