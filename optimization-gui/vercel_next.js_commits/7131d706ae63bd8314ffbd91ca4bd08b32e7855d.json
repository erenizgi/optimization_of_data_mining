{
    "author": "mischnic",
    "message": "Fix flakey devtools test (#81127)\n\nA regression from #81085 @huozhi \n\n\nThe problem is that `openDevToolsIndicatorPopover` doesn't tell anymore whether the popup menu is open, but if the panel is open, but the \"Try Turbopack\" text is in the popup menu (only in the old UI).",
    "sha": "7131d706ae63bd8314ffbd91ca4bd08b32e7855d",
    "files": [
        {
            "sha": "428ab08aede6f0a6bc71009cff22252b4fbdb488",
            "filename": "test/development/client-dev-overlay/index.test.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 3,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/7131d706ae63bd8314ffbd91ca4bd08b32e7855d/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7131d706ae63bd8314ffbd91ca4bd08b32e7855d/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fclient-dev-overlay%2Findex.test.ts?ref=7131d706ae63bd8314ffbd91ca4bd08b32e7855d",
            "patch": "@@ -2,12 +2,12 @@ import { FileRef } from 'e2e-utils'\n import { Playwright } from 'next-webdriver'\n import { nextTestSetup } from 'e2e-utils'\n import { join } from 'path'\n-import { openDevToolsIndicatorPopover, retry } from 'next-test-utils'\n+import { assertHasDevToolsIndicator, retry } from 'next-test-utils'\n \n describe('client-dev-overlay', () => {\n   const { next, isTurbopack } = nextTestSetup({\n     files: {\n-      pages: new FileRef(join(__dirname, 'app/pages')),\n+      pages: new FileRef(join(__dirname, 'pages')),\n     },\n     env: {\n       // Disable the cooldown period for the dev indicator so that hiding the indicator in a test doesn't\n@@ -124,7 +124,14 @@ describe('client-dev-overlay', () => {\n   it('should nudge to use Turbopack unless Turbopack is disabled', async () => {\n     const browser = await next.browser('/')\n \n-    await openDevToolsIndicatorPopover(browser)\n+    // Don't use openDevToolsIndicatorPopover because this is asserting something in the old dev tools menu which isn't preset yet in the new UI.\n+    const devToolsIndicator = await assertHasDevToolsIndicator(browser)\n+    try {\n+      await devToolsIndicator.click()\n+    } catch (cause) {\n+      const error = new Error('No DevTools Indicator to open.', { cause })\n+      throw error\n+    }\n \n     const devtoolsMenu = await browser.elementByCss('#nextjs-dev-tools-menu')\n     if (isTurbopack) {"
        },
        {
            "sha": "95d1ec6405a3c11bbc05a2dce57f2d42c4ef77b4",
            "filename": "test/development/client-dev-overlay/pages/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/7131d706ae63bd8314ffbd91ca4bd08b32e7855d/test%2Fdevelopment%2Fclient-dev-overlay%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7131d706ae63bd8314ffbd91ca4bd08b32e7855d/test%2Fdevelopment%2Fclient-dev-overlay%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fclient-dev-overlay%2Fpages%2Findex.js?ref=7131d706ae63bd8314ffbd91ca4bd08b32e7855d",
            "previous_filename": "test/development/client-dev-overlay/app/pages/index.js"
        },
        {
            "sha": "8871f6d96485041804cb77d23847bd0e331c39f8",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 6,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/7131d706ae63bd8314ffbd91ca4bd08b32e7855d/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7131d706ae63bd8314ffbd91ca4bd08b32e7855d/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=7131d706ae63bd8314ffbd91ca4bd08b32e7855d",
            "patch": "@@ -969,12 +969,10 @@ export async function openDevToolsIndicatorPopover(\n \n export async function hasDevToolsPanel(browser: Playwright) {\n   const result = await browser.eval(() => {\n-    const portal = [].slice\n-      .call(document.querySelectorAll('nextjs-portal'))\n-      .find((p) => p.shadowRoot.querySelector('[data-nextjs-dialog-overlay]'))\n-\n-    const root = portal?.shadowRoot\n-    return root?.querySelector('[data-nextjs-dialog-overlay]') != null\n+    const portal = document.querySelector('nextjs-portal')\n+    return (\n+      portal?.shadowRoot?.querySelector('[data-nextjs-dialog-overlay]') != null\n+    )\n   })\n   return result\n }"
        }
    ],
    "stats": {
        "total": 23,
        "additions": 14,
        "deletions": 9
    }
}