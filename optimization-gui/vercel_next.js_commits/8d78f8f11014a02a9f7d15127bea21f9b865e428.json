{
    "author": "wyattjoh",
    "message": "feat(test): add proxy support for e2e deployment tests (#83118)\n\n### What?\n\nAdds proxy configuration support for e2e deployment tests, allowing test\ntraffic to be routed through a specified proxy server.\n\n### Why?\n\nSome testing environments require network traffic to be routed through\nspecific proxy servers or load balancers. This change enables the e2e\ndeployment test infrastructure to support such configurations by:\n\n- Allowing specification of a proxy IP address via the\n`NEXT_TEST_PROXY_ADDRESS` environment variable\n- Automatically managing `/etc/hosts` entries to route deployment\ndomains through the proxy\n- Providing proper cleanup when tests complete",
    "sha": "8d78f8f11014a02a9f7d15127bea21f9b865e428",
    "files": [
        {
            "sha": "2160149054d6ca91d858c46d21e5dc741a97648e",
            "filename": ".github/workflows/build_reusable.yml",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/8d78f8f11014a02a9f7d15127bea21f9b865e428/.github%2Fworkflows%2Fbuild_reusable.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/8d78f8f11014a02a9f7d15127bea21f9b865e428/.github%2Fworkflows%2Fbuild_reusable.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_reusable.yml?ref=8d78f8f11014a02a9f7d15127bea21f9b865e428",
            "patch": "@@ -74,6 +74,11 @@ on:\n         required: false\n         type: string\n         default: 'x86_64-unknown-linux-gnu'\n+      overrideProxyAddress:\n+        description: Override the proxy address to use for the test\n+        required: false\n+        type: string\n+        default: ''\n \n env:\n   NAPI_CLI_VERSION: 2.18.4\n@@ -101,6 +106,7 @@ env:\n   VERCEL_TEST_TEAM: vtest314-next-e2e-tests\n   NEXT_TEST_PREFER_OFFLINE: 1\n   NEXT_CI_RUNNER: ${{ inputs.runs_on_labels }}\n+  NEXT_TEST_PROXY_ADDRESS: ${{ inputs.overrideProxyAddress || '' }}\n \n jobs:\n   build:"
        },
        {
            "sha": "631b0a2b43f462c9536801288b3c3005d21c050e",
            "filename": ".github/workflows/test_e2e_deploy_release.yml",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8d78f8f11014a02a9f7d15127bea21f9b865e428/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/8d78f8f11014a02a9f7d15127bea21f9b865e428/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Ftest_e2e_deploy_release.yml?ref=8d78f8f11014a02a9f7d15127bea21f9b865e428",
            "patch": "@@ -15,6 +15,10 @@ on:\n         description: Version of Vercel CLI to use\n         default: 'vercel@latest'\n         type: string\n+      overrideProxyAddress:\n+        description: Override the proxy address to use for the test\n+        default: ''\n+        type: string\n \n env:\n   VERCEL_TEST_TEAM: vtest314-next-e2e-tests\n@@ -80,6 +84,7 @@ jobs:\n       stepName: 'test-deploy-${{ matrix.group }}'\n       timeout_minutes: 180\n       runs_on_labels: '[\"ubuntu-latest\"]'\n+      overrideProxyAddress: ${{ inputs.overrideProxyAddress || '' }}\n \n   report-test-results-to-datadog:\n     needs: test-deploy"
        },
        {
            "sha": "f2622901661cabaf5d4a6d926783180c0863839e",
            "filename": "test/lib/next-modes/next-deploy.ts",
            "status": "modified",
            "additions": 61,
            "deletions": 0,
            "changes": 61,
            "blob_url": "https://github.com/vercel/next.js/blob/8d78f8f11014a02a9f7d15127bea21f9b865e428/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8d78f8f11014a02a9f7d15127bea21f9b865e428/test%2Flib%2Fnext-modes%2Fnext-deploy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-modes%2Fnext-deploy.ts?ref=8d78f8f11014a02a9f7d15127bea21f9b865e428",
            "patch": "@@ -14,6 +14,7 @@ import { Span } from 'next/dist/trace'\n export class NextDeployInstance extends NextInstance {\n   private _cliOutput: string\n   private _buildId: string\n+  private _writtenHostsLine: string | null = null\n \n   public get buildId() {\n     // get deployment ID via fetch since we can't access\n@@ -127,10 +128,41 @@ export class NextDeployInstance extends NextInstance {\n         `Failed to deploy project ${deployRes.stdout} ${deployRes.stderr} (${deployRes.exitCode})`\n       )\n     }\n+\n     // the CLI gives just the deployment URL back when not a TTY\n     this._url = deployRes.stdout\n     this._parsedUrl = new URL(this._url)\n \n+    // If configured, we should configure the `/etc/hosts` file to point the\n+    // deployment domain to the specified proxy address.\n+    if (\n+      process.env.NEXT_TEST_PROXY_ADDRESS &&\n+      // Validate that the proxy address is a valid IP address.\n+      /^\\d+\\.\\d+\\.\\d+\\.\\d+$/.test(process.env.NEXT_TEST_PROXY_ADDRESS)\n+    ) {\n+      this._writtenHostsLine = `${process.env.NEXT_TEST_PROXY_ADDRESS}\\t${this._parsedUrl.hostname}\\n`\n+\n+      require('console').log(\n+        `Writing proxy address to hosts file: ${this._writtenHostsLine.trim()}`\n+      )\n+\n+      // Using a child process, we'll use sudo to tee the hosts file to add the\n+      // proxy address to the target domain.\n+      await execa('sudo', ['tee', '-a', '/etc/hosts'], {\n+        input: this._writtenHostsLine,\n+        stdout: 'inherit',\n+        shell: true,\n+      })\n+\n+      // Verify that the proxy address was written to the hosts file.\n+      const hostsFile = await fs.readFile('/etc/hosts', 'utf8')\n+      if (!hostsFile.includes(this._writtenHostsLine)) {\n+        throw new Error('Proxy address not found in hosts file after writing')\n+      }\n+\n+      require('console').log(`Proxy address written to hosts file`)\n+    }\n+\n     require('console').log(`Deployment URL: ${this._url}`)\n     const buildIdUrl = `${this._url}${\n       this.basePath || ''\n@@ -168,6 +200,35 @@ export class NextDeployInstance extends NextInstance {\n     this._cliOutput = buildLogs.stdout + buildLogs.stderr\n   }\n \n+  public async destroy() {\n+    // If configured, we should remove the proxy address from the hosts file.\n+    if (this._writtenHostsLine) {\n+      const trimmed = this._writtenHostsLine.trim()\n+\n+      require('console').log(\n+        `Removing proxy address from hosts file: ${this._writtenHostsLine.trim()}`\n+      )\n+\n+      const hostsFile = await fs.readFile('/etc/hosts', 'utf8')\n+\n+      const cleanedHostsFile = hostsFile\n+        .split('\\n')\n+        .filter((line) => line.trim() !== trimmed)\n+        .join('\\n')\n+\n+      await execa('sudo', ['tee', '/etc/hosts'], {\n+        input: cleanedHostsFile,\n+        stdout: 'inherit',\n+        shell: true,\n+      })\n+\n+      require('console').log(`Removed proxy address from hosts file`)\n+    }\n+\n+    // Run the super destroy to clean up the test directory.\n+    return super.destroy()\n+  }\n+\n   public get cliOutput() {\n     return this._cliOutput || ''\n   }"
        }
    ],
    "stats": {
        "total": 72,
        "additions": 72,
        "deletions": 0
    }
}