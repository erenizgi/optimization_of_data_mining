{
    "author": "eps1lon",
    "message": "[strict-route-types] Switch to `satisfies` when validating page and route modules (#87398)\n\nReverts https://github.com/vercel/next.js/pull/83239 flagged behind `experimental.strictRouteTypes`.\r\n\r\nMakes the error messages a bit friendlier since we no longer need these `__*` helper types which made it harder to grok what we were actually doing.\r\n\r\n`satisfies` is available since TypeScript 4.9. Our lowest supported version is 5.1. We could land this unflagged but this just makes it clearer that all the type changes are behind a single flag instead of being spread across flagged and unflagged.\r\n\r\nCloses https://linear.app/vercel/issue/NXT-128",
    "sha": "502a3d1f9648a276fce797c2940895129cb35ea7",
    "files": [
        {
            "sha": "413db2cc83005931d8e21a9775ba0bb9ed150c4b",
            "filename": "packages/next/src/server/lib/router-utils/typegen.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/502a3d1f9648a276fce797c2940895129cb35ea7/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/502a3d1f9648a276fce797c2940895129cb35ea7/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Ftypegen.ts?ref=502a3d1f9648a276fce797c2940895129cb35ea7",
            "patch": "@@ -688,18 +688,12 @@ export function generateValidatorFileStrict(\n             ? `${type}<${JSON.stringify(route)}>`\n             : type\n \n-        // NOTE: we previously used `satisfies` here, but it's not supported by TypeScript 4.8 and below.\n-        // If we ever raise the TS minimum version, we can switch back.\n-\n         return `// Validate ${filePath}\n {\n-  type __IsExpected<Specific extends ${typeWithRoute}> = Specific\n   const handler = {} as typeof import(${JSON.stringify(\n     importPath.replace(/\\.tsx?$/, '.js')\n   )})\n-  type __Check = __IsExpected<typeof handler>\n-  // @ts-ignore\n-  type __Unused = __Check\n+  handler satisfies ${typeWithRoute}\n }`\n       })\n       .join('\\n\\n')"
        },
        {
            "sha": "57e23c9d71fdf614371fd161c8e6ba08b9f92d51",
            "filename": "test/e2e/app-dir/typed-routes-validator/typed-routes-validator.test.ts",
            "status": "modified",
            "additions": 57,
            "deletions": 18,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/502a3d1f9648a276fce797c2940895129cb35ea7/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/502a3d1f9648a276fce797c2940895129cb35ea7/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Ftyped-routes-validator%2Ftyped-routes-validator.test.ts?ref=502a3d1f9648a276fce797c2940895129cb35ea7",
            "patch": "@@ -1,6 +1,9 @@\n import { nextTestSetup } from 'e2e-utils'\n import { getDistDir } from 'next-test-utils'\n \n+const strictRouteTypes =\n+  process.env.__NEXT_EXPERIMENTAL_STRICT_ROUTE_TYPES === 'true'\n+\n describe('typed-routes-validator', () => {\n   const { next, isNextDev, isNextStart, skipped } = nextTestSetup({\n     files: __dirname,\n@@ -55,9 +58,15 @@ describe('typed-routes-validator', () => {\n       await next.deleteFile('app/invalid/page.tsx')\n \n       expect(exitCode).toBe(1)\n-      expect(cliOutput).toMatch(\n-        /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'AppPageConfig</\n-      )\n+      if (strictRouteTypes) {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the expected type 'AppPageConfig</\n+        )\n+      } else {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'AppPageConfig</\n+        )\n+      }\n     })\n \n     it('should pass type checking with valid page props', async () => {\n@@ -92,9 +101,15 @@ describe('typed-routes-validator', () => {\n       await next.deleteFile('app/invalid/page.tsx')\n \n       expect(exitCode).toBe(1)\n-      expect(cliOutput).toMatch(\n-        /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'AppPageConfig</\n-      )\n+      if (strictRouteTypes) {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the expected type 'AppPageConfig</\n+        )\n+      } else {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'AppPageConfig</\n+        )\n+      }\n     })\n \n     it('should pass type checking with valid route handler exports', async () => {\n@@ -150,9 +165,15 @@ describe('typed-routes-validator', () => {\n       await next.deleteFile('app/invalid/route.ts')\n \n       expect(exitCode).toBe(1)\n-      expect(cliOutput).toMatch(\n-        /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'RouteHandlerConfig</\n-      )\n+      if (strictRouteTypes) {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the expected type 'RouteHandlerConfig</\n+        )\n+      } else {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'RouteHandlerConfig</\n+        )\n+      }\n     })\n \n     it('should fail type checking with invalid route handler params', async () => {\n@@ -171,9 +192,15 @@ describe('typed-routes-validator', () => {\n       await next.deleteFile('app/invalid-2/route.ts')\n \n       expect(exitCode).toBe(1)\n-      expect(cliOutput).toMatch(\n-        /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'RouteHandlerConfig</\n-      )\n+      if (strictRouteTypes) {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the expected type 'RouteHandlerConfig</\n+        )\n+      } else {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'RouteHandlerConfig</\n+        )\n+      }\n     })\n \n     it('should pass type checking with valid layout exports', async () => {\n@@ -212,9 +239,15 @@ describe('typed-routes-validator', () => {\n       await next.deleteFile('app/invalid/layout.tsx')\n \n       expect(exitCode).toBe(1)\n-      expect(cliOutput).toMatch(\n-        /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'LayoutConfig</\n-      )\n+      if (strictRouteTypes) {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the expected type 'LayoutConfig</\n+        )\n+      } else {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'LayoutConfig</\n+        )\n+      }\n     })\n \n     it('should pass type checking with valid API route exports', async () => {\n@@ -256,9 +289,15 @@ describe('typed-routes-validator', () => {\n       await next.deleteFile('pages/api/invalid-api.ts')\n \n       expect(exitCode).toBe(1)\n-      expect(cliOutput).toMatch(\n-        /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'ApiRouteConfig'/\n-      )\n+      if (strictRouteTypes) {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the expected type 'ApiRouteConfig'/\n+        )\n+      } else {\n+        expect(cliOutput).toMatch(\n+          /Type error: Type 'typeof import\\(.*' does not satisfy the constraint 'ApiRouteConfig'/\n+        )\n+      }\n     })\n   }\n })"
        }
    ],
    "stats": {
        "total": 83,
        "additions": 58,
        "deletions": 25
    }
}