{
    "author": "gaojude",
    "message": "track persistent caching usage (#76996)",
    "sha": "8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c",
    "files": [
        {
            "sha": "4d70556563afd5e7867d3cc3dd87c0b1d127ceec",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c",
            "patch": "@@ -206,6 +206,7 @@ import {\n } from '../server/lib/router-utils/build-prefetch-segment-data-route'\n \n import { turbopackBuild } from './turbopack-build'\n+import { isPersistentCachingEnabled } from '../shared/lib/turbopack/utils'\n import { inlineStaticEnv, populateStaticEnv } from '../lib/inline-static-env'\n \n type Fallback = null | boolean | string\n@@ -2476,6 +2477,10 @@ export default async function build(\n           featureName: 'experimental/ppr',\n           invocationCount: config.experimental.ppr ? 1 : 0,\n         },\n+        {\n+          featureName: 'turbopackPersistentCaching',\n+          invocationCount: isPersistentCachingEnabled(config) ? 1 : 0,\n+        },\n       ]\n       telemetry.record(\n         features.map((feature) => {"
        },
        {
            "sha": "9590093a01b69f0b8a31730509fb218a3e352580",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 1,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c",
            "patch": "@@ -26,7 +26,10 @@ import type { Telemetry } from '../../../telemetry/storage'\n import type { IncomingMessage, ServerResponse } from 'http'\n import loadJsConfig from '../../../build/load-jsconfig'\n import { createValidFileMatcher } from '../find-page-file'\n-import { eventCliSession } from '../../../telemetry/events'\n+import {\n+  EVENT_BUILD_FEATURE_USAGE,\n+  eventCliSession,\n+} from '../../../telemetry/events'\n import { getDefineEnv } from '../../../build/webpack/plugins/define-env-plugin'\n import { getSortedRoutes } from '../../../shared/lib/router/utils'\n import {\n@@ -73,6 +76,7 @@ import { createEnvDefinitions } from '../experimental/create-env-definitions'\n import { JsConfigPathsPlugin } from '../../../build/webpack/plugins/jsconfig-paths-plugin'\n import { store as consoleStore } from '../../../build/output/store'\n import {\n+  isPersistentCachingEnabled,\n   ModuleBuildError,\n   TurbopackInternalError,\n } from '../../../shared/lib/turbopack/utils'\n@@ -996,6 +1000,16 @@ export async function setupDevBundler(opts: SetupOpts) {\n       }\n     )\n   )\n+\n+  // Track build features for dev server here:\n+  opts.telemetry.record({\n+    eventName: EVENT_BUILD_FEATURE_USAGE,\n+    payload: {\n+      featureName: 'turbopackPersistentCaching',\n+      invocationCount: isPersistentCachingEnabled(opts.nextConfig) ? 1 : 0,\n+    },\n+  })\n+\n   return result\n }\n "
        },
        {
            "sha": "d0289c5f0f12d11452733c6c1794c55e422a2fa0",
            "filename": "packages/next/src/telemetry/events/build.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Ftelemetry%2Fevents%2Fbuild.ts?ref=8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c",
            "patch": "@@ -178,6 +178,7 @@ export type EventBuildFeatureUsage = {\n     | 'esmExternals'\n     | 'webpackPlugins'\n     | UseCacheTrackerKey\n+    | 'turbopackPersistentCaching'\n   invocationCount: number\n }\n export function eventBuildFeatureUsage("
        },
        {
            "sha": "1f7cb91e334c5a07c5901168f3c5372ee78a380a",
            "filename": "test/integration/telemetry/next.config.persistent-cache",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/test%2Fintegration%2Ftelemetry%2Fnext.config.persistent-cache",
            "raw_url": "https://github.com/vercel/next.js/raw/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/test%2Fintegration%2Ftelemetry%2Fnext.config.persistent-cache",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Fnext.config.persistent-cache?ref=8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c",
            "patch": "@@ -0,0 +1,7 @@\n+module.exports = {\n+  experimental: {\n+    turbo: {\n+      unstablePersistentCaching: true\n+    }\n+  }\n+} \n\\ No newline at end of file"
        },
        {
            "sha": "591b19fe57121c0788e0b9b0eb0c40de52be4839",
            "filename": "test/integration/telemetry/test/config.test.js",
            "status": "modified",
            "additions": 76,
            "deletions": 1,
            "changes": 77,
            "blob_url": "https://github.com/vercel/next.js/blob/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js",
            "raw_url": "https://github.com/vercel/next.js/raw/8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Ftelemetry%2Ftest%2Fconfig.test.js?ref=8bc2a65fdd0853a7e0bdd16856a99fdc0a626f9c",
            "patch": "@@ -6,10 +6,10 @@ import {\n   launchApp,\n   nextBuild,\n   nextLint,\n+  waitFor,\n } from 'next-test-utils'\n import fs from 'fs-extra'\n import path from 'path'\n-\n const appDir = path.join(__dirname, '..')\n \n describe('config telemetry', () => {\n@@ -761,6 +761,81 @@ describe('config telemetry', () => {\n           })\n         }\n       )\n+\n+      it('emits telemetry for persistent cache in build mode', async () => {\n+        await fs.rename(\n+          path.join(appDir, 'next.config.persistent-cache'),\n+          path.join(appDir, 'next.config.js')\n+        )\n+\n+        try {\n+          const { stderr } = await nextBuild(appDir, [], {\n+            stderr: true,\n+            env: { NEXT_TELEMETRY_DEBUG: 1 },\n+          })\n+\n+          try {\n+            const featureUsageEvents = findAllTelemetryEvents(\n+              stderr,\n+              'NEXT_BUILD_FEATURE_USAGE'\n+            )\n+            expect(featureUsageEvents).toContainEqual({\n+              featureName: 'turbopackPersistentCaching',\n+              invocationCount: 1,\n+            })\n+          } catch (err) {\n+            require('console').error('failing stderr', stderr, err)\n+            throw err\n+          }\n+        } finally {\n+          await fs.rename(\n+            path.join(appDir, 'next.config.js'),\n+            path.join(appDir, 'next.config.persistent-cache')\n+          )\n+        }\n+      })\n+\n+      it('emits telemetry for persistent cache in dev mode', async () => {\n+        await fs.rename(\n+          path.join(appDir, 'next.config.persistent-cache'),\n+          path.join(appDir, 'next.config.js')\n+        )\n+\n+        let app\n+        let stderr = ''\n+\n+        try {\n+          app = await launchApp(appDir, await findPort(), {\n+            env: { NEXT_TELEMETRY_DEBUG: 1 },\n+            onStderr(msg) {\n+              stderr += msg || ''\n+            },\n+          })\n+\n+          await waitFor(2000)\n+\n+          const featureUsageEvents = findAllTelemetryEvents(\n+            stderr,\n+            'NEXT_BUILD_FEATURE_USAGE'\n+          )\n+\n+          expect(featureUsageEvents).toContainEqual({\n+            featureName: 'turbopackPersistentCaching',\n+            invocationCount: 1,\n+          })\n+        } catch (err) {\n+          require('console').error('failing stderr', err)\n+          throw err\n+        } finally {\n+          if (app) {\n+            await killApp(app)\n+          }\n+          await fs.rename(\n+            path.join(appDir, 'next.config.js'),\n+            path.join(appDir, 'next.config.persistent-cache')\n+          )\n+        }\n+      })\n     }\n   )\n })"
        }
    ],
    "stats": {
        "total": 106,
        "additions": 104,
        "deletions": 2
    }
}