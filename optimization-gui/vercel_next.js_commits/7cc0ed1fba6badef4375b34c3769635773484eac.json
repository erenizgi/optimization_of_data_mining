{
    "author": "gaojude",
    "message": "Fix: Resolve <Head> PPR resume mismatch by search params (#82587)\n\nThe `key` prop on `<Head>` component differs during prerender and a PPR\nresume because of search params being part of the key, causing the\nresume to treat them as distinct components, hence the error\\*. However,\nit is necessary semantically to include search params in the key for\n`<Head>`, so we will remove the search params from the key during the\nresume SSR.\n\n\\*Mismatch Error:\n```\n тип [Error: Couldn't find all resumable slots by key/index during replaying.\nThe tree doesn't match so React will fallback to client rendering.]\n```",
    "sha": "7cc0ed1fba6badef4375b34c3769635773484eac",
    "files": [
        {
            "sha": "2f23a3024dd8f4eec35a25f2ef00cb4944928a61",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 11,
            "deletions": 2,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc0ed1fba6badef4375b34c3769635773484eac/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc0ed1fba6badef4375b34c3769635773484eac/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=7cc0ed1fba6badef4375b34c3769635773484eac",
            "patch": "@@ -474,8 +474,17 @@ function Router({\n     //\n     // The `key` is used to remount the component whenever the head moves to\n     // a different segment.\n-    const [headCacheNode, headKey] = matchingHead\n-    head = <Head key={headKey} headCacheNode={headCacheNode} />\n+    const [headCacheNode, headKey, headKeyWithoutSearchParams] = matchingHead\n+\n+    head = (\n+      <Head\n+        key={\n+          // Necessary for PPR: omit search params from the key to match prerendered keys\n+          typeof window === 'undefined' ? headKeyWithoutSearchParams : headKey\n+        }\n+        headCacheNode={headCacheNode}\n+      />\n+    )\n   } else {\n     head = null\n   }"
        },
        {
            "sha": "d3d4baddcf20b7d6eaad3c21453a45b91da02eab",
            "filename": "packages/next/src/client/components/router-reducer/reducers/find-head-in-cache.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 6,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc0ed1fba6badef4375b34c3769635773484eac/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc0ed1fba6badef4375b34c3769635773484eac/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Frouter-reducer%2Freducers%2Ffind-head-in-cache.ts?ref=7cc0ed1fba6badef4375b34c3769635773484eac",
            "patch": "@@ -6,19 +6,20 @@ import { createRouterCacheKey } from '../create-router-cache-key'\n export function findHeadInCache(\n   cache: CacheNode,\n   parallelRoutes: FlightRouterState[1]\n-): [CacheNode, string] | null {\n-  return findHeadInCacheImpl(cache, parallelRoutes, '')\n+): [CacheNode, string, string] | null {\n+  return findHeadInCacheImpl(cache, parallelRoutes, '', '')\n }\n \n function findHeadInCacheImpl(\n   cache: CacheNode,\n   parallelRoutes: FlightRouterState[1],\n-  keyPrefix: string\n-): [CacheNode, string] | null {\n+  keyPrefix: string,\n+  keyPrefixWithoutSearchParams: string\n+): [CacheNode, string, string] | null {\n   const isLastItem = Object.keys(parallelRoutes).length === 0\n   if (isLastItem) {\n     // Returns the entire Cache Node of the segment whose head we will render.\n-    return [cache, keyPrefix]\n+    return [cache, keyPrefix, keyPrefixWithoutSearchParams]\n   }\n \n   // First try the 'children' parallel route if it exists\n@@ -45,6 +46,7 @@ function findHeadInCacheImpl(\n     }\n \n     const cacheKey = createRouterCacheKey(segment)\n+    const cacheKeyWithoutSearchParams = createRouterCacheKey(segment, true)\n \n     const cacheNode = childSegmentMap.get(cacheKey)\n     if (!cacheNode) {\n@@ -54,8 +56,10 @@ function findHeadInCacheImpl(\n     const item = findHeadInCacheImpl(\n       cacheNode,\n       childParallelRoutes,\n-      keyPrefix + '/' + cacheKey\n+      keyPrefix + '/' + cacheKey,\n+      keyPrefix + '/' + cacheKeyWithoutSearchParams\n     )\n+\n     if (item) {\n       return item\n     }"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/resuming-head-runtime-search-param/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc0ed1fba6badef4375b34c3769635773484eac/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc0ed1fba6badef4375b34c3769635773484eac/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Flayout.tsx?ref=7cc0ed1fba6badef4375b34c3769635773484eac",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "2bdfde9628d503e40a7c7191ad804c0cd03f4f60",
            "filename": "test/e2e/app-dir/resuming-head-runtime-search-param/app/page.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc0ed1fba6badef4375b34c3769635773484eac/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc0ed1fba6badef4375b34c3769635773484eac/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fapp%2Fpage.tsx?ref=7cc0ed1fba6badef4375b34c3769635773484eac",
            "patch": "@@ -0,0 +1,25 @@\n+import { connection } from 'next/server'\n+import { Suspense } from 'react'\n+\n+export default function Page() {\n+  return (\n+    <p>\n+      hello world\n+      <Suspense>\n+        <DynamicHole />\n+      </Suspense>\n+    </p>\n+  )\n+}\n+\n+export const generateMetadata = async () => {\n+  await connection()\n+  return {\n+    title: `Hello World`,\n+  }\n+}\n+\n+const DynamicHole = async () => {\n+  await connection()\n+  return <p>Dynamic Hole</p>\n+}"
        },
        {
            "sha": "93363cc5a0b240c09d1ed21d758ccd370baed123",
            "filename": "test/e2e/app-dir/resuming-head-runtime-search-param/next.config.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc0ed1fba6badef4375b34c3769635773484eac/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc0ed1fba6badef4375b34c3769635773484eac/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fnext.config.js?ref=7cc0ed1fba6badef4375b34c3769635773484eac",
            "patch": "@@ -0,0 +1,11 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    cacheComponents: true,\n+    clientSegmentCache: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "0880414d02a3661ffe307520a678e7d17465e0ff",
            "filename": "test/e2e/app-dir/resuming-head-runtime-search-param/resuming-head-runtime-search-param.test.ts",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/7cc0ed1fba6badef4375b34c3769635773484eac/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fresuming-head-runtime-search-param.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7cc0ed1fba6badef4375b34c3769635773484eac/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fresuming-head-runtime-search-param.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fresuming-head-runtime-search-param%2Fresuming-head-runtime-search-param.test.ts?ref=7cc0ed1fba6badef4375b34c3769635773484eac",
            "patch": "@@ -0,0 +1,26 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('resuming-head-runtime-search-param', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should not show resumable slots error when using runtime search params', async () => {\n+    const browser = await next.browser('/?foo=bar&test=123')\n+\n+    // Check that the page renders correctly\n+    await browser.waitForElementByCss('p')\n+    const text = await browser.elementByCss('p').text()\n+    expect(text).toContain('hello world')\n+\n+    // Wait for dynamic content to load (it's rendered inside the first p element)\n+    await browser.waitForElementByCss('p p')\n+    const dynamicText = await browser.elementByCss('p p').text()\n+    expect(dynamicText).toContain('Dynamic Hole')\n+\n+    // Check server logs for the specific error message\n+    expect(next.cliOutput).not.toContain(\n+      \"Couldn't find all resumable slots by key/index during replaying. The tree doesn't match so React will fallback to client rendering.\"\n+    )\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 102,
        "additions": 94,
        "deletions": 8
    }
}