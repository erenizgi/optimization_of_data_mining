{
    "author": "unstubbable",
    "message": "Fix `--no-mangling` for `\"use cache\"` functions (#78993)\n\nWhen mangling is disabled with `next build --no-mangling`, the function\nnames of `\"use cache\"` functions are currently still mangled.\n\nThe reason is that those functions are transformed to inline function\nexpressions whose names are removed by the SWC minifier even if `mangle`\nis `false`.\n\nOriginal:\n\n```js\n'use cache'\n\nexport async function getCachedData() {\n  return functionThatMightThrow()\n}\n```\n\nTransformed by the Next.js compiler during `next dev`:\n\n```js\nexport var $$RSC_SERVER_CACHE_0 = $$cache__(\"default\", \"<id>\", 0, async function getCachedData() {\n  return functionThatMightThrow()\n});\n```\n\nTransformed by the Next.js compiler during `next build`:\n\n```js\nexport var $$RSC_SERVER_CACHE_0 = $$cache__(\"default\", \"<id>\", 0, async function () {\n  return functionThatMightThrow()\n});\n```\n\nBy setting `keep_fnames` to `true` in SWC's `compress` options, we can\nensure that those function expression names are preserved when building\nwith `--no-mangling`, which is helpful when looking at error stacks or\ntraces.",
    "sha": "c4c3aee98f7da0ea5739192f3dc0cdc8537efc68",
    "files": [
        {
            "sha": "8881cfcced585ead218d92fbeb1db38b410f71ad",
            "filename": "packages/next/src/build/webpack/plugins/minify-webpack-plugin/src/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fminify-webpack-plugin%2Fsrc%2Findex.ts?ref=c4c3aee98f7da0ea5739192f3dc0cdc8537efc68",
            "patch": "@@ -145,6 +145,8 @@ export class MinifyPlugin {\n                 global_defs: {\n                   'process.env.__NEXT_PRIVATE_MINIMIZE_MACRO_FALSE': false,\n                 },\n+                keep_classnames: this.options.noMangling,\n+                keep_fnames: this.options.noMangling,\n               },\n               mangle,\n               module: 'unknown',"
        },
        {
            "sha": "f66eda001cd04bfeb6ad20576f4c6b6a4002c220",
            "filename": "test/production/app-dir/no-mangling/app/use-cache/page.tsx",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fapp%2Fuse-cache%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fapp%2Fuse-cache%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fapp%2Fuse-cache%2Fpage.tsx?ref=c4c3aee98f7da0ea5739192f3dc0cdc8537efc68",
            "patch": "@@ -0,0 +1,6 @@\n+'use cache'\n+\n+export default async function CachedPage() {\n+  throw new Error('Kaputt!')\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "dd2e95b8393dba556c7d99cbf2ffb53e52cf25d6",
            "filename": "test/production/app-dir/no-mangling/next.config.js",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fnext.config.js?ref=c4c3aee98f7da0ea5739192f3dc0cdc8537efc68",
            "patch": "@@ -1,6 +1,11 @@\n /**\n  * @type {import('next').NextConfig}\n  */\n-const nextConfig = {}\n+const nextConfig = {\n+  experimental: {\n+    useCache: true,\n+    prerenderEarlyExit: false,\n+  },\n+}\n \n module.exports = nextConfig"
        },
        {
            "sha": "1b4acd80e7edfcca479c5e3857fb8e91963f5bcc",
            "filename": "test/production/app-dir/no-mangling/no-mangling.test.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fno-mangling.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fno-mangling.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fno-mangling%2Fno-mangling.test.ts?ref=c4c3aee98f7da0ea5739192f3dc0cdc8537efc68",
            "patch": "@@ -46,5 +46,21 @@ Error: Kaputt!\n Error: Kaputt!\n     at Page`)\n     })\n+\n+    describe('with \"use cache\" functions', () => {\n+      it('should show original function names in stack traces', async () => {\n+        try {\n+          await next.build()\n+        } catch {\n+          // we expect the build to fail\n+        }\n+\n+        // `CachedPage` is the original function name that would be mangled if\n+        // `next build` was called without `--no-mangling`.\n+        expect(next.cliOutput).toInclude(`\n+Error: Kaputt!\n+    at CachedPage`)\n+      })\n+    })\n   })\n })"
        },
        {
            "sha": "1f7a17c247346a9580323ebcd908abe247f4cd3b",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/c4c3aee98f7da0ea5739192f3dc0cdc8537efc68/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=c4c3aee98f7da0ea5739192f3dc0cdc8537efc68",
            "patch": "@@ -85,6 +85,8 @@ pub fn minify(code: &Code, source_maps: bool, mangle: Option<MangleType>) -> Res\n                             // Only run 2 passes, this is a tradeoff between performance and\n                             // compression size. Default is 3 passes.\n                             passes: 2,\n+                            keep_classnames: mangle.is_none(),\n+                            keep_fnames: mangle.is_none(),\n                             ..Default::default()\n                         }),\n                         mangle: mangle.map(|mangle| {"
        }
    ],
    "stats": {
        "total": 33,
        "additions": 32,
        "deletions": 1
    }
}