{
    "author": "eps1lon",
    "message": "[test] Fix `app-static` deploy test (#81712)",
    "sha": "10ce117bdf5d702969fd81ec15d539be4dfa24cd",
    "files": [
        {
            "sha": "8e81f823064cfde956dea384fabf6c011bf8127f",
            "filename": "test/e2e/app-dir/app-static/app-static.test.ts",
            "status": "modified",
            "additions": 41,
            "deletions": 17,
            "changes": 58,
            "blob_url": "https://github.com/vercel/next.js/blob/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp-static.test.ts?ref=10ce117bdf5d702969fd81ec15d539be4dfa24cd",
            "patch": "@@ -2763,27 +2763,51 @@ describe('app-dir static/dynamic handling', () => {\n     for (let i = 0; i < 6; i++) {\n       await waitFor(1000)\n \n-      const timings = {\n-        start: Date.now(),\n-        startedStreaming: 0,\n-      }\n-\n       res = await next.fetch(path)\n \n-      // eslint-disable-next-line no-loop-func\n-      await new Promise<void>((resolve) => {\n-        res.body.on('data', () => {\n-          if (!timings.startedStreaming) {\n-            timings.startedStreaming = Date.now()\n-          }\n-        })\n-\n-        res.body.on('end', () => {\n-          resolve()\n-        })\n+      let data: any\n+      let startedStreaming: number = -1\n+      res.body.on('data', () => {\n+        if (startedStreaming === -1) {\n+          startedStreaming = Date.now()\n+        }\n       })\n+      if (res.headers.get('content-type').includes('application/json')) {\n+        data = await res.json()\n+      } else {\n+        const html = await res.text()\n+        const $ = cheerio.load(html)\n+        const dataJSON = $('#data').text()\n+        try {\n+          data = JSON.parse(dataJSON)\n+        } catch (cause) {\n+          throw new Error(\n+            `Failed to parse JSON from data-start attribute: \"${dataJSON}\"`,\n+            { cause }\n+          )\n+        }\n+      }\n \n-      expect(timings.startedStreaming - timings.start).toBeLessThan(3000)\n+      const startedResponding = +data.start\n+      if (Number.isNaN(startedResponding)) {\n+        throw new Error(\n+          `Expected start to be a number. Received: \"${data.start}\"`\n+        )\n+      }\n+      if (startedStreaming === -1) {\n+        throw new Error(\n+          'Expected startedStreaming to be set. This is a bug in the test.'\n+        )\n+      }\n+\n+      // We just want to ensure the response isn't blocked on revalidating the fetch.\n+      // So we use the start time when route started processing not when we\n+      // send off the response because that includes cold boots of the infra.\n+      if (startedStreaming - startedResponding >= 3000) {\n+        throw new Error(\n+          `Response #${i} took too long to complete: ${startedStreaming - startedResponding}ms`\n+        )\n+      }\n     }\n   })\n "
        },
        {
            "sha": "26cc7baea90b30bd01375ef0423459028c4bf238",
            "filename": "test/e2e/app-dir/app-static/app/stale-cache-serving-edge/app-page/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving-edge%2Fapp-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving-edge%2Fapp-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving-edge%2Fapp-page%2Fpage.tsx?ref=10ce117bdf5d702969fd81ec15d539be4dfa24cd",
            "patch": "@@ -13,7 +13,7 @@ export default async function Page(props) {\n   return (\n     <>\n       <p id=\"data\">\n-        {JSON.stringify({ fetchDuration, data, now: Date.now() })}\n+        {JSON.stringify({ fetchDuration, data, now: Date.now(), start })}\n       </p>\n     </>\n   )"
        },
        {
            "sha": "30b7952b823480fdbfc1a05d2527f1ab1b6ef9bf",
            "filename": "test/e2e/app-dir/app-static/app/stale-cache-serving-edge/route-handler/route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving-edge%2Froute-handler%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving-edge%2Froute-handler%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving-edge%2Froute-handler%2Froute.ts?ref=10ce117bdf5d702969fd81ec15d539be4dfa24cd",
            "patch": "@@ -12,5 +12,5 @@ export async function GET(req: NextRequest) {\n   ).then((res) => res.json())\n   const fetchDuration = Date.now() - start\n \n-  return NextResponse.json({ fetchDuration, data, now: Date.now() })\n+  return NextResponse.json({ fetchDuration, data, now: Date.now(), start })\n }"
        },
        {
            "sha": "d373e37aa2a31bb8a8f010a4af0d6103dd4c4265",
            "filename": "test/e2e/app-dir/app-static/app/stale-cache-serving/app-page/page.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving%2Fapp-page%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving%2Fapp-page%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving%2Fapp-page%2Fpage.tsx?ref=10ce117bdf5d702969fd81ec15d539be4dfa24cd",
            "patch": "@@ -13,7 +13,7 @@ export default async function Page(props) {\n   return (\n     <>\n       <p id=\"data\">\n-        {JSON.stringify({ fetchDuration, data, now: Date.now() })}\n+        {JSON.stringify({ fetchDuration, data, now: Date.now(), start })}\n       </p>\n     </>\n   )"
        },
        {
            "sha": "408959da737f98654ffd9c61c719509b2c2594e1",
            "filename": "test/e2e/app-dir/app-static/app/stale-cache-serving/route-handler/route.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving%2Froute-handler%2Froute.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/10ce117bdf5d702969fd81ec15d539be4dfa24cd/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving%2Froute-handler%2Froute.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-static%2Fapp%2Fstale-cache-serving%2Froute-handler%2Froute.ts?ref=10ce117bdf5d702969fd81ec15d539be4dfa24cd",
            "patch": "@@ -12,5 +12,5 @@ export async function GET(req: NextRequest) {\n   ).then((res) => res.json())\n   const fetchDuration = Date.now() - start\n \n-  return NextResponse.json({ fetchDuration, data, now: Date.now() })\n+  return NextResponse.json({ fetchDuration, data, now: Date.now(), start })\n }"
        }
    ],
    "stats": {
        "total": 66,
        "additions": 45,
        "deletions": 21
    }
}