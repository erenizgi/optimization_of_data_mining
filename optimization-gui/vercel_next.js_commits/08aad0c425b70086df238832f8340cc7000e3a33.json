{
    "author": "mischnic",
    "message": "Turbopack: fix codegen of directives  (#80895)\n\nCloses PACK-4894\r\n\r\nPreviously, directives in the input weren't handled correctly, this was the output:\r\nThe `use strict` doesn't do anything here because directives only have an effect at the top of modules and at the top of functions.\r\n```js\r\n\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/input/index.js [test] (ecmascript)\": ((__turbopack_context__) => {\r\n\r\nvar { m: module, e: exports } = __turbopack_context__;\r\n{\r\n'use strict';\r\nconsole.log('this is CJS');\r\nmodule.exports = 1234;\r\n}}),\r\n}]);\r\n```\r\n\r\nInstead:\r\n1. detect if `use strict` is in the input file\r\n2. strip all directives\r\n3. prepend `\"use strict\"`  at the top of the chunk item, if it was strict strict",
    "sha": "08aad0c425b70086df238832f8340cc7000e3a33",
    "files": [
        {
            "sha": "0423d3e7dde1464b379df01bcd1df4e880fa1751",
            "filename": "turbopack/crates/turbopack-ecmascript/src/analyzer/imports.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 1,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fanalyzer%2Fimports.rs?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -7,7 +7,7 @@ use swc_core::{\n     ecma::{\n         ast::*,\n         atoms::{Atom, atom},\n-        utils::find_pat_ids,\n+        utils::{IsDirective, find_pat_ids},\n         visit::{Visit, VisitWith},\n     },\n };\n@@ -169,6 +169,9 @@ pub(crate) struct ImportMap {\n     /// True if the module is an ESM module due to top-level await.\n     has_top_level_await: bool,\n \n+    /// True if the module has \"use strict\"\n+    pub(crate) strict: bool,\n+\n     /// Locations of [webpack-style \"magic comments\"][magic] that override import behaviors.\n     ///\n     /// Most commonly, these are `/* webpackIgnore: true */` comments. See [ImportAttributes] for\n@@ -705,6 +708,18 @@ impl Visit for Analyzer<'_> {\n \n     fn visit_program(&mut self, m: &Program) {\n         self.data.has_top_level_await = has_top_level_await(m).is_some();\n+        self.data.strict = match m {\n+            Program::Module(module) => module\n+                .body\n+                .iter()\n+                .take_while(|s| s.directive_continue())\n+                .any(IsDirective::is_use_strict),\n+            Program::Script(script) => script\n+                .body\n+                .iter()\n+                .take_while(|s| s.directive_continue())\n+                .any(IsDirective::is_use_strict),\n+        };\n \n         m.visit_children_with(self);\n     }"
        },
        {
            "sha": "b328a6cf7e2a8cdd406c517a4899f9338a757e45",
            "filename": "turbopack/crates/turbopack-ecmascript/src/chunk/item.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fitem.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fitem.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fchunk%2Fitem.rs?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -51,6 +51,7 @@ impl EcmascriptChunkItemContent {\n \n         let content = content.await?;\n         let async_module = async_module_options.owned().await?;\n+        let strict = content.strict;\n \n         Ok(EcmascriptChunkItemContent {\n             rewrite_source_path: if *chunking_context.should_use_file_source_map_uris().await? {\n@@ -76,6 +77,7 @@ impl EcmascriptChunkItemContent {\n                 }\n \n                 EcmascriptChunkItemOptions {\n+                    strict,\n                     refresh,\n                     externals,\n                     // These things are not available in ESM"
        },
        {
            "sha": "7a6c715ec3a2062f80aeffa3217b89c9f59ec785",
            "filename": "turbopack/crates/turbopack-ecmascript/src/lib.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Flib.rs?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -127,7 +127,7 @@ use crate::{\n     side_effect_optimization::reference::EcmascriptModulePartReference,\n     simple_tree_shake::{ModuleExportUsageInfo, get_module_export_usages},\n     swc_comments::{CowComments, ImmutableComments},\n-    transform::remove_shebang,\n+    transform::{remove_directives, remove_shebang},\n };\n \n #[derive(\n@@ -888,6 +888,7 @@ pub struct EcmascriptModuleContent {\n     pub inner_code: Rope,\n     pub source_map: Option<Rope>,\n     pub is_esm: bool,\n+    pub strict: bool,\n     pub additional_ids: SmallVec<[ResolvedVc<ModuleId>; 1]>,\n }\n \n@@ -1144,6 +1145,7 @@ impl EcmascriptModuleContent {\n             },\n             export_contexts: None,\n             is_esm: true,\n+            strict: true,\n             generate_source_map: options.generate_source_map,\n             original_source_map: CodeGenResultOriginalSourceMap::ScopeHoisting(\n                 original_source_maps,\n@@ -1546,6 +1548,7 @@ struct CodeGenResult {\n     /// `eval_context.imports.exports`\n     export_contexts: Option<FxHashMap<RcStr, Id>>,\n     is_esm: bool,\n+    strict: bool,\n     generate_source_map: bool,\n     original_source_map: CodeGenResultOriginalSourceMap,\n     minify: MinifyType,\n@@ -1571,19 +1574,21 @@ async fn process_parse_result(\n     with_consumed_parse_result(\n         parsed,\n         async |mut program, source_map, globals, eval_context, comments| -> Result<CodeGenResult> {\n-            let (top_level_mark, is_esm, export_contexts) = eval_context\n+            let (top_level_mark, is_esm, strict, export_contexts) = eval_context\n                 .map_either(\n                     |e| {\n                         (\n                             e.top_level_mark,\n                             e.is_esm(specified_module_type),\n+                            e.imports.strict,\n                             Cow::Owned(e.imports.exports),\n                         )\n                     },\n                     |e| {\n                         (\n                             e.top_level_mark,\n                             e.is_esm(specified_module_type),\n+                            e.imports.strict,\n                             Cow::Borrowed(&e.imports.exports),\n                         )\n                     },\n@@ -1711,6 +1716,7 @@ async fn process_parse_result(\n                 // we need to remove any shebang before bundling as it's only valid as the first\n                 // line in a js file (not in a chunk item wrapped in the runtime)\n                 remove_shebang(&mut program);\n+                remove_directives(&mut program);\n             });\n \n             Ok(CodeGenResult {\n@@ -1725,6 +1731,7 @@ async fn process_parse_result(\n                 // TODO ideally don't clone here at all\n                 export_contexts: Some(export_contexts.into_owned()),\n                 is_esm,\n+                strict,\n                 generate_source_map,\n                 original_source_map: CodeGenResultOriginalSourceMap::Single(original_source_map),\n                 minify,\n@@ -1760,6 +1767,7 @@ async fn process_parse_result(\n                         comments: CodeGenResultComments::Empty,\n                         export_contexts: None,\n                         is_esm: false,\n+                        strict: false,\n                         generate_source_map: false,\n                         original_source_map: CodeGenResultOriginalSourceMap::Single(None),\n                         minify: MinifyType::NoMinify,\n@@ -1787,6 +1795,7 @@ async fn process_parse_result(\n                         comments: CodeGenResultComments::Empty,\n                         export_contexts: None,\n                         is_esm: false,\n+                        strict: false,\n                         generate_source_map: false,\n                         original_source_map: CodeGenResultOriginalSourceMap::Single(None),\n                         minify: MinifyType::NoMinify,\n@@ -1877,6 +1886,7 @@ async fn emit_content(\n         source_map,\n         comments,\n         is_esm,\n+        strict,\n         generate_source_map,\n         original_source_map,\n         minify,\n@@ -1941,6 +1951,7 @@ async fn emit_content(\n         inner_code: bytes.into(),\n         source_map,\n         is_esm,\n+        strict,\n         additional_ids,\n     }\n     .cell())"
        },
        {
            "sha": "5d3ab1692c4cc433114ddb641249aca720c54caf",
            "filename": "turbopack/crates/turbopack-ecmascript/src/references/external_module.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Freferences%2Fexternal_module.rs?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -125,6 +125,7 @@ impl CachedExternalModule {\n             inner_code: code.build(),\n             source_map: None,\n             is_esm: self.external_type != CachedExternalType::CommonJs,\n+            strict: false,\n             additional_ids: Default::default(),\n         }\n         .cell())"
        },
        {
            "sha": "b7234902f4870de349f74016f3220525350ad80a",
            "filename": "turbopack/crates/turbopack-ecmascript/src/transform/mod.rs",
            "status": "modified",
            "additions": 47,
            "deletions": 1,
            "changes": 48,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Ftransform%2Fmod.rs?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -8,7 +8,7 @@ use swc_core::{\n     base::SwcComments,\n     common::{Mark, SourceMap, comments::Comments},\n     ecma::{\n-        ast::{ModuleItem, Pass, Program},\n+        ast::{ExprStmt, ModuleItem, Pass, Program, Stmt},\n         preset_env::{self, Targets},\n         transforms::{\n             base::{\n@@ -18,6 +18,7 @@ use swc_core::{\n             optimization::inline_globals,\n             react::react,\n         },\n+        utils::IsDirective,\n     },\n     quote,\n };\n@@ -307,6 +308,51 @@ pub fn remove_shebang(program: &mut Program) {\n     }\n }\n \n+pub fn remove_directives(program: &mut Program) {\n+    match program {\n+        Program::Module(module) => {\n+            let directive_count = module\n+                .body\n+                .iter()\n+                .take_while(|i| match i {\n+                    ModuleItem::Stmt(stmt) => stmt.directive_continue(),\n+                    ModuleItem::ModuleDecl(_) => false,\n+                })\n+                .take_while(|i| match i {\n+                    ModuleItem::Stmt(stmt) => match stmt {\n+                        Stmt::Expr(ExprStmt { expr, .. }) => expr\n+                            .as_lit()\n+                            .and_then(|lit| lit.as_str())\n+                            .and_then(|str| str.raw.as_ref())\n+                            .is_some_and(|raw| {\n+                                raw.starts_with(\"\\\"use \") || raw.starts_with(\"'use \")\n+                            }),\n+                        _ => false,\n+                    },\n+                    ModuleItem::ModuleDecl(_) => false,\n+                })\n+                .count();\n+            module.body.drain(0..directive_count);\n+        }\n+        Program::Script(script) => {\n+            let directive_count = script\n+                .body\n+                .iter()\n+                .take_while(|stmt| stmt.directive_continue())\n+                .take_while(|stmt| match stmt {\n+                    Stmt::Expr(ExprStmt { expr, .. }) => expr\n+                        .as_lit()\n+                        .and_then(|lit| lit.as_str())\n+                        .and_then(|str| str.raw.as_ref())\n+                        .is_some_and(|raw| raw.starts_with(\"\\\"use \") || raw.starts_with(\"'use \")),\n+                    _ => false,\n+                })\n+                .count();\n+            script.body.drain(0..directive_count);\n+        }\n+    }\n+}\n+\n #[turbo_tasks::value(shared)]\n pub struct UnsupportedServerActionIssue {\n     pub file_path: ResolvedVc<FileSystemPath>,"
        },
        {
            "sha": "ff1fe73ae2b9f8d424e6faf055c5c5eed7b9046b",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/input/index.js",
            "status": "added",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Finput%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Finput%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Finput%2Findex.js?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -0,0 +1,4 @@\n+'use strict'\n+\n+console.log('this is CJS')\n+module.exports = 1234"
        },
        {
            "sha": "6c9f6d85ab89a5b561ed88bb125d91a745a51a38",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/output/4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -0,0 +1,6 @@\n+(globalThis.TURBOPACK = globalThis.TURBOPACK || []).push([\n+    \"output/4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js\",\n+    {},\n+    {\"otherChunks\":[\"output/4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js\"],\"runtimeModuleIds\":[\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/input/index.js [test] (ecmascript)\"]}\n+]);\n+// Dummy runtime\n\\ No newline at end of file"
        },
        {
            "sha": "c15d7ec00382d3604310ddb8b53cbdb90d9e1942",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/output/4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js.map",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_b7c39fa7.js.map?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -0,0 +1,5 @@\n+{\n+  \"version\": 3,\n+  \"sources\": [],\n+  \"sections\": []\n+}\n\\ No newline at end of file"
        },
        {
            "sha": "6a53f1ec0e613a38c61c9940982ea2755ff8d830",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/output/4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -0,0 +1,13 @@\n+(globalThis.TURBOPACK = globalThis.TURBOPACK || []).push([\"output/4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js\", {\n+\n+\"[project]/turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/input/index.js [test] (ecmascript)\": ((__turbopack_context__) => {\n+\"use strict\";\n+\n+var { m: module, e: exports } = __turbopack_context__;\n+{\n+console.log('this is CJS');\n+module.exports = 1234;\n+}}),\n+}]);\n+\n+//# sourceMappingURL=4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js.map\n\\ No newline at end of file"
        },
        {
            "sha": "5ca128ff8094e42eea1c96bd0cc8a9fd15d4e66c",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/output/4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js.map",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js.map",
            "raw_url": "https://github.com/vercel/next.js/raw/08aad0c425b70086df238832f8340cc7000e3a33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js.map",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot%2Fbasic%2Fuse-strict%2Foutput%2F4e721_crates_turbopack-tests_tests_snapshot_basic_use-strict_input_index_c0953835.js.map?ref=08aad0c425b70086df238832f8340cc7000e3a33",
            "patch": "@@ -0,0 +1,6 @@\n+{\n+  \"version\": 3,\n+  \"sources\": [],\n+  \"sections\": [\n+    {\"offset\": {\"line\": 7, \"column\": 0}, \"map\": {\"version\":3,\"sources\":[\"turbopack:///[project]/turbopack/crates/turbopack-tests/tests/snapshot/basic/use-strict/input/index.js\"],\"sourcesContent\":[\"'use strict'\\n\\nconsole.log('this is CJS')\\nmodule.exports = 1234\\n\"],\"names\":[],\"mappings\":\"AAEA,QAAQ,GAAG,CAAC;AACZ,OAAO,OAAO,GAAG\"}}]\n+}\n\\ No newline at end of file"
        }
    ],
    "stats": {
        "total": 117,
        "additions": 113,
        "deletions": 4
    }
}