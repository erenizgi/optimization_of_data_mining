{
    "author": "sokra",
    "message": "Turbopack: shard amount need to grow quadratic to cpu count to keep propability of conflicts constant (#84921)\n\n### What?\n\nshard amount need to grow quadratic to cpu count to keep propability of conflicts constant\n\nprobability is computed via birthday paradox",
    "sha": "2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
    "files": [
        {
            "sha": "9a0b7ed714ed1f8c8c442a19907641ae29ded14b",
            "filename": "crates/napi/src/next_api/turbopack_ctx.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fturbopack_ctx.rs?ref=2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
            "patch": "@@ -207,6 +207,7 @@ pub fn create_turbo_tasks(\n                     turbo_tasks_backend::StorageMode::ReadWrite\n                 }),\n                 dependency_tracking,\n+                num_workers: Some(tokio::runtime::Handle::current().metrics().num_workers()),\n                 ..Default::default()\n             },\n             Either::Left(backing_storage),"
        },
        {
            "sha": "f5deae92f7678b9c448503e1cdc1429324856330",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/mod.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 5,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fmod.rs?ref=2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
            "patch": "@@ -15,7 +15,6 @@ use std::{\n         Arc,\n         atomic::{AtomicBool, AtomicU64, AtomicUsize, Ordering},\n     },\n-    thread::available_parallelism,\n };\n \n use anyhow::{Result, bail};\n@@ -67,7 +66,7 @@ use crate::{\n     },\n     utils::{\n         bi_map::BiMap, chunked_vec::ChunkedVec, dash_map_drop_contents::drop_contents,\n-        ptr_eq_arc::PtrEqArc, sharded::Sharded, swap_retain,\n+        ptr_eq_arc::PtrEqArc, shard_amount::compute_shard_amount, sharded::Sharded, swap_retain,\n     },\n };\n \n@@ -134,6 +133,10 @@ pub struct BackendOptions {\n     /// Enables the backing storage.\n     pub storage_mode: Option<StorageMode>,\n \n+    /// Number of tokio worker threads. It will be used to compute the shard amount of parallel\n+    /// datastructures. If `None`, it will use the available parallelism.\n+    pub num_workers: Option<usize>,\n+\n     /// Avoid big preallocations for faster startup. Should only be used for testing purposes.\n     pub small_preallocation: bool,\n }\n@@ -144,6 +147,7 @@ impl Default for BackendOptions {\n             dependency_tracking: true,\n             active_tracking: true,\n             storage_mode: Some(StorageMode::ReadWrite),\n+            num_workers: None,\n             small_preallocation: false,\n         }\n     }\n@@ -228,8 +232,7 @@ impl<B: BackingStorage> TurboTasksBackend<B> {\n \n impl<B: BackingStorage> TurboTasksBackendInner<B> {\n     pub fn new(mut options: BackendOptions, backing_storage: B) -> Self {\n-        let shard_amount =\n-            (available_parallelism().map_or(4, |v| v.get()) * 64).next_power_of_two();\n+        let shard_amount = compute_shard_amount(options.num_workers, options.small_preallocation);\n         let need_log = matches!(options.storage_mode, Some(StorageMode::ReadWrite));\n         if !options.dependency_tracking {\n             options.active_tracking = false;\n@@ -256,7 +259,7 @@ impl<B: BackingStorage> TurboTasksBackendInner<B> {\n             task_cache: BiMap::new(),\n             transient_tasks: FxDashMap::default(),\n             local_is_partial: AtomicBool::new(next_task_id != TaskId::MIN),\n-            storage: Storage::new(small_preallocation),\n+            storage: Storage::new(shard_amount, small_preallocation),\n             in_progress_operations: AtomicUsize::new(0),\n             snapshot_request: Mutex::new(SnapshotRequest::new()),\n             operations_suspended: Condvar::new(),"
        },
        {
            "sha": "8e83bb7c80af2664eda87eff06d8be9d2c2b1b7b",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/storage.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 6,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Fstorage.rs?ref=2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
            "patch": "@@ -2,7 +2,6 @@ use std::{\n     hash::Hash,\n     ops::{Deref, DerefMut},\n     sync::{Arc, atomic::AtomicBool},\n-    thread::available_parallelism,\n };\n \n use bitfield::bitfield;\n@@ -616,17 +615,13 @@ pub struct Storage {\n }\n \n impl Storage {\n-    pub fn new(small_preallocation: bool) -> Self {\n+    pub fn new(shard_amount: usize, small_preallocation: bool) -> Self {\n         let map_capacity: usize = if small_preallocation {\n             1024\n         } else {\n             1024 * 1024\n         };\n         let modified_capacity: usize = if small_preallocation { 0 } else { 1024 };\n-        let shard_factor: usize = if small_preallocation { 4 } else { 64 };\n-\n-        let shard_amount =\n-            (available_parallelism().map_or(4, |v| v.get()) * shard_factor).next_power_of_two();\n \n         Self {\n             snapshot_mode: AtomicBool::new(false),"
        },
        {
            "sha": "142ae2c4db1670c84ced12464e5ded41c2f519fe",
            "filename": "turbopack/crates/turbo-tasks-backend/src/utils/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fmod.rs?ref=2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
            "patch": "@@ -3,6 +3,7 @@ pub mod chunked_vec;\n pub mod dash_map_drop_contents;\n pub mod dash_map_multi;\n pub mod ptr_eq_arc;\n+pub mod shard_amount;\n pub mod sharded;\n pub mod swap_retain;\n "
        },
        {
            "sha": "04bc9aa3f969e5a98b77b2583aa3108853ee499d",
            "filename": "turbopack/crates/turbo-tasks-backend/src/utils/shard_amount.rs",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fshard_amount.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fshard_amount.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Futils%2Fshard_amount.rs?ref=2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
            "patch": "@@ -0,0 +1,44 @@\n+use std::thread::available_parallelism;\n+\n+/// Compute a good number of shards to use for sharded data structures.\n+/// The number of shards is computed based on the number of worker threads\n+/// and whether a small preallocation is requested.\n+/// A small preallocation is useful for tests where performance is not\n+/// critical and we want to reduce memory usage and startup time.\n+/// The number of shards is chosen to minimize the probability of shard\n+/// collisions (which can lead to false sharing) while keeping memory\n+/// usage reasonable.\n+/// The returned number is always a power of two as this is often required\n+/// by sharded data structures. The maximum shard amount is capped at 1 << 16 (65536).\n+pub fn compute_shard_amount(num_workers: Option<usize>, small_preallocation: bool) -> usize {\n+    let num_workers = num_workers.unwrap_or_else(|| available_parallelism().map_or(4, |v| v.get()));\n+\n+    // Once can compute the probability of a shard collision (which leads to false sharing) using\n+    // the birthday paradox formula.  It's notable that the probability of collisions increases\n+    // with more worker threads. To mitigate this effect, the number of shards need to grow\n+    // quadratically with the number of worker threads. This way the probability of at least one\n+    // collision remains constant.\n+    //\n+    // Lets call the worker thread count `N` and the number of shards `S`. When using `S = k * N^2`\n+    // for some constant `k` the probability of at least one collision for large `N` can be\n+    // approximated as: P = 1 - exp(-N^2 / (2*S)) = 1 - exp(-1/(2*k))\n+    //\n+    // For `k = 16` this results in a collision probability of about 3%.\n+    // For `k = 1` this results in a collision probability of about 39%.\n+    //\n+    // We clamp the number of shards to 1 << 16 to avoid excessive memory usage in case of a very\n+    // high number of worker threads. This case is hit with more than 64 worker threads for `k =\n+    // 16` and more than 256 worker threads for `k = 1`.\n+\n+    if small_preallocation {\n+        // We also clamp the minimum number of workers to 256 so all following multiplications can't\n+        // overflow.\n+        let num_workers = num_workers.max(256);\n+        (num_workers * num_workers).next_power_of_two()\n+    } else {\n+        // We also clamp the minimum number of workers to 64 so all following multiplications can't\n+        // overflow.\n+        let num_workers = num_workers.max(64);\n+        (num_workers * num_workers * 16).next_power_of_two()\n+    }\n+}"
        },
        {
            "sha": "16c4cccefb9d0bed312f564c1ddf72a70f7171e7",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/test_config.trs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs",
            "raw_url": "https://github.com/vercel/next.js/raw/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs?ref=2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
            "patch": "@@ -7,7 +7,11 @@\n   std::fs::create_dir_all(&path).unwrap();\n   turbo_tasks::TurboTasks::new(\n     turbo_tasks_backend::TurboTasksBackend::new(\n-      turbo_tasks_backend::BackendOptions::default(),\n+      turbo_tasks_backend::BackendOptions {\n+        num_workers: Some(2),\n+        small_preallocation: true,\n+        ..Default::default()\n+      },\n       turbo_tasks_backend::default_backing_storage(\n         path.as_path(),\n         &turbo_tasks_backend::GitVersionInfo {"
        },
        {
            "sha": "16c4cccefb9d0bed312f564c1ddf72a70f7171e7",
            "filename": "turbopack/crates/turbo-tasks-fetch/tests/test_config.trs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs",
            "raw_url": "https://github.com/vercel/next.js/raw/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fetch%2Ftests%2Ftest_config.trs?ref=2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
            "patch": "@@ -7,7 +7,11 @@\n   std::fs::create_dir_all(&path).unwrap();\n   turbo_tasks::TurboTasks::new(\n     turbo_tasks_backend::TurboTasksBackend::new(\n-      turbo_tasks_backend::BackendOptions::default(),\n+      turbo_tasks_backend::BackendOptions {\n+        num_workers: Some(2),\n+        small_preallocation: true,\n+        ..Default::default()\n+      },\n       turbo_tasks_backend::default_backing_storage(\n         path.as_path(),\n         &turbo_tasks_backend::GitVersionInfo {"
        },
        {
            "sha": "77eb94aac0155b7153e601314f73f98e53e5c4e9",
            "filename": "turbopack/crates/turbo-tasks-macros-tests/tests/test_config.trs",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ftest_config.trs",
            "raw_url": "https://github.com/vercel/next.js/raw/2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ftest_config.trs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-macros-tests%2Ftests%2Ftest_config.trs?ref=2f8b1ece6d87e8d476220da9c5e7d0b46427e2f4",
            "patch": "@@ -1,7 +1,11 @@\n |_name, _initial| {\n   turbo_tasks::TurboTasks::new(\n     turbo_tasks_backend::TurboTasksBackend::new(\n-      turbo_tasks_backend::BackendOptions::default(),\n+      turbo_tasks_backend::BackendOptions {\n+        num_workers: Some(2),\n+        small_preallocation: true,\n+        ..Default::default()\n+      },\n       turbo_tasks_backend::noop_backing_storage(),\n     )\n   )"
        }
    ],
    "stats": {
        "total": 84,
        "additions": 70,
        "deletions": 14
    }
}