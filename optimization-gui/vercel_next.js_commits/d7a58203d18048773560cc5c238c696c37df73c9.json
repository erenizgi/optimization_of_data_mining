{
    "author": "devjiwonchoi",
    "message": "Deprecate `middleware` and recommend `proxy` (#84119)\n\nWe recommend users avoid relying on Middleware unless no other options\nexist. Our goal is to give them APIs with better ergonomics so they can\nachieve their goals without Middleware.\n\nThe term “middleware” often confuses users with Express.js middleware,\nwhich can encourage misuse. To clarify our direction, we are renaming\nthe file convention to “proxy.” This highlights that we are moving away\nfrom Middleware, breaking down its overloaded features, and making the\nProxy clear in its purpose.\n\n`proxy.js` should be a drop-in replacement for `middleware.js` for its\nfeatures, but ONE thing:\n\n```diff\n- export function middleware\n+ export function proxy\n```\n\nCodemod: https://github.com/vercel/next.js/pull/84127\n\n---------\n\nCo-authored-by: Benjamin Woodruff <benjamin.woodruff@vercel.com>",
    "sha": "d7a58203d18048773560cc5c238c696c37df73c9",
    "files": [
        {
            "sha": "3f78f528753f84d89f2c638dbead9f79daad1b30",
            "filename": "crates/next-core/src/middleware.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 5,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fmiddleware.rs?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -9,7 +9,7 @@ use crate::util::load_next_js_template;\n #[turbo_tasks::function]\n pub async fn middleware_files(page_extensions: Vc<Vec<RcStr>>) -> Result<Vc<Vec<RcStr>>> {\n     let extensions = page_extensions.await?;\n-    let files = [\"middleware.\", \"src/middleware.\"]\n+    let files = [\"middleware.\", \"src/middleware.\", \"proxy.\", \"src/proxy.\"]\n         .into_iter()\n         .flat_map(|f| {\n             extensions\n@@ -29,14 +29,16 @@ pub async fn get_middleware_module(\n ) -> Result<Vc<Box<dyn Module>>> {\n     const INNER: &str = \"INNER_MIDDLEWARE_MODULE\";\n \n+    // Determine if this is a proxy file by checking the module path\n+    let userland_path = userland_module.ident().path().await?;\n+    let is_proxy = userland_path.file_stem() == Some(\"proxy\");\n+    let page_path = if is_proxy { \"/proxy\" } else { \"/middleware\" };\n+\n     // Load the file from the next.js codebase.\n     let source = load_next_js_template(\n         \"middleware.js\",\n         project_root,\n-        &[\n-            (\"VAR_USERLAND\", INNER),\n-            (\"VAR_DEFINITION_PAGE\", \"/middleware\"),\n-        ],\n+        &[(\"VAR_USERLAND\", INNER), (\"VAR_DEFINITION_PAGE\", page_path)],\n         &[],\n         &[],\n     )"
        },
        {
            "sha": "04bfa1d49fd2bcee48c5e5b1a812d7c1d29296ec",
            "filename": "packages/next/errors.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Ferrors.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Ferrors.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ferrors.json?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -863,5 +863,7 @@\n   \"862\": \"Request body exceeded %s\",\n   \"863\": \"\\\\`<Link legacyBehavior>\\\\` received a direct child that is either a Server Component, or JSX that was loaded with React.lazy(). This is not supported. Either remove legacyBehavior, or make the direct child a Client Component that renders the Link's \\\\`<a>\\\\` tag.\",\n   \"864\": \"Missing value for segment key: \\\"%s\\\" with dynamic param type: %s\",\n-  \"865\": \"`experimental.rdcForNavigations` is enabled, but `experimental.cacheComponents` is not.\"\n+  \"865\": \"`experimental.rdcForNavigations` is enabled, but `experimental.cacheComponents` is not.\",\n+  \"866\": \"Both \\\"%s\\\" and \\\"%s\\\" files are detected. Please use \\\"%s\\\" instead.\",\n+  \"867\": \"The %s \\\"%s\\\" must export a %s or a \\\\`default\\\\` function\"\n }"
        },
        {
            "sha": "c55eec3afe5ad2384800a357cda99a1488ae133e",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 2,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -20,6 +20,8 @@ import {\n   APP_DIR_ALIAS,\n   WEBPACK_LAYERS,\n   INSTRUMENTATION_HOOK_FILENAME,\n+  PROXY_FILENAME,\n+  MIDDLEWARE_FILENAME,\n } from '../lib/constants'\n import { isAPIRoute } from '../lib/is-api-route'\n import { isEdgeRuntime } from '../lib/is-edge-runtime'\n@@ -948,7 +950,13 @@ export async function createEntrypoints(\n                 isDev: false,\n               })\n           } else if (isMiddlewareFile(page)) {\n-            server[serverBundlePath.replace('src/', '')] = getEdgeServerEntry({\n+            server[\n+              serverBundlePath\n+                // proxy.js still uses middleware.js for bundle path for now.\n+                // TODO: Revisit when we remove middleware.js.\n+                .replace(PROXY_FILENAME, MIDDLEWARE_FILENAME)\n+                .replace('src/', '')\n+            ] = getEdgeServerEntry({\n               ...params,\n               rootDir,\n               absolutePagePath: absolutePagePath,\n@@ -1023,7 +1031,12 @@ export async function createEntrypoints(\n                   : undefined,\n               }).import\n             }\n-            edgeServer[serverBundlePath] = getEdgeServerEntry({\n+            const edgeServerBundlePath = isMiddlewareFile(page)\n+              ? serverBundlePath\n+                  .replace(PROXY_FILENAME, MIDDLEWARE_FILENAME)\n+                  .replace('src/', '')\n+              : serverBundlePath\n+            edgeServer[edgeServerBundlePath] = getEdgeServerEntry({\n               ...params,\n               rootDir,\n               absolutePagePath: absolutePagePath,"
        },
        {
            "sha": "f22b53f19ba72bcf28f87538b9c47964af0dcfcd",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -21,6 +21,7 @@ import {\n   STATIC_STATUS_PAGE_GET_INITIAL_PROPS_ERROR,\n   PUBLIC_DIR_MIDDLEWARE_CONFLICT,\n   MIDDLEWARE_FILENAME,\n+  PROXY_FILENAME,\n   PAGES_DIR_ALIAS,\n   INSTRUMENTATION_HOOK_FILENAME,\n   RSC_PREFETCH_SUFFIX,\n@@ -1163,6 +1164,10 @@ export default async function build(\n         `^${MIDDLEWARE_FILENAME}\\\\.(?:${config.pageExtensions.join('|')})$`\n       )\n \n+      const proxyDetectionRegExp = new RegExp(\n+        `^${PROXY_FILENAME}\\\\.(?:${config.pageExtensions.join('|')})$`\n+      )\n+\n       const instrumentationHookDetectionRegExp = new RegExp(\n         `^${INSTRUMENTATION_HOOK_FILENAME}\\\\.(?:${config.pageExtensions.join(\n           '|'\n@@ -1172,6 +1177,7 @@ export default async function build(\n       const rootDir = path.join((pagesDir || appDir)!, '..')\n       const includes = [\n         middlewareDetectionRegExp,\n+        proxyDetectionRegExp,\n         instrumentationHookDetectionRegExp,\n       ]\n \n@@ -1186,6 +1192,17 @@ export default async function build(\n       const hasMiddlewareFile = rootPaths.some((p) =>\n         p.includes(MIDDLEWARE_FILENAME)\n       )\n+      const hasProxyFile = rootPaths.some((p) => p.includes(PROXY_FILENAME))\n+      if (hasMiddlewareFile) {\n+        if (hasProxyFile) {\n+          throw new Error(\n+            `Both \"${MIDDLEWARE_FILENAME}\" and \"${PROXY_FILENAME}\" files are detected. Please use \"${PROXY_FILENAME}\" instead.`\n+          )\n+        }\n+        Log.warn(\n+          `The \"${MIDDLEWARE_FILENAME}\" file convention is deprecated. Please use \"${PROXY_FILENAME}\" instead.`\n+        )\n+      }\n \n       NextBuildContext.hasInstrumentationHook = hasInstrumentationHook\n \n@@ -2543,8 +2560,8 @@ export default async function build(\n           return serverFilesManifest\n         })\n \n-      const middlewareFile = rootPaths.find((p) =>\n-        p.includes(MIDDLEWARE_FILENAME)\n+      const middlewareFile = rootPaths.find(\n+        (p) => p.includes(MIDDLEWARE_FILENAME) || p.includes(PROXY_FILENAME)\n       )\n       let hasNodeMiddleware = false\n \n@@ -3918,7 +3935,7 @@ export default async function build(\n           rewritesWithHasCount: combinedRewrites.filter((r: any) => !!r.has)\n             .length,\n           redirectsWithHasCount: redirects.filter((r: any) => !!r.has).length,\n-          middlewareCount: hasMiddlewareFile ? 1 : 0,\n+          middlewareCount: hasMiddlewareFile || hasProxyFile ? 1 : 0,\n           totalAppPagesCount,\n           staticAppPagesCount,\n           serverAppPagesCount,"
        },
        {
            "sha": "baef5b3bd3eb3a4cc918d3cbcfb6495dd645e35b",
            "filename": "packages/next/src/build/templates/middleware.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -10,13 +10,15 @@ import { edgeInstrumentationOnRequestError } from '../../server/web/globals'\n import { isNextRouterError } from '../../client/components/is-next-router-error'\n \n const mod = { ..._mod }\n-const handler = mod.middleware || mod.default\n \n const page = 'VAR_DEFINITION_PAGE'\n+// @ts-expect-error `page` will be replaced during build\n+const isProxy = page === '/proxy' || page === '/src/proxy'\n+const handler = (isProxy ? mod.proxy : mod.middleware) || mod.default\n \n if (typeof handler !== 'function') {\n   throw new Error(\n-    `The Middleware \"${page}\" must export a \\`middleware\\` or a \\`default\\` function`\n+    `The ${isProxy ? 'Proxy' : 'Middleware'} \"${page}\" must export a ${isProxy ? '`proxy`' : '`middleware`'} or a \\`default\\` function`\n   )\n }\n "
        },
        {
            "sha": "387fbb0742a1c98bb281a5a13d8a4d4c62011ca0",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 6,
            "changes": 22,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -22,6 +22,7 @@ import {\n   SERVER_PROPS_SSG_CONFLICT,\n   SSG_GET_INITIAL_PROPS_CONFLICT,\n   WEBPACK_LAYERS,\n+  PROXY_FILENAME,\n } from '../lib/constants'\n import type {\n   AppPageModule,\n@@ -96,7 +97,12 @@ export function difference<T>(\n }\n \n export function isMiddlewareFilename(file?: string | null) {\n-  return file === MIDDLEWARE_FILENAME || file === `src/${MIDDLEWARE_FILENAME}`\n+  return (\n+    file === MIDDLEWARE_FILENAME ||\n+    file === `src/${MIDDLEWARE_FILENAME}` ||\n+    file === PROXY_FILENAME ||\n+    file === `src/${PROXY_FILENAME}`\n+  )\n }\n \n export function isInstrumentationHookFilename(file?: string | null) {\n@@ -489,7 +495,7 @@ export async function printTreeView(\n   const middlewareInfo = middlewareManifest.middleware?.['/']\n   if (middlewareInfo?.files.length > 0) {\n     messages.push([])\n-    messages.push(['ƒ Middleware'])\n+    messages.push(['ƒ Proxy (Middleware)'])\n   }\n \n   print(\n@@ -1375,7 +1381,10 @@ export function isCustomErrorPage(page: string) {\n \n export function isMiddlewareFile(file: string) {\n   return (\n-    file === `/${MIDDLEWARE_FILENAME}` || file === `/src/${MIDDLEWARE_FILENAME}`\n+    file === `/${MIDDLEWARE_FILENAME}` ||\n+    file === `/src/${MIDDLEWARE_FILENAME}` ||\n+    file === `/${PROXY_FILENAME}` ||\n+    file === `/src/${PROXY_FILENAME}`\n   )\n }\n \n@@ -1405,9 +1414,10 @@ export function getPossibleMiddlewareFilenames(\n   folder: string,\n   extensions: string[]\n ) {\n-  return extensions.map((extension) =>\n-    path.join(folder, `${MIDDLEWARE_FILENAME}.${extension}`)\n-  )\n+  return extensions.flatMap((extension) => [\n+    path.join(folder, `${MIDDLEWARE_FILENAME}.${extension}`),\n+    path.join(folder, `${PROXY_FILENAME}.${extension}`),\n+  ])\n }\n \n export class NestedMiddlewareError extends Error {"
        },
        {
            "sha": "b6fc2c1d44e4474dc2b9f40d01ebbfdc16ad4bff",
            "filename": "packages/next/src/build/webpack/loaders/next-middleware-loader.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 2,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-middleware-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-middleware-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-middleware-loader.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -3,7 +3,10 @@ import type {\n   MiddlewareMatcher,\n } from '../../analysis/get-page-static-info'\n import { getModuleBuildInfo } from './get-module-build-info'\n-import { MIDDLEWARE_LOCATION_REGEXP } from '../../../lib/constants'\n+import {\n+  MIDDLEWARE_LOCATION_REGEXP,\n+  PROXY_LOCATION_REGEXP,\n+} from '../../../lib/constants'\n import { loadEntrypoint } from '../../load-entrypoint'\n \n export type MiddlewareLoaderOptions = {\n@@ -49,7 +52,12 @@ export default async function middlewareLoader(this: any) {\n   buildInfo.nextEdgeMiddleware = {\n     matchers,\n     page:\n-      page.replace(new RegExp(`/${MIDDLEWARE_LOCATION_REGEXP}$`), '') || '/',\n+      page.replace(\n+        new RegExp(\n+          `/(${MIDDLEWARE_LOCATION_REGEXP}|${PROXY_LOCATION_REGEXP})$`\n+        ),\n+        ''\n+      ) || '/',\n   }\n   buildInfo.rootDir = rootDir\n   buildInfo.route = {"
        },
        {
            "sha": "89a43e400fb4a8e5e57a234909fbf1140dc5e529",
            "filename": "packages/next/src/lib/constants.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Flib%2Fconstants.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -46,6 +46,10 @@ export const INFINITE_CACHE = 0xfffffffe\n export const MIDDLEWARE_FILENAME = 'middleware'\n export const MIDDLEWARE_LOCATION_REGEXP = `(?:src/)?${MIDDLEWARE_FILENAME}`\n \n+// Patterns to detect proxy files (replacement for middleware)\n+export const PROXY_FILENAME = 'proxy'\n+export const PROXY_LOCATION_REGEXP = `(?:src/)?${PROXY_FILENAME}`\n+\n // Pattern to detect instrumentation hooks file\n export const INSTRUMENTATION_HOOK_FILENAME = 'instrumentation'\n "
        },
        {
            "sha": "f731007a9dbda7a4530b0e952fe4899a4ffdd13d",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -1311,6 +1311,8 @@ export async function createHotReloaderTurbopack(\n             // TODO: why is this entry missing in turbopack?\n             if (page === '/middleware') return\n             if (page === '/src/middleware') return\n+            if (page === '/proxy') return\n+            if (page === '/src/proxy') return\n             if (page === '/instrumentation') return\n             if (page === '/src/instrumentation') return\n "
        },
        {
            "sha": "f6eb2cd65079b8d952583540dd3ceaefca64b9e5",
            "filename": "packages/next/src/server/lib/router-utils/setup-dev-bundler.ts",
            "status": "modified",
            "additions": 29,
            "deletions": 1,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Flib%2Frouter-utils%2Fsetup-dev-bundler.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -76,7 +76,11 @@ import {\n import { getDefineEnv } from '../../../build/define-env'\n import { TurbopackInternalError } from '../../../shared/lib/turbopack/internal-error'\n import { normalizePath } from '../../../lib/normalize-path'\n-import { JSON_CONTENT_TYPE_HEADER } from '../../../lib/constants'\n+import {\n+  JSON_CONTENT_TYPE_HEADER,\n+  MIDDLEWARE_FILENAME,\n+  PROXY_FILENAME,\n+} from '../../../lib/constants'\n import {\n   createRouteTypesManifest,\n   writeRouteTypesManifest,\n@@ -387,6 +391,29 @@ async function startWatcher(\n         sortByPageExts(nextConfig.pageExtensions)\n       )\n \n+      let hasMiddlewareFile = false\n+      let hasProxyFile = false\n+      for (const fileName of sortedKnownFiles) {\n+        const { name } = path.parse(fileName)\n+        if (name === MIDDLEWARE_FILENAME) {\n+          hasMiddlewareFile = true\n+        }\n+        if (name === PROXY_FILENAME) {\n+          hasProxyFile = true\n+        }\n+      }\n+\n+      if (hasMiddlewareFile) {\n+        if (hasProxyFile) {\n+          throw new Error(\n+            `Both \"${MIDDLEWARE_FILENAME}\" and \"${PROXY_FILENAME}\" files are detected. Please use \"${PROXY_FILENAME}\" instead.`\n+          )\n+        }\n+        Log.warn(\n+          `The \"${MIDDLEWARE_FILENAME}\" file convention is deprecated. Please use \"${PROXY_FILENAME}\" instead.`\n+        )\n+      }\n+\n       for (const fileName of sortedKnownFiles) {\n         if (\n           !files.includes(fileName) &&\n@@ -467,6 +494,7 @@ async function startWatcher(\n             continue\n           }\n           serverFields.actualMiddlewareFile = rootFile\n+\n           await propagateServerField(\n             opts,\n             'actualMiddlewareFile',"
        },
        {
            "sha": "76739849a8d76a482e4d1e95a1c0e4ca723bbcfd",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -239,7 +239,10 @@ export async function adapter(\n   response = await propagator(request, () => {\n     // we only care to make async storage available for middleware\n     const isMiddleware =\n-      params.page === '/middleware' || params.page === '/src/middleware'\n+      params.page === '/middleware' ||\n+      params.page === '/src/middleware' ||\n+      params.page === '/proxy' ||\n+      params.page === '/src/proxy'\n \n     if (isMiddleware) {\n       // if we're in an edge function, we only get a subset of `nextConfig` (no `experimental`),"
        },
        {
            "sha": "c36b19620717501046c983a2c1c8ff73b76ac7a3",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app-middleware-proxy-in-src-dir.test.ts",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy-in-src-dir.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy-in-src-dir.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy-in-src-dir.test.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,34 @@\n+/* eslint-env jest */\n+import path from 'path'\n+import { nextTestSetup, FileRef } from 'e2e-utils'\n+\n+describe('app dir - with proxy in src dir', () => {\n+  const { next } = nextTestSetup({\n+    files: {\n+      'src/app': new FileRef(path.join(__dirname, 'app')),\n+      'next.config.js': new FileRef(path.join(__dirname, 'next.config.js')),\n+      'src/proxy.js': `\n+      import { NextResponse } from 'next/server'\n+      import { cookies } from 'next/headers'\n+\n+      export async function proxy(request) {\n+        const cookie = (await cookies()).get('test-cookie')\n+        return NextResponse.json({ cookie })\n+      }\n+    `,\n+    },\n+  })\n+\n+  it('works without crashing when using RequestStore', async () => {\n+    const browser = await next.browser('/')\n+    await browser.addCookie({\n+      name: 'test-cookie',\n+      value: 'test-cookie-response',\n+    })\n+    await browser.refresh()\n+\n+    const html = await browser.eval('document.documentElement.innerHTML')\n+\n+    expect(html).toContain('test-cookie-response')\n+  })\n+})"
        },
        {
            "sha": "5b6d3c0687953025fe64239a243249300053dd25",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app-middleware-proxy-without-pages-dir.test.ts",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy-without-pages-dir.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy-without-pages-dir.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy-without-pages-dir.test.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,30 @@\n+/* eslint-env jest */\n+import path from 'path'\n+import { nextTestSetup, FileRef } from 'e2e-utils'\n+\n+describe('app dir - proxy without pages dir', () => {\n+  const { next } = nextTestSetup({\n+    files: {\n+      app: new FileRef(path.join(__dirname, 'app')),\n+      'next.config.js': new FileRef(path.join(__dirname, 'next.config.js')),\n+      'proxy.js': `\n+      import { NextResponse } from 'next/server'\n+\n+      export async function proxy(request) {\n+        return new NextResponse('redirected')\n+      }\n+\n+      export const config = {\n+        matcher: '/headers'\n+      }\n+    `,\n+    },\n+  })\n+\n+  // eslint-disable-next-line jest/no-identical-title\n+  it('Updates headers', async () => {\n+    const html = await next.render('/headers')\n+\n+    expect(html).toContain('redirected')\n+  })\n+})"
        },
        {
            "sha": "a12f5fe07e69010a57ff31eea527f066e1467d57",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app-middleware-proxy.test.ts",
            "status": "added",
            "additions": 269,
            "deletions": 0,
            "changes": 269,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp-middleware-proxy.test.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,269 @@\n+/* eslint-env jest */\n+import cheerio from 'cheerio'\n+import { check, retry, withQuery } from 'next-test-utils'\n+import { nextTestSetup } from 'e2e-utils'\n+import type { Response } from 'node-fetch'\n+\n+describe('app-dir with proxy', () => {\n+  const { next, isNextDeploy } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should filter correctly after proxy rewrite', async () => {\n+    const browser = await next.browser('/start')\n+\n+    await browser.eval('window.beforeNav = 1')\n+    await browser.eval('window.next.router.push(\"/rewrite-to-app\")')\n+\n+    await check(async () => {\n+      return browser.eval('document.documentElement.innerHTML')\n+    }, /app-dir/)\n+  })\n+\n+  describe.each([\n+    {\n+      title: 'Serverless Functions',\n+      path: '/api/dump-headers-serverless',\n+      toJson: (res: Response) => res.json(),\n+    },\n+    {\n+      title: 'Edge Functions',\n+      path: '/api/dump-headers-edge',\n+      toJson: (res: Response) => res.json(),\n+    },\n+    {\n+      title: 'next/headers',\n+      path: '/headers',\n+      toJson: async (res: Response) => {\n+        const $ = cheerio.load(await res.text())\n+        return JSON.parse($('#headers').text())\n+      },\n+    },\n+  ])('Mutate request headers for $title', ({ path, toJson }) => {\n+    it(`Adds new headers`, async () => {\n+      const res = await next.fetch(path, {\n+        headers: {\n+          'x-from-client': 'hello-from-client',\n+        },\n+      })\n+      expect(await toJson(res)).toMatchObject({\n+        'x-from-client': 'hello-from-client',\n+        'x-from-proxy': 'hello-from-proxy',\n+      })\n+    })\n+\n+    it(`Deletes headers`, async () => {\n+      const res = await next.fetch(\n+        withQuery(path, {\n+          'remove-headers': 'x-from-client1,x-from-client2',\n+        }),\n+        {\n+          headers: {\n+            'x-from-client1': 'hello-from-client',\n+            'X-From-Client2': 'hello-from-client',\n+          },\n+        }\n+      )\n+\n+      const json = await toJson(res)\n+      expect(json).not.toHaveProperty('x-from-client1')\n+      expect(json).not.toHaveProperty('X-From-Client2')\n+      expect(json).toMatchObject({\n+        'x-from-proxy': 'hello-from-proxy',\n+      })\n+\n+      // Should not be included in response headers.\n+      expect(res.headers.get('x-middleware-override-headers')).toBeNull()\n+      expect(res.headers.get('x-middleware-request-x-from-proxy')).toBeNull()\n+      expect(res.headers.get('x-middleware-request-x-from-client1')).toBeNull()\n+      expect(res.headers.get('x-middleware-request-x-from-client2')).toBeNull()\n+    })\n+\n+    it(`Updates headers`, async () => {\n+      const res = await next.fetch(\n+        withQuery(path, {\n+          'update-headers':\n+            'x-from-client1=new-value1,x-from-client2=new-value2',\n+        }),\n+        {\n+          headers: {\n+            'x-from-client1': 'old-value1',\n+            'X-From-Client2': 'old-value2',\n+            'x-from-client3': 'old-value3',\n+          },\n+        }\n+      )\n+      expect(await toJson(res)).toMatchObject({\n+        'x-from-client1': 'new-value1',\n+        'x-from-client2': 'new-value2',\n+        'x-from-client3': 'old-value3',\n+        'x-from-proxy': 'hello-from-proxy',\n+      })\n+\n+      // Should not be included in response headers.\n+      expect(res.headers.get('x-middleware-override-headers')).toBeNull()\n+      expect(res.headers.get('x-middleware-request-x-from-proxy')).toBeNull()\n+      expect(res.headers.get('x-middleware-request-x-from-client1')).toBeNull()\n+      expect(res.headers.get('x-middleware-request-x-from-client2')).toBeNull()\n+      expect(res.headers.get('x-middleware-request-x-from-client3')).toBeNull()\n+    })\n+\n+    it(`Supports draft mode`, async () => {\n+      const res = await next.fetch(`${path}?draft=true`)\n+      const headers: string = res.headers.get('set-cookie') || ''\n+      const bypassCookie = headers\n+        .split(';')\n+        .find((c) => c.startsWith('__prerender_bypass'))\n+      expect(bypassCookie).toBeDefined()\n+    })\n+  })\n+\n+  it('retains a link response header from the proxy', async () => {\n+    const res = await next.fetch('/preloads')\n+    expect(res.headers.get('link')).toContain(\n+      '<https://example.com/page>; rel=\"alternate\"; hreflang=\"en\"'\n+    )\n+  })\n+\n+  it('should be possible to modify cookies & read them in an RSC in a single request', async () => {\n+    const browser = await next.browser('/rsc-cookies')\n+\n+    const initialRandom1 = await browser.elementById('rsc-cookie-1').text()\n+    const initialRandom2 = await browser.elementById('rsc-cookie-2').text()\n+    const totalCookies = await browser.elementById('total-cookies').text()\n+\n+    // cookies were set in proxy, assert they are present and match the Math.random() pattern\n+    expect(initialRandom1).toMatch(/Cookie 1: \\d+\\.\\d+/)\n+    expect(initialRandom2).toMatch(/Cookie 2: \\d+\\.\\d+/)\n+    expect(totalCookies).toBe('Total Cookie Length: 2')\n+\n+    await browser.refresh()\n+\n+    const refreshedRandom1 = await browser.elementById('rsc-cookie-1').text()\n+    const refreshedRandom2 = await browser.elementById('rsc-cookie-2').text()\n+\n+    // the cookies should be refreshed and have new values\n+    expect(refreshedRandom1).toMatch(/Cookie 1: \\d+\\.\\d+/)\n+    expect(refreshedRandom2).toMatch(/Cookie 2: \\d+\\.\\d+/)\n+    expect(refreshedRandom1).not.toBe(initialRandom1)\n+    expect(refreshedRandom2).not.toBe(initialRandom2)\n+\n+    // navigate to delete cookies route\n+    await browser.elementByCss('[href=\"/rsc-cookies-delete\"]').click()\n+    await retry(async () => {\n+      // only the first cookie should be deleted\n+      expect(await browser.elementById('rsc-cookie-1').text()).toBe('Cookie 1:')\n+\n+      expect(await browser.elementById('rsc-cookie-2').text()).toMatch(\n+        /Cookie 2: \\d+\\.\\d+/\n+      )\n+    })\n+\n+    // Cleanup\n+    await browser.deleteCookies()\n+  })\n+\n+  it('should respect cookie options of merged proxy cookies', async () => {\n+    const browser = await next.browser('/rsc-cookies/cookie-options')\n+\n+    const totalCookies = await browser.elementById('total-cookies').text()\n+\n+    // a secure cookie was set in proxy\n+    expect(totalCookies).toBe('Total Cookie Length: 1')\n+\n+    // we don't expect to be able to read it\n+    expect(await browser.eval('document.cookie')).toBeFalsy()\n+\n+    await browser.elementById('submit-server-action').click()\n+\n+    await retry(async () => {\n+      expect(await browser.elementById('action-result').text()).toMatch(\n+        /Action Result: \\d+\\.\\d+/\n+      )\n+    })\n+\n+    // ensure that we still can't read the secure cookie\n+    expect(await browser.eval('document.cookie')).toBeFalsy()\n+\n+    // Cleanup\n+    await browser.deleteCookies()\n+  })\n+\n+  it('should omit internal headers for proxy cookies', async () => {\n+    const response = await next.fetch('/rsc-cookies/cookie-options')\n+    expect(response.status).toBe(200)\n+    expect(response.headers.get('x-middleware-set-cookie')).toBeNull()\n+\n+    const response2 = await next.fetch('/cookies/api')\n+    expect(response2.status).toBe(200)\n+    expect(response2.headers.get('x-middleware-set-cookie')).toBeNull()\n+    expect(response2.headers.get('set-cookie')).toBeDefined()\n+    expect(response2.headers.get('set-cookie')).toContain('example')\n+  })\n+\n+  it('should ignore x-middleware-set-cookie as a request header', async () => {\n+    const $ = await next.render$(\n+      '/cookies',\n+      {},\n+      {\n+        headers: {\n+          'x-middleware-set-cookie': 'test',\n+        },\n+      }\n+    )\n+\n+    expect($('#cookies').text()).toBe('cookies: 0')\n+  })\n+\n+  it('should be possible to read cookies that are set during the proxy handling of a server action', async () => {\n+    const browser = await next.browser('/rsc-cookies')\n+    const initialRandom1 = await browser.elementById('rsc-cookie-1').text()\n+    const initialRandom2 = await browser.elementById('rsc-cookie-2').text()\n+    const totalCookies = await browser.elementById('total-cookies').text()\n+\n+    // cookies were set in proxy, assert they are present and match the Math.random() pattern\n+    expect(initialRandom1).toMatch(/Cookie 1: \\d+\\.\\d+/)\n+    expect(initialRandom2).toMatch(/Cookie 2: \\d+\\.\\d+/)\n+    expect(totalCookies).toBe('Total Cookie Length: 2')\n+\n+    expect(await browser.eval('document.cookie')).toBeTruthy()\n+\n+    await browser.deleteCookies()\n+\n+    // assert that document.cookie is empty\n+    expect(await browser.eval('document.cookie')).toBeFalsy()\n+\n+    await browser.elementById('submit-server-action').click()\n+\n+    await retry(async () => {\n+      expect(await browser.elementById('action-result').text()).toMatch(\n+        /Action Result: \\d+\\.\\d+/\n+      )\n+    })\n+\n+    await browser.deleteCookies()\n+  })\n+\n+  // TODO: This consistently 404s on Vercel deployments. It technically\n+  // doesn't repro the bug we're trying to fix but we need to figure out\n+  // why the handling is different.\n+  if (!isNextDeploy) {\n+    it('should not incorrectly treat a Location header as a rewrite', async () => {\n+      const res = await next.fetch('/test-location-header')\n+\n+      // Should get status 200 (not a redirect status)\n+      expect(res.status).toBe(200)\n+\n+      // Should get the JSON response associated with the route,\n+      // and not follow the redirect\n+      const json = await res.json()\n+      expect(json).toEqual({ foo: 'bar' })\n+\n+      // Ensure the provided location is still on the response\n+      const locationHeader = res.headers.get('location')\n+      expect(locationHeader).toBe(\n+        'https://next-data-api-endpoint.vercel.app/api/random'\n+      )\n+    })\n+  }\n+})"
        },
        {
            "sha": "598c70f384dac0af9d92c1c5e65324e36e303524",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/cookies/api/route.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fcookies%2Fapi%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fcookies%2Fapi%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fcookies%2Fapi%2Froute.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,11 @@\n+import { NextResponse } from 'next/server'\n+\n+export function GET() {\n+  const response = new NextResponse()\n+  response.cookies.set({\n+    name: 'example',\n+    value: 'example',\n+  })\n+\n+  return response\n+}"
        },
        {
            "sha": "cdcfe3addce7f264d6d9a79c77bfc5e034b1cd18",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/cookies/page.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fcookies%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fcookies%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fcookies%2Fpage.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,6 @@\n+import { cookies } from 'next/headers'\n+\n+export default async function Page() {\n+  const cookieLength = (await cookies()).size\n+  return <div id=\"cookies\">cookies: {cookieLength}</div>\n+}"
        },
        {
            "sha": "977111f49c646b9c1a77eab04f18e6874325f18c",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/headers/page.js",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fheaders%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fheaders%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fheaders%2Fpage.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,11 @@\n+import { headers } from 'next/headers'\n+\n+export default async function SSRPage() {\n+  const headersObj = Object.fromEntries(await headers())\n+  return (\n+    <>\n+      <p>app-dir</p>\n+      <p id=\"headers\">{JSON.stringify(headersObj)}</p>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "3a1af60bc8b9839c92a6f524b680f9c21b2c23a1",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/layout.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Flayout.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Flayout.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Flayout.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,10 @@\n+export default function Layout({ children }) {\n+  return (\n+    <html lang=\"en\">\n+      <head>\n+        <title>app-middleware</title>\n+      </head>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "3cbe6210546ce961041a7f19a8e8ed723ef11cb8",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/preloads/page.js",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fpreloads%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fpreloads%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Fpreloads%2Fpage.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,13 @@\n+import Image from 'next/image'\n+import { Inter } from 'next/font/google'\n+\n+const inter = Inter({ subsets: ['latin'] })\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <Image priority src=\"/favicon.ico\" alt=\"favicon\" width={16} height={16} />\n+      <h1 className={inter.className}>Hello World</h1>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "bd396280f09d328a894374091defe31dac659163",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/rsc-cookies-delete/page.js",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies-delete%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies-delete%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies-delete%2Fpage.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,14 @@\n+import { cookies } from 'next/headers'\n+\n+export default async function Page() {\n+  const rscCookie1 = (await cookies()).get('rsc-cookie-value-1')?.value\n+  const rscCookie2 = (await cookies()).get('rsc-cookie-value-2')?.value\n+\n+  return (\n+    <div>\n+      <p id=\"rsc-cookie-1\">Cookie 1: {rscCookie1}</p>\n+      <p id=\"rsc-cookie-2\">Cookie 2: {rscCookie2}</p>\n+      <p id=\"total-cookies\">Total Cookie Length: {(await cookies()).size}</p>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "713c8babccc6bb2975ed6a9d7b694947896f435b",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/rsc-cookies/cookie-options/page.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fcookie-options%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fcookie-options%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fcookie-options%2Fpage.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,21 @@\n+import { cookies } from 'next/headers'\n+import Link from 'next/link'\n+import { Form } from '../form'\n+\n+export default async function Page() {\n+  return (\n+    <div>\n+      <p id=\"total-cookies\">Total Cookie Length: {(await cookies()).size}</p>\n+      <Link href=\"/rsc-cookies-delete\" prefetch={false}>\n+        To Delete Cookies Route\n+      </Link>\n+\n+      <Form\n+        action={async () => {\n+          'use server'\n+          return (await cookies()).get('rsc-secure-cookie').value\n+        }}\n+      />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "638f30b338964cf1fda34f0df69859ba6ea62f35",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/rsc-cookies/form.js",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fform.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fform.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fform.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,16 @@\n+'use client'\n+\n+import { useActionState } from 'react'\n+\n+export function Form({ action }) {\n+  const [state, formAction] = useActionState(action, null)\n+\n+  return (\n+    <form action={formAction}>\n+      <div id=\"action-result\">Action Result: {state}</div>\n+      <button type=\"submit\" id=\"submit-server-action\">\n+        server action\n+      </button>\n+    </form>\n+  )\n+}"
        },
        {
            "sha": "15de30f6c17d687f0e05ea6c11335ae71ebc08c6",
            "filename": "test/e2e/app-dir/app-middleware-proxy/app/rsc-cookies/page.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fapp%2Frsc-cookies%2Fpage.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,26 @@\n+import { cookies } from 'next/headers'\n+import Link from 'next/link'\n+import { Form } from './form'\n+\n+export default async function Page() {\n+  const rscCookie1 = (await cookies()).get('rsc-cookie-value-1')?.value\n+  const rscCookie2 = (await cookies()).get('rsc-cookie-value-2')?.value\n+\n+  return (\n+    <div>\n+      <p id=\"rsc-cookie-1\">Cookie 1: {rscCookie1}</p>\n+      <p id=\"rsc-cookie-2\">Cookie 2: {rscCookie2}</p>\n+      <p id=\"total-cookies\">Total Cookie Length: {(await cookies()).size}</p>\n+      <Link href=\"/rsc-cookies-delete\" prefetch={false}>\n+        To Delete Cookies Route\n+      </Link>\n+      <Form\n+        action={async () => {\n+          'use server'\n+\n+          return (await cookies()).get('rsc-cookie-value-1')?.value\n+        }}\n+      />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "265b3fb7e344b091b01cbbb678c6f9560cdd09d7",
            "filename": "test/e2e/app-dir/app-middleware-proxy/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fnext.config.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,6 @@\n+module.exports = {\n+  experimental: {\n+    clientRouterFilter: true,\n+    clientRouterFilterRedirects: true,\n+  },\n+}"
        },
        {
            "sha": "6701299af9b94900f3e253e4f59350051fd4e797",
            "filename": "test/e2e/app-dir/app-middleware-proxy/pages/[slug].js",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2F%5Bslug%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2F%5Bslug%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2F%5Bslug%5D.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello from pages/[slug]</p>\n+}"
        },
        {
            "sha": "15fa2581745ee737cdd656dfaf59f6891e7c4a73",
            "filename": "test/e2e/app-dir/app-middleware-proxy/pages/api/dump-headers-edge.js",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2Fapi%2Fdump-headers-edge.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2Fapi%2Fdump-headers-edge.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2Fapi%2Fdump-headers-edge.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,9 @@\n+export const runtime = 'edge'\n+\n+export default (req) => {\n+  return Response.json(Object.fromEntries(req.headers.entries()), {\n+    headers: {\n+      'headers-from-edge-function': '1',\n+    },\n+  })\n+}"
        },
        {
            "sha": "0f1a9262d9cd0b47aa26a441502487d6de7660bb",
            "filename": "test/e2e/app-dir/app-middleware-proxy/pages/api/dump-headers-serverless.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2Fapi%2Fdump-headers-serverless.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2Fapi%2Fdump-headers-serverless.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fpages%2Fapi%2Fdump-headers-serverless.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,6 @@\n+export default (req, res) => {\n+  return res\n+    .status(200)\n+    .setHeader('headers-from-serverless', '1')\n+    .json(req.headers)\n+}"
        },
        {
            "sha": "d5a7c82b381ad3b36904c8921658433136af1234",
            "filename": "test/e2e/app-dir/app-middleware-proxy/proxy.js",
            "status": "added",
            "additions": 97,
            "deletions": 0,
            "changes": 97,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fproxy.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fproxy.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware-proxy%2Fproxy.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,97 @@\n+import { NextResponse } from 'next/server'\n+\n+import { headers as nextHeaders, draftMode } from 'next/headers'\n+\n+/**\n+ * @param {import('next/server').NextRequest} request\n+ */\n+export async function proxy(request) {\n+  const headersFromRequest = new Headers(request.headers)\n+  // It should be able to import and use `headers` inside proxy\n+  const headersFromNext = await nextHeaders()\n+  headersFromRequest.set('x-from-proxy', 'hello-from-proxy')\n+\n+  // make sure headers() from `next/headers` is behaving properly\n+  if (\n+    headersFromRequest.get('x-from-client') &&\n+    headersFromNext.get('x-from-client') !==\n+      headersFromRequest.get('x-from-client')\n+  ) {\n+    throw new Error('Expected headers from client to match')\n+  }\n+\n+  if (request.nextUrl.searchParams.get('draft')) {\n+    ;(await draftMode()).enable()\n+  }\n+\n+  const removeHeaders = request.nextUrl.searchParams.get('remove-headers')\n+  if (removeHeaders) {\n+    for (const key of removeHeaders.split(',')) {\n+      headersFromRequest.delete(key)\n+    }\n+  }\n+\n+  const updateHeader = request.nextUrl.searchParams.get('update-headers')\n+  if (updateHeader) {\n+    for (const kv of updateHeader.split(',')) {\n+      const [key, value] = kv.split('=')\n+      headersFromRequest.set(key, value)\n+    }\n+  }\n+\n+  if (request.nextUrl.pathname.includes('/rewrite-to-app')) {\n+    request.nextUrl.pathname = '/headers'\n+    return NextResponse.rewrite(request.nextUrl)\n+  }\n+\n+  if (request.nextUrl.pathname === '/rsc-cookies') {\n+    const res = NextResponse.next()\n+    res.cookies.set('rsc-cookie-value-1', `${Math.random()}`)\n+    res.cookies.set('rsc-cookie-value-2', `${Math.random()}`)\n+\n+    return res\n+  }\n+\n+  if (request.nextUrl.pathname === '/rsc-cookies/cookie-options') {\n+    const res = NextResponse.next()\n+    res.cookies.set('rsc-secure-cookie', `${Math.random()}`, {\n+      secure: true,\n+      httpOnly: true,\n+    })\n+\n+    return res\n+  }\n+\n+  if (request.nextUrl.pathname === '/rsc-cookies-delete') {\n+    const res = NextResponse.next()\n+    res.cookies.delete('rsc-cookie-value-1')\n+\n+    return res\n+  }\n+\n+  if (request.nextUrl.pathname === '/preloads') {\n+    const res = NextResponse.next({\n+      headers: {\n+        link: '<https://example.com/page>; rel=\"alternate\"; hreflang=\"en\"',\n+      },\n+    })\n+    return res\n+  }\n+\n+  if (request.nextUrl.pathname === '/test-location-header') {\n+    return NextResponse.json(\n+      { foo: 'bar' },\n+      {\n+        headers: {\n+          location: 'https://next-data-api-endpoint.vercel.app/api/random',\n+        },\n+      }\n+    )\n+  }\n+\n+  return NextResponse.next({\n+    request: {\n+      headers: headersFromRequest,\n+    },\n+  })\n+}"
        },
        {
            "sha": "40d09d0e58405349e7551b2ef53a0c579ef1a5bb",
            "filename": "test/e2e/app-dir/app-middleware/app-middleware.test.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp-middleware%2Fapp-middleware.test.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -9,6 +9,12 @@ describe('app-dir with middleware', () => {\n     files: __dirname,\n   })\n \n+  it('should warn when deprecated middleware file is used', async () => {\n+    expect(next.cliOutput).toContain(\n+      'The \"middleware\" file convention is deprecated. Please use \"proxy\" instead.'\n+    )\n+  })\n+\n   it('should filter correctly after middleware rewrite', async () => {\n     const browser = await next.browser('/start')\n "
        },
        {
            "sha": "4d09bbd1c45877509b9cbeb8e6b2e2b881e2eef0",
            "filename": "test/experimental-tests-manifest.json",
            "status": "modified",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fexperimental-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fexperimental-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fexperimental-tests-manifest.json?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -124,6 +124,9 @@\n       \"test/e2e/app-dir/app-middleware/app-middleware.test.ts\",\n       \"test/e2e/app-dir/app-middleware/app-middleware-in-src-dir.test.ts\",\n       \"test/e2e/app-dir/app-middleware/app-middleware-without-pages-dir.test.ts\",\n+      \"test/e2e/app-dir/app-middleware-proxy/app-middleware-proxy.test.ts\",\n+      \"test/e2e/app-dir/app-middleware-proxy/app-middleware-proxy-in-src-dir.test.ts\",\n+      \"test/e2e/app-dir/app-middleware-proxy/app-middleware-proxy-without-pages-dir.test.ts\",\n       \"test/e2e/app-dir/app-prefetch*/**/*\",\n       \"test/e2e/app-dir/app-rendering/rendering.test.ts\",\n       \"test/e2e/app-dir/app-root-params/generate-static-params.test.ts\","
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/production/app-dir/proxy-with-middleware/app/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Flayout.tsx?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/production/app-dir/proxy-with-middleware/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fapp%2Fpage.tsx?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "adf5b7f421208a6ca37811aa17b68124af312b58",
            "filename": "test/production/app-dir/proxy-with-middleware/middleware.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fmiddleware.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,5 @@\n+import { NextResponse } from 'next/server'\n+\n+export function middleware(req: Request) {\n+  return NextResponse.rewrite(new URL('/', req.url))\n+}"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/app-dir/proxy-with-middleware/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fnext.config.js?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "459bbf8c880ecb74110614f9851ae5ad0ee71a9d",
            "filename": "test/production/app-dir/proxy-with-middleware/proxy-with-middleware.test.ts",
            "status": "added",
            "additions": 27,
            "deletions": 0,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fproxy-with-middleware.test.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,27 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('proxy-with-middleware', () => {\n+  const { next, isNextDev, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+    skipStart: true,\n+  })\n+\n+  if (skipped) {\n+    return\n+  }\n+\n+  it('should error when both middleware and proxy files are detected', async () => {\n+    if (isNextDev) {\n+      await next.start()\n+      expect(next.cliOutput).toContain(\n+        'Both \"middleware\" and \"proxy\" files are detected. Please use \"proxy\" instead.'\n+      )\n+    } else {\n+      const { cliOutput } = await next.build()\n+      expect(cliOutput).toContain(\n+        'Both \"middleware\" and \"proxy\" files are detected. Please use \"proxy\" instead.'\n+      )\n+    }\n+  })\n+})"
        },
        {
            "sha": "26c43637fecde47f0d8a56aacfb82a92ba500951",
            "filename": "test/production/app-dir/proxy-with-middleware/proxy.ts",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fproxy.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d7a58203d18048773560cc5c238c696c37df73c9/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fproxy.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fproxy-with-middleware%2Fproxy.ts?ref=d7a58203d18048773560cc5c238c696c37df73c9",
            "patch": "@@ -0,0 +1,5 @@\n+import { NextResponse } from 'next/server'\n+\n+export function proxy(req: Request) {\n+  return NextResponse.rewrite(new URL('/', req.url))\n+}"
        }
    ],
    "stats": {
        "total": 782,
        "additions": 759,
        "deletions": 23
    }
}