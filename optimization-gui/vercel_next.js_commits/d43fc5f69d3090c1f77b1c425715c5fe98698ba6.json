{
    "author": "unstubbable",
    "message": "Show revalidate/expire columns in build output (#76343)\n\nFor pages router ISR pages, we are showing the revalidate times in the\nbuild output tree view, e.g.:\n```\nRoute (pages)                             Size     First Load JS\n┌ ○ /404                                  190 B          92.6 kB\n└ ● /my-isr-page (ISR: 300 Seconds)       291 B          92.7 kB\n```\n\nFor app router pages, this info is currently missing.\n\nWith this PR, we're not only adding the revalidate times for app router\nroutes, but also showing the expire times as well. Those may be\nconfigured in the Next.js config\n[`expireTime`](https://nextjs.org/docs/app/api-reference/config/next-config-js/expireTime),\nor via [cache\nprofiles](https://nextjs.org/docs/app/api-reference/functions/cacheLife)\nin `\"use cache\"` functions.\n\nBoth values are moved into separate `Revalidate` and `Expire` columns\nand are shown in a human-readable format.\n\n**After:**\n\n<img width=\"708\" alt=\"two columns\"\nsrc=\"https://github.com/user-attachments/assets/3d6dff7b-7df1-43b2-ae33-802227a3cf88\"\n/>\n\n**Before:**\n\n<img width=\"788\" alt=\"before\"\nsrc=\"https://github.com/user-attachments/assets/19d5bc2c-c39f-4d44-97e0-ddcb72de3d82\"\n/>\n\ncloses NAR-96",
    "sha": "d43fc5f69d3090c1f77b1c425715c5fe98698ba6",
    "files": [
        {
            "sha": "25391ee07c0737377f5103129585334c6e886a41",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 10,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=d43fc5f69d3090c1f77b1c425715c5fe98698ba6",
            "patch": "@@ -2909,23 +2909,15 @@ export default async function build(\n                 ...(pageInfos.get(route.pathname) as PageInfo),\n                 hasPostponed,\n                 hasEmptyPrelude,\n-                // TODO: Enable the following line to show \"ISR\" status in build\n-                // output. Requires different presentation to also work for app\n-                // router routes.\n-                // See https://vercel.slack.com/archives/C02CDC2ALJH/p1739552318644119?thread_ts=1739550179.439319&cid=C02CDC2ALJH\n-                // initialCacheControl: cacheControl,\n+                initialCacheControl: cacheControl,\n               })\n \n               // update the page (eg /blog/[slug]) to also have the postpone metadata\n               pageInfos.set(page, {\n                 ...(pageInfos.get(page) as PageInfo),\n                 hasPostponed,\n                 hasEmptyPrelude,\n-                // TODO: Enable the following line to show \"ISR\" status in build\n-                // output. Requires different presentation to also work for app\n-                // router routes.\n-                // See https://vercel.slack.com/archives/C02CDC2ALJH/p1739552318644119?thread_ts=1739550179.439319&cid=C02CDC2ALJH\n-                // initialCacheControl: cacheControl,\n+                initialCacheControl: cacheControl,\n               })\n \n               if (cacheControl.revalidate !== 0) {"
        },
        {
            "sha": "dcf58e5f1d7af0b049aa39703ac8e46682538a92",
            "filename": "packages/next/src/build/output/format.ts",
            "status": "added",
            "additions": 54,
            "deletions": 0,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/packages%2Fnext%2Fsrc%2Fbuild%2Foutput%2Fformat.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/packages%2Fnext%2Fsrc%2Fbuild%2Foutput%2Fformat.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Foutput%2Fformat.ts?ref=d43fc5f69d3090c1f77b1c425715c5fe98698ba6",
            "patch": "@@ -0,0 +1,54 @@\n+import type { CacheControl } from '../../server/lib/cache-control'\n+\n+const timeUnits = [\n+  { label: 'y', seconds: 31536000 },\n+  { label: 'w', seconds: 604800 },\n+  { label: 'd', seconds: 86400 },\n+  { label: 'h', seconds: 3600 },\n+  { label: 'm', seconds: 60 },\n+  { label: 's', seconds: 1 },\n+]\n+\n+function humanReadableTimeRounded(seconds: number): string {\n+  // Find the largest fitting unit.\n+  let candidateIndex = timeUnits.length - 1\n+  for (let i = 0; i < timeUnits.length; i++) {\n+    if (seconds >= timeUnits[i].seconds) {\n+      candidateIndex = i\n+      break\n+    }\n+  }\n+\n+  const candidate = timeUnits[candidateIndex]\n+  const value = seconds / candidate.seconds\n+  const isExact = Number.isInteger(value)\n+\n+  // For days and weeks only, check if using the next smaller unit yields an\n+  // exact result.\n+  if (!isExact && (candidate.label === 'd' || candidate.label === 'w')) {\n+    const nextUnit = timeUnits[candidateIndex + 1]\n+    const nextValue = seconds / nextUnit.seconds\n+\n+    if (Number.isInteger(nextValue)) {\n+      return `${nextValue}${nextUnit.label}`\n+    }\n+  }\n+\n+  if (isExact) {\n+    return `${value}${candidate.label}`\n+  }\n+\n+  return `≈${Math.round(value)}${candidate.label}`\n+}\n+\n+export function formatRevalidate(cacheControl: CacheControl): string {\n+  const { revalidate } = cacheControl\n+\n+  return revalidate ? humanReadableTimeRounded(revalidate) : ''\n+}\n+\n+export function formatExpire(cacheControl: CacheControl): string {\n+  const { expire } = cacheControl\n+\n+  return expire ? humanReadableTimeRounded(expire) : ''\n+}"
        },
        {
            "sha": "1d01f03286db935ef95d59cd78415ec7f35761fe",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 65,
            "deletions": 23,
            "changes": 88,
            "blob_url": "https://github.com/vercel/next.js/blob/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=d43fc5f69d3090c1f77b1c425715c5fe98698ba6",
            "patch": "@@ -82,6 +82,7 @@ import { buildAppStaticPaths } from './static-paths/app'\n import { buildPagesStaticPaths } from './static-paths/pages'\n import type { PrerenderedRoute } from './static-paths/types'\n import type { CacheControl } from '../server/lib/cache-control'\n+import { formatExpire, formatRevalidate } from './output/format'\n \n export type ROUTER_TYPE = 'pages' | 'app'\n \n@@ -347,7 +348,6 @@ export interface PageInfo {\n    */\n   isRoutePPREnabled: boolean\n   ssgPageRoutes: string[] | null\n-  // TODO: initialCacheControl should be set per prerendered route.\n   initialCacheControl: CacheControl | undefined\n   pageDuration: number | undefined\n   ssgPageDurations: number[] | undefined\n@@ -447,7 +447,7 @@ export async function printTreeView(\n   // Collect all the symbols we use so we can print the icons out.\n   const usedSymbols = new Set()\n \n-  const messages: [string, string, string][] = []\n+  const messages: [string, string, string, string, string][] = []\n \n   const stats = await computeFromManifest(\n     { build: buildManifest, app: appBuildManifest },\n@@ -468,12 +468,39 @@ export async function printTreeView(\n       return\n     }\n \n+    let showRevalidate = false\n+    let showExpire = false\n+\n+    for (const page of filteredPages) {\n+      const cacheControl = pageInfos.get(page)?.initialCacheControl\n+\n+      if (cacheControl?.revalidate) {\n+        showRevalidate = true\n+      }\n+\n+      if (cacheControl?.expire) {\n+        showExpire = true\n+      }\n+\n+      if (showRevalidate && showExpire) {\n+        break\n+      }\n+    }\n+\n     messages.push(\n       [\n         routerType === 'app' ? 'Route (app)' : 'Route (pages)',\n         'Size',\n         'First Load JS',\n-      ].map((entry) => underline(entry)) as [string, string, string]\n+        showRevalidate ? 'Revalidate' : '',\n+        showExpire ? 'Expire' : '',\n+      ].map((entry) => underline(entry)) as [\n+        string,\n+        string,\n+        string,\n+        string,\n+        string,\n+      ]\n     )\n \n     filteredPages.forEach((item, i, arr) => {\n@@ -522,16 +549,8 @@ export async function printTreeView(\n \n       usedSymbols.add(symbol)\n \n-      // TODO: Rework this to be usable for app router routes.\n-      // See https://vercel.slack.com/archives/C02CDC2ALJH/p1739552318644119?thread_ts=1739550179.439319&cid=C02CDC2ALJH\n-      if (pageInfo?.initialCacheControl?.revalidate) usedSymbols.add('ISR')\n-\n       messages.push([\n-        `${border} ${symbol} ${\n-          pageInfo?.initialCacheControl?.revalidate\n-            ? `${item} (ISR: ${pageInfo?.initialCacheControl.revalidate} Seconds)`\n-            : item\n-        }${\n+        `${border} ${symbol} ${item}${\n           totalDuration > MIN_DURATION\n             ? ` (${getPrettyDuration(totalDuration)})`\n             : ''\n@@ -550,6 +569,12 @@ export async function printTreeView(\n               ? getPrettySize(pageInfo.totalSize, { strong: true })\n               : ''\n           : '',\n+        showRevalidate && pageInfo?.initialCacheControl\n+          ? formatRevalidate(pageInfo.initialCacheControl)\n+          : '',\n+        showExpire && pageInfo?.initialCacheControl\n+          ? formatExpire(pageInfo.initialCacheControl)\n+          : '',\n       ])\n \n       const uniqueCssFiles =\n@@ -569,6 +594,8 @@ export async function printTreeView(\n             `${contSymbol}   ${innerSymbol} ${getCleanName(file)}`,\n             typeof size === 'number' ? getPrettySize(size) : '',\n             '',\n+            '',\n+            '',\n           ])\n         })\n       }\n@@ -623,6 +650,10 @@ export async function printTreeView(\n         routes.forEach(\n           ({ route, duration, avgDuration }, index, { length }) => {\n             const innerSymbol = index === length - 1 ? '└' : '├'\n+\n+            const initialCacheControl =\n+              pageInfos.get(route)?.initialCacheControl\n+\n             messages.push([\n               `${contSymbol}   ${innerSymbol} ${route}${\n                 duration > MIN_DURATION\n@@ -635,6 +666,12 @@ export async function printTreeView(\n               }`,\n               '',\n               '',\n+              showRevalidate && initialCacheControl\n+                ? formatRevalidate(initialCacheControl)\n+                : '',\n+              showExpire && initialCacheControl\n+                ? formatExpire(initialCacheControl)\n+                : '',\n             ])\n           }\n         )\n@@ -653,6 +690,8 @@ export async function printTreeView(\n         ? getPrettySize(sharedFilesSize, { strong: true })\n         : '',\n       '',\n+      '',\n+      '',\n     ])\n     const sharedCssFiles: string[] = []\n     const sharedJsChunks = [\n@@ -686,14 +725,22 @@ export async function printTreeView(\n         return\n       }\n \n-      messages.push([`  ${innerSymbol} ${cleanName}`, getPrettySize(size), ''])\n+      messages.push([\n+        `  ${innerSymbol} ${cleanName}`,\n+        getPrettySize(size),\n+        '',\n+        '',\n+        '',\n+      ])\n     })\n \n     if (restChunkCount > 0) {\n       messages.push([\n         `  └ other shared chunks (total)`,\n         getPrettySize(restChunkSize),\n         '',\n+        '',\n+        '',\n       ])\n     }\n   }\n@@ -705,7 +752,7 @@ export async function printTreeView(\n       list: lists.app,\n     })\n \n-    messages.push(['', '', ''])\n+    messages.push(['', '', '', '', ''])\n   }\n \n   pageInfos.set('/404', {\n@@ -735,17 +782,19 @@ export async function printTreeView(\n         .map(gzipSize ? fsStatGzip : fsStat)\n     )\n \n-    messages.push(['', '', ''])\n+    messages.push(['', '', '', '', ''])\n     messages.push([\n       'ƒ Middleware',\n       getPrettySize(sum(middlewareSizes), { strong: true }),\n       '',\n+      '',\n+      '',\n     ])\n   }\n \n   print(\n     textTable(messages, {\n-      align: ['l', 'l', 'r'],\n+      align: ['l', 'r', 'r', 'r', 'r'],\n       stringLength: (str) => stripAnsi(str).length,\n     })\n   )\n@@ -766,13 +815,6 @@ export async function printTreeView(\n           '(SSG)',\n           `prerendered as static HTML (uses ${cyan(staticFunctionInfo)})`,\n         ],\n-        usedSymbols.has('ISR') && [\n-          '',\n-          '(ISR)',\n-          `incremental static regeneration (uses revalidate in ${cyan(\n-            staticFunctionInfo\n-          )})`,\n-        ],\n         usedSymbols.has('◐') && [\n           '◐',\n           '(Partial Prerender)',"
        },
        {
            "sha": "11ff33f383148115f7526d8a46afcf51c17528a2",
            "filename": "test/production/app-dir/build-output-tree-view/build-output-tree-view.test.ts",
            "status": "modified",
            "additions": 23,
            "deletions": 26,
            "changes": 49,
            "blob_url": "https://github.com/vercel/next.js/blob/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts?ref=d43fc5f69d3090c1f77b1c425715c5fe98698ba6",
            "patch": "@@ -14,37 +14,34 @@ describe('build-output-tree-view', () => {\n     beforeAll(() => next.build())\n \n     it('should show info about prerendered and dynamic routes in a tree view', async () => {\n-      // TODO: Show cache info (revalidate/expire) for app router, and use the\n-      // same for pages router instead of the ISR addendum.\n-\n       // TODO: Fix double-listing of the /ppr/[slug] fallback.\n \n       expect(getTreeView(next.cliOutput)).toMatchInlineSnapshot(`\n-       \"Route (app)                             Size    First Load JS\n-       ┌ ○ /_not-found                         N/A kB         N/A kB\n-       ├ ƒ /api                                N/A kB         N/A kB\n-       ├ ○ /api/force-static                   N/A kB         N/A kB\n-       ├ ○ /app-static                         N/A kB         N/A kB\n-       ├ ○ /cache-life                         N/A kB         N/A kB\n-       ├ ƒ /dynamic                            N/A kB         N/A kB\n-       ├ ◐ /ppr/[slug]                         N/A kB         N/A kB\n-       ├   ├ /ppr/[slug]\n-       ├   ├ /ppr/[slug]\n-       ├   ├ /ppr/days\n-       ├   └ /ppr/weeks\n-       └ ○ /revalidate                         N/A kB         N/A kB\n-       + First Load JS shared by all           N/A kB\n+       \"Route (app)                      Size  First Load JS  Revalidate  Expire\n+       ┌ ○ /_not-found                N/A kB         N/A kB\n+       ├ ƒ /api                       N/A kB         N/A kB\n+       ├ ○ /api/force-static          N/A kB         N/A kB\n+       ├ ○ /app-static                N/A kB         N/A kB\n+       ├ ○ /cache-life-custom         N/A kB         N/A kB         ≈7m     ≈2h\n+       ├ ○ /cache-life-hours          N/A kB         N/A kB          1h      1d\n+       ├ ƒ /dynamic                   N/A kB         N/A kB\n+       ├ ◐ /ppr/[slug]                N/A kB         N/A kB          1w     30d\n+       ├   ├ /ppr/[slug]                                             1w     30d\n+       ├   ├ /ppr/[slug]                                             1w     30d\n+       ├   ├ /ppr/days                                               1d      1w\n+       ├   └ /ppr/weeks                                              1w     30d\n+       └ ○ /revalidate                N/A kB         N/A kB         15m      1y\n+       + First Load JS shared by all  N/A kB\n \n-       Route (pages)                           Size    First Load JS\n-       ┌ ƒ /api/hello                          N/A kB         N/A kB\n-       ├ ● /gsp-revalidate (ISR: 300 Seconds)  N/A kB         N/A kB\n-       ├ ƒ /gssp                               N/A kB         N/A kB\n-       └ ○ /static                             N/A kB         N/A kB\n-       + First Load JS shared by all           N/A kB\n+       Route (pages)                    Size  First Load JS  Revalidate  Expire\n+       ┌ ƒ /api/hello                 N/A kB         N/A kB\n+       ├ ● /gsp-revalidate            N/A kB         N/A kB          5m      1y\n+       ├ ƒ /gssp                      N/A kB         N/A kB\n+       └ ○ /static                    N/A kB         N/A kB\n+       + First Load JS shared by all  N/A kB\n \n        ○  (Static)             prerendered as static content\n        ●  (SSG)                prerendered as static HTML (uses generateStaticParams)\n-          (ISR)                incremental static regeneration (uses revalidate in generateStaticParams)\n        ◐  (Partial Prerender)  prerendered as static HTML with dynamic server-streamed content\n        ƒ  (Dynamic)            server-rendered on demand\"\n       `)\n@@ -64,12 +61,12 @@ describe('build-output-tree-view', () => {\n \n     it('should show info about prerendered routes in a compact tree view', async () => {\n       expect(getTreeView(next.cliOutput)).toMatchInlineSnapshot(`\n-       \"Route (app)                    Size    First Load JS\n+       \"Route (app)                      Size  First Load JS\n        ┌ ○ /                          N/A kB         N/A kB\n        └ ○ /_not-found                N/A kB         N/A kB\n        + First Load JS shared by all  N/A kB\n \n-       Route (pages)                  Size    First Load JS\n+       Route (pages)                    Size  First Load JS\n        ─ ○ /static                    N/A kB         N/A kB\n        + First Load JS shared by all  N/A kB\n "
        },
        {
            "sha": "f4776c4d57d8a4e8369111b9b257a4c987677110",
            "filename": "test/production/app-dir/build-output-tree-view/fixtures/mixed/app/cache-life-custom/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Ffixtures%2Fmixed%2Fapp%2Fcache-life-custom%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Ffixtures%2Fmixed%2Fapp%2Fcache-life-custom%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Ffixtures%2Fmixed%2Fapp%2Fcache-life-custom%2Fpage.tsx?ref=d43fc5f69d3090c1f77b1c425715c5fe98698ba6",
            "patch": "@@ -0,0 +1,9 @@\n+'use cache'\n+\n+import { unstable_cacheLife } from 'next/cache'\n+\n+export default async function Page() {\n+  unstable_cacheLife({ revalidate: 412, expire: 8940 })\n+\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "47ece35cdee7ae772f9c11e3038dacb8273207f8",
            "filename": "test/production/app-dir/build-output-tree-view/fixtures/mixed/app/cache-life-hours/page.tsx",
            "status": "renamed",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Ffixtures%2Fmixed%2Fapp%2Fcache-life-hours%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/d43fc5f69d3090c1f77b1c425715c5fe98698ba6/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Ffixtures%2Fmixed%2Fapp%2Fcache-life-hours%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Ffixtures%2Fmixed%2Fapp%2Fcache-life-hours%2Fpage.tsx?ref=d43fc5f69d3090c1f77b1c425715c5fe98698ba6",
            "patch": "@@ -3,7 +3,7 @@\n import { unstable_cacheLife } from 'next/cache'\n \n export default async function Page() {\n-  unstable_cacheLife('weeks')\n+  unstable_cacheLife('hours')\n \n   return <p>hello world</p>\n }",
            "previous_filename": "test/production/app-dir/build-output-tree-view/fixtures/mixed/app/cache-life/page.tsx"
        }
    ],
    "stats": {
        "total": 214,
        "additions": 154,
        "deletions": 60
    }
}