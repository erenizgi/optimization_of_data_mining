{
    "author": "ztanner",
    "message": "[BF Cache]: skip lazyData fetch logic for inactive segments (#85142)\n\nWhen `routerBfCache` is enabled, React's Activity API renders inactive\nroute segments offscreen to enable instant back/forward navigation.\nHowever, the layout-router's lazy data fetching logic was incorrectly\ntriggering fetchServerResponse calls for these offscreen segments when\ndata was missing.\n\nThis PR adds an isActive prop to InnerLayoutRouter that tracks whether a\nsegment is currently visible via the existing `stateKey` check.",
    "sha": "fbbd5380362c0a4b247a47cbe1fdfec9413be826",
    "files": [
        {
            "sha": "b940e7c10897f41fe50f6beecd0cf960b97b645a",
            "filename": "packages/next/src/client/components/app-router.tsx",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fbbd5380362c0a4b247a47cbe1fdfec9413be826/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fbbd5380362c0a4b247a47cbe1fdfec9413be826/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fapp-router.tsx?ref=fbbd5380362c0a4b247a47cbe1fdfec9413be826",
            "patch": "@@ -437,6 +437,8 @@ function Router({\n       // Root node always has `url`\n       // Provided in AppTreeContext to ensure it can be overwritten in layout-router\n       url: canonicalUrl,\n+      // Root segment is always active\n+      isActive: true,\n     }\n   }, [tree, cache, canonicalUrl])\n "
        },
        {
            "sha": "b5f6a5bf38670cd0b2b6587310b0ed40e2f641dd",
            "filename": "packages/next/src/client/components/layout-router.tsx",
            "status": "modified",
            "additions": 45,
            "deletions": 36,
            "changes": 81,
            "blob_url": "https://github.com/vercel/next.js/blob/fbbd5380362c0a4b247a47cbe1fdfec9413be826/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/fbbd5380362c0a4b247a47cbe1fdfec9413be826/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Flayout-router.tsx?ref=fbbd5380362c0a4b247a47cbe1fdfec9413be826",
            "patch": "@@ -338,11 +338,13 @@ function InnerLayoutRouter({\n   segmentPath,\n   cacheNode,\n   url,\n+  isActive,\n }: {\n   tree: FlightRouterState\n   segmentPath: FlightSegmentPath\n   cacheNode: CacheNode\n   url: string\n+  isActive: boolean\n }) {\n   const context = useContext(GlobalLayoutRouterContext)\n   const parentNavPromises = useContext(NavigationPromisesContext)\n@@ -382,44 +384,48 @@ function InnerLayoutRouter({\n     // navigation that will be able to fulfill it. We need to fetch more from\n     // the server and patch the cache.\n \n-    // Check if there's already a pending request.\n-    let lazyData = cacheNode.lazyData\n-    if (lazyData === null) {\n-      /**\n-       * Router state with refetch marker added\n-       */\n-      // TODO-APP: remove ''\n-      const refetchTree = walkAddRefetch(['', ...segmentPath], fullTree)\n-      const includeNextUrl = hasInterceptionRouteInCurrentTree(fullTree)\n-      const navigatedAt = Date.now()\n-      cacheNode.lazyData = lazyData = fetchServerResponse(\n-        new URL(url, location.origin),\n-        {\n-          flightRouterState: refetchTree,\n-          nextUrl: includeNextUrl\n-            ? // We always send the last next-url, not the current when\n-              // performing a dynamic request. This is because we update\n-              // the next-url after a navigation, but we want the same\n-              // interception route to be matched that used the last\n-              // next-url.\n-              context.previousNextUrl || context.nextUrl\n-            : null,\n-        }\n-      ).then((serverResponse) => {\n-        startTransition(() => {\n-          dispatchAppRouterAction({\n-            type: ACTION_SERVER_PATCH,\n-            previousTree: fullTree,\n-            serverResponse,\n-            navigatedAt,\n+    // Only fetch data for the active segment. Inactive segments (rendered\n+    // offscreen for bfcache) should not trigger fetches.\n+    if (isActive) {\n+      // Check if there's already a pending request.\n+      let lazyData = cacheNode.lazyData\n+      if (lazyData === null) {\n+        /**\n+         * Router state with refetch marker added\n+         */\n+        // TODO-APP: remove ''\n+        const refetchTree = walkAddRefetch(['', ...segmentPath], fullTree)\n+        const includeNextUrl = hasInterceptionRouteInCurrentTree(fullTree)\n+        const navigatedAt = Date.now()\n+        cacheNode.lazyData = lazyData = fetchServerResponse(\n+          new URL(url, location.origin),\n+          {\n+            flightRouterState: refetchTree,\n+            nextUrl: includeNextUrl\n+              ? // We always send the last next-url, not the current when\n+                // performing a dynamic request. This is because we update\n+                // the next-url after a navigation, but we want the same\n+                // interception route to be matched that used the last\n+                // next-url.\n+                context.previousNextUrl || context.nextUrl\n+              : null,\n+          }\n+        ).then((serverResponse) => {\n+          startTransition(() => {\n+            dispatchAppRouterAction({\n+              type: ACTION_SERVER_PATCH,\n+              previousTree: fullTree,\n+              serverResponse,\n+              navigatedAt,\n+            })\n           })\n-        })\n \n-        return serverResponse\n-      })\n+          return serverResponse\n+        })\n \n-      // Suspend while waiting for lazyData to resolve\n-      use(lazyData)\n+        // Suspend while waiting for lazyData to resolve\n+        use(lazyData)\n+      }\n     }\n     // Suspend infinitely as `changeByServerResponse` will cause a different part of the tree to be rendered.\n     // A falsey `resolvedRsc` indicates missing data -- we should not commit that branch, and we need to wait for the data to arrive.\n@@ -461,6 +467,7 @@ function InnerLayoutRouter({\n \n         // TODO-APP: overriding of url for parallel routes\n         url: url,\n+        isActive: isActive,\n       }}\n     >\n       {content}\n@@ -558,7 +565,8 @@ export default function OuterLayoutRouter({\n     throw new Error('invariant expected layout router to be mounted')\n   }\n \n-  const { parentTree, parentCacheNode, parentSegmentPath, url } = context\n+  const { parentTree, parentCacheNode, parentSegmentPath, url, isActive } =\n+    context\n \n   // Get the CacheNode for this segment by reading it from the parent segment's\n   // child map.\n@@ -691,6 +699,7 @@ export default function OuterLayoutRouter({\n                       tree={tree}\n                       cacheNode={cacheNode}\n                       segmentPath={segmentPath}\n+                      isActive={isActive && stateKey === activeStateKey}\n                     />\n                     {segmentBoundaryTriggerNode}\n                   </RedirectBoundary>"
        },
        {
            "sha": "21a0793d47c21131eb2b98fdc30869b80816b348",
            "filename": "packages/next/src/shared/lib/app-router-context.shared-runtime.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/fbbd5380362c0a4b247a47cbe1fdfec9413be826/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fbbd5380362c0a4b247a47cbe1fdfec9413be826/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fshared%2Flib%2Fapp-router-context.shared-runtime.ts?ref=fbbd5380362c0a4b247a47cbe1fdfec9413be826",
            "patch": "@@ -62,6 +62,7 @@ export const LayoutRouterContext = React.createContext<{\n   parentCacheNode: CacheNode\n   parentSegmentPath: FlightSegmentPath | null\n   url: string\n+  isActive: boolean\n } | null>(null)\n \n export const GlobalLayoutRouterContext = React.createContext<{"
        },
        {
            "sha": "9410d3ede4b9d5ebec3ff4cbfb6530d66f11620d",
            "filename": "test/development/acceptance-app/hydration-error.test.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/fbbd5380362c0a4b247a47cbe1fdfec9413be826/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fbbd5380362c0a4b247a47cbe1fdfec9413be826/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts?ref=fbbd5380362c0a4b247a47cbe1fdfec9413be826",
            "patch": "@@ -457,7 +457,7 @@ describe('Error overlay for hydration errors in App router', () => {\n                <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                  <RedirectBoundary>\n                    <RedirectErrorBoundary router={{...}}>\n-                     <InnerLayoutRouter url=\"/extra-nod...\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                     <InnerLayoutRouter url=\"/extra-nod...\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]} ...>\n                        <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                          <SegmentTrieNode>\n                          <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n@@ -514,7 +514,7 @@ describe('Error overlay for hydration errors in App router', () => {\n                    <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                      <RedirectBoundary>\n                        <RedirectErrorBoundary router={{...}}>\n-                         <InnerLayoutRouter url=\"/p-under-p\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                         <InnerLayoutRouter url=\"/p-under-p\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]} ...>\n                            <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                              <SegmentTrieNode>\n                              <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n@@ -570,7 +570,7 @@ describe('Error overlay for hydration errors in App router', () => {\n                  <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                    <RedirectBoundary>\n                      <RedirectErrorBoundary router={{...}}>\n-                       <InnerLayoutRouter url=\"/div-under-p\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                       <InnerLayoutRouter url=\"/div-under-p\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]} ...>\n                          <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                            <SegmentTrieNode>\n                            <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>"
        },
        {
            "sha": "c03dfa3b5b494e24c4d9a3806de0b95e3bff9b85",
            "filename": "test/development/app-dir/hydration-error-count/hydration-error-count.test.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/fbbd5380362c0a4b247a47cbe1fdfec9413be826/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fhydration-error-count.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/fbbd5380362c0a4b247a47cbe1fdfec9413be826/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fhydration-error-count.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Fapp-dir%2Fhydration-error-count%2Fhydration-error-count.test.ts?ref=fbbd5380362c0a4b247a47cbe1fdfec9413be826",
            "patch": "@@ -72,7 +72,7 @@ describe('hydration-error-count', () => {\n                    <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                      <RedirectBoundary>\n                        <RedirectErrorBoundary router={{...}}>\n-                         <InnerLayoutRouter url=\"/html-diff\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                         <InnerLayoutRouter url=\"/html-diff\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]} ...>\n                            <SegmentViewNode type=\"page\" pagePath=\"html-diff/...\">\n                              <SegmentTrieNode>\n                              <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>"
        }
    ],
    "stats": {
        "total": 92,
        "additions": 52,
        "deletions": 40
    }
}