{
    "author": "mischnic",
    "message": "Add test for twoslash (#84267)\n\nTo be improved by better NFT....",
    "sha": "f230aa3b611ca0ba169792c7859eba9965b2c0da",
    "files": [
        {
            "sha": "276396ec76dbdeab87f399c63f1d39b28be499c8",
            "filename": "test/e2e/twoslash/app/route.js",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/f230aa3b611ca0ba169792c7859eba9965b2c0da/test%2Fe2e%2Ftwoslash%2Fapp%2Froute.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f230aa3b611ca0ba169792c7859eba9965b2c0da/test%2Fe2e%2Ftwoslash%2Fapp%2Froute.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftwoslash%2Fapp%2Froute.js?ref=f230aa3b611ca0ba169792c7859eba9965b2c0da",
            "patch": "@@ -0,0 +1,24 @@\n+import { createTwoslasher } from 'twoslash'\n+import ts from 'typescript'\n+\n+export function GET(request) {\n+  try {\n+    const options = request.nextUrl.searchParams.has('esnext')\n+      ? {\n+          target: ts.ScriptTarget.ESNext,\n+          lib: ['ESNext', 'DOM', 'esnext', 'dom', 'es2020'],\n+        }\n+      : {}\n+\n+    const code = `type X = Promise<number>;\n+'hello'.toUpperCase()`\n+    const twoslasher = createTwoslasher({\n+      compilerOptions: options,\n+    })\n+    const result = twoslasher(code)\n+\n+    return Response.json(result)\n+  } catch (e) {\n+    return Response.json({ error: e })\n+  }\n+}"
        },
        {
            "sha": "fa1edcbd20d6313eb512a970e17127284a1c14dc",
            "filename": "test/e2e/twoslash/index.test.ts",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/f230aa3b611ca0ba169792c7859eba9965b2c0da/test%2Fe2e%2Ftwoslash%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f230aa3b611ca0ba169792c7859eba9965b2c0da/test%2Fe2e%2Ftwoslash%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftwoslash%2Findex.test.ts?ref=f230aa3b611ca0ba169792c7859eba9965b2c0da",
            "patch": "@@ -0,0 +1,55 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('twoslash', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+    dependencies: {\n+      twoslash: '0.3.4',\n+    },\n+  })\n+\n+  it.each(['default', 'esnext'])(\n+    'should annotate twoslash types %s',\n+    async (mode) => {\n+      const { code, nodes, error } = JSON.parse(await next.render(`/?${mode}`))\n+      expect({ code, nodes, error }).toMatchInlineSnapshot(`\n+     {\n+       \"code\": \"type X = Promise<number>;\n+     'hello'.toUpperCase()\",\n+       \"error\": undefined,\n+       \"nodes\": [\n+         {\n+           \"character\": 5,\n+           \"length\": 1,\n+           \"line\": 0,\n+           \"start\": 5,\n+           \"target\": \"X\",\n+           \"text\": \"type X = Promise<number>\",\n+           \"type\": \"hover\",\n+         },\n+         {\n+           \"character\": 9,\n+           \"docs\": \"Represents the completion of an asynchronous operation\",\n+           \"length\": 7,\n+           \"line\": 0,\n+           \"start\": 9,\n+           \"target\": \"Promise\",\n+           \"text\": \"interface Promise<T>\",\n+           \"type\": \"hover\",\n+         },\n+         {\n+           \"character\": 8,\n+           \"docs\": \"Converts all the alphabetic characters in a string to uppercase.\",\n+           \"length\": 11,\n+           \"line\": 1,\n+           \"start\": 34,\n+           \"target\": \"toUpperCase\",\n+           \"text\": \"(method) String.toUpperCase(): string\",\n+           \"type\": \"hover\",\n+         },\n+       ],\n+     }\n+    `)\n+    }\n+  )\n+})"
        },
        {
            "sha": "241faf5446daf31a70a15b18f05beabbf2775666",
            "filename": "test/e2e/twoslash/next.config.js",
            "status": "added",
            "additions": 26,
            "deletions": 0,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/f230aa3b611ca0ba169792c7859eba9965b2c0da/test%2Fe2e%2Ftwoslash%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f230aa3b611ca0ba169792c7859eba9965b2c0da/test%2Fe2e%2Ftwoslash%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftwoslash%2Fnext.config.js?ref=f230aa3b611ca0ba169792c7859eba9965b2c0da",
            "patch": "@@ -0,0 +1,26 @@\n+const path = require('path')\n+\n+/** @type {import('next').NextConfig} */\n+const nextConfig = {\n+  // output: 'standalone',\n+\n+  // TODO ideally, all of these manual includes wouldn't be necessary. Maybe we can improve that for\n+  // Turbopack\n+  outputFileTracingIncludes: {\n+    '/': [\n+      path.relative(\n+        process.cwd(),\n+        path.resolve(\n+          require.resolve('typescript/package.json'),\n+          '..',\n+          'lib',\n+          'lib.*.d.ts'\n+        )\n+      ),\n+      './node_modules/@types/node/**',\n+    ],\n+  },\n+  serverExternalPackages: ['twoslash'],\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "a5836fba08eb56f341b9ea3e00f0fad89f5382a0",
            "filename": "test/e2e/twoslash/standalone.test.ts",
            "status": "added",
            "additions": 113,
            "deletions": 0,
            "changes": 113,
            "blob_url": "https://github.com/vercel/next.js/blob/f230aa3b611ca0ba169792c7859eba9965b2c0da/test%2Fe2e%2Ftwoslash%2Fstandalone.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f230aa3b611ca0ba169792c7859eba9965b2c0da/test%2Fe2e%2Ftwoslash%2Fstandalone.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Ftwoslash%2Fstandalone.test.ts?ref=f230aa3b611ca0ba169792c7859eba9965b2c0da",
            "patch": "@@ -0,0 +1,113 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import fs from 'fs-extra'\n+import os from 'os'\n+import path from 'path'\n+import {\n+  findPort,\n+  initNextServerScript,\n+  killApp,\n+  fetchViaHTTP,\n+} from 'next-test-utils'\n+\n+if (!(globalThis as any).isNextStart) {\n+  it('should skip for non-next start', () => {})\n+} else {\n+  describe('output: standalone with twoslash', () => {\n+    const { next, skipped } = nextTestSetup({\n+      files: __dirname,\n+      dependencies: {\n+        twoslash: '0.3.4',\n+      },\n+      skipStart: true,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    let server: any\n+    let appPort: number\n+    let tmpFolder: string\n+\n+    beforeAll(async () => {\n+      await next.patchFile(\n+        'next.config.js',\n+        (await next.readFile('next.config.js')).replace('// output', 'output')\n+      )\n+      await next.build()\n+\n+      tmpFolder = path.join(os.tmpdir(), 'next-standalone-' + Date.now())\n+      await fs.mkdirp(tmpFolder)\n+      const distFolder = path.join(tmpFolder, 'test')\n+      await fs.move(path.join(next.testDir, '.next/standalone'), distFolder)\n+      const testServer = path.join(distFolder, 'server.js')\n+      appPort = await findPort()\n+      server = await initNextServerScript(\n+        testServer,\n+        /- Local:/,\n+        {\n+          ...process.env,\n+          PORT: appPort.toString(),\n+        },\n+        undefined,\n+        {\n+          cwd: distFolder,\n+        }\n+      )\n+    })\n+\n+    afterAll(async () => {\n+      if (server) await killApp(server)\n+      if (!process.env.NEXT_TEST_SKIP_CLEANUP) {\n+        await fs.remove(tmpFolder)\n+      }\n+    })\n+\n+    it.each(['default', 'esnext'])(\n+      'should annotate twoslash types %s',\n+      async (mode) => {\n+        const { code, nodes, error } = await (\n+          await fetchViaHTTP(appPort, `/?${mode}`)\n+        ).json()\n+        expect({ code, nodes, error }).toMatchInlineSnapshot(`\n+           {\n+             \"code\": \"type X = Promise<number>;\n+           'hello'.toUpperCase()\",\n+             \"error\": undefined,\n+             \"nodes\": [\n+               {\n+                 \"character\": 5,\n+                 \"length\": 1,\n+                 \"line\": 0,\n+                 \"start\": 5,\n+                 \"target\": \"X\",\n+                 \"text\": \"type X = Promise<number>\",\n+                 \"type\": \"hover\",\n+               },\n+               {\n+                 \"character\": 9,\n+                 \"docs\": \"Represents the completion of an asynchronous operation\",\n+                 \"length\": 7,\n+                 \"line\": 0,\n+                 \"start\": 9,\n+                 \"target\": \"Promise\",\n+                 \"text\": \"interface Promise<T>\",\n+                 \"type\": \"hover\",\n+               },\n+               {\n+                 \"character\": 8,\n+                 \"docs\": \"Converts all the alphabetic characters in a string to uppercase.\",\n+                 \"length\": 11,\n+                 \"line\": 1,\n+                 \"start\": 34,\n+                 \"target\": \"toUpperCase\",\n+                 \"text\": \"(method) String.toUpperCase(): string\",\n+                 \"type\": \"hover\",\n+               },\n+             ],\n+           }\n+          `)\n+      }\n+    )\n+  })\n+}"
        }
    ],
    "stats": {
        "total": 218,
        "additions": 218,
        "deletions": 0
    }
}