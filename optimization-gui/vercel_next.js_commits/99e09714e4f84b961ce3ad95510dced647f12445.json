{
    "author": "ztanner",
    "message": "CI: use KV for test timing data (#83745)\n\nNext.js tests are grouped based on timing data to better distribute them\nfor parallelization.\n\nPreviously this relied on a gist file that we would write to in CI.\nHowever, this has more recently started resulting in 401s.\n\nThe actual reason for the 401s is the Turbo task wasn't propagating the\nrequired environment variable to the task. It was mostly working by\naccident, because we would store timing data on disk for the runner,\nwhich would have been satisfied by a job that ran before it.\n\nHowever despite that, relying on a gist file to read/write timing data\ndidn't feel like the write abstraction. I decided to refactor it to use\nKV instead.\n\nThis also makes the handling more resilient to missing timing data. We\nshouldn't fail the build if we can't fetch timings, as there's already\nhandling to fallback to round robin.",
    "sha": "99e09714e4f84b961ce3ad95510dced647f12445",
    "files": [
        {
            "sha": "1a3914638776639a11f43f98fdf7cc40eb0bd927",
            "filename": ".github/workflows/build_reusable.yml",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/99e09714e4f84b961ce3ad95510dced647f12445/.github%2Fworkflows%2Fbuild_reusable.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/99e09714e4f84b961ce3ad95510dced647f12445/.github%2Fworkflows%2Fbuild_reusable.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fbuild_reusable.yml?ref=99e09714e4f84b961ce3ad95510dced647f12445",
            "patch": "@@ -100,7 +100,9 @@ env:\n   DATADOG_API_KEY: ${{ secrets.DATA_DOG_API_KEY }}\n   NEXT_JUNIT_TEST_REPORT: 'true'\n   DD_ENV: 'ci'\n-  TEST_TIMINGS_TOKEN: ${{ secrets.TEST_TIMINGS_TOKEN }}\n+  # Vercel KV Store for test timings\n+  KV_REST_API_URL: ${{ secrets.KV_REST_API_URL }}\n+  KV_REST_API_TOKEN: ${{ secrets.KV_REST_API_TOKEN }}\n   NEXT_TEST_JOB: 1\n   VERCEL_TEST_TOKEN: ${{ secrets.VERCEL_TEST_TOKEN }}\n   VERCEL_TEST_TEAM: vtest314-next-e2e-tests"
        },
        {
            "sha": "3b3afeee5da3b37f8ca91719a30514de0059bfe5",
            "filename": ".github/workflows/pull_request_stats.yml",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/99e09714e4f84b961ce3ad95510dced647f12445/.github%2Fworkflows%2Fpull_request_stats.yml",
            "raw_url": "https://github.com/vercel/next.js/raw/99e09714e4f84b961ce3ad95510dced647f12445/.github%2Fworkflows%2Fpull_request_stats.yml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/.github%2Fworkflows%2Fpull_request_stats.yml?ref=99e09714e4f84b961ce3ad95510dced647f12445",
            "patch": "@@ -16,7 +16,9 @@ env:\n   # we build a dev binary for use in CI so skip downloading\n   # canary next-swc binaries in the monorepo\n   NEXT_SKIP_NATIVE_POSTINSTALL: 1\n-  TEST_TIMINGS_TOKEN: ${{ secrets.TEST_TIMINGS_TOKEN }}\n+  # Vercel KV Store for test timings\n+  KV_REST_API_URL: ${{ secrets.KV_REST_API_URL }}\n+  KV_REST_API_TOKEN: ${{ secrets.KV_REST_API_TOKEN }}\n   NEXT_TEST_JOB: 1\n   NEXT_DISABLE_SWC_WASM: 1\n "
        },
        {
            "sha": "6c672e329053f884ecb119ba23d5d3caa9f4a205",
            "filename": "package.json",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/99e09714e4f84b961ce3ad95510dced647f12445/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/99e09714e4f84b961ce3ad95510dced647f12445/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=99e09714e4f84b961ce3ad95510dced647f12445",
            "patch": "@@ -152,7 +152,7 @@\n     \"@typescript-eslint/eslint-plugin\": \"^8.36.0\",\n     \"@typescript-eslint/parser\": \"^8.36.0\",\n     \"@vercel/devlow-bench\": \"workspace:*\",\n-    \"@vercel/fetch\": \"6.1.1\",\n+    \"@vercel/kv\": \"3.0.0\",\n     \"@vercel/og\": \"0.7.2\",\n     \"abort-controller\": \"3.0.0\",\n     \"alex\": \"9.1.0\","
        },
        {
            "sha": "5080543b43778433fc36a91c4cac45e1a77d67ba",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 20,
            "deletions": 75,
            "changes": 95,
            "blob_url": "https://github.com/vercel/next.js/blob/99e09714e4f84b961ce3ad95510dced647f12445/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/99e09714e4f84b961ce3ad95510dced647f12445/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=99e09714e4f84b961ce3ad95510dced647f12445",
            "patch": "@@ -225,9 +225,9 @@ importers:\n       '@vercel/devlow-bench':\n         specifier: workspace:*\n         version: link:turbopack/packages/devlow-bench\n-      '@vercel/fetch':\n-        specifier: 6.1.1\n-        version: 6.1.1(@types/node-fetch@2.6.1)(node-fetch@2.6.7(encoding@0.1.13))\n+      '@vercel/kv':\n+        specifier: 3.0.0\n+        version: 3.0.0\n       '@vercel/og':\n         specifier: 0.7.2\n         version: 0.7.2\n@@ -5463,9 +5463,6 @@ packages:\n   '@types/aria-query@5.0.1':\n     resolution: {integrity: sha512-XTIieEY+gvJ39ChLcB4If5zHtPxt3Syj5rgZR+e1ctpmK8NjPf0zFqsz4JpLJT0xla9GFDKjy8Cpu331nrmE1Q==}\n \n-  '@types/async-retry@1.2.1':\n-    resolution: {integrity: sha512-yMQ6CVgICWtyFNBqJT3zqOc+TnqqEPLo4nKJNPFwcialiylil38Ie6q1ENeFTjvaLOkVim9K5LisHgAKJWidGQ==}\n-\n   '@types/async-retry@1.4.2':\n     resolution: {integrity: sha512-GUDuJURF0YiJZ+CBjNQA0+vbP/VHlJbB0sFqkzsV7EcOPRfurVonXpXKAt3w8qIjM1TEzpz6hc6POocPvHOS3w==}\n \n@@ -5686,9 +5683,6 @@ packages:\n   '@types/long@4.0.1':\n     resolution: {integrity: sha512-5tXH6Bx/kNGd3MgffdmP4dy2Z+G4eaXw0SE81Tq3BNadtnMR5/ySMzX4SLEzHJzSmPNn4HIdpQsBvXMUykr58w==}\n \n-  '@types/lru-cache@4.1.1':\n-    resolution: {integrity: sha512-8mNEUG6diOrI6pMqOHrHPDBB1JsrpedeMK9AWGzVCQ7StRRribiT9BRvUmF8aUws9iBbVlgVekOT5Sgzc1MTKw==}\n-\n   '@types/mdast@3.0.10':\n     resolution: {integrity: sha512-W864tg/Osz1+9f4lrGTZpCSO5/z4608eUp19tbozkq2HJK6i3z1kT0H9tlADXuYIb1YYOBByU4Jsqkk75q48qA==}\n \n@@ -5710,9 +5704,6 @@ packages:\n   '@types/mute-stream@0.0.4':\n     resolution: {integrity: sha512-CPM9nzrCPPJHQNA9keH9CVkVI+WR5kMa+7XEs5jcGQ0VoAGnLv242w8lIVgwAEfmE4oufJRaTc9PNLQl0ioAow==}\n \n-  '@types/node-fetch@2.3.2':\n-    resolution: {integrity: sha512-yW0EOebSsQme9yKu09XbdDfle4/SmWZMK4dfteWcSLCYNQQcF+YOv0kIrvm+9pO11/ghA4E6A+RNQqvYj4Nr3A==}\n-\n   '@types/node-fetch@2.6.1':\n     resolution: {integrity: sha512-oMqjURCaxoSIsHSr1E47QHzbmzNR5rK8McHuNb11BOM9cHcIK3Avy0s/b2JlXHoQGTYS3NsvWzV1M0iK7l0wbA==}\n \n@@ -6028,21 +6019,12 @@ packages:\n   '@ungap/structured-clone@1.2.0':\n     resolution: {integrity: sha512-zuVdFrMJiuCDQUMCzQaD6KL28MjnqqN8XnAqiEq9PNm/hCPTSGfrXCOfwj1ow4LFb/tNymJPwsNbVePc1xFqrQ==}\n \n-  '@vercel/fetch-cached-dns@2.0.2':\n-    resolution: {integrity: sha512-gDqKEV8CeY2YmCdZpP1rn3tFK1L07Vw2+HYkCK8zpRHOVGr/sP8yhBsW+C/yqGVj0i9z/rIvqIHe5emvRvxwgw==}\n-    peerDependencies:\n-      node-fetch: '*'\n+  '@upstash/redis@1.35.3':\n+    resolution: {integrity: sha512-hSjv66NOuahW3MisRGlSgoszU2uONAY2l5Qo3Sae8OT3/Tng9K+2/cBRuyPBX8egwEGcNNCF9+r0V6grNnhL+w==}\n \n-  '@vercel/fetch-retry@5.0.3':\n-    resolution: {integrity: sha512-DIIoBY92r+sQ6iHSf5WjKiYvkdsDIMPWKYATlE0KcUAj2RV6SZK9UWpUzBRKsofXqedOqpVjrI0IE6AWL7JRtg==}\n-    peerDependencies:\n-      node-fetch: '*'\n-\n-  '@vercel/fetch@6.1.1':\n-    resolution: {integrity: sha512-nddCkgpA0aVIqOlzh+qVlzDNcQq0cSnqefM+x6SciGI4GCvVZeaZ7WEowgX8I/HwBAq8Uj5Bdnd+r0+sYsJsig==}\n-    peerDependencies:\n-      '@types/node-fetch': '2'\n-      node-fetch: '2'\n+  '@vercel/kv@3.0.0':\n+    resolution: {integrity: sha512-pKT8fRnfyYk2MgvyB6fn6ipJPCdfZwiKDdw7vB+HL50rjboEBHDVBEcnwfkEpVSp2AjNtoaOUH7zG+bVC/rvSg==}\n+    engines: {node: '>=14.6'}\n \n   '@vercel/ncc@0.34.0':\n     resolution: {integrity: sha512-G9h5ZLBJ/V57Ou9vz5hI8pda/YQX5HQszCs3AmIus3XzsmRn/0Ptic5otD3xVST8QLKk7AMk7AqpsyQGN7MZ9A==}\n@@ -6162,9 +6144,6 @@ packages:\n   '@xtuc/long@4.2.2':\n     resolution: {integrity: sha512-NuHqBY1PB/D8xU6s/thBgOAiAP7HOYDQ32+BFZILJ8ivkUkAHQnWfn6WhL79Owj1qmUnoN/YPhktdIoucipkAQ==}\n \n-  '@zeit/dns-cached-resolve@2.1.2':\n-    resolution: {integrity: sha512-A/5gbBskKPETTBqHwvlaW1Ri2orO62yqoFoXdxna1SQ7A/lXjpWgpJ1wdY3IQEcz5LydpS4sJ8SzI2gFyyLEhg==}\n-\n   JSONStream@1.3.5:\n     resolution: {integrity: sha512-E+iruNOY8VV9s4JEbe1aNEm6MiszPRr/UfcHMz0TQh1BXSxHK+ASV1R6W4HpjBhSeS+54PIsAMCBmwD06LLsqQ==}\n     hasBin: true\n@@ -6264,10 +6243,6 @@ packages:\n     resolution: {integrity: sha512-RZNwNclF7+MS/8bDg70amg32dyeZGZxiDuQmZxKLAlQjr3jGyLx+4Kkk58UO7D2QdgFIQCovuSuZESne6RG6XQ==}\n     engines: {node: '>= 6.0.0'}\n \n-  agentkeepalive@3.4.1:\n-    resolution: {integrity: sha512-MPIwsZU9PP9kOrZpyu2042kYA8Fdt/AedQYkYXucHgF9QoD9dXVp0ypuGnHXSR0hTstBxdt85Xkh4JolYfK5wg==}\n-    engines: {node: '>= 4.0.0'}\n-\n   agentkeepalive@4.1.4:\n     resolution: {integrity: sha512-+V/rGa3EuU74H6wR04plBb7Ks10FbtUQgRj/FQOG7uUIEuaINI+AiqJR1k6t3SVNs7o7ZjIdus6706qqzVq8jQ==}\n     engines: {node: '>= 8.0.0'}\n@@ -6778,6 +6753,7 @@ packages:\n   binary-install@1.1.0:\n     resolution: {integrity: sha512-rkwNGW+3aQVSZoD0/o3mfPN6Yxh3Id0R/xzTVBVVpGNlVz8EGwusksxRlbk/A5iKTZt9zkMn3qIqmAt3vpfbzg==}\n     engines: {node: '>=10'}\n+    deprecated: Package no longer supported. Contact Support at https://www.npmjs.com/support for more info.\n \n   bindings@1.5.0:\n     resolution: {integrity: sha512-p2q/t/mhvuOj/UeLlV6566GD/guowlr0hHxClI0W9m7MWYkL1F0hLo+0Aexs9HSPCtR1SXQ0TD3MMKrXZajbiQ==}\n@@ -8867,6 +8843,7 @@ packages:\n   eslint-plugin-markdown@3.0.1:\n     resolution: {integrity: sha512-8rqoc148DWdGdmYF6WSQFT3uQ6PO7zXYgeBpHAOAakX/zpq+NvFYbDA/H7PYzHajwtmaOzAwfxyl++x0g1/N9A==}\n     engines: {node: ^12.22.0 || ^14.17.0 || >=16.0.0}\n+    deprecated: Please use @eslint/markdown instead\n     peerDependencies:\n       eslint: ^6.0.0 || ^7.0.0 || ^8.0.0\n \n@@ -13993,6 +13970,7 @@ packages:\n     engines: {node: '>=0.6.0', teleport: '>=0.2.0'}\n     deprecated: |-\n       You or someone you depend on is using Q, the JavaScript Promise library that gave JavaScript developers strong feelings about promises. They can almost certainly migrate to the native JavaScript promise now. Thank you literally everyone for joining me in this bet against the odds. Be excellent to each other.\n+\n       (For a CapTP with native promises, see @endo/eventual-send and @endo/captp)\n \n   qs@6.11.0:\n@@ -16072,6 +16050,9 @@ packages:\n   unbox-primitive@1.0.2:\n     resolution: {integrity: sha512-61pPlCD9h51VoreyJ0BReideM3MDKMKnh6+V9L08331ipq6Q8OFXZYiqP6n/tbHx4s5I9uRhcye6BrbkizkBDw==}\n \n+  uncrypto@0.1.3:\n+    resolution: {integrity: sha512-Ql87qFHB3s/De2ClA9e0gsnS6zXG27SkTiSJwjCc9MebbfapQfuPzumMIUMi38ezPZVNFcHI9sUIepeQfw8J8Q==}\n+\n   undici-types@6.19.8:\n     resolution: {integrity: sha512-ve2KP6f/JnbPBFyobGHuerC9g1FYGn/F8n1LWTwNxCEzd6IfqTwUQcNXgEtmmQ6DlRrC1hrSrBnCZPokRrDHjw==}\n \n@@ -21388,8 +21369,6 @@ snapshots:\n \n   '@types/aria-query@5.0.1': {}\n \n-  '@types/async-retry@1.2.1': {}\n-\n   '@types/async-retry@1.4.2':\n     dependencies:\n       '@types/retry': 0.12.0\n@@ -21648,8 +21627,6 @@ snapshots:\n \n   '@types/long@4.0.1': {}\n \n-  '@types/lru-cache@4.1.1': {}\n-\n   '@types/mdast@3.0.10':\n     dependencies:\n       '@types/unist': 2.0.3\n@@ -21670,10 +21647,6 @@ snapshots:\n     dependencies:\n       '@types/node': 20.17.6(patch_hash=rvl3vkomen3tospgr67bzubfyu)\n \n-  '@types/node-fetch@2.3.2':\n-    dependencies:\n-      '@types/node': 20.17.6(patch_hash=rvl3vkomen3tospgr67bzubfyu)\n-\n   '@types/node-fetch@2.6.1':\n     dependencies:\n       '@types/node': 20.17.6(patch_hash=rvl3vkomen3tospgr67bzubfyu)\n@@ -22113,31 +22086,13 @@ snapshots:\n \n   '@ungap/structured-clone@1.2.0': {}\n \n-  '@vercel/fetch-cached-dns@2.0.2(node-fetch@2.6.7(encoding@0.1.13))':\n+  '@upstash/redis@1.35.3':\n     dependencies:\n-      '@types/node-fetch': 2.3.2\n-      '@zeit/dns-cached-resolve': 2.1.2\n-      node-fetch: 2.6.7(encoding@0.1.13)\n+      uncrypto: 0.1.3\n \n-  '@vercel/fetch-retry@5.0.3(node-fetch@2.6.7(encoding@0.1.13))':\n+  '@vercel/kv@3.0.0':\n     dependencies:\n-      async-retry: 1.3.1\n-      debug: 3.2.7\n-      node-fetch: 2.6.7(encoding@0.1.13)\n-    transitivePeerDependencies:\n-      - supports-color\n-\n-  '@vercel/fetch@6.1.1(@types/node-fetch@2.6.1)(node-fetch@2.6.7(encoding@0.1.13))':\n-    dependencies:\n-      '@types/async-retry': 1.2.1\n-      '@types/node-fetch': 2.6.1\n-      '@vercel/fetch-cached-dns': 2.0.2(node-fetch@2.6.7(encoding@0.1.13))\n-      '@vercel/fetch-retry': 5.0.3(node-fetch@2.6.7(encoding@0.1.13))\n-      agentkeepalive: 3.4.1\n-      debug: 3.1.0\n-      node-fetch: 2.6.7(encoding@0.1.13)\n-    transitivePeerDependencies:\n-      - supports-color\n+      '@upstash/redis': 1.35.3\n \n   '@vercel/ncc@0.34.0': {}\n \n@@ -22331,14 +22286,6 @@ snapshots:\n \n   '@xtuc/long@4.2.2': {}\n \n-  '@zeit/dns-cached-resolve@2.1.2':\n-    dependencies:\n-      '@types/async-retry': 1.2.1\n-      '@types/lru-cache': 4.1.1\n-      '@types/node': 20.17.6(patch_hash=rvl3vkomen3tospgr67bzubfyu)\n-      async-retry: 1.2.3\n-      lru-cache: 5.1.1\n-\n   JSONStream@1.3.5:\n     dependencies:\n       jsonparse: 1.3.1\n@@ -22423,10 +22370,6 @@ snapshots:\n     transitivePeerDependencies:\n       - supports-color\n \n-  agentkeepalive@3.4.1:\n-    dependencies:\n-      humanize-ms: 1.2.1\n-\n   agentkeepalive@4.1.4:\n     dependencies:\n       debug: 4.1.1\n@@ -34731,6 +34674,8 @@ snapshots:\n       has-symbols: 1.0.3\n       which-boxed-primitive: 1.0.2\n \n+  uncrypto@0.1.3: {}\n+\n   undici-types@6.19.8: {}\n \n   undici@5.26.3:"
        },
        {
            "sha": "94437aa37c79d47f2836ccf010bec4c8f2b5ad4c",
            "filename": "run-tests.js",
            "status": "modified",
            "additions": 118,
            "deletions": 79,
            "changes": 197,
            "blob_url": "https://github.com/vercel/next.js/blob/99e09714e4f84b961ce3ad95510dced647f12445/run-tests.js",
            "raw_url": "https://github.com/vercel/next.js/raw/99e09714e4f84b961ce3ad95510dced647f12445/run-tests.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/run-tests.js?ref=99e09714e4f84b961ce3ad95510dced647f12445",
            "patch": "@@ -4,10 +4,7 @@ const path = require('path')\n const _glob = require('glob')\n const { existsSync } = require('fs')\n const fsp = require('fs/promises')\n-const nodeFetch = require('node-fetch')\n-const vercelFetch = require('@vercel/fetch')\n-// @ts-expect-error\n-const fetch = vercelFetch(nodeFetch)\n+const { createClient } = require('@vercel/kv')\n const { promisify } = require('util')\n const { Sema } = require('async-sema')\n const { spawn, exec: execOrig } = require('child_process')\n@@ -65,14 +62,47 @@ const shouldContinueTestsOnError = !!process.env.NEXT_TEST_CONTINUE_ON_ERROR\n const skipRetryTestManifest = process.env.NEXT_TEST_SKIP_RETRY_MANIFEST\n   ? require(process.env.NEXT_TEST_SKIP_RETRY_MANIFEST)\n   : []\n-const TIMINGS_API = `https://api.github.com/gists/4500dd89ae2f5d70d9aaceb191f528d1`\n-const TIMINGS_API_HEADERS = {\n-  Accept: 'application/vnd.github.v3+json',\n-  ...(process.env.TEST_TIMINGS_TOKEN\n-    ? {\n-        Authorization: `Bearer ${process.env.TEST_TIMINGS_TOKEN}`,\n+const KV_TIMINGS_KEY = 'test-timings'\n+\n+const kvClient =\n+  process.env.KV_REST_API_URL && process.env.KV_REST_API_TOKEN\n+    ? createClient({\n+        url: process.env.KV_REST_API_URL,\n+        token: process.env.KV_REST_API_TOKEN,\n+      })\n+    : null\n+\n+/**\n+ * Retry a KV operation with exponential backoff\n+ * @param {() => Promise<any>} operation - The async operation to retry\n+ * @param {string} operationName - Name of the operation for logging\n+ * @param {number} maxRetries - Maximum number of retries (default: 3)\n+ * @returns {Promise<any>} The result of the operation\n+ */\n+async function retryKVOperation(operation, operationName, maxRetries = 3) {\n+  let lastError\n+  let retries = maxRetries\n+\n+  while (retries > 0) {\n+    try {\n+      return await operation()\n+    } catch (err) {\n+      lastError = err\n+      retries--\n+      if (retries > 0) {\n+        const delay = (maxRetries - retries + 1) * 5 // 5s, 10s, 15s backoff\n+        console.log(\n+          `KV ${operationName} failed, retrying in ${delay}s. Error:`,\n+          err.message\n+        )\n+        await new Promise((resolve) => setTimeout(resolve, delay * 1000))\n       }\n-    : {}),\n+    }\n+  }\n+\n+  throw new Error(\n+    `Failed to ${operationName} after ${maxRetries} retries: ${lastError?.message}`\n+  )\n }\n \n const testFilters = {\n@@ -168,28 +198,19 @@ const isMatchingPattern = (pattern, file) => {\n }\n \n async function getTestTimings() {\n-  let timingsRes\n-\n-  const doFetch = () =>\n-    fetch(TIMINGS_API, {\n-      headers: {\n-        ...TIMINGS_API_HEADERS,\n-      },\n-    })\n-  timingsRes = await doFetch()\n-\n-  if (timingsRes.status === 403) {\n-    const delay = 15\n-    console.log(`Got 403 response waiting ${delay} seconds before retry`)\n-    await new Promise((resolve) => setTimeout(resolve, delay * 1000))\n-    timingsRes = await doFetch()\n+  if (!kvClient) {\n+    console.warn('KV client not configured, skipping timing fetch')\n+    return null\n   }\n \n-  if (!timingsRes.ok) {\n-    throw new Error(`request status: ${timingsRes.status}`)\n-  }\n-  const timingsData = await timingsRes.json()\n-  return JSON.parse(timingsData.files['test-timings.json'].content)\n+  const timings = await retryKVOperation(async () => {\n+    const data = await kvClient.get(KV_TIMINGS_KEY)\n+    if (!data) {\n+      console.log('No timing data found in KV store')\n+    }\n+    return data\n+  }, 'fetch timings')\n+  return timings || null\n }\n \n async function main() {\n@@ -243,6 +264,10 @@ async function main() {\n     process.env.NEXT_TEST_MODE\n   )\n \n+  // Only fetch/update shared timing data during grouped CI runs to avoid\n+  // individual test runs from polluting the timing data\n+  const shouldUseSharedTimings = options.timings && options.group\n+\n   /** @type TestFile[] */\n   let tests = argv._.filter((arg) =>\n     arg.toString().match(/\\.test\\.(js|ts|tsx)/)\n@@ -302,30 +327,45 @@ async function main() {\n     //\n   }\n \n-  if (options.timings && options.group) {\n+  if (shouldUseSharedTimings) {\n     console.log('Fetching previous timings data')\n+    const timingsFile = path.join(process.cwd(), 'test-timings.json')\n+\n     try {\n-      const timingsFile = path.join(process.cwd(), 'test-timings.json')\n-      try {\n-        prevTimings = JSON.parse(await fsp.readFile(timingsFile, 'utf8'))\n-        console.log('Loaded test timings from disk successfully')\n-      } catch (_) {\n-        console.error('failed to load from disk', _)\n-      }\n+      prevTimings = JSON.parse(await fsp.readFile(timingsFile, 'utf8'))\n+      console.log('Loaded test timings from disk successfully')\n+    } catch (_) {\n+      console.error(\n+        'Failed to load test timings from disk. Proceeding to fetch from KV store. Original error: ',\n+        _\n+      )\n+    }\n \n-      if (!prevTimings) {\n+    if (!prevTimings) {\n+      try {\n         prevTimings = await getTestTimings()\n-        console.log('Fetched previous timings data successfully')\n+        if (prevTimings) {\n+          console.log('Fetched previous timings data successfully from KV')\n+        } else {\n+          console.log('No previous timings data available')\n+        }\n+      } catch (kvError) {\n+        console.warn(\n+          'Failed to fetch timings from KV, continuing without timing data:',\n+          kvError.message\n+        )\n+        prevTimings = null\n+      }\n \n-        if (options.writeTimings) {\n+      if (options.writeTimings) {\n+        if (prevTimings) {\n           await fsp.writeFile(timingsFile, JSON.stringify(prevTimings))\n           console.log('Wrote previous timings data to', timingsFile)\n-          await cleanUpAndExit(0)\n+        } else {\n+          console.log('No timings data to write')\n         }\n+        await cleanUpAndExit(0)\n       }\n-    } catch (err) {\n-      console.log(`Failed to fetch timings data`, err)\n-      await cleanUpAndExit(1)\n     }\n   }\n \n@@ -389,6 +429,14 @@ async function main() {\n       // tests tend not to get clustered together\n       tests = tests.filter((_value, idx) => idx % groupTotal === groupPos - 1)\n       console.log('Splitting without timings')\n+\n+      // Warn in CI that tests are not optimally distributed\n+      if (process.env.GITHUB_ACTIONS) {\n+        core.warning(\n+          `Test timing data unavailable for group ${options.group}. Tests are being distributed round-robin, which may increase CI time. ` +\n+            `Consider checking KV store connectivity if this persists.`\n+        )\n+      }\n     }\n   }\n \n@@ -773,43 +821,34 @@ ${ENDGROUP}`)\n     // junitData += `</testsuites>`\n     // console.log('output timing data to junit.xml')\n \n-    if (prevTimings && process.env.TEST_TIMINGS_TOKEN) {\n-      try {\n-        const newTimings = {\n-          ...(await getTestTimings()),\n-          ...curTimings,\n-        }\n+    if (shouldUseSharedTimings) {\n+      if (kvClient) {\n+        try {\n+          // Fetch existing timings and merge with new ones\n+          const existingTimings = (await getTestTimings()) || {}\n+          const newTimings = {\n+            ...existingTimings,\n+            ...curTimings,\n+          }\n \n-        for (const test of Object.keys(newTimings)) {\n-          if (!existsSync(path.join(__dirname, test))) {\n-            console.log('removing stale timing', test)\n-            delete newTimings[test]\n+          // Clean up stale timings for deleted tests\n+          for (const test of Object.keys(newTimings)) {\n+            if (!existsSync(path.join(__dirname, test))) {\n+              console.log('removing stale timing', test)\n+              delete newTimings[test]\n+            }\n           }\n-        }\n \n-        const timingsRes = await fetch(TIMINGS_API, {\n-          method: 'PATCH',\n-          headers: {\n-            ...TIMINGS_API_HEADERS,\n-          },\n-          body: JSON.stringify({\n-            files: {\n-              'test-timings.json': {\n-                content: JSON.stringify(newTimings),\n-              },\n-            },\n-          }),\n-        })\n-\n-        if (!timingsRes.ok) {\n-          throw new Error(`request status: ${timingsRes.status}`)\n+          // Update KV store with retries\n+          await retryKVOperation(async () => {\n+            await kvClient.set(KV_TIMINGS_KEY, newTimings)\n+            console.log('Successfully updated test timings in KV store')\n+          }, 'update timings')\n+        } catch (err) {\n+          console.log('Failed to update timings data', err)\n         }\n-        const result = await timingsRes.json()\n-        console.log(\n-          `Sent updated timings successfully. API URL: \"${result?.url}\" HTML URL: \"${result?.html_url}\"`\n-        )\n-      } catch (err) {\n-        console.log('Failed to update timings data', err)\n+      } else {\n+        console.warn('KV client not configured, skipping timing update')\n       }\n     }\n   }"
        },
        {
            "sha": "b7d5d171d1c2bfad9eae1bf735a2c4babb1160c1",
            "filename": "turbo.json",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/99e09714e4f84b961ce3ad95510dced647f12445/turbo.json",
            "raw_url": "https://github.com/vercel/next.js/raw/99e09714e4f84b961ce3ad95510dced647f12445/turbo.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbo.json?ref=99e09714e4f84b961ce3ad95510dced647f12445",
            "patch": "@@ -23,7 +23,8 @@\n     \"//#typescript\": {},\n     \"//#get-test-timings\": {\n       \"inputs\": [\"run-tests.js\"],\n-      \"outputs\": [\"test-timings.json\"]\n+      \"outputs\": [\"test-timings.json\"],\n+      \"env\": [\"KV_REST_API_URL\", \"KV_REST_API_TOKEN\"]\n     }\n   },\n   \"ui\": \"tui\""
        }
    ],
    "stats": {
        "total": 305,
        "additions": 147,
        "deletions": 158
    }
}