{
    "author": "bgw",
    "message": "fix(turbopack): Use vergen-git2 instead of shadow-rs for napi and next-api crates to fix stale git lock files (#76773)\n\nBoth `shadow-rs` and `vergen-gitcl` call out to the git CLI, which takes optional locks to update the index: https://git-scm.com/docs/git-status#_background_refresh\n\nThis is why we sometimes find ourselves with stale `.git/index.lock` files.\n\nUsing a lightly patched version of https://github.com/martinpitt/fatrace (to look up parent process names) shows this:\n\n![Screenshot 2025-03-03 at 5.39.53â€¯PM.png](https://graphite-user-uploaded-assets-prod.s3.amazonaws.com/HAZVitxRNnZz8QMiPn4a/64a88f82-47bc-4d80-b49a-c5349e946411.png)\n\n`shadow-rs` has a `git2` feature (enabled by default), but that doesn't prevent it from running the git CLI. Instead it runs *both* and overwrites some values.\n\n`vergen-git2` only uses `libgit2` and does not invoke the CLI. This fixes things because `libgit2` disables `GIT_STATUS_OPT_UPDATE_INDEX` by default.\n\nAdditionally, after looking through both codebases, I've decided I like `vergen`'s implementation a bit more than `shadow-rs`'s.\n\nSupposedly, `git`'s command-line should support a `GIT_OPTIONAL_LOCKS=0` environment variable to disable this behavior, but I'm still finding the lock written to when trying to use that. I'm still investigating if I can use something like this to contribute a proper fix upstream to these crates.",
    "sha": "190df615aa3be3e477258a27537d4afd670b8646",
    "files": [
        {
            "sha": "413993ac2359a3ac9d8ced8a23cd07074d05da29",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 157,
            "deletions": 184,
            "changes": 341,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -868,7 +868,7 @@ dependencies = [\n  \"nom\",\n  \"serde\",\n  \"serde_json\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n ]\n \n [[package]]\n@@ -1018,7 +1018,21 @@ dependencies = [\n  \"semver 1.0.23\",\n  \"serde\",\n  \"serde_json\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n+]\n+\n+[[package]]\n+name = \"cargo_metadata\"\n+version = \"0.19.2\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"dd5eb614ed4c27c5d706420e4320fbe3216ab31fa1c33cd8246ac36dae4479ba\"\n+dependencies = [\n+ \"camino\",\n+ \"cargo-platform\",\n+ \"semver 1.0.23\",\n+ \"serde\",\n+ \"serde_json\",\n+ \"thiserror 2.0.12\",\n ]\n \n [[package]]\n@@ -1113,7 +1127,7 @@ dependencies = [\n  \"pin-project-lite\",\n  \"serde\",\n  \"serde_json\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tokio\",\n  \"tracing\",\n  \"url\",\n@@ -1393,12 +1407,6 @@ dependencies = [\n  \"syn 1.0.109\",\n ]\n \n-[[package]]\n-name = \"const_fn\"\n-version = \"0.4.9\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"fbdcdcb6d86f71c5e97409ad45898af11cbc995b4ee8112d59095a28d376c935\"\n-\n [[package]]\n name = \"const_format\"\n version = \"0.2.30\"\n@@ -1838,12 +1846,12 @@ dependencies = [\n \n [[package]]\n name = \"darling\"\n-version = \"0.20.8\"\n+version = \"0.20.10\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"54e36fcd13ed84ffdfda6f5be89b31287cbb80c439841fe69e04841435464391\"\n+checksum = \"6f63b86c8a8826a49b8c21f08a2d07338eec8d900540f8630dc76284be802989\"\n dependencies = [\n- \"darling_core 0.20.8\",\n- \"darling_macro 0.20.8\",\n+ \"darling_core 0.20.10\",\n+ \"darling_macro 0.20.10\",\n ]\n \n [[package]]\n@@ -1862,15 +1870,15 @@ dependencies = [\n \n [[package]]\n name = \"darling_core\"\n-version = \"0.20.8\"\n+version = \"0.20.10\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"9c2cf1c23a687a1feeb728783b993c4e1ad83d99f351801977dd809b48d0a70f\"\n+checksum = \"95133861a8032aaea082871032f5815eb9e98cef03fa916ab4500513994df9e5\"\n dependencies = [\n  \"fnv\",\n  \"ident_case\",\n  \"proc-macro2\",\n  \"quote\",\n- \"strsim 0.10.0\",\n+ \"strsim 0.11.1\",\n  \"syn 2.0.95\",\n ]\n \n@@ -1887,11 +1895,11 @@ dependencies = [\n \n [[package]]\n name = \"darling_macro\"\n-version = \"0.20.8\"\n+version = \"0.20.10\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"a668eda54683121533a393014d8692171709ff57a7d61f187b6e782719f8933f\"\n+checksum = \"d336a2a514f6ccccaa3e09b02d41d35330c07ddf03a62165fcec10bb561c7806\"\n dependencies = [\n- \"darling_core 0.20.8\",\n+ \"darling_core 0.20.10\",\n  \"quote\",\n  \"syn 2.0.95\",\n ]\n@@ -1980,11 +1988,11 @@ dependencies = [\n \n [[package]]\n name = \"derive_builder\"\n-version = \"0.20.1\"\n+version = \"0.20.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"cd33f37ee6a119146a1781d3356a7c26028f83d779b2e04ecd45fdc75c76877b\"\n+checksum = \"507dfb09ea8b7fa618fcf76e953f4f5e192547945816d5358edffe39f6f94947\"\n dependencies = [\n- \"derive_builder_macro 0.20.1\",\n+ \"derive_builder_macro 0.20.2\",\n ]\n \n [[package]]\n@@ -2001,11 +2009,11 @@ dependencies = [\n \n [[package]]\n name = \"derive_builder_core\"\n-version = \"0.20.1\"\n+version = \"0.20.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"7431fa049613920234f22c47fdc33e6cf3ee83067091ea4277a3f8c4587aae38\"\n+checksum = \"2d5bcf7b024d6835cfb3d473887cd966994907effbe9227e8c8219824d06c4e8\"\n dependencies = [\n- \"darling 0.20.8\",\n+ \"darling 0.20.10\",\n  \"proc-macro2\",\n  \"quote\",\n  \"syn 2.0.95\",\n@@ -2023,11 +2031,11 @@ dependencies = [\n \n [[package]]\n name = \"derive_builder_macro\"\n-version = \"0.20.1\"\n+version = \"0.20.2\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"4abae7035bf79b9877b779505d8cf3749285b80c43941eda66604841889451dc\"\n+checksum = \"ab63b0e2bf4d5928aff72e83a7dace85d7bba5fe12dcc3c5a572d78caffd3f3c\"\n dependencies = [\n- \"derive_builder_core 0.20.1\",\n+ \"derive_builder_core 0.20.2\",\n  \"syn 2.0.95\",\n ]\n \n@@ -2194,16 +2202,7 @@ version = \"0.7.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"4eeac5c5edb79e4e39fe8439ef35207780a11f69c52cbe424ce3dfad4cb78de6\"\n dependencies = [\n- \"enum-iterator-derive 0.7.0\",\n-]\n-\n-[[package]]\n-name = \"enum-iterator\"\n-version = \"1.4.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"7add3873b5dd076766ee79c8e406ad1a472c385476b9e38849f8eec24f1be689\"\n-dependencies = [\n- \"enum-iterator-derive 1.2.1\",\n+ \"enum-iterator-derive\",\n ]\n \n [[package]]\n@@ -2217,17 +2216,6 @@ dependencies = [\n  \"syn 1.0.109\",\n ]\n \n-[[package]]\n-name = \"enum-iterator-derive\"\n-version = \"1.2.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"eecf8589574ce9b895052fa12d69af7a233f99e6107f5cb8dd1044f2a17bfdcb\"\n-dependencies = [\n- \"proc-macro2\",\n- \"quote\",\n- \"syn 2.0.95\",\n-]\n-\n [[package]]\n name = \"enumset\"\n version = \"1.1.2\"\n@@ -2243,7 +2231,7 @@ version = \"0.8.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"e08b6c6ab82d70f08844964ba10c7babb716de2ecaeab9be5717918a5177d3af\"\n dependencies = [\n- \"darling 0.20.8\",\n+ \"darling 0.20.10\",\n  \"proc-macro2\",\n  \"quote\",\n  \"syn 2.0.95\",\n@@ -2603,18 +2591,6 @@ dependencies = [\n  \"wasm-bindgen\",\n ]\n \n-[[package]]\n-name = \"getset\"\n-version = \"0.1.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"e45727250e75cc04ff2846a66397da8ef2b3db8e40e0cef4df67950a07621eb9\"\n-dependencies = [\n- \"proc-macro-error\",\n- \"proc-macro2\",\n- \"quote\",\n- \"syn 1.0.109\",\n-]\n-\n [[package]]\n name = \"gif\"\n version = \"0.13.1\"\n@@ -2642,6 +2618,19 @@ dependencies = [\n  \"stable_deref_trait\",\n ]\n \n+[[package]]\n+name = \"git2\"\n+version = \"0.20.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"3fda788993cc341f69012feba8bf45c0ba4f3291fcc08e214b4d5a7332d88aff\"\n+dependencies = [\n+ \"bitflags 2.5.0\",\n+ \"libc\",\n+ \"libgit2-sys\",\n+ \"log\",\n+ \"url\",\n+]\n+\n [[package]]\n name = \"glob\"\n version = \"0.3.1\"\n@@ -2657,8 +2646,8 @@ dependencies = [\n  \"aho-corasick\",\n  \"bstr\",\n  \"log\",\n- \"regex-automata 0.4.6\",\n- \"regex-syntax 0.8.3\",\n+ \"regex-automata 0.4.9\",\n+ \"regex-syntax 0.8.5\",\n ]\n \n [[package]]\n@@ -2738,7 +2727,7 @@ dependencies = [\n  \"pest_derive\",\n  \"serde\",\n  \"serde_json\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n ]\n \n [[package]]\n@@ -3275,7 +3264,7 @@ dependencies = [\n  \"globset\",\n  \"log\",\n  \"memchr\",\n- \"regex-automata 0.4.6\",\n+ \"regex-automata 0.4.9\",\n  \"same-file\",\n  \"walkdir\",\n  \"winapi-util\",\n@@ -3307,7 +3296,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"ba6107a25f04af48ceeb4093eebc9b405ee5a1813a0bab5ecf1805d3eabb3337\"\n dependencies = [\n  \"byteorder\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n ]\n \n [[package]]\n@@ -3395,7 +3384,7 @@ dependencies = [\n  \"dyn-clone\",\n  \"lazy_static\",\n  \"newline-converter\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"unicode-segmentation\",\n  \"unicode-width\",\n ]\n@@ -3483,12 +3472,6 @@ dependencies = [\n  \"windows-sys 0.52.0\",\n ]\n \n-[[package]]\n-name = \"is_debug\"\n-version = \"1.0.2\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"e8ea828c9d6638a5bd3d8b14e37502b4d56cae910ccf8a5b7f51c7a0eb1d0508\"\n-\n [[package]]\n name = \"isahc\"\n version = \"1.7.2\"\n@@ -3560,7 +3543,7 @@ dependencies = [\n  \"combine\",\n  \"jni-sys\",\n  \"log\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"walkdir\",\n  \"windows-sys 0.45.0\",\n ]\n@@ -3773,6 +3756,18 @@ dependencies = [\n  \"once_cell\",\n ]\n \n+[[package]]\n+name = \"libgit2-sys\"\n+version = \"0.18.0+1.9.0\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"e1a117465e7e1597e8febea8bb0c410f1c7fb93b1e1cddf34363f8390367ffec\"\n+dependencies = [\n+ \"cc\",\n+ \"libc\",\n+ \"libz-sys\",\n+ \"pkg-config\",\n+]\n+\n [[package]]\n name = \"libloading\"\n version = \"0.8.1\"\n@@ -4163,7 +4158,7 @@ dependencies = [\n  \"miette-derive\",\n  \"owo-colors 4.0.0\",\n  \"textwrap\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"unicode-width\",\n ]\n \n@@ -4427,7 +4422,6 @@ dependencies = [\n  \"rustc-hash 2.1.0\",\n  \"serde\",\n  \"serde_json\",\n- \"shadow-rs\",\n  \"swc_core 16.0.0\",\n  \"tracing\",\n  \"turbo-rcstr\",\n@@ -4445,6 +4439,7 @@ dependencies = [\n  \"turbopack-env\",\n  \"turbopack-node\",\n  \"turbopack-nodejs\",\n+ \"vergen\",\n ]\n \n [[package]]\n@@ -4454,7 +4449,6 @@ dependencies = [\n  \"next-core\",\n  \"turbo-tasks-build\",\n  \"turbopack-core\",\n- \"vergen 7.5.1\",\n ]\n \n [[package]]\n@@ -4519,7 +4513,7 @@ dependencies = [\n  \"serde_json\",\n  \"swc_core 16.0.0\",\n  \"swc_relay\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tracing\",\n  \"turbo-rcstr\",\n  \"turbo-tasks\",\n@@ -4608,7 +4602,6 @@ dependencies = [\n  \"rustc-hash 2.1.0\",\n  \"serde\",\n  \"serde_json\",\n- \"shadow-rs\",\n  \"swc_core 16.0.0\",\n  \"tokio\",\n  \"tracing\",\n@@ -4629,6 +4622,7 @@ dependencies = [\n  \"turbopack-trace-utils\",\n  \"url\",\n  \"urlencoding\",\n+ \"vergen-git2\",\n ]\n \n [[package]]\n@@ -5077,7 +5071,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"311fb059dee1a7b802f036316d790138c613a4e8b180c822e3925a662e9f0c95\"\n dependencies = [\n  \"memchr\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"ucd-trie\",\n ]\n \n@@ -5702,7 +5696,7 @@ dependencies = [\n  \"rand_chacha\",\n  \"simd_helpers\",\n  \"system-deps\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"v_frame\",\n  \"wasm-bindgen\",\n ]\n@@ -5805,14 +5799,14 @@ dependencies = [\n \n [[package]]\n name = \"regex\"\n-version = \"1.10.6\"\n+version = \"1.11.1\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"4219d74c6b67a3654a9fbebc4b419e22126d13d2f3c4a07ee0cb61ff79a79619\"\n+checksum = \"b544ef1b4eac5dc2db33ea63606ae9ffcfac26c1416a2806ae0bf5f56b201191\"\n dependencies = [\n  \"aho-corasick\",\n  \"memchr\",\n- \"regex-automata 0.4.6\",\n- \"regex-syntax 0.8.3\",\n+ \"regex-automata 0.4.9\",\n+ \"regex-syntax 0.8.5\",\n ]\n \n [[package]]\n@@ -5826,13 +5820,13 @@ dependencies = [\n \n [[package]]\n name = \"regex-automata\"\n-version = \"0.4.6\"\n+version = \"0.4.9\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"86b83b8b9847f9bf95ef68afb0b8e6cdb80f498442f5179a29fad448fcc1eaea\"\n+checksum = \"809e8dc61f6de73b46c85f4c96486310fe304c434cfa43669d7b40f711150908\"\n dependencies = [\n  \"aho-corasick\",\n  \"memchr\",\n- \"regex-syntax 0.8.3\",\n+ \"regex-syntax 0.8.5\",\n ]\n \n [[package]]\n@@ -5843,9 +5837,9 @@ checksum = \"f162c6dd7b008981e4d40210aca20b4bd0f9b60ca9271061b07f78537722f2e1\"\n \n [[package]]\n name = \"regex-syntax\"\n-version = \"0.8.3\"\n+version = \"0.8.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"adad44e29e4c806119491a7f06f03de4d1af22c3a680dd47f1e6e179439d1f56\"\n+checksum = \"2b15c43186be67a4fd63bee50d0303afffcef381492ebe2c5d87f324e1b8815c\"\n \n [[package]]\n name = \"region\"\n@@ -6210,9 +6204,9 @@ dependencies = [\n \n [[package]]\n name = \"rustversion\"\n-version = \"1.0.17\"\n+version = \"1.0.19\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"955d28af4278de8121b7ebeb796b6a45735dc01436d898801014aced2773a3d6\"\n+checksum = \"f7c45b9784283f1b2e7fb61b42047c2fd678ef0960d4f6f1eba131594cc369d4\"\n \n [[package]]\n name = \"rusty_pool\"\n@@ -6474,7 +6468,7 @@ checksum = \"cd34f36fe4c5ba9654417139a9b3a20d2e1de6012ee678ad14d240c22c78d8d6\"\n dependencies = [\n  \"percent-encoding\",\n  \"serde\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n ]\n \n [[package]]\n@@ -6552,7 +6546,7 @@ version = \"3.12.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"8d00caa5193a3c8362ac2b73be6b9e768aa5a4b2f721d8f4b339600c3cb51f8e\"\n dependencies = [\n- \"darling 0.20.8\",\n+ \"darling 0.20.10\",\n  \"proc-macro2\",\n  \"quote\",\n  \"syn 2.0.95\",\n@@ -6595,18 +6589,6 @@ dependencies = [\n  \"digest\",\n ]\n \n-[[package]]\n-name = \"shadow-rs\"\n-version = \"0.37.0\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"974eb8222c62a8588bc0f02794dd1ba5b60b3ec88b58e050729d0907ed6af610\"\n-dependencies = [\n- \"const_format\",\n- \"is_debug\",\n- \"time\",\n- \"tzdb\",\n-]\n-\n [[package]]\n name = \"sharded-slab\"\n version = \"0.1.4\"\n@@ -7239,7 +7221,7 @@ dependencies = [\n  \"swc_ecma_parser\",\n  \"swc_ecma_transforms_base\",\n  \"swc_ecma_visit\",\n- \"vergen 9.0.1\",\n+ \"vergen\",\n ]\n \n [[package]]\n@@ -7276,7 +7258,7 @@ dependencies = [\n  \"swc_plugin_proxy\",\n  \"swc_plugin_runner\",\n  \"testing\",\n- \"vergen 9.0.1\",\n+ \"vergen\",\n ]\n \n [[package]]\n@@ -8318,7 +8300,7 @@ dependencies = [\n  \"swc_plugin_proxy\",\n  \"tokio\",\n  \"tracing\",\n- \"vergen 9.0.1\",\n+ \"vergen\",\n  \"virtual-fs 0.19.0\",\n  \"wasmer\",\n  \"wasmer-cache\",\n@@ -8390,7 +8372,7 @@ dependencies = [\n  \"swc_ecma_ast\",\n  \"swc_ecma_utils\",\n  \"swc_ecma_visit\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n ]\n \n [[package]]\n@@ -8561,7 +8543,7 @@ source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"8d32ddc0e2ebd072cbffe7424087267da990708a5bc3ae29e075904468450275\"\n dependencies = [\n  \"ansi_term\",\n- \"cargo_metadata\",\n+ \"cargo_metadata 0.18.1\",\n  \"difference\",\n  \"once_cell\",\n  \"pretty_assertions\",\n@@ -8609,7 +8591,16 @@ version = \"1.0.69\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"b6aaf5339b578ea85b50e080feb250a3e8ae8cfcdff9a461c9ec2904bc923f52\"\n dependencies = [\n- \"thiserror-impl\",\n+ \"thiserror-impl 1.0.69\",\n+]\n+\n+[[package]]\n+name = \"thiserror\"\n+version = \"2.0.12\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"567b8a2dae586314f7be2a752ec7474332959c6460e02bde30d702a66d488708\"\n+dependencies = [\n+ \"thiserror-impl 2.0.12\",\n ]\n \n [[package]]\n@@ -8623,6 +8614,17 @@ dependencies = [\n  \"syn 2.0.95\",\n ]\n \n+[[package]]\n+name = \"thiserror-impl\"\n+version = \"2.0.12\"\n+source = \"registry+https://github.com/rust-lang/crates.io-index\"\n+checksum = \"7f7cf42b4507d8ea322120659672cf1b9dbb93f8f2d4ecfd6e51350ff5b17a1d\"\n+dependencies = [\n+ \"proc-macro2\",\n+ \"quote\",\n+ \"syn 2.0.95\",\n+]\n+\n [[package]]\n name = \"thousands\"\n version = \"0.2.0\"\n@@ -8641,9 +8643,9 @@ dependencies = [\n \n [[package]]\n name = \"time\"\n-version = \"0.3.36\"\n+version = \"0.3.37\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"5dfd88e563464686c916c7e46e623e520ddc6d79fa6641390f2e3fa86e83e885\"\n+checksum = \"35e7868883861bd0e56d9ac6efcaaca0d6d5d82a2a7ec8209ff492c07cf37b21\"\n dependencies = [\n  \"deranged\",\n  \"itoa\",\n@@ -8664,9 +8666,9 @@ checksum = \"ef927ca75afb808a4d64dd374f00a2adf8d0fcff8e7b184af886c3c87ec4a3f3\"\n \n [[package]]\n name = \"time-macros\"\n-version = \"0.2.18\"\n+version = \"0.2.19\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"3f252a68540fde3a3877aeea552b832b40ab9a69e318efd078774a01ddee1ccf\"\n+checksum = \"2834e6017e3e5e4b9834939793b282bc03b37a3336245fa820e35e233e2a85de\"\n dependencies = [\n  \"num-conv\",\n  \"time-core\",\n@@ -9087,7 +9089,7 @@ dependencies = [\n  \"log\",\n  \"rand\",\n  \"sha1\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"url\",\n  \"utf-8\",\n ]\n@@ -9106,7 +9108,7 @@ dependencies = [\n  \"log\",\n  \"rand\",\n  \"sha1\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"url\",\n  \"utf-8\",\n ]\n@@ -9125,7 +9127,7 @@ dependencies = [\n  \"log\",\n  \"rand\",\n  \"sha1\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"url\",\n  \"utf-8\",\n ]\n@@ -9216,7 +9218,7 @@ dependencies = [\n  \"serde_regex\",\n  \"shrink-to-fit\",\n  \"smallvec\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tokio\",\n  \"tokio-util\",\n  \"tracing\",\n@@ -10151,35 +10153,6 @@ version = \"1.16.0\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"497961ef93d974e23eb6f433eb5fe1b7930b659f06d12dec6fc44a8f554c0bba\"\n \n-[[package]]\n-name = \"tz-rs\"\n-version = \"0.6.14\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"33851b15c848fad2cf4b105c6bb66eb9512b6f6c44a4b13f57c53c73c707e2b4\"\n-dependencies = [\n- \"const_fn\",\n-]\n-\n-[[package]]\n-name = \"tzdb\"\n-version = \"0.6.1\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"1b580f6b365fa89f5767cdb619a55d534d04a4e14c2d7e5b9a31e94598687fb1\"\n-dependencies = [\n- \"iana-time-zone\",\n- \"tz-rs\",\n- \"tzdb_data\",\n-]\n-\n-[[package]]\n-name = \"tzdb_data\"\n-version = \"0.1.3\"\n-source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"654c1ec546942ce0594e8d220e6b8e3899e0a0a8fe70ddd54d32a376dfefe3f8\"\n-dependencies = [\n- \"tz-rs\",\n-]\n-\n [[package]]\n name = \"ucd-trie\"\n version = \"0.1.6\"\n@@ -10380,42 +10353,42 @@ checksum = \"accd4ea62f7bb7a82fe23066fb0957d48ef677f6eeb8215f372f52e48bb32426\"\n \n [[package]]\n name = \"vergen\"\n-version = \"7.5.1\"\n+version = \"9.0.4\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"f21b881cd6636ece9735721cf03c1fe1e774fe258683d084bb2812ab67435749\"\n+checksum = \"e0d2f179f8075b805a43a2a21728a46f0cc2921b3c58695b28fa8817e103cd9a\"\n dependencies = [\n  \"anyhow\",\n- \"cfg-if\",\n- \"enum-iterator 1.4.1\",\n- \"getset\",\n+ \"cargo_metadata 0.19.2\",\n+ \"derive_builder 0.20.2\",\n+ \"regex\",\n  \"rustversion\",\n- \"thiserror\",\n  \"time\",\n+ \"vergen-lib\",\n ]\n \n [[package]]\n-name = \"vergen\"\n-version = \"9.0.1\"\n+name = \"vergen-git2\"\n+version = \"1.0.5\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"349ed9e45296a581f455bc18039878f409992999bc1d5da12a6800eb18c8752f\"\n+checksum = \"d86bae87104cb2790cdee615c2bb54729804d307191732ab27b1c5357ea6ddc5\"\n dependencies = [\n  \"anyhow\",\n- \"cargo_metadata\",\n- \"derive_builder 0.20.1\",\n- \"regex\",\n+ \"derive_builder 0.20.2\",\n+ \"git2\",\n  \"rustversion\",\n  \"time\",\n+ \"vergen\",\n  \"vergen-lib\",\n ]\n \n [[package]]\n name = \"vergen-lib\"\n-version = \"0.1.4\"\n+version = \"0.1.6\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n-checksum = \"229eaddb0050920816cf051e619affaf18caa3dd512de8de5839ccbc8e53abb0\"\n+checksum = \"9b07e6010c0f3e59fcb164e0163834597da68d1f864e2b8ca49f74de01e9c166\"\n dependencies = [\n  \"anyhow\",\n- \"derive_builder 0.20.1\",\n+ \"derive_builder 0.20.2\",\n  \"rustversion\",\n ]\n \n@@ -10450,7 +10423,7 @@ dependencies = [\n  \"replace_with\",\n  \"shared-buffer\",\n  \"slab\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tokio\",\n  \"tracing\",\n  \"wasmer-package 0.2.0\",\n@@ -10478,7 +10451,7 @@ dependencies = [\n  \"replace_with\",\n  \"shared-buffer\",\n  \"slab\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tokio\",\n  \"tracing\",\n  \"wasmer-package 0.4.0\",\n@@ -10496,7 +10469,7 @@ dependencies = [\n  \"mio 1.0.3\",\n  \"serde\",\n  \"socket2 0.5.8\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tracing\",\n ]\n \n@@ -10519,7 +10492,7 @@ dependencies = [\n  \"rkyv 0.8.9\",\n  \"serde\",\n  \"smoltcp\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tokio\",\n  \"tracing\",\n  \"virtual-mio\",\n@@ -10761,7 +10734,7 @@ dependencies = [\n  \"shared-buffer\",\n  \"tar\",\n  \"target-lexicon\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tracing\",\n  \"ureq\",\n  \"wasm-bindgen\",\n@@ -10782,7 +10755,7 @@ source = \"git+https://github.com/kdy1/wasmer?branch=build-deps#afedc9315eb1c7fef\n dependencies = [\n  \"blake3\",\n  \"hex\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"wasmer\",\n ]\n \n@@ -10794,7 +10767,7 @@ dependencies = [\n  \"backtrace\",\n  \"bytes\",\n  \"cfg-if\",\n- \"enum-iterator 0.7.0\",\n+ \"enum-iterator\",\n  \"enumset\",\n  \"lazy_static\",\n  \"leb128\",\n@@ -10808,7 +10781,7 @@ dependencies = [\n  \"shared-buffer\",\n  \"smallvec\",\n  \"target-lexicon\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"wasmer-types\",\n  \"wasmer-vm\",\n  \"wasmparser 0.216.0\",\n@@ -10852,7 +10825,7 @@ dependencies = [\n  \"serde\",\n  \"serde_json\",\n  \"serde_yml\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"toml 0.8.19\",\n  \"url\",\n ]\n@@ -10873,7 +10846,7 @@ dependencies = [\n  \"serde\",\n  \"serde_json\",\n  \"serde_yml\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"toml 0.8.19\",\n  \"url\",\n ]\n@@ -10906,7 +10879,7 @@ dependencies = [\n  \"rkyv 0.8.9\",\n  \"serde\",\n  \"serde_json\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tracing\",\n  \"virtual-fs 0.21.0\",\n  \"virtual-net\",\n@@ -10933,7 +10906,7 @@ dependencies = [\n  \"shared-buffer\",\n  \"tar\",\n  \"tempfile\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"toml 0.8.19\",\n  \"url\",\n  \"wasmer-config 0.10.0\",\n@@ -10958,7 +10931,7 @@ dependencies = [\n  \"shared-buffer\",\n  \"tar\",\n  \"tempfile\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"toml 0.8.19\",\n  \"url\",\n  \"wasmer-config 0.12.0\",\n@@ -10971,7 +10944,7 @@ version = \"5.0.5-rc1\"\n source = \"git+https://github.com/kdy1/wasmer?branch=build-deps#afedc9315eb1c7fefddff7a3c6ada0235e78678a\"\n dependencies = [\n  \"bytecheck 0.6.11\",\n- \"enum-iterator 0.7.0\",\n+ \"enum-iterator\",\n  \"enumset\",\n  \"getrandom\",\n  \"hex\",\n@@ -10981,7 +10954,7 @@ dependencies = [\n  \"serde\",\n  \"sha2\",\n  \"target-lexicon\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"xxhash-rust\",\n ]\n \n@@ -10996,7 +10969,7 @@ dependencies = [\n  \"corosensei\",\n  \"crossbeam-queue\",\n  \"dashmap 6.1.0\",\n- \"enum-iterator 0.7.0\",\n+ \"enum-iterator\",\n  \"fnv\",\n  \"indexmap 2.7.1\",\n  \"lazy_static\",\n@@ -11006,7 +10979,7 @@ dependencies = [\n  \"more-asserts\",\n  \"region\",\n  \"scopeguard\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"wasmer-types\",\n  \"windows-sys 0.59.0\",\n ]\n@@ -11056,7 +11029,7 @@ dependencies = [\n  \"tempfile\",\n  \"terminal_size\",\n  \"termios\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"tokio\",\n  \"tokio-stream\",\n  \"toml 0.8.19\",\n@@ -11201,7 +11174,7 @@ dependencies = [\n  \"serde_json\",\n  \"sha2\",\n  \"shared-buffer\",\n- \"thiserror\",\n+ \"thiserror 1.0.69\",\n  \"url\",\n ]\n "
        },
        {
            "sha": "c08789fe04fe323bb9c01c176d1a49cb077d2c65",
            "filename": "Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/Cargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/Cargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.toml?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -426,6 +426,8 @@ unicode-segmentation = \"1.10.1\"\n unsize = \"1.1.0\"\n url = \"2.2.2\"\n urlencoding = \"2.1.2\"\n+vergen = { version = \"9.0.4\", features = [\"cargo\"] }\n+vergen-git2 = { version = \"1.0.5\", features = [\"cargo\"] }\n webbrowser = \"0.8.7\"\n \n [patch.crates-io]"
        },
        {
            "sha": "2330a95c04cc50c2f80a957cf6299a97a87f13ee",
            "filename": "crates/napi/Cargo.toml",
            "status": "modified",
            "additions": 3,
            "deletions": 4,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2FCargo.toml?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -66,14 +66,13 @@ rand = { workspace = true }\n rustc-hash = { workspace = true }\n serde = \"1\"\n serde_json = \"1\"\n-shadow-rs = { workspace = true }\n tracing = { workspace = true }\n tracing-subscriber = { workspace = true }\n tracing-chrome = \"0.5.0\"\n url = { workspace = true }\n urlencoding = { workspace = true }\n once_cell = { workspace = true }\n-dashmap = \"6.1.0\"\n+dashmap = { workspace = true }\n \n swc_core = { workspace = true, features = [\n     \"base_concurrent\",\n@@ -139,11 +138,11 @@ turbo-tasks-malloc = { workspace = true, default-features = false }\n tokio = { workspace = true, features = [\"full\"] }\n \n [build-dependencies]\n+anyhow = { workspace = true }\n napi-build = \"2\"\n serde = { workspace = true }\n serde_json = { workspace = true }\n-# It is not a mistake this dependency is specified in dep / build-dep both.\n-shadow-rs = { workspace = true }\n+vergen-git2 = { workspace = true }\n \n # build-dependencies for the native, non-wasm32 build\n [target.'cfg(not(target_arch = \"wasm32\"))'.build-dependencies]"
        },
        {
            "sha": "802b220c2dab245b9d8f5b726047cc310f0238b0",
            "filename": "crates/napi/build.rs",
            "status": "modified",
            "additions": 44,
            "deletions": 8,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2Fbuild.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2Fbuild.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fbuild.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -1,18 +1,52 @@\n-use std::fs;\n+use std::{env, process::Command, str};\n \n extern crate napi_build;\n \n-fn main() {\n+fn main() -> anyhow::Result<()> {\n+    println!(\"cargo:rerun-if-env-changed=CI\");\n+    let is_ci = env::var(\"CI\").is_ok_and(|value| !value.is_empty());\n+\n     // Generates, stores build-time information as static values.\n     // There are some places relying on correct values for this (i.e telemetry),\n     // So failing build if this fails.\n-    shadow_rs::ShadowBuilder::builder()\n-        .build()\n-        .expect(\"Should able to generate build time information\");\n+    let cargo = vergen_git2::CargoBuilder::default()\n+        .target_triple(true)\n+        .build()?;\n+    // We use the git dirty state to disable persistent caching (persistent caching relies on a\n+    // commit hash to be safe). One tradeoff of this is that we must invalidate the rust build more\n+    // often.\n+    //\n+    // This invalidates the build if any untracked files change. That's sufficient for the case\n+    // where we transition from dirty to clean.\n+    //\n+    // There's an edge-case here where the repository could be newly dirty, but we can't know\n+    // because our build hasn't been invalidated, since the untracked files weren't untracked last\n+    // time we ran. That will cause us to incorrectly report ourselves as clean.\n+    //\n+    // However, in practice that shouldn't be much of an issue: If no other dependency of this\n+    // top-level crate has changed (which would've triggered our rebuild), then the resulting binary\n+    // must be equivalent to a clean build anyways. Therefore, persistent caching using the HEAD\n+    // commit hash as a version is okay.\n+    let git = vergen_git2::Git2Builder::default()\n+        .dirty(/* include_untracked */ true)\n+        .describe(\n+            /* tags */ true,\n+            /* dirty */ !is_ci, // suppress the dirty suffix in CI\n+            /* matches */ Some(\"v[0-9]*\"), // find the last version tag\n+        )\n+        .build()?;\n+    vergen_git2::Emitter::default()\n+        .add_instructions(&cargo)?\n+        .add_instructions(&git)?\n+        .fail_on_error()\n+        .emit()?;\n \n-    let git_head = fs::read_to_string(\"../../.git/HEAD\").unwrap_or_default();\n-    if !git_head.is_empty() && !git_head.starts_with(\"ref: \") {\n-        println!(\"cargo:warning=git version {}\", git_head);\n+    match Command::new(\"git\").args([\"rev-parse\", \"HEAD\"]).output() {\n+        Ok(out) if out.status.success() => println!(\n+            \"cargo:warning=git HEAD: {}\",\n+            str::from_utf8(&out.stdout).unwrap()\n+        ),\n+        _ => println!(\"cargo:warning=`git rev-parse HEAD` failed\"),\n     }\n \n     #[cfg(not(all(target_os = \"macos\", target_arch = \"aarch64\")))]\n@@ -36,4 +70,6 @@ fn main() {\n \n     #[cfg(not(target_arch = \"wasm32\"))]\n     turbo_tasks_build::generate_register();\n+\n+    Ok(())\n }"
        },
        {
            "sha": "c3669352803008e54b01ab619e8a04a68cf88bfd",
            "filename": "crates/napi/src/lib.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Flib.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -61,9 +61,6 @@ pub mod turbo_trace_server;\n pub mod turbopack;\n pub mod util;\n \n-// Declare build-time information variables generated in build.rs\n-shadow_rs::shadow!(build);\n-\n #[cfg(not(any(feature = \"__internal_dhat-heap\", feature = \"__internal_dhat-ad-hoc\")))]\n #[global_allocator]\n static ALLOC: turbo_tasks_malloc::TurboMalloc = turbo_tasks_malloc::TurboMalloc;"
        },
        {
            "sha": "527d440809f3645906543b4883d6e5f1c5d6cd83",
            "filename": "crates/napi/src/next_api/utils.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 21,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Futils.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -13,7 +13,8 @@ use turbo_tasks::{\n     TryJoinIterExt, TurboTasks, TurboTasksApi, UpdateInfo, Vc,\n };\n use turbo_tasks_backend::{\n-    default_backing_storage, noop_backing_storage, DefaultBackingStorage, NoopBackingStorage,\n+    default_backing_storage, noop_backing_storage, DefaultBackingStorage, GitVersionInfo,\n+    NoopBackingStorage,\n };\n use turbo_tasks_fs::FileContent;\n use turbopack_core::{\n@@ -130,26 +131,10 @@ pub fn create_turbo_tasks(\n     dependency_tracking: bool,\n ) -> Result<NextTurboTasks> {\n     Ok(if persistent_caching {\n-        let dirty_suffix = if crate::build::GIT_CLEAN\n-            || option_env!(\"CI\").is_some_and(|value| !value.is_empty())\n-        {\n-            \"\"\n-        } else {\n-            \"-dirty\"\n-        };\n-        #[allow(\n-            clippy::const_is_empty,\n-            reason = \"LAST_TAG might be empty if the tag can't be determined\"\n-        )]\n-        let version_info = if crate::build::LAST_TAG.is_empty() {\n-            format!(\"{}{}\", crate::build::SHORT_COMMIT, dirty_suffix)\n-        } else {\n-            format!(\n-                \"{}-{}{}\",\n-                crate::build::LAST_TAG,\n-                crate::build::SHORT_COMMIT,\n-                dirty_suffix\n-            )\n+        let version_info = GitVersionInfo {\n+            describe: env!(\"VERGEN_GIT_DESCRIBE\"),\n+            dirty: option_env!(\"CI\").is_none_or(|value| value.is_empty())\n+                && env!(\"VERGEN_GIT_DIRTY\") == \"true\",\n         };\n         NextTurboTasks::PersistentCaching(TurboTasks::new(\n             turbo_tasks_backend::TurboTasksBackend::new("
        },
        {
            "sha": "0cf2938ecb58cb315a7d684b8e0083a918597124",
            "filename": "crates/napi/src/util.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnapi%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Futil.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -127,8 +127,8 @@ pub fn log_internal_error_and_inform(err_info: &str) {\n }\n \n #[napi]\n-pub fn get_target_triple() -> String {\n-    crate::build::BUILD_TARGET.to_string()\n+pub fn get_target_triple() -> &'static str {\n+    env!(\"VERGEN_CARGO_TARGET_TRIPLE\")\n }\n \n pub trait MapErr<T>: Into<Result<T, anyhow::Error>> {"
        },
        {
            "sha": "5377b2cc6551bfcc884143b2cc23eacf7e5f1dce",
            "filename": "crates/next-api/Cargo.toml",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-api%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-api%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2FCargo.toml?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -24,7 +24,6 @@ regex = { workspace = true }\n rustc-hash = { workspace = true }\n serde = { workspace = true }\n serde_json = { workspace = true }\n-shadow-rs = { workspace = true }\n swc_core = { workspace = true }\n tracing = { workspace = true }\n turbo-rcstr = { workspace = true }\n@@ -43,6 +42,6 @@ turbopack-node = { workspace = true }\n turbopack-nodejs = { workspace = true }\n \n [build-dependencies]\n-# It is not a mistake this dependency is specified in dep / build-dep both.\n-shadow-rs = { workspace = true }\n+anyhow = { workspace = true }\n turbo-tasks-build = { workspace = true }\n+vergen = { workspace = true }"
        },
        {
            "sha": "6c4783fd307723d664dc82ba7a1f073149b7f0ff",
            "filename": "crates/next-api/build.rs",
            "status": "modified",
            "additions": 10,
            "deletions": 5,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-api%2Fbuild.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-api%2Fbuild.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fbuild.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -1,13 +1,18 @@\n use turbo_tasks_build::generate_register;\n \n-fn main() {\n+fn main() -> anyhow::Result<()> {\n     // Generates, stores build-time information as static values.\n     // There are some places relying on correct values for this (i.e telemetry),\n     // So failing build if this fails.\n-    shadow_rs::ShadowBuilder::builder()\n-        .build_pattern(shadow_rs::BuildPattern::Lazy)\n-        .build()\n-        .expect(\"Should able to generate build time information\");\n+    let cargo = vergen::CargoBuilder::default()\n+        .target_triple(true)\n+        .build()?;\n+    vergen::Emitter::default()\n+        .add_instructions(&cargo)?\n+        .fail_on_error()\n+        .emit()?;\n \n     generate_register();\n+\n+    Ok(())\n }"
        },
        {
            "sha": "17360fdb01d215bf79539f3ccc32dce5386d69ca",
            "filename": "crates/next-api/src/lib.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-api%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-api%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Flib.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -23,9 +23,6 @@ mod server_actions;\n mod versioned_content_map;\n mod webpack_stats;\n \n-// Declare build-time information variables generated in build.rs\n-shadow_rs::shadow!(build);\n-\n pub fn register() {\n     next_core::register();\n     turbopack_nodejs::register();"
        },
        {
            "sha": "82298f6fa7e2618d74d99f7b6e293272ac7c76fb",
            "filename": "crates/next-api/src/project.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-api%2Fsrc%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fproject.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -68,7 +68,6 @@ use turbopack_nodejs::NodeJsChunkingContext;\n \n use crate::{\n     app::{AppProject, OptionAppProject, ECMASCRIPT_CLIENT_TRANSITION_NAME},\n-    build,\n     empty::EmptyEndpoint,\n     entrypoints::Entrypoints,\n     instrumentation::InstrumentationEndpoint,\n@@ -1069,7 +1068,7 @@ impl Project {\n         // First, emit an event for the binary target triple.\n         // This is different to webpack-config; when this is being called,\n         // it is always using SWC so we don't check swc here.\n-        emit_event(build::BUILD_TARGET, true);\n+        emit_event(env!(\"VERGEN_CARGO_TARGET_TRIPLE\"), true);\n \n         // Go over jsconfig and report enabled features.\n         let compiler_options = self.js_config().compiler_options().await?;"
        },
        {
            "sha": "7b57ede7fb42477552e5eb3ae54e409d051a8570",
            "filename": "crates/next-build/Cargo.toml",
            "status": "modified",
            "additions": 0,
            "deletions": 20,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-build%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-build%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-build%2FCargo.toml?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -16,25 +16,5 @@ workspace = true\n next-core = { workspace = true }\n turbopack-core = { workspace = true }\n \n-#turbopack-binding = { workspace = true, features = [\n-#  \"__turbo_tasks\",\n-#  \"__turbo_tasks_memory\",\n-#  \"__turbo_tasks_env\",\n-#  \"__turbo_tasks_fs\",\n-#  \"__turbo_tasks_memory\",\n-#  \"__turbopack\",\n-#  \"__turbopack_nodejs\",\n-#  \"__turbopack_core\",\n-#  \"__turbopack_browser\",\n-#  \"__turbopack_ecmascript\",\n-#  \"__turbopack_ecmascript_runtime\",\n-#  \"__turbopack_env\",\n-#  \"__turbopack_node\",\n-#] }\n-\n [build-dependencies]\n turbo-tasks-build = { workspace = true }\n-vergen = { version = \"7.3.2\", default-features = false, features = [\n-  \"cargo\",\n-  \"build\",\n-] }"
        },
        {
            "sha": "1673efed59cce6379c6a83d17829dfc0687e253f",
            "filename": "crates/next-build/build.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 5,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-build%2Fbuild.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/crates%2Fnext-build%2Fbuild.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-build%2Fbuild.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -1,10 +1,5 @@\n use turbo_tasks_build::generate_register;\n-use vergen::{vergen, Config};\n \n fn main() {\n     generate_register();\n-\n-    // Attempt to collect some build time env values but will skip if there are any\n-    // errors.\n-    let _ = vergen(Config::default());\n }"
        },
        {
            "sha": "50c964adf671081f00d3fcef0730c60f59fdd60b",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/db_versioning.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 10,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_versioning.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_versioning.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fdb_versioning.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -7,24 +7,31 @@ use std::{\n \n use anyhow::Result;\n \n+/// Information gathered by `vergen_git2` in the top-level binary crate and passed down. This\n+/// information must be computed in the top-level crate for cargo incremental compilation to work\n+/// correctly.\n+///\n+/// See `crates/napi/build.rs` for details.\n+pub struct GitVersionInfo<'a> {\n+    /// Output of `git describe --match 'v[0-9]' --dirty`.\n+    pub describe: &'a str,\n+    /// Is the git repository dirty? Always forced to `false` when the `CI` environment variable is\n+    /// set and non-empty.\n+    pub dirty: bool,\n+}\n+\n /// Specifies many databases that have a different version than the current one are retained.\n /// For example if MAX_OTHER_DB_VERSIONS is 2, there can be at most 3 databases in the directory,\n /// the current one and two older/newer ones.\n const MAX_OTHER_DB_VERSIONS: usize = 2;\n \n-pub fn handle_db_versioning(base_path: &Path, version_info: &str) -> Result<PathBuf> {\n+pub fn handle_db_versioning(base_path: &Path, version_info: &GitVersionInfo) -> Result<PathBuf> {\n     if let Ok(version) = env::var(\"TURBO_ENGINE_VERSION\") {\n         return Ok(base_path.join(version));\n     }\n     // Database versioning. Pass `TURBO_ENGINE_IGNORE_DIRTY` at runtime to ignore a\n     // dirty git repository. Pass `TURBO_ENGINE_DISABLE_VERSIONING` at runtime to disable\n     // versioning and always use the same database.\n-    let (version_info, git_dirty) = if let Some(version_info) = version_info.strip_suffix(\"-dirty\")\n-    {\n-        (version_info, true)\n-    } else {\n-        (version_info, false)\n-    };\n     let ignore_dirty = env::var(\"TURBO_ENGINE_IGNORE_DIRTY\").ok().is_some();\n     let disabled_versioning = env::var(\"TURBO_ENGINE_DISABLE_VERSIONING\").ok().is_some();\n     let version = if disabled_versioning {\n@@ -33,14 +40,14 @@ pub fn handle_db_versioning(base_path: &Path, version_info: &str) -> Result<Path\n              caching database might be required.\"\n         );\n         Some(\"unversioned\")\n-    } else if !git_dirty {\n-        Some(version_info)\n+    } else if !version_info.dirty {\n+        Some(version_info.describe)\n     } else if ignore_dirty {\n         println!(\n             \"WARNING: The git repository is dirty, but Persistent Caching is still enabled. \\\n              Manual removal of the persistent caching database might be required.\"\n         );\n-        Some(version_info)\n+        Some(version_info.describe)\n     } else {\n         println!(\n             \"WARNING: The git repository is dirty: Persistent Caching is disabled. Use \\"
        },
        {
            "sha": "90272bf79b1772c2c0db108ff97664a7c22a3edd",
            "filename": "turbopack/crates/turbo-tasks-backend/src/lib.rs",
            "status": "modified",
            "additions": 21,
            "deletions": 8,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Flib.rs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -15,13 +15,14 @@ use std::path::Path;\n \n use anyhow::Result;\n \n-pub use self::{\n-    backend::{BackendOptions, StorageMode, TurboTasksBackend},\n-    kv_backing_storage::KeyValueDatabaseBackingStorage,\n-};\n use crate::database::{\n     db_versioning::handle_db_versioning, noop_kv::NoopKvDb, turbo::TurboKeyValueDatabase,\n };\n+pub use crate::{\n+    backend::{BackendOptions, StorageMode, TurboTasksBackend},\n+    database::db_versioning::GitVersionInfo,\n+    kv_backing_storage::KeyValueDatabaseBackingStorage,\n+};\n \n #[cfg(feature = \"lmdb\")]\n pub type LmdbBackingStorage = KeyValueDatabaseBackingStorage<\n@@ -35,7 +36,10 @@ pub type LmdbBackingStorage = KeyValueDatabaseBackingStorage<\n >;\n \n #[cfg(feature = \"lmdb\")]\n-pub fn lmdb_backing_storage(path: &Path, version_info: &str) -> Result<LmdbBackingStorage> {\n+pub fn lmdb_backing_storage(\n+    path: &Path,\n+    version_info: &GitVersionInfo,\n+) -> Result<LmdbBackingStorage> {\n     use crate::database::{\n         fresh_db_optimization::{is_fresh, FreshDbOptimization},\n         read_transaction_cache::ReadTransactionCache,\n@@ -53,7 +57,10 @@ pub fn lmdb_backing_storage(path: &Path, version_info: &str) -> Result<LmdbBacki\n \n pub type TurboBackingStorage = KeyValueDatabaseBackingStorage<TurboKeyValueDatabase>;\n \n-pub fn turbo_backing_storage(path: &Path, version_info: &str) -> Result<TurboBackingStorage> {\n+pub fn turbo_backing_storage(\n+    path: &Path,\n+    version_info: &GitVersionInfo,\n+) -> Result<TurboBackingStorage> {\n     let path = handle_db_versioning(path, version_info)?;\n     let database = TurboKeyValueDatabase::new(path)?;\n     Ok(KeyValueDatabaseBackingStorage::new(database))\n@@ -69,14 +76,20 @@ pub fn noop_backing_storage() -> NoopBackingStorage {\n pub type DefaultBackingStorage = LmdbBackingStorage;\n \n #[cfg(feature = \"lmdb\")]\n-pub fn default_backing_storage(path: &Path, version_info: &str) -> Result<DefaultBackingStorage> {\n+pub fn default_backing_storage(\n+    path: &Path,\n+    version_info: &GitVersionInfo,\n+) -> Result<DefaultBackingStorage> {\n     lmdb_backing_storage(path, version_info)\n }\n \n #[cfg(not(feature = \"lmdb\"))]\n pub type DefaultBackingStorage = TurboBackingStorage;\n \n #[cfg(not(feature = \"lmdb\"))]\n-pub fn default_backing_storage(path: &Path, version_info: &str) -> Result<DefaultBackingStorage> {\n+pub fn default_backing_storage(\n+    path: &Path,\n+    version_info: &GitVersionInfo,\n+) -> Result<DefaultBackingStorage> {\n     turbo_backing_storage(path, version_info)\n }"
        },
        {
            "sha": "a444a1b87dc2dbe2f1d0f66856ec549173561437",
            "filename": "turbopack/crates/turbo-tasks-backend/tests/test_config.trs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/190df615aa3be3e477258a27537d4afd670b8646/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs",
            "raw_url": "https://github.com/vercel/next.js/raw/190df615aa3be3e477258a27537d4afd670b8646/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Ftests%2Ftest_config.trs?ref=190df615aa3be3e477258a27537d4afd670b8646",
            "patch": "@@ -12,7 +12,10 @@\n       turbo_tasks_backend::BackendOptions::default(),\n       turbo_tasks_backend::default_backing_storage(\n         path.as_path(),\n-        \"test\"\n+        &turbo_tasks_backend::GitVersionInfo {\n+          describe: \"test-unversioned\",\n+          dirty: false,\n+        },\n       ).unwrap()\n     )\n   )"
        }
    ],
    "stats": {
        "total": 548,
        "additions": 269,
        "deletions": 279
    }
}