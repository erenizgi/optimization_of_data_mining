{
    "author": "unstubbable",
    "message": "[test] Improve debug logs for Playwright tests (#83431)",
    "sha": "eadcd5435d82c380db0742825281270be8f71b79",
    "files": [
        {
            "sha": "ea38905c5a25c24cace4548ca13566ed802769a2",
            "filename": "run-tests.js",
            "status": "modified",
            "additions": 0,
            "deletions": 1,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/eadcd5435d82c380db0742825281270be8f71b79/run-tests.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eadcd5435d82c380db0742825281270be8f71b79/run-tests.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/run-tests.js?ref=eadcd5435d82c380db0742825281270be8f71b79",
            "patch": "@@ -463,7 +463,6 @@ ${ENDGROUP}`)\n         '--runInBand',\n         '--forceExit',\n         '--verbose',\n-        '--silent',\n         ...(isTestJob\n           ? ['--json', `--outputFile=${test.file}${RESULTS_EXT}`]\n           : []),"
        },
        {
            "sha": "af67b2ade3c872768a5f6b099ec1b6fa7bcb8c91",
            "filename": "test/lib/browsers/playwright.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/eadcd5435d82c380db0742825281270be8f71b79/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eadcd5435d82c380db0742825281270be8f71b79/test%2Flib%2Fbrowsers%2Fplaywright.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fbrowsers%2Fplaywright.ts?ref=eadcd5435d82c380db0742825281270be8f71b79",
            "patch": "@@ -1,4 +1,5 @@\n import fs from 'fs-extra'\n+import { debugPrint } from 'next-test-utils'\n import {\n   chromium,\n   webkit,\n@@ -269,7 +270,7 @@ export class Playwright<TCurrent = undefined> {\n     websocketFrames = []\n \n     page.on('console', (msg) => {\n-      console.log('browser log:', msg)\n+      debugPrint('Browser Log:', msg)\n \n       pageLogs.push(\n         Promise.all("
        },
        {
            "sha": "6ff66f48735a4addb6484ad9df2962345cbd1bf6",
            "filename": "test/lib/next-test-utils.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 5,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/eadcd5435d82c380db0742825281270be8f71b79/test%2Flib%2Fnext-test-utils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eadcd5435d82c380db0742825281270be8f71b79/test%2Flib%2Fnext-test-utils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-test-utils.ts?ref=eadcd5435d82c380db0742825281270be8f71b79",
            "patch": "@@ -6,7 +6,7 @@ import {\n   writeFileSync,\n   createReadStream,\n } from 'fs'\n-import { promisify } from 'util'\n+import { inspect, promisify } from 'util'\n import http from 'http'\n import path from 'path'\n \n@@ -41,6 +41,21 @@ export { shouldUseTurbopack }\n export const nextServer = server\n export const pkg = _pkg\n \n+// This goes straight to Nodeâ€™s stdout, avoiding Jest's verbose output:\n+export const debugPrint = (...args: unknown[]) => {\n+  const prettyArgs = args\n+    .map((arg) =>\n+      typeof arg === 'string'\n+        ? arg\n+        : inspect(arg, { colors: process.stdout.isTTY })\n+    )\n+    .join(' ')\n+\n+  const timestamp = new Date().toISOString().split('T')[1]\n+\n+  return process.stdout.write(`[${timestamp}] ${prettyArgs}\\n`)\n+}\n+\n export function initNextServerScript(\n   scriptPath: string,\n   successRegexp: RegExp,\n@@ -249,7 +264,7 @@ export function runNextCommand(\n   }\n \n   return new Promise((resolve, reject) => {\n-    console.log(`Running command \"next ${argv.join(' ')}\"`)\n+    debugPrint(`Running command \"next ${argv.join(' ')}\"`)\n     const instance = spawn(\n       'node',\n       [...(options.nodeArgs || []), '--no-deprecation', nextBin, ...argv],\n@@ -274,7 +289,7 @@ export function runNextCommand(\n         stderrOutput += chunk\n \n         if (options.stderr === 'log') {\n-          console.log(chunk.toString())\n+          debugPrint(chunk.toString())\n         }\n         if (typeof options.onStderr === 'function') {\n           options.onStderr(chunk.toString())\n@@ -293,7 +308,7 @@ export function runNextCommand(\n         stdoutOutput += chunk\n \n         if (options.stdout === 'log') {\n-          console.log(chunk.toString())\n+          debugPrint(chunk.toString())\n         }\n         if (typeof options.onStdout === 'function') {\n           options.onStdout(chunk.toString())\n@@ -820,7 +835,7 @@ export async function retry<T>(\n         )\n         throw err\n       }\n-      console.log(\n+      debugPrint(\n         `Retrying${description ? ` ${description}` : ''} in ${interval}ms`\n       )\n       await waitFor(interval)"
        },
        {
            "sha": "ee506fe9ed2079e35f0a07a4baeed6bc142277ef",
            "filename": "test/lib/next-webdriver.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/eadcd5435d82c380db0742825281270be8f71b79/test%2Flib%2Fnext-webdriver.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eadcd5435d82c380db0742825281270be8f71b79/test%2Flib%2Fnext-webdriver.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Flib%2Fnext-webdriver.ts?ref=eadcd5435d82c380db0742825281270be8f71b79",
            "patch": "@@ -1,4 +1,4 @@\n-import { getFullUrl, waitFor } from 'next-test-utils'\n+import { debugPrint, getFullUrl, waitFor } from 'next-test-utils'\n import os from 'os'\n import {\n   Playwright,\n@@ -146,7 +146,7 @@ export default async function webdriver(\n     isBrowserStack ? deviceIP : 'localhost'\n   )\n \n-  console.log(`\\n> Loading browser with ${fullUrl}\\n`)\n+  debugPrint(`Loading browser with ${fullUrl}`)\n \n   await browser.loadPage(fullUrl, {\n     disableCache,\n@@ -155,13 +155,13 @@ export default async function webdriver(\n     pushErrorAsConsoleLog,\n     waitUntil,\n   })\n-  console.log(`\\n> Loaded browser with ${fullUrl}\\n`)\n+  debugPrint(`Loaded browser with ${fullUrl}`)\n \n   browserTeardown.push(browser.close.bind(browser))\n \n   // Wait for application to hydrate\n   if (!disableJavaScript && waitHydration) {\n-    console.log(`\\n> Waiting hydration for ${fullUrl}\\n`)\n+    debugPrint(`Waiting hydration for ${fullUrl}`)\n \n     const checkHydrated = async () => {\n       await browser.eval(() => {\n@@ -207,15 +207,15 @@ export default async function webdriver(\n       }\n     }\n \n-    console.log(`\\n> Hydration complete for ${fullUrl}\\n`)\n+    debugPrint(`Hydration complete for ${fullUrl}`)\n   }\n \n   // This is a temporary workaround for turbopack starting watching too late.\n   // So we delay file changes to give it some time\n   // to connect the WebSocket and start watching.\n   // TODO: Is this still needed? Can we wait in a more useful way, like a socket connection event?\n   if (process.env.IS_TURBOPACK_TEST && process.env.TURBOPACK_DEV) {\n-    console.log(`\\n> Waiting for for turbopack watcher to start`)\n+    debugPrint(`Waiting for for turbopack watcher to start`)\n     await waitFor(1000)\n   }\n   return browser"
        }
    ],
    "stats": {
        "total": 41,
        "additions": 28,
        "deletions": 13
    }
}