{
    "author": "mischnic",
    "message": "Turbopack: port remaining NFT step (#82278)\n\nPort the remainder of `Collect build traces` from JS to Turbopack (when using Turbopack, anyway), which was the generation of the `.next/next-[minimal-]server.js.nft.json` files\n\nDepends on https://github.com/vercel/next.js/pull/82340\n\nCloses PACK-4166",
    "sha": "79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
    "files": [
        {
            "sha": "70917b4d8d02d95aa1b0632a738e5f8fdb36e1e7",
            "filename": "crates/napi/src/next_api/project.rs",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnapi%2Fsrc%2Fnext_api%2Fproject.rs?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -9,6 +9,7 @@ use napi::{\n };\n use next_api::{\n     entrypoints::Entrypoints,\n+    next_server_nft::next_server_nft_assets,\n     operation::{\n         EntrypointsOperation, InstrumentationOperation, MiddlewareOperation, OptionEndpoint,\n         RouteOperation,\n@@ -988,7 +989,14 @@ async fn output_assets_operation(\n         .flat_map(|assets| assets.iter().copied())\n         .collect();\n \n-    Ok(Vc::cell(output_assets.into_iter().collect()))\n+    let nft = next_server_nft_assets(container.project()).await?;\n+\n+    Ok(Vc::cell(\n+        output_assets\n+            .into_iter()\n+            .chain(nft.iter().copied())\n+            .collect(),\n+    ))\n }\n \n #[napi(ts_return_type = \"{ __napiType: \\\"RootTask\\\" }\")]"
        },
        {
            "sha": "84499a4a5488b8341ed1cd10c69c4ee53f4c8b95",
            "filename": "crates/next-api/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-api%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-api%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Flib.rs?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -13,6 +13,7 @@ mod instrumentation;\n mod loadable_manifest;\n mod middleware;\n mod module_graph;\n+pub mod next_server_nft;\n mod nft_json;\n pub mod operation;\n mod pages;"
        },
        {
            "sha": "f31e0534446df9e31f30c36e056a2c751ca372e8",
            "filename": "crates/next-api/src/next_server_nft.rs",
            "status": "added",
            "additions": 354,
            "deletions": 0,
            "changes": 354,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnext_server_nft.rs?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -0,0 +1,354 @@\n+use std::collections::BTreeSet;\n+\n+use anyhow::{Context, Result, bail};\n+use either::Either;\n+use next_core::{get_next_package, next_server::get_tracing_compile_time_info};\n+use serde::{Deserialize, Serialize};\n+use serde_json::{Value, json};\n+use turbo_rcstr::RcStr;\n+use turbo_tasks::{\n+    NonLocalValue, ResolvedVc, TaskInput, TryFlatJoinIterExt, TryJoinIterExt, Vc,\n+    trace::TraceRawVcs,\n+};\n+use turbo_tasks_fs::{DirectoryContent, DirectoryEntry, File, FileSystemPath, glob::Glob};\n+use turbopack::externals_tracing_module_context;\n+use turbopack_core::{\n+    asset::{Asset, AssetContent},\n+    context::AssetContext,\n+    file_source::FileSource,\n+    output::{OutputAsset, OutputAssets},\n+    reference_type::{CommonJsReferenceSubType, ReferenceType},\n+    resolve::{ExternalType, origin::PlainResolveOrigin, parse::Request},\n+    traced_asset::TracedAsset,\n+};\n+use turbopack_ecmascript::resolve::cjs_resolve;\n+\n+use crate::{\n+    nft_json::{all_assets_from_entries_filtered, relativize_glob},\n+    project::Project,\n+};\n+\n+#[derive(\n+    PartialEq, Eq, TraceRawVcs, NonLocalValue, Deserialize, Serialize, Debug, Clone, Hash, TaskInput,\n+)]\n+enum ServerNftType {\n+    Minimal,\n+    Full,\n+}\n+\n+#[turbo_tasks::function]\n+pub async fn next_server_nft_assets(project: Vc<Project>) -> Result<Vc<OutputAssets>> {\n+    Ok(Vc::cell(vec![\n+        ResolvedVc::upcast(\n+            ServerNftJsonAsset::new(project, ServerNftType::Full)\n+                .to_resolved()\n+                .await?,\n+        ),\n+        ResolvedVc::upcast(\n+            ServerNftJsonAsset::new(project, ServerNftType::Minimal)\n+                .to_resolved()\n+                .await?,\n+        ),\n+    ]))\n+}\n+\n+#[turbo_tasks::value]\n+pub struct ServerNftJsonAsset {\n+    project: ResolvedVc<Project>,\n+    ty: ServerNftType,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl ServerNftJsonAsset {\n+    #[turbo_tasks::function]\n+    pub fn new(project: ResolvedVc<Project>, ty: ServerNftType) -> Vc<Self> {\n+        ServerNftJsonAsset { project, ty }.cell()\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl OutputAsset for ServerNftJsonAsset {\n+    #[turbo_tasks::function]\n+    async fn path(&self) -> Result<Vc<FileSystemPath>> {\n+        let name = match self.ty {\n+            ServerNftType::Minimal => \"next-minimal-server.js.nft.json\",\n+            ServerNftType::Full => \"next-server.js.nft.json\",\n+        };\n+\n+        Ok(self.project.node_root().await?.join(name)?.cell())\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl Asset for ServerNftJsonAsset {\n+    #[turbo_tasks::function]\n+    async fn content(self: Vc<Self>) -> Result<Vc<AssetContent>> {\n+        let this = self.await?;\n+        // Example: [project]/apps/my-website/.next/\n+        let base_dir = this\n+            .project\n+            .project_root_path()\n+            .await?\n+            .join(&this.project.node_root().await?.path)?;\n+\n+        let mut server_output_assets =\n+            all_assets_from_entries_filtered(self.entries(), None, Some(self.ignores()))\n+                .await?\n+                .iter()\n+                .map(async |m| {\n+                    base_dir\n+                        .get_relative_path_to(&*m.path().await?)\n+                        .context(\"failed to compute relative path for server NFT JSON\")\n+                })\n+                .try_join()\n+                .await?;\n+\n+        // A few hardcoded files (not recursive)\n+        server_output_assets.push(\"./package.json\".into());\n+\n+        let next_dir = get_next_package(this.project.project_path().owned().await?).await?;\n+        for ty in [\"app-page\", \"pages\"] {\n+            let dir = next_dir.join(&format!(\"dist/server/route-modules/{ty}\"))?;\n+            let module_path = dir.join(\"module.compiled.js\")?;\n+            server_output_assets.push(\n+                base_dir\n+                    .get_relative_path_to(&module_path)\n+                    .context(\"failed to compute relative path for server NFT JSON\")?,\n+            );\n+\n+            let contexts_dir = dir.join(\"vendored/contexts\")?;\n+            let DirectoryContent::Entries(contexts_files) = &*contexts_dir.read_dir().await? else {\n+                bail!(\n+                    \"Expected contexts directory to be a directory, found: {:?}\",\n+                    contexts_dir\n+                );\n+            };\n+            for (_, entry) in contexts_files {\n+                let DirectoryEntry::File(file) = entry else {\n+                    continue;\n+                };\n+                if file.extension() == \"js\" {\n+                    server_output_assets.push(\n+                        base_dir\n+                            .get_relative_path_to(file)\n+                            .context(\"failed to compute relative path for server NFT JSON\")?,\n+                    )\n+                }\n+            }\n+        }\n+\n+        server_output_assets.sort();\n+        // Dedupe as some entries may be duplicates: a file might be referenced multiple times,\n+        // e.g. as a RawModule (from an FS operation) and as an EcmascriptModuleAsset because it\n+        // was required.\n+        server_output_assets.dedup();\n+\n+        let json = json!({\n+          \"version\": 1,\n+          \"files\": server_output_assets\n+        });\n+\n+        Ok(AssetContent::file(File::from(json.to_string()).into()))\n+    }\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl ServerNftJsonAsset {\n+    #[turbo_tasks::function]\n+    async fn entries(&self) -> Result<Vc<OutputAssets>> {\n+        let is_standalone = *self.project.next_config().is_standalone().await?;\n+\n+        let asset_context = Vc::upcast(externals_tracing_module_context(\n+            ExternalType::CommonJs,\n+            get_tracing_compile_time_info(),\n+        ));\n+\n+        let project_path = self.project.project_path().owned().await?;\n+\n+        let next_resolve_origin = Vc::upcast(PlainResolveOrigin::new(\n+            asset_context,\n+            get_next_package(project_path.clone()).await?.join(\"_\")?,\n+        ));\n+\n+        let cache_handler = self\n+            .project\n+            .next_config()\n+            .cache_handler(project_path.clone())\n+            .await?;\n+        let cache_handlers = self\n+            .project\n+            .next_config()\n+            .experimental_cache_handlers(project_path.clone())\n+            .await?;\n+\n+        // These are used by packages/next/src/server/require-hook.ts\n+        let shared_entries = [\"styled-jsx\", \"styled-jsx/style\", \"styled-jsx/style.js\"];\n+\n+        let cache_handler_entries = cache_handler\n+            .into_iter()\n+            .chain(cache_handlers.into_iter())\n+            .map(|f| {\n+                asset_context\n+                    .process(\n+                        Vc::upcast(FileSource::new(f.clone())),\n+                        ReferenceType::CommonJs(CommonJsReferenceSubType::Undefined),\n+                    )\n+                    .module()\n+            });\n+\n+        let entries = match self.ty {\n+            ServerNftType::Full => Either::Left(\n+                if is_standalone {\n+                    Either::Left(\n+                        [\n+                            \"next/dist/server/lib/start-server\",\n+                            \"next/dist/server/next\",\n+                            \"next/dist/server/require-hook\",\n+                        ]\n+                        .into_iter(),\n+                    )\n+                } else {\n+                    Either::Right(std::iter::empty())\n+                }\n+                .chain(std::iter::once(\"next/dist/server/next-server\")),\n+            ),\n+            ServerNftType::Minimal => Either::Right(std::iter::once(\n+                \"next/dist/compiled/next-server/server.runtime.prod\",\n+            )),\n+        };\n+\n+        Ok(Vc::cell(\n+            cache_handler_entries\n+                .chain(\n+                    shared_entries\n+                        .into_iter()\n+                        .chain(entries)\n+                        .map(async |path| {\n+                            Ok(cjs_resolve(\n+                                next_resolve_origin,\n+                                Request::parse_string(path.into()),\n+                                CommonJsReferenceSubType::Undefined,\n+                                None,\n+                                false,\n+                            )\n+                            .primary_modules()\n+                            .await?\n+                            .into_iter()\n+                            .map(|m| **m))\n+                        })\n+                        .try_flat_join()\n+                        .await?,\n+                )\n+                .map(|m| Vc::upcast::<Box<dyn OutputAsset>>(TracedAsset::new(m)).to_resolved())\n+                .try_join()\n+                .await?,\n+        ))\n+    }\n+\n+    #[turbo_tasks::function]\n+    async fn ignores(&self) -> Result<Vc<Glob>> {\n+        let is_standalone = *self.project.next_config().is_standalone().await?;\n+        let has_next_support = *self.project.next_config().ci_has_next_support().await?;\n+        let project_path = self.project.project_path().owned().await?;\n+\n+        let output_file_tracing_excludes = self\n+            .project\n+            .next_config()\n+            .output_file_tracing_excludes()\n+            .await?;\n+        let mut additional_ignores = BTreeSet::new();\n+        if let Some(output_file_tracing_excludes) = output_file_tracing_excludes\n+            .as_ref()\n+            .and_then(Value::as_object)\n+        {\n+            for (glob_pattern, exclude_patterns) in output_file_tracing_excludes {\n+                // Check if the route matches the glob pattern\n+                let glob = Glob::new(RcStr::from(glob_pattern.clone()), Default::default()).await?;\n+                if glob.matches(\"next-server\")\n+                    && let Some(patterns) = exclude_patterns.as_array()\n+                {\n+                    for pattern in patterns {\n+                        if let Some(pattern_str) = pattern.as_str() {\n+                            let (glob, root) = relativize_glob(pattern_str, project_path.clone())?;\n+                            let glob = if root.path.is_empty() {\n+                                glob.to_string()\n+                            } else {\n+                                format!(\"{root}/{glob}\")\n+                            };\n+                            additional_ignores.insert(glob);\n+                        }\n+                    }\n+                }\n+            }\n+        }\n+\n+        let server_ignores_glob = [\n+            \"**/node_modules/react{,-dom,-server-dom-turbopack}/**/*.development.js\",\n+            \"**/*.d.ts\",\n+            \"**/*.map\",\n+            \"**/next/dist/pages/**/*\",\n+            \"**/next/dist/compiled/next-server/**/*.dev.js\",\n+            \"**/next/dist/compiled/webpack/*\",\n+            \"**/node_modules/webpack5/**/*\",\n+            \"**/next/dist/server/lib/route-resolver*\",\n+            \"**/next/dist/compiled/semver/semver/**/*.js\",\n+            \"**/next/dist/compiled/jest-worker/**/*\",\n+            // Turbopack doesn't support AMP\n+            \"**/next/dist/compiled/@ampproject/toolbox-optimizer/**/*\",\n+            // -- The following were added for Turbopack specifically --\n+            // client/components/use-action-queue.ts has a process.env.NODE_ENV guard, but we can't set that due to React: https://github.com/vercel/next.js/pull/75254\n+            \"**/next/dist/next-devtools/userspace/use-app-dev-rendering-indicator.js\",\n+            // client/components/app-router.js has a process.env.NODE_ENV guard, but we\n+            // can't set that.\n+            \"**/next/dist/client/dev/hot-reloader/app/hot-reloader-app.js\",\n+            // server/lib/router-server.js doesn't guard this require:\n+            \"**/next/dist/server/lib/router-utils/setup-dev-bundler.js\",\n+            // server/next.js doesn't guard this require\n+            \"**/next/dist/server/dev/next-dev-server.js\",\n+            // next/dist/compiled/babel* pulls in this, but we never actually transpile at\n+            // deploy-time\n+            \"**/next/dist/compiled/browserslist/**\",\n+        ]\n+        .into_iter()\n+        .chain(additional_ignores.iter().map(|s| s.as_str()))\n+        // only ignore image-optimizer code when\n+        // this is being handled outside of next-server\n+        .chain(if has_next_support {\n+            Either::Left(\n+                [\n+                    \"**/node_modules/sharp/**/*\",\n+                    \"**/@img/sharp-libvips*/**/*\",\n+                    \"**/next/dist/server/image-optimizer.js\",\n+                ]\n+                .into_iter(),\n+            )\n+        } else {\n+            Either::Right(std::iter::empty())\n+        })\n+        .chain(if is_standalone {\n+            Either::Left(std::iter::empty())\n+        } else {\n+            Either::Right([\"**/*/next/dist/server/next.js\", \"**/*/next/dist/bin/next\"].into_iter())\n+        })\n+        .map(|g| Glob::new(g.into(), Default::default()))\n+        .collect::<Vec<_>>();\n+\n+        Ok(match self.ty {\n+            ServerNftType::Full => Glob::alternatives(server_ignores_glob),\n+            ServerNftType::Minimal => Glob::alternatives(\n+                server_ignores_glob\n+                    .into_iter()\n+                    .chain(\n+                        [\n+                            \"**/next/dist/compiled/edge-runtime/**/*\",\n+                            \"**/next/dist/server/web/sandbox/**/*\",\n+                            \"**/next/dist/server/post-process.js\",\n+                        ]\n+                        .into_iter()\n+                        .map(|g| Glob::new(g.into(), Default::default())),\n+                    )\n+                    .collect(),\n+            ),\n+        })\n+    }\n+}"
        },
        {
            "sha": "a25cfa5b97b70609e1af0b902f737c39b16a36b8",
            "filename": "crates/next-api/src/nft_json.rs",
            "status": "modified",
            "additions": 4,
            "deletions": 1,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-api%2Fsrc%2Fnft_json.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fnft_json.rs?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -350,7 +350,10 @@ impl Asset for NftJsonAsset {\n /// traversal doesn't need to consider them and can just traverse 'down' the tree.\n /// The main alternative is to merge glob evaluation with directory traversal which is what the npm\n /// `glob` package does, but this would be a substantial rewrite.`\n-fn relativize_glob(glob: &str, relative_to: FileSystemPath) -> Result<(&str, FileSystemPath)> {\n+pub(crate) fn relativize_glob(\n+    glob: &str,\n+    relative_to: FileSystemPath,\n+) -> Result<(&str, FileSystemPath)> {\n     let mut relative_to = relative_to;\n     let mut processed_glob = glob;\n     loop {"
        },
        {
            "sha": "f0a2862e2c2df7633474c6559b4741f1ad946eaa",
            "filename": "crates/next-core/src/next_client_reference/visit_client_reference.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_client_reference%2Fvisit_client_reference.rs?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -266,13 +266,13 @@ impl Visit<FindServerEntriesNode> for FindServerEntries {\n                 tracing::info_span!(\"client reference\")\n             }\n             FindServerEntriesNode::Internal(_, name) => {\n-                tracing::info_span!(\"module\", name = name.to_string())\n+                tracing::info_span!(\"module\", name = display(name))\n             }\n             FindServerEntriesNode::ServerUtilEntry(_, name) => {\n-                tracing::info_span!(\"server util\", name = name.to_string())\n+                tracing::info_span!(\"server util\", name = display(name))\n             }\n             FindServerEntriesNode::ServerComponentEntry(_, name) => {\n-                tracing::info_span!(\"layout segment\", name = name.to_string())\n+                tracing::info_span!(\"layout segment\", name = display(name))\n             }\n         }\n     }"
        },
        {
            "sha": "8c129230b6aa32c7321195f356829b755e5691dc",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -1330,6 +1330,11 @@ impl NextConfig {\n         Vc::cell(self.output == Some(OutputType::Standalone))\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn ci_has_next_support(&self) -> Vc<bool> {\n+        Vc::cell(self.env.contains_key(\"NOW_BUILDER\"))\n+    }\n+\n     #[turbo_tasks::function]\n     pub fn cache_handler(&self, project_path: FileSystemPath) -> Result<Vc<OptionFileSystemPath>> {\n         if let Some(handler) = &self.cache_handler {"
        },
        {
            "sha": "6980c2a73b8b1107a23ec7aa1480940240a1bd32",
            "filename": "crates/next-core/src/next_server/mod.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_server%2Fmod.rs?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -6,5 +6,5 @@ pub use context::{\n     ServerChunkingContextOptions, ServerContextType, get_server_chunking_context,\n     get_server_chunking_context_with_client_assets, get_server_compile_time_info,\n     get_server_module_options_context, get_server_resolve_options_context,\n-    get_server_runtime_entries,\n+    get_server_runtime_entries, get_tracing_compile_time_info,\n };"
        },
        {
            "sha": "4f9efd7fa51d6b51e6a71725dc4ec0836a56f018",
            "filename": "packages/next/src/build/collect-build-traces.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 7,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fcollect-build-traces.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -82,7 +82,6 @@ export async function collectBuildTraces({\n   hasSsrAmpPages,\n   buildTraceContext,\n   outputFileTracingRoot,\n-  isTurbopack,\n }: {\n   dir: string\n   distDir: string\n@@ -94,7 +93,6 @@ export async function collectBuildTraces({\n   nextBuildSpan?: Span\n   config: NextConfigComplete\n   buildTraceContext?: BuildTraceContext\n-  isTurbopack: boolean\n }) {\n   const startTime = Date.now()\n   debug('starting build traces')\n@@ -280,11 +278,6 @@ export async function collectBuildTraces({\n         )\n       }\n \n-      if (isTurbopack) {\n-        addToTracedFiles(distDir, './package.json', serverTracedFiles)\n-        addToTracedFiles(distDir, './package.json', minimalServerTracedFiles)\n-      }\n-\n       {\n         const chunksToTrace: string[] = [\n           ...(buildTraceContext?.chunksTrace?.action.input || []),"
        },
        {
            "sha": "77122300b9549d72f0783e211cd61d110b14acbb",
            "filename": "packages/next/src/build/index.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 4,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Findex.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -1748,7 +1748,6 @@ export default async function build(\n                     hasSsrAmpPages: false,\n                     buildTraceContext,\n                     outputFileTracingRoot,\n-                    isTurbopack: false,\n                   })\n                   .catch((err) => {\n                     console.error(err)\n@@ -2642,7 +2641,7 @@ export default async function build(\n \n       await writeFunctionsConfigManifest(distDir, functionsConfigManifest)\n \n-      if (!isGenerateMode && !buildTracesPromise) {\n+      if (!isTurbopack && !isGenerateMode && !buildTracesPromise) {\n         buildTracesPromise = collectBuildTraces({\n           dir,\n           config,\n@@ -2653,7 +2652,6 @@ export default async function build(\n           hasSsrAmpPages,\n           buildTraceContext,\n           outputFileTracingRoot,\n-          isTurbopack: true,\n         }).catch((err) => {\n           console.error(err)\n           process.exit(1)\n@@ -3935,7 +3933,10 @@ export default async function build(\n       }\n \n       const postBuildSpinner = createSpinner('Finalizing page optimization')\n-      let buildTracesSpinner = createSpinner(`Collecting build traces`)\n+      let buildTracesSpinner\n+      if (buildTracesPromise) {\n+        buildTracesSpinner = createSpinner('Collecting build traces')\n+      }\n \n       // ensure the worker is not left hanging\n       worker.end()"
        },
        {
            "sha": "2731f1fa53f7756868c290457d4264030648f0b1",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 10,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -45,6 +45,7 @@ import type { TLSSocket } from 'tls'\n import type { PathnameNormalizer } from './normalizers/request/pathname-normalizer'\n import type { InstrumentationModule } from './instrumentation/types'\n \n+import * as path from 'path'\n import { format as formatUrl, parse as parseUrl } from 'url'\n import { formatHostname } from './lib/format-hostname'\n import {\n@@ -444,7 +445,7 @@ export default abstract class Server<\n     this.experimentalTestProxy = experimentalTestProxy\n     this.serverOptions = options\n \n-    this.dir = (require('path') as typeof import('path')).resolve(dir)\n+    this.dir = path.resolve(/* turbopackIgnore: true */ dir)\n \n     this.quiet = quiet\n     this.loadEnvConfig({ dev })\n@@ -458,8 +459,8 @@ export default abstract class Server<\n       this.fetchHostname = formatHostname(this.hostname)\n     }\n     this.port = port\n-    this.distDir = (require('path') as typeof import('path')).join(\n-      this.dir,\n+    this.distDir = path.join(\n+      /* turbopackIgnore: true */ this.dir,\n       this.nextConfig.distDir\n     )\n     this.publicDir = this.getPublicDir()\n@@ -2416,19 +2417,19 @@ export default abstract class Server<\n     return null\n   }\n \n-  private stripNextDataPath(path: string, stripLocale = true) {\n-    if (path.includes(this.buildId)) {\n-      const splitPath = path.substring(\n-        path.indexOf(this.buildId) + this.buildId.length\n+  private stripNextDataPath(filePath: string, stripLocale = true) {\n+    if (filePath.includes(this.buildId)) {\n+      const splitPath = filePath.substring(\n+        filePath.indexOf(this.buildId) + this.buildId.length\n       )\n \n-      path = denormalizePagePath(splitPath.replace(/\\.json$/, ''))\n+      filePath = denormalizePagePath(splitPath.replace(/\\.json$/, ''))\n     }\n \n     if (this.localeNormalizer && stripLocale) {\n-      return this.localeNormalizer.normalize(path)\n+      return this.localeNormalizer.normalize(filePath)\n     }\n-    return path\n+    return filePath\n   }\n \n   // map the route to the actual bundle name"
        },
        {
            "sha": "727e812b6ae7da94312c0f168b8a88d5fc2ac466",
            "filename": "packages/next/src/server/image-optimizer.ts",
            "status": "modified",
            "additions": 10,
            "deletions": 4,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -142,6 +142,7 @@ async function writeToCacheDir(\n   upstreamEtag: string\n ) {\n   const filename = join(\n+    /* turbopackIgnore: true */\n     dir,\n     `${maxAge}.${expireAt}.${etag}.${upstreamEtag}.${extension}`\n   )\n@@ -494,20 +495,25 @@ export class ImageOptimizerCache {\n     distDir: string\n     nextConfig: NextConfigComplete\n   }) {\n-    this.cacheDir = join(distDir, 'cache', 'images')\n+    this.cacheDir = join(/* turbopackIgnore: true */ distDir, 'cache', 'images')\n     this.nextConfig = nextConfig\n   }\n \n   async get(cacheKey: string): Promise<IncrementalResponseCacheEntry | null> {\n     try {\n-      const cacheDir = join(this.cacheDir, cacheKey)\n+      const cacheDir = join(/* turbopackIgnore: true */ this.cacheDir, cacheKey)\n       const files = await promises.readdir(cacheDir)\n       const now = Date.now()\n \n       for (const file of files) {\n         const [maxAgeSt, expireAtSt, etag, upstreamEtag, extension] =\n           file.split('.', 5)\n-        const buffer = await promises.readFile(join(cacheDir, file))\n+        const buffer = await promises.readFile(\n+          /* turbopackIgnore: true */ join(\n+            /* turbopackIgnore: true */ cacheDir,\n+            file\n+          )\n+        )\n         const expireAt = Number(expireAtSt)\n         const maxAge = Number(maxAgeSt)\n \n@@ -560,7 +566,7 @@ export class ImageOptimizerCache {\n \n     try {\n       await writeToCacheDir(\n-        join(this.cacheDir, cacheKey),\n+        join(/* turbopackIgnore: true */ this.cacheDir, cacheKey),\n         value.extension,\n         revalidate,\n         expireAt,"
        },
        {
            "sha": "904c5f27ae29da1d5641a5a4a580ba040ac5e6a9",
            "filename": "packages/next/src/server/load-components.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 5,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fload-components.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -177,9 +177,13 @@ async function loadComponentsImpl<N = any>({\n \n   let reactLoadableManifestPath\n   if (!process.env.TURBOPACK) {\n-    reactLoadableManifestPath = join(distDir, REACT_LOADABLE_MANIFEST)\n+    reactLoadableManifestPath = join(\n+      /* turbopackIgnore: true */ distDir,\n+      REACT_LOADABLE_MANIFEST\n+    )\n   } else if (isAppPath) {\n     reactLoadableManifestPath = join(\n+      /* turbopackIgnore: true */\n       distDir,\n       'server',\n       'app',\n@@ -188,6 +192,7 @@ async function loadComponentsImpl<N = any>({\n     )\n   } else {\n     reactLoadableManifestPath = join(\n+      /* turbopackIgnore: true */\n       distDir,\n       'server',\n       'pages',\n@@ -213,7 +218,7 @@ async function loadComponentsImpl<N = any>({\n     subresourceIntegrityManifest,\n   ] = await Promise.all([\n     loadManifestWithRetries<BuildManifest>(\n-      join(distDir, BUILD_MANIFEST),\n+      join(/* turbopackIgnore: true */ distDir, BUILD_MANIFEST),\n       manifestLoadAttempts\n     ),\n     tryLoadManifestWithRetries<ReactLoadableManifest>(\n@@ -224,12 +229,16 @@ async function loadComponentsImpl<N = any>({\n     isAppPath || process.env.TURBOPACK\n       ? undefined\n       : loadManifestWithRetries<DynamicCssManifest>(\n-          join(distDir, `${DYNAMIC_CSS_MANIFEST}.json`),\n+          join(\n+            /* turbopackIgnore: true */ distDir,\n+            `${DYNAMIC_CSS_MANIFEST}.json`\n+          ),\n           manifestLoadAttempts\n         ).catch(() => undefined),\n     isAppPath && hasClientManifest\n       ? tryLoadClientReferenceManifest(\n           join(\n+            /* turbopackIgnore: true */\n             distDir,\n             'server',\n             'app',\n@@ -241,13 +250,21 @@ async function loadComponentsImpl<N = any>({\n       : undefined,\n     isAppPath\n       ? loadManifestWithRetries<ActionManifest>(\n-          join(distDir, 'server', SERVER_REFERENCE_MANIFEST + '.json'),\n+          join(\n+            /* turbopackIgnore: true */ distDir,\n+            'server',\n+            SERVER_REFERENCE_MANIFEST + '.json'\n+          ),\n           manifestLoadAttempts\n         ).catch(() => null)\n       : null,\n     sriEnabled\n       ? loadManifestWithRetries<DeepReadonly<Record<string, string>>>(\n-          join(distDir, 'server', SUBRESOURCE_INTEGRITY_MANIFEST + '.json')\n+          join(\n+            /* turbopackIgnore: true */ distDir,\n+            'server',\n+            SUBRESOURCE_INTEGRITY_MANIFEST + '.json'\n+          )\n         ).catch(() => undefined)\n       : undefined,\n   ])"
        },
        {
            "sha": "0e66b2a10e4c5191b87522fdee16d2100283d6f4",
            "filename": "packages/next/src/server/next-server.ts",
            "status": "modified",
            "additions": 59,
            "deletions": 16,
            "changes": 75,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext-server.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -327,7 +327,10 @@ export default class NextNodeServer extends BaseServer<\n       interceptTestApis()\n     }\n \n-    this.middlewareManifestPath = join(this.serverDistDir, MIDDLEWARE_MANIFEST)\n+    this.middlewareManifestPath = join(\n+      /* turbopackIgnore: true */ this.serverDistDir,\n+      MIDDLEWARE_MANIFEST\n+    )\n \n     // This is just optimization to fire prepare as soon as possible. It will be\n     // properly awaited later. We add the catch here to ensure that it does not\n@@ -509,24 +512,29 @@ export default class NextNodeServer extends BaseServer<\n   }\n \n   protected getPublicDir(): string {\n-    return join(this.dir, CLIENT_PUBLIC_FILES_PATH)\n+    return join(/* turbopackIgnore: true */ this.dir, CLIENT_PUBLIC_FILES_PATH)\n   }\n \n   protected getHasStaticDir(): boolean {\n-    return fs.existsSync(join(this.dir, 'static'))\n+    return fs.existsSync(\n+      /* turbopackIgnore: true */ join(\n+        /* turbopackIgnore: true */ this.dir,\n+        'static'\n+      )\n+    )\n   }\n \n   protected getPagesManifest(): PagesManifest | undefined {\n     return loadManifest(\n-      join(this.serverDistDir, PAGES_MANIFEST)\n+      join(/* turbopackIgnore: true */ this.serverDistDir, PAGES_MANIFEST)\n     ) as PagesManifest\n   }\n \n   protected getAppPathsManifest(): PagesManifest | undefined {\n     if (!this.enabledDirectories.app) return undefined\n \n     return loadManifest(\n-      join(this.serverDistDir, APP_PATHS_MANIFEST)\n+      join(/* turbopackIgnore: true */ this.serverDistDir, APP_PATHS_MANIFEST)\n     ) as PagesManifest\n   }\n \n@@ -551,9 +559,14 @@ export default class NextNodeServer extends BaseServer<\n   }\n \n   protected getBuildId(): string {\n-    const buildIdFile = join(this.distDir, BUILD_ID_FILE)\n+    const buildIdFile = join(\n+      /* turbopackIgnore: true */ this.distDir,\n+      BUILD_ID_FILE\n+    )\n     try {\n-      return fs.readFileSync(buildIdFile, 'utf8').trim()\n+      return fs\n+        .readFileSync(/* turbopackIgnore: true */ buildIdFile, 'utf8')\n+        .trim()\n     } catch (err: any) {\n       if (err.code === 'ENOENT') {\n         throw new Error(\n@@ -931,7 +944,11 @@ export default class NextNodeServer extends BaseServer<\n \n   protected getNextFontManifest(): NextFontManifest | undefined {\n     return loadManifest(\n-      join(this.distDir, 'server', NEXT_FONT_MANIFEST + '.json')\n+      join(\n+        /* turbopackIgnore: true */ this.distDir,\n+        'server',\n+        NEXT_FONT_MANIFEST + '.json'\n+      )\n     ) as NextFontManifest\n   }\n \n@@ -1495,17 +1512,25 @@ export default class NextNodeServer extends BaseServer<\n \n     return {\n       name: pageInfo.name,\n-      paths: pageInfo.files.map((file) => join(this.distDir, file)),\n+      paths: pageInfo.files.map((file) =>\n+        join(/* turbopackIgnore: true */ this.distDir, file)\n+      ),\n       wasm: (pageInfo.wasm ?? []).map((binding) => ({\n         ...binding,\n-        filePath: join(this.distDir, binding.filePath),\n+        filePath: join(\n+          /* turbopackIgnore: true */ this.distDir,\n+          binding.filePath\n+        ),\n       })),\n       assets:\n         pageInfo.assets &&\n         pageInfo.assets.map((binding) => {\n           return {\n             ...binding,\n-            filePath: join(this.distDir, binding.filePath),\n+            filePath: join(\n+              /* turbopackIgnore: true */ this.distDir,\n+              binding.filePath\n+            ),\n           }\n         }),\n       env: pageInfo.env,\n@@ -1517,14 +1542,26 @@ export default class NextNodeServer extends BaseServer<\n       try {\n         const functionsConfig = this.renderOpts.dev\n           ? {}\n-          : require(join(this.distDir, 'server', FUNCTIONS_CONFIG_MANIFEST))\n+          : require(\n+              join(\n+                /* turbopackIgnore: true */ this.distDir,\n+                'server',\n+                FUNCTIONS_CONFIG_MANIFEST\n+              )\n+            )\n \n         if (\n           this.renderOpts.dev ||\n           functionsConfig?.functions?.['/_middleware']\n         ) {\n           // if used with top level await, this will be a promise\n-          return require(join(this.distDir, 'server', 'middleware.js'))\n+          return require(\n+            join(\n+              /* turbopackIgnore: true */ this.distDir,\n+              'server',\n+              'middleware.js'\n+            )\n+          )\n         }\n       } catch (err) {\n         if (\n@@ -1861,7 +1898,7 @@ export default class NextNodeServer extends BaseServer<\n     }\n \n     this._cachedPreviewManifest = loadManifest(\n-      join(this.distDir, PRERENDER_MANIFEST)\n+      join(/* turbopackIgnore: true */ this.distDir, PRERENDER_MANIFEST)\n     ) as PrerenderManifest\n \n     return this._cachedPreviewManifest\n@@ -1870,7 +1907,10 @@ export default class NextNodeServer extends BaseServer<\n   protected getRoutesManifest(): NormalizedRouteManifest | undefined {\n     return getTracer().trace(\n       NextNodeServerSpan.getRoutesManifest,\n-      () => loadManifest(join(this.distDir, ROUTES_MANIFEST)) as RoutesManifest\n+      () =>\n+        loadManifest(\n+          join(/* turbopackIgnore: true */ this.distDir, ROUTES_MANIFEST)\n+        ) as RoutesManifest\n     )\n   }\n \n@@ -2032,7 +2072,10 @@ export default class NextNodeServer extends BaseServer<\n     if (this._serverDistDir) {\n       return this._serverDistDir\n     }\n-    const serverDistDir = join(this.distDir, SERVER_DIRECTORY)\n+    const serverDistDir = join(\n+      /* turbopackIgnore: true */ this.distDir,\n+      SERVER_DIRECTORY\n+    )\n     this._serverDistDir = serverDistDir\n     return serverDistDir\n   }"
        },
        {
            "sha": "1c6c807d7ddf631bc924efab534db4b6be2c9baf",
            "filename": "packages/next/src/server/next.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fnext.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -14,7 +14,7 @@ import './node-polyfill-crypto'\n import type { default as NextNodeServer } from './next-server'\n import * as log from '../build/output/log'\n import loadConfig from './config'\n-import path, { resolve } from 'path'\n+import path from 'path'\n import { NON_STANDARD_NODE_ENV } from '../lib/constants'\n import {\n   PHASE_DEVELOPMENT_SERVER,\n@@ -247,7 +247,9 @@ export class NextServer implements NextWrapperServer {\n   }\n \n   private async [SYMBOL_LOAD_CONFIG]() {\n-    const dir = resolve(this.options.dir || '.')\n+    const dir = path.resolve(\n+      /* turbopackIgnore: true */ this.options.dir || '.'\n+    )\n \n     const config = await loadConfig(\n       this.options.dev ? PHASE_DEVELOPMENT_SERVER : PHASE_PRODUCTION_SERVER,\n@@ -262,7 +264,12 @@ export class NextServer implements NextWrapperServer {\n     if (!this.options.dev) {\n       try {\n         const serializedConfig = require(\n-          path.join(dir, config.distDir, SERVER_FILES_MANIFEST)\n+          /* turbopackIgnore: true */\n+          path.join(\n+            /* turbopackIgnore: true */ dir,\n+            config.distDir,\n+            SERVER_FILES_MANIFEST\n+          )\n         ).config\n \n         config.experimental.isExperimentalCompile =\n@@ -549,7 +556,7 @@ function createServer(\n \n   // When the caller is a custom server (using next()).\n   if (options.customServer !== false) {\n-    const dir = resolve(options.dir || '.')\n+    const dir = path.resolve(/* turbopackIgnore: true */ options.dir || '.')\n \n     return new NextCustomServer({\n       ...options,"
        },
        {
            "sha": "9bcda1c14cdd3b451b54903ff2f541734870b75c",
            "filename": "packages/next/src/server/require.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 8,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Frequire.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Frequire.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Frequire.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -29,17 +29,23 @@ export function getMaybePagePath(\n   // If we have a cached path, we can return it directly.\n   if (pagePath) return pagePath\n \n-  const serverBuildPath = path.join(distDir, SERVER_DIRECTORY)\n+  const serverBuildPath = path.join(\n+    /* turbopackIgnore: true */ distDir,\n+    SERVER_DIRECTORY\n+  )\n   let appPathsManifest: undefined | PagesManifest\n \n   if (isAppPath) {\n     appPathsManifest = loadManifest(\n-      path.join(serverBuildPath, APP_PATHS_MANIFEST),\n+      path.join(\n+        /* turbopackIgnore: true */ serverBuildPath,\n+        APP_PATHS_MANIFEST\n+      ),\n       !isDev\n     ) as PagesManifest\n   }\n   const pagesManifest = loadManifest(\n-    path.join(serverBuildPath, PAGES_MANIFEST),\n+    path.join(/* turbopackIgnore: true */ serverBuildPath, PAGES_MANIFEST),\n     !isDev\n   ) as PagesManifest\n \n@@ -85,7 +91,7 @@ export function getMaybePagePath(\n     return pagePath\n   }\n \n-  pagePath = path.join(serverBuildPath, pagePath)\n+  pagePath = path.join(/* turbopackIgnore: true */ serverBuildPath, pagePath)\n \n   pagePathCache?.set(cacheKey, pagePath)\n   return pagePath\n@@ -113,14 +119,16 @@ export async function requirePage(\n ): Promise<any> {\n   const pagePath = getPagePath(page, distDir, undefined, isAppPath)\n   if (pagePath.endsWith('.html')) {\n-    return promises.readFile(pagePath, 'utf8').catch((err) => {\n-      throw new MissingStaticPage(page, err.message)\n-    })\n+    return promises\n+      .readFile(/* turbopackIgnore: true */ pagePath, 'utf8')\n+      .catch((err) => {\n+        throw new MissingStaticPage(page, err.message)\n+      })\n   }\n \n   const mod = process.env.NEXT_MINIMAL\n     ? // @ts-ignore\n       __non_webpack_require__(pagePath)\n-    : require(pagePath)\n+    : require(/* turbopackIgnore: true */ pagePath)\n   return mod\n }"
        },
        {
            "sha": "5992a6ed9728b5f2408e70131c1871573be2b7cb",
            "filename": "packages/next/src/server/route-modules/route-module.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Froute-modules%2Froute-module.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -152,6 +152,7 @@ export abstract class RouteModule<\n     } else {\n       const { join } = require('node:path') as typeof import('node:path')\n       const absoluteProjectDir = join(\n+        /* turbopackIgnore: true */\n         process.cwd(),\n         getRequestMeta(req, 'relativeProjectDir') || this.relativeProjectDir\n       )\n@@ -390,6 +391,7 @@ export abstract class RouteModule<\n \n         const { join } = require('node:path') as typeof import('node:path')\n         const absoluteProjectDir = join(\n+          /* turbopackIgnore: true */\n           process.cwd(),\n           getRequestMeta(req, 'relativeProjectDir') || this.relativeProjectDir\n         )\n@@ -432,6 +434,7 @@ export abstract class RouteModule<\n       }\n       const { join } = require('node:path') as typeof import('node:path')\n       const projectDir = join(\n+        /* turbopackIgnore: true */\n         process.cwd(),\n         getRequestMeta(req, 'relativeProjectDir') || this.relativeProjectDir\n       )\n@@ -539,6 +542,7 @@ export abstract class RouteModule<\n         require('node:path') as typeof import('node:path')\n \n       absoluteProjectDir = join(\n+        /* turbopackIgnore: true */\n         process.cwd(),\n         getRequestMeta(req, 'relativeProjectDir') || this.relativeProjectDir\n       )"
        },
        {
            "sha": "60a985c9b583c577751b5702b96d07572f77b5c3",
            "filename": "test/production/app-dir/build-output-tree-view/build-output-tree-view.test.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fapp-dir%2Fbuild-output-tree-view%2Fbuild-output-tree-view.test.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -74,15 +74,15 @@ describe('build-output-tree-view', () => {\n })\n \n function getTreeView(cliOutput: string): string {\n-  let foundBuildTracesLine = false\n+  let foundStart = false\n   const lines: string[] = []\n \n   for (const line of cliOutput.split('\\n')) {\n-    if (foundBuildTracesLine) {\n+    foundStart ||= line.startsWith('Route ')\n+\n+    if (foundStart) {\n       lines.push(line)\n     }\n-\n-    foundBuildTracesLine ||= line.includes('Collecting build traces')\n   }\n \n   return lines.join('\\n').trim()"
        },
        {
            "sha": "e7077399c03ce1479a655dc647c0545b64531628",
            "filename": "test/production/next-server-nft/app/layout.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fnext-server-nft%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fnext-server-nft%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fapp%2Flayout.tsx?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -0,0 +1,7 @@\n+export default function Root({ children }: { children: React.ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "8afb7372a1d520d941cc49f105a7379f5188891c",
            "filename": "test/production/next-server-nft/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fnext-server-nft%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fnext-server-nft%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fapp%2Fpage.tsx?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'Hello'\n+}"
        },
        {
            "sha": "08818c878262170a7b0e1e7196bda6ca9c9e44c9",
            "filename": "test/production/next-server-nft/next-server-nft.test.ts",
            "status": "added",
            "additions": 353,
            "deletions": 0,
            "changes": 353,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fnext-server-nft.test.ts?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -0,0 +1,353 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import path from 'path'\n+import fs from 'fs'\n+\n+// Only run this test for Turbopack as it is more conservative (i.e. aggressive) in including\n+// referenced files and might include too many. (The Webpack snapshots would different slightly from\n+// the Turbopack ones below.)\n+//\n+// This test is not meant for testing correctness (which is done by the behavioral tests), but as a\n+// regression test to ensure that some stray `path.join` doesn't cause all of the Next.js package to\n+// get included.\n+;(process.env.IS_TURBOPACK_TEST ? describe : describe.skip)(\n+  'next-server-nft',\n+  () => {\n+    const { next, skipped } = nextTestSetup({\n+      files: __dirname,\n+      skipDeployment: true,\n+    })\n+\n+    if (skipped) {\n+      return\n+    }\n+\n+    async function readNormalizedNFT(name) {\n+      let data = await next.readJSON(name)\n+      let result = [\n+        ...new Set(\n+          data.files\n+            .filter((file: string) => {\n+              // They are important, but they are never actually included by themselves but rather as\n+              // part of some JS files in the same directory tree, which are higher-signal for the\n+              // screenshot below.\n+              if (file.endsWith('/package.json')) {\n+                return false\n+              }\n+\n+              // Filter out the many symlinks that power node_modules\n+              let fileAbsolute = path.join(next.testDir, name, '..', file)\n+              if (fs.lstatSync(fileAbsolute).isSymbolicLink()) {\n+                return false\n+              }\n+              return true\n+            })\n+            .map((file: string) => {\n+              // Normalize sharp, different architectures have different files\n+              if (file.includes('/node_modules/@img/sharp-libvips-')) {\n+                return '@img/sharp-libvips-*'\n+              }\n+              if (\n+                file.match(\n+                  /\\/node_modules\\/@img\\/sharp-\\w+-\\w+\\/lib\\/sharp-\\w+-\\w+.node$/\n+                )\n+              ) {\n+                return '@img/sharp-*/sharp-*.node'\n+              }\n+\n+              // Strip double node_modules to simplify output\n+              let firstNodeModules = file.indexOf('/node_modules/')\n+              let lastNodeModules = file.lastIndexOf('/node_modules/')\n+              if (firstNodeModules !== lastNodeModules) {\n+                return file.slice(lastNodeModules)\n+              }\n+\n+              return file\n+            })\n+        ),\n+      ]\n+      result.sort()\n+      return result\n+    }\n+\n+    it('should not trace too many files in next-server.js.nft.json', async () => {\n+      let trace = await readNormalizedNFT('.next/next-server.js.nft.json')\n+\n+      //  Group the entries together so that the snapshot doesn't change too often.\n+      // This trace contains quite a lot of files that aren't actually needed. But there isn't much\n+      // that Turbopack itself can do about that.\n+\n+      let traceGrouped = [\n+        ...new Set(\n+          trace.map((file: string) => {\n+            if (file.startsWith('/node_modules/next/dist/client/')) {\n+              return '/node_modules/next/dist/client/*'\n+            }\n+            if (file.startsWith('/node_modules/next/dist/server/')) {\n+              return '/node_modules/next/dist/server/*'\n+            }\n+            if (file.startsWith('/node_modules/next/dist/shared/')) {\n+              return '/node_modules/next/dist/shared/*'\n+            }\n+            return file\n+          })\n+        ),\n+      ]\n+\n+      expect(traceGrouped).toMatchInlineSnapshot(`\n+       [\n+         \"/node_modules/@next/env/dist/index.js\",\n+         \"/node_modules/@swc/helpers/cjs/_class_private_field_loose_base.cjs\",\n+         \"/node_modules/@swc/helpers/cjs/_class_private_field_loose_key.cjs\",\n+         \"/node_modules/@swc/helpers/cjs/_interop_require_default.cjs\",\n+         \"/node_modules/@swc/helpers/cjs/_interop_require_wildcard.cjs\",\n+         \"/node_modules/client-only/index.js\",\n+         \"/node_modules/color-convert/conversions.js\",\n+         \"/node_modules/color-convert/index.js\",\n+         \"/node_modules/color-convert/route.js\",\n+         \"/node_modules/color-name/index.js\",\n+         \"/node_modules/color-string/index.js\",\n+         \"/node_modules/color/index.js\",\n+         \"/node_modules/detect-libc/lib/detect-libc.js\",\n+         \"/node_modules/detect-libc/lib/filesystem.js\",\n+         \"/node_modules/detect-libc/lib/process.js\",\n+         \"/node_modules/is-arrayish/index.js\",\n+         \"/node_modules/next/dist/build/output/log.js\",\n+         \"/node_modules/next/dist/build/segment-config/app/app-segment-config.js\",\n+         \"/node_modules/next/dist/build/segment-config/app/app-segments.js\",\n+         \"/node_modules/next/dist/build/static-paths/utils.js\",\n+         \"/node_modules/next/dist/client/*\",\n+         \"/node_modules/next/dist/compiled/@edge-runtime/cookies/index.js\",\n+         \"/node_modules/next/dist/compiled/@hapi/accept/index.js\",\n+         \"/node_modules/next/dist/compiled/@mswjs/interceptors/ClientRequest/index.js\",\n+         \"/node_modules/next/dist/compiled/@opentelemetry/api/index.js\",\n+         \"/node_modules/next/dist/compiled/babel-packages/packages-bundle.js\",\n+         \"/node_modules/next/dist/compiled/babel/bundle.js\",\n+         \"/node_modules/next/dist/compiled/babel/code-frame.js\",\n+         \"/node_modules/next/dist/compiled/babel/core.js\",\n+         \"/node_modules/next/dist/compiled/babel/parser.js\",\n+         \"/node_modules/next/dist/compiled/babel/traverse.js\",\n+         \"/node_modules/next/dist/compiled/babel/types.js\",\n+         \"/node_modules/next/dist/compiled/busboy/index.js\",\n+         \"/node_modules/next/dist/compiled/bytes/index.js\",\n+         \"/node_modules/next/dist/compiled/content-disposition/index.js\",\n+         \"/node_modules/next/dist/compiled/cookie/index.js\",\n+         \"/node_modules/next/dist/compiled/debug/index.js\",\n+         \"/node_modules/next/dist/compiled/edge-runtime/index.js\",\n+         \"/node_modules/next/dist/compiled/fresh/index.js\",\n+         \"/node_modules/next/dist/compiled/image-detector/detector.js\",\n+         \"/node_modules/next/dist/compiled/image-size/index.js\",\n+         \"/node_modules/next/dist/compiled/is-animated/index.js\",\n+         \"/node_modules/next/dist/compiled/json5/index.js\",\n+         \"/node_modules/next/dist/compiled/jsonwebtoken/index.js\",\n+         \"/node_modules/next/dist/compiled/lru-cache/index.js\",\n+         \"/node_modules/next/dist/compiled/nanoid/index.cjs\",\n+         \"/node_modules/next/dist/compiled/next-server/app-page-turbo-experimental.runtime.prod.js\",\n+         \"/node_modules/next/dist/compiled/next-server/app-page-turbo.runtime.prod.js\",\n+         \"/node_modules/next/dist/compiled/next-server/pages-turbo.runtime.prod.js\",\n+         \"/node_modules/next/dist/compiled/p-queue/index.js\",\n+         \"/node_modules/next/dist/compiled/path-browserify/index.js\",\n+         \"/node_modules/next/dist/compiled/path-to-regexp/index.js\",\n+         \"/node_modules/next/dist/compiled/picomatch/index.js\",\n+         \"/node_modules/next/dist/compiled/react-is/cjs/react-is.development.js\",\n+         \"/node_modules/next/dist/compiled/react-is/cjs/react-is.production.js\",\n+         \"/node_modules/next/dist/compiled/react-is/index.js\",\n+         \"/node_modules/next/dist/compiled/semver/index.js\",\n+         \"/node_modules/next/dist/compiled/send/index.js\",\n+         \"/node_modules/next/dist/compiled/source-map/source-map.js\",\n+         \"/node_modules/next/dist/compiled/stacktrace-parser/stack-trace-parser.cjs.js\",\n+         \"/node_modules/next/dist/compiled/string-hash/index.js\",\n+         \"/node_modules/next/dist/compiled/strip-ansi/index.js\",\n+         \"/node_modules/next/dist/compiled/superstruct/index.cjs\",\n+         \"/node_modules/next/dist/compiled/ws/index.js\",\n+         \"/node_modules/next/dist/compiled/zod-validation-error/index.js\",\n+         \"/node_modules/next/dist/compiled/zod/index.cjs\",\n+         \"/node_modules/next/dist/experimental/testmode/context.js\",\n+         \"/node_modules/next/dist/experimental/testmode/fetch.js\",\n+         \"/node_modules/next/dist/experimental/testmode/httpget.js\",\n+         \"/node_modules/next/dist/experimental/testmode/server-edge.js\",\n+         \"/node_modules/next/dist/experimental/testmode/server.js\",\n+         \"/node_modules/next/dist/lib/batcher.js\",\n+         \"/node_modules/next/dist/lib/client-and-server-references.js\",\n+         \"/node_modules/next/dist/lib/constants.js\",\n+         \"/node_modules/next/dist/lib/detached-promise.js\",\n+         \"/node_modules/next/dist/lib/error-telemetry-utils.js\",\n+         \"/node_modules/next/dist/lib/fallback.js\",\n+         \"/node_modules/next/dist/lib/find-pages-dir.js\",\n+         \"/node_modules/next/dist/lib/format-dynamic-import-path.js\",\n+         \"/node_modules/next/dist/lib/format-server-error.js\",\n+         \"/node_modules/next/dist/lib/framework/boundary-components.js\",\n+         \"/node_modules/next/dist/lib/framework/boundary-constants.js\",\n+         \"/node_modules/next/dist/lib/generate-interception-routes-rewrites.js\",\n+         \"/node_modules/next/dist/lib/interop-default.js\",\n+         \"/node_modules/next/dist/lib/is-api-route.js\",\n+         \"/node_modules/next/dist/lib/is-app-page-route.js\",\n+         \"/node_modules/next/dist/lib/is-app-route-route.js\",\n+         \"/node_modules/next/dist/lib/is-error.js\",\n+         \"/node_modules/next/dist/lib/is-serializable-props.js\",\n+         \"/node_modules/next/dist/lib/metadata/get-metadata-route.js\",\n+         \"/node_modules/next/dist/lib/metadata/is-metadata-route.js\",\n+         \"/node_modules/next/dist/lib/metadata/metadata-context.js\",\n+         \"/node_modules/next/dist/lib/multi-file-writer.js\",\n+         \"/node_modules/next/dist/lib/non-nullable.js\",\n+         \"/node_modules/next/dist/lib/page-types.js\",\n+         \"/node_modules/next/dist/lib/pick.js\",\n+         \"/node_modules/next/dist/lib/picocolors.js\",\n+         \"/node_modules/next/dist/lib/redirect-status.js\",\n+         \"/node_modules/next/dist/lib/route-pattern-normalizer.js\",\n+         \"/node_modules/next/dist/lib/scheduler.js\",\n+         \"/node_modules/next/dist/lib/semver-noop.js\",\n+         \"/node_modules/next/dist/lib/static-env.js\",\n+         \"/node_modules/next/dist/lib/url.js\",\n+         \"/node_modules/next/dist/lib/wait.js\",\n+         \"/node_modules/next/dist/next-devtools/server/shared.js\",\n+         \"/node_modules/next/dist/server/*\",\n+         \"/node_modules/next/dist/shared/*\",\n+         \"/node_modules/react-dom/cjs/react-dom-server-legacy.browser.production.js\",\n+         \"/node_modules/react-dom/cjs/react-dom-server-legacy.node.production.js\",\n+         \"/node_modules/react-dom/cjs/react-dom-server.browser.production.js\",\n+         \"/node_modules/react-dom/cjs/react-dom-server.edge.production.js\",\n+         \"/node_modules/react-dom/cjs/react-dom-server.node.production.js\",\n+         \"/node_modules/react-dom/cjs/react-dom.production.js\",\n+         \"/node_modules/react-dom/index.js\",\n+         \"/node_modules/react-dom/server.browser.js\",\n+         \"/node_modules/react-dom/server.edge.js\",\n+         \"/node_modules/react-dom/server.node.js\",\n+         \"/node_modules/react-dom/static.node.js\",\n+         \"/node_modules/react/cjs/react-compiler-runtime.production.js\",\n+         \"/node_modules/react/cjs/react-jsx-dev-runtime.production.js\",\n+         \"/node_modules/react/cjs/react-jsx-runtime.production.js\",\n+         \"/node_modules/react/cjs/react.production.js\",\n+         \"/node_modules/react/compiler-runtime.js\",\n+         \"/node_modules/react/index.js\",\n+         \"/node_modules/react/jsx-dev-runtime.js\",\n+         \"/node_modules/react/jsx-runtime.js\",\n+         \"/node_modules/semver/classes/comparator.js\",\n+         \"/node_modules/semver/classes/range.js\",\n+         \"/node_modules/semver/classes/semver.js\",\n+         \"/node_modules/semver/functions/cmp.js\",\n+         \"/node_modules/semver/functions/coerce.js\",\n+         \"/node_modules/semver/functions/compare.js\",\n+         \"/node_modules/semver/functions/eq.js\",\n+         \"/node_modules/semver/functions/gt.js\",\n+         \"/node_modules/semver/functions/gte.js\",\n+         \"/node_modules/semver/functions/lt.js\",\n+         \"/node_modules/semver/functions/lte.js\",\n+         \"/node_modules/semver/functions/neq.js\",\n+         \"/node_modules/semver/functions/parse.js\",\n+         \"/node_modules/semver/functions/satisfies.js\",\n+         \"/node_modules/semver/internal/constants.js\",\n+         \"/node_modules/semver/internal/debug.js\",\n+         \"/node_modules/semver/internal/identifiers.js\",\n+         \"/node_modules/semver/internal/lrucache.js\",\n+         \"/node_modules/semver/internal/parse-options.js\",\n+         \"/node_modules/semver/internal/re.js\",\n+         \"/node_modules/sharp/lib/channel.js\",\n+         \"/node_modules/sharp/lib/colour.js\",\n+         \"/node_modules/sharp/lib/composite.js\",\n+         \"/node_modules/sharp/lib/constructor.js\",\n+         \"/node_modules/sharp/lib/index.js\",\n+         \"/node_modules/sharp/lib/input.js\",\n+         \"/node_modules/sharp/lib/is.js\",\n+         \"/node_modules/sharp/lib/libvips.js\",\n+         \"/node_modules/sharp/lib/operation.js\",\n+         \"/node_modules/sharp/lib/output.js\",\n+         \"/node_modules/sharp/lib/resize.js\",\n+         \"/node_modules/sharp/lib/sharp.js\",\n+         \"/node_modules/sharp/lib/utility.js\",\n+         \"/node_modules/simple-swizzle/index.js\",\n+         \"/node_modules/styled-jsx/dist/index/index.js\",\n+         \"/node_modules/styled-jsx/index.js\",\n+         \"/node_modules/styled-jsx/style.js\",\n+         \"@img/sharp-*/sharp-*.node\",\n+         \"@img/sharp-libvips-*\",\n+       ]\n+      `)\n+    })\n+\n+    it('should not trace too many files in next-minimal-server.js.nft.json', async () => {\n+      let trace = await readNormalizedNFT(\n+        '.next/next-minimal-server.js.nft.json'\n+      )\n+      expect(trace).toMatchInlineSnapshot(`\n+       [\n+         \"/node_modules/client-only/index.js\",\n+         \"/node_modules/next/dist/client/components/app-router-headers.js\",\n+         \"/node_modules/next/dist/compiled/@opentelemetry/api/index.js\",\n+         \"/node_modules/next/dist/compiled/babel-packages/packages-bundle.js\",\n+         \"/node_modules/next/dist/compiled/babel/bundle.js\",\n+         \"/node_modules/next/dist/compiled/babel/code-frame.js\",\n+         \"/node_modules/next/dist/compiled/babel/core.js\",\n+         \"/node_modules/next/dist/compiled/babel/parser.js\",\n+         \"/node_modules/next/dist/compiled/babel/traverse.js\",\n+         \"/node_modules/next/dist/compiled/babel/types.js\",\n+         \"/node_modules/next/dist/compiled/debug/index.js\",\n+         \"/node_modules/next/dist/compiled/json5/index.js\",\n+         \"/node_modules/next/dist/compiled/lru-cache/index.js\",\n+         \"/node_modules/next/dist/compiled/next-server/server.runtime.prod.js\",\n+         \"/node_modules/next/dist/compiled/semver/index.js\",\n+         \"/node_modules/next/dist/compiled/source-map/source-map.js\",\n+         \"/node_modules/next/dist/compiled/stacktrace-parser/stack-trace-parser.cjs.js\",\n+         \"/node_modules/next/dist/compiled/ws/index.js\",\n+         \"/node_modules/next/dist/experimental/testmode/context.js\",\n+         \"/node_modules/next/dist/experimental/testmode/fetch.js\",\n+         \"/node_modules/next/dist/experimental/testmode/server-edge.js\",\n+         \"/node_modules/next/dist/lib/client-and-server-references.js\",\n+         \"/node_modules/next/dist/lib/constants.js\",\n+         \"/node_modules/next/dist/lib/interop-default.js\",\n+         \"/node_modules/next/dist/lib/is-error.js\",\n+         \"/node_modules/next/dist/server/app-render/after-task-async-storage-instance.js\",\n+         \"/node_modules/next/dist/server/app-render/after-task-async-storage.external.js\",\n+         \"/node_modules/next/dist/server/app-render/async-local-storage.js\",\n+         \"/node_modules/next/dist/server/app-render/work-async-storage-instance.js\",\n+         \"/node_modules/next/dist/server/app-render/work-async-storage.external.js\",\n+         \"/node_modules/next/dist/server/app-render/work-unit-async-storage-instance.js\",\n+         \"/node_modules/next/dist/server/app-render/work-unit-async-storage.external.js\",\n+         \"/node_modules/next/dist/server/lib/cache-handlers/default.external.js\",\n+         \"/node_modules/next/dist/server/lib/incremental-cache/memory-cache.external.js\",\n+         \"/node_modules/next/dist/server/lib/incremental-cache/shared-cache-controls.external.js\",\n+         \"/node_modules/next/dist/server/lib/incremental-cache/tags-manifest.external.js\",\n+         \"/node_modules/next/dist/server/lib/lru-cache.js\",\n+         \"/node_modules/next/dist/server/lib/router-utils/instrumentation-globals.external.js\",\n+         \"/node_modules/next/dist/server/lib/router-utils/instrumentation-node-extensions.js\",\n+         \"/node_modules/next/dist/server/lib/trace/constants.js\",\n+         \"/node_modules/next/dist/server/lib/trace/tracer.js\",\n+         \"/node_modules/next/dist/server/load-manifest.external.js\",\n+         \"/node_modules/next/dist/server/response-cache/types.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/module.compiled.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/amp-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/app-router-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/entrypoints.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/head-manager-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/hooks-client-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/image-config-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/router-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/app-page/vendored/contexts/server-inserted-html.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/module.compiled.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/amp-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/app-router-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/entrypoints.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/head-manager-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/hooks-client-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/html-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/image-config-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/loadable-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/loadable.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/router-context.js\",\n+         \"/node_modules/next/dist/server/route-modules/pages/vendored/contexts/server-inserted-html.js\",\n+         \"/node_modules/next/dist/shared/lib/deep-freeze.js\",\n+         \"/node_modules/next/dist/shared/lib/invariant-error.js\",\n+         \"/node_modules/next/dist/shared/lib/is-plain-object.js\",\n+         \"/node_modules/next/dist/shared/lib/is-thenable.js\",\n+         \"/node_modules/next/dist/shared/lib/no-fallback-error.external.js\",\n+         \"/node_modules/next/dist/shared/lib/runtime-config.external.js\",\n+         \"/node_modules/next/dist/shared/lib/server-reference-info.js\",\n+         \"/node_modules/react/cjs/react.production.js\",\n+         \"/node_modules/react/index.js\",\n+         \"/node_modules/styled-jsx/dist/index/index.js\",\n+         \"/node_modules/styled-jsx/index.js\",\n+         \"/node_modules/styled-jsx/style.js\",\n+       ]\n+      `)\n+    })\n+  }\n+)"
        },
        {
            "sha": "807126e4cf0bf5b1c8c917e6e0148a27331587d1",
            "filename": "test/production/next-server-nft/next.config.js",
            "status": "added",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fnext-server-nft%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/test%2Fproduction%2Fnext-server-nft%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fnext-server-nft%2Fnext.config.js?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -0,0 +1,6 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "ab71efcb1474eba0e21b63c2a7d1d1de9bb15338",
            "filename": "turbopack/crates/turbopack/src/lib.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/79c16cb2fe3a5270e8dbf606164834cdb7360e0d/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack%2Fsrc%2Flib.rs?ref=79c16cb2fe3a5270e8dbf606164834cdb7360e0d",
            "patch": "@@ -672,7 +672,7 @@ async fn process_default_internal(\n }\n \n #[turbo_tasks::function]\n-async fn externals_tracing_module_context(\n+pub async fn externals_tracing_module_context(\n     ty: ExternalType,\n     compile_time_info: Vc<CompileTimeInfo>,\n ) -> Result<Vc<ModuleAssetContext>> {"
        }
    ],
    "stats": {
        "total": 958,
        "additions": 889,
        "deletions": 69
    }
}