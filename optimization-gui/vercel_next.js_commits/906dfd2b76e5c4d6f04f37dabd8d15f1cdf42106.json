{
    "author": "isBatak",
    "message": "feat(images): use experimental `isrFlushToDisk` option to prevent writing optimized images to cache (#70645)\n\n#### Description\nThis PR implements the use of the existing experimental configuration\noption, isrFlushToDisk, for Next.js, which prevents optimized images\nfrom being written to the cache directory. This feature can be useful in\nscenarios where disk writes need to be avoided, such as in environments\nwith limited disk space or read-only file systems.\n\nBy enabling this option, the `x-nextjs-cache` response header will\nalways return `MISS` for every request, indicating that no caching is\ntaking place for optimized images.\n\n#### Configuration Example\nTo disable the cache, add the following to your `next.config.js`:\n\n```js\nmodule.exports = {\n  experimental: {\n    isrFlushToDisk: false,\n  },\n}\n```\n\n- Fixes #25846\n\n---------\n\nCo-authored-by: Steven <steven@ceriously.com>",
    "sha": "906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106",
    "files": [
        {
            "sha": "674dfebedf627c679d36486d12e1b2618b2d0481",
            "filename": "packages/next/src/server/image-optimizer.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 0,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fimage-optimizer.ts?ref=906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106",
            "patch": "@@ -435,6 +435,10 @@ export class ImageOptimizerCache {\n       cacheControl?: CacheControl\n     }\n   ) {\n+    if (!this.nextConfig.experimental.isrFlushToDisk) {\n+      return\n+    }\n+\n     if (value?.kind !== CachedRouteKind.IMAGE) {\n       throw new Error('invariant attempted to set non-image to image-cache')\n     }"
        },
        {
            "sha": "d26c7cb6285da31a4f19186d0690b0847d5e5a97",
            "filename": "test/integration/image-optimizer/test/disable-write-to-cache-dir.test.ts",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdisable-write-to-cache-dir.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdisable-write-to-cache-dir.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Fdisable-write-to-cache-dir.test.ts?ref=906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106",
            "patch": "@@ -0,0 +1,13 @@\n+import { join } from 'path'\n+import { setupTests } from './util'\n+\n+const appDir = join(__dirname, '../app')\n+const imagesDir = join(appDir, '.next', 'cache', 'images')\n+\n+describe('with isrFlushToDisk false config', () => {\n+  setupTests({\n+    appDir,\n+    imagesDir,\n+    nextConfigExperimental: { isrFlushToDisk: false },\n+  })\n+})"
        },
        {
            "sha": "2a8c43431e4fb733c9d8c3094a1d0425d6699efb",
            "filename": "test/integration/image-optimizer/test/util.ts",
            "status": "modified",
            "additions": 50,
            "deletions": 26,
            "changes": 76,
            "blob_url": "https://github.com/vercel/next.js/blob/906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fimage-optimizer%2Ftest%2Futil.ts?ref=906dfd2b76e5c4d6f04f37dabd8d15f1cdf42106",
            "patch": "@@ -16,11 +16,13 @@ import {\n } from 'next-test-utils'\n import isAnimated from 'next/dist/compiled/is-animated'\n import type { RequestInit } from 'node-fetch'\n+import type { NextConfig } from 'next'\n \n type SetupTestsCtx = {\n   appDir: string\n   imagesDir: string\n   nextConfigImages?: Partial<import('next').NextConfig['images']>\n+  nextConfigExperimental?: Partial<import('next').NextConfig['experimental']>\n   isDev?: boolean\n }\n \n@@ -69,7 +71,10 @@ export async function serveSlowImage() {\n }\n \n export async function fsToJson(dir: string, output = {}) {\n-  const files = await fs.readdir(dir)\n+  const files = await fs.readdir(dir).catch((e: Error) => e)\n+  if (!Array.isArray(files)) {\n+    return output\n+  }\n   for (let file of files) {\n     const fsPath = join(dir, file)\n     const stat = await fs.stat(fsPath)\n@@ -874,6 +879,9 @@ export function runTests(ctx: RunTestsCtx) {\n     })\n \n     it('should use cache and stale-while-revalidate when query is the same for external image', async () => {\n+      if (ctx.nextConfigExperimental?.isrFlushToDisk === false) {\n+        return // this test is not applicable when we don't write the cache\n+      }\n       await cleanImagesDir(ctx)\n       const delay = 500\n \n@@ -903,6 +911,7 @@ export function runTests(ctx: RunTestsCtx) {\n       const etagOne = one.res.headers.get('etag')\n \n       let json1\n+\n       await check(async () => {\n         json1 = await fsToJson(ctx.imagesDir)\n         return Object.keys(json1).some((dir) => {\n@@ -951,6 +960,7 @@ export function runTests(ctx: RunTestsCtx) {\n         expect(four.res.headers.get('Content-Disposition')).toBe(\n           `${contentDispositionType}; filename=\"slow.webp\"`\n         )\n+\n         await check(async () => {\n           const json4 = await fsToJson(ctx.imagesDir)\n           try {\n@@ -1093,6 +1103,9 @@ export function runTests(ctx: RunTestsCtx) {\n   }\n \n   it('should use cache and stale-while-revalidate when query is the same for internal image', async () => {\n+    if (ctx.nextConfigExperimental?.isrFlushToDisk === false) {\n+      return // this test is not applicable when we don't write the cache\n+    }\n     await cleanImagesDir(ctx)\n \n     if (globalThis.isrImgQuality) {\n@@ -1243,6 +1256,9 @@ export function runTests(ctx: RunTestsCtx) {\n   }\n \n   it('should use cached image file when parameters are the same for animated gif', async () => {\n+    if (ctx.nextConfigExperimental?.isrFlushToDisk === false) {\n+      return // this test is not applicable when we don't write the cache\n+    }\n     await cleanImagesDir(ctx)\n \n     const query = { url: '/animated.gif', w: ctx.w, q: 80 }\n@@ -1339,14 +1355,19 @@ export function runTests(ctx: RunTestsCtx) {\n       `${contentDispositionType}; filename=\"test.bmp\"`\n     )\n \n-    await check(async () => {\n-      try {\n-        assert.deepStrictEqual(await fsToJson(ctx.imagesDir), json1)\n-        return 'expected change, but matched'\n-      } catch (_) {\n-        return 'success'\n-      }\n-    }, 'success')\n+    if (ctx.nextConfigExperimental?.isrFlushToDisk === false) {\n+      expect(json1).toEqual({})\n+      expect(await fsToJson(ctx.imagesDir)).toEqual({})\n+    } else {\n+      await check(async () => {\n+        try {\n+          assert.deepStrictEqual(await fsToJson(ctx.imagesDir), json1)\n+          return 'expected change, but matched'\n+        } catch (_) {\n+          return 'success'\n+        }\n+      }, 'success')\n+    }\n   })\n \n   it('should not resize if requested width is larger than original source image', async () => {\n@@ -1458,9 +1479,12 @@ export function runTests(ctx: RunTestsCtx) {\n       await expectWidth(res2, ctx.w)\n       await expectWidth(res3, ctx.w)\n \n+      const length =\n+        ctx.nextConfigExperimental?.isrFlushToDisk === false ? 0 : 1\n+\n       await check(async () => {\n         const json1 = await fsToJson(ctx.imagesDir)\n-        return Object.keys(json1).length === 1 ? 'success' : 'fail'\n+        return Object.keys(json1).length === length ? 'success' : 'fail'\n       }, 'success')\n \n       const xCache = [res1, res2, res3]\n@@ -1492,10 +1516,10 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n \n     beforeAll(async () => {\n       const json = JSON.stringify({\n-        experimental: {\n-          outputFileTracingRoot: join(__dirname, '../../../..'),\n-        },\n-      })\n+        // See https://github.com/vercel/next.js/pull/60972\n+        outputFileTracingRoot: join(__dirname, '../../../..'),\n+        experimental: curCtx.nextConfigExperimental,\n+      } satisfies NextConfig)\n       nextConfig.replace('{ /* replaceme */ }', json)\n       curCtx.nextOutput = ''\n       curCtx.appPort = await findPort()\n@@ -1537,11 +1561,11 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n     }\n     beforeAll(async () => {\n       const json = JSON.stringify({\n+        // See https://github.com/vercel/next.js/pull/60972\n+        outputFileTracingRoot: join(__dirname, '../../../..'),\n         images: curCtx.nextConfigImages,\n-        experimental: {\n-          outputFileTracingRoot: join(__dirname, '../../../..'),\n-        },\n-      })\n+        experimental: curCtx.nextConfigExperimental,\n+      } satisfies NextConfig)\n       curCtx.nextOutput = ''\n       nextConfig.replace('{ /* replaceme */ }', json)\n       await cleanImagesDir(ctx)\n@@ -1575,10 +1599,10 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n     }\n     beforeAll(async () => {\n       const json = JSON.stringify({\n-        experimental: {\n-          outputFileTracingRoot: join(__dirname, '../../../..'),\n-        },\n-      })\n+        // See https://github.com/vercel/next.js/pull/60972\n+        outputFileTracingRoot: join(__dirname, '../../../..'),\n+        experimental: curCtx.nextConfigExperimental,\n+      } satisfies NextConfig)\n       nextConfig.replace('{ /* replaceme */ }', json)\n       curCtx.nextOutput = ''\n       await nextBuild(curCtx.appDir)\n@@ -1621,11 +1645,11 @@ export const setupTests = (ctx: SetupTestsCtx) => {\n     }\n     beforeAll(async () => {\n       const json = JSON.stringify({\n+        // See https://github.com/vercel/next.js/pull/60972\n+        outputFileTracingRoot: join(__dirname, '../../../..'),\n         images: curCtx.nextConfigImages,\n-        experimental: {\n-          outputFileTracingRoot: join(__dirname, '../../../..'),\n-        },\n-      })\n+        experimental: curCtx.nextConfigExperimental,\n+      } satisfies NextConfig)\n       curCtx.nextOutput = ''\n       nextConfig.replace('{ /* replaceme */ }', json)\n       await nextBuild(curCtx.appDir)"
        }
    ],
    "stats": {
        "total": 93,
        "additions": 67,
        "deletions": 26
    }
}