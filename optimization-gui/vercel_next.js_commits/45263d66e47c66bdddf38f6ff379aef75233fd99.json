{
    "author": "huozhi",
    "message": "[fix] clone the config module to avoid mutation (#80573)",
    "sha": "45263d66e47c66bdddf38f6ff379aef75233fd99",
    "files": [
        {
            "sha": "de5150ca36c05515071913ec6481ed5dafa51076",
            "filename": "packages/next/src/server/config.ts",
            "status": "modified",
            "additions": 24,
            "deletions": 3,
            "changes": 27,
            "blob_url": "https://github.com/vercel/next.js/blob/45263d66e47c66bdddf38f6ff379aef75233fd99/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45263d66e47c66bdddf38f6ff379aef75233fd99/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig.ts?ref=45263d66e47c66bdddf38f6ff379aef75233fd99",
            "patch": "@@ -1267,10 +1267,12 @@ export default async function loadConfig(\n       throw err\n     }\n \n-    const userConfig = (await normalizeConfig(\n+    // Clone a new userConfig each time to avoid mutating the original\n+    const loadedConfig = (await normalizeConfig(\n       phase,\n-      userConfigModule.default || userConfigModule\n+      interopDefault(userConfigModule)\n     )) as NextConfig\n+    const userConfig = cloneObject(loadedConfig) as NextConfig\n \n     if (!process.env.NEXT_MINIMAL) {\n       // We only validate the config against schema in non minimal mode\n@@ -1388,7 +1390,7 @@ export default async function loadConfig(\n       userConfig.htmlLimitedBots = userConfig.htmlLimitedBots.source\n     }\n \n-    onLoadUserConfig?.(userConfig)\n+    onLoadUserConfig?.(Object.freeze(loadedConfig))\n     const completeConfig = assignDefaults(\n       dir,\n       {\n@@ -1476,3 +1478,22 @@ export function getConfiguredExperimentalFeatures(\n   }\n   return configuredExperimentalFeatures\n }\n+\n+function cloneObject(obj: any): any {\n+  if (obj === null || typeof obj !== 'object') {\n+    return obj\n+  }\n+\n+  if (Array.isArray(obj)) {\n+    return obj.map(cloneObject)\n+  }\n+  const keys = Object.keys(obj)\n+  if (keys.length === 0) {\n+    return obj\n+  }\n+\n+  return keys.reduce((acc, key) => {\n+    ;(acc as any)[key] = cloneObject(obj[key])\n+    return acc\n+  }, {})\n+}"
        },
        {
            "sha": "88e2d7d48107f496676e88337484dba2d9bc62b0",
            "filename": "test/e2e/app-dir/metadata-streaming/metadata-streaming-customized-rule.test.ts",
            "status": "modified",
            "additions": 9,
            "deletions": 1,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/45263d66e47c66bdddf38f6ff379aef75233fd99/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming-customized-rule.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/45263d66e47c66bdddf38f6ff379aef75233fd99/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming-customized-rule.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-streaming%2Fmetadata-streaming-customized-rule.test.ts?ref=45263d66e47c66bdddf38f6ff379aef75233fd99",
            "patch": "@@ -1,7 +1,7 @@\n import { nextTestSetup } from 'e2e-utils'\n \n describe('app-dir - metadata-streaming-customized-rule', () => {\n-  const { next } = nextTestSetup({\n+  const { next, isNextDev } = nextTestSetup({\n     files: __dirname,\n     overrideFiles: {\n       'next.config.js': `\n@@ -39,4 +39,12 @@ describe('app-dir - metadata-streaming-customized-rule', () => {\n     expect(await $('head title').length).toBe(0)\n     expect(await $('body title').length).toBe(1)\n   })\n+\n+  if (isNextDev) {\n+    it('should not have schema issue', () => {\n+      expect(next.cliOutput).not.toContain(\n+        'Invalid next.config.js options detected'\n+      )\n+    })\n+  }\n })"
        },
        {
            "sha": "ba08da856bf876e95e0f1b77fb82e2dbd79331e9",
            "filename": "test/integration/config-experimental-warning/next.config.js",
            "status": "removed",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/d2d2bf94695c65a12b31bd81c7c1a7f948782969/test%2Fintegration%2Fconfig-experimental-warning%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/d2d2bf94695c65a12b31bd81c7c1a7f948782969/test%2Fintegration%2Fconfig-experimental-warning%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fconfig-experimental-warning%2Fnext.config.js?ref=d2d2bf94695c65a12b31bd81c7c1a7f948782969",
            "patch": "@@ -1,6 +0,0 @@\n-module.exports = {\n-  experimental: {\n-    staticGenerationRetryCount: 2,\n-    staticGenerationMaxConcurrency: 4,\n-  },\n-}"
        }
    ],
    "stats": {
        "total": 43,
        "additions": 33,
        "deletions": 10
    }
}