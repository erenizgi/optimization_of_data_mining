{
    "author": "kdy1",
    "message": "perf(turbopack): Use owned instance of `Code` for `minify()` (#79991)\n\n### What?\n\nAdd `Rope::into_string()` that takes the owned instance of `self` and avoids an extra allocation.\n\n### Why?\n\nWe don't need to go through the `Read` + `Clone` interface in these cases. We construct the `Code` instance, and pass it right away to the `minify` without cloning, so we can even use `String`.",
    "sha": "f9084e30f151638d06af30b270e0900406ef6dde",
    "files": [
        {
            "sha": "1aa6cc3171ff08e3b1856db2136971b417be57c9",
            "filename": "turbopack/crates/turbo-tasks-fs/src/rope.rs",
            "status": "modified",
            "additions": 37,
            "deletions": 5,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-fs%2Fsrc%2Frope.rs?ref=f9084e30f151638d06af30b270e0900406ef6dde",
            "patch": "@@ -18,7 +18,6 @@ use serde_bytes::ByteBuf;\n use tokio::io::{AsyncRead, ReadBuf};\n use triomphe::Arc;\n use turbo_tasks_hash::{DeterministicHash, DeterministicHasher};\n-use unsize::{CoerceUnsize, Coercion};\n \n static EMPTY_BUF: &[u8] = &[];\n \n@@ -42,7 +41,7 @@ pub struct Rope {\n /// An Arc container for ropes. This indirection allows for easily sharing the\n /// contents between Ropes (and also RopeBuilders/RopeReaders).\n #[derive(Clone, Debug)]\n-struct InnerRope(Arc<[RopeElem]>);\n+struct InnerRope(Arc<Vec<RopeElem>>);\n \n /// Differentiates the types of stored bytes in a rope.\n #[derive(Clone, Debug)]\n@@ -117,6 +116,10 @@ impl Rope {\n     pub fn to_bytes(&self) -> Cow<'_, [u8]> {\n         self.data.to_bytes(self.length)\n     }\n+\n+    pub fn into_bytes(self) -> Bytes {\n+        self.data.into_bytes(self.length)\n+    }\n }\n \n impl From<Vec<u8>> for Rope {\n@@ -142,7 +145,7 @@ impl<T: Into<Bytes>> From<T> for Rope {\n         } else {\n             Rope {\n                 length: bytes.len(),\n-                data: InnerRope(Arc::from([Local(bytes)]).unsize(Coercion::to_slice())),\n+                data: InnerRope(Arc::from(vec![Local(bytes)])),\n             }\n         }\n     }\n@@ -536,11 +539,33 @@ impl InnerRope {\n             }\n         }\n     }\n+\n+    fn into_bytes(mut self, len: usize) -> Bytes {\n+        if self.0.is_empty() {\n+            return Bytes::default();\n+        } else if self.0.len() == 1 {\n+            let data = Arc::try_unwrap(self.0);\n+            match data {\n+                Ok(data) => {\n+                    return data.into_iter().next().unwrap().into_bytes(len);\n+                }\n+                Err(data) => {\n+                    self.0 = data;\n+                }\n+            }\n+        }\n+\n+        let mut read = RopeReader::new(&self, 0);\n+        let mut buf = Vec::with_capacity(len);\n+        read.read_to_end(&mut buf)\n+            .expect(\"read of rope cannot fail\");\n+        buf.into()\n+    }\n }\n \n impl Default for InnerRope {\n     fn default() -> Self {\n-        InnerRope(Arc::new([]).unsize(Coercion::to_slice()))\n+        InnerRope(Arc::new(vec![]))\n     }\n }\n \n@@ -579,7 +604,7 @@ impl From<Vec<RopeElem>> for InnerRope {\n }\n \n impl Deref for InnerRope {\n-    type Target = Arc<[RopeElem]>;\n+    type Target = Arc<Vec<RopeElem>>;\n \n     fn deref(&self) -> &Self::Target {\n         &self.0\n@@ -610,6 +635,13 @@ impl RopeElem {\n             _ => None,\n         }\n     }\n+\n+    fn into_bytes(self, len: usize) -> Bytes {\n+        match self {\n+            Local(bytes) => bytes,\n+            Shared(inner) => inner.into_bytes(len),\n+        }\n+    }\n }\n \n impl DeterministicHash for RopeElem {"
        },
        {
            "sha": "70c1f7a6647f6773a6c84189e09b5b9564fd33f9",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/content.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fcontent.rs?ref=f9084e30f151638d06af30b270e0900406ef6dde",
            "patch": "@@ -128,7 +128,7 @@ impl EcmascriptBrowserChunkContent {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(&code, source_maps, mangle)?;\n+            code = minify(code, source_maps, mangle)?;\n         }\n \n         Ok(code.cell())"
        },
        {
            "sha": "67b403defce4c1b5e8fe377d2d813adb16849242",
            "filename": "turbopack/crates/turbopack-browser/src/ecmascript/evaluate/chunk.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fecmascript%2Fevaluate%2Fchunk.rs?ref=f9084e30f151638d06af30b270e0900406ef6dde",
            "patch": "@@ -194,7 +194,7 @@ impl EcmascriptBrowserEvaluateChunk {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(&code, source_maps, mangle)?;\n+            code = minify(code, source_maps, mangle)?;\n         }\n \n         Ok(code.cell())"
        },
        {
            "sha": "693d84a7af3db1b3c8e119bffd08e5131674ba7f",
            "filename": "turbopack/crates/turbopack-core/src/code_builder.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcode_builder.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcode_builder.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fcode_builder.rs?ref=f9084e30f151638d06af30b270e0900406ef6dde",
            "patch": "@@ -34,6 +34,11 @@ impl Code {\n     pub fn has_source_map(&self) -> bool {\n         !self.mappings.is_empty()\n     }\n+\n+    /// Take the source code out of the Code.\n+    pub fn into_source_code(self) -> Rope {\n+        self.code\n+    }\n }\n \n /// CodeBuilder provides a mutable container to append source code."
        },
        {
            "sha": "365f35c0f4b6166b961bceaba19167832d5c4b89",
            "filename": "turbopack/crates/turbopack-ecmascript/src/minify.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 9,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fminify.rs?ref=f9084e30f151638d06af30b270e0900406ef6dde",
            "patch": "@@ -31,17 +31,17 @@ use turbopack_core::{\n use crate::parse::generate_js_source_map;\n \n #[instrument(level = Level::INFO, skip_all)]\n-pub fn minify(code: &Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n+pub fn minify(code: Code, source_maps: bool, mangle: Option<MangleType>) -> Result<Code> {\n     let source_maps = source_maps\n         .then(|| code.generate_source_map_ref())\n         .transpose()?;\n \n+    let source_code = code.into_source_code().into_bytes().into();\n+    let source_code = String::from_utf8(source_code)?;\n+\n     let cm = Arc::new(SwcSourceMap::new(FilePathMapping::empty()));\n     let (src, mut src_map_buf) = {\n-        let fm = cm.new_source_file(\n-            FileName::Anon.into(),\n-            code.source_code().to_str()?.into_owned(),\n-        );\n+        let fm = cm.new_source_file(FileName::Anon.into(), source_code);\n \n         let lexer = Lexer::new(\n             Syntax::default(),\n@@ -57,10 +57,7 @@ pub fn minify(code: &Code, source_maps: bool, mangle: Option<MangleType>) -> Res\n                     Ok(program) => program,\n                     Err(err) => {\n                         err.into_diagnostic(handler).emit();\n-                        bail!(\n-                            \"failed to parse source code\\n{}\",\n-                            code.source_code().to_str()?\n-                        )\n+                        bail!(\"failed to parse source code\\n{}\", fm.src)\n                     }\n                 };\n                 let comments = SingleThreadedComments::default();"
        },
        {
            "sha": "079f9ba6bcc0af7b8d0f35a6e8f8e54677fbb01b",
            "filename": "turbopack/crates/turbopack-nodejs/src/ecmascript/node/content.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f9084e30f151638d06af30b270e0900406ef6dde/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fecmascript%2Fnode%2Fcontent.rs?ref=f9084e30f151638d06af30b270e0900406ef6dde",
            "patch": "@@ -78,7 +78,7 @@ impl EcmascriptBuildNodeChunkContent {\n         let mut code = code.build();\n \n         if let MinifyType::Minify { mangle } = this.chunking_context.await?.minify_type() {\n-            code = minify(&code, source_maps, mangle)?;\n+            code = minify(code, source_maps, mangle)?;\n         }\n \n         Ok(code.cell())"
        }
    ],
    "stats": {
        "total": 68,
        "additions": 51,
        "deletions": 17
    }
}