{
    "author": "bgw",
    "message": "test: Port clean-distdir integration test to the modern e2e test framework (#85828)\n\n@timneutkens pointed out that this test was sometimes flaky with the\nlockfile:\nhttps://vercel.slack.com/archives/C07UCHRBWGK/p1762267195472319\n\nI wasn't able to reproduce this locally, but this test looked like it\nwas in generally rough shape, and the `integration` test directory lacks\ntest isolation, so this at least ports it to the modern framework. If\nnothing else, the test isolation might help.",
    "sha": "f09304af7c64c9bebd517151b2de97ec7252bcfd",
    "files": [
        {
            "sha": "dcfff0dac4b713dabb921f93b1ff5f11e68cc3b8",
            "filename": "test/integration/clean-distdir/test/index.test.ts",
            "status": "removed",
            "additions": 0,
            "deletions": 64,
            "changes": 64,
            "blob_url": "https://github.com/vercel/next.js/blob/db5528317e24e0316e0497716976a715a325ca09/test%2Fintegration%2Fclean-distdir%2Ftest%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/db5528317e24e0316e0497716976a715a325ca09/test%2Fintegration%2Fclean-distdir%2Ftest%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fintegration%2Fclean-distdir%2Ftest%2Findex.test.ts?ref=db5528317e24e0316e0497716976a715a325ca09",
            "patch": "@@ -1,64 +0,0 @@\n-/* eslint-env jest */\n-\n-import fs from 'fs-extra'\n-import { join } from 'path'\n-import { nextBuild } from 'next-test-utils'\n-\n-const appDir = join(__dirname, '../')\n-const nextDir = join(appDir, '.next')\n-const customFile = join(nextDir, '/extra-file.txt')\n-const cacheDir = join(nextDir, '/cache')\n-// const swcCacheDir = join(nextDir, '/cache/swc')\n-const nextConfig = join(appDir, 'next.config.js')\n-\n-let nextConfigContent\n-\n-async function checkFileWrite(existsAfterBuild) {\n-  await nextBuild(appDir, [])\n-  fs.writeFileSync(customFile, 'this is a testing file')\n-  await nextBuild(appDir, [])\n-  expect(fs.existsSync(customFile)).toBe(existsAfterBuild)\n-  // `.next/cache` should be preserved in all cases\n-  expect(fs.existsSync(cacheDir)).toBe(true)\n-  // expect(fs.existsSync(swcCacheDir)).toBe(true)\n-}\n-\n-const runTests = () => {\n-  it('should clean up .next before build start', async () => {\n-    await checkFileWrite(false)\n-  })\n-}\n-\n-describe('Cleaning distDir', () => {\n-  ;(process.env.TURBOPACK_DEV ? describe.skip : describe)(\n-    'production mode',\n-    () => {\n-      beforeAll(() => {\n-        fs.removeSync(nextDir)\n-      })\n-\n-      runTests()\n-\n-      describe('disabled write', () => {\n-        beforeAll(async () => {\n-          nextConfigContent = await fs.readFile(nextConfig, 'utf8')\n-          await fs.writeFile(\n-            nextConfig,\n-            `\n-          module.exports = {\n-            cleanDistDir: false\n-          }\n-        `\n-          )\n-        })\n-        afterAll(async () => {\n-          await fs.writeFile(nextConfig, nextConfigContent)\n-        })\n-\n-        it('should not clean up .next before build start', async () => {\n-          await checkFileWrite(true)\n-        })\n-      })\n-    }\n-  )\n-})"
        },
        {
            "sha": "995ef48c615688bc5fa958f9cdb1d074cb34e98a",
            "filename": "test/production/clean-distdir/index.test.ts",
            "status": "added",
            "additions": 55,
            "deletions": 0,
            "changes": 55,
            "blob_url": "https://github.com/vercel/next.js/blob/f09304af7c64c9bebd517151b2de97ec7252bcfd/test%2Fproduction%2Fclean-distdir%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f09304af7c64c9bebd517151b2de97ec7252bcfd/test%2Fproduction%2Fclean-distdir%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fclean-distdir%2Findex.test.ts?ref=f09304af7c64c9bebd517151b2de97ec7252bcfd",
            "patch": "@@ -0,0 +1,55 @@\n+/* eslint-env jest */\n+\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('Cleaning distDir', () => {\n+  const { next, isTurbopack, skipped } = nextTestSetup({\n+    files: __dirname,\n+    skipDeployment: true,\n+    skipStart: true,\n+  })\n+\n+  if (skipped) return\n+\n+  beforeEach(async () => {\n+    await next.stop()\n+    await next.remove('.next')\n+  })\n+\n+  async function checkFileWrite(existsAfterBuild: boolean) {\n+    await next.build()\n+\n+    const customFile = '.next/extra-file.txt'\n+    await next.patchFile(customFile, 'this is a testing file')\n+\n+    await next.build()\n+\n+    expect(await next.hasFile(customFile)).toBe(existsAfterBuild)\n+\n+    // `.next/cache` should be preserved in all cases\n+    expect(await next.hasFile('.next/cache')).toBe(true)\n+    if (!isTurbopack) {\n+      expect(await next.hasFile('.next/cache/swc')).toBe(true)\n+    }\n+  }\n+\n+  describe('disabled write', () => {\n+    it('should clean up .next before build start', async () => {\n+      await checkFileWrite(false)\n+    })\n+\n+    it('should not clean up .next before build start', async () => {\n+      await next.patchFile(\n+        'next.config.js',\n+        `\n+          module.exports = {\n+            cleanDistDir: false\n+          }\n+        `,\n+        async () => {\n+          await checkFileWrite(true)\n+        }\n+      )\n+    })\n+  })\n+})"
        },
        {
            "sha": "4ba52ba2c8df6758685c8f65f490306b5c44eb76",
            "filename": "test/production/clean-distdir/next.config.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f09304af7c64c9bebd517151b2de97ec7252bcfd/test%2Fproduction%2Fclean-distdir%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f09304af7c64c9bebd517151b2de97ec7252bcfd/test%2Fproduction%2Fclean-distdir%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fclean-distdir%2Fnext.config.js?ref=f09304af7c64c9bebd517151b2de97ec7252bcfd",
            "previous_filename": "test/integration/clean-distdir/next.config.js"
        },
        {
            "sha": "f6c15d1f66e8a6d311ba78b7bdeb9b9763448937",
            "filename": "test/production/clean-distdir/pages/index.js",
            "status": "renamed",
            "additions": 0,
            "deletions": 0,
            "changes": 0,
            "blob_url": "https://github.com/vercel/next.js/blob/f09304af7c64c9bebd517151b2de97ec7252bcfd/test%2Fproduction%2Fclean-distdir%2Fpages%2Findex.js",
            "raw_url": "https://github.com/vercel/next.js/raw/f09304af7c64c9bebd517151b2de97ec7252bcfd/test%2Fproduction%2Fclean-distdir%2Fpages%2Findex.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fproduction%2Fclean-distdir%2Fpages%2Findex.js?ref=f09304af7c64c9bebd517151b2de97ec7252bcfd",
            "previous_filename": "test/integration/clean-distdir/pages/index.js"
        }
    ],
    "stats": {
        "total": 119,
        "additions": 55,
        "deletions": 64
    }
}