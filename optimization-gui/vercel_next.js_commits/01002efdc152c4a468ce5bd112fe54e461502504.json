{
    "author": "bgw",
    "message": "chore(dev-overlay): Minor cleanups to useDelayedRender hook (#79119)\n\nI noticed a few minor issues/nits while reading through this:\n\n- The refs aren't needed for a local variable. `useEffect`'s cancellation is called every time the inputs to `useEffect` change, so there's no need to hold timeout ids across `useEffects`.\n- Getting rid of the refs also lets use get rid of `useCallback`. Note: It's totally acceptable and idiomatic to call `clearTimeout` with a potentially-`undefined` value. That's explicitly allowed in the typescript definition.\n- `useEffect` shouldn't depend on the object. The object destructuring should happen outside of the `useEffect`. Hook dependencies are compared via referential equality, not structural equality, so this could have unintended effects.\n- Most places in Next.js seem to use the global `setTimeout` directly instead of accessing it through `window`?\n\nI tested this by increasing the duration of the animation, playing with the overlay menu, and watching the DOM for the unmount:\n\n[Screen Recording 2025-05-12 at 4.25.32â€¯PM.mov <span class=\"graphite__hidden\">(uploaded via Graphite)</span> <img class=\"graphite__hidden\" src=\"https://app.graphite.dev/api/v1/graphite/video/thumbnail/HAZVitxRNnZz8QMiPn4a/47d98858-e344-4532-b60f-c68561f5347f.mov\" />](https://app.graphite.dev/media/video/HAZVitxRNnZz8QMiPn4a/47d98858-e344-4532-b60f-c68561f5347f.mov)",
    "sha": "01002efdc152c4a468ce5bd112fe54e461502504",
    "files": [
        {
            "sha": "4653f2d83bc1859003c2663c19b233fbbfdd595c",
            "filename": "packages/next/src/client/components/react-dev-overlay/ui/hooks/use-delayed-render.ts",
            "status": "modified",
            "additions": 13,
            "deletions": 21,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/01002efdc152c4a468ce5bd112fe54e461502504/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fhooks%2Fuse-delayed-render.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/01002efdc152c4a468ce5bd112fe54e461502504/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fhooks%2Fuse-delayed-render.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Freact-dev-overlay%2Fui%2Fhooks%2Fuse-delayed-render.ts?ref=01002efdc152c4a468ce5bd112fe54e461502504",
            "patch": "@@ -1,11 +1,13 @@\n-import { useState, useRef, useCallback, useEffect } from 'react'\n+import { useState, useEffect } from 'react'\n \n interface Options {\n   enterDelay?: number\n   exitDelay?: number\n   onUnmount?: () => void\n }\n \n+type Timeout = ReturnType<typeof setTimeout>\n+\n /**\n  * Useful to perform CSS transitions on React components without\n  * using libraries like Framer Motion. This hook will defer the\n@@ -34,31 +36,18 @@ interface Options {\n export function useDelayedRender(active = false, options: Options = {}) {\n   const [mounted, setMounted] = useState(active)\n   const [rendered, setRendered] = useState(false)\n-  const renderTimerRef = useRef<number | null>(null)\n-  const unmountTimerRef = useRef<number | null>(null)\n-\n-  const clearTimers = useCallback(() => {\n-    if (renderTimerRef.current !== null) {\n-      window.clearTimeout(renderTimerRef.current)\n-      renderTimerRef.current = null\n-    }\n-    if (unmountTimerRef.current !== null) {\n-      window.clearTimeout(unmountTimerRef.current)\n-      unmountTimerRef.current = null\n-    }\n-  }, [])\n \n+  const { enterDelay = 1, exitDelay = 0 } = options\n   useEffect(() => {\n-    const { enterDelay = 1, exitDelay = 0 } = options\n-\n-    clearTimers()\n+    let renderTimeout: Timeout | undefined\n+    let unmountTimeout: Timeout | undefined\n \n     if (active) {\n       setMounted(true)\n       if (enterDelay <= 0) {\n         setRendered(true)\n       } else {\n-        renderTimerRef.current = window.setTimeout(() => {\n+        renderTimeout = setTimeout(() => {\n           setRendered(true)\n         }, enterDelay)\n       }\n@@ -67,14 +56,17 @@ export function useDelayedRender(active = false, options: Options = {}) {\n       if (exitDelay <= 0) {\n         setMounted(false)\n       } else {\n-        unmountTimerRef.current = window.setTimeout(() => {\n+        unmountTimeout = setTimeout(() => {\n           setMounted(false)\n         }, exitDelay)\n       }\n     }\n \n-    return clearTimers\n-  }, [active, options, clearTimers])\n+    return () => {\n+      clearTimeout(renderTimeout)\n+      clearTimeout(unmountTimeout)\n+    }\n+  }, [active, enterDelay, exitDelay])\n \n   return { mounted, rendered }\n }"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 13,
        "deletions": 21
    }
}