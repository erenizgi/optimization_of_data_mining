{
    "author": "mischnic",
    "message": "Turbopack: ChunkGroup in evaluated_chunk_group (#76593)\n\n<!-- Thanks for opening a PR! Your contribution is much appreciated.\nTo make sure your PR is handled as smoothly as possible we request that you follow the checklist sections below.\nChoose the right checklist for the change(s) that you're making:\n\n## For Contributors\n\n### Improving Documentation\n\n- Run `pnpm prettier-fix` to fix formatting issues before opening the PR.\n- Read the Docs Contribution Guide to ensure your contribution follows the docs guidelines: https://nextjs.org/docs/community/contribution-guide\n\n### Adding or Updating Examples\n\n- The \"examples guidelines\" are followed from our contributing doc https://github.com/vercel/next.js/blob/canary/contributing/examples/adding-examples.md\n- Make sure the linting passes by running `pnpm build && pnpm lint`. See https://github.com/vercel/next.js/blob/canary/contributing/repository/linting.md\n\n### Fixing a bug\n\n- Related issues linked using `fixes #number`\n- Tests added. See: https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n### Adding a feature\n\n- Implements an existing feature request or RFC. Make sure the feature request has been accepted for implementation before opening a PR. (A discussion must be opened, see https://github.com/vercel/next.js/discussions/new?category=ideas)\n- Related issues/discussions are linked using `fixes #number`\n- e2e tests added (https://github.com/vercel/next.js/blob/canary/contributing/core/testing.md#writing-tests-for-nextjs)\n- Documentation added\n- Telemetry added. In case of a feature if it's used or not.\n- Errors have a helpful link attached, see https://github.com/vercel/next.js/blob/canary/contributing.md\n\n\n## For Maintainers\n\n- Minimal description (aim for explaining to someone not on the team to understand the PR)\n- When linking to a Slack thread, you might want to share details of the conclusion\n- Link both the Linear (Fixes NEXT-xxx) and the GitHub issues\n- Add review comments if necessary to explain to the reviewer the logic behind a change\n\n### What?\n\n### Why?\n\n### How?\n\nCloses NEXT-\nFixes #\n\n-->",
    "sha": "afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
    "files": [
        {
            "sha": "230d7eeb2c546d3e3a623d82f952df40c2c182da",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 7,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -1677,23 +1677,27 @@ impl AppEndpoint {\n                 } = *chunking_context\n                     .evaluated_chunk_group(\n                         server_action_manifest_loader.ident(),\n-                        Vc::cell(vec![server_action_manifest_loader]),\n+                        ChunkGroup::Entry(\n+                            [ResolvedVc::upcast(server_action_manifest_loader)]\n+                                .into_iter()\n+                                .collect(),\n+                        ),\n                         module_graph,\n                         Value::new(AvailabilityInfo::Root),\n                     )\n                     .await?;\n \n-                let mut evaluatable_assets =\n-                    this.app_project.edge_rsc_runtime_entries().owned().await?;\n-                let evaluatable = ResolvedVc::try_sidecast(app_entry.rsc_entry)\n-                    .context(\"Entry module must be evaluatable\")?;\n-                evaluatable_assets.push(evaluatable);\n+                let edge_rsc_runtime_entries = this.app_project.edge_rsc_runtime_entries().await?;\n+                let evaluatable_assets = edge_rsc_runtime_entries\n+                    .iter()\n+                    .map(|m| ResolvedVc::upcast(*m))\n+                    .chain(std::iter::once(app_entry.rsc_entry));\n \n                 assets.concatenate(\n                     chunking_context\n                         .evaluated_chunk_group_assets(\n                             app_entry.rsc_entry.ident(),\n-                            Vc::cell(evaluatable_assets.clone()),\n+                            ChunkGroup::Entry(evaluatable_assets.collect()),\n                             module_graph,\n                             Value::new(availability_info),\n                         )"
        },
        {
            "sha": "a1226107301c8fa688835be6bfb1310d70b681bd",
            "filename": "crates/next-api/src/instrumentation.rs",
            "status": "modified",
            "additions": 12,
            "deletions": 19,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Finstrumentation.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -17,13 +17,15 @@ use turbopack_core::{\n     },\n     context::AssetContext,\n     module::Module,\n-    module_graph::{chunk_group_info::ChunkGroupEntry, GraphEntries},\n+    module_graph::{\n+        chunk_group_info::{ChunkGroup, ChunkGroupEntry},\n+        GraphEntries,\n+    },\n     output::{OutputAsset, OutputAssets},\n     reference_type::{EntryReferenceSubType, ReferenceType},\n     source::Source,\n     virtual_output::VirtualOutputAsset,\n };\n-use turbopack_ecmascript::chunk::EcmascriptChunkPlaceable;\n \n use crate::{\n     nft_json::NftJsonAsset,\n@@ -98,12 +100,11 @@ impl InstrumentationEndpoint {\n     #[turbo_tasks::function]\n     async fn edge_files(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n         let this = self.await?;\n-\n         let module = self.core_modules().await?.edge_entry_module;\n \n         let module_graph = this.project.module_graph(*module);\n \n-        let mut evaluatable_assets = get_server_runtime_entries(\n+        let evaluatable_assets = get_server_runtime_entries(\n             Value::new(ServerContextType::Instrumentation {\n                 app_dir: this.app_dir,\n                 ecmascript_client_reference_transition_name: this\n@@ -112,24 +113,16 @@ impl InstrumentationEndpoint {\n             this.project.next_mode(),\n         )\n         .resolve_entries(*this.asset_context)\n-        .owned()\n-        .await?;\n-\n-        let Some(module) = ResolvedVc::try_downcast::<Box<dyn EcmascriptChunkPlaceable>>(module)\n-        else {\n-            bail!(\"Entry module must be evaluatable\");\n-        };\n-\n-        let Some(evaluatable) = ResolvedVc::try_sidecast(module) else {\n-            bail!(\"Entry module must be evaluatable\");\n-        };\n-        evaluatable_assets.push(evaluatable);\n+        .await?\n+        .iter()\n+        .map(|m| ResolvedVc::upcast(*m))\n+        .chain(std::iter::once(module))\n+        .collect();\n \n         let edge_chunking_context = this.project.edge_chunking_context(false);\n-\n-        let edge_files = edge_chunking_context.evaluated_chunk_group_assets(\n+        let edge_files: Vc<OutputAssets> = edge_chunking_context.evaluated_chunk_group_assets(\n             module.ident(),\n-            Vc::cell(evaluatable_assets),\n+            ChunkGroup::Entry(evaluatable_assets),\n             module_graph,\n             Value::new(AvailabilityInfo::Root),\n         );"
        },
        {
            "sha": "eb85bc8dd6a660b0cf08ab0869f6501662e3084f",
            "filename": "crates/next-api/src/middleware.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 23,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fmiddleware.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -1,6 +1,6 @@\n use std::future::IntoFuture;\n \n-use anyhow::{bail, Context, Result};\n+use anyhow::{bail, Result};\n use next_core::{\n     all_assets_from_entries,\n     middleware::get_middleware_module,\n@@ -17,17 +17,19 @@ use turbopack_core::{\n     asset::AssetContent,\n     chunk::{\n         availability_info::AvailabilityInfo, ChunkingContext, ChunkingContextExt,\n-        EntryChunkGroupResult, EvaluatableAsset,\n+        EntryChunkGroupResult,\n     },\n     context::AssetContext,\n     module::Module,\n-    module_graph::{chunk_group_info::ChunkGroupEntry, GraphEntries},\n+    module_graph::{\n+        chunk_group_info::{ChunkGroup, ChunkGroupEntry},\n+        GraphEntries,\n+    },\n     output::{OutputAsset, OutputAssets},\n     reference_type::{EntryReferenceSubType, ReferenceType},\n     source::Source,\n     virtual_output::VirtualOutputAsset,\n };\n-use turbopack_ecmascript::chunk::EcmascriptChunkPlaceable;\n \n use crate::{\n     nft_json::NftJsonAsset,\n@@ -103,7 +105,9 @@ impl MiddlewareEndpoint {\n     #[turbo_tasks::function]\n     async fn edge_files(self: Vc<Self>) -> Result<Vc<OutputAssets>> {\n         let this = self.await?;\n-        let module = self.entry_module();\n+        let module = self.entry_module().to_resolved().await?;\n+\n+        let module_graph = this.project.module_graph(*module);\n \n         let evaluatable_assets = get_server_runtime_entries(\n             Value::new(ServerContextType::Middleware {\n@@ -113,28 +117,17 @@ impl MiddlewareEndpoint {\n             }),\n             this.project.next_mode(),\n         )\n-        .resolve_entries(*this.asset_context);\n-\n-        let mut evaluatable_assets = evaluatable_assets.owned().await?;\n-\n-        let Some(module) =\n-            Vc::try_resolve_downcast::<Box<dyn EcmascriptChunkPlaceable>>(module).await?\n-        else {\n-            bail!(\"Entry module must be evaluatable\");\n-        };\n-        let evaluatable = Vc::try_resolve_sidecast::<Box<dyn EvaluatableAsset>>(module)\n-            .await?\n-            .context(\"Entry module must be evaluatable\")?;\n-        evaluatable_assets.push(evaluatable.to_resolved().await?);\n-\n-        let evaluatable_assets = Vc::cell(evaluatable_assets);\n-        let module_graph = this.project.module_graph_for_entries(evaluatable_assets);\n+        .resolve_entries(*this.asset_context)\n+        .await?\n+        .iter()\n+        .map(|m| ResolvedVc::upcast(*m))\n+        .chain(std::iter::once(module))\n+        .collect();\n \n         let edge_chunking_context = this.project.edge_chunking_context(false);\n-\n         let edge_files = edge_chunking_context.evaluated_chunk_group_assets(\n             module.ident(),\n-            evaluatable_assets,\n+            ChunkGroup::Entry(evaluatable_assets),\n             module_graph,\n             Value::new(AvailabilityInfo::Root),\n         );"
        },
        {
            "sha": "ea10b60bf2f1b6254891f6db8d7722a52f7b6adc",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 17,
            "deletions": 6,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -52,7 +52,10 @@ use turbopack_core::{\n     file_source::FileSource,\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::{chunk_group_info::ChunkGroupEntry, GraphEntries, ModuleGraph},\n+    module_graph::{\n+        chunk_group_info::{ChunkGroup, ChunkGroupEntry},\n+        GraphEntries, ModuleGraph,\n+    },\n     output::{OptionOutputAsset, OutputAsset, OutputAssets},\n     reference_type::{EcmaScriptModulesReferenceSubType, EntryReferenceSubType, ReferenceType},\n     resolve::{origin::PlainResolveOrigin, parse::Request, pattern::Pattern},\n@@ -782,10 +785,15 @@ impl PageEndpoint {\n \n             let module_graph = self.client_module_graph();\n \n-            let evaluatable_assets = self.client_evaluatable_assets();\n+            let evaluatable_assets = self\n+                .client_evaluatable_assets()\n+                .await?\n+                .iter()\n+                .map(|m| ResolvedVc::upcast(*m))\n+                .collect();\n             let client_chunk_group = client_chunking_context.evaluated_chunk_group(\n                 AssetIdent::from_path(*this.page.await?.base_path),\n-                evaluatable_assets,\n+                ChunkGroup::Entry(evaluatable_assets),\n                 module_graph,\n                 Value::new(AvailabilityInfo::Root),\n             );\n@@ -948,13 +956,16 @@ impl PageEndpoint {\n                 .context(\"could not process page loader entry module\")?;\n             let is_edge = matches!(runtime, NextRuntime::Edge);\n             if is_edge {\n-                let mut evaluatable_assets = edge_runtime_entries.owned().await?;\n-                evaluatable_assets.push(ssr_module_evaluatable);\n+                let edge_runtime_entries = edge_runtime_entries.await?;\n+                let evaluatable_assets = edge_runtime_entries\n+                    .iter()\n+                    .map(|m| ResolvedVc::upcast(*m))\n+                    .chain(std::iter::once(ResolvedVc::upcast(ssr_module_evaluatable)));\n \n                 let edge_files = edge_chunking_context\n                     .evaluated_chunk_group_assets(\n                         ssr_module.ident(),\n-                        Vc::cell(evaluatable_assets),\n+                        ChunkGroup::Entry(evaluatable_assets.collect()),\n                         module_graph,\n                         Value::new(AvailabilityInfo::Root),\n                     )"
        },
        {
            "sha": "364bc9b62fe25f9bbf49cf3293998a84d3eefa08",
            "filename": "crates/next-core/src/next_app/app_client_shared_chunks.rs",
            "status": "modified",
            "additions": 23,
            "deletions": 9,
            "changes": 32,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_shared_chunks.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_shared_chunks.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_client_shared_chunks.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -1,11 +1,12 @@\n use anyhow::Result;\n-use turbo_tasks::{Value, Vc};\n+use tracing::Instrument;\n+use turbo_tasks::{ResolvedVc, Value, Vc};\n use turbopack_core::{\n     chunk::{\n         availability_info::AvailabilityInfo, ChunkGroupResult, ChunkingContext, EvaluatableAssets,\n     },\n     ident::AssetIdent,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::OutputAssets,\n };\n \n@@ -24,13 +25,26 @@ pub async fn get_app_client_shared_chunk_group(\n         .cell());\n     }\n \n-    let _span = tracing::trace_span!(\"app client shared\").entered();\n-    let app_client_shared_chunk_grou = client_chunking_context.evaluated_chunk_group(\n-        ident,\n-        app_client_runtime_entries,\n-        module_graph,\n-        Value::new(AvailabilityInfo::Root),\n-    );\n+    let span = tracing::trace_span!(\"app client shared\");\n+    let app_client_shared_chunk_grou = async {\n+        client_chunking_context\n+            .evaluated_chunk_group(\n+                ident,\n+                ChunkGroup::Entry(\n+                    app_client_runtime_entries\n+                        .await?\n+                        .iter()\n+                        .map(|v| ResolvedVc::upcast(*v))\n+                        .collect(),\n+                ),\n+                module_graph,\n+                Value::new(AvailabilityInfo::Root),\n+            )\n+            .resolve()\n+            .await\n+    }\n+    .instrument(span)\n+    .await?;\n \n     Ok(app_client_shared_chunk_grou)\n }"
        },
        {
            "sha": "a14c071547662c46ee35cc9567a8e71768a78da7",
            "filename": "turbopack/crates/turbopack-browser/src/chunking_context.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 10,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-browser%2Fsrc%2Fchunking_context.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -10,8 +10,8 @@ use turbopack_core::{\n         chunk_group::{make_chunk_group, MakeChunkGroupResult},\n         module_id_strategies::{DevModuleIdStrategy, ModuleIdStrategy},\n         Chunk, ChunkGroupResult, ChunkItem, ChunkableModule, ChunkingConfig, ChunkingConfigs,\n-        ChunkingContext, EntryChunkGroupResult, EvaluatableAssets, MinifyType, ModuleId,\n-        SourceMapsType,\n+        ChunkingContext, EntryChunkGroupResult, EvaluatableAsset, EvaluatableAssets, MinifyType,\n+        ModuleId, SourceMapsType,\n     },\n     environment::Environment,\n     ident::AssetIdent,\n@@ -497,7 +497,7 @@ impl ChunkingContext for BrowserChunkingContext {\n     async fn evaluated_chunk_group(\n         self: ResolvedVc<Self>,\n         ident: Vc<AssetIdent>,\n-        evaluatable_assets: Vc<EvaluatableAssets>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Result<Vc<ChunkGroupResult>> {\n@@ -509,11 +509,7 @@ impl ChunkingContext for BrowserChunkingContext {\n             let this = self.await?;\n             let availability_info = availability_info.into_value();\n \n-            let evaluatable_assets_ref = evaluatable_assets.await?;\n-\n-            let entries = evaluatable_assets_ref\n-                .iter()\n-                .map(|&evaluatable| ResolvedVc::upcast(evaluatable));\n+            let entries = chunk_group.entries();\n \n             let MakeChunkGroupResult {\n                 chunks,\n@@ -534,11 +530,21 @@ impl ChunkingContext for BrowserChunkingContext {\n \n             let other_assets = Vc::cell(assets.clone());\n \n+            let entries = Vc::cell(\n+                chunk_group\n+                    .entries()\n+                    .map(|m| {\n+                        ResolvedVc::try_downcast::<Box<dyn EvaluatableAsset>>(m)\n+                            .context(\"evaluated_chunk_group entries must be evaluatable assets\")\n+                    })\n+                    .collect::<Result<Vec<_>>>()?,\n+            );\n+\n             if this.enable_hot_module_replacement {\n                 assets.push(\n                     self.generate_chunk_list_register_chunk(\n                         ident,\n-                        evaluatable_assets,\n+                        entries,\n                         other_assets,\n                         Value::new(EcmascriptDevChunkListSource::Entry),\n                     )\n@@ -548,7 +554,7 @@ impl ChunkingContext for BrowserChunkingContext {\n             }\n \n             assets.push(\n-                self.generate_evaluate_chunk(ident, other_assets, evaluatable_assets, module_graph)\n+                self.generate_evaluate_chunk(ident, other_assets, entries, module_graph)\n                     .to_resolved()\n                     .await?,\n             );"
        },
        {
            "sha": "3b3c7eace299614ef162248592930b6e79e5976e",
            "filename": "turbopack/crates/turbopack-cli/src/build/mod.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 2,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-cli%2Fsrc%2Fbuild%2Fmod.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -29,7 +29,10 @@ use turbopack_core::{\n     ident::AssetIdent,\n     issue::{handle_issues, IssueReporter, IssueSeverity},\n     module::Module,\n-    module_graph::{chunk_group_info::ChunkGroupEntry, ModuleGraph},\n+    module_graph::{\n+        chunk_group_info::{ChunkGroup, ChunkGroupEntry},\n+        ModuleGraph,\n+    },\n     output::{OutputAsset, OutputAssets},\n     reference::all_assets_from_entries,\n     reference_type::{EntryReferenceSubType, ReferenceType},\n@@ -396,7 +399,9 @@ async fn build_internal(\n                                             )\n                                             .with_extension(\"entry.js\".into()),\n                                     ),\n-                                    EvaluatableAssets::one(*ResolvedVc::upcast(ecmascript)),\n+                                    ChunkGroup::Entry(\n+                                        [ResolvedVc::upcast(ecmascript)].into_iter().collect(),\n+                                    ),\n                                     module_graph,\n                                     Value::new(AvailabilityInfo::Root),\n                                 )"
        },
        {
            "sha": "6e4357aeb2d018054aee1355afe50a9f4b731a4c",
            "filename": "turbopack/crates/turbopack-core/src/chunk/chunking_context.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 6,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-core%2Fsrc%2Fchunk%2Fchunking_context.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -194,7 +194,7 @@ pub trait ChunkingContext {\n     fn evaluated_chunk_group(\n         self: Vc<Self>,\n         ident: Vc<AssetIdent>,\n-        evaluatable_assets: Vc<EvaluatableAssets>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Vc<ChunkGroupResult>;\n@@ -247,7 +247,7 @@ pub trait ChunkingContextExt {\n     fn evaluated_chunk_group_assets(\n         self: Vc<Self>,\n         ident: Vc<AssetIdent>,\n-        evaluatable_assets: Vc<EvaluatableAssets>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Vc<OutputAssets>\n@@ -323,14 +323,14 @@ impl<T: ChunkingContext + Send + Upcast<Box<dyn ChunkingContext>>> ChunkingConte\n     fn evaluated_chunk_group_assets(\n         self: Vc<Self>,\n         ident: Vc<AssetIdent>,\n-        evaluatable_assets: Vc<EvaluatableAssets>,\n+        chunk_group: ChunkGroup,\n         module_graph: Vc<ModuleGraph>,\n         availability_info: Value<AvailabilityInfo>,\n     ) -> Vc<OutputAssets> {\n         evaluated_chunk_group_assets(\n             Vc::upcast(self),\n             ident,\n-            evaluatable_assets,\n+            chunk_group,\n             module_graph,\n             availability_info,\n         )\n@@ -421,12 +421,12 @@ async fn root_chunk_group_assets(\n async fn evaluated_chunk_group_assets(\n     chunking_context: Vc<Box<dyn ChunkingContext>>,\n     ident: Vc<AssetIdent>,\n-    evaluatable_assets: Vc<EvaluatableAssets>,\n+    chunk_group: ChunkGroup,\n     module_graph: Vc<ModuleGraph>,\n     availability_info: Value<AvailabilityInfo>,\n ) -> Result<Vc<OutputAssets>> {\n     Ok(*chunking_context\n-        .evaluated_chunk_group(ident, evaluatable_assets, module_graph, availability_info)\n+        .evaluated_chunk_group(ident, chunk_group, module_graph, availability_info)\n         .await?\n         .assets)\n }"
        },
        {
            "sha": "2ebfbe93c093ec809700bd5a46ac0705e2882f96",
            "filename": "turbopack/crates/turbopack-dev-server/src/html.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fhtml.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fhtml.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-dev-server%2Fsrc%2Fhtml.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -156,7 +156,13 @@ impl DevHtmlAsset {\n                         };\n                     chunking_context.evaluated_chunk_group_assets(\n                         chunkable_module.ident(),\n-                        *runtime_entries,\n+                        ChunkGroup::Entry(\n+                            runtime_entries\n+                                .await?\n+                                .iter()\n+                                .map(|v| ResolvedVc::upcast(*v))\n+                                .collect(),\n+                        ),\n                         *module_graph,\n                         Value::new(AvailabilityInfo::Root),\n                     )"
        },
        {
            "sha": "fbce115f1026a49ef2fe07117bcb97ea113f6702",
            "filename": "turbopack/crates/turbopack-ecmascript/src/worker_chunk/chunk_item.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 13,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fworker_chunk%2Fchunk_item.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fworker_chunk%2Fchunk_item.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript%2Fsrc%2Fworker_chunk%2Fchunk_item.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -1,15 +1,15 @@\n-use anyhow::{bail, Result};\n+use anyhow::Result;\n use indoc::formatdoc;\n use turbo_rcstr::RcStr;\n-use turbo_tasks::{ResolvedVc, TryJoinIterExt, Value, ValueToString, Vc};\n+use turbo_tasks::{ResolvedVc, TryJoinIterExt, Value, Vc};\n use turbopack_core::{\n     chunk::{\n         availability_info::AvailabilityInfo, ChunkData, ChunkItem, ChunkType, ChunkingContext,\n-        ChunkingContextExt, ChunksData, EvaluatableAsset, EvaluatableAssets,\n+        ChunkingContextExt, ChunksData,\n     },\n     ident::AssetIdent,\n     module::Module,\n-    module_graph::ModuleGraph,\n+    module_graph::{chunk_group_info::ChunkGroup, ModuleGraph},\n     output::OutputAssets,\n };\n \n@@ -41,21 +41,13 @@ impl WorkerLoaderChunkItem {\n     async fn chunks(&self) -> Result<Vc<OutputAssets>> {\n         let module = self.module.await?;\n \n-        let Some(evaluatable) = ResolvedVc::try_downcast::<Box<dyn EvaluatableAsset>>(module.inner)\n-        else {\n-            bail!(\n-                \"{} is not evaluatable for Worker loader module\",\n-                module.inner.ident().to_string().await?\n-            );\n-        };\n-\n         Ok(self.chunking_context.evaluated_chunk_group_assets(\n             AssetIdent::from_path(\n                 self.chunking_context\n                     .chunk_path(module.inner.ident(), \".js\".into()),\n             )\n             .with_modifier(worker_modifier()),\n-            EvaluatableAssets::empty().with_entry(*evaluatable),\n+            ChunkGroup::Isolated(ResolvedVc::upcast(module.inner)),\n             *self.module_graph,\n             Value::new(AvailabilityInfo::Root),\n         ))"
        },
        {
            "sha": "c4dcd3dac1c11b70461326cb51614a0590bda708",
            "filename": "turbopack/crates/turbopack-nodejs/src/chunking_context.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-nodejs%2Fsrc%2Fchunking_context.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -442,7 +442,7 @@ impl ChunkingContext for NodeJsChunkingContext {\n     fn evaluated_chunk_group(\n         self: Vc<Self>,\n         _ident: Vc<AssetIdent>,\n-        _evaluatable_assets: Vc<EvaluatableAssets>,\n+        _chunk_group: ChunkGroup,\n         _module_graph: Vc<ModuleGraph>,\n         _availability_info: Value<AvailabilityInfo>,\n     ) -> Result<Vc<ChunkGroupResult>> {"
        },
        {
            "sha": "3006b9dfdb5a000cd18022ca38b5bff8dc549a23",
            "filename": "turbopack/crates/turbopack-tests/tests/snapshot.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 4,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/afa3c94b986dc0dc600b19f37d7e707e1dac7e33/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-tests%2Ftests%2Fsnapshot.rs?ref=afa3c94b986dc0dc600b19f37d7e707e1dac7e33",
            "patch": "@@ -45,7 +45,10 @@ use turbopack_core::{\n     free_var_references,\n     issue::{Issue, IssueDescriptionExt},\n     module::Module,\n-    module_graph::{chunk_group_info::ChunkGroupEntry, ModuleGraph},\n+    module_graph::{\n+        chunk_group_info::{ChunkGroup, ChunkGroupEntry},\n+        ModuleGraph,\n+    },\n     output::{OutputAsset, OutputAssets},\n     reference_type::{EntryReferenceSubType, ReferenceType},\n     source::Source,\n@@ -396,14 +399,14 @@ async fn run_test_operation(resource: RcStr) -> Result<Vc<FileSystemPath>> {\n             .iter()\n             .copied()\n             .map(ResolvedVc::upcast)\n-            .collect();\n+            .collect::<Vec<_>>();\n         let module_graph =\n-            ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(all_modules)]));\n+            ModuleGraph::from_modules(Vc::cell(vec![ChunkGroupEntry::Entry(all_modules.clone())]));\n         // TODO: Load runtime entries from snapshots\n         match options.runtime {\n             Runtime::Browser => chunking_context.evaluated_chunk_group_assets(\n                 entry_module.ident(),\n-                evaluatable_assets,\n+                ChunkGroup::Entry(all_modules.into_iter().collect()),\n                 module_graph,\n                 Value::new(AvailabilityInfo::Root),\n             ),"
        }
    ],
    "stats": {
        "total": 229,
        "additions": 128,
        "deletions": 101
    }
}