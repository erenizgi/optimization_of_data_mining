{
    "author": "Cy-Tek",
    "message": "fix(turbopack): Fix a panic when the generated hash is too short when radix formatting a string. (#80966)\n\n## Fix hash length check in metadata formatting\n\n### What?\nFixed a panic in the `format_radix` function when the generated hash is\nshorter than 6 characters.\n\n### Why?\nThe current implementation always tries to take the first 6 characters\nof the hash using a fixed slice `result[..6]`, which would panic if the\nhash is shorter than 6 characters. This doesn't match the JavaScript\nbehavior where `toString(36).slice(0, 6)` automatically takes the\nminimum of the hash length and 6.\n\n### How?\nAdded a check to determine the minimum length between the hash length\nand 6, then use that value for slicing:\n```rust\nlet len = result.len().min(6);\nresult[..len].iter().collect()\n```\n\nFixes #PACK-4495",
    "sha": "ee5c6eb73f3a3dd2d1b474664f1b93a1d397ed93",
    "files": [
        {
            "sha": "cf187c878dd61a3b0ad0d679b9fb3394aee7618b",
            "filename": "crates/next-core/src/next_app/metadata/mod.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 2,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/ee5c6eb73f3a3dd2d1b474664f1b93a1d397ed93/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/ee5c6eb73f3a3dd2d1b474664f1b93a1d397ed93/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Fmod.rs?ref=ee5c6eb73f3a3dd2d1b474664f1b93a1d397ed93",
            "patch": "@@ -276,7 +276,12 @@ fn format_radix(mut x: u32, radix: u32) -> String {\n     }\n \n     result.reverse();\n-    result[..6].iter().collect()\n+\n+    // We only need the first 6 characters of the hash but sometimes the hash is too short.\n+    // In JavaScript, we use `toString(36).slice(0, 6)` to get the first 6 characters of the hash,\n+    // but it will automatically take the minimum of the length of the hash and 6. Rust will panic.\n+    let len = result.len().min(6);\n+    result[..len].iter().collect()\n }\n \n /// If there's special convention like (...) or @ in the page path,\n@@ -360,7 +365,7 @@ pub fn normalize_metadata_route(mut page: AppPage) -> Result<AppPage> {\n \n #[cfg(test)]\n mod test {\n-    use super::normalize_metadata_route;\n+    use super::{djb2_hash, format_radix, normalize_metadata_route};\n     use crate::next_app::AppPage;\n \n     #[test]\n@@ -385,4 +390,10 @@ mod test {\n             assert_eq!(&normalized.to_string(), expected);\n         }\n     }\n+\n+    #[test]\n+    fn test_format_radix_doesnt_panic_with_result_less_than_6_characters() {\n+        let hash = format_radix(djb2_hash(\"/lookup/[domain]/(dns)\"), 36);\n+        assert!(hash.len() < 6);\n+    }\n }"
        }
    ],
    "stats": {
        "total": 15,
        "additions": 13,
        "deletions": 2
    }
}