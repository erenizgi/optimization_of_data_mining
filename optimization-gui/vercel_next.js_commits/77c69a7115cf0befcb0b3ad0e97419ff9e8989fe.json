{
    "author": "mischnic",
    "message": "Turbopack: improve error message for incompatible swc plugins (#86346)\n\nBefore:\r\n```\r\nModule not found: Can't resolve 'next/dist/esm/build/templates/helpers'\r\nfailed to analyze ecmascript module '[project]/node_modules/.pnpm/next@file+..+next-repo-2bf56e024dbccc85257a8c308492f2375d690b206153b02d3bea2029707d4c38+packa_tacnzof7rtmb5bwqa7bdnfcdbq/node_modules/next/dist/esm/build/templates/helpers.js [ssr] (ecmascript)'\r\n\r\nCaused by:\r\n- failed to parse [project]/node_modules/.pnpm/next@file+..+next-repo-2bf56e024dbccc85257a8c308492f2375d690b206153b02d3bea2029707d4c38+packa_tacnzof7rtmb5bwqa7bdnfcdbq/node_modules/next/dist/esm/build/templates/helpers.js\r\n- Transforming and/or parsing of [project]/node_modules/.pnpm/next@file+..+next-repo-2bf56e024dbccc85257a8c308492f2375d690b206153b02d3bea2029707d4c38+packa_tacnzof7rtmb5bwqa7bdnfcdbq/node_modules/next/dist/esm/build/templates/helpers.js failed\r\n- failed to deserialize `swc_common::plugin::diagnostics::PluginCorePkgDiagnostics`\r\n- Mismatch { name: \"array\", found: 48 }\r\n\r\nDebug info:\r\n- Execution of <ModuleAssetContext as AssetContext>::process_resolve_result failed\r\n- Execution of <ModuleAssetContext as AssetContext>::process failed\r\n- Execution of <EcmascriptModuleAsset as Module>::side_effects failed\r\n- Execution of analyze_ecmascript_module failed\r\n- failed to analyze ecmascript module '[project]/node_modules/.pnpm/next@file+..+next-repo-2bf56e024dbccc85257a8c308492f2375d690b206153b02d3bea2029707d4c38+packa_tacnzof7rtmb5bwqa7bdnfcdbq/node_modules/next/dist/esm/build/templates/helpers.js [ssr] (ecmascript)'\r\n- Execution of <EcmascriptModuleAsset as EcmascriptParsable>::failsafe_parse failed\r\n- Execution of parse failed\r\n- failed to parse [project]/node_modules/.pnpm/next@file+..+next-repo-2bf56e024dbccc85257a8c308492f2375d690b206153b02d3bea2029707d4c38+packa_tacnzof7rtmb5bwqa7bdnfcdbq/node_modules/next/dist/esm/build/templates/helpers.js\r\n- Transforming and/or parsing of [project]/node_modules/.pnpm/next@file+..+next-repo-2bf56e024dbccc85257a8c308492f2375d690b206153b02d3bea2029707d4c38+packa_tacnzof7rtmb5bwqa7bdnfcdbq/node_modules/next/dist/esm/build/templates/helpers.js failed\r\n- failed to deserialize `swc_common::plugin::diagnostics::PluginCorePkgDiagnostics`\r\n- Mismatch { name: \"array\", found: 48 }\r\nImport map: aliased to module 'next' with subpath '/dist/esm/build/templates/helpers' inside of [project]/\r\n\r\n\r\nhttps://nextjs.org/docs/messages/module-not-found\r\n```\r\n\r\nAfter:\r\n```\r\n./packages/next/document.js\r\nFailed to execute SWC plugin\r\nAn unexpected error occurred when executing an SWC EcmaScript transform plugin.\r\nThis might be due to a version mismatch between the plugin and Next.js.\r\n\r\nFailed to execute @swc/plugin-react-remove-properties\r\n\r\nCaused by:\r\n    0: failed to deserialize `swc_common::plugin::diagnostics::PluginCorePkgDiagnostics`\r\n    1: Mismatch { name: \"array\", found: 48 }\r\n```",
    "sha": "77c69a7115cf0befcb0b3ad0e97419ff9e8989fe",
    "files": [
        {
            "sha": "90759d9882fdb174fc928dff60ec9ba71aec5ce6",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=77c69a7115cf0befcb0b3ad0e97419ff9e8989fe",
            "patch": "@@ -9903,6 +9903,7 @@ dependencies = [\n  \"anyhow\",\n  \"async-trait\",\n  \"bincode 2.0.1\",\n+ \"either\",\n  \"indexmap 2.9.0\",\n  \"rustc-hash 2.1.1\",\n  \"serde\","
        },
        {
            "sha": "0e2677040fdbf1f6c506665f06fdd2d9f2d75a4c",
            "filename": "crates/next-core/src/next_shared/transforms/swc_ecma_transform_plugins.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_shared%2Ftransforms%2Fswc_ecma_transform_plugins.rs?ref=77c69a7115cf0befcb0b3ad0e97419ff9e8989fe",
            "patch": "@@ -139,7 +139,8 @@ pub async fn get_swc_ecma_transform_rule_impl(\n                 };\n \n                 Ok(Some((\n-                    SwcPluginModule::new(name, file.content().to_bytes().to_vec()).resolved_cell(),\n+                    SwcPluginModule::new(name.clone(), file.content().to_bytes().to_vec())\n+                        .resolved_cell(),\n                     config.clone(),\n                 )))\n             }"
        },
        {
            "sha": "158e32b25d39fc596d146fda969f11b46ec231cb",
            "filename": "test/e2e/swc-plugins/index.test.ts",
            "status": "modified",
            "additions": 39,
            "deletions": 0,
            "changes": 39,
            "blob_url": "https://github.com/vercel/next.js/blob/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/test%2Fe2e%2Fswc-plugins%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/test%2Fe2e%2Fswc-plugins%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fswc-plugins%2Findex.test.ts?ref=77c69a7115cf0befcb0b3ad0e97419ff9e8989fe",
            "patch": "@@ -17,6 +17,44 @@ describe('swcPlugins', () => {\n       expect(html).not.toContain('data-custom-attribute')\n     })\n   })\n+  ;(isNextDev ? describe : describe.skip)('incompatible plugin version', () => {\n+    const { next, skipped, isTurbopack } = nextTestSetup({\n+      files: __dirname,\n+      skipDeployment: true,\n+      dependencies: {\n+        '@swc/plugin-react-remove-properties': '7.0.2',\n+      },\n+    })\n+    if (skipped) return\n+\n+    it('shows a redbox in dev', async () => {\n+      const browser = await next.browser('/')\n+\n+      if (isTurbopack) {\n+        await expect(browser).toDisplayRedbox(`\n+         {\n+           \"description\": \"Failed to execute SWC plugin\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Build Error\",\n+           \"source\": \"./app/layout.js\n+         Failed to execute SWC plugin\n+         An unexpected error occurred when executing an SWC EcmaScript transform plugin.\n+         This might be due to a version mismatch between the plugin and Next.js. https://plugins.swc.rs/ can help you find the correct plugin version to use.\n+         Failed to execute @swc/plugin-react-remove-properties\n+         Caused by:\n+             0: failed to deserialize \\`swc_common::plugin::diagnostics::PluginCorePkgDiagnostics\\`\n+             1: Mismatch { name: \"array\", found: 48 }\",\n+           \"stack\": [],\n+         }\n+        `)\n+      } else {\n+        // TODO missing proper error with Webpack\n+        await expect(browser).toDisplayRedbox(\n+          `\"Expected Redbox but found no visible one.\"`\n+        )\n+      }\n+    })\n+  })\n   ;(isNextDev ? describe : describe.skip)('invalid plugin name', () => {\n     const { next, skipped, isTurbopack } = nextTestSetup({\n       files: __dirname,\n@@ -32,6 +70,7 @@ module.exports = {\n     })\n     if (skipped) return\n \n+    // eslint-disable-next-line jest/no-identical-title\n     it('shows a redbox in dev', async () => {\n       const browser = await next.browser('/')\n "
        },
        {
            "sha": "1d06718e2db8b5e0056adb4cab4909b4887bfafa",
            "filename": "turbopack/crates/turbopack-ecmascript-plugins/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2FCargo.toml?ref=77c69a7115cf0befcb0b3ad0e97419ff9e8989fe",
            "patch": "@@ -26,6 +26,7 @@ workspace = true\n anyhow = { workspace = true }\n async-trait = { workspace = true }\n bincode = { workspace = true }\n+either = { workspace = true }\n indexmap = { workspace = true }\n serde = { workspace = true }\n serde_json = { workspace = true }"
        },
        {
            "sha": "19abb631801f4fb3be919dc4938b3b4fcc040fb2",
            "filename": "turbopack/crates/turbopack-ecmascript-plugins/src/transform/swc_ecma_transform_plugins.rs",
            "status": "modified",
            "additions": 139,
            "deletions": 48,
            "changes": 187,
            "blob_url": "https://github.com/vercel/next.js/blob/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Fswc_ecma_transform_plugins.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/77c69a7115cf0befcb0b3ad0e97419ff9e8989fe/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Fswc_ecma_transform_plugins.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbopack-ecmascript-plugins%2Fsrc%2Ftransform%2Fswc_ecma_transform_plugins.rs?ref=77c69a7115cf0befcb0b3ad0e97419ff9e8989fe",
            "patch": "@@ -1,7 +1,7 @@\n use anyhow::Result;\n use async_trait::async_trait;\n use swc_core::ecma::ast::Program;\n-use turbo_rcstr::rcstr;\n+use turbo_rcstr::{RcStr, rcstr};\n use turbo_tasks::Vc;\n use turbo_tasks_fs::FileSystemPath;\n use turbopack_core::issue::{Issue, IssueSeverity, IssueStage, OptionStyledString, StyledString};\n@@ -14,36 +14,35 @@ use turbopack_ecmascript::{CustomTransformer, TransformContext};\n /// compiled, serialized wasmer::Module instead of raw file bytes to reduce the\n /// cost of the compilation.\n #[turbo_tasks::value(serialization = \"none\", eq = \"manual\", cell = \"new\", shared)]\n-pub struct SwcPluginModule(\n+pub struct SwcPluginModule {\n+    pub name: RcStr,\n     #[turbo_tasks(trace_ignore, debug_ignore)]\n     #[cfg(feature = \"swc_ecma_transform_plugin\")]\n-    pub swc_core::plugin_runner::plugin_module_bytes::CompiledPluginModuleBytes,\n-    // Dummy field to avoid turbo_tasks macro complaining about empty struct.\n-    // This is because we can't import CompiledPluginModuleBytes by default, it should be only\n-    // available for the target / platforms that support swc plugins (which can build wasmer)\n-    #[cfg(not(feature = \"swc_ecma_transform_plugin\"))] pub (),\n-);\n+    pub plugin: swc_core::plugin_runner::plugin_module_bytes::CompiledPluginModuleBytes,\n+}\n \n impl SwcPluginModule {\n-    pub fn new(plugin_name: &str, plugin_bytes: Vec<u8>) -> Self {\n+    pub fn new(plugin_name: RcStr, plugin_bytes: Vec<u8>) -> Self {\n         #[cfg(feature = \"swc_ecma_transform_plugin\")]\n         {\n             use swc_core::plugin_runner::plugin_module_bytes::{\n                 CompiledPluginModuleBytes, RawPluginModuleBytes,\n             };\n             use swc_plugin_backend_wasmer::WasmerRuntime;\n \n-            Self(CompiledPluginModuleBytes::from_raw_module(\n-                &WasmerRuntime,\n-                RawPluginModuleBytes::new(plugin_name.to_string(), plugin_bytes),\n-            ))\n+            Self {\n+                plugin: CompiledPluginModuleBytes::from_raw_module(\n+                    &WasmerRuntime,\n+                    RawPluginModuleBytes::new(plugin_name.to_string(), plugin_bytes),\n+                ),\n+                name: plugin_name,\n+            }\n         }\n \n         #[cfg(not(feature = \"swc_ecma_transform_plugin\"))]\n         {\n-            let _ = plugin_name;\n             let _ = plugin_bytes;\n-            Self(())\n+            Self { name: plugin_name }\n         }\n     }\n }\n@@ -89,6 +88,53 @@ impl Issue for UnsupportedSwcEcmaTransformPluginsIssue {\n     }\n }\n \n+#[turbo_tasks::value(shared)]\n+struct SwcEcmaTransformFailureIssue {\n+    pub file_path: FileSystemPath,\n+    pub description: StyledString,\n+}\n+\n+#[turbo_tasks::value_impl]\n+impl Issue for SwcEcmaTransformFailureIssue {\n+    fn severity(&self) -> IssueSeverity {\n+        IssueSeverity::Error\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn stage(&self) -> Vc<IssueStage> {\n+        IssueStage::Transform.cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn title(&self) -> Vc<StyledString> {\n+        StyledString::Text(rcstr!(\"Failed to execute SWC plugin\")).cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn file_path(&self) -> Vc<FileSystemPath> {\n+        self.file_path.clone().cell()\n+    }\n+\n+    #[turbo_tasks::function]\n+    fn description(&self) -> Vc<OptionStyledString> {\n+        Vc::cell(Some(\n+            StyledString::Stack(vec![\n+                StyledString::Text(rcstr!(\n+                    \"An unexpected error occurred when executing an SWC EcmaScript transform \\\n+                     plugin.\"\n+                )),\n+                StyledString::Text(rcstr!(\n+                    \"This might be due to a version mismatch between the plugin and Next.js. \\\n+                    https://plugins.swc.rs/ can help you find the correct plugin version to use.\"\n+                )),\n+                StyledString::Text(Default::default()),\n+                self.description.clone(),\n+            ])\n+            .resolved_cell(),\n+        ))\n+    }\n+}\n+\n /// A custom transformer plugin to execute SWC's transform plugins.\n #[derive(Debug)]\n pub struct SwcEcmaTransformPluginsTransformer {\n@@ -122,6 +168,7 @@ impl CustomTransformer for SwcEcmaTransformPluginsTransformer {\n         {\n             use std::{cell::RefCell, rc::Rc, sync::Arc};\n \n+            use anyhow::Context;\n             use swc_core::{\n                 common::{\n                     comments::SingleThreadedComments,\n@@ -132,6 +179,7 @@ impl CustomTransformer for SwcEcmaTransformPluginsTransformer {\n                 },\n                 ecma::ast::Module,\n                 plugin::proxies::{COMMENTS, HostCommentsStorage},\n+                plugin_runner::plugin_module_bytes::CompiledPluginModuleBytes,\n             };\n             use swc_plugin_backend_wasmer::WasmerRuntime;\n             use turbo_tasks::TryJoinIterExt;\n@@ -142,8 +190,9 @@ impl CustomTransformer for SwcEcmaTransformPluginsTransformer {\n                 .map(async |(plugin_module, config)| {\n                     let plugin_module = plugin_module.await?;\n                     Ok((\n+                        plugin_module.name.clone(),\n                         config.clone(),\n-                        Box::new(plugin_module.0.clone_module(&WasmerRuntime)),\n+                        Box::new(plugin_module.plugin.clone_module(&WasmerRuntime)),\n                     ))\n                 })\n                 .try_join()\n@@ -178,6 +227,58 @@ impl CustomTransformer for SwcEcmaTransformPluginsTransformer {\n                 None\n             };\n \n+            fn transform(\n+                original_serialized_program: &PluginSerializedBytes,\n+                ctx: &TransformContext<'_>,\n+                plugins: Vec<(RcStr, serde_json::Value, Box<CompiledPluginModuleBytes>)>,\n+                should_enable_comments_proxy: bool,\n+            ) -> Result<Program> {\n+                use either::Either;\n+\n+                let transform_metadata_context = Arc::new(TransformPluginMetadataContext::new(\n+                    Some(ctx.file_path_str.to_string()),\n+                    //[TODO]: Support env-related variable injection, i.e process.env.NODE_ENV\n+                    \"development\".to_string(),\n+                    None,\n+                ));\n+\n+                let mut serialized_program = Either::Left(original_serialized_program);\n+\n+                // Run plugin transformation against current program.\n+                // We do not serialize / deserialize between each plugin execution but\n+                // copies raw transformed bytes directly into plugin's memory space.\n+                // Note: This doesn't mean plugin won't perform any se/deserialization: it\n+                // still have to construct from raw bytes internally to perform actual\n+                // transform.\n+                for (plugin_name, plugin_config, plugin_module) in plugins {\n+                    let mut transform_plugin_executor =\n+                        swc_core::plugin_runner::create_plugin_transform_executor(\n+                            ctx.source_map,\n+                            &ctx.unresolved_mark,\n+                            &transform_metadata_context,\n+                            None,\n+                            plugin_module,\n+                            Some(plugin_config),\n+                            Arc::new(WasmerRuntime),\n+                        );\n+\n+                    serialized_program = Either::Right(\n+                        transform_plugin_executor\n+                            .transform(\n+                                serialized_program.as_ref().either(|p| *p, |p| p),\n+                                Some(should_enable_comments_proxy),\n+                            )\n+                            .with_context(|| format!(\"Failed to execute {plugin_name}\"))?,\n+                    );\n+                }\n+\n+                serialized_program\n+                    .as_ref()\n+                    .either(|p| *p, |p| p)\n+                    .deserialize()\n+                    .map(|v| v.into_inner())\n+            }\n+\n             let transformed_program =\n                 COMMENTS.set(&HostCommentsStorage { inner: comments }, || {\n                     let module_program =\n@@ -186,39 +287,29 @@ impl CustomTransformer for SwcEcmaTransformPluginsTransformer {\n                         swc_core::common::plugin::serialized::VersionedSerializable::new(\n                             module_program,\n                         );\n-                    let mut serialized_program =\n-                        PluginSerializedBytes::try_serialize(&module_program)?;\n-\n-                    let transform_metadata_context = Arc::new(TransformPluginMetadataContext::new(\n-                        Some(ctx.file_path_str.to_string()),\n-                        //[TODO]: Support env-related variable injection, i.e process.env.NODE_ENV\n-                        \"development\".to_string(),\n-                        None,\n-                    ));\n-\n-                    // Run plugin transformation against current program.\n-                    // We do not serialize / deserialize between each plugin execution but\n-                    // copies raw transformed bytes directly into plugin's memory space.\n-                    // Note: This doesn't mean plugin won't perform any se/deserialization: it\n-                    // still have to construct from raw bytes internally to perform actual\n-                    // transform.\n-                    for (plugin_config, plugin_module) in plugins {\n-                        let mut transform_plugin_executor =\n-                            swc_core::plugin_runner::create_plugin_transform_executor(\n-                                ctx.source_map,\n-                                &ctx.unresolved_mark,\n-                                &transform_metadata_context,\n-                                None,\n-                                plugin_module,\n-                                Some(plugin_config),\n-                                Arc::new(WasmerRuntime),\n-                            );\n-\n-                        serialized_program = transform_plugin_executor\n-                            .transform(&serialized_program, Some(should_enable_comments_proxy))?;\n-                    }\n+                    let serialized_program = PluginSerializedBytes::try_serialize(&module_program)?;\n+\n+                    match transform(\n+                        &serialized_program,\n+                        ctx,\n+                        plugins,\n+                        should_enable_comments_proxy,\n+                    ) {\n+                        Ok(program) => anyhow::Ok(program),\n+                        Err(e) => {\n+                            use turbopack_core::issue::IssueExt;\n \n-                    serialized_program.deserialize().map(|v| v.into_inner())\n+                            SwcEcmaTransformFailureIssue {\n+                                file_path: ctx.file_path.clone(),\n+                                description: StyledString::Text(format!(\"{:?}\", e).into()),\n+                            }\n+                            .resolved_cell()\n+                            .emit();\n+\n+                            // On failure, return the original program.\n+                            Ok(module_program.into_inner())\n+                        }\n+                    }\n                 })?;\n \n             *program = transformed_program;"
        }
    ],
    "stats": {
        "total": 231,
        "additions": 182,
        "deletions": 49
    }
}