{
    "author": "wbinnssmith",
    "message": "bundle-analyzer: add kbd shortcut labels and fix focus bugs (#87001)\n\n- Adds decorated kbd-style shortcut labels to cue the user into using them\n- Listens only for the appropriate OS or Ctrl key on Mac/Others\n- Esc now clears and focuses the search field and the treemap focus\n- Does not trigger in the case where the user has another element focused\n\n![image.png](https://app.graphite.com/user-attachments/assets/6a85d1e7-a711-432d-86b0-f65c0b89de74.png)",
    "sha": "5099903e88943df679d69d81f088a2b7b699f0c6",
    "files": [
        {
            "sha": "f52fbbe78cb6415f8eb337d10da76655ea9d7ca8",
            "filename": "apps/bundle-analyzer/app/page.tsx",
            "status": "modified",
            "additions": 17,
            "deletions": 45,
            "changes": 62,
            "blob_url": "https://github.com/vercel/next.js/blob/5099903e88943df679d69d81f088a2b7b699f0c6/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5099903e88943df679d69d81f088a2b7b699f0c6/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fapp%2Fpage.tsx?ref=5099903e88943df679d69d81f088a2b7b699f0c6",
            "patch": "@@ -1,18 +1,15 @@\n 'use client'\n \n import type React from 'react'\n-import { useEffect, useMemo, useRef, useState } from 'react'\n+import { useEffect, useMemo, useState } from 'react'\n import useSWR from 'swr'\n import { ErrorState } from '@/components/error-state'\n-import {\n-  RouteTypeahead,\n-  type RouteTypeaheadRef,\n-} from '@/components/route-typeahead'\n+import { FileSearch } from '@/components/file-search'\n+import { RouteTypeahead } from '@/components/route-typeahead'\n import { Sidebar } from '@/components/sidebar'\n import { TreemapVisualizer } from '@/components/treemap-visualizer'\n \n import { Badge } from '@/components/ui/badge'\n-import { Input } from '@/components/ui/input'\n import { TreemapSkeleton } from '@/components/ui/skeleton'\n import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group'\n import { AnalyzeData, ModulesData } from '@/lib/analyze-data'\n@@ -72,31 +69,27 @@ export default function Home() {\n     client?: boolean\n   } | null>(null)\n   const [searchQuery, setSearchQuery] = useState('')\n-  const [searchFocused, setSearchFocused] = useState(false)\n-\n-  const routeTypeaheadRef = useRef<RouteTypeaheadRef>(null)\n-  const searchInputRef = useRef<HTMLInputElement>(null)\n \n   useEffect(() => {\n     const handleKeyDown = (e: KeyboardEvent) => {\n-      // Cmd+K or Ctrl+K to focus route filter\n-      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {\n-        e.preventDefault()\n-        routeTypeaheadRef.current?.focus()\n-      }\n-      // / to focus search (only if not already in an input)\n-      else if (\n-        e.key === '/' &&\n-        !['INPUT', 'TEXTAREA'].includes((e.target as HTMLElement).tagName)\n-      ) {\n-        e.preventDefault()\n-        searchInputRef.current?.focus()\n+      // esc clears current treemap source selection\n+      if (e.key === 'Escape') {\n+        const activeElement = document.activeElement\n+        const isInputFocused =\n+          activeElement && ['INPUT', 'TEXTAREA'].includes(activeElement.tagName)\n+\n+        if (!isInputFocused) {\n+          e.preventDefault()\n+          const rootSourceIndex = getRootSourceIndex(analyzeData)\n+          setSelectedSourceIndex(rootSourceIndex)\n+          setFocusedSourceIndex(rootSourceIndex)\n+        }\n       }\n     }\n \n     window.addEventListener('keydown', handleKeyDown)\n     return () => window.removeEventListener('keydown', handleKeyDown)\n-  }, [])\n+  }, [analyzeData])\n \n   // Compute module depth map from active entries\n   const moduleDepthMap = useMemo(() => {\n@@ -155,7 +148,6 @@ export default function Home() {\n       <div className=\"flex-none px-4 py-2 border-b border-border flex items-center gap-4\">\n         <div className=\"basis-1/3 flex\">\n           <RouteTypeahead\n-            ref={routeTypeaheadRef}\n             selectedRoute={selectedRoute}\n             onRouteSelected={(route) => {\n               setSelectedRoute(route)\n@@ -196,27 +188,7 @@ export default function Home() {\n                 <ToggleGroupItem value=\"asset\">Asset</ToggleGroupItem>\n               </ToggleGroup>\n \n-              {!searchFocused && (\n-                <div className=\"flex items-center gap-4 text-xs\">\n-                  <p className=\"text-muted-foreground\">\n-                    {\n-                      analyzeData.source(focusedSourceIndex ?? rootSourceIndex)\n-                        ?.path\n-                    }\n-                  </p>\n-                </div>\n-              )}\n-\n-              <Input\n-                ref={searchInputRef}\n-                type=\"search\"\n-                value={searchQuery}\n-                onChange={(e) => setSearchQuery(e.target.value)}\n-                onFocus={() => setSearchFocused(true)}\n-                onBlur={() => setSearchFocused(false)}\n-                placeholder=\"Search files...\"\n-                className=\"w-48 focus:w-80 transition-all duration-200\"\n-              />\n+              <FileSearch value={searchQuery} onChange={setSearchQuery} />\n             </>\n           )}\n         </div>"
        },
        {
            "sha": "960038021f1272858ae0fa93848e284d64da5d16",
            "filename": "apps/bundle-analyzer/components/file-search.tsx",
            "status": "added",
            "additions": 63,
            "deletions": 0,
            "changes": 63,
            "blob_url": "https://github.com/vercel/next.js/blob/5099903e88943df679d69d81f088a2b7b699f0c6/apps%2Fbundle-analyzer%2Fcomponents%2Ffile-search.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5099903e88943df679d69d81f088a2b7b699f0c6/apps%2Fbundle-analyzer%2Fcomponents%2Ffile-search.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fcomponents%2Ffile-search.tsx?ref=5099903e88943df679d69d81f088a2b7b699f0c6",
            "patch": "@@ -0,0 +1,63 @@\n+'use client'\n+\n+import { useEffect, useRef, useState } from 'react'\n+import { Input } from '@/components/ui/input'\n+import { Kbd } from '@/components/ui/kbd'\n+\n+interface FileSearchProps {\n+  value: string\n+  onChange: (value: string) => void\n+}\n+\n+export function FileSearch({ value, onChange }: FileSearchProps) {\n+  const [focused, setFocused] = useState(false)\n+  const inputRef = useRef<HTMLInputElement>(null)\n+\n+  useEffect(() => {\n+    const handleKeyDown = (e: KeyboardEvent) => {\n+      if (\n+        e.key === '/' &&\n+        !['INPUT', 'TEXTAREA'].includes((e.target as HTMLElement).tagName)\n+      ) {\n+        e.preventDefault()\n+        inputRef.current?.focus()\n+      } else if (\n+        e.key === 'Escape' &&\n+        document.activeElement === inputRef.current\n+      ) {\n+        e.preventDefault()\n+        onChange('')\n+        inputRef.current?.blur()\n+      }\n+    }\n+\n+    window.addEventListener('keydown', handleKeyDown)\n+    return () => window.removeEventListener('keydown', handleKeyDown)\n+  }, [onChange])\n+\n+  const handleFocus = () => {\n+    setFocused(true)\n+  }\n+\n+  const handleBlur = () => {\n+    setFocused(false)\n+  }\n+\n+  return (\n+    <div className=\"relative\">\n+      <Input\n+        ref={inputRef}\n+        type=\"search\"\n+        value={value}\n+        onChange={(e) => onChange(e.target.value)}\n+        onFocus={handleFocus}\n+        onBlur={handleBlur}\n+        placeholder=\"Search files...\"\n+        className=\"w-48 focus:w-80 transition-all duration-200 pr-8\"\n+      />\n+      {!value && !focused && (\n+        <Kbd className=\"absolute right-2 top-1/2 -translate-y-1/2\">/</Kbd>\n+      )}\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "e561acf601e03466a9c25b4769d50a8658807e50",
            "filename": "apps/bundle-analyzer/components/route-typeahead.tsx",
            "status": "modified",
            "additions": 36,
            "deletions": 16,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/5099903e88943df679d69d81f088a2b7b699f0c6/apps%2Fbundle-analyzer%2Fcomponents%2Froute-typeahead.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5099903e88943df679d69d81f088a2b7b699f0c6/apps%2Fbundle-analyzer%2Fcomponents%2Froute-typeahead.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fcomponents%2Froute-typeahead.tsx?ref=5099903e88943df679d69d81f088a2b7b699f0c6",
            "patch": "@@ -2,7 +2,7 @@\n \n import useSWR from 'swr'\n import { Check, ChevronsUpDown, Loader, Route } from 'lucide-react'\n-import { forwardRef, useImperativeHandle, useState } from 'react'\n+import { useEffect, useState } from 'react'\n import { Button } from '@/components/ui/button'\n import {\n   Command,\n@@ -19,27 +19,44 @@ import {\n } from '@/components/ui/popover'\n import { cn, jsonFetcher } from '@/lib/utils'\n import { NetworkError } from '@/lib/errors'\n+import { Kbd } from '@/components/ui/kbd'\n \n interface RouteTypeaheadProps {\n   selectedRoute: string | null\n   onRouteSelected: (routeName: string) => void\n }\n \n-export interface RouteTypeaheadRef {\n-  focus: () => void\n-}\n-\n-export const RouteTypeahead = forwardRef<\n-  RouteTypeaheadRef,\n-  RouteTypeaheadProps\n->(function RouteTypeahead({ selectedRoute, onRouteSelected }, ref) {\n+export function RouteTypeahead({\n+  selectedRoute,\n+  onRouteSelected,\n+}: RouteTypeaheadProps) {\n   const [open, setOpen] = useState(false)\n+  const [shortcutLabel, setShortcutLabel] = useState<string | null>(null)\n \n-  useImperativeHandle(ref, () => ({\n-    focus: () => {\n-      setOpen(true)\n-    },\n-  }))\n+  useEffect(() => {\n+    const isAppleDevice = /Mac|iPhone|iPad|iPod/.test(navigator.userAgent)\n+    setShortcutLabel(isAppleDevice ? 'âŒ˜K' : 'Ctrl+K')\n+\n+    const handleKeyDown = (e: KeyboardEvent) => {\n+      const activeElement = document.activeElement\n+      const isInputFocused =\n+        activeElement && ['INPUT', 'TEXTAREA'].includes(activeElement.tagName)\n+\n+      if (isInputFocused) return\n+\n+      const isShortcutPressed = isAppleDevice\n+        ? e.metaKey && e.key === 'k'\n+        : e.ctrlKey && e.key === 'k'\n+\n+      if (isShortcutPressed) {\n+        e.preventDefault()\n+        setOpen(true)\n+      }\n+    }\n+\n+    window.addEventListener('keydown', handleKeyDown)\n+    return () => window.removeEventListener('keydown', handleKeyDown)\n+  }, [])\n \n   const {\n     data: routes,\n@@ -96,7 +113,10 @@ export const RouteTypeahead = forwardRef<\n \n               {ctaText}\n             </div>\n-            <ChevronsUpDown className=\"ml-2 h-4 w-4 shrink-0 opacity-50\" />\n+            <div className=\"flex items-center gap-2\">\n+              {shortcutLabel && <Kbd>{shortcutLabel}</Kbd>}\n+              <ChevronsUpDown className=\"h-4 w-4 shrink-0 opacity-50\" />\n+            </div>\n           </Button>\n         </PopoverTrigger>\n         <PopoverContent className=\"w-96 p-0\">\n@@ -133,4 +153,4 @@ export const RouteTypeahead = forwardRef<\n       </Popover>\n     </div>\n   )\n-})\n+}"
        },
        {
            "sha": "a8a8c27bcafe6cc2db9087f70a775e6dd855f3df",
            "filename": "apps/bundle-analyzer/components/ui/kbd.tsx",
            "status": "added",
            "additions": 28,
            "deletions": 0,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/5099903e88943df679d69d81f088a2b7b699f0c6/apps%2Fbundle-analyzer%2Fcomponents%2Fui%2Fkbd.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5099903e88943df679d69d81f088a2b7b699f0c6/apps%2Fbundle-analyzer%2Fcomponents%2Fui%2Fkbd.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/apps%2Fbundle-analyzer%2Fcomponents%2Fui%2Fkbd.tsx?ref=5099903e88943df679d69d81f088a2b7b699f0c6",
            "patch": "@@ -0,0 +1,28 @@\n+import { cn } from '@/lib/utils'\n+\n+function Kbd({ className, ...props }: React.ComponentProps<'kbd'>) {\n+  return (\n+    <kbd\n+      data-slot=\"kbd\"\n+      className={cn(\n+        'bg-muted text-muted-foreground pointer-events-none inline-flex h-5 w-fit min-w-5 items-center justify-center gap-1 rounded-sm px-1 font-sans text-xs font-medium select-none',\n+        \"[&_svg:not([class*='size-'])]:size-3\",\n+        '[[data-slot=tooltip-content]_&]:bg-background/20 [[data-slot=tooltip-content]_&]:text-background dark:[[data-slot=tooltip-content]_&]:bg-background/10',\n+        className\n+      )}\n+      {...props}\n+    />\n+  )\n+}\n+\n+function KbdGroup({ className, ...props }: React.ComponentProps<'div'>) {\n+  return (\n+    <kbd\n+      data-slot=\"kbd-group\"\n+      className={cn('inline-flex items-center gap-1', className)}\n+      {...props}\n+    />\n+  )\n+}\n+\n+export { Kbd, KbdGroup }"
        }
    ],
    "stats": {
        "total": 205,
        "additions": 144,
        "deletions": 61
    }
}