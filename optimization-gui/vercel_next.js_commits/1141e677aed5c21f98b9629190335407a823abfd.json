{
    "author": "wyattjoh",
    "message": "test: improve action test reliability (#80587)\n\n## Summary\n\nThis PR improves test reliability for the app-dir actions test suite by\naddressing race conditions and modernizing file system operations.\n\n  ## Changes\n\n  ### Test Improvements\n- **Fixed race conditions** in revalidation tests by ensuring proper\nsequencing of assertions\n- URL assertions now occur before DOM checks to prevent flaky failures\n    - Added explicit waits and retries for revalidated content\n    - Improved test flow with proper page transition checks\n\n  ### Code Modernization\n  - **Updated file system operations** to use modern Node.js APIs\n    - Migrated from `fs-extra` to native `node:fs/promises`\n- Replaced sync operations with async equivalents for better performance\n    - Updated import paths to use `node:` protocol for built-in modules\n\n  ### Specific Fixes\n- Fixed timing issues in the revalidate path/tag tests where assertions\nwere checking values before revalidation completed\n- Added proper waiting for deploy environments where revalidation may\nhave eventual consistency\n- Improved cookie handling by reading the value once to avoid potential\nrace conditions\n  - Added semantic `id=\"title\"` to help with page transition assertions",
    "sha": "1141e677aed5c21f98b9629190335407a823abfd",
    "files": [
        {
            "sha": "cfb4f8e70d5ef5f4747b1f493ad018dcea79f0b4",
            "filename": "test/e2e/app-dir/actions/app-action.test.ts",
            "status": "modified",
            "additions": 62,
            "deletions": 50,
            "changes": 112,
            "blob_url": "https://github.com/vercel/next.js/blob/1141e677aed5c21f98b9629190335407a823abfd/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/1141e677aed5c21f98b9629190335407a823abfd/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp-action.test.ts?ref=1141e677aed5c21f98b9629190335407a823abfd",
            "patch": "@@ -8,10 +8,10 @@ import {\n   getRedboxSource,\n } from 'next-test-utils'\n import type { Request, Response } from 'playwright'\n-import fs from 'fs-extra'\n-import nodeFs from 'fs'\n-import { join } from 'path'\n+import fs from 'node:fs/promises'\n+import { join } from 'node:path'\n import { outdent } from 'outdent'\n+import { setTimeout } from 'node:timers/promises'\n \n const GENERIC_RSC_ERROR =\n   'Error: An error occurred in the Server Components render. The specific message is omitted in production builds to avoid leaking sensitive details. A digest property is included on this error instance which may provide additional details about the nature of the error.'\n@@ -540,10 +540,10 @@ describe('app-dir action handling', () => {\n     // this triggers a revalidate + redirect in a client component\n     await browser.elementById('redirect-revalidate-client').click()\n     await retry(async () => {\n+      expect(await browser.url()).toBe(`${next.url}/revalidate?foo=bar`)\n+\n       const newJustPutIt = await browser.elementById('justputit').text()\n       expect(newJustPutIt).not.toBe(initialJustPutit)\n-\n-      expect(await browser.url()).toBe(`${next.url}/revalidate?foo=bar`)\n     })\n \n     // this triggers a revalidate + redirect in a server component\n@@ -593,7 +593,8 @@ describe('app-dir action handling', () => {\n       beforePageLoad(page) {\n         page.on('request', (request) => {\n           const url = new URL(request.url())\n-          if (url.pathname === '/server') {\n+          // Only count POST requests to /server (form submissions)\n+          if (url.pathname === '/server' && request.method() === 'POST') {\n             requestCount++\n           }\n         })\n@@ -956,16 +957,21 @@ describe('app-dir action handling', () => {\n   if (isNextStart) {\n     it('should not expose action content in sourcemaps', async () => {\n       // We check all sourcemaps in the `static` folder for sensitive information given that chunking\n-      const sourcemaps = nodeFs\n-        .readdirSync(join(next.testDir, '.next', 'static'), {\n+      const sourcemaps = await fs\n+        .readdir(join(next.testDir, '.next', 'static'), {\n           recursive: true,\n           encoding: 'utf8',\n         })\n-        .filter((f) => f.endsWith('.js.map'))\n-        .map((f) =>\n-          nodeFs.readFileSync(join(next.testDir, '.next', 'static', f), {\n-            encoding: 'utf8',\n-          })\n+        .then((files) =>\n+          Promise.all(\n+            files\n+              .filter((f) => f.endsWith('.js.map'))\n+              .map((f) =>\n+                fs.readFile(join(next.testDir, '.next', 'static', f), {\n+                  encoding: 'utf8',\n+                })\n+              )\n+          )\n         )\n \n       expect(sourcemaps).not.toBeEmpty()\n@@ -1039,23 +1045,22 @@ describe('app-dir action handling', () => {\n     it('should bundle external libraries if they are on the action layer', async () => {\n       await next.fetch('/client')\n       const pageBundle = await fs.readFile(\n-        join(next.testDir, '.next', 'server', 'app', 'client', 'page.js')\n+        join(next.testDir, '.next', 'server', 'app', 'client', 'page.js'),\n+        { encoding: 'utf8' }\n       )\n       if (isTurbopack) {\n-        const chunkPaths = pageBundle\n-          .toString()\n-          .matchAll(/loadChunk\\(\"([^\"]*)\"\\)/g)\n-        // @ts-ignore\n+        const chunkPaths = pageBundle.matchAll(/loadChunk\\(\"([^\"]*)\"\\)/g)\n         const reads = [...chunkPaths].map(async (match) => {\n           const bundle = await fs.readFile(\n-            join(next.testDir, '.next', ...match[1].split(/[\\\\/]/g))\n+            join(next.testDir, '.next', ...match[1].split(/[\\\\/]/g)),\n+            { encoding: 'utf8' }\n           )\n-          return bundle.toString().includes('node_modules/nanoid/index.js')\n+          return bundle.includes('node_modules/nanoid/index.js')\n         })\n \n         expect(await Promise.all(reads)).toContain(true)\n       } else {\n-        expect(pageBundle.toString()).toContain('node_modules/nanoid/index.js')\n+        expect(pageBundle).toContain('node_modules/nanoid/index.js')\n       }\n     })\n   }\n@@ -1519,7 +1524,7 @@ describe('app-dir action handling', () => {\n         const browser = await next.browser('/revalidate')\n         await browser.refresh()\n \n-        const thankYouNext = await browser.elementByCss('#thankyounext').text()\n+        const original = await browser.elementByCss('#thankyounext').text()\n \n         await browser.elementByCss('#another').click()\n         await retry(async () => {\n@@ -1528,47 +1533,54 @@ describe('app-dir action handling', () => {\n           )\n         })\n \n-        const newThankYouNext = await browser\n-          .elementByCss('#thankyounext')\n-          .text()\n-\n-        // Should be the same number although in serverless\n-        // it might be eventually consistent\n+        // Should be the same number although in serverless it might be\n+        // eventually consistent.\n         if (!isNextDeploy) {\n-          expect(thankYouNext).toEqual(newThankYouNext)\n+          await retry(async () => {\n+            const another = await browser.elementByCss('#thankyounext').text()\n+            expect(another).toEqual(original)\n+          })\n         }\n \n         await browser.elementByCss('#back').click()\n-\n-        // Should be different\n-        let revalidatedThankYouNext\n         await retry(async () => {\n-          switch (type) {\n-            case 'tag':\n-              await browser.elementByCss('#revalidate-thankyounext').click()\n-              break\n-            case 'path':\n-              await browser.elementByCss('#revalidate-path').click()\n-              break\n-            default:\n-              throw new Error(`Invalid type: ${type}`)\n-          }\n+          expect(await browser.elementByCss('#title').text()).toBe('revalidate')\n+        })\n \n-          revalidatedThankYouNext = await browser\n-            .elementByCss('#thankyounext')\n-            .text()\n+        switch (type) {\n+          case 'tag':\n+            await browser.elementByCss('#revalidate-thankyounext').click()\n+            break\n+          case 'path':\n+            await browser.elementByCss('#revalidate-path').click()\n+            break\n+          default:\n+            throw new Error(`Invalid type: ${type}`)\n+        }\n \n-          expect(thankYouNext).not.toBe(revalidatedThankYouNext)\n+        // Give some time for it to be revalidated.\n+        if (isNextDeploy) {\n+          await setTimeout(5000)\n+        }\n+\n+        // Should be different\n+        let revalidated\n+        await retry(async () => {\n+          revalidated = await browser.elementByCss('#thankyounext').text()\n+          expect(revalidated).not.toBe(original)\n         })\n \n         await browser.elementByCss('#another').click()\n+        await retry(async () => {\n+          expect(await browser.elementByCss('#title').text()).toBe(\n+            'another route'\n+          )\n+        })\n \n         // The other page should be revalidated too\n         await retry(async () => {\n-          const newThankYouNext = await browser\n-            .elementByCss('#thankyounext')\n-            .text()\n-          expect(revalidatedThankYouNext).toBe(newThankYouNext)\n+          const another = await browser.elementByCss('#thankyounext').text()\n+          expect(another).toBe(revalidated)\n         })\n       }\n     )"
        },
        {
            "sha": "0d348ab19a6bf8749ccce3eaf315529e866a0a0b",
            "filename": "test/e2e/app-dir/actions/app/revalidate-2/page.js",
            "status": "modified",
            "additions": 2,
            "deletions": 3,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/1141e677aed5c21f98b9629190335407a823abfd/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Frevalidate-2%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1141e677aed5c21f98b9629190335407a823abfd/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Frevalidate-2%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Frevalidate-2%2Fpage.js?ref=1141e677aed5c21f98b9629190335407a823abfd",
            "patch": "@@ -3,6 +3,7 @@ import { cookies } from 'next/headers'\n import Link from 'next/link'\n \n export default async function Page() {\n+  const randomCookie = (await cookies()).get('random')\n   const data = await fetch(\n     'https://next-data-api-endpoint.vercel.app/api/random?page',\n     {\n@@ -33,9 +34,7 @@ export default async function Page() {\n       </form>\n       <p>\n         random cookie:{' '}\n-        <span id=\"random-cookie\">\n-          {JSON.stringify((await cookies()).get('random'))}\n-        </span>\n+        <span id=\"random-cookie\">{JSON.stringify(randomCookie)}</span>\n       </p>\n     </>\n   )"
        },
        {
            "sha": "7e3de04841b531c20fe2a40becf563499ec09ba7",
            "filename": "test/e2e/app-dir/actions/app/revalidate/page.js",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/1141e677aed5c21f98b9629190335407a823abfd/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Frevalidate%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/1141e677aed5c21f98b9629190335407a823abfd/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Frevalidate%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Factions%2Fapp%2Frevalidate%2Fpage.js?ref=1141e677aed5c21f98b9629190335407a823abfd",
            "patch": "@@ -6,6 +6,7 @@ import { cookies } from 'next/headers'\n import RedirectClientComponent from './client'\n \n export default async function Page() {\n+  const cookie = (await cookies()).get('random')\n   const data = await fetch(\n     'https://next-data-api-endpoint.vercel.app/api/random?page',\n     {\n@@ -22,7 +23,7 @@ export default async function Page() {\n \n   return (\n     <>\n-      <p>/revalidate</p>\n+      <h1 id=\"title\">revalidate</h1>\n       <p>\n         {' '}\n         revalidate (tags: thankyounext): <span id=\"thankyounext\">\n@@ -39,10 +40,7 @@ export default async function Page() {\n         <span id=\"justputit\">{data2}</span>\n       </p>\n       <p>\n-        random cookie:{' '}\n-        <span id=\"random-cookie\">\n-          {JSON.stringify((await cookies()).get('random'))}\n-        </span>\n+        random cookie: <span id=\"random-cookie\">{JSON.stringify(cookie)}</span>\n       </p>\n       <form>\n         <button"
        }
    ],
    "stats": {
        "total": 125,
        "additions": 67,
        "deletions": 58
    }
}