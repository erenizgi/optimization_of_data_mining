{
    "author": "wbinnssmith",
    "message": "Refactor build scripts and rewrite pack-next in TypeScript (#77536)\n\nWritten with @bgw.\r\n\r\n- Transitions to using `tsx` for script execution\r\n- Replaces `patch-package` with TypeScript implementation\r\n- Implements argument parsing and help message with `yargs`\r\n- Uses `execa` for some command execution\r\n\r\nTest Plan: Run `pnpm pack-next`, `pnpm swc-build-wasm`, `pnpm unpack-next`, and `pnpm sweep` without errors.",
    "sha": "a6375148dc698fe302d34190d8fbd812f3013b9d",
    "files": [
        {
            "sha": "4171e88799bff251c940f0ba9c82b0110e51e992",
            "filename": "contributing/core/testing.md",
            "status": "modified",
            "additions": 28,
            "deletions": 15,
            "changes": 43,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/contributing%2Fcore%2Ftesting.md",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/contributing%2Fcore%2Ftesting.md",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/contributing%2Fcore%2Ftesting.md?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -123,40 +123,53 @@ pnpm test-dev test/e2e/app-dir/app/ --projects jest.config.*\n \n ## Integration testing outside the repository with local builds\n \n-You can locally generate tarballs for each package in this repository with:\n+You can locally generate builds for each package in this repository with:\n \n-```\n+```bash\n pnpm pack-next\n ```\n \n-The tarballs will be written to a `tarballs` directory in the root of the repository, and you will\n-be shown information about how to use these tarballs in a project by modifying the workspace\n-`package.json` file.\n-\n-Alternatively, you can automatically apply these `package.json` modifications by passing in your\n-project directory:\n+You can automatically apply modifications to `package.json` by specifying your project directory:\n \n-```\n+```bash\n pnpm pack-next --project ~/shadcn-ui/apps/www/\n ```\n \n This will find and modify parent workspaces when relevant. These automatic overrides should work\n with `npm` and `pnpm`. There are known issues preventing it from working with `bun` and `yarn`.\n \n-On some platforms, this generates stripped `@next/swc` binaries to avoid exceeding 2 GiB, [which is\n+Flags can be passed to `napi`'s CLI, separated by an argument separator (`--`). For example:\n+\n+```bash\n+pnpm pack-next --project ~/my-project/ -- --release\n+```\n+\n+See `pnpm pack-next --help` for more details.\n+\n+### Locally creating tarballs\n+\n+You can create tarballs with:\n+\n+```bash\n+pnpm pack-next --tar\n+```\n+\n+The tarballs will be written to a `tarballs` directory in the root of the repository, and you will\n+be shown information about how to use these tarballs in a project by modifying the workspace\n+`package.json` file.\n+\n+On Linux, this generates stripped `@next/swc` binaries to avoid exceeding 2 GiB, [which is\n known to cause problems with `pnpm`](https://github.com/libuv/libuv/pull/1501). That behavior can be\n-overridden with `PACK_NEXT_COMPRESS=objcopy-zstd` on Linux (which is slower, but retains debuginfo),\n-or with `PACK_NEXT_COMPRESS=none` on all platforms (which disables stripping entirely).\n+overridden with `--compress objcopy-zstd` on Linux (which is slower, but retains debuginfo).\n \n These tarballs can be extracted directly into a project's `node_modules` directory (bypassing the\n package manager) by using:\n \n-```\n+```bash\n pnpm unpack-next ~/shadcn-ui\n ```\n \n-However, this is not typically recommended, unless you're running into issues like the 2 GiB file\n-size limit.\n+However, this is not typically recommended, as installing using the package manager is safer.\n \n ## Integration testing outside the repository with preview builds\n "
        },
        {
            "sha": "ead6a3c40354d38b5af704111ef9714a9c29c7e4",
            "filename": "package.json",
            "status": "modified",
            "additions": 6,
            "deletions": 5,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/package.json",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/package.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/package.json?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -12,7 +12,7 @@\n     \"build\": \"turbo run build --remote-cache-timeout 60 --summarize true\",\n     \"lerna\": \"lerna\",\n     \"dev\": \"turbo run dev --parallel\",\n-    \"pack-next\": \"node scripts/pack-next.cjs\",\n+    \"pack-next\": \"tsx scripts/pack-next.ts\",\n     \"test-types\": \"tsc\",\n     \"test-unit\": \"jest test/unit/ packages/next/ packages/font\",\n     \"test-dev\": \"cross-env NEXT_TEST_MODE=dev pnpm testheadless\",\n@@ -67,11 +67,11 @@\n     \"sync-react\": \"node ./scripts/sync-react.js\",\n     \"update-google-fonts\": \"node ./scripts/update-google-fonts.js\",\n     \"patch-next\": \"node scripts/patch-next.cjs\",\n-    \"unpack-next\": \"node scripts/unpack-next.cjs\",\n-    \"swc-build-native\": \"node scripts/build-native.cjs\",\n-    \"swc-build-wasm\": \"node scripts/build-wasm.cjs\",\n+    \"unpack-next\": \"tsx scripts/unpack-next.cjs\",\n+    \"swc-build-native\": \"tsx scripts/build-native.cjs\",\n+    \"swc-build-wasm\": \"tsx scripts/build-wasm.cjs\",\n     \"build-turbopack-cli\": \"cargo build -p turbopack-cli --release\",\n-    \"sweep\": \"node scripts/sweep.cjs\",\n+    \"sweep\": \"tsx scripts/sweep.cjs\",\n     \"check-error-codes\": \"node packages/next/check-error-codes.js\",\n     \"update-error-codes\": \"cd packages/next && pnpm taskr compile check_error_codes\",\n     \"storybook\": \"turbo run storybook\",\n@@ -260,6 +260,7 @@\n     \"taskr\": \"1.1.0\",\n     \"tree-kill\": \"1.2.2\",\n     \"tsec\": \"0.2.1\",\n+    \"tsx\": \"4.19.2\",\n     \"turbo\": \"2.3.3\",\n     \"typescript\": \"5.8.2\",\n     \"unfetch\": \"4.2.0\","
        },
        {
            "sha": "27c914fd13f2b3fdc65b998fc86f27e5eed8ea56",
            "filename": "packages/next-swc/package.json",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/packages%2Fnext-swc%2Fpackage.json",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/packages%2Fnext-swc%2Fpackage.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext-swc%2Fpackage.json?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -2,6 +2,9 @@\n   \"name\": \"@next/swc\",\n   \"version\": \"15.3.0-canary.24\",\n   \"private\": true,\n+  \"files\": [\n+    \"native/\"\n+  ],\n   \"scripts\": {\n     \"clean\": \"node ../../scripts/rm.mjs native\",\n     \"build-native\": \"napi build --platform -p next-swc-napi --cargo-cwd ../../ --cargo-name next_swc_napi --features plugin,image-extended --js false native\",\n@@ -33,6 +36,7 @@\n   },\n   \"devDependencies\": {\n     \"@napi-rs/cli\": \"2.18.0\",\n-    \"cross-env\": \"6.0.3\"\n+    \"cross-env\": \"6.0.3\",\n+    \"wasm-pack\": \"0.13.1\"\n   }\n }"
        },
        {
            "sha": "5f47a0143d2524a380d63682f2c4647973c768bc",
            "filename": "pnpm-lock.yaml",
            "status": "modified",
            "additions": 55,
            "deletions": 12,
            "changes": 67,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/pnpm-lock.yaml",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/pnpm-lock.yaml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/pnpm-lock.yaml?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -146,7 +146,7 @@ importers:\n         version: 1.1.0\n       '@testing-library/jest-dom':\n         specifier: 6.1.2\n-        version: 6.1.2(@jest/globals@29.7.0)(@types/jest@29.5.5)(jest@29.7.0(@types/node@20.17.6)(babel-plugin-macros@3.1.0))(vitest@3.0.4(@types/node@20.17.6)(sass@1.54.0))\n+        version: 6.1.2(@jest/globals@29.7.0)(@types/jest@29.5.5)(jest@29.7.0(@types/node@20.17.6)(babel-plugin-macros@3.1.0))(vitest@3.0.4(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2))\n       '@testing-library/react':\n         specifier: ^15.0.5\n         version: 15.0.7(@types/react@19.0.8)(react-dom@19.1.0-canary-313332d1-20250326(react@19.1.0-canary-313332d1-20250326))(react@19.1.0-canary-313332d1-20250326)\n@@ -573,6 +573,9 @@ importers:\n       tsec:\n         specifier: 0.2.1\n         version: 0.2.1(@bazel/bazelisk@1.19.0)(typescript@5.8.2)\n+      tsx:\n+        specifier: 4.19.2\n+        version: 4.19.2\n       turbo:\n         specifier: 2.3.3\n         version: 2.3.3\n@@ -1686,6 +1689,9 @@ importers:\n       cross-env:\n         specifier: 6.0.3\n         version: 6.0.3\n+      wasm-pack:\n+        specifier: 0.13.1\n+        version: 0.13.1\n \n   packages/react-refresh-utils:\n     devDependencies:\n@@ -5064,6 +5070,7 @@ packages:\n   '@playwright/test@1.41.2':\n     resolution: {integrity: sha512-qQB9h7KbibJzrDpkXkYvsmiDJK14FULCCZgEcoe2AvFAS64oCirWTwzTlAYEbKaRxWs5TFesE1Na6izMv3HfGg==}\n     engines: {node: '>=16'}\n+    deprecated: Please update to the latest version of Playwright to test up-to-date browsers.\n     hasBin: true\n \n   '@polka/url@1.0.0-next.11':\n@@ -7016,6 +7023,9 @@ packages:\n     peerDependencies:\n       playwright: '>1.0.0'\n \n+  axios@0.26.1:\n+    resolution: {integrity: sha512-fPwcX4EvnSHuInCMItEhAGnaSEXRBjtzh9fOtsE6E1G6p7vl7edEeZe11QHf18+6+9gR5PbKV/sGKNaD8YaMeA==}\n+\n   axios@1.7.9:\n     resolution: {integrity: sha512-LhLcE7Hbiryz8oMDdDptSrWowmB4Bl6RCt6sIJKpRB4XtVf0iEgewX3au/pJqm+Py1kCASkb/FFKjxQaLtxJvw==}\n \n@@ -7156,6 +7166,10 @@ packages:\n     resolution: {integrity: sha512-Ceh+7ox5qe7LJuLHoY0feh3pHuUDHAcRUeyL2VYghZwfpkNIy/+8Ocg0a3UuSoYzavmylwuLWQOf3hl0jjMMIw==}\n     engines: {node: '>=8'}\n \n+  binary-install@1.1.0:\n+    resolution: {integrity: sha512-rkwNGW+3aQVSZoD0/o3mfPN6Yxh3Id0R/xzTVBVVpGNlVz8EGwusksxRlbk/A5iKTZt9zkMn3qIqmAt3vpfbzg==}\n+    engines: {node: '>=10'}\n+\n   bindings@1.5.0:\n     resolution: {integrity: sha512-p2q/t/mhvuOj/UeLlV6566GD/guowlr0hHxClI0W9m7MWYkL1F0hLo+0Aexs9HSPCtR1SXQ0TD3MMKrXZajbiQ==}\n \n@@ -11712,6 +11726,7 @@ packages:\n \n   lodash.get@4.4.2:\n     resolution: {integrity: sha512-z+Uw/vLuy6gQe8cfaFWD7p0wVv8fJl3mbzXh33RS+0oW2wvUqiRXiQ69gLWSLpgB5/6sU+r6BlQR0MBILadqTQ==}\n+    deprecated: This package is deprecated. Use the optional chaining (?.) operator instead.\n \n   lodash.intersection@4.4.0:\n     resolution: {integrity: sha512-N+L0cCfnqMv6mxXtSPeKt+IavbOBBSiAEkKyLasZ8BVcP9YXQgxLO12oPR8OyURwKV8l5vJKiE1M8aS70heuMg==}\n@@ -11733,6 +11748,7 @@ packages:\n \n   lodash.pick@4.4.0:\n     resolution: {integrity: sha512-hXt6Ul/5yWjfklSGvLQl8vM//l3FtyHZeuelpzK6mm99pNvN9yTDruNZPEJZD1oWrqo+izBmB7oUfWgcCX7s4Q==}\n+    deprecated: This package is deprecated. Use destructuring assignment syntax instead.\n \n   lodash.reduce@4.6.0:\n     resolution: {integrity: sha512-6raRe2vxCYBhpBu+B+TtNGUzah+hQjVdu3E17wfusjyrXBka2nBS8OH/gjVZ5PvHOhWmIZTYri09Z6n/QfnNMw==}\n@@ -11748,6 +11764,7 @@ packages:\n \n   lodash.template@4.5.0:\n     resolution: {integrity: sha512-84vYFxIkmidUiFxidA/KjjH9pAycqW+h980j7Fuz5qxRtO9pgB7MDFTdys1N7A5mcucRiDyEq4fusljItR1T/A==}\n+    deprecated: This package is deprecated. Use https://socket.dev/npm/package/eta instead.\n \n   lodash.templatesettings@4.2.0:\n     resolution: {integrity: sha512-stgLz+i3Aa9mZgnjr/O+v9ruKZsPsndy7qPZOchbqk2cnTU1ZaldKK+v7m54WoKIyxiuMZTKT2H81F8BeAc3ZQ==}\n@@ -14252,6 +14269,7 @@ packages:\n     engines: {node: '>=0.6.0', teleport: '>=0.2.0'}\n     deprecated: |-\n       You or someone you depend on is using Q, the JavaScript Promise library that gave JavaScript developers strong feelings about promises. They can almost certainly migrate to the native JavaScript promise now. Thank you literally everyone for joining me in this bet against the odds. Be excellent to each other.\n+\n       (For a CapTP with native promises, see @endo/eventual-send and @endo/captp)\n \n   qs@6.11.0:\n@@ -16822,6 +16840,10 @@ packages:\n   walker@1.0.8:\n     resolution: {integrity: sha512-ts/8E8l5b7kY0vlWLewOkDXMmPdLcVV4GmOQLyxuSswIJsweeFZtAsMF7k1Nszz+TYBQrlYRmzOnr398y1JemQ==}\n \n+  wasm-pack@0.13.1:\n+    resolution: {integrity: sha512-P9exD4YkjpDbw68xUhF3MDm/CC/3eTmmthyG5bHJ56kalxOTewOunxTke4SyF8MTXV6jUtNjXggPgrGmMtczGg==}\n+    hasBin: true\n+\n   watchpack@2.4.0:\n     resolution: {integrity: sha512-Lcvm7MGST/4fup+ifyKi2hjyIAwcdI4HRgtvTpIUxBRhB+RFtUh8XtDOxUfctVCnhVi+QQj49i91OyvzkJl6cg==}\n     engines: {node: '>=10.13.0'}\n@@ -22224,7 +22246,7 @@ snapshots:\n       lz-string: 1.5.0\n       pretty-format: 27.5.1\n \n-  '@testing-library/jest-dom@6.1.2(@jest/globals@29.7.0)(@types/jest@29.5.5)(jest@29.7.0(@types/node@20.17.6)(babel-plugin-macros@3.1.0))(vitest@3.0.4(@types/node@20.17.6)(sass@1.54.0))':\n+  '@testing-library/jest-dom@6.1.2(@jest/globals@29.7.0)(@types/jest@29.5.5)(jest@29.7.0(@types/node@20.17.6)(babel-plugin-macros@3.1.0))(vitest@3.0.4(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2))':\n     dependencies:\n       '@adobe/css-tools': 4.3.1\n       '@babel/runtime': 7.22.5\n@@ -22238,7 +22260,7 @@ snapshots:\n       '@jest/globals': 29.7.0\n       '@types/jest': 29.5.5\n       jest: 29.7.0(@types/node@20.17.6)(babel-plugin-macros@3.1.0)\n-      vitest: 3.0.4(@types/node@20.17.6)(sass@1.54.0)\n+      vitest: 3.0.4(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2)\n \n   '@testing-library/jest-dom@6.5.0':\n     dependencies:\n@@ -23078,13 +23100,13 @@ snapshots:\n       tinyrainbow: 2.0.0\n     optional: true\n \n-  '@vitest/mocker@3.0.4(vite@6.0.11(@types/node@20.17.6)(sass@1.54.0))':\n+  '@vitest/mocker@3.0.4(vite@6.0.11(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2))':\n     dependencies:\n       '@vitest/spy': 3.0.4\n       estree-walker: 3.0.3\n       magic-string: 0.30.17\n     optionalDependencies:\n-      vite: 6.0.11(@types/node@20.17.6)(sass@1.54.0)\n+      vite: 6.0.11(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2)\n     optional: true\n \n   '@vitest/pretty-format@2.0.5':\n@@ -23695,6 +23717,12 @@ snapshots:\n       picocolors: 1.1.1\n       playwright: 1.48.0\n \n+  axios@0.26.1:\n+    dependencies:\n+      follow-redirects: 1.15.9(debug@4.1.1)\n+    transitivePeerDependencies:\n+      - debug\n+\n   axios@1.7.9(debug@4.1.1):\n     dependencies:\n       follow-redirects: 1.15.9(debug@4.1.1)\n@@ -23882,6 +23910,14 @@ snapshots:\n \n   binary-extensions@2.3.0: {}\n \n+  binary-install@1.1.0:\n+    dependencies:\n+      axios: 0.26.1\n+      rimraf: 3.0.2\n+      tar: 6.1.15\n+    transitivePeerDependencies:\n+      - debug\n+\n   bindings@1.5.0:\n     dependencies:\n       file-uri-to-path: 1.0.0\n@@ -35976,13 +36012,13 @@ snapshots:\n       '@types/unist': 3.0.3\n       vfile-message: 4.0.2\n \n-  vite-node@3.0.4(@types/node@20.17.6)(sass@1.54.0):\n+  vite-node@3.0.4(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2):\n     dependencies:\n       cac: 6.7.14\n       debug: 4.4.0\n       es-module-lexer: 1.6.0\n       pathe: 2.0.2\n-      vite: 6.0.11(@types/node@20.17.6)(sass@1.54.0)\n+      vite: 6.0.11(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2)\n     transitivePeerDependencies:\n       - '@types/node'\n       - jiti\n@@ -35998,7 +36034,7 @@ snapshots:\n       - yaml\n     optional: true\n \n-  vite@6.0.11(@types/node@20.17.6)(sass@1.54.0):\n+  vite@6.0.11(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2):\n     dependencies:\n       esbuild: 0.24.2\n       postcss: 8.4.49\n@@ -36007,12 +36043,13 @@ snapshots:\n       '@types/node': 20.17.6\n       fsevents: 2.3.3\n       sass: 1.54.0\n+      tsx: 4.19.2\n     optional: true\n \n-  vitest@3.0.4(@types/node@20.17.6)(sass@1.54.0):\n+  vitest@3.0.4(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2):\n     dependencies:\n       '@vitest/expect': 3.0.4\n-      '@vitest/mocker': 3.0.4(vite@6.0.11(@types/node@20.17.6)(sass@1.54.0))\n+      '@vitest/mocker': 3.0.4(vite@6.0.11(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2))\n       '@vitest/pretty-format': 3.0.4\n       '@vitest/runner': 3.0.4\n       '@vitest/snapshot': 3.0.4\n@@ -36028,8 +36065,8 @@ snapshots:\n       tinyexec: 0.3.2\n       tinypool: 1.0.2\n       tinyrainbow: 2.0.0\n-      vite: 6.0.11(@types/node@20.17.6)(sass@1.54.0)\n-      vite-node: 3.0.4(@types/node@20.17.6)(sass@1.54.0)\n+      vite: 6.0.11(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2)\n+      vite-node: 3.0.4(@types/node@20.17.6)(sass@1.54.0)(tsx@4.19.2)\n       why-is-node-running: 2.3.0\n     optionalDependencies:\n       '@types/node': 20.17.6\n@@ -36086,6 +36123,12 @@ snapshots:\n     dependencies:\n       makeerror: 1.0.12\n \n+  wasm-pack@0.13.1:\n+    dependencies:\n+      binary-install: 1.1.0\n+    transitivePeerDependencies:\n+      - debug\n+\n   watchpack@2.4.0:\n     dependencies:\n       glob-to-regexp: 0.4.1"
        },
        {
            "sha": "b073e228778c3892df67ca241baccc8cde51f779",
            "filename": "scripts/build-native.cjs",
            "status": "removed",
            "additions": 0,
            "deletions": 96,
            "changes": 96,
            "blob_url": "https://github.com/vercel/next.js/blob/7dab09943cea549382c63bf3cc19307a8b448dd3/scripts%2Fbuild-native.cjs",
            "raw_url": "https://github.com/vercel/next.js/raw/7dab09943cea549382c63bf3cc19307a8b448dd3/scripts%2Fbuild-native.cjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fbuild-native.cjs?ref=7dab09943cea549382c63bf3cc19307a8b448dd3",
            "patch": "@@ -1,96 +0,0 @@\n-#!/usr/bin/env node\n-\n-const {\n-  NEXT_DIR,\n-  booleanArg,\n-  execAsyncWithOutput,\n-  execFn,\n-  exec,\n-  namedValueArg,\n-} = require('./pack-util.cjs')\n-const fs = require('fs')\n-const path = require('path')\n-\n-const args = process.argv.slice(2)\n-\n-// strip --no-build and --project when called from pack-next.cjs\n-booleanArg(args, '--no-build')\n-namedValueArg(args, '--project')\n-\n-const targetDir = path.join(NEXT_DIR, 'target')\n-const nextSwcDir = path.join(NEXT_DIR, 'packages/next-swc')\n-\n-module.exports = (async () => {\n-  for (let i = 0; i < 2; i++) {\n-    try {\n-      await execAsyncWithOutput(\n-        'Build native bindings',\n-        ['pnpm', 'run', 'build-native', ...args],\n-        {\n-          cwd: nextSwcDir,\n-          shell: process.platform === 'win32' ? 'powershell.exe' : false,\n-          env: {\n-            CARGO_TERM_COLOR: 'always',\n-            TTY: '1',\n-            ...process.env,\n-          },\n-        }\n-      )\n-    } catch (e) {\n-      if (\n-        e.stderr\n-          .toString()\n-          .includes('the compiler unexpectedly panicked. this is a bug.')\n-      ) {\n-        fs.rmSync(path.join(targetDir, 'release/incremental'), {\n-          recursive: true,\n-          force: true,\n-        })\n-        fs.rmSync(path.join(targetDir, 'debug/incremental'), {\n-          recursive: true,\n-          force: true,\n-        })\n-        continue\n-      }\n-      delete e.stdout\n-      delete e.stderr\n-      throw e\n-    }\n-    break\n-  }\n-\n-  execFn(\n-    'Copy generated types to `next/src/build/swc/generated-native.d.ts`',\n-    () => writeTypes()\n-  )\n-})()\n-\n-function writeTypes() {\n-  const generatedTypesPath = path.join(\n-    NEXT_DIR,\n-    'packages/next-swc/native/index.d.ts'\n-  )\n-  const vendoredTypesPath = path.join(\n-    NEXT_DIR,\n-    'packages/next/src/build/swc/generated-native.d.ts'\n-  )\n-  const generatedTypesMarker = '// GENERATED-TYPES-BELOW\\n'\n-  const generatedNotice =\n-    '// DO NOT MANUALLY EDIT THESE TYPES\\n// You can regenerate this file by running `pnpm swc-build-native` in the root of the repo.\\n\\n'\n-\n-  const generatedTypes = fs.readFileSync(generatedTypesPath, 'utf8')\n-  let vendoredTypes = fs.readFileSync(vendoredTypesPath, 'utf8')\n-\n-  vendoredTypes = vendoredTypes.split(generatedTypesMarker)[0]\n-  vendoredTypes =\n-    vendoredTypes + generatedTypesMarker + generatedNotice + generatedTypes\n-\n-  fs.writeFileSync(vendoredTypesPath, vendoredTypes)\n-\n-  exec('Prettify generated types', [\n-    'pnpm',\n-    'prettier',\n-    '--write',\n-    vendoredTypesPath,\n-  ])\n-}"
        },
        {
            "sha": "4512440f79a5637931ff90f3042fb815f19994fd",
            "filename": "scripts/build-native.ts",
            "status": "added",
            "additions": 70,
            "deletions": 0,
            "changes": 70,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fbuild-native.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fbuild-native.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fbuild-native.ts?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -0,0 +1,70 @@\n+#!/usr/bin/env node\n+\n+import { promises as fs } from 'node:fs'\n+import path from 'node:path'\n+import execa from 'execa'\n+import { NEXT_DIR, logCommand, execFn } from './pack-util'\n+\n+const nextSwcDir = path.join(NEXT_DIR, 'packages/next-swc')\n+\n+export default async function buildNative(\n+  buildNativeArgs: string[]\n+): Promise<void> {\n+  const buildCommand = ['pnpm', 'run', 'build-native', ...buildNativeArgs]\n+  logCommand('Build native bindings', buildCommand)\n+  await execa(buildCommand[0], buildCommand.slice(1), {\n+    cwd: nextSwcDir,\n+    // Without a shell, `pnpm run build-native` returns a 0 exit code on SIGINT?\n+    shell: true,\n+    env: {\n+      CARGO_TERM_COLOR: 'always',\n+      TTY: '1',\n+    },\n+    stdio: 'inherit',\n+  })\n+\n+  await execFn(\n+    'Copy generated types to `next/src/build/swc/generated-native.d.ts`',\n+    () => writeTypes()\n+  )\n+}\n+\n+// Check if this file is being run directly\n+if (import.meta.url === `file://${process.argv[1]}`) {\n+  buildNative(process.argv.slice(2)).catch((err) => {\n+    console.error(err)\n+    process.exit(1)\n+  })\n+}\n+\n+async function writeTypes() {\n+  const generatedTypesPath = path.join(\n+    NEXT_DIR,\n+    'packages/next-swc/native/index.d.ts'\n+  )\n+  const vendoredTypesPath = path.join(\n+    NEXT_DIR,\n+    'packages/next/src/build/swc/generated-native.d.ts'\n+  )\n+  const generatedTypesMarker = '// GENERATED-TYPES-BELOW\\n'\n+  const generatedNotice =\n+    '// DO NOT MANUALLY EDIT THESE TYPES\\n' +\n+    '// You can regenerate this file by running `pnpm swc-build-native` in the root of the repo.\\n\\n'\n+\n+  const generatedTypes = await fs.readFile(generatedTypesPath, 'utf8')\n+  let vendoredTypes = await fs.readFile(vendoredTypesPath, 'utf8')\n+\n+  vendoredTypes = vendoredTypes.split(generatedTypesMarker)[0]\n+  vendoredTypes =\n+    vendoredTypes + generatedTypesMarker + generatedNotice + generatedTypes\n+\n+  await fs.writeFile(vendoredTypesPath, vendoredTypes)\n+\n+  const prettifyCommand = ['prettier', '--write', vendoredTypesPath]\n+  logCommand('Prettify generated types', prettifyCommand)\n+  await execa(prettifyCommand[0], prettifyCommand.slice(1), {\n+    cwd: NEXT_DIR,\n+    stdio: 'inherit',\n+    preferLocal: true,\n+  })\n+}"
        },
        {
            "sha": "b44acf0de22c9b45abcd6790a3615134e04b9246",
            "filename": "scripts/build-wasm.cjs",
            "status": "modified",
            "additions": 15,
            "deletions": 53,
            "changes": 68,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fbuild-wasm.cjs",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fbuild-wasm.cjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fbuild-wasm.cjs?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -1,63 +1,25 @@\n-#!/usr/bin/env node\n+// This script must be run with tsx\n \n-const {\n-  NEXT_DIR,\n-  booleanArg,\n-  execAsyncWithOutput,\n-  execFn,\n-  exec,\n-  namedValueArg,\n-} = require('./pack-util.cjs')\n+const { NEXT_DIR, execAsyncWithOutput, execFn, exec } = require('./pack-util')\n const fs = require('fs')\n const path = require('path')\n \n-const args = process.argv.slice(2)\n-\n-// strip --no-build and --project when called from pack-next.cjs\n-booleanArg(args, '--no-build')\n-namedValueArg(args, '--project')\n-\n-const targetDir = path.join(NEXT_DIR, 'target')\n const nextSwcDir = path.join(NEXT_DIR, 'packages/next-swc')\n \n-module.exports = (async () => {\n-  for (let i = 0; i < 2; i++) {\n-    try {\n-      await execAsyncWithOutput(\n-        'Build wasm bindings',\n-        ['pnpm', 'run', 'build-wasm', ...args],\n-        {\n-          cwd: nextSwcDir,\n-          shell: process.platform === 'win32' ? 'powershell.exe' : false,\n-          env: {\n-            CARGO_TERM_COLOR: 'always',\n-            TTY: '1',\n-            ...process.env,\n-          },\n-        }\n-      )\n-    } catch (e) {\n-      if (\n-        e.stderr\n-          .toString()\n-          .includes('the compiler unexpectedly panicked. this is a bug.')\n-      ) {\n-        fs.rmSync(path.join(targetDir, 'release/incremental'), {\n-          recursive: true,\n-          force: true,\n-        })\n-        fs.rmSync(path.join(targetDir, 'debug/incremental'), {\n-          recursive: true,\n-          force: true,\n-        })\n-        continue\n-      }\n-      delete e.stdout\n-      delete e.stderr\n-      throw e\n+;(async () => {\n+  await execAsyncWithOutput(\n+    'Build wasm bindings',\n+    ['pnpm', 'run', 'build-wasm', ...process.argv.slice(2)],\n+    {\n+      cwd: nextSwcDir,\n+      shell: process.platform === 'win32' ? 'powershell.exe' : false,\n+      env: {\n+        CARGO_TERM_COLOR: 'always',\n+        TTY: '1',\n+        ...process.env,\n+      },\n     }\n-    break\n-  }\n+  )\n \n   execFn(\n     'Copy generated types to `next/src/build/swc/generated-wasm.d.ts`',"
        },
        {
            "sha": "e3db122c3a88dbd7f632fdc4a16c234494760fb5",
            "filename": "scripts/pack-next.cjs",
            "status": "removed",
            "additions": 0,
            "deletions": 190,
            "changes": 190,
            "blob_url": "https://github.com/vercel/next.js/blob/7dab09943cea549382c63bf3cc19307a8b448dd3/scripts%2Fpack-next.cjs",
            "raw_url": "https://github.com/vercel/next.js/raw/7dab09943cea549382c63bf3cc19307a8b448dd3/scripts%2Fpack-next.cjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fpack-next.cjs?ref=7dab09943cea549382c63bf3cc19307a8b448dd3",
            "patch": "@@ -1,190 +0,0 @@\n-#!/usr/bin/env node\n-\n-const {\n-  NEXT_DIR,\n-  booleanArg,\n-  exec,\n-  execAsyncWithOutput,\n-  glob,\n-  namedValueArg,\n-  packageFiles,\n-} = require('./pack-util.cjs')\n-const fs = require('fs')\n-const fsPromises = require('fs/promises')\n-\n-const args = process.argv.slice(2)\n-\n-const TARBALLS = `${NEXT_DIR}/tarballs`\n-const NEXT_PACKAGES = `${NEXT_DIR}/packages`\n-const noBuild = booleanArg(args, '--no-build')\n-const projectPath = namedValueArg(args, '--project')\n-\n-async function main() {\n-  // the debuginfo on macos is much smaller, so we don't typically need to strip\n-  const DEFAULT_PACK_NEXT_COMPRESS =\n-    process.platform === 'darwin' ? 'none' : 'strip'\n-  const PACK_NEXT_COMPRESS =\n-    process.env.PACK_NEXT_COMPRESS || DEFAULT_PACK_NEXT_COMPRESS\n-\n-  fs.mkdirSync(TARBALLS, { recursive: true })\n-\n-  if (!noBuild) {\n-    exec('Install Next.js build dependencies', 'pnpm i')\n-    exec('Build Next.js', 'pnpm run build')\n-  }\n-\n-  if (PACK_NEXT_COMPRESS !== 'strip') {\n-    // HACK: delete any pre-existing binaries to force napi-rs to rewrite it\n-    let binaries = await nextSwcBinaries()\n-    await Promise.all(binaries.map((bin) => fsPromises.rm(bin)))\n-  }\n-\n-  await require('./build-native.cjs')\n-\n-  const NEXT_TARBALL = `${TARBALLS}/next.tar`\n-  const NEXT_SWC_TARBALL = `${TARBALLS}/next-swc.tar`\n-  const NEXT_MDX_TARBALL = `${TARBALLS}/next-mdx.tar`\n-  const NEXT_ENV_TARBALL = `${TARBALLS}/next-env.tar`\n-  const NEXT_BA_TARBALL = `${TARBALLS}/next-bundle-analyzer.tar`\n-\n-  async function nextSwcBinaries() {\n-    return await glob('next-swc/native/*.node', {\n-      cwd: NEXT_PACKAGES,\n-      absolute: true,\n-    })\n-  }\n-\n-  // We use neither:\n-  // * npm pack, as it doesn't include native modules in the tarball\n-  // * pnpm pack, as it tries to include target directories and compress them,\n-  //   which takes forever.\n-  // Instead, we generate non-compressed tarballs.\n-  async function packWithTar(packagePath, tarballPath, extraArgs = []) {\n-    const paths = await packageFiles(packagePath)\n-\n-    const command = [\n-      'tar',\n-      '-c',\n-      // https://apple.stackexchange.com/a/444073\n-      ...(process.platform === 'darwin' ? ['--no-mac-metadata'] : []),\n-      '-f',\n-      tarballPath,\n-      ...extraArgs,\n-      '--',\n-      ...paths.map((p) => `./${p}`),\n-    ]\n-\n-    await execAsyncWithOutput(`Pack ${packagePath}`, command, {\n-      cwd: packagePath,\n-    })\n-  }\n-\n-  // Special-case logic for packing next-swc.\n-  //\n-  // pnpm emits `ERR_FS_FILE_TOO_LARGE` if the tarfile is >2GiB due to limits\n-  // in libuv (https://github.com/libuv/libuv/pull/1501). This is common with\n-  // next-swc due to the large amount of debugging symbols. We can fix this one\n-  // of two ways: strip or compression.\n-  //\n-  // We default to stripping (usually faster), but on Linux, we can compress\n-  // instead with objcopy, keeping debug symbols intact. This is controlled by\n-  // `PACK_NEXT_COMPRESS`.\n-  async function packNextSwc() {\n-    const packagePath = `${NEXT_PACKAGES}/next-swc`\n-    switch (PACK_NEXT_COMPRESS) {\n-      case 'strip':\n-        await execAsyncWithOutput('Stripping next-swc native binary', [\n-          'strip',\n-          ...(process.platform === 'darwin' ? ['-x', '-'] : ['--']),\n-          await nextSwcBinaries(),\n-        ])\n-        await packWithTar(packagePath, NEXT_SWC_TARBALL)\n-        break\n-      case 'objcopy-zstd':\n-      case 'objcopy-zlib':\n-        if (process.platform !== 'linux') {\n-          throw new Error('objcopy-{zstd,zlib} is only supported on Linux')\n-        }\n-        const format = PACK_NEXT_COMPRESS == 'objcopy-zstd' ? 'zstd' : 'zlib'\n-        await Promise.all(\n-          (await nextSwcBinaries()).map((bin) =>\n-            execAsyncWithOutput(\n-              'Compressing debug symbols in next-swc native binary',\n-              ['objcopy', `--compress-debug-sections=${format}`, '--', bin]\n-            )\n-          )\n-        )\n-        await packWithTar(packagePath, NEXT_SWC_TARBALL)\n-        break\n-      case 'none':\n-        await packWithTar(packagePath, NEXT_SWC_TARBALL)\n-        break\n-      default:\n-        throw new Error(\n-          \"PACK_NEXT_COMPRESS must be one of 'strip', 'objcopy-zstd', \" +\n-            \"'objcopy-zlib', or 'none'\"\n-        )\n-    }\n-  }\n-\n-  // build all tarfiles in parallel\n-  await Promise.all([\n-    packNextSwc(),\n-    ...[\n-      [`${NEXT_PACKAGES}/next`, NEXT_TARBALL],\n-      [`${NEXT_PACKAGES}/next-mdx`, NEXT_MDX_TARBALL],\n-      [`${NEXT_PACKAGES}/next-env`, NEXT_ENV_TARBALL],\n-      [`${NEXT_PACKAGES}/next-bundle-analyzer`, NEXT_BA_TARBALL],\n-    ].map(([packagePath, tarballPath]) =>\n-      packWithTar(packagePath, tarballPath)\n-    ),\n-  ])\n-\n-  if (projectPath != null) {\n-    await execAsyncWithOutput(`Update package.json for ${projectPath}`, [\n-      'cargo',\n-      'xtask',\n-      'patch-package-json',\n-      projectPath,\n-      `--next-tarball=${NEXT_TARBALL}`,\n-      `--next-mdx-tarball=${NEXT_MDX_TARBALL}`,\n-      `--next-env-tarball=${NEXT_ENV_TARBALL}`,\n-      `--next-bundle-analyzer-tarball=${NEXT_BA_TARBALL}`,\n-      `--next-swc-tarball=${NEXT_SWC_TARBALL}`,\n-    ])\n-  } else {\n-    console.log('Add the following overrides to your workspace package.json:')\n-    console.log(`  \"pnpm\": {`)\n-    console.log(`    \"overrides\": {`)\n-    console.log(`      \"next\": ${JSON.stringify(`file:${NEXT_TARBALL}`)},`)\n-    console.log(\n-      `      \"@next/mdx\": ${JSON.stringify(`file:${NEXT_MDX_TARBALL}`)},`\n-    )\n-    console.log(\n-      `      \"@next/env\": ${JSON.stringify(`file:${NEXT_ENV_TARBALL}`)},`\n-    )\n-    console.log(\n-      `      \"@next/bundle-analyzer\": ${JSON.stringify(\n-        `file:${NEXT_BA_TARBALL}`\n-      )}`\n-    )\n-    console.log(`    }`)\n-    console.log(`  }`)\n-    console.log()\n-    console.log(\n-      'Add the following dependencies to your workspace package.json:'\n-    )\n-    console.log(`  \"dependencies\": {`)\n-    console.log(\n-      `    \"@next/swc\": ${JSON.stringify(`file:${NEXT_SWC_TARBALL}`)},`\n-    )\n-    console.log(`    ...`)\n-    console.log(`  }`)\n-    console.log()\n-  }\n-}\n-\n-main().catch((e) => {\n-  console.error(e)\n-  process.exit(1)\n-})"
        },
        {
            "sha": "2a08f149def136a55e1b98c127bc7d0ecba3fc4c",
            "filename": "scripts/pack-next.ts",
            "status": "added",
            "additions": 260,
            "deletions": 0,
            "changes": 260,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fpack-next.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fpack-next.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fpack-next.ts?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -0,0 +1,260 @@\n+// This script must be run with tsx\n+\n+import fs from 'node:fs/promises'\n+import yargs from 'yargs'\n+import { default as patchPackageJson } from './pack-utils/patch-package-json.js'\n+import buildNative from './build-native.js'\n+\n+import {\n+  NEXT_DIR,\n+  exec,\n+  execAsyncWithOutput,\n+  glob,\n+  packageFiles,\n+} from './pack-util.js'\n+\n+const TARBALLS = `${NEXT_DIR}/tarballs`\n+const NEXT_PACKAGES = `${NEXT_DIR}/packages`\n+const NEXT_TARBALL = `${TARBALLS}/next.tar`\n+const NEXT_SWC_TARBALL = `${TARBALLS}/next-swc.tar`\n+const NEXT_MDX_TARBALL = `${TARBALLS}/next-mdx.tar`\n+const NEXT_ENV_TARBALL = `${TARBALLS}/next-env.tar`\n+const NEXT_BA_TARBALL = `${TARBALLS}/next-bundle-analyzer.tar`\n+\n+type CompressOpt = 'none' | 'strip' | 'objcopy-zlib' | 'objcopy-zstd'\n+\n+interface CliOptions {\n+  jsBuild?: boolean\n+  project?: string\n+  tar?: boolean\n+  compress?: CompressOpt\n+  _: string[]\n+}\n+\n+const cliOptions = yargs(process.argv.slice(2))\n+  .command('$0')\n+  .option('no-js-build', {\n+    type: 'boolean',\n+    describe: 'Skip building JavaScript code',\n+  })\n+  .option('project', {\n+    alias: 'p',\n+    type: 'string',\n+  })\n+  .option('tar', {\n+    type: 'boolean',\n+    describe: 'Create tarballs instead of direct reflinks',\n+  })\n+  .option('compress', {\n+    type: 'string',\n+    describe:\n+      'How compress the binary, useful on platforms where tarballs can ' +\n+      'exceed 2 GiB, which causes ERR_FS_FILE_TOO_LARGE with pnpm. Defaults ' +\n+      'to \"strip\" on Linux, otherwise defaults to \"none\". Requires `--tar` ' +\n+      'to be set.',\n+    choices: [\n+      'none',\n+      'strip',\n+      ...(process.platform === 'linux' ? ['objcopy-zlib', 'objcopy-zstd'] : []),\n+    ],\n+  })\n+  .check((opts: CliOptions) => {\n+    if (!opts.tar && (opts.compress ?? 'none') !== 'none') {\n+      throw new Error('--compress is only valid in combination with --tar')\n+    }\n+    return true\n+  })\n+  .middleware((opts: CliOptions) => {\n+    if (opts.tar && process.platform === 'linux' && opts.compress == null) {\n+      opts.compress = 'strip'\n+    }\n+  })\n+  .strict().argv as unknown as CliOptions\n+\n+interface PackageFiles {\n+  nextFile: string\n+  nextMdxFile: string\n+  nextEnvFile: string\n+  nextBaFile: string\n+  nextSwcFile: string\n+}\n+\n+async function main(): Promise<void> {\n+  if (cliOptions.jsBuild) {\n+    exec('Install Next.js build dependencies', 'pnpm i')\n+    exec('Build Next.js', 'pnpm run build')\n+  }\n+\n+  if (cliOptions.tar && cliOptions.compress !== 'strip') {\n+    // HACK: delete any pre-existing binaries to force napi-rs to rewrite it\n+    // We must do this as pre-existing could've been stripped.\n+    let binaries = await nextSwcBinaries()\n+    await Promise.all(binaries.map((bin) => fs.rm(bin)))\n+  }\n+\n+  await buildNative(cliOptions._)\n+\n+  if (cliOptions.tar) {\n+    await fs.mkdir(TARBALLS, { recursive: true })\n+\n+    // build all tarfiles in parallel\n+    await Promise.all([\n+      packNextSwcWithTar(cliOptions.compress ?? 'none'),\n+      ...[\n+        [`${NEXT_PACKAGES}/next`, NEXT_TARBALL],\n+        [`${NEXT_PACKAGES}/next-mdx`, NEXT_MDX_TARBALL],\n+        [`${NEXT_PACKAGES}/next-env`, NEXT_ENV_TARBALL],\n+        [`${NEXT_PACKAGES}/next-bundle-analyzer`, NEXT_BA_TARBALL],\n+      ].map(([packagePath, tarballPath]) =>\n+        packWithTar(packagePath, tarballPath)\n+      ),\n+    ])\n+  }\n+\n+  const packageFiles = getPackageFiles(cliOptions.tar)\n+\n+  if (cliOptions.project != null) {\n+    const patchedPath = await patchPackageJson(cliOptions.project, {\n+      nextTarball: packageFiles.nextFile,\n+      nextMdxTarball: packageFiles.nextMdxFile,\n+      nextEnvTarball: packageFiles.nextEnvFile,\n+      nextBundleAnalyzerTarball: packageFiles.nextBaFile,\n+      nextSwcTarball: packageFiles.nextSwcFile,\n+    })\n+    console.log(`Patched ${patchedPath}`)\n+  } else {\n+    console.log('Add the following overrides to your workspace package.json:')\n+    console.log(`  \"pnpm\": {`)\n+    console.log(`    \"overrides\": {`)\n+    console.log(\n+      `      \"next\": ${JSON.stringify(`file:${packageFiles.nextFile}`)},`\n+    )\n+    console.log(\n+      `      \"@next/mdx\": ${JSON.stringify(`file:${packageFiles.nextMdxFile}`)},`\n+    )\n+    console.log(\n+      `      \"@next/env\": ${JSON.stringify(`file:${packageFiles.nextEnvFile}`)},`\n+    )\n+    console.log(\n+      `      \"@next/bundle-analyzer\": ${JSON.stringify(`file:${packageFiles.nextBaFile}`)}`\n+    )\n+    console.log(`    }`)\n+    console.log(`  }`)\n+    console.log()\n+    console.log(\n+      'Add the following dependencies to your workspace package.json:'\n+    )\n+    console.log(`  \"dependencies\": {`)\n+    console.log(\n+      `    \"@next/swc\": ${JSON.stringify(`file:${packageFiles.nextSwcFile}`)},`\n+    )\n+    console.log(`    ...`)\n+    console.log(`  }`)\n+    console.log()\n+  }\n+}\n+\n+main().catch((e) => {\n+  console.error(e)\n+  process.exit(1)\n+})\n+\n+async function nextSwcBinaries(): Promise<string[]> {\n+  return await glob('next-swc/native/*.node', {\n+    cwd: NEXT_PACKAGES,\n+    absolute: true,\n+  })\n+}\n+\n+// We use neither:\n+// * npm pack, as it doesn't include native modules in the tarball\n+// * pnpm pack, as it tries to include target directories and compress them,\n+//   which takes forever.\n+// Instead, we generate non-compressed tarballs.\n+async function packWithTar(\n+  packagePath: string,\n+  tarballPath: string,\n+  extraArgs: string[] = []\n+): Promise<void> {\n+  const paths = await packageFiles(packagePath)\n+\n+  const command = [\n+    'tar',\n+    '-c',\n+    // https://apple.stackexchange.com/a/444073\n+    ...(process.platform === 'darwin' ? ['--no-mac-metadata'] : []),\n+    '-f',\n+    tarballPath,\n+    ...extraArgs,\n+    '--',\n+    ...paths.map((p) => `./${p}`),\n+  ]\n+\n+  await execAsyncWithOutput(`Pack ${packagePath}`, command, {\n+    cwd: packagePath,\n+  })\n+}\n+\n+// Special-case logic for packing next-swc.\n+//\n+// pnpm emits `ERR_FS_FILE_TOO_LARGE` if the tarfile is >2GiB due to limits\n+// in libuv (https://github.com/libuv/libuv/pull/1501). This is common with\n+// next-swc due to the large amount of debugging symbols. We can fix this one\n+// of two ways: strip or compression.\n+//\n+// We default to stripping (usually faster), but on Linux, we can compress\n+// instead with objcopy, keeping debug symbols intact. This is controlled by\n+// `PACK_NEXT_COMPRESS`.\n+async function packNextSwcWithTar(compress: CompressOpt): Promise<void> {\n+  const packagePath = `${NEXT_PACKAGES}/next-swc`\n+  switch (compress) {\n+    case 'strip':\n+      await execAsyncWithOutput('Stripping next-swc native binary', [\n+        'strip',\n+        ...(process.platform === 'darwin' ? ['-x', '-'] : ['--']),\n+        ...(await nextSwcBinaries()),\n+      ])\n+      await packWithTar(packagePath, NEXT_SWC_TARBALL)\n+      break\n+    case 'objcopy-zstd':\n+    case 'objcopy-zlib':\n+      // Linux-specific, feature is gated by yargs choices array\n+      const format = compress === 'objcopy-zstd' ? 'zstd' : 'zlib'\n+      await Promise.all(\n+        (await nextSwcBinaries()).map((bin) =>\n+          execAsyncWithOutput(\n+            'Compressing debug symbols in next-swc native binary',\n+            ['objcopy', `--compress-debug-sections=${format}`, '--', bin]\n+          )\n+        )\n+      )\n+      await packWithTar(packagePath, NEXT_SWC_TARBALL)\n+      break\n+    case 'none':\n+      await packWithTar(packagePath, NEXT_SWC_TARBALL)\n+      break\n+    default:\n+      // should never happen, yargs enforces the `choices` array\n+      throw new Error('compress value is invalid')\n+  }\n+}\n+\n+function getPackageFiles(shouldCreateTarballs?: boolean): PackageFiles {\n+  if (shouldCreateTarballs) {\n+    return {\n+      nextFile: NEXT_TARBALL,\n+      nextMdxFile: NEXT_MDX_TARBALL,\n+      nextEnvFile: NEXT_ENV_TARBALL,\n+      nextBaFile: NEXT_BA_TARBALL,\n+      nextSwcFile: NEXT_SWC_TARBALL,\n+    }\n+  }\n+\n+  return {\n+    nextFile: `${NEXT_PACKAGES}/next`,\n+    nextMdxFile: `${NEXT_PACKAGES}/next-mdx`,\n+    nextEnvFile: `${NEXT_PACKAGES}/next-env`,\n+    nextBaFile: `${NEXT_PACKAGES}/next-bundle-analyzer`,\n+    nextSwcFile: `${NEXT_PACKAGES}/next-swc`,\n+  }\n+}"
        },
        {
            "sha": "6d6b05899ac0cf9a713cc7ddbcad2c42751278e4",
            "filename": "scripts/pack-util.ts",
            "status": "renamed",
            "additions": 41,
            "deletions": 56,
            "changes": 97,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fpack-util.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fpack-util.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fpack-util.ts?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -1,23 +1,25 @@\n-const { execSync, execFileSync, spawn } = require('child_process')\n-const { existsSync } = require('fs')\n-const globOrig = require('glob')\n-const { join } = require('path')\n-const { promisify } = require('util')\n+import {\n+  execSync,\n+  execFileSync,\n+  spawn,\n+  ExecSyncOptionsWithStringEncoding,\n+} from 'child_process'\n+import { existsSync } from 'fs'\n+import globOrig from 'glob'\n+import { join } from 'path'\n+import { promisify } from 'util'\n \n-const glob = promisify(globOrig)\n-exports.glob = glob\n+export const glob = promisify(globOrig)\n \n-const NEXT_DIR = join(__dirname, '..')\n-\n-exports.NEXT_DIR = NEXT_DIR\n+export const NEXT_DIR = join(__dirname, '..')\n \n /**\n  * @param {string} title\n  * @param {string | string[]} command\n  * @param {ExecSyncOptions} [opts]\n  * @returns {string}\n  */\n-function exec(title, command, opts) {\n+export function exec(title, command, opts?: ExecSyncOptionsWithStringEncoding) {\n   if (Array.isArray(command)) {\n     logCommand(title, command)\n     return execFileSync(command[0], command.slice(1), {\n@@ -35,27 +37,45 @@ function exec(title, command, opts) {\n   }\n }\n \n-exports.exec = exec\n+class ExecError extends Error {\n+  code: number | null\n+  stdout: Buffer\n+  stderr: Buffer\n+}\n+\n+type ExecOutput = {\n+  stdout: Buffer\n+  stderr: Buffer\n+}\n \n /**\n  * @param {string} title\n  * @param {string | string[]} command\n  * @param {SpawnOptions} [opts]\n  */\n-function execAsyncWithOutput(title, command, opts) {\n+export function execAsyncWithOutput(\n+  title,\n+  command,\n+  opts?: Partial<ExecSyncOptionsWithStringEncoding>\n+): Promise<ExecOutput> {\n   logCommand(title, command)\n   const proc = spawn(command[0], command.slice(1), {\n     encoding: 'utf8',\n     stdio: ['inherit', 'pipe', 'pipe'],\n     cwd: NEXT_DIR,\n     ...opts,\n   })\n-  const stdout = []\n+\n+  if (!proc || !proc.stdout || !proc.stderr) {\n+    throw new Error(`Failed to spawn: ${title}`)\n+  }\n+\n+  const stdout: Buffer[] = []\n   proc.stdout.on('data', (data) => {\n     process.stdout.write(data)\n     stdout.push(data)\n   })\n-  const stderr = []\n+  const stderr: Buffer[] = []\n   proc.stderr.on('data', (data) => {\n     process.stderr.write(data)\n     stderr.push(data)\n@@ -68,7 +88,7 @@ function execAsyncWithOutput(title, command, opts) {\n           stderr: Buffer.concat(stderr),\n         })\n       }\n-      const err = new Error(\n+      const err = new ExecError(\n         `Command failed with exit code ${code}: ${prettyCommand(command)}`\n       )\n       err.code = code\n@@ -79,25 +99,21 @@ function execAsyncWithOutput(title, command, opts) {\n   })\n }\n \n-exports.execAsyncWithOutput = execAsyncWithOutput\n-\n /**\n  * @template T\n  * @param {string} title\n  * @param {() => T} fn\n  * @returns {T}\n  */\n-function execFn(title, fn) {\n+export function execFn<T>(title: string, fn: () => T): T {\n   logCommand(title, fn.toString())\n   return fn()\n }\n \n-exports.execFn = execFn\n-\n /**\n  * @param {string | string[]} command\n  */\n-function prettyCommand(command) {\n+function prettyCommand(command: string | string[]): string {\n   if (Array.isArray(command)) command = command.join(' ')\n   return command.replace(/ -- .*/, ' -- â€¦')\n }\n@@ -106,7 +122,7 @@ function prettyCommand(command) {\n  * @param {string} title\n  * @param {string | string[]} [command]\n  */\n-function logCommand(title, command) {\n+export function logCommand(title: string, command: string | string[]) {\n   if (command) {\n     const pretty = prettyCommand(command)\n     console.log(`\\n\\x1b[1;4m${title}\\x1b[0m\\n> \\x1b[1m${pretty}\\x1b[0m\\n`)\n@@ -115,46 +131,17 @@ function logCommand(title, command) {\n   }\n }\n \n-exports.logCommand = logCommand\n-\n-/**\n- * @param {string[]} args\n- * @param {string} name\n- * @returns {boolean}\n- */\n-function booleanArg(args, name) {\n-  const index = args.indexOf(name)\n-  if (index === -1) return false\n-  args.splice(index, 1)\n-  return true\n-}\n-\n-exports.booleanArg = booleanArg\n-\n-/**\n- * @param {string[]} args\n- * @param {string} name\n- * @returns {?string}\n- */\n-function namedValueArg(args, name) {\n-  const index = args.indexOf(name)\n-  if (index === -1) return null\n-  return args.splice(index, 2)[1]\n-}\n-\n-exports.namedValueArg = namedValueArg\n-\n const DEFAULT_GLOBS = ['**', '!target', '!node_modules', '!crates', '!.turbo']\n const FORCED_GLOBS = ['package.json', 'README*', 'LICENSE*', 'LICENCE*']\n \n /**\n  * @param {string} path\n  * @returns {Promise<string[]>}\n  */\n-async function packageFiles(path) {\n+export async function packageFiles(path: string): Promise<string[]> {\n   const { files = DEFAULT_GLOBS, main, bin } = require(`${path}/package.json`)\n \n-  const allFiles = files.concat(\n+  const allFiles: string[] = files.concat(\n     FORCED_GLOBS,\n     main ?? [],\n     Object.values(bin ?? {})\n@@ -189,5 +176,3 @@ async function packageFiles(path) {\n     return true\n   })\n }\n-\n-exports.packageFiles = packageFiles",
            "previous_filename": "scripts/pack-util.cjs"
        },
        {
            "sha": "e4133a91d7997474dcd395e06771d293212d0960",
            "filename": "scripts/pack-utils/patch-package-json.ts",
            "status": "added",
            "additions": 210,
            "deletions": 0,
            "changes": 210,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fpack-utils%2Fpatch-package-json.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fpack-utils%2Fpatch-package-json.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fpack-utils%2Fpatch-package-json.ts?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -0,0 +1,210 @@\n+import fs from 'node:fs/promises'\n+import path from 'node:path'\n+import { fileURLToPath } from 'node:url'\n+import os from 'node:os'\n+\n+export interface DependencyPaths {\n+  nextTarball: string\n+  nextMdxTarball: string\n+  nextEnvTarball: string\n+  nextBundleAnalyzerTarball: string\n+  nextSwcTarball: string\n+}\n+\n+interface NextPeerDeps {\n+  react: string\n+  reactDom: string\n+  [key: string]: unknown\n+}\n+\n+export interface PackageJson {\n+  dependencies?: Record<string, string>\n+  peerDependencies?: Record<string, string>\n+  overrides?: Record<string, string>\n+  resolutions?: Record<string, string>\n+  workspaces?: string[] | { packages: string[] }\n+  [key: string]: unknown\n+}\n+\n+/**\n+ * Main function to patch a project's package.json with Next.js tarball references\n+ * @param paths Configuration options for patching\n+ * @returns The path to the patched file\n+ */\n+export default async function patchPackageJson(\n+  targetProjectPath: string,\n+  paths: DependencyPaths\n+): Promise<string> {\n+  try {\n+    const root = await findWorkspaceRoot(targetProjectPath)\n+    const packageJsonPath = root\n+      ? path.join(root, 'package.json')\n+      : path.join(targetProjectPath, 'package.json')\n+\n+    const packageJsonValue = await readJsonValue(packageJsonPath)\n+    await patchWorkspacePackageJsonMap(paths, packageJsonValue)\n+    await writeJsonValue(packageJsonPath, packageJsonValue)\n+\n+    return packageJsonPath\n+  } catch (error) {\n+    throw new Error('Error patching package.json', { cause: error })\n+  }\n+}\n+\n+async function readJsonValue(filePath: string): Promise<PackageJson> {\n+  try {\n+    const content = await fs.readFile(filePath, 'utf8')\n+    return JSON.parse(content) as PackageJson\n+  } catch (error) {\n+    throw new Error(`Could not read or parse ${filePath}`, { cause: error })\n+  }\n+}\n+\n+async function writeJsonValue(\n+  filePath: string,\n+  value: PackageJson\n+): Promise<void> {\n+  try {\n+    const content = JSON.stringify(value, null, 2) + os.EOL\n+    await fs.writeFile(filePath, content)\n+  } catch (error) {\n+    throw new Error(`Failed to write ${filePath}`, { cause: error })\n+  }\n+}\n+\n+async function patchWorkspacePackageJsonMap(\n+  paths: DependencyPaths,\n+  packageJsonMap: PackageJson\n+): Promise<PackageJson> {\n+  const nextPeerDeps = await getNextPeerDeps()\n+\n+  const overrides: [string, string][] = [\n+    ['next', `file:${paths.nextTarball}`],\n+    ['@next/mdx', `file:${paths.nextMdxTarball}`],\n+    ['@next/env', `file:${paths.nextEnvTarball}`],\n+    ['@next/bundle-analyzer', `file:${paths.nextBundleAnalyzerTarball}`],\n+    ['@next/swc', `file:${paths.nextSwcTarball}`],\n+    ['react', nextPeerDeps.react],\n+    ['react-dom', nextPeerDeps.reactDom],\n+  ]\n+\n+  // npm uses `overrides`\n+  packageJsonMap.overrides = packageJsonMap.overrides || {}\n+  insertMapEntries(packageJsonMap.overrides, overrides)\n+\n+  // yarn uses `resolutions`\n+  packageJsonMap.resolutions = packageJsonMap.resolutions || {}\n+  insertMapEntries(packageJsonMap.resolutions, overrides)\n+\n+  // Add @next/swc to dependencies\n+  packageJsonMap.dependencies = packageJsonMap.dependencies || {}\n+  insertMapEntries(packageJsonMap.dependencies, [\n+    ['@next/swc', `file:${paths.nextSwcTarball}`],\n+  ])\n+\n+  // Update direct dependencies to match overrides\n+  updateMapEntriesIfExists(packageJsonMap.dependencies, overrides)\n+\n+  return packageJsonMap\n+}\n+\n+/**\n+ * Get Next.js peer dependencies from its package.json\n+ */\n+async function getNextPeerDeps(): Promise<NextPeerDeps> {\n+  try {\n+    // Navigate to the next package.json relative to the current module\n+    const currentFilePath = fileURLToPath(import.meta.url)\n+    const scriptDir = path.dirname(currentFilePath)\n+    const packageJsonPath = path.resolve(\n+      scriptDir,\n+      '../../packages/next/package.json'\n+    )\n+\n+    const content = await fs.readFile(packageJsonPath, 'utf8')\n+    const nextPackageJson = JSON.parse(content) as PackageJson\n+\n+    if (!nextPackageJson.peerDependencies) {\n+      throw new Error('Next.js package.json is missing peerDependencies')\n+    }\n+\n+    return {\n+      react: nextPackageJson.peerDependencies.react || '',\n+      reactDom: nextPackageJson.peerDependencies['react-dom'] || '',\n+    }\n+  } catch (error) {\n+    throw new Error('Failed to get Next.js peer dependencies', { cause: error })\n+  }\n+}\n+\n+function insertMapEntries(\n+  map: Record<string, string>,\n+  entries: [string, string][]\n+): void {\n+  for (const [key, value] of entries) {\n+    map[key] = value\n+  }\n+}\n+\n+function updateMapEntriesIfExists(\n+  map: Record<string, string>,\n+  entries: [string, string][]\n+): void {\n+  for (const [key, value] of entries) {\n+    if (map[key] !== undefined) {\n+      map[key] = value\n+    }\n+  }\n+}\n+\n+async function fileExists(filePath: string): Promise<boolean> {\n+  try {\n+    await fs.access(filePath)\n+    return true\n+  } catch {\n+    return false\n+  }\n+}\n+\n+/**\n+ * @returns null if not in a workspace\n+ */\n+async function findWorkspaceRoot(projectPath: string): Promise<string | null> {\n+  // Check environment variables\n+  const envVars = ['NPM_CONFIG_WORKSPACE_DIR', 'npm_config_workspace_dir']\n+  for (const ev of envVars) {\n+    if (process.env[ev]) {\n+      return process.env[ev]\n+    }\n+  }\n+\n+  try {\n+    const canonicalPath = await fs.realpath(projectPath)\n+    let currentDir = canonicalPath\n+\n+    // Walk up the directory tree\n+    while (currentDir !== path.parse(currentDir).root) {\n+      // Check for pnpm workspace\n+      if (await fileExists(path.join(currentDir, 'pnpm-workspace.yaml'))) {\n+        return currentDir\n+      }\n+\n+      // Check for npm/yarn workspace\n+      const packageJsonPath = path.join(currentDir, 'package.json')\n+      if (await fileExists(packageJsonPath)) {\n+        const packageJson = await readJsonValue(packageJsonPath)\n+        if (packageJson.workspaces) {\n+          return currentDir\n+        }\n+      }\n+\n+      // Move up to parent directory\n+      currentDir = path.dirname(currentDir)\n+    }\n+\n+    // No workspace found\n+    return null\n+  } catch (error) {\n+    throw new Error('Failed to find workspace root', { cause: error })\n+  }\n+}"
        },
        {
            "sha": "2403ecc9bb567d87c96cdf43bac9a231c5ad9f1a",
            "filename": "scripts/sweep.cjs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fsweep.cjs",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Fsweep.cjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Fsweep.cjs?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -1,8 +1,8 @@\n-#!/usr/bin/env node\n+// This script must be run with tsx\n \n const { existsSync, rmSync, readdirSync } = require('fs')\n const { join } = require('path')\n-const { NEXT_DIR, exec, logCommand } = require('./pack-util.cjs')\n+const { NEXT_DIR, exec, logCommand } = require('./pack-util')\n \n const sweepInstalled = existsSync(`${process.env.CARGO_HOME}/bin/cargo-sweep`)\n const cacheInstalled = existsSync(`${process.env.CARGO_HOME}/bin/cargo-cache`)"
        },
        {
            "sha": "1a247cfbc51b91b3e31347bbdeded077065ccbc2",
            "filename": "scripts/unpack-next.cjs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Funpack-next.cjs",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/scripts%2Funpack-next.cjs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/scripts%2Funpack-next.cjs?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -1,6 +1,6 @@\n-#!/usr/bin/env node\n+// This script must be run with tsx\n \n-const { NEXT_DIR, exec } = require('./pack-util.cjs')\n+const { NEXT_DIR, exec } = require('./pack-util')\n const fs = require('fs')\n const path = require('path')\n "
        },
        {
            "sha": "1d7b4faafae47a7ab3ac5649e86b79a478328b65",
            "filename": "turbopack/xtask/src/main.rs",
            "status": "modified",
            "additions": 1,
            "deletions": 7,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/a6375148dc698fe302d34190d8fbd812f3013b9d/turbopack%2Fxtask%2Fsrc%2Fmain.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/a6375148dc698fe302d34190d8fbd812f3013b9d/turbopack%2Fxtask%2Fsrc%2Fmain.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fxtask%2Fsrc%2Fmain.rs?ref=a6375148dc698fe302d34190d8fbd812f3013b9d",
            "patch": "@@ -5,17 +5,15 @@ use std::{\n };\n \n use anyhow::Result;\n-use clap::{arg, Command, CommandFactory, FromArgMatches};\n+use clap::{arg, Command};\n \n mod command;\n mod nft_bench;\n-mod patch_package_json;\n mod publish;\n mod summarize_bench;\n mod visualize_bundler_bench;\n \n use nft_bench::show_result;\n-use patch_package_json::PatchPackageJsonArgs;\n use publish::{publish_workspace, run_bump, run_publish};\n use rustc_hash::{FxHashMap, FxHashSet};\n \n@@ -74,7 +72,6 @@ Visualizations generated by this command will appear in a sibling directory to t\n                 .arg(arg!(<PATH_TO_SUMMARY_JSON> \"the path to the benchmark summary json file\"))\n                 .arg(arg!(--bundlers <BUNDLERS> \"comma separated list of bundlers to include in the visualization\")),\n         )\n-        .subcommand(PatchPackageJsonArgs::command())\n }\n \n fn main() -> Result<()> {\n@@ -184,9 +181,6 @@ fn main() -> Result<()> {\n             let path = path.canonicalize().unwrap();\n             visualize_bundler_bench::generate(path, bundlers)\n         }\n-        Some((\"patch-package-json\", sub_matches)) => {\n-            patch_package_json::run(&PatchPackageJsonArgs::from_arg_matches(sub_matches)?)\n-        }\n         _ => {\n             anyhow::bail!(\"Unknown command {:?}\", matches.subcommand().map(|c| c.0));\n         }"
        },
        {
            "sha": "0ed910e111316a38108e6026b0c90fa285bc6f3b",
            "filename": "turbopack/xtask/src/patch_package_json.rs",
            "status": "removed",
            "additions": 0,
            "deletions": 231,
            "changes": 231,
            "blob_url": "https://github.com/vercel/next.js/blob/7dab09943cea549382c63bf3cc19307a8b448dd3/turbopack%2Fxtask%2Fsrc%2Fpatch_package_json.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/7dab09943cea549382c63bf3cc19307a8b448dd3/turbopack%2Fxtask%2Fsrc%2Fpatch_package_json.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fxtask%2Fsrc%2Fpatch_package_json.rs?ref=7dab09943cea549382c63bf3cc19307a8b448dd3",
            "patch": "@@ -1,231 +0,0 @@\n-use std::{\n-    fs::File,\n-    io::{self, BufReader, BufWriter, Write},\n-    path::{Path, PathBuf},\n-};\n-\n-use anyhow::{Context, Result};\n-use clap::Parser;\n-use serde::Deserialize;\n-use serde_json::Value;\n-\n-type JsonMap = serde_json::Map<String, Value>;\n-\n-/// Modifies a target project's package.json to point to the next.js tarballs previously built from\n-/// this next.js repository with `pnpm pack-next`.\n-#[derive(Parser)]\n-#[command(name = \"patch-package-json\")]\n-pub struct PatchPackageJsonArgs {\n-    target_project_path: PathBuf,\n-\n-    #[arg(long, value_name = \"FILE\")]\n-    next_tarball: String,\n-\n-    #[arg(long, value_name = \"FILE\")]\n-    next_mdx_tarball: String,\n-    #[arg(long, value_name = \"FILE\")]\n-    next_env_tarball: String,\n-    #[arg(long, value_name = \"FILE\")]\n-    next_bundle_analyzer_tarball: String,\n-    #[arg(long, value_name = \"FILE\")]\n-    next_swc_tarball: String,\n-}\n-\n-/// A subset of the `packages/next/package.json` file, used to determine what `peerDependencies` we\n-/// require for `react`.\n-#[derive(Deserialize)]\n-#[serde(rename_all = \"camelCase\")]\n-struct NextPackageJson {\n-    peer_dependencies: NextPeerDeps,\n-}\n-\n-#[derive(Deserialize)]\n-#[serde(rename_all = \"kebab-case\")]\n-struct NextPeerDeps {\n-    react: String,\n-    react_dom: String,\n-}\n-\n-pub fn run(args: &PatchPackageJsonArgs) -> Result<()> {\n-    let package_json_path = find_workspace_root(&args.target_project_path)?\n-        .map(|root| root.join(\"package.json\"))\n-        .inspect(|json_path| println!(\"Found workspace! Patching {json_path:?} with overrides.\"))\n-        // if we're not in a workspace, apply the changes we would've made to the workspace root to\n-        // the project's package.json file\n-        .unwrap_or_else(|| args.target_project_path.join(\"package.json\"));\n-\n-    let mut package_json_value = read_json_value(&package_json_path)?;\n-    let package_json_map = to_package_json_map(&mut package_json_value)?;\n-    patch_workspace_package_json_map(args, package_json_map)?;\n-    write_json_value(&package_json_path, &package_json_value)?;\n-\n-    println!(\"Successfully patched {package_json_path:?} to use local tarball files!\");\n-    // TODO: Bun is currently broken for unknown reasons, it generates ENOTDIR when trying to read\n-    // the tarballs\n-    // NOTE: Yarn is currently broken due to an upstream issue:\n-    // https://github.com/yarnpkg/yarn/issues/6339\n-    println!(\"Run `pnpm i` or `npm i` to install the overrides\");\n-\n-    Ok(())\n-}\n-\n-fn read_json_value(path: &Path) -> Result<Value> {\n-    serde_json::from_reader(BufReader::new(\n-        File::open(path).with_context(|| format!(\"could not read {path:?}\"))?,\n-    ))\n-    .with_context(|| format!(\"failed to parse {path:?}\"))\n-}\n-\n-fn write_json_value(path: &Path, value: &Value) -> Result<()> {\n-    (|| {\n-        let file = File::options().write(true).truncate(true).open(path)?;\n-        let mut writer = BufWriter::new(file);\n-\n-        // NOTE: serde_json defaults to two-space indents\n-        serde_json::to_writer_pretty(&mut writer, value)?;\n-        writer.write_all(b\"\\n\")?;\n-        writer.flush()?;\n-        anyhow::Ok(())\n-    })()\n-    .with_context(|| format!(\"failed to write {path:?}\"))\n-}\n-\n-fn to_package_json_map(value: &mut Value) -> Result<&mut JsonMap> {\n-    value\n-        .as_object_mut()\n-        .context(\"package.json must represent an object\")\n-}\n-\n-fn patch_workspace_package_json_map(\n-    args: &PatchPackageJsonArgs,\n-    package_json_map: &mut JsonMap,\n-) -> Result<()> {\n-    let next_peer_deps = get_next_peer_deps()?;\n-\n-    // insert overrides\n-    let overrides = [\n-        (\"next\", &*format!(\"file:{}\", args.next_tarball)),\n-        (\"@next/mdx\", &*format!(\"file:{}\", args.next_mdx_tarball)),\n-        (\"@next/env\", &*format!(\"file:{}\", args.next_env_tarball)),\n-        (\n-            \"@next/bundle-analyzer\",\n-            &*format!(\"file:{}\", args.next_bundle_analyzer_tarball),\n-        ),\n-        // next-swc is added to the project's package.json, but also set a global override just in\n-        // case something else pulls it in\n-        (\"@next/swc\", &*format!(\"file:{}\", args.next_swc_tarball)),\n-        // next's peerDependencies\n-        (\"react\", &*next_peer_deps.react),\n-        (\"react-dom\", &*next_peer_deps.react_dom),\n-    ];\n-\n-    // npm uses `overrides`: https://docs.npmjs.com/cli/v10/configuring-npm/package-json#overrides\n-    // bun also supports this: https://bun.sh/docs/install/overrides\n-    let overrides_map = get_mut_or_insert_default_object(package_json_map, \"overrides\")?;\n-    insert_map_entries(overrides_map, &overrides[..]);\n-\n-    // yarn uses `resolutions`: https://yarnpkg.com/configuration/manifest#resolutions\n-    // pnpm also supports this: https://pnpm.io/package_json#resolutions\n-    let resolutions_map = get_mut_or_insert_default_object(package_json_map, \"resolutions\")?;\n-    insert_map_entries(resolutions_map, &overrides[..]);\n-\n-    // add `@next/swc` to `dependencies`, without this next might fall back to downloading the\n-    // binary blob from the release version, which isn't what we want.\n-    let deps_map = get_mut_or_insert_default_object(package_json_map, \"dependencies\")?;\n-    insert_map_entries(\n-        deps_map,\n-        &[(\"@next/swc\", &*format!(\"file:{}\", args.next_swc_tarball))],\n-    );\n-\n-    // npm requires that any direct dependencies in the workspace file match the version specified\n-    // in the overrides:\n-    //\n-    // > You may not set an override for a package that you directly depend on unless both the\n-    // > dependency and the override itself share the exact same spec.\n-    update_map_entries_if_exists(deps_map, &overrides[..]);\n-\n-    Ok(())\n-}\n-\n-fn get_next_peer_deps() -> Result<NextPeerDeps> {\n-    let package_json_path = Path::new(file!())\n-        .parent()\n-        .and_then(Path::parent)\n-        .and_then(Path::parent)\n-        .and_then(Path::parent)\n-        .with_context(|| format!(\"{} does not have enough ancestors?\", file!()))?\n-        .join(\"packages\")\n-        .join(\"next\")\n-        .join(\"package.json\");\n-    Ok(\n-        serde_json::from_reader::<_, NextPackageJson>(BufReader::new(File::open(\n-            package_json_path,\n-        )?))?\n-        .peer_dependencies,\n-    )\n-}\n-\n-fn insert_map_entries(map: &mut JsonMap, entries: &[(&str, &str)]) {\n-    for &(key, value) in entries {\n-        map.insert(key.to_owned(), Value::String(value.to_owned()));\n-    }\n-}\n-\n-fn update_map_entries_if_exists(map: &mut JsonMap, entries: &[(&str, &str)]) {\n-    for &(key, value) in entries {\n-        if let Some(old_value) = map.get_mut(key) {\n-            *old_value = Value::String(value.to_owned());\n-        }\n-    }\n-}\n-\n-fn get_mut_or_insert_default_object<'a>(\n-    map: &'a mut JsonMap,\n-    key: &str,\n-) -> Result<&'a mut JsonMap> {\n-    map.entry(key)\n-        .or_insert_with(|| Value::Object(Default::default()))\n-        .as_object_mut()\n-        .with_context(|| format!(\"failed to read package.json object with key {key}\"))\n-}\n-\n-/// pnpm and npm (and probably bun+yarn too) require that overrides are set in the root package.json\n-/// of the workspace.\n-///\n-/// Different package managers have slightly different logic. We'll return the first workspace root\n-/// we find that's valid for any package manager.\n-///\n-/// Returns `None` if we're not in a workspace.\n-///\n-/// Here's how pnpm does it:\n-/// <https://github.com/pnpm/pnpm/blob/757e6be29d1916fd0c/workspace/find-workspace-dir/src/index.ts>\n-fn find_workspace_root(project_path: &Path) -> Result<Option<PathBuf>> {\n-    const ENV_VAR: &str = \"NPM_CONFIG_WORKSPACE_DIR\";\n-    for ev in [ENV_VAR, &ENV_VAR.to_ascii_lowercase()] {\n-        if let Some(root) = std::env::var_os(ev) {\n-            return Ok(Some(root.into()));\n-        }\n-    }\n-\n-    for ancestor in project_path.canonicalize()?.ancestors() {\n-        if ancestor.join(\"pnpm-workspace.yaml\").exists() {\n-            return Ok(Some(ancestor.to_owned()));\n-        }\n-        let package_json_path = ancestor.join(\"package.json\");\n-        let package_json_file = match File::open(&package_json_path) {\n-            Ok(file) => file,\n-            Err(err) if err.kind() == io::ErrorKind::NotFound => continue,\n-            Err(err) => return Err(err.into()),\n-        };\n-        let package_json_value: Value = serde_json::from_reader(BufReader::new(package_json_file))?;\n-        if package_json_value\n-            .as_object()\n-            .with_context(|| format!(\"failed to parse {package_json_path:?}\"))?\n-            .contains_key(\"workspaces\")\n-        {\n-            return Ok(Some(ancestor.to_owned()));\n-        }\n-    }\n-    // we didn't find a workspace root, we're not in a workspace\n-    Ok(None)\n-}"
        }
    ],
    "stats": {
        "total": 1365,
        "additions": 695,
        "deletions": 670
    }
}