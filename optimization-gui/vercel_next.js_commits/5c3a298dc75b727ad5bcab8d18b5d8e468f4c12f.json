{
    "author": "huozhi",
    "message": "[not-found] Add global-not-found convention (#78783)\n\n### Feature\r\n\r\nIntroducing a new convention `global-not-found.js`, which let you build your own 404 page within app router. This convention is similar to `global-error.js` but for not found in general case, it's similar to `not-found.js` but including the layout.\r\n\r\nApp router has an implicit convention of building the 404 route, which is composing the top-level root `layout.js` and the root `not-found.js` to build up a 404 page. Since it's so implicit so that users don't have much control over it, which also lead to some confusing errors like `/_not-found` route is build failed due to various reason.\r\n\r\nThe `global-not-found.js` convention is aimed to help users to build 404 route in App Router easily and convenience. Currently it will be bound with a flag `experimental.globalNotFound` and later it will become the stable feature in next major release as it introduces a minor breaking change that we won't use root layout and root not-found to compose the 404 page. Instead, we'll either choose the builtin 404 page or users customized `global-not-found.js` to generate the 404 page when you enable the feature.\r\n\r\n#### Advantages\r\n\r\nGood new that if you were having struggles with creating 404 page for the multi root layouts app, such as the case below. Then `global-not-found.js` is your choose.\r\n\r\n```\r\n- (2024)/\r\n   /layout.js\r\n   /... # routes\r\n- (2025)/\r\n   /layout.js\r\n   /... # routes\r\n```\r\n\r\nCloses NDX-1036\r\nRelated #59180\r\n\r\n\r\n#### Follow up\r\n\r\nThe metadata and deployment will be followed up in new PRs",
    "sha": "5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
    "files": [
        {
            "sha": "af3a7314644ad63b8f37efd03f4426e1815140c4",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -194,7 +194,12 @@ impl AppProject {\n \n     #[turbo_tasks::function]\n     fn app_entrypoints(&self) -> Vc<AppEntrypoints> {\n-        get_entrypoints(*self.app_dir, self.project.next_config().page_extensions())\n+        let conf = self.project.next_config();\n+        get_entrypoints(\n+            *self.app_dir,\n+            conf.page_extensions(),\n+            conf.is_global_not_found_enabled(),\n+        )\n     }\n \n     #[turbo_tasks::function]"
        },
        {
            "sha": "38a974688a878c826f542f677ec9599ff08c89eb",
            "filename": "crates/next-core/src/app_page_loader_tree.rs",
            "status": "modified",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_page_loader_tree.rs?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -335,6 +335,7 @@ impl AppPageLoaderTreeBuilder {\n             default,\n             error,\n             global_error,\n+            global_not_found,\n             layout,\n             loading,\n             template,\n@@ -375,6 +376,8 @@ impl AppPageLoaderTreeBuilder {\n             .await?;\n         self.write_modules_entry(AppDirModuleType::GlobalError, *global_error)\n             .await?;\n+        self.write_modules_entry(AppDirModuleType::GlobalNotFound, *global_not_found)\n+            .await?;\n \n         let modules_code = replace(&mut self.loader_tree_code, temp_loader_tree_code);\n \n@@ -399,6 +402,7 @@ impl AppPageLoaderTreeBuilder {\n         let loader_tree = &*loader_tree.await?;\n \n         let modules = &loader_tree.modules;\n+        // load global-error module\n         if let Some(global_error) = modules.global_error {\n             let module = self\n                 .base\n@@ -407,6 +411,17 @@ impl AppPageLoaderTreeBuilder {\n                 .await?;\n             self.base.inner_assets.insert(GLOBAL_ERROR.into(), module);\n         };\n+        // load global-not-found module\n+        if let Some(global_not_found) = modules.global_not_found {\n+            let module = self\n+                .base\n+                .process_source(Vc::upcast(FileSource::new(*global_not_found)))\n+                .to_resolved()\n+                .await?;\n+            self.base\n+                .inner_assets\n+                .insert(GLOBAL_NOT_FOUND.into(), module);\n+        };\n \n         self.walk_tree(loader_tree, true).await?;\n         Ok(AppPageLoaderTreeModule {\n@@ -439,3 +454,4 @@ impl AppPageLoaderTreeModule {\n }\n \n pub const GLOBAL_ERROR: &str = \"GLOBAL_ERROR_MODULE\";\n+pub const GLOBAL_NOT_FOUND: &str = \"GLOBAL_NOT_FOUND_MODULE\";"
        },
        {
            "sha": "4c5dc5505262888ed5c5808a4f3d4270e585fa2f",
            "filename": "crates/next-core/src/app_structure.rs",
            "status": "modified",
            "additions": 60,
            "deletions": 11,
            "changes": 71,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fapp_structure.rs?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -39,6 +39,8 @@ pub struct AppDirModules {\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n     pub global_error: Option<ResolvedVc<FileSystemPath>>,\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n+    pub global_not_found: Option<ResolvedVc<FileSystemPath>>,\n+    #[serde(skip_serializing_if = \"Option::is_none\")]\n     pub loading: Option<ResolvedVc<FileSystemPath>>,\n     #[serde(skip_serializing_if = \"Option::is_none\")]\n     pub template: Option<ResolvedVc<FileSystemPath>>,\n@@ -63,6 +65,7 @@ impl AppDirModules {\n             layout: self.layout,\n             error: self.error,\n             global_error: self.global_error,\n+            global_not_found: self.global_not_found,\n             loading: self.loading,\n             template: self.template,\n             not_found: self.not_found,\n@@ -322,6 +325,7 @@ async fn get_directory_tree_internal(\n                             \"layout\" => modules.layout = Some(file),\n                             \"error\" => modules.error = Some(file),\n                             \"global-error\" => modules.global_error = Some(file),\n+                            \"global-not-found\" => modules.global_not_found = Some(file),\n                             \"loading\" => modules.loading = Some(file),\n                             \"template\" => modules.template = Some(file),\n                             \"forbidden\" => modules.forbidden = Some(file),\n@@ -730,11 +734,13 @@ fn add_app_metadata_route(\n pub fn get_entrypoints(\n     app_dir: Vc<FileSystemPath>,\n     page_extensions: Vc<Vec<RcStr>>,\n+    is_global_not_found_enabled: Vc<bool>,\n ) -> Vc<Entrypoints> {\n     directory_tree_to_entrypoints(\n         app_dir,\n         get_directory_tree(app_dir, page_extensions),\n         get_global_metadata(app_dir, page_extensions),\n+        is_global_not_found_enabled,\n         Default::default(),\n     )\n }\n@@ -744,11 +750,13 @@ fn directory_tree_to_entrypoints(\n     app_dir: Vc<FileSystemPath>,\n     directory_tree: Vc<DirectoryTree>,\n     global_metadata: Vc<GlobalMetadata>,\n+    is_global_not_found_enabled: Vc<bool>,\n     root_layouts: Vc<FileSystemPathVec>,\n ) -> Vc<Entrypoints> {\n     directory_tree_to_entrypoints_internal(\n         app_dir,\n         global_metadata,\n+        is_global_not_found_enabled,\n         \"\".into(),\n         directory_tree,\n         AppPage::new(),\n@@ -1124,6 +1132,7 @@ async fn default_route_tree(\n async fn directory_tree_to_entrypoints_internal(\n     app_dir: ResolvedVc<FileSystemPath>,\n     global_metadata: Vc<GlobalMetadata>,\n+    is_global_not_found_enabled: Vc<bool>,\n     directory_name: RcStr,\n     directory_tree: Vc<DirectoryTree>,\n     app_page: AppPage,\n@@ -1133,6 +1142,7 @@ async fn directory_tree_to_entrypoints_internal(\n     directory_tree_to_entrypoints_internal_untraced(\n         app_dir,\n         global_metadata,\n+        is_global_not_found_enabled,\n         directory_name,\n         directory_tree,\n         app_page,\n@@ -1145,6 +1155,7 @@ async fn directory_tree_to_entrypoints_internal(\n async fn directory_tree_to_entrypoints_internal_untraced(\n     app_dir: ResolvedVc<FileSystemPath>,\n     global_metadata: Vc<GlobalMetadata>,\n+    is_global_not_found_enabled: Vc<bool>,\n     directory_name: RcStr,\n     directory_tree: Vc<DirectoryTree>,\n     app_page: AppPage,\n@@ -1284,6 +1295,13 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n \n         // Next.js has this logic in \"collect-app-paths\", where the root not-found page\n         // is considered as its own entry point.\n+\n+        // Determine if we enable the global not-found feature.\n+        let is_global_not_found_enabled = *is_global_not_found_enabled.await?;\n+        let use_global_not_found =\n+            is_global_not_found_enabled || modules.global_not_found.is_some();\n+\n+        let not_found_root_modules = modules.without_leafs();\n         let not_found_tree = AppPageLoaderTree {\n             page: app_page.clone(),\n             segment: directory_name.clone(),\n@@ -1296,24 +1314,54 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n                             page: app_page.clone(),\n                             segment: \"__PAGE__\".into(),\n                             parallel_routes: FxIndexMap::default(),\n-                            modules: AppDirModules {\n-                                page: match modules.not_found {\n-                                    Some(v) => Some(v),\n-                                    None => Some(get_next_package(*app_dir)\n-                                        .join(\"dist/client/components/not-found-error.js\".into())\n-                                        .to_resolved()\n-                                        .await?),\n-                                },\n-                                ..Default::default()\n+                            modules: if use_global_not_found {\n+                                // if global-not-found.js is present:\n+                                // we use it for the page and no layout, since layout is included in global-not-found.js;\n+                                AppDirModules {\n+                                    layout: None,\n+                                    page: match modules.global_not_found {\n+                                        Some(v) => Some(v),\n+                                        None => Some(get_next_package(*app_dir)\n+                                            .join(\"dist/client/components/global-not-found.js\".into())\n+                                            .to_resolved()\n+                                            .await?),\n+                                    },\n+                                    ..Default::default()\n+                                }\n+                            } else {\n+                                // if global-not-found.js is not present:\n+                                // we search if we can compose root layout with the root not-found.js;\n+                                AppDirModules {\n+                                    page: match modules.not_found {\n+                                        Some(v) => Some(v),\n+                                        None => Some(get_next_package(*app_dir)\n+                                            .join(\"dist/client/components/not-found-error.js\".into())\n+                                            .to_resolved()\n+                                            .await?),\n+                                    },\n+                                    ..Default::default()\n+                                }\n                             },\n                             global_metadata: global_metadata.to_resolved().await?,\n                         }\n                     },\n-                    modules: AppDirModules::default(),\n+                    modules: AppDirModules {\n+                        ..Default::default()\n+                    },\n                     global_metadata: global_metadata.to_resolved().await?,\n                 },\n             },\n-            modules: modules.without_leafs(),\n+            modules: AppDirModules {\n+                // `global-not-found.js` does not need a layout since it's included.\n+                // Skip it if it's present.\n+                // Otherwise, we need to compose it with the root layout to compose with not-found.js boundary.\n+                layout: if use_global_not_found {\n+                    None\n+                } else {\n+                    modules.layout\n+                },\n+                ..not_found_root_modules\n+            },\n             global_metadata: global_metadata.to_resolved().await?,\n         }\n         .resolved_cell();\n@@ -1345,6 +1393,7 @@ async fn directory_tree_to_entrypoints_internal_untraced(\n             let map = directory_tree_to_entrypoints_internal(\n                 *app_dir,\n                 global_metadata,\n+                is_global_not_found_enabled,\n                 subdir_name.clone(),\n                 *subdirectory,\n                 child_app_page.clone(),"
        },
        {
            "sha": "f6ece7e1d51e656632c8f2c3d6aab851633e733f",
            "filename": "crates/next-core/src/base_loader_tree.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fbase_loader_tree.rs?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -32,6 +32,7 @@ pub enum AppDirModuleType {\n     Forbidden,\n     Unauthorized,\n     GlobalError,\n+    GlobalNotFound,\n }\n \n impl AppDirModuleType {\n@@ -47,6 +48,7 @@ impl AppDirModuleType {\n             AppDirModuleType::Forbidden => \"forbidden\",\n             AppDirModuleType::Unauthorized => \"unauthorized\",\n             AppDirModuleType::GlobalError => \"global-error\",\n+            AppDirModuleType::GlobalNotFound => \"global-not-found\",\n         }\n     }\n }"
        },
        {
            "sha": "1fca5a2a772e4db19fb49164e43197787b11f6b7",
            "filename": "crates/next-core/src/next_config.rs",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/crates%2Fnext-core%2Fsrc%2Fnext_config.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_config.rs?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -799,6 +799,8 @@ pub struct ExperimentalConfig {\n     turbopack_persistent_caching: Option<bool>,\n     turbopack_source_maps: Option<bool>,\n     turbopack_tree_shaking: Option<bool>,\n+    // Whether to enable the global-not-found convention\n+    global_not_found: Option<bool>,\n }\n \n #[derive(\n@@ -1189,6 +1191,11 @@ impl NextConfig {\n         Vc::cell(self.page_extensions.clone())\n     }\n \n+    #[turbo_tasks::function]\n+    pub fn is_global_not_found_enabled(&self) -> Vc<bool> {\n+        Vc::cell(self.experimental.global_not_found.unwrap_or_default())\n+    }\n+\n     #[turbo_tasks::function]\n     pub fn transpile_packages(&self) -> Vc<Vec<RcStr>> {\n         Vc::cell(self.transpile_packages.clone().unwrap_or_default())"
        },
        {
            "sha": "64c3cc213bf53735c4692ecdc2d899b6e98305d1",
            "filename": "packages/next/src/build/entries.ts",
            "status": "modified",
            "additions": 11,
            "deletions": 4,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fentries.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -301,11 +301,12 @@ export async function createPagesMapping({\n         page.endsWith('/page')\n       )\n       return {\n-        // If there's any app pages existed, add a default not-found page.\n-        // If there's any custom not-found page existed, it will override the default one.\n+        // If there's any app pages existed, add a default /_not-found route as 404.\n+        // If there's any custom /_not-found page, it will override the default one.\n         ...(hasAppPages && {\n-          [UNDERSCORE_NOT_FOUND_ROUTE_ENTRY]:\n-            'next/dist/client/components/not-found-error',\n+          [UNDERSCORE_NOT_FOUND_ROUTE_ENTRY]: require.resolve(\n+            'next/dist/client/components/global-not-found'\n+          ),\n         }),\n         ...pages,\n       }\n@@ -720,6 +721,9 @@ export async function createEntrypoints(\n                 : undefined,\n               preferredRegion: staticInfo.preferredRegion,\n               middlewareConfig: encodeToBase64(staticInfo.middleware || {}),\n+              isGlobalNotFoundEnabled: config.experimental.globalNotFound\n+                ? true\n+                : undefined,\n             })\n           } else if (isInstrumentation) {\n             server[serverBundlePath.replace('src/', '')] =\n@@ -799,6 +803,9 @@ export async function createEntrypoints(\n                 middlewareConfig: Buffer.from(\n                   JSON.stringify(staticInfo.middleware || {})\n                 ).toString('base64'),\n+                isGlobalNotFoundEnabled: config.experimental.globalNotFound\n+                  ? true\n+                  : undefined,\n               }).import\n             }\n             edgeServer[serverBundlePath] = getEdgeServerEntry({"
        },
        {
            "sha": "475dd6b8fd630cfe010e0d6466e85348cdd23505",
            "filename": "packages/next/src/build/utils.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Futils.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -1751,7 +1751,7 @@ export function isReservedPage(page: string) {\n }\n \n export function isAppBuiltinNotFoundPage(page: string) {\n-  return /next[\\\\/]dist[\\\\/]client[\\\\/]components[\\\\/]not-found-error/.test(\n+  return /next[\\\\/]dist[\\\\/]client[\\\\/]components[\\\\/](not-found-error|global-not-found)/.test(\n     page\n   )\n }"
        },
        {
            "sha": "dfbe103fe87b1a24a93bae7cbca1807b232410b6",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 106,
            "deletions": 26,
            "changes": 132,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -50,6 +50,7 @@ export type AppLoaderOptions = {\n   nextConfigOutput?: NextConfig['output']\n   nextConfigExperimentalUseEarlyImport?: true\n   middlewareConfig: string\n+  isGlobalNotFoundEnabled: true | undefined\n }\n type AppLoader = webpack.LoaderDefinitionFunction<AppLoaderOptions>\n \n@@ -70,15 +71,19 @@ const FILE_TYPES = {\n   error: 'error',\n   loading: 'loading',\n   'global-error': 'global-error',\n+  'global-not-found': 'global-not-found',\n   ...HTTP_ACCESS_FALLBACKS,\n } as const\n \n const GLOBAL_ERROR_FILE_TYPE = 'global-error'\n+const GLOBAL_NOT_FOUND_FILE_TYPE = 'global-not-found'\n const PAGE_SEGMENT = 'page$'\n const PARALLEL_CHILDREN_SEGMENT = 'children$'\n \n const defaultGlobalErrorPath = 'next/dist/client/components/global-error'\n+const defaultNotFoundPath = 'next/dist/client/components/not-found-error'\n const defaultLayoutPath = 'next/dist/client/components/default-layout'\n+const defaultGlobalNotFoundPath = 'next/dist/client/components/global-not-found'\n \n type DirResolver = (pathToResolve: string) => string\n type PathResolver = (\n@@ -123,6 +128,7 @@ async function createTreeCodeFromPath(\n     pageExtensions,\n     basePath,\n     collectedDeclarations,\n+    isGlobalNotFoundEnabled,\n   }: {\n     page: string\n     resolveDir: DirResolver\n@@ -135,22 +141,25 @@ async function createTreeCodeFromPath(\n     pageExtensions: PageExtensions\n     basePath: string\n     collectedDeclarations: [string, string][]\n+    isGlobalNotFoundEnabled: boolean\n   }\n ): Promise<{\n   treeCode: string\n   pages: string\n   rootLayout: string | undefined\n   globalError: string\n+  globalNotFound: string\n }> {\n   const splittedPath = pagePath.split(/[\\\\/]/, 1)\n   const isNotFoundRoute = page === UNDERSCORE_NOT_FOUND_ROUTE_ENTRY\n-\n   const isDefaultNotFound = isAppBuiltinNotFoundPage(pagePath)\n+\n   const appDirPrefix = isDefaultNotFound ? APP_DIR_ALIAS : splittedPath[0]\n   const pages: string[] = []\n \n   let rootLayout: string | undefined\n   let globalError: string | undefined\n+  let globalNotFound: string | undefined\n \n   async function resolveAdjacentParallelSegments(\n     segmentPath: string\n@@ -210,9 +219,7 @@ async function createTreeCodeFromPath(\n       null\n     const routerDirPath = `${appDirPrefix}${segmentPath}`\n     // For default not-found, don't traverse the directory to find metadata.\n-    const resolvedRouteDir = isDefaultNotFound\n-      ? ''\n-      : await resolveDir(routerDirPath)\n+    const resolvedRouteDir = isDefaultNotFound ? '' : resolveDir(routerDirPath)\n \n     if (resolvedRouteDir) {\n       metadata = await createStaticMetadataFromRoute(resolvedRouteDir, {\n@@ -294,7 +301,7 @@ async function createTreeCodeFromPath(\n         })\n       )\n \n-      const definedFilePaths = filePaths.filter(\n+      let definedFilePaths = filePaths.filter(\n         ([, filePath]) => filePath !== undefined\n       ) as [ValueOf<typeof FILE_TYPES>, string][]\n \n@@ -325,7 +332,9 @@ async function createTreeCodeFromPath(\n             !hasLayerFallbackFile\n           ) {\n             const defaultFallbackPath = defaultHTTPAccessFallbackPaths[type]\n-            definedFilePaths.push([type, defaultFallbackPath])\n+            if (!(isDefaultNotFound && type === 'not-found')) {\n+              definedFilePaths.push([type, defaultFallbackPath])\n+            }\n           }\n         }\n       }\n@@ -336,7 +345,15 @@ async function createTreeCodeFromPath(\n         )?.[1]\n         rootLayout = layoutPath\n \n-        if (isDefaultNotFound && !layoutPath && !rootLayout) {\n+        // When `global-not-found` is disabled, we insert a default layout if\n+        // root layout is presented. This logic and the default layout will be removed\n+        // once `global-not-found` is stabilized.\n+        if (\n+          !isGlobalNotFoundEnabled &&\n+          isDefaultNotFound &&\n+          !layoutPath &&\n+          !rootLayout\n+        ) {\n           rootLayout = defaultLayoutPath\n           definedFilePaths.push(['layout', rootLayout])\n         }\n@@ -350,6 +367,16 @@ async function createTreeCodeFromPath(\n           globalError = resolvedGlobalErrorPath\n         }\n       }\n+      // TODO(global-not-found): remove this flag assertion condition\n+      //  once global-not-found is stable\n+      if (isGlobalNotFoundEnabled && !globalNotFound) {\n+        const resolvedGlobalNotFoundPath = await resolver(\n+          `${appDirPrefix}/${GLOBAL_NOT_FOUND_FILE_TYPE}`\n+        )\n+        if (resolvedGlobalNotFoundPath) {\n+          globalNotFound = resolvedGlobalNotFoundPath\n+        }\n+      }\n \n       let parallelSegmentKey = Array.isArray(parallelSegment)\n         ? parallelSegment[0]\n@@ -368,23 +395,57 @@ async function createTreeCodeFromPath(\n       const normalizedParallelKey = normalizeParallelKey(parallelKey)\n       let subtreeCode\n       // If it's root not found page, set not-found boundary as children page\n-      if (isNotFoundRoute && normalizedParallelKey === 'children') {\n-        const notFoundPath =\n-          definedFilePaths.find(([type]) => type === 'not-found')?.[1] ??\n-          defaultHTTPAccessFallbackPaths['not-found']\n-\n-        const varName = `notFound${nestedCollectedDeclarations.length}`\n-        nestedCollectedDeclarations.push([varName, notFoundPath])\n-        subtreeCode = `{\n-          children: [${JSON.stringify(UNDERSCORE_NOT_FOUND_ROUTE)}, {\n-            children: ['${PAGE_SEGMENT_KEY}', {}, {\n-              page: [\n-                ${varName},\n-                ${JSON.stringify(notFoundPath)}\n-              ]\n-            }]\n-          }, {}]\n-        }`\n+      if (isNotFoundRoute) {\n+        if (normalizedParallelKey === 'children') {\n+          const matchedGlobalNotFound = isGlobalNotFoundEnabled\n+            ? definedFilePaths.find(\n+                ([type]) => type === GLOBAL_NOT_FOUND_FILE_TYPE\n+              )?.[1] ?? defaultGlobalNotFoundPath\n+            : undefined\n+\n+          // If custom global-not-found.js is defined, use global-not-found.js\n+          if (matchedGlobalNotFound) {\n+            const varName = `notFound${nestedCollectedDeclarations.length}`\n+            nestedCollectedDeclarations.push([varName, matchedGlobalNotFound])\n+            subtreeCode = `{\n+              children: [${JSON.stringify(UNDERSCORE_NOT_FOUND_ROUTE)}, {\n+                children: ['${PAGE_SEGMENT_KEY}', {}, {\n+                  page: [\n+                    ${varName},\n+                    ${JSON.stringify(matchedGlobalNotFound)}\n+                  ]\n+                }]\n+              }, {}]\n+            }`\n+          } else {\n+            // If custom not-found.js is found, use it and layout to compose the page,\n+            // and fallback to built-in not-found component if doesn't exist.\n+            const notFoundPath =\n+              definedFilePaths.find(([type]) => type === 'not-found')?.[1] ??\n+              defaultNotFoundPath\n+            const varName = `notFound${nestedCollectedDeclarations.length}`\n+            nestedCollectedDeclarations.push([varName, notFoundPath])\n+            subtreeCode = `{\n+              children: [${JSON.stringify(UNDERSCORE_NOT_FOUND_ROUTE)}, {\n+                children: ['${PAGE_SEGMENT_KEY}', {}, {\n+                  page: [\n+                    ${varName},\n+                    ${JSON.stringify(notFoundPath)}\n+                  ]\n+                }]\n+              }, {}]\n+            }`\n+          }\n+        }\n+      }\n+\n+      // For 404 route\n+      // if global-not-found is in definedFilePaths, remove root layout for /_not-found\n+      // TODO: remove this once global-not-found is stable.\n+      if (isNotFoundRoute && isGlobalNotFoundEnabled) {\n+        definedFilePaths = definedFilePaths.filter(\n+          ([type]) => type !== 'layout'\n+        )\n       }\n \n       const modulesCode = `{\n@@ -461,6 +522,7 @@ async function createTreeCodeFromPath(\n     pages: `${JSON.stringify(pages)};`,\n     rootLayout,\n     globalError: globalError ?? defaultGlobalErrorPath,\n+    globalNotFound: globalNotFound ?? defaultNotFoundPath,\n   }\n }\n \n@@ -495,6 +557,14 @@ const nextAppLoader: AppLoader = async function nextAppLoader() {\n     nextConfigExperimentalUseEarlyImport,\n   } = loaderOptions\n \n+  const isGlobalNotFoundEnabled = !!loaderOptions.isGlobalNotFoundEnabled\n+\n+  // Update FILE_TYPES on the very top-level of the loader\n+  if (!isGlobalNotFoundEnabled) {\n+    // @ts-expect-error this delete is only necessary while experimental\n+    delete FILE_TYPES['global-not-found']\n+  }\n+\n   const buildInfo = getModuleBuildInfo((this as any)._module)\n   const collectedDeclarations: [string, string][] = []\n   const page = name.replace(/^app/, '')\n@@ -509,7 +579,10 @@ const nextAppLoader: AppLoader = async function nextAppLoader() {\n     relatedModules: [],\n   }\n \n-  const extensions = pageExtensions.map((extension) => `.${extension}`)\n+  const extensions =\n+    typeof pageExtensions === 'string'\n+      ? [pageExtensions]\n+      : pageExtensions.map((extension) => `.${extension}`)\n \n   const normalizedAppPaths =\n     typeof appPaths === 'string' ? [appPaths] : appPaths || []\n@@ -687,9 +760,15 @@ const nextAppLoader: AppLoader = async function nextAppLoader() {\n     pageExtensions,\n     basePath,\n     collectedDeclarations,\n+    isGlobalNotFoundEnabled,\n   })\n \n-  if (!treeCodeResult.rootLayout) {\n+  const isGlobalNotFoundPath =\n+    page === UNDERSCORE_NOT_FOUND_ROUTE_ENTRY &&\n+    !!treeCodeResult.globalNotFound &&\n+    isGlobalNotFoundEnabled\n+\n+  if (!treeCodeResult.rootLayout && !isGlobalNotFoundPath) {\n     if (!isDev) {\n       // If we're building and missing a root layout, exit the build\n       Log.error(\n@@ -736,6 +815,7 @@ const nextAppLoader: AppLoader = async function nextAppLoader() {\n         pageExtensions,\n         basePath,\n         collectedDeclarations,\n+        isGlobalNotFoundEnabled,\n       })\n     }\n   }"
        },
        {
            "sha": "6d48186a73523f8292c486577f9ccb76dd6d76d1",
            "filename": "packages/next/src/build/webpack/plugins/flight-client-entry-plugin.ts",
            "status": "modified",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Fplugins%2Fflight-client-entry-plugin.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -400,6 +400,20 @@ export class FlightClientEntryPlugin {\n             absolutePagePath: entryRequest,\n           })\n         }\n+\n+        if (\n+          name === `app${UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}` &&\n+          bundlePath === 'app/global-not-found'\n+        ) {\n+          clientEntriesToInject.push({\n+            compiler,\n+            compilation,\n+            entryName: name,\n+            clientComponentImports,\n+            bundlePath: `app${UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`,\n+            absolutePagePath: entryRequest,\n+          })\n+        }\n       }\n \n       // Make sure CSS imports are deduplicated before injecting the client entry"
        },
        {
            "sha": "1d903ed6d6df3f0e9836d491bdb59c641814bfdb",
            "filename": "packages/next/src/client/components/global-not-found.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fglobal-not-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fglobal-not-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fglobal-not-found.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,16 @@\n+import { HTTPAccessErrorFallback } from './http-access-fallback/error-fallback'\n+\n+function GlobalNotFound() {\n+  return (\n+    <html>\n+      <body>\n+        <HTTPAccessErrorFallback\n+          status={404}\n+          message={'This page could not be found.'}\n+        />\n+      </body>\n+    </html>\n+  )\n+}\n+\n+export default GlobalNotFound"
        },
        {
            "sha": "ca1805de03d8f46c4b1fcb416664791dfac71646",
            "filename": "packages/next/src/client/components/http-access-fallback/error-fallback.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 36,
            "changes": 37,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhttp-access-fallback%2Ferror-fallback.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhttp-access-fallback%2Ferror-fallback.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fhttp-access-fallback%2Ferror-fallback.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -1,39 +1,4 @@\n-import React from 'react'\n-\n-const styles: Record<string, React.CSSProperties> = {\n-  error: {\n-    // https://github.com/sindresorhus/modern-normalize/blob/main/modern-normalize.css#L38-L52\n-    fontFamily:\n-      'system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"',\n-    height: '100vh',\n-    textAlign: 'center',\n-    display: 'flex',\n-    flexDirection: 'column',\n-    alignItems: 'center',\n-    justifyContent: 'center',\n-  },\n-\n-  desc: {\n-    display: 'inline-block',\n-  },\n-\n-  h1: {\n-    display: 'inline-block',\n-    margin: '0 20px 0 0',\n-    padding: '0 23px 0 0',\n-    fontSize: 24,\n-    fontWeight: 500,\n-    verticalAlign: 'top',\n-    lineHeight: '49px',\n-  },\n-\n-  h2: {\n-    fontSize: 14,\n-    fontWeight: 400,\n-    lineHeight: '49px',\n-    margin: 0,\n-  },\n-}\n+import { styles } from '../styles/access-error-styles'\n \n export function HTTPAccessErrorFallback({\n   status,"
        },
        {
            "sha": "6c0e52c633d82a5faa70a26ad48c87fe9e5dc3bf",
            "filename": "packages/next/src/client/components/styles/access-error-styles.ts",
            "status": "added",
            "additions": 34,
            "deletions": 0,
            "changes": 34,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fstyles%2Faccess-error-styles.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fstyles%2Faccess-error-styles.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fcomponents%2Fstyles%2Faccess-error-styles.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,34 @@\n+export const styles: Record<string, React.CSSProperties> = {\n+  error: {\n+    // https://github.com/sindresorhus/modern-normalize/blob/main/modern-normalize.css#L38-L52\n+    fontFamily:\n+      'system-ui,\"Segoe UI\",Roboto,Helvetica,Arial,sans-serif,\"Apple Color Emoji\",\"Segoe UI Emoji\"',\n+    height: '100vh',\n+    textAlign: 'center',\n+    display: 'flex',\n+    flexDirection: 'column',\n+    alignItems: 'center',\n+    justifyContent: 'center',\n+  },\n+\n+  desc: {\n+    display: 'inline-block',\n+  },\n+\n+  h1: {\n+    display: 'inline-block',\n+    margin: '0 20px 0 0',\n+    padding: '0 23px 0 0',\n+    fontSize: 24,\n+    fontWeight: 500,\n+    verticalAlign: 'top',\n+    lineHeight: '49px',\n+  },\n+\n+  h2: {\n+    fontSize: 14,\n+    fontWeight: 400,\n+    lineHeight: '49px',\n+    margin: 0,\n+  },\n+}"
        },
        {
            "sha": "e9b49811d7b2eeacdab721c7ff9bc34de382f5c3",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 4,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -325,20 +325,21 @@ function parseRequestHeaders(\n }\n \n function createNotFoundLoaderTree(loaderTree: LoaderTree): LoaderTree {\n-  // Align the segment with parallel-route-default in next-app-loader\n   const components = loaderTree[2]\n+  const hasGlobalNotFound = !!components['global-not-found']\n   return [\n     '',\n     {\n       children: [\n         PAGE_SEGMENT_KEY,\n         {},\n         {\n-          page: components['not-found'],\n+          page: components['global-not-found'] ?? components['not-found'],\n         },\n       ],\n     },\n-    components,\n+    // When global-not-found is present, skip layout from components\n+    hasGlobalNotFound ? components : {},\n   ]\n }\n \n@@ -1282,7 +1283,6 @@ async function renderToHTMLOrFlightImpl(\n \n   // Pull out the hooks/references from the component.\n   const { tree: loaderTree, taintObjectReference } = ComponentMod\n-\n   if (enableTainting) {\n     taintObjectReference(\n       'Do not pass process.env to Client Components since it will leak sensitive data',"
        },
        {
            "sha": "ab492a9e5cebd6fb9cd9c3c7585c2094e6197a8c",
            "filename": "packages/next/src/server/config-schema.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-schema.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -493,6 +493,7 @@ export const configSchema: zod.ZodType<NextConfig> = z.lazy(() =>\n             buildTimeThresholdMs: z.number().int(),\n           })\n           .optional(),\n+        globalNotFound: z.boolean().optional(),\n       })\n       .optional(),\n     exportPathMap: z"
        },
        {
            "sha": "7293723741513d9e661a7d6c1d71b3f6fa123369",
            "filename": "packages/next/src/server/config-shared.ts",
            "status": "modified",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fconfig-shared.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -671,6 +671,12 @@ export interface ExperimentalConfig {\n    * Note: Use with caution as this can negatively impact page loading performance.\n    */\n   clientInstrumentationHook?: boolean\n+\n+  /**\n+   * Enables using the global-not-found.js file in the app directory\n+   *\n+   */\n+  globalNotFound?: boolean\n }\n \n export type ExportPathMap = {\n@@ -1366,6 +1372,7 @@ export const defaultConfig: NextConfig = {\n     inlineCss: false,\n     useCache: undefined,\n     slowModuleDetection: undefined,\n+    globalNotFound: false,\n   },\n   htmlLimitedBots: undefined,\n   bundlePagesRouterDependencies: false,"
        },
        {
            "sha": "8f89197850a66ca6f53455ca23763164052fe879",
            "filename": "packages/next/src/server/dev/hot-reloader-turbopack.ts",
            "status": "modified",
            "additions": 2,
            "deletions": 1,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-turbopack.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -979,7 +979,8 @@ export async function createHotReloaderTurbopack(\n               inputPage,\n               nextConfig.pageExtensions,\n               opts.pagesDir,\n-              opts.appDir\n+              opts.appDir,\n+              !!nextConfig.experimental.globalNotFound\n             ))\n \n           // If the route is actually an app page route, then we should have access"
        },
        {
            "sha": "abd4dcaa9a1615d436191fe9ada683b0696f7ffe",
            "filename": "packages/next/src/server/dev/hot-reloader-webpack.ts",
            "status": "modified",
            "additions": 22,
            "deletions": 8,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fhot-reloader-webpack.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -12,7 +12,7 @@ import {\n   getSourceMapMiddleware,\n } from '../../client/components/react-dev-overlay/server/middleware-webpack'\n import { WebpackHotMiddleware } from './hot-middleware'\n-import { join, relative, isAbsolute, posix } from 'path'\n+import { join, relative, isAbsolute, posix, dirname } from 'path'\n import {\n   createEntrypoints,\n   createPagesMapping,\n@@ -962,6 +962,10 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n                       middlewareConfig: Buffer.from(\n                         JSON.stringify(staticInfo?.middleware || {})\n                       ).toString('base64'),\n+                      isGlobalNotFoundEnabled: this.config.experimental\n+                        .globalNotFound\n+                        ? true\n+                        : undefined,\n                     }).import\n                   : undefined\n \n@@ -1052,17 +1056,23 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n                     preferredRegion: staticInfo?.preferredRegion,\n                   })\n                 } else if (isAppPath) {\n+                  // This path normalization is critical for webpack to resolve the next internals as entry.\n+                  const pagePath = entryData.absolutePagePath.startsWith(\n+                    dirname(require.resolve('next/package.json'))\n+                  )\n+                    ? entryData.absolutePagePath\n+                    : posix.join(\n+                        APP_DIR_ALIAS,\n+                        relative(\n+                          this.appDir!,\n+                          entryData.absolutePagePath\n+                        ).replace(/\\\\/g, '/')\n+                      )\n                   value = getAppEntry({\n                     name: bundlePath,\n                     page,\n                     appPaths: entryData.appPaths,\n-                    pagePath: posix.join(\n-                      APP_DIR_ALIAS,\n-                      relative(\n-                        this.appDir!,\n-                        entryData.absolutePagePath\n-                      ).replace(/\\\\/g, '/')\n-                    ),\n+                    pagePath,\n                     appDir: this.appDir!,\n                     pageExtensions: this.config.pageExtensions,\n                     rootDir: this.dir,\n@@ -1075,6 +1085,10 @@ export default class HotReloaderWebpack implements NextJsHotReloaderInterface {\n                     middlewareConfig: Buffer.from(\n                       JSON.stringify(staticInfo?.middleware || {})\n                     ).toString('base64'),\n+                    isGlobalNotFoundEnabled: this.config.experimental\n+                      .globalNotFound\n+                      ? true\n+                      : undefined,\n                   })\n                 } else if (isAPIRoute(page)) {\n                   value = getRouteLoaderEntry({"
        },
        {
            "sha": "5f6f26c59b3eca2f1a8cc8549f8cfe95fd648157",
            "filename": "packages/next/src/server/dev/on-demand-entry-handler.ts",
            "status": "modified",
            "additions": 37,
            "deletions": 15,
            "changes": 52,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fon-demand-entry-handler.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -393,8 +393,9 @@ export async function findPagePathData(\n   rootDir: string,\n   page: string,\n   extensions: string[],\n-  pagesDir?: string,\n-  appDir?: string\n+  pagesDir: string | undefined,\n+  appDir: string | undefined,\n+  isGlobalNotFoundEnabled: boolean\n ): Promise<PagePathData> {\n   const normalizedPagePath = tryToNormalizePagePath(page)\n   let pagePath: string | null = null\n@@ -436,23 +437,43 @@ export async function findPagePathData(\n   // Check appDir first falling back to pagesDir\n   if (appDir) {\n     if (page === UNDERSCORE_NOT_FOUND_ROUTE_ENTRY) {\n-      const notFoundPath = await findPageFile(\n-        appDir,\n-        'not-found',\n-        extensions,\n-        true\n-      )\n-      if (notFoundPath) {\n-        return {\n-          filename: join(appDir, notFoundPath),\n-          bundlePath: `app${UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`,\n-          page: UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+      // Load `global-not-found` when global-not-found is enabled.\n+      // Prefer to load it when both `global-not-found` and root `not-found` present.\n+      if (isGlobalNotFoundEnabled) {\n+        const globalNotFoundPath = await findPageFile(\n+          appDir,\n+          'global-not-found',\n+          extensions,\n+          true\n+        )\n+        if (globalNotFoundPath) {\n+          return {\n+            filename: join(appDir, globalNotFoundPath),\n+            bundlePath: `app${UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`,\n+            page: UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+          }\n+        }\n+      } else {\n+        // Then if global-not-found.js doesn't exist then load not-found.js\n+        const notFoundPath = await findPageFile(\n+          appDir,\n+          'not-found',\n+          extensions,\n+          true\n+        )\n+        if (notFoundPath) {\n+          return {\n+            filename: join(appDir, notFoundPath),\n+            bundlePath: `app${UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`,\n+            page: UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n+          }\n         }\n       }\n \n+      // If they're not presented, then fallback to global-not-found\n       return {\n         filename: require.resolve(\n-          'next/dist/client/components/not-found-error'\n+          'next/dist/client/components/global-not-found'\n         ),\n         bundlePath: `app${UNDERSCORE_NOT_FOUND_ROUTE_ENTRY}`,\n         page: UNDERSCORE_NOT_FOUND_ROUTE_ENTRY,\n@@ -726,7 +747,8 @@ export function onDemandEntryHandler({\n           page,\n           nextConfig.pageExtensions,\n           pagesDir,\n-          appDir\n+          appDir,\n+          !!nextConfig.experimental.globalNotFound\n         )\n       }\n "
        },
        {
            "sha": "dec7ffddcdd0340fdfd3134cfa2ec22037e8c5f5",
            "filename": "packages/next/types/$$compiled.internal.d.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Ftypes%2F%24%24compiled.internal.d.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -337,6 +337,7 @@ declare module 'react-server-dom-webpack/client.edge' {\n }\n \n declare module 'VAR_MODULE_GLOBAL_ERROR'\n+declare module 'VAR_MODULE_GLOBAL_NOT_FOUND'\n declare module 'VAR_USERLAND'\n declare module 'VAR_MODULE_DOCUMENT'\n declare module 'VAR_MODULE_APP'"
        },
        {
            "sha": "6f7be9458297a35649d5f59c5ba793fad181f36e",
            "filename": "test/e2e/app-dir/global-not-found/basic/app/call-not-found/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fcall-not-found%2Fpage.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+import { notFound } from 'next/navigation'\n+\n+export default function Page() {\n+  notFound()\n+}"
        },
        {
            "sha": "f5733496f458508970b12f5e8e0fc298e3886036",
            "filename": "test/e2e/app-dir/global-not-found/basic/app/client.tsx",
            "status": "added",
            "additions": 5,
            "deletions": 0,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fclient.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fclient.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fclient.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,5 @@\n+'use client'\n+\n+export function Client() {\n+  return <div id=\"client\">client</div>\n+}"
        },
        {
            "sha": "6ac8620dd99ddc9222a44bba612c38063187fec2",
            "filename": "test/e2e/app-dir/global-not-found/basic/app/global-not-found.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fglobal-not-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fglobal-not-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fglobal-not-found.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,13 @@\n+import { Client } from './client'\n+\n+export default function GlobalNotFound() {\n+  return (\n+    // html tag is different from actual page's layout\n+    <html data-global-not-found=\"true\">\n+      <body>\n+        <h1 id=\"global-error-title\">global-not-found</h1>\n+        <Client />\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/global-not-found/basic/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Flayout.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/global-not-found/basic/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fapp%2Fpage.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "bded218938936b98e19cac1efd53a36e6ff14d7d",
            "filename": "test/e2e/app-dir/global-not-found/basic/global-not-found-basic.test.ts",
            "status": "added",
            "additions": 44,
            "deletions": 0,
            "changes": 44,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fglobal-not-found-basic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fglobal-not-found-basic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fglobal-not-found-basic.test.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,44 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { assertNoRedbox } from 'next-test-utils'\n+\n+describe('global-not-found - basic', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should render global-not-found for 404', async () => {\n+    const browser = await next.browser('/does-not-exist')\n+    if (isNextDev) {\n+      await assertNoRedbox(browser)\n+    }\n+\n+    const errorTitle = await browser.elementByCss('#global-error-title').text()\n+    expect(errorTitle).toBe('global-not-found')\n+    const notFoundHtmlProp = await browser\n+      .elementByCss('html')\n+      .getAttribute('data-global-not-found')\n+    expect(notFoundHtmlProp).toBe('true')\n+  })\n+\n+  it('should ssr global-not-found for 404', async () => {\n+    const $ = await next.render$('/does-not-exist')\n+    const errorTitle = $('#global-error-title').text()\n+    expect(errorTitle).toBe('global-not-found')\n+    const notFoundHtmlProp = $('html').attr('data-global-not-found')\n+    expect(notFoundHtmlProp).toBe('true')\n+  })\n+\n+  it('should render not-found boundary when calling notFound() in a page', async () => {\n+    const browser = await next.browser('/call-not-found')\n+    // Still using the root layout\n+    expect(\n+      await browser.elementByCss('html').getAttribute('data-global-not-found')\n+    ).toBeNull()\n+    expect(await browser.elementByCss('html').getAttribute('lang')).toBe('en')\n+\n+    // There's no not-found boundary in the root layout, show the default not-found.js\n+    expect(await browser.elementByCss('body').text()).toBe(\n+      '404\\nThis page could not be found.'\n+    )\n+  })\n+})"
        },
        {
            "sha": "a198cf5a769a106aef77008e1dd3fc2e332aa98e",
            "filename": "test/e2e/app-dir/global-not-found/basic/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fbasic%2Fnext.config.js?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    globalNotFound: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "6f7be9458297a35649d5f59c5ba793fad181f36e",
            "filename": "test/e2e/app-dir/global-not-found/both-present/app/call-not-found/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fcall-not-found%2Fpage.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+import { notFound } from 'next/navigation'\n+\n+export default function Page() {\n+  notFound()\n+}"
        },
        {
            "sha": "69bea87e0c5b811d3b73962a4616724e4eb90c5f",
            "filename": "test/e2e/app-dir/global-not-found/both-present/app/global-not-found.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fglobal-not-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fglobal-not-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fglobal-not-found.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,10 @@\n+export default function GlobalNotFound() {\n+  return (\n+    // html tag is different from actual page's layout\n+    <html data-global-not-found=\"true\">\n+      <body>\n+        <h1 id=\"global-error-title\">global-not-found</h1>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/global-not-found/both-present/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Flayout.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ea2bfb546029e8c6fa3120d1287ca1bc2fbb6cb7",
            "filename": "test/e2e/app-dir/global-not-found/both-present/app/not-found.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fnot-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fnot-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fapp%2Fnot-found.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function NotFound() {\n+  return <div id=\"not-found-boundary\">not-found.js</div>\n+}"
        },
        {
            "sha": "035dcd193c967cc1fbf1d9646e368dfbb0976a12",
            "filename": "test/e2e/app-dir/global-not-found/both-present/both-present.test.ts",
            "status": "added",
            "additions": 31,
            "deletions": 0,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fboth-present.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fboth-present.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fboth-present.test.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,31 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('global-not-found - both-present', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should render global-not-found for 404 routes', async () => {\n+    const $ = await next.render$('/does-not-exist')\n+    expect($('html').attr('data-global-not-found')).toBe('true')\n+    expect($('#global-error-title').text()).toBe('global-not-found')\n+\n+    const browser = await next.browser('/does-not-exist')\n+    expect(await browser.elementByCss('#global-error-title').text()).toBe(\n+      'global-not-found'\n+    )\n+    expect(\n+      await browser.elementByCss('html').getAttribute('data-global-not-found')\n+    ).toBe('true')\n+  })\n+\n+  it('should render not-found boundary when calling notFound() in a page', async () => {\n+    const browser = await next.browser('/call-not-found')\n+    expect(await browser.elementByCss('#not-found-boundary').text()).toBe(\n+      'not-found.js'\n+    )\n+    expect(\n+      await browser.elementByCss('html').getAttribute('data-global-not-found')\n+    ).toBeNull()\n+  })\n+})"
        },
        {
            "sha": "a198cf5a769a106aef77008e1dd3fc2e332aa98e",
            "filename": "test/e2e/app-dir/global-not-found/both-present/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fboth-present%2Fnext.config.js?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    globalNotFound: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "a14e64fcd5e33e9399d0e823434b0ab3095d5b75",
            "filename": "test/e2e/app-dir/global-not-found/no-root-layout/app/(bar)/bar/layout.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(bar)%2Fbar%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(bar)%2Fbar%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(bar)%2Fbar%2Flayout.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,16 @@\n+export const metadata = {\n+  title: 'Next.js',\n+  description: 'Generated by Next.js',\n+}\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "51fdbbc49cc106c476a8f5c9ddfd06ba8deef920",
            "filename": "test/e2e/app-dir/global-not-found/no-root-layout/app/(bar)/bar/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(bar)%2Fbar%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(bar)%2Fbar%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(bar)%2Fbar%2Fpage.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>bar</p>\n+}"
        },
        {
            "sha": "a14e64fcd5e33e9399d0e823434b0ab3095d5b75",
            "filename": "test/e2e/app-dir/global-not-found/no-root-layout/app/(foo)/foo/layout.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(foo)%2Ffoo%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(foo)%2Ffoo%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(foo)%2Ffoo%2Flayout.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,16 @@\n+export const metadata = {\n+  title: 'Next.js',\n+  description: 'Generated by Next.js',\n+}\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "7e900dc1e8914909c41a9359161c6c9356c95bd7",
            "filename": "test/e2e/app-dir/global-not-found/no-root-layout/app/(foo)/foo/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(foo)%2Ffoo%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(foo)%2Ffoo%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2F(foo)%2Ffoo%2Fpage.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>foo</p>\n+}"
        },
        {
            "sha": "69bea87e0c5b811d3b73962a4616724e4eb90c5f",
            "filename": "test/e2e/app-dir/global-not-found/no-root-layout/app/global-not-found.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2Fglobal-not-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2Fglobal-not-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fapp%2Fglobal-not-found.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,10 @@\n+export default function GlobalNotFound() {\n+  return (\n+    // html tag is different from actual page's layout\n+    <html data-global-not-found=\"true\">\n+      <body>\n+        <h1 id=\"global-error-title\">global-not-found</h1>\n+      </body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "a198cf5a769a106aef77008e1dd3fc2e332aa98e",
            "filename": "test/e2e/app-dir/global-not-found/no-root-layout/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fnext.config.js?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    globalNotFound: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "2f86336fcbe9fc5afb54f234531ba5d9f5d6345c",
            "filename": "test/e2e/app-dir/global-not-found/no-root-layout/no-root-layout.test.ts",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fno-root-layout.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fno-root-layout.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fno-root-layout%2Fno-root-layout.test.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,30 @@\n+import { nextTestSetup } from 'e2e-utils'\n+import { assertNoRedbox } from 'next-test-utils'\n+\n+describe('global-not-found - no-root-layout', () => {\n+  const { next, isNextDev } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should render global-not-found for 404', async () => {\n+    const browser = await next.browser('/does-not-exist')\n+    if (isNextDev) {\n+      await assertNoRedbox(browser)\n+    }\n+\n+    const errorTitle = await browser.elementByCss('#global-error-title').text()\n+    expect(errorTitle).toBe('global-not-found')\n+    const notFoundHtmlProp = await browser\n+      .elementByCss('html')\n+      .getAttribute('data-global-not-found')\n+    expect(notFoundHtmlProp).toBe('true')\n+  })\n+\n+  it('should ssr global-not-found for 404', async () => {\n+    const $ = await next.render$('/does-not-exist')\n+    const errorTitle = $('#global-error-title').text()\n+    expect(errorTitle).toBe('global-not-found')\n+    const notFoundHtmlProp = $('html').attr('data-global-not-found')\n+    expect(notFoundHtmlProp).toBe('true')\n+  })\n+})"
        },
        {
            "sha": "6f7be9458297a35649d5f59c5ba793fad181f36e",
            "filename": "test/e2e/app-dir/global-not-found/not-present/app/call-not-found/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fcall-not-found%2Fpage.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+import { notFound } from 'next/navigation'\n+\n+export default function Page() {\n+  notFound()\n+}"
        },
        {
            "sha": "a14e64fcd5e33e9399d0e823434b0ab3095d5b75",
            "filename": "test/e2e/app-dir/global-not-found/not-present/app/layout.tsx",
            "status": "added",
            "additions": 16,
            "deletions": 0,
            "changes": 16,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Flayout.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,16 @@\n+export const metadata = {\n+  title: 'Next.js',\n+  description: 'Generated by Next.js',\n+}\n+\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ea2bfb546029e8c6fa3120d1287ca1bc2fbb6cb7",
            "filename": "test/e2e/app-dir/global-not-found/not-present/app/not-found.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fnot-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fnot-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fnot-found.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function NotFound() {\n+  return <div id=\"not-found-boundary\">not-found.js</div>\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/global-not-found/not-present/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fapp%2Fpage.tsx?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "a198cf5a769a106aef77008e1dd3fc2e332aa98e",
            "filename": "test/e2e/app-dir/global-not-found/not-present/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fnext.config.js?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    globalNotFound: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "0c1ce88b61f999d922963e18192ba5a26a6d0d86",
            "filename": "test/e2e/app-dir/global-not-found/not-present/not-present.test.ts",
            "status": "added",
            "additions": 24,
            "deletions": 0,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fnot-present.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fnot-present.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fnot-present%2Fnot-present.test.ts?ref=5c3a298dc75b727ad5bcab8d18b5d8e468f4c12f",
            "patch": "@@ -0,0 +1,24 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+// TODO(global-not-found): remove this test when the feature is stable\n+describe('global-not-found - not-present', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should render default 404 when global-not-found is not defined but enabled', async () => {\n+    const browser = await next.browser('/does-not-exist')\n+    const bodyText = await browser.elementByCss('body').text()\n+    expect(bodyText).toBe('404\\nThis page could not be found.')\n+  })\n+\n+  it('should render custom not-found.js boundary when global-not-found is not defined but enabled', async () => {\n+    const browser = await next.browser('/call-not-found')\n+    const bodyText = await browser.elementByCss('body').text()\n+    const htmlLang = await browser.elementByCss('html').getAttribute('lang')\n+    // Render the root layout\n+    expect(htmlLang).toBe('en')\n+    // Render the not-found.js boundary\n+    expect(bodyText).toBe('not-found.js')\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 771,
        "additions": 664,
        "deletions": 107
    }
}