{
    "author": "mischnic",
    "message": "Turbopack: fix edge function name (#82617)\n\nEdge functions with route `/` had `\"name\": \"/\"` in the `middleware-manifest.json`. When deploying to Vercel, this wouldn't work as the Vercel builder turned that into `\"name\": \"\"`.\nFor the root function, Webpack emits a name like `\"app/page\"` or `\"pages/index\"`.\nThis aligns Turbopack with Webpack\n\nI think the name itself can be pretty arbitrary. As long as the `_ENTRIES` access and the middleware manifests agree (which is covered by the regular e2e tests), and as long as it's not literally `\"/\"` which breaks on Vercel.\n\nCloses PACK-5245",
    "sha": "3c142be74c73a675c24e12e8c7e39c33162d07a0",
    "files": [
        {
            "sha": "1d7f4b0258413866ddf4d3102e071bd27023f5c1",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 5,
            "deletions": 2,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=3c142be74c73a675c24e12e8c7e39c33162d07a0",
            "patch": "@@ -34,7 +34,10 @@ use next_core::{\n     },\n     next_server_utility::{NEXT_SERVER_UTILITY_MERGE_TAG, NextServerUtilityTransition},\n     parse_segment_config_from_source,\n-    util::{NextRuntime, module_styles_rule_condition, styles_rule_condition},\n+    util::{\n+        NextRuntime, app_middleware_function_name, module_styles_rule_condition,\n+        styles_rule_condition,\n+    },\n };\n use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n@@ -1587,7 +1590,7 @@ impl AppEndpoint {\n                         files: file_paths_from_root.into_iter().collect(),\n                         wasm: wasm_paths_to_bindings(wasm_paths_from_root).await?,\n                         assets: paths_to_bindings(all_assets),\n-                        name: app_entry.pathname.clone(),\n+                        name: app_middleware_function_name(&app_entry.original_name).into(),\n                         page: app_entry.original_name.clone(),\n                         regions: app_entry\n                             .config"
        },
        {
            "sha": "3cd57d44f4d907c456286c9cdf2743a0ed95b2d0",
            "filename": "crates/next-api/src/pages.rs",
            "status": "modified",
            "additions": 13,
            "deletions": 13,
            "changes": 26,
            "blob_url": "https://github.com/vercel/next.js/blob/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-api%2Fsrc%2Fpages.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fpages.rs?ref=3c142be74c73a675c24e12e8c7e39c33162d07a0",
            "patch": "@@ -23,7 +23,10 @@ use next_core::{\n     pages_structure::{\n         PagesDirectoryStructure, PagesStructure, PagesStructureItem, find_pages_structure,\n     },\n-    util::{NextRuntime, get_asset_prefix_from_pathname, parse_config_from_source},\n+    util::{\n+        NextRuntime, get_asset_prefix_from_pathname, pages_middleware_function_name,\n+        parse_config_from_source,\n+    },\n };\n use serde::{Deserialize, Serialize};\n use tracing::Instrument;\n@@ -1385,22 +1388,19 @@ impl PageEndpoint {\n             PageEndpointType::SsrOnly => self.ssr_chunk(emit_manifests),\n         };\n \n-        let pathname = &this.pathname;\n-        let original_name = &this.original_name;\n-\n         let client_assets = OutputAssets::new(client_assets).to_resolved().await?;\n \n-        let manifest_path_prefix = get_asset_prefix_from_pathname(pathname);\n+        let manifest_path_prefix = get_asset_prefix_from_pathname(&this.pathname);\n         let node_root = this.pages_project.project().node_root().owned().await?;\n \n         if emit_manifests == EmitManifests::Full {\n             let next_font_manifest_output = create_font_manifest(\n                 this.pages_project.project().client_root().owned().await?,\n                 node_root.clone(),\n                 this.pages_project.pages_dir().owned().await?,\n-                original_name,\n+                &this.original_name,\n                 &manifest_path_prefix,\n-                pathname,\n+                &this.pathname,\n                 *client_assets,\n                 false,\n             )\n@@ -1416,7 +1416,7 @@ impl PageEndpoint {\n         {\n             let webpack_stats = generate_webpack_stats(\n                 self.client_module_graph(),\n-                original_name.to_owned(),\n+                this.original_name.clone(),\n                 client_assets.await?.iter().copied(),\n             )\n             .await?;\n@@ -1509,10 +1509,10 @@ impl PageEndpoint {\n                     let all_assets =\n                         get_asset_paths_from_root(&node_root, &all_output_assets).await?;\n \n-                    let named_regex = get_named_middleware_regex(pathname).into();\n+                    let named_regex = get_named_middleware_regex(&this.pathname).into();\n                     let matchers = MiddlewareMatcher {\n                         regexp: Some(named_regex),\n-                        original_source: pathname.clone(),\n+                        original_source: this.pathname.clone(),\n                         ..Default::default()\n                     };\n                     let regions = if let Some(regions) = regions.as_ref() {\n@@ -1531,15 +1531,15 @@ impl PageEndpoint {\n                         files: file_paths_from_root.into_iter().collect(),\n                         wasm: wasm_paths_to_bindings(wasm_paths_from_root).await?,\n                         assets: paths_to_bindings(all_assets),\n-                        name: pathname.clone(),\n+                        name: pages_middleware_function_name(&this.original_name).into(),\n                         page: this.original_name.clone(),\n                         regions,\n                         matchers: vec![matchers],\n                         env: this.pages_project.project().edge_env().owned().await?,\n                     };\n                     let middleware_manifest_v2 = MiddlewaresManifestV2 {\n-                        sorted_middleware: vec![pathname.clone()],\n-                        functions: [(pathname.clone(), edge_function_definition)]\n+                        sorted_middleware: vec![this.pathname.clone()],\n+                        functions: [(this.pathname.clone(), edge_function_definition)]\n                             .into_iter()\n                             .collect(),\n                         ..Default::default()"
        },
        {
            "sha": "24d9dc400f169efae00d6506f7cc5d72f8e361d6",
            "filename": "crates/next-core/src/next_app/app_page_entry.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_page_entry.rs?ref=3c142be74c73a675c24e12e8c7e39c33162d07a0",
            "patch": "@@ -27,7 +27,7 @@ use crate::{\n     next_edge::entry::wrap_edge_entry,\n     next_server_component::NextServerComponentTransition,\n     parse_segment_config_from_loader_tree,\n-    util::{NextRuntime, file_content_rope, load_next_js_template},\n+    util::{NextRuntime, app_middleware_function_name, file_content_rope, load_next_js_template},\n };\n \n /// Computes the entry for a Next.js app page.\n@@ -186,6 +186,6 @@ async fn wrap_edge_page(\n         asset_context,\n         project_root,\n         wrapped,\n-        AppPath::from(page).to_string().into(),\n+        app_middleware_function_name(&page).into(),\n     ))\n }"
        },
        {
            "sha": "5627ab3a22b1faf0995c3d1812429b5a19bc03d8",
            "filename": "crates/next-core/src/next_app/app_route_entry.rs",
            "status": "modified",
            "additions": 2,
            "deletions": 2,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fapp_route_entry.rs?ref=3c142be74c73a675c24e12e8c7e39c33162d07a0",
            "patch": "@@ -16,7 +16,7 @@ use crate::{\n     next_config::{NextConfig, OutputType},\n     next_edge::entry::wrap_edge_entry,\n     parse_segment_config_from_source,\n-    util::{NextRuntime, load_next_js_template},\n+    util::{NextRuntime, app_middleware_function_name, load_next_js_template},\n };\n \n /// Computes the entry for a Next.js app route.\n@@ -162,6 +162,6 @@ async fn wrap_edge_route(\n         asset_context,\n         project_root.clone(),\n         wrapped,\n-        AppPath::from(page).to_string().into(),\n+        app_middleware_function_name(&page).into(),\n     ))\n }"
        },
        {
            "sha": "71cebf38d9e83c3c047e33f92045b930ad9217d1",
            "filename": "crates/next-core/src/next_pages/page_entry.rs",
            "status": "modified",
            "additions": 3,
            "deletions": 3,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_pages%2Fpage_entry.rs?ref=3c142be74c73a675c24e12e8c7e39c33162d07a0",
            "patch": "@@ -19,7 +19,7 @@ use crate::{\n     next_config::NextConfig,\n     next_edge::entry::wrap_edge_entry,\n     pages_structure::{PagesStructure, PagesStructureItem},\n-    util::{NextRuntime, file_content_rope, load_next_js_template},\n+    util::{NextRuntime, file_content_rope, load_next_js_template, pages_middleware_function_name},\n };\n \n #[turbo_tasks::value]\n@@ -163,7 +163,7 @@ pub async fn create_page_ssr_entry_module(\n                 ssr_module_context,\n                 project_root,\n                 ssr_module,\n-                definition_pathname.clone(),\n+                pages_middleware_function_name(&definition_page).into(),\n             );\n         }\n     }\n@@ -288,7 +288,7 @@ async fn wrap_edge_page(\n         asset_context,\n         project_root,\n         wrapped,\n-        pathname.clone(),\n+        pages_middleware_function_name(&page).into(),\n     ))\n }\n "
        },
        {
            "sha": "398a7db77c3213c334c7aebdb435241aba47ac2f",
            "filename": "crates/next-core/src/util.rs",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/3c142be74c73a675c24e12e8c7e39c33162d07a0/crates%2Fnext-core%2Fsrc%2Futil.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Futil.rs?ref=3c142be74c73a675c24e12e8c7e39c33162d07a0",
            "patch": "@@ -1,4 +1,4 @@\n-use std::{future::Future, str::FromStr};\n+use std::{fmt::Display, future::Future, str::FromStr};\n \n use anyhow::{Result, bail};\n use next_taskless::expand_next_js_template;\n@@ -196,6 +196,13 @@ pub async fn internal_assets_conditions() -> Result<ContextCondition> {\n     ]))\n }\n \n+pub fn app_middleware_function_name(page: impl Display) -> String {\n+    format!(\"app{page}\")\n+}\n+pub fn pages_middleware_function_name(page: impl Display) -> String {\n+    format!(\"pages{page}\")\n+}\n+\n #[derive(\n     Default,\n     PartialEq,"
        }
    ],
    "stats": {
        "total": 56,
        "additions": 33,
        "deletions": 23
    }
}