{
    "author": "eps1lon",
    "message": "[test] Reduce flakiness of instrumentation-order (#80712)\n\nThe test was implicitly relying on `preloadEntriesOnStart` to load the module in our prod tests.\r\n\r\nFixes https://github.com/vercel/next.js/actions/runs/15774186781/job/44464850249?pr=80710#step:34:282 and [other flakes](https://app.datadoghq.com/ci/test/runs?query=test_level%3Atest%20%40test.source.file%3A%22test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts%22%20%40test.status%3Afail&agg_m=count&agg_m_source=base&agg_t=count&currentTab=overview&eventStack=&fromUser=true&index=citest&start=1749804083936&end=1750408883936&paused=true)\r\n\r\nNow we always trigger the page for the first time in the test and wait for the logs to come in instead of hardcoding a timeout.",
    "sha": "7c458922eaf10adb840962c12512c9655829b616",
    "files": [
        {
            "sha": "cdd90fdedf5ec55aa37f30e9f1f5b6c3a6758d4b",
            "filename": "test/e2e/app-dir/instrumentation-order/instrumentation-order.test.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 23,
            "changes": 42,
            "blob_url": "https://github.com/vercel/next.js/blob/7c458922eaf10adb840962c12512c9655829b616/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/7c458922eaf10adb840962c12512c9655829b616/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Finstrumentation-order.test.ts?ref=7c458922eaf10adb840962c12512c9655829b616",
            "patch": "@@ -1,35 +1,31 @@\n import { nextTestSetup } from 'e2e-utils'\n-import { waitFor } from 'next-test-utils'\n-\n-const ORDERED_LOGS = [\n-  'instrumentation:side-effect',\n-  'instrumentation:register:begin',\n-  'instrumentation:register:timeout',\n-  'instrumentation:register:end',\n-  'global-side-effect:app-router-page',\n-]\n+import { retry } from 'next-test-utils'\n \n describe('instrumentation-order', () => {\n-  const { next, isNextDev } = nextTestSetup({\n+  const { next } = nextTestSetup({\n     files: __dirname,\n     skipDeployment: true,\n   })\n \n-  it('should work using cheerio', async () => {\n-    // Wait for the timeout in the instrumentation to complete\n-    await waitFor(500)\n+  it('should work', async () => {\n+    await next.fetch('/')\n \n-    // Dev mode requires to render the page to trigger the build of the page\n-    if (isNextDev) {\n-      await next.render$('/')\n-    }\n+    await retry(async () => {\n+      const serverLog = next.cliOutput.split('Starting...')[1]\n+      const cliOutputLines = serverLog.split('\\n')\n \n-    const serverLog = next.cliOutput.split('Starting...')[1]\n-    const cliOutputLines = serverLog.split('\\n')\n-    const searchedLines = cliOutputLines.filter((line) =>\n-      ORDERED_LOGS.includes(line.trim())\n-    )\n+      const ORDERED_LOGS = [\n+        'instrumentation:side-effect',\n+        'instrumentation:register:begin',\n+        'instrumentation:register:timeout',\n+        'instrumentation:register:end',\n+        'global-side-effect:app-router-page',\n+      ]\n+      const searchedLines = cliOutputLines.filter((line) =>\n+        ORDERED_LOGS.includes(line.trim())\n+      )\n \n-    expect(searchedLines).toEqual(ORDERED_LOGS)\n+      expect(searchedLines).toEqual(ORDERED_LOGS)\n+    })\n   })\n })"
        },
        {
            "sha": "19f80359dcbdf52d81b857aa9b591df378bcb95b",
            "filename": "test/e2e/app-dir/instrumentation-order/next.config.js",
            "status": "modified",
            "additions": 5,
            "deletions": 1,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/7c458922eaf10adb840962c12512c9655829b616/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/7c458922eaf10adb840962c12512c9655829b616/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Finstrumentation-order%2Fnext.config.js?ref=7c458922eaf10adb840962c12512c9655829b616",
            "patch": "@@ -1,6 +1,10 @@\n /**\n  * @type {import('next').NextConfig}\n  */\n-const nextConfig = {}\n+const nextConfig = {\n+  experimental: {\n+    preloadEntriesOnStart: false,\n+  },\n+}\n \n module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 48,
        "additions": 24,
        "deletions": 24
    }
}