{
    "author": "bgw",
    "message": "fix(test/e2e/prerender): Remove race condition in test (#77222)\n\nFixed `setTimeout`s in tests are bad for flakiness, as they introduce\npotential race conditions.\n\nhttps://vercel.slack.com/archives/C07UCHRBWGK/p1742074798403739\n\nInstead of using a fixed timeout, check for a special marker file in a\nloop every 100ms.",
    "sha": "eaf6ca44578d55363d41e44a04af7f2235e18f54",
    "files": [
        {
            "sha": "9c9bc8580b880215b940c3d65d7e3b28b7202e75",
            "filename": "test/e2e/prerender.test.ts",
            "status": "modified",
            "additions": 33,
            "deletions": 21,
            "changes": 54,
            "blob_url": "https://github.com/vercel/next.js/blob/eaf6ca44578d55363d41e44a04af7f2235e18f54/test%2Fe2e%2Fprerender.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/eaf6ca44578d55363d41e44a04af7f2235e18f54/test%2Fe2e%2Fprerender.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender.test.ts?ref=eaf6ca44578d55363d41e44a04af7f2235e18f54",
            "patch": "@@ -551,7 +551,7 @@ describe('Prerender', () => {\n     })\n   }\n \n-  const runTests = (isDev = false, isDeploy) => {\n+  const runTests = (isDev: boolean = false, isDeploy: boolean) => {\n     navigateTest(isDev)\n \n     it('should respond with 405 for POST to static page', async () => {\n@@ -926,33 +926,45 @@ describe('Prerender', () => {\n       const text = await browser.elementByCss('p').text()\n       expect(text).toContain('hi fallback')\n \n-      // wait for fallback data to load\n-      await check(() => browser.elementByCss('p').text(), /Post/)\n+      if (isDeploy) {\n+        // patchFile does not work with deploy tests\n+        return\n+      }\n+\n+      await next.patchFile('resolve-static-props', '', async () => {\n+        // wait for fallback data to load\n+        await check(() => browser.elementByCss('p').text(), /Post/)\n \n-      // check fallback data\n-      const post = await browser.elementByCss('p').text()\n-      const query = JSON.parse(await browser.elementByCss('#query').text())\n-      const params = JSON.parse(await browser.elementByCss('#params').text())\n+        // check fallback data\n+        const post = await browser.elementByCss('p').text()\n+        const query = JSON.parse(await browser.elementByCss('#query').text())\n+        const params = JSON.parse(await browser.elementByCss('#params').text())\n \n-      expect(post).toContain('first/post')\n-      expect(params).toEqual({\n-        slug: 'first/post',\n+        expect(post).toContain('first/post')\n+        expect(params).toEqual({\n+          slug: 'first/post',\n+        })\n+        expect(query).toEqual(params)\n       })\n-      expect(query).toEqual(params)\n     })\n \n-    it('should handle fallback only page correctly data', async () => {\n-      const data = JSON.parse(\n-        await renderViaHTTP(\n-          next.url,\n-          `/_next/data/${next.buildId}/fallback-only/second%2Fpost.json`\n-        )\n-      )\n+    // patchFile does not work with deploy tests\n+    if (!isDeploy) {\n+      it('should handle fallback only page correctly data', async () => {\n+        await next.patchFile('resolve-static-props', '', async () => {\n+          const data = JSON.parse(\n+            await renderViaHTTP(\n+              next.url,\n+              `/_next/data/${next.buildId}/fallback-only/second%2Fpost.json`\n+            )\n+          )\n \n-      expect(data.pageProps.params).toEqual({\n-        slug: 'second/post',\n+          expect(data.pageProps.params).toEqual({\n+            slug: 'second/post',\n+          })\n+        })\n       })\n-    })\n+    }\n \n     it('should 404 for a missing catchall explicit route', async () => {\n       const res = await fetchViaHTTP("
        },
        {
            "sha": "fdd48fbcbb56d91c364af339fa1de06d8b5146f6",
            "filename": "test/e2e/prerender/pages/fallback-only/[slug].js",
            "status": "modified",
            "additions": 8,
            "deletions": 1,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/eaf6ca44578d55363d41e44a04af7f2235e18f54/test%2Fe2e%2Fprerender%2Fpages%2Ffallback-only%2F%5Bslug%5D.js",
            "raw_url": "https://github.com/vercel/next.js/raw/eaf6ca44578d55363d41e44a04af7f2235e18f54/test%2Fe2e%2Fprerender%2Fpages%2Ffallback-only%2F%5Bslug%5D.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fprerender%2Fpages%2Ffallback-only%2F%5Bslug%5D.js?ref=eaf6ca44578d55363d41e44a04af7f2235e18f54",
            "patch": "@@ -1,6 +1,7 @@\n import React from 'react'\n import Link from 'next/link'\n import { useRouter } from 'next/router'\n+import fs from 'node:fs/promises'\n \n export async function getStaticPaths() {\n   return {\n@@ -10,7 +11,13 @@ export async function getStaticPaths() {\n }\n \n export async function getStaticProps({ params }) {\n-  await new Promise((resolve) => setTimeout(resolve, 1000))\n+  while (true) {\n+    try {\n+      await fs.stat('resolve-static-props')\n+      break\n+    } catch (e) {}\n+    await new Promise((resolve) => setTimeout(resolve, 100))\n+  }\n \n   return {\n     props: {"
        }
    ],
    "stats": {
        "total": 63,
        "additions": 41,
        "deletions": 22
    }
}