{
    "author": "bgw",
    "message": "refactor(turbo-tasks): Make TraceRawVcs a supertrait of MagicAny (#77596)\n\nThe previous PR makes `TaskInput` implement `TraceRawVcs`, but the task inputs are actually stored as `Box<dyn MagicAny>`, so this implements `TraceRawVcs` for that.",
    "sha": "6c4f6be223c0e3a7281960a22744044ac4291468",
    "files": [
        {
            "sha": "476fa88c3b233771605b322c30a83b1d2e002238",
            "filename": "turbopack/crates/turbo-tasks/src/magic_any.rs",
            "status": "modified",
            "additions": 24,
            "deletions": 7,
            "changes": 31,
            "blob_url": "https://github.com/vercel/next.js/blob/6c4f6be223c0e3a7281960a22744044ac4291468/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6c4f6be223c0e3a7281960a22744044ac4291468/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fmagic_any.rs?ref=6c4f6be223c0e3a7281960a22744044ac4291468",
            "patch": "@@ -9,6 +9,8 @@ use std::{\n \n use serde::{de::DeserializeSeed, Deserialize, Serialize};\n \n+use crate::trace::{TraceRawVcs, TraceRawVcsContext};\n+\n pub trait MagicAny: mopa::Any + Send + Sync {\n     fn magic_any_arc(self: Arc<Self>) -> Arc<dyn Any + Sync + Send>;\n \n@@ -18,6 +20,8 @@ pub trait MagicAny: mopa::Any + Send + Sync {\n \n     fn magic_hash(&self, hasher: &mut dyn Hasher);\n \n+    fn magic_trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext);\n+\n     #[cfg(debug_assertions)]\n     fn magic_type_name(&self) -> &'static str;\n }\n@@ -31,7 +35,7 @@ mod clippy {\n     mopafy!(MagicAny);\n }\n \n-impl<T: Debug + Eq + Hash + Send + Sync + 'static> MagicAny for T {\n+impl<T: Debug + Eq + Hash + Send + Sync + TraceRawVcs + 'static> MagicAny for T {\n     fn magic_any_arc(self: Arc<Self>) -> Arc<dyn Any + Sync + Send> {\n         self\n     }\n@@ -58,6 +62,10 @@ impl<T: Debug + Eq + Hash + Send + Sync + 'static> MagicAny for T {\n         Hash::hash(&(TypeId::of::<Self>(), self), &mut HasherMut(hasher))\n     }\n \n+    fn magic_trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext) {\n+        self.trace_raw_vcs(trace_context);\n+    }\n+\n     #[cfg(debug_assertions)]\n     fn magic_type_name(&self) -> &'static str {\n         std::any::type_name::<T>()\n@@ -99,8 +107,14 @@ where\n     }\n }\n \n+impl TraceRawVcs for dyn MagicAny {\n+    fn trace_raw_vcs(&self, trace_context: &mut TraceRawVcsContext) {\n+        self.magic_trace_raw_vcs(trace_context)\n+    }\n+}\n+\n impl dyn MagicAny {\n-    pub fn as_serialize<T: Debug + Eq + Hash + Serialize + Send + Sync + 'static>(\n+    pub fn as_serialize<T: Debug + Eq + Hash + Serialize + Send + Sync + TraceRawVcs + 'static>(\n         &self,\n     ) -> &dyn erased_serde::Serialize {\n         if let Some(r) = self.downcast_ref::<T>() {\n@@ -126,8 +140,8 @@ pub struct MagicAnySerializeSeed {\n }\n \n impl MagicAnySerializeSeed {\n-    pub fn new<T: Debug + Eq + Hash + Serialize + Send + Sync + 'static>() -> Self {\n-        fn serialize<T: Debug + Eq + Hash + Serialize + Send + Sync + 'static>(\n+    pub fn new<T: Debug + Eq + Hash + Serialize + Send + Sync + TraceRawVcs + 'static>() -> Self {\n+        fn serialize<T: Debug + Eq + Hash + Serialize + Send + Sync + TraceRawVcs + 'static>(\n             value: &dyn MagicAny,\n         ) -> &dyn erased_serde::Serialize {\n             value.as_serialize::<T>()\n@@ -153,11 +167,14 @@ pub struct MagicAnyDeserializeSeed {\n impl MagicAnyDeserializeSeed {\n     pub fn new<T>() -> Self\n     where\n-        T: for<'de> Deserialize<'de> + Debug + Eq + Hash + Send + Sync + 'static,\n+        T: for<'de> Deserialize<'de> + Debug + Eq + Hash + Send + Sync + TraceRawVcs + 'static,\n     {\n-        fn deserialize<T: Debug + Eq + Hash + for<'de> Deserialize<'de> + Send + Sync + 'static>(\n+        fn deserialize<T>(\n             deserializer: &mut dyn erased_serde::Deserializer<'_>,\n-        ) -> Result<Box<dyn MagicAny>, erased_serde::Error> {\n+        ) -> Result<Box<dyn MagicAny>, erased_serde::Error>\n+        where\n+            T: for<'de> Deserialize<'de> + Debug + Eq + Hash + Send + Sync + TraceRawVcs + 'static,\n+        {\n             let value: T = erased_serde::deserialize(deserializer)?;\n             Ok(Box::new(value))\n         }"
        },
        {
            "sha": "78ad7be46bb04bbdf008ed016af12ff695456aaf",
            "filename": "turbopack/crates/turbo-tasks/src/value_type.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 3,
            "changes": 23,
            "blob_url": "https://github.com/vercel/next.js/blob/6c4f6be223c0e3a7281960a22744044ac4291468/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvalue_type.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/6c4f6be223c0e3a7281960a22744044ac4291468/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvalue_type.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks%2Fsrc%2Fvalue_type.rs?ref=6c4f6be223c0e3a7281960a22744044ac4291468",
            "patch": "@@ -17,6 +17,7 @@ use crate::{\n     magic_any::{AnyDeserializeSeed, MagicAny, MagicAnyDeserializeSeed, MagicAnySerializeSeed},\n     registry::{register_trait_type, register_value_type},\n     task::shared_reference::TypedSharedReference,\n+    trace::TraceRawVcs,\n     vc::VcCellMode,\n     RawVc, VcValueType,\n };\n@@ -116,7 +117,7 @@ impl ValueType {\n \n     /// This is internally used by `#[turbo_tasks::value]`\n     pub fn new_with_magic_serialization<\n-        T: VcValueType + Debug + Eq + Hash + Serialize + for<'de> Deserialize<'de>,\n+        T: VcValueType + Debug + Eq + Hash + Serialize + for<'de> Deserialize<'de> + TraceRawVcs,\n     >() -> Self {\n         Self {\n             name: std::any::type_name::<T>().to_string(),\n@@ -265,7 +266,15 @@ impl TraitType {\n \n     pub fn register_trait_method<T>(&mut self, name: Cow<'static, str>)\n     where\n-        T: Serialize + for<'de> Deserialize<'de> + Debug + Eq + Hash + Send + Sync + 'static,\n+        T: Serialize\n+            + for<'de> Deserialize<'de>\n+            + Debug\n+            + Eq\n+            + Hash\n+            + Send\n+            + Sync\n+            + TraceRawVcs\n+            + 'static,\n     {\n         self.methods.insert(\n             name,\n@@ -282,7 +291,15 @@ impl TraitType {\n         name: Cow<'static, str>,\n         native_fn: FunctionId,\n     ) where\n-        T: Serialize + for<'de> Deserialize<'de> + Debug + Eq + Hash + Send + Sync + 'static,\n+        T: Serialize\n+            + for<'de> Deserialize<'de>\n+            + Debug\n+            + Eq\n+            + Hash\n+            + Send\n+            + Sync\n+            + TraceRawVcs\n+            + 'static,\n     {\n         self.methods.insert(\n             name,"
        }
    ],
    "stats": {
        "total": 54,
        "additions": 44,
        "deletions": 10
    }
}