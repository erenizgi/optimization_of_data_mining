{
    "author": "kdy1",
    "message": "perf(turbopack): Implement `ShrinkToFit` for `AutoMap` (#79218)\n\n### What?\n\nImplement `ShrinkToFit` for `AutoMap`, which can be used in a `Vc`\n\n### Why?\n\nFor consistency and to reduce max RSS\n\n---------\n\nCo-authored-by: Niklas Mischkulnig <4586894+mischnic@users.noreply.github.com>",
    "sha": "62de494f3c28e3a6e949a434047ea3023121d239",
    "files": [
        {
            "sha": "0042dedb572ba7cc53a6550ae2890c93d539c770",
            "filename": "Cargo.lock",
            "status": "modified",
            "additions": 2,
            "deletions": 0,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/62de494f3c28e3a6e949a434047ea3023121d239/Cargo.lock",
            "raw_url": "https://github.com/vercel/next.js/raw/62de494f3c28e3a6e949a434047ea3023121d239/Cargo.lock",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/Cargo.lock?ref=62de494f3c28e3a6e949a434047ea3023121d239",
            "patch": "@@ -577,6 +577,7 @@ dependencies = [\n  \"hashbrown 0.14.5\",\n  \"rustc-hash 2.1.1\",\n  \"serde\",\n+ \"shrink-to-fit\",\n  \"smallvec\",\n ]\n \n@@ -6985,6 +6986,7 @@ version = \"0.2.10\"\n source = \"registry+https://github.com/rust-lang/crates.io-index\"\n checksum = \"939a4c696178684fc5fc1426625b882805418bbb56e056d21f9d4946a9d6ff51\"\n dependencies = [\n+ \"hashbrown 0.15.2\",\n  \"indexmap 2.7.1\",\n  \"serde_json\",\n  \"shrink-to-fit-macro\","
        },
        {
            "sha": "1b15fd8e643b990f2746a7eb958fffa8be3595e6",
            "filename": "turbopack/crates/turbo-tasks-auto-hash-map/Cargo.toml",
            "status": "modified",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/62de494f3c28e3a6e949a434047ea3023121d239/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2FCargo.toml",
            "raw_url": "https://github.com/vercel/next.js/raw/62de494f3c28e3a6e949a434047ea3023121d239/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2FCargo.toml",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2FCargo.toml?ref=62de494f3c28e3a6e949a434047ea3023121d239",
            "patch": "@@ -13,3 +13,4 @@ hashbrown = { workspace = true, features = [\"serde\"]}\n rustc-hash = { workspace = true }\n serde = { workspace = true, features = [\"derive\"] }\n smallvec = { workspace = true }\n+shrink-to-fit = { workspace = true, features = [\"hashbrown\"] }\n\\ No newline at end of file"
        },
        {
            "sha": "b1a3d27ba0bab71a8ca74fa44464118c7b939611",
            "filename": "turbopack/crates/turbo-tasks-auto-hash-map/src/map.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/62de494f3c28e3a6e949a434047ea3023121d239/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2Fsrc%2Fmap.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/62de494f3c28e3a6e949a434047ea3023121d239/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2Fsrc%2Fmap.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2Fsrc%2Fmap.rs?ref=62de494f3c28e3a6e949a434047ea3023121d239",
            "patch": "@@ -12,6 +12,7 @@ use serde::{\n     de::{MapAccess, Visitor},\n     ser::SerializeMap,\n };\n+use shrink_to_fit::ShrinkToFit;\n use smallvec::SmallVec;\n \n use crate::{MAX_LIST_SIZE, MIN_HASH_SIZE};\n@@ -900,6 +901,25 @@ where\n     }\n }\n \n+impl<K, V, H, const I: usize> ShrinkToFit for AutoMap<K, V, H, I>\n+where\n+    K: Eq + Hash,\n+    V: Eq,\n+    H: BuildHasher + Default,\n+{\n+    fn shrink_to_fit(&mut self) {\n+        if self.len() < MIN_HASH_SIZE {\n+            self.convert_to_list();\n+        }\n+\n+        match self {\n+            AutoMap::List(list) => list.shrink_to_fit(),\n+            AutoMap::Map(map) => {\n+                hashbrown::HashMap::shrink_to_fit(map);\n+            }\n+        }\n+    }\n+}\n #[cfg(test)]\n mod tests {\n     use super::*;"
        },
        {
            "sha": "5814874c453306473e64f10a2858b0118cf67512",
            "filename": "turbopack/crates/turbo-tasks-auto-hash-map/src/set.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/62de494f3c28e3a6e949a434047ea3023121d239/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2Fsrc%2Fset.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/62de494f3c28e3a6e949a434047ea3023121d239/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2Fsrc%2Fset.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-auto-hash-map%2Fsrc%2Fset.rs?ref=62de494f3c28e3a6e949a434047ea3023121d239",
            "patch": "@@ -6,6 +6,7 @@ use std::{\n \n use rustc_hash::FxHasher;\n use serde::{Deserialize, Serialize};\n+use shrink_to_fit::ShrinkToFit;\n \n use crate::AutoMap;\n \n@@ -240,6 +241,16 @@ where\n     }\n }\n \n+impl<K, H, const I: usize> ShrinkToFit for AutoSet<K, H, I>\n+where\n+    K: Eq + Hash,\n+    H: BuildHasher + Default,\n+{\n+    fn shrink_to_fit(&mut self) {\n+        self.map.shrink_to_fit();\n+    }\n+}\n+\n #[cfg(test)]\n mod tests {\n     use super::*;"
        }
    ],
    "stats": {
        "total": 34,
        "additions": 34,
        "deletions": 0
    }
}