{
    "author": "eps1lon",
    "message": "[test] Assert on all errors in app/ hydration-error suite (#78132)",
    "sha": "307c40e5c43b93ce3ce8c4127ba5d3399cb8e4ce",
    "files": [
        {
            "sha": "ca0bab590a45b5ef6bc807cd9fdb5ad8588cb230",
            "filename": "test/development/acceptance-app/hydration-error.test.ts",
            "status": "modified",
            "additions": 472,
            "deletions": 192,
            "changes": 664,
            "blob_url": "https://github.com/vercel/next.js/blob/307c40e5c43b93ce3ce8c4127ba5d3399cb8e4ce/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/307c40e5c43b93ce3ce8c4127ba5d3399cb8e4ce/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts?ref=307c40e5c43b93ce3ce8c4127ba5d3399cb8e4ce",
            "patch": "@@ -3,7 +3,7 @@ import { createSandbox } from 'development-sandbox'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n import path from 'path'\n import { outdent } from 'outdent'\n-import { getRedboxTotalErrorCount, retry } from 'next-test-utils'\n+import { getToastErrorCount, retry } from 'next-test-utils'\n \n describe('Error overlay for hydration errors in App router', () => {\n   const { next, isTurbopack } = nextTestSetup({\n@@ -69,32 +69,11 @@ describe('Error overlay for hydration errors in App router', () => {\n       ])\n     )\n     const { session, browser } = sandbox\n-    await session.openRedbox()\n-\n-    expect(await getRedboxTotalErrorCount(browser)).toBe(1)\n \n     // TODO(veil): Should be \"rendered text\"\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\"`\n-    )\n-\n-    expect(await session.getRedboxDescriptionWarning()).toMatchInlineSnapshot(`\n-      \"- A server/client branch \\`if (typeof window !== 'undefined')\\`.\n-      - Variable input such as \\`Date.now()\\` or \\`Math.random()\\` which changes each time it's called.\n-      - Date formatting in a user's locale which doesn't match the server.\n-      - External changing data without sending a snapshot of it along with the HTML.\n-      - Invalid HTML tag nesting.\n-\n-      It can also happen if the client has a browser extension installed which messes with the HTML before React loaded.\"\n-    `)\n-\n-    expect(await session.getRedboxErrorLink()).toMatchInlineSnapshot(\n-      `\"See more info here: https://nextjs.org/docs/messages/react-hydration-error\"`\n-    )\n-\n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -111,8 +90,22 @@ describe('Error overlay for hydration errors in App router', () => {\n                                    <main className=\"child\">\n      +                               client\n      -                               server\n-                             ...\"\n+                             ...\",\n+       \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": \"app/page.js (6:7) @ Mismatch\n+     > 6 |       <main className=\"child\">{isClient ? \"client\" : \"server\"}</main>\n+         |       ^\",\n+       \"stack\": [\n+         \"main <anonymous> (0:0)\",\n+         \"Mismatch app/page.js (6:7)\",\n+       ],\n+     }\n     `)\n+    expect(await session.getRedboxErrorLink()).toMatchInlineSnapshot(\n+      `\"See more info here: https://nextjs.org/docs/messages/react-hydration-error\"`\n+    )\n \n     await session.patch(\n       'app/page.js',\n@@ -153,14 +146,11 @@ describe('Error overlay for hydration errors in App router', () => {\n         ],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n-\n-    expect(await getRedboxTotalErrorCount(browser)).toBe(1)\n+    const { browser } = sandbox\n \n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -175,12 +165,19 @@ describe('Error overlay for hydration errors in App router', () => {\n                                <Mismatch params={Promise} searchParams={Promise}>\n                                  <div className=\"parent\">\n      +                             <main className=\"only\">\n-                             ...\"\n+                             ...\",\n+       \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": \"app/page.js (6:20) @ Mismatch\n+     > 6 |       {isClient && <main className=\"only\" />}\n+         |                    ^\",\n+       \"stack\": [\n+         \"main <anonymous> (0:0)\",\n+         \"Mismatch app/page.js (6:20)\",\n+       ],\n+     }\n     `)\n-\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\"`\n-    )\n   })\n \n   it('should show correct hydration error when extra attributes set on server', async () => {\n@@ -206,15 +203,12 @@ describe('Error overlay for hydration errors in App router', () => {\n         ['app/page.js', `export default function Page() { return 'page' }`],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n-\n-    expect(await getRedboxTotalErrorCount(browser)).toBe(1)\n+    const { browser } = sandbox\n \n-    const pseudoHtml = await session.getRedboxComponentStack()\n     if (isTurbopack) {\n-      expect(pseudoHtml).toMatchInlineSnapshot(`\n-       \"...\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"componentStack\": \"...\n            <HotReload assetPrefix=\"\" globalError={[...]}>\n              <AppDevOverlay state={{nextId:1, ...}} globalError={[...]}>\n                <AppDevOverlayErrorBoundary globalError={[...]} onError={function bound dispatchSetState}>\n@@ -234,11 +228,23 @@ describe('Error overlay for hydration errors in App router', () => {\n        -                         className=\"server-html\"\n                                >\n                            ...\n-               ...\"\n+               ...\",\n+         \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/layout.js (5:5) @ Root\n+       > 5 |     <html\n+           |     ^\",\n+         \"stack\": [\n+           \"html <anonymous> (0:0)\",\n+           \"Root app/layout.js (5:5)\",\n+         ],\n+       }\n       `)\n     } else {\n-      expect(pseudoHtml).toMatchInlineSnapshot(`\n-       \"...\n+      await expect(browser).toDisplayCollapsedRedbox(`\n+       {\n+         \"componentStack\": \"...\n            <HotReload assetPrefix=\"\" globalError={[...]}>\n              <AppDevOverlay state={{nextId:1, ...}} globalError={[...]}>\n                <AppDevOverlayErrorBoundary globalError={[...]} onError={function bound dispatchSetState}>\n@@ -255,13 +261,20 @@ describe('Error overlay for hydration errors in App router', () => {\n        -                         className=\"server-html\"\n                                >\n                            ...\n-               ...\"\n+               ...\",\n+         \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/layout.js (5:5) @ Root\n+       > 5 |     <html\n+           |     ^\",\n+         \"stack\": [\n+           \"html <anonymous> (0:0)\",\n+           \"Root app/layout.js (5:5)\",\n+         ],\n+       }\n       `)\n     }\n-\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\"`\n-    )\n   })\n \n   it('should show correct hydration error when client renders an extra text node', async () => {\n@@ -286,14 +299,11 @@ describe('Error overlay for hydration errors in App router', () => {\n         ],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n-\n-    expect(await getRedboxTotalErrorCount(browser)).toBe(1)\n+    const { browser } = sandbox\n \n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -311,12 +321,19 @@ describe('Error overlay for hydration errors in App router', () => {\n      +                             second\n      -                             <footer className=\"3\">\n                                    ...\n-                             ...\"\n+                             ...\",\n+       \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": \"app/page.js (5:5) @ Mismatch\n+     > 5 |     <div className=\"parent\">\n+         |     ^\",\n+       \"stack\": [\n+         \"div <anonymous> (0:0)\",\n+         \"Mismatch app/page.js (5:5)\",\n+       ],\n+     }\n     `)\n-\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\"`\n-    )\n   })\n \n   it('should show correct hydration error when server renders an extra element', async () => {\n@@ -339,14 +356,11 @@ describe('Error overlay for hydration errors in App router', () => {\n         ],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n-\n-    expect(await getRedboxTotalErrorCount(browser)).toBe(1)\n+    const { browser } = sandbox\n \n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -361,12 +375,19 @@ describe('Error overlay for hydration errors in App router', () => {\n                                <Mismatch params={Promise} searchParams={Promise}>\n                                  <div className=\"parent\">\n      -                             <main className=\"only\">\n-                             ...\"\n+                             ...\",\n+       \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": \"app/page.js (5:5) @ Mismatch\n+     > 5 |     <div className=\"parent\">\n+         |     ^\",\n+       \"stack\": [\n+         \"div <anonymous> (0:0)\",\n+         \"Mismatch app/page.js (5:5)\",\n+       ],\n+     }\n     `)\n-\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\"`\n-    )\n   })\n \n   it('should show correct hydration error when server renders an extra text node', async () => {\n@@ -385,18 +406,11 @@ describe('Error overlay for hydration errors in App router', () => {\n         ],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n-\n-    expect(await getRedboxTotalErrorCount(browser)).toBe(1)\n-\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\"`\n-    )\n+    const { browser } = sandbox\n \n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -411,7 +425,18 @@ describe('Error overlay for hydration errors in App router', () => {\n                                <Mismatch params={Promise} searchParams={Promise}>\n                                  <div className=\"parent\">\n      -                             only\n-                             ...\"\n+                             ...\",\n+       \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": \"app/page.js (4:10) @ Mismatch\n+     > 4 |   return <div className=\"parent\">{!isClient && \"only\"}</div>;\n+         |          ^\",\n+       \"stack\": [\n+         \"div <anonymous> (0:0)\",\n+         \"Mismatch app/page.js (4:10)\",\n+       ],\n+     }\n     `)\n   })\n \n@@ -436,21 +461,16 @@ describe('Error overlay for hydration errors in App router', () => {\n         ],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n+    const { browser } = sandbox\n \n     await retry(async () => {\n-      expect(await getRedboxTotalErrorCount(browser)).toBe(2)\n+      expect(await getToastErrorCount(browser)).toBe(2)\n     })\n \n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(`\n-     \"In HTML, text nodes cannot be a child of <tr>.\n-     This will cause a hydration error.\"\n-    `)\n-\n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     [\n+       {\n+         \"componentStack\": \"...\n          <ScrollAndFocusHandler segmentPath={[...]}>\n            <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n              <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n@@ -466,7 +486,48 @@ describe('Error overlay for hydration errors in App router', () => {\n                                  <tbody>\n                                    <tr>\n      >                               test\n-                           ...\"\n+                           ...\",\n+         \"description\": \"In HTML, text nodes cannot be a child of <tr>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/page.js (6:9) @ Page\n+     > 6 |         <tr>test</tr>\n+         |         ^\",\n+         \"stack\": [\n+           \"tr <anonymous> (0:0)\",\n+           \"Page app/page.js (6:9)\",\n+         ],\n+       },\n+       {\n+         \"componentStack\": \"...\n+         <RenderFromTemplateContext>\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={[...]} forbidden={undefined} unauthorized={undefined}>\n+                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={[...]} forbidden={undefined} ...>\n+                       <RedirectBoundary>\n+                         <RedirectErrorBoundary router={{...}}>\n+                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     +                           <table>\n+     -                           test\n+                             ...\",\n+         \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/page.js (4:5) @ Page\n+     > 4 |     <table>\n+         |     ^\",\n+         \"stack\": [\n+           \"table <anonymous> (0:0)\",\n+           \"Page app/page.js (4:5)\",\n+         ],\n+       },\n+     ]\n     `)\n   })\n \n@@ -490,14 +551,11 @@ describe('Error overlay for hydration errors in App router', () => {\n         ],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n-\n-    expect(await getRedboxTotalErrorCount(browser)).toBe(1)\n+    const { browser } = sandbox\n \n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -513,7 +571,19 @@ describe('Error overlay for hydration errors in App router', () => {\n      >                           <table>\n      >                             {\" \"}\n                                    ...\n-                             ...\"\n+                             ...\",\n+       \"description\": \"In HTML, whitespace text nodes cannot be a child of <table>. Make sure you don't have any extra whitespace between tags on each line of your source code.\n+     This will cause a hydration error.\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Console Error\",\n+       \"source\": \"app/page.js (4:5) @ Page\n+     > 4 |     <table>\n+         |     ^\",\n+       \"stack\": [\n+         \"table <anonymous> (0:0)\",\n+         \"Page app/page.js (4:5)\",\n+       ],\n+     }\n     `)\n   })\n \n@@ -542,12 +612,11 @@ describe('Error overlay for hydration errors in App router', () => {\n         ],\n       ])\n     )\n-    const { session } = sandbox\n-    await session.openRedbox()\n+    const { browser } = sandbox\n \n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     {\n+       \"componentStack\": \"...\n          <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n            <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n              <LoadingBoundary loading={null}>\n@@ -564,12 +633,19 @@ describe('Error overlay for hydration errors in App router', () => {\n      +                           <main className=\"second\">\n      -                           <footer className=\"3\">\n                                  ...\n-                         ...\"\n+                         ...\",\n+       \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n+       \"environmentLabel\": null,\n+       \"label\": \"Runtime Error\",\n+       \"source\": \"app/page.js (9:22) @ Mismatch\n+     >  9 |         {isClient && <main className=\"second\" />}\n+          |                      ^\",\n+       \"stack\": [\n+         \"main <anonymous> (0:0)\",\n+         \"Mismatch app/page.js (9:22)\",\n+       ],\n+     }\n     `)\n-\n-    expect(await session.getRedboxDescription()).toMatchInlineSnapshot(\n-      `\"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\"`\n-    )\n   })\n \n   it('should not show a hydration error when using `useId` in a client component', async () => {\n@@ -598,14 +674,8 @@ describe('Error overlay for hydration errors in App router', () => {\n \n     const { browser } = sandbox\n     const logs = await browser.log()\n-    const errors = logs\n-      .filter((x) => x.source === 'error')\n-      .map((x) => x.message)\n-      .join('\\n')\n-\n-    expect(errors).not.toInclude(\n-      'Warning: Prop `%s` did not match. Server: %s Client: %s'\n-    )\n+    const errors = logs.filter((x) => x.source === 'error')\n+    expect(errors).toEqual([])\n   })\n \n   it('should only show one hydration error when bad nesting happened - p under p', async () => {\n@@ -629,22 +699,16 @@ describe('Error overlay for hydration errors in App router', () => {\n       ])\n     )\n \n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n+    const { browser } = sandbox\n \n     await retry(async () => {\n-      expect(await getRedboxTotalErrorCount(browser)).toBe(2)\n+      expect(await getToastErrorCount(browser)).toBe(2)\n     })\n \n-    const description = await session.getRedboxDescription()\n-    expect(description).toContain(\n-      'In HTML, <p> cannot be a descendant of <p>.\\nThis will cause a hydration error.'\n-    )\n-\n-    const pseudoHtml = await session.getRedboxComponentStack()\n-\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     [\n+       {\n+         \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -659,7 +723,49 @@ describe('Error overlay for hydration errors in App router', () => {\n                                <Page params={Promise} searchParams={Promise}>\n      >                           <p>\n      >                             <p>\n-                             ...\"\n+                             ...\",\n+         \"description\": \"In HTML, <p> cannot be a descendant of <p>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/page.js (6:7) @ Page\n+     > 6 |       <p>Nested p tags</p>\n+         |       ^\",\n+         \"stack\": [\n+           \"p <anonymous> (0:0)\",\n+           \"Page app/page.js (6:7)\",\n+         ],\n+       },\n+       {\n+         \"componentStack\": \"...\n+         <RenderFromTemplateContext>\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={[...]} forbidden={undefined} unauthorized={undefined}>\n+                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={[...]} forbidden={undefined} ...>\n+                       <RedirectBoundary>\n+                         <RedirectErrorBoundary router={{...}}>\n+                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     >                           <p>\n+     >                             <p>\n+                             ...\",\n+         \"description\": \"In HTML, <p> cannot be a descendant of <p>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/page.js (6:7) @ Page\n+     > 6 |       <p>Nested p tags</p>\n+         |       ^\",\n+         \"stack\": [\n+           \"p <anonymous> (0:0)\",\n+           \"Page app/page.js (6:7)\",\n+         ],\n+       },\n+     ]\n     `)\n   })\n \n@@ -688,22 +794,16 @@ describe('Error overlay for hydration errors in App router', () => {\n       ])\n     )\n \n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n+    const { browser } = sandbox\n \n     await retry(async () => {\n-      expect(await getRedboxTotalErrorCount(browser)).toBe(2)\n+      expect(await getToastErrorCount(browser)).toBe(2)\n     })\n \n-    const description = await session.getRedboxDescription()\n-    expect(description).toContain(\n-      'In HTML, <div> cannot be a descendant of <p>.\\nThis will cause a hydration error.'\n-    )\n-\n-    const pseudoHtml = await session.getRedboxComponentStack()\n-\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     [\n+       {\n+         \"componentStack\": \"...\n          <ScrollAndFocusHandler segmentPath={[...]}>\n            <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n              <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n@@ -719,7 +819,50 @@ describe('Error overlay for hydration errors in App router', () => {\n                                  <div>\n      >                             <p>\n      >                               <div>\n-                           ...\"\n+                           ...\",\n+         \"description\": \"In HTML, <div> cannot be a descendant of <p>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/page.js (8:11) @ Page\n+     >  8 |           <div>Nested div under p tag</div>\n+          |           ^\",\n+         \"stack\": [\n+           \"div <anonymous> (0:0)\",\n+           \"Page app/page.js (8:11)\",\n+         ],\n+       },\n+       {\n+         \"componentStack\": \"...\n+         <ScrollAndFocusHandler segmentPath={[...]}>\n+           <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+             <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+               <LoadingBoundary loading={null}>\n+                 <HTTPAccessFallbackBoundary notFound={[...]} forbidden={undefined} unauthorized={undefined}>\n+                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={[...]} forbidden={undefined} ...>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                           <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                             <Page params={Promise} searchParams={Promise}>\n+                               <div>\n+                                 <div>\n+     >                             <p>\n+     >                               <div>\n+                           ...\",\n+         \"description\": \"In HTML, <div> cannot be a descendant of <p>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/page.js (8:11) @ Page\n+     >  8 |           <div>Nested div under p tag</div>\n+          |           ^\",\n+         \"stack\": [\n+           \"div <anonymous> (0:0)\",\n+           \"Page app/page.js (8:11)\",\n+         ],\n+       },\n+     ]\n     `)\n   })\n \n@@ -739,23 +882,45 @@ describe('Error overlay for hydration errors in App router', () => {\n       ])\n     )\n \n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n+    const { browser } = sandbox\n \n     await retry(async () => {\n-      expect(await getRedboxTotalErrorCount(browser)).toBe(2)\n+      expect(await getToastErrorCount(browser)).toBe(2)\n     })\n \n-    const description = await session.getRedboxDescription()\n-    expect(description).toMatchInlineSnapshot(`\n-     \"In HTML, <tr> cannot be a child of <div>.\n-     This will cause a hydration error.\"\n-    `)\n-\n-    const pseudoHtml = await session.getRedboxComponentStack()\n-\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     [\n+       {\n+         \"componentStack\": \"...\n+         <RenderFromTemplateContext>\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={[...]} forbidden={undefined} unauthorized={undefined}>\n+                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={[...]} forbidden={undefined} ...>\n+                       <RedirectBoundary>\n+                         <RedirectErrorBoundary router={{...}}>\n+                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     >                           <div>\n+     >                             <tr>\n+                             ...\",\n+         \"description\": \"In HTML, <tr> cannot be a child of <div>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/page.js (3:15) @ Page\n+     > 3 |   return <div><tr></tr></div>\n+         |               ^\",\n+         \"stack\": [\n+           \"tr <anonymous> (0:0)\",\n+           \"Page app/page.js (3:15)\",\n+         ],\n+       },\n+       {\n+         \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -770,7 +935,20 @@ describe('Error overlay for hydration errors in App router', () => {\n                                <Page params={Promise} searchParams={Promise}>\n      >                           <div>\n      >                             <tr>\n-                             ...\"\n+                             ...\",\n+         \"description\": \"In HTML, <tr> cannot be a child of <div>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/page.js (3:15) @ Page\n+     > 3 |   return <div><tr></tr></div>\n+         |               ^\",\n+         \"stack\": [\n+           \"tr <anonymous> (0:0)\",\n+           \"Page app/page.js (3:15)\",\n+         ],\n+       },\n+     ]\n     `)\n   })\n \n@@ -793,21 +971,16 @@ describe('Error overlay for hydration errors in App router', () => {\n       ])\n     )\n \n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n+    const { browser } = sandbox\n \n     await retry(async () => {\n-      expect(await getRedboxTotalErrorCount(browser)).toBe(3)\n+      expect(await getToastErrorCount(browser)).toBe(3)\n     })\n \n-    const description = await session.getRedboxDescription()\n-    expect(description).toContain(\n-      'In HTML, <p> cannot be a descendant of <p>.\\nThis will cause a hydration error.'\n-    )\n-\n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    expect(pseudoHtml).toMatchInlineSnapshot(`\n-     \"...\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     [\n+       {\n+         \"componentStack\": \"...\n          <RenderFromTemplateContext>\n            <ScrollAndFocusHandler segmentPath={[...]}>\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n@@ -826,7 +999,66 @@ describe('Error overlay for hydration errors in App router', () => {\n                                        <span>\n                                          <span>\n      >                                     <p>\n-                             ...\"\n+                             ...\",\n+         \"description\": \"In HTML, <p> cannot be a descendant of <p>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/page.js (5:32) @ Page\n+     > 5 |     <p><span><span><span><span><p>hello world</p></span></span></span></span></p>\n+         |                                ^\",\n+         \"stack\": [\n+           \"p <anonymous> (0:0)\",\n+           \"Page app/page.js (5:32)\",\n+         ],\n+       },\n+       {\n+         \"description\": \"<p> cannot contain a nested <p>.\n+     See this log for the ancestor stack trace.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/page.js (5:5) @ Page\n+     > 5 |     <p><span><span><span><span><p>hello world</p></span></span></span></span></p>\n+         |     ^\",\n+         \"stack\": [\n+           \"p <anonymous> (0:0)\",\n+           \"Page app/page.js (5:5)\",\n+         ],\n+       },\n+       {\n+         \"componentStack\": \"...\n+         <RenderFromTemplateContext>\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={[...]} forbidden={undefined} unauthorized={undefined}>\n+                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={[...]} forbidden={undefined} ...>\n+                       <RedirectBoundary>\n+                         <RedirectErrorBoundary router={{...}}>\n+                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     >                           <p>\n+                                   <span>\n+                                     <span>\n+                                       <span>\n+                                         <span>\n+     >                                     <p>\n+                             ...\",\n+         \"description\": \"In HTML, <p> cannot be a descendant of <p>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Runtime Error\",\n+         \"source\": \"app/page.js (5:32) @ Page\n+     > 5 |     <p><span><span><span><span><p>hello world</p></span></span></span></span></p>\n+         |                                ^\",\n+         \"stack\": [\n+           \"p <anonymous> (0:0)\",\n+           \"Page app/page.js (5:32)\",\n+         ],\n+       },\n+     ]\n     `)\n   })\n \n@@ -862,25 +1094,73 @@ describe('Error overlay for hydration errors in App router', () => {\n         ],\n       ])\n     )\n-    const { session, browser } = sandbox\n-    await session.openRedbox()\n+    const { browser } = sandbox\n \n     await retry(async () => {\n-      expect(await getRedboxTotalErrorCount(browser)).toBe(\n+      expect(await getToastErrorCount(browser)).toBe(\n         // One error for \"Cannot render a sync or defer <script>\"\n         3\n       )\n     })\n \n-    // TODO: assert on 2nd error being \"In HTML, <script> cannot be a child of <html>.\"\n-    // TODO: assert on 3rd error that's specific to owner stacks\n-    const description = await session.getRedboxDescription()\n-    expect(description).toMatchInlineSnapshot(\n-      `\"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\"`\n-    )\n-\n-    const pseudoHtml = await session.getRedboxComponentStack()\n-    // 1st error has no component context.\n-    expect(pseudoHtml).toMatchInlineSnapshot(`null`)\n+    await expect(browser).toDisplayCollapsedRedbox(`\n+     [\n+       {\n+         \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/layout.js (7:7) @ Layout\n+     >  7 |       <Script\n+          |       ^\",\n+         \"stack\": [\n+           \"Layout app/layout.js (7:7)\",\n+         ],\n+       },\n+       {\n+         \"componentStack\": \"...\n+         <HotReload assetPrefix=\"\" globalError={[...]}>\n+           <AppDevOverlay state={{nextId:1, ...}} globalError={[...]}>\n+             <AppDevOverlayErrorBoundary globalError={[...]} onError={function bound dispatchSetState}>\n+               <ReplaySsrOnlyErrors>\n+               <DevRootHTTPAccessFallbackBoundary>\n+                 <HTTPAccessFallbackBoundary notFound={<NotAllowedRootHTTPFallbackError>}>\n+                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<NotAllowedRootHTTPFallbackError>} ...>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <Head>${isTurbopack ? '\\n                         <script>\\n                         <script>' : ''}\n+                         <Layout>\n+     >                     <html>\n+                             <body>\n+                             <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n+     >                         <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n+                         ...\n+             ...\",\n+         \"description\": \"In HTML, <script> cannot be a child of <html>.\n+     This will cause a hydration error.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/layout.js (7:7) @ Layout\n+     >  7 |       <Script\n+          |       ^\",\n+         \"stack\": [\n+           \"script <anonymous> (0:0)\",\n+           \"Layout app/layout.js (7:7)\",\n+         ],\n+       },\n+       {\n+         \"description\": \"<html> cannot contain a nested <script>.\n+     See this log for the ancestor stack trace.\",\n+         \"environmentLabel\": null,\n+         \"label\": \"Console Error\",\n+         \"source\": \"app/layout.js (5:5) @ Layout\n+     > 5 |     <html>\n+         |     ^\",\n+         \"stack\": [\n+           \"html <anonymous> (0:0)\",\n+           \"Layout app/layout.js (5:5)\",\n+         ],\n+       },\n+     ]\n+    `)\n   })\n })"
        }
    ],
    "stats": {
        "total": 664,
        "additions": 472,
        "deletions": 192
    }
}