{
    "author": "eps1lon",
    "message": "[sourcemaps] Try VM for retrieving source maps first (#81869)",
    "sha": "907501e8f37e59086a1c086d056becf1952f054e",
    "files": [
        {
            "sha": "332957b1ddc649dd5c7567faa5d9244284911d8a",
            "filename": "packages/next/src/server/dev/middleware-turbopack.ts",
            "status": "modified",
            "additions": 16,
            "deletions": 22,
            "changes": 38,
            "blob_url": "https://github.com/vercel/next.js/blob/907501e8f37e59086a1c086d056becf1952f054e/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/907501e8f37e59086a1c086d056becf1952f054e/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fdev%2Fmiddleware-turbopack.ts?ref=907501e8f37e59086a1c086d056becf1952f054e",
            "patch": "@@ -21,8 +21,7 @@ import {\n   devirtualizeReactServerURL,\n   findApplicableSourceMapPayload,\n } from '../lib/source-maps'\n-import { getSourceMapFromFile } from './get-source-map-from-file'\n-import { findSourceMap } from 'node:module'\n+import { findSourceMap, type SourceMap } from 'node:module'\n import { fileURLToPath, pathToFileURL } from 'node:url'\n import { inspect } from 'node:util'\n \n@@ -419,19 +418,22 @@ export function getSourceMapMiddleware(project: Project) {\n       return middlewareResponse.badRequest(res)\n     }\n \n-    // TODO(veil): Always try the native version first.\n-    // Externals could also be files that aren't bundled via Webpack.\n-    if (\n-      filename.startsWith('webpack://') ||\n-      filename.startsWith('webpack-internal:///')\n-    ) {\n-      const sourceMap = findSourceMap(filename)\n-\n-      if (sourceMap) {\n-        return middlewareResponse.json(res, sourceMap.payload)\n-      }\n+    let nativeSourceMap: SourceMap | undefined\n+    try {\n+      nativeSourceMap = findSourceMap(filename)\n+    } catch (cause) {\n+      return middlewareResponse.internalServerError(\n+        res,\n+        new Error(\n+          `${filename}: Invalid source map. Only conformant source maps can be used to find the original code.`,\n+          { cause }\n+        )\n+      )\n+    }\n \n-      return middlewareResponse.noContent(res)\n+    if (nativeSourceMap !== undefined) {\n+      const sourceMapPayload = nativeSourceMap.payload\n+      return middlewareResponse.json(res, sourceMapPayload)\n     }\n \n     try {\n@@ -451,14 +453,6 @@ export function getSourceMapMiddleware(project: Project) {\n       if (sourceMapString) {\n         return middlewareResponse.jsonString(res, sourceMapString)\n       }\n-\n-      if (filename.startsWith('file:')) {\n-        const sourceMap = await getSourceMapFromFile(filename)\n-\n-        if (sourceMap) {\n-          return middlewareResponse.json(res, sourceMap)\n-        }\n-      }\n     } catch (cause) {\n       return middlewareResponse.internalServerError(\n         res,"
        }
    ],
    "stats": {
        "total": 38,
        "additions": 16,
        "deletions": 22
    }
}