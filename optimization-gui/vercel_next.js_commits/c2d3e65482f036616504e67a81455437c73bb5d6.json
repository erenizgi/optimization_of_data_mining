{
    "author": "unstubbable",
    "message": "[test] Do not use sandboxes for hydration error tests (#83398)\n\nThe sandboxes used in the `Error overlay for hydration errors in App\nrouter` test suite frequently lead to timeout errors in CI\n([DD](https://app.datadoghq.com/ci/test/runs?query=test_level%3Atest%20%40git.repository.id%3A%22github.com%2Fvercel%2Fnext.js%22%20%40test.type%3A%22nextjs%22%20%40test.status%3A%22fail%22%20%40git.branch%3Acanary%20%40test.suite%3A%22Error%20overlay%20for%20hydration%20errors%20in%20App%20router%22&agg_m=count&agg_m_source=base&agg_t=count&currentTab=overview&eventStack=&fromUser=false&index=citest&start=1755633071704&end=1756929071704&paused=false))\nand also make it unnecessarily complicated to run the scenarios locally\nwith `pnpm next dev`. I also have a suspicion that the sandboxes are not\nproperly cleaning up after themselves, leading to test interference.\n\nBy saving the inlined layouts and pages to actual files, we can avoid\nthe issues caused by sandboxes and make the tests faster, more reliable,\nand easier to debug.",
    "sha": "c2d3e65482f036616504e67a81455437c73bb5d6",
    "files": [
        {
            "sha": "8ece71173b3bef5314ed65351674c66a50daaaf6",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/bad-nesting/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fbad-nesting%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fbad-nesting%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fbad-nesting%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,17 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <p>\n+      <span>\n+        <span>\n+          <span>\n+            <span>\n+              <p>hello world</p>\n+            </span>\n+          </span>\n+        </span>\n+      </span>\n+    </p>\n+  )\n+}"
        },
        {
            "sha": "4108a03bffcda7281e12ac3f45bf34052ad839f3",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/div-under-p/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fdiv-under-p%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fdiv-under-p%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fdiv-under-p%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <div>\n+        <p>\n+          <div>Nested div under p tag</div>\n+        </p>\n+      </div>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "6103a7df9986b891ed015558a26d0468d6f38466",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/extra-element-client/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-element-client%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-element-client%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-element-client%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+const isClient = typeof window !== 'undefined'\n+\n+export default function Mismatch() {\n+  return <div className=\"parent\">{isClient && <main className=\"only\" />}</div>\n+}"
        },
        {
            "sha": "5332bd1d8b19a23f256ca6d702e5f06d03c8f73e",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/extra-element-server/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-element-server%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-element-server%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-element-server%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+const isServer = typeof window === 'undefined'\n+\n+export default function Mismatch() {\n+  return <div className=\"parent\">{isServer && <main className=\"only\" />}</div>\n+}"
        },
        {
            "sha": "ace45f467a36e4d6580efa59a19a5dd44db442c4",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/extra-node-suspense/page.tsx",
            "status": "added",
            "additions": 17,
            "deletions": 0,
            "changes": 17,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-node-suspense%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-node-suspense%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-node-suspense%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,17 @@\n+'use client'\n+\n+import React from 'react'\n+\n+const isClient = typeof window !== 'undefined'\n+\n+export default function Mismatch() {\n+  return (\n+    <div className=\"parent\">\n+      <React.Suspense fallback={<p>Loading...</p>}>\n+        <header className=\"1\" />\n+        {isClient && <main className=\"second\" />}\n+        <footer className=\"3\" />\n+      </React.Suspense>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "a649fa903e2c825571248b04767b3b3948ea7850",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/extra-text-node-client/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-client%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-client%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-client%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+const isClient = typeof window !== 'undefined'\n+\n+export default function Mismatch() {\n+  return (\n+    <div className=\"parent\">\n+      <header className=\"1\" />\n+      {isClient && 'second'}\n+      <footer className=\"3\" />\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "018c5641d9f195a65e7170b0a732c8cdc4bca9e2",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/extra-text-node-invalid-place/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-invalid-place%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-invalid-place%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-invalid-place%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,11 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <table>\n+      <tbody>\n+        <tr>test</tr>\n+      </tbody>\n+    </table>\n+  )\n+}"
        },
        {
            "sha": "70904f4ec00a3d3a615a91079ab19621639eecbe",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/extra-text-node-server/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-server%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-server%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-text-node-server%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+const isServer = typeof window === 'undefined'\n+\n+export default function Mismatch() {\n+  return <div className=\"parent\">{isServer && 'only'}</div>\n+}"
        },
        {
            "sha": "cf745a9525b124cf23af57e42149f83fa8131c5a",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/extra-whitespace-invalid-place/page.tsx",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-whitespace-invalid-place%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-whitespace-invalid-place%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fextra-whitespace-invalid-place%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,10 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <table>\n+      {' '}\n+      <tbody></tbody>\n+    </table>\n+  )\n+}"
        },
        {
            "sha": "888614deda3ba5d744d1a7e5dac131038dba2b12",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/layout.tsx",
            "status": "added",
            "additions": 8,
            "deletions": 0,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Flayout.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,8 @@\n+import { ReactNode } from 'react'\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "bca49153cd046ecc966bc6c3509fd77a35976bb6",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/p-under-p/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fp-under-p%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fp-under-p%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fp-under-p%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,9 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <p>\n+      <p>Nested p tags</p>\n+    </p>\n+  )\n+}"
        },
        {
            "sha": "6f9145ef10e5df6c1a6eaafa8864c70b3e3d967a",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/text-mismatch/page.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Ftext-mismatch%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Ftext-mismatch%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Ftext-mismatch%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,11 @@\n+'use client'\n+\n+const isClient = typeof window !== 'undefined'\n+\n+export default function Mismatch() {\n+  return (\n+    <div className=\"parent\">\n+      <main className=\"child\">{isClient ? 'client' : 'server'}</main>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "1ceab61b8854bc8d83ad7fe45d2d43cea47bba18",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/tr-under-div/page.tsx",
            "status": "added",
            "additions": 9,
            "deletions": 0,
            "changes": 9,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Ftr-under-div%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Ftr-under-div%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Ftr-under-div%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,9 @@\n+'use client'\n+\n+export default function Page() {\n+  return (\n+    <div>\n+      <tr></tr>\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "3ad544c5f9a2838c5dc9c9659e2529cc47447833",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(default)/use-id/page.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fuse-id%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fuse-id%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(default)%2Fuse-id%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+import { useId } from 'react'\n+\n+export default function Page() {\n+  let id = useId()\n+\n+  return (\n+    <div className=\"parent\" data-id={id}>\n+      Hello World\n+    </div>\n+  )\n+}"
        },
        {
            "sha": "9c4a21008113f0a96bcda2d35adc01b20f056cc2",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(extra-attributes)/extra-attributes/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(extra-attributes)%2Fextra-attributes%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(extra-attributes)%2Fextra-attributes%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(extra-attributes)%2Fextra-attributes%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return 'page'\n+}"
        },
        {
            "sha": "3235d08484c51ca4a44073fde33b009380bcee2b",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(extra-attributes)/layout.tsx",
            "status": "added",
            "additions": 13,
            "deletions": 0,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(extra-attributes)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(extra-attributes)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(extra-attributes)%2Flayout.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,13 @@\n+'use client'\n+\n+import { ReactNode } from 'react'\n+\n+const isServer = typeof window === 'undefined'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html {...(isServer ? { className: 'server-html' } : undefined)}>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "9ff95025d67a258719ac9e762cc1235640f303b4",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(script-under-html)/layout.tsx",
            "status": "added",
            "additions": 14,
            "deletions": 0,
            "changes": 14,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(script-under-html)%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(script-under-html)%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(script-under-html)%2Flayout.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,14 @@\n+import Script from 'next/script'\n+import { ReactNode } from 'react'\n+\n+export default function Root({ children }: { children: ReactNode }) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+      <Script\n+        src=\"https://example.com/script.js\"\n+        strategy=\"beforeInteractive\"\n+      />\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "0bd21c5bac776b2207e1e01878c12fde935a2dde",
            "filename": "test/development/acceptance-app/fixtures/hydration-errors/app/(script-under-html)/script-under-html/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(script-under-html)%2Fscript-under-html%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(script-under-html)%2Fscript-under-html%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Ffixtures%2Fhydration-errors%2Fapp%2F(script-under-html)%2Fscript-under-html%2Fpage.tsx?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <div>Hello World</div>\n+}"
        },
        {
            "sha": "fb8fe83f5a13158882421862c16fbe465f0872cb",
            "filename": "test/development/acceptance-app/hydration-error.test.ts",
            "status": "modified",
            "additions": 359,
            "deletions": 657,
            "changes": 1016,
            "blob_url": "https://github.com/vercel/next.js/blob/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c2d3e65482f036616504e67a81455437c73bb5d6/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fdevelopment%2Facceptance-app%2Fhydration-error.test.ts?ref=c2d3e65482f036616504e67a81455437c73bb5d6",
            "patch": "@@ -1,39 +1,24 @@\n /* eslint-env jest */\n-import { createSandbox } from 'development-sandbox'\n import { FileRef, nextTestSetup } from 'e2e-utils'\n import path from 'path'\n import { outdent } from 'outdent'\n-import { getToastErrorCount, retry } from 'next-test-utils'\n+import {\n+  assertNoRedbox,\n+  getRedboxErrorLink,\n+  getToastErrorCount,\n+  retry,\n+} from 'next-test-utils'\n \n describe('Error overlay for hydration errors in App router', () => {\n   const { next, isTurbopack } = nextTestSetup({\n-    files: new FileRef(path.join(__dirname, 'fixtures', 'default-template')),\n-    skipStart: true,\n+    files: new FileRef(path.join(__dirname, 'fixtures', 'hydration-errors')),\n   })\n \n   it('includes a React docs link when hydration error does occur', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            const isClient = typeof window !== 'undefined'\n-            export default function Mismatch() {\n-              return (\n-                <div className=\"parent\">\n-                  <main className=\"child\">{isClient ? \"client\" : \"server\"}</main>\n-                </div>\n-              );\n-            }\n-          `,\n-        ],\n-      ]),\n-      '/',\n-      { pushErrorAsConsoleLog: true }\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/text-mismatch', {\n+      pushErrorAsConsoleLog: true,\n+    })\n+\n     const logs = await browser.log()\n     expect(logs).toEqual(\n       expect.arrayContaining([\n@@ -49,40 +34,21 @@ describe('Error overlay for hydration errors in App router', () => {\n   })\n \n   it('should show correct hydration error when client and server render different text', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            const isClient = typeof window !== 'undefined'\n-            export default function Mismatch() {\n-              return (\n-                <div className=\"parent\">\n-                  <main className=\"child\">{isClient ? \"client\" : \"server\"}</main>\n-                </div>\n-              );\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { session, browser } = sandbox\n+    const browser = await next.browser('/text-mismatch')\n \n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n        \"componentStack\": \"...\n-         <ScrollAndFocusHandler segmentPath={[...]}>\n-           <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-             <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-               <LoadingBoundary loading={null}>\n-                 <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n+         <RenderFromTemplateContext>\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                      <RedirectBoundary>\n                        <RedirectErrorBoundary router={{...}}>\n-                         <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                           <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n+                         <InnerLayoutRouter url=\"/text-mism...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                              <SegmentTrieNode>\n                              <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n                                <Mismatch params={Promise} searchParams={Promise}>\n@@ -92,25 +58,26 @@ describe('Error overlay for hydration errors in App router', () => {\n      -                               server\n                            ...\n                          ...\n-             ...\",\n+               ...\",\n        \"description\": \"Hydration failed because the server rendered text didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n        \"environmentLabel\": null,\n        \"label\": \"Recoverable Error\",\n-       \"source\": \"app/page.js (6:7) @ Mismatch\n-     > 6 |       <main className=\"child\">{isClient ? \"client\" : \"server\"}</main>\n-         |       ^\",\n+       \"source\": \"app/(default)/text-mismatch/page.tsx (8:7) @ Mismatch\n+     >  8 |       <main className=\"child\">{isClient ? 'client' : 'server'}</main>\n+          |       ^\",\n        \"stack\": [\n          \"main <anonymous>\",\n-         \"Mismatch app/page.js (6:7)\",\n+         \"Mismatch app/(default)/text-mismatch/page.tsx (8:7)\",\n        ],\n      }\n     `)\n-    expect(await session.getRedboxErrorLink()).toMatchInlineSnapshot(\n+\n+    expect(await getRedboxErrorLink(browser)).toMatchInlineSnapshot(\n       `\"See more info here: https://nextjs.org/docs/messages/react-hydration-error\"`\n     )\n \n-    await session.patch(\n-      'app/page.js',\n+    await next.patchFile(\n+      'app/(default)/text-mismatch/page.tsx',\n       outdent`\n       'use client'\n       export default function Mismatch() {\n@@ -120,206 +87,146 @@ describe('Error overlay for hydration errors in App router', () => {\n           </div>\n         );\n       }\n-    `\n+    `,\n+      async () => {\n+        await assertNoRedbox(browser)\n+        expect(await browser.elementByCss('.child').text()).toBe('Value')\n+      }\n     )\n-\n-    await session.assertNoRedbox()\n-\n-    expect(await browser.elementByCss('.child').text()).toBe('Value')\n   })\n \n   it('should show correct hydration error when client renders an extra element', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            const isClient = typeof window !== 'undefined'\n-            export default function Mismatch() {\n-              return (\n-                <div className=\"parent\">\n-                  {isClient && <main className=\"only\" />}\n-                </div>\n-              );\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/extra-element-client')\n \n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n        \"componentStack\": \"...\n-         <ScrollAndFocusHandler segmentPath={[...]}>\n-           <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-             <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-               <LoadingBoundary loading={null}>\n-                 <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n+         <RenderFromTemplateContext>\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                      <RedirectBoundary>\n                        <RedirectErrorBoundary router={{...}}>\n-                         <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                           <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n+                         <InnerLayoutRouter url=\"/extra-ele...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                              <SegmentTrieNode>\n                              <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n                                <Mismatch params={Promise} searchParams={Promise}>\n                                  <div className=\"parent\">\n      +                             <main className=\"only\">\n                            ...\n                          ...\n-             ...\",\n+               ...\",\n        \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n        \"environmentLabel\": null,\n        \"label\": \"Recoverable Error\",\n-       \"source\": \"app/page.js (6:20) @ Mismatch\n-     > 6 |       {isClient && <main className=\"only\" />}\n-         |                    ^\",\n+       \"source\": \"app/(default)/extra-element-client/page.tsx (6:47) @ Mismatch\n+     > 6 |   return <div className=\"parent\">{isClient && <main className=\"only\" />}</div>\n+         |                                               ^\",\n        \"stack\": [\n          \"main <anonymous>\",\n-         \"Mismatch app/page.js (6:20)\",\n+         \"Mismatch app/(default)/extra-element-client/page.tsx (6:47)\",\n        ],\n      }\n     `)\n   })\n \n   it('should show correct hydration error when extra attributes set on server', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/layout.js',\n-          outdent`\n-          'use client'\n-          const isServer = typeof window === 'undefined'\n-          export default function Root({ children }) {\n-            return (\n-              <html \n-                {...(isServer ? ({ className: 'server-html'}) : undefined)}\n-              >\n-                <body>{children}</body>\n-              </html>\n-            )\n-          }\n-          `,\n-        ],\n-        ['app/page.js', `export default function Page() { return 'page' }`],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/extra-attributes')\n \n     if (isTurbopack) {\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n          \"componentStack\": \"...\n-           <HotReload globalError={[...]} webSocket={WebSocket} staticIndicatorState={{pathname:null, ...}}>\n-             <AppDevOverlayErrorBoundary globalError={[...]}>\n-               <ReplaySsrOnlyErrors>\n-               <DevRootHTTPAccessFallbackBoundary>\n-                 <HTTPAccessFallbackBoundary notFound={<NotAllowedRootHTTPFallbackError>}>\n-                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<NotAllowedRootHTTPFallbackError>} ...>\n-                     <RedirectBoundary>\n-                       <RedirectErrorBoundary router={{...}}>\n-                         <Head>\n-                         <__next_root_layout_boundary__>\n-                           <SegmentViewNode type=\"layout\" pagePath=\"layout.js\">\n-                             <SegmentTrieNode>\n-                             <script>\n-                             <script>\n-                             <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n-                               <Root params={Promise}>\n-                                 <html\n-       -                           className=\"server-html\"\n-                                 >\n-                         ...\",\n+           <RenderFromTemplateContext>\n+             <ScrollAndFocusHandler segmentPath={[...]}>\n+               <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+                 <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                   <LoadingBoundary loading={null}>\n+                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n+                       <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={<SegmentViewNode>} ...>\n+                         <RedirectBoundary>\n+                           <RedirectErrorBoundary router={{...}}>\n+                             <InnerLayoutRouter url=\"/extra-att...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                               <SegmentViewNode type=\"layout\" pagePath=\"(extra-att...\">\n+                                 <SegmentTrieNode>\n+                                 <script>\n+                                 <script>\n+                                 <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n+                                   <Root params={Promise}>\n+                                     <html\n+       -                               className=\"server-html\"\n+                                     >\n+                             ...\n+                 ...\",\n          \"description\": \"A tree hydrated but some attributes of the server rendered HTML didn't match the client properties. This won't be patched up. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n-         \"source\": \"app/layout.js (5:5) @ Root\n-       > 5 |     <html\n-           |     ^\",\n+         \"source\": \"app/(extra-attributes)/layout.tsx (9:5) @ Root\n+       >  9 |     <html {...(isServer ? { className: 'server-html' } : undefined)}>\n+            |     ^\",\n          \"stack\": [\n            \"html <anonymous>\",\n-           \"Root app/layout.js (5:5)\",\n+           \"Root app/(extra-attributes)/layout.tsx (9:5)\",\n          ],\n        }\n       `)\n     } else {\n       await expect(browser).toDisplayCollapsedRedbox(`\n        {\n          \"componentStack\": \"...\n-           <HotReload globalError={[...]} webSocket={WebSocket} staticIndicatorState={{pathname:null, ...}}>\n-             <AppDevOverlayErrorBoundary globalError={[...]}>\n-               <ReplaySsrOnlyErrors>\n-               <DevRootHTTPAccessFallbackBoundary>\n-                 <HTTPAccessFallbackBoundary notFound={<NotAllowedRootHTTPFallbackError>}>\n-                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<NotAllowedRootHTTPFallbackError>} ...>\n-                     <RedirectBoundary>\n-                       <RedirectErrorBoundary router={{...}}>\n-                         <Head>\n-                         <__next_root_layout_boundary__>\n-                           <SegmentViewNode type=\"layout\" pagePath=\"layout.js\">\n-                             <SegmentTrieNode>\n-                             <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n-                               <Root params={Promise}>\n-                                 <html\n-       -                           className=\"server-html\"\n-                                 >\n-                         ...\",\n+           <RenderFromTemplateContext>\n+             <ScrollAndFocusHandler segmentPath={[...]}>\n+               <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+                 <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                   <LoadingBoundary loading={null}>\n+                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n+                       <HTTPAccessFallbackErrorBoundary pathname=\"/extra-att...\" notFound={<SegmentViewNode>} ...>\n+                         <RedirectBoundary>\n+                           <RedirectErrorBoundary router={{...}}>\n+                             <InnerLayoutRouter url=\"/extra-att...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                               <SegmentViewNode type=\"layout\" pagePath=\"(extra-att...\">\n+                                 <SegmentTrieNode>\n+                                 <ClientSegmentRoot Component={function Root} slots={{...}} params={{}}>\n+                                   <Root params={Promise}>\n+                                     <html\n+       -                               className=\"server-html\"\n+                                     >\n+                             ...\n+                 ...\",\n          \"description\": \"A tree hydrated but some attributes of the server rendered HTML didn't match the client properties. This won't be patched up. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n-         \"source\": \"app/layout.js (5:5) @ Root\n-       > 5 |     <html\n-           |     ^\",\n+         \"source\": \"app/(extra-attributes)/layout.tsx (9:5) @ Root\n+       >  9 |     <html {...(isServer ? { className: 'server-html' } : undefined)}>\n+            |     ^\",\n          \"stack\": [\n            \"html <anonymous>\",\n-           \"Root app/layout.js (5:5)\",\n+           \"Root app/(extra-attributes)/layout.tsx (9:5)\",\n          ],\n        }\n       `)\n     }\n   })\n \n   it('should show correct hydration error when client renders an extra text node', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            const isClient = typeof window !== 'undefined'\n-            export default function Mismatch() {\n-              return (\n-                <div className=\"parent\">\n-                  <header className=\"1\" />\n-                  {isClient && \"second\"}\n-                  <footer className=\"3\" />\n-                </div>\n-              );\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/extra-text-node-client')\n \n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n        \"componentStack\": \"...\n-         <ScrollAndFocusHandler segmentPath={[...]}>\n-           <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-             <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-               <LoadingBoundary loading={null}>\n-                 <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n+         <RenderFromTemplateContext>\n+           <ScrollAndFocusHandler segmentPath={[...]}>\n+             <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+               <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                 <LoadingBoundary loading={null}>\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                      <RedirectBoundary>\n                        <RedirectErrorBoundary router={{...}}>\n-                         <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                           <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n+                         <InnerLayoutRouter url=\"/extra-tex...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                              <SegmentTrieNode>\n                              <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n                                <Mismatch params={Promise} searchParams={Promise}>\n@@ -330,42 +237,23 @@ describe('Error overlay for hydration errors in App router', () => {\n                                    ...\n                            ...\n                          ...\n-             ...\",\n+               ...\",\n        \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n        \"environmentLabel\": null,\n        \"label\": \"Recoverable Error\",\n-       \"source\": \"app/page.js (5:5) @ Mismatch\n-     > 5 |     <div className=\"parent\">\n-         |     ^\",\n+       \"source\": \"app/(default)/extra-text-node-client/page.tsx (7:5) @ Mismatch\n+     >  7 |     <div className=\"parent\">\n+          |     ^\",\n        \"stack\": [\n          \"div <anonymous>\",\n-         \"Mismatch app/page.js (5:5)\",\n+         \"Mismatch app/(default)/extra-text-node-client/page.tsx (7:5)\",\n        ],\n      }\n     `)\n   })\n \n   it('should show correct hydration error when server renders an extra element', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            const isClient = typeof window !== 'undefined'\n-            export default function Mismatch() {\n-              return (\n-                <div className=\"parent\">\n-                  {!isClient && <main className=\"only\" />}\n-                </div>\n-              );\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/extra-element-server')\n \n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n@@ -375,51 +263,35 @@ describe('Error overlay for hydration errors in App router', () => {\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                  <LoadingBoundary loading={null}>\n-                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n-                       <RedirectBoundary>\n-                         <RedirectErrorBoundary router={{...}}>\n-                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                             <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n-                               <SegmentTrieNode>\n-                               <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n-                                 <Mismatch params={Promise} searchParams={Promise}>\n-                                   <div className=\"parent\">\n-     -                               <main className=\"only\">\n-                             ...\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <InnerLayoutRouter url=\"/extra-ele...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n+                             <SegmentTrieNode>\n+                             <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n+                               <Mismatch params={Promise} searchParams={Promise}>\n+                                 <div className=\"parent\">\n+     -                             <main className=\"only\">\n                            ...\n+                         ...\n                ...\",\n        \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n        \"environmentLabel\": null,\n        \"label\": \"Recoverable Error\",\n-       \"source\": \"app/page.js (5:5) @ Mismatch\n-     > 5 |     <div className=\"parent\">\n-         |     ^\",\n+       \"source\": \"app/(default)/extra-element-server/page.tsx (6:10) @ Mismatch\n+     > 6 |   return <div className=\"parent\">{isServer && <main className=\"only\" />}</div>\n+         |          ^\",\n        \"stack\": [\n          \"div <anonymous>\",\n-         \"Mismatch app/page.js (5:5)\",\n+         \"Mismatch app/(default)/extra-element-server/page.tsx (6:10)\",\n        ],\n      }\n     `)\n   })\n \n   it('should show correct hydration error when server renders an extra text node', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            const isClient = typeof window !== 'undefined'\n-            export default function Mismatch() {\n-              return <div className=\"parent\">{!isClient && \"only\"}</div>;\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/extra-text-node-server')\n \n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n@@ -429,56 +301,35 @@ describe('Error overlay for hydration errors in App router', () => {\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                  <LoadingBoundary loading={null}>\n-                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n-                       <RedirectBoundary>\n-                         <RedirectErrorBoundary router={{...}}>\n-                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                             <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n-                               <SegmentTrieNode>\n-                               <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n-                                 <Mismatch params={Promise} searchParams={Promise}>\n-                                   <div className=\"parent\">\n-     -                               only\n-                             ...\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <InnerLayoutRouter url=\"/extra-tex...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n+                             <SegmentTrieNode>\n+                             <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n+                               <Mismatch params={Promise} searchParams={Promise}>\n+                                 <div className=\"parent\">\n+     -                             only\n                            ...\n+                         ...\n                ...\",\n        \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n        \"environmentLabel\": null,\n        \"label\": \"Recoverable Error\",\n-       \"source\": \"app/page.js (4:10) @ Mismatch\n-     > 4 |   return <div className=\"parent\">{!isClient && \"only\"}</div>;\n+       \"source\": \"app/(default)/extra-text-node-server/page.tsx (6:10) @ Mismatch\n+     > 6 |   return <div className=\"parent\">{isServer && 'only'}</div>\n          |          ^\",\n        \"stack\": [\n          \"div <anonymous>\",\n-         \"Mismatch app/page.js (4:10)\",\n+         \"Mismatch app/(default)/extra-text-node-server/page.tsx (6:10)\",\n        ],\n      }\n     `)\n   })\n \n   it('should show correct hydration error when server renders an extra text node in an invalid place', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            export default function Page() {\n-              return (\n-                <table>\n-                  <tbody>\n-                    <tr>test</tr>\n-                  </tbody>\n-                </table>\n-              )\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/extra-text-node-invalid-place')\n \n     await retry(async () => {\n       expect(await getToastErrorCount(browser)).toBe(2)\n@@ -488,15 +339,15 @@ describe('Error overlay for hydration errors in App router', () => {\n      [\n        {\n          \"componentStack\": \"...\n-         <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-           <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-             <LoadingBoundary loading={null}>\n-               <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                 <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n+         <ScrollAndFocusHandler segmentPath={[...]}>\n+           <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+             <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+               <LoadingBoundary loading={null}>\n+                 <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                    <RedirectBoundary>\n                      <RedirectErrorBoundary router={{...}}>\n-                       <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                         <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n+                       <InnerLayoutRouter url=\"/extra-tex...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                         <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                            <SegmentTrieNode>\n                            <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n                              <Page params={Promise} searchParams={Promise}>\n@@ -506,17 +357,17 @@ describe('Error overlay for hydration errors in App router', () => {\n      >                               test\n                          ...\n                        ...\n-           ...\",\n+             ...\",\n          \"description\": \"In HTML, text nodes cannot be a child of <tr>.\n      This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n-         \"source\": \"app/page.js (6:9) @ Page\n-     > 6 |         <tr>test</tr>\n-         |         ^\",\n+         \"source\": \"app/(default)/extra-text-node-invalid-place/page.tsx (7:9) @ Page\n+     >  7 |         <tr>test</tr>\n+          |         ^\",\n          \"stack\": [\n            \"tr <anonymous>\",\n-           \"Page app/page.js (6:9)\",\n+           \"Page app/(default)/extra-text-node-invalid-place/page.tsx (7:9)\",\n          ],\n        },\n        {\n@@ -526,56 +377,36 @@ describe('Error overlay for hydration errors in App router', () => {\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                  <LoadingBoundary loading={null}>\n-                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n-                       <RedirectBoundary>\n-                         <RedirectErrorBoundary router={{...}}>\n-                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                             <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n-                               <SegmentTrieNode>\n-                               <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n-                                 <Page params={Promise} searchParams={Promise}>\n-     +                             <table>\n-     -                             test\n-                             ...\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <InnerLayoutRouter url=\"/extra-tex...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n+                             <SegmentTrieNode>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     +                           <table>\n+     -                           test\n                            ...\n+                         ...\n                ...\",\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Recoverable Error\",\n-         \"source\": \"app/page.js (4:5) @ Page\n-     > 4 |     <table>\n+         \"source\": \"app/(default)/extra-text-node-invalid-place/page.tsx (5:5) @ Page\n+     > 5 |     <table>\n          |     ^\",\n          \"stack\": [\n            \"table <anonymous>\",\n-           \"Page app/page.js (4:5)\",\n+           \"Page app/(default)/extra-text-node-invalid-place/page.tsx (5:5)\",\n          ],\n        },\n      ]\n     `)\n   })\n \n   it('should show correct hydration error when server renders an extra whitespace in an invalid place', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            export default function Page() {\n-              return (\n-                <table>\n-                  {' '}\n-                  <tbody></tbody>\n-                </table>\n-              )\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/extra-whitespace-invalid-place')\n \n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n@@ -585,74 +416,49 @@ describe('Error overlay for hydration errors in App router', () => {\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                  <LoadingBoundary loading={null}>\n-                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n-                       <RedirectBoundary>\n-                         <RedirectErrorBoundary router={{...}}>\n-                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                             <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n-                               <SegmentTrieNode>\n-                               <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n-                                 <Page params={Promise} searchParams={Promise}>\n-     >                             <table>\n-     >                               {\" \"}\n-                                     ...\n-                             ...\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <InnerLayoutRouter url=\"/extra-whi...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n+                             <SegmentTrieNode>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     >                           <table>\n+     >                             {\" \"}\n+                                   ...\n                            ...\n+                         ...\n                ...\",\n        \"description\": \"In HTML, whitespace text nodes cannot be a child of <table>. Make sure you don't have any extra whitespace between tags on each line of your source code.\n      This will cause a hydration error.\",\n        \"environmentLabel\": null,\n        \"label\": \"Console Error\",\n-       \"source\": \"app/page.js (4:5) @ Page\n-     > 4 |     <table>\n+       \"source\": \"app/(default)/extra-whitespace-invalid-place/page.tsx (5:5) @ Page\n+     > 5 |     <table>\n          |     ^\",\n        \"stack\": [\n          \"table <anonymous>\",\n-         \"Page app/page.js (4:5)\",\n+         \"Page app/(default)/extra-whitespace-invalid-place/page.tsx (5:5)\",\n        ],\n      }\n     `)\n   })\n \n   it('should show correct hydration error when client renders an extra node inside Suspense content', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            import React from \"react\"\n-            const isClient = typeof window !== 'undefined'\n-            export default function Mismatch() {\n-              return (\n-                <div className=\"parent\">\n-                  <React.Suspense fallback={<p>Loading...</p>}>\n-                    <header className=\"1\" />\n-                    {isClient && <main className=\"second\" />}\n-                    <footer className=\"3\" />\n-                  </React.Suspense>\n-                </div>\n-              );\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/extra-node-suspense')\n \n     await expect(browser).toDisplayCollapsedRedbox(`\n      {\n        \"componentStack\": \"...\n-         <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-           <LoadingBoundary loading={null}>\n-             <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-               <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n+         <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+           <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+             <LoadingBoundary loading={null}>\n+               <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                  <RedirectBoundary>\n                    <RedirectErrorBoundary router={{...}}>\n-                     <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                       <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n+                     <InnerLayoutRouter url=\"/extra-nod...\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                       <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                          <SegmentTrieNode>\n                          <ClientPageRoot Component={function Mismatch} searchParams={{}} params={{}}>\n                            <Mismatch params={Promise} searchParams={Promise}>\n@@ -663,73 +469,34 @@ describe('Error overlay for hydration errors in App router', () => {\n      -                           <footer className=\"3\">\n                                  ...\n                        ...\n-                     ...\",\n+                     ...\n+           ...\",\n        \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n        \"environmentLabel\": null,\n        \"label\": \"Recoverable Error\",\n-       \"source\": \"app/page.js (9:22) @ Mismatch\n-     >  9 |         {isClient && <main className=\"second\" />}\n+       \"source\": \"app/(default)/extra-node-suspense/page.tsx (12:22) @ Mismatch\n+     > 12 |         {isClient && <main className=\"second\" />}\n           |                      ^\",\n        \"stack\": [\n          \"main <anonymous>\",\n-         \"Mismatch app/page.js (9:22)\",\n+         \"Mismatch app/(default)/extra-node-suspense/page.tsx (12:22)\",\n        ],\n      }\n     `)\n   })\n \n   it('should not show a hydration error when using `useId` in a client component', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-\n-            import { useId } from \"react\"\n-\n-            export default function Page() {\n-              let id = useId();\n-              return (\n-                <div className=\"parent\" data-id={id}>\n-                  Hello World\n-                </div>\n-              );\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n+    const browser = await next.browser('/use-id', {\n+      pushErrorAsConsoleLog: true,\n+    })\n \n-    const { browser } = sandbox\n     const logs = await browser.log()\n     const errors = logs.filter((x) => x.source === 'error')\n     expect(errors).toEqual([])\n   })\n \n   it('should only show one hydration error when bad nesting happened - p under p', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-\n-            export default function Page() {\n-              return (\n-                <p>\n-                  <p>Nested p tags</p>\n-                </p>\n-              )\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-\n-    const { browser } = sandbox\n+    const browser = await next.browser('/p-under-p')\n \n     await retry(async () => {\n       expect(await getToastErrorCount(browser)).toBe(2)\n@@ -744,74 +511,49 @@ describe('Error overlay for hydration errors in App router', () => {\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                  <LoadingBoundary loading={null}>\n-                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n-                       <RedirectBoundary>\n-                         <RedirectErrorBoundary router={{...}}>\n-                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                             <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n-                               <SegmentTrieNode>\n-                               <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n-                                 <Page params={Promise} searchParams={Promise}>\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <InnerLayoutRouter url=\"/p-under-p\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n+                             <SegmentTrieNode>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     >                           <p>\n      >                             <p>\n-     >                               <p>\n-                             ...\n                            ...\n+                         ...\n                ...\",\n          \"description\": \"In HTML, <p> cannot be a descendant of <p>.\n      This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n-         \"source\": \"app/page.js (6:7) @ Page\n+         \"source\": \"app/(default)/p-under-p/page.tsx (6:7) @ Page\n      > 6 |       <p>Nested p tags</p>\n          |       ^\",\n          \"stack\": [\n            \"p <anonymous>\",\n-           \"Page app/page.js (6:7)\",\n+           \"Page app/(default)/p-under-p/page.tsx (6:7)\",\n          ],\n        },\n        {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Recoverable Error\",\n-         \"source\": \"app/page.js (6:7) @ Page\n+         \"source\": \"app/(default)/p-under-p/page.tsx (6:7) @ Page\n      > 6 |       <p>Nested p tags</p>\n          |       ^\",\n          \"stack\": [\n            \"p <anonymous>\",\n-           \"Page app/page.js (6:7)\",\n+           \"Page app/(default)/p-under-p/page.tsx (6:7)\",\n          ],\n        },\n      ]\n     `)\n   })\n \n   it('should only show one hydration error when bad nesting happened - div under p', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-\n-            export default function Page() {\n-              return (\n-                <div>\n-                  <div>\n-                    <p>\n-                      <div>Nested div under p tag</div>\n-                    </p>\n-                  </div>\n-                </div>\n-              )\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-\n-    const { browser } = sandbox\n+    const browser = await next.browser('/div-under-p')\n \n     await retry(async () => {\n       expect(await getToastErrorCount(browser)).toBe(2)\n@@ -821,15 +563,15 @@ describe('Error overlay for hydration errors in App router', () => {\n      [\n        {\n          \"componentStack\": \"...\n-         <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n-           <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n-             <LoadingBoundary loading={null}>\n-               <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                 <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n+         <ScrollAndFocusHandler segmentPath={[...]}>\n+           <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+             <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+               <LoadingBoundary loading={null}>\n+                 <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n                    <RedirectBoundary>\n                      <RedirectErrorBoundary router={{...}}>\n-                       <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                         <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n+                       <InnerLayoutRouter url=\"/div-under-p\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n+                         <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n                            <SegmentTrieNode>\n                            <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n                              <Page params={Promise} searchParams={Promise}>\n@@ -839,52 +581,37 @@ describe('Error overlay for hydration errors in App router', () => {\n      >                               <div>\n                          ...\n                        ...\n-           ...\",\n+             ...\",\n          \"description\": \"In HTML, <div> cannot be a descendant of <p>.\n      This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n-         \"source\": \"app/page.js (8:11) @ Page\n+         \"source\": \"app/(default)/div-under-p/page.tsx (8:11) @ Page\n      >  8 |           <div>Nested div under p tag</div>\n           |           ^\",\n          \"stack\": [\n            \"div <anonymous>\",\n-           \"Page app/page.js (8:11)\",\n+           \"Page app/(default)/div-under-p/page.tsx (8:11)\",\n          ],\n        },\n        {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Recoverable Error\",\n-         \"source\": \"app/page.js (8:11) @ Page\n+         \"source\": \"app/(default)/div-under-p/page.tsx (8:11) @ Page\n      >  8 |           <div>Nested div under p tag</div>\n           |           ^\",\n          \"stack\": [\n            \"div <anonymous>\",\n-           \"Page app/page.js (8:11)\",\n+           \"Page app/(default)/div-under-p/page.tsx (8:11)\",\n          ],\n        },\n      ]\n     `)\n   })\n \n   it('should only show one hydration error when bad nesting happened - div > tr', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-            export default function Page() {\n-              return <div><tr></tr></div>\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-\n-    const { browser } = sandbox\n+    const browser = await next.browser('/tr-under-div')\n \n     await retry(async () => {\n       expect(await getToastErrorCount(browser)).toBe(2)\n@@ -899,68 +626,49 @@ describe('Error overlay for hydration errors in App router', () => {\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                  <LoadingBoundary loading={null}>\n-                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n-                       <RedirectBoundary>\n-                         <RedirectErrorBoundary router={{...}}>\n-                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                             <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n-                               <SegmentTrieNode>\n-                               <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n-                                 <Page params={Promise} searchParams={Promise}>\n-     >                             <div>\n-     >                               <tr>\n-                             ...\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <InnerLayoutRouter url=\"/tr-under-div\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n+                             <SegmentTrieNode>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     >                           <div>\n+     >                             <tr>\n                            ...\n+                         ...\n                ...\",\n          \"description\": \"In HTML, <tr> cannot be a child of <div>.\n      This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n-         \"source\": \"app/page.js (3:15) @ Page\n-     > 3 |   return <div><tr></tr></div>\n-         |               ^\",\n+         \"source\": \"app/(default)/tr-under-div/page.tsx (6:7) @ Page\n+     > 6 |       <tr></tr>\n+         |       ^\",\n          \"stack\": [\n            \"tr <anonymous>\",\n-           \"Page app/page.js (3:15)\",\n+           \"Page app/(default)/tr-under-div/page.tsx (6:7)\",\n          ],\n        },\n        {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Recoverable Error\",\n-         \"source\": \"app/page.js (3:15) @ Page\n-     > 3 |   return <div><tr></tr></div>\n-         |               ^\",\n+         \"source\": \"app/(default)/tr-under-div/page.tsx (6:7) @ Page\n+     > 6 |       <tr></tr>\n+         |       ^\",\n          \"stack\": [\n            \"tr <anonymous>\",\n-           \"Page app/page.js (3:15)\",\n+           \"Page app/(default)/tr-under-div/page.tsx (6:7)\",\n          ],\n        },\n      ]\n     `)\n   })\n \n   it('should show the highlighted bad nesting html snippet when bad nesting happened', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/page.js',\n-          outdent`\n-            'use client'\n-\n-            export default function Page() {\n-              return (\n-                <p><span><span><span><span><p>hello world</p></span></span></span></span></p>\n-              )\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-\n-    const { browser } = sandbox\n+    const browser = await next.browser('/bad-nesting')\n \n     await retry(async () => {\n       expect(await getToastErrorCount(browser)).toBe(3)\n@@ -975,98 +683,66 @@ describe('Error overlay for hydration errors in App router', () => {\n              <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n                <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n                  <LoadingBoundary loading={null}>\n-                   <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n-                     <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<SegmentViewNode>} forbidden={undefined} ...>\n-                       <RedirectBoundary>\n-                         <RedirectErrorBoundary router={{...}}>\n-                           <InnerLayoutRouter url=\"/\" tree={[...]} cacheNode={{lazyData:null, ...}} segmentPath={[...]}>\n-                             <SegmentViewNode type=\"page\" pagePath=\"page.js\">\n-                               <SegmentTrieNode>\n-                               <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n-                                 <Page params={Promise} searchParams={Promise}>\n-     >                             <p>\n+                   <HTTPAccessFallbackBoundary notFound={undefined} forbidden={undefined} unauthorized={undefined}>\n+                     <RedirectBoundary>\n+                       <RedirectErrorBoundary router={{...}}>\n+                         <InnerLayoutRouter url=\"/bad-nesting\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                           <SegmentViewNode type=\"page\" pagePath=\"(default)/...\">\n+                             <SegmentTrieNode>\n+                             <ClientPageRoot Component={function Page} searchParams={{}} params={{}}>\n+                               <Page params={Promise} searchParams={Promise}>\n+     >                           <p>\n+                                   <span>\n                                      <span>\n                                        <span>\n                                          <span>\n-                                           <span>\n-     >                                       <p>\n-                             ...\n+     >                                     <p>\n                            ...\n+                         ...\n                ...\",\n          \"description\": \"In HTML, <p> cannot be a descendant of <p>.\n      This will cause a hydration error.\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n-         \"source\": \"app/page.js (5:32) @ Page\n-     > 5 |     <p><span><span><span><span><p>hello world</p></span></span></span></span></p>\n-         |                                ^\",\n+         \"source\": \"app/(default)/bad-nesting/page.tsx (10:15) @ Page\n+     > 10 |               <p>hello world</p>\n+          |               ^\",\n          \"stack\": [\n            \"p <anonymous>\",\n-           \"Page app/page.js (5:32)\",\n+           \"Page app/(default)/bad-nesting/page.tsx (10:15)\",\n          ],\n        },\n        {\n          \"description\": \"<p> cannot contain a nested <p>.\n      See this log for the ancestor stack trace.\",\n          \"environmentLabel\": null,\n          \"label\": \"Console Error\",\n-         \"source\": \"app/page.js (5:5) @ Page\n-     > 5 |     <p><span><span><span><span><p>hello world</p></span></span></span></span></p>\n+         \"source\": \"app/(default)/bad-nesting/page.tsx (5:5) @ Page\n+     > 5 |     <p>\n          |     ^\",\n          \"stack\": [\n            \"p <anonymous>\",\n-           \"Page app/page.js (5:5)\",\n+           \"Page app/(default)/bad-nesting/page.tsx (5:5)\",\n          ],\n        },\n        {\n          \"description\": \"Hydration failed because the server rendered HTML didn't match the client. As a result this tree will be regenerated on the client. This can happen if a SSR-ed Client Component used:\",\n          \"environmentLabel\": null,\n          \"label\": \"Recoverable Error\",\n-         \"source\": \"app/page.js (5:32) @ Page\n-     > 5 |     <p><span><span><span><span><p>hello world</p></span></span></span></span></p>\n-         |                                ^\",\n+         \"source\": \"app/(default)/bad-nesting/page.tsx (10:15) @ Page\n+     > 10 |               <p>hello world</p>\n+          |               ^\",\n          \"stack\": [\n            \"p <anonymous>\",\n-           \"Page app/page.js (5:32)\",\n+           \"Page app/(default)/bad-nesting/page.tsx (10:15)\",\n          ],\n        },\n      ]\n     `)\n   })\n \n   it('should show error if script is directly placed under html instead of body', async () => {\n-    await using sandbox = await createSandbox(\n-      next,\n-      new Map([\n-        [\n-          'app/layout.js',\n-          outdent`\n-            import Script from 'next/script'\n-\n-            export default function Layout({ children }) {\n-              return (\n-                <html>\n-                  <body>{children}</body>\n-                  <Script\n-                    src=\"https://example.com/script.js\"\n-                    strategy=\"beforeInteractive\"\n-                  />\n-                </html>\n-              )\n-            }\n-          `,\n-        ],\n-        [\n-          'app/page.js',\n-          outdent`\n-            export default function Page() {\n-              return <div>Hello World</div>\n-            }\n-          `,\n-        ],\n-      ])\n-    )\n-    const { browser } = sandbox\n+    const browser = await next.browser('/script-under-html')\n \n     await retry(async () => {\n       expect(await getToastErrorCount(browser)).toBe(\n@@ -1082,60 +758,73 @@ describe('Error overlay for hydration errors in App router', () => {\n            \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n            \"environmentLabel\": null,\n            \"label\": \"Console Error\",\n-           \"source\": \"app/layout.js (7:7) @ Layout\n-       >  7 |       <Script\n+           \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+       >  8 |       <Script\n             |       ^\",\n            \"stack\": [\n-             \"Layout app/layout.js (7:7)\",\n+             \"Root app/(script-under-html)/layout.tsx (8:7)\",\n            ],\n          },\n          {\n            \"componentStack\": \"...\n-           <HotReload globalError={[...]} webSocket={WebSocket} staticIndicatorState={{pathname:null, ...}}>\n-             <AppDevOverlayErrorBoundary globalError={[...]}>\n-               <ReplaySsrOnlyErrors>\n-               <DevRootHTTPAccessFallbackBoundary>\n-                 <HTTPAccessFallbackBoundary notFound={<NotAllowedRootHTTPFallbackError>}>\n-                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<NotAllowedRootHTTPFallbackError>} ...>\n-                     <RedirectBoundary>\n-                       <RedirectErrorBoundary router={{...}}>\n-                         <Head>\n-                         <__next_root_layout_boundary__>\n-                           <SegmentViewNode type=\"layout\" pagePath=\"layout.js\">\n-                             <SegmentTrieNode>\n-                             <script>\n-                             <script>\n-                             <Layout>\n-                               <NotFound>\n-                                 <HTTPAccessErrorFallback>\n-       >                           <html>\n-                                     <body>\n-                                     <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n-       >                               <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n-                         ...\",\n+           <RenderFromTemplateContext>\n+             <ScrollAndFocusHandler segmentPath={[...]}>\n+               <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+                 <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                   <LoadingBoundary loading={null}>\n+                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n+                       <HTTPAccessFallbackErrorBoundary pathname=\"/script-un...\" notFound={<SegmentViewNode>} ...>\n+                         <RedirectBoundary>\n+                           <RedirectErrorBoundary router={{...}}>\n+                             <InnerLayoutRouter url=\"/script-un...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                               <SegmentViewNode type=\"layout\" pagePath=\"(script-un...\">\n+                                 <SegmentTrieNode>\n+                                 <script>\n+                                 <script>\n+                                 <Root>\n+                                   <NotFound>\n+                                     <HTTPAccessErrorFallback>\n+                                       <NotFound>\n+                                         <HTTPAccessErrorFallback>\n+                                           <NotFound>\n+                                             <HTTPAccessErrorFallback>\n+                                               <NotFound>\n+                                                 <HTTPAccessErrorFallback>\n+                                                   <NotFound>\n+                                                     <HTTPAccessErrorFallback>\n+       >                                               <html>\n+                                                         <body>\n+                                                         <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n+       >                                                   <script\n+       >                                                     nonce={undefined}\n+       >                                                     dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}\n+       >                                                   >\n+                             ...\n+                 ...\n+           ...\",\n            \"description\": \"In HTML, <script> cannot be a child of <html>.\n        This will cause a hydration error.\",\n            \"environmentLabel\": null,\n            \"label\": \"Console Error\",\n-           \"source\": \"app/layout.js (7:7) @ Layout\n-       >  7 |       <Script\n+           \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+       >  8 |       <Script\n             |       ^\",\n            \"stack\": [\n              \"script <anonymous>\",\n-             \"Layout app/layout.js (7:7)\",\n+             \"Root app/(script-under-html)/layout.tsx (8:7)\",\n            ],\n          },\n          {\n            \"description\": \"<html> cannot contain a nested <script>.\n        See this log for the ancestor stack trace.\",\n            \"environmentLabel\": null,\n            \"label\": \"Console Error\",\n-           \"source\": \"app/layout.js (5:5) @ Layout\n-       > 5 |     <html>\n+           \"source\": \"app/(script-under-html)/layout.tsx (6:5) @ Root\n+       > 6 |     <html>\n            |     ^\",\n            \"stack\": [\n              \"html <anonymous>\",\n-             \"Layout app/layout.js (5:5)\",\n+             \"Root app/(script-under-html)/layout.tsx (6:5)\",\n            ],\n          },\n        ]\n@@ -1147,58 +836,71 @@ describe('Error overlay for hydration errors in App router', () => {\n            \"description\": \"Cannot render a sync or defer <script> outside the main document without knowing its order. Try adding async=\"\" or moving it into the root <head> tag.\",\n            \"environmentLabel\": null,\n            \"label\": \"Console Error\",\n-           \"source\": \"app/layout.js (7:7) @ Layout\n-       >  7 |       <Script\n+           \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+       >  8 |       <Script\n             |       ^\",\n            \"stack\": [\n-             \"Layout app/layout.js (7:7)\",\n+             \"Root app/(script-under-html)/layout.tsx (8:7)\",\n            ],\n          },\n          {\n            \"componentStack\": \"...\n-           <HotReload globalError={[...]} webSocket={WebSocket} staticIndicatorState={{pathname:null, ...}}>\n-             <AppDevOverlayErrorBoundary globalError={[...]}>\n-               <ReplaySsrOnlyErrors>\n-               <DevRootHTTPAccessFallbackBoundary>\n-                 <HTTPAccessFallbackBoundary notFound={<NotAllowedRootHTTPFallbackError>}>\n-                   <HTTPAccessFallbackErrorBoundary pathname=\"/\" notFound={<NotAllowedRootHTTPFallbackError>} ...>\n-                     <RedirectBoundary>\n-                       <RedirectErrorBoundary router={{...}}>\n-                         <Head>\n-                         <__next_root_layout_boundary__>\n-                           <SegmentViewNode type=\"layout\" pagePath=\"layout.js\">\n-                             <SegmentTrieNode>\n-                             <Layout>\n-                               <NotFound>\n-                                 <HTTPAccessErrorFallback>\n-       >                           <html>\n-                                     <body>\n-                                     <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n-       >                               <script nonce={undefined} dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}>\n-                         ...\",\n+           <RenderFromTemplateContext>\n+             <ScrollAndFocusHandler segmentPath={[...]}>\n+               <InnerScrollAndFocusHandler segmentPath={[...]} focusAndScrollRef={{apply:false, ...}}>\n+                 <ErrorBoundary errorComponent={undefined} errorStyles={undefined} errorScripts={undefined}>\n+                   <LoadingBoundary loading={null}>\n+                     <HTTPAccessFallbackBoundary notFound={<SegmentViewNode>} forbidden={undefined} unauthorized={undefined}>\n+                       <HTTPAccessFallbackErrorBoundary pathname=\"/script-un...\" notFound={<SegmentViewNode>} ...>\n+                         <RedirectBoundary>\n+                           <RedirectErrorBoundary router={{...}}>\n+                             <InnerLayoutRouter url=\"/script-un...\" tree={[...]} cacheNode={{lazyData:null, ...}} ...>\n+                               <SegmentViewNode type=\"layout\" pagePath=\"(script-un...\">\n+                                 <SegmentTrieNode>\n+                                 <Root>\n+                                   <NotFound>\n+                                     <HTTPAccessErrorFallback>\n+                                       <NotFound>\n+                                         <HTTPAccessErrorFallback>\n+                                           <NotFound>\n+                                             <HTTPAccessErrorFallback>\n+                                               <NotFound>\n+                                                 <HTTPAccessErrorFallback>\n+                                                   <NotFound>\n+                                                     <HTTPAccessErrorFallback>\n+       >                                               <html>\n+                                                         <body>\n+                                                         <Script src=\"https://ex...\" strategy=\"beforeInte...\">\n+       >                                                   <script\n+       >                                                     nonce={undefined}\n+       >                                                     dangerouslySetInnerHTML={{__html:\"(self.__ne...\"}}\n+       >                                                   >\n+                             ...\n+                 ...\n+           ...\",\n            \"description\": \"In HTML, <script> cannot be a child of <html>.\n        This will cause a hydration error.\",\n            \"environmentLabel\": null,\n            \"label\": \"Console Error\",\n-           \"source\": \"app/layout.js (7:7) @ Layout\n-       >  7 |       <Script\n+           \"source\": \"app/(script-under-html)/layout.tsx (8:7) @ Root\n+       >  8 |       <Script\n             |       ^\",\n            \"stack\": [\n              \"script <anonymous>\",\n-             \"Layout app/layout.js (7:7)\",\n+             \"Root app/(script-under-html)/layout.tsx (8:7)\",\n            ],\n          },\n          {\n            \"description\": \"<html> cannot contain a nested <script>.\n        See this log for the ancestor stack trace.\",\n            \"environmentLabel\": null,\n            \"label\": \"Console Error\",\n-           \"source\": \"app/layout.js (5:5) @ Layout\n-       > 5 |     <html>\n+           \"source\": \"app/(script-under-html)/layout.tsx (6:5) @ Root\n+       > 6 |     <html>\n            |     ^\",\n            \"stack\": [\n              \"html <anonymous>\",\n-             \"Layout app/layout.js (5:5)\",\n+             \"Root app/(script-under-html)/layout.tsx (6:5)\",\n            ],\n          },\n        ]"
        }
    ],
    "stats": {
        "total": 1201,
        "additions": 544,
        "deletions": 657
    }
}