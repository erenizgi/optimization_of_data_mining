{
    "author": "sbougerel",
    "message": "fix(jest): stricter regex for 'server-only' in default config (#77588)\n\nNextJest default `moduleNameMapper` configuration for `server-only`\nmatches any string that contains this substring, causing mocks of\nmatching dependencies to overwrite each others and the empty mock for\n`import 'server-only';`. This changes makes the regex for the module\nname more strict to ensure only the full string `server-only` is a\nmatch.\n\n### Why?\n\nOn my project, we thought it'd be a good idea to store our server-only\nfiles under the directory `@/app/lib/server-only`. Unfortunately, this\nmade testing with Jest difficult due to `nextJest`'s default\nconfiguration for `server-only`. Given a test file with:\n\n```typescript\njest.mock('@/app/lib/server-only/one, () => ({\n  fnOne: jest.fn(),\n}));\njest.mock('@/app/lib/server-only/two, () => ({\n  fnTwo: jest.fn(),\n}));\n```\n\nThe mocks for the dependency `@/app/lib/server-only/two` would overwrite\nthe mock of `@/app/lib/server-only/one` (that was overwriting the empty\nmock for `server-only`) and thus `fnOne` would be `undefined`.\n\nIn our project, we've currently fixed the issue by patching the\nconfiguration generated by `nextJest` using the stricter regexp in this\nPR:\n\n```typescript\n// ...At the end of jest.config.ts\nmodule.exports = async () => {\n  const jestConfig = await createJestConfig(config)();\n  if (\n    typeof jestConfig.moduleNameMapper !== 'undefined' &&\n    'server-only' in jestConfig.moduleNameMapper\n  ) {\n    const value = jestConfig.moduleNameMapper['server-only'];\n    jestConfig.moduleNameMapper['^server-only$'] = value;\n    delete jestConfig.moduleNameMapper['server-only'];\n  }\n  return jestConfig;\n};\n```\n\n## Verifications\n\nI've checked that `pnpm build` and `pnpm test-unit` were unaffected.\nThis is the result of `pnpm test-unit`:\n\n```\nTest Suites: 199 passed, 199 total\nTests:       2 skipped, 1312 passed, 1314 total\nSnapshots:   188 passed, 188 total\nTime:        11.697 s\nRan all test suites matching /test\\/unit\\/|packages\\/next\\/|packages\\/font/i.\n```",
    "sha": "c5d401150edaf037c0cb2118c9d5a394095d2bb9",
    "files": [
        {
            "sha": "2d64cc80b3e979f1fc8cc05d8f70fe2fcb0d837f",
            "filename": "packages/next/src/build/jest/jest.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/c5d401150edaf037c0cb2118c9d5a394095d2bb9/packages%2Fnext%2Fsrc%2Fbuild%2Fjest%2Fjest.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/c5d401150edaf037c0cb2118c9d5a394095d2bb9/packages%2Fnext%2Fsrc%2Fbuild%2Fjest%2Fjest.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fjest%2Fjest.ts?ref=c5d401150edaf037c0cb2118c9d5a394095d2bb9",
            "patch": "@@ -141,7 +141,7 @@ export default function nextJest(options: { dir?: string } = {}) {\n           // Handle next/font\n           'next/font/(.*)': require.resolve('./__mocks__/nextFontMock.js'),\n           // Disable server-only\n-          'server-only': require.resolve('./__mocks__/empty.js'),\n+          '^server-only$': require.resolve('./__mocks__/empty.js'),\n \n           // custom config comes last to ensure the above rules are matched,\n           // fixes the case where @pages/(.*) -> src/pages/$! doesn't break"
        }
    ],
    "stats": {
        "total": 2,
        "additions": 1,
        "deletions": 1
    }
}