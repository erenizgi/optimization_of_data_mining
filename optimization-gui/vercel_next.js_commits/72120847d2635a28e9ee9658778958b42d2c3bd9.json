{
    "author": "huozhi",
    "message": "[not-found] support metadata exports of global-not-found (#78961)",
    "sha": "72120847d2635a28e9ee9658778958b42d2c3bd9",
    "files": [
        {
            "sha": "eef6c6daa4074116465ea00dc95e1e2495b60a1b",
            "filename": "packages/next/src/build/webpack/loaders/next-app-loader/index.ts",
            "status": "modified",
            "additions": 1,
            "deletions": 2,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-app-loader%2Findex.ts?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -218,8 +218,7 @@ async function createTreeCodeFromPath(\n     let metadata: Awaited<ReturnType<typeof createStaticMetadataFromRoute>> =\n       null\n     const routerDirPath = `${appDirPrefix}${segmentPath}`\n-    // For default not-found, don't traverse the directory to find metadata.\n-    const resolvedRouteDir = isDefaultNotFound ? '' : resolveDir(routerDirPath)\n+    const resolvedRouteDir = resolveDir(routerDirPath)\n \n     if (resolvedRouteDir) {\n       metadata = await createStaticMetadataFromRoute(resolvedRouteDir, {"
        },
        {
            "sha": "4e468248394bb7ace035930fabf8602e6c62d156",
            "filename": "packages/next/src/server/app-render/app-render.tsx",
            "status": "modified",
            "additions": 7,
            "deletions": 1,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fapp-render%2Fapp-render.tsx?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -808,6 +808,7 @@ async function getRSCPayload(\n     query\n   )\n   const serveStreamingMetadata = !!ctx.renderOpts.serveStreamingMetadata\n+  const hasGlobalNotFound = !!tree[2]['global-not-found']\n \n   const {\n     ViewportTree,\n@@ -817,7 +818,12 @@ async function getRSCPayload(\n     StreamingMetadataOutlet,\n   } = createMetadataComponents({\n     tree,\n-    errorType: is404 ? 'not-found' : undefined,\n+    // When it's using global-not-found, metadata errorType is undefined, which will retrieve the\n+    // metadata from the page.\n+    // When it's using not-found, metadata errorType is 'not-found', which will retrieve the\n+    // metadata from the not-found.js boundary.\n+    // TODO: remove this condition and keep it undefined when global-not-found is stabilized.\n+    errorType: is404 && !hasGlobalNotFound ? 'not-found' : undefined,\n     parsedQuery: query,\n     metadataContext: createTrackedMetadataContext(\n       url.pathname,"
        },
        {
            "sha": "6f7be9458297a35649d5f59c5ba793fad181f36e",
            "filename": "test/e2e/app-dir/global-not-found/metadata/app/call-not-found/page.tsx",
            "status": "added",
            "additions": 7,
            "deletions": 0,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fcall-not-found%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fcall-not-found%2Fpage.tsx?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -0,0 +1,7 @@\n+'use client'\n+\n+import { notFound } from 'next/navigation'\n+\n+export default function Page() {\n+  notFound()\n+}"
        },
        {
            "sha": "2655663a3bef6443ddf981338fd48c16ddb1f638",
            "filename": "test/e2e/app-dir/global-not-found/metadata/app/global-not-found.tsx",
            "status": "added",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fglobal-not-found.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fglobal-not-found.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fglobal-not-found.tsx?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -0,0 +1,15 @@\n+export default function GlobalNotFound() {\n+  return (\n+    // html tag is different from actual page's layout\n+    <html data-global-not-found=\"true\">\n+      <body>\n+        <h1 id=\"global-error-title\">global-not-found</h1>\n+      </body>\n+    </html>\n+  )\n+}\n+\n+export const metadata = {\n+  title: 'global-not-found',\n+  description: 'global-not-found description',\n+}"
        },
        {
            "sha": "76bea97e3e9a8c74606fb56fdb576d91f89981ee",
            "filename": "test/e2e/app-dir/global-not-found/metadata/app/icon.svg",
            "status": "added",
            "additions": 1,
            "deletions": 0,
            "changes": 1,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Ficon.svg",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Ficon.svg",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Ficon.svg?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -0,0 +1 @@\n+<svg fill=\"none\" height=\"20\" viewBox=\"0 0 283 64\" xmlns=\"http://www.w3.org/2000/svg\"><path d=\"M141.04 16c-11.04 0-19 7.2-19 18s8.96 18 20 18c6.67 0 12.55-2.64 16.19-7.09l-7.65-4.42c-2.02 2.21-5.09 3.5-8.54 3.5-4.79 0-8.86-2.5-10.37-6.5h28.02c.22-1.12.35-2.28.35-3.5 0-10.79-7.96-17.99-19-17.99zm-9.46 14.5c1.25-3.99 4.67-6.5 9.45-6.5 4.79 0 8.21 2.51 9.45 6.5h-18.9zM248.72 16c-11.04 0-19 7.2-19 18s8.96 18 20 18c6.67 0 12.55-2.64 16.19-7.09l-7.65-4.42c-2.02 2.21-5.09 3.5-8.54 3.5-4.79 0-8.86-2.5-10.37-6.5h28.02c.22-1.12.35-2.28.35-3.5 0-10.79-7.96-17.99-19-17.99zm-9.45 14.5c1.25-3.99 4.67-6.5 9.45-6.5 4.79 0 8.21 2.51 9.45 6.5h-18.9zM200.24 34c0 6 3.92 10 10 10 4.12 0 7.21-1.87 8.8-4.92l7.68 4.43c-3.18 5.3-9.14 8.49-16.48 8.49-11.05 0-19-7.2-19-18s7.96-18 19-18c7.34 0 13.29 3.19 16.48 8.49l-7.68 4.43c-1.59-3.05-4.68-4.92-8.8-4.92-6.07 0-10 4-10 10zm82.48-29v46h-9V5h9zM36.95 0L73.9 64H0L36.95 0zm92.38 5l-27.71 48L73.91 5H84.3l17.32 30 17.32-30h10.39zm58.91 12v9.69c-1-.29-2.06-.49-3.2-.49-5.81 0-10 4-10 10V51h-9V17h9v9.2c0-5.08 5.91-9.2 13.2-9.2z\" fill=\"#000\"></path></svg>\n\\ No newline at end of file"
        },
        {
            "sha": "dbce4ea8e3aeb6cb61b81712b62288d5abaf776b",
            "filename": "test/e2e/app-dir/global-not-found/metadata/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Flayout.tsx?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: {\n+  children: React.ReactNode\n+}) {\n+  return (\n+    <html lang=\"en\">\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "ff7159d9149feeb1eb8f4b7bbeadb2e26c20b053",
            "filename": "test/e2e/app-dir/global-not-found/metadata/app/page.tsx",
            "status": "added",
            "additions": 3,
            "deletions": 0,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fapp%2Fpage.tsx?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -0,0 +1,3 @@\n+export default function Page() {\n+  return <p>hello world</p>\n+}"
        },
        {
            "sha": "cc1f2ee4d9ef6d5effb99f299ffc85548c9e8e94",
            "filename": "test/e2e/app-dir/global-not-found/metadata/metadata.test.ts",
            "status": "added",
            "additions": 30,
            "deletions": 0,
            "changes": 30,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fmetadata.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fmetadata.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fmetadata.test.ts?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -0,0 +1,30 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('global-not-found - metadata', () => {\n+  const { next } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should render metadata of global-not-found for 404', async () => {\n+    // assert SSR metadata\n+    const $ = await next.render$('/does-not-exist')\n+    expect($('title').text()).toBe('global-not-found')\n+    expect($('meta[name=\"description\"]').attr('content')).toBe(\n+      'global-not-found description'\n+    )\n+    // pick up static icon svg\n+    expect($('link[rel=\"icon\"]').attr('type')).toBe('image/svg+xml')\n+\n+    // assert hydrated metadata\n+    const browser = await next.browser('/does-not-exist')\n+    const title = await browser.elementByCss('title')\n+    const description = await browser.elementByCss('meta[name=\"description\"]')\n+    expect(await title.text()).toBe('global-not-found')\n+    expect(await description.getAttribute('content')).toBe(\n+      'global-not-found description'\n+    )\n+    // pick up static icon svg\n+    const icon = await browser.elementByCss('link[rel=\"icon\"]')\n+    expect(await icon.getAttribute('type')).toBe('image/svg+xml')\n+  })\n+})"
        },
        {
            "sha": "a198cf5a769a106aef77008e1dd3fc2e332aa98e",
            "filename": "test/e2e/app-dir/global-not-found/metadata/next.config.js",
            "status": "added",
            "additions": 10,
            "deletions": 0,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/72120847d2635a28e9ee9658778958b42d2c3bd9/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fglobal-not-found%2Fmetadata%2Fnext.config.js?ref=72120847d2635a28e9ee9658778958b42d2c3bd9",
            "patch": "@@ -0,0 +1,10 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  experimental: {\n+    globalNotFound: true,\n+  },\n+}\n+\n+module.exports = nextConfig"
        }
    ],
    "stats": {
        "total": 88,
        "additions": 85,
        "deletions": 3
    }
}