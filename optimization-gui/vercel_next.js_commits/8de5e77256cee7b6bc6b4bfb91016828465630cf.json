{
    "author": "mischnic",
    "message": "Turbopack: fewer manifests for static metadata (#77087)\n\nCloses PACK-3731\r\n\r\nThis test was effectively already passing, except that we unnecessarily always emitted manifests.\r\n\r\nNo need to emit the various client reference, next dynamic, server actions, ... manifests for static metadata routes.",
    "sha": "8de5e77256cee7b6bc6b4bfb91016828465630cf",
    "files": [
        {
            "sha": "35af658a88cb0b4fa25e6f1a03d0c90c3a05533b",
            "filename": "crates/next-api/src/app.rs",
            "status": "modified",
            "additions": 36,
            "deletions": 10,
            "changes": 46,
            "blob_url": "https://github.com/vercel/next.js/blob/8de5e77256cee7b6bc6b4bfb91016828465630cf/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/8de5e77256cee7b6bc6b4bfb91016828465630cf/crates%2Fnext-api%2Fsrc%2Fapp.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-api%2Fsrc%2Fapp.rs?ref=8de5e77256cee7b6bc6b4bfb91016828465630cf",
            "patch": "@@ -1106,14 +1106,35 @@ impl AppEndpoint {\n \n         let app_entry = self.app_endpoint_entry().await?;\n \n+        #[derive(Debug, PartialEq, Eq)]\n+        enum EmitManifests {\n+            /// Don't emit any manifests (needed for the RSC endpoints)\n+            None,\n+            /// Emit the manifest for basic Next.js functionality (e.g. app-build-manifest.json)\n+            Minimal,\n+            /// All manifests: `Minimal` plus client-references, next-dynamic, ...\n+            Full,\n+        }\n         let (process_client_assets, process_ssr, emit_manifests) = match this.ty {\n             AppEndpointType::Page { ty, .. } => (\n                 true,\n                 matches!(ty, AppPageEndpointType::Html),\n-                matches!(ty, AppPageEndpointType::Html),\n+                if matches!(ty, AppPageEndpointType::Html) {\n+                    EmitManifests::Full\n+                } else {\n+                    EmitManifests::None\n+                },\n+            ),\n+            AppEndpointType::Route { .. } => (false, false, EmitManifests::Full),\n+            AppEndpointType::Metadata { metadata } => (\n+                false,\n+                false,\n+                if matches!(metadata, MetadataItem::Dynamic { .. }) {\n+                    EmitManifests::Full\n+                } else {\n+                    EmitManifests::Minimal\n+                },\n             ),\n-            AppEndpointType::Route { .. } => (false, false, true),\n-            AppEndpointType::Metadata { .. } => (false, false, true),\n         };\n \n         let node_root = project.node_root();\n@@ -1223,7 +1244,7 @@ impl AppEndpoint {\n \n         let manifest_path_prefix = &app_entry.original_name;\n \n-        if emit_manifests {\n+        if emit_manifests != EmitManifests::None {\n             let app_build_manifest = AppBuildManifest {\n                 pages: fxindexmap!(\n                     app_entry.original_name.clone() => Vc::cell(entry_client_chunks\n@@ -1261,7 +1282,7 @@ impl AppEndpoint {\n         );\n         client_assets.insert(polyfill_output_asset);\n \n-        if emit_manifests {\n+        if emit_manifests != EmitManifests::None {\n             if *this\n                 .app_project\n                 .project()\n@@ -1342,7 +1363,9 @@ impl AppEndpoint {\n                 .runtime_chunking_context(process_client_assets, runtime),\n         )\n         .await?;\n-        server_assets.insert(server_action_manifest.manifest);\n+        if emit_manifests == EmitManifests::Full {\n+            server_assets.insert(server_action_manifest.manifest);\n+        }\n \n         let server_action_manifest_loader = server_action_manifest.loader;\n \n@@ -1366,7 +1389,7 @@ impl AppEndpoint {\n         // these references are important for turbotrace\n         let mut client_reference_manifest = None;\n \n-        if emit_manifests {\n+        if emit_manifests == EmitManifests::Full {\n             let entry_manifest =\n                 ClientReferenceManifest::build_output(ClientReferenceManifestOptions {\n                     node_root,\n@@ -1437,7 +1460,7 @@ impl AppEndpoint {\n \n                 let entry_file = \"app-edge-has-no-entrypoint\".into();\n \n-                if emit_manifests {\n+                if emit_manifests == EmitManifests::Full {\n                     let dynamic_import_entries = collect_next_dynamic_chunks(\n                         *module_graphs.full,\n                         Vc::upcast(client_chunking_context),\n@@ -1516,7 +1539,8 @@ impl AppEndpoint {\n                         .await?,\n                     );\n                     server_assets.insert(middleware_manifest_v2);\n-\n+                }\n+                if emit_manifests != EmitManifests::None {\n                     // create app paths manifest\n                     let app_paths_manifest_output =\n                         create_app_paths_manifest(node_root, &app_entry.original_name, entry_file)\n@@ -1536,7 +1560,7 @@ impl AppEndpoint {\n                 // For node, there will be exactly one asset in this\n                 let rsc_chunk = *app_entry_chunks_ref.first().unwrap();\n \n-                let loadable_manifest_output = if emit_manifests {\n+                if emit_manifests != EmitManifests::None {\n                     // create app paths manifest\n                     let app_paths_manifest_output = create_app_paths_manifest(\n                         node_root,\n@@ -1551,7 +1575,9 @@ impl AppEndpoint {\n                     )\n                     .await?;\n                     server_assets.insert(app_paths_manifest_output);\n+                }\n \n+                let loadable_manifest_output = if emit_manifests == EmitManifests::Full {\n                     // create react-loadable-manifest for next/dynamic\n                     let dynamic_import_entries = collect_next_dynamic_chunks(\n                         *module_graphs.full,"
        },
        {
            "sha": "362e02b9a6a7a5b18446fa72de05a8acfdc75a39",
            "filename": "test/e2e/app-dir/use-cache-metadata-route-handler/use-cache-metadata-route-handler.test.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 4,
            "changes": 12,
            "blob_url": "https://github.com/vercel/next.js/blob/8de5e77256cee7b6bc6b4bfb91016828465630cf/test%2Fe2e%2Fapp-dir%2Fuse-cache-metadata-route-handler%2Fuse-cache-metadata-route-handler.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/8de5e77256cee7b6bc6b4bfb91016828465630cf/test%2Fe2e%2Fapp-dir%2Fuse-cache-metadata-route-handler%2Fuse-cache-metadata-route-handler.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-metadata-route-handler%2Fuse-cache-metadata-route-handler.test.ts?ref=8de5e77256cee7b6bc6b4bfb91016828465630cf",
            "patch": "@@ -1,7 +1,7 @@\n import { nextTestSetup } from 'e2e-utils'\n \n describe('use-cache-metadata-route-handler', () => {\n-  const { next, isNextDev, isNextStart, isTurbopack } = nextTestSetup({\n+  const { next, isNextDev, isNextStart } = nextTestSetup({\n     files: __dirname,\n   })\n \n@@ -132,7 +132,7 @@ describe('use-cache-metadata-route-handler', () => {\n     }\n   })\n \n-  if (isNextStart && !isTurbopack) {\n+  if (isNextStart) {\n     it('should include the client reference manifest in the route.js.nft.json files of dynamic metadata routes', async () => {\n       for (const filename of [\n         'icon',\n@@ -146,7 +146,9 @@ describe('use-cache-metadata-route-handler', () => {\n           `/.next/server/app/${filename}/route.js.nft.json`\n         )\n \n-        expect(files).toInclude('route_client-reference-manifest.js')\n+        expect(\n+          files.find((e) => e.endsWith('route_client-reference-manifest.js'))\n+        ).toBeString()\n       }\n     })\n \n@@ -155,7 +157,9 @@ describe('use-cache-metadata-route-handler', () => {\n         '/.next/server/app/favicon.ico/route.js.nft.json'\n       )\n \n-      expect(files).not.toInclude('route_client-reference-manifest.js')\n+      expect(\n+        files.find((e) => e.endsWith('route_client-reference-manifest.js'))\n+      ).toBeUndefined()\n     })\n   }\n })"
        },
        {
            "sha": "7b7b2676ed4ed3736721e42012e437c6565a8937",
            "filename": "test/turbopack-build-tests-manifest.json",
            "status": "modified",
            "additions": 3,
            "deletions": 1,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/8de5e77256cee7b6bc6b4bfb91016828465630cf/test%2Fturbopack-build-tests-manifest.json",
            "raw_url": "https://github.com/vercel/next.js/raw/8de5e77256cee7b6bc6b4bfb91016828465630cf/test%2Fturbopack-build-tests-manifest.json",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fturbopack-build-tests-manifest.json?ref=8de5e77256cee7b6bc6b4bfb91016828465630cf",
            "patch": "@@ -5498,7 +5498,9 @@\n         \"use-cache-metadata-route-handler should generate manifest.json with a metadata route handler that uses \\\"use cache\\\"\",\n         \"use-cache-metadata-route-handler should generate multiple sitemaps with a metadata route handler that uses \\\"use cache\\\"\",\n         \"use-cache-metadata-route-handler should generate robots.txt with a metadata route handler that uses \\\"use cache\\\"\",\n-        \"use-cache-metadata-route-handler should generate sitemaps with a metadata route handler that uses \\\"use cache\\\"\"\n+        \"use-cache-metadata-route-handler should generate sitemaps with a metadata route handler that uses \\\"use cache\\\"\",\n+        \"use-cache-metadata-route-handler should include the client reference manifest in the route.js.nft.json files of dynamic metadata routes\",\n+        \"use-cache-metadata-route-handler should not include the client reference manifest in the route.js.nft.json files of static metadata routes\"\n       ],\n       \"failed\": [],\n       \"pending\": [],"
        }
    ],
    "stats": {
        "total": 62,
        "additions": 47,
        "deletions": 15
    }
}