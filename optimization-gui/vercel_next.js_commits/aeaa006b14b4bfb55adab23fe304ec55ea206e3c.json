{
    "author": "ijjk",
    "message": "Handle duplex automatically for NextRequest (#76531)\n\nWhen configuring a body with `NextRequest` in node runtime without the\n`duplex: 'half'` option it can throw an error un-necessarily since it's\nan extension of the node `Request` instance. This auto-configures\n`duplex: 'half'` when using `NextRequest` for easier migration from edge\n-> node runtime for middleware.\n\n```sh\nTypeError: RequestInit: duplex option is required when sending a body.\n    at new Request (/opt/rust/undici-runtime.js:40:31096)\n```\n\nx-ref: [slack\nthread](https://vercel.slack.com/archives/C07LQPFERGF/p1740490607381379)",
    "sha": "aeaa006b14b4bfb55adab23fe304ec55ea206e3c",
    "files": [
        {
            "sha": "0e0b2df3c33a80a7fe81c76f5550be9ee06ff7d3",
            "filename": "packages/next/src/server/web/spec-extension/adapters/next-request.ts",
            "status": "modified",
            "additions": 0,
            "deletions": 2,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/aeaa006b14b4bfb55adab23fe304ec55ea206e3c/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Fnext-request.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aeaa006b14b4bfb55adab23fe304ec55ea206e3c/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Fnext-request.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Fadapters%2Fnext-request.ts?ref=aeaa006b14b4bfb55adab23fe304ec55ea206e3c",
            "patch": "@@ -107,7 +107,6 @@ export class NextRequestAdapter {\n     return new NextRequest(url, {\n       method: request.method,\n       headers: fromNodeOutgoingHttpHeaders(request.headers),\n-      // @ts-expect-error - see https://github.com/whatwg/fetch/pull/1457\n       duplex: 'half',\n       signal,\n       // geo\n@@ -134,7 +133,6 @@ export class NextRequestAdapter {\n     return new NextRequest(request.url, {\n       method: request.method,\n       headers: fromNodeOutgoingHttpHeaders(request.headers),\n-      // @ts-expect-error - see https://github.com/whatwg/fetch/pull/1457\n       duplex: 'half',\n       signal: request.request.signal,\n       // geo"
        },
        {
            "sha": "af5a5c21ab1a89953c7a9b37fa70efd646eb674a",
            "filename": "packages/next/src/server/web/spec-extension/request.ts",
            "status": "modified",
            "additions": 15,
            "deletions": 0,
            "changes": 15,
            "blob_url": "https://github.com/vercel/next.js/blob/aeaa006b14b4bfb55adab23fe304ec55ea206e3c/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frequest.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aeaa006b14b4bfb55adab23fe304ec55ea206e3c/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frequest.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fspec-extension%2Frequest.ts?ref=aeaa006b14b4bfb55adab23fe304ec55ea206e3c",
            "patch": "@@ -21,9 +21,22 @@ export class NextRequest extends Request {\n   constructor(input: URL | RequestInfo, init: RequestInit = {}) {\n     const url =\n       typeof input !== 'string' && 'url' in input ? input.url : String(input)\n+\n     validateURL(url)\n+\n+    // node Request instance requires duplex option when a body\n+    // is present or it errors, we don't handle this for\n+    // Request being passed in since it would have already\n+    // errored if this wasn't configured\n+    if (process.env.NEXT_RUNTIME !== 'edge') {\n+      if (init.body && init.duplex !== 'half') {\n+        init.duplex = 'half'\n+      }\n+    }\n+\n     if (input instanceof Request) super(input, init)\n     else super(url, init)\n+\n     const nextUrl = new NextURL(url, {\n       headers: toNodeOutgoingHttpHeaders(this.headers),\n       nextConfig: init.nextConfig,\n@@ -97,4 +110,6 @@ export interface RequestInit extends globalThis.RequestInit {\n     trailingSlash?: boolean\n   }\n   signal?: AbortSignal\n+  // see https://github.com/whatwg/fetch/pull/1457\n+  duplex?: 'half'\n }"
        },
        {
            "sha": "81ab1506107e1961fccac5ca3f94e6ceea40fcf5",
            "filename": "test/unit/web-runtime/next-request-node.test.ts",
            "status": "added",
            "additions": 59,
            "deletions": 0,
            "changes": 59,
            "blob_url": "https://github.com/vercel/next.js/blob/aeaa006b14b4bfb55adab23fe304ec55ea206e3c/test%2Funit%2Fweb-runtime%2Fnext-request-node.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aeaa006b14b4bfb55adab23fe304ec55ea206e3c/test%2Funit%2Fweb-runtime%2Fnext-request-node.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fweb-runtime%2Fnext-request-node.test.ts?ref=aeaa006b14b4bfb55adab23fe304ec55ea206e3c",
            "patch": "@@ -0,0 +1,59 @@\n+// this file must not use the edge-runtime env setup\n+// so that we test node runtime properly\n+import { expectTypeOf } from 'expect-type'\n+import { NextRequest } from 'next/dist/server/web/spec-extension/request'\n+\n+it('should have 1 required parameter for constructor', () => {\n+  expect(NextRequest.length).toBe(1)\n+})\n+\n+it('should allow the 2nd parameter to be undefined', () => {\n+  const request = new NextRequest('https://vercel.com')\n+  expectTypeOf(request).toMatchTypeOf<NextRequest>()\n+\n+  expect(new NextRequest('https://vercel.com')).toHaveProperty(\n+    'nextUrl.pathname',\n+    '/'\n+  )\n+})\n+\n+it('should clone Request with headers', () => {\n+  const request = new Request('https://example.com', {\n+    headers: { 'x-foo': 'bar' },\n+  })\n+\n+  const nextRequest = new NextRequest(request)\n+\n+  expect(Object.fromEntries(nextRequest.headers)).toEqual(\n+    Object.fromEntries(request.headers)\n+  )\n+\n+  // Second argument should override headers\n+  const headers = new Headers({ 'x-header': 'some header' })\n+  const nextRequest2 = new NextRequest(request, { headers })\n+\n+  expect(Object.fromEntries(nextRequest2.headers)).toEqual(\n+    Object.fromEntries(headers)\n+  )\n+})\n+\n+it('should handle Request with body', () => {\n+  let nextRequest = new NextRequest('https://example.com', {\n+    body: new ReadableStream(),\n+    method: 'POST',\n+  })\n+  expect(nextRequest.body).toBeTruthy()\n+  expect(nextRequest.method).toBe('POST')\n+\n+  const request = new Request('https://example.com', {\n+    body: new ReadableStream(),\n+    method: 'POST',\n+    // @ts-expect-error this exists but not in type\n+    duplex: 'half',\n+  })\n+\n+  nextRequest = new NextRequest(request)\n+\n+  expect(nextRequest.body).toBeTruthy()\n+  expect(nextRequest.method).toBe('POST')\n+})"
        },
        {
            "sha": "6cd528fdee76c7249c6d7cba86329eec037ad8b7",
            "filename": "test/unit/web-runtime/next-request.test.ts",
            "status": "modified",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/aeaa006b14b4bfb55adab23fe304ec55ea206e3c/test%2Funit%2Fweb-runtime%2Fnext-request.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/aeaa006b14b4bfb55adab23fe304ec55ea206e3c/test%2Funit%2Fweb-runtime%2Fnext-request.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Funit%2Fweb-runtime%2Fnext-request.test.ts?ref=aeaa006b14b4bfb55adab23fe304ec55ea206e3c",
            "patch": "@@ -38,3 +38,24 @@ it('should clone Request with headers', () => {\n     Object.fromEntries(headers)\n   )\n })\n+\n+it('should handle Request with body', () => {\n+  let nextRequest = new NextRequest('https://example.com', {\n+    body: new ReadableStream(),\n+    method: 'POST',\n+  })\n+  expect(nextRequest.body).toBeTruthy()\n+  expect(nextRequest.method).toBe('POST')\n+\n+  const request = new Request('https://example.com', {\n+    body: new ReadableStream(),\n+    method: 'POST',\n+    // @ts-expect-error this exists but not in type\n+    duplex: 'half',\n+  })\n+\n+  nextRequest = new NextRequest(request)\n+\n+  expect(nextRequest.body).toBeTruthy()\n+  expect(nextRequest.method).toBe('POST')\n+})"
        }
    ],
    "stats": {
        "total": 97,
        "additions": 95,
        "deletions": 2
    }
}