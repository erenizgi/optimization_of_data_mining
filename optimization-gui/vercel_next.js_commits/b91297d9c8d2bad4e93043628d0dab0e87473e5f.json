{
    "author": "unstubbable",
    "message": "Use snapshots to verify dynamic validation errors in dev mode (#80992)\n\nFollow-up to #80946, asserting on the collapsed redbox errors in dev mode.\r\n\r\n> [!NOTE]  \r\n> This PR is best reviewed with hidden whitespace changes.",
    "sha": "b91297d9c8d2bad4e93043628d0dab0e87473e5f",
    "files": [
        {
            "sha": "6b80ad464cfd7704cd72384d5e9287a6a3bcc351",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.platform-dynamic.test.ts",
            "status": "modified",
            "additions": 114,
            "deletions": 79,
            "changes": 193,
            "blob_url": "https://github.com/vercel/next.js/blob/b91297d9c8d2bad4e93043628d0dab0e87473e5f/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b91297d9c8d2bad4e93043628d0dab0e87473e5f/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.platform-dynamic.test.ts?ref=b91297d9c8d2bad4e93043628d0dab0e87473e5f",
            "patch": "@@ -1,119 +1,154 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { assertNoErrorToast } from 'next-test-utils'\n import { getPrerenderOutput } from './utils'\n \n describe.each([\n-  { inDebugMode: true, name: 'With --prerender-debug' },\n-  { inDebugMode: false, name: 'Without --prerender-debug' },\n-])('Dynamic IO Errors - $name', ({ inDebugMode }) => {\n+  { inPrerenderDebugMode: true, name: 'With --prerender-debug' },\n+  // { inPrerenderDebugMode: false, name: 'Without --prerender-debug' },\n+])('Dynamic IO Errors - $name', ({ inPrerenderDebugMode }) => {\n+  // We want to skip building and starting in start mode, and in dev mode when\n+  // prerender debug mode is enabled, which doesn't exist for `next dev`.\n+  const skipStart =\n+    process.env.NEXT_TEST_MODE === 'start' || inPrerenderDebugMode\n+\n   describe('Sync Dynamic - With Fallback - Math.random()', () => {\n     const { next, isNextDev, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/sync-random-with-fallback',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should not error the build when calling Math.random() if all dynamic access is inside a Suspense boundary', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        throw new Error('expected build not to fail for fully static project')\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      expect(next.cliOutput).toContain('◐ / ')\n-      const $ = await next.render$('/')\n-      expect($('[data-fallback]').length).toBe(2)\n-    })\n+      it('should not show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+        await assertNoErrorToast(browser)\n+      })\n+    } else {\n+      it('should not error the build when calling Math.random() if all dynamic access is inside a Suspense boundary', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+\n+        expect(next.cliOutput).toContain('◐ / ')\n+        const $ = await next.render$('/')\n+        expect($('[data-fallback]').length).toBe(2)\n+      })\n+    }\n   })\n \n   describe('Sync Dynamic - Without Fallback - Math.random()', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/sync-random-without-fallback',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if Math.random() happens before some component outside a Suspense boundary is complete', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/page.tsx (35:23) @ RandomReadingComponent\n+         > 35 |   const random = Math.random()\n+              |                       ^\",\n+           \"stack\": [\n+             \"RandomReadingComponent app/page.tsx (35:23)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"LogSafely <anonymous> (0:0)\",\n+           ],\n+         }\n+        `)\n       })\n+    } else {\n+      it('should error the build if Math.random() happens before some component outside a Suspense boundary is complete', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n+        }\n \n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-               at RandomReadingComponent (turbopack:///[project]/app/page.tsx:35:22)\n-             33 |     use(new Promise((r) => process.nextTick(r)))\n-             34 |   }\n-           > 35 |   const random = Math.random()\n-                |                      ^\n-             36 |   return (\n-             37 |     <div>\n-             38 |       <span id=\"rand\">{random}</span>\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n \n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-               at a (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n-        }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-               at RandomReadingComponent (webpack:///app/page.tsx:35:22)\n-             33 |     use(new Promise((r) => process.nextTick(r)))\n-             34 |   }\n-           > 35 |   const random = Math.random()\n-                |                      ^\n-             36 |   return (\n-             37 |     <div>\n-             38 |       <span id=\"rand\">{random}</span>\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+                 at RandomReadingComponent (turbopack:///[project]/app/page.tsx:35:22)\n+               33 |     use(new Promise((r) => process.nextTick(r)))\n+               34 |   }\n+             > 35 |   const random = Math.random()\n+                  |                      ^\n+               36 |   return (\n+               37 |     <div>\n+               38 |       <span id=\"rand\">{random}</span>\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n \n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+                 at a (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n-               at a (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+                 at RandomReadingComponent (webpack:///app/page.tsx:35:22)\n+               33 |     use(new Promise((r) => process.nextTick(r)))\n+               34 |   }\n+             > 35 |   const random = Math.random()\n+                  |                      ^\n+               36 |   return (\n+               37 |     <div>\n+               38 |       <span id=\"rand\">{random}</span>\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`Math.random()\\` outside of \\`\"use cache\"\\` and without explicitly calling \\`await connection()\\` beforehand. See more info here: https://nextjs.org/docs/messages/next-prerender-random\n+                 at a (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n })"
        },
        {
            "sha": "f9980e198f61d14e99e8e84e8e1012ce4ade8b02",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.sync-attribution.test.ts",
            "status": "modified",
            "additions": 344,
            "deletions": 235,
            "changes": 579,
            "blob_url": "https://github.com/vercel/next.js/blob/b91297d9c8d2bad4e93043628d0dab0e87473e5f/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b91297d9c8d2bad4e93043628d0dab0e87473e5f/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-attribution.test.ts?ref=b91297d9c8d2bad4e93043628d0dab0e87473e5f",
            "patch": "@@ -3,26 +3,35 @@ import { assertNoErrorToast } from 'next-test-utils'\n import { getPrerenderOutput } from './utils'\n \n describe.each([\n-  { inDebugMode: true, name: 'With --prerender-debug' },\n-  { inDebugMode: false, name: 'Without --prerender-debug' },\n-])('Dynamic IO Errors - $name', ({ inDebugMode }) => {\n+  { inPrerenderDebugMode: true, name: 'With --prerender-debug' },\n+  { inPrerenderDebugMode: false, name: 'Without --prerender-debug' },\n+])('Dynamic IO Errors - $name', ({ inPrerenderDebugMode }) => {\n+  // We want to skip building and starting in start mode, and in dev mode when\n+  // prerender debug mode is enabled, which doesn't exist for `next dev`.\n+  const skipStart =\n+    process.env.NEXT_TEST_MODE === 'start' || inPrerenderDebugMode\n+\n   describe('Error Attribution with Sync IO - Guarded RSC with guarded Client sync IO', () => {\n     const { next, isNextDev, skipped } = nextTestSetup({\n       files:\n         __dirname +\n         '/fixtures/sync-attribution/guarded-async-guarded-clientsync',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n+      }\n+\n       it('does not show a validation error in the dev overlay', async () => {\n-        await next.start()\n         const browser = await next.browser('/')\n         await assertNoErrorToast(browser)\n       })\n@@ -43,293 +52,393 @@ describe.each([\n       files:\n         __dirname +\n         '/fixtures/sync-attribution/guarded-async-unguarded-clientsync',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build with a reason related to sync IO access', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n-      })\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n \n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-               at SyncIO (turbopack:///[project]/app/client.tsx:5:15)\n-             3 | export function SyncIO() {\n-             4 |   // This is a sync IO access that should not cause an error\n-           > 5 |   const data = new Date().toISOString()\n-               |               ^\n-             6 |\n-             7 |   return (\n-             8 |     <main>\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-               at a (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/client.tsx (5:16) @ SyncIO\n+         > 5 |   const data = new Date().toISOString()\n+             |                ^\",\n+           \"stack\": [\n+             \"SyncIO app/client.tsx (5:16)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"LogSafely <anonymous> (0:0)\",\n+           ],\n+         }\n+        `)\n+      })\n+    } else {\n+      it('should error the build with a reason related to sync IO access', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-               at SyncIO (webpack:///app/client.tsx:5:15)\n-             3 | export function SyncIO() {\n-             4 |   // This is a sync IO access that should not cause an error\n-           > 5 |   const data = new Date().toISOString()\n-               |               ^\n-             6 |\n-             7 |   return (\n-             8 |     <main>\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+                 at SyncIO (turbopack:///[project]/app/client.tsx:5:15)\n+               3 | export function SyncIO() {\n+               4 |   // This is a sync IO access that should not cause an error\n+             > 5 |   const data = new Date().toISOString()\n+                 |               ^\n+               6 |\n+               7 |   return (\n+               8 |     <main>\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+                 at a (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-               at a (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+                 at SyncIO (webpack:///app/client.tsx:5:15)\n+               3 | export function SyncIO() {\n+               4 |   // This is a sync IO access that should not cause an error\n+             > 5 |   const data = new Date().toISOString()\n+                 |               ^\n+               6 |\n+               7 |   return (\n+               8 |     <main>\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+                 at a (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Error Attribution with Sync IO - Unguarded RSC with guarded Client sync IO', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files:\n         __dirname +\n         '/fixtures/sync-attribution/unguarded-async-guarded-clientsync',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build with a reason related dynamic data', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n-      })\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n \n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at section (<anonymous>)\n-               at main (<anonymous>)\n-               at RenderFromTemplateContext (<anonymous>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": null,\n+             \"stack\": [\n+               \"RequestData [Server] <anonymous> (1:29)\",\n+               \"section <anonymous> (1:16)\",\n+               \"main <anonymous> (1:13)\",\n+               \"<FIXME-file-protocol>\",\n+               \"main <anonymous> (1:13)\",\n+               \"body <anonymous> (1:13)\",\n+               \"html <anonymous> (1:13)\",\n+               \"Root [Server] <anonymous> (1:22)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"LogSafely <anonymous> (0:0)\",\n+             ],\n+           }\n           `)\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at a (<anonymous>)\n-               at main (<anonymous>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-               at d (<next-dist-dir>)\n-               at e (<next-dist-dir>)\n-               at f (<next-dist-dir>)\n-               at g (<next-dist-dir>)\n-               at h (<next-dist-dir>)\n-               at i (<next-dist-dir>)\n-               at j (<next-dist-dir>)\n-               at k (<anonymous>)\n-               at l (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (27:9) @ Page\n+           > 27 |         <RequestData />\n+                |         ^\",\n+             \"stack\": [\n+               \"RequestData [Server] <anonymous> (1:29)\",\n+               \"section <anonymous> (1:16)\",\n+               \"main <anonymous> (1:13)\",\n+               \"Page app/page.tsx (27:9)\",\n+               \"main <anonymous> (1:13)\",\n+               \"body <anonymous> (1:13)\",\n+               \"html <anonymous> (1:13)\",\n+               \"Root [Server] <anonymous> (1:22)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"LogSafely <anonymous> (0:0)\",\n+             ],\n+           }\n           `)\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at section (<anonymous>)\n-               at main (<anonymous>)\n-               at InnerLayoutRouter (webpack://<next-src>)\n-               at RedirectErrorBoundary (webpack://<next-src>)\n-               at RedirectBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-               at LoadingBoundary (webpack://<next-src>)\n-               at ErrorBoundary (webpack://<next-src>)\n-               at InnerScrollAndFocusHandler (webpack://<next-src>)\n-               at ScrollAndFocusHandler (webpack://<next-src>)\n-               at RenderFromTemplateContext (<anonymous>)\n-               at OuterLayoutRouter (webpack://<next-src>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-             332 |  */\n-             333 | function InnerLayoutRouter({\n-           > 334 |   tree,\n-                 |  ^\n-             335 |   segmentPath,\n-             336 |   cacheNode,\n-             337 |   url,\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+      })\n+    } else {\n+      it('should error the build with a reason related dynamic data', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n+        }\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at section (<anonymous>)\n+                 at main (<anonymous>)\n+                 at RenderFromTemplateContext (<anonymous>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at a (<anonymous>)\n+                 at main (<anonymous>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+                 at g (<next-dist-dir>)\n+                 at h (<next-dist-dir>)\n+                 at i (<next-dist-dir>)\n+                 at j (<next-dist-dir>)\n+                 at k (<anonymous>)\n+                 at l (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at a (<anonymous>)\n-               at main (<anonymous>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-               at d (<next-dist-dir>)\n-               at e (<next-dist-dir>)\n-               at f (<next-dist-dir>)\n-               at g (<next-dist-dir>)\n-               at h (<next-dist-dir>)\n-               at i (<next-dist-dir>)\n-               at j (<next-dist-dir>)\n-               at k (<anonymous>)\n-               at l (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at section (<anonymous>)\n+                 at main (<anonymous>)\n+                 at InnerLayoutRouter (webpack://<next-src>)\n+                 at RedirectErrorBoundary (webpack://<next-src>)\n+                 at RedirectBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+                 at LoadingBoundary (webpack://<next-src>)\n+                 at ErrorBoundary (webpack://<next-src>)\n+                 at InnerScrollAndFocusHandler (webpack://<next-src>)\n+                 at ScrollAndFocusHandler (webpack://<next-src>)\n+                 at RenderFromTemplateContext (<anonymous>)\n+                 at OuterLayoutRouter (webpack://<next-src>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+               332 |  */\n+               333 | function InnerLayoutRouter({\n+             > 334 |   tree,\n+                   |  ^\n+               335 |   segmentPath,\n+               336 |   cacheNode,\n+               337 |   url,\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at a (<anonymous>)\n+                 at main (<anonymous>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+                 at g (<next-dist-dir>)\n+                 at h (<next-dist-dir>)\n+                 at i (<next-dist-dir>)\n+                 at j (<next-dist-dir>)\n+                 at k (<anonymous>)\n+                 at l (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Error Attribution with Sync IO - unguarded RSC with unguarded Client sync IO', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files:\n         __dirname +\n         '/fixtures/sync-attribution/unguarded-async-unguarded-clientsync',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build with a reason related to sync IO access', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n-      })\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n \n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-               at SyncIO (turbopack:///[project]/app/client.tsx:5:15)\n-             3 | export function SyncIO() {\n-             4 |   // This is a sync IO access that should not cause an error\n-           > 5 |   const data = new Date().toISOString()\n-               |               ^\n-             6 |\n-             7 |   return (\n-             8 |     <main>\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-               at a (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/client.tsx (5:16) @ SyncIO\n+         > 5 |   const data = new Date().toISOString()\n+             |                ^\",\n+           \"stack\": [\n+             \"SyncIO app/client.tsx (5:16)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"LogSafely <anonymous> (0:0)\",\n+           ],\n+         }\n+        `)\n+      })\n+    } else {\n+      it('should error the build with a reason related to sync IO access', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-               at SyncIO (webpack:///app/client.tsx:5:15)\n-             3 | export function SyncIO() {\n-             4 |   // This is a sync IO access that should not cause an error\n-           > 5 |   const data = new Date().toISOString()\n-               |               ^\n-             6 |\n-             7 |   return (\n-             8 |     <main>\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+                 at SyncIO (turbopack:///[project]/app/client.tsx:5:15)\n+               3 | export function SyncIO() {\n+               4 |   // This is a sync IO access that should not cause an error\n+             > 5 |   const data = new Date().toISOString()\n+                 |               ^\n+               6 |\n+               7 |   return (\n+               8 |     <main>\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+                 at a (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n-               at a (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+                 at SyncIO (webpack:///app/client.tsx:5:15)\n+               3 | export function SyncIO() {\n+               4 |   // This is a sync IO access that should not cause an error\n+             > 5 |   const data = new Date().toISOString()\n+                 |               ^\n+               6 |\n+               7 |   return (\n+               8 |     <main>\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`new Date()\\` inside a Client Component without a Suspense boundary above it. See more info here: https://nextjs.org/docs/messages/next-prerender-current-time-client\n+                 at a (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n })"
        },
        {
            "sha": "27d96c7bef0bb46fb705485d9bab413050b6d0c8",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.sync-dynamic.test.ts",
            "status": "modified",
            "additions": 505,
            "deletions": 304,
            "changes": 809,
            "blob_url": "https://github.com/vercel/next.js/blob/b91297d9c8d2bad4e93043628d0dab0e87473e5f/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b91297d9c8d2bad4e93043628d0dab0e87473e5f/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.sync-dynamic.test.ts?ref=b91297d9c8d2bad4e93043628d0dab0e87473e5f",
            "patch": "@@ -2,409 +2,610 @@ import { nextTestSetup } from 'e2e-utils'\n import { getPrerenderOutput } from './utils'\n \n describe.each([\n-  { inDebugMode: true, name: 'With --prerender-debug' },\n-  { inDebugMode: false, name: 'Without --prerender-debug' },\n-])('Dynamic IO Errors - $name', ({ inDebugMode }) => {\n+  { inPrerenderDebugMode: true, name: 'With --prerender-debug' },\n+  { inPrerenderDebugMode: false, name: 'Without --prerender-debug' },\n+])('Dynamic IO Errors - $name', ({ inPrerenderDebugMode }) => {\n+  // We want to skip building and starting in start mode, and in dev mode when\n+  // prerender debug mode is enabled, which doesn't exist for `next dev`.\n+  const skipStart =\n+    process.env.NEXT_TEST_MODE === 'start' || inPrerenderDebugMode\n+\n   describe('Sync Dynamic - With Fallback - client searchParams', () => {\n     const { next, isNextDev, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/sync-client-search-with-fallback',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        throw new Error('expected build not to fail for fully static project')\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      expect(next.cliOutput).toContain('◐ / ')\n-      const $ = await next.render$('/')\n-      expect($('[data-fallback]').length).toBe(2)\n-    })\n+      // We don't error the build, but we do show a dev-only error so that users\n+      // migrate to the async usage.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"A searchParam property was accessed directly with \\`searchParams.foo\\`. \\`searchParams\\` should be unwrapped with \\`React.use()\\` before accessing its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+           \"environmentLabel\": null,\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/page.tsx (44:5) @ SearchParamsReadingComponent\n+         > 44 |   ).foo\n+              |     ^\",\n+           \"stack\": [\n+             \"SearchParamsReadingComponent app/page.tsx (44:5)\",\n+             \"Page app/page.tsx (19:11)\",\n+           ],\n+         }\n+        `)\n+      })\n+    } else {\n+      it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+\n+        expect(next.cliOutput).toContain('◐ / ')\n+        const $ = await next.render$('/')\n+        expect($('[data-fallback]').length).toBe(2)\n+      })\n+    }\n   })\n \n   describe('Sync Dynamic - Without Fallback - client searchParams', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/sync-client-search-without-fallback',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n+      it('should show a collapsed redbox with two errors', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (52:8) @ LongRunningComponent\n+         > 52 |     use(\n+              |        ^\",\n+             \"stack\": [\n+               \"LongRunningComponent app/page.tsx (52:8)\",\n+               \"IndirectionTwo app/indirection.tsx (7:34)\",\n+               \"Page app/page.tsx (19:61)\",\n+               \"main <anonymous> (1:13)\",\n+               \"body <anonymous> (1:13)\",\n+               \"html <anonymous> (1:13)\",\n+               \"Root [Server] <anonymous> (1:22)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"LogSafely <anonymous> (0:0)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"A searchParam property was accessed directly with \\`searchParams.foo\\`. \\`searchParams\\` should be unwrapped with \\`React.use()\\` before accessing its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": null,\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (42:5) @ SearchParamsReadingComponent\n+         > 42 |   ).foo\n+              |     ^\",\n+             \"stack\": [\n+               \"SearchParamsReadingComponent app/page.tsx (42:5)\",\n+               \"Page app/page.tsx (19:11)\",\n+             ],\n+           },\n+         ]\n+        `)\n       })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at LongRunningComponent (<anonymous>)\n-               at IndirectionTwo (turbopack:///[project]/app/indirection.tsx:7:33)\n-               at Page (turbopack:///[project]/app/page.tsx:19:60)\n-               at RenderFromTemplateContext (<anonymous>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-              5 | }\n-              6 |\n-           >  7 | export function IndirectionTwo({ children }) {\n-                |                                 ^\n-              8 |   return children\n-              9 | }\n-             10 |\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at a (<anonymous>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-               at d (<next-dist-dir>)\n-               at e (<next-dist-dir>)\n-               at f (<next-dist-dir>)\n-               at g (<next-dist-dir>)\n-               at h (<next-dist-dir>)\n-               at i (<next-dist-dir>)\n-               at j (<next-dist-dir>)\n-               at k (<next-dist-dir>)\n-               at l (<next-dist-dir>)\n-               at m (<next-dist-dir>)\n-               at n (<anonymous>)\n-               at o (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+    } else {\n+      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at LongRunningComponent (<anonymous>)\n-               at IndirectionTwo (webpack:///app/indirection.tsx:7:33)\n-               at Page (webpack:///app/page.tsx:19:60)\n-               at ClientPageRoot (webpack://<next-src>)\n-               at InnerLayoutRouter (webpack://<next-src>)\n-               at RedirectErrorBoundary (webpack://<next-src>)\n-               at RedirectBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-               at LoadingBoundary (webpack://<next-src>)\n-               at ErrorBoundary (webpack://<next-src>)\n-               at InnerScrollAndFocusHandler (webpack://<next-src>)\n-               at ScrollAndFocusHandler (webpack://<next-src>)\n-               at RenderFromTemplateContext (<anonymous>)\n-               at OuterLayoutRouter (webpack://<next-src>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-              5 | }\n-              6 |\n-           >  7 | export function IndirectionTwo({ children }) {\n-                |                                 ^\n-              8 |   return children\n-              9 | }\n-             10 |\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at LongRunningComponent (<anonymous>)\n+                 at IndirectionTwo (turbopack:///[project]/app/indirection.tsx:7:33)\n+                 at Page (turbopack:///[project]/app/page.tsx:19:60)\n+                 at RenderFromTemplateContext (<anonymous>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+                5 | }\n+                6 |\n+             >  7 | export function IndirectionTwo({ children }) {\n+                  |                                 ^\n+                8 |   return children\n+                9 | }\n+               10 |\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at a (<anonymous>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+                 at g (<next-dist-dir>)\n+                 at h (<next-dist-dir>)\n+                 at i (<next-dist-dir>)\n+                 at j (<next-dist-dir>)\n+                 at k (<next-dist-dir>)\n+                 at l (<next-dist-dir>)\n+                 at m (<next-dist-dir>)\n+                 at n (<anonymous>)\n+                 at o (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at a (<anonymous>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-               at d (<next-dist-dir>)\n-               at e (<next-dist-dir>)\n-               at f (<next-dist-dir>)\n-               at g (<next-dist-dir>)\n-               at h (<next-dist-dir>)\n-               at i (<next-dist-dir>)\n-               at j (<next-dist-dir>)\n-               at k (<next-dist-dir>)\n-               at l (<next-dist-dir>)\n-               at m (<next-dist-dir>)\n-               at n (<anonymous>)\n-               at o (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at LongRunningComponent (<anonymous>)\n+                 at IndirectionTwo (webpack:///app/indirection.tsx:7:33)\n+                 at Page (webpack:///app/page.tsx:19:60)\n+                 at ClientPageRoot (webpack://<next-src>)\n+                 at InnerLayoutRouter (webpack://<next-src>)\n+                 at RedirectErrorBoundary (webpack://<next-src>)\n+                 at RedirectBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+                 at LoadingBoundary (webpack://<next-src>)\n+                 at ErrorBoundary (webpack://<next-src>)\n+                 at InnerScrollAndFocusHandler (webpack://<next-src>)\n+                 at ScrollAndFocusHandler (webpack://<next-src>)\n+                 at RenderFromTemplateContext (<anonymous>)\n+                 at OuterLayoutRouter (webpack://<next-src>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+                5 | }\n+                6 |\n+             >  7 | export function IndirectionTwo({ children }) {\n+                  |                                 ^\n+                8 |   return children\n+                9 | }\n+               10 |\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at a (<anonymous>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+                 at g (<next-dist-dir>)\n+                 at h (<next-dist-dir>)\n+                 at i (<next-dist-dir>)\n+                 at j (<next-dist-dir>)\n+                 at k (<next-dist-dir>)\n+                 at l (<next-dist-dir>)\n+                 at m (<next-dist-dir>)\n+                 at n (<anonymous>)\n+                 at o (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Sync Dynamic - With Fallback - server searchParams', () => {\n     const { next, isNextDev, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/sync-server-search-with-fallback',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        throw new Error('expected build not to fail for fully static project')\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      expect(next.cliOutput).toContain('◐ / ')\n-      const $ = await next.render$('/')\n-      expect($('[data-fallback]').length).toBe(2)\n-    })\n+      // We don't error the build, but we do show a dev-only error so that users\n+      // migrate to the async usage.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+           \"environmentLabel\": \"Prerender\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/page.tsx (42:5) @ SearchParamsReadingComponent\n+         > 42 |   ).foo\n+              |     ^\",\n+           \"stack\": [\n+             \"SearchParamsReadingComponent app/page.tsx (42:5)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"Page app/page.tsx (19:11)\",\n+           ],\n+         }\n+        `)\n+      })\n+    } else {\n+      it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+\n+        expect(next.cliOutput).toContain('◐ / ')\n+        const $ = await next.render$('/')\n+        expect($('[data-fallback]').length).toBe(2)\n+      })\n+    }\n   })\n \n   describe('Sync Dynamic - Without Fallback - server searchParams', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/sync-server-search-without-fallback',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n+      // TODO: Ideally we'd only show the error once.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": \"Prerender\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (40:5) @ SearchParamsReadingComponent\n+         > 40 |   ).foo\n+              |     ^\",\n+             \"stack\": [\n+               \"SearchParamsReadingComponent app/page.tsx (40:5)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"Page app/page.tsx (19:11)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (40:5) @ SearchParamsReadingComponent\n+         > 40 |   ).foo\n+              |     ^\",\n+             \"stack\": [\n+               \"SearchParamsReadingComponent app/page.tsx (40:5)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"LogSafely <anonymous> (0:0)\",\n+             ],\n+           },\n+         ]\n+        `)\n       })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-               at SearchParamsReadingComponent (turbopack:///[project]/app/page.tsx:40:4)\n-             38 |   const fooParams = (\n-             39 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n-           > 40 |   ).foo\n-                |    ^\n-             41 |   return (\n-             42 |     <div>\n-             43 |       this component read the accessed the \\`foo\\` search param: {fooParams}\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-               at a (<next-dist-dir>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+    } else {\n+      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-               at SearchParamsReadingComponent (webpack:///app/page.tsx:40:4)\n-             38 |   const fooParams = (\n-             39 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n-           > 40 |   ).foo\n-                |    ^\n-             41 |   return (\n-             42 |     <div>\n-             43 |       this component read the accessed the \\`foo\\` search param: {fooParams}\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at SearchParamsReadingComponent (turbopack:///[project]/app/page.tsx:40:4)\n+               38 |   const fooParams = (\n+               39 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n+             > 40 |   ).foo\n+                  |    ^\n+               41 |   return (\n+               42 |     <div>\n+               43 |       this component read the accessed the \\`foo\\` search param: {fooParams}\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-               at a (<next-dist-dir>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at SearchParamsReadingComponent (webpack:///app/page.tsx:40:4)\n+               38 |   const fooParams = (\n+               39 |     searchParams as unknown as UnsafeUnwrappedSearchParams<typeof searchParams>\n+             > 40 |   ).foo\n+                  |    ^\n+               41 |   return (\n+               42 |     <div>\n+               43 |       this component read the accessed the \\`foo\\` search param: {fooParams}\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`searchParams.foo\\`. \\`searchParams\\` should be awaited before using its properties. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Sync Dynamic - With Fallback - cookies', () => {\n     const { next, isNextDev, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/sync-cookies-with-fallback',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        throw new Error('expected build not to fail for fully static project')\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      expect(next.cliOutput).toContain('◐ / ')\n-      const $ = await next.render$('/')\n-      expect($('[data-fallback]').length).toBe(2)\n-    })\n+      // We don't error the build, but we do show a dev-only error so that users\n+      // migrate to the async usage.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": \"app/page.tsx (34:67) @ CookiesReadingComponent\n+         > 34 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+              |                                                                   ^\",\n+           \"stack\": [\n+             \"CookiesReadingComponent app/page.tsx (34:67)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"JSON.parse <anonymous> (0:0)\",\n+             \"Page app/page.tsx (17:11)\",\n+           ],\n+         }\n+        `)\n+      })\n+    } else {\n+      it('should not error the build when synchronously reading search params in a client component if all dynamic access is inside a Suspense boundary', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+\n+        expect(next.cliOutput).toContain('◐ / ')\n+        const $ = await next.render$('/')\n+        expect($('[data-fallback]').length).toBe(2)\n+      })\n+    }\n   })\n \n   describe('Sync Dynamic - Without Fallback - cookies', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/sync-cookies-without-fallback',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n+      // TODO: Ideally we'd only show the error once.\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         [\n+           {\n+             \"description\": \"Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (32:67) @ CookiesReadingComponent\n+         > 32 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+              |                                                                   ^\",\n+             \"stack\": [\n+               \"CookiesReadingComponent app/page.tsx (32:67)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"Page app/page.tsx (17:11)\",\n+             ],\n+           },\n+           {\n+             \"description\": \"Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (32:67) @ CookiesReadingComponent\n+         > 32 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+              |                                                                   ^\",\n+             \"stack\": [\n+               \"CookiesReadingComponent app/page.tsx (32:67)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"LogSafely <anonymous> (0:0)\",\n+             ],\n+           },\n+         ]\n+        `)\n       })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-               at CookiesReadingComponent (turbopack:///[project]/app/page.tsx:32:66)\n-             30 | async function CookiesReadingComponent() {\n-             31 |   await new Promise((r) => process.nextTick(r))\n-           > 32 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n-                |                                                                  ^\n-             33 |   return <div>this component read the \\`token\\` cookie synchronously</div>\n-             34 | }\n-             35 |\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-               at a (<next-dist-dir>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+    } else {\n+      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-               at createCookiesAccessError (webpack://<next-src>)\n-               at Promise.get (webpack://<next-src>)\n-               at CookiesReadingComponent (webpack:///app/page.tsx:32:66)\n-             579 | ) {\n-             580 |   const prefix = route ? \\`Route \"\\${route}\" \\` : 'This route '\n-           > 581 |   return new Error(\n-                 |         ^\n-             582 |     \\`\\${prefix}used \\${expression}. \\` +\n-             583 |       \\`\\\\\\`cookies()\\\\\\` should be awaited before using its value. \\` +\n-             584 |       \\`Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\\`\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at CookiesReadingComponent (turbopack:///[project]/app/page.tsx:32:66)\n+               30 | async function CookiesReadingComponent() {\n+               31 |   await new Promise((r) => process.nextTick(r))\n+             > 32 |   const _token = (cookies() as unknown as UnsafeUnwrappedCookies).get('token')\n+                  |                                                                  ^\n+               33 |   return <div>this component read the \\`token\\` cookie synchronously</div>\n+               34 | }\n+               35 |\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n-               at a (<next-dist-dir>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at createCookiesAccessError (webpack://<next-src>)\n+                 at Promise.get (webpack://<next-src>)\n+                 at CookiesReadingComponent (webpack:///app/page.tsx:32:66)\n+               579 | ) {\n+               580 |   const prefix = route ? \\`Route \"\\${route}\" \\` : 'This route '\n+             > 581 |   return new Error(\n+                   |         ^\n+               582 |     \\`\\${prefix}used \\${expression}. \\` +\n+               583 |       \\`\\\\\\`cookies()\\\\\\` should be awaited before using its value. \\` +\n+               584 |       \\`Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\\`\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\" used \\`cookies().get('token')\\`. \\`cookies()\\` should be awaited before using its value. Learn more: https://nextjs.org/docs/messages/sync-dynamic-apis\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n })"
        },
        {
            "sha": "8ce996be925c667a6de70bd334b284d92b4028db",
            "filename": "test/e2e/app-dir/dynamic-io-errors/dynamic-io-errors.test.ts",
            "status": "modified",
            "additions": 732,
            "deletions": 487,
            "changes": 1219,
            "blob_url": "https://github.com/vercel/next.js/blob/b91297d9c8d2bad4e93043628d0dab0e87473e5f/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/b91297d9c8d2bad4e93043628d0dab0e87473e5f/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fdynamic-io-errors%2Fdynamic-io-errors.test.ts?ref=b91297d9c8d2bad4e93043628d0dab0e87473e5f",
            "patch": "@@ -1,654 +1,899 @@\n import { nextTestSetup } from 'e2e-utils'\n+import { assertNoErrorToast } from 'next-test-utils'\n import { getPrerenderOutput } from './utils'\n \n describe.each([\n-  { inDebugMode: true, name: 'With --prerender-debug' },\n-  { inDebugMode: false, name: 'Without --prerender-debug' },\n-])('Dynamic IO Errors - $name', ({ inDebugMode }) => {\n+  { inPrerenderDebugMode: true, name: 'With --prerender-debug' },\n+  { inPrerenderDebugMode: false, name: 'Without --prerender-debug' },\n+])('Dynamic IO Errors - $name', ({ inPrerenderDebugMode }) => {\n+  // We want to skip building and starting in start mode, and in dev mode when\n+  // prerender debug mode is enabled, which doesn't exist for `next dev`.\n+  const skipStart =\n+    process.env.NEXT_TEST_MODE === 'start' || inPrerenderDebugMode\n+\n   describe('Dynamic Metadata - Static Route', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/dynamic-metadata-static-route',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if generateMetadata is dynamic when the rest of the route is prerenderable', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": null,\n+           \"stack\": [\n+             \"LogSafely <anonymous> (0:0)\",\n+           ],\n+         }\n+        `)\n       })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+    } else {\n+      it('should error the build if generateMetadata is dynamic when the rest of the route is prerenderable', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(\n-            getPrerenderOutput(next.cliOutput, { isMinified: !inDebugMode })\n-          ).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(\n+              getPrerenderOutput(next.cliOutput, {\n+                isMinified: !inPrerenderDebugMode,\n+              })\n+            ).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Dynamic Metadata - Error Route', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/dynamic-metadata-error-route',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    // This test is just here because there was a bug when dynamic metadata was used alongside another dynamic IO violation which caused the validation to be skipped.\n-    it('should error the build for the correct reason when there is a dynamic IO violation alongside dynamic metadata', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n-      })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": null,\n+             \"stack\": [\n+               \"Dynamic [Server] <anonymous> (1:25)\",\n+               \"<FIXME-file-protocol>\",\n+               \"main <anonymous> (1:13)\",\n+               \"body <anonymous> (1:13)\",\n+               \"html <anonymous> (1:13)\",\n+               \"Root [Server] <anonymous> (1:22)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"LogSafely <anonymous> (0:0)\",\n+             ],\n+           }\n           `)\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at a (<next-dist-dir>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-               at d (<next-dist-dir>)\n-               at e (<next-dist-dir>)\n-               at f (<next-dist-dir>)\n-               at g (<next-dist-dir>)\n-               at h (<next-dist-dir>)\n-               at i (<next-dist-dir>)\n-               at j (<next-dist-dir>)\n-               at k (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           {\n+             \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+             \"environmentLabel\": \"Server\",\n+             \"label\": \"Console Error\",\n+             \"source\": \"app/page.tsx (15:7) @ Page\n+           > 15 |       <Dynamic />\n+                |       ^\",\n+             \"stack\": [\n+               \"Dynamic [Server] <anonymous> (1:25)\",\n+               \"Page app/page.tsx (15:7)\",\n+               \"main <anonymous> (1:13)\",\n+               \"body <anonymous> (1:13)\",\n+               \"html <anonymous> (1:13)\",\n+               \"Root [Server] <anonymous> (1:22)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"JSON.parse <anonymous> (0:0)\",\n+               \"LogSafely <anonymous> (0:0)\",\n+             ],\n+           }\n           `)\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at InnerLayoutRouter (webpack://<next-src>)\n-               at RedirectErrorBoundary (webpack://<next-src>)\n-               at RedirectBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-               at LoadingBoundary (webpack://<next-src>)\n-               at ErrorBoundary (webpack://<next-src>)\n-               at InnerScrollAndFocusHandler (webpack://<next-src>)\n-               at ScrollAndFocusHandler (webpack://<next-src>)\n-               at RenderFromTemplateContext (webpack://<next-src>)\n-               at OuterLayoutRouter (webpack://<next-src>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-             332 |  */\n-             333 | function InnerLayoutRouter({\n-           > 334 |   tree,\n-                 |  ^\n-             335 |   segmentPath,\n-             336 |   cacheNode,\n-             337 |   url,\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+      })\n+    } else {\n+      // This test is just here because there was a bug when dynamic metadata was used alongside another dynamic IO violation which caused the validation to be skipped.\n+      it('should error the build for the correct reason when there is a dynamic IO violation alongside dynamic metadata', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n+        }\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+                 at g (<next-dist-dir>)\n+                 at h (<next-dist-dir>)\n+                 at i (<next-dist-dir>)\n+                 at j (<next-dist-dir>)\n+                 at k (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at a (<next-dist-dir>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-               at d (<next-dist-dir>)\n-               at e (<next-dist-dir>)\n-               at f (<next-dist-dir>)\n-               at g (<next-dist-dir>)\n-               at h (<next-dist-dir>)\n-               at i (<next-dist-dir>)\n-               at j (<next-dist-dir>)\n-               at k (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at InnerLayoutRouter (webpack://<next-src>)\n+                 at RedirectErrorBoundary (webpack://<next-src>)\n+                 at RedirectBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+                 at LoadingBoundary (webpack://<next-src>)\n+                 at ErrorBoundary (webpack://<next-src>)\n+                 at InnerScrollAndFocusHandler (webpack://<next-src>)\n+                 at ScrollAndFocusHandler (webpack://<next-src>)\n+                 at RenderFromTemplateContext (webpack://<next-src>)\n+                 at OuterLayoutRouter (webpack://<next-src>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+               332 |  */\n+               333 | function InnerLayoutRouter({\n+             > 334 |   tree,\n+                   |  ^\n+               335 |   segmentPath,\n+               336 |   cacheNode,\n+               337 |   url,\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+                 at g (<next-dist-dir>)\n+                 at h (<next-dist-dir>)\n+                 at i (<next-dist-dir>)\n+                 at j (<next-dist-dir>)\n+                 at k (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Dynamic Metadata - Static Route With Suspense', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/dynamic-metadata-static-with-suspense',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if generateMetadata is dynamic when the rest of the route is prerenderable', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": null,\n+           \"stack\": [\n+             \"LogSafely <anonymous> (0:0)\",\n+           ],\n+         }\n+        `)\n       })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+    } else {\n+      it('should error the build if generateMetadata is dynamic when the rest of the route is prerenderable', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateMetadata\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) when the rest of the route does not. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-metadata\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Dynamic Metadata - Dynamic Route', () => {\n     const { next, isNextDev, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/dynamic-metadata-dynamic-route',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should partially prerender when all dynamic components are inside a Suspense boundary', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        throw new Error('expected build not to fail for fully static project')\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      expect(next.cliOutput).toContain('◐ / ')\n-      const $ = await next.render$('/')\n-      expect($('#dynamic').text()).toBe('Dynamic')\n-      expect($('[data-fallback]').length).toBe(1)\n-    })\n+      it('should not show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+        await assertNoErrorToast(browser)\n+      })\n+    } else {\n+      it('should partially prerender when all dynamic components are inside a Suspense boundary', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+\n+        expect(next.cliOutput).toContain('◐ / ')\n+        const $ = await next.render$('/')\n+        expect($('#dynamic').text()).toBe('Dynamic')\n+        expect($('[data-fallback]').length).toBe(1)\n+      })\n+    }\n   })\n \n   describe('Dynamic Viewport - Static Route', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/dynamic-viewport-static-route',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if generateViewport is dynamic', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": null,\n+           \"stack\": [\n+             \"LogSafely <anonymous> (0:0)\",\n+           ],\n+         }\n+        `)\n       })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+    } else {\n+      it('should error the build if generateViewport is dynamic', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Dynamic Viewport - Dynamic Route', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/dynamic-viewport-dynamic-route',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if generateViewport is dynamic even if there are other uses of dynamic on the page', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n+      it('should show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+\n+        await expect(browser).toDisplayCollapsedRedbox(`\n+         {\n+           \"description\": \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\",\n+           \"environmentLabel\": \"Server\",\n+           \"label\": \"Console Error\",\n+           \"source\": null,\n+           \"stack\": [\n+             \"LogSafely <anonymous> (0:0)\",\n+           ],\n+         }\n+        `)\n       })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n-        } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+    } else {\n+      it('should error the build if generateViewport is dynamic even if there are other uses of dynamic on the page', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n         }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n-          `)\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Route \"/\" has a \\`generateViewport\\` that depends on Request data (\\`cookies()\\`, etc...) or uncached external data (\\`fetch(...)\\`, etc...) without explicitly allowing fully dynamic rendering. See more info here: https://nextjs.org/docs/messages/next-prerender-dynamic-viewport\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Static Route', () => {\n     const { next, isNextDev, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/static',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should not error the build when all routes are static', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n-        throw new Error('expected build not to fail for fully static project')\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n-    })\n+\n+      it('should not show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+        await assertNoErrorToast(browser)\n+      })\n+    } else {\n+      it('should not error the build when all routes are static', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n+          throw new Error('expected build not to fail for fully static project')\n+        }\n+      })\n+    }\n   })\n \n   describe('Dynamic Root', () => {\n     const { next, isNextDev, isTurbopack, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/dynamic-root',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      const output = getPrerenderOutput(next.cliOutput, {\n-        isMinified: !inDebugMode,\n-      })\n-\n-      if (isTurbopack) {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at IndirectionTwo (turbopack:///[project]/app/indirection.tsx:7:33)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-              5 | }\n-              6 |\n+      it('should show a collapsed redbox with two errors', async () => {\n+        const browser = await next.browser('/')\n+\n+        if (isTurbopack) {\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           [\n+             {\n+               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/indirection.tsx (7:34) @ IndirectionTwo\n            >  7 | export function IndirectionTwo({ children }) {\n-                |                                 ^\n-              8 |   return children\n-              9 | }\n-             10 |\n-           Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n+                |                                  ^\",\n+               \"stack\": [\n+                 \"FetchingComponent [Server] <anonymous> (1:35)\",\n+                 \"IndirectionTwo app/indirection.tsx (7:34)\",\n+                 \"<FIXME-file-protocol>\",\n+                 \"main <anonymous> (1:13)\",\n+                 \"body <anonymous> (1:13)\",\n+                 \"html <anonymous> (1:13)\",\n+                 \"Root [Server] <anonymous> (1:22)\",\n+                 \"JSON.parse <anonymous> (0:0)\",\n+                 \"JSON.parse <anonymous> (0:0)\",\n+                 \"LogSafely <anonymous> (0:0)\",\n+               ],\n+             },\n+             {\n+               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": null,\n+               \"stack\": [\n+                 \"FetchingComponent [Server] <anonymous> (1:35)\",\n+                 \"<FIXME-file-protocol>\",\n+                 \"main <anonymous> (1:13)\",\n+                 \"body <anonymous> (1:13)\",\n+                 \"html <anonymous> (1:13)\",\n+                 \"Root [Server] <anonymous> (1:22)\",\n+                 \"JSON.parse <anonymous> (0:0)\",\n+                 \"JSON.parse <anonymous> (0:0)\",\n+                 \"LogSafely <anonymous> (0:0)\",\n+               ],\n+             },\n+           ]\n           `)\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at a (<next-dist-dir>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-               at d (<next-dist-dir>)\n-               at e (<next-dist-dir>)\n-               at f (<next-dist-dir>)\n-               at g (<next-dist-dir>)\n-               at h (<next-dist-dir>)\n-               at i (<next-dist-dir>)\n-               at j (<next-dist-dir>)\n-               at k (<next-dist-dir>)\n-               at l (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at m (<next-dist-dir>)\n-               at n (<next-dist-dir>)\n-               at o (<next-dist-dir>)\n-               at p (<next-dist-dir>)\n-               at q (<next-dist-dir>)\n-               at r (<next-dist-dir>)\n-               at s (<next-dist-dir>)\n-               at t (<next-dist-dir>)\n-               at u (<next-dist-dir>)\n-               at v (<next-dist-dir>)\n-               at w (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n-        }\n-      } else {\n-        if (inDebugMode) {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at IndirectionTwo (webpack:///app/indirection.tsx:7:33)\n-               at InnerLayoutRouter (webpack://<next-src>)\n-               at RedirectErrorBoundary (webpack://<next-src>)\n-               at RedirectBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-               at LoadingBoundary (webpack://<next-src>)\n-               at ErrorBoundary (webpack://<next-src>)\n-               at InnerScrollAndFocusHandler (webpack://<next-src>)\n-               at ScrollAndFocusHandler (webpack://<next-src>)\n-               at RenderFromTemplateContext (webpack://<next-src>)\n-               at OuterLayoutRouter (webpack://<next-src>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-              5 | }\n-              6 |\n+          await expect(browser).toDisplayCollapsedRedbox(`\n+           [\n+             {\n+               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/indirection.tsx (7:34) @ IndirectionTwo\n            >  7 | export function IndirectionTwo({ children }) {\n-                |                                 ^\n-              8 |   return children\n-              9 | }\n-             10 |\n-           Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at InnerLayoutRouter (webpack://<next-src>)\n-               at RedirectErrorBoundary (webpack://<next-src>)\n-               at RedirectBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n-               at HTTPAccessFallbackBoundary (webpack://<next-src>)\n-               at LoadingBoundary (webpack://<next-src>)\n-               at ErrorBoundary (webpack://<next-src>)\n-               at InnerScrollAndFocusHandler (webpack://<next-src>)\n-               at ScrollAndFocusHandler (webpack://<next-src>)\n-               at RenderFromTemplateContext (webpack://<next-src>)\n-               at OuterLayoutRouter (webpack://<next-src>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-             332 |  */\n-             333 | function InnerLayoutRouter({\n-           > 334 |   tree,\n-                 |  ^\n-             335 |   segmentPath,\n-             336 |   cacheNode,\n-             337 |   url,\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-\n-           > Export encountered errors on following paths:\n-           \t/page: /\"\n+                |                                  ^\",\n+               \"stack\": [\n+                 \"FetchingComponent [Server] <anonymous> (1:35)\",\n+                 \"IndirectionTwo app/indirection.tsx (7:34)\",\n+                 \"Page app/page.tsx (16:9)\",\n+                 \"main <anonymous> (1:13)\",\n+                 \"body <anonymous> (1:13)\",\n+                 \"html <anonymous> (1:13)\",\n+                 \"Root [Server] <anonymous> (1:22)\",\n+                 \"JSON.parse <anonymous> (0:0)\",\n+                 \"JSON.parse <anonymous> (0:0)\",\n+                 \"LogSafely <anonymous> (0:0)\",\n+               ],\n+             },\n+             {\n+               \"description\": \"Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\",\n+               \"environmentLabel\": \"Server\",\n+               \"label\": \"Console Error\",\n+               \"source\": \"app/page.tsx (16:9) @ Page\n+           > 16 |         <FetchingComponent nonce=\"a\" cached={true} />\n+                |         ^\",\n+               \"stack\": [\n+                 \"FetchingComponent [Server] <anonymous> (1:35)\",\n+                 \"Page app/page.tsx (16:9)\",\n+                 \"main <anonymous> (1:13)\",\n+                 \"body <anonymous> (1:13)\",\n+                 \"html <anonymous> (1:13)\",\n+                 \"Root [Server] <anonymous> (1:22)\",\n+                 \"JSON.parse <anonymous> (0:0)\",\n+                 \"JSON.parse <anonymous> (0:0)\",\n+                 \"LogSafely <anonymous> (0:0)\",\n+               ],\n+             },\n+           ]\n           `)\n+        }\n+      })\n+    } else {\n+      it('should error the build if dynamic IO happens in the root (outside a Suspense)', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          // we expect the build to fail\n+        }\n+\n+        const output = getPrerenderOutput(next.cliOutput, {\n+          isMinified: !inPrerenderDebugMode,\n+        })\n+\n+        if (isTurbopack) {\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at IndirectionTwo (turbopack:///[project]/app/indirection.tsx:7:33)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+                5 | }\n+                6 |\n+             >  7 | export function IndirectionTwo({ children }) {\n+                  |                                 ^\n+                8 |   return children\n+                9 | }\n+               10 |\n+             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+                 at g (<next-dist-dir>)\n+                 at h (<next-dist-dir>)\n+                 at i (<next-dist-dir>)\n+                 at j (<next-dist-dir>)\n+                 at k (<next-dist-dir>)\n+                 at l (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at m (<next-dist-dir>)\n+                 at n (<next-dist-dir>)\n+                 at o (<next-dist-dir>)\n+                 at p (<next-dist-dir>)\n+                 at q (<next-dist-dir>)\n+                 at r (<next-dist-dir>)\n+                 at s (<next-dist-dir>)\n+                 at t (<next-dist-dir>)\n+                 at u (<next-dist-dir>)\n+                 at v (<next-dist-dir>)\n+                 at w (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         } else {\n-          expect(output).toMatchInlineSnapshot(`\n-           \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at a (<next-dist-dir>)\n-               at b (<next-dist-dir>)\n-               at c (<next-dist-dir>)\n-               at d (<next-dist-dir>)\n-               at e (<next-dist-dir>)\n-               at f (<next-dist-dir>)\n-               at g (<next-dist-dir>)\n-               at h (<next-dist-dir>)\n-               at i (<next-dist-dir>)\n-               at j (<next-dist-dir>)\n-               at k (<next-dist-dir>)\n-               at l (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n-               at m (<next-dist-dir>)\n-               at n (<next-dist-dir>)\n-               at o (<next-dist-dir>)\n-               at p (<next-dist-dir>)\n-               at q (<next-dist-dir>)\n-               at r (<next-dist-dir>)\n-               at s (<next-dist-dir>)\n-               at t (<next-dist-dir>)\n-               at u (<next-dist-dir>)\n-               at v (<next-dist-dir>)\n-               at w (<next-dist-dir>)\n-               at main (<anonymous>)\n-               at body (<anonymous>)\n-               at html (<anonymous>)\n-           Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n-           Export encountered an error on /page: /, exiting the build.\"\n-          `)\n+          if (inPrerenderDebugMode) {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at IndirectionTwo (webpack:///app/indirection.tsx:7:33)\n+                 at InnerLayoutRouter (webpack://<next-src>)\n+                 at RedirectErrorBoundary (webpack://<next-src>)\n+                 at RedirectBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+                 at LoadingBoundary (webpack://<next-src>)\n+                 at ErrorBoundary (webpack://<next-src>)\n+                 at InnerScrollAndFocusHandler (webpack://<next-src>)\n+                 at ScrollAndFocusHandler (webpack://<next-src>)\n+                 at RenderFromTemplateContext (webpack://<next-src>)\n+                 at OuterLayoutRouter (webpack://<next-src>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+                5 | }\n+                6 |\n+             >  7 | export function IndirectionTwo({ children }) {\n+                  |                                 ^\n+                8 |   return children\n+                9 | }\n+               10 |\n+             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at InnerLayoutRouter (webpack://<next-src>)\n+                 at RedirectErrorBoundary (webpack://<next-src>)\n+                 at RedirectBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackErrorBoundary (webpack://<next-src>)\n+                 at HTTPAccessFallbackBoundary (webpack://<next-src>)\n+                 at LoadingBoundary (webpack://<next-src>)\n+                 at ErrorBoundary (webpack://<next-src>)\n+                 at InnerScrollAndFocusHandler (webpack://<next-src>)\n+                 at ScrollAndFocusHandler (webpack://<next-src>)\n+                 at RenderFromTemplateContext (webpack://<next-src>)\n+                 at OuterLayoutRouter (webpack://<next-src>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+               332 |  */\n+               333 | function InnerLayoutRouter({\n+             > 334 |   tree,\n+                   |  ^\n+               335 |   segmentPath,\n+               336 |   cacheNode,\n+               337 |   url,\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+\n+             > Export encountered errors on following paths:\n+             \t/page: /\"\n+            `)\n+          } else {\n+            expect(output).toMatchInlineSnapshot(`\n+             \"Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at a (<next-dist-dir>)\n+                 at b (<next-dist-dir>)\n+                 at c (<next-dist-dir>)\n+                 at d (<next-dist-dir>)\n+                 at e (<next-dist-dir>)\n+                 at f (<next-dist-dir>)\n+                 at g (<next-dist-dir>)\n+                 at h (<next-dist-dir>)\n+                 at i (<next-dist-dir>)\n+                 at j (<next-dist-dir>)\n+                 at k (<next-dist-dir>)\n+                 at l (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error: Route \"/\": A component accessed data, headers, params, searchParams, or a short-lived cache without a Suspense boundary nor a \"use cache\" above it. We don't have the exact line number added to error messages yet but you can see which component in the stack below. See more info: https://nextjs.org/docs/messages/next-prerender-missing-suspense\n+                 at m (<next-dist-dir>)\n+                 at n (<next-dist-dir>)\n+                 at o (<next-dist-dir>)\n+                 at p (<next-dist-dir>)\n+                 at q (<next-dist-dir>)\n+                 at r (<next-dist-dir>)\n+                 at s (<next-dist-dir>)\n+                 at t (<next-dist-dir>)\n+                 at u (<next-dist-dir>)\n+                 at v (<next-dist-dir>)\n+                 at w (<next-dist-dir>)\n+                 at main (<anonymous>)\n+                 at body (<anonymous>)\n+                 at html (<anonymous>)\n+             Error occurred prerendering page \"/\". Read more: https://nextjs.org/docs/messages/prerender-error\n+             Export encountered an error on /page: /, exiting the build.\"\n+            `)\n+          }\n         }\n-      }\n-    })\n+      })\n+    }\n   })\n \n   describe('Dynamic Boundary', () => {\n     const { next, isNextDev, skipped } = nextTestSetup({\n       files: __dirname + '/fixtures/dynamic-boundary',\n-      skipStart: true,\n+      skipStart,\n       skipDeployment: true,\n-      buildOptions: inDebugMode ? ['--debug-prerender'] : undefined,\n+      buildOptions: inPrerenderDebugMode ? ['--debug-prerender'] : undefined,\n     })\n \n     if (skipped) {\n       return\n     }\n \n     if (isNextDev) {\n-      it('does not run in dev', () => {})\n-      return\n-    }\n-\n-    it('should partially prerender when all dynamic components are inside a Suspense boundary', async () => {\n-      try {\n-        await next.start()\n-      } catch {\n-        throw new Error('expected build not to fail for fully static project')\n-        // we expect the build to fail\n+      if (inPrerenderDebugMode) {\n+        it('prerender debug mode does not exist for `next dev`', () => {})\n+        return\n       }\n \n-      expect(next.cliOutput).toContain('◐ / ')\n-      const $ = await next.render$('/')\n-      expect($('[data-fallback]').length).toBe(2)\n-    })\n+      it('should not show a collapsed redbox error', async () => {\n+        const browser = await next.browser('/')\n+        await assertNoErrorToast(browser)\n+      })\n+    } else {\n+      it('should partially prerender when all dynamic components are inside a Suspense boundary', async () => {\n+        try {\n+          await next.start()\n+        } catch {\n+          throw new Error('expected build not to fail for fully static project')\n+          // we expect the build to fail\n+        }\n+\n+        expect(next.cliOutput).toContain('◐ / ')\n+        const $ = await next.render$('/')\n+        expect($('[data-fallback]').length).toBe(2)\n+      })\n+    }\n   })\n })"
        }
    ],
    "stats": {
        "total": 2800,
        "additions": 1695,
        "deletions": 1105
    }
}