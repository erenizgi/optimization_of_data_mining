{
    "author": "huozhi",
    "message": "[metadata] change the metadata routes params to promises (#83560)",
    "sha": "f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
    "files": [
        {
            "sha": "533a3e5e3f6053310806352c333f95e157e4aea0",
            "filename": "crates/next-core/src/next_app/metadata/route.rs",
            "status": "modified",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/crates%2Fnext-core%2Fsrc%2Fnext_app%2Fmetadata%2Froute.rs?ref=f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
            "patch": "@@ -288,10 +288,12 @@ async fn dynamic_sitemap_route_with_generate_source(\n             }}\n \n             export async function GET(_, ctx) {{\n-                const {{ __metadata_id__: id, ...params }} = await ctx.params || {{}}\n-                const hasXmlExtension = id ? id.endsWith('.xml') : false\n+                const paramsPromise = ctx.params\n+                const idPromise = paramsPromise.then(params => params?.__metadata_id__)\n \n                 if (process.env.NODE_ENV !== 'production') {{\n+                    const id = await idPromise\n+                    const hasXmlExtension = id ? id.endsWith('.xml') : false\n                     const sitemaps = await generateSitemaps()\n                     let foundId\n                     for (const item of sitemaps) {{\n@@ -310,8 +312,11 @@ async fn dynamic_sitemap_route_with_generate_source(\n                     }}\n                 }}\n                 \n-                const targetId = id && hasXmlExtension ? id.slice(0, -4) : undefined\n-                const data = await handler({{ id: targetId }})\n+                const targetIdPromise = idPromise.then(id => {{\n+                    const hasXmlExtension = id ? id.endsWith('.xml') : false\n+                    return id && hasXmlExtension ? id.slice(0, -4) : undefined\n+                }})\n+                const data = await handler({{ id: targetIdPromise }})\n                 const content = resolveRouteData(data, fileType)\n \n                 return new NextResponse(content, {{\n@@ -433,11 +438,17 @@ async fn dynamic_image_route_with_metadata_source(\n             }}\n \n             export async function GET(_, ctx) {{\n-                const params = await ctx.params\n-                const {{ __metadata_id__, ...rest }} = params || {{}}\n-                const restParams = params ? rest : undefined\n+                const paramsPromise = ctx.params\n+                const idPromise = paramsPromise.then(params => params?.__metadata_id__)\n+                const restParamsPromise = paramsPromise.then(params => {{\n+                    if (!params) return undefined\n+                    const {{ __metadata_id__, ...rest }} = params\n+                    return rest\n+                }})\n                 \n                 if (process.env.NODE_ENV !== 'production') {{\n+                    const restParams = await restParamsPromise\n+                    const __metadata_id__ = await idPromise\n                     const imageMetadata = await generateImageMetadata({{ params: restParams }})\n                     const id = imageMetadata.find((item) => {{\n                         if (item?.id == null) {{\n@@ -454,7 +465,7 @@ async fn dynamic_image_route_with_metadata_source(\n                     }}\n                 }}\n \n-                return handler({{ params: restParams, id: __metadata_id__ }})\n+                return handler({{ params: restParamsPromise, id: idPromise }})\n             }}\n \n             export * from {resource_path}\n@@ -502,7 +513,7 @@ async fn dynamic_image_route_without_metadata_source(\n             }}\n \n             export async function GET(_, ctx) {{\n-                return handler({{ params: await ctx.params }})\n+                return handler({{ params: ctx.params }})\n             }}\n \n             export * from {resource_path}"
        },
        {
            "sha": "d169e5e26d39b3afe131aa1dd2872dff86429054",
            "filename": "packages/next/src/build/webpack/loaders/next-metadata-route-loader.ts",
            "status": "modified",
            "additions": 20,
            "deletions": 9,
            "changes": 29,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Fwebpack%2Floaders%2Fnext-metadata-route-loader.ts?ref=f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
            "patch": "@@ -169,12 +169,18 @@ ${errorOnBadHandler(resourcePath)}\n ${await createReExportsCode(resourcePath, loaderContext)}\n \n export async function GET(_, ctx) {\n-  const params = await ctx.params\n-  const { __metadata_id__, ...rest } = params || {}\n-  const restParams = params ? rest : undefined\n+  const paramsPromise = ctx.params\n+  const idPromise = paramsPromise.then(params => params?.__metadata_id__)\n+  const restParamsPromise = paramsPromise.then(params => {\n+    if (!params) return undefined\n+    const { __metadata_id__, ...rest } = params\n+    return rest\n+  })\n   \n   ${/* we need a dev assertion for id since dynamicParams=false won't work well in dev */ ''}\n   if (process.env.NODE_ENV !== 'production') {\n+    const restParams = await restParamsPromise\n+    const __metadata_id__ = await idPromise\n     const imageMetadata = await generateImageMetadata({ params: restParams })\n     const id = imageMetadata.find((item) => {\n       if (item?.id == null) {\n@@ -191,7 +197,7 @@ export async function GET(_, ctx) {\n     }\n   }\n \n-  return handler({ params: restParams, id: __metadata_id__ })\n+  return handler({ params: restParamsPromise, id: idPromise })\n }\n \n export const dynamicParams = false\n@@ -223,7 +229,7 @@ ${errorOnBadHandler(resourcePath)}\n ${await createReExportsCode(resourcePath, loaderContext)}\n \n export async function GET(_, ctx) {\n-  return handler({ params: await ctx.params })\n+  return handler({ params: ctx.params })\n }\n `\n }\n@@ -294,10 +300,12 @@ ${errorOnBadHandler(resourcePath)}\n ${await createReExportsCode(resourcePath, loaderContext)}\n \n export async function GET(_, ctx) {\n-  const { __metadata_id__: id, ...params } = await ctx.params || {}\n-  const hasXmlExtension = id ? id.endsWith('.xml') : false\n+  const paramsPromise = ctx.params\n+  const idPromise = paramsPromise.then(params => params?.__metadata_id__)\n \n   if (process.env.NODE_ENV !== 'production') {\n+    const id = await idPromise\n+    const hasXmlExtension = id ? id.endsWith('.xml') : false\n     const sitemaps = await generateSitemaps()\n     let foundId\n     for (const item of sitemaps) {\n@@ -317,8 +325,11 @@ export async function GET(_, ctx) {\n     }\n   }\n \n-  const targetId = id && hasXmlExtension ? id.slice(0, -4) : undefined\n-  const data = await handler({ id: targetId })\n+  const targetIdPromise = idPromise.then(id => {\n+    const hasXmlExtension = id ? id.endsWith('.xml') : false\n+    return id && hasXmlExtension ? id.slice(0, -4) : undefined\n+  })\n+  const data = await handler({ id: targetIdPromise })\n   const content = resolveRouteData(data, fileType)\n \n   return new NextResponse(content, {"
        },
        {
            "sha": "f7e6ba7861f329c6ff4cfa1cc04f8b62f7ca93a4",
            "filename": "test/e2e/app-dir/logging/app/dynamic/[slug]/icon.jsx",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Flogging%2Fapp%2Fdynamic%2F%5Bslug%5D%2Ficon.jsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Flogging%2Fapp%2Fdynamic%2F%5Bslug%5D%2Ficon.jsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Flogging%2Fapp%2Fdynamic%2F%5Bslug%5D%2Ficon.jsx?ref=f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
            "patch": "@@ -1,6 +1,8 @@\n import { ImageResponse } from 'next/og'\n \n-export default function icon({ params, id }) {\n+export default async function icon({ params, id }) {\n+  const { size } = await params\n+  const iconId = await id\n   return new ImageResponse(\n     (\n       <div\n@@ -15,7 +17,7 @@ export default function icon({ params, id }) {\n           color: '#fafafa',\n         }}\n       >\n-        Apple {params.size} {id}\n+        Apple {size} {iconId}\n       </div>\n     )\n   )"
        },
        {
            "sha": "c41c84e860bf51a423dabdb67ac9970f1bdf5bb3",
            "filename": "test/e2e/app-dir/metadata-dynamic-routes/app/(group)/dynamic/[size]/icon.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Ficon.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Ficon.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Ficon.tsx?ref=f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
            "patch": "@@ -15,7 +15,9 @@ export async function generateImageMetadata({ params }) {\n   ]\n }\n \n-export default function icon({ params, id }) {\n+export default async function icon({ params, id }) {\n+  const { size } = await params\n+  const iconId = await id\n   return new ImageResponse(\n     (\n       <div\n@@ -30,7 +32,7 @@ export default function icon({ params, id }) {\n           color: '#000',\n         }}\n       >\n-        Icon {params.size} {id}\n+        Icon {size} {iconId}\n       </div>\n     )\n   )"
        },
        {
            "sha": "9c54d96b9bd3ca4b67bb877df4028a2088a9d253",
            "filename": "test/e2e/app-dir/metadata-dynamic-routes/app/(group)/dynamic/[size]/opengraph-image.tsx",
            "status": "modified",
            "additions": 3,
            "deletions": 2,
            "changes": 5,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Fopengraph-image.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Fopengraph-image.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2F(group)%2Fdynamic%2F%5Bsize%5D%2Fopengraph-image.tsx?ref=f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
            "patch": "@@ -2,8 +2,9 @@ import { ImageResponse } from 'next/og'\n \n export const alt = 'Open Graph'\n \n-export default function og({ params }) {\n-  const big = params.size === 'big'\n+export default async function og({ params }) {\n+  const { size } = await params\n+  const big = size === 'big'\n   const background = big ? 'orange' : '#000'\n   return new ImageResponse(\n     ("
        },
        {
            "sha": "c41c84e860bf51a423dabdb67ac9970f1bdf5bb3",
            "filename": "test/e2e/app-dir/metadata-dynamic-routes/app/gsp/icon.tsx",
            "status": "modified",
            "additions": 4,
            "deletions": 2,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2Fgsp%2Ficon.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2Fgsp%2Ficon.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2Fgsp%2Ficon.tsx?ref=f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
            "patch": "@@ -15,7 +15,9 @@ export async function generateImageMetadata({ params }) {\n   ]\n }\n \n-export default function icon({ params, id }) {\n+export default async function icon({ params, id }) {\n+  const { size } = await params\n+  const iconId = await id\n   return new ImageResponse(\n     (\n       <div\n@@ -30,7 +32,7 @@ export default function icon({ params, id }) {\n           color: '#000',\n         }}\n       >\n-        Icon {params.size} {id}\n+        Icon {size} {iconId}\n       </div>\n     )\n   )"
        },
        {
            "sha": "3d1bef0f058b81fbd0e32ba0405838696d0da0ac",
            "filename": "test/e2e/app-dir/metadata-dynamic-routes/app/gsp/sitemap.ts",
            "status": "modified",
            "additions": 4,
            "deletions": 3,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2Fgsp%2Fsitemap.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2Fgsp%2Fsitemap.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fmetadata-dynamic-routes%2Fapp%2Fgsp%2Fsitemap.ts?ref=f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
            "patch": "@@ -9,14 +9,15 @@ export async function generateSitemaps() {\n   ]\n }\n \n-export default function sitemap({ id }): MetadataRoute.Sitemap {\n+export default async function sitemap({ id }): Promise<MetadataRoute.Sitemap> {\n+  const sitemapId = await id\n   return [\n     {\n-      url: `https://example.com/dynamic/${id}`,\n+      url: `https://example.com/dynamic/${sitemapId}`,\n       lastModified: '2021-01-01',\n     },\n     {\n-      url: `https://example.com/dynamic/${id}/about`,\n+      url: `https://example.com/dynamic/${sitemapId}/about`,\n       lastModified: '2021-01-01',\n     },\n   ]"
        },
        {
            "sha": "9b0be68b194edc3e97ff42b2b60b8bba394d7ffb",
            "filename": "test/e2e/app-dir/use-cache-metadata-route-handler/app/products/sitemap.ts",
            "status": "modified",
            "additions": 5,
            "deletions": 5,
            "changes": 10,
            "blob_url": "https://github.com/vercel/next.js/blob/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fuse-cache-metadata-route-handler%2Fapp%2Fproducts%2Fsitemap.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/f0a6103dc807e0b089bf7d2bf6031daca6d8ceae/test%2Fe2e%2Fapp-dir%2Fuse-cache-metadata-route-handler%2Fapp%2Fproducts%2Fsitemap.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fuse-cache-metadata-route-handler%2Fapp%2Fproducts%2Fsitemap.ts?ref=f0a6103dc807e0b089bf7d2bf6031daca6d8ceae",
            "patch": "@@ -1,6 +1,5 @@\n import type { MetadataRoute } from 'next'\n import { getSentinelValue } from '../sentinel'\n-import { setTimeout } from 'timers/promises'\n \n export async function generateSitemaps() {\n   return [{ id: 0 }, { id: 1 }]\n@@ -9,12 +8,13 @@ export async function generateSitemaps() {\n export default async function sitemap({\n   id,\n }: {\n-  id: number\n+  id: Promise<number>\n }): Promise<MetadataRoute.Sitemap> {\n   'use cache'\n \n-  // Simulate I/O\n-  await setTimeout(100)\n+  const resolvedId = await id\n \n-  return [{ url: `https://acme.com/${id}?sentinel=${getSentinelValue()}` }]\n+  return [\n+    { url: `https://acme.com/${resolvedId}?sentinel=${getSentinelValue()}` },\n+  ]\n }"
        }
    ],
    "stats": {
        "total": 98,
        "additions": 64,
        "deletions": 34
    }
}