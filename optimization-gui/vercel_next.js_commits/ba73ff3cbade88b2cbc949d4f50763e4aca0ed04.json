{
    "author": "ijjk",
    "message": "Ensure manual nonce on Script works as expected (#78939)\n\nWhile investigating https://github.com/vercel/next.js/pull/78936 we\nnoticed that manually setting `nonce` prop on `next/script` tag it\nwasn't honored properly. This ensures we fully propagate it when\nmanually set as a prop.\n\n---------\n\nCo-authored-by: Zack Tanner <1939140+ztanner@users.noreply.github.com>",
    "sha": "ba73ff3cbade88b2cbc949d4f50763e4aca0ed04",
    "files": [
        {
            "sha": "e28724e894cc58d7d4cc347f6f0427b5ffcec265",
            "filename": "packages/next/src/client/script.tsx",
            "status": "modified",
            "additions": 9,
            "deletions": 2,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/packages%2Fnext%2Fsrc%2Fclient%2Fscript.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/packages%2Fnext%2Fsrc%2Fclient%2Fscript.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fclient%2Fscript.tsx?ref=ba73ff3cbade88b2cbc949d4f50763e4aca0ed04",
            "patch": "@@ -209,9 +209,12 @@ function Script(props: ScriptProps): JSX.Element | null {\n   } = props\n \n   // Context is available only during SSR\n-  const { updateScripts, scripts, getIsSsr, appDir, nonce } =\n+  let { updateScripts, scripts, getIsSsr, appDir, nonce } =\n     useContext(HeadManagerContext)\n \n+  // if a nonce is explicitly passed to the script tag, favor that over the automatic handling\n+  nonce = restProps.nonce || nonce\n+\n   /**\n    * - First mount:\n    *   1. The useEffect for onReady executes\n@@ -276,14 +279,18 @@ function Script(props: ScriptProps): JSX.Element | null {\n           onReady,\n           onError,\n           ...restProps,\n+          nonce,\n         },\n       ])\n       updateScripts(scripts)\n     } else if (getIsSsr && getIsSsr()) {\n       // Script has already loaded during SSR\n       LoadCache.add(id || src)\n     } else if (getIsSsr && !getIsSsr()) {\n-      loadScript(props)\n+      loadScript({\n+        ...props,\n+        nonce,\n+      })\n     }\n   }\n "
        },
        {
            "sha": "07abb5476c8fb4392f45247b4e606b52084f135c",
            "filename": "packages/next/src/pages/_document.tsx",
            "status": "modified",
            "additions": 1,
            "deletions": 1,
            "changes": 2,
            "blob_url": "https://github.com/vercel/next.js/blob/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fpages%2F_document.tsx?ref=ba73ff3cbade88b2cbc949d4f50763e4aca0ed04",
            "patch": "@@ -330,7 +330,7 @@ function getPreNextScripts(context: HtmlProps, props: OriginProps) {\n           {...scriptProps}\n           key={scriptProps.src || index}\n           defer={scriptProps.defer ?? !disableOptimizedLoading}\n-          nonce={props.nonce}\n+          nonce={scriptProps.nonce || props.nonce}\n           data-nscript=\"beforeInteractive\"\n           crossOrigin={props.crossOrigin || crossOrigin}\n         />"
        },
        {
            "sha": "21f33446f6dfe2b62c76e7f64a632e2cbc5c668e",
            "filename": "test/e2e/app-dir/app/app/script-manual-nonce/page.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fpage.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fpage.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fpage.js?ref=ba73ff3cbade88b2cbc949d4f50763e4aca0ed04",
            "patch": "@@ -0,0 +1,18 @@\n+import Script from 'next/script'\n+import { ShowScriptOrder } from './show-order'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>script-nonce</p>\n+      <Script strategy=\"afterInteractive\" src=\"/test1.js\" nonce=\"hello-world\" />\n+      <Script\n+        strategy=\"beforeInteractive\"\n+        src=\"/test2.js\"\n+        nonce=\"hello-world\"\n+      />\n+      <Script strategy=\"beforeInteractive\" id=\"3\" nonce=\"hello-world\" />\n+      <ShowScriptOrder />\n+    </>\n+  )\n+}"
        },
        {
            "sha": "6c5af531d1e668dab3ee43c0ecf96f6067efe3e7",
            "filename": "test/e2e/app-dir/app/app/script-manual-nonce/show-order.js",
            "status": "added",
            "additions": 20,
            "deletions": 0,
            "changes": 20,
            "blob_url": "https://github.com/vercel/next.js/blob/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fshow-order.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fshow-order.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Fapp%2Fscript-manual-nonce%2Fshow-order.js?ref=ba73ff3cbade88b2cbc949d4f50763e4aca0ed04",
            "patch": "@@ -0,0 +1,20 @@\n+'use client'\n+import { useState } from 'react'\n+\n+export function ShowScriptOrder() {\n+  const [order, setOrder] = useState(null)\n+\n+  return (\n+    <>\n+      <p id=\"order\">{JSON.stringify(order)}</p>\n+      <button\n+        id=\"get-order\"\n+        onClick={() => {\n+          setOrder(window._script_order)\n+        }}\n+      >\n+        get order\n+      </button>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "8f8ba4763bd2c5bb26c6be9f0e1a6dac280ec5ec",
            "filename": "test/e2e/app-dir/app/index.test.ts",
            "status": "modified",
            "additions": 51,
            "deletions": 0,
            "changes": 51,
            "blob_url": "https://github.com/vercel/next.js/blob/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Findex.test.ts?ref=ba73ff3cbade88b2cbc949d4f50763e4aca0ed04",
            "patch": "@@ -1711,6 +1711,57 @@ describe('app dir - basic', () => {\n       }\n     })\n \n+    it('should pass manual `nonce`', async () => {\n+      const html = await next.render('/script-manual-nonce')\n+      const $ = cheerio.load(html)\n+      let scripts = $('script, link[rel=\"preload\"][as=\"script\"]')\n+\n+      scripts = scripts.filter((_, element) =>\n+        (element.attribs.src || element.attribs.href)?.startsWith('/test')\n+      )\n+\n+      expect(scripts.length).toBeGreaterThan(0)\n+\n+      scripts.each((_, element) => {\n+        expect(element.attribs.nonce).toBeTruthy()\n+      })\n+\n+      if (!isNextDev) {\n+        const browser = await next.browser('/script-manual-nonce')\n+\n+        await retry(async () => {\n+          await browser.elementByCss('#get-order').click()\n+          const order = JSON.parse(await browser.elementByCss('#order').text())\n+          expect(order?.length).toBe(2)\n+        })\n+      }\n+    })\n+\n+    it('should pass manual `nonce` pages', async () => {\n+      const html = await next.render('/pages-script-manual-nonce')\n+      const $ = cheerio.load(html)\n+      let scripts = $('script, link[rel=\"preload\"][as=\"script\"]')\n+\n+      scripts = scripts.filter((_, element) =>\n+        (element.attribs.src || element.attribs.href)?.startsWith('/test')\n+      )\n+\n+      expect(scripts.length).toBeGreaterThan(0)\n+\n+      scripts.each((_, element) => {\n+        expect(element.attribs.nonce).toBeTruthy()\n+      })\n+\n+      if (!isNextDev) {\n+        await retry(async () => {\n+          const browser = await next.browser('/pages-script-manual-nonce')\n+          await browser.elementByCss('#get-order').click()\n+          const order = JSON.parse(await browser.elementByCss('#order').text())\n+          expect(order?.length).toBe(2)\n+        })\n+      }\n+    })\n+\n     it('should pass nonce when using next/font', async () => {\n       const html = await next.render('/script-nonce/with-next-font')\n       const $ = cheerio.load(html)"
        },
        {
            "sha": "dd3eacd6a03e4ee9b6e832fac92f728171feeebf",
            "filename": "test/e2e/app-dir/app/pages/pages-script-manual-nonce.js",
            "status": "added",
            "additions": 18,
            "deletions": 0,
            "changes": 18,
            "blob_url": "https://github.com/vercel/next.js/blob/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/test%2Fe2e%2Fapp-dir%2Fapp%2Fpages%2Fpages-script-manual-nonce.js",
            "raw_url": "https://github.com/vercel/next.js/raw/ba73ff3cbade88b2cbc949d4f50763e4aca0ed04/test%2Fe2e%2Fapp-dir%2Fapp%2Fpages%2Fpages-script-manual-nonce.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Fapp%2Fpages%2Fpages-script-manual-nonce.js?ref=ba73ff3cbade88b2cbc949d4f50763e4aca0ed04",
            "patch": "@@ -0,0 +1,18 @@\n+import Script from 'next/script'\n+import { ShowScriptOrder } from '../app/script-nonce/show-order'\n+\n+export default function Page() {\n+  return (\n+    <>\n+      <p>script-nonce</p>\n+      <Script strategy=\"afterInteractive\" src=\"/test1.js\" nonce=\"hello-world\" />\n+      <Script\n+        strategy=\"beforeInteractive\"\n+        src=\"/test2.js\"\n+        nonce=\"hello-world\"\n+      />\n+      <Script strategy=\"beforeInteractive\" id=\"3\" nonce=\"hello-world\" />\n+      <ShowScriptOrder />\n+    </>\n+  )\n+}"
        }
    ],
    "stats": {
        "total": 120,
        "additions": 117,
        "deletions": 3
    }
}