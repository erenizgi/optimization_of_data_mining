{
    "author": "mischnic",
    "message": "Properly type edge handler fn (#86766)\n\nFollowup to https://github.com/vercel/next.js/issues/86765\n\nThere were quite a few cases where `page` wasn't actually passed to ​`adapter`​. I hope I'm now passing the right string there.\n\nThe old `nHandler(opts: { page: string; request: RequestData }) was a lie, ​packages/next/src/server/web/sandbox/sandbox.ts`​ never passes `page`​",
    "sha": "a949001d829b493967a718709c9e5d0b53f005c0",
    "files": [
        {
            "sha": "bc8cd732b38df6249ac57d8641f6986dfbd83624",
            "filename": "packages/next/src/build/templates/edge-app-route.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 1,
            "changes": 7,
            "blob_url": "https://github.com/vercel/next.js/blob/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-app-route.ts?ref=a949001d829b493967a718709c9e5d0b53f005c0",
            "patch": "@@ -1,5 +1,6 @@\n import { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\n import type { NextConfigComplete } from '../../server/config-shared'\n+import type { EdgeHandler } from '../../server/web/adapter'\n import { EdgeRouteModuleWrapper } from '../../server/web/edge-route-module-wrapper'\n \n // Import the userland code.\n@@ -24,4 +25,8 @@ if (rscManifest && rscServerManifest) {\n \n export const ComponentMod = module\n \n-export default EdgeRouteModuleWrapper.wrap(module.routeModule, { nextConfig })\n+const handler: EdgeHandler = EdgeRouteModuleWrapper.wrap(module.routeModule, {\n+  nextConfig,\n+  page: 'VAR_PAGE',\n+})\n+export default handler"
        },
        {
            "sha": "921aa56efc72a1f2f5afb591b8133269ffa2e0c7",
            "filename": "packages/next/src/build/templates/edge-ssr-app.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr-app.ts?ref=a949001d829b493967a718709c9e5d0b53f005c0",
            "patch": "@@ -1,10 +1,13 @@\n import '../../server/web/globals'\n-import { adapter, type NextRequestHint } from '../../server/web/adapter'\n+import {\n+  adapter,\n+  type EdgeHandler,\n+  type NextRequestHint,\n+} from '../../server/web/adapter'\n import { IncrementalCache } from '../../server/lib/incremental-cache'\n \n import * as pageMod from 'VAR_USERLAND'\n \n-import type { RequestData } from '../../server/web/types'\n import type { NextConfigComplete } from '../../server/config-shared'\n import { setManifestsSingleton } from '../../server/app-render/manifests-singleton'\n import { initializeCacheHandlers } from '../../server/use-cache/handlers'\n@@ -353,11 +356,13 @@ async function requestHandler(\n   )\n }\n \n-export default function nHandler(opts: { page: string; request: RequestData }) {\n+const handler: EdgeHandler = (opts) => {\n   return adapter({\n     ...opts,\n     IncrementalCache,\n     handler: requestHandler,\n     incrementalCacheHandler,\n+    page: 'VAR_PAGE',\n   })\n }\n+export default handler"
        },
        {
            "sha": "480fe3689dc1108d8e10dc81426e0ff42f9fa0df",
            "filename": "packages/next/src/build/templates/edge-ssr.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fedge-ssr.ts?ref=a949001d829b493967a718709c9e5d0b53f005c0",
            "patch": "@@ -1,5 +1,9 @@\n import '../../server/web/globals'\n-import { adapter, type NextRequestHint } from '../../server/web/adapter'\n+import {\n+  adapter,\n+  type EdgeHandler,\n+  type NextRequestHint,\n+} from '../../server/web/adapter'\n import { IncrementalCache } from '../../server/lib/incremental-cache'\n import { initializeCacheHandlers } from '../../server/use-cache/handlers'\n \n@@ -18,7 +22,6 @@ import RouteModule, {\n } from '../../server/route-modules/pages/module'\n import { WebNextRequest, WebNextResponse } from '../../server/base-http/web'\n \n-import type { RequestData } from '../../server/web/types'\n import type { NextConfigComplete } from '../../server/config-shared'\n import type { NextFetchEvent } from '../../server/web/spec-extension/fetch-event'\n import type RenderResult from '../../server/render-result'\n@@ -354,12 +357,14 @@ async function requestHandler(\n   )\n }\n \n-export default function nHandler(opts: { page: string; request: RequestData }) {\n+const handler: EdgeHandler = (opts) => {\n   return adapter({\n     ...opts,\n     IncrementalCache,\n     handler: requestHandler,\n     incrementalCacheHandler,\n     bypassNextUrl: true,\n+    page: 'VAR_PAGE',\n   })\n }\n+export default handler"
        },
        {
            "sha": "eb3533384c42d80449133ff0db4944bd8798ff3d",
            "filename": "packages/next/src/build/templates/middleware.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fmiddleware.ts?ref=a949001d829b493967a718709c9e5d0b53f005c0",
            "patch": "@@ -1,4 +1,4 @@\n-import type { AdapterOptions } from '../../server/web/adapter'\n+import type { AdapterOptions, EdgeHandler } from '../../server/web/adapter'\n \n import '../../server/web/globals'\n \n@@ -13,7 +13,7 @@ const mod = { ..._mod }\n \n const page: string = 'VAR_DEFINITION_PAGE'\n const isProxy = page === '/proxy' || page === '/src/proxy'\n-const handler = (isProxy ? mod.proxy : mod.middleware) || mod.default\n+const handlerUserland = (isProxy ? mod.proxy : mod.middleware) || mod.default\n \n class ProxyMissingExportError extends Error {\n   constructor(message: string) {\n@@ -25,7 +25,7 @@ class ProxyMissingExportError extends Error {\n \n // TODO: This spams logs during development. Find a better way to handle this.\n // Removing this will spam \"fn is not a function\" logs which is worse.\n-if (typeof handler !== 'function') {\n+if (typeof handlerUserland !== 'function') {\n   throw new ProxyMissingExportError(\n     `The ${isProxy ? 'Proxy' : 'Middleware'} file \"${page}\" must export a function named \\`${isProxy ? 'proxy' : 'middleware'}\\` or a default function.`\n   )\n@@ -69,12 +69,11 @@ function errorHandledHandler(fn: AdapterOptions['handler']) {\n   }\n }\n \n-export default function nHandler(\n-  opts: Omit<AdapterOptions, 'IncrementalCache' | 'page' | 'handler'>\n-) {\n+const handler: EdgeHandler = (opts) => {\n   return adapter({\n     ...opts,\n     page,\n-    handler: errorHandledHandler(handler),\n+    handler: errorHandledHandler(handlerUserland),\n   })\n }\n+export default handler"
        },
        {
            "sha": "1620f3ae53c48116d1831cc43b3c883d08c2dc4f",
            "filename": "packages/next/src/build/templates/pages-edge-api.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 7,
            "changes": 13,
            "blob_url": "https://github.com/vercel/next.js/blob/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-edge-api.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-edge-api.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fbuild%2Ftemplates%2Fpages-edge-api.ts?ref=a949001d829b493967a718709c9e5d0b53f005c0",
            "patch": "@@ -1,4 +1,4 @@\n-import type { AdapterOptions } from '../../server/web/adapter'\n+import type { EdgeHandler } from '../../server/web/adapter'\n \n import '../../server/web/globals'\n \n@@ -7,23 +7,22 @@ import { IncrementalCache } from '../../server/lib/incremental-cache'\n import { wrapApiHandler } from '../../server/api-utils'\n \n // Import the userland code.\n-import handler from 'VAR_USERLAND'\n+import handlerUserland from 'VAR_USERLAND'\n \n const page = 'VAR_DEFINITION_PAGE'\n \n-if (typeof handler !== 'function') {\n+if (typeof handlerUserland !== 'function') {\n   throw new Error(\n     `The Edge Function \"pages${page}\" must export a \\`default\\` function`\n   )\n }\n \n-export default function (\n-  opts: Omit<AdapterOptions, 'IncrementalCache' | 'page' | 'handler'>\n-) {\n+const handler: EdgeHandler = (opts) => {\n   return adapter({\n     ...opts,\n     IncrementalCache,\n     page: 'VAR_DEFINITION_PATHNAME',\n-    handler: wrapApiHandler(page, handler),\n+    handler: wrapApiHandler(page, handlerUserland),\n   })\n }\n+export default handler"
        },
        {
            "sha": "ef0e7ad50cf2c78bfee8b610dc45d9b0bf2dcbb3",
            "filename": "packages/next/src/server/web/adapter.ts",
            "status": "modified",
            "additions": 6,
            "deletions": 0,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fadapter.ts?ref=a949001d829b493967a718709c9e5d0b53f005c0",
            "patch": "@@ -76,6 +76,12 @@ export type AdapterOptions = {\n   bypassNextUrl?: boolean\n }\n \n+// This has to be compatible with what the Vercel builder does as well:\n+// https://github.com/vercel/vercel/blob/0e0a6eb9f12216202ae2f5ee37e4ada1796361fd/packages/next/src/edge-function-source/get-edge-function.ts#L112-L136\n+export type EdgeHandler = (opts: {\n+  request: AdapterOptions['request']\n+}) => Promise<FetchEventResult>\n+\n let propagator: <T>(request: NextRequestHint, fn: () => T) => T = (\n   request,\n   fn"
        },
        {
            "sha": "c98a3078b64fdab3e616c6dcdded229d8bf7ee7f",
            "filename": "packages/next/src/server/web/edge-route-module-wrapper.ts",
            "status": "modified",
            "additions": 8,
            "deletions": 3,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fedge-route-module-wrapper.ts?ref=a949001d829b493967a718709c9e5d0b53f005c0",
            "patch": "@@ -6,7 +6,7 @@ import type {\n \n import './globals'\n \n-import { adapter, type AdapterOptions } from './adapter'\n+import { adapter, type EdgeHandler } from './adapter'\n import { IncrementalCache } from '../lib/incremental-cache'\n import { RouteMatcher } from '../route-matchers/route-matcher'\n import type { NextFetchEvent } from './spec-extension/fetch-event'\n@@ -19,6 +19,7 @@ import type { NextConfigComplete } from '../config-shared'\n \n export interface WrapOptions {\n   nextConfig: NextConfigComplete\n+  page: string\n }\n \n /**\n@@ -52,17 +53,21 @@ export class EdgeRouteModuleWrapper {\n    *                override the ones passed from the runtime\n    * @returns a function that can be used as a handler for the edge runtime\n    */\n-  public static wrap(routeModule: AppRouteRouteModule, options: WrapOptions) {\n+  public static wrap(\n+    routeModule: AppRouteRouteModule,\n+    options: WrapOptions\n+  ): EdgeHandler {\n     // Create the module wrapper.\n     const wrapper = new EdgeRouteModuleWrapper(routeModule, options.nextConfig)\n \n     // Return the wrapping function.\n-    return (opts: AdapterOptions) => {\n+    return (opts) => {\n       return adapter({\n         ...opts,\n         IncrementalCache,\n         // Bind the handler method to the wrapper so it still has context.\n         handler: wrapper.handler.bind(wrapper),\n+        page: options.page,\n       })\n     }\n   }"
        },
        {
            "sha": "7af41b9a5fcf6e2c0272e787ed74f8af319e93eb",
            "filename": "packages/next/src/server/web/sandbox/sandbox.ts",
            "status": "modified",
            "additions": 3,
            "deletions": 5,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/a949001d829b493967a718709c9e5d0b53f005c0/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fweb%2Fsandbox%2Fsandbox.ts?ref=a949001d829b493967a718709c9e5d0b53f005c0",
            "patch": "@@ -1,4 +1,4 @@\n-import type { NodejsRequestData, FetchEventResult, RequestData } from '../types'\n+import type { NodejsRequestData, FetchEventResult } from '../types'\n import type { EdgeFunctionDefinition } from '../../../build/webpack/plugins/middleware-plugin'\n import type { EdgeRuntime } from 'next/dist/compiled/edge-runtime'\n import {\n@@ -16,6 +16,7 @@ import {\n   RouterServerContextSymbol,\n   routerServerGlobal,\n } from '../../lib/router-utils/router-server-context'\n+import type { EdgeHandler } from '../adapter'\n \n export const ErrorSource = Symbol('SandboxError')\n \n@@ -104,10 +105,7 @@ export async function getRuntimeContext(\n export const run = withTaggedErrors(async function runWithTaggedErrors(params) {\n   const runtime = await getRuntimeContext(params)\n \n-  // TODO better typesafety here\n-  const edgeFunction: (args: {\n-    request: RequestData\n-  }) => Promise<FetchEventResult> = (\n+  const edgeFunction: EdgeHandler = (\n     await runtime.context._ENTRIES[`middleware_${params.name}`]\n   ).default\n "
        }
    ],
    "stats": {
        "total": 80,
        "additions": 51,
        "deletions": 29
    }
}