{
    "author": "bgw",
    "message": "refactor(turbo-tasks-backend): Remove `ExecuteContextImpl::lower_read_transaction` (#80822)\n\nFollowing the removal of the other `transaction` and `lower_read_transaction` callsites in #80816...\n\nIf `ExecuteContextImpl::transaction` is inlined into `ExecuteContextImpl::restore_task_data` (the only remaining callsite), we no longer need `lower_read_transaction` and its crimes against Rust lifetimes.\n\nSanity checked with:\n\n```\ncargo check --features turbo-tasks-backend/lmdb\n```",
    "sha": "546cdee5672dce4fde8057dd59232acadad41142",
    "files": [
        {
            "sha": "91368b89dd41059aa952c42e38250808e7da57e9",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backend/operation/mod.rs",
            "status": "modified",
            "additions": 11,
            "deletions": 17,
            "changes": 28,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbackend%2Foperation%2Fmod.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -107,10 +107,11 @@ where\n         }\n     }\n \n-    fn transaction<'l>(&'l mut self) -> Option<&'l B::ReadTransaction<'l>>\n-    where\n-        'e: 'l,\n-    {\n+    fn restore_task_data(\n+        &mut self,\n+        task_id: TaskId,\n+        category: TaskDataCategory,\n+    ) -> Vec<CachedDataItem> {\n         if matches!(self.transaction, TransactionState::None) {\n             let tx = self.backend.backing_storage.start_read_transaction();\n             let tx = tx.map(|tx| {\n@@ -119,23 +120,16 @@ where\n             });\n             self.transaction = TransactionState::Owned(tx);\n         }\n-        match &self.transaction {\n+        let tx = match &self.transaction {\n             TransactionState::None => unreachable!(),\n-            TransactionState::Borrowed(tx) => tx.map(B::lower_read_transaction),\n-            TransactionState::Owned(tx) => tx.as_ref().map(B::lower_read_transaction),\n-        }\n-    }\n-\n-    fn restore_task_data(\n-        &mut self,\n-        task_id: TaskId,\n-        category: TaskDataCategory,\n-    ) -> Vec<CachedDataItem> {\n-        // Safety: `transaction` is a valid transaction from `self.backend.backing_storage`.\n+            TransactionState::Borrowed(tx) => *tx,\n+            TransactionState::Owned(tx) => tx.as_ref(),\n+        };\n+        // Safety: `tx` is a valid transaction from `self.backend.backing_storage`.\n         let result = unsafe {\n             self.backend\n                 .backing_storage\n-                .lookup_data(self.transaction(), task_id, category)\n+                .lookup_data(tx, task_id, category)\n         };\n         match result {\n             Ok(data) => data,"
        },
        {
            "sha": "526cdf93468a516f0e9699bdd02092a98d1eac4b",
            "filename": "turbopack/crates/turbo-tasks-backend/src/backing_storage.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 3,
            "changes": 3,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbacking_storage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbacking_storage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fbacking_storage.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -41,9 +41,6 @@ pub trait BackingStorage: BackingStorageSealed {\n /// [`BackingStorage::invalidate`] method.\n pub trait BackingStorageSealed: 'static + Send + Sync {\n     type ReadTransaction<'l>;\n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i>;\n     fn next_free_task_id(&self) -> Result<TaskId>;\n     fn next_session_id(&self) -> Result<SessionId>;\n     fn uncompleted_operations(&self) -> Result<Vec<AnyOperation>>;"
        },
        {
            "sha": "390ff0d851fb6db41a69031e7569c48eac58baf2",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/fresh_db_optimization.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Ffresh_db_optimization.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Ffresh_db_optimization.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Ffresh_db_optimization.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -37,12 +37,6 @@ impl<T: KeyValueDatabase> KeyValueDatabase for FreshDbOptimization<T> {\n     where\n         Self: 'l;\n \n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i> {\n-        T::lower_read_transaction(tx)\n-    }\n-\n     fn is_empty(&self) -> bool {\n         self.fresh_db.load(Ordering::Acquire) || self.database.is_empty()\n     }"
        },
        {
            "sha": "5b4176742a41e03f372c263788857c8e84ab6e39",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/key_value_database.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 4,
            "changes": 4,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fkey_value_database.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fkey_value_database.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fkey_value_database.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -18,10 +18,6 @@ pub trait KeyValueDatabase {\n     where\n         Self: 'l;\n \n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i>;\n-\n     fn begin_read_transaction(&self) -> Result<Self::ReadTransaction<'_>>;\n \n     fn is_empty(&self) -> bool {"
        },
        {
            "sha": "39dc1f3a19aa5d23febc34eabbced9ae700773e2",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/lmdb/mod.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Flmdb%2Fmod.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Flmdb%2Fmod.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Flmdb%2Fmod.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -75,12 +75,6 @@ impl KeyValueDatabase for LmbdKeyValueDatabase {\n     where\n         Self: 'l;\n \n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i> {\n-        tx\n-    }\n-\n     fn begin_read_transaction(&self) -> Result<Self::ReadTransaction<'_>> {\n         Ok(self.env.begin_ro_txn()?)\n     }"
        },
        {
            "sha": "a5693060d383c62d4e8a0e583773043ba88c39b7",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/noop_kv.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fnoop_kv.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fnoop_kv.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fnoop_kv.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -15,12 +15,6 @@ impl KeyValueDatabase for NoopKvDb {\n     where\n         Self: 'l;\n \n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i> {\n-        tx\n-    }\n-\n     fn begin_read_transaction(&self) -> Result<Self::ReadTransaction<'_>> {\n         Ok(())\n     }"
        },
        {
            "sha": "c5a100814e50ecf2ca67eb49689350acda105de3",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/read_transaction_cache.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 8,
            "changes": 8,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fread_transaction_cache.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fread_transaction_cache.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fread_transaction_cache.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -53,14 +53,6 @@ impl<T: KeyValueDatabase + 'static> KeyValueDatabase for ReadTransactionCache<T>\n     where\n         T: 'l;\n \n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i> {\n-        // Safety: When T compiles fine and lower_read_transaction is implemented correctly this is\n-        // safe to do.\n-        unsafe { transmute::<&'r Self::ReadTransaction<'l>, &'r Self::ReadTransaction<'i>>(tx) }\n-    }\n-\n     fn is_empty(&self) -> bool {\n         self.database.is_empty()\n     }"
        },
        {
            "sha": "60fcdbcc94d278e6b825262e81c71bb920a2776e",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/startup_cache.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fstartup_cache.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fstartup_cache.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fstartup_cache.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -105,12 +105,6 @@ impl<T: KeyValueDatabase> KeyValueDatabase for StartupCacheLayer<T> {\n     where\n         Self: 'l;\n \n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i> {\n-        T::lower_read_transaction(tx)\n-    }\n-\n     fn is_empty(&self) -> bool {\n         self.database.is_empty()\n     }"
        },
        {
            "sha": "7d020c14639522b9a0c1fe1956bbbb588648d802",
            "filename": "turbopack/crates/turbo-tasks-backend/src/database/turbo.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fdatabase%2Fturbo.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -60,12 +60,6 @@ impl KeyValueDatabase for TurboKeyValueDatabase {\n     where\n         Self: 'l;\n \n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i> {\n-        tx\n-    }\n-\n     fn is_empty(&self) -> bool {\n         self.db.is_empty()\n     }"
        },
        {
            "sha": "dc5042c7246aed0db0ab6e98096cb6c9a2285029",
            "filename": "turbopack/crates/turbo-tasks-backend/src/kv_backing_storage.rs",
            "status": "modified",
            "additions": 0,
            "deletions": 6,
            "changes": 6,
            "blob_url": "https://github.com/vercel/next.js/blob/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "raw_url": "https://github.com/vercel/next.js/raw/546cdee5672dce4fde8057dd59232acadad41142/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/turbopack%2Fcrates%2Fturbo-tasks-backend%2Fsrc%2Fkv_backing_storage.rs?ref=546cdee5672dce4fde8057dd59232acadad41142",
            "patch": "@@ -262,12 +262,6 @@ impl<T: KeyValueDatabase + Send + Sync + 'static> BackingStorageSealed\n {\n     type ReadTransaction<'l> = T::ReadTransaction<'l>;\n \n-    fn lower_read_transaction<'l: 'i + 'r, 'i: 'r, 'r>(\n-        tx: &'r Self::ReadTransaction<'l>,\n-    ) -> &'r Self::ReadTransaction<'i> {\n-        T::lower_read_transaction(tx)\n-    }\n-\n     fn next_free_task_id(&self) -> Result<TaskId> {\n         Ok(TaskId::try_from(\n             self.inner"
        }
    ],
    "stats": {
        "total": 79,
        "additions": 11,
        "deletions": 68
    }
}