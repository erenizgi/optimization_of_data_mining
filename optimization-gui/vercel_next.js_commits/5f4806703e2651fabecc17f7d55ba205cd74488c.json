{
    "author": "huozhi",
    "message": "[next-server] fix params duplicate in query after rewrite (#77939)",
    "sha": "5f4806703e2651fabecc17f7d55ba205cd74488c",
    "files": [
        {
            "sha": "598b6ce2bf122d098371d89418f13d149a0f5230",
            "filename": "packages/next/src/server/base-server.ts",
            "status": "modified",
            "additions": 19,
            "deletions": 5,
            "changes": 24,
            "blob_url": "https://github.com/vercel/next.js/blob/5f4806703e2651fabecc17f7d55ba205cd74488c/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5f4806703e2651fabecc17f7d55ba205cd74488c/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/packages%2Fnext%2Fsrc%2Fserver%2Fbase-server.ts?ref=5f4806703e2651fabecc17f7d55ba205cd74488c",
            "patch": "@@ -1196,28 +1196,34 @@ export default abstract class Server<\n             parsedUrl.pathname = `/${defaultLocale}${parsedUrl.pathname}`\n           }\n \n+          // Store a copy of `parsedUrl.query` before calling handleRewrites.\n+          // Since `handleRewrites` might add new queries to `parsedUrl.query`.\n+          const originQueryParams = { ...parsedUrl.query }\n+\n           const pathnameBeforeRewrite = parsedUrl.pathname\n           const rewriteParamKeys = Object.keys(\n             utils.handleRewrites(req, parsedUrl)\n           )\n-          const didRewrite = pathnameBeforeRewrite !== parsedUrl.pathname\n-\n-          if (didRewrite && parsedUrl.pathname) {\n-            addRequestMeta(req, 'rewroteURL', parsedUrl.pathname)\n-          }\n \n           // Create a copy of the query params to avoid mutating the original\n           // object. This prevents any overlapping query params that have the\n           // same normalized key from causing issues.\n           const queryParams = { ...parsedUrl.query }\n+          const didRewrite = pathnameBeforeRewrite !== parsedUrl.pathname\n \n+          if (didRewrite && parsedUrl.pathname) {\n+            addRequestMeta(req, 'rewroteURL', parsedUrl.pathname)\n+          }\n+\n+          const routeParamKeys = new Set<string>()\n           for (const [key, value] of Object.entries(parsedUrl.query)) {\n             const normalizedKey = normalizeNextQueryParam(key)\n             if (!normalizedKey) continue\n \n             // Remove the prefixed key from the query params because we want\n             // to consume it for the dynamic route matcher.\n             delete parsedUrl.query[key]\n+            routeParamKeys.add(normalizedKey)\n \n             if (typeof value === 'undefined') continue\n \n@@ -1371,6 +1377,14 @@ export default abstract class Server<\n               ...Object.keys(utils.defaultRouteRegex?.groups || {}),\n             ])\n           }\n+          // Remove the route `params` keys from `parsedUrl.query` if they are\n+          // not in the original query params.\n+          // If it's used in both route `params` and query `searchParams`, it should be kept.\n+          for (const key of routeParamKeys) {\n+            if (!(key in originQueryParams)) {\n+              delete parsedUrl.query[key]\n+            }\n+          }\n           parsedUrl.pathname = matchedPath\n           url.pathname = parsedUrl.pathname\n           finished = await this.normalizeAndAttachMetadata(req, res, parsedUrl)"
        },
        {
            "sha": "b4f9c0b21b2798e55bb2c5a60763719201c144b8",
            "filename": "test/e2e/app-dir/rewrite-with-search-params/app/[domain]/[...section]/page.tsx",
            "status": "added",
            "additions": 25,
            "deletions": 0,
            "changes": 25,
            "blob_url": "https://github.com/vercel/next.js/blob/5f4806703e2651fabecc17f7d55ba205cd74488c/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fapp%2F%5Bdomain%5D%2F%5B...section%5D%2Fpage.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5f4806703e2651fabecc17f7d55ba205cd74488c/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fapp%2F%5Bdomain%5D%2F%5B...section%5D%2Fpage.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fapp%2F%5Bdomain%5D%2F%5B...section%5D%2Fpage.tsx?ref=5f4806703e2651fabecc17f7d55ba205cd74488c",
            "patch": "@@ -0,0 +1,25 @@\n+export default async function Page({\n+  params,\n+  searchParams,\n+}: {\n+  params: Promise<{ domain: string; section: string[] }>\n+  searchParams: Promise<{ [key: string]: string | string[] }>\n+}) {\n+  const resolvedParams = await params\n+  const resolvedSearchParams = await searchParams\n+\n+  return (\n+    <>\n+      <div>\n+        <h2>Params:</h2>\n+        <pre id=\"params-value\">{JSON.stringify(resolvedParams, null, 2)}</pre>\n+      </div>\n+      <div>\n+        <h2>Search Params:</h2>\n+        <pre id=\"search-params-value\">\n+          {JSON.stringify(resolvedSearchParams, null, 2)}\n+        </pre>\n+      </div>\n+    </>\n+  )\n+}"
        },
        {
            "sha": "a9fec4d5077d7fa756a112fc87b2d3b50b7e6f61",
            "filename": "test/e2e/app-dir/rewrite-with-search-params/app/layout.tsx",
            "status": "added",
            "additions": 11,
            "deletions": 0,
            "changes": 11,
            "blob_url": "https://github.com/vercel/next.js/blob/5f4806703e2651fabecc17f7d55ba205cd74488c/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fapp%2Flayout.tsx",
            "raw_url": "https://github.com/vercel/next.js/raw/5f4806703e2651fabecc17f7d55ba205cd74488c/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fapp%2Flayout.tsx",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fapp%2Flayout.tsx?ref=5f4806703e2651fabecc17f7d55ba205cd74488c",
            "patch": "@@ -0,0 +1,11 @@\n+export default function RootLayout({\n+  children,\n+}: Readonly<{\n+  children: React.ReactNode\n+}>) {\n+  return (\n+    <html>\n+      <body>{children}</body>\n+    </html>\n+  )\n+}"
        },
        {
            "sha": "18bda66ceb90e3fbe286fb47f4429cdc6ccf9dbc",
            "filename": "test/e2e/app-dir/rewrite-with-search-params/next.config.js",
            "status": "added",
            "additions": 21,
            "deletions": 0,
            "changes": 21,
            "blob_url": "https://github.com/vercel/next.js/blob/5f4806703e2651fabecc17f7d55ba205cd74488c/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fnext.config.js",
            "raw_url": "https://github.com/vercel/next.js/raw/5f4806703e2651fabecc17f7d55ba205cd74488c/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fnext.config.js",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Fnext.config.js?ref=5f4806703e2651fabecc17f7d55ba205cd74488c",
            "patch": "@@ -0,0 +1,21 @@\n+/**\n+ * @type {import('next').NextConfig}\n+ */\n+const nextConfig = {\n+  async rewrites() {\n+    return [\n+      {\n+        source: '/:path((?!sitemap.xml$).*)',\n+        has: [\n+          {\n+            type: 'host',\n+            value: '(?<subdomain>[^.]+)\\\\.(?<domain>.*)',\n+          },\n+        ],\n+        destination: '/:subdomain/:path*',\n+      },\n+    ]\n+  },\n+}\n+\n+module.exports = nextConfig"
        },
        {
            "sha": "7776a0bc7ec5dd8c11355b6f94ac5a95065f6646",
            "filename": "test/e2e/app-dir/rewrite-with-search-params/rewrite-with-search-params.test.ts",
            "status": "added",
            "additions": 35,
            "deletions": 0,
            "changes": 35,
            "blob_url": "https://github.com/vercel/next.js/blob/5f4806703e2651fabecc17f7d55ba205cd74488c/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Frewrite-with-search-params.test.ts",
            "raw_url": "https://github.com/vercel/next.js/raw/5f4806703e2651fabecc17f7d55ba205cd74488c/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Frewrite-with-search-params.test.ts",
            "contents_url": "https://api.github.com/repos/vercel/next.js/contents/test%2Fe2e%2Fapp-dir%2Frewrite-with-search-params%2Frewrite-with-search-params.test.ts?ref=5f4806703e2651fabecc17f7d55ba205cd74488c",
            "patch": "@@ -0,0 +1,35 @@\n+import { nextTestSetup } from 'e2e-utils'\n+\n+describe('rewrite-with-search-params', () => {\n+  const { next, isNextDeploy } = nextTestSetup({\n+    files: __dirname,\n+  })\n+\n+  it('should not contain params in search params after rewrite', async () => {\n+    const $ = await next.render$(\n+      '/galleries/123',\n+      {\n+        param: 'value',\n+      },\n+      {\n+        headers: isNextDeploy\n+          ? undefined\n+          : {\n+              host: 'vercel-test.vercel.app',\n+            },\n+      }\n+    )\n+\n+    const searchParams = JSON.parse($('#search-params-value').text())\n+    const params = JSON.parse($('#params-value').text())\n+\n+    expect(searchParams).toEqual({\n+      param: 'value',\n+    })\n+\n+    expect(params).toEqual({\n+      domain: expect.stringMatching(/[\\w-]+/),\n+      section: ['galleries', '123'],\n+    })\n+  })\n+})"
        }
    ],
    "stats": {
        "total": 116,
        "additions": 111,
        "deletions": 5
    }
}